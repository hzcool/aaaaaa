[
    {
        "content": "\u9898\u610f\uff1a\u7ed9\u4f60\u4e00\u4e2a\u6392\u5217\uff0c\u5e76\u4e14\u5c06\u6839\u636e\u8fd9\u4e2a\u6392\u5217\u6784\u9020\u51fa\u4e00\u5f20\u56fe\u3002\u5177\u4f53\u7684\u6784\u9020\u65b9\u5f0f\u4e3a\uff1a\u6bcf\u4e2a\u70b9$i$\u5411$i+1$\u8fde\u4e00\u6761\u8fb9\uff0c\u5e76\u4e14\u4e5f\u5411\u6700\u5c0f\u7684\u6ee1\u8db3$i<j,p_i<p_j$\u7684\u70b9\u8fde\u4e00\u6761\u8fb9\uff0c\u8fb9\u6709\u8fb9\u6743\u3002\n\n\u518d\u7ed9\u5b9a\u4f60\u4e00\u4e2a\u96c6\u5408$S$\uff0c\u8981\u6c42\u52a8\u6001\u7ef4\u62a4$1$\u4e3a\u8d77\u70b9\uff0c$n+1$\u4e3a\u7ec8\u70b9\uff0c\u7ecf\u8fc7\u4e86\u96c6\u5408\u4e2d\u6240\u6709\u70b9\u7684\u6700\u77ed\u8def\u3002\n\n\u601d\u8def\uff1a\n\n\u94a6\u5b9a\u96c6\u5408$S$\u4e2d\u603b\u662f\u5b58\u5728$1$\u4e0e$n+1$\uff0c\u5957\u8def\u5730\u628a$dis_{1,n+1}$\u62c6\u6210\n$$\\sum_{i=1}^{|S|-1}dis_{S_i,S_{i+1}}$$\n\n\u5bf9\u4e8e\u6bcf\u6b21\u52a0\u5165\uff0c\u5220\u9664\u4e00\u4e2a\u70b9\u7684\u64cd\u4f5c\uff0c\u53ef\u4ee5\u5957\u8def\u5730\u7ef4\u62a4\u4e00\u4e0b\u8fd9\u4e2a\u7b54\u6848\u5e8f\u5217\u7684\u5dee\u5206\u5e8f\u5217\uff0c\u7136\u540e\u79bb\u7ebf\u8be2\u95ee\n\n\u73b0\u5728\u95ee\u9898\u53d8\u6210\u4e86\uff1a\u7ed9\u51fa$q$\u6b21\u8be2\u95ee\uff0c\u6bcf\u6b21\u8be2\u95ee$x$\uff0c$y$\u4e24\u70b9\u4e4b\u95f4\u7684\u6700\u77ed\u8def\u3002\n\n~~\u8fd9\u672a\u5fc5\u53ef\u505a\u554a\u5582~~\n\n\u5bf9\u4e8e\u8fd9\u6837\u4e00\u4e2a\u95ee\u9898\uff0c\u539f\u56fe\u80af\u5b9a\u662f\u8981\u6ee1\u8db3\u67d0\u4e9b\u9650\u5236\u7684\uff0c\u5426\u5219\u4e0d\u53ef\u80fd\u6c42\u51fa\u8fd9\u4e2a\u95ee\u9898\u7684\u7b54\u6848\u3002\n\n\u5148\u505a\u4e00\u6b21\u8f6c\u6362\uff1a\u5982\u679c\u5c06\u56fe\u4e2d\u975e$i->i+1$\u7684\u8fb9\u770b\u4f5c\u533a\u95f4\uff0c\u90a3\u4e48$x->y$\u7684\u6700\u77ed\u8def\u7b49\u4ef7\u4e8e$[x,y]$\u8fd9\u6bb5\u5e8f\u5217\u5185\u90e8\u7684\u6700\u5927\u4e0d\u53ef\u91cd\u533a\u95f4\u96c6\u7684\u6743\u503c\n\n\u8fd9\u4e2a\u5f88\u663e\u7136\u3002\n\n\u518d\u6765\u4e00\u4e2a\u6027\u8d28\uff1a\u8fd9\u4e9b\u533a\u95f4\u8981\u4e48\u4e92\u76f8\u5305\u542b\uff0c\u8981\u4e48\u4ea4\u96c6\u4e3a\u7a7a\u3002\n\n\u8003\u8651\u82e5\u6709$x_1<x_2<x_3<x_4$\uff0c\u4e14$x_1->x_3$\uff0c$x_2->x_4$\uff0c\u5219\u53ef\u4ee5\u5f97\u5230\uff1a$p_{x_1}<p_{x_3},p_{x_1}>p_{x_2},p_{x_2}>p_{x_3}$\n\n\u6210\u73af\u4e86\uff0c\u77db\u76fe\u4e86\uff0c\u539f\u547d\u9898\u5c31\u6210\u7acb\u4e86\u3002\n\n\u90a3\u4e48\u63a5\u4e0b\u6765\u5957\u8def\u5730\u79fb\u52a8\u5de6\u7aef\u70b9\u7ef4\u62a4\u7b54\u6848\u3002\u5bf9\u4e8e\u6bcf\u4e2a\u70b9$i$\uff0c\u626b\u5230\u4ed6\u7684\u65f6\u5019\u7528$[i,to_i]$\u8fd9\u6761\u8fb9\u66f4\u65b0$to_i\\sim n$\u7684\u7b54\u6848\u5373\u53ef\u3002\n\n\u53ef\u4ee5\u8fd9\u4e48\u505a\u7684\u539f\u56e0\u662f\uff0c\u4e0d\u5b58\u5728\u4ea4\u53c9\u7684\u533a\u95f4\uff0c\u4e5f\u5c31\u662f$to_i$\u4e4b\u540e\u7684\u70b9\u7684\u6700\u77ed\u8def\u5fc5\u7136\u4f1a\u4ece$to_i$\u8fd9\u91cc\u66f4\u65b0\u8fc7\u53bb\n\n\u8fd9\u662f\u4e00\u4e2a\u533a\u95f4\u52a0\uff0c\u5355\u70b9\u8be2\u95ee\u7684\u5f62\u5f0f\uff0c\u53ef\u4ee5\u7528\u4e00\u4e2a\u5957\u8def\u7684\u6811\u72b6\u6570\u7ec4\u505a\u5b83\u3002\n\n\u4f60\u5c31\u5957\u8def\u5730\u89e3\u51b3\u4e86\u8fd9\u9053\u5957\u8def\u9898\u3002\n\n```cpp\n/*************************************************************************\n\t> File Name: CF1495F.cpp\n\t> Author: The-Out-Land\n\t> Mail: 2264454706@qq.com \n\t> Created Time: 2021\u5e7403\u670817\u65e5 \u661f\u671f\u4e09 19\u65f614\u520613\u79d2\n ************************************************************************/\n\n#include <bits/stdc++.h>\n\n#define enter putchar('\\n')\n#define space putchar(' ')\n#define re register\n#define N 800100\n#define int long long\n#define pii pair<int,int>\n#define fi first\n#define se second\n#define mp make_pair\n\nusing namespace std;\n\ninline int max(int x,int y){return (x>y?x:y);}\n\ninline int min(int x,int y){return (x<y?x:y);}\n\ninline int read(){\n\tint x=0;char c=getchar();bool y=1;\n\tfor(;c<'0' || c>'9';c=getchar()) if(c=='-') y=0;\n\tfor(;c>='0' && c<='9';c=getchar()) x=(x<<1)+(x<<3)+c-48;\n\tif(y) return x;\n\treturn -x;\n}\n\nint n,q,A[N],B[N],p[N],to[N];\n\nint ans[N];\n\nstruct BIT_Tree{\n\tint T[N];\n\tinline void add(int l,int r,int y){\n\t\tfor(re int i=l;i<=n;i+=(i&-i))\t\tT[i]+=y;\n\t\tfor(re int i=r+1;i<=n;i+=(i&-i))\tT[i]-=y;\n\t\treturn;\n\t}\n\tinline int query(int x){int ans=0;while(x>0) ans+=T[x],x&=(x-1);return ans;}\n}tree;\n\nint top;\n\npii st[N];\n\nset<int> U;\n\npii ver[N];int nex[N],head[N],nu;\n\ninline void add(int x,pii y){ver[++nu]=y,nex[nu]=head[x],head[x]=nu;return;}\n\ninline int Find(int x){\n\tint l=1,r=top,mid;\n\twhile(l<r){\n\t\tmid=(l+r)>>1;\n\t\tif(st[mid+1].fi>x)\tl=mid+1;\n\t\telse\t\t\t\tr=mid;\n\t}\n\treturn l;\n}\n\ninline void Input(){\n\tn=read(),q=read();\n\tfor(re int i=1;i<=n;++i) p[i]=read();\n\tfor(re int i=1;i<=n;++i) A[i]=read()+A[i-1];\n\tfor(re int i=1;i<=n;++i) B[i]=read();\n\tst[++top]=pii(n+1,n+1);\n\tfor(re int i=n;i;--i){\n\t\tint wh=Find(p[i]);\n\t\t//cerr<<top<<endl;\n\t\tto[i]=st[wh].se;\n\t\t//cout<<i<<\" \"<<to[i]<<endl;\n\t\tB[i]-=A[to[i]-1]-A[i-1];\n\t\twhile(p[i]>st[top].fi) --top;\n\t\tst[++top]=pii(p[i],i);\n\t}\n\treturn;\n}\n\ninline void solve(){\n\t++n;\n\tU.insert(1);\n\tU.insert(n);\n\tint L,R;\n\tadd(1,pii(n,0));\n\tfor(re int i=1;i<=q;++i){\n\t\tint X=read();\n\t\tif(X==1) continue;\n\t\t//cerr<<i<<endl;\n\t\tif(U.find(X)==U.end()){\n\t\t\t//cerr<<X<<endl;\n\t\t\tauto i1=U.lower_bound(X);\n\t\t\tR=*i1;--i1;L=*i1;\n\t\t\t//cerr<<i<<\" \"<<L<<\" ?? \"<<R<<endl;\n\t\t\tadd(L,pii(R,-i));\n\t\t\tadd(L,pii(X,i));\n\t\t\tadd(X,pii(R,i));\n\t\t\tU.insert(X);\n\t\t}\n\t\telse{\n\t\t\tauto i1=U.lower_bound(X);\n\t\t\tauto i2=i1;\n\t\t\t++i1,--i2;\n\t\t\tR=*i1,L=*i2;\n\t\t\tadd(L,pii(R,i));\n\t\t\tadd(L,pii(X,-i));\n\t\t\tadd(X,pii(R,-i));\n\t\t\tU.erase(X);\n\t\t}\n\t}\n\n\tfor(re int i=n-1;i;--i){\n\t\tint tar=to[i],val=B[i],las=tree.query(tar),delt;\n\t\t//cerr<<tar<<endl;\n\t\tif(las>=val) tree.add(tar,n,val-las);\n\t\tfor(re int j=head[i];j;j=nex[j]){\n\t\t\tpii y=ver[j];\n\t\t\tdelt=tree.query(y.fi);\n\t\t\tif(y.se>=0)\tans[ y.se]+=delt+A[y.fi-1]-A[i-1];\n\t\t\telse\t\tans[-y.se]-=delt+A[y.fi-1]-A[i-1];\n\t\t}\n\t}\n\n\tfor(re int i=1;i<=q;++i) ans[i]+=ans[i-1],printf(\"%lld\\n\",ans[i]);\n\treturn;\n}\n\nsigned main(){\n\tfreopen(\"data.in\",\"r\",stdin);\n\tfreopen(\"data.out\",\"w\",stdout);\n\tInput();\n\tsolve();\n\treturn 0;\n}\n```\n\n~~\u5b8c\u4e86\uff0c\u53ef\u4ee5\u5f3a\u5236\u5728\u7ebf\uff0c\u4eba\u6ca1\u4e86~~\n\n\u4f46\u662f\u597d\u50cf\u53ef\u4ee5\u628a\u533a\u95f4\u5efa\u51fa\u4e00\u68f5\u6811\uff0c\u7136\u540e\u6bcf\u6b21\u8be2\u95ee\u4e00\u4e0b\u4e24\u4e2a\u70b9\u4e4b\u95f4\u7684\u8ddd\u79bb\u3002\n\n\u5e94\u8be5\u5427\u3002",
        "postTime": 1615983666,
        "uid": 55357,
        "name": "Thaumaturge",
        "ccfLevel": 0,
        "title": "\u3010CF1495F\u3011Squares"
    },
    {
        "content": "# \u9898\u89e3 CF1495F Squares\n\nupdate:\u4e4b\u524d dp \u8f6c\u79fb\u65b9\u7a0b\u5199\u9519\u4e86\uff0c $\\min()$ \u5199\u6210\u4e86 $\\max()$ \uff0c\u73b0\u5df2\u4fee\u6b63\u3002\n\n[\u9898\u76ee\u94fe\u63a5](https://codeforces.com/problemset/problem/1495/F)\n\n[\u53ef\u80fd\u66f4\u597d\u7684\u9605\u8bfb\u4f53\u9a8c\uff1f](https://www.cnblogs.com/lsq147/p/14528053.html)\n\n## \u9898\u610f\u7b80\u8ff0\n\n\u7ed9\u5b9a\u957f\u5ea6\u4e3a $n$ \u7684\u4e09\u4e2a\u6570\u7ec4 $a,b,p$ \uff0c\u5176\u4e2d $p$ \u662f\u4e00\u4e2a\u6392\u5217\uff0c\u6784\u5efa\u4e00\u5f20 $n+1$ \u4e2a\u70b9\uff08\u70b9\u7f16\u53f7 $1\\sim n+1$ \uff09\u7684 DAG \uff0c\u5176\u4e2d\u70b9 $i(1\\le i\\le n)$ \u5411 $i+1$ \u8fde\u8fb9\u6743\u4e3a $a_i$ \u7684\u8fb9\u5e76\u4e14\u5411 $j$ \uff08 $j$ \u662f\u6700\u5c0f\u7684\u6ee1\u8db3 $j>i$ \u5e76\u4e14 $p_j>p_i$ \u7684 $j$ \uff0c\u5982\u679c\u4e0d\u5b58\u5728\u8ba4\u4e3a $j=n+1$ \uff09\u8fde\u8fb9\u6743\u4e3a $b_i$ \u7684\u8fb9\uff0c\u6709 $q$ \u6b21\u8be2\u95ee\uff0c\u6bcf\u6b21\u8be2\u95ee\u7ed9\u5b9a\u4e00\u4e2a\u70b9\u96c6 $S$ \uff0c\u8be2\u95ee $1$ \u5230 $n+1$ \u5fc5\u987b\u7ecf\u8fc7 $S$ \u4e2d\u7684\u6240\u6709\u5143\u7d20\u7684\u6700\u77ed\u8def\uff0c\u5176\u4e2d\u7b2c $i$ \u6b21\u8be2\u95ee\u7ed9\u5b9a\u7684 $S$ \u7531\u7b2c $i-1$ \u6b21\u8be2\u95ee\u7ed9\u5b9a\u7684 $S$ \u6dfb\u52a0\u6216\u8005\u5220\u9664\u4e00\u4e2a\u5143\u7d20\u5f97\u5230\u3002\n\n$1\\le n,q\\le 2\\times 10^5,-10^9\\le a_i,b_i\\le 10^9$ \u3002\n\n## \u9898\u76ee\u5206\u6790\n\n\u8ba4\u4e3a\u70b9 $i(1\\le i\\le n)$ \u5411 $i+1$ \u8fde\u8fb9\u6743\u4e3a $a_i$ \u7684\u8fb9\u4e3a A \u7c7b\u8fb9\uff0c\u70b9 $i(1\\le i\\le n)$ \u5411 $j$ \uff08 $j$ \u662f\u6700\u5c0f\u7684\u6ee1\u8db3 $j>i$ \u5e76\u4e14 $p_j>p_i$ \u7684 $j$ \uff0c\u5982\u679c\u4e0d\u5b58\u5728\u8ba4\u4e3a $j=n+1$ \uff09\u8fde\u8fb9\u6743\u4e3a $b_i$ \u7684\u8fb9\u4e3a B \u7c7b\u8fb9\u3002\n\n\u6784\u9020\u4e00\u68f5 $n+1$ \u4e2a\u70b9\u7684\u6811\uff08\u70b9\u7f16\u53f7 $0\\sim n$ \uff09\uff0c\u4f7f\u5f97 $i(1\\le i\\le n)$ \u7684\u7236\u6bcd\u7ed3\u70b9\u4e3a $j$ \uff08 $j$ \u662f\u6700\u5927\u7684\u6ee1\u8db3 $j<i$ \u5e76\u4e14 $p_j>p_i$ \u7684 $j$ \uff0c\u5982\u679c\u4e0d\u5b58\u5728\u8ba4\u4e3a $j=0$ \uff09\uff0c\u53ef\u4ee5\u53d1\u73b0\u5b58\u5728\u4e00\u4e2a\u7ecf\u8fc7\u7684\u70b9\u4f9d\u6b21\u662f $0,1,2,\\dots,n$ \u7684 dfs \u65b9\u5f0f\u3002\n\n\u8003\u8651\u4e00\u6761\u539f DAG \u4e2d\u4ece $1$ \u53f7\u70b9\u8d70\u5230 $n+1$ \u53f7\u70b9\u7684\u8def\u5f84\uff0c\u5982\u679c\u7ecf\u8fc7\u4e86\u4ee5 $i(1\\le i\\le n)$ \u4e3a\u8d77\u70b9\u7684 A \u7c7b\u8fb9\uff0c\u6211\u4eec\u8ba4\u4e3a\u9009\u62e9\u4e86 $i$ \u53f7\u70b9\uff0c\u8ba4\u4e3a $0$ \u53f7\u70b9\u4e00\u5f00\u59cb\u5c31\u662f\u88ab\u9009\u62e9\u7684\uff0c\u53ef\u4ee5\u53d1\u73b0\u4e00\u4e2a\u70b9\u6700\u591a\u53ea\u4f1a\u88ab\u9009\u62e9\u4e00\u6b21\uff0c\u5e76\u4e14\u4e00\u4e2a\u70b9 $i$ \u53ef\u4ee5\u88ab\u9009\u62e9\u5f53\u4e14\u4ec5\u5f53\u5b83\u5728\u6211\u4eec\u6784\u5efa\u7684\u6811\u4e2d\u7684\u6240\u6709\u7956\u5148\u7ed3\u70b9\u90fd\u88ab\u9009\u62e9\u4e86\uff08\u8fd9\u4e2a\u6bd4\u8f83\u597d\u8bc1\u660e\uff0c\u5047\u8bbe $i$ \u7684\u67d0\u4e2a\u7956\u5148\u7ed3\u70b9\u6ca1\u6709\u88ab\u9009\u62e9\uff0c\u627e\u5230\u6df1\u5ea6\u6700\u5c0f\u7684\u6ca1\u6709\u88ab\u9009\u62e9\u7684\u7956\u5148\u7ed3\u70b9 $j$ \uff0c\u8fd9\u6761\u8def\u5f84\u5fc5\u7136\u7ecf\u8fc7\u4e86 $j$ \u5e76\u4e14\u5728 $j$ \u8fd9\u4e2a\u70b9\u9009\u62e9\u4e86 B \u7c7b\u8fb9\u8d70\u4e86\u8fc7\u53bb\uff0c\u5bb9\u6613\u53d1\u73b0\u8fd9\u6761\u8fb9\u7684\u7ec8\u70b9\u7f16\u53f7\u5fc5\u7136\u5927\u4e8e $i$ \uff0c\u6240\u4ee5\u65e0\u8bba\u5982\u4f55\u90fd\u65e0\u6cd5\u7ecf\u8fc7 $i$ \uff0c\u66f4\u522b\u63d0\u9009\u62e9\u4e86\uff09\u3002\n\n\u5bb9\u6613\u53d1\u73b0\u4e00\u79cd\u9009\u62e9\u70b9\u7684\u65b9\u5f0f\uff08\u6ee1\u8db3\u5982\u679c $i$ \u9009\u4e86\u90a3\u4e48 $i$ \u7684\u6240\u6709\u7956\u5148\u90fd\u8981\u88ab\u9009\u5e76\u4e14 $0$ \u5fc5\u987b\u88ab\u9009\u62e9\uff09\u548c\u4e00\u6761 $1$ \u5230 $n+1$ \u7684\u8def\u5f84\u4e00\u4e00\u5bf9\u5e94\uff0c\u5e76\u4e14\u5fc5\u987b\u8981\u7ecf\u8fc7\u67d0\u4e2a\u70b9 $i$ \u7b49\u4ef7\u4e8e\u5fc5\u987b\u8981\u9009\u62e9 $i$ \u7684\u7236\u6bcd\u7ed3\u70b9\u3002\n\n\u5047\u8bbe\u6211\u4eec\u9009\u62e9\u7684\u70b9\u96c6\u4e3a $H$ \uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u9009\u62e9\u7684\u70b9\u96c6\u63a8\u51fa\u8fd9\u6761\u8def\u5f84\u7684\u957f\u5ea6\uff0c\u8fd9\u6761\u8def\u5f84\u7684\u957f\u5ea6\u5c31\u662f\u8fd9\u4e2a\uff08\u5176\u4e2d $\\operatorname{pa}_u$ \u8868\u793a $u$ \u7684\u7236\u6bcd\u7ed3\u70b9\uff09\uff1a\n$$\n\\sum_{u\\in H,u\\ne 0}a_u+\\sum_{u\\not\\in H,\\operatorname{pa}_u\\in H}b_u\n$$\n\u5982\u679c\u8ba4\u4e3a $a_0=b_0=0$ \uff0c\u90a3\u4e48\u8fd9\u4e2a\u5f0f\u5b50\u4e5f\u53ef\u4ee5\u5199\u6210\uff08\u5176\u4e2d $\\operatorname{child}_u$ \u8868\u793a $u$ \u7684\u5b69\u5b50\u7ed3\u70b9\u96c6\u5408\uff09\uff1a\n$$\n\\sum_{u\\in H}(-b_u+a_u+\\sum_{v\\in \\operatorname{child}_u}b_v)\n$$\n\u8bbe\uff1a\n$$\nc_u=-b_u+a_u+\\sum_{v\\in\\operatorname{child}_u}b_v\n$$\n\u90a3\u4e48\u8def\u5f84\u957f\u5ea6\u5c31\u662f\uff1a\n$$\n\\sum_{u\\in H}c_u\n$$\n\u95ee\u9898\u8f6c\u5316\u6210\u7ed9\u5b9a\u4e00\u68f5 $n+1$ \u4e2a\u70b9\u7684\u6709\u6839\u6811\uff08\u70b9\u7f16\u53f7 $0\\sim n$ \uff0c\u70b9 $i$ \u6743\u503c\u4e3a $c_i$ \uff09\uff0c\u6bcf\u6b21\u8be2\u95ee\u7ed9\u5b9a\u70b9\u96c6 $S$ \u8981\u6c42\u6c42\u51fa\u4e00\u4e2a\u5fc5\u987b\u5305\u542b $S$ \u548c $0$ \u7684\u6700\u5c0f\u6743\u503c\u8fde\u901a\u5757\u7684\u6743\u503c\u3002\n\n\u5148\u8003\u8651\u6ca1\u6709\u5fc5\u987b\u5305\u542b $S$ \u8fd9\u4e2a\u9650\u5236\uff0c\u8bbe $dp_i$ \u8868\u793a\u8003\u8651\u4ee5 $i$ \u4e3a\u6839\u7684\u5b50\u6811\uff0c\u5176\u4e2d\u5fc5\u987b\u5305\u542b $i$ \u8fd9\u4e2a\u70b9\u7684\u6700\u5c0f\u6743\u503c\u8fde\u901a\u5757\u7684\u6743\u503c\u4e3a\u591a\u5c11\uff0c\u8f6c\u79fb\uff1a\n$$\ndp_u=c_u+\\sum_{v\\in \\operatorname{child}_u}\\min(0,dp_v)\n$$\n\u8003\u8651\u52a0\u4e0a\u5fc5\u987b\u5305\u542b $S$ \u548c $0$ \u8fd9\u4e2a\u9650\u5236\uff0c\u4ee4\uff1a\n$$\nd_u=dp_u-\\min(0,dp_u)=\\max(0,dp_u)\n$$\n\u8bbe\u5fc5\u987b\u5305\u542b $S$ \u548c $0$ \u7684\u6700\u5c0f\u8fde\u901a\u5757\uff08\u8fd9\u91cc\u7684\u6700\u5c0f\u6307\u7684\u662f\u70b9\u7684\u6570\u91cf\u5c3d\u53ef\u80fd\u5c11\uff09\u4e3a $H$ \uff0c\u90a3\u4e48\u7b54\u6848\u5c31\u662f\uff1a\n$$\n\\sum_{u\\in H}(c_u+\\sum_{v\\in\\operatorname{child}_u,v\\not\\in H}\\min(0,dp_v))\n$$\n\n$$\n=\\sum_{u\\in H}(dp_u-\\sum_{v\\in\\operatorname{child}_u,v\\in H}\\min(0,dp_v))\n$$\n\n$$\n=dp_0+\\sum_{u\\in H,u\\ne 0}(dp_u-\\min(0,dp_u))\n$$\n\n$$\n=dp_0+\\sum_{u\\in H,u\\ne 0}d_u\n$$\n\n\u95ee\u9898\u8f6c\u5316\u6210\u6c42\u5fc5\u987b\u5305\u542b $S$ \u548c $0$ \u7684\u6700\u5c0f\u8fde\u901a\u5757\u7684\u6240\u6709\u70b9\u7684\u6743\u503c\uff0c\u7136\u540e\u5c31\u662f[\u5957\u8def\u9898](https://www.cnblogs.com/lsq147/p/14232473.html)\u4e86\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal O(n+q\\log_2n)$ \u6216\u8005 $\\mathcal O((n+q)\\log_2n)$ \uff0c\u53ef\u4ee5\u5f3a\u5236\u5728\u7ebf\u3002\n\n~~\u7efc\u4e0a\uff0c\u8fd9\u9053\u9898\u76ee\u5c31\u662f\u4e00\u9053\u5957\u8def\u9898\u3002~~\n\n## \u53c2\u8003\u4ee3\u7801\n\n```cpp\n#include<set>\n#include<cstdio>\n#include<cstring>\n#include<iostream>\n#include<algorithm>\n#define ch() getchar()\n#define pc(x) putchar(x)\nusing namespace std;\ntemplate<typename T>void read(T&x){\n\tstatic char c;static int f;\n\tfor(c=ch(),f=1;c<'0'||c>'9';c=ch())if(c=='-')f=-f;\n\tfor(x=0;c>='0'&&c<='9';c=ch())x=x*10+(c&15);x*=f;\n}\ntemplate<typename T>void write(T x){\n\tstatic char q[65];int cnt=0;\n\tif(x<0)pc('-'),x=-x;\n\tq[++cnt]=x%10,x/=10;\n\twhile(x)\n\t\tq[++cnt]=x%10,x/=10;\n\twhile(cnt)pc(q[cnt--]+'0');\n}\nconst int maxn=200005;\nint p[maxn],st[maxn],tp,pa[maxn][22],dp[maxn];\nlong long a[maxn],b[maxn],val[maxn],dis[maxn];\nint lca(int x,int y){\n\tif(dp[x]<dp[y])x^=y^=x^=y;\n\tfor(int t=dp[x]-dp[y],cn=0;t;t>>=1,++cn)\n\t\tif(t&1)x=pa[x][cn];\n\tif(x==y)return x;\n\tfor(int t=20;t>=0;--t)\n\t\tif(pa[x][t]!=pa[y][t])\n\t\t\tx=pa[x][t],y=pa[y][t];\n\treturn pa[x][0];\n}\nint vis[maxn],cnt[maxn];set<int>s;\nlong long sum;\nlong long dist(int x,int y){\n\treturn dis[x]+dis[y]-2*dis[lca(x,y)];\n}\nset<int>::iterator it;\nvoid ins(int x){\n\tit=s.insert(x).first;int l=*(--it);++it;++it;\n\tint r=((it==s.end())?*s.begin():*it);\n\tsum+=dist(l,x)+dist(x,r)-dist(l,r);\n}\nvoid del(int x){\n\tit=s.find(x);int l=*(--it);++it;++it;\n\tint r=((it==s.end())?*s.begin():*it);\n\tsum-=dist(l,x)+dist(x,r)-dist(l,r);\n\t--it;s.erase(it);\n}\nint main(){\n\tint n,q;read(n),read(q);\n\tfor(int i=1;i<=n;++i){\n\t\tread(p[i]);\n\t\twhile(tp&&p[st[tp]]<p[i])--tp;\n\t\tdp[i]=dp[pa[i][0]=st[tp]]+1;st[++tp]=i;\n\t\tfor(int j=1;(1<<j)<=dp[i];++j)\n\t\t\tpa[i][j]=pa[pa[i][j-1]][j-1];\n\t}\n\tfor(int i=1;i<=n;++i)read(a[i]),val[i]+=a[i];\n\tfor(int i=1;i<=n;++i)read(b[i]),val[i]-=b[i],val[pa[i][0]]+=b[i];\n\tfor(int i=n;i>=1;--i)dis[pa[i][0]]+=min(0ll,dis[i]+=val[i]),dis[i]-=min(0ll,dis[i]);\n\tdis[0]+=val[0];for(int i=1;i<=n;++i)dis[i]+=dis[pa[i][0]];cnt[0]=1;s.insert(0);\n\twhile(q--){\n\t\tint x;read(x);\n\t\tif(vis[x]){\n\t\t\tvis[x]=false;\n\t\t\tif(!(--cnt[pa[x][0]]))\n\t\t\t\tdel(pa[x][0]);\n\t\t}\n\t\telse{\n\t\t\tvis[x]=true;\n\t\t\tif(!(cnt[pa[x][0]]++))\n\t\t\t\tins(pa[x][0]);\n\t\t}\n\t\twrite(sum/2+dis[0]),pc('\\n');\n\t}\n\treturn 0;\n}\n```\n\n\u53e6\u5916\u5c31\u662f\u8fd9\u4e2a\u53c2\u8003\u4ee3\u7801\u548c\u5b98\u65b9\u9898\u89e3\u7ed9\u7684\u4ee3\u7801\u5e94\u8be5\u662f\u4e00\u6837\u7684\uff0c\u6211\u5e76\u4e0d\u662f\u6284\u88ad\u5b98\u65b9\u7684\uff0c\u56e0\u4e3a\u6211\u5c31\u662f\u51fa\u9898\u4eba qaq \u3002",
        "postTime": 1615605869,
        "uid": 230249,
        "name": "xiaolilsq",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 CF1495F Squares"
    },
    {
        "content": "## \u9898\u610f\u7b80\u8ff0\n\n\u8bf4\uff1a\u7ed9\u5b9a $n\\le 10^5,q\\le 10^5$ \u6bcf\u4e2a\u4f4d\u7f6e\u6709 $p_i,a_i,b_i$\uff0c\u4fdd\u8bc1 $p_i$ \u4e3a\u4e00\u4e2a\u6392\u5217\uff0c\u7136\u540e\u4f60\u53ef\u4ee5\u7528 $a_i$ \u7684\u4ee3\u4ef7\u4ece $i$ \u8d70\u5230 $i+1$\uff0c\u53ef\u4ee5\u7528 $b_i$ \u7684\u4ee3\u4ef7\u4ece $i$ \u8d70\u5230 $j$\uff0c$j$ \u662f $p_j>p_i$ \u7684\u6700\u9760\u524d\u7684 $j$\uff08$n+1$ \u662f\u7ec8\u70b9\uff0c$p_{n+1}=n+1$\uff09\uff0c$q$ \u6b21\u8be2\u95ee\uff0c\u4f60\u9700\u8981\u6c42\u7ecf\u8fc7\u6240\u6709\u5728 $S$ \u96c6\u5408\u4e2d\u7684\u70b9\u7684\u4ece $1$ \u5f00\u59cb\u8d70\u5230\u7ec8\u70b9\u7684\u6700\u5c0f\u6d88\u8017\u4ee3\u4ef7\u3002\n\n## \u9898\u89e3\n\u4ecb\u7ecd\u4e00\u4e2a\u9898\u89e3\u533a\u4e2d\u6ca1\u6709\u7684\u500d\u589e\u505a\u6cd5\u3002\n\n\u5c1d\u8bd5\u8d70\u7684\u8fc7\u7a0b\uff0c\u9996\u5148\u6ce8\u610f\u5230\uff0c\u94a6\u5b9a\u540e\uff0c\u53ea\u9700\u8981\u7b97\u51fa\u6765\u76f8\u90bb $S_i \\rightarrow S_{i+1}$ \u7684\u6700\u77ed\u8def\uff0c\u76f8\u5f53\u4e8e\u662f\u4e00\u4e2a\u533a\u95f4 $[l,r]$ \u8be2\u95ee\u4ece $l$ \u8d70\u5230 $r$ \u7684\u6700\u77ed\u8def\u3002\n\n\u5c1d\u8bd5\u89c2\u5bdf\u6700\u77ed\u8def\u7684\u5f62\u5f0f\uff0c\u5bf9\u4e8e\u67d0 $i$ \u5411\u540e\u8d70\u8def\u5411\u540e\u8d70\u8def\uff0c\u4ece $i$ \u5f00\u59cb\u4e00\u5b9a\u4f1a\u8d70\u5230\u6700\u8fd1\u7684 $j$ \u6ee1\u8db3 $p_j>p_i$\uff0c\u4eec\u6c42\u51fa\u6765 $F_i$ \u8868\u793a\u5230\u8fd9\u6837\u7684\u70b9\u7684\u6700\u77ed\u8def\uff0c\u8f6c\u79fb\u8981\u4e48\u7528 $b_i$ \u8d70\uff0c\u8981\u4e48\u7528 $a_i$ \u8d70\u7136\u540e\u8d70\u82e5\u5e72\u4e2a $F_i$ \uff08\u53ef\u4ee5\u4e00\u904d\u5355\u8c03\u6808\u6c42\u51fa\uff09\u3002\n\n\u8003\u8651 $l\\sim r$ \u7684\u8fc7\u7a0b\uff0c\u4f60\u53d1\u73b0\uff0c\u5f62\u5982 $l$ \u8d70\u5230 $l\\sim r$ \u4e4b\u95f4\u7684\u533a\u95f4 $\\max$ \u518d\u5f80\u4e0b\u8d70(\u610f\u601d\u662f\u4ece $p_i$ \u8f83\u5927\u8d70\u5230 $p_i$ \u8f83\u5c0f\u7684\u70b9)\u8d70\u5230 $r$ \u6ce8\u610f\u5230\uff0c\u4ece\u67d0 $i$ \u8d70\u5230 $k$ \uff08\u8bbe $p_i>p_k$\uff09 \u907f\u4e0d\u5f00\u6700\u5927\u7684 $j(i<j<k)$ \u6ee1\u8db3 $p_j>p_k$ \u6211\u4eec\u6c42 $G_k$ \u8868\u793a\u8fd9\u6837\u7684\u6700\u77ed\u8def\u957f\u5ea6\uff0c\u8f6c\u79fb\u662f\u7b80\u6d01\u7684\uff0c\u4ece $j$ \u51fa\u53d1\u5148\u8d70\u4e00\u4e2a $G$ \u518d\u8d70\u82e5\u5e72\u4e2a $F$ \u5230 $k$\uff08\u4e5f\u53ef\u4ee5\u4e00\u904d\u5355\u8c03\u6808\u6c42\u51fa\uff09\u3002\n\n\u82e5\u5c06 $F_i,G_i$ \u8fdb\u884c\u8fde\u8fb9\u5b9e\u9645\u4e0a\u753b\u51fa\u6765\u5f62\u5982\u6b63\u53cd\u4e24\u68f5\u6811\u7684\u5f62\u5f0f\uff0c\u5728\u7b2c\u4e00\u68f5\u6811\u4e0a\u500d\u589e\u6c42\u5f97\u533a\u95f4 $\\max$ \u4f4d\u7f6e\uff0c\u7136\u540e\u5230\u6839\u4f5c\u5dee\u5373\u53ef\u3002\n\n\u76f4\u63a5\u5904\u7406\uff0c\u53ef\u4ee5\u652f\u6301\u5f3a\u5236\u5728\u7ebf\uff0c\u590d\u6742\u5ea6 $O(n\\log n)-O(q\\log n)$ \u5982\u679c\u9884\u5904\u7406 $ST$ \u8868\u53ef\u4ee5\u4f18\u5316\u5230 $O(n\\log n)-O(q)$\u3002\n\n\n\n## \u4ee3\u7801\n\n```cpp\n#include<bits/stdc++.h>\nnamespace ifzw{\n//~ #define int LL\n#define ll long long\n#define dd double\n#define ull unsigned ll \n#define LL __int128\n#define siz(A) ((int)A.size())\nusing namespace std;\nchar gc(){static char buf[1<<16],*s,*t;if(s==t){t=(s=buf)+fread(buf,1,1<<16,stdin);if(s==t)return EOF;}return *s++;}\n#define getchar gc\nll read()\n{\n\tchar c;\n\tll w=1;\n\twhile((c=getchar())>'9'||c<'0')if(c=='-')w=-1;\n\tll ans=c-'0';\n\twhile((c=getchar())>='0'&&c<='9')ans=(ans<<1)+(ans<<3)+c-'0';\n\treturn ans*w;\n}\nvoid pc(char c,int op)\n{\n\tstatic char buf[1<<16],*s=buf,*t=buf+(1<<16);\n\t(op||((*s++=c)&&(s==t)))&&(fwrite(buf,1,s-buf,stdout),s=buf);\n}\nvoid wt(int x)\n{\n\tif(x>9)wt(x/10);\n\tpc('0'+x%10,0);\n}\nvoid wts(int x,char op)\n{\n\tif(x<0)pc('-',0),x=-x;\n\twt(x),pc(op,0);\n}\nchar ST;\nconst int xx=2e5+5;\nint n,q;\nint p[xx],a[xx],b[xx];\nint f[xx][21],tl[xx],stk[xx],top;\nll F[xx],G[xx];\nll ans;\nll get(int l,int r)\n{\n\tif(r==n+1)return F[l];\n\tint x=l;\n\tfor(int i=20;i>=0;i--)if(f[x][i]<=r)x=f[x][i];\n\treturn F[l]-F[x]+G[r]-G[x];\n}\nchar ED;\nint main(){\n\tcerr<<abs(&ST-&ED)/1024.0/1024<<\"\\n\";\n\t#ifdef AAA\n\tsystem(\"ulimit -s 524288\");\n\tcerr<<\" stack is on \\n\";\n\t#endif \n\t//~ freopen(\"a.in\",\"r\",stdin);\n\t//~ freopen(\"a.out\",\"w\",stdout);\n\tn=read(),q=read();\n\tfor(int i=1;i<=n;i++)p[i]=read();\n\tfor(int i=1;i<=n;i++)a[i]=read();\n\tfor(int i=1;i<=n;i++)b[i]=read();\n\tp[n+1]=1e9;\n\tstk[top=1]=n+1;\n\tfor(int i=n;i>=1;i--)\n\t{\n\t\twhile(top&&p[stk[top]]<p[i])--top;\n\t\tif(!top)f[i][0]=n+1,F[i]=0;\n\t\telse \n\t\t{\n\t\t\tf[i][0]=stk[top],F[i]=b[i];\n\t\t\tll s=a[i],x=i+1;\n\t\t\twhile(x!=stk[top])s+=F[x],x=f[x][0];\n\t\t\tF[i]=min(F[i],s);\n\t\t}\n\t\tstk[++top]=i;\n\t}\n\tf[n+1][0]=n+1;\n\tfor(int j=1;j<=20;j++)\n\t\tfor(int i=1;i<=n+1;i++)f[i][j]=f[f[i][j-1]][j-1];\n\tp[0]=1e9;\n\tstk[top=1]=0;\n\tfor(int i=1;i<=n;i++)\n\t{\n\t\tint ls=0;\n\t\twhile(top&&p[stk[top]]<p[i])ls=stk[top--];\n\t\tif(!top)tl[i]=0,G[i]=0;\n\t\telse \n\t\t{\n\t\t\ttl[i]=stk[top];\n\t\t\tif(stk[top]==i-1)G[i]=a[i-1];\n\t\t\telse G[i]=G[ls]+F[ls];\n\t\t}\n\t\tstk[++top]=i;\n\t}\n\tfor(int i=1;i<=n;i++)G[i]+=G[tl[i]];\n\tfor(int i=n;i>=1;i--)F[i]+=F[f[i][0]];\n\tset<int>s;\n\ts.insert(1),s.insert(n+1);\n\tans=get(1,n+1);\n\t//cerr<<get(2,3)<<\" \"<<F[2]<<\" \"<<F[3]<<\" \"<<G[2]<<\" \"<<G[3]<<\"@ss\\n\";\n\t\n\twhile(q--)\n\t{\n\t\tint x=read();\n\t\tif(x!=1)\n\t\t{\n\t\t\tif(s.count(x))\n\t\t\t{\n\t\t\t\ts.erase(x);\n\t\t\t\tint R=*s.lower_bound(x),L=*--s.lower_bound(x);\n\t\t\t\tans-=get(L,x);\n\t\t\t\tans-=get(x,R);\n\t\t\t\tans+=get(L,R);\n\t\t\t}\n\t\t\telse \n\t\t\t{\n\t\t\t\tint R=*s.lower_bound(x),L=*--s.lower_bound(x);\n\t\t\t\t//~ cerr<<x<<\" \"<<L<<\" \"<<R<<\" \"<<get(L,R)<<\" \"<<get(L,x)<<\" \"<<get(x,R)<<\"@\\n\";\n\t\t\t\ts.insert(x);\n\t\t\t\tans+=get(L,x);\n\t\t\t\tans+=get(x,R);\n\t\t\t\tans-=get(L,R);\n\t\t\t}\n\t\t}\n\t\tcout<<ans<<\"\\n\";\n\t}\n\t\n\tpc('1',1);\n\treturn 0;\n}\n\n}signed main(){return ifzw::main();}\n\n```",
        "postTime": 1683632406,
        "uid": 371852,
        "name": "\u4e00\u5ff5\u4e4b\u95f4\u3001\u3001",
        "ccfLevel": 0,
        "title": "CF1495F"
    },
    {
        "content": "[\u6211\u7684\u535a\u5ba2](https://2745518585.github.io/post/CF1495F-solution)\n\n\n### \u9898\u610f\n\n\u6709\u4e00\u6392\u683c\u5b50\uff0c\u6bcf\u4e2a\u683c\u5b50\u6709\u4e09\u4e2a\u6570 $p_i,a_i,b_i$\uff0c\u73b0\u5728\u4f60\u8981\u73a9\u4e00\u4e2a\u6e38\u620f\uff0c\u4f60\u7ad9\u5728\u7b2c\u4e00\u4e2a\u683c\u5b50\u4e0a\uff0c\u8981\u8df3\u5230\u7b2c $n+1$ \u4e2a\u683c\u5b50\uff0c$p_{n+1}=\\infty$\u3002\u6709\u4e00\u4e2a\u683c\u5b50\u96c6\u5408 $S$\uff0c\u4f60\u5fc5\u987b\u8df3\u5230 $S$ \u4e2d\u7684\u6240\u6709\u683c\u5b50(\u5176\u5b83\u968f\u610f)\u3002\n\n\u5047\u8bbe\u4f60\u7ad9\u5728\u683c\u5b50 $i$\uff0c\u4e0b\u4e00\u6b65\u4f60\u53ef\u4ee5\u9009\u62e9 : \n\n- \u82b1\u8d39 $a_i$ \u7684\u4ee3\u4ef7\uff0c\u8df3\u5230 $i+1$\u3002\n\n- \u82b1\u8d39 $b_i$ \u7684\u4ee3\u4ef7\uff0c\u8df3\u5230 $i$ \u540e\u9762\u7b2c\u4e00\u4e2a\u6ee1\u8db3 $p_j>p_i$ \u7684\u4f4d\u7f6e $j$\u3002\n\n\u4e00\u8f6e\u6e38\u620f\u7684\u4ee3\u4ef7\u662f\u8df3\u7684\u603b\u4ee3\u4ef7\u3002\n\n$q$ \u6b21\u8be2\u95ee\uff0c\u6bcf\u6b21\u53ef\u4ee5\u5728\u4e0a\u4e00\u6b21\u7684 $S$ \u4e2d\u6dfb\u52a0\u6216\u5220\u9664\u4e00\u4e2a\u5143\u7d20\u3002\n\n### \u601d\u8def\n\n\u56e0\u4e3a\u8d77\u70b9\u662f $1$\uff0c\u7ec8\u70b9\u662f $n+1$\uff0c\u6211\u4eec\u76f4\u63a5\u628a\u8fd9\u4e24\u4e2a\u70b9\u585e\u8fdb $S$\uff0c\u5e76\u65e0\u6cd5\u5220\u9664\u3002\n\n\u9996\u5148\u56e0\u4e3a\u9700\u8981\u7ecf\u8fc7 $S$ \u4e2d\u7684\u6240\u6709\u70b9\uff0c\u6211\u4eec\u53ef\u4ee5\u8f6c\u6362\u4e3a $S$ \u4e2d\u76f8\u90bb\u4e24\u70b9\u7684\u8ddd\u79bb\u548c\uff0c\u4e5f\u5c31\u662f $dis(S_1,S_k) = \\sum_{i=1}^{k-1} dis(S_{i-1},S_i)$\u3002\u7531\u4e8e\u76f8\u90bb\u4e24\u6b21\u8be2\u95ee\u53ea\u4fee\u6539\u4e86\u4e00\u4e2a\u70b9\uff0c\u6240\u4ee5\u76f8\u90bb\u4e24\u6b21\u8be2\u95ee\u7684\u7b54\u6848\u53ea\u6709 $O(1)$ \u6b21\u8be2\u95ee\u7684\u5dee\u8ddd\uff0c\u6bd4\u5982\u7b2c $t$ \u6b21\u6dfb\u52a0\u4e00\u4e2a\u70b9 $S_k$\uff0c\u5c31\u6709\uff1a\n\n$$ans_t = ans_{t-1} - dis(S_{t-1},S_{t+1}) + dis(S_{t-1},S_t) + dis(S_t,S_{t+1})$$\n\n\u628a\u8be2\u95ee\u79bb\u7ebf\u4e0b\u6765\u540e\uff0c\u5c31\u53d8\u6210\u4e86 $O(n)$ \u6b21\u8be2\u95ee $dis(x,y)$\u3002\n\n\u6211\u4eec\u628a\u7b2c\u4e00\u79cd\u8d70\u6cd5\u548c\u7b2c\u4e8c\u79cd\u8d70\u6cd5\u653e\u5728\u4e00\u8d77\u770b\uff0c\u770b\u8d77\u6765\u6211\u4eec\u53ef\u4ee5\u628a\u5de6\u7aef\u70b9 $l$ \u4ece $n+1$ \u79fb\u5230 $1$\uff0c\u8fc7\u7a0b\u4e2d\u5904\u7406\u8df3\u8dc3 $l,r$ \u7684\u8d70\u6cd5\u9020\u6210\u7684\u8d21\u732e\u3002\u5982\u679c\u5f53\u524d\u60c5\u51b5\u4e0b $l$ \u5230 $r$ \u7684\u4ee3\u4ef7\u6bd4\u76f4\u63a5\u8d70\u8fd9\u4e2a\u533a\u95f4\u7684\u4ee3\u4ef7\u5c0f\uff0c\u90a3\u4e48\u5c31\u6309\u539f\u6765\u7684\u8d70\uff0c\u5426\u5219\u5c31\u8d70\u8fd9\u4e2a\u533a\u95f4\u3002\u4f46\u662f\u8fd9\u6837\u5e76\u4e0d\u5bf9\uff0c\u56e0\u4e3a\u6211\u4eec\u6309\u5c40\u90e8\u6700\u4f18\u8d70\uff0c\u53ef\u80fd\u4e00\u4e0b\u5b50\u8d70\u8fc7\u4e86\u67d0\u4e2a\u8df3\u8dc3\u4f4d\u7f6e\uff0c\u5bfc\u81f4\u7ed3\u679c\u4e0d\u4f18\u3002\n\n\u4f46\u662f\u6211\u4eec\u8fd8\u6ca1\u6709\u7528\u5230\u7b2c\u4e8c\u79cd\u8d70\u6cd5\u7684\u7279\u6b8a\u4e4b\u5904\uff0c\u5206\u6790\u4e00\u4e0b\u53ef\u4ee5\u53d1\u73b0\uff0c\u7b2c\u4e8c\u79cd\u8d70\u6cd5\u7684\u533a\u95f4\u4e4b\u95f4\u8981\u4e48\u5305\u542b\u8981\u4e48\u4e0d\u4ea4\u3002\u6240\u4ee5\u50cf\u4e0a\u9762\u90a3\u6837\u8d70\u662f\u4e0d\u4f1a\u8df3\u8fc7\u67d0\u4e2a\u8df3\u8dc3\u4f4d\u7f6e\u7684\u3002\u5982\u679c\u4e00\u4e2a\u8df3\u8dc3 $l,r$ \u80fd\u9020\u6210\u8d21\u732e\uff0c\u90a3\u4e48 $l$ \u5230 $[r,n+1]$ \u7684\u4ee3\u4ef7\u90fd\u76f8\u5e94\u7684\u51cf\u5c0f\u76f8\u540c\u7684\u503c \uff0c\u7528\u6811\u72b6\u6570\u7ec4\u5373\u53ef\u7ef4\u62a4\u3002\n\n### code\n\n```cpp\n#include<cstdio>\n#include<algorithm>\n#include<vector>\n#include<set>\nusing namespace std;\ntypedef long long ll;\nconst int N=1000001;\nint n,m,c[N],d[N];\nll a[N],b[N],f[N],T[N];\nset<int> Set;\nstruct str\n{\n    int x,u,t;\n};\nvector<str> e[N];\nbool cmp(int x,int y)\n{\n    return c[x]>c[y];\n}\nvoid add(int x,ll k)\n{\n    while(x<=n+1)\n    {\n        T[x]+=k;\n        x+=(x&-x);\n    }\n}\nll sum(int x)\n{\n    ll s=0;\n    while(x>=1)\n    {\n        s+=T[x];\n        x-=(x&-x);\n    }\n    return s;\n}\nint main()\n{\n    scanf(\"%d%d\",&n,&m);\n    for(int i=1;i<=n;++i)\n    {\n        scanf(\"%d\",&c[i]);\n    }\n    for(int i=1;i<=n;++i)\n    {\n        scanf(\"%lld\",&a[i]);\n    }\n    for(int i=1;i<=n;++i)\n    {\n        scanf(\"%lld\",&b[i]);\n    }\n    c[n+1]=1e9;\n    for(int i=n;i>=1;--i)\n    {\n        int x=i+1;\n        while(c[x]<=c[i]) x=d[x];\n        d[i]=x;\n    }\n    Set.insert(1);\n    Set.insert(n+1);\n    e[1].push_back((str){n+1,1,0});\n    for(int i=1;i<=m;++i)\n    {\n        int x;\n        scanf(\"%d\",&x);\n        if(x==1) continue;\n        if(Set.count(x))\n        {\n            int z1=*(--Set.find(x)),z2=*(++Set.find(x));\n            e[z1].push_back((str){x,-1,i});\n            e[x].push_back((str){z2,-1,i});\n            e[z1].push_back((str){z2,1,i});\n            Set.erase(x);\n        }\n        else\n        {\n            Set.insert(x);\n            int z1=*(--Set.find(x)),z2=*(++Set.find(x));\n            e[z1].push_back((str){x,1,i});\n            e[x].push_back((str){z2,1,i});\n            e[z1].push_back((str){z2,-1,i});\n        }\n    }\n    for(int i=n+1;i>=1;--i)\n    {\n        if(i<=n)\n        {\n            add(i+1,a[i]);\n            ll z=sum(d[i]);\n            if(b[i]<z) add(d[i],b[i]-z);\n        }\n        for(int j=0;j<e[i].size();++j)\n        {\n            f[e[i][j].t]+=e[i][j].u*sum(e[i][j].x);\n        }\n    }\n    for(int i=1;i<=m;++i) f[i]+=f[i-1];\n    for(int i=1;i<=m;++i)\n    {\n        printf(\"%lld\\n\",f[i]);\n    }\n    return 0;\n}\n```\n\n",
        "postTime": 1677233576,
        "uid": 291248,
        "name": "\u8d75\u60a6\u5c91",
        "ccfLevel": 7,
        "title": "CF1495F \u9898\u89e3"
    }
]