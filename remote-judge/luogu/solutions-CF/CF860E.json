[
    {
        "content": "\u957f\u94fe\u5256\u5206\u7684\u7384\u5b66\u9898\u76ee\u3002\u91cd\u94fe\u5256\u5206\u8981$O(N\\log^2 N)$\u7684\u65f6\u95f4\u590d\u6742\u5ea6,LCA+\u5355\u8c03\u6808\u4e5f\u8981$O(N\\log N)$\u3002\u4f46\u662f\u957f\u94fe\u5256\u5206\u73c2\u4ee5$O(N)$\u3002\n\n\u5177\u4f53\u505a\u6cd5: \n\n\u89c2\u5bdf\u5230$ans_v=ans_{fa(v)}+dep_{fa(v)}+ans'_v$\uff0c\u5176\u4e2d$dep$\u4e3a\u6df1\u5ea6(\u6839\u7684\u6df1\u5ea6\u4e3a1)\uff0c$ans$\u4e3a\u7b54\u6848\uff0c$ans'_v$\u4e3a\u9664\u4e86$v$\u5916\u6240\u6709\u6df1\u5ea6\u4e3a$dep_v$\u7684\u70b9\u5bf9$v$\u4ea7\u751f\u7684\u8d21\u732e\u3002$dep_v$\u5728\u8fd9\u4e2a\u67ff\u5b50\u4e2d\u7684\u542b\u4e49\u662f$v$\u7684\u6240\u6709\u7956\u5148(\u4e0d\u5305\u542b\u81ea\u5df1)\u3002\n\n\u4e0d\u59a8\u4ee4`dfs(v)`\u8fd4\u56de\u4e00\u4e2avector,\u5176\u4e2dvector\u7684\u7b2c$d$\u9879\u662f\u4e00\u4e2a\u4e09\u5143\u7ec4$(ans'_x,x,cnt_x)$\uff0c\u5206\u522b\u8868\u793a\u4ec5\u8003\u8651$x$\u5728$v$\u7684\u5b50\u6811\u5185\u7684$dep$\u76f8\u540c\u7684\u70b9\u65f6\u7684$ans'_x$,\u5b50\u6811\u5185\u6df1\u5ea6\u4e3a$d$\u7684\u4efb\u610f\u4e00\u70b9$x$\u548c\u5b50\u6811\u5185\u6df1\u5ea6\u4e3a$d$\u7684\u70b9\u7684\u4e2a\u6570\u3002\n\n\u8003\u8651\u600e\u4e48\u5408\u5e76$v$\u7684\u4e24\u4e2a\u513f\u5b50\u7684vector\u3002\u663e\u7136\u5bf9\u5e94\u7684\u6df1\u5ea6\u7684\u4e09\u5143\u7ec4\u624d\u80fd\u5408\u5e76\u3002\u7136\u540e\u8003\u8651\u5982\u4f55\u5408\u5e76$(ans'_x,x,cnt_x)$\u548c$(ans'_y,y,cnt_y)$\u3002\u6211\u4eec\u53ea\u8981\u4ee4$ans'_x+=dep_v\\times cnt_y$,$ans'_y+=dep_v\\times cnt_x$,\u7136\u540e\u8fd4\u56de$(ans'_x,x,cnt_x+cnt_y)$\u3002\u4f46\u662f\u8fd9\u4e2a$ans'_y$\u7684\u503c\u663e\u7136\u4e0d\u80fd\u6254\u7740\u4e0d\u7ba1\u3002\u89c2\u5bdf\u5230\u63a5\u4e0b\u6765\u7684\u8fc7\u7a0b\u4e2d\u6240\u6709$dep$\u4e0e$x$,$y$\u76f8\u540c\u7684\u70b9\u90fd\u4f1a\u540c\u65f6\u5bf9$ans'_x$\u548c$ans'_y$\u4ea7\u751f\u8d21\u732e\uff0c\u4e5f\u5c31\u662f$ans'_y-ans'_x$\u7684\u503c\u5df2\u7ecf\u786e\u5b9a\u3002\u5728\u4e00\u5f20\u65b0\u56fe\u4e0a\u4ece$x$\u5411$y$\u8fde\u4e00\u6761\u8fb9\u6743\u4e3a$ans'_y-ans'_x$\u7684\u8fb9\u5373\u53ef\uff0c\u6700\u540e\u7ed3\u675f\u540e\u73c2\u4ee5\u7528\u8fd9\u5f20\u56fe\u8fd8\u539f\u3002\n\n\u5728\u5b9e\u73b0\u65f6\uff0c\u56e0\u4e3a$v$\u7684vector\u7684\u7b2c$d$\u9879\u5728$d< dep_v$\u65f6\u90fd\u662f\u65e0\u610f\u4e49\u7684\uff0c\u6240\u4ee5\u73c2\u4ee5\u7528\u4e00\u79cd\u652f\u6301`push_front`\u64cd\u4f5c\u7684\u6570\u636e\u7ed3\u6784(\u90bb\u63a5\u8868\uff09\u4ee3\u66ffvector\u3002\n\n\u8981\u8dd1\u56db\u904ddfs...(\u7b2c\u4e00\u904dLPD,\u7b2c\u4e8c\u904d\u5982\u4e0a\uff0c\u7b2c\u4e09\u904d\u8fd8\u539f$ans'$,\u7b2c\u56db\u6b65\u8ba1\u7b97$ans$)\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\nconst int N = 500005;\nusing ll = long long;\nint n;ll ans[N];\nvector<int> e[N];\nvector<pair<int,int>> g[N];\nint a[N],dep[N],lson[N],lv[N];\nint head[N],v[N],w[N],nxt[N],ptr;\ninline void add_edge(int uu,int vv,int ww)\n{v[ptr] = vv;w[ptr] = ww;nxt[ptr] = head[uu];head[uu] = ptr++;}\nvoid dfs1(int pos)\n{\n    for (auto &i : e[pos])\n    {   \n        dep[i] = dep[pos] + 1;dfs1(i);\n        if (lv[pos] < lv[i] + 1) lson[pos] = i,lv[pos] = lv[i] + 1;\n    }\n}\nvoid dfs2(int pos)\n{\n    if (lson[pos]) dfs2(lson[pos]),head[pos] = head[lson[pos]];\n    for (auto &i : e[pos])\n    {   \n        if (i == lson[pos]) continue;\n        dfs2(i);\n        int j = head[pos],k = head[i];\n        while (k != -1)\n        {\n            ans[w[k]] += dep[pos] * v[j];ans[w[j]] += dep[pos] * v[k];\n            g[w[j]].push_back({w[k],ans[w[k]] - ans[w[j]]});v[j] += v[k];\n            j = nxt[j];k = nxt[k];\n        }\n    }\n    add_edge(pos,1,pos);\n}\nvoid dfs3(int pos,bool rt = 1)\n{\n    if (rt && lson[pos]) dfs3(lson[pos]);\n    for (auto &i : g[pos]) ans[i.first] = ans[pos] + i.second,dfs3(i.first,0);\n}\nvoid dfs4(int pos)\n{\n    for (auto &i : e[pos]) ans[i] += dep[pos] + ans[pos],dfs4(i);\n}\nint main ()\n{\n    ios::sync_with_stdio(false);\n    cin >> n;int t1,rt = 0;\n    for (int i = 1;i <= n;i++)\n    {\n        cin >> t1;if (t1) e[t1].push_back(i);else rt = i;\n    }\n    memset(head,-1,sizeof(head));memset(nxt,-1,sizeof(nxt));\n    dep[rt] = 1;dfs1(rt);dfs2(rt);dfs3(rt);dfs4(rt);\n    for (int i = 1;i <= n;i++) cout << ans[i] << ' ';\n    return 0;\n}\n```",
        "postTime": 1583757659,
        "uid": 92602,
        "name": "SIGSEGV",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF860E \u3010Arkady and a Nobody-men\u3011"
    },
    {
        "content": "\u53c8\u6765\u6c34\u9898\u89e3\u4e86\u3002\u3002\u3002\n[\u6b22\u8fce\u6765\u6211\u7684blog\u901b\u901b~](https://blog.csdn.net/dream_lolita)\n\n\u7ed9\u5b9a\u4e00\u68f5$n$\u4e2a\u8282\u70b9\u7684\u6709\u6839\u6811\uff0c\u5b9a\u4e49$f(x,y)$\uff08\u5176\u4e2d$y$\u662f$x$\u7684\u7956\u5148\uff09\u8868\u793a$y$\u540e\u4ee3\u4e2d\u9664$x$\u4ee5\u5916\u6df1\u5ea6\u4e0d\u5927\u4e8e$x$\u7684\u8282\u70b9\u6570\u3002\u5b9a\u4e49$g(x)=\\sum f(x,y)$\u3002\u6c42\u6240\u6709$g(x)$\u3002$n\\leq 5\\times 10^5$\n\n\u4e00\u4e2a\u6bd4\u8f83$\\text{naive}$\u7684\u601d\u8def\u5c31\u662f\u5c06\u8282\u70b9\u6309\u6df1\u5ea6\u6392\u5e8f\u540e\u4e00\u5c42\u4e00\u5c42\u505a\uff0c\u7528\u6811\u94fe\u5256\u5206\u89e3\u51b3\u8fd9\u4e2a\u4e1c\u897f\u53ef\u4ee5\u505a\u5230$O(n\\log^2 n)$\uff0c\u4f46\u662f\u9700\u8981\u4e00\u5b9a\u5361\u5e38\u6280\u5de7\u3002\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u4f18\u5316\u8fd9\u4e2a\u8fc7\u7a0b\u3002\n\n\u6211\u4eec\u8981\u6c42\u7684\u4e1c\u897f\u53ef\u4ee5\u8868\u793a\u6210\u8fd9\u4e2a\uff1a\n$$g(x)=\\sum_{dep(y)\\leq dep(x)} dep(lca(x,y))-dep(x)$$\n\u7b49\u4ef7\u4e8e\uff1a\n$$g(fa(x))+\\sum_{dep(y)=dep(x)}dep(lca(x,y))-dep)(x)$$\n\u89c2\u5bdf\u5230\uff0c\u5982\u679c\u6211\u4eec\u5148\u5c06\u8fd9\u4e9b\u8282\u70b9\u6309$dfs$\u5e8f\u6392\u5e8f\uff0c\u5bf9\u4e8e\u7b2c$i$\u4e2a\u8282\u70b9\uff0c\u5b83\u524d\u9762\u7684\u8282\u70b9\u4e0e\u5b83\u7684$lca$\u7684\u6df1\u5ea6\u662f\u5355\u8c03\u4e0d\u964d\u7684\u3002\n\n\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u7ef4\u62a4\u4e00\u4e2a\u5355\u8c03\u6808\uff0c\u82e5\u76f8\u90bb\u8282\u70b9\u4e0e\u5f53\u524d\u8282\u70b9\u7684$lca$\u76f8\u540c\u53ef\u4ee5\u5c06\u76f8\u90bb\u8282\u70b9\u5408\u5e76\uff0c\u56e0\u4e3a\u663e\u7136\u4e4b\u540e\u5b83\u4eec\u7684$lca$\u4e5f\u662f\u76f8\u540c\u7684\uff0c\u540c\u6837\u4e5f\u4e0d\u5b58\u5728\u6808\u4e2d\u95f4\u4f1a\u5408\u5e76\u7684\u60c5\u51b5\u3002\u8fd9\u6837\u6bcf\u4e2a\u6df1\u5ea6\u4e0b\u603b\u7684\u5408\u5e76\u6b21\u6570\u5c31\u662f$O(\u70b9\u6570)$\u7684\u4e86\u3002\n\n\u603b\u590d\u6742\u5ea6\u5c31\u662f$O(n\\log n)$\uff0c$\\log$\u6765\u81ea\u4e8e\u6c42$lca$\n\n\u56e0\u4e3a\u6c42$lca$\u7684\u6b21\u6570\u6bd4\u8f83\u591a\uff0c\u5982\u679c\u4f7f\u7528$O(n\\log n)$\u9884\u5904\u7406\uff0c$O(1)$\u8be2\u95ee\u7684\u6b27\u62c9\u5e8f$lca$\u5e94\u8be5\u4f1a\u66f4\u4f18\u79c0\u3002~~\u4e0d\u8fc7\u89c2\u5bdf\u5230\u7a7a\u95f4\u6bd4\u8f83\u7d27\u5c31\u6ca1\u641e\u4e86\u3002~~\n\n\u3010\u53c2\u8003\u4ee3\u7801\u3011\n```cpp\n#include<bits/stdc++.h>\n#define pb push_back\nusing namespace std;\n\ntypedef long long ll;\nconst int N=5e5+10;\nint n,rt,fc[20],Log[N];\nll ans[N];\n\nnamespace IO\n{\n\tint read()\n\t{\n\t\tint ret=0;char c=getchar();\n\t\twhile(!isdigit(c)) c=getchar();\n\t\twhile(isdigit(c)) ret=ret*10+(c^48),c=getchar();\n\t\treturn ret;\n\t}\n\tvoid write(ll x){if(x>9)write(x/10);putchar(x%10^48);}\n\tvoid writesp(ll x){write(x);putchar(' ');}\n}\nusing namespace IO;\n\nnamespace Tree\n{\n\tint tot,ind;\n\tint head[N],dep[N],pos[N],fa[20][N];\n\tvector<int>st[N];\n\tstruct Tway{int v,nex;}e[N<<1];\n\tvoid add(int u,int v)\n\t{\n\t\te[++tot]=(Tway){v,head[u]};head[u]=tot;\n\t\te[++tot]=(Tway){u,head[v]};head[v]=tot;\n\t}\n\tvoid dfs(int x)\n\t{\n\t\tpos[x]=++ind;\n\t\tfor(int i=1;fc[i]<=dep[x];++i) fa[i][x]=fa[i-1][fa[i-1][x]];\n\t\tfor(int i=head[x];i;i=e[i].nex)\n\t\t{\n\t\t\tint v=e[i].v;\n\t\t\tif(v==fa[0][x]) continue;\n\t\t\tdep[v]=dep[x]+1;fa[0][v]=x;st[dep[v]].pb(v);dfs(v);\n\t\t}\n\t}\n\tint lca(int x,int y)\n\t{\n\t\tif(dep[x]<dep[y])swap(x,y);\n\t\tfor(int i=0,t=dep[x]-dep[y];i<20;++i) \n\t\t\tif(t&fc[i]) x=fa[i][x];\n\t\tfor(int i=19;~i;--i) if(fa[i][x]^fa[i][y])\n\t\t\tx=fa[i][x],y=fa[i][y];\n\t\treturn x==y?x:fa[0][x];\n\t}\n}\nusing namespace Tree;\n\nnamespace DreamLolita\n{\n\tstruct Stack\n\t{\n\t\tint len,a[N],b[N],c[N];//a=id,b=dep,c=pos\n\t\tvoid clear(){len=0;}\n\t\tvoid push(int x,int y,int z){++len;a[len]=x;b[len]=y;c[len]=z;}\n\t\tvoid pop(){--len;}\n\t\tint topa(){return a[len];}\n\t\tint topb(){return b[len];}\n\t\tll calctop(){return (ll)b[len]*(c[len]-c[len-1]);}\n\t}S;\n\tvoid initsomething()\n\t{\n\t\tfc[0]=1;for(int i=1;i<20;++i)fc[i]=fc[i-1]<<1;\n\t\tfor(int i=2;i<N;++i)Log[i]=Log[i>>1]+1;\n\t}\n\tbool cmp(int x,int y){return pos[x]<pos[y];}\n\tvoid calc(const vector<int> &a)\n\t{\n\t\tll res=0;S.clear();\n\t\tfor(int i=0;i<(int)a.size();++i)\n\t\t{\n\t\t\tint x=a[i];\n\t\t\tif(!i) S.push(x,0,0);\n\t\t\telse\n\t\t\t{\n\t\t\t\tfor(;;)\n\t\t\t\t{\n\t\t\t\t\tint y=lca(S.topa(),x);\n\t\t\t\t\tif(S.topb()<=dep[y]){S.push(x,dep[y]+1,i);break;}\n\t\t\t\t\tres-=S.calctop();S.pop();\n\t\t\t\t}\n\t\t\t\tres+=S.calctop();\n\t\t\t}\n\t\t\tans[x]+=res;\n\t\t}\n\t}\n\tvoid solve()\n\t{\n\t\tn=read();\n\t\tfor(int i=1,x;i<=n;++i) \n\t\t{\n\t\t\tx=read();\n\t\t\tif(x) add(i,x); else rt=i;\n\t\t}\n\t\tinitsomething();dfs(rt);\n\t\tfor(int d=1;d<=n;++d)\n\t\t{\n\t\t\tsort(st[d].begin(),st[d].end(),cmp);\n\t\t\tfor(int i=0;i<(int)st[d].size();++i) ans[st[d][i]]+=ans[fa[0][st[d][i]]]+d;\n\t\t\tcalc(st[d]);reverse(st[d].begin(),st[d].end());calc(st[d]);\n\t\t}\n\t\tfor(int i=1;i<=n;++i) writesp(ans[i]);\n\t}\n}\n\nint main()\n{\n#ifndef ONLINE_JUDGE\n\tfreopen(\"CF860E.in\",\"r\",stdin);\n\tfreopen(\"CF860E.out\",\"w\",stdout);\n#endif\n\tDreamLolita::solve();\n\treturn 0;\n}\n```",
        "postTime": 1548834585,
        "uid": 15438,
        "name": "Durant_Lee",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF860E \u3010Arkady and a Nobody-men\u3011"
    },
    {
        "content": "## [\u9898\u610f](https://www.luogu.com.cn/problem/CF860E)\n\n\u9996\u5148$g(x)=\\sum\\limits_{dep_y\\leqslant dep_x,y\\not =x}dep_{lca(x,y)}=g(fa_x)+dep_{fa_x}+\\sum\\limits_{dep_y=dep_x,y\\not= x}dep_{lca(x,y)}$\u3002\n\n\u4e8e\u662f\u6211\u4eec\u6709\u4e2a$O(n\\log^2 n)$\u7684\u505a\u6cd5\uff1a\u6bcf\u6b21\u5904\u7406\u540c\u6df1\u5ea6\u7684\u70b9\uff0c\u7528[$LNOI2014\\ LCA$](https://www.luogu.com.cn/blog/nofind/p4211-lnoi2014lca-shu-shang-ci-fen-li-xian-post)\u7684\u6811\u5256\u505a\u6cd5\u89e3\u51b3\u3002\n\n\u867d\u7136\u4e0a\u9762\u7684\u65b9\u6cd5\u80fd\u8fc7\uff0c\u4f46\u662f\u5e76\u6ca1\u6709\u7528\u5230\u5904\u7406\u7684\u8282\u70b9\u7684\u6df1\u5ea6\u76f8\u540c\u8fd9\u6837\u7684\u6027\u8d28\uff0c\u6211\u4eec\u53ef\u4ee5\u8fdb\u4e00\u6b65\u89c2\u5bdf\uff1a  \n\u5982\u679c\u6211\u4eec\u5c06\u8282\u70b9\u6309\u7167$dfs$\u5e8f\u8fdb\u884c\u6392\u5e8f\uff0c\u90a3\u4e48\u5bf9\u4e8e\u4e00\u4e2a\u70b9$x$\uff0c\u5176\u4e0e\u4e4b\u524d\u7684\u70b9\u7684$lca$\u7684\u6df1\u5ea6\u662f\u5355\u8c03\u4e0d\u964d\u7684\uff0c\u8fd9\u4e2a\u753b\u4e2a\u56fe\u5c31\u5f88\u663e\u7136\uff0c\u4e0d\u8bc1\u660e\u4e86\u3002 \n\n\u4e8e\u662f\u6211\u4eec\u4ece\u5de6\u5f80\u53f3\u548c\u4ece\u53f3\u5f80\u5de6\u626b\u4e00\u904d\uff0c\u6c42\u51fa\u70b9$a_x$\u7684\u7b54\u6848\uff0c\u4e2d\u9014\u7ef4\u62a4\u4e00\u4e2a\u6808\u3002\u6808\u4e2d\u5b58\u7684\u662f\u4e00\u6bb5\u70b9\uff0c\u8fd9\u4e9b\u70b9\u4e0e\u4e0a\u4e2a\u70b9$a_{x-1}$\u7684$lca$\u90fd\u76f8\u540c\uff0c\u6211\u4eec\u9009\u6700\u9760\u540e\u7684\u70b9\u4f5c\u4e3a\u4ee3\u8868\u70b9\u5e76\u8bb0\u5f55\u4e0e$a_{x-1}$\u7684$lca$\u7684\u6df1\u5ea6\u3002\n\n\u5982\u679c\u6808\u9876\u7684\u70b9\u4e0e$a_x$\u7684$lca$\uff08\u8bbe\u4e3a$y$\uff09\u7684\u6df1\u5ea6\u5c0f\u4e8e\u6808\u9876\u5b58\u7684\u6df1\u5ea6\uff0c\u90a3\u4e48\u6211\u4eec\u8981\u5f39\u6808\uff0c\u4e00\u76f4\u5230\u4e0d\u80fd\u5f39\u4e3a\u6b62\uff0c\u6b64\u65f6\u5f39\u6389\u7684\u70b9\u4e0e$a_x$\u7684$lca$\u90fd\u4e3a$y$\uff0c\u6211\u4eec\u5411\u6808\u4e2d\u65b0\u52a0\u5165\u4e00\u4e2a\u70b9\u5373\u53ef\u3002\n\n\u5f39\u6808\u7684\u4e2d\u9014\u7ef4\u62a4\u7b54\u6848\u5373\u53ef\u7b97\u51fa\u5bf9$a_x$\u7b54\u6848\u7684\u8d21\u732e\u3002\n\ncode:\n```\n#include<bits/stdc++.h>\nusing namespace std;\n#define int long long\nconst int maxn=5e5+10;\nint n,root;\nint ans[maxn];\ninline int read()\n{\n    char c=getchar();int res=0,f=1;\n    while(c<'0'||c>'9'){if(c=='-')f=-1;c=getchar();}\n    while(c>='0'&&c<='9')res=res*10+c-'0',c=getchar();\n    return res*f;\n}\nint cnt_edge;\nint head[maxn];\nstruct edge{int to,nxt;}e[maxn<<1];\ninline void add_edge(int u,int v)\n{\n\te[++cnt_edge]=(edge){v,head[u]};\n\thead[u]=cnt_edge;\n}\nint size[maxn],son[maxn],pre[maxn],dep[maxn];\nvector<int>ve[maxn];\nvoid dfs1(int x,int fa)\n{\n\tsize[x]=1;\n\tve[dep[x]=dep[pre[x]=fa]+1].push_back(x);\n\tfor(int i=head[x];i;i=e[i].nxt)\n\t{\n\t\tint y=e[i].to;\n\t\tif(y==fa)continue;\n\t\tdfs1(y,x);size[x]+=size[y];\n\t\tif(size[son[x]]<size[y])son[x]=y;\n\t}\n}\nint tim;\nint dfn[maxn],pos[maxn],top[maxn];\nvoid dfs2(int x,int tp)\n{\n\ttop[x]=tp;\n\tpos[dfn[x]=++tim]=x;\n\tif(son[x])dfs2(son[x],tp);\n\tfor(int i=head[x];i;i=e[i].nxt)\n\t{\n\t\tint y=e[i].to;\n\t\tif(y==pre[x]||y==son[x])continue;\n\t\tdfs2(y,y);\n\t}\n}\ninline int lca(int x,int y)\n{\n\twhile(top[x]!=top[y])\n\t\tif(dep[top[x]]>dep[top[y]])x=pre[top[x]];\n\t\telse y=pre[top[y]];\n\treturn dep[x]<dep[y]?x:y;\n}\nint tp;\nstruct node\n{\n\tint x,d,pos;\n}sta[maxn];\ninline int calc()\n{\n\tif(!tp)return 0;\n\treturn (sta[tp].pos-sta[tp-1].pos)*sta[tp].d;\n}\ninline void solve(vector<int> ve)\n{\n\ttp=0;\n\tint res=0;\n\tfor(unsigned int i=0;i<ve.size();i++)\n\t{\n\t\tint x=ve[i];\n\t\tif(!i)sta[++tp]=(node){x,0,0};\n\t\telse\n\t\t{\n\t\t\twhile(2333)\n\t\t\t{\n\t\t\t\tint y=lca(sta[tp].x,x);\n\t\t\t\tif(dep[y]>=sta[tp].d){sta[++tp]=(node){x,dep[y],i};break;}\n\t\t\t\tres-=calc();\n\t\t\t\ttp--;\n\t\t\t}\n\t\t\tres+=calc();\n\t\t}\n\t\tans[x]+=res;\n\t}\n}\nsigned main()\n{\n\tn=read();\n\tfor(int i=1;i<=n;i++)\n\t{\n\t\tint x=read();\n\t\tif(x)add_edge(x,i),add_edge(i,x);\n\t\telse root=i;\n\t} \n\tdfs1(root,0),dfs2(root,root);\n\tfor(int d=1;d<=n;d++)\n\t{\n\t\tfor(unsigned int i=0;i<ve[d].size();i++)ans[ve[d][i]]+=ans[pre[ve[d][i]]]+d-1;\n\t\tsolve(ve[d]);\n\t\treverse(ve[d].begin(),ve[d].end());\n\t\tsolve(ve[d]);\n\t}\n\tfor(int i=1;i<=n;i++)printf(\"%lld \",ans[i]);\n\treturn 0;\n}\n```\n",
        "postTime": 1592203692,
        "uid": 145441,
        "name": "nofind",
        "ccfLevel": 6,
        "title": "CF860E Arkady and a Nobody-men(\u601d\u7ef4\u9898)"
    },
    {
        "content": "\u8f6c\u5316\u4e00\u4e0b\u9898\u610f\uff1a\n\n$f(x,y)$ \u8868\u793a $y$ \u5b50\u6811\u4e2d\u6df1\u5ea6\u5c0f\u4e8e\u7b49\u4e8e $x$ \u7684\u6709\u591a\u5c11\u4e2a\u70b9\uff08\u5305\u62ec $x$ \uff09\uff1b\n\n$g(x)$ \u8868\u793a $x$ \u7684\u6240\u6709\u7956\u5148\u8282\u70b9\u7684\u513f\u5b50\u8282\u70b9\u4e2d\u6df1\u5ea6\u5c0f\u4e8e\u7b49\u4e8e $x$ \u7684\u70b9\u6709\u591a\u5c11\u4e2a\uff08\u8fd9\u4e9b\u70b9\u53ef\u4ee5\u91cd\u590d\uff09\u3002\n\n\u4e8e\u662f\u6211\u4eec\u53d1\u73b0\u5982\u679c\u4e00\u4e2a\u70b9\u4e0d\u5927\u4e8e\u53e6\u4e00\u4e2a\u70b9\u7684\u6df1\u5ea6\uff0c\u90a3\u4e48\u8fd9\u4e2a\u70b9\u5bf9\u53e6\u4e00\u4e2a\u70b9\u7684\u8d21\u732e\u5c31\u662f\u8fd9\u4e24\u4e2a\u70b9\u4ece\u81ea\u5df1\u5230\u6839\u8282\u70b9\u8def\u5f84\u4e0a\u6709\u591a\u5c11\u4e2a\u70b9\u662f\u76f8\u540c\u7684\uff0c\u5373\u6709\u591a\u5c11\u4e2a\u5171\u540c\u7956\u5148\u3002\n\n\u90a3\u4e48\u6211\u4eec\u5c31\u53ef\u4ee5\u628a\u8d21\u732e\u7d2f\u52a0\u5230\u7956\u5148\u8eab\u4e0a\uff0c\u67e5\u8be2\u4e00\u4e2a\u70b9\u7684\u7b54\u6848\u5c31\u662f\u8fd9\u4e2a\u70b9\u6240\u6709\u7956\u5148\u4e4b\u524d\u88ab\u7d2f\u52a0\u7684\u8d21\u732e\u4e4b\u548c\u3002\n\n\u90a3\u4e48\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\uff0c\u5982\u4f55\u4f7f\u6df1\u5ea6\u5c0f\u7684\u70b9\u4f18\u5148\u9020\u6210\u8d21\u732e\uff1f\n\n\u6211\u4eec\u628a\u70b9\u6309\u7167\u6df1\u5ea6\u6392\u5e8f\uff0c\u5229\u7528\u6811\u94fe\u5256\u5206\u4f9d\u6b21\u5c06\u8d21\u732e\u7d2f\u52a0\u5230\u7956\u5148\u8282\u70b9\u4e0a\u5373\u53ef\u3002\n\n\u5982\u679c\u4f7f\u7528\u7ebf\u6bb5\u6811\uff0c\u5e38\u6570\u8f83\u5927\uff0c\u4f1a\u51fa\u73b0 TLE \u7684\u60c5\u51b5\uff08~~\u5176\u5b9e\u53ea\u6709\u6211\u81ea\u5df1\u5e38\u6570\u5927\u5427~~\uff09\n\n\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5e38\u6570\u8f83\u5c0f\u7684\u6811\u72b6\u6570\u7ec4\u5b9e\u73b0\u533a\u95f4\u52a0\uff0c\u533a\u95f4\u6c42\u548c\uff08\u6709\u5174\u8da3\u7684\u540c\u5b66\u53ef\u4ee5\u53bb\u770b\u80e1\u5c0f\u5154 julao \u7684\u535a\u5ba2 orz \uff09\n\n\u90a3\u4e48\u6b64\u9898\u5c31\u5b8c\u7f8e\u89e3\u51b3\u4e86~\n\n\uff08\u4e0d\u8981\u5728\u610f\u6211\u5947\u602a\u7684\u53d8\u91cf\u540d\uff0c\u56e0\u4e3a\u4e00\u5f00\u59cb\u7528\u7684\u7ebf\u6bb5\u6811\u6240\u4ee5\u61d2\u5f97\u6539\u540d\u5b57\u4e86\uff09\n\n## Code\n```cpp\n#include<cstring>\n#include<iostream>\n#include<cstdio>\n#include<cmath>\n#include<algorithm>\nnamespace EMT{\n\ttypedef long long ll;typedef double db;//(double)clock() / (double)CLOCKS_PER_SEC;\n\t#define pf printf\n\t#define F(i,a,b) for(int i=a;i<=b;i++)\n\t#define D(i,a,b) for(int i=a;i>=b;i--)\n\tinline int read(){int x=0,f=1;char ch=getchar();while(ch<'0'||ch>'9'){if(ch=='-')f=-1;ch=getchar();}while(ch>='0'&&ch<='9')x=x*10+ch-'0',ch=getchar();return x*f;}\n\tinline void file(){auto it=freopen(\"in.in\",\"r\",stdin);it=freopen(\"my.out\",\"w\",stdout);it++;}\n\tinline int max(int a,int b){return a>b?a:b;}inline int min(int a,int b){return a<b?a:b;}\n\tinline void pi(ll x){pf(\"%lld \",x);}inline void pn(){pf(\"\\n\");}\n\tconst int N=5e5+10;\n\tint rt,co,head[N],n,dfn[N],siz[N],p[N],ti,fa[N],deep[N],top[N],son[N];ll ans[N];\n\tstruct node{int next,to;}e[N];\n\tinline void add(int next,int to){e[++co]=(node){head[next],to},head[next]=co;}\n\tinline void dfs1(int k,int fa){\n\t\tsiz[k]=1;\n\t\tfor(int i=head[k],j;i;i=e[i].next)if((j=e[i].to)!=fa){\n\t\t\tdeep[j]=deep[k]+1;\n\t\t\tdfs1(j,k);siz[k]+=siz[j];\n\t\t\tif(siz[son[k]]<siz[j])son[k]=j;\n\t\t}\n\t}\n\tinline void dfs2(int k,int tp){\n\t\ttop[k]=tp;dfn[k]=++ti;\n\t\tif(!son[k])return;\n\t\tdfs2(son[k],tp);\n\t\tfor(int i=head[k];i;i=e[i].next)\n\t\t\tif(e[i].to!=son[k]&&e[i].to!=fa[k])\n\t\t\t\tdfs2(e[i].to,e[i].to);\n\t}\n\tstruct seg{\n\t\tll sum1[N],sum2[N];\n\t\tinline void add(int x,int v){for(int i=x;i<=n;i+=i&-i)sum1[i]+=v,sum2[i]+=v*x;}\n\t\tinline void change(int l,int r){add(l,1),add(r+1,-1);}\n\t\tinline ll ask(int x){ll ans=0;for(int i=x;i;i-=i&-i)ans+=1ll*(x+1)*sum1[i]-sum2[i];return ans;}\n\t\tinline ll ask(int l,int r){return ask(r)-ask(l-1);}\n\t}segm;\n\tinline void change(int x){\n\t\twhile(x)segm.change(dfn[top[x]],dfn[x]),x=fa[top[x]];\n\t}\n\tinline ll ask(int x){\n\t\tll ans=0;\n\t\twhile(x)ans+=segm.ask(dfn[top[x]],dfn[x]),x=fa[top[x]];\n\t\treturn ans;\n\t}\n\tinline short main(){\n\t\tn=read();\n\t\tF(i,1,n){\n\t\t\tfa[i]=read();\n\t\t\tif(!fa[i])rt=i;else add(fa[i],i);\n\t\t}dfs1(rt,0);dfs2(rt,rt);\n\t\tF(i,1,n)p[i]=i;\n\t\tstd::sort(p+1,p+n+1,[](int i,int j){return deep[i]<deep[j];});\n\t\tint last=2;\n\t\tF(i,2,n){\n\t\t\tchange(fa[p[i]]);\n\t\t\tif(deep[p[i]]!=deep[p[i+1]]){\n\t\t\t\twhile(deep[p[last]]==deep[p[i]])ans[p[last]]=ask(fa[p[last]]),last++;\n\t\t\t}\n\t\t}\n\t\tF(i,1,n)pi(ans[i]);\n\t\treturn 0;\n\t}\n}\nsigned main(){return EMT::main();}\n\n```",
        "postTime": 1635763529,
        "uid": 451066,
        "name": "letitdown",
        "ccfLevel": 9,
        "title": "CF860E Arkady and a Nobody-men"
    },
    {
        "content": "\u53ef\u4ee5\u53d1\u73b0\uff0c\u5bf9\u70b9 $u$ \u7684\uff0c\u53ea\u9700\u8981\u8003\u8651\u90a3\u4e9b\u6df1\u5ea6\u5c0f\u4e8e\u7b49\u4e8e $deep_u$ \u7684\u70b9\u5bf9\u5b83\u7684\u8d21\u732e\uff0c\u5e76\u4e14\u6bcf\u4e2a\u70b9 $v$ \u7684\u8d21\u732e\u662f\u4f7f\u5f97 $father_v$ \u5230 $root$ \u8fd9\u6761\u8def\u5f84\u4e0a\u7684\u70b9\u7684 $f$ \u51fd\u6570 $+1$\uff0c\u540c\u65f6\u67e5\u8be2\u4e00\u4e2a\u70b9\u7684\u7b54\u6848\u5c31\u662f\u5230\u6839\u8282\u70b9\u7684\u8def\u5f84\u6c42\u548c\u3002  \n\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u62ff\u6811\u5256\u6765\u7ef4\u62a4\uff0c\u6309\u7167\u6df1\u5ea6\u4e00\u5c42\u4e00\u5c42\u52a0\u70b9\uff08\u8fd9\u91cc\u4f7f\u7528BFS\u5c31\u53ef\u4ee5\u8fc7\uff0c\u800c\u76f4\u63a5\u5bf9\u6df1\u5ea6\u6392\u5e8f\u662f\u8fc7\u4e0d\u53bb\u7684\uff09\uff0c\u8fd9\u6837\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u662f $O(n \\log^2 n)$ \u7684\uff0c\u7a0d\u5fae\u5361\u4e00\u5361\u5e38\u5c31\u53ef\u4ee5\u901a\u8fc7\u3002  \n\n```cpp\n \ntypedef long long ll;\n \nconst int MAXN = 5e5 + 7;\n \nstruct Node;\nstruct Edge { int t, next; } edge[MAXN << 1];\n\nint n, head[MAXN], cnt, dfn[MAXN], top[MAXN], deep[MAXN], ro, f[MAXN], size[MAXN], son[MAXN], q[MAXN], h, t = -1, g[MAXN];\nll val[MAXN];\nchar ch;\n\nNode *newNode(int l, int r, Node *lc, Node *rc);\n\nstruct Node {\n\tint l, r, mid;\n\tNode *lc, *rc;\n\tll sum; int tag;\n\t\n\tstatic Node *build(int l, int r) {\n\t\tif (l == r) return newNode(l, r, NULL, NULL);\n\t\tint mid = l + (r - l) / 2;\n\t\treturn newNode(l, r, build(l, mid), build(mid + 1, r));\n\t}\n\t\n\tvoid add(int le, int ri) {\n\t\tif (le == l && ri == r) {\n\t\t\ttag++; sum += r - l + 1;\n\t\t\treturn;\n\t\t}\n\t\tpushDown();\n\t\tif (ri <= mid) lc->add(le, ri);\n\t\telse if (le > mid) rc->add(le, ri);\n\t\telse lc->add(le, mid), rc->add(mid + 1, ri);\n\t\tsum = lc->sum + rc->sum;\n\t}\n\t\n\tvoid plus(ll d) {\n\t\tsum += 1ll * (r - l + 1ll) * d, tag += d; \n\t}\n\t\n\tvoid pushDown() {\n\t\tif (tag) lc->plus(tag), rc->plus(tag), tag = 0;\n\t}\n\t\n\tll query(int le, int ri) {\n\t\tif (le == l && r == ri) return sum;\n\t\tpushDown();\n\t\tif (ri <= mid) return lc->query(le, ri);\n\t\telse if (le > mid) return rc->query(le, ri);\n\t\telse return lc->query(le, mid) + rc->query(mid + 1, ri);\n\t}\n} *root, pool[MAXN << 1], *tail = pool;\n\nNode *newNode(int l, int r, Node *lc, Node *rc) {\n\tNode *ret = ++tail;\n\tret->l = l, ret->r = r, ret->mid = l + (r - l) / 2;\n\tret->lc = lc, ret->rc = rc;\n\tret->sum = ret->tag = 0;\n\treturn ret;\n}\n \ninline void add(int u, int v) {\n\tedge[++cnt] = (Edge){v, head[u]}; head[u] = cnt;\n}\n \ninline void init(int u, int pre) {\n\tf[u] = pre;\n\tdeep[u] = deep[pre] + 1;\n\tsize[u] = 1;\n\tint v;\n\tPE(e, u) {\n\t\tv = edge[e].t;\n\t\tinit(v, u);\n\t\tsize[u] += size[v];\n\t\tif (size[v] > size[son[u]]) son[u] = v;\n\t}\n}\n \ninline void split(int u, int tip) {\n\ttop[u] = tip;\n\tstatic int ts = 0;\n\tdfn[u] = ++ts;\n\tif (son[u]) split(son[u], tip);\n\tint v;\n\tPE(e, u) {\n\t\tv = edge[e].t;\n\t\tif (v == son[u]) continue;\n\t\tsplit(v, v);\n\t}\n}\n \ninline char nc(){\n    #define SIZE 300000+3\n    static char buf[SIZE],*p1 = buf+SIZE,*p2 = buf+SIZE;\n    if(p1 == p2){\n        p1 = buf;p2 = buf+fread(buf,1,SIZE,stdin);\n        if(p1 == p2) return -1;\n    }\n    return *p1++;\n}\n \ninline void read(int &x){\n    ch = nc();x = 0;\n    while(!isdigit(ch)) ch = nc();\n    while(isdigit(ch)) x = x * 10 + ch - '0', ch = nc();\n}\n \ninline void write(ll x) {\n    if(x > 9) write(x / 10);\n    putchar(x % 10 + '0');\n}\n \nint main() {\n\tread(n);\n\t\n\tint u;\n\t\n\trep(i, 1, n) {\n\t\tread(u);\n\t\tif (!u) ro = i;\n\t\telse add(u, i);\n\t}\n\t\n\tinit(ro, 0);\n\tsplit(ro, ro);\n\troot = Node::build(1, n);\n\t\n\tint now = 0, tail, v;\n\tq[++t] = ro;\n\t\n\twhile (h <= t) {\n\t\tnow++;\n\t\ttail = 0;\n\t\t\n\t\twhile (deep[q[h]] == now) {\n\t\t\tu = q[h]; h++;\n\t\t\tg[++tail] = u;\n\t\t\t\n\t\t\tPE(e, u) {\n\t\t\t\tv = edge[e].t;\n\t\t\t\tq[++t] = v;\n\t\t\t}\n\t\t\t\n\t\t\tv = f[u];\n\t\t\tfor (;v; v = f[top[v]]) root->add(dfn[top[v]], dfn[v]);\n\t\t}\n\t\t\n\t\trep(i, 1, tail) {\n\t\t\tu = v = g[i];\n\t\t\tfor (;v;v = f[top[v]]) val[u] += root->query(dfn[top[v]], dfn[v]);\n\t\t}\n\t}\n\t\n\trep(i, 1, n) write(val[i]), putchar(' ');\n\treturn 0;\n}\n```",
        "postTime": 1571627804,
        "uid": 52748,
        "name": "Logey",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 CF860E \u3010Arkady and a Nobody-men\u3011"
    },
    {
        "content": "\u6811\u5256\u52a0\u4e0a\u5404\u79cd\u5947\u5947\u602a\u602a\u7684\u5361\u5e38\u6280\u5de7\u5c45\u7136A\u6389\u4e86\u8fd9\u9898\u3002\u3002\u3002\n\n\u7531\u6d45\u5165\u6df1\u6bcf\u6b21\u52a0\u5165\u540c\u4e00\u6df1\u5ea6\u6240\u6709\u70b9\uff0c\u518d\u7528\u6811\u5256\u7edf\u8ba1\u3002\n\n\u533a\u95f4\u4fee\u6539\u533a\u95f4\u67e5\u8be2\u3002\n\n\u6bd2\u7624\u65e0\u6bd4\u7684\u4ee3\u7801\n\n\n```#include <bits/stdc++.h>\nusing namespace std;\n#define lson l,mid,rt<<1\n#define rson mid+1,r,rt<<1|1\ntemplate <class T> void read(T &x){ x = 0; int f = 1; char ch = getchar(); while(ch < '0' || ch > '9'){ if(ch == '-') f = -1; ch = getchar(); } while(ch >= '0' && ch <= '9') x = (x << 3) + (x << 1) + ch - '0', ch = getchar(); x *= f; }\nconst int maxn=1000005;\nint n,tid[maxn],top[maxn],ran[maxn],son[maxn],cnt,head[maxn],root,siz[maxn],idx,dep[maxn],fa[maxn];\nlong long ans[maxn],tree[maxn<<2],lazy[maxn<<2];\nqueue<int>q;\nstruct edge{int to,next;\n}e[maxn<<1];\nvoid dfs1(int u,int pre)\n{\n    dep[u]=dep[pre]+1;\n    siz[u]=1;\n    fa[u]=pre;\n    for(int i=head[u];i;i=e[i].next)\n    {\n        if(e[i].to==pre)continue;\n        dfs1(e[i].to,u);\n        siz[u]+=siz[e[i].to];\n        if(son[u]==-1||siz[e[i].to]>siz[son[u]])\n        {\n            son[u]=e[i].to;\n        }\n    }\n}\nvoid dfs2(int u,int t)\n{\n    top[u]=t;\n    tid[u]=++idx;\n    ran[idx]=u;\n    if(son[u]==-1)return ;\n    dfs2(son[u],t);\n    for(int i=head[u];i;i=e[i].next)\n    {\n        if(e[i].to==fa[u]||e[i].to==son[u])continue;\n        dfs2(e[i].to,e[i].to);\n    }\n}\nvoid add(int a,int b)\n{\n    e[cnt].to=b;\n    e[cnt].next=head[a];\n    head[a]=cnt++;\n}\nvoid pushdown(int l,int r,int rt)\n{\n    if(!lazy[rt])return ;\n    int mid=(l+r)>>1;\n    tree[rt<<1]+=(long long)lazy[rt]*(mid-l+1);\n    tree[rt<<1|1]+=(long long)lazy[rt]*(r-mid);\n    lazy[rt<<1]+=lazy[rt];\n    lazy[rt<<1|1]+=lazy[rt];\n    lazy[rt]=0;\n}\nvoid update(int L,int R,int l,int r,int rt)\n{\n    if(L<=l&&R>=r)\n    {\n        tree[rt]+=(r-l+1);\n        lazy[rt]++;\n        return ;\n    }\n    pushdown(l,r,rt);\n    int mid=(l+r)>>1;\n    if(L<=mid)update(L,R,lson);\n    if(R>mid)update(L,R,rson);\n    tree[rt]=tree[rt<<1]+tree[rt<<1|1];\n}\nvoid change(int u)\n{\n    while(u)\n    {\n        update(tid[top[u]],tid[u],1,n,1);\n        u=fa[top[u]];\n    }\n}\nlong long query(int L,int R,int l,int r,int rt)\n{\n    if(L<=l&&R>=r)return tree[rt];\n    pushdown(l,r,rt);\n    int mid=(l+r)>>1;\n    long long as=0;\n    if(L<=mid)as+=query(L,R,lson);\n    if(R>mid)as+=query(L,R,rson);\n    return as;\n}\nvoid getans(int u)\n{\n    int x=u;\n    u=fa[u];\n    while(u)\n    {\n        ans[x]+=query(tid[top[u]],tid[u],1,n,1);\n        ans[x]-=(tid[u]-tid[top[u]]+1);\n        u=fa[top[u]];\n    }\n}\nvoid write(long long x)\n{\n    if(x>9)write(x/10);\n    putchar(x%10+'0');\n}\nint main()\n{\n    memset(son,-1,sizeof(son));\n    read(n);cnt=1;idx=0;\n    int a;\n    for(int i=1;i<=n;++i)\n    {\n        read(a);\n        if(a==0){root=i;}\n        else add(a,i);\n    }if(n==1){puts(\"0\");return 0;\n\t\t}\n    dfs1(root,0);\n    dfs2(root,root);\n    q.push(root);\n    int nowdep=0;\n    while(!q.empty())\n    {\n        queue<int>g;\n        nowdep++;\n        while(dep[q.front()]==nowdep)\n        {\n            int u=q.front();q.pop();g.push(u);\n            for(int i=head[u];i;i=e[i].next)\n            {\n                q.push(e[i].to);\n            }\n            change(u);\n        }\n        while(!g.empty())\n        {\n            int u=g.front();g.pop();\n            getans(u);\n        }\n    }\n    for(int i=1;i<=n;++i)write(ans[i]),putchar(' ');\n}\n//\u4e0d\u8fc7\u542c\u8bf4\u597d\u50cf\u6709nlogn\u7684\u89e3\u6cd5\u624d\u662f\u6b63\u89e3\u3002\u3002\u3002",
        "postTime": 1543493221,
        "uid": 55703,
        "name": "ywh666",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF860E \u3010Arkady and a Nobody-men\u3011"
    }
]