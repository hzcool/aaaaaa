[
    {
        "content": "[CF1515I Phoenix and Diamonds](https://www.luogu.com.cn/problem/CF1515I)\u89e3\u9898\u62a5\u544a\uff1a\n\n[\u66f4\u597d\u7684\u9605\u8bfb\u4f53\u9a8c](https://zybuluo.com/xiaoziyao/note/1794035)\n\n\u4f3c\u4e4e\u662f\u4f60\u8c37\u9996\u6740\uff0c\u9488\u4e0d\u6233\u3002\n\n## \u9898\u610f\n\n$n$\u79cd\u94bb\u77f3\uff0c\u4e00\u9897\u7b2c$i$\u79cd\u94bb\u77f3\u91cd\u91cf\u4e3a$w_i$\uff0c\u4ef7\u503c\u4e3a$v_i$\uff0c\u4e00\u5f00\u59cb\u7b2c$i$\u4e2d\u94bb\u77f3\u7684\u5e93\u5b58\u4e3a$a_i$\u3002\u63a5\u4e0b\u6765\u8fdb\u884c$m$\u6b21\u64cd\u4f5c\uff1a\n\n- $1\\ k\\ d$\uff1a\u8fdb\u8d27\u4e86$k$\u4e2a\u79cd\u7c7b\u4e3a$d$\u7684\u94bb\u77f3\uff1b\n- $2\\ k\\ d$\uff1a\u5356\u51fa\u4e86$k$\u4e2a\u79cd\u7c7b\u4e3a$d$\u7684\u94bb\u77f3\uff1b\n- $3\\ c$\uff1a\u5982\u679c\u4f60\u6709\u4e00\u4e2a\u5927\u5c0f\u4e3a$c$\u7684\u888b\u5b50\uff0c\u4e14\u6309\u7167\u7b2c\u4e00\u5173\u952e\u5b57\u4e3a\u4ef7\u503c\uff08\u4ece\u5927\u5230\u5c0f\uff09\uff0c\u7b2c\u4e8c\u5173\u952e\u5b57\u4e3a\u91cd\u91cf\uff08\u4ece\u5c0f\u5230\u5927\uff09\u7684\u987a\u5e8f\u53d6\u94bb\u77f3\u7684\u8bdd\uff0c\u4f60\u6700\u7ec8\u53ef\u4ee5\u53d6\u5230\u94bb\u77f3\u7684\u4ef7\u503c\u4e3a\u591a\u5c11\uff08\u6ce8\u610f\u64cd\u4f5c\u4e0d\u4f1a\u771f\u6b63\u6267\u884c\uff09\n\n$1\\leqslant n\\leqslant 2\\times 10^5,1\\leqslant m\\leqslant 10^5,1\\leqslant k,d,a_i\\leqslant 10^5,1\\leqslant c\\leqslant 10^{18}$\n\n## \u5206\u6790\n\n\u795e\u5947\u7684\u9898\u76ee\uff0c\u611f\u89c9\u6ca1\u6709CF*3400\u8bc4\u5206\u8fd9\u4e48\u5938\u5f20\uff0c\u4e0d\u8fc7\u8fd9\u6570\u636e\u786e\u5b9e\u5f3a\u3002\n\n\u7531\u4e8e\u94bb\u77f3\u79cd\u7c7b\u5df2\u7ecf\u7ed9\u5b9a\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u77e5\u9053\u62ff\u94bb\u77f3\u7684\u4f18\u5148\u7ea7\u3002\n\n\u53d1\u73b0\u5904\u7406\u8be2\u95ee\u7684\u590d\u6742\u5ea6\u4e0e$c$\u603b\u5f97\u6709\u70b9\u5173\u7cfb\uff0c\u770b$c$\u7684\u6570\u636e\u8303\u56f4\u5c31\u5927\u80c6\u731c\u60f3\u590d\u6742\u5ea6\u8981\u5e26$\\log C$\uff0c\u90a3\u4e48\u8003\u8651\u5982\u4f55\u6bcf\u6b21\u81f3\u5c11\u628a$c$\u9664\u4e8c\u3002\n\n\u8bbe$c$\u7684\u6700\u9ad8\u4f4d\u4e3a$\\omega$\uff0c\u5bf9\u4e8e\u7b2c$\\omega$\u4f4d\uff0c\u8bbe\u4e00\u4e2a\u94bb\u77f3\u662f\u201c\u8f7b\u7684\u201d\u5f53\u4e14\u4ec5\u5f53\u5176\u91cd\u91cf\u5c0f\u4e8e$2^{\\omega-1}$\uff0c\u5426\u5219\u5982\u679c\u5b83\u7684\u91cd\u91cf\u5c0f\u4e8e$2^{omega}$\uff0c\u90a3\u4e48\u5b83\u662f\u201c\u91cd\u7684\u201d\uff0c\u4e00\u4e2a\u5f88\u663e\u7136\u7684\u7ed3\u8bba\u5c31\u662f\u5728\u6700\u9ad8\u4f4d\u4e0d\u53d8\u7684\u60c5\u51b5\u4e0b\u4e0d\u80fd\u53d6\u591a\u4e8e\u4e00\u4e2a\u201c\u91cd\u7684\u201d\u94bb\u77f3\u3002\n\n\u81ea\u7136\u800c\u7136\u5730\u8bbe$lightv_{l,r,k}/lightw_{l,r,k}$\u8868\u793a\u5bf9\u4e8e\u7b2c$k$\u4f4d\uff0c$l$\u5230$r$\u201c\u8f7b\u7684\u201d\u94bb\u77f3\u4ef7\u503c\u548c\u4e0e\u91cd\u91cf\u548c\uff0c$extra_{l,r,k}$\u8868\u793a\u5bf9\u4e8e\u7b2c$k$\u4f4d\uff0c$l$\u5230$r$\u201c\u8f7b\u7684\u201d\u94bb\u77f3\u91cd\u91cf\u52a0\u4e0a\u4e00\u4e2a\u6700\u5c0f\u7684\u201c\u91cd\u7684\u201d\u94bb\u77f3\u7684\u91cd\u91cf\u4e4b\u548c\u3002\n\n\u72b6\u6001\u662f$O(n^2\\log c)$\u7684\uff0c\u4e0d\u597d\u5b58\u50a8\uff0c\u8003\u8651\u4e0a\u7ebf\u6bb5\u6811\uff0c\u5c06\u4e0a\u9762\u7684\u533a\u95f4$[l,r]$\u6539\u4e3a\u5176\u5bf9\u5e94\u7ebf\u6bb5\u6811\u4e0a\u7684\u7ed3\u70b9$now$\uff0c\u90a3\u4e48\u5f88\u5bb9\u6613\u5199\u51fa\u4e00\u4e2a$\\log c$\u7684$\\text{pushup}$\u6765\u52a8\u6001\u7ef4\u62a4\u8fd9\u4e09\u4e2a\u6570\u7ec4\u3002\n\n\u67e5\u8be2\u90e8\u5206\uff0c\u6211\u4eec\u5c31\u5148\u5224\u6389\u53f6\u5b50\u7ed3\u70b9\u7684\u60c5\u51b5\uff0c\u7136\u540e\u8003\u8651\u91cd\u94bb\u77f3\u4e0e\u8f7b\u94bb\u77f3\u90fd\u53ef\u4ee5\u53d6\u8d70\u7684\u60c5\u51b5\uff0c\u7136\u540e\u518d\u5224\u4e00\u5224\u662f\u4e0d\u662f\u53ea\u80fd\u53d6\u8f7b\u94bb\u77f3\uff0c\u5982\u679c\u90fd\u4e0d\u662f\u7684\u8bdd\u5c31\u9012\u5f52\u4e24\u4e2a\u513f\u5b50\u5904\u7406\u3002\n\n\u8bb0\u5f97\u52a8\u6001\u7ef4\u62a4\u5f53\u524d$c$\u7684\u6700\u9ad8\u4f4d$\\omega$\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a$O((n+q)\\log n\\log c)$\u3002\uff08\u590d\u6742\u5ea6\u4e0d\u592a\u4f1a\u8bc1/kel\uff09\n\n```\nlong long query(int l,int r,int now){//calc()\u662f\u7ef4\u62a4c\u7684\u6700\u9ad8\u4f4d\u03c9\u7684\u51fd\u6570\n\tif(l==r){\n\t\tlong long num=min(a[id[l]],c/w[id[l]]);\n\t\tc-=num*w[id[l]],calc();\n\t\treturn num*v[id[l]];\n\t}\n\tif(lightw[now][omega]<=c){\n\t\tlong long res=lightv[now][omega];\n\t\tc-=lightw[now][omega],calc();\n\t\treturn res;\n\t}\n\tif(lightw[now][omega-1]<=c&&c<extra[now][omega-1]){\n\t\tlong long res=lightv[now][omega-1];\n\t\tc-=lightw[now][omega-1],calc();\n\t\treturn res;\n\t}\n\tint mid=(l+r)>>1;\n\treturn query(l,mid,lc[now])+query(mid+1,r,rc[now]);\n}\n```\n\n[AC\u8bb0\u5f55&\u4ee3\u7801](https://codeforces.com/contest/1515/submission/115129315)",
        "postTime": 1620145161,
        "uid": 35754,
        "name": "Verdandi",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF1515I\u3010Phoenix and Diamonds\u3011"
    },
    {
        "content": "\u8fd9\u9898\u73b0\u5728\u7684\u4e00\u7bc7\u9898\u89e3\u770b\u8d77\u6765\u6bd4\u8f83\u7384\u5b66\uff0c\u6211\u6765\u7ed9\u4e2a\u6b63\u5e38\u70b9\u7684\u505a\u6cd5\u3002\n\n\u9996\u5148\u628a\u6240\u6709\u7269\u54c1\u6392\u5e8f\uff0c\u8bbe\u5f53\u524d $c$ \u4e8c\u8fdb\u5236\u4e0b\u7684\u6700\u9ad8\u4f4d\u4e3a $d$\uff0c\u90a3\u4e48\u6211\u4eec\u53ea\u8003\u8651\u6240\u6709\u91cd\u91cf\u7684\u6700\u9ad8\u4f4d\u4e0d\u5927\u4e8e $d$ \u7684\u7269\u54c1\u3002\u628a\u6700\u9ad8\u4f4d\u4e3a $d$ \u7684\u7269\u54c1\u79f0\u4e3a\u201c\u91cd\u7684\u201d\uff0c\u5176\u4ed6\u7269\u54c1\u79f0\u4e3a\u201c\u8f7b\u7684\u201d\u3002\n\n\u6211\u4eec\u6b32\u6c42\u51fa\u7b2c\u4e00\u4e2a\u8fd9\u6837\u7684\u4f4d\u7f6e\uff1a\u8fd9\u4e2a\u4f4d\u7f6e\u7684\u7269\u54c1\u8981\u4e48\u662f\u8f7b\u7684\uff0c\u5e76\u4e14\u5b83\u6ca1\u6709\u88ab\u53d6\uff1b\u6216\u8005\u5b83\u662f\u91cd\u7684\uff0c\u5e76\u4e14\u8981\u88ab\u53d6\u3002\u5047\u8bbe\u6211\u4eec\u53ef\u4ee5\u6c42\u51fa\u8fd9\u4e2a\u4f4d\u7f6e\uff0c\u90a3\u4e48\u6211\u4eec\u628a\u7b54\u6848\u52a0\u4e0a\u8fd9\u4e2a\u4f4d\u7f6e\u7684\u8d21\u732e\u548c\u4e4b\u524d\u6240\u6709\u8f7b\u7269\u54c1\u7684\u4ef7\u503c\uff0c\u7136\u540e\u518d\u4ee5\u65b0\u7684 $c$ \u5728\u8fd9\u4e2a\u4f4d\u7f6e\u4e4b\u540e\u518d\u505a\u4e00\u904d\u3002\n\n\u8003\u8651\u5982\u4f55\u6c42\u51fa\u8fd9\u4e2a\u4f4d\u7f6e\u3002\u5982\u679c\u6211\u4eec\u4f7f\u7528\u7ebf\u6bb5\u6811\u4e8c\u5206\uff0c\u6211\u4eec\u53ef\u4ee5\u77e5\u9053\u80fd\u4e0d\u80fd\u53d6\u5b8c\u4e00\u4e2a\u533a\u95f4\u5185\u7684\u6240\u6709\u8f7b\u7269\u54c1\u3002\u8003\u8651\u80fd\u4e0d\u80fd\u53d6\u5230\u67d0\u4e2a\u91cd\u7269\u54c1\uff0c\u9996\u5148 $c$ \u8981\u4e0d\u5c0f\u4e8e\u8fd9\u4e4b\u524d\u7684\u6240\u6709\u8f7b\u7269\u54c1\u52a0\u4e0a\u81ea\u5df1\u7684\u91cd\u91cf\uff0c\u5e76\u4e14\u8981\u5c0f\u4e8e\u4e4b\u524d\u6bcf\u4e2a\u91cd\u7269\u54c1\u7684\u8fd9\u4e2a\u503c\u3002\u90a3\u4e48\u6211\u4eec\u53d1\u73b0 $c$ \u80fd\u53d6\u5230\u67d0\u4e2a\u533a\u95f4\u5185\u7684\u91cd\u7269\u54c1\u7684\u6761\u4ef6\u662f $c$ \u4e0d\u5c0f\u4e8e\u6240\u6709\u91cd\u7269\u54c1\u7684\u8fd9\u4e2a\u503c\u7684\u6700\u5c0f\u503c\u3002\u4e8e\u662f\u6211\u4eec\u5728\u7ebf\u6bb5\u6811\u4e0a\u7ef4\u62a4\u4e4b\uff0c\u5c31\u53ef\u4ee5\u901a\u8fc7\u7ebf\u6bb5\u6811\u4e8c\u5206\u6c42\u51fa\u4e0a\u8ff0\u4f4d\u7f6e\u3002\n\n\u8003\u8651\u8fd9\u4e2a\u505a\u6cd5\u7684\u590d\u6742\u5ea6\u3002\u53d1\u73b0\u6bcf\u6b21\u627e\u5230\u8fd9\u4e2a\u4f4d\u7f6e\u90fd\u4f1a\u4f7f\u5f97 $d$ \u81f3\u5c11\u51cf\u5c11 $1$\uff0c\u6240\u4ee5\u8fd9\u4e2a\u8fc7\u7a0b\u53ea\u4f1a\u8fdb\u884c log \u6b21\u3002\u5355\u6b21\u590d\u6742\u5ea6\u662f log \u7684\uff0c\u603b\u5171\u662f 2log \u7684\u590d\u6742\u5ea6\u3002\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nusing ll=long long;\ninline ll read(){\n\tll x=0;\n\tbool f=0;\n\tchar c=getchar();\n\twhile(!isdigit(c)){\n\t\tif(c=='-') f=1;\n\t\tc=getchar();\n\t}\n\twhile(isdigit(c)){\n\t\tx=x*10+c-'0';\n\t\tc=getchar();\n\t}\n\treturn f?-x:x;\n}\nconst int maxn=2e5+5;\nint n,m;\nll a[maxn],w[maxn],v[maxn];\nint ord[maxn],p[maxn];\nconst ll inf=9e18;\nstruct node{\n\tint l,r;\n\tnode* ch[2];\n\tll s1[60],s2[60],s3[60];\n\tvoid pushup(){\n\t\tfor(int i=0;i<60;i++){\n\t\t\ts1[i]=ch[0]->s1[i]+ch[1]->s1[i];\n\t\t\ts2[i]=ch[0]->s2[i]+ch[1]->s2[i];\n\t\t\ts3[i]=ch[0]->s3[i];\n\t\t\tif(ch[1]->s3[i]<inf)\n\t\t\t\ts3[i]=min(s3[i],ch[0]->s1[i]+ch[1]->s3[i]);\n\t\t}\n\t}\n\tvoid upd(){\n\t\tint u=ord[r],d=60;\n\t\twhile(!(w[u]>>d&1)) d--;\n\t\tfor(int i=0;i<d;i++){\n\t\t\ts1[i]=s2[i]=0;\n\t\t\ts3[i]=inf;\n\t\t}\n\t\ts1[d]=s2[d]=0;\n\t\ts3[d]=a[u]?w[u]:inf;\n\t\tfor(int i=d+1;i<60;i++){\n\t\t\ts1[i]=w[u]*a[u];\n\t\t\ts2[i]=v[u]*a[u];\n\t\t\ts3[i]=inf;\n\t\t}\n\t}\n\tnode(int l,int r):l(l),r(r){\n\t\tif(l==r){\n\t\t\tupd();\n\t\t\treturn;\n\t\t}\n\t\tint mid=l+(r-l)/2;\n\t\tch[0]=new node(l,mid);\n\t\tch[1]=new node(mid+1,r);\n\t\tpushup();\n\t}\n\tvoid modify(int x){\n\t\tif(l==r){\n\t\t\tupd();\n\t\t\treturn;\n\t\t}\n\t\tif(x<=ch[0]->r) ch[0]->modify(x);\n\t\telse ch[1]->modify(x);\n\t\tpushup();\n\t}\n\tvoid get(int ql,int qr,vector<node*>& vec){\n\t\tif(ql<=l&&qr>=r){\n\t\t\tvec.push_back(this);\n\t\t\treturn;\n\t\t}\n\t\tif(ql<=ch[0]->r) ch[0]->get(ql,qr,vec);\n\t\tif(qr>=ch[1]->l) ch[1]->get(ql,qr,vec);\n\t}\n\tint query(int d,ll& c,ll& s){\n\t\tif(l==r){\n\t\t\tint u=ord[r];\n\t\t\tif(!(w[u]>>d&1)){\n\t\t\t\tll t=c/w[u];\n\t\t\t\tc-=w[u]*t;\n\t\t\t\ts+=v[u]*t;\n\t\t\t}\n\t\t\telse if(c>=w[u]){\n\t\t\t\tc-=w[u];\n\t\t\t\ts+=v[u];\n\t\t\t}\n\t\t\treturn r+1;\n\t\t}\n\t\tif(c>=ch[0]->s3[d]||c<=ch[0]->s1[d]) return ch[0]->query(d,c,s);\n\t\telse return ch[1]->query(d,c-=ch[0]->s1[d],s+=ch[0]->s2[d]);\n\t}\n}*rt;\nint main(){\n#ifdef LOCAL\n\tfreopen(\"in.txt\",\"r\",stdin);\n\tfreopen(\"out.txt\",\"w\",stdout);\n#endif\n\tn=read();\n\tm=read();\n\tfor(int i=1;i<=n;i++){\n\t\ta[i]=read();\n\t\tw[i]=read();\n\t\tv[i]=read();\n\t}\n\tfor(int i=1;i<=n;i++) ord[i]=i;\n\tsort(ord+1,ord+n+1,[](int a,int b){\n\t\tif(v[a]!=v[b]) return v[a]>v[b];\n\t\treturn w[a]<w[b];\n\t});\n\tfor(int i=1;i<=n;i++) p[ord[i]]=i;\n\trt=new node(1,n);\n\twhile(m--){\n\t\tint opt=read();\n\t\tif(opt==1){\n\t\t\tint k,d;\n\t\t\tk=read();\n\t\t\td=read();\n\t\t\ta[d]+=k;\n\t\t\trt->modify(p[d]);\n\t\t}\n\t\telse if(opt==2){\n\t\t\tint k,d;\n\t\t\tk=read();\n\t\t\td=read();\n\t\t\ta[d]-=k;\n\t\t\trt->modify(p[d]);\n\t\t}\n\t\telse{\n\t\t\tll c=read(),ans=0;\n\t\t\tint d=60,x=1;\n\t\t\twhile(d>=0&&!(c>>d&1)) d--;\n\t\t\twhile(d>=0&&x<=n){\n\t\t\t\tvector<node*> vec;\n\t\t\t\trt->get(x,n,vec);\n\t\t\t\tfor(node* u:vec)\n\t\t\t\t\tif(c>=u->s3[d]||c<=u->s1[d]){\n\t\t\t\t\t\tx=u->query(d,c,ans);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\tc-=u->s1[d];\n\t\t\t\t\t\tans+=u->s2[d];\n\t\t\t\t\t\tx=u->r+1;\n\t\t\t\t\t}\n\t\t\t\twhile(d>=0&&!(c>>d&1)) d--;\n\t\t\t}\n\t\t\tprintf(\"%lld\\n\",ans);\n\t\t}\n\t}\n#ifdef LOCAL\n\tfprintf(stderr,\"%f\\n\",1.0*clock()/CLOCKS_PER_SEC);\n#endif\n\treturn 0;\n}\n```",
        "postTime": 1644800132,
        "uid": 174045,
        "name": "FZzzz",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF1515I \u3010Phoenix and Diamonds\u3011"
    },
    {
        "content": "\u611f\u8c22 @[ReKoJ](www.luogu.com.cn/user/341102) \u7684\u8bfe\u4ef6\u3002\n\n\u5f88\u5389\u5bb3\u7684\u4e00\u7c7b\u6280\u5de7\u3002\u65f6\u95f4\u4e0d\u591f\u5c31\u53ea\u7ec3\u4e86\u8fd9\u4e00\u9898\u3002\n\n\u5c06\u5b9d\u77f3\u6392\u5e8f\uff0c\u8be2\u95ee\u65f6\u4ece\u524d\u5f80\u540e\u626b\u4e00\u904d\u5b9d\u77f3\u5e8f\u5217\uff0c\u90a3\u4e48\u626b\u5230\u5b9d\u77f3 $i$ \u65f6\uff0c\u8fdb\u884c\u7684\u64cd\u4f5c\u53ef\u4ee5\u770b\u505a\uff1a\n\n>  \u82e5 $c\\ge w_i$\uff0c$c$ \u51cf\u53bb $w_i$\u3002\n\n\u90a3\u4e48\u4e0d\u96be\u60f3\u5230\u7528\u7c7b\u4f3c\u4e8e\u500d\u589e\u503c\u57df\u5206\u5757\u7684\u6280\u5de7\u6765\u89e3\u51b3\u6b64\u9898\u3002\n\n\u8bbe $c$ \u4e8c\u8fdb\u5236\u4e0b\u6700\u9ad8\u4f4d\u4e3a $k$\uff0c\u5c06\u5b9d\u77f3\u5206\u4e3a $[1,2^k),[2^k,2^{k+1})$ \u4e24\u90e8\u5206\u3002\n\n$[2^k,2^{k+1})$ \u5185\u6700\u591a\u53d6\u4e00\u4e2a\uff0c\u4e14\u53d6\u8d70\u4e00\u4e2a\u540e $k$ \u81f3\u5c11\u51cf $1$\uff0c\u76f4\u63a5\u53d6\u5373\u53ef\u3002\n\n$[1,2^k)$ \u5185\u53ef\u4ee5\u53d6\u5230\u7684\u662f\u4e00\u4e2a\u6781\u957f\u7684\u8fde\u7eed\u533a\u95f4 $[l,r]$\uff0c\u6ee1\u8db3\u53d6\u5b8c $[l,r]$ \u540e $c'<w_{r+1}$\uff08\u5373\u65e0\u6cd5\u518d\u591a\u53d6\uff09\u3002\u53c8\u56e0\u4e3a $w_{r+1}\\in[1,2^k)$\uff0c\u6240\u4ee5\u53d6\u5b8c\u540e $k$ \u4e5f\u81f3\u5c11\u51cf\u5c11 $1$\uff0c\u76f4\u63a5\u53d6\u5373\u53ef\u3002\n\n\u5355\u6b21\u53d6\u6570\u90fd\u662f\u7ebf\u6bb5\u6811\u4e8c\u5206\uff0c\u53c8\u56e0\u4e3a $k=\\log w$\uff08\u8fd9\u91cc\u4e0d\u7528\u53d6\u5230 $\\log C$\uff09\uff0c\u56e0\u6b64\u603b\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log^2w)$\u3002\n\n\u5b9e\u73b0\u7ec6\u8282\u5f88\u591a\u3002\n\n\n```cpp\n#include<bits/stdc++.h>\n#define mp make_pair\n#define ll long long\n#define il inline\n#define Xu_Hongxi using\n#define isOur namespace\n#define RedSun std\nXu_Hongxi isOur RedSun;\nconst ll inf=1ll<<60;\nconst int maxn=200010;\nconst int Lg=18;\nil ll read(){\n\tll x=0;\n\tchar c=getchar();\n\tfor(;!(c>='0'&&c<='9');c=getchar());\n\tfor(;c>='0'&&c<='9';c=getchar())\n\t\tx=(x<<1)+(x<<3)+c-'0';\n\treturn x;\n}\nil void chkmax(int &x,int y){if(y>x)x=y;}\nstruct Gem{\n\tll w,v,s;\n\tint id;\n}a[maxn];\nint as[maxn][Lg];\nint aw[maxn][Lg];\nint av[maxn][Lg];\nil bool cmp(Gem a,Gem b){return (a.v^b.v)?a.v>b.v:a.w<b.w;}\nint tp[maxn],rt[Lg];\nint n,m,N,id[maxn];\nll now_loc,costed; \nnamespace Seg{\n\tconst int MAXN=maxn*50;\n\tint ls[MAXN],rs[MAXN],cnt;\n\tll lz[MAXN],dw[MAXN],dv[MAXN];\n\tll cw[MAXN],dm[MAXN];\n\tvoid pushup(int i){\n\t\tdw[i]=dw[ls[i]]+dw[rs[i]];\n\t\tdv[i]=dv[ls[i]]+dv[rs[i]];\n\t\tdm[i]=min(dm[ls[i]],dm[rs[i]]);\n\t}\n\tvoid pushdown(int i){\n\t\tcw[ls[i]]+=lz[i],cw[rs[i]]+=lz[i];\n\t\tlz[ls[i]]+=lz[i],lz[rs[i]]+=lz[i];\n\t\tif(dm[ls[i]]!=inf) dm[ls[i]]+=lz[i];\n\t\tif(dm[rs[i]]!=inf) dm[rs[i]]+=lz[i];\n\t\tlz[i]=0;\n\t} \n\tvoid build(int &i,int l,int r,int t){\n\t\tif(!i) i=++cnt;\n\t\tif(l==r){\n\t\t\tdw[i]=as[l][t]*aw[l][t];\n\t\t\tdv[i]=as[l][t]*av[l][t];\n\t\t\tcw[i]=aw[l][t];\n\t\t\tif(!as[l][t]||tp[a[l].w]!=t) dm[i]=inf;\n\t\t\telse dm[i]=cw[i];\n\t\t\treturn ;\n\t\t}int mid=l+r>>1;\n\t\tif(mid>=l) build(ls[i],l,mid,t);\n\t\tif(mid<r) build(rs[i],mid+1,r,t);\n\t\tpushup(i);\n\t}\n\tvoid A_cw(int i,int l,int r,int L,int R,ll k){\n\t\tif(L>R) return ;\n\t\tif(l>=L&&r<=R){\n\t\t\tcw[i]+=k,lz[i]+=k;\n\t\t\tif(dm[i]!=inf) dm[i]+=k; \n\t\t\treturn ;\n\t\t}pushdown(i);\n\t\tint mid=l+r>>1;\n\t\tif(mid>=L) A_cw(ls[i],l,mid,L,R,k);\n\t\tif(mid<R) A_cw(rs[i],mid+1,r,L,R,k);\n\t\tpushup(i);\n\t}\n\tvoid A_s(int i,int l,int r,int x,ll k,int t){\n\t\tif(l==r){\n\t\t\tdw[i]+=k*aw[l][t];\n\t\t\tdv[i]+=k*av[l][t];\n\t\t\tas[l][t]+=k;\n\t\t\tif(!as[l][t]||tp[a[l].w]!=t) dm[i]=inf;\n\t\t\telse dm[i]=cw[i];\n\t\t\treturn ; \n\t\t}pushdown(i);\n\t\tint mid=l+r>>1;\n\t\tif(mid>=x) A_s(ls[i],l,mid,x,k,t);\n\t\telse A_s(rs[i],mid+1,r,x,k,t);\n\t\tpushup(i);\n\t} \n\tll Q1(int i,int l,int r,ll &s,int t){\n\t\tif(r<now_loc) return 0;\n\t\tif(l==now_loc&&s>=dw[i]-aw[l][t]*costed){\n\t\t\tll tmp=costed;\n\t\t\tnow_loc=r+1,costed=0;\n\t\t\ts-=dw[i]-aw[l][t]*tmp;\n\t\t\treturn dv[i]-av[l][t]*tmp;\n\t\t}\n\t\tif(l==r){\n\t\t\tif(!as[l][t]){\n\t\t\t\tnow_loc++,costed=0;\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t\tll tmp=min(as[l][t]-costed,s/aw[l][t]);\n\t\t\ts-=tmp*aw[l][t],costed+=tmp;\n\t\t\tif(costed>=as[l][t]){\n\t\t\t\tnow_loc++,costed=0;\n\t\t\t\treturn tmp*av[l][t];\n\t\t\t}\n\t\t\treturn tmp*av[l][t];\n\t\t}pushdown(i);\n\t\tint mid=l+r>>1; ll y=0;\n\t\ty+=Q1(ls[i],l,mid,s,t);\n\t\tif(now_loc>mid) y+=Q1(rs[i],mid+1,r,s,t);\n\t\treturn y; \n\t}\n\tll Q2(int i,int l,int r,ll &s,int t){\n\t\tif(r<now_loc||dm[i]>s) return 0;\n\t\tif(l==r){\n\t\t\tif(l==now_loc)\n\t\t\t\tif((++costed)>=as[l][t]) \n\t\t\t\t\tcosted=0,now_loc++;\n\t\t\treturn s-=aw[l][t],av[l][t];\n\t\t}\n\t\tpushdown(i);\n\t\tint mid=l+r>>1; ll y;\n\t\tif(y=Q2(ls[i],l,mid,s,t)) return y;\n\t\telse return Q2(rs[i],mid+1,r,s,t); \n\t}\n}\nvoid init(){\n\tfor(int i=0;i<Lg;i++){\n\t\tSeg::build(rt[i],1,n,i);\n\t\tfor(int j=1;j<=n;j++)\n\t\t\tif(tp[a[j].w]<=i)\n\t\t\t\tSeg::A_cw(rt[i],1,n,j+1,n,a[j].s*a[j].w);\n\t}\n} \nll calc(ll s){\n\tint x; ll v=0,tmp=-1,Tp;\n\tnow_loc=1,costed=0;\n\tv+=Seg::Q1(rt[Lg-1],1,n,s,Lg-1);\n\tfor(int i=Lg-1;~i;i--){\n\t\tv+=Seg::Q2(rt[i],1,n,s,i);\n\t\tif(i)v+=Seg::Q1(rt[i-1],1,n,s,i-1);\n\t}return v;\n}\nint main(){\n\tn=N=read(),m=read();\n\tfor(int i=1;i<=n;i++){\n\t\ta[i].s=read(),a[i].w=read();\n\t\ta[i].v=read(),a[i].id=i;\n\t\tchkmax(N,a[i].w);\n\t}sort(a+1,a+1+n,cmp);\n\tfor(int i=2;i<=N;i++) tp[i]=tp[i>>1]+1;\n\tfor(int i=0;i<Lg;i++)\n\t\tfor(int j=1;j<=n;j++)\n\t\t\tif(tp[a[j].w]<=i){\n\t\t\t\tas[j][i]=a[j].s;\n\t\t\t\taw[j][i]=a[j].w;\n\t\t\t\tav[j][i]=a[j].v;\n\t\t\t}\n\tfor(int i=1;i<=n;i++) id[a[i].id]=i;\n\tinit();\n\twhile(m--){\n//\t\tprintf(\"cw[6]\uff1a%d\\n\",Seg::cw[6]);\n\t\tint opt=read();\n\t\tif(opt<=2){\n\t\t\tint d=(opt==1?read():-read()),k=id[read()];\n\t\t\tfor(int i=0;i<Lg;i++)\n\t\t\t\tif(tp[a[k].w]<=i){\n\t\t\t\t\tSeg::A_s(rt[i],1,n,k,d,i);\n\t\t\t\t\tSeg::A_cw(rt[i],1,n,k+1,n,d*a[k].w);\n\t\t\t\t}\n\t\t\ta[k].s+=d;\n\t\t}\n\t\telse if(opt==3) printf(\"%lld\\n\",calc(read()));\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1679965862,
        "uid": 288716,
        "name": "lzqy_",
        "ccfLevel": 7,
        "title": "CF1515I Phoenix and Diamonds \u9898\u89e3"
    },
    {
        "content": "\u9996\u5148 $c$ \u5f88\u5927\uff0c\u56e0\u6b64\u590d\u6742\u5ea6\u8ddf $c$ \u6709\u5173\u7684\u9879\u80af\u5b9a\u53ea\u80fd\u662f $\\log c$ \u4e4b\u7c7b\u7684\u3002\n\n\u7c7b\u6bd4 IOI2021 dungeons \u7684\u5957\u8def\uff0c\u6211\u4eec**\u5bf9\u503c\u57df\u8fdb\u884c\u5206\u5c42**\uff0c\u5047\u8bbe $c\\in[2^{\\omega-1},2^{\\omega})$\uff0c\u8003\u8651\u4ee4\u91cd\u91cf\u5728 $\\ge 2^{\\omega-1}$ \u7684\u7269\u54c1\u4e3a\u201c\u91cd\u7269\u54c1\u201d\uff0c\u5176\u4ed6\u7269\u54c1\u4e3a\u201c\u8f7b\u7269\u54c1\u201d\uff0c\u90a3\u4e48\u4e00\u4e2a\u663e\u7136\u7684\u6027\u8d28\u662f\u6211\u4eec\u6700\u591a\u53ea\u80fd\u53d6\u4e00\u4e2a\u201c\u91cd\u7269\u54c1\u201d\u3002\u5e76\u4e14\u5982\u679c\u53d6\u4e86\u4e00\u4e2a\u201c\u91cd\u7269\u54c1\u201d\uff0c\u90a3\u4e48 $c$ \u5c31\u4f1a\u8fdb\u5165 $\\omega$ \u4ee5\u4e0b\u7684\u5c42\u3002\u5982\u679c\u5b58\u5728\u4e00\u4e2a\u201c\u8f7b\u7269\u54c1\u201d\uff0c\u6ee1\u8db3\u5176\u4e0d\u80fd\u53d6\u5b8c\u5168\u90e8 $a_i$ \u4e2a\uff0c\u90a3\u4e48\u8bf4\u660e\u6b64\u65f6 $c<w_i<2^{\\omega-1}$\uff0c\u4e5f\u4f1a\u8fdb\u5165 $\\omega$ \u4ee5\u4e0b\u7684\u5c42\u3002\n\n\u8003\u8651\u5c06\u8fd9\u4e2a\u8fc7\u7a0b\u653e\u5728\u7ebf\u6bb5\u6811\u4e0a\u3002\u5bf9\u7ebf\u6bb5\u6811\u4e0a\u6bcf\u4e2a\u8282\u70b9 $[l,r]$ \u7ef4\u62a4\u4ee5\u4e0b\u4e09\u4e2a\u4fe1\u606f\uff1a\n\n- $lw_i$\uff1a$[l,r]$ \u4e2d\u6240\u6709\u91cd\u91cf $<2^{i-1}$ \u7684\u7269\u54c1\u7684 $w_j\u00b7a_j$ \u4e4b\u548c\u3002\n- $lv_i$\uff1a$[l,r]$ \u4e2d\u6240\u6709\u91cd\u91cf $<2^{i-1}$ \u7684\u7269\u54c1\u7684 $v_j\u00b7a_j$ \u4e4b\u548c\u3002\n- $tot_i$\uff1a\u8981\u53d6\u8d70\u81f3\u5c11\u4e00\u4e2a $[l,r]$ \u4e2d\u91cd\u91cf\u5728 $[2^{i-1},2^i)$ \u4e2d\u7269\u54c1\uff0c$c$ \u81f3\u5c11\u4e3a\u591a\u5c11\u3002\n\n\u663e\u7136\u8fd9\u4e9b\u4fe1\u606f\u90fd\u53ef\u4ee5\u5728 $O(\\log V)$ \u7684\u65f6\u95f4\u5185\u8fdb\u884c `pushup`\u3002\u5177\u4f53\u7ec6\u8282\u89c1\u4ee3\u7801\u3002\n\n\u63a5\u4e0b\u6765\u600e\u4e48\u8003\u8651\u67e5\u8be2\u3002\u5047\u8bbe\u73b0\u5728\u9012\u5f52\u5230 $[l,r]$ \u8868\u793a\u7684\u8282\u70b9\uff0c$c\\in[2^{\\omega},2^{\\omega+1})$\uff0c\u7279\u5224\u6389\u4ee5\u4e0b\u4e24\u79cd\u60c5\u51b5\uff1a\n\n- $c\\ge lw_{\\omega}$\uff0c\u8bf4\u660e\u6240\u6709\u53ef\u80fd\u80fd\u53d6\u8d70\u7684\u7269\u54c1\u90fd\u80fd\u53d6\u8d70\uff0c\u76f4\u63a5\u8fd4\u56de $lv_{\\omega}$\u3002\n- $lw_{\\omega-1}\\le c<tot_{\\omega-1}$\uff0c\u8bf4\u660e\u6240\u6709\u8f7b\u7269\u54c1\u90fd\u80fd\u53d6\u8d70\uff0c\u4f46\u91cd\u7269\u54c1\u4e00\u4e2a\u90fd\u4e0d\u80fd\u53d6\u3002\u76f4\u63a5\u8fd4\u56de $lv_{\\omega-1}$\u3002\n\n\u9664\u6b64\u4e4b\u5916\u7684\u6240\u6709\u60c5\u51b5\u90fd\u7ee7\u7eed\u9012\u5f52\u4e24\u4e2a\u5b50\u8282\u70b9\u3002\u53ef\u4ee5\u8bc1\u660e\u590d\u6742\u5ea6\u4e3a $O(\\log V\\log n)$\uff0c\u8fd9\u662f\u56e0\u4e3a\u5bf9\u4e8e\u7b2c\u4e09\u79cd\u60c5\u51b5\uff0c\u8981\u4e48\u4f60\u53d6\u8d70\u4e86\u4e00\u4e2a\u91cd\u7269\u54c1\uff0c\u8981\u4e48\u9047\u5230\u67d0\u4e2a\u8f7b\u7269\u54c1\u4e0d\u80fd\u5168\u90e8\u53d6\u5b8c\uff0c\u6839\u636e\u524d\u9762\u7684\u5206\u6790\uff0c\u6b64\u79cd\u60c5\u51b5\u90fd\u4f1a\u4f7f $c$ \u81f3\u5c11\u51cf\u4e00\uff0c\u56e0\u6b64\u9012\u5f52\u4e24\u4e2a\u5206\u53c9\u7684\u6b21\u6570\u4e0d\u4f1a\u8d85\u8fc7 $\\log V$\u3002\n\n```cpp\nconst int MAXN=2e5;\nconst int LOG_V=18;\nconst ll INF=0x3f3f3f3f3f3f3f3fll;\nint n,qu,w[MAXN+5],v[MAXN+5],ord[MAXN+5],pos[MAXN+5],omega;ll a[MAXN+5],c;\nbool cmp(int x,int y){return ((v[x]==v[y])?(w[x]<w[y]):(v[x]>v[y]));}\nstruct node{int l,r;ll lw[LOG_V+2],lv[LOG_V+2],tot[LOG_V+2];}s[MAXN*4+5];\nvoid pushup(int k){\n\tfor(int i=1;i<=LOG_V;i++){\n\t\ts[k].lw[i]=s[k<<1].lw[i]+s[k<<1|1].lw[i];\n\t\ts[k].lv[i]=s[k<<1].lv[i]+s[k<<1|1].lv[i];\n\t\ts[k].tot[i]=min(s[k<<1].tot[i],s[k<<1|1].tot[i]+s[k<<1].lw[i]);\n\t}\n}\nvoid init_val(int k,int p){\n\tfor(int i=1;i<=18;i++){\n\t\ts[k].lw[i]=s[k].lv[i]=0;s[k].tot[i]=INF;\n\t\tif(w[p]<(1<<i-1))s[k].lv[i]=1ll*v[p]*a[p],s[k].lw[i]=1ll*w[p]*a[p];\n\t\telse if(w[p]<(1<<i)&&a[p]>0)s[k].tot[i]=w[p];\n\t}\n}\nvoid build(int k,int l,int r){\n\ts[k].l=l;s[k].r=r;if(l==r)return init_val(k,ord[l]),void();\n\tint mid=l+r>>1;build(k<<1,l,mid);build(k<<1|1,mid+1,r);pushup(k);\n}\nvoid modify(int k,int p){\n\tif(s[k].l==s[k].r)return init_val(k,ord[p]),void();\n\tint mid=s[k].l+s[k].r>>1;\n\tif(p<=mid)modify(k<<1,p);else modify(k<<1|1,p);\n\tpushup(k);\n}\nvoid recalc(){while(omega>1&&(1<<((omega-1)-1))>c)omega--;}\nll query(int k){\n\tif(s[k].l==s[k].r){\n\t\tll num=min(a[ord[s[k].l]],c/w[ord[s[k].l]]);\n\t\tc-=num*w[ord[s[k].l]];recalc();return num*v[ord[s[k].l]];\n\t}\n\tif(s[k].lw[omega]<=c){ll tmp=s[k].lv[omega];c-=s[k].lw[omega];recalc();return tmp;}\n\telse if(s[k].lw[omega-1]<=c&&c<s[k].tot[omega-1]){ll tmp=s[k].lv[omega-1];c-=s[k].lw[omega-1];recalc();return tmp;}\n\telse return query(k<<1)+query(k<<1|1);\n}\nint main(){\n\tscanf(\"%d%d\",&n,&qu);\n\tfor(int i=1;i<=n;i++)scanf(\"%lld%d%d\",&a[i],&w[i],&v[i]),ord[i]=i;\n\tsort(ord+1,ord+n+1,cmp);for(int i=1;i<=n;i++)pos[ord[i]]=i;\n\tbuild(1,1,n);\n\twhile(qu--){\n\t\tint opt;scanf(\"%d\",&opt);\n\t\tif(opt==1||opt==2){\n\t\t\tint k,d;scanf(\"%d%d\",&k,&d);\n\t\t\ta[d]+=((opt==1)?k:(-k));\n\t\t\tmodify(1,pos[d]);\n\t\t}else{\n\t\t\tscanf(\"%lld\",&c);omega=18;recalc();\n\t\t\tprintf(\"%lld\\n\",query(1));\n\t\t}\n\t}\n\treturn 0;\n}\n```\n\n",
        "postTime": 1685620797,
        "uid": 115194,
        "name": "lTgMFePRoeZ",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 CF1515I Phoenix and Diamonds"
    }
]