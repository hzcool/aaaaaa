[
    {
        "content": "\u6c42\u671f\u671b\u9996\u5148\u8981\u77e5\u9053\uff0c**\u671f\u671b\u957f\u5ea6$=$\u603b\u957f\u5ea6/\u73af\u6570**\n\n\u6211\u4eec\u5148\u6765\u8003\u8651\u5982\u4f55\u627e\u73af\n\n\u56e0\u4e3a\u6811\u4e0a\u7684\u7b80\u5355\u8def\u5f84\u53ea\u6709\u4e00\u6761\uff0c\u6240\u4ee5\u6211\u4eec\u8fde\u8fb9$(x\\rightarrow y)$\u4f7f\u5f97$a,b$\u5728\u73af\u4e0a\uff0c\u5c31\u7b49\u4e8e\u6811\u4e0a\u627e\u4e24\u70b9$x\\rightarrow y$\u7684\u8def\u5f84\u7ecf\u8fc7$a,b$\u4e24\u70b9\n\n\u8fd9\u65f6\u6211\u4eec\u5c31\u8981\u5206\u7c7b\u8ba8\u8bba\u4e86\n\n- $a$\u4e0d\u662f$b$\u7684\u7956\u5148\u8282\u70b9\u4e14$b$\u4e5f\u4e0d\u4e3a$a$\u7684\u7956\u5148\u8282\u70b9\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/zis7zf5o.png)\n\n\u663e\u7136\uff0c$x$\u53ea\u80fd\u53d6$a$\u7684\u5b50\u6811\u8282\u70b9\uff08\u5305\u62ec$a$\uff09\uff0c$y$\u53ea\u80fd\u53d6$b$\u7684\u5b50\u6811\u7ed3\u70b9\uff08\u5305\u62ec$b$\uff09\n\n**\u4e58\u6cd5\u539f\u7406\uff1a\u73af\u6570$\\large=size_a\\times  size_b$**\n\n\u63a5\u4e0b\u6765\u5c31\u60f3\u600e\u4e48\u6c42\u8fd9\u4e2a\u73af\u7684\u957f\u5ea6\u4e86\n\n\u9996\u5148\u4e0d\u7ba1$x,y$\u53d6\u5728\u54ea\uff0c$a\\rightarrow b$\u548c$x\\rightarrow y$\u662f\u5fc5\u8d70\u7684\uff0c\u5373\n\n$Dep_a-Dep_{LCA}+Dep_b-Dep_{LCA}+1$\n\n\u5176\u4e2d$Dep$\u4e3a\u5728\u6811\u4e2d\u7684\u6df1\u5ea6\n\n\u7b54\u6848\u53ef\u4ee5\u76f4\u63a5\u52a0\u4e0a\uff1a$size_a\\times  size_b\\times  (Dep_a+Dep_b-2\\times  Dep_{LCA}+1)$\n\n\u7136\u540e\u5c31\u662f\u6c42$x\\rightarrow a$\u548c$y\\rightarrow b$\u7684\u8ddd\u79bb\uff0c\u5373\n\n$Dep_x-Dep_a+Dep_y-Dep_b$\n\n\u7136\u540e\u53d1\u73b0\u8fd9\u4e2a\u5176\u5b9e\u662f\u53ef\u4ee5$Dfs$\u9884\u5904\u7406\u5bf9\u4e8e\u6bcf\u4e2a\u8282\u70b9\u5176\u6240\u6709\u5b50\u6811\u7ed3\u70b9\u5230\u8be5\u70b9\u7684\u8ddd\u79bb\u548c\n\n\u8bbe\uff1a$\\large s_x$\u4e3a\u7ed3\u70b9$x$\u7684\u6240\u6709\u5b50\u6811\u8282\u70b9\u5230$x$\u7684\u8ddd\u79bb\u548c\n\n$\\large s_x=\\sum\\limits s_{son}+size_{son}$\n\n- $a$\u4e3a$b$\u7684\u7956\u5148\u8282\u70b9\u6216$b$\u4e3a$a$\u7684\u7956\u5148\u8282\u70b9\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/wzjm07mk.png)\n\n\u8fd9\u8981\u6bd4\u4e0a\u4e00\u79cd\u8981\u590d\u6742\u4e00\u4e9b\n\n\u6211\u4eec\u5047\u8bbe$a$\u4e3a$b$\u7684\u7956\u5148\n\n\u548c\u4e4b\u524d\u6709\u4e9b\u4e0d\u540c\uff0c$y$\u4f9d\u7136\u662f$b$\u7684\u5b50\u6811\u8282\u70b9\uff0c\u4f46$x$\u5219\u6709\u4e9b\u53d8\u5316\n\n\u56e0\u4e3a\u8981\u6c42$x \\rightarrow y$\u8981\u7ecf\u8fc7$a,b$\u4e24\u70b9\uff0c\u6240\u4ee5$x$\u4e0d\u80fd\u53d6\n$b$\u6240\u5728$a$\u5b50\u6811\u7684\u5b50\u6811\u8282\u70b9\uff08\u5373$c$\u7684\u5b50\u6811\u8282\u70b9\u90fd\u4e0d\u80fd\u53d6\uff0c\u5176\u4ed6\u8282\u70b9\u90fd\u884c\uff09\n\n\u6240\u4ee5\uff1a**\u73af\u6570$\\large =size_b\\times  (n-size_c)$**\n\n\u540c\u6837\u7684\uff0c$a \\rightarrow b$\u548c$x \\rightarrow y$\u5fc5\u8d70\n\n\u7b54\u6848\u53ef\u4ee5\u76f4\u63a5\u52a0\u4e0a\uff1a$size_b\\times  (n-size_c)\\times (Dep_b-Dep_a+1)$\n\n\u56e0\u4e3a$y \\rightarrow b$\u548c\u4e4b\u524d\u6c42\u6cd5\u4e00\u6837\uff0c\u5c31\u662f$\\large s_b$\n\n\u6240\u4ee5\u6211\u4eec\u53ea\u8981\u8003\u8651$x \\rightarrow a$\u548c$y \\rightarrow b$\u5c31\u597d\u4e86\n\n\u548c\u4e4b\u524d\u7684\u60f3\u6cd5\u7c7b\u4f3c\uff0c\u6211\u4eec\u53ef\u4ee5$Dfs$\u9884\u5904\u7406\u4e00\u904d\n\n\u4e0d\u59a8\u8bbe$G_x$\u4e3a\u6240\u6709\u8282\u70b9\u5230$x$\u70b9\u7684\u8ddd\u79bb\u548c\n\n\u6839\u636e\u5b9a\u4e49\uff1a$\\large G_{root}=\\sum\\limits_{i=1}^n Dep_i$\n\n\u4ece\u6839\u8282\u70b9\u5f80\u4e0b\u63a8\uff0c\u56e0\u4e3a\u4e2d\u5fc3\u70b9\u5f80\u63a8\u5230\u4e86\u5b50\u8282\u70b9\uff0c\u6240\u4ee5\u5bf9\u4e8e\u5b50\u8282\u70b9\u7684\u6240\u6709\u5b50\u6811\u8282\u70b9\u8ddd\u79bb$-1$\uff0c\u5bf9\u4e8e\u5176\u4ed6\u8282\u70b9\u8ddd\u79bb$+1$\n\n$\\large G_{son}=G_x-size_{son}+(n-size_{son})$\n\n\u4f46\u6211\u4eec\u53d1\u73b0\uff0c\u8fd9\u6837\u7b97\u8fd8\u628a\u8282\u70b9$c$\u7684\u5b50\u6811\u8282\u70b9\u7684\u8ddd\u79bb\u8d21\u732e\u7b97\u8fdb\u53bb\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u8fd8\u8981\u518d\u51cf\u53bb$\\large s_c$\n\n\u8be6\u89c1\u4ee3\u7801\uff1a\n```\n#include<bits/stdc++.h>\n#define maxn 1000005\n#define ll long long\nusing namespace std;\nint Q[1005],t,n,m,x,y,a,b,fa[maxn][20],Dep[maxn],lnk[maxn],nxt[maxn],son[maxn],tot;\nll Ans,s[maxn],si[maxn],S[maxn];\ninline int read(){\n\tint ret=0;char ch=getchar();\n\twhile (ch<'0'||ch>'9') ch=getchar();\n\twhile (ch<='9'&&ch>='0') ret=ret*10+ch-'0',ch=getchar();\n\treturn ret;\n}\ninline void add(int x,int y){nxt[++tot]=lnk[x];lnk[x]=tot;son[tot]=y;}\ninline void Dfs1(int x){\n\tsi[x]=1;\n\tfor (int i=1;i<20;i++) fa[x][i]=fa[fa[x][i-1]][i-1];\n\tfor (int i=lnk[x];i;i=nxt[i])\n\t  if (son[i]!=fa[x][0]) Dep[son[i]]=Dep[x]+1,fa[son[i]][0]=x,Dfs1(son[i]),si[x]+=si[son[i]],S[x]+=S[son[i]]+si[son[i]];\n}\ninline void Dfs2(int x){\n\tfor (int i=lnk[x];i;i=nxt[i])\n\t  if (son[i]!=fa[x][0]) s[son[i]]=s[x]-2*si[son[i]]+n,Dfs2(son[i]);\n}\ninline int LCA(int x,int y){\n\tif (Dep[x]<Dep[y]) swap(x,y);\n\tint fx=x,fy=y;\n\tfor (int i=19;i>=0;i--) if (Dep[fa[fx][i]]>=Dep[fy]) fx=fa[fx][i];\n\tif (fx==fy) return fx;\n\tfor (int i=19;i>=0;i--) if (fa[fx][i]^fa[fy][i]) fx=fa[fx][i],fy=fa[fy][i];\n\treturn fa[fx][0];\n}\ninline int Get(int x){\n\tfor (int i=19;i>=0;i--) if (Dep[fa[x][i]]>Dep[y]) x=fa[x][i];\n\treturn x;\n}\nint main(){\n\tn=read(),m=read();\n\tfor (int i=1;i<n;i++) x=read(),y=read(),add(x,y),add(y,x);\n\tDep[1]=1;Dfs1(1);for (int i=2;i<=n;i++) s[1]+=Dep[i]-1;Dfs2(1);\n\tfor (int i=1;i<=m;i++){\n\t\tx=read(),y=read();\n\t\tif (x==y){printf(\"0.00000000\\n\");continue;}\n\t\tint top=LCA(x,y);Ans=0;\n\t    if (top^x&&top^y){\n\t    \tll len=1+Dep[x]+Dep[y]-2*Dep[top];\n\t    \tAns+=(ll)len*si[x]*si[y];\n\t    \tAns+=(ll)S[x]*si[y]+(ll)(S[y]*si[x]);\n         \tprintf(\"%.8lf\\n\",(double)Ans/(si[x]*si[y]));\n\t\t}\n\t\telse{\n\t\t\tif (Dep[x]<Dep[y]) swap(x,y);\n\t\t\ttop=Get(x);\n\t\t\tll len=1+Dep[x]-Dep[y];\n\t\t\tAns+=(ll)len*si[x]*(n-si[top]);\n\t\t\tAns+=(ll)(s[y]-S[top]-si[top])*si[x]+(ll)S[x]*(n-si[top]);\n         \tprintf(\"%.8lf\\n\",(double)Ans/(si[x]*(n-si[top])));\n\t\t}\n\t}\n\treturn 0;\n}\n```\n",
        "postTime": 1593868331,
        "uid": 108047,
        "name": "LlLlCc",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 CF629E \u3010Famil Door and Roads\u3011"
    },
    {
        "content": "**\u4e8c\u6b21\u626b\u63cf+\u6362\u6839 dp**\n\n\u8bbe\u52a0\u5165\u67d0\u6761\u8fb9\u540e $\\text{a,b}$ \u5904\u5728\u540c\u4e00\u4e2a\u73af\u5185\u65f6\u4e0e\u8be5\u8fb9\u76f4\u63a5\u76f8\u8fde\u7684\u4e24\u4e2a\u70b9\u4e3a\u4e00\u5bf9**\u5408\u6cd5\u70b9\u5bf9**\u3002\n\n\u7531\u4e8e\u6bcf\u4e2a\u5408\u6cd5\u70b9\u5bf9\u88ab\u9009\u53d6\u7684\u6982\u7387\u662f\u76f8\u7b49\u7684\uff0c\u800c\u5408\u6cd5\u70b9\u5bf9\u6570\u5c31\u662f**\u53ef\u52a0\u8fb9**\u7684\u6570\u91cf\u3002\n\n\u663e\u7136\u53ef\u52a0\u8fb9\u7684\u6570\u91cf\u5c31\u662f\u73af\u7684\u6570\u91cf\uff0c\u6240\u4ee5\u671f\u671b\u5c31\u662f**\u6240\u6709\u73af\u7684\u603b\u957f\u5ea6/\u5408\u6cd5\u70b9\u5bf9\u4e2a\u6570**\u3002\n\n\u4e3a\u65b9\u4fbf\u8ba8\u8bba\uff0c\u6211\u4eec\u8bbe\uff1a\n\n+ $x$ \u8868\u793a\u6811\u4e0a\u7684\u4e00\u4e2a\u8282\u70b9\u3002\n\n+ $d(x)$ \u8868\u793a\u8282\u70b9 $x$ \u5230\u6839\u8282\u70b9\u7684\u8ddd\u79bb\u3002\n\n+ $size(x)$ \u8868\u793a\u4ee5 $x$ \u4e3a\u6839\u8282\u70b9\u7684\u5b50\u6811\u7684\u5927\u5c0f\u3002\n\n+ $F(x)$ \u8868\u793a\u4ee5 $x$ \u4e3a**\u6839\u8282\u70b9\u7684\u5b50\u6811**\u4e2d\u6240\u6709\u70b9\u5230 $x$ \u70b9\u7684\u8ddd\u79bb\u548c\u3002\n\n+ $G(x)$ \u8868\u793a\u4ee5 $x$ \u4e3a**\u6839**\u65f6\u6240\u6709\u70b9\u5230 $x$ \u70b9\u7684\u8ddd\u79bb\u548c\u3002\n\n+ $\\text{lca}(x,y)$ \u8868\u793a $x$ \u548c $y$ \u7684\u6700\u8fd1\u516c\u5171\u7956\u5148\u3002\n\n\u8003\u8651\u73af\u662f\u7531\u4ec0\u4e48\u6784\u6210\u7684\uff1a\n\n+ \u65b0\u52a0\u5165\u7684\u4e00\u6761\u8fb9\n\n+ \u8def\u5f84 $\\text{a} \\rightarrow \\text{b}$ \n\n\u56e0\u4e3a\u5728\u4e00\u68f5\u6811\u4e0a\u8def\u5f84 $\\text{a} \\rightarrow \\text{b}$ \u662f\u552f\u4e00\u7684\uff0c\u800c\u52a0\u5165\u4e00\u6761\u8fb9\u540e\u8def\u5f84 $\\text{a} \\rightarrow \\text{b}$ \u663e\u7136\u6709\u4e24\u6761\uff0c\u6240\u4ee5\u73af\u4e00\u5b9a\u5305\u542b\u8def\u5f84 $\\text{a} \\rightarrow \\text{b}$ \u3002\n\n\u8bbe\u5f53\u524d\u9009\u53d6\u7684\u70b9\u4e3a $x$ \u548c $y$ \u3002\n\n\u63a5\u4e0b\u6765\u5206\u7c7b\u8ba8\u8bba\u4e24\u79cd\u60c5\u51b5\uff0c\u5f53 $\\text{lca}(a,b)$ \u4e0d\u4e3a $a$ \u6216 $b$ \u65f6\uff1a\n\n\u6b64\u65f6 $x$ \u548c $y$ \u53ea\u80fd\u5728 $a$ \u548c $b$ \u7684\u5b50\u6811\u4e2d\u9009\u53d6\uff0c\u6839\u636e**\u4e58\u6cd5\u539f\u7406**\uff0c\u9009\u53d6\u7684\u65b9\u6848\u6570\u4e3a\uff1a\n\n$$size(a) \\ast size(b)$$\n\n\u90a3\u600e\u4e48\u6c42\u73af\u7684\u603b\u957f\u5ea6\u5462\uff1f\u6839\u636e\u4e0a\u9762\u8ba8\u8bba\u7684\u7ed3\u679c\uff0c\u7531\u4e8e\u8def\u5f84 $\\text{a} \\rightarrow \\text{b}$ \u548c\u65b0\u52a0\u5165\u7684\u4e00\u6761\u8fb9\u5728\u6bcf\u4e2a\u73af\u4e2d\u90fd\u4f1a\u51fa\u73b0\uff0c\u800c\u73af\u7684\u603b\u6570\u4e3a $size(a) \\ast size(b)$ \uff0c\u6240\u4ee5\u8fd9\u90e8\u5206\u5bf9\u73af\u603b\u6570\u7684\u8d21\u732e\u4e3a\uff1a\n\n$$size(a) \\ast size(b) \\ast (|\\text{a} \\rightarrow \\text{b}|+1)$$ \n\n\u81f3\u4e8e $|\\text{a} \\rightarrow \\text{b}|$ \uff0c\u7b80\u5355\u5730\u7528 $\\text{LCA}$ \u6c42\u4e00\u4e0b\u5c31\u884c\u3002\n\n\u5177\u4f53\u5730\u8bf4\uff1a $|\\text{a} \\rightarrow \\text{b}|=d(a)+d(b)-2 \\ast \\text{lca}(a,b)$ \n\n\u5047\u8bbe $x$ \u5728 $a$ \u7684\u5b50\u6811\u4e2d\uff0c$y$ \u5728 $b$ \u7684\u5b50\u6811\u4e2d\u3002\n\n\u73b0\u5728\u53ea\u7528\u8003\u8651 $|\\text{x} \\rightarrow \\text{a}|$ \u548c $|\\text{y} \\rightarrow \\text{b}|$ \u5bf9\u7b54\u6848\u7684\u8d21\u732e\u3002\n\n\u53ef\u4ee5\u8fd9\u6837\u611f\u6027\u7406\u89e3\u4e00\u4e0b\uff1a\n\n> \u5bf9\u4e8e\u5b50\u6811 $a$ \u4e2d\u7684\u4efb\u610f\u7684\u4e00\u4e2a\u8282\u70b9\uff0c\u5728\u6240\u6709\u65b9\u6848\u4e2d\u5b83\u5fc5\u5b9a\u4f1a\u4e0e\u5b50\u6811 $b$ \u4e2d\u7684\u6240\u6709\u8282\u70b9\u8fde\u8fb9\u5f62\u6210\u4e00\u4e2a\u73af\uff0c\u5b50\u6811 $b$ \u540c\u7406\u3002\n\n>\u6240\u4ee5\u5b50\u6811 $a$ \u4e2d\u7684\u8282\u70b9 $x$ \u5bf9\u7b54\u6848\u7684\u8d21\u732e\u4e3a\u5b83\u5230\u8282\u70b9 $a$ \u7684\u8ddd\u79bb\u4e58\u4e0a $size(b)$ ,\u7531\u6b64\u63a8\u5e7f\u5230\u6240\u6709\u70b9\uff0c\u5f97\u5b50\u6811 $a$ \u4e2d\u6240\u6709\u7684\u8282\u70b9\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u7684\u603b\u548c\u4e3a $F(a) \\ast size(b)$ \uff0c\u5b50\u6811 $b$ \u540c\u7406\u3002\n\n\u4e8e\u662f**\u73af\u7684\u603b\u957f\u5ea6**\u4e3a\uff1a\n\n$$size(a) \\ast size(b) \\ast (d(a)+d(b)-2 \\ast \\text{lca}(a,b)+1) + F(a) \\ast size(b) + F(b) \\ast size(a) $$\n\n\u7b54\u6848\u4e3a\u4e0a\u9762\u90a3\u5806\u4e1c\u897f\u9664\u4ee5 $size(a) \\ast size(b)$ \u3002\n\n\u8ba8\u8bba\u53e6\u4e00\u79cd\u60c5\u51b5\uff0c\u5f53 $\\text{lca}(a,b)$ \u4e3a $a$ \u65f6 ($b$ \u540c\u7406) \uff1a\n\n\u5bf9\u4e8e\u5b50\u6811 $b$ \uff0c\u4ecd\u7136\u53ef\u4ee5\u6309\u7167\u60c5\u51b5\u4e00\u6765\u8ba8\u8bba\uff0c\u53ea\u662f\u6b64\u65f6\u4e0d\u80fd\u76f4\u63a5\u8ba8\u8bba $a$ \u7684\u5b50\u6811\u4e86\uff0c\u56e0\u4e3a\u5728 $a$ \u4e0a\u65b9\u7684\u8282\u70b9(\u53ef\u4ee5\u7406\u89e3\u4e3a\u7956\u5148\u8282\u70b9\u53ca\u5176\u5b50\u6811\u4e2d\u7684\u8282\u70b9)\u4e5f\u80fd\u5bf9\u7b54\u6848\u4ea7\u751f\u8d21\u732e\u3002\n\n\u8bbe $Son_a$ \u8868\u793a $a$ \u5728\u8def\u5f84 $\\text{a} \\rightarrow \\text{b}$ \u4e0a\u7684\u513f\u5b50\u8282\u70b9\uff0c\u53ef\u4ee5\u7528\u7c7b\u4f3c\u500d\u589e $\\text{LCA}$ \u7684\u529e\u6cd5\u6c42\u51fa\u3002\n\n\u628a\u5728 $a$ \u4e0a\u65b9\u7684\u8282\u70b9\u548c $a$ \u7684\u5b50\u6811\u4e2d\u7684\u8282\u70b9\u8fd1\u4f3c\u5730\u770b\u4f5c $a$ \u7684\u201c\u5b50\u6811\u201d\uff0c\u53c2\u7167\u60c5\u51b5\u4e00\u8fdb\u884c\u8ba8\u8bba\u3002\n\n\u6b64\u65f6\u5728 $a$ \u7684\u201c\u5b50\u6811\u201d\u548c $b$ \u7684\u5b50\u6811\u4e2d**\u9009\u53d6 $x,y$ \u7684\u65b9\u6848\u6570**\u4e3a\uff1a\n\n$$(n-size(Son_a)) \\ast size(b)$$\n\n\u5176\u4e2d $n$ \u4e3a\u6574\u68f5\u6811\u7684\u5927\u5c0f\u3002\n\n\u7ee7\u7eed\u53c2\u8003\u60c5\u51b5\u4e00\uff0c\u8ba1\u7b97 $|\\text{a} \\rightarrow \\text{b}|$ \u548c\u65b0\u52a0\u5165\u7684\u8fb9\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u3002\n\n\u663e\u7136\u53ea\u7528\u5c06\u539f\u6765\u73af\u7684\u603b\u6570\u53d8\u6210 $(n-size(Son_a)) \\ast size(b)$ \u5c31\u884c\u3002\n\n\u8bbe $y$ \u5728 $b$ \u7684\u5b50\u6811\u4e2d\u3002\n\n\u6b64\u65f6 $|\\text{y} \\rightarrow \\text{b}|$ \u5bf9\u7b54\u6848\u7684\u8d21\u732e\u8ddf\u60c5\u51b5\u4e00\u7c7b\u4f3c\uff0c\u4e3a\uff1a\n\n$$F(b) \\ast (n-size(Son_a))$$\n\n\u8ba8\u8bba $a$ \u7684\u201c\u5b50\u6811\u201d\uff0c\u6839\u636e\u6587\u7ae0\u6700\u5f00\u59cb\u7684\u8bbe\u5b9a\uff0c\u53ef\u4ee5\u77e5\u9053 $G(a)$ \u4e3a\u6240\u6709\u70b9\u5230 $a$ \u70b9\u7684\u8ddd\u79bb\u4e4b\u548c\uff0c\u56e0\u4e3a $x$ \u4e0d\u4f1a\u51fa\u73b0\u5728 $Son_a$ \u53ca\u5176\u5b50\u6811\u4e2d\uff0c\u6240\u4ee5\u6211\u4eec\u8981\u51cf\u53bb $F(Son_a)$ \u5bf9\u7b54\u6848\u7684\u5f71\u54cd\uff0c\u7531\u4e8e\u76f4\u63a5\u51cf\u53bb\u4f1a\u5bfc\u81f4 $|\\text{a} \\rightarrow Son_a |$ \u7684\u957f\u5ea6\u4ecd\u88ab\u8ba1\u7b97\uff0c\u6613\u5f97\u77e5\u5728 $G(a)$ \u4e2d $|\\text{a} \\rightarrow Son_a |$ \u88ab\u8ba1\u7b97\u4e86 $size(Son_a)$ \u6b21\uff0c\u6240\u4ee5\u76f4\u63a5\u51cf\u53bb\u5c31\u884c\u3002\n\n\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u8ddf\u60c5\u51b5\u4e00\u7c7b\u4f3c\uff1a\n\n$$(G(a)-F(Son_a)-size(Son_a)) \\ast size(b)$$\n\n\u5408\u5e76\u4e00\u4e0b\uff0c\u5f97**\u73af\u7684\u603b\u957f\u5ea6**\u4e3a\uff1a\n\n$$\\begin{aligned}(n-size(Son_a)) \\ast size(b) \\ast (d(a)+d(b)-2 \\ast \\text{lca}(a,b)+1) + \\\\ F(b) \\ast (n-size(Son_a)) + (G(a)-F(Son_a)-size(Son_a)) \\ast size(b)\\end{aligned}$$\n\n\u7b54\u6848\u5c31\u662f**\u73af\u7684\u603b\u957f\u5ea6/\u9009\u53d6 $x,y$ \u7684\u65b9\u6848\u6570** \u3002\n\n\u63a5\u4e0b\u6765\u8003\u8651\u5982\u4f55\u6c42\u51fa $F(x)$ \u548c $G(x)$ \uff0c\u8bbe\u6811\u7684\u4e00\u53f7\u8282\u70b9\u4e3a\u6839\u3002\n\n $F(x)$ \u7684\u6c42\u6cd5\u6bd4\u8f83\u663e\u7136\uff0c\u56e0\u4e3a\u6bcf\u6761\u8fb9\u7684\u8ddd\u79bb\u90fd\u662f $1$ \uff0c\u6240\u4ee5\u5728\u7b2c\u4e00\u904d dfs \u56de\u6eaf\u65f6\u76f4\u63a5\u7edf\u8ba1\u5373\u53ef\uff0c$size(x)$ \u4e5f\u53ef\u4ee5\u4e00\u5e76\u6c42\u51fa\uff1a\n\n$$size(x)=\\sum_{y \\in Son\\{x\\}}size(y)$$\n\n$$F(x)=\\sum_{y \\in Son\\{x\\}} F(y) + size(y)$$\n\n\u5229\u7528\u7b2c\u4e00\u6b21 dfs \u6c42\u51fa\u7684\u4fe1\u606f\u6c42 $G(x)$ \uff0c\u663e\u7136\uff0c\u5f53 $x=1$ \u65f6\u6709 $G(x)=F(x)$ \u3002\n\n\u7b2c\u4e8c\u6b21 dfs \u65f6\uff0c\u8003\u8651\u5c06 $G(x)$ \u76f4\u63a5\u8f6c\u79fb\u5230 $G(y),y \\in Son\\{x\\}$ \u3002\n\n\u7531\u4e8e $G(x)$ \u7684\u7279\u6b8a\u6027\uff0c$G(x)$ \u548c $G(y)$ \u53ea\u4f1a\u53d7\u5230\u8fb9 $x \\rightarrow y$ \u8ba1\u7b97\u6b21\u6570\u7684\u5f71\u54cd\uff0c\u53ef\u4ee5\u8fd9\u4e48\u7406\u89e3\uff0c\u5728\u8ba1\u7b97 $G(x)$ \u65f6\u8fb9 $x \\rightarrow y$ \u4f1a\u88ab\u8ba1\u7b97 $size(y)$ \u6b21\uff0c\u800c\u5728\u8ba1\u7b97 $G(y)$ \u65f6\u8fb9 $x \\rightarrow y$ \u4f1a\u88ab\u8ba1\u7b97 $n-size(y)$ \u6b21\uff0c\u5176\u4ed6\u7684\u8fb9\u88ab\u8ba1\u7b97\u7684\u6b21\u6570\u5747\u4e0d\u53d7\u5f71\u54cd\uff0c\u6545\uff1a\n\n$$G(y)=G(x)-size(y)+(n-size(y))$$\n\n\u6c42\u51fa $F(x)$ \u548c $G(x)$ \u540e\uff0c\u5c31\u53ef\u4ee5\u6109\u5feb\u5730\u89e3\u51b3\u4e0a\u9762\u7684\u95ee\u9898\u4e86\u3002\n\n\u65e2\u7136\u4f60\u80fd\u627e\u5230\u8fd9\u9898\uff0c\u6211\u76f8\u4fe1\u4f60\u80fd\u77ac\u95f4\u505a\u51fa\u6765\u7684\u3002\n\n$Code:$\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nconst long long N=100010,M=1000010,INF=0x3f3f3f3f;\ninline long long Max(long long x,long long y){return x>y?x:y;}\ninline long long Min(long long x,long long y){return x<y?x:y;}\ninline void Swap(long long &x,long long &y){x^=y^=x^=y;}\nlong long head[N],ver[M],Next[M],tot;\nlong long n,m,t,d[N],F[N],G[N],dist[N],size[N],f[N][20];\nqueue<long long> q;\nvoid add(long long x,long long y){\n\tver[++tot]=y,Next[tot]=head[x],head[x]=tot;\n}\nvoid bfs(){\n\td[1]=1;\n\tq.push(1);\n\twhile(q.size()){\n\t\tlong long x=q.front();q.pop();\n\t\tfor(long long i=head[x];i;i=Next[i]){\n\t\t\tlong long y=ver[i];\n\t\t\tif(d[y])continue;\n\t\t\td[y]=d[x]+1;\n\t\t\tdist[y]=dist[x]+1;\n\t\t\tf[y][0]=x;\n\t\t\tfor(long long j=1;j<=t;j++)\n\t\t\t\tf[y][j]=f[f[y][j-1]][j-1];\n\t\t\tq.push(y);\n\t\t}\n\t}\n}\nlong long lca(long long x,long long y){\n\tif(d[x]>d[y])Swap(x,y);\n\tfor(long long i=t;i>=0;i--)\n\t\tif(d[f[y][i]]>=d[x])y=f[y][i];\n\tif(x==y)return x;\n\tfor(long long i=t;i>=0;i--)\n\t\tif(f[x][i]!=f[y][i])x=f[x][i],y=f[y][i];\n\treturn f[x][0];\n}\nlong long query(long long x,long long y){\n\treturn dist[x]+dist[y]-2*dist[lca(x,y)];\n}\nvoid dfs1(long long x,long long fa){\n\tsize[x]=1;\n\tfor(long long i=head[x];i;i=Next[i]){\n\t\tlong long y=ver[i];\n\t\tif(y==fa)continue;\n\t\tdfs1(y,x);\n\t\tsize[x]+=size[y];\n\t\tF[x]+=F[y]+size[y];\n\t}\n}\nvoid dfs2(long long x,long long fa){\n\tif(x==1)G[x]=F[x];\n\tfor(long long i=head[x];i;i=Next[i]){\n\t\tlong long y=ver[i];\n\t\tif(y==fa)continue;\n\t\tG[y]=G[x]-size[y]+(n-size[y]);\n\t\tdfs2(y,x);\n\t}\n}\nlong double GetE(long long x,long long y){\n\tlong long Lca=lca(x,y);\n\tlong double Size,Sum;\n\tif(d[x]>d[y])Swap(x,y);\n\tif(Lca!=x){\n\t\tSize=size[x]*size[y];\n\t\tSum=Size*(dist[x]+dist[y]-2*dist[Lca]+1)+F[x]*size[y]+F[y]*size[x];\n\t}\n\telse{\n\t\tlong long sonx=y;\n\t\tfor(long long i=t;i>=0;i--)\n\t\t\tif(d[f[sonx][i]]>d[x])sonx=f[sonx][i];\n\t\tSize=(n-size[sonx])*size[y];\n\t\tSum=Size*(dist[x]+dist[y]-2*dist[Lca]+1)+\n\t\t(G[x]-F[sonx]-size[sonx])*size[y]+F[y]*(n-size[sonx]);\n\t}\n\treturn Sum/Size;\n}\nint main(){\n\tscanf(\"%lld%lld\",&n,&m);\n\tt=(long long)(log(n)/log(2))+1;\n\tfor(long long i=1;i<n;i++){\n\t\tlong long x,y;\n\t\tscanf(\"%lld%lld\",&x,&y);\n\t\tadd(x,y),add(y,x);\n\t}\n\tbfs();\n\tdfs1(1,0);\n\tdfs2(1,0);\n\twhile(m--){\n\t\tlong long x,y;\n\t\tscanf(\"%lld%lld\",&x,&y);\n\t\tprintf(\"%.8lf\\n\",(double)GetE(x,y));\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1611665811,
        "uid": 137242,
        "name": "Dia\u043esi",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF629E \u3010Famil Door and Roads\u3011"
    },
    {
        "content": "\u8fd9\u91cc\u63d0\u4f9b\u4e00\u4e2a\u667a\u969c\u4e14\u590d\u6742\u5ea6\u4e0d\u4f18\u7684\u5199\u6cd5\uff0c\u5927\u5bb6\u5c31\u5f53\u770b\u4e2a\u7b11\u8bdd\u5427\u3002  \n~~\u5982\u679c\u771f\u7684\u6709\u4eba\u613f\u610f\u5199\u8fd9\u4e2a\u65b9\u6cd5\uff0c\u90a3\u5c31\u795d\u60a8\u597d\u8fd0~~\n***\n\u663e\u7136\u8fd9\u4e2a $a$\uff0c$b$ \u90fd\u5728\u73af\u4e0a\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u7ea6\u675f\uff0c\u540c\u65f6\u4e5f\u8bf4\u660e\u6b64\u73af\u4e00\u5b9a\u5305\u542b $a \\to \\operatorname{LCA}(a,b) \\to b$ \u8fd9\u90e8\u5206\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u6211\u4eec\u53ea\u9700\u8981\u8003\u8651\u62fc\u63a5\u7684\u53e6\u4e00\u90e8\u5206\u7684\u671f\u671b\u957f\u5ea6\u3002  \n\n\u6211\u4eec\u636e\u6b64\u5206\u60c5\u51b5\u8ba8\u8bba\uff1a  \n\n\u5f53\u4e24\u4e2a\u70b9\u4e0d\u5b58\u5728\u7956\u5148\u5173\u7cfb\u65f6\uff08$a \\ne \\operatorname{LCA}(a,b) \\ne b$\uff09\uff0c$a$\uff0c$b$ \u90fd\u5728\u8fd9\u4e2a\u73af\u91cc\u7684\u6761\u4ef6\u662f $S \\in subtree_a$\uff0c$T \\in subtree_b$\uff0c\u5176\u4e2d $subtree_x$ \u8868\u793a $x$ \u7684\u5b50\u6811\u3002  \n\n\u4e0d\u96be\u5f97\u51fa\u6b64\u65f6\u7684\u7b54\u6848\uff1a  \n$$\\sum_{x \\in subtree_a}\\frac{dep_x}{siz_a}+\\sum_{x \\in subtree_b}\\frac{dep_x}{siz_b}+1-2dep_{\\operatorname{LCA}(a,b)}$$\n\n\u56e0\u4e3a\u8981\u4ece $a$ \u5b50\u6811\u4e2d\u9009\u62e9\u4e00\u70b9 $x$\uff0c\u90a3\u4e48\u671f\u671b\u957f\u5ea6\u662f\u6240\u6709 $x$ \u5230 $a$ \u7684\u8ddd\u79bb\u548c\u9664\u4ee5\u4e2a\u6570\u3002\u62c6\u5f00\u62ec\u53f7\u540e\u5316\u7b80\u5c31\u662f\u8fd9\u6837\u4e86\u3002  \n\u8fd9\u4e2a\u4e1c\u897f\u53ef\u4ee5\u4e00\u904d $\\operatorname{dfs}$ \u9884\u5904\u7406\uff0c\u8fd9\u91cc\u4e0d\u591a\u8d58\u8ff0\uff0c\u6709\u9700\u8981\u53ef\u4ee5\u770b\u4ee3\u7801\u3002  \n\n\u8003\u8651\u7b2c\u4e8c\u79cd\u60c5\u51b5\uff0c\u5f53 $a$\uff0c$b$ \u5b58\u5728\u7956\u5148\u5173\u7cfb\u65f6\uff0c\u8bbe $a=\\operatorname{LCA}(a,b)$\uff0c\u8fb9\u7684\u8d77\u70b9\u5e94\u8be5\u5728 $subtree_b$ \u4e2d\uff0c\u800c\u7ec8\u70b9\u662f **\u9664\u4e86 $a$ \u5411 $b$ \u5ef6\u4f38\u7684\u90a3\u68f5\u5b50\u6811\u4e4b\u5916** \u7684\u6240\u6709\u70b9\u4e2d\u7684\u4e00\u4e2a\u3002\u6211\u4eec\u8bbe\u8fd9\u68f5\u5b50\u6811\u4e3a $T$\u3002  \n\u90a3\u4e48\u7ec8\u70b9\uff08\u7b97\u4e0a\u8fde\u63a5\u7684\u8fd9\u6761\u8fb9\uff09\u7684\u8d21\u732e\u5c31\u662f  \n\n$$1+dep_a+\\sum_{x \\in tree-T}\\frac{dep_x-2dep_{\\operatorname{LCA}(x,a)}}{n-siz_{T}}$$    \n\u4f60\u53d1\u73b0\u8fd9\u4e2a\u5c31\u662f [[LNOI2014]LCA](https://www.luogu.com.cn/problem/P4211) \u7684\u5957\u8def\uff0c\u6240\u4ee5\u8fd9\u4e2a $\\sum dep_{\\operatorname{LCA}(x,a)}$ \u5176\u5b9e\u5c31\u662f\uff0c\u5168\u6811\u6240\u6709\u8282\u70b9\u5411\u6839\u8fd9\u6761\u94fe $+1$\uff0c\u7136\u540e\u5bf9 $a \\to root$ \u6c42\u548c\u3002\n\n\u4f46\u662f\u73b0\u5728\u6211\u4eec\u6709\u4e00\u4e2a\u9650\u5236\uff0c\u5c31\u662f\u8fd9\u4e2a $x$ \u8981\u4e0d\u5728 $T$ \u8fd9\u4e2a\u5b50\u6811\u91cc\uff0c\u90a3\u4e48\u5c31\u662f\u5168\u6811\u7684\u7b54\u6848\u51cf\u53bb $T$ \u5b50\u6811\u7684\u7b54\u6848\uff0c\u663e\u7136\u6211\u4eec\u53ef\u4ee5\u8f6c\u5316\u4e3a $\\operatorname{dfs}$ \u5e8f\u4e0a\u8fde\u7eed\u533a\u95f4\u89e3\u51b3\u3002  \n\n\u7167\u642c\u4e0a\u9762\u90a3\u9053\u9898\u7684\u65b9\u6cd5\uff0c\u79bb\u7ebf\u540e\u4f7f\u7528\u6811\u5256+\u7ebf\u6bb5\u6811\u7ef4\u62a4\uff0c\u800c\u4e14\u53ef\u4ee5\u987a\u4fbf\u652f\u6301\u6c42 $\\operatorname{LCA}$\u3002\u5f53\u7136\u4e5f\u53ef\u4ee5\u4e3b\u5e2d\u6811\u3002  \n\n\u7136\u540e\u5c31\u505a\u5b8c\u4e86\u3002  \n\u65f6\u95f4\u590d\u6742\u5ea6 $O(n \\log^2 n)$\u3002  \n\n~~\u6ce8\u610f\u4e0a\u9762\u6807\u9ed1\u4f53\u7684\u90e8\u5206\uff0c\u8fd9\u91cc\u6ca1\u60f3\u6e05\u695a\u5bfc\u81f4\u6211\u8c03\u4e86\u4e00\u4e0a\u5348~~  \n\u987a\u5e26\u4e00\u63d0\uff0c$\\operatorname{dfs}$ \u7684\u4f5c\u7528\u662f\u9884\u5904\u7406\u4e00\u5806\u4e1c\u897f\uff0c\u540c\u65f6\u56e0\u4e3a\u8981\u627e\u5230\u8fd9\u4e2a\u5b50\u6811\u7684\u6839\uff0c\u6211\u5728\u6811\u5256\u4e4b\u5916\u8fd8\u5199\u4e86\u4e00\u4e2a\u500d\u589e\uff08\u3002  \n\n\u6240\u4ee5\u8877\u5fc3\u529d\u544a\u4e0d\u8981\u5199\u8fd9\u4e2a\u5199\u6cd5\uff0c\u56fe\u4e2a\u4e50\u5c31\u597d\u4e86\u3002\n\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n\n#define ri register int\n#define ll long long\n#define Tp template<class T>\n#define g() getchar()\n#define pc(x) putchar(x)\n#define isd(x) (x>=48&&x<=57)\nnamespace SlowIO{\n\tTp inline void rd(T &x){ x=0; char i=g(); bool f=1; while(!isd(i)) f&=(i!='-'),i=g(); while(isd(i)) x=(x<<3)+(x<<1)+(i^48),i=g(); x*=((f<<1)-1); }\n\tconst int OUT=1e6; static char outp[OUT]; int out;\n\tTp inline void op(T x){ out=0; x<0&&(x=-x,pc('-')); if(!x){ pc(48); return; } while(x) outp[++out]=x%10+48,x/=10; while(out) pc(outp[out--]); }\n\tTp inline void writeln(T x){ op(x);pc('\\n'); }\n\tTp inline void writesp(T x){ op(x); pc(' '); }\n\tTp inline void write(T x,char c=0){ op(x); c&&pc(c); }\n}; using namespace SlowIO;\n\n#define N 100003\n#define db double\nint n,m,head[N],cntr,FA[N][17];\nstruct edge{ int to,nxt; }e[N<<1];\ninline void add(int u,int v){ e[++cntr]={v,head[u]},head[u]=cntr; }\n#define gfore(u) for(ri i=head[u],v;i;i=e[i].nxt)\nint dfn[N],Dfn,rig[N],son[N],siz[N],fa[N],top[N],dep[N],id[N]; ll sum[N],Sdep[N];\ninline void Dfs(int u,int father){\n\tdep[u]=dep[fa[u]=father]+1,siz[u]=1;\n\tgfore(u) if((v=e[i].to)!=father)\n\t\tDfs(v,u),siz[u]+=siz[v],\n\t\tson[u]=siz[son[u]]<siz[v]?v:son[u];\n}\ninline void Df4(int u,int tp){\n\tdfn[u]=rig[u]=++Dfn,id[Dfn]=u,top[u]=tp; if(!son[u]) return; Df4(son[u],tp);\n\tgfore(u){ v=e[i].to; if(v!=fa[u]&&v!=son[u]) Df4(v,v); } rig[u]=Dfn;\n}\ninline void Df3(int u){\n\tFA[u][0]=fa[u]; for(ri i=1;i<=16;++i) FA[u][i]=FA[FA[u][i-1]][i-1];\n\t++sum[u]; gfore(u) if((v=e[i].to)!=fa[u])\n\t\tDf3(v),sum[u]+=sum[v];\n}\ninline void Df2(int u){\n\tsum[u]+=sum[fa[u]],Sdep[u]=dep[u];\n\tgfore(u) if((v=e[i].to)!=fa[u]) Df2(v),Sdep[u]+=Sdep[v];\n}\nll val[N<<2]; int tag[N<<2];\n#define lef(u) u<<1\n#define rig(u) u<<1|1\ninline void Get(int u,int l,int r,ll d){ val[u]+=d*(r-l+1),tag[u]+=d; }\ninline void Down(int u,int l,int r){ if(!tag[u]) return; ri mid=l+r>>1; Get(lef(u),l,mid,tag[u]),Get(rig(u),mid+1,r,tag[u]),tag[u]=0; }\ninline void push(int u){ val[u]=val[lef(u)]+val[rig(u)]; }\ninline void Mdf(int u,int l,int r,int L,int R){\n\tif(L>R) return; if(l>=L&&r<=R) return Get(u,l,r,1); Down(u,l,r); ri mid=l+r>>1;\n\tif(L<=mid) Mdf(lef(u),l,mid,L,R); if(R>mid) Mdf(rig(u),mid+1,r,L,R); push(u);\n}\ninline ll Qry(int u,int l,int r,int L,int R){\n\tif(L>R) return 0; if(l>=L&&r<=R) return val[u]; Down(u,l,r);\n\tri mid=l+r>>1; ll t=0; if(L<=mid) t=Qry(lef(u),l,mid,L,R);\n\tif(R>mid) t+=Qry(rig(u),mid+1,r,L,R); return t;\n}\ninline int LCA(int a,int b){\n\twhile(top[a]^top[b]){\n\t\tif(dep[top[a]]<dep[top[b]]) swap(a,b);\n\t\ta=fa[top[a]];\n\t} return dep[a]<dep[b]?a:b;\n}\ninline void Root_Mdf(int a){\n\twhile(a) Mdf(1,1,n,dfn[top[a]],dfn[a]),a=fa[top[a]];\n}\ninline ll Root_Qry(int a,ll t=0){\n\twhile(a) t+=Qry(1,1,n,dfn[top[a]],dfn[a]),a=fa[top[a]]; return t;\n}\ninline int Skip(int a,int tar){\n\tfor(ri i=16;i>=0;--i) if(dep[FA[a][i]]>dep[tar]) a=FA[a][i];\n\treturn a;\n}\n#define pii pair<int,int>\n#define fir(x) x.first\n#define sec(x) x.second\n#define rp register pii\nvector<pii > lpos[N],rpos[N],qr;\nll ans[N]; db res[N];\n\nint main()\n{\n\trd(n),rd(m);\n\tfor(ri i=1,u,v;i<n;++i)\n\t\trd(u),rd(v),add(u,v),add(v,u);\n\tDfs(1,0),Df4(1,1),Df3(1),Df2(1);\n\tfor(ri i=1;i<=m;++i){\n\t\tint a,b,lca; rd(a),rd(b),lca=LCA(a,b);\n\t\tif(dep[a]>dep[b]) swap(a,b);\n\t\tif(lca==a){\n\t\t\tint pos=Skip(b,a);\n\t\t\tlpos[dfn[pos]-1].push_back({i,a}),rpos[rig[pos]].push_back({i,a});\n\t\t\tans[i]=Sdep[1]-Sdep[pos]-(sum[a]<<1);\n\t\t\tres[i]=1.0+(db)Sdep[b]/siz[b];\n\t\t\tqr.push_back({i,n-siz[pos]}); continue;\n\t\t} res[i]=(db)Sdep[a]/siz[a]+(db)Sdep[b]/siz[b]+1.0-2.0*dep[lca];\n\t} for(ri i=1;i<=n;++i){\n\t\tRoot_Mdf(id[i]);\n\t\tfor(rp t:lpos[i]) ans[fir(t)]-=Root_Qry(sec(t))<<1;\n\t\tfor(rp t:rpos[i]) ans[fir(t)]+=Root_Qry(sec(t))<<1;\n\t} for(rp t:qr) res[fir(t)]+=(db)ans[fir(t)]/sec(t);\n\tfor(ri i=1;i<=m;++i) printf(\"%.8lf\\n\",res[i]);\n\treturn 0;\n}\n```",
        "postTime": 1660805532,
        "uid": 538609,
        "name": "Neutralized",
        "ccfLevel": 7,
        "title": "\u6807\u9898"
    },
    {
        "content": "~~\u5957\u8def\u9898\uff0c\u53ef\u6d77\u661f~~\n\n\u6211\u4eec\u53d1\u73b0\uff0c\u7b54\u6848\u5c31\u662f \u53ef\u4ee5\u6784\u6210\u7684\u6240\u6709\u73af\u7684\u603b\u957f\u5ea6/\u53ef\u4ee5\u6784\u6210\u7684\u6240\u6709\u73af\u7684\u6570\u91cf\n\n\u90a3\u4e48\uff0c\u6211\u4eec\u5206\u60c5\u51b5\u8ba8\u8bba\u4e00\u4e0b\n\n\u5bf9\u4e8e\u8be2\u95ee\u7684\u70b9\u5bf9\uff08x,y\uff09\uff0c\u6211\u4eec\u9ed8\u8ba4$dep_x \\ge dep_y$\n\n1.y\u662fx\u7684\u7956\u5148\n\t\n\u6211\u4eec\u5b9a\u4e49w\u4e3a\uff0cw\u662fx\u7684\u7956\u5148\u4e14$fa_w=y$\n\n\u6b64\u65f6\uff0c\u6240\u6709\u53ef\u4ee5\u6784\u6210\u73af\u7684\u70b9\u5bf9\u5fc5\u5b9a\u662f\uff0c\u4e00\u4e2a\u5728x\u7684\u5b50\u6811\u5185\uff0c\u53e6\u4e00\u4e2a\u5728w\u7684\u5b50\u6811\u5916\u3002\n\n\u73af\u7684\u6570\u91cf\u5c31\u662f$size_x*(n-size_w)$\n\n\u90a3\u4e48\uff0c\u73af\u7684\u603b\u957f\u5ea6\u600e\u4e48\u6c42\u5462\uff1f\n\n\u5148\u8003\u8651\u516c\u5171\u90e8\u5206\uff0c\u4e5f\u5c31\u662f\u4ecex\u5230w\u7684\u957f\u5ea6\uff08\u4e3a\u5565\u4e0d\u662f\u4ecex\u5230y\u7684\u957f\u5ea6\u5462\uff1f\u56e0\u4e3a\u4e3a\u4e86\u65b9\u4fbf\u6c42\u5b50\u6811\u5916\u7684\u90e8\u5206\uff0c\u9009\u53d6y\u7684\u8bdd\uff0c\u53ef\u80fd\u4f1a\u6bd4\u8f83\u9ebb\u70e6\uff09\u548c \u65b0\u52a0\u7684\u8fb9\u7684\u957f\u5ea61\uff0c\u4ed6\u4f1a\u51fa\u73b0 $size_x*(n-size_w)$ \u6b21\u3002\n\n\u5176\u6b21\u5c31\u662f\uff0cx\u5b50\u6811\u5185\u7684\u90e8\u5206\uff0c\u6211\u4eec\u9700\u8981\u7ef4\u62a4x\u5b50\u6811\u5185\u7684\u6240\u6709\u70b9\u5230x\u7684\u8ddd\u79bb\u548c\uff0c\u4ed6\u4f1a\u51fa\u73b0 $n - size_w$ \u6b21\n\n\u6700\u540e\u5c31\u662f\uff0cw\u5b50\u6811\u5916\u7684\u90e8\u5206\uff0c\u6211\u4eec\u9700\u8981\u7ef4\u62a4w\u5b50\u6811\u5916\u7684\u6240\u6709\u70b9\u5230w\u7684\u8ddd\u79bb\u548c\uff0c\u4ed6\u4f1a\u51fa\u73b0$size_x$\u6b21\n\n\u7ef4\u62a4\u7684\u8fd9\u4e9b\u4e1c\u897f\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e24\u904ddfs\uff0c\u6362\u6839DP\u6765\u6c42\u51fa\u3002\u8fd9\u4e2a\u662f\u6bd4\u8f83\u57fa\u7840\u7684\u4e86\u3002\n\n2.y\u4e0d\u662fx\u7684\u7956\u5148\n\n\u8fd9\u4e2a\u66f4\u7b80\u5355\u4e86\n\n\u70b9\u5bf9 \u662f\u4e00\u4e2a\u5728x\u7684\u5b50\u6811\u5185\uff0c\u53e6\u4e00\u4e2a\u5728y\u7684\u5b50\u6811\u5185\n\n\u516c\u5171\u90e8\u5206\u662f$dis_{x,y}$ + 1\uff0c\u4f1a\u51fa\u73b0$size_x*size_y$\u6b21\n\n\u4e24\u4e2a\u5b50\u6811\u5185\u7684\u90e8\u5206\u5c31\u8ddf\u4e0a\u9762\u7684\u5dee\u4e0d\u591a\u4e86\u3002\n\n\u7136\u540e\u5c31\u5b8c\u7f8e\u5730\u89e3\u51b3\u4e86\u3002\n\n$O(n)$\u9884\u5904\u7406\uff0c\u5355\u6b21\u8be2\u95ee$O(logn)$\n\n\u8d34\u4e0a\u4ee3\u7801\n\n```cpp\nconst int N = 1e5 + 5;\nint n , m;\nint fa[N][20] , size[N] , dep[N];\nll sum[N] , s[N];\nstruct Edge\n{\n\tint to; Edge *nxt;\n\tEdge(int to = 0,Edge *nxt = NULL) : to(to) , nxt(nxt) {}\n} *head[N] , pool[N << 1] , *tail = pool;\ninline void add(int u,int v) { head[u] = new (tail ++) Edge(v,head[u]);}\nvoid get_tree(int x)\n{\n\tdep[x] = dep[fa[x][0]] + 1; size[x] = 1;\n\tfor(int i = 1;i <= 19;i ++) fa[x][i] = fa[fa[x][i - 1]][i - 1];\n\tfor(Edge *i = head[x];i;i = i -> nxt)\n\t{\n\t\tint to = i -> to;\n\t\tif(to == fa[x][0]) continue;\n\t\tfa[to][0] = x;\n\t\tget_tree(to);\n\t\tsize[x] += size[to];\n\t\tsum[x] += sum[to] + size[to];\n\t}\n}\nvoid dfs(int x)\n{\n\tfor(Edge *i = head[x];i;i = i -> nxt)\n\t{\n\t\tint to = i -> to;\n\t\tif(to == fa[x][0]) continue;\n\t\ts[to] = s[x] + sum[x] - sum[to] - size[to] + n - size[to];\n\t\tdfs(to);\n\t}\n}\ninline int LCA(int x,int y)\n{\n\tif(dep[x] < dep[y]) swap(x,y);\n\tfor(int i = 19;i >= 0;i --) if(dep[fa[x][i]] >= dep[y]) x = fa[x][i];\n\tif(x == y) return x;\n\tfor(int i = 19;i >= 0;i --) if(fa[x][i] != fa[y][i]) x = fa[x][i] , y = fa[y][i];\n\treturn fa[x][0];\n}\ninline int find(int x,int y)\n{\n\tfor(int i = 19;i >= 0;i --) if(dep[fa[fa[x][i]][0]] >= dep[y]) x = fa[x][i];\n\treturn x;\n}\ninline int Dis(int x,int y) { return dep[x] + dep[y] - (dep[LCA(x,y)] << 1);}\nint main()\n{\n\tn = read(); m = read();\n\tfor(int i = 1 , u , v;i < n;i ++) u = read() , v = read() , add(u,v) , add(v,u);\n\tget_tree(1); dfs(1);\n\twhile(m --> 0)\n\t{\n\t\tint x = read() , y = read() , lca = LCA(x,y); double ans = 0;\n\t\tif(dep[x] < dep[y]) swap(x,y);\n\t\tif(lca == y) \n\t\t{\n\t\t\tint w = find(x,y);\n\t\t\tans = dep[x] - dep[w] + 1 + (double)sum[x] / (double)size[x] + (double)s[w] / (double)(n - size[w]);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tans = (double)sum[x] / (double)size[x] + (double)sum[y] / (double)size[y] + Dis(x,y) + 1;\n\t\t}\n\t\tprintf(\"%.8f\\n\",ans);\n\t}\n\treturn 0;\n}\n```\n",
        "postTime": 1589501659,
        "uid": 153898,
        "name": "Treaker",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF629E \u3010Famil Door and Roads\u3011"
    },
    {
        "content": "### \u9898\u76ee\u63cf\u8ff0\n\n\u7ed9\u51fa\u4e00\u68f5n\u4e2a\u8282\u70b9\u7684\u6811\u3002\u6709m\u4e2a\u8be2\u95ee\uff0c\u6bcf\u4e00\u4e2a\u8be2\u95ee\u5305\u542b\u4e24\u4e2a\u6570a\u3001b\uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9\u4efb\u610f\u4e24\u4e2a\u4e0d\u76f8\u8fde\u7684\u70b9\u8fde\u4e00\u6761\u65e0\u5411\u8fb9\uff0c\u5e76\u4e14\u4f7f\u5f97\u52a0\u4e0a\u8fd9\u6761\u8fb9\u540ea\uff0cb\u5904\u5728\u4e00\u4e2a\u73af\u5185\u3002\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u8be2\u95ee\uff0c\u6c42\u8fd9\u6837\u7684\u73af\u7684\u671f\u671b\u957f\u5ea6\u3002\n\n$2<=n,m<=10^5$\n\n### \u8f93\u5165\n\n\u7b2c\u4e00\u884c\u5305\u62ec\u4e24\u4e2a\u6574\u6570n\uff0cm\uff0c\u5206\u522b\u8868\u793a\u8282\u70b9\u6570\u548c\u8be2\u95ee\u6570\u3002\n\u63a5\u4e0b\u6765n-1\u884c\uff0c\u6bcf\u884c\u4e24\u4e2a\u6574\u6570u\u3001v\u8868\u793a\u6709\u4e00\u6761\u4eceu\u5230v\u7684\u8fb9\u3002\n\u63a5\u4e0b\u6765m\u884c\uff0c\u6bcf\u884c\u4e24\u4e2a\u6574\u6570a\u3001b\uff08a\u2260b\uff09\uff0c\u8868\u793a\u4e00\u4e2a\u8be2\u95ee\u3002\n\n### \u8f93\u51fa\n\n\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u8be2\u95ee\uff0c\u8f93\u51fa\u6ee1\u8db3\u6761\u4ef6\u7684\u73af\u7684\u671f\u671b\u957f\u5ea6\u3002\u7b54\u6848\u4fdd\u75596\u4f4d\u5c0f\u6570\u3002\n\n\n## \u9898\u89e3\n\n\u9898\u76ee\u6c42\u7684\u662f\u671f\u671b\uff0c\u5176\u5b9e\u5c31\u662f\u6c42\u4e24\u4e2a\u4e1c\u897f\uff0c$all=$\u80fd\u5f62\u6210\u73af\u7684\u4e2a\u6570\uff0c$ans=$\u6240\u6709\u73af\u7684\u957f\u5ea6\u603b\u548c\uff0c\u4e24\u8005\u76f8\u9664\u5f97\u5230\u7b54\u6848\u3002\n\n\u8f6c\u5316\u4e3a\u6811\u4e0a\u7684\u8ba1\u6570\u95ee\u9898\u3002\u63a5\u4e0b\u6765\u5206\u4e24\u79cd\u60c5\u51b5\u8ba8\u8bba\u3002\n\n\u5148\u4ea4\u4ee3\u4e0b\u9762\u4f1a\u7528\u5230\u7684\u6570\u7ec4\uff0c\u53ca\u5176\u610f\u4e49\u3002\n\n> *$sz[x]$*\uff1a\u4ee5x\u4e3a\u6839\u7684\u5b50\u6811\u6240\u542b\u8282\u70b9\u7684\u4e2a\u6570\u3002\n>\n> *$dep[x]$*\uff1a\u8282\u70b9\u6df1\u5ea6\u3002\n>\n> *$fa[x][i=0..17]$*\uff1ax\u5411\u4e0a\u7b2c$2^i$\u4e2a\u7956\u5148\uff08\u4f9b\u540e\u9762\u500d\u589e\u8df3LCA\u7528\uff09\u3002\n>\n> *$sum[x]$*\uff1a$= \u2211_{son\u2208x}dep[son]$\uff0c\u4e5f\u5c31\u662f\u5b50\u6811\u4e2d\u6240\u6709\u70b9\u7684\u6df1\u5ea6\u4e4b\u548c\u3002\n>\n> *$tot[x]$*\uff1a\u540e\u9762\u518d\u8bf4\u3002\n\n\n\n### 1.(u,v)\u4e0d\u662f\u7956\u5148\u5173\u7cfb\n\n![](https://images.cnblogs.com/cnblogs_com/Tieechal/1556277/o_CF%20tmps.png)\n\n\u53d1\u73b0\u53ea\u80fd\u5c06u,v\u5b50\u6811\u91cc\u7684\u70b9\u8fde\u8d77\u6765\u3002\n\n\u6240\u4ee5\uff0c\u80fd\u5f62\u6210\u73af\u7684\u4e2a\u6570$all=sz[u]*sz[v]$\uff0c\u5176\u4e2d$sz$\u6570\u7ec4\u8868\u793a\u5b50\u6811\u6240\u542b\u8282\u70b9\u4e2a\u6570\u3002\n\n\u6240\u6709\u73af\u7684\u957f\u5ea6\u4e4b\u548c\uff1a\n\n$ans+=sz[u]*(sum[v]-dep[v]*sz[v]);$\n$ans+=sz[v]*(sum[u]-dep[u]*sz[u]);$\n$ans+=all*(dep[u]+dep[v]-2*dep[lca]+1);$\n\n\n\n------\n\n### 2.(u,v)\u662f\u7956\u5148\u5173\u7cfb\n\n\u7279\u6b8a\u70b9\u8bf4\u660e\uff1a\u5c06\u6df1\u5ea6\u5c0f\u7684\u70b9\u4f5c\u4e3au\u3002son\u662fu\u7684\u513f\u5b50\u4e2d\u901a\u5411v\u7684\u90a3\u4e00\u4e2a\u3002v\u662f\u6df1\u5ea6\u8f83\u5927\u7684\u90a3\u4e00\u4e2a\u3002\n\n\u5982\u4f55\u6c42son\uff1f\u500d\u589e\u5411\u4e0a\u8df3$dep[v]-dep[u]-1$\u6b65\uff0c\u53ef\u4ee5\u5728O(logN)\u65f6\u95f4\u5185\u5f97\u5230\u3002\n\n------\n\n\u770b\u4e0b\u9762\u8fd9\u5e45\u56fe\uff0c\u6211\u4eec\u53ea\u80fd\u5728**v\u7684\u5b50\u6811**\u4e2d\u9009\u4e00\u4e2a\u70b9\uff0c\u5728**\u84dd\u8272\u90e8\u5206(\u9664\u5b50\u6811son\u7684\u70b9)** \u9009\u4e00\u4e2a\u70b9\uff0c\u5c06\u4e24\u8005\u76f8\u8fde\uff0c\u624d\u80fd\u5f62\u6210\u73af\u3002\n\n\u6240\u4ee5\uff0c\u73af\u7684\u4e2a\u6570$all=sz[v]*(sz[1]-sz[son])$\u3002\n\n\u5982\u4f55\u6c42\u73af\u7684\u957f\u5ea6\u603b\u548c\uff1f\u5206\u6210\u4e0b\u9762\u51e0\u90e8\u5206\u5206\u6b65\u6c42\u89e3\u3002\n\n\u8fd9\u91cc\u6362\u4e2a\u5143\u65b9\u4fbf\u4e0b\u9762\u8868\u793a$sz1=sz[v]$\uff0c$sz2=(sz[1]-sz[son])$\u3002$sz1$\u5c31\u662f\u7c89\u8272\u90e8\u5206\u7684\u70b9\u6570\uff0c$sz2$\u5c31\u662f\u84dd\u8272\u90e8\u5206\u7684\u70b9\u6570\u3002\n\n\n\n![](https://images.cnblogs.com/cnblogs_com/Tieechal/1556277/o_CF%20tmp2.png)\n\n**part1:**\n\n$ans+=(sum[v]-dep[v]*sz1)*sz2+(dep[v]-dep[u])*all$\n\n**part2:**\n\n$ans+=1*all$\n\n**part3\uff1a**\n\n\u8fd9\u4e2a\u4e1c\u897f\u4e0e\u524d\u9762\u51e0\u4e2a\u76f8\u6bd4\u4e0d\u592a\u597d\u5206\u6790\u3002\n\n\u6c42\u6811\u4e0a\u4e24\u70b9(a,b)\u7684\u8ddd\u79bb\u5c31\u662f$dep[a]+dep[b]-2*dep[LCA(a,b)]$\u3002\n\n\u5168\u90e8\u52a0\u8d77\u6765\uff0c\u90a3\u4e48\u73b0\u5728\u6211\u4eec\u6c42\u7684\u5c31\u662f\u4e0b\u9762\u8fd9\u4e1c\u897f\u3002\n$$\ndep[u]*sz2+\u2211_{x\u2208bluepart}(dep[x]-2*dep[LCA(u,x)])\n$$\n\u524d\u9762\u90a3\u4e2a\u53ef\u4ee5O(1)\u7b97\u51fa\u3002\u5c31\u662f\u540e\u9762\u90a3\u4e00\u5768\u5982\u4f55\u5728\u53ef\u884c\u7684\u65f6\u95f4\u5185\u5f04\u51fa\uff1f\n\n\u8003\u8651\u9884\u5904\u7406\u4e00\u4e2a\u6570\u7ec4$tot[son]$\uff0c\u8868\u793a\uff0c\u82e5\u5b83\u7684\u7236\u4eb2\u8282\u70b9\u4e3au\uff0c\u5219$tot[son]=\u2211_{x\u2208bluepart}(dep[x]-2*dep[LCA(u,x)])$\u4e5f\u5c31\u662f\u4e0a\u9762\u5f0f\u5b50\u4e2d\u540e\u9762\u7684\u90e8\u5206\u3002\n\ndfs\u4e00\u904d\uff0c\u5b8c\u6210$tot$\u6570\u7ec4\u7684\u9884\u5904\u7406\uff0c\u8f6c\u79fb\u5982\u4e0b\u3002\u753b\u4e2a\u56fe\u8fd8\u662f\u5f88\u597d\u7406\u89e3\u7684\uff0c\u5f53\u5f04\u5230x\u65f6\uff0cf\u5c31\u662f\u4e0a\u5f0f\u7684lca\u3002\n\n```cpp\nvoid dfs2(int x){\n    int f=fa[x][0];\n    if(f){\n        tot[x]=tot[f]+sum[f]-sum[x];\n        tot[x]-=2ll*(sz[f]-sz[x])*dep[f];\n    }\n    for(int i=head[x];i;i=e[i].nxt)if(e[i].to!=fa[x][0])dfs2(e[i].to);\n}\n```\n\n\u7efc\u4e0a\u5206\u4e24\u79cd\u60c5\u51b5\u8ba8\u8bba\uff0c\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a$O(NlogN)$\u3002\n\n\u5b8c\u6574\u4ee3\u7801\u5982\u4e0b\uff1a\n\n```cpp\n#include<bits/stdc++.h>\n#define int long long\nusing namespace std;\ntypedef long long ll;\nconst int N=1e5+10;\ninline int read(){\n    int x=0;char c=getchar();\n    while(c<'0'||c>'9')c=getchar();\n    while(c>='0'&&c<='9')x=(x<<3)+(x<<1)+(c^48),c=getchar();\n    return x;\n}\nstruct edge{\n    int to,nxt;\n}e[N<<1];\nint head[N],ecnt;\ninline void link(int u,int v){\n    e[++ecnt].to=v,e[ecnt].nxt=head[u];\n    head[u]=ecnt;\n}\nint n,m;\nll sum[N],tot[N];\nint sz[N],dep[N],fa[N][18];\nll gcd(ll a,ll b){return b==0?a:gcd(b,a%b);}\nvoid dfs(int x,int f){\n    fa[x][0]=f,dep[x]=dep[f]+1,sum[x]=dep[x];\n    sz[x]=1;\n    for(int i=head[x];i;i=e[i].nxt){\n        int y=e[i].to;if(y==f)continue;\n        dfs(y,x);\n        sz[x]+=sz[y];\n        sum[x]+=sum[y];\n    }\n}\nvoid dfs2(int x){\n    int f=fa[x][0];\n    if(f){\n        tot[x]=tot[f]+sum[f]-sum[x];\n        tot[x]-=2ll*(sz[f]-sz[x])*dep[f];\n    }\n    for(int i=head[x];i;i=e[i].nxt)if(e[i].to!=fa[x][0])dfs2(e[i].to);\n}\ninline int jump(int x,int stp){\n    for(int i=0;i<=17;i++)if(stp&(1<<i))x=fa[x][i];\n    return x;\n}\ninline int LCA(int x,int y){\n    if(dep[x]<dep[y])swap(x,y);\n    int stp=dep[x]-dep[y];\n    x=jump(x,stp);\n    if(x==y)return x;\n    for(int i=17;i>=0;i--)if(fa[x][i]!=fa[y][i])x=fa[x][i],y=fa[y][i];\n    return fa[x][0];\n}\nsigned main(){\n    n=read(),m=read();\n    for(int i=1;i<n;i++){\n        int u=read(),v=read();\n        link(u,v),link(v,u);\n    }\n    dfs(1,0),dfs2(1);\n    for(int j=1;j<=17;j++)for(int i=1;i<=n;i++)fa[i][j]=fa[fa[i][j-1]][j-1];\n    while(m--){\n        int u=read(),v=read();\n        if(dep[u]>dep[v])swap(u,v);\n        int lca=LCA(u,v);\n        ll all,ans;\n        if(lca==u){\n            int son=jump(v,dep[v]-dep[u]-1);\n            int sz1=sz[v],sz2=sz[1]-sz[son]; \n            all=1ll*sz1*sz2,ans=0;\n            ans+=1ll*(sum[v]-dep[v]*sz1)*sz2;\n            ans+=1ll*(tot[son]+sz2*dep[u])*sz1;\n            ans+=1ll*all*(dep[v]-dep[u]+1);\n        }\n        else{\n            all=1ll*sz[u]*sz[v],ans=0;\n            ans+=1ll*sz[u]*(sum[v]-dep[v]*sz[v]);\n            ans+=1ll*sz[v]*(sum[u]-dep[u]*sz[u]);\n            ans+=1ll*all*(dep[u]+dep[v]-2*dep[lca]+1);\n        }\n    \tprintf(\"%.7f\\n\",1.0*ans/all);\n\t}\n}\n```\n\n[blog](https://www.cnblogs.com/Tieechal/p/11590224.html)\n\n",
        "postTime": 1569473455,
        "uid": 33912,
        "name": "lyb666666",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 CF629E \u3010Famil Door and Roads\u3011"
    },
    {
        "content": "## Famil Door and Roads\n\n### \u89e3\u6790\uff1a\n\n\n\u6362\u6839dp + \u500d\u589e + \u9884\u5904\u7406\n\n\u6839\u636e\u671f\u671b\u7684\u5b9a\u4e49\u4e0d\u96be\u53d1\u73b0\uff0c\u6211\u4eec\u9700\u8981\u6c42\u7684\u7b54\u6848\u5176\u5b9e\u662f \u6240\u6709\u73af\u7684\u957f\u5ea6\u7684\u548c/\u8fd9\u6837\u7684\u73af\u7684\u4e2a\u6570\u3002\n\n\u53d8\u91cf\u58f0\u660e\uff1a\n\n$siz_u,f_u,g_u$ \u5206\u522b\u8868\u793a\u5728\u6839\u4e3a $1$ \u7684\u610f\u4e49\u4e0b\u5b50\u6811 $u$ \u7684\u5927\u5c0f\uff0c\u5728\u6839\u4e3a $1$ \u7684\u610f\u4e49\u4e0b\u5b50\u6811 $u$ \u6240\u6709\u5b50\u6811\u7684\u5927\u5c0f\u7684\u548c\uff0c\u5728\u6839\u4e3a $u$ \u7684\u610f\u4e49\u4e0b\u6240\u6709\u5b50\u6811\u7684\u5927\u5c0f\u7684\u548c\uff08\u8fd9\u91cc\u4e0d\u61c2\u6ca1\u5173\u7cfb\uff0c\u63a5\u7740\u5f80\u4e0b\u770b\uff09\u3002\n\n\u5bf9\u4e8e\u6bcf\u6b21\u8be2\u95ee\u7684\u70b9 $a,b$ \uff0c\u6211\u4eec\u5206\u6210\u4e24\u7c7b\u8fdb\u884c\u8ba8\u8bba\n\n- \u5982\u679c  $a,b$ \u4e92\u76f8\u65e0\u7956\u5148\u5173\u7cfb\uff0c\u90a3\u4e48\u73af\u7684\u4e2a\u6570\u5b9e\u9645\u4e0a\u5c31\u662f $siz_a \\times siz_b$\uff0c\u800c\u5bf9\u4e8e\u6240\u6709\u73af\u7684\u603b\u957f\u5ea6\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u8fb9\u5206\u4e3a\u4e09\u7c7b\uff1a\n\n  - \u65b0\u52a0\u5165\u73af\u7684\u8fb9\uff0c\u6bcf\u6b21\u52a0\u4e00\u6761\u8fb9\uff0c\u4e00\u5171\u52a0\u4e86**\u73af\u7684\u4e2a\u6570**\u6b21\uff0c\u8fd9\u7c7b\u8fb9\u4e00\u5171\u6709 $siz_a \\times siz_b$ \u6761\u3002\n\n  - \u539f\u5148\u5728\u6811\u4e2d\u7684\u8fb9\u4e14\u51fa\u73b0\u5728\u4e86\u6bcf\u4e00\u4e2a\u73af\u4e0a\uff0c\u8fd9\u6837\u7684\u8fb9\u5176\u5b9e\u5c31\u662f\u8def\u5f84 $a \\rightarrow b$ \u4e0a\u7684\u6240\u6709\u8fb9\uff0c\u540c\u6837\u51fa\u73b0\u4e86 $siz_a \\times siz_b$  \u6b21\u3002\n\n  - \u539f\u5148\u5728\u6811\u4e2d\u7684\u8fb9\u4f46\u51fa\u73b0\u5728\u4e86 $a$  ($b$) \u7684\u5b50\u6811\u5185\uff0c\u8fd9\u6837\u7684\u8fb9\u662f\u6700\u590d\u6742\u7684\uff0c\u6211\u4eec\u8003\u8651\u5bf9\u4e8e\u4e00\u4e2a\u5728 $a$ \u5b50\u6811\u5185\u7684\u8282\u70b9 $u$ ,\u90a3\u4e48\u7ecf\u8fc7\u8fb9 $father_u\\rightarrow u$ \u7684\u6b21\u6570\u4e3a $siz_u\\times siz_b$\uff0c\u6211\u4eec\u53d1\u73b0\u539f\u5f0f\u7b49\u4ef7\u4e8e $siz_b\\times \\sum_{u\\in \\mathrm S}siz_u$\uff0c\u8fd9\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 $f$ \u6570\u7ec4\u5feb\u901f\u8ba1\u7b97\u51fa $\\sum_{u\\in \\mathrm S}siz_u$ \uff0c\u5176\u4e2d $\\mathrm S$ \u8868\u793a\u5b50\u6811 $a$ \u4e2d\u6240\u6709\u70b9\u7684\u96c6\u5408\uff08\u4f46\u4e0d\u5305\u62ec $a$\uff0c\u56e0\u4e3a\u8fde\u63a5 $father_a\\rightarrow a$ \u7684\u8fb9\u5c5e\u4e8e\u7b2c\u4e8c\u79cd\u60c5\u51b5\uff09\u3002\u5219\u8fd9\u79cd\u8fb9\u7684\u603b\u4e2a\u6570\u4e3a $(f_a-siz_a)\\times siz_b+(f_b-siz_b)\\times siz_a$\n\n    \u7efc\u4e0a\uff1a\u8fd9\u90e8\u5206\u7684\u7b54\u6848\u4e3a : \uff08\u5176\u5b9e\u8fd8\u53ef\u4ee5\u5316\u7b80\uff0c\u4f46\u6ca1\u6709\u5fc5\u8981\uff09\n    $$\n    \\frac{siz_a \\times siz_b+siz_a \\times siz_b\\times dis(a,b)+(f_a-siz_a)\\times siz_b+(f_b-siz_b)\\times siz_a}{siz_a\\times siz_b}\n    $$\n    ![1](https://cdn.luogu.com.cn/upload/image_hosting/7pvn841u.png)\n\n    \u5176\u4e2d\uff0c\u5982\u679c\u6211\u8981\u8ba9 $2,4$ \u4e24\u4e2a\u70b9\u5171\u73af\uff0c\u90a3\u5728\u4e24\u4e2a\u5b50\u6811\u4e2d\u4efb\u610f\u5404\u9009\u4e00\u4e2a\u9876\u70b9\u76f8\u8fde\u5c31\u53ef\u4ee5\u4f7f\u4ed6\u4eec\u5171\u73af\uff0c\u5176\u4e2d\uff0c\u84dd\u8272\u8fb9\u662f\u6bcf\u6b21\u90fd\u9700\u8981\u7ecf\u8fc7\u7684\uff0c\u7eff\u8272\u8fb9\u6709\u51e0\u7387\u901a\u8fc7 \u3002\n\n  - \u5982\u679c  a,b \u4e92\u76f8\u6709\u7956\u5148\u5173\u7cfb\uff0c\u6211\u4eec\u94a6\u5b9a $a$ \u4e3a $b$ \u7684\u7956\u5148\uff0c\u90a3\u4e48\u73af\u7684\u4e2a\u6570\u5b9e\u9645\u4e0a\u662f $siz_b \\times (n-siz_{son_a})$ \u5176\u4e2d $son_a$ \u4e00\u5b9a\u4e5f\u662f $b$  \u7684\u7956\u5148\uff0c\uff08\u8fd9\u90e8\u5206\u53ef\u4ee5\u901a\u8fc7\u500d\u589e\u6c42\u89e3\uff09\u3002\u800c\u603b\u73af\u7684\u5927\u5c0f\uff0c\u6211\u4eec\u540c\u6837\u5206\u4e3a\u4e09\u7c7b\uff1a\n\n    - \u65b0\u52a0\u5165\u73af\u7684\u8fb9\uff0c\u6bcf\u6b21\u52a0\u4e00\u6761\u8fb9\uff0c\u4e00\u5171\u52a0\u4e86**\u73af\u7684\u4e2a\u6570**\u6b21\uff0c\u8fd9\u7c7b\u8fb9\u4e00\u5171\u6709 $siz_b \\times (n-siz_{son_a})$ \u6761\u3002\n\n    - \u539f\u5148\u5728\u6811\u4e2d\u7684\u8fb9\u4e14\u51fa\u73b0\u5728\u4e86\u6bcf\u4e00\u4e2a\u73af\u4e0a\uff0c\u540c\u4e0a\u4e00\u79cd\u60c5\u51b5\uff0c\u4e00\u5171 $siz_b \\times (n-siz_{son_a}) \\times dis(a,b)$  \u6b21\u3002\n\n    - \u539f\u5148\u5728\u6811\u4e2d\u7684\u8fb9\u4f46\u51fa\u73b0\u5728\u4e86 $a$  ($b$) \u7684\u5b50\u6811\u5185\uff0c\u8fd9\u90e8\u5206\u8fb9\u5728 $b$ \u7684\u5b50\u6811\u5185\u4ecd\u7136\u53ef\u4ee5\u5feb\u901f\u6c42\u51fa\uff0c\u56e0\u4e3a\u5b50\u6811 $a$ \u4ee5\u5916\u7684\u5927\u5c0f\u662f\u5f88\u597d\u7b97\u51fa\u7684\uff0c\u5373 $f_b \\times (n-siz_{son_a})$\uff0c\u4f46\u5982\u679c\u6211\u4eec\u9700\u8981\u7b97 $a$ \u5b50\u6811\u5916\u7684\u6240\u6709\u5b50\u6811\u7684\u7b54\u6848\uff0c\u8fd9\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u94a6\u5b9a $a$ \u4e3a\u6839\u4e86\uff0c\u8fd9\u90e8\u5206\u5f88\u660e\u663e\u5c31\u662f\u6362\u6839dp\u7684\u677f\u5b50\uff0c\u6211\u4eec\u7b97\u51fa $g_{father_u}$ \u540e\uff0c\u901a\u8fc7 $g$ \u7684\u5b9a\u4e49\u53ef\u4ee5\u53d1\u73b0 $g_u=\\sum_{v\\in \\mathrm S} f_v+f_{father_u}-f_u-siz_u+n$\u3002\u5176\u4e2d\uff0c$f_{father_u}-f_u-siz_u$  \u8868\u793a\u4ee5 $fa_u$ \u4e3a\u5b50\u6811\u7684\u6839\u7684\u60c5\u51b5\u4e0b\u7684\u6240\u6709\u5b50\u6811\u7684\u5927\u5c0f\u7684\u548c\u3002\u90a3\u8fd9\u90e8\u5206\u4e0d\u96be\u63a8\u51fa\u7b54\u6848\u4e3a $(g_a - f_{son_a} - n)\\times siz_b$ \u3002\u8fd9\u90e8\u5206\u7684\u5f0f\u5b50\u4e3a\uff1a\n      $$\n      \\frac{siz_a \\times siz_b+siz_a \\times siz_b\\times dis(a,b)+f_b \\times (n-siz_{son_a})+(g_a - f_{son_a} - n)\\times siz_b}{siz_a\\times siz_b}\n      $$\n\n    \u6ce8\u610f\uff1a\u6240\u6709\u7684 $f$ \u90fd\u53ef\u4ee5\u901a\u8fc7 $g$  \u5bb9\u65a5\u7b97\u51fa\uff0c\u4f46\u5b9e\u9645\u4e0a\u66f4\u9ebb\u70e6\u4e86\u3002\n\n----------------------------------------------------\n\n## code\uff1a\n\n```c++\n#include <bits/stdc++.h>\n#define int long long\nusing namespace std;\nconst int N = 1e5 + 10;\ninline int read ( )\n{\n    int x = 0, f = 1;\n    char ch = getchar ( );\n    while (ch < '0' || ch > '9') {if (ch == '-') f = - 1; ch = getchar ( );}\n    while (ch >= '0' && ch <='9') {x = (x << 1) + (x << 3) + (ch ^ 48); ch = getchar ( );}\n    return x * f;\n}\nint n, q;\nstruct edge {\n    int ver, nxt;\n}e[N << 1];\nint head[N], tot;\nvoid add_edge (int u, int v) { e[++tot] = (edge) {v, head[u]}; head[u] = tot; }\nint fa[N][20], depth[N], siz[N], lg[N];\nint sum1[N], sum2[N]; // \u5373 f, g \u6570\u7ec4\nvoid dfs1 (int u, int f) \n{\n    fa[u][0] = f; depth[u] = depth[f] + 1;\n    siz[u] = 1;\n    for (int i = 1; i <= lg[depth[u]]; i++)\n        fa[u][i] = fa[fa[u][i - 1]][i - 1];\n    for (int i = head[u]; i; i = e[i].nxt) {\n        int v = e[i].ver;\n        if (v == f) continue;\n        dfs1 (v, u);\n        siz[u] += siz[v];\n    }\n    sum1[u] = siz[u];\n    for (int i = head[u]; i; i = e[i].nxt) if (e[i].ver != f) sum1[u] += sum1[e[i].ver];\n}\nvoid dfs2 (int u, int f) // \u6362\u6839dp\n{\n    if (u != 1) {\n        for (int i = head[u]; i; i = e[i].nxt)\n            if (e[i].ver != f) sum2[u] += sum1[e[i].ver];\n        sum2[u] += (sum2[f] - sum1[u] + n - siz[u]);\n    }\n    for (int i = head[u]; i; i = e[i].nxt)\n        if (e[i].ver != f)\n        \t\tdfs2 (e[i].ver, u);\n}\nint getlca (int x, int y)\n{\n    if (depth[x] < depth[y]) swap (x, y);\n    while (depth[x] > depth[y]) x = fa[x][lg[depth[x] - depth[y]] - 1];\n    if (x == y) return x;\n    for (int i = lg[depth[x]]; i >= 0; i--)\n        if (fa[x][i] != fa[y][i]) x = fa[x][i], y = fa[y][i];\n    return fa[x][0];\n}\nint dis (int a, int b) { return depth[a] + depth[b] - 2 * depth[getlca (a, b)]; }\nint find (int a, int b)\n{\n    for (int i = lg[depth[b]]; i >= 0; i--)\n      \tif (fa[b][i] && depth[fa[b][i]] > depth[a]) b = fa[b][i];\n    return b;\n}\nsigned main()\n{\n    n = read (); q = read ( );\n    for (int i = 1, u, v; i < n; i++) {\n        u = read ( ), v = read ( );\n        add_edge (u, v); add_edge (v, u);\n    }\n    for (int i = 1; i <= n; i++) lg[i] = lg[i - 1] + (1 << lg[i - 1] == i);\n    dfs1 (1, 0); sum2[1] = sum1[1]; dfs2 (1, 0);\n    double len, num;\n    while (q--) {\n        int a = read ( ), b = read ( ); if (depth[a] > depth[b]) swap (a, b);\n        int lca = getlca (a, b);\n        if (lca == a) {\n            num = (n - siz[find(a, b)]) * siz[b];\n            len = num + ((sum2[a] - sum1[find(a, b)] - n) * siz[b] + (sum1[b] - siz[b]) * (n - siz[find(a, b)])) + dis(a, b) * num;\n        }\n        else {\n            num = siz[a] * siz[b];\n            len = num + ((sum1[a] - siz[a]) * siz[b] + (sum1[b] - siz[b]) * siz[a]) + dis(a, b) * num;\n        }\n        printf (\"%.6lf\\n\", (double)len / (double)num);\n    }\n    return 0;\n}\n```\n\n",
        "postTime": 1635899834,
        "uid": 177837,
        "name": "violin_wyl",
        "ccfLevel": 6,
        "title": "CF629E Famil Door and Roads"
    },
    {
        "content": "# \u9898\u76ee\u5206\u6790\n\u6211\u4eec\u9996\u5148\u4ee51\u4e3a\u6839\u3002  \n\u5bf9\u4e8e\u7ed9\u5b9a\u7684 $a,b$\uff0c\u82e5 $lca_{a,b}$ \u4e0d\u662f $a,b$\uff0c\u5219\u53ea\u6709\u5728\u5206\u522b\u8fde\u63a5 $a,b$ \u7684\u5b50\u6811\u5185\u7684\u70b9\u65f6\uff08\u5206\u522b\u8bb0\u4e3a $x,y$\uff09\uff0c$a,b$ \u624d\u53ef\u80fd\u5728\u4e00\u4e2a\u73af\u5185\uff0c\u6b64\u65f6\u73af\u7684\u957f\u5ea6\u5c31\u662f $1+dis_{a,b}+dis_{a,x}+dis_{b,y}$\uff0c\u6240\u4ee5\u6211\u4eec\u53ea\u9700\u6c42\u51fa$dis_{a,x},dis_{b,y}$ \u7684\u671f\u671b\u957f\u5ea6\u5373\u53ef\uff0c\u8fd9\u53ea\u9700\u6c42\u51fa $a$ \u5b50\u6811\u5185\u6240\u6709\u70b9\u5230 $a$ \u7684\u8ddd\u79bb\u548c\uff0c\u518d\u9664\u4ee5 $size_a$ \u5373\u53ef\uff0c\u5bf9 $b$ \u540c\u7406\uff0c\u8fd9\u4e2a\u76f4\u63a5DP\u5373\u53ef\u6c42\u51fa\u3002  \n\u82e5 $lca_{a,b}$ \u662f $a,b$ \u4e2d\u7684\u4e00\u4e2a\uff08\u8fd9\u91cc\u5047\u8bbe\u7b49\u4e8e $a$\uff09\uff0c\u5219\u6211\u4eec\u9700\u8981\u6c42\u51fa $a$ \u7684\u513f\u5b50\u4e2d\u5728 $(a,b)$ \u8fd9\u6761\u94fe\u4e0a\u7684\u513f\u5b50\uff0c\u5373 $b$ \u7684$dep_b-dep_a-1$ \u7ea7\u7956\u5148(\u8bb0\u4e3a $son$)\u3002\u7136\u540e\u53ef\u4ee5\u53d1\u73b0\u53ea\u6709\u5728\u8fde\u63a5 $b$ \u7684\u5b50\u6811\u5185\u7684\u70b9\uff08\u8bb0\u4e3a $x$\uff09\u548c\u9664\u53bb $son$ \u7684\u5b50\u6811\u5916\u7684\u6240\u6709\u70b9(\u8bb0\u4e3a $y$)\u65f6\uff0c$a,b$ \u624d\u53ef\u80fd\u5728\u4e00\u4e2a\u73af\u5185\uff0c\u6b64\u65f6\u73af\u7684\u957f\u5ea6\u5c31\u662f $1+dis_{a,b}+dis_{a,x}+dis_{b,y}$\uff0c\u6240\u4ee5\u6211\u4eec\u53ea\u9700\u6c42\u51fa$dis_{a,x},dis_{b,y}$ \u7684\u671f\u671b\u957f\u5ea6\u5373\u53ef\uff0c$dis_{b,y}$ \u7684\u671f\u671b\u7684\u8ba1\u7b97\u65b9\u6cd5\u540c\u4e0a\uff0c$dis_{a,x}$ \u7684\u671f\u671b\u9700\u8981\u6211\u4eec\u6c42\u51fa\u6240\u6709\u70b9\u5230 $a$ \u7684\u957f\u5ea6\u548c\uff0c\u518d\u51cf\u53bb $son$ \u7684\u8d21\u732e\uff0c\u518d\u9664\u4ee5 $n-size_{son}$\uff0c\u8fd9\u4e2a\u9700\u8981\u6362\u6839DP\u3002  \n\u6211\u4f7f\u7528\u4e86\u500d\u589e\u6765\u5728\u7ebf\u6c42LCA\u548cK\u7ea7\u7956\u5148\uff0c\u590d\u6742\u5ea6 $O(NlogN)$\uff0c\u4f46\u5176\u5b9e\u53ef\u4ee5\u7528\u79bb\u7ebf\u6c42LCA\u548cK\u7ea7\u7956\u5148\u6765\u505a\u5230 $O(N)$\n``` cpp\n#include <bits/stdc++.h>\nusing namespace std;\ntemplate <class T>\ninline void read(T &x)\n{\n\tx= 0;\n\tchar c= getchar();\n\twhile(!isdigit(c)) c= getchar();\n\twhile(isdigit(c)) x= x * 10 + (c & 15), c= getchar();\n}\n#define N 100001\nint n, m, head[N], cnt, dep[N], fa[N][17], sz[N];\nlong long a1[N], a2[N];//a1x\u8868\u793ax\u5b50\u6811\u5185\u8282\u70b9\u5230x\u7684\u8ddd\u79bb\u548c,a2x\u8868\u793ax\u9664\u53bbx\u5b50\u6811\u5916\u7684\u6240\u6709\u70b9\u5230x\u7684\u8ddd\u79bb\u548c\nstruct Edge\n{\n\tint a, b;\n} e[N << 1];\ninline void add(int a, int b)\n{\n\te[++cnt].a= head[a], e[cnt].b= b, head[a]= cnt;\n}\ninline void dfs1(int x, int y)//\u7b2c\u4e00\u904ddfs\u6c42\u51faa1\u6570\u7ec4\n{\n\tfa[x][0]= y, sz[x]= 1;\n\tfor(int i= 1; i < 17; i++) fa[x][i]= fa[fa[x][i - 1]][i - 1];\n\tfor(int i= head[x]; i; i= e[i].a)\n\t{\n\t\tif(e[i].b == y) continue;\n\t\tdep[e[i].b]= dep[x] + 1, dfs1(e[i].b, x);\n\t\tsz[x]+= sz[e[i].b];\n\t\ta1[x]+= a1[e[i].b] + sz[e[i].b];//\u4ece\u513f\u5b50\u8f6c\u79fb\n\t}\n}\ninline void dfs2(int x, int y)//\u7b2c\u4e8c\u904ddfs\u6c42\u51faa2\u6570\u7ec4\n{\n\tfor(int i= head[x]; i; i= e[i].a)\n\t{\n\t\tif(e[i].b == y) continue;\n\t\ta2[e[i].b]= a2[x] + n - sz[x] + 1 + a1[x] - a1[e[i].b] - sz[e[i].b] + sz[x] - sz[e[i].b] - 1;//\u8ba1\u7b97\u7956\u5148\u7684\u8d21\u732e\u548c\u7236\u4eb2\u7684\u5176\u4ed6\u513f\u5b50\u7684\u8d21\u732e\n\t\tdfs2(e[i].b, x);\n\t}\n}\ninline int lca(int x, int y)//\u500d\u589e\u6c42LCA\n{\n\tint k= dep[y] - dep[x];\n\tfor(int i= 0, j= 1; i < 17; i++, j<<= 1)\n\t\tif(k & j) y= fa[y][i];\n\tif(x == y) return x;\n\tfor(int i= 16; i >= 0; i--)\n\t\tif(fa[x][i] != fa[y][i]) x= fa[x][i], y= fa[y][i];\n\treturn fa[x][0];\n}\ninline int ancestor(int x, int k)//\u500d\u589e\u6c42K\u7ea7\u7956\u5148\n{\n\tfor(int i= 0, j= 1; i < 17; i++, j<<= 1)\n\t\tif(k & j) x= fa[x][i];\n\treturn x;\n}\nsigned main()\n{\n\tread(n), read(m);\n\tfor(int i= 1, x, y; i < n; i++) read(x), read(y), add(x, y), add(y, x);\n\tdfs1(1, 0), dfs2(1, 0);\n\tfor(int i= 1, x, y; i <= m; i++)\n\t{\n\t\tread(x), read(y);\n\t\tif(dep[x] > dep[y]) swap(x, y);\n\t\tint l= lca(x, y);\n\t\tif(x == l)//x\u662f\u4e24\u4e2a\u70b9\u7684LCA\uff0c\u5373\u4e0a\u6587\u7684\u7b2c\u4e8c\u79cd\u60c5\u51b5\n\t\t{\n\t\t\tint a= ancestor(y, dep[y] - dep[x] - 1);\n\t\t\tdouble ans= 1 + 1.0 * (a2[x] + a1[x] - a1[a] - sz[a]) / (n - sz[a]) + 1.0 * a1[y] / sz[y] + dep[y] - dep[x];\n\t\t\tprintf(\"%0.10lf\\n\", ans);\n\t\t}\n\t\telse//\u4e0a\u6587\u7684\u7b2c\u4e00\u79cd\u60c5\u51b5\n\t\t{\n\t\t\tdouble ans= 1 + 1.0 * a1[x] / sz[x] + 1.0 * a1[y] / sz[y] + dep[x] + dep[y] - (dep[l] << 1);\n\t\t\tprintf(\"%0.10lf\\n\", ans);\n\t\t}\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1604494514,
        "uid": 60075,
        "name": "pzc2004",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 CF629E \u3010Famil Door and Roads\u3011"
    }
]