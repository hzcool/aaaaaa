[
    {
        "content": "## [\u9898\u89e3](https://blog.csdn.net/BeNoble_/article/details/107156232)\n\n\u8fd9\u68f5\u6811\u662f\u4e00\u9897\u5b8c\u5168\u4e8c\u53c9\u6811\u3002\n\n\u8bbe ${\\rm dep}_u$ \u8868\u793a $u$ \u5230 $1$ \u7684\u8ddd\u79bb\u3002\n\n\u5206\u522b\u8003\u8651 $u$ \u5b50\u6811\u5185\u7684\u7b54\u6848\u548c\u5b50\u6811\u5916\u7684\u7b54\u6848\uff1a\n\n### $1.$ \u5b50\u6811\u5185\u7684\u7b54\u6848\n\n\u5373\uff1a\n\n$$\\sum_{{\\rm dep}_v-{\\rm dep}_u<H}H-({\\rm dep}_v-{\\rm dep}_u)=\\sum_{{\\rm dep}_v<H+{\\rm dep}_u}(H+{\\rm dep}_u)-{\\rm dep}_v=s(H+{\\rm dep}_u)-\\sum_{{\\rm dep}_v<H+{\\rm dep}_u}{\\rm dep}_v$$\n\n\u5176\u4e2d $s=\\sum[{\\rm dep}_v<H+{\\rm dep}_u]$ \u3002\n\n\u5c06 $u$ \u5b50\u6811\u5185\u6240\u6709\u7684 ${\\rm dep}_v$ \u653e\u5230\u7684\u4e00\u4e2a\u6570\u7ec4 $a_u$ \u4e2d\uff0c\u5bf9 $a_u$ \u6392\u5e8f\u540e\u6c42\u5176\u524d\u7f00\u548c\u6570\u7ec4 ${\\rm Sum}_u$ \u3002\n\n\u90a3\u4e48\u8fd9\u90e8\u5206\u7b54\u6848\u5c31\u53ef\u4ee5\u901a\u8fc7\u5bf9 $a_u$ \u6570\u7ec4\u4e8c\u5206\u5f97\u5230 $s$ \u7b97\u51fa\u6765\uff0c\u5373 $s(H+{\\rm dep}_u)-{\\rm Sum}_u[s]$ \u3002\n\n### $2.$ \u7236\u4eb2 $fa_u$ \u53ca\u5176\u5144\u5f1f\u8282\u70b9 $w$ \n\n\u7236\u4eb2\u7684\u7b54\u6848\u5373 $H-L_u$ \u3002\u5144\u5f1f\u8282\u70b9 $w$ \u7684\u5b50\u6811\u5185\u7684\u8282\u70b9\u7684\u7b54\u6848\u5373\uff1a\n\n$$\\sum_{{\\rm dep}_v-{\\rm dep}_w+L_u+L_w<H}H-({\\rm dep}_v-{\\rm dep}_w+L_u+L_w)=s'(H+{\\rm dep}_w-L_u-L_w)-\\sum_{{\\rm dep}_v<H+{\\rm dep}_w-L_u-L_w}{\\rm dep}_v$$\n\n\u53ef\u4ee5\u53d1\u73b0\u4e0a\u5f0f\u548c $1.$ \u4e2d\u7684\u5f0f\u5b50\u5f62\u5f0f\u76f8\u540c\uff0c\u6545\u53ef\u4ee5\u7edf\u4e00\u5904\u7406\u3002\n\n### $3.$ \u7236\u4eb2\u7684\u7236\u4eb2\u53ca\u7236\u4eb2\u7684\u5144\u5f1f\u8282\u70b9......\n\n\u7531\u4e8e\u8fd9\u662f\u68f5\u5b8c\u5168\u4e8c\u53c9\u6811\uff0c\u6545\u66b4\u529b\u8df3\u7236\u4eb2\u7b97\u7b54\u6848\u6700\u591a\u8df3 $\\log n$ \u6b21\uff0c\u7b97\u4e0a\u4e8c\u5206\u7684 $\\log n$ \uff0c\u5355\u6b21\u8be2\u95ee\u590d\u6742\u5ea6\u4e3a $\\log^2n$ \u3002\n\n$a_u$ \u53ef\u4ee5\u81ea\u5e95\u5411\u4e0a\u901a\u8fc7\u5f52\u5e76\u6c42\u51fa\uff0c\u4e14\u6839\u636e\u5b8c\u5168\u4e8c\u53c9\u6811\u7684\u7279\u6027\uff0c\u53ef\u4ee5\u91c7\u7528\u975e\u9012\u5f52\u7684\u5f62\u5f0f\u6c42\u89e3\u964d\u4f4e\u5e38\u6570\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log n+m\\log^2n)$\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\nconst int N = 1e6 + 5;\ntypedef long long ll;\nint n, m, dep[N], Len[N];\nvector<int> a[N];\nvector<ll> Sum[N];\ninline ll Calc(int u, int H) {\n    if (H <= 0 || !a[u].size())\n        return 0;\n    int s = lower_bound(a[u].begin(), a[u].end(), H) - a[u].begin();\n    return s ? (ll)s * H - Sum[u][s - 1] : 0;\n}\nint main() {\n    scanf(\"%d%d\", &n, &m);\n    for (int i = 2; i <= n; ++i)\n        scanf(\"%d\", Len + i);\n    for (int u = 1; u <= n / 2; ++u) {\n        int L = u << 1, R = L | 1;\n        if (L <= n)\n            dep[L] = dep[u] + Len[L];\n        if (R <= n)\n            dep[R] = dep[u] + Len[R];\n    }\n    for (int u = n; u; --u) {\n        int L = u << 1, R = L | 1;\n        a[u].emplace_back(dep[u]);\n        if (R <= n)\n            merge(a[L].begin(), a[L].end(), a[R].begin(), a[R].end(),\n                  back_inserter(a[u]));\n        else if (L <= n)\n            a[u].insert(a[u].end(), a[L].begin(), a[L].end());\n        Sum[u].resize(a[u].size());\n        Sum[u][0] = a[u][0];\n        for (int i = 1; i < (int)Sum[u].size(); ++i)\n            Sum[u][i] = Sum[u][i - 1] + a[u][i];\n    }\n    for (int u, H; m--;) {\n        scanf(\"%d%d\", &u, &H);\n        ll Ans = Calc(u, H + dep[u]);\n        for (H -= Len[u]; H > 0 && u != 1; H -= Len[u >>= 1])\n            Ans += H + Calc(u ^ 1, H - Len[u ^ 1] + dep[u ^ 1]);\n        printf(\"%lld\\n\", Ans);\n    }\n    return 0;\n}\n```",
        "postTime": 1594014956,
        "uid": 20156,
        "name": "Kelin",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 CF894D \u3010Ralph And His Tour in Binary Country\u3011"
    }
]