[
    {
        "content": "### Description\n\n#### \u9898\u610f\u7b80\u8ff0\n\n\u8bbe $F_i$ \u8868\u793aFibonacci\u6570\u5217\u7684\u7b2c $i$ \u9879\uff0c\u5373 $F_1=1,F_2=2,F_i=F_{i-1}+F_{i-2}$\u3002\n\n\u8bbe $A_i=F_i\\times i^k(k\\leqslant 40)$\uff0c\u4f60\u7684\u4efb\u52a1\u662f\u6c42\u51fa\u5176\u524d $n$ \u9879\u548c $(n\\leqslant 10^{18})\\bmod 10^9+7$ \u7684\u7ed3\u679c\u3002\n\n### Solution\n\n\u6ce8\u610f\u5230Fibonacci\uff0c$n\\leqslant 10^{18}$ \u7b49\u5173\u952e\u8bcd\uff0c\u660e\u6446\u7740\u5c31\u662f\u4e00\u9053\u77e9\u9635\u52a0\u901f\u561b\u3002\n\n\u4f46\u662f\uff0c\uff0c\uff0c$(i-1)^k$ \u600e\u4e48\u8f6c\u79fb\u5230 $i^k$ \u5462\uff1f\n\nBDFS\u4e86\u4e00\u5927\u5806\u540e\uff0c\u53d1\u73b0\u4e86\u65b9\u6cd5\uff1a\u4e8c\u9879\u5f0f\u5b9a\u7406\u3002\n\n$k$ \u90a3\u4e48\u5c0f\uff0c\u90a3\u4f60\u5e72\u8106\u628a $(i-1)^1,(i-1)^2,(i-1)^3,\\cdots,(i-1)^k$ \u4e22\u5230\u521d\u59cb\u77e9\u9635\u91cc\u53bb\u4e0d\u5c31\u884c\u4e86\uff1f\n\n\u987a\u4fbf\u8fd8\u5f97\u628a $i^1,i^2,i^3,\\cdots,i^k$ \u4e22\u8fdb\u53bb\uff0c\u7136\u540e $(i-1)^x$ \u5c31\u53ef\u4ee5\u76f4\u63a5\u8f6c\u6362\u6210 $i^x$\u3002\n\n\u90a3\u4e48 $i^x$ \u4e5f\u5f97\u8f6c\u6362\u4e3a $(i+1)^x$\uff0c\u6240\u4ee5\u5173\u952e\u5728\u4e8e $i^x$ \u600e\u4e48\u8f6c\u6362\u4e3a $(i+1)^x$\u3002\n\n* \u90a3\u8fd9\u4e0d\u662f\u53c8\u56de\u5230\u539f\u95ee\u9898\u4e0a\u4e86\u5417\uff01\n\n* \u54b1\u4e0d\u8981\u6025\uff0c\u5148\u6162\u6162\u770b\n\n\u7ecf\u8fc7\u4f5c\u8005\u4e00\u9635\u4e71\u641e\uff0c\u53d1\u73b0\u77e9\u9635\u4e58\u6cd5\u662f\u5904\u7406\u4e0d\u4e86 $A_i$ \u7684\u3002\n\n\u6240\u4ee5\u53ea\u80fd\u628a\u77e9\u9635\u91cc\u7684 $i^1,i^2,\\cdots,i^k$ \u90fd\u4e58\u4e0a\u4e00\u4e2a $F_i$ \u6765\u5145\u6570\u3002\n\n\u90a3\u4e48\u6211\u4eec\u770b\u4e00\u770b $F_{i+1}\\times(i+1)^k$ \u662f\u600e\u4e48\u5f97\u5230\u7684\uff1a\n$$\n\\begin{aligned}\nF_{i+1}\\times(i+1)^k&=(F_{i-1}+F_i)\\times(i+1)^k\\\\\n&=F_{i-1}\\times(i+1)^k+F_i\\times(i+1)^k\\\\\n&=F_{i-1}\\times[(i-1)+2]^k+F_i\\times[(i)+1]^k\n\\end{aligned}\n$$\n\u662f\u65f6\u5019\u4eae\u51fa\u4e8c\u9879\u5f0f\u5b9a\u7406\u4e86\uff01\n\n\u6211\u4eec\u90fd\u77e5\u9053\uff0c\u4e8c\u9879\u5f0f\u5b9a\u7406\u662f\u4e00\u4e2a\u9171\u7d2b\u7684\u4e1c\u897f\uff1a\n$$\n(x+y)^k=\\sum\\limits_{i=0}^kC_k^ix^iy^{k-i}\n$$\n\u4ee3\u5165\u5230 $[(i-1)+2]^k$ \u4e2d\u6765\uff0c\u5c31\u662f\uff1a\n$$\n[(i-1)+2]^x=\\sum\\limits_{j=0}^xC_x^j(i-1)^j2^{x-j}\n$$\n\u800c\u6211\u4eec\u521a\u597d\u6709 $(i-1)^j$\u3002\n\n$C_x^j\\times2^{x-j}$ \u5c31\u662f $(i-1)^j$ \u5728\u52a0\u901f\u77e9\u9635\u91cc\u5bf9\u5e94\u7684\u7cfb\u6570\u3002\n\n\u53c8\u4ee3\u5165\u5230 $[(i)+1]^x$ \u4e2d\uff0c\u5f97\uff1a\n$$\n[(i)+1]^x=\\sum\\limits_{j=0}^xC_x^ji^j\n$$\n\u633a\u5de7\u7684\uff0c\u6211\u4eec\u4e5f\u6709 $i^j$\u3002\n\n$C_x^j$ \u5c31\u662f $i^j$ \u5728\u52a0\u901f\u77e9\u9635\u4e2d\u5bf9\u5e94\u7684\u7cfb\u6570\u3002\n\n\u8bbe $S_x=\\sum\\limits_{i=1}^xA_i$\u3002\n\n\u90a3\u4e48\u521d\u59cb\u77e9\u9635\u5c31\u957f\u8fd9\u6837\uff1a\n$$\n[F_1,F_2,S_1,F_1\\times1^1,F_1\\times 1^2,\\cdots,F_1\\times1^k,F_2\\times2^1,F_2\\times2^2,\\cdots,F_2\\times2^k]\n$$\n\u8f6c\u79fb\u4e00\u6b65\u540e\u957f\u8fd9\u6837\uff1a\n$$\n[F_2,F_3,S_3,F_2\\times2^1,F_2\\times2^2,\\cdots,F_2\\times2^k,F_3\\times3^1,F_3\\times3^2,\\cdots,F_3\\times3^k]\n$$\n\u8f6c\u79fb $n-1$ \u6b65\u540e\u7684\u6700\u7ec8\u77e9\u9635\u957f\u8fd9\u6837\uff1a\n$$\n[F_n,F_{n+1},S_n,F_n\\times n^1,F_n\\times n^2,\\cdots,F_n\\times n^k,F_{n+1}\\times(n+1)^1,F_{n+1}\\times(n+1)^2,\\cdots,F_{n+1}\\times(n+1)^k]\n$$\n\u52a0\u901f\u77e9\u9635\u957f\u8fd9\u6837\uff1a\n$$\n\\begin{bmatrix}\n&F_i&F_{i+1}&S_i&F_i\\times i^1&F_i\\times i^2&\\cdots&F_i\\times i^k&F_{i+1}\\times(i+1)^1&F_{i+1}\\times(i+1)^2&\\cdots&F_{i+1}\\times(i+1)^k\n\\\\\nF_{i-1}(\\times(i-1)^0)&0&1&0&0&0&\\cdots&0&2^{1-0}\\times C_1^0=2&2^{2-0}\\times C_2^0=4&\\cdots&2^{k-0}\\times C_k^0\\\\\nF_{i}(\\times i^0)&1&1&0&0&0&\\cdots&0&C_1^0=1&C_2^0=1&\\cdots&C_k^0\\\\\nS_{i-1}&0&0&1&0&0&\\cdots&0&0&0&\\cdots&0\\\\\nF_{i-1}\\times(i-1)^1&0&0&0&0&0&\\cdots&0&2^{1-1}\\times C_1^1=1&2^{2-1}\\times C_2^1=4&\\cdots&2^{k-1}\\times C_k^1\\\\\nF_{i-1}\\times(i-1)^2&0&0&0&0&0&\\cdots&0&0&2^{2-2}\\times C_2^2=1&\\cdots&2^{k-2}\\times C_k^2\\\\\n\\cdots&\\vdots&\\vdots&\\vdots&\\vdots&\\vdots&\\cdots&\\vdots&\\vdots&\\vdots&\\cdots&\\vdots\\\\\nF_{i-1}\\times(i-1)^k&0&0&0&0&0&\\cdots&0&0&0&\\cdots&2^{k-k}\\times C_k^k\\\\\nF_i\\times i^1&0&0&0&1&0&\\cdots&0&C_1^1=1&C_2^1=2&\\cdots&C_k^1\\\\\nF_i \\times i^2&0&0&0&0&1&\\cdots&0&0&C_2^2=1&\\cdots&C_k^2\\\\\n\\vdots&\\vdots&\\vdots&\\vdots&\\vdots&\\vdots&\\cdots&\\vdots&\\vdots&\\vdots&\\cdots&\\vdots\\\\\nF_i\\times i^k&0&0&1&0&0&\\cdots&0&0&0&\\cdots&C_k^k\n\\end{bmatrix}\n$$\n\n\n\uff08\u8fd9\u4e2a$\\LaTeX$ \u662f\u7ed9\u4eba\u6253\u7684\u5417\u3002\u3002\u3002\uff09\n\n\u597d\u4e86\uff0c\u9664\u4e86\u521d\u59cb\u5316\u9ebb\u70e6\u70b9\uff0c\u4ee3\u7801\u8fd8\u662f\u6bd4\u8f83\u7b80\u5355\u7684\u3002\n\n### Code\n\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal O($\u80fd\u8fc7$)$\n\n\u611f\u8c22@w23c3c3 \u5927\u5de8\u4f6c\u8ba9\u6211\u9003\u79bb\u4e86\u624b\u63a8 $k=40$ \u5927\u6570\u636e\u7136\u540e\u771f\u00b7\u6e05\u660e\u8282\u5feb\u4e50\u7684\u5384\u8fd0\u3002\n\n```cpp\n#include<cstdio>\n#include<cstring>\n#define int long long\nconst int mod=1e9+7;\nconst int maxn=105;\nstruct Matrix{\n\tint n,m;\n\tint c[maxn][maxn]; \n\tMatrix(int N=0,int M=0){\n\t\tn=N,m=M;\n\t\tmemset(c,0,sizeof(c));\n\t}\n\tMatrix operator*(const Matrix a)const{\n\t\tint l=n,r=a.m;\n\t\tMatrix x=Matrix(l,r);\n\t\tfor(int i=1;i<=l;++i){\n\t\t\tfor(int j=1;j<=r;++j){\n\t\t\t\tfor(int k=1;k<=m;++k){\n\t\t\t\t\tx.c[i][j]+=c[i][k]*a.c[k][j];\n\t\t\t\t\tx.c[i][j]%=mod;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn x;\n\t}\n}A,B;\nint n,k,x=4;\nint f[45][45]; \nMatrix pow(Matrix&x,int b){\n\tMatrix ans=Matrix(x.n,x.m);\n\tfor(int i=1;i<=x.m;++i)\n        ans.c[i][i]=1;\n\twhile(b){\n\t\tif(b&1)\n\t\t\tans=x*ans;\n\t\tx=x*x;\n\t\tb>>=1;\n\t}\n\treturn ans;\n}\ninline void init(void){\n\tf[0][0]=1;\n\tfor(int i=1;i<=k;++i){\n        f[i][0]=1;\n\t\tfor(int j=1;j<=i;++j)\n\t\t\tf[i][j]=(f[i-1][j-1]+f[i-1][j])%mod;\n\t}\n    return;\n}\nsigned main(){\n    scanf(\"%lld%lld\",&n,&k);\n    init();\n    A=Matrix(1,3+(k<<1));\n    A.c[1][1]=1;A.c[1][2]=2;A.c[1][3]=1;\n    for(int i=1;i<=k;++i){\n        A.c[1][3+i]=1;\n        A.c[1][k+3+i]=x%mod;\n        x<<=1;\n    }\n    B=Matrix(3+(k<<1),3+(k<<1));\n    B.c[2][1]=1;\n    B.c[1][2]=B.c[2][2]=1;\n    B.c[3][3]=B.c[3+(k<<1)][3]=1;\n    for(int i=1;i<=k;++i){\n        B.c[1][i+k+3]=(1ll<<i)%mod;\n        B.c[3+k+i][3+i]=1;\n        B.c[2][3+i+k]=1;\n    }\n    for(int i=1;i<=k;++i){\n        for(int j=i;j<=k;++j){\n            B.c[3+i][3+k+j]=(((1ll<<j-i)%mod)*f[j][i])%mod;\n            B.c[3+k+i][3+k+j]=f[j][i];\n        }\n    }\n    A=A*pow(B,n-1);\n    printf(\"%lld\",A.c[1][3]);\n    return 0;\n}\n```",
        "postTime": 1617435504,
        "uid": 245052,
        "name": "ollll62",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 CF392C \u3010Yet Another Number Sequence\u3011"
    },
    {
        "content": "\u4e0d\u59a8\u4ee4 $F_0=1$\uff0c\u90a3\u4e48 $F_i = F_{i-1}+F_{i-2}$ \u5c31\u5bf9\u6240\u6709 $i\\ge 1$ \u6ee1\u8db3\u3002  \n\u7136\u540e\u6211\u4eec\u8003\u8651\u6c42\u51fa\n$$\nF(z) = \\frac1{1-z-z^2} \\bmod z^{n+1} = \\sum\\limits_{i=0}^n F_i z^i\n$$\n\n\u90a3\u4e48\u5176\u663e\u7136\u8981\u5728 $n+1,n+2$ \u5904\u53bb\u9664\u8d21\u732e\u3002\u5373\n$$\n\\begin{aligned}\nF(z) &= zF(z) + z^2F(z) + 1 - (F_{n-1}+F_n)z^{n+1} - F_nz^{n+2} \\\\\nF(z) &= \\frac{1 - (F_{n-1}+F_n)z^{n+1} - F_nz^{n+2}}{1-z-z^2}\n\\end{aligned}\n$$\n\n\u5219\u7b54\u6848\u5c31\u662f\n$$\n\\begin{aligned}\n\\sum\\limits_{i=0}^n F_i i^k\n&= \\left[\\frac{z^k}{k!}\\right] \\sum\\limits_{i=0}^n F_i \\mathrm e^{iz} \\\\\n&= \\left[\\frac{z^k}{k!}\\right] F(\\mathrm e^z)\n\\end{aligned}\n$$\n\n\u8bbe $\\mathscr F(z + 1) = F(z+1) \\bmod z^{k+1}$\u3002  \n\u4ee4 $P(z) = 1 - (F_{n-1}+F_n)z^{n+1} - F_nz^{n+2}$\uff0c\u5219\n$$\n\\begin{aligned}\nF(z+1) &= -\\frac{P(z+1)}{1+3z+z^2} \\\\\n\\left([z^i] F(z+1)\\right) &= -\\left([z^i] P(z+1)\\right) - 3\\left([z^{i-1}] F(z+1)\\right) - \\left([z^{i-2}] F(z+1)\\right)\n\\end{aligned}\n$$\n\n\u5219\u4ee4 $\\mathscr P(z+1) = P(z+1) \\bmod z^{k+1}$\uff0c\u5148\u6c42 $\\mathscr P(z)$\uff0c\u4e3b\u8981\u662f\u8981\u8003\u8651\n$$\n\\mathscr G_m(z+1) = (1+z)^m \\bmod z^{k+1}\n$$\n\n\u8003\u8651\n$$\n\\begin{aligned}\n(1+z)[(1+z)^m]' &= m(1+z)^m \\\\\n(1+z)[\\mathscr G_m(z+1)]' &= m\\mathscr G_m(z+1) - (m-k) \\binom mk z^k \\\\\nz\\mathscr G_m'(z) &= m\\mathscr G_m(z) - (m-k) \\binom mk (z-1)^k\n\\end{aligned}\n$$\n\n\u4ece\u800c\u53ef\u4ee5\u6c42\u51fa $\\mathscr P(z)$\u3002\n\n\u800c\n$$\n\\begin{aligned}\n&\\quad\\;\\left([z^i] \\mathscr F(z+1)\\right) \\\\\n&= -\\left([z^i] \\mathscr P(z+1)\\right) - 3\\left([z^{i-1}] \\mathscr F(z+1)\\right) - \\left([z^{i-2}] \\mathscr F(z+1)\\right) \\\\\n&+ [i=k+1]\\left[3\\left([z^k] \\mathscr F(z+1)\\right) + \\left([z^{k-1}] \\mathscr F(z+1)\\right)\\right] \\\\\n&+ [i=k+2]\\left([z^k] \\mathscr F(z+1)\\right)\n\\end{aligned}\n$$\n\n\u4e0d\u59a8\u4ee4 $C_1 = \\left[3\\left([z^k] \\mathscr F(z+1)\\right) + \\left([z^{k-1}] \\mathscr F(z+1)\\right)\\right]$\uff0c$C_2 = \\left([z^k] \\mathscr F(z+1)\\right)$\uff0c\u5219\n$$\n\\mathscr F(z+1) = \\frac{-\\mathscr P(z+1)+C_1 z^{k+1}+C_2 z^{k+2}}{1+3z+z^2}\n$$\n\n\u5373\n$$\n\\mathscr F(z) = \\frac{\\mathscr P(z) - C_1(z-1)^{k+1} - C_2(z-1)^{k+2}}{1-z-z^2}\n$$\n\n\u6839\u636e EI \u7684\u7ed3\u679c\uff0c$[z^k] F(\\mathrm e^z) = [z^k] \\mathscr F(\\mathrm e^z)$\u3002\u7ebf\u6027\u6c42\u51fa $\\mathscr F(z)$ \u5373\u53ef\u3002  \n\u65f6\u95f4\u590d\u6742\u5ea6 $\\Theta(k + \\log n)$\u3002\n\n\u4ee3\u7801\uff1a\n```cpp\n#include <cstdio>\n#include <algorithm>\nusing namespace std;\nconst int K = 42;\nconst int mod = 1e9 + 7;\ninline int norm(int x)\n{\n    return x >= mod ? x - mod : x;\n}\ninline int reduce(int x)\n{\n    return x < 0 ? x + mod : x;\n}\ninline int neg(int x)\n{\n    return x ? mod - x : 0;\n}\ninline void add(int &x,int y)\n{\n    if((x += y - mod) < 0)\n        x += mod;\n}\ninline void sub(int &x,int y)\n{\n    if((x -= y) < 0)\n        x += mod;\n}\ninline void fam(int &x,int y,int z)\n{\n    x = (x + (long long)y * z) % mod;\n}\ninline int fpow(int a,int b)\n{\n    int ret = 1;\n    for(;b;b >>= 1)\n        (b & 1) && (ret = (long long)ret * a % mod),a = (long long)a * a % mod;\n    return ret;\n}\nlong long n;\nint k;\nint F_n_1,F_n;\ninline int bostanMori(long long n,int p0,int p1,int q0,int q1,int q2)\n{\n    for(;n;n >>= 1)\n    {\n        if(n & 1)\n            p0 = ((long long)q0 * p1 + (long long)(mod - q1) * p0) % mod,\n            p1 = (long long)q2 * p1 % mod;\n        else\n            p0 = (long long)q0 * p0 % mod,\n            p1 = ((long long)q2 * p0 + (long long)(mod - q1) * p1) % mod;\n        q1 = (2LL * q0 * q2 + (long long)(mod - q1) * q1) % mod,\n        q0 = (long long)q0 * q0 % mod,\n        q2 = (long long)q2 * q2 % mod;\n    }\n    return q0 == 1 ? p0 : (long long)p0 * fpow(q0,mod - 2) % mod;\n}\nint vis[K + 5],cnt,prime[K + 5],pw[K + 5];\nint fac[K + 5],ifac[K + 5],inv[K + 5];\nint prod[K + 5],iprod[K + 5],inv_n_2[K + 5];\nint C_n_1_k,C_n_2_k;\nint C_1,C_2;\nint G_n_1[K + 5],G_n_2[K + 5];\nint P[K + 5],F[K + 5];\nint ans;\ninline int C(int n,int m)\n{\n    return n < m || m < 0 ? 0 : (long long)fac[n] * ifac[m] % mod * ifac[n - m] % mod;\n}\nint main()\n{\n    scanf(\"%lld%d\",&n,&k);\n    pw[1] = 1;\n    for(int i = 2;i <= k;++i)\n    {\n        if(!vis[i])\n            pw[prime[++cnt] = i] = fpow(i,k);\n        for(int j = 1;j <= cnt && i * prime[j] <= k;++j)\n        {\n            vis[i * prime[j]] = 1,pw[i * prime[j]] = (long long)pw[i] * pw[prime[j]] % mod;\n            if(!(i % prime[j]))\n                break;\n        }\n    }\n    if(n <= k)\n    {\n        F[0] = 1;\n        for(int i = 0;i <= n;++i)\n            i && (add(F[i],F[i - 1]),1),\n            i > 1 && (add(F[i],F[i - 2]),1),\n            fam(ans,F[i],pw[i]);\n        printf(\"%d\\n\",ans);\n        return 0;\n    }\n    F_n_1 = bostanMori(n - 1,1,0,1,mod - 1,mod - 1),\n    F_n = bostanMori(n,1,0,1,mod - 1,mod - 1),\n    add(F_n_1,F_n);\n    n %= mod;\n    prod[0] = norm(n + 2);\n    for(int i = 1;i <= k + 1;++i)\n        prod[i] = prod[i - 1] * (n + 2 - i + mod) % mod;\n    iprod[k + 1] = fpow(prod[k + 1],mod - 2);\n    for(int i = k + 1;i;--i)\n        iprod[i - 1] = iprod[i] * (n + 2 - i + mod) % mod;\n    for(int i = 1;i <= k + 1;++i)\n        inv_n_2[i] = (long long)iprod[i] * prod[i - 1] % mod;\n    inv_n_2[0] = iprod[0];\n    fac[0] = 1;\n    for(int i = 1;i <= k + 2;++i)\n        fac[i] = (long long)fac[i - 1] * i % mod;\n    ifac[k + 2] = fpow(fac[k + 2],mod - 2);\n    for(int i = k + 2;i;--i)\n        ifac[i - 1] = (long long)ifac[i] * i % mod;\n    for(int i = 1;i <= k + 1;++i)\n        inv[i] = (long long)ifac[i] * fac[i - 1] % mod;\n    C_n_1_k = C_n_2_k = 1;\n    C_2 = norm(F_n_1 + F_n),sub(C_2,1);\n    for(int i = 1,C_t;i <= k;++i)\n        C_n_1_k = C_n_1_k * (n - i + 2 + mod) % mod * inv[i] % mod,\n        C_n_2_k = C_n_2_k * (n - i + 3 + mod) % mod * inv[i] % mod,\n        C_t = ((long long)F_n_1 * C_n_1_k + (long long)F_n * C_n_2_k - 3LL * C_2 - C_1 + 4LL * mod) % mod,\n        C_1 = C_2,C_2 = C_t;\n    fam(C_1,3,C_2);\n    C_n_1_k = C_n_1_k * (n - k + 1 + mod) % mod,\n    C_n_2_k = C_n_2_k * (n - k + 2 + mod) % mod;\n    for(int i = 0;i <= k;++i)\n        G_n_1[i] = (long long)(k - i & 1 ? mod - C_n_1_k : C_n_1_k) * C(k,i) % mod * inv_n_2[i + 1] % mod,\n        G_n_2[i] = (long long)(k - i & 1 ? mod - C_n_2_k : C_n_2_k) * C(k,i) % mod * inv_n_2[i] % mod,\n        P[i] = ((long long)F_n_1 * G_n_1[i] + (long long)F_n * G_n_2[i]) % mod,\n        P[i] = neg(P[i]);\n    add(P[0],1);\n    for(int i = 0;i <= k;++i)\n        F[i] = ((long long)(k - i & 1 ? mod - C_1 : C_1) * C(k + 1,i) + (long long)(k - i & 1 ? C_2 : mod - C_2) * C(k + 2,i)) % mod,\n        add(F[i],P[i]),\n        i && (add(F[i],F[i - 1]),1),\n        i > 1 && (add(F[i],F[i - 2]),1),\n        fam(ans,F[i],pw[i]);\n    printf(\"%d\\n\",ans);\n}\n```",
        "postTime": 1629441097,
        "uid": 75840,
        "name": "deserter",
        "ccfLevel": 0,
        "title": "\u8f7d\u8c2d Binomial Sum \u5c0f\u7ec3\u4e60"
    },
    {
        "content": "\u53d1\u4e00\u4e2a\u590d\u6742\u5ea6\u4f18\u79c0\u7684\u505a\u6cd5\n\n\u8bbe$F(n,m)$\u8868\u793a$\\sum_{i=1}^n G^i*i^m$\n\n\u5176\u4e2d$G[2][2]$\u662f\u6590\u6ce2\u90a3\u5951\u7684\u8f6c\u79fb\u77e9\u9635\n\n\u663e\u7136\u7b54\u6848\u4e3a$F(N,K)$\n\n\u76f4\u63a5\u9012\u63a8\u6c42$F(N,K)$\u590d\u6742\u5ea6\u663e\u7136\u4e0d\u53ef\u63a5\u53d7\u3002\n\n\u8003\u8651\u5feb\u901f\u5e42\u5f62\u5f0f\u7684\u500d\u589e\uff1a\n\n$$F(2n,m)$$\n$$=\\sum_{i=1}^{2n} G^i*i^m$$\n$$=\\sum_{i=1}^n G^i*i^m + G^n\\sum_{i=1}^n G^i*(i+n)^m$$\n$$=F(n,m)+G^n\\sum_{i=1}^n G^i\\sum_{j=0}^m \\dbinom{m}{j} i^j n^{m-j}$$\n$$=F(n,m)+G^n\\sum_{j=0}^m \\dbinom{m}{j} n^{m-j}\\sum_{i=1}^n G^ii^j$$\n$$=F(n,m)+G^n\\sum_{j=0}^m \\dbinom{m}{j} n^{m-j} F(n,j)$$\n\n\u5bf9$i$\u7ef4\u62a4$F(i,0...m)$\n\u7136\u540e\u505a\u5feb\u901f\u5e42\n\u590d\u6742\u5ea6$O(8KlogN)$\n\n```cpp\n#include<cmath>\n#include<cstdio>\n#include<cstring>\n#include<algorithm>\nusing namespace std;\ntypedef long long ll;\n\nconst int N=45;\nconst int mod=1000000007;\n\nll n;\nint k;\nint w[N],C[N][N];\n\nint fpow(int a,int b)\n{\n\tint r(1);\n\twhile(b) {\n\t\tif(b&1) r=(ll)r*a%mod;\n\t\ta=(ll)a*a%mod;\n\t\tb>>=1;\n\t}\n\treturn r;\n}\n\nstruct mat {\n\tint a[2][2];\n\tmat(int o=0) {\n\t\ta[0][0]=a[1][1]=o;\n\t\ta[0][1]=a[1][0]=0;\n\t}\n\tvoid operator*=(const mat&y)\n\t{\n\t    static ll Tmp[N][N];\n\t\tint i,j,k;\n\t\tfor(i=0; i<2; i++)\n\t\t\tfor(j=0; j<2; j++)\n\t\t\t\tfor(Tmp[i][j]=k=0; k<2; k++)\n\t\t\t\t\tTmp[i][j] += (ll)a[i][k]*y.a[k][j];\n\t\tfor(i=0; i<2; i++)\n\t\t\tfor(j=0; j<2; j++)\n\t\t\t\ta[i][j]=Tmp[i][j] % mod;\n\t}\n\tvoid operator+=(const mat&y)\n\t{\n\t\tint i,j;\n\t\tfor(i=0; i<2; i++)\n\t\t\tfor(j=0; j<2; j++)\n\t\t\t\ta[i][j]=(a[i][j]+y.a[i][j])%mod;\n\t}\n\tvoid operator*=(const int y)\n\t{\n\t\tint i,j;\n\t\tfor(i=0; i<2; i++)\n\t\t\tfor(j=0; j<2; j++)\n\t\t\t\ta[i][j]=(ll)a[i][j]*y%mod;\n\t}\n}a,b[N],t[N],tmp;\n\nmat fpow(const mat &a,ll n)\n{\n\tmat x=mat(1);\n\tmat y=a;\n\twhile(n)\n\t{\n\t\tif(n&1)x*=y;\n\t\ty*=y;\n\t\tn>>=1;\n\t}\n\treturn x;\n}\n\nvoid init()\n{\n\tC[0][0]=1;\n\tfor(int i=1; i<=k; i++)\n\t{\n\t\tC[i][0]=1;\n\t\tfor(int j=1; j<=i; j++)\n\t\t\tC[i][j]=(C[i-1][j-1]+C[i-1][j])%mod;\n\t}\n}\n\nvoid solve(ll n)\n{\n\tif(n==1)\n\t{\n\t\tfor(int i=0; i<=k; i++)\n\t\t\tb[i]=a;\n\t\ttmp=a;\n\t\treturn;\n\t}\n\tll mid=n>>1;\n\tsolve(mid);\n\tfor(int i=0; i<=k; i++)\n\t{\n\t\tt[i]=b[i];\n\t\tb[i]=mat();\n\t}\n\tw[0]=1;\n\tfor(int i=1,o=mid%mod; i<=k; i++)\n\t\tw[i]=(ll)w[i-1]*o%mod;\n\tfor(int i=0; i<=k; i++)\n\t{\n\t\tfor(int j=0; j<=i; j++)\n\t\t{\n\t\t\tmat now=t[j];\n\t\t\tnow*=((ll)C[i][j]*w[i-j]%mod);\n\t\t\tb[i]+=now;\n\t\t}\n\t\tb[i]*=tmp;\n\t}\n\tfor(int i=0; i<=k; i++)\n\t\tb[i]+=t[i];\n\ttmp*=tmp;\n\tif(n&1)\n\t{\n\t\ttmp*=a;\n\t\tw[0]=1;\n\t\tfor(int i=0,o=n%mod; i<=k; i++)\n\t\t{\n\t\t\tt[i]=tmp;\n\t\t\tt[i]*=w[0];\n\t\t\tb[i]+=t[i];\n\t\t\tw[0]=(ll)w[0]*o%mod;\n\t\t}\n\t}\n}\n\nint main()\n{\n\tscanf(\"%lld %d\",&n,&k);\n\t\n\ta.a[0][0] = a.a[0][1] = a.a[1][0] = 1;\n\ta.a[1][1] = 0;\n\t\n//\tfprintf(stderr, \"%d\\n\", fpow(a, 4).a[0][0]);\n\t\n\tinit();\n\t\n\tsolve(n);\n\t\n\tprintf(\"%d\", b[k].a[0][0]); \n\treturn 0;\n}",
        "postTime": 1555848808,
        "uid": 13052,
        "name": "iostream",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 CF392C \u3010Yet Another Number Sequence\u3011"
    },
    {
        "content": "\u9898\u89e3\uff1a\n\n\u8bbe$ f(n,k)=\\displaystyle\\sum_{i=1}^nF_ii^k$\n\n\u4e3a\u4e86\u65b9\u4fbf\uff0c\u4ee4$ F_0=1,F_{-1}=0 $\n\n$$f(n,k)=\\sum_{i=1}^nF_ii^k$$\n\n$$=\\sum_{i=1}^n(F_{i-1}+F_{i-2})i^k$$\n\n\u4e8c\u9879\u5f0f\u5b9a\u7406\u5c55\u5f00\n\n$$=\\sum_{i=1}^nF_{i-1}\\sum_{j=0}^k(i-1)^j\\binom kj+\\sum_{i=1}^nF_{i-2}\\sum_{j=0}^k\\binom kj(i-2)^j2^{k-j}$$\n\n\u4ea4\u6362\u6c42\u548c\u987a\u5e8f\n\n$$=\\sum_{j=0}^k\\binom kj\\sum_{i=1}^nF_{i-1}(i-1)^j+\\sum_{j=0}^k\\binom kj2^{k-j}\\sum_{i=1}^nF_{i-2}(i-2)^j$$\n\n\u8fd9\u4e00\u6b65\u9700\u8981\u6ce8\u610f\u4e00\u4e0b\u8fb9\u754c\u60c5\u51b5\uff0c$F_0=1,0^0=1$\n\n$$=\\sum_{j=0}^k\\binom kj\\sum_{i=1}^{n-1}F_ii^j+1+\\sum_{j=0}^k\\binom kj2^{k-j}\\sum_{i=1}^{n-2}F_ii^j+2^k$$\n\n$$=\\sum_{j=0}^k\\binom kjf(n-1,j)+\\sum_{j=0}^k\\binom kj2^{k-j}f(n-2,j)+2^k+1$$\n\n\u77e9\u9635\u5feb\u901f\u5e42\u4f18\u5316\u5373\u53ef\uff0c\u6ce8\u610f\u4e00\u4e0b\u521d\u59cb\u72b6\u6001\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(k^3\\log n)$\n\n```cpp\n#include <iostream>\nconst int mod = 1000000007;\nusing LL = long long;\nint k, C[50][50], pow[50], num[2][50], K, tot;\nvoid up(int &x, int y) { if ((x += y) >= mod) x -= mod; }\nstruct matrix {\n\tint num[83][83];\n\tmatrix operator * (matrix rhs) const {\n\t\tmatrix res;\n\t\tfor (int i = 0; i <= K; i++)\n\t\t\tfor (int j = 0; j <= K; j++) {\n\t\t\t\tint ans = 0;\n\t\t\t\tfor (int k = 0; k <= K; k++) up(ans, static_cast<LL> (num[i][k]) * rhs.num[k][j] % mod);\n\t\t\t\tres.num[i][j] = ans;\n\t\t\t}\n\t\treturn res;\n\t}\n} base, init;\nLL n;\nint main() {\n\tstd::cin >> n >> k; K = 2 * k + 2;\n\tfor (int i = 0; i <= k + 1; i++) pow[i] = (1LL << i) % mod;\n\tfor (int i = 0; i <= k; i++) {\n\t\tC[i][0] = 1;\n\t\tfor (int j = 1; j <= i; j++) {\n\t\t\tup(C[i][j] = C[i - 1][j - 1], C[i - 1][j]);\n\t\t}\n\t}\n\tfor (int i = 0; i < 2; i++) for (int j = 0; j <= k; j++) num[i][j] = tot++;\n\tfor (int j = 0; j <= k; j++) {\n\t\tfor (int p = 0; p <= j; p++)\n\t\t\tbase.num[num[0][p]][num[0][j]] = C[j][p];\n\t\tfor (int p = 0; p <= j; p++)\n\t\t\tbase.num[num[1][p]][num[0][j]] = static_cast<LL> (C[j][p]) * pow[j - p] % mod;\n\t\tbase.num[K][num[0][j]] = pow[j] + 1;\n\t\tbase.num[num[0][j]][num[1][j]] = 1;\n\t}\n\tbase.num[K][K] = 1;\n\tfor (int j = 0; j <= k; j++) {\n\t\tinit.num[0][num[0][j]] = (1 + pow[j + 1]) % mod;\n\t\tinit.num[0][num[1][j]] = 1;\n\t}\n\tinit.num[0][K] = 1;\n\tif (n == 1) std::printf(\"%d\\n\", init.num[0][num[1][k]]);\n\telse {\n\t\tfor (----n; n; n >>= 1, base = base * base) if (n & 1) init = init * base;\n\t\tstd::printf(\"%d\\n\", init.num[0][num[0][k]]);\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1540887895,
        "uid": 26127,
        "name": "Weng_Weijie",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 CF392C \u3010Yet Another Number Sequence\u3011"
    },
    {
        "content": "### \u9898\u610f\n\n$F_1=1,F_2=2,F_n=F_{n-1}+F_{n-2}$\uff0c\u6c42 $\\sum_{i=1}^ni^kF_i$\u3002\n\n### \u5206\u6790\n\n\u66b4\u63a8\u5f0f\u5b50\u3002\n\n\u6211\u4eec\u8bb0 $\\alpha=\\dfrac{1+\\sqrt5}2,\\beta=\\dfrac{1-\\sqrt5}2$\u3002\n\n\u7531\u4e8e $F_n=\\dfrac 1{\\sqrt{5}}(\\alpha^{n+1}-\\beta^{n+1})$\uff0c\n\n\u8bb0 $S_{k,d}=\\sum_{i=1}^ni^kd^i$\uff0c\u5219\u6211\u4eec\u8981\u6c42\u7684\u7b54\u6848\u5373\u4e3a $\\dfrac1{\\sqrt5}(\\alpha S_{k,\\alpha}-\\beta S_{k,\\beta})$\u3002\n\n\u4e0b\u9762\u8ba1\u7b97 $S_{k,\\alpha}$\uff0c$\\beta$ \u540c\u7406\uff0c\u601d\u8def\u662f**\u5dee\u5206**\u3002\n\n\u9996\u5148\uff0c\u5f53 $k=0$ \u65f6\uff0c\u539f\u5f0f\u5373\u4e3a $\\sum_{i=1}^nd^i=d\\cdot\\dfrac{d^n-1}{d-1}$\uff0c\u53ef\u4ee5\u76f4\u63a5\u6c42\u51fa\u3002\n\n\u7136\u540e\uff0c\u5f53 $k\\neq0$ \u65f6\uff0c\u8fdb\u884c\u4ee5\u4e0b\u8f6c\u5316\uff1a\n$$\n\\begin{aligned}\nS_{k,d}&=\\sum_{i=1}^ni^kd^i\\\\\nd\\cdot S_{k,d}&=\\sum_{i=1}^ni^kd^{i+1}\\\\\n(d-1)S_{k,d}&=\\sum_{i=2}^{n}((i-1)^kd^i-i^kd^i)-d+n^kd^{n+1}\\\\\nS_{k,d}&=\\dfrac{\\sum_{i=2}^{n}(((i-1)^k-i^k)d^i)-d+n^kd^{n+1}}{d-1}\n\\end{aligned}\n$$\n\u6211\u4eec\u6ce8\u610f\u5230\uff0c\u6c42\u548c\u5f0f\u4e2d\u7684 $(i-1)^k-i^k=\\sum_{j=1}^k\\binom kj(-1)^{j}\\cdot i^{k-j}$\uff0c\u5219\u539f\u6c42\u548c\u5f0f\u53ef\u8f6c\u5316\u4e3a\n$$\n\\begin{aligned}\n&\\;\\;\\;\\;\\; \\sum_{i=2}^n(((i-1)^k-i^k)d^i)\\\\\n&=\\sum_{i=2}^n(\\sum_{j=1}^k(-1)^j\\binom kji^{k-j}d^i)\\\\\n&=\\sum_{j=1}^k(-1)^j\\binom kj\\sum_{i=2}^ni^{k-j}d^i\\\\\n&=\\sum_{j=1}^k(-1)^j\\binom kj S_{k-j,d}\n\\end{aligned}\n$$\n\u800c\u5176\u4e2d\u7684 $k-j<k$\uff0c $S_{k-j,d}$ \u5747\u662f\u6211\u4eec\u5df2\u7ecf\u6c42\u51fa\u7684\u7b54\u6848\u3002\u56e0\u800c\uff0c\u6211\u4eec\u6700\u7ec8\u7684\u5f0f\u5b50\u5c31\u5316\u4e3a\n$$S_{k,d}=\\dfrac{\\sum_{j=1}^k(-1)^j\\binom kj S_{k-j,d}-d+n^kd^{n+1}}{d-1}$$\n\n\u90a3\u4e48\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 $O(k^2)$ \u7684\u590d\u6742\u5ea6\u5185\u9012\u63a8\u51fa\u6240\u6709\u7684 $S_{k,d}$\uff0c\u5c31\u53ef\u4ee5\u6c42\u5f97\u6211\u4eec\u6700\u540e\u7684\u7b54\u6848\u4e86\u3002\n\n\u5f53\u7136\uff0c\u8fd9\u91cc\u8fd8\u6709\u4e00\u4e2a\u91cd\u8981\u7684\u7ec6\u8282\uff1a\u7531\u4e8e\u9898\u76ee\u8981\u6c42\u5bf9 $1e9+7$ \u53d6\u6a21\uff0c\u800c $\\sqrt5$ \u5728\u6a21 $1e9+7$ \u4e0b\u6ca1\u6709\u4e8c\u6b21\u5269\u4f59\u7684\u6837\u5b50\uff0c\u56e0\u800c\u6211\u4eec\u8fd8\u9700\u8981\u5b9a\u4e49\u4e00\u4e2a\u201c\u590d\u201d\u6570 $a+b\\sqrt5$\u3002\n\n\u6ce8\u610f\u5230\u6709\u4e00\u4e2a\u5947\u5999\u7684\u6027\u8d28\uff1a\u8fd9\u4e2a\u201c\u590d\u201d\u6570\u7684 \u201c$1$ \u90e8\u201d\u548c\u201c$\\sqrt5$ \u90e8\u201d\u53ef\u4ee5\u5bf9 $1e9+7$ \u53d6\u6a21\uff0c\u6700\u7ec8\u8ba1\u7b97\u5f97\u7684\u7b54\u6848\u7531\u4e8e\u539f\u672c\u5c31\u5fc5\u7136\u662f\u6574\u6570\uff0c\u56e0\u800c\u4e0d\u4f1a\u6539\u53d8\u3002\u6240\u4ee5\u6211\u4eec\u53ea\u8981\u5b9a\u4e49\u8fd9\u4e2a\u201c\u590d\u201d\u6570\u7684\u56db\u5219\u8fd0\u7b97\u5373\u53ef\u3002\u6ce8\u610f\u5230\u9664\u6cd5\u65f6\u7531\u4e8e\u8981\u628a\u5206\u6bcd\u6709\u7406\u5316\uff0c\u8fd8\u8981 $\\log p$ \u7684\u65f6\u95f4\u6c42\u9006\u5143\uff1b\u6211\u4eec\u7684 $n^kd^{n+1}$ \u53ef\u4ee5\u63d0\u524d\u5904\u7406\uff0c\u56e0\u800c\u603b\u7684\u590d\u6742\u5ea6\u662f $O(k^2\\log p)$\uff0c\u975e\u5e38\u7684\u4f18\u79c0\u3002\n\n### \u4ee3\u7801\n\n```cpp\n//sigma(i^k*Fib(i))\n#include<bits/stdc++.h>\n#define int long long\n#define rint register int\n#define fu(i,a,b,d,c) for(rint i=a;i<=b&&c;i+=d)\n#define fd(i,a,b,d,c) for(rint i=a;i>=b&&c;i-=d)\nusing namespace std;\ninline int read(){\n    char c=0,f=1;int num=0;\n    while(c<'0'||c>'9'&&c!='-')((c=getchar())=='-')&&(f=-f);\n    while(c>='0'&&c<='9')num=(num<<1)+(num<<3)+(c^48),c=getchar();\n    return num*f;\n}\n\nconst int LJC = 1e9+7, MAXK = 50;\nint qp(int x,int p){\n    int res=1;\n    for(x%=LJC;p;x=1ll*x*x%LJC,p>>=1)(p&1)&&(res=1ll*res*x%LJC);\n    return res;\n}\nint inv(int x){return qp(x,LJC-2);}\nstruct S{\n    int a,b;\n    S():a(0),b(0){}\n    S(int a_,int b_):a((a_%LJC+LJC)%LJC),b((b_%LJC+LJC)%LJC){}\n    S operator+(const S y){return S(a+y.a,b+y.b);}\n    S operator-(const S y){return S(a-y.a,b-y.b);}\n    S operator*(const S y){return S(1ll*a*y.a+5ll*b*y.b,1ll*a*y.b+1ll*b*y.a);}\n    S operator/(const S y){\n        int fm=inv(((1ll*y.a*y.a-5ll*y.b*y.b)%LJC+LJC)%LJC);\n        return S(1ll*(1ll*a*y.a-5ll*b*y.b)%LJC*fm,1ll*(1ll*b*y.a-1ll*a*y.b)%LJC*fm);\n    }\n};\nS qp(S x,int p){\n    S res(1,0);\n    for(;p;x=x*x,p>>=1)(p&1)&&(res=res*x,0);\n    return res;\n}\nvoid write(int n){\n    if(n==0)putchar('0');\n    char c[30]={0};int len=0;\n    while(n)c[++len]=n%10+'0',n/=10;\n    while(len)putchar(c[len--]);\n}\nint n,nk[MAXK];\nint k;\nS ansA[MAXK],ansB[MAXK],an,bn;\nint C[MAXK][MAXK];\nsigned main(){\n    n=read(),k=read();\n    S A(inv(2),inv(2)),B(inv(2),LJC-inv(2));\n    nk[0]=1;an=qp(A,n+1),bn=qp(B,n+1);\n    fu(i,1,k,1,1)nk[i]=1ll*nk[i-1]*(n%LJC)%LJC;\n    C[0][0]=1;\n    fu(i,1,k,1,1){\n        C[i][0]=1;\n        fu(j,1,i,1,1)C[i][j]=(1ll*C[i-1][j-1]+C[i-1][j])%LJC;\n    }\n    ansA[0]=A*((qp(A,n)-S(1,0))/(A-S(1,0)));\n    ansB[0]=B*((qp(B,n)-S(1,0))/(B-S(1,0)));\n    fu(i,1,k,1,1){\n        S tmpA(0,0),tmpB(0,0);\n        fu(j,0,i-1,1,1){\n            tmpA=tmpA+S(((i-j&1)?LJC-1:1),0)*S(C[i][j],0)*(ansA[j]-A);\n            tmpB=tmpB+S(((i-j&1)?LJC-1:1),0)*S(C[i][j],0)*(ansB[j]-B);\n        }\n        tmpA=tmpA-A+S(nk[i],0)*an;\n        tmpB=tmpB-B+S(nk[i],0)*bn;\n        ansA[i]=tmpA/(A-S(1,0));\n        ansB[i]=tmpB/(B-S(1,0));\n    }\n    S res=((A*ansA[k]-B*ansB[k])/S(0,1));\n    // printf(\"%lld\",res.a);\n    write(res.a);\n}\n```",
        "postTime": 1647047146,
        "uid": 218517,
        "name": "Mr_H2T",
        "ccfLevel": 0,
        "title": "CF392C Yet Another Number Sequence"
    },
    {
        "content": "[\u9898\u4f20](https://www.luogu.com.cn/problem/CF392C)\n\n\n\u7ed9\u5b9a $n \\leq 10^{17}, K \\leq 40, F$ \u4e3a fibonacci \u6570\u5217\uff0c\u6c42:\n\n$$\n\n\\sum_{i=1}^{n} F_{n} \\times i^{K}\n\n$$\n\n\u5148\u66b4\u529b\u63a8\u63a8\u67ff\u5b50\uff0c\u8bb0 $S_{i}(K)=F_{i} \\times i^{K}$, sum $_{i}=\\sum S_{i}(K)$\n\n$$\n\n\\begin{gathered}\n\nS_{i}(K)=\\left(F_{i-1}+F_{i-2}\\right) i^{K} \\\\\n\n=F_{i-1} i^{K}+F_{i-2} i^{K}\n\n\\end{gathered}\n\n$$\n\n\u4e00\u822c\u5730\uff0c\u6211\u4eec\u5e0c\u671b\u62c6\u5f00\u540e\u4e0b\u6807\u5bf9\u5e94\uff0c\u6240\u4ee5\u91cd\u5199\u6210 :\n\n$$\n\n=F_{i-1}(i-1+1)^{K}+F_{i-2}(i-2+2)^{K}\n\n$$\n\n\u4e8c\u9879\u5f0f\u5b9a\u7406\n\n$$\n\n\\begin{gathered}\n\n=F_{i-1}\\left(\\sum_{k=0}^{K} C_{K}^{k}(i-1)^{k}\\right)+F_{i-2}\\left(\\sum_{k=0}^{K} C_{K}^{k}(k-2)^{k} 2^{K-k}\\right) \\\\\n\n=\\sum_{k=0}^{K} C_{K}^{k}\\left(F_{i-1}(i-1)^{k}+F_{i-2}(i-2)^{k}2^{K-k}\\right) \\\\\n\n=\\sum_{k=0}^{K} C_{K}^{k}\\left(S_{i-1}(k)+S_{i-2}(k) 2^{K-k}\\right)\n\n\\end{gathered}\n\n$$\n\n\u5373\n\n$$\n\nS_{i}(K)=\\sum_{k=0}^{K} C_{K}^{k} S_{i-1}(k)+C_{K}^{k} 2^{K-k}S_{i-2}(k) \n\n$$\n\n\u6ce8\u610f\u5230 k \u5f88\u5c0f\uff0c\u6240\u4ee5\u76f4\u63a5\u628a\u6240\u6709\u7684 $S(k)$ \u4e22\u8fdb\u77e9\u9635\u662f\u6ca1\u6709\u95ee\u9898\u7684\u3002\n\n\u73b0\u5728\u5c31\u53ef\u4ee5\u77e9\u9635\u5feb\u901f\u5e42\u4e86\u3002\u65f6\u95f4\u590d\u6742\u5ea6 $O(K^3 \\log n)$\u3002\n\n\n\n### Code\uff1a\n\n```cpp\n#include <stdio.h>\n#include <algorithm>\n#include <string.h>\n#include <cctype>\n#define int long long\nusing namespace std;\nconst int N=101;\nconst int mo=1e9+7;\ninline int read(){\n\tchar ch=getchar();int x=0, f=1;\n\twhile(!isdigit(ch)){if(ch=='-') f=-1; ch=getchar();}\n\twhile(isdigit(ch)){x=(x<<3)+(x<<1)+ch-'0';ch=getchar();}\n\treturn x*f;\n}\nlong long n;\nint K, S, C[N][N], pow2[N];\nstruct node{\n\tint r[N][N];\n\tint* operator [](int i){return r[i];}\n\tvoid reset(){memset(r, 0, sizeof(r));}\n\tvoid debug(){\n\t\tfor(int i=0; i<S; i++, puts(\"\"))\n\t\t\tfor(int j=0; j<S; j++)\n\t\t\t\tprintf(\"%d \", r[i][j]);\n\t}\n\tnode operator * (node x){\n\t\tnode c;c.reset();\n\t\tfor(int i=0; i<S; i++)\n\t\t\tfor(int j=0; j<S; j++)\n\t\t\t\tfor(int k=0; k<S; k++)\n\t\t\t\t\tc[i][j]=(c[i][j]+1ll*r[i][k]*x[k][j]%mo)%mo;\n\t\treturn c;\n\t}\n}A, I, X;\nnode ksm(node a, long long b){\n\tnode res=I;\n\tfor(; b; b=b/2, a=a*a)\n\t\tif(b&1) res=res*a;\n\treturn res;\n}\n/*\nS(i, 0)\nS(i, 1)\nS(i, 2)\n...\nS(i, K)\nS(i-1, 0)\nS(i-1, 1)\nS(i-1, 2)\n...\nS(i-1, K)\nSum(i-1)\n*/\nsigned main(){\n\tn=read(), K=read();S=2*K+3;pow2[0]=1;\n\tfor(int i=1; i<=K; i++) pow2[i]=1ll*pow2[i-1]*2%mo;\n\tfor(int i=0; i<=K; i++){\n\t\tC[i][0]=1;\n\t\tfor(int j=1; j<=i; j++)\n\t\t\tC[i][j]=(C[i-1][j-1]+C[i-1][j])%mo;\n\t}\n\tI.reset();for(int i=0; i<S; i++) I[i][i]=1;\n\tX.reset();\n\tfor(int i=0; i<=K+1; i++)\n\t\tX[0][i]=1;//X[0][S-1]=0;\n\tA.reset();\n\tfor(int i=0; i<=K; i++) //S(i, (0-K)) \u4e2d\u7684 (0-K) \n\t\tfor(int k=0; k<=i; k++) //sigma  \u4e2d\u7684 \u5c0fk \n\t\t\tA[k][i]=C[i][k],\n\t\t\tA[k+K+1][i]=C[i][k]*pow2[i-k]%mo;\n\tfor(int i=0; i<=K; i++)\n\t\tA[i][i+K+1]=1;\n\tA[2*K+2][2*K+2]=1, A[K][2*K+2]=1;\n//\tX.debug();puts(\"CRX AK IOI\");\n//\tA.debug();puts(\"CHT AK IOI\");\n\tX=X*ksm(A, n);//X.debug();\n\tprintf(\"%lld\\n\", X[0][2*K+2]);\n    return 0;\n}\n```\n\n\n\n\n\n",
        "postTime": 1632567244,
        "uid": 341102,
        "name": "ReKoJ",
        "ccfLevel": 0,
        "title": "CF392C Yet Another Number Sequence"
    },
    {
        "content": "[\u9898\u76ee\u4f20\u9001\u95e8](https://codeforces.com/contest/392/problem/C)\n\n## \u9898\u610f:\n\u6590\u6ce2\u90a3\u5951\u6570\u5217 $F_1=1$\uff0c$F_2=2$\uff0c$F_i=F_{i-1}+F_{i-2}(i>2)$\u3002\u5bf9\u4e8e\u6570\u5217 $A$\uff0c$A_i(k)=F_i \\times i^k(i>1)$\u3002\u6c42 $A_1(k)+A_2(k)+...A_n(k)$\uff0c\u7b54\u6848\u5bf9 $10^9+7$ \u53d6\u6a21\u3002\n## \u89e3\u9898\u601d\u8def\n\u53d1\u73b0 $n<=10^{17}$\uff0c\u8003\u8651\u4f7f\u7528\u77e9\u9635\u52a0\u901f\u3002\u56e0\u4e3a\u77e9\u9635\u4e2d\u5411\u91cf\u53ea\u80fd\u6c42\u548c\u4e0d\u80fd\u76f8\u4e58\uff0c\u6240\u4ee5\u6211\u4eec\u53ea\u80fd\u628a $F_i \\times i^k$ \u770b\u6210\u4e00\u4e2a\u6574\u4f53\u3002\u63a5\u7740\u8003\u8651\u8f6c\u79fb\uff0c\u9996\u5148 $F_i=F_{i-1}+F_{i-2}$\uff0c\u7136\u540e\u5bf9\u4e8e $i^k = (i-1+1)^k$\u3002\u5bf9\u5176\u8fdb\u884c\u4e8c\u9879\u5f0f\u5c55\u5f00\u5f97 $(i-1+1)^k=\\sum\\limits_{r=0}^kC_k^r \\times (i-1)^k$\u3002\u6240\u4ee5\u628a $\\sum$ \u62c6\u5f00\u5f97\u5230\u77e9\u9635\uff1a\n$$\\begin{bmatrix}(i-1)^0 \\times F_{i-2}\\\\(i-1)^1 \\times F_{i-2}\\\\\\vdots\\\\(i-1)^k \\times F_{i-2}\\\\(i-1)^0 \\times F_{i-1}\\\\(i-1)^1 \\times F_{i-1}\\\\\\vdots\\\\(i-1)^k \\times F_{i-1}\\end{bmatrix} \\times C=\\begin{bmatrix}i^0 \\times F_{i-1}\\\\i^1 \\times F_{i-1}\\\\\\vdots\\\\i^k \\times F_{i-1}\\\\i^0 \\times F_{i}\\\\i^1 \\times F_{i}\\\\\\vdots\\\\i^k \\times F_{i}\\end{bmatrix}$$\n\u63a5\u7740\u601d\u8003\u5982\u4f55\u6784\u5efa\u64cd\u4f5c\u77e9\u9635 $C$\u3002\u663e\u7136 $i^0 \\times F_{i-1}=(i-1)^0 \\times F_{i-1}$\uff0c$i^1 \\times F_{i-1}=(i-1)^0 \\times F_{i-1}+(i-1)^1 \\times F_{i-1}$\uff0c$i^2 \\times F_{i-1}=(i-1)^0 \\times F_{i-1}+2 \\times (i-1)^1 \\times F_{i-1}+(i-1)^2 \\times F_{i-1}$\u3002\u5176\u5b9e\u5c31\u662f\u4e00\u4e2a\u6768\u8f89\u4e09\u89d2\u3002 $i^0 \\times F_i=(i-1)^0 \\times (F_{i-2}+F_{i-1})$\uff0c\u6240\u4ee5\u5c31\u662f\u4e24\u4e2a\u6768\u8f89\u4e09\u89d2\uff0c\u8fd9\u6837\u5c31\u5f97\u5230\u4e86\u64cd\u4f5c\u77e9\u9635 $C$\u3002\n$$\\begin{bmatrix}0&0&0&\\cdots&0&1&0&0&\\cdots&0\\\\0&0&0&\\cdots&0&1&1&0&\\cdots&0\\\\0&0&0&\\cdots&0&1&2&1&\\cdots&0\\\\\\vdots&\\vdots&\\vdots&\\vdots&\\vdots&\\vdots&\\vdots&\\vdots&\\vdots&\\vdots&\\\\1&0&0&\\cdots&0&1&0&0&\\cdots&0\\\\1&1&0&\\cdots&0&1&1&0&\\cdots&0\\\\1&2&1&\\cdots&0&1&2&1&\\cdots&0\\\\\\vdots&\\vdots&\\vdots&\\vdots&\\vdots&\\vdots&\\vdots&\\vdots&\\vdots&\\vdots&\\end{bmatrix}$$\n## AC\u4ee3\u7801\n```cpp\n#include<iostream>\n#include<algorithm>\n#include<vector>\n#define int long long\nusing namespace std;\nconst int mod=1e9+7;\nstruct Matrix{//\u77e9\u9635\u7ed3\u6784\u4f53 \n\tvector<vector<int> > mp;\n\tMatrix(int n,int val=0):mp(n,vector<int>(n,0)){\n\t\tfor(int i=0;i<n;i++) mp[i][i]=val;\n\t}\n\tMatrix(const vector<vector<int> >& _m):mp(move(_m)){}\n\tMatrix operator*(const Matrix& _m)const{\n\t\tint n=mp[0].size();\n\t\tMatrix res(n);\n\t\tfor(int i=0;i<n;i++)\n\t\t\tfor(int j=0;j<n;j++)\n\t\t\t\tfor(int k=0;k<n;k++)\n\t\t\t\t\tres.mp[i][j]=(res.mp[i][j]+mp[i][k]*_m.mp[k][j])%mod;\n\t\treturn res;\n\t}\n\tMatrix operator^(int l){\n\t\tMatrix res(mp.size(),1),tmp=*this;\n\t\twhile(l){\n\t\t\tif(l&1) res=res*tmp;\n\t\t\ttmp=tmp*tmp;\n\t\t\tl>>=1;\n\t\t}\n\t\treturn res;\n\t}\n};\nint n,k,ans;\nsigned main(){\n\tscanf(\"%lld%lld\",&n,&k);\n\tif(n==1){\n\t\tprintf(\"1\");\n\t\treturn 0;\n\t}\n\tif(n==2){\n\t\tprintf(\"%lld\",1+2*(1<<k));\n\t\treturn 0;\n\t}//\u7279\u5224\u5c0f\u4e8e\u7b49\u4e8e\u4e8c\u7684\u60c5\u51b5 \n\tMatrix C((k<<1)+3);\n\tC.mp[0][k+1]=1;\n\tfor(int i=1;i<k+1;i++){\n\t\tfor(int j=k+1;j<(k<<1)+2;j++){\n\t\t\tif(j==k+1) C.mp[i][j]=1;\n\t\t\telse C.mp[i][j]=(C.mp[i-1][j-1]+C.mp[i-1][j])%mod;\n\t\t}\n\t}\n\tC.mp[k+1][0]=C.mp[k+1][k+1]=1;\n\tfor(int i=k+2;i<(k<<1)+2;i++){\n\t\tfor(int j=0;j<k+1;j++){\n\t\t\tif(j==0) C.mp[i][j]=C.mp[i][j+k+1]=1;\n\t\t\telse C.mp[i][j]=C.mp[i][j+k+1]=(C.mp[i-1][j-1]+C.mp[i-1][j])%mod;\n\t\t}\n\t}\n\tfor(int i=0;i<(k<<1)+2;i++) C.mp[(k<<1)+2][i]=C.mp[(k<<1)+1][i];\n\tC.mp[(k<<1)+2][(k<<1)+2]=1;//\u521b\u5efa\u64cd\u4f5c\u77e9\u9635C \n\tC=C^(n-1);//\u77e9\u9635\u5feb\u901f\u5e42 \n\tfor(int i=0;i<(k<<1)+3;i++) ans=(ans+C.mp[(k<<1)+2][i])%mod;//\u7edf\u8ba1\u7b54\u6848 \n\tprintf(\"%lld\",ans%mod);\n\treturn 0;\n}\n```",
        "postTime": 1674040402,
        "uid": 372040,
        "name": "Fhr123456",
        "ccfLevel": 0,
        "title": "CF392C Yet Another Number Sequence \u9898\u89e3"
    },
    {
        "content": "~~\u5e94\u4e3a\u662f\u6570\u5217\uff0c\u6240\u4ee5\u8003\u8651\u77e9\u9635\u5feb\u901f\u5e42~~\n\n\u8fd9\u4e2a\u9898\u76ee\u672c\u8eab\u770b\u8d77\u6765\u4e0d\u80fd\u4f7f\u7528\u77e9\u9635\u5feb\u901f\u5e42\uff0c\u4f46\u662f\u4ed4\u7ec6\u770b\u770b\u5230 $k$ \u7279\u522b\u5c0f\uff0c\u53ef\u4ee5\u4fdd\u5b58\u6240\u6709 $F_i*i^x$ \u5728\u4e00\u4e2a\u72b6\u6001\u91cc\u3002\n\n\u6211\u4eec\u7684\u72b6\u6001\u662f\n\n$$\\begin{pmatrix}S(i)\\\\F_i\\\\F_i*i\\\\F_i*i^2\\\\F_i*i^3\\\\F_{i+1}\\\\F_{i+1}*(i+1)\\\\F_{i+1}*(i+1)^2\\\\F_{i+1}*(i+1)^3\\end{pmatrix}$$\n\n\u5e76\u4e14\u5e0c\u671b\u4ece\n\n$$\\begin{pmatrix}S(i-1)\\\\F_{i-1}\\\\F_{i-1}*(i-1)\\\\F_{i-1}*(i-1)^2\\\\F_{i-1}*(i-1)^3\\\\F_i\\\\F_i*i\\\\F_i*i^2\\\\F_i*i^3\\end{pmatrix}$$\n\n\u524d $k+1$ \u9879\u53ef\u4ee5\u76f4\u63a5\u79fb\u52a8\u5230\uff0c\u4f46\u662f\u540e $k$ \u9879\u9700\u8981\u66f4\u590d\u6742\u7684\u5c55\u5f00\u3002\n\n$$F_{i+1}*(i+1)^k=F_{i-1}*(i+1)^k+F_{i}*(i+1)^k$$\n$$=F_{i-1}*((i-1)+2)^k+F_{i}*((i)+1)^k$$\n\n\u5e94\u7528\u4e8c\u9879\u5f0f\u5b9a\u7406\u5c55\u5f00\uff1a\n\n$$=\\sum^k_{j=0}(\\binom{k}{j}2^{j-k})[F_{i-1}*(i-1)^j]+\\sum^k_{j=0}(\\binom{k}{j})[F_i*i^j]$$\n\n\u8fd9\u4e9b\u7cfb\u6570\u76f4\u63a5\u7528 dp \u653e\u5230\u8f6c\u79fb\u77e9\u9635\u91cc\uff0c\u5f97\u5230\u4e00\u4e2a\u7c7b\u4f3c\u4e8e\u8fd9\u6837\u4ed6\u77e9\u9635\uff1a\n\n$$\\begin{pmatrix}S(i)\\\\F_i\\\\F_i*i\\\\F_i*i^2\\\\F_i*i^3\\\\F_{i+1}\\\\F_{i+1}*(i+1)\\\\F_{i+1}*(i+1)^2\\\\F_{i+1}*(i+1)^3\\end{pmatrix}=\\begin{pmatrix}1&0&0&0&0&0&0&0&1\\\\0&0&0&0&0&1&0&0&0\\\\0&0&0&0&0&0&1&0&0\\\\0&0&0&0&0&0&0&1&0\\\\0&0&0&0&0&0&0&0&1\\\\0&1&0&0&0&1&0&0&0\\\\0&2&1&0&0&1&1&0&0\\\\0&4&4&1&0&1&2&1&0\\\\0&8&12&6&1&1&3&3&1\\end{pmatrix}\\begin{pmatrix}S(i-1)\\\\F_{i-1}\\\\F_{i-1}*(i-1)\\\\F_{i-1}*(i-1)^2\\\\F_{i-1}*(i-1)^3\\\\F_i\\\\F_i*i\\\\F_i*i^2\\\\F_i*i^3\\end{pmatrix}$$\n\n\n\u7b80\u5316\u6210\u521d\u59cb\u503c\uff1a\n\n$$\\begin{pmatrix}S(n)\\\\F_n\\\\F_n*n\\\\F_n*n^2\\\\F_n*n^3\\\\F_{n+1}\\\\F_{n+1}*(n+1)\\\\F_{n+1}*(n+1)^2\\\\F_{n+1}*(n+1)^3\\end{pmatrix}=\\begin{pmatrix}1&0&0&0&0&0&0&0&1\\\\0&0&0&0&0&1&0&0&0\\\\0&0&0&0&0&0&1&0&0\\\\0&0&0&0&0&0&0&1&0\\\\0&0&0&0&0&0&0&0&1\\\\0&1&0&0&0&1&0&0&0\\\\0&2&1&0&0&1&1&0&0\\\\0&4&4&1&0&1&2&1&0\\\\0&8&12&6&1&1&3&3&1\\end{pmatrix}^{n-1}\\begin{pmatrix}1\\\\1\\\\0\\\\0\\\\0\\\\1\\\\1\\\\1\\\\1\\end{pmatrix}$$\n\n\u77e9\u9635\u5927\u5c0f\u662f $2K+3$\uff0c\u6240\u4ee5\u603b\u5171\u590d\u6742\u5ea6\u662f $(2K+3)^3O(\\log n)=O(K^3\\log n)$\uff0c\u53ef\u8fc7\u3002\n\n\u4e3b\u8981\u4ee3\u7801\uff1a\n\n```cpp\nint p2[42];\n\nsigned main() {\n    ios_base::sync_with_stdio(false); cin.tie(0);\n    ll n; int k; gi(n), gi(k);\n\tif(n==1) {\n\t\tpc('1');\n\t\treturn 0;\n\t}\n\tmatt v; v.init();\n\tp2[0] = 1;\n\trep1(i, k+1) p2[i] = (p2[i-1]<<1)%MOD;\n\tv[0][0] = 1;\n\trep(i, k+1) v[i+1][k+i+2] = 1;\n\trep(i, k+1)\n\t\trep(j, i+1) {\n\t\t\tif(!(i|j)) v[k+2][k+2] = 1;\n\t\t\telse v[k+i+2][k+j+2] = (v[k+i+1][k+j+1]+v[k+i+1][k+j+2])%MOD;\n\t\t\tv[k+i+2][j+1] = 1ll*v[k+i+2][k+j+2]*p2[i-j]%MOD;\n\t\t}\n\trep1(i, 2*k+2) v[0][i] = v[2*k+2][i];\n\tmatt i; i.init();\n\ti[0][0] = i[1][0] = 1;\n\trep(r, k+1) i[k+r+2][0] = 1;\n\tprint(qpow(v,n-1).mult(i)[0][0]);\n}\n```",
        "postTime": 1584282434,
        "uid": 220037,
        "name": "w33z8kqrqk8zzzx33",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 CF392C"
    }
]