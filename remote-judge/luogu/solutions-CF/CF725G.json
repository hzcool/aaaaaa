[
    {
        "content": "\u600e\u4e48\u6ca1\u6709\u9898\u89e3\uff0c\u6c34\u4e00\u7bc7\u3002\n\n\u8003\u8651\u6bcf\u6761\u4fe1\u606f\u7ecf\u8fc7\u7684\u8fc7\u7a0b\u4e00\u5b9a\u662f\uff1a\u4ece\u8d77\u70b9\u51fa\u53d1\u5f80\u4e0a\u8d70\u5230\u67d0\u4e2a\u8282\u70b9\uff0c\u7136\u540e\u8d70\u56de\u6765\u3002\u6240\u4ee5\u6211\u4eec\u53ea\u5173\u5fc3\u5b83\u80fd\u8d70\u5230\u54ea\u4e2a\u8282\u70b9\u3002\u8003\u8651\u82e5\u4fe1\u606f $i$ \u8d70\u5230\u4e86\u8282\u70b9 $y_i\\ne1$\uff0c\u6b64\u65f6\u8282\u70b9 $y_i$ \u6b63\u5728\u5904\u7406\u4fe1\u606f $j$\uff0c\u90a3\u4e48\uff1a\n$$\\begin{cases}(t_j+d_{x_j}-d_{y_i},x_j)<(t_i+d_{x_i}-d_{y_i},x_i)\\\\t_i+d_{x_i}-d_{y_i}<t_j+d_{x_j}+d_{y_i}-2d_{y_j}\\end{cases}$$\n\u5176\u4e2d $d_u$ \u8868\u793a\u8282\u70b9 $u$ \u7684\u6df1\u5ea6\uff0c\u4e8c\u5143\u7ec4\u7684\u6bd4\u8f83\u662f\u5148\u6bd4\u8f83\u7b2c\u4e00\u5173\u952e\u5b57\uff0c\u82e5\u76f8\u7b49\u518d\u6bd4\u8f83\u7b2c\u4e8c\u5173\u952e\u5b57\u3002\u6574\u7406\u4e00\u4e0b\uff1a\n$$\\begin{cases}(t_j+d_{x_j},x_j)<(t_i+d_{x_i},x_i)\\\\t_i+d_{x_i}<t_j+d_{x_j}+2d_{y_i}-2d_{y_j}\\end{cases}$$\n\u56e0\u6b64\u6211\u4eec\u5c06\u4fe1\u606f\u6309 $t_i+d_{x_i}$ \u4e3a\u7b2c\u4e00\u5173\u952e\u5b57\uff0c$x_i$ \u4e3a\u7b2c\u4e8c\u5173\u952e\u5b57\u6392\u5e8f\uff0c\u4f9d\u6b21\u5904\u7406\u6bcf\u4e2a\u4fe1\u606f\u3002\u5904\u7406\u4fe1\u606f $i$ \u65f6\uff0c\u6211\u4eec\u9700\u8981\u627e\u51fa $x_i$ \u7684\u7956\u5148\u4e2d\u6700\u8fd1\u7684\u8282\u70b9 $u$\uff0c\u4f7f\u5f97\u5b58\u5728\u4e00\u4e2a\u4fe1\u606f $j$ \u7ecf\u8fc7\u8282\u70b9 $u$ \u4e14 $t_i+d_{x_i}<t_j+d_{x_j}+2d_u-2d_{y_j}$\u3002\n\n\u5bf9\u6bcf\u4e2a\u8282\u70b9 $u$ \u7ef4\u62a4\u7ecf\u8fc7\u5b83\u7684\u6240\u6709\u4fe1\u606f $j$ \u4e2d\uff0c$t_j+d_{x_j}+2d_u-2d_{y_j}$ \u7684\u6700\u5927\u503c\u3002\u518d\u7528\u6811\u5256\u548c\u7ebf\u6bb5\u6811\u7ef4\u62a4\u4e0a\u8ff0\u4fe1\u606f\u7684\u533a\u95f4\u6700\u5927\u503c\uff0c\u8fd9\u6837\u6211\u4eec\u5bfb\u627e $y_i$ \u65f6\u53ea\u9700\u8981\u987a\u7740\u6811\u5256\u5f80\u4e0a\u8df3\uff0c\u6bcf\u6b21\u518d\u8fdb\u884c\u7ebf\u6bb5\u6811\u4e8c\u5206\u5373\u53ef\u3002\u627e\u5230 $y_i$ \u540e\u6211\u4eec\u9700\u8981\u66f4\u65b0\u7ebf\u6bb5\u6811\uff0c\u8fd9\u53ef\u4ee5\u6253\u6807\u8bb0\u5b9e\u73b0\u3002\n\n\u4e8e\u662f\u6211\u4eec\u5b8c\u6574\u89e3\u51b3\u4e86\u95ee\u9898\u3002\u82e5\u4ee4 $n$ \u4e0e $m$ \u540c\u7ea7\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log^2n)$\u3002\u4f7f\u7528\u5176\u4ed6\u7684\u6811\u4e0a\u6570\u636e\u7ed3\u6784\u53ef\u4ee5\u505a\u5230 $O(n\\log n)$\u3002\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nusing ll=long long;\ninline ll read(){\n\tll x=0;\n\tbool f=0;\n\tchar c=getchar();\n\twhile(!isdigit(c)){\n\t\tif(c=='-') f=1;\n\t\tc=getchar();\n\t}\n\twhile(isdigit(c)){\n\t\tx=x*10+c-'0';\n\t\tc=getchar();\n\t}\n\treturn f?-x:x;\n}\nconst int maxn=2e5+5;\nint n,m,x[maxn],t[maxn];\nvector<int> g[maxn];\nint fa[maxn],dep[maxn],sz[maxn],son[maxn];\nvoid dfs1(int u){\n\tdep[u]=dep[fa[u]]+1;\n\tsz[u]=1;\n\tfor(int v:g[u]){\n\t\tdfs1(v);\n\t\tsz[u]+=sz[v];\n\t\tif(sz[v]>sz[son[u]]) son[u]=v;\n\t}\n}\nint pos[maxn],top[maxn];\nvector<int> f;\nvoid dfs2(int u){\n\tpos[u]=f.size();\n\tf.push_back(u);\n\ttop[u]=son[fa[u]]==u?top[fa[u]]:u;\n\tif(son[u]) dfs2(son[u]);\n\tfor(int v:g[u]) if(v!=son[u]) dfs2(v);\n}\nconst int inf=2e9;\nstruct node{\n\tint l,r;\n\tnode* ch[2];\n\tint mx,tag=-inf;\n\tvoid pushup(){\n\t\tmx=max(ch[0]->mx,ch[1]->mx);\n\t}\n\tnode(int l,int r):l(l),r(r),mx(l?-inf:inf){\n\t\tif(l==r) return;\n\t\tint mid=l+(r-l)/2;\n\t\tch[0]=new node(l,mid);\n\t\tch[1]=new node(mid+1,r);\n\t}\n\tvoid pushtag(int k){\n\t\tmx=max(mx,k+dep[f[r]]*2);\n\t\ttag=max(tag,k);\n\t}\n\tvoid pushdown(){\n\t\tch[0]->pushtag(tag);\n\t\tch[1]->pushtag(tag);\n\t\ttag=-inf;\n\t}\n\tvoid modify(int ql,int qr,int k){\n\t\tif(ql>r||qr<l) return;\n\t\tif(ql<=l&&qr>=r){\n\t\t\tpushtag(k);\n\t\t\treturn;\n\t\t}\n\t\tpushdown();\n\t\tch[0]->modify(ql,qr,k);\n\t\tch[1]->modify(ql,qr,k);\n\t\tpushup();\n\t}\n\tvoid get(int ql,int qr,vector<node*>& vec){\n\t\tif(ql>r||qr<l) return;\n\t\tif(ql<=l&&qr>=r){\n\t\t\tvec.push_back(this);\n\t\t\treturn;\n\t\t}\n\t\tpushdown();\n\t\tch[0]->get(ql,qr,vec);\n\t\tch[1]->get(ql,qr,vec);\n\t}\n\tint query(int x){\n\t\tif(l==r) return r;\n\t\tpushdown();\n\t\treturn ch[ch[1]->mx>x]->query(x);\n\t}\n}*rt;\nvoid modify(int x,int y,int k){\n\twhile(top[x]!=top[y]){\n\t\trt->modify(pos[top[x]],pos[x],k);\n\t\tx=fa[top[x]];\n\t}\n\trt->modify(pos[y],pos[x],k);\n}\nint query(int x,int k){\n\twhile(1){\n\t\tvector<node*> vec;\n\t\trt->get(pos[top[x]],pos[x],vec);\n\t\treverse(vec.begin(),vec.end());\n\t\tfor(node* u:vec)\n\t\t\tif(u->mx>k) return f[u->query(k)];\n\t\tx=fa[top[x]];\n\t}\n}\nint ord[maxn],ans[maxn];\nint main(){\n#ifdef LOCAL\n\tfreopen(\"in.txt\",\"r\",stdin);\n\tfreopen(\"out.txt\",\"w\",stdout);\n#endif\n\tn=read();\n\tm=read();\n\tfor(int i=2;i<=n+1;i++)\n\t\tg[fa[i]=read()+1].push_back(i);\n\tdfs1(1);\n\tdfs2(1);\n\tfor(int i=1;i<=m;i++){\n\t\tx[i]=read()+1;\n\t\tt[i]=read();\n\t\tord[i]=i;\n\t}\n\tsort(ord+1,ord+m+1,[](int a,int b){\n\t\tif(t[a]+dep[x[a]]!=t[b]+dep[x[b]])\n\t\t\treturn t[a]+dep[x[a]]<t[b]+dep[x[b]];\n\t\treturn x[a]<x[b];\n\t});\n\trt=new node(0,n);\n\tfor(int i=1;i<=m;i++){\n\t\tint u=ord[i],y=query(x[u],t[u]+dep[x[u]]);\n\t\tans[u]=t[u]+dep[x[u]]*2-dep[y]*2;\n\t\tmodify(x[u],y,t[u]+dep[x[u]]-dep[y]*2);\n\t}\n\tfor(int i=1;i<=m;i++) printf(\"%d \",ans[i]);\n#ifdef LOCAL\n\tfprintf(stderr,\"%f\\n\",1.0*clock()/CLOCKS_PER_SEC);\n#endif\n\treturn 0;\n}\n```",
        "postTime": 1675648723,
        "uid": 174045,
        "name": "FZzzz",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF725G Messages on a Tree"
    },
    {
        "content": "\u4e3a\u4ec0\u4e48\u6ca1\u6709 LCT\u3002\n\n\u5148\u6309\u7167 $dep+T$ \u6392\u5e8f\uff0c\u8fd9\u6837\u540e\u9762\u7684\u4e0d\u4f1a\u5f71\u54cd\u524d\u9762\u7684\u3002\n\n\u66b4\u529b\u633a\u7b80\u5355\u7684\uff0c\u5c31\u76f8\u5f53\u4e8e\u8bb0\u5f55\u6bcf\u4e2a\u8282\u70b9\u7b49\u5f85\u65f6\u95f4\u7684\u6700\u5927\u503c\uff0c\u7136\u540e\u4e00\u4e2a\u70b9\u66b4\u529b\u5411\u4e0a\u8df3\uff0c\u4e00\u76f4\u8df3\u5230\u7b2c\u4e00\u4e2a\u7b49\u5f85\u65f6\u95f4\u6bd4\u81ea\u5df1\u5927\u7684\u5c31\u505c\u4e0b\uff0c\u7136\u540e\u56de\u53bb\u3002\n\n\u53d1\u73b0\u4ece\u4e0a\u9762\u4e0b\u6765\u7684\u8fd9\u4e2a\u8fc7\u7a0b\u4f1a\u5f62\u6210\u4e00\u6761\u4e0b\u9762\u5927\uff0c\u4e0a\u9762\u5c0f\u7684\u94fe\uff0c\u5728\u8fd9\u4e2a\u94fe\u4e0a\u53ea\u8981\u8df3\u8fc7\u6700\u4e0b\u9762\u4e00\u4e2a\u5c31\u53ef\u4ee5\u76f4\u63a5\u8df3\u5230\u94fe\u9876\u3002\n\n\u4f46\u662f\u8fd9\u4e2a\u94fe\u4f1a\u4fee\u6539\u554a\uff0c\u7136\u540e\u53d1\u73b0\u8fd9\u4e2a\u53ef\u4ee5\u76f4\u63a5 LCT\uff0c\u76f8\u5f53\u4e8e\u4e00\u4e2a\u70b9\u6253\u901a\u5230\u6839\u7684\u8def\u5f84\uff0c\u4f46\u662f\u9047\u5230\u6bd4\u81ea\u5df1\u5927\u7684\u5c31\u505c\u4e0b\u3002\n\n\u6211\u5199\u7684\u662f\u53cc $\\log$\uff0c\u4e0d\u8fc7\u53ef\u4ee5\u8f7b\u677e\u4f18\u5316\uff0c\u61d2\u3002\n\n\u6bd4\u6811\u5256\u597d\u5199\u5f97\u591a\u3002\n\n```cpp\n#include <bits/stdc++.h>\n#define V vector\n#define Vi vector<int>\n#define sz(a) ((int)a.size())\n#define fi first\n#define se second\n#define Int pair<int, int>\n#define Inf ((int)1e9)\n#define pb push_back\n#define ins insert\n#define For(i, x, y) for (auto i = (x); i <= (y); i++)\n#define Rep(i, x, y) for (auto i = (x); i >= (y); i--)\n#define seg int p, int l, int r\n#define lid p << 1, l, mid\n#define rid p << 1 | 1, mid + 1, r\n#define mid ((l + r) / 2)\n#define IO(x) freopen(#x \".in\", \"r\", stdin), freopen(#x \".out\", \"w\", stdout);\nusing namespace std;\nstruct hzy {\n  int x, T, id;\n};\nstruct Link_Cut_Tree {\n  static const int N = 2e5 + 5;\n  int isrt(int x) { return e[fa[x]][0] != x && e[fa[x]][1] != x; }\n  void up(int x) {\n    int y = fa[x], k = e[y][1] == x;\n    fa[x] = fa[y];\n    if (!isrt(y)) e[fa[y]][e[fa[y]][1] == y] = x;\n    e[y][k] = e[x][k ^ 1];\n    if (e[x][k ^ 1]) fa[e[x][k ^ 1]] = y;\n    e[x][k ^ 1] = y, fa[y] = x;\n  }\n  void splay(int x) {\n    for (int y; !isrt(x); up(x))\n      if (!isrt(y = fa[x])) up((e[fa[y]][0] == y) == (e[y][0] == x) ? y : x);\n  }\n  int getval(int x) {\n    splay(x);\n    int y = x;\n    while (e[y][0]) y = e[y][0];\n    return v[y] + dep[x];\n  }\n  int getrt(int x) {\n    splay(x);\n    int y = x;\n    while (e[y][0]) y = e[y][0];\n    return y;\n  }\n  int ask(int x, int T) {\n    int y = 0;\n    for (; x && T - dep[x] >= getval(x); x = fa[y = x]) {\n      if (e[x][1]) {\n        int t = getrt(x), g = e[x][1];\n        e[x][1] = y;\n        g = getrt(g);\n        v[g] = v[t];\n      }\n      e[x][1] = y;\n    }\n    if (y) {\n      int t = getrt(y);\n      v[t] = T - dep[t] + 2 - dep[t];\n    }\n    return x;\n  }\n  int la[N], e[N][2], fa[N], v[N], dep[N];\n};\nint main() {\n  ios::sync_with_stdio(0), cin.tie(0), cout.tie(0);\n  int n, m;\n  cin >> n >> m;\n  n++;\n  V<Vi> e(n + 5);\n  Vi fa(n + 5);\n  for (int i = 2; i <= n; i++) cin >> fa[i], fa[i]++, e[fa[i]].pb(i);\n  Vi dep(n + 5);\n  auto dfs = [&](auto lf, int x) -> void {\n    for (int y : e[x]) {\n      dep[y] = dep[x] + 1;\n      lf(lf, y);\n    }\n  };\n  dfs(dfs, 1);\n  V<hzy> b(m + 5);\n  for (int i = 1; i <= m; i++) {\n    cin >> b[i].x >> b[i].T;\n    b[i].x++;\n    b[i].id = i;\n  }\n  sort(&b[1], &b[m + 1], [&](hzy x, hzy y) {\n    if (dep[x.x] + x.T != dep[y.x] + y.T)\n      return dep[x.x] + x.T < dep[y.x] + y.T;\n    return x.x < y.x;\n  });\n  Link_Cut_Tree lct;\n  for (int i = 2; i <= n; i++) lct.fa[i] = fa[i];\n  for (int i = 1; i <= n; i++) lct.dep[i] = dep[i], lct.v[i] = -Inf;\n  lct.v[1] = Inf;\n  Vi las(n + 5), Ans(m + 5);\n  for (int i = 1; i <= m; i++) {\n    int t = lct.ask(b[i].x, b[i].T + dep[b[i].x]);\n    Ans[b[i].id] = b[i].T + (dep[b[i].x] - dep[t]) * 2;\n  }\n  For(i, 1, m) cout << Ans[i] << '\\n';\n}\n```",
        "postTime": 1685517953,
        "uid": 98490,
        "name": "houzhiyuan",
        "ccfLevel": 7,
        "title": "CF725G"
    },
    {
        "content": "[$\\texttt{link}$](https://www.luogu.com.cn/problem/solution/CF725G)\n\n\u7b2c $i$ \u6761\u4fe1\u606f\u7684\u4f20\u8f93\u53ef\u4ee5\u8868\u793a\u6210 $x_i$ \u8d70\u5230 $x_i$ \u7684\u67d0\u4e00\u7956\u5148\u518d\u8d70\u56de $x_i$ \u7684\u8def\u5f84\u3002\u6240\u4ee5\u7b54\u6848\u53ea\u548c $x_i$ \u7684\u8fd9\u4e00\u7956\u5148\u6709\u5173\uff0c\u8bb0\u4e3a $f_i$\uff0c\u5219 $ans_i=t_i+2\\times dep_{x_i}-2\\times dep_{f_i}$\u3002\n\n\u82e5 $x_i$ \u5728 $f_i$ \u505c\u4e0b\uff0c\u8bf4\u660e\u66f4\u65e9\u7684\u65f6\u523b\uff08\u6216\u540c\u4e00\u65f6\u523b\u4f46\u7f16\u53f7\u66f4\u5c0f\uff09\uff0c\u6709 $x_j$ \u7ecf\u8fc7\u4e86 $f_i$\uff0c\u4e14\u5230\u73b0\u5728\u5b83\u4e5f\u6ca1\u56de\u6765\u3002\n\n\u4e8e\u662f\u6709\n\n$$\\begin{cases}(t_i+dep_{x_i}-dep_{f_i},x_i)>(t_j+dep_{x_j}-dep_{f_i},x_j)\\\\t_i+dep_{x_i}-dep_{f_i}<t_j+dep_{x_j}+dep_{f_i}-2\\times dep_{f_j}\\end{cases}$$\n\n\u4e8c\u5143\u7ec4\u5927\u5c0f\u6bd4\u8f83\u4ee5\u7b2c\u4e00\u9879\u4e3a\u7b2c\u4e00\u5173\u952e\u5b57\uff0c\u7b2c\u4e8c\u9879\u4e3a\u7b2c\u4e8c\u5173\u952e\u5b57\u3002\n\n\u6574\u7406\u5f97\n\n$$\\begin{cases}(t_i+dep_{x_i},x_i)>(t_j+dep_{x_j},x_j)\\\\t_i+dep_{x_i}<t_j+dep_{x_j}+2\\times dep_{f_i}-2\\times dep_{f_j}\\end{cases}$$\n\n\u8fd9\u662f\u4e2a\u4e8c\u7ef4\u504f\u5e8f\uff0c\u628a\u4fe1\u606f\u6309 $(t_i+dep_{x_i},x_i)$ \u6392\u5e8f\uff0c\u4f9d\u6b21\u52a0\u5165\uff0c\u5373\u53ef\u6ee1\u8db3\u7b2c\u4e00\u6761\u5173\u7cfb\u3002\n\n\u5bf9\u4e8e\u7b2c\u4e8c\u6761\u5173\u7cfb\uff0c\u6211\u4eec\u5e94\u8be5\u987a\u7740\u6839\u5230 $x_i$ \u7684\u8def\u5f84\u5411\u4e0a\u722c\uff0c\u76f4\u5230\u7b2c\u4e00\u4e2a\u8282\u70b9 $u$\uff0c\u6ee1\u8db3 $t_i+dep_{x_i}<t_j+dep_{x_j}+2\\times dep_u-2\\times dep_{f_j}$\u3002\u6240\u4ee5\u5bf9\u4e8e\u6811\u4e0a\u6bcf\u4e2a\u70b9 $u$\uff0c\u7ef4\u62a4 $g_u$ \u8868\u793a\u7ecf\u8fc7\u70b9 $u$ \u7684\u70b9 $x_j$ \u4e2d\uff0c$t_j+dep_{x_j}-2\\times dep_{f_j}$ \u7684\u6700\u5927\u503c\u3002\u4e8e\u662f\u53ea\u9700\u627e\u6700\u6df1\u5ea6\u6700\u5927\u7684 $x_i$ \u7684\u7956\u5148\uff0c\u6ee1\u8db3 $t_i+dep_{x_i}<g_u+2\\times dep_u$\u3002\u6811\u5256\uff0c\u7ef4\u62a4 $\\max(g_u+2\\times dep_u)$\uff0c\u7136\u540e\u7ebf\u6bb5\u6811\u4e8c\u5206\u5373\u53ef\u3002\u7b97\u51fa $f_i$ \u540e\u66f4\u65b0\u8def\u5f84\u4e0a\u6700\u5927\u503c\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log^2 n)$\u3002",
        "postTime": 1682989804,
        "uid": 365107,
        "name": "Terac",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF725G Messages on a Tree"
    }
]