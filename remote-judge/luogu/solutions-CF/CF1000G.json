[
    {
        "content": "\u8003\u8bd5\u505a\u5230\u4e86\u7c7b\u4f3c\u7684\u4e00\u9053\u9898 [LOJ#6699](https://loj.ac/problem/6699)\uff0c\u9898\u89e3\u662f\u6362\u6839DP\u3002\u4f46\u662f\u6211\u4e0d\u4f1a\u6362\u6839\uff0c\u6240\u4ee5\u7528\u500d\u589e\u8fc7\u4e86\u8fd9\u9053\u9898qwq\u3002\n\n---\n\n#### \u9898\u610f\n\n\u7ed9\u5b9a\u4e00\u68f5\u6811\uff0c\u6709\u70b9\u6743\u548c\u8fb9\u6743\u3002\u8be2\u95ee\u4ece $u$ \u5230 $v$\uff0c\u6bcf\u6761\u8fb9\u6700\u591a\u7ecf\u8fc7\u4e24\u6b21\uff08\u5373\u5f80\u8fd4\u4e24\u6b21\uff09\uff0c\u7ecf\u8fc7\u7684\u70b9\u6743\u51cf\u8fb9\u6743\uff08\u70b9\u6743\u53ea\u7b97\u4e00\u6b21\uff09\u7684\u6700\u5927\u503c\u3002\n\n#### \u9898\u89e3\n\n\u5148\u8003\u8651\u4ece\u70b9 $u$ \u5f00\u59cb\uff0c\u8fdb\u5165\u5b83\u7684\u5b50\u6811\u518d\u8fd4\u56de\u6240\u80fd\u5f97\u5230\u7684\u6700\u5927\u4ef7\u503c\u3002\u4e0d\u96be\u60f3\u51fa\u5982\u4e0b\u8f6c\u79fb\u65b9\u7a0b\uff1a\n\n$$\nf(u)=a_u+\\sum_{v \\in son_u} {\\rm{max}}\\{0,f(v)-w(u,v)-w(v,u)\\}\n$$\n\n\u8dd1\u4e00\u904d\u6811\u5f62DP\u5c06\u5176\u8ba1\u7b97\u51fa\u6765\u3002\n\n\u7136\u540e\u8003\u8651\u5982\u4f55\u500d\u589e\u3002\n\n\u8bb0\u5f55 $ p(u,i) $ \u8868\u793a\u4ece $u$ \u7ed3\u70b9\u5411\u4e0a\u8df3 $2^i$ \u5c42\u540e\u6240\u5230\u8fbe\u7684\u7ed3\u70b9\uff0c\u8fd9\u53ef\u4ee5\u901a\u8fc7\u9012\u63a8\u7684\u65b9\u5f0f\u6c42\u51fa\uff1a\n$$\np(u,i)=p(p(u,i-1),i-1)\n$$\n\u8bb0\u5f55 $F(u,i)$ \u8868\u793a\u4ece $u$ \u7ed3\u70b9\u5230\u8fbe $p(u,i)$ \u6216\u4ece $p(u,i)$ \u5230 $u$ \u6240\u80fd\u5f97\u5230\u7684\u6700\u5927\u4ef7\u503c\uff08\u56e0\u4e3a\u8fd9\u9053\u9898\u5728\u4e00\u6761\u8fb9\u4e0a\u5f80\u8fd4\u7684\u82b1\u8d39\u90fd\u4e00\u6837\uff0c\u6240\u4ee5\u53ea\u7528\u8bb0\u4e00\u4e2a\u6570\u7ec4\uff09\uff0c\u4e5f\u5c31\u662f\u8bf4\u9014\u4e2d\u53ef\u4ee5\u4ece\u8def\u5f84\u4e0a\u7684\u4efb\u610f\u4e00\u4e2a\u70b9\u8fdb\u5165\u5b83\u7684\u5b50\u6811\u518d\u8fd4\u56de\u3002\u7136\u540e\u6211\u4eec~~\u51ed\u76f4\u89c9~~\u5199\u51fa\u8fd9\u4e2a\u8f6c\u79fb\u65b9\u7a0b\uff1a\n$$\nF(u,i)=F(u,i-1)+F(p(u,i-1),i-1)\n$$\n\u4f46\u662f\u8fd9\u6837\u8f6c\u79fb\uff0c\u4f1a\u6709\u4e00\u90e8\u5206\u4fe1\u606f\u91cd\u590d\u8ba1\u7b97\uff0c\u8003\u8651\u7528\u5bb9\u65a5\u7684\u601d\u60f3\u5c06\u8fd9\u90e8\u5206\u5254\u51fa\u53bb\u3002\n\n$F(u,i-1)$ \u8bb0\u5f55\u4e86\u56fe\u4e2d\u7ea2\u8272\u533a\u57df\u5185\u7684\u4fe1\u606f\uff0c$F(u,i)$ \u8bb0\u5f55\u4e86\u56fe\u4e2d\u84dd\u8272\u533a\u57df\u5185\u7684\u4fe1\u606f\uff1a\n\n![a8aMtA.png](https://s1.ax1x.com/2020/08/01/a8aMtA.png)\n\n\u89c2\u5bdf\u4e00\u4e0b\uff0c\u7f3a\u5931\u7684\u90e8\u5206\u6b63\u597d\u662f $F(p(u,i-1),i-1)-f(p(u,i-1))$ \u3002\u4e8e\u662f\u6211\u4eec\u5f97\u5230\u4e86\u6b63\u786e\u7684\u8f6c\u79fb\u65b9\u7a0b\uff1a\n$$\nF(u,i)=F(u,i-1)+F(p(u,i-1),i-1)-f(p(u,i-1))\n$$\n\u63a5\u7740\u8003\u8651\u5982\u4f55\u7edf\u8ba1\u7b54\u6848\u3002\n\n\u7531\u4e8e\u6211\u4eec\u5df2\u7ecf\u628a\u4fe1\u606f\u8bb0\u5f55\u5230\u4e86\u500d\u589e\u6570\u7ec4 $F$ \u91cc\u9762\uff0c\u6240\u4ee5\u73b0\u5728\u53ea\u9700\u8981\u8fdb\u884c\u500d\u589e\u6c42LCA\u7684\u64cd\u4f5c\uff0c\u5e76\u5408\u5e76\u7b54\u6848\u3002\n\n\u8003\u8651\u5982\u4f55\u5728\u4ece $u$ \u8df3\u5230 $p(u,i)$ \u65f6\u628a $F(u,i)$ \u62fc\u63a5\u5230\u7b54\u6848\u4e2d\u53bb\u3002\n\n\u56fe\u4e2d\u7ea2\u8272\u533a\u57df\u5df2\u7ecf\u7edf\u8ba1\u5165\u7b54\u6848\uff0c\u84dd\u8272\u533a\u57df\u662f\u8df3\u5230 $p(u,i)$ \u540e\u7edf\u8ba1\u5165\u7b54\u6848\u7684\u533a\u57df\uff1a\n\n![a8Dsw8.png](https://s1.ax1x.com/2020/08/01/a8Dsw8.png)\n\n\u7c7b\u6bd4\u4e0a\u9762 $F(u,i)$ \u7684\u8ba1\u7b97\u8fc7\u7a0b\uff0c\u53d1\u73b0\u9700\u8981\u8ba1\u5165\u7b54\u6848\u7684\u5c31\u662f $F(u,i)-f(u)$ \uff0c\u8fb9\u500d\u589e\u8fb9\u7edf\u8ba1\u7b54\u6848\u5373\u53ef\u3002\n\n\u7136\u800c\u5f53\u4e00\u4e2a\u7ed3\u70b9\u662f\u53e6\u4e00\u4e2a\u7ed3\u70b9\u7956\u5148\u65f6\uff0c\u8fd9\u6837\u7edf\u8ba1\u6ca1\u4ec0\u4e48\u95ee\u9898\uff0c\u800c\u5f53\u4e24\u7ed3\u70b9\u7684\u7684LCA\u4e0d\u662f\u4ed6\u4eec\u5176\u4e2d\u4efb\u4f55\u4e00\u4e2a\u65f6\uff0c\u5728LCA\u5904\u7b54\u6848\u6709\u91cd\u590d\uff0c\u6211\u4eec\u518d\u8003\u8651\u5bb9\u65a5\u6765\u89e3\u51b3\u95ee\u9898\u3002\n\n\u5f53 $u$ \u4e0e $v$ \u90fd\u8df3\u5230LCA\u4e0b\u9762\u65f6\uff0c\u6709\u4e0b\u9762\u8fd9\u4e2a\u56fe\uff1a\n\n\u84dd\u8272\u90e8\u5206\u662f\u4ece $v$ \u5230 $LCA$ \u8ba1\u7b97\u5165\u7b54\u6848\u7684 $LCA$ \u7684\u5176\u4ed6\u5b50\u6811\u90e8\u5206\uff0c\u4e5f\u5c31\u662f\u8bf4\u7b54\u6848\u53ef\u80fd\u5305\u542b\u7531 $LCA$ \u8fdb\u5165\u84dd\u8272\u533a\u57df\u7684\u8d21\u732e\uff0c\u7ea2\u8272\u533a\u57df\u540c\u7406\u3002\u7eff\u8272\u533a\u57df\u4ee3\u8868 $f(LCA)$ \u3002\n\n![a8gBOs.png](https://s1.ax1x.com/2020/08/01/a8gBOs.png)\n\n\u53ef\u4ee5\u53d1\u73b0\uff0c$a_{LCA}$ \u548c $LCA$ \u9664\u4e86 $u,v$ \u7684\u5b50\u6811\u4fe1\u606f\u88ab\u8ba1\u7b97\u4e86\u4e24\u6b21\uff0c\u800c $LCA$ \u7684\u5b50\u6811\u4e2d $u,v$ \u7684\u5b50\u6811\u4fe1\u606f\u4e0d\u5e94\u8be5\u7edf\u8ba1\u5165\u7b54\u6848\uff0c\u591a\u4f59\u7684\u4fe1\u606f\u6070\u597d\u662f $f(LCA)$ \uff0c\u5df2\u7ecf\u7b97\u597d\u4e86\uff0c\u5c06\u8fd9\u90e8\u5206\u5728\u7b54\u6848\u4e2d\u5254\u9664\u5373\u53ef\u3002\n\n\u7136\u540e\u6211\u5c31\u8fd9\u6837\u7801\u4e86\u51fa\u6765\uff0c\u7ed3\u679c\u6837\u4f8b\u90fd\u8fc7\u4e0d\u53bb\u3002\n\n![a82REt.png](https://s1.ax1x.com/2020/08/01/a82REt.png)\n\nLCA\u8fd8\u53ef\u4ee5\u5411\u5b83\u7684\u7956\u5148\u8d70\uff0c\u800c\u4e0a\u9762\u5b8c\u5168\u6ca1\u8003\u8651\u8fd9\u70b9\uff0c\u53ea\u5728\u5b50\u6811\u4e2d\u7edf\u8ba1\u3002\n\n\u7ecf\u8fc7~~\u4e71\u641e~~\u5206\u6790\uff0c\u8fd9\u4e2a\u4fe1\u606f\u53ef\u4ee5\u901a\u8fc7\u5b83\u7684\u7236\u4eb2\u8f6c\u79fb\u8fc7\u6765\uff0c\u4e8e\u662f\u518d\u8bb0 $g(u)$ \u4ee3\u8868\u4ece $u$ \u5411\u5b83\u7684\u7956\u5148\u8d70\u518d\u8fd4\u56de\u6240\u80fd\u5f97\u5230\u7684\u6700\u5927\u8d21\u732e\uff08\u6ce8\u610f\uff0c\u8fd9\u91cc\u5e76\u6ca1\u6709\u5c06 $a_u$ \u8ba1\u5165 $g(u)$ \uff09\u3002\u7528 $F$ \u548c $f$ \u6765\u8f85\u52a9 $g$ \u7684\u8f6c\u79fb\uff1a\n$$\ng(u)= {\\rm{max}}\\{0,g(fa)+F(u,0)-f(u)-w(fa,u)\\}\n$$\n\u7531\u4e8e\u53ea\u6709 $LCA$ \u624d\u80fd\u5411\u4e0a\u8d70\uff0c\u6240\u4ee5\u6700\u7ec8\u7b54\u6848\u518d\u52a0\u4e0a $g(LCA)$ \u5373\u53ef\u3002\n\n---\n\n$\\text{Code}:$\n\n```cpp\n#include <iostream>\n#include <cstring>\n#include <cstdio>\n#include <algorithm>\n#include <cmath>\n#define maxn 300005\n#define R register\n#define INF 0x3f3f3f3f\nusing namespace std;\ntypedef long long lxl;\n\ninline lxl read()\n{\n\tlxl x=0,f=1;char ch=getchar();\n\twhile(ch<'0'||ch>'9') {if(ch=='-') f=-1;ch=getchar();}\n\twhile(ch>='0'&&ch<='9') {x=(x<<1)+(x<<3)+ch-'0';ch=getchar();}\n\treturn x*f;\n}\n\nstruct edge\n{\n\tint v,w,next;\n}e[maxn<<1];\n\nint head[maxn],k;\n\ninline void add(int u,int v,int w)\n{\n\te[k]=(edge){v,w,head[u]};\n\thead[u]=k++;\n}\n\nint n,q;\nlxl f[maxn],a[maxn];\n\ninline void dp(int u,int fa)\n{\n\tf[u]=a[u];\n\tfor(int i=head[u];~i;i=e[i].next)\n\t{\n\t\tint v=e[i].v;\n\t\tif(v==fa) continue;\n\t\tdp(v,u);\n\t\tif(f[v]-e[i].w-e[i^1].w>0)// \u82e5\u4e3a\u8d1f\u5219\u4e00\u5b9a\u4e0d\u4f1a\u8fdb\u5165\u8fd9\u68f5\u5b50\u6811\uff0c\u56e0\u4e3a\u8fd9\u6837\u4f1a\u8ba9\u7b54\u6848\u66f4\u52a3\n            f[u]+=f[v]-e[i].w-e[i^1].w;\n\t}\n}\n\nint p[maxn][30];\nlxl F[maxn][30],g[maxn];\nint dep[maxn];\n\ninline void dfs(int u,int fa)\n{\n\tdep[u]=dep[p[u][0]=fa]+1;\n\tfor(int i=1;i<=25;++i)\n\t{\n\t\tp[u][i]=p[p[u][i-1]][i-1];\n\t\tF[u][i]=F[u][i-1]+F[p[u][i-1]][i-1]-f[p[u][i-1]];\n\t}\n\tfor(int i=head[u];~i;i=e[i].next)\n\t{\n\t\tint v=e[i].v;\n\t\tif(v==fa) continue;\n\t\tF[v][0]=f[v]+f[u]-e[i^1].w;\n\t\tif(f[v]-2*e[i].w>0) F[v][0]-=f[v]-e[i].w-e[i^1].w;// \u5982\u679cf[u]\u4e2d\u5305\u542b\u4e86f[v]\uff0c\u5219\u5c06\u5176\u9664\u53bb\uff0c\u907f\u514d\u91cd\u590d\u8ba1\u7b97\n\t\tg[v]=max(g[v],g[u]+F[v][0]-e[i].w-f[v]);\n\t\tdfs(v,u);\n\t}\n}\n\ninline lxl Query(int u,int v)// \u500d\u589e\n{\n\tlxl ans=0;\n\tint a=u,b=v;\n\tif(dep[v]>dep[u]) swap(u,v);// \u4ece\u6df1\u5ea6\u6df1\u7684\u5f00\u59cb\u8df3\n\tfor(int i=25;i>=0;--i)\n\t\tif(dep[p[u][i]]>=dep[v])\n\t\t{\n\t\t\tans+=F[u][i]-f[u];\n\t\t\tu=p[u][i];\n\t\t}\n\tif(u==v) return ans+((dep[a]>dep[b])?f[a]:f[b])+g[u];\n\tfor(int i=25;i>=0;--i)\n\t\tif(p[u][i]!=p[v][i])\n\t\t{\n\t\t\tans+=F[u][i]-f[u]+F[v][i]-f[v];\n\t\t\tu=p[u][i];v=p[v][i];\n\t\t}\n\treturn ans+F[u][0]-f[u]+F[v][0]-f[v]-f[p[u][0]]+f[a]+f[b]+g[p[u][0]];\n}\n\nint main()\n{\n\t// freopen(\"CF1000G.in\",\"r\",stdin);\n\tn=read(),q=read();\n\tfor(int i=1;i<=n;++i)\n\t\ta[i]=read();\n\tmemset(head,-1,sizeof(int)*(n+5));\n\tfor(int i=1;i<n;++i)\n\t{\n\t\tint u=read(),v=read();\n\t\tlxl w=read();\n\t\tadd(u,v,w);\n\t\tadd(v,u,w);\n\t}\n\tdp(1,0);//\u8ba1\u7b97 f\n\tdfs(1,0);// \u500d\u589e\u9884\u5904\u7406\n\twhile(q--)\n\t{\n\t\tint u=read(),v=read();\n\t\tprintf(\"%lld\\n\",Query(u,v));\n\t}\n\treturn 0;\n}\n\n```\n\n",
        "postTime": 1596274710,
        "uid": 224236,
        "name": "GoPoux4",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 CF1000G \u3010Two-Paths\u3011"
    },
    {
        "content": "# \u9898\u76ee\u5927\u610f\n\n\u7ed9\u51fa\u4e00\u68f5\u6811,\u591a\u6b21\u67e5\u8be2\u4e24\u4e2a\u70b9\u4e4b\u95f4\u7684 $\\mathcal{Two-Path}$ \u7684\u6743\u503c\u7684\u6700\u5927\u503c,\u4ee5\u4e0b\u4e3a $\\mathcal{Two-Path}$ \u8def\u5f84\u6743\u503c\u7684\u5b9a\u4e49:\n$$\nvalue=\\sum\\limits_{p\\in path}a_p-\\sum\\limits_{e\\in path}(w_ek_e)\n$$\n(\u5176\u4e2d $a_i$ \u8868\u793a $i$ \u7684\u70b9\u6743,$w_e$ \u8868\u793a\u8fb9 $e$ \u7684\u8fb9\u6743,$k_e$ \u8868\u793a\u8fb9 $e$ \u88ab\u7ecf\u8fc7\u7684\u6b21\u6570,\u4e14\u8981\u6c42 $0\\leq k_e\\leq 2$,\u5373\u6bcf\u6761\u8fb9\u6700\u591a\u88ab\u8d70\u8fc7\u4e24\u6b21).\n\n# \u5206\u6790\n\n\u5047\u5982\u7ed9\u51fa\u7684\u6811\u957f\u8fd9\u4e2a\u6837\u5b50:\n\n![](https://images.cnblogs.com/cnblogs_com/Sxy_Limit/1864899/o_2010161210391.jpg)\n\n\u8003\u8651\u6709\u4e00\u6b21 $3\\to 6$ \u7684\u67e5\u8be2.\n\n\u663e\u7136\u5bf9\u4e8e $3\\to 6$ \u8fd9\u6761\u7b80\u5355\u8def\u5f84\u4e0a\u7684\u8fb9\u662f\u53ea\u80fd\u8d70\u4e00\u6b21\u7684(\u5982\u679c\u8d70\u4e86\u81f3\u5c11 $2$ \u6b21,\u90a3\u4e48\u80af\u5b9a\u8981\u8d70\u81f3\u5c11 $3$ \u6b21,\u8fd9\u6837\u662f\u4e0d\u5408\u6cd5\u7684),\u6240\u4ee5\u8003\u8651\u8d21\u732e\u7684\u65f6\u5019\u53ea\u9700\u8981\u53bb\u8003\u8651\u4e0d\u5728\u8fd9\u6761\u7b80\u5355\u8def\u5f84\u4e0a\u7684\u90e8\u5206\u5373\u53ef,\u4e5f\u5c31\u662f\u5982\u4e0b\u90e8\u5206(\u84dd\u8272\u548c\u7eff\u8272\u90e8\u5206):\n\n![](https://images.cnblogs.com/cnblogs_com/Sxy_Limit/1864899/o_2010161214204.jpg)\n\n\u5176\u4e2d\u7eff\u8272\u90e8\u5206\u662f\u8def\u5f84\u4e0a\u7684\u70b9\u7684\u90e8\u5206\u5b50\u8282\u70b9\u7684\u8d21\u732e,\u84dd\u8272\u90e8\u5206\u4ec5\u5728 $\\operatorname{LCA}(3,6)$(\u6bcf\u6b21\u67e5\u8be2\u7684\u4e24\u4e2a\u8282\u70b9\u7684\u6700\u8fd1\u516c\u5171\u7956\u5148)\u5904\u5b58\u5728.\u5148\u8003\u8651\u7eff\u8272\u90e8\u5206\u7684\u8d21\u732e.\n\n\u663e\u7136\u53ef\u4ee5\u5148\u5904\u7406\u51fa $f_i$ \u8868\u793a $i$ \u8282\u70b9\u7684**\u6240\u6709**\u5b50\u8282\u70b9\u5bf9 $i$ \u7684\u8d21\u732e\u7684\u6700\u5927\u503c,\u663e\u7136\u6709\u5982\u4e0b\u8f6c\u79fb\u65b9\u7a0b:\n\n$$f_i=\\sum\\limits_{u\\in son_i}\\max\\{f_u-2*VAL+val_u,0\\}$$\n\n($VAL_u$ \u8868\u793a $u$ \u5230 $u$ \u7684\u7236\u4eb2\u8fd9\u6761\u8fb9\u7684\u8fb9\u6743,$val_u$ \u8868\u793a $u$ \u8282\u70b9\u7684\u6743\u503c)\n\n\u4f46\u662f\u5bf9\u4e8e\u4e24\u4e2a\u70b9\u67e5\u8be2\u7684\u65f6\u5019\u5e76\u4e0d\u80fd\u628a\u8def\u5f84\u4e0a\u6240\u4ee5\u7684 $f$ \u52a0\u8d77\u6765,\u5982\u4e0b\u56fe:\n\n![](https://images.cnblogs.com/cnblogs_com/Sxy_Limit/1864899/o_2010161232213.jpg)\n\n\u6211\u4eec\u9700\u8981\u7684\u662f\u84dd\u8272\u90e8\u5206\u4ee5\u53ca\u7eff\u8272\u90e8\u5206\u7684\u8d21\u732e,\u4f46\u662f\u5bf9\u4e8e $4$ \u53f7\u8282\u70b9\u5b58\u7684\u8d21\u732e\u662f\u7ea2\u8272\u90e8\u5206\u7ed9\u5b83\u7684,\u4f46\u5b9e\u9645\u5e94\u8be5\u662f\u53ea\u80fd\u6709\u7eff\u8272\u90e8\u5206,\u4e5f\u5c31\u662f\u8bf4\u8981\u51cf\u53bb\u84dd\u8272\u90e8\u5206\u7684\u8d21\u732e,\u518d\u7406\u89e3\u7406\u89e3\u540e\u5c31\u53ef\u4ee5\u5f97\u5230\u4ee5\u4e0b\u5f0f\u5b50:\n\n$$p=f_i+f_{fa}-{\\color{red}\\max\\{f_i-2*VAL_i+val_{i},0\\}}$$\n\n($p$ \u8868\u793a $i,fa$ \u7684\u90e8\u5206\u5bf9\u5f53\u524d\u8fd9\u6b21\u67e5\u8be2\u7684\u8d21\u732e,$fa$ \u662f $i$ \u7684\u7236\u8282\u70b9,$fa,i$ \u90fd\u662f\u67e5\u8be2\u4e24\u4e2a\u70b9\u518d\u6811\u4e0a\u7684\u7b80\u5355\u8def\u5f84\u4e0a\u7684\u70b9($i$ \u4e3a $u$ \u6216 $v$,\u5982\u679c $i\\not= u$ \u4e14 $i\\not= v$,\u90a3\u4e48\u5bf9\u4e8e\u8fd9\u6761\u8def\u5f84\u4e0a\u7684 $i$ \u7684\u5b50\u8282\u70b9\u4e5f\u9700\u8981\u51cf\u53bb\u81ea\u8eab\u5bf9 $i$ \u7684\u8d21\u732e))\n\n\u5176\u4e2d\u7ea2\u8272\u90e8\u5206\u5176\u5b9e\u5c31\u662f $i$ \u5bf9 $fa$ \u7684\u8d21\u732e,\u5c06\u8fd9\u90e8\u5206\u62ce\u51fa\u6765\u5c31\u53d8\u6210\u4e86\u6240\u4ee5\u975e $\\operatorname{LCA}$ \u7684\u8282\u70b9\u90fd\u9700\u8981\u51cf\u53bb\u81ea\u5df1\u4e3a\u6839\u8282\u70b9\u7684\u5b50\u6811\u5bf9\u7236\u8282\u70b9\u7684\u8d21\u732e.\u56e0\u4e3a\u8fd9\u4e2a\u4e1c\u897f\u662f\u56fa\u5b9a\u7684,\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u6811\u4e0a\u5dee\u5206\u5feb\u901f\u8ba1\u7b97.\u8fd9\u6837\u5c31\u53ef\u4ee5\u901a\u8fc7\u8ba1\u7b97\u4e00\u6b21 $\\operatorname{LCA}$ \u7684\u590d\u6742\u5ea6\u8ba1\u7b97\u51fa\u6240\u6709\u8def\u5f84\u8282\u70b9\u7684\u5b50\u6811\u5bf9\u8def\u5f84\u7684\u8d21\u732e.\n\n\u4e0b\u9762\u53ea\u9700\u8981\u8ba1\u7b97\u51fa $\\operatorname{LCA}$ \u7684\u7236\u8282\u70b9\u5bf9\u5b83\u7684\u8d21\u732e\u5373\u53ef,\u53ef\u4ee5\u53d1\u73b0\u8fd9\u4e2a\u4e1c\u897f\u53ef\u4ee5\u6362\u6839 $\\operatorname{dp}$ \u6c42\u51fa:\n\n$$g_i=\\max\\{g_{fa}+f_{fa}+val_{fa}-2*VAL_{i}-\\max\\{f_i-2*VAL_i+val_{i},0\\},0\\}$$\n\n($g_i$ \u8868\u793a $i$ \u7684\u7236\u8282\u70b9\u5bf9 $i$ \u7684\u8d21\u732e,\u5177\u4f53\u63a8\u5bfc\u6bd4\u8f83\u663e\u7136,\u4e0d\u5c55\u5f00)\n\n\u5bf9\u4e8e\u67e5\u8be2\u4e24\u70b9\u7684\u7b80\u5355\u8def\u5f84\u7684\u8d21\u732e\u4e5f\u53ef\u4ee5\u76f4\u63a5\u6811\u4e0a\u5dee\u5206,\u6240\u4ee5\u5355\u6b21\u67e5\u8be2\u7684\u590d\u6742\u5ea6 $=$ \u8ba1\u7b97\u4e24\u70b9 $\\operatorname{LCA}$ \u7684\u590d\u6742\u5ea6.\n\n\u56e0\u4e3a\u4e0d\u4f1a $\\mathcal{Tarjan\\ LCA}$ \u6240\u4ee5\u7528\u4e86\u6811\u5256,\u4f46\u8fd8\u662f\u6bd4\u500d\u589e\u505a\u6cd5\u5feb\u4e86\u4e0d\u5c11.\n\n# \u4ee3\u7801\n\n```cpp\n#include<bits/stdc++.h>\n#define REP(i,first,last) for(int i=first;i<=last;++i)\n#define DOW(i,first,last) for(int i=first;last<=i;--i)\nnamespace IO\n//\u5feb\u8bfb\u6a21\u677f\nusing namespace IO;\nusing namespace std;\nconst int MAXN=3e5+5;\nconst int MAXM=MAXN<<1;\nint n,m;\nlong long val[MAXN];\nstruct Edge\n{\n\tint to,next;\n\tlong long val;\n}edge[MAXM];\nint edge_head[MAXN];\nint edge_cnt=0;\n#define FOR(now) for(int edge_i=edge_head[now];edge_i;edge_i=edge[edge_i].next)\n#define TO edge[edge_i].to\n#define VAL edge[edge_i].val\ninline void AddEdge(int from,int to,long long val)\n{\n\tedge[++edge_cnt].to=to;\n\tedge[edge_cnt].val=val;\n\tedge[edge_cnt].next=edge_head[from];\n\tedge_head[from]=edge_cnt;\n}\nlong long f[MAXN];//f \u540c\u5206\u6790\u4e2d\u7684 f\nlong long sumf[MAXN];//f \u51fd\u6570\u7684\u6811\u4e0a\u524d\u7f00\u548c\nlong long d[MAXN];//\u6bcf\u4e2a\u70b9\u5bf9\u7236\u8282\u70b9\u7684\u8d21\u732e\nlong long sumdec[MAXN];//\u9700\u8981\u51cf\u53bb\u90e8\u5206\u7684\u6811\u4e0a\u524d\u7f00\u548c\nlong long tof[MAXN];//\u6bcf\u4e2a\u70b9\u5230\u7236\u8282\u70b9\u7684\u8fb9\u7684\u8fb9\u6743\nlong long sump[MAXN],sume[MAXN];//\u70b9\u6743\u4e0e\u8fb9\u6743\u7684\u6811\u4e0a\u524d\u7f00\u548c\nlong long g[MAXN];//g \u540c\u5206\u6790\u4e2d\u7684 g\n//\u4ee5\u4e0b\u53d8\u91cf\u4e3a\u6811\u5256\u6240\u9700\u53d8\u91cf\nint point_deep[MAXN];\nint point_father[MAXN];\nint point_son[MAXN];\nint point_size[MAXN];\nint chain_cnt=0;\nint point_id[MAXN];\nint point_val[MAXN];\nint chain_top[MAXN];\n//\u6811\u5256\u90e8\u5206\u4e0d\u4f1a\u505a\u8bf4\u660e,\u5982\u6709\u4e0d\u7406\u89e3\u5efa\u8bae\u5148\u505a\u6a21\u677f\u9898\nvoid DFS_1(int now=1)//\u7b2c\u4e00\u6b21 DFS\n{\n\tsump[now]=sump[point_father[now]]+val[now];//\u6811\u4e0a\u524d\u7f00\u70b9\u6743\n\tint max_size=-1;\n\tpoint_size[now]=1;\n\tFOR(now)\n\t{\n\t\tif(point_father[now]!=TO)\n\t\t{\n\t\t\tpoint_father[TO]=now;\n\t\t\tpoint_deep[TO]=point_deep[now]+1;\n\t\t\ttof[TO]=VAL;\n\t\t\tsume[TO]=sume[now]+VAL;//\u6811\u4e0a\u524d\u7f00\u8fb9\u6743\n\t\t\tDFS_1(TO);\n\t\t\tf[now]+=d[TO];//\u8ba1\u7b97 f\n\t\t\tpoint_size[now]+=point_size[TO];\n\t\t\tif(point_size[TO]>max_size)\n\t\t\t{\n\t\t\t\tmax_size=point_size[TO];\n\t\t\t\tpoint_son[now]=TO;\n\t\t\t}\n\t\t}\n\t}\n\td[now]=max(f[now]-2*tof[now]+val[now],0ll);//\u8ba1\u7b97\u8fd9\u4e2a\u70b9\u5bf9\u7236\u8282\u70b9\u7684\u8d21\u732e\n}\nvoid DFS_2(int now=1,int top=1,long long on=0/*\u4ece\u7236\u8282\u70b9\u8f6c\u79fb\u6765\u7684 gi*/)\n{\n\tg[now]=on;\n\tsumf[now]=sumf[point_father[now]]+f[now];\n\tsumdec[now]=sumdec[point_father[now]]+d[now];\n\tpoint_id[now]=++chain_cnt;\n\tpoint_val[chain_cnt]=val[now];\n\tchain_top[now]=top;\n\tif(!point_son[now])\n\t{\n\t\treturn;\n\t}\n\tDFS_2(point_son[now],top,max(on+f[now]+val[now]-d[point_son[now]]-2*tof[point_son[now]],0ll));\n\tFOR(now)\n\t{\n\t\tif(TO!=point_father[now]&&TO!=point_son[now])\n\t\t{\n\t\t\tDFS_2(TO,TO,max(on+f[now]+val[now]-d[TO]-2*VAL,0ll));\n\t\t}\n\t}\n}\nint LCA(int u,int v)\n{\n\twhile(chain_top[u]!=chain_top[v])\n\t{\n\t\tif(point_deep[chain_top[u]]<point_deep[chain_top[v]])\n\t\t{\n\t\t\tswap(u,v);\n\t\t}\n\t\tu=point_father[chain_top[u]];\n\t}\n\tif(point_deep[v]<point_deep[u])\n\t{\n\t\tswap(u,v);\n\t}\n\treturn u;\n}\nlong long Query(int u,int v)\n{\n\tint lca=LCA(u,v);\n\treturn sumf[u]+sumf[v]-2*sumf[lca]+f[lca]-sumdec[u]-sumdec[v]+2*sumdec[lca]+g[lca]-sume[u]-sume[v]+2*sume[lca]+sump[u]+sump[v]-sump[lca]-sump[point_father[lca]];//\u53c8\u81ed\u53c8\u957f\u7684\u6811\u4e0a\u5dee\u5206\n}\n\nint main()\n{\n\tRead(n,m);\n\tREP(i,1,n)\n\t{\n\t\tRead(val[i]);\n\t}\n\tint u,v,w;\n\tREP(i,1,n-1)\n\t{\n\t\tRead(u,v,w);\n\t\tAddEdge(u,v,w);\n\t\tAddEdge(v,u,w);\n\t}\n\tDFS_1();\n\tDFS_2();\n\tREP(i,1,m)\n\t{\n\t\tRead(u,v);\n\t\tWriteln(Query(u,v));\n\t}\n\treturn 0;\n}\n```\n\n",
        "postTime": 1602853590,
        "uid": 86625,
        "name": "Limit",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 CF1000G \u3010Two-Paths\u3011"
    },
    {
        "content": "# CF1000G Two-Paths \u9898\u89e3\n\n## \u9898\u610f\n\n\u7ed9\u5b9a\u4e00\u9897\u6811\uff0c\u8be2\u95ee\u4e00\u6761\u4ee5 `u`,`v` \u4e3a\u8d77\u70b9\u4e0e\u91cd\u70b9\u7684\u8def\u5f84\u7684  \u70b9\u6743\u548c-\u8fb9\u6743\u548c\uff0c\n\u6bcf\u6761\u8fb9\u6700\u591a\u7ecf\u8fc7\u4e24\u6b21\uff0c\u70b9\u6743\u4ec5\u80fd\u7b97\u4e00\u6b21\u6240\u80fd\u5f97\u5230\u7684\u6700\u5927\u503c\u3002\n\n## \u601d\u8def\uff1a\u6362\u6839DP\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/dw13y5w1.png)\n\n\u9996\u5148\u5bf9\u4e8e\u4e0a\u9762\u8fd9\u4e2a\u56fe\uff0c\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u6574\u4e2a\u8def\u5f84\u7684\u7279\u5f81\uff0c**\u8fb9\u7684\u7f16\u53f7\u8868\u793a\u4e00\u79cd\u53ef\u80fd\u7684\u904d\u5386\u987a\u5e8f**\uff1a\n\n1.\uff08\u5176\u5b9e\u53ef\u4ee5\u5148\u904d\u5386 `u` \u7684\u5b50\u6811\uff0c\u53ea\u4e0d\u8fc7\u56fe\u4e2d\u672a\u753b\u51fa\u3002\uff09\n\n2.\u5728 `u` \u5230 `LCA` \u7684\u8def\u5f84\u4e0a\u7684\u4e00\u70b9 `x` \uff0c\u53ef\u4ee5\u9009\u62e9\u904d\u5386\u5b8c `x` \u7684\u5b50\u6811\u540e\u518d\u5f80 `x` \u7684\u7236\u4eb2\u8d70\u3002\n\n3.\u5230\u8fbe\u4e86 `LCA` \u540e\uff0c\u53ef\u4ee5\u9009\u62e9\u904d\u5386\u5b8c `LCA` \u7684\u5b50\u6811\u540e\u518d\u904d\u5386 `LCA` \u5411\u4e0a\u7684\u90a3\u4e00\u90e8\u5206\u3002\n\n4.\u4ece `LCA` \u5230 `v` \u7684\u8def\u5f84\u4e0a\u4e00\u70b9 `x` \u53ef\u4ee5\u9009\u62e9\u904d\u5386\u5b8c  `x`  \u9664\u4e86\u5411 `v` \u7684\u90a3\u4e00\u90e8\u5206\u5728\u5411 `v` \u90a3\u8fb9\u8d70.\n\n--------\n\u4e8e\u662f\u8bbe\u4e00\u4e2a`dp` \u65b9\u7a0b `dp[x][0]` \u4e0e `dp[x][1]` \n\n`dp[x][0]` \u8868\u793a\u4ece `x` \u5f80\u4e0b\u8d70\u6700\u7ec8\u56de\u5230 `x ` \u7684\u6700\u5927\u4ef7\u503c\u3002\n\n`dp[x][1]` \u8868\u793a\u4ece `x` \u968f\u4fbf\u8d70\uff08\u5373\u4ee5 `x` \u4e3a\u51fa\u53d1\u70b9\u7684\u5168\u5c40\u6700\u5927\u503c\uff09\uff0c\u6700\u7ec8\u56de\u5230 `x` \u7684\u6700\u5927\u4ef7\u503c\u3002\n\n**PS:\u4e0a\u6587\u7684\u904d\u5386\u662f\u5728\u6700\u4f18\u9009\u62e9\u4e0b\u7684\u904d\u5386\uff0c\u5e76\u4e0d\u662f\u5168\u90e8\u904d\u5386\u5b8c\u7684\u610f\u601d\u3002**\n\n ## DP\u7684\u8f6c\u79fb\uff1a\n\n\u4ec5\u4ec5\u9009\u62e9\u5b50\u6811\u7684\u8bdd\u5f88\u7b80\u5355\uff0c\u8bbe\u5f53\u524d\u70b9\u4e3a `u` , \u51fa\u70b9\u4e3a `v` \u3002\n\n\u5982\u679c\u5f53\u524d `u` \u6700\u4f18\u53ef\u4ee5\u9009\u62e9 `v` \uff0c\u4e00\u5b9a\u662f\u53ef\u4ee5\u83b7\u5f97\u7684\u4ef7\u503c >0 \uff0c\u5373 `dp[v][0]-edge[i]-edge[i^1]` \uff0c`edge[i]` \u8868\u793a\u8fd9\u6761\u8fb9\uff0c\u800c`edge[i^1]` \u5c31\u662f\u8fd9\u6761\u8fb9\u7684\u53cd\u8fb9\u3002\uff08\u56e0\u4e3a\u8fc7\u53bb\u8fd8\u8981\u56de\u6765\uff0c\u6240\u4ee5\u662f\u8fd9\u4e2a\u4ee3\u4ef7\uff09\n\n\u4e8e\u662f\u65b9\u7a0b\u4e5f\u5f88\u7b80\u5355\uff1a`dp[u][0]` \u7684\u521d\u59cb\u503c\u9996\u5148\u8bbe\u4e3a `a[x]` \u7136\u540e `dp[x][0]+=max(0,dp[y][0]-edge[i]-edge[i^1])`\n\n\u4e5f\u5c31\u662f\u4e00\u4e2a\u7b80\u5355\u7684 `Dfs` \u53ef\u4ee5\u89e3\u51b3\u3002\n\n\u800c `dp[u][1]` \u4ec5\u4ec5\u9700\u8981\u4e00\u4e2a\u6362\u6839\u5c31\u89e3\u51b3\u4e86\u3002\n\n\u4f46\u662f\u6ce8\u610f\u8f6c\u79fb\u65f6\uff0c\u56e0\u4e3a `dp[u][1]` \u8868\u793a\u7684\u662f\u5168\u5c40\uff0c\u53ef\u80fd\u4f1a\u5bf9 `dp[v][1]` \u4ea7\u751f\u91cd\u590d\u8ba1\u7b97\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u9700\u8981\u526a\u6389\u91cd\u590d\u8ba1\u7b97\u7684\u90e8\u5206\uff0c\u5373 `dp[v][0]` \uff0c\u5f53\u7136\uff0c`dp[v][0]` \u53ef\u80fd\u5bf9 `dp[u][1]` \u65e0\u8d21\u732e\u3002\u8ba1\u7b97\u4e00\u4e0b\u662f\u5426 `dp[v][0]-edge[i]-edge[i^1]` \u662f\u5426>0\u5373\u53ef\uff0c\u8f6c\u79fb\u65f6\u540c\u6837\u8ba1\u7b97 `dp[u][1]` \u662f\u5426\u53ef\u4ee5\u5bf9\u5b83\u7684\u4ea7\u751f\u8d21\u732e\uff0c\u4e5f\u5c31\u662f\u9664\u53bb\u91cd\u590d\u7684\u8d21\u732e\u540e\u518d\u526a\u6389\u4e24\u4e2a\u8fb9\u7684\u8fb9\u6743\uff0c\u5177\u4f53\u53ef\u4ee5\u770b\u4ee3\u7801\u3002\n\n\u4e24\u4e2a `Dfs` \u5373\u53ef\u641e\u5b9a\uff0c\u4e00\u6b21\u9884\u5904\u7406\uff0c\u4e00\u6b21\u6362\u6839\u5c31\u53ef\u4ee5\u4e86\u3002\n\n## \u5904\u7406\u7b54\u6848\n\n\u9996\u5148\u53d1\u73b0 `u->LCA->v` \u8fd9\u6761\u8def\u5f84\u662f\u5fc5\u5b9a\u7ecf\u8fc7\u7684\uff0c\u6240\u4ee5\u9884\u5148\u5904\u7406\u51fa\u8fd9\u4e2a\u8fb9\u6743\uff0c\n\n\u8bbe `h(u,v)` \u4e3a `v` \u662f\u5426\u8ba1\u5165 `u` \u7684\u8d21\u732e\uff0c\u5373 $\\max(0,dp[v][0]-e_{u->v}-e_{v->u})$ \n\n\u53d1\u73b0\u6574\u4e2a `u->LCA` \u7684\u4ee3\u4ef7\u53ef\u4ee5\u8868\u793a\u4e3a $\\sum_{i=1}^n dp[u_i][0]-h(fa_{u_i},u_i)$ \uff08\u8fd9\u4e2a\u5f0f\u5b50\u7684\u610f\u601d\u5c31\u662f\u9009\u5b8c\u8def\u5f84\u4e0a\u6bcf\u4e00\u4e2a\u70b9\u7684\u6700\u4f18\u5b50\u6811\u7136\u540e\u526a\u6389\u8fd9\u4e2a\u70b9\u5bf9\u4e8e\u4ed6\u7236\u4eb2\u7684\u91cd\u590d\u8d21\u732e\u3002\n\n\u540c\u7406\u7684`v->LCA` \u7684\u4ee3\u4ef7\u4e5f\u73c2\u4ee5\u7528\u4e00\u4e2a\u7c7b\u4f3c\u7684\u5f0f\u5b50\u8868\u793a\uff0c\u6700\u540e\u52a0\u4e0a `dp[LCA][1]` \u518d\u51cf\u53bb\u8def\u5f84\u8fb9\u6743\u5373\u53ef\u3002\n\n\u7136\u540e\u4e0a\u9762\u7684\u90a3\u4e2a\u5f0f\u5b50\u53ef\u4ee5\u7528\u4e00\u4e2a\u524d\u7f00\u548c\u4f18\u5316\u6389\u3002\u8fd9\u6837\u5c31\u53ef\u4ee5\u76f4\u63a5\u6c42\u51fa\u7b54\u6848\u4e86\u3002\n\n\u7528\u4e86\u6811\u5256\u6c42 `LCA`\uff0c\u4e8e\u662f\u5904\u7406\u8def\u5f84\u7684\u8fb9\u6743\u548c\u4f1a\u5305\u542b\u5728\u4e86\u6811\u5256\u4e2d\u7684 `DFS1` \u91cc\u9762\u3002\n\n### Code:\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\ntemplate <typename T>\ninline void read(T &x){\n\tx=0;char ch=getchar();bool f=false;\n\twhile(!isdigit(ch))\tf|=ch=='-',ch=getchar();\n\twhile(isdigit(ch))\tx=(x<<1)+(x<<3)+(ch^48),ch=getchar();\n\tx=f?-x:x;return;\n}\ntemplate <typename T>\ninline void print(T x){\n\tif(x<0)\tputchar('-'),x=-x;\n\tif(x>9)\tprint(x/10);\n\tputchar(x%10^48);return;\n}\n#define int long long\nconst int N=3e5+3;\nint head[N],to[N<<1],Next[N<<1],edge[N<<1],tot=1,n,a[N],q;\ninline void Addedge(int u,int v,int w){\n\tto[++tot]=v,edge[tot]=w,Next[tot]=head[u],head[u]=tot;\n\treturn;\n}\n//Tree&DP\nint fa[N],siz[N],son[N],dep[N],up[N],down[N];\ninline void Dfs1(int x,int f){\n\tdep[x]=dep[f]+1,siz[x]=1,fa[x]=f;\n\tfor(register int i=head[x];i;i=Next[i]){\n\t\tint y=to[i];if(y==f)\tcontinue;\n\t\tdown[y]=down[x]+edge[i],up[y]=up[x]+edge[i^1];\n\t\tDfs1(y,x);siz[x]+=siz[y];\n\t\tson[x]=siz[son[x]]<siz[y] ? y :son[x];\n\t}\n\treturn;\n}\nint top[N];\ninline void Dfs2(int x){\n\ttop[x]=son[fa[x]]==x ? top[fa[x]] : x;\n\tif(son[x])\tDfs2(son[x]);\n\tfor(register int i=head[x];i;i=Next[i]){\n\t\tint y=to[i];\n\t\tif(y==fa[x]||y==son[x])\tcontinue;\n\t\tDfs2(y);\n\t}\n\treturn;\n}\ninline int LCA(int u,int v){\n\twhile(top[u]!=top[v]){\n\t\tif(dep[top[u]]>dep[top[v]]) u=fa[top[u]];\n\t\telse v=fa[top[v]];\n\t}\n\treturn dep[u]>dep[v] ? v: u;\n}\n//DP\nint dp[N][2];\ninline int Get(int v,int i){return dp[v][0]-edge[i]-edge[i^1];}\nint g[N];\ninline void Dfs(int x){\n\tdp[x][0]=a[x];\n\tfor(register int i=head[x];i;i=Next[i]){\n\t\tint y=to[i];\n\t\tif(y==fa[x])\tcontinue;\n\t\tDfs(y);\n\t\tif(Get(y,i)>0)\tdp[x][0]+=Get(y,i);\n\t}\n\treturn;\n}\ninline void Croot(int x){\n\tfor(register int i=head[x];i;i=Next[i]){\n\t\tint y=to[i];\n\t\tif(y==fa[x])\tcontinue;\n\t\tint tmp=0;if(Get(y,i)>0)\ttmp=Get(y,i);\n\t\tif(dp[x][1]-tmp-edge[i]-edge[i^1]>0) dp[y][1]=dp[y][0]+dp[x][1]-tmp-edge[i]-edge[i^1];\n\t\telse dp[y][1]=dp[y][0];\n\t\tg[y]=g[x]+dp[y][0]-tmp;\n\t\tCroot(y);\n\t}\n\treturn;\n}\n\nsigned main(){\n\tread(n),read(q);\n\tfor(register int i=1;i<=n;++i)\tread(a[i]);\n\tfor(register int i=1;i<n;++i){\n\t\tint x,y,z1,z2;read(x),read(y),read(z1),z2=z1;\n\t\tAddedge(x,y,z1),Addedge(y,x,z2);\n\t}\n\tDfs1(1,0),Dfs2(1);\n\tDfs(1);dp[1][1]=dp[1][0];Croot(1);\n\twhile(q--){\n\t\tint u,v;read(u),read(v);\n\t\tint l=LCA(u,v);\n\t\tint ans1=up[u]-up[l]+down[v]-down[l],ans2=g[u]+g[v]-2*g[l]+dp[l][1];\n\t\tprint(ans2-ans1),putchar('\\n');\n\t}\n\treturn 0;\n}\n\n```\n\n",
        "postTime": 1627175872,
        "uid": 67621,
        "name": "NuoCarter",
        "ccfLevel": 7,
        "title": "CF1000G Two-Paths \u9898\u89e3"
    },
    {
        "content": "\u4ee3\u7801\u5176\u5b9e\u662f [LOJ6699](https://loj.ac/p/6699) \u7a0d\u5fae\u6539\u4e86\u4e00\u4e0b\u3002\n\n\u8fd9\u4e2a\u9898\u7b80\u76f4\u662f\u4ee4\u4eba\u65e0\u8bed\u3002\n\n\u9996\u5148 2-Path \u8fd9\u79cd\u5b9a\u4e49\u5c31\u6709\u591f\u65e0\u8bed\u4e86\u3002\u663e\u7136\u6700\u4f18\u60c5\u51b5\u4e0b\uff0c\u4e0d\u5728\u8def\u5f84\u4e0a\u7684\u8fb9\u53ea\u4f1a\u987a\u5411\u8d70\u4e00\u6b21\uff0c\u5176\u4ed6\u7684\u8fb9\u6700\u591a\u8d70\u4e24\u6b21\u3002\n\n\u6211\u4eec\u7ef4\u62a4\u4e09\u4e2a\u6570\u7ec4 $f,g,h$\u3002\u5206\u522b\u8868\u793a\uff1a\n\n- $f_i$\uff1a\u5728\u4ee5 $1$ \u4e3a\u6839\u7684\u6811\u4e2d\uff0c\u4ece $i$ \u5f00\u59cb\u53ea\u5728\u4ee5 $i$ \u4e3a\u6839\u7684\u5b50\u6811\u4e2d\u8d70\u7684\u6700\u5927\u7684\u8d21\u732e\uff1b   \n- $g_i$\uff1a\u5728\u4ee5 $1$ \u4e3a\u6839\u7684\u6811\u4e2d\uff0c\u4ece $i$ \u7684\u7236\u4eb2 $p$ \u5f00\u59cb\uff0c\u53ea\u5728\u4ee5 $p$ \u4e3a\u6839\u7684\u5b50\u6811\u4e2d\u8d70\u5e76\u4e14\u4e0d\u7ecf\u8fc7 $i$ \u7684\u6700\u5927\u7684\u8d21\u732e\uff1b   \n- $h_i$\uff1a\u4ee5 $i$ \u4e3a\u8d77\u70b9\u4e0d\u52a0\u5176\u4ed6\u9650\u5236\u7684\u6700\u5927\u7684\u8d21\u732e\u3002\n\n\u8003\u8651\u8ba1\u7b97 $f_i$\u3002\u663e\u7136\u4e00\u4e2a\u5b50\u6811\u53ea\u6709\u7ecf\u8fc7\u6216\u8005\u4e0d\u7ecf\u8fc7\u4e24\u79cd\u53ef\u80fd\uff0c\u4e24\u79cd\u60c5\u51b5\u53d6 $\\max$\u3002\n\n\u5728\u5904\u7406 $f_i$ \u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5904\u7406\u6240\u6709 $x \\in \\operatorname{son}_i$ \u7684 $g_x$\u3002\u65b9\u6cd5\u662f\u8981\u4e48\u8d70\u8fd8\u662f\u4e0d\u8d70\uff0c\u76f8\u5f53\u4e8e\u9664\u53bb\u8ba1\u7b97 $f_i$ \u7684\u65f6\u5019\uff0c$g_x$ \u7684\u8d21\u732e\u3002\n\n\u7136\u540e\u8981\u5f04\u51fa $h_i$ \u51fa\u6765\u3002\u8fd9\u662f\u663e\u7136\u7684\u6362\u6839 dp\uff0c\u65b9\u6cd5\u662f\uff1a\n\n- \u5982\u679c\u5f53\u524d\u7ed3\u70b9 $p$ \u662f $1$\uff0c$h_p \\gets f_p$\uff1b   \n- \u5426\u5219\uff0c\u6211\u4eec\u5c06\u5176\u7236\u4eb2\u7ed3\u70b9 $q$ \u7684 $h$ \u503c\u5148\u51cf\u53bb\u5f53\u524d\u5b50\u6811\u5728 $f_q$ \u4e2d\u7684\u8d21\u732e\u51cf\u53bb\u5728 $p,q$ \u95f4\u5f80\u8fd4\u4e00\u6b21\u7684\u82b1\u8d39\u4f5c\u4e3a $p$ \u5f80 $q$ \u8d70\u7684\u8d21\u732e\uff0c\u7136\u540e\u518d\u52a0\u4e0a $f_p$ \u5c31\u53ef\u4ee5\u7b97\u51fa $h_p$\u3002\n\n\u6700\u540e\u9700\u8981\u8ba1\u7b97\u7b54\u6848\u3002\u6ce8\u610f\u5230\u6211\u4eec\u9884\u5904\u7406\u4e86\u5f88\u591a\u4e1c\u897f\uff0c\u4f46\u662f\u6211\u4eec\u8fd8\u662f\u9700\u8981\u5206\u7c7b\u8ba8\u8bba\u2026\u2026\n\n\u4ee4 $u,v$ \u4e3a\u8be2\u95ee\u7684\u70b9\uff0c$p$ \u4e3a\u4e24\u70b9\u95f4 LCA\uff0c$u'$ \u4e3a $p$ \u5411 $u$ \u8d70\u4e00\u6b65\u7684\u70b9\uff0c$v'$ \u540c\u7406\u3002\u8fd9\u4e9b\u4e1c\u897f\u53ef\u4ee5\u9884\u5904\u7406\u500d\u589e\u6570\u7ec4\uff0c\u7b97 $u'$ \u53ef\u4ee5\u500d\u589e\u6c42\u51fa $u,p$ \u95f4\u8ddd\u79bb\uff0c\u51cf\u53bb\u4e00\u540e\u518d\u4ece $u$ \u500d\u589e\u8df3\u3002\uff08\u867d\u7136\u4f46\u662f\uff0c\u597d\u6df1\u6bd4\u554a\u3002\uff09\n\n- \u5982\u679c $u=v$\uff1a\u8f93\u51fa $h_u$\uff1b   \n- \u5982\u679c $u,v$ \u5728\u540c\u4e00\u6761\u94fe\u4e0a\uff08\u5373\uff0c\u4e24\u70b9 LCA \u4e3a\u4e24\u70b9\u4e4b\u4e00\uff09\uff1a\u5148\u786e\u5b9a\u8c01\u5728\u4e0a\u9762\u8c01\u5728\u4e0b\u9762\uff08\u5728\u8fd9\u4e2a\u9898\u91cc\u9762\u5176\u5b9e\u4e0d\u592a\u9700\u8981\uff09\uff0c\u8fd9\u91cc\u5047\u8bbe $u$ \u5728\u4e0b\u9762\u3002\u5206\u6790\u53d1\u73b0\uff0c$u$ \u53ef\u4ee5\u5f80\u5176\u5b50\u6811\u8d70\uff0c$p$ \u53ef\u4ee5\u5f80\u4e0a\u8d70\uff0c\u4f46\u662f\u8981\u6392\u53bb\u5411 $u'$ \u8d70\u7684\u8d21\u732e\u3002\u7b54\u6848\u5c31\u662f $u \\to u'$ \u4e0a\u6240\u6709\u7ed3\u70b9\u7684 $g$ \u503c\uff0c\u52a0\u4e0a $f_u$ \u503c\uff0c\u52a0\u4e0a $h_p$ \u5e76\u51cf\u53bb $g_{u'}$ \u5728 $h_p$ \u5185\u7684\u8d21\u732e\uff0c\u6700\u540e\u51cf\u53bb $u \\to v$ \u8def\u5f84\u4e0a\u6240\u6709\u8fb9\u7684\u82b1\u8d39\u52a0\u4e0a\u5e94\u6709\u7684\u70b9\u7684\u8d21\u732e\uff08\u70b9\u6743\u5177\u4f53\u5b9e\u73b0\u65b9\u6cd5\u5177\u4f53\u5904\u7406\uff0c\u539f\u56e0\u662f\u6211\u4eec\u53ef\u80fd\u5df2\u7ecf\u5728 $f,g,h$ \u91cc\u9762\u7b97\u4e86\u70b9\u7684\u8d21\u732e\uff09\uff1b   \n- \u5426\u5219\uff0c\u6211\u4eec\u5c06\u8def\u5f84\u62c6\u6210\u4e24\u6761\u94fe $u\\to u',v \\to v'$ \u5e76\u4e14\u7279\u6b8a\u5904\u7406 $p$\u3002\u6cbf\u7528\u4e0a\u9762\u7684\u65b9\u6cd5\u5c31\u884c\uff0c\u6709\u4e00\u4e9b\u591a\u4f59\u7684\u7ec6\u8282\u3002\n\n\u7ec6\u8282\u5f88\u591a\uff0c\u63a8\u8350\u770b\u4ee3\u7801\u3002\u5982\u679c\u611f\u89c9\u6709\u95ee\u9898\u53ef\u4ee5\u770b\u4e00\u4e0b $f(dp),g(dp_1),h(dp_2)$ \u7684\u8ba1\u7b97\u65b9\u5f0f\u3002\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\ntypedef long long LL;\nchar buf[1<<21],*p1=buf,*p2=buf;\n#define getchar() (p1==p2 && (p2=(p1=buf)+fread(buf,1,1<<21,stdin),p1==p2)?EOF:*p1++)\nLL read()\n{\n\tLL x=0,f=1;\n\tchar c=getchar();\n\twhile(c<'0' || c>'9')\tf=(c=='-'?-1:f),c=getchar();\n\twhile(c>='0' && c<='9')\tx=(x<<1)+(x<<3)+(c^'0'),c=getchar();\n\treturn x*f;\n}\nvoid write(LL x)\n{\n\tif(x<0)\tputchar('-'),x=-x;\n\tif(x>9)\twrite(x/10);\n\tputchar(x%10+'0');\n}\nvector<LL> G[300005];\nLL n,a[300005],sum[300005],sd[300005],U[300005],V[300005],Z1[300005],Z2[300005],dep[300005],fa[19][300005],lgs[300005],sz1[300005],sz2[300005],dp[300005],dp1[300005],dp2[300005],rev[300005];\nvoid dfs(LL now,LL pre)\n{\n\tfa[0][now]=pre;\n\tdep[now]=dep[pre]+1;\n\tfor(auto st:G[now])\tif(st^pre)\tdfs(st,now);\n}\nLL LCA(LL u,LL v)\n{\n\tif(dep[u]>dep[v])\tswap(u,v);\n\twhile(dep[u]<dep[v])\tv=fa[lgs[dep[v]-dep[u]]][v];\n\tif(u==v)\treturn u;\n\tfor(LL i=18;~i;--i)\tif(fa[i][u]!=fa[i][v])\tu=fa[i][u],v=fa[i][v];\n\treturn fa[0][u];\n}\nLL queKth(LL u,LL ac)\n{\n\tLL ret=0;\n\tfor(LL i=18;~i;--i)\tif(dep[fa[i][u]]>=dep[ac])\tu=fa[i][u],ret|=(1<<i);\n\treturn ret;\n}\nLL getKth(LL u,LL kt)\n{\n\tfor(LL i=18;~i;--i)\tif((kt>>i)&1)\tu=fa[i][u];\n\treturn u;\n}\nvoid dfs1(LL now,LL pre)\n{\n\tsum[now]=dp[now]=a[now];\n\tfor(auto st:G[now])\tif(st^pre)\tdfs1(st,now);\n\tfor(auto st:G[now])\tif(st^pre)\tdp[now]+=max(dp[st]-Z1[rev[st]]-Z2[rev[st]],0ll);\n\tfor(auto st:G[now])\tif(st^pre)\tsd[st]=dp1[st]=dp[now]-max(dp[st]-Z1[rev[st]]-Z2[rev[st]],0ll)-a[now];\n}\nvoid dfs2(LL now,LL pre)\n{\n\tif(!pre)\tdp2[now]=dp[now];\n\telse\tdp2[now]=max(0ll,dp2[pre]-max(dp[now]-Z1[rev[now]]-Z2[rev[now]],0ll)-Z1[rev[now]]-Z2[rev[now]])+dp[now];\n\tfor(auto st:G[now])\tif(st^pre)\tdfs2(st,now);\n}\nvoid maintain(LL now,LL pre){for(auto st:G[now])\tif(st^pre)\tsum[st]+=sum[now],sd[st]+=sd[now],sz1[st]+=sz1[now],sz2[st]+=sz2[now],maintain(st,now);}\nint main(){\n\tn=read();\n\tLL q=read();\n\tfor(LL i=1;i<=n;++i)\ta[i]=read();\n\tfor(LL i=1;i<n;++i)\tU[i]=read(),V[i]=read(),Z1[i]=Z2[i]=read(),G[U[i]].push_back(V[i]),G[V[i]].push_back(U[i]);\n\tdfs(1,0);\n\tfor(LL i=1;i<n;++i)\tif(dep[U[i]]<dep[V[i]])\tswap(U[i],V[i]),swap(Z1[i],Z2[i]);\n\tfor(LL i=1;i<=18;++i)\tfor(LL j=1;j<=n;++j)\tfa[i][j]=fa[i-1][fa[i-1][j]];\n\tfor(LL i=2;i<=n;++i)\tlgs[i]=lgs[i>>1]+1;\n\tfor(LL i=1;i<n;++i)\trev[U[i]]=i,sz1[U[i]]=Z1[i],sz2[U[i]]=Z2[i];\n\tdfs1(1,0);\n\tdfs2(1,0);\n\tmaintain(1,0);\n\twhile(q-->0)\n\t{\n\t\tLL u=read(),v=read(),lca=LCA(u,v);\n\t\tif(u==v)\twrite(dp2[u]),puts(\"\");\n\t\telse if(u!=lca && v!=lca)\n\t\t{\n\t\t\tLL disu=queKth(u,lca),disv=queKth(v,lca);\n\t\t\t--disu,--disv;\n\t\t\tLL xu=getKth(u,disu),xv=getKth(v,disv);\n\t\t\tLL ans=dp[u]+dp[v]-a[u]-a[v]-a[lca]+sum[u]+sum[v]-sum[lca]-sum[fa[0][lca]]+sd[u]+sd[v]-sd[xu]-sd[xv]+dp2[lca]-max(0ll,dp[xu]-Z1[rev[xu]]-Z2[rev[xu]])-max(0ll,dp[xv]-Z1[rev[xv]]-Z2[rev[xv]])-sz1[u]-sz2[v]+sz1[lca]+sz2[lca];\n\t\t\twrite(ans),puts(\"\");\n\t\t}\n\t\telse\n\t\t{\n\t\t\tLL down=dep[u]>dep[v]?u:v;\n\t\t\tLL disu=queKth(down,lca);\n\t\t\t--disu;\n\t\t\tLL xu=getKth(down,disu);\n\t\t\tLL ans=dp[down]-a[down]+sd[down]-sd[xu]+dp2[lca]-max(0ll,dp[xu]-Z1[rev[xu]]-Z2[rev[xu]]);\n\t\t\tif(down==u)\tans-=sz1[u]-sz1[v];\n\t\t\telse\tans-=sz2[v]-sz2[u];\n\t\t\tans+=sum[down]-sum[fa[0][lca]];\n\t\t\tans-=a[lca];\n\t\t\twrite(ans),puts(\"\");\n\t\t}\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1631785857,
        "uid": 184977,
        "name": "pomelo_nene",
        "ccfLevel": 9,
        "title": "\u2162\u222a\u5410"
    },
    {
        "content": "[link](https://www.luogu.com.cn/problem/CF1000G)\r\n\r\n\u987a\u7740 [loj6699](https://loj.ac/p/6699) \u8fc7\u6765\u7684\uff0c\u4e0d\u96be\u53d1\u73b0 loj \u90a3\u9898\u662f\u5728\u8fd9\u9898\u7684\u52a0\u5f3a\u7248\uff0c\u90a3\u4e48\u76f4\u63a5\u7ed9\u51fa loj \u7684\u505a\u6cd5\u3002\r\n\r\n\u8bbe $w(x, y)$ \u5206\u522b\u4e3a $x \\to y$ \u7684\u8fb9\u6743\u548c\uff0c$f_x$ \u4e3a\u5728 $x$ \u5b50\u6811\u4e2d\u8d70\u4e00\u904d\u5e76\u56de\u5230 $x$ \u7684\u6700\u4f18\u4ef7\u503c\u3002\r\n\r\n\u90a3\u4e48\u6709 $f_x=a_x+\\sum_{(x, y)\\in T} \\max(0, f_y-w(x, y)-w(y, x))$\u3002\r\n\r\n\u8bbe\u4e0a\u5f0f $y$ \u5bf9 $x$ \u7684\u8d21\u732e\u4e3a $g_x$\u3002\r\n\r\n\u8bbe\u6240\u6c42\u4e3a $h(u, v)$ \u62c6\u6210\u4e24\u6761\u8def\u5f84\uff0c\u53d8\u4e3a $h(u, \\operatorname{LCA})+h(\\operatorname{LCA}, v)+D(\\operatorname{LCA})$\uff0c\u5176\u4e2d $D(\\operatorname{LCA})$ \u4e3a $\\operatorname{LCA}$ \u5904\u989d\u5916\u7684\u8d21\u732e\u3002\r\n\r\n\u8003\u8651\u4e00\u6761\u6700\u4f18\u8def\u5f84 $P(u, v)$\uff0c\u5728\u8d70\u7684\u8fc7\u7a0b\u4e2d\u6211\u4eec\u53ea\u4f1a\u7ecf\u8fc7 $u\\to v$ \u7684\u7b80\u5355\u8def\u5f84\u4e0a\u7684\u8fb9\u4e00\u6b21\uff0c\u5728\u8d70\u5230\u7b80\u5355\u8def\u5f84\u4e0a\u7684\u67d0\u4e2a\u70b9\u65f6\uff0c\u4f1a\u8d70\u5230\u5176\u4ed6\u5b50\u6811\u4e2d\u518d\u6298\u8fd4\u56de\u6765\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c$P(u, v)$ \u4e2d\u9664\u53bb\u7b80\u5355\u8def\u5f84\u4e0a\u7684\u8fb9\u540e\uff0c\u5269\u4e0b\u7684\u8fb9\u90fd\u4ece\u4e24\u4e2a\u65b9\u5411\u5206\u522b\u8d70\u4e86\u4e00\u6b21\uff0c\u76f4\u63a5\u5229\u7528 $g_x$ \u5bb9\u65a5\u6389\u591a\u4f59\u7684\u8d21\u732e\u5373\u53ef\uff0c\u56e0\u6b64\u6709\uff1a\r\n\r\n$$h(x, anc)=-w(x, anc)+g_{anc}+\\sum_{v\\in P(x, anc)} f_v-g_v$$\r\n\r\n$$h(anc, x)=-w(anc, x)+g_{anc}+\\sum_{v\\in P(x, anc)} f_v-g_v$$\r\n\r\n\u5176\u4e2d $anc$ \u662f $x$ \u7684\u7956\u5148\u3002\r\n\r\n\u8003\u8651\u6c42 $D(\\operatorname{LCA})$\uff0c\u9996\u5148 $f_{\\operatorname{LCA}}$ \u88ab\u7b97\u4e86\u4e24\u6b21\uff0c\u51cf\u53bb\u4e00\u4e2a\u3002\r\n\r\n\u4ece $\\operatorname{LCA}$ \u53ef\u4ee5\u5411\u5b50\u6811\u5916\u8d70\uff0c\u8bbe $r_x$ \u4e3a\u53ea\u8d70 $x$ \u5b50\u6811\u5916\u540e\u56de\u5230 $x$ \u7684\u6700\u4f18\u6743\u503c\u3002\r\n\r\n\u90a3\u4e48\u6709 \r\n\r\n\r\n\r\n$$r_x=a_x+\\max(0, r_{fa_x}-w(x, fa_x)-w(fa_x, x)+\\sum_{(fa_x, y)\\in T\\wedge x\\ne y} \\max(0, f_y-w(fa_x, y)-w(x, fa_x)))$$\r\n\r\n\u7136\u540e\u53d1\u73b0\u540e\u9762\u90a3\u4e1c\u897f\u5c31\u662f $f_{fa_x}-a_{fa_x}-g_x$\uff0c\u6240\u4ee5\r\n\r\n$$r_x=a_x+\\max(0, r_{fa_x}-w(x, fa_x)-w(fa_x, x)+f_{fa_x}-a_{fa_x}-g_x)$$\r\n\r\n\u90a3\u4e48\u76f4\u63a5\u9884\u5904\u7406\u51fa $f, g, r, dis$ \u548c $f_x-g_x$ \u7684\u524d\u7f00\u548c\u5373\u53ef\uff0c\u590d\u6742\u5ea6\u4e3a $O(n\\log n+m)$\uff0c\u74f6\u9888\u5728\u4e8e\u6c42 $\\operatorname{LCA}$\u3002\r\n\r\n[code](https://loj.ac/s/1693048)\r\n\r\n",
        "postTime": 1675481730,
        "uid": 341102,
        "name": "ReKoJ",
        "ccfLevel": 0,
        "title": "CF1000G  Two-Paths"
    },
    {
        "content": "\u8fd9\u662f\u4e00\u79cd\u65e2\u9700\u8981\u79bb\u7ebf\u8dd1\u5f97\u8fd8\u975e\u5e38\u6162\u7684\u6811\u72b6\u6570\u7ec4\u505a\u6cd5\u3002\n\n\n\n\u4ee4$dp_i$\u8868\u793a\u4e00\u4e9b`2-path`\u4ece$i$\u53f7\u70b9\u5f00\u59cb\u53c8\u4ee5$i$\u53f7\u70b9\u7ed3\u675f\u7684\u6700\u5927\u6536\u76ca\u3002\n\n\u4ee4$f_i$\u8868\u793a\u53ea\u80fd\u4ece$i$\u7684\u5b50\u6811\u8d70\u7684\u6700\u5927\u6536\u76ca\u3002\n\n$f_i$\u7684\u8f6c\u79fb\u76f8\u5bf9\u597d\u60f3\uff0c\u5373\u679a\u4e3e\u5b83\u7684\u6240\u6709\u513f\u5b50\uff0c\u7136\u540e\u9009\u6216\u4e0d\u9009\u5373\u53ef\u3002\n$$\nf_u=a_u+\\sum_{v\\in son(u)} \\max(0,f_v-2\\cdot w(u,v))\n$$\n\u7136\u540e\u8003\u8651\u8ba1\u7b97$dp_i$\uff0c\u4e0e$f$\u7684\u8f6c\u79fb\u4e0d\u540c\u7684\u662f\u5b83\u4e0d\u4ec5\u53ef\u4ee5\u4ece\u5b83\u7684\u513f\u5b50\u8f6c\u79fb\u8fc7\u6765\uff0c\u5b83\u8fd8\u53ef\u4ee5\u4ece\u5b83\u7684\u7236\u4eb2\u8f6c\u79fb\u8fc7\u6765\n$$\ndp_u=a_u+\\sum_{v\\in Neighbour(u)} \\max(0,f_v-2\\cdot w(u,v))\n$$\n\u4f46\u662f\u663e\u7136\u8fd9\u6837\u76f4\u63a5\u8f6c\u79fb\u4e00\u6761\u8fb9\u7684\u8d21\u732e\u4f1a\u7b97\u591a\u6b21\uff0c\u6240\u4ee5\u8981\u5254\u9664\u539f\u5148\u81ea\u5df1\u7684\u8d21\u732e\uff0c\u6bcf\u6b21\u5f80\u513f\u5b50\u65b9\u5411\u8f6c\u79fb\u65f6\u8bb0\u5f55\u6240\u6709\u7684$\\max(0,f_v-2\\cdot w(u,v))$\u4e22\u5230$dv(u,v)$\u4e2d\uff0c\u5e76\u66f4\u65b0$f_u=dp_u-\\max(0,f_v-2\\cdot w(u,v))$\u3002\n\n\u7136\u540e\u8003\u8651\u5904\u7406\u6240\u6709\u7684\u8be2\u95ee\n\n\u4e3a\u4e86\u53d6\u5f97\u6700\u5927\u6536\u76ca\uff0c\u4e00\u6761\u8def\u5f84$(u,v)$\u4e00\u5b9a\u662f\u5728\u4e24\u70b9\u7684\u7b80\u5355\u8def\u5f84\u57fa\u7840\u4e0a\u8d70\u4e00\u4e9b\u5176\u4ed6\u5e76\u4e0d\u662f\u7b80\u5355\u8def\u5f84\u4e0a\u7684\u8fb9\u7136\u540e\u8fd4\u56de\u53d6\u5f97\u7684\u3002\n\n\u7531\u4e8e\u5df2\u7ecf\u9884\u5904\u7406\u51fa\u4e86$dp$\u548c$dv$\uff0c\u5047\u8bbe\u8981\u6c42\u51fa$(u,u)$\u7684`2-path`\u5e76\u4e14\u4e0d\u80fd\u8d70$(u,v_1),(u,v_2)$\u7684\u6700\u5927\u6536\u76ca\uff0c\u663e\u7136\u4e3a$dp_u-dv(u,v_1)-dv(u,v_2)$\u3002\n\n\u6240\u4ee5\u5bf9\u4e8e\u6bcf\u4e2a\u8be2\u95ee$(qu,qv)$\uff0c\u4ee4$l=\\operatorname{lca}(qu,qv)$\uff0c\u53ef\u4ee5\u5c06\u8be2\u95ee\u62c6\u6210$(qu,l),(qv,l)$\u3002\n\n\u8003\u8651\u5c06\u6240\u6709\u8be2\u95ee\u79bb\u7ebf\u4e0b\u6765\uff0c\u7136\u540e\u8fdb\u884c\u4e00\u6b21dfs\uff0c\u5e76\u4e14\u7ef4\u62a4\u4e00\u4e2a\u652f\u6301\u5355\u70b9\u4fee\u6539\u7684\u6570\u636e\u7ed3\u6784\uff08\u5982\u6811\u72b6\u6570\u7ec4\uff09\u3002\n\n\u5f53\u5230\u8fbe\u70b9$u$\u65f6\uff0c\u5728$dep(u)$\u5904\u589e\u52a0$dp_u-dv(v,fa_v)$\uff0c\u5e76\u4e14\u5728\u56de\u6eaf\u65f6\u6ce8\u610f\u5220\u9664\u3002\n\n\u800c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u8be2\u95ee$(u,l)$\uff0c\u663e\u7136\u6700\u5927\u5229\u76ca\u4e3a$[dep_l,dep_u]$\u7684\u548c\uff08\u6ce8\u610f\u8fd9\u91cc\u8fd8\u8981\u5904\u7406\u597d$l$\u5904\u7684\u503c\uff09\n\n\u5f53\u4ece$u$\u8f6c\u79fb\u5230$v$\u65f6\uff0c\u9700\u8981\u5220\u9664\u5728$dep_u$\u5904\u5220\u9664$dv(u,v)$\u7684\u503c\uff08\u8fd9\u91cc\u53ef\u4ee5\u76f4\u63a5\u51cf\u53bb$w(u,v)$\uff09\n\n\u5177\u4f53\u5b9e\u73b0\u53ef\u4ee5\u89c1\u4ee3\u7801\n\n\u65f6\u95f4\u590d\u6742\u5ea6$O((n+m)\\log n)$\n\n```c++\nconst int N=4e5+10;\nint n,m;\nint a[N];\nvector<pii>e[N],qs[N];\nint dep[N];\nll f[N],dp[N];\nint st[22][1111111],fa[N],tim,bg[N];\nll ans[N];\nint Lg[1111111];\nvector<ll>dv[N];\nvoid dfs1(int u)\n{\n\tbg[u]=++tim;\n\tst[0][tim]=u;\n\tf[u]+=a[u];\n\tint v;\n\tfor(auto qwq:e[u])\n\t{\n\t\tv=qwq.fi;\n\t\tif(v==fa[u]) continue;\n\t\tfa[v]=u;\n\t\tdep[v]=dep[u]+1;\n\t\tdfs1(v);\n\t\tf[u]+=max(0ll,f[v]-2ll*qwq.se);\n\t\tst[0][++tim]=u;\n\t}\n}\nvoid dfs2(int u)\n{\n\tdp[u]=a[u];\n\tint v;\n\tll cur;\n\tfor(auto qwq:e[u]) \n\t{\n\t\tv=qwq.fi;\n\t\tcur=max(0ll,f[v]-2ll*qwq.se);\n\t\tdp[u]+=cur;\n\t\tdv[u].pb(cur);\n\t}\n\tcur=f[u];\n\tfor(int i=0;i<(int)e[u].size();i++)\n\t{\n\t\tv=e[u][i].fi;\n\t\tif(fa[u]==v) continue;\n\t\tf[u]=dp[u]-dv[u][i];\n\t\tdfs2(v);\n\t}\n\tf[u]=cur;\n}\ninline int get_lp(int x,int y) {return dep[x]<dep[y]?x:y;}\ninline void init_ST()\n{\n\tR(i,2,tim+5) Lg[i]=Lg[i>>1]+1;\n\tfor(int i=1;(1<<i)<=tim;i++) \n\t{\n\t\tint w=(1<<i);\n\t\tR(j,1,tim-w+1) st[i][j]=get_lp(st[i-1][j],st[i-1][j+(w>>1)]);\n\t}\n}\ninline int get_LCA(int x,int y)\n{\n\tx=bg[x],y=bg[y];\n\tif(x>y) Swap(x,y);\n\tint i=Lg[y-x+1],w=(1<<i);\n\treturn get_lp(st[i][x],st[i][y-w+1]);\n}\ninline ll get_dv(int u) \n{\n\tint f=fa[u];\n\tint pos=(lower_bound(e[u].begin(),e[u].end(),pii(f,-1))-e[u].begin());\n\tif(pos>=(int)e[u].size()||e[u][pos].fi!=f) return 0;\n\treturn dv[u][pos];\n}\nll BIT[N];\ninline int lowbit(int x) {return x&(-x);}\ninline void modify(int pos,ll val) \n{\n\tfor(int i=pos;i<N;i+=lowbit(i)) BIT[i]+=val;\n}\n\ninline ll query(int pos) \n{\n\tll ret=0;\n\tfor(int i=pos;i;i-=lowbit(i)) ret+=BIT[i];return ret;\n}\ninline ll query_SUM(int l,int r) {return query(r)-query(l-1);}\nvoid dfs3(int u)\n{\n\tll vadd=dp[u]-get_dv(u);\n\tmodify(dep[u],vadd);\n\tint v;\n\tll cur;\n\tfor(auto qwq:qs[u])\n\t{\n\t\tv=qwq.fi;\n\t\tans[qwq.se]+=query_SUM(dep[v],dep[u])+get_dv(v);\n\t}\n\tfor(int i=0;i<(int)e[u].size();i++) \n\t{\n\t\tv=e[u][i].fi;\n\t\tif(fa[u]==v) continue;\n\t\tcur=dv[u][i]+e[u][i].se;\n\t\tmodify(dep[u],-cur);\n\t\tdfs3(v);\n\t\tmodify(dep[u],cur);\n\t}\n\tmodify(dep[u],-vadd);\n}\nsigned main()\n{\t\n\tn=read(),m=read();\n\tR(i,1,n) a[i]=read();\n\tint u,v;\n\tll d;\n\tR(i,2,n)\n\t{\n\t\tu=read(),v=read(),d=read();\n\t\te[u].pb(mkp(v,d));\n\t\te[v].pb(mkp(u,d));\n\t}\n\tR(i,1,n) sort(e[i].begin(),e[i].end());\n \tdfs1(1);\n \tR(i,1,n) dep[i]++;\n \tinit_ST();\n \tdfs2(1);\n \tR(i,1,m) \n \t{\n \t\tu=read(),v=read();\n \t\tint L_A=get_LCA(u,v);\n \t\tans[i]=-dp[L_A];\n \t\tqs[u].pb(mkp(L_A,i));\n \t\tqs[v].pb(mkp(L_A,i));\n \t}\n \tdfs3(1);\n \tR(i,1,m) writeln(ans[i]);\n\n}\n```\n",
        "postTime": 1618900293,
        "uid": 115779,
        "name": "\u6781\u5bd2\u795e\u51b0",
        "ccfLevel": 0,
        "title": "CF1000G"
    },
    {
        "content": "\u7801\u4ee3\u7801\u65f6\u5f88\u62c5\u5fc3\u6700\u540e\u600e\u4e48\u8c03\u8bd5\uff0c\u4e0d\u8fc7\u8fd8\u597d\u57fa\u672c\u6ca1\u51fa\u4ec0\u4e48\u5c94\u5b50\u51e0\u4e0b\u5c31\u8c03\u51fa\u6765\u4e86X\n\n## \u89e3\u6790\n\n\u8003\u8651\u4e00\u6761\u4ece $x$ \u5230 $y$ \u7684 2-Path\u3002\u5982\u679c\u4e2d\u9014 \u201c\u79bb\u5f00\u201d \u4e86 $(x, y)$ \u7684\u8def\u5f84\uff0c\u6700\u540e\u4e00\u5b9a\u5f97\u56de\u5230\u8fd9\u6761\u8def\u5f84\u4e0a\uff1b\u5047\u8bbe 2-Path \u4ece $(x, y)$ \u8def\u5f84\u4e0a\u7684\u70b9 $u$ \u79bb\u5f00\u4e86\u8def\u5f84\uff0c\u5c31\u4f1a\u7c7b\u4f3c\u5728 $u$ \u7684\u5b50\u6811\u5185\uff08\u4e0d\u542b\u8def\u5f84\uff09\u8d70\u4e86\u4e00\u5708\uff0c\u6700\u540e\u518d\u56de\u5230 $u$\n\n\u6211\u4eec\u6682\u65f6\u5148\u4e0d\u8003\u8651\u5b50\u6811\u5305\u542b\u8def\u5f84\u7684\u95ee\u9898\uff0c\u8003\u8651\u600e\u4e48\u7b97\u8fd9\u4e2a\u503c\uff08\u4ece\u5b50\u6811\u91cc\u7ed5\u4e00\u5708\u56de\u6765\u5f97\u5230\u7684\u6700\u5927\u8d21\u732e\uff09\u3002\u8fd9\u663e\u7136\u53ef\u4ee5 dp\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u8bbe $dp(u)$ \u8868\u793a\u53ea\u5141\u8bb8\u8d70 $u$ \u5b50\u6811\u5185\u7684\u7ed3\u70b9\uff0c2-Path\uff08\u5c31\u662f\u9898\u76ee\u5b9a\u4e49\u7684\u90a3\u6837\uff09$p(u, u)$ \u7684\u6700\u5927\u503c\uff1b\u5176\u8f6c\u79fb\u65b9\u7a0b\u5373\u4e3a $dp(u)=a_u+\\sum\\limits_{v}\\max(0, dp(v)-2w(u, v))$\uff0c\u5176\u4e2d $v$ \u662f $u$ \u7684\u513f\u5b50\uff0c$w(u, v)$ \u6307\u8fb9 $(u, v)$ \u7684\u6743\u503c\n\n\u7136\u800c dp \u51fa\u4e86\u8fd9\u4e1c\u897f\u540e\u8fd8\u662f\u5f88\u9ebb\u70e6\uff0c\u9700\u8981\u5206\u7c7b\u8ba8\u8bba\u592a\u591a\u4e86\u3002\u63a5\u7740\u53d1\u73b0\u8fd9\u4e1c\u897f\u633a\u597d\u6362\u6839\u7684\uff0c\u56e0\u6b64\u53ef\u4ee5\u8003\u8651\u7528\u6362\u6839 dp \u505a\u51fa\u4ee5\u6bcf\u4e2a\u70b9\u4e3a\u6839\u65f6\u5404\u70b9\u7684 dp \u503c\uff1b\u5bf9\u6bcf\u4e2a\u8be2\u95ee $(x, y)$\uff0c\u6211\u4eec\u5c31\u5728**\u4ee5 $x$ \u4e3a\u6839\u65f6**\u5904\u7406\u5b83\n\n\u8003\u8651\u5bf9\u4e8e\u8be2\u95ee $(x, y)$\uff0c\u5e76\u4e14\u6b64\u65f6\u7684 dp \u503c\u4ee5 $x$ \u4e3a\u6839\uff0c\u6211\u4eec\u8be5\u600e\u4e48\u8ba1\u7b97\u51fa 2-Path $p(x, y)$ \u7684\u6700\u5927\u503c\n\n\u53ef\u4ee5\u53d1\u73b0\uff0c\u8bbe\u8def\u5f84\u4e0a\u7684\u4e24\u70b9 $u, v$\uff0c\u4e14 $u$ \u4e3a $v$ \u7684\u7236\u4eb2\uff0c\u90a3\u4e48\u7b54\u6848\u5c31\u4e3a $\\sum(dp(v)-\\max(0, dp(v)-2w(u, v))-w(u, v))+dp(x)$\uff08\u5176\u4e2d $\\max(0, dp(v)-2w(u, v))$ \u662f\u4e3a\u4e86\u53bb\u6389 $u$ \u7684 dp \u503c\u4e2d\u8d70\u5165 $v$ \u7684\u8d21\u732e\uff09\n\n\u8fd9\u4e2a\u4e1c\u897f\u53ef\u4ee5\u7528\u5404\u79cd\u65b9\u5f0f\u5feb\u901f\u7ef4\u62a4\uff1b\u4f46\u8003\u8651\u6362\u6839\u65f6\u8fd8\u9700\u505a\uff08\u5355\u70b9\uff09\u4fee\u6539\uff0c\u56e0\u6b64\u8981\u7528 \u6811\u5256/lct \u7ef4\u62a4\n\n\u4e8e\u662f\u8fd9\u9898\u5c31\u505a\u5b8c\u4e86\u3002\u603b\u590d\u6742\u5ea6 $O(n\\log n)$\n\n## CODE\n\n\u4e3a\u4e86\u65b9\u4fbf\u6211\u5c31\u76f4\u63a5\u590d\u5236\u4e86 lct \u7684\u6a21\u677fX\n\nlct \u4e2d\u6211\u5bf9\u6bcf\u4e2a\u7ed3\u70b9\u7ef4\u62a4\u4e86\u4e24\u4e2a\u6743\u503c\uff0c\u5206\u522b\u4e3a $dp(v)$ \u548c $(\\max(0, dp(v)-2w(u, v))+w(u, v))$\uff1b\u5e76\u4e14\u6211\u6ca1\u663e\u5f0f\u5730\u5728\u6700\u540e\u52a0\u4e0a $dp(x)$\uff0c\u800c\u662f\u5c06 $w(x, 0)$ \u8bbe\u4e3a $0$\uff0c\u5e76\u8bbe $x$\uff08\u6811\u6839\uff09\u7684\u7236\u4eb2\u4e3a $0$\uff0c\u76f4\u63a5\u5957\u7528\u4e86\u4e0a\u9762\u7684\u7ef4\u62a4\n\n\u6ce8\u610f\u4ee3\u7801\u7ec6\u8282\u5f88\u591a\u3002\u5c24\u5176\u6362\u6839 dfs \u4e2d\u6bcf\u6b21\u4ece\u513f\u5b50\u8fd4\u56de\u8bb0\u5f97**\u8fd8\u539f**\u4fee\u6539\uff0c\u6bd5\u7adf\u8fd8\u8981\u505a\u6811\u94fe\u67e5\u8be2\u7684\n\n```cpp\n#include <cstdio>\n#include <algorithm>\n#define ll long long\nusing std::sort;\nusing std::max;\n\nconst int MAXN =3e5+50, MAXQ =4e5+50;\n\n/*------------------------------Lct------------------------------*/\n\nint Lct_c[2][MAXN], Lct_fa[MAXN];\nll Lct_sum1[MAXN], Lct_val1[MAXN], Lct_sum2[MAXN], Lct_val2[MAXN];\nbool rev[MAXN];\n\n#define c Lct_c\n#define f Lct_fa\n\ninline void pushdown(const int &x){\n\tif(rev[x]){\n\t\trev[c[0][x]] ^=1, rev[c[1][x]] ^=1;\n\t\tc[0][x] ^=c[1][x] ^=c[0][x] ^=c[1][x];\n\t\trev[x] =0;\n\t}\n}\n\ninline void pushup(const int &x){\n\tLct_sum1[x] =Lct_sum1[c[0][x]]+Lct_sum1[c[1][x]]+Lct_val1[x];\n\tLct_sum2[x] =Lct_sum2[c[0][x]]+Lct_sum2[c[1][x]]+Lct_val2[x];\n}\n\ninline bool isroot(const int &x){ return ((c[0][f[x]] != x && c[1][f[x]] != x) || f[x] == 0); }\n\ninline bool rotate_get(const int &x){ return (c[1][f[x]] == x); }\n\ninline void rotate(int x){\n\tbool r =rotate_get(x), rf =rotate_get(f[x]);\n\tint y =f[x], z =f[y], a =c[!r][x];\n\tf[x] =z; if(!isroot(y)) c[rf][z] =x;\n\tf[y] =x, c[!r][x] =y;\n\tf[a] =y, c[r][y] =a;\n\tpushup(y);\n}\n\nvoid pushall(int x){\n\tif(!isroot(x))\n\t\tpushall(f[x]);\n\tpushdown(x);\n}\n\nvoid splay(int x){\n\tpushall(x);\n\tfor(; !isroot(x); rotate(x))\n\t\tif(!isroot(f[x]))\n\t\t\trotate((rotate_get(f[x]) == rotate_get(x)) ? f[x] : x);\n\tpushup(x);\n}\n\nvoid access(int x){\n\tfor(int pre =0; x; pre =x, x =f[x]){\n\t\tsplay(x);\n\t\tc[1][x] =pre;\n\t\tpushup(x);\n\t}\n}\n\ninline void setroot(int x){\n\taccess(x), splay(x);\n\trev[x] =1;\n}\n\ninline void link(int x, int y){\n\tsetroot(x); f[x] =y;\n}\n\ninline ll Lct_query1(int x, int y){\n\tsetroot(x), access(y), splay(y);\n\treturn Lct_sum1[y];\n}\n\ninline ll Lct_query2(int x, int y){\n\tsetroot(x), access(y), splay(y);\n\treturn Lct_sum2[y];\n}\n\ninline void updata(int x, const ll &val1, const ll &val2){\n\tsplay(x);\n\tLct_val1[x] =val1, Lct_val2[x] =val2;\n\tpushup(x);\n}\n\n#undef c\n#undef f\n\n/*------------------------------Map------------------------------*/\n\nint first[MAXN], tote;\nstruct edge{\n\tint to, net, w;\n}e[MAXN<<1];\n\ninline void addedge(const int &u, const int &v, const int &w){\n\t++tote;\n\te[tote].to =v, e[tote].net =first[u], e[tote].w =w;\n\tfirst[u] =tote;\n\t++tote;\n\te[tote].to =u, e[tote].net =first[v], e[tote].w =w;\n\tfirst[v] =tote;\n}\n\n/*------------------------------Dfs------------------------------*/\n\nint dfn[MAXN], tot;\n\n/*------------------------------Query------------------------------*/\n\nstruct Query{\n\tint x, y, qid;\n\t\n\tbool operator < (const Query &B) const{\n\t\treturn dfn[x] < dfn[B.x];\n\t}\n}query[MAXQ];\nll Ans[MAXQ];\nint cur_q;\n\n/*------------------------------Dp------------------------------*/\n\nint a[MAXN], w_fa[MAXN];\nll dp[MAXN];/*u \u5b50\u6811\u5185\u7684 2-Path(u, u) \u7684\u6700\u5927\u503c*/\n\nvoid dfs1(int u, int fa){\n\tdfn[u] =tot++;\n\tdp[u] =a[u];\n\tfor(int l =first[u]; l; l =e[l].net)\n\t\tif(e[l].to != fa){\n\t\t\tw_fa[e[l].to] =e[l].w;\n\t\t\tdfs1(e[l].to, u);\n\t\t\tif(dp[e[l].to]-2*e[l].w > 0)\n\t\t\t\tdp[u] +=dp[e[l].to]-2*e[l].w;\n\t\t}\n}\n\nvoid dfs2(int u, int fa){\n\twhile(query[cur_q].x == u){\n\t\tint y =query[cur_q].y;\n\t\tAns[query[cur_q].qid] =Lct_query1(u, y)-Lct_query2(u, y);\n\t\t++cur_q;\n\t}\n\tfor(int l =first[u]; l; l =e[l].net)\n\t\tif(e[l].to != fa){\n\t\t\tll delta1 =max(0ll, dp[e[l].to]-2*w_fa[e[l].to]);\n\t\t\tdp[u] -=delta1;\n\t\t\tw_fa[u] ^=w_fa[e[l].to] ^=w_fa[u] ^=w_fa[e[l].to];\n\t\t\tll delta2 =max(0ll, dp[u]-2*w_fa[u]);\n\t\t\tdp[e[l].to] +=delta2;\n\t\t\tupdata(u, dp[u], w_fa[u]+delta2);\n\t\t\tupdata(e[l].to, dp[e[l].to], 0);\n\t\t\t\n\t\t\tdfs2(e[l].to, u);\n\t\t\t\n\t\t\tdp[u] +=delta1;\n\t\t\tw_fa[u] ^=w_fa[e[l].to] ^=w_fa[u] ^=w_fa[e[l].to];\n\t\t\tdp[e[l].to] -=delta2;\n\t\t\tupdata(u, dp[u], 0);\n\t\t\tupdata(e[l].to, dp[e[l].to], w_fa[e[l].to]+delta1);\n\t\t}\n}\n\n/*------------------------------Main------------------------------*/\n\ninline int read(){\n\tint x =0; char c =getchar(); bool f =0;\n\twhile(c < '0' || c > '9') (c == '-') ? f =1, c =getchar() : c =getchar();\n\twhile(c >= '0' && c <= '9') x =(x<<3)+(x<<1)+(48^c), c =getchar();\n\treturn (f) ? -x : x;\n}\n\nint main(){\n\tint n =read(), q =read();\n\tfor(int i =1; i <= n; ++i)\n\t\ta[i] =read();\n\tfor(int i =0; i < n-1; ++i){\n\t\tint u =read(), v =read(), w =read();\n\t\taddedge(u, v, w);\n\t}\n\tfor(int i =0; i < q; ++i){\n\t\tquery[i].x =read(), query[i].y =read();\n\t\tif(dfn[query[i].x] > dfn[query[i].y])/*\u4e0d\u4ea4\u6362\u4e5f\u65e0\u5927\u788d*/\n\t\t\tquery[i].x ^=query[i].y ^=query[i].x ^=query[i].y;\n\t\tquery[i].qid =i;\n\t}\n\t\n\tdfs1(1, 0);\n\tfor(int x =1; x <= n; ++x){\n\t\tLct_val1[x] =Lct_sum1[x] =dp[x];\n\t\tLct_val2[x] =w_fa[x];\n\t\tif(x != 1 && dp[x]-2*w_fa[x] > 0){\n\t\t\tLct_val2[x] +=dp[x]-2*w_fa[x];\n\t\t\tLct_sum2[x] +=dp[x]-2*w_fa[x];\n\t\t}\n\t}\n\tfor(int i =1; i <= tote; i +=2)\n\t\tlink(e[i].to, e[i+1].to);\n\tsort(query, query+q);\n\tdfs2(1, 0);\n\t\n\tfor(int i =0; i < q; ++i)\n\t\tprintf(\"%lld\\n\", Ans[i]);\n}\n```",
        "postTime": 1602681571,
        "uid": 105254,
        "name": "Piwry",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 CF1000G \u3010Two-Paths\u3011"
    },
    {
        "content": "\u66f4\u6e05\u6670\u7684\u9605\u8bfb\u4f53\u9a8c\u6233https://blog.csdn.net/lleozhang/article/details/83659914 \u8fd9\u91cc\n\n\u871c\u6c41\u6811\u5f62dp...\n\n\u9996\u5148\u5206\u6790\u4e00\u4e0b\uff1a\u4ed6\u8981\u6c42\u4e00\u6761\u8fb9\u81f3\u591a\u53ea\u80fd\u7ecf\u8fc7\u4e24\u6b21\uff0c\u90a3\u4e48\u5f88\u5bb9\u6613\u4f1a\u53d1\u73b0\uff1a\u4ecex\u5230y\u8fd9\u4e00\u6761\u8def\u5f84\u4e0a\u7684\u6240\u6709\u8fb9\u90fd\u53ea\u4f1a\u88ab\u7ecf\u8fc7\u4e00\u6b21\u3002\uff08\u5982\u679c\u8fc7\u53bb\u518d\u56de\u6765\u90a3\u4e48\u8fd8\u8981\u8fc7\u53bb\uff0c\u8fd9\u6837\u5c31\u4e09\u6b21\u4e86\uff0c\u663e\u7136\u4e0d\u5408\u6cd5\uff09\n\n\u90a3\u4e48\u5176\u4ed6\u80fd\u4ea7\u751f\u8d21\u732e\u7684\u90e8\u5206\u5c31\u53ea\u6709\u4e00\u4e0b\u51e0\u4e2a\u90e8\u5206\uff1ax\uff0cy\u7684\u5b50\u6811\u5185\u90e8\uff0cLCA\uff08x,y\uff09\u7684\u4e0a\u534a\u90e8\u5206\u7684\u6811\u4ee5\u53cax-y\u8def\u5f84\u4e0a\u7684\u70b9\u5411\u5916\u5ef6\u4f38\u6240\u5f62\u6210\u7684\u90e8\u5206\n\n\u8fd9\u4e09\u90e8\u5206\u4e92\u76f8\u72ec\u7acb\u53c8\u4e92\u76f8\u5173\u8054\uff0c\u6240\u4ee5\u6211\u4eec\u8bbe\u8ba1\u4e09\u4e2adp\u5bf9\u4ed6\u4eec\u8fdb\u884c\u8f6c\u79fb\n\n\u8bb0dp1[x]\u4ee3\u8868x\u7684\u5b50\u6811\u5185\u6240\u5f62\u6210\u7684\u7684\u8d21\u732e\uff0cdp3[x]\u8868\u793ax\u4ee5\u4e0a\u7684\u6811\u6240\u5f62\u6210\u7684\u8d21\u732e\uff08\u5305\u62ecx\u7684\u5144\u5f1f\u8282\u70b9\uff09\n\n\u8fd9\u6837\u5c31\u8bbe\u8ba1\u51fa\u4e86\u7b2c\u4e00\u4e2a\u548c\u7b2c\u4e09\u4e2a\u72b6\u6001\n\n\u81f3\u4e8e\u7b2c\u4e8c\u4e2a\uff0c\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u8fd9\u4e2a\u60c5\u51b5\u7b49\u4ef7\u4e8e\u8def\u5f84\u4e0a\u6240\u6709\u70b9\u5411\u4ed6\u7684\u6240\u6709\u5144\u5f1f\u8282\u70b9\u53bb\u8dd1\uff0c\u8fd9\u6837\u5ef6\u4f38\u51fa\u6765\u7684\u4e00\u79cd\u60c5\u51b5\u3002\n\n\u90a3\u4e48\u6211\u4eec\u8bbe\u8ba1dp2[x]\u4ee3\u8868x\u7684\u5144\u5f1f\u8282\u70b9\u5bf9x\u7684\u8d21\u732e\n\n\u63a5\u4e0b\u6765\u6211\u4eec\u8003\u8651\u8f6c\u79fb\uff1a\n\n\u9996\u5148\uff0cdp1\u975e\u5e38\u597d\u8f6c\u79fb\uff0c\u53ea\u9700\u5411\u4e0bdfs\uff0c\u6bcf\u6b21\u56de\u6eaf\u65f6\u53ea\u8981\u80fd\u4ea7\u751f\u6b63\u7684\u8d21\u732e\u5c31\u5411\u4e0a\u66f4\u65b0\uff0c\u540c\u65f6\u8bb0\u5f55\u6bcf\u4e2a\u70b9\u662f\u5426\u53ef\u4ee5\u5411\u4e0a\u66f4\u65b0\u5373\u53ef\n\n\u5f53dp1\u51fa\u6765\u4e86\u4e4b\u540e\uff0cdp2\u4e5f\u5c31\u5f88\u597d\u8f6c\u79fb\u4e86\uff0c\u56e0\u4e3a\u5982\u679c\u7236\u8282\u70b9\u7684dp1\u6ca1\u6709\u5229\u7528\u8fd9\u4e2a\u8282\u70b9\u8fdb\u884c\u66f4\u65b0\uff0c\u90a3\u4e48\u8fd9\u4e2a\u8282\u70b9\u7684dp2\u5c31\u662f\u4ed6\u7236\u8282\u70b9\u7684dp1\n\n\u5982\u679cdp1\u5229\u7528\u4e86\u8fd9\u4e2a\u8282\u70b9\u8fdb\u884c\u66f4\u65b0\uff0c\u90a3\u5c31\u5c06dp1\u51cf\u6389\u8fd9\u4e2a\u8282\u70b9\u63d0\u4f9b\u7684\u8d21\u732e\u8d4b\u7ed9dp2\u5373\u53ef\n\n\u800cdp3\uff0c\u5f88\u663e\u7136dp3\u8981\u5206\u4e3a\u4e24\u90e8\u5206\uff0c\u4e00\u90e8\u5206\u662f\u7236\u8282\u70b9\u5411\u4e0a\uff0c\u4e00\u90e8\u5206\u662f\u5144\u5f1f\u8282\u70b9\uff0c\u5144\u5f1f\u8282\u70b9\u90e8\u5206\u5c31\u662fdp2\uff0c\u800c\u7236\u8282\u70b9\u5411\u4e0a\u90a3\u5c31\u662f\u7236\u8282\u70b9\u7684dp3\uff0c\u8fd9\u4e5f\u5c31\u5b8c\u6210\u4e86\u66f4\u65b0\n\n\u8fd9\u6837\u4e09\u4e2adp\u5c31\u7ef4\u62a4\u51fa\u6765\u4e86\n\n\u5982\u679c\u5bf9\u6982\u5ff5\u4e0d\u662f\u7279\u522b\u6e05\u695a\uff0c\u753b\u51e0\u4e2a\u56fe\u6765\u7406\u89e3\u4e00\u4e0b\u5c31\u884c\uff1a\n\n\u00a0\u90a3\u4e48\u66f4\u65b0\u5b8c\u8fd9\u4e09\u4e2a\uff0c\u67e5\u8be2\u4e5f\u5c31\u53d8\u5f97\u7b80\u5355\u4e86\uff1a\u9996\u5148\u7edf\u8ba1x-y\u8def\u5f84\u4e0a\u7684\u90e8\u5206\uff0c\u7136\u540e\u7edf\u8ba1x\u5b50\u6811\u5185\uff0cy\u5b50\u6811\u5185\uff0cLCA\uff08x\uff0cy\uff09\u4ee5\u4e0a\u7684\u90e8\u5206\uff0c\u4ee5\u53cax-y\u8def\u5f84\u4e0a\u7684\u70b9\u5411\u5916\u5ef6\u4f38\u7684\u90e8\u5206\uff0c\u800c\u8fd9\u90e8\u5206\u53ef\u4ee5\u5728\u6811\u94fe\u4e0a\u7528\u524d\u7f00\u548c\u7ef4\u62a4\u3002\n\n\u4f46\u662f\u8fd9\u91cc\u6709\u4e2a\u5c0f\u95ee\u9898\uff1a\u7531\u4e8ex\u548cy\u5728\u8df3\u5230LCA\u4e0a\u65f6\u4f1a\u8df3\u5230LCA\u7684\u4e24\u4e2a\u5b50\u8282\u70b9\u4e0a\uff0c\u90a3\u4e48\u5bf9\u8fd9\u4e24\u4e2a\u5b50\u8282\u70b9\uff0c\u6211\u4eec\u4e0d\u80fd\u52a0\u4e24\u6b21\u5144\u5f1f\u8282\u70b9\u7684\u8d21\u732e\uff08\u8fd9\u6837\u5c31\u52a0\u91cd\u4e86\uff09\uff0c\u6240\u4ee5\u6211\u4eec\u53bb\u6389\u4e00\u90e8\u5206\u5373\u53ef\u3002\n\n```cpp\n#include <cstdio>\n#include <cmath>\n#include <cstring>\n#include <cstdlib>\n#include <iostream>\n#include <algorithm>\n#include <queue>\n#include <stack>\n#define ll long long\nusing namespace std;\nstruct Edge\n{\n\tint next;\n\tint to;\n\tll val;\n}edge[600005];\nint head[300005];\nint f[300005][30];\nll dp1[300005];\nll dp2[300005];\nll dp3[300005];\nll fv[300005];\nbool used1[300005];\nll dis[300005];//\u8fb9\u6743\u8ddd\u79bb \nll d[300005];//\u70b9\u6743\u8ddd\u79bb\nll v[300005];\nll s[300005];\nint dep[300005]; \nint cnt=1;\nint n,q;\nvoid init()\n{\n\tmemset(head,-1,sizeof(head));\n\tcnt=1;\n}\nvoid add(int l,int r,ll w)\n{\n\tedge[cnt].next=head[l];\n\tedge[cnt].to=r;\n\tedge[cnt].val=w;\n\thead[l]=cnt++;\n}\nvoid dfs(int x,int fx)//\u5904\u7406dp1 \n{\n\tf[x][0]=fx;\n\tdep[x]=dep[fx]+1;\n\tfor(int i=head[x];i!=-1;i=edge[i].next)\n\t{\n\t\tint to=edge[i].to;\n\t\tif(to==fx)\n\t\t{\n\t\t\tcontinue;\n\t\t}\n\t\tfv[to]=edge[i].val;\n\t\tdis[to]=dis[x]+edge[i].val;\n\t\td[to]=d[x]+v[to];\n\t\tdfs(to,x);\n\t\tif(dp1[to]+v[to]-2*edge[i].val>=0)\n\t\t{\n\t\t\tdp1[x]+=dp1[to]+v[to]-2*edge[i].val;\n\t\t\tused1[to]=1;\n\t\t}\n\t}\n\tfor(int i=head[x];i!=-1;i=edge[i].next)\n\t{\n\t\tint to=edge[i].to;\n\t\tif(to==fx)\n\t\t{\n\t\t\tcontinue;\n\t\t}\n\t\tif(!used1[to])\n\t\t{\n\t\t\tdp2[to]=dp1[x];\n\t\t}else\n\t\t{\n\t\t\tdp2[to]=dp1[x]-(dp1[to]+v[to]-2*edge[i].val);\n\t\t}\n\t}\n}\nvoid redfs(int x,int fx)\n{\n\ts[x]+=dp2[x];\n\tfor(int i=head[x];i!=-1;i=edge[i].next)\n\t{\n\t\tint to=edge[i].to;\n\t\tif(to==fx)\n\t\t{\n\t\t\tcontinue;\n\t\t}\n\t\tdp3[to]=max((ll)0,dp3[x]+v[x]-2*edge[i].val+dp2[to]);\n\t\ts[to]+=s[x];\n\t\tredfs(to,x);\n\t}\n}\nvoid getf()\n{\n\tfor(int i=1;i<=25;i++)\n\t{\n\t\tfor(int j=1;j<=n;j++)\n\t\t{\n\t\t\tf[j][i]=f[f[j][i-1]][i-1];\n\t\t}\n\t}\n}\nint LCA(int x,int y)\n{\n\tif(dep[x]>dep[y])\n\t{\n\t\tswap(x,y);\n\t}\n\tfor(int i=25;i>=0;i--)\n\t{\n\t\tif(dep[f[y][i]]>=dep[x])\n\t\t{\n\t\t\ty=f[y][i];\n\t\t}\n\t}\n\tif(x==y)\n\t{\n\t\treturn x;\n\t}\n\tint ret;\n\tfor(int i=25;i>=0;i--)\n\t{\n\t\tif(f[x][i]!=f[y][i])\n\t\t{\n\t\t\tx=f[x][i];\n\t\t\ty=f[y][i];\n\t\t}else\n\t\t{\n\t\t\tret=f[x][i];\n\t\t}\n\t}\n\treturn ret;\n}\nll cal(int x,int y)\n{\n\tll ret=0;\n\tif(dep[x]>dep[y])\n\t{\n\t\tswap(x,y);\n\t}\n\tint f1=LCA(x,y);\n\tif(f1!=1)\n\t{\n\t\tret+=d[x]+d[y]-d[f1]-d[f[f1][0]];\n\t\tret-=dis[x]+dis[y]-2*dis[f1];\n\t}else\n\t{\n\t\tret+=d[x]+d[y]-d[f1];\n\t\tret-=dis[x]+dis[y]-dis[f1];\n\t}\n\tif(x==f1)\n\t{\n\t\tret+=dp1[y];\n\t\tret+=dp3[x];\n\t\tret+=s[y];\n\t\tret-=s[x];\n\t}else\n\t{\n\t\tret+=dp1[x];\n\t\tret+=dp1[y];\n\t\tret+=dp3[f1];\n\t\tint ff1=x,ff2=y;\n\t\tfor(int i=25;i>=0;i--)\n\t\t{\n\t\t\tif(dep[f[ff1][i]]>dep[f1])\n\t\t\t{\n\t\t\t\tff1=f[ff1][i];\n\t\t\t}\n\t\t\tif(dep[f[ff2][i]]>dep[f1])\n\t\t\t{\n\t\t\t\tff2=f[ff2][i];\n\t\t\t}\n\t\t}\n\t\tret+=s[x]-s[ff1];\n\t\tret+=s[y]-s[ff2];\n\t\tret+=dp2[ff1];\n\t\tif(used1[ff2])\n\t\t{\n\t\t\tret-=dp1[ff2]+v[ff2]-2*fv[ff2];\n\t\t}\n\t}\n\treturn ret;\n}\ninline int read()\n{\n\tint f=1,x=0;char ch=getchar();\n\twhile(ch<'0'||ch>'9'){if(ch=='-')f=-1;ch=getchar();}\n\twhile(ch>='0'&&ch<='9'){x=x*10+ch-'0';ch=getchar();}\n\treturn x*f;\n}\nint main()\n{\n\tn=read(),q=read();\n\tinit();\n\tfor(int i=1;i<=n;i++)\n\t{\n\t\tv[i]=(ll)read();\n\t}\n\tfor(int i=1;i<n;i++)\n\t{\n\t\tint x=read(),y=read(),z=read();\n\t\tadd(x,y,(ll)z);\n\t\tadd(y,x,(ll)z);\n\t}\n\td[1]=v[1];\n\tdfs(1,1);\n\tgetf();\n\tredfs(1,1);\n\tfor(int i=1;i<=q;i++)\n\t{\n\t\tint x=read(),y=read();\n\t\tprintf(\"%lld\\n\",cal(x,y));\n\t}\n\treturn 0;\n}\n\n```\n",
        "postTime": 1555835919,
        "uid": 66905,
        "name": "leozhang",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF1000G \u3010Two-Paths\u3011"
    }
]