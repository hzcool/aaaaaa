[
    {
        "content": "\u8bfb\u5b8c\u9898\u53d1\u73b0\u4e24\u4e2a\u7279\u6b8a\u6761\u4ef6\uff1a\u4ece\u59cb\u81f3\u7ec8 $a$ \u6ca1\u6709\u53d8\u4ee5\u53ca $p_1$ \u548c $p_5$ \u7684\u9009\u62e9\u4e0e $b$ \u65e0\u5173\u3002\n\n\u6211\u4eec\u8003\u8651\u628a $p_1p_2$\u3001$p_4p_5$ \u5206\u522b\u770b\u4f5c\u4e00\u4e2a\u6574\u4f53\uff0c\u5206\u522b\u8bb0\u4e3a $a$ \u548c $c$\uff08\u539f\u8c05\u6211\u7684\u53d8\u91cf\u91cd\u540d\uff09\uff0c\u90a3\u4e48\u56fa\u5b9a\u7684 $p_2$ \u548c $p_4$ \u80fd\u7ec4\u6210\u7684 $a$ \u548c $c$ \u7684\u4e2a\u6570\u662f\u4e00\u5b9a\u7684\uff0c\u53ef\u4ee5\u9884\u5904\u7406\u3002\u8bb0 $p_3$ \u4e3a $b$\uff0c\u7531\u4e8e $a_{p2}=a_{p3}=a_{p4}$\uff0c\u800c $a$ \u59cb\u7ec8\u4e0d\u53d8\uff0c\u5c31\u53ef\u4ee5\u60f3\u5230\u5bf9 $a_i$ \u76f8\u540c\u7684\u70b9\u5206\u522b\u5f00\u52a8\u6001\u5f00\u70b9\u7ebf\u6bb5\u6811\u5373\u53ef\u7ef4\u62a4\u3002\n\n\u5177\u4f53\u5730\uff0c\u5c06\u6570\u7ec4 $a$ \u79bb\u6563\u5316\u4e4b\u540e\uff0c\u7528\u6811\u72b6\u6570\u7ec4\u6c42\u51fa $pre[i]=\\sum\\limits_{j=1}^{i-1}(a[j]\\le a[i])$ \u548c $nxt[i]=\\sum\\limits_{j=i+1}^n(a[j]\\le a[i])$\uff0c\u7ebf\u6bb5\u6811\u4e0a `pushup` \u7ef4\u62a4 $a,b,c,ab,bc,abc$ \u7684\u4e2a\u6570\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log n)$ \u5e26\u4e0a\u51e0\u500d\u5e38\u6570\uff0c\u8dd1\u7684\u8fd8\u662f\u633a\u5feb\u7684\u3002\n\n```cpp\n#include<bits/stdc++.h>\n#define ll long long\n#define ff(i,s,e) for(int i=(s);i<=(e);++i)\nusing namespace std;\ninline int read(){\n\tint x=0,f=1;\n\tchar ch=getchar();\n\twhile(ch>'9'||ch<'0'){if(ch=='-') f=-1;ch=getchar();}\n\twhile(ch>='0'&&ch<='9'){x=(x<<1)+(x<<3)+(ch^48);ch=getchar();}\n\treturn x*f;\n}\nconst int N=1e5+5,mod=1e9+7;\nint n,a[N],b[N],m,pre[N],nxt[N];\nstruct BIT{\n\tint t[N];\n\tinline int lowbit(int x){return x&(-x);}\n\tinline void upd(int x,int val){\n\t\tfor(int i=x;i<=n;i+=lowbit(i)) t[i]+=val;\n\t}\n\tinline int query(int x){\n\t\tint res=0;\n\t\tfor(int i=x;i;i-=lowbit(i)) res+=t[i];\n\t\treturn res;\n\t}\n}t1;\nint rt[N],tot;\nstruct qwq{\n\tint ls,rs,a,ab,abc,b,bc,c;\n}t[N*50];\n#define ls(k) t[k].ls\n#define rs(k) t[k].rs\ninline void add(int &x,int y){x+=y;if(x>=mod) x-=mod;}\ninline void pushup(int k){\n\tqwq &res=t[k],l=t[ls(k)],r=t[rs(k)];\n\tres.a=(l.a+r.a)%mod,res.b=(l.b+r.b)%mod,res.c=(l.c+r.c)%mod;\n\tres.ab=(1ll*l.a*r.b%mod+l.ab+r.ab)%mod;\n\tres.bc=(1ll*l.b*r.c%mod+l.bc+r.bc)%mod;\n\tres.abc=(1ll*l.ab*r.c%mod+1ll*l.a*r.bc%mod+l.abc+r.abc)%mod;\n}\nvoid upd(int &k,int l,int r,int x,int val){\n\tif(!k) k=++tot;\n\tif(l==r){\n\t\tif(val) t[k].a=pre[x],t[k].c=nxt[x],t[k].b=1;\n\t\telse t[k].a=t[k].b=t[k].c=0;\n\t\treturn;\n\t}\n\tint mid=l+r>>1;\n\tif(x<=mid) upd(ls(k),l,mid,x,val);\n\telse upd(rs(k),mid+1,r,x,val);\n\tpushup(k);\n}\nsigned main(){\n\tn=read();\n\tff(i,1,n) a[i]=b[i]=read();\n\tsort(b+1,b+n+1);\n\tm=unique(b+1,b+n+1)-b-1;\n\tff(i,1,n){\n\t\ta[i]=lower_bound(b+1,b+m+1,a[i])-b;\n\t\tpre[i]=t1.query(a[i]),t1.upd(a[i],1);\n\t}\n\tff(i,1,n) t1.t[i]=0;\n\tfor(int i=n;i>=1;--i){\n\t\tnxt[i]=t1.query(a[i]),t1.upd(a[i],1);\n\t\tupd(rt[a[i]],1,n,i,1);\n\t}\n\tint ans=0;\n\tff(i,1,m) add(ans,t[rt[i]].abc);\n\tm=read();\n\twhile(m--){\n\t\tint op=read(),x=read(),tmp=t[rt[a[x]]].abc;\n\t\tif(op==1) upd(rt[a[x]],1,n,x,0);\n\t\telse upd(rt[a[x]],1,n,x,1);\n\t\tans=(ans+t[rt[a[x]]].abc-tmp)%mod;\n\t\tif(ans<0) ans+=mod;\n\t\tprintf(\"%d\\n\",ans);\n\t}\n}\n```\n",
        "postTime": 1672670291,
        "uid": 613616,
        "name": "zcxxn",
        "ccfLevel": 7,
        "title": "CF788E New task \u9898\u89e3"
    },
    {
        "content": "[\u53ef\u80fd\u66f4\u597d\u7684\u9605\u8bfb\u4f53\u9a8c](https://www.luogu.com.cn/blog/wangrx/solution-cf788e)\n\n## \u9898\u76ee\u5927\u610f\n\n\u7ed9\u5b9a\u4e00\u957f\u5ea6\u4e3a $n$ \u7684\u5e8f\u5217 $a_1,a_2,\\cdots,a_n$\uff0c  \n\u5176\u4e2d\u6bcf\u4e2a\u6570 $a_i$ \u6709\u4e00\u4e2a $0/1$ \u5c5e\u6027 $b_i$\uff0c\u521d\u59cb $b_1,b_2,\\cdots,b_n$ \u5168\u4e3a $1$\u3002  \n$m$ \u6b21\u64cd\u4f5c\uff0c\u6bcf\u6b21\u4fee\u6539\u4e00\u4e2a\u5143\u7d20\u7684 $b_i$ \u503c\uff0c\u4fee\u6539\u540e\u8f93\u51fa\u6ee1\u8db3  \n$p_1<p_2<p_3<p_4<p_5,\\ a_{p_1}\\le a_{p_2}=a_{p_3}=a_{p_4}\\le a_{p_5},$  \n$b_{p_2}=b_{p_3}=b_{p_4}=1$ \u7684\u4e94\u5143\u7ec4 $(p_1,p_2,p_3,p_4,p_5)$ \u7684\u4e2a\u6570\u5bf9 $10^9+7$ \u53d6\u6a21\u7684\u7ed3\u679c\u3002 \n\n$\\texttt{Data Range: }1\\le n,m\\le 10^5,1\\le a_i\\le 10^9$\u3002\n\n## \u9898\u89e3\n\u7eaf\u7cb9\u7684\u5806\u780c\u6761\u4ef6\u7684\u9898\u3002\n\n\u6ce8\u610f\u5230\u7ed3\u679c\u53ea\u4e0e $a_i$ \u7684\u5927\u5c0f\u5173\u7cfb\u6709\u5173\uff0c\u4e0e\u5176\u786e\u5207\u7684\u503c\u65e0\u5173\uff0c  \n\u56e0\u6b64\u9996\u5148\u5c06 $a_i$ \u79bb\u6563\u5316\u3002\n\n\u4e4b\u540e\u53d1\u73b0\u7ed3\u679c\u4e0e $b_{p_1},b_{p_5}$ \u65e0\u5173\uff0c  \n\u56e0\u6b64\u5148\u7528\u6811\u72b6\u6570\u7ec4\u8ba1\u7b97 $\\displaystyle\\mathrm{prev}_k=\\sum_{i<k}[a_i\\le a_k],\\mathrm{sufv}_k=\\sum_{i>k}[a_i\\ge a_k]$\uff0c  \n\u6b64\u65f6\u7ed3\u679c\u5c31\u662f $\\displaystyle\\sum_{\\scriptsize\\begin{matrix}p_2<p_3<p_4\\\\a_{p_2}=a_{p_3}=a_{p_4}\\\\b_{p_2}=b_{p_3}=b_{p_4}=1\\end{matrix}}\\mathrm{prev_{p_2}\\mathrm{sufv}_{p_4}}$\uff0c\u4e94\u5143\u7ec4\u88ab\u4f18\u5316\u4e3a\u4e09\u5143\u7ec4\u3002\n\n------------\n\n\u8003\u8651\u4fee\u6539\u64cd\u4f5c\u4ea7\u751f\u7684\u8d21\u732e\uff1a  \n\u8bbe $\\mathrm{pre}_k=\\displaystyle\\sum_{i<k,a_i=a_k}b_i\\mathrm{prev}_i,\\mathrm{suf}_k=\\sum_{i>k,a_i=a_k}b_i\\mathrm{sufv}_i$\uff0c  \n\u4fee\u6539\u7684\u5143\u7d20\u6807\u53f7\u4e3a $k$\uff0c\u5219\n- $k$ \u4f5c\u4e3a $p_2$ \u65f6\uff0c\u5bf9\u7b54\u6848\u4ea7\u751f $\\displaystyle\\mathrm{prev}_k\\sum_{i>k,a_i=a_k}b_i\\mathrm{suf}_i$ \u7684\u8d21\u732e\u3002\n- $k$ \u4f5c\u4e3a $p_4$ \u65f6\uff0c\u5bf9\u7b54\u6848\u4ea7\u751f $\\displaystyle\\mathrm{sufv}_k\\sum_{i<k,a_i=a_k}b_i\\mathrm{pre}_i$ \u7684\u8d21\u732e\u3002\n- $k$ \u4f5c\u4e3a $p_3$ \u65f6\uff0c\u5bf9\u7b54\u6848\u4ea7\u751f $\\mathrm{pre}_k\\mathrm{suf}_k$ \u7684\u8d21\u732e\u3002\n\n\u540c\u65f6\uff0c$k$ \u4f1a\u5bf9 $\\mathrm{pre}_i(i>k,a_i=a_k)$ \u4ea7\u751f $\\mathrm{prev}_k$ \u7684\u8d21\u732e\uff0c  \n\u4f1a\u5bf9 $\\mathrm{suf}_i(i<k,a_i=a_k)$ \u4ea7\u751f $\\mathrm{sufv}_k$ \u7684\u8d21\u732e\u3002\n\n\u7531\u4e8e $a_i$ \u4e0d\u540c\u7684\u5143\u7d20\u5176\u8d21\u732e\u7684\u8ba1\u7b97\u76f8\u4e92\u5206\u79bb\uff0c  \n\u5bf9\u6bcf\u7ec4 $a_i$ \u76f8\u540c\u7684\u5143\u7d20\u5f00\u4e00\u68f5\u5e73\u8861\u6811\u7ef4\u62a4 $\\mathrm{pre},\\mathrm{suf}$ \u53ca\u5176\u533a\u95f4\u548c\u3002\n\n\u7136\u540e\u5c31\u505a\u5b8c\u4e86\uff0c\u7ec6\u8282\u5565\u7684\u4e0a\u9762\u90fd\u6709\u3002\n\n## Code\n```cpp\n/*\nthis code is made by wangrx\n2021-6-20 10:34\n*/\n#include<stdio.h>\n#include<string.h>\n#include<time.h>\n#include<random>\n#include<algorithm>\ntypedef unsigned long long ull;\ntypedef unsigned int word;\ntypedef unsigned short hword;\ntypedef unsigned char byte;\nstruct READ{//\u5feb\u8bfb\n\tchar c;\n\tinline READ(){c=getchar();}\n\ttemplate<typename type>\n\tinline READ& operator >>(register type& num){\n\t\twhile('0'>c||c>'9') c=getchar();\n\t\tfor(num=0;'0'<=c&&c<='9';c=getchar())\n\t\t\tnum=num*10+(c-'0');\n\t\treturn *this;\n\t}\n}cin;\nconst word mod=1e9+7;\nstd::mt19937 RAND(time(0));\nstruct treap{\n\ttreap *l,*r;\n\tword value,size,blc;\n\tword pre,presum,pretag;\n\tword suf,sufsum,suftag;\n\tinline treap(){size=1,blc=RAND();}\n\tinline void preplus(word in){//pre \u533a\u95f4\u52a0\n\t\tif((pre+=in)>=mod) pre-=mod;\n\t\tif((pretag+=in)>=mod) pretag-=mod;\n\t\tif((presum+=(ull)(in)*size%mod)>=mod)\n\t\t\tpresum-=mod;\n\t}\n\tinline void sufplus(word in){//suf \u533a\u95f4\u52a0\n\t\tif((suf+=in)>=mod) suf-=mod;\n\t\tif((suftag+=in)>=mod) suftag-=mod;\n\t\tif((sufsum+=(ull)(in)*size%mod)>=mod)\n\t\t\tsufsum-=mod;\n\t}\n\tinline void pushdown(){//\u6807\u8bb0\u4e0b\u4f20\n\t\tif(pretag){\n\t\t\tif(l) l->preplus(pretag);\n\t\t\tif(r) r->preplus(pretag);\n\t\t\tpretag=0;\n\t\t}\n\t\tif(suftag){\n\t\t\tif(l) l->sufplus(suftag);\n\t\t\tif(r) r->sufplus(suftag);\n\t\t\tsuftag=0;\n\t\t}\n\t}\n\tinline void pushup(){//\u7ed3\u679c\u4e0a\u4f20\n\t\tsize=1,presum=pre,sufsum=suf;\n\t\tif(l){\n\t\t\tsize+=l->size;\n\t\t\tif((presum+=l->presum)>=mod) presum-=mod;\n\t\t\tif((sufsum+=l->sufsum)>=mod) sufsum-=mod;\n\t\t}\n\t\tif(r){\n\t\t\tsize+=r->size;\n\t\t\tif((presum+=r->presum)>=mod) presum-=mod;\n\t\t\tif((sufsum+=r->sufsum)>=mod) sufsum-=mod;\n\t\t}\n\t}\n}p[100010],*root[100010];\ninline treap* merge(treap *l,treap *r){//treap \u5408\u5e76\n\tif(l==0) return r;\n\tif(r==0) return l;\n\tif(l->blc<=r->blc){\n\t\tl->pushdown();\n\t\tl->r=merge(l->r,r);\n\t\treturn l->pushup(),l;\n\t}\n\tr->pushdown();\n\tr->l=merge(l,r->l);\n\treturn r->pushup(),r;\n}\n// treap \u5206\u88c2 (<=value \u7684\u88ab\u4fdd\u7559\uff0c>value \u7684\u9664\u53bb)\ninline treap* split(word value,treap *&root){\n\tif(root==0) return 0;\n\ttreap *out;\n\tif(root->pushdown(),value<root->value){\n\t\tout=split(value,root->l);\n\t\tregister treap *swap=root->l;\n\t\troot->l=out,out=swap;\n\t\tswap=root,root=out,out=swap;\n\t\treturn out->pushup(),out;\n\t}\n\tout=split(value,root->r);\n\treturn root->pushup(),out;\n}\nstruct BIT{//\u6811\u72b6\u6570\u7ec4\n\tword sum[100010];\n\tinline void operator()(){\n\t\tmemset(sum,0,sizeof(sum));}\n\t#define lowbit(x) ((x)&-(x))\n\tinline word operator()(register word id){\n\t\tregister word ans=0;\n\t\tfor(;id;id&=~lowbit(id)) ans+=sum[id];\n\t\treturn ans;\n\t}\n\tinline void operator()(\n\t\tregister word id,register word num){\n\t\tfor(;id<=100000;id+=lowbit(id))\n\t\t\tsum[id]+=num;\n\t}\n}tree;\nword n,m,ans;\nword prev[100010],sufv[100010],num[100010];\ninline bool cmp(register word a,register word b){\n\treturn prev[a]<prev[b];}\nbyte b[100010];\ninline void push(word in){//b_i=1\n\ttreap *left=root[num[in]];\n\ttreap *right=split(in,left);\n\tb[in]=1,p[in].pretag=p[in].suftag=0;\n\tif(left){//\u4f5c\u4e3a p_4 \u7684\u8d21\u732e\n\t\tif((ans+=(ull)(left->presum)*sufv[in]%mod)>=mod) ans-=mod;\n\t\tleft->sufplus(sufv[in]);\n\t\ttreap* bef=left;//\u8ba1\u7b97\u81ea\u8eab\u7684 pre\n\t\twhile(bef->pushdown(),bef->r) bef=bef->r;\n\t\tp[in].presum=p[in].pre=(bef->pre+prev[bef->value])%mod;\n\t}else p[in].presum=p[in].pre=0;\n\tif(right){//\u4f5c\u4e3a p_2 \u7684\u8d21\u732e\n\t\tif((ans+=(ull)(right->sufsum)*prev[in]%mod)>=mod) ans-=mod;\n\t\tright->preplus(prev[in]);\n\t\ttreap* next=right;// \u8ba1\u7b97\u81ea\u8eab\u7684 suf\n\t\twhile(next->pushdown(),next->l) next=next->l;\n\t\tp[in].sufsum=p[in].suf=(next->suf+sufv[next->value])%mod;\n\t}else p[in].sufsum=p[in].suf=0;\n\tif((ans+=(ull)(p[in].pre)*p[in].suf%mod)>=mod) ans-=mod;//\u4f5c\u4e3a p_3 \u7684\u8d21\u732e\n\troot[num[in]]=merge(merge(left,p+in),right);\n}\ninline void pop(word in){//b_i=0\uff0c\u540c\u4e0a\n\ttreap *left=root[num[in]];\n\ttreap *right=split(in,left);\n\tb[in]=0,split(in-1,left);\n\tif(left){\n\t\tif((ans+=mod-(ull)(left->presum)*sufv[in]%mod)>=mod) ans-=mod;\n\t\tleft->sufplus(mod-sufv[in]);\n\t}\n\tif(right){\n\t\tif((ans+=mod-(ull)(right->sufsum)*prev[in]%mod)>=mod) ans-=mod;\n\t\tright->preplus(mod-prev[in]);\n\t}\n\tif((ans+=mod-(ull)(p[in].pre)*p[in].suf%mod)>=mod) ans-=mod;\n\troot[num[in]]=merge(left,right);\n}\nint main(){\n\tcin>>n;\n\tfor(register word i=1;i<=n;++i)\n\t\tcin>>prev[i],sufv[i]=p[i].value=i;\n\tstd::sort(sufv+1,sufv+n+1,cmp);\n\tfor(register word i=1;i<=n;++i)\n\t\tif(prev[sufv[i]]==prev[sufv[i-1]])\n\t\t\tnum[sufv[i]]=num[sufv[i-1]];\n\t\telse num[sufv[i]]=num[sufv[i-1]]+1;\n\t//\u79bb\u6563\u5316\n\n\tfor(register word i=1;i<=n;++i)\n\t\tprev[i]=tree(num[i]),tree(num[i],1);\n\ttree();\n\tfor(register word i=n;i;--i)\n\t\tsufv[i]=tree(num[i]),tree(num[i],1);\n\t//\u6811\u72b6\u6570\u7ec4\u8ba1\u7b97 prev,sufv\n\n\tfor(register word i=1;i<=n;++i) push(i);\n\tword opt,x;\n\tfor(cin>>n;n;--n){\n\t\tcin>>opt>>x,--opt;\n\t\tif(opt!=b[x]) opt? push(x):pop(x);\n\t\tprintf(\"%u\\n\",ans);\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1624152301,
        "uid": 104726,
        "name": "wangrx",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 CF788E New task"
    },
    {
        "content": "#### CF788E New task\n\n\u6570\u636e\u7ed3\u6784\u597d\u9898\uff01\n\n\u6ce8\u610f\u5230\u8fd9\u4e2a\u4e94\u5143\u7ec4\u7684\u6761\u4ef6\u975e\u5e38\u7684\u5bf9\u79f0\uff0c\u56e0\u6b64\u8003\u8651\u641e\u7b2c\u4e09\u4e2a\u6570\u3002\n\n\u5148\u4e0d\u8003\u8651$B$\u7684\u503c\u548c\u4fee\u6539\uff0c\u4e5f\u5c31\u662f\u6c42\u51fa\u6700\u5f00\u59cb\u7684\u7b54\u6848\uff0c\u4e00\u4e2a\u6bd4\u8f83\u7b80\u5355\u7684\u601d\u8def\u662f\u5bf9\u4e8e\u4e00\u4e2a\u4f4d\u7f6e$x$\uff0c\u8bb0\u5f55\u4e00\u4e0b\u524d\u8fb9\u6709\u591a\u5c11\u4e2a$A[x]$\u4ee5\u53ca\u5176\u65b9\u6848\u6570\u4e4b\u548c\uff0c\u540e\u8fb9\u4e5f\u7c7b\u4f3c\uff0c\u6700\u540e\u4e58\u8d77\u6765\u3002\n\n\u6211\u4eec\u8bbe\u8fd9\u4e2a\u4e94\u5143\u7ec4\u4e3a$(a,b,c,d,e)$\uff0c\u90a3\u4e48\u6ce8\u610f\u5230\u6211\u4eec\u521a\u521a\u7684\u64cd\u4f5c\u5b9e\u9645\u4e0a\u662f\u7edf\u8ba1\u4e86$(a,b)$\u548c$(d,e)$\u7684\u7b54\u6848\uff0c\u7136\u540e\u679a\u4e3e$c$\u4e58\u8d77\u6765\u3002\u7136\u540e\u6211\u4eec\u53d1\u73b0\u4e00\u4e2a\u6bd4\u8f83\u4f18\u79c0\u7684\u6027\u8d28\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a$a$\u548c$e$\u7684$B$\u503c\u5b9e\u9645\u4e0a\u662f\u65e0\u6240\u8c13\u7684\uff0c\u56e0\u6b64\u6211\u4eec\u53ea\u9700\u8981\u8003\u8651\u8fd9\u4e2a$b$\u548c$d$\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u4f4d\u7f6e$x$\uff0c\u5176\u4f5c\u4e3a$b$\u548c$d$\u7684\u65b9\u6848\u6570\u663e\u7136\u6bd4\u8f83\u597d\u6c42\uff0c\u53ef\u4ee5\u62ff\u6811\u72b6\u6570\u7ec4\u9884\u5904\u7406\u51fa\u6765\u3002\n\n\u90a3\u4e48\u5173\u952e\u5c31\u662f\u7edf\u8ba1\u7b54\u6848\uff0c\u6ce8\u610f\u5230\u4e24\u4e2a\u533a\u95f4\u5408\u5e76\u4e3a\u4e00\u4e2a\u5927\u533a\u95f4\u7684\u65f6\u5019\u5176\u5b9e\u6bd4\u8f83\u597d\u8f6c\u79fb\uff0c\u90a3\u4e48\u8003\u8651\u7ebf\u6bb5\u6811\u7ef4\u62a4\u4e00\u4e0b\uff0c\u5bf9\u4e8e\u76f8\u540c\u7684\u6743\u503c$v$\uff0c\u6211\u4eec\u641e\u4e00\u68f5\u7ebf\u6bb5\u6811\uff0c\u628a\u6743\u503c\u4e3a$v$\u7684\u90fd\u641e\u8fdb\u53bb\uff0c\u7ef4\u62a4\u8fd9\u4e9b$v$\u5728\u539f\u5e8f\u5217\u4e2d\u7684\u4f4d\u7f6e\uff0c\u7ebf\u6bb5\u6811$pushup$\u7684\u65f6\u5019\u5408\u5e76\u4e24\u4e2a\u5b50\u533a\u95f4\u7684\u7b54\u6848\u3002\u5373\u53ef\u65b9\u4fbf\u7684\u8ba1\u7b97$c=v$\u7684\u7b54\u6848\u3002\n\n\u4fee\u6539\u7684\u8bdd\u5c31\u5bf9\u4e8e$B$\u503c\u53d8\u4e3a0\u7684\u5730\u65b9\u6211\u4eec\u76f4\u63a5\u628a\u8fd9\u4e2a\u70b9\u6682\u65f6\u5220\u6389\u5373\u53ef\u3002\n\n\u4f46\u662f\u8fd9\u6837\u505a\u4f1a\u6709\u4e2a\u95ee\u9898\uff0c\u7a7a\u95f4\u5f00\u4e0d\u4e0b\uff0c\u5c06\u6743\u503c\u7ebf\u6bb5\u6811\u52a8\u6001\u5f00\u70b9\u5373\u53ef\u3002\n\n\u8fd9\u662f\u8fd9\u4e00\u7c7b\u95ee\u9898\u7684\u6bd4\u8f83\u7ecf\u5178\u7684\u9898\u76ee\uff0c\u5bf9\u4e8e\u4e24\u4e2a\u533a\u95f4\u7b54\u6848\u5408\u5e76\u8d77\u6765\u4e0d\u662f\u5f88\u56f0\u96be\u7684\u95ee\u9898\uff0c\u90fd\u53ef\u4ee5\u8003\u8651\u7528\u7ebf\u6bb5\u6811\u89e3\u51b3\u3002\n\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<cstring>\n#include<algorithm>\n#define N 600005\n#define mod 1000000007\n#define lowbit(x) x&-x\n#define int long long\nusing namespace std;\nint read()\n{\n\tint x=0,f=1;char ch=getchar();\n\twhile(ch<'0'||ch>'9'){if(ch=='-')f=-1;ch=getchar();}\n\twhile(ch>='0'&&ch<='9'){x=(x<<3)+(x<<1)+(ch^48);ch=getchar();}\n\treturn x*f;\n}\nint n,m,q,A[N],a[N],pre[N],suf[N],ans;\nstruct BIT\n{\n\tint c[N];\n\tvoid init(){memset(c,0,sizeof(c));}\n\tvoid modify(int x,int k){for(;x<=m;x+=lowbit(x))c[x]+=k;}\n\tint query(int x){int res=0;for(;x;x-=lowbit(x))res+=c[x];return res;}\n}t;\nstruct Segment_Tree\n{\n\tint cnt,ls[N<<2],rs[N<<2],sum[N<<2],B[N<<2],D[N<<2],BC[N<<2],CD[N<<2],BCD[N<<2];\n\tvoid push_up(int k)\n\t{\n\t\tsum[k]=(sum[ls[k]]+sum[rs[k]])%mod;\n\t\tB[k]=(B[ls[k]]+B[rs[k]])%mod;\n\t\tD[k]=(D[ls[k]]+D[rs[k]])%mod;\n\t\tBC[k]=(BC[ls[k]]+BC[rs[k]]+B[ls[k]]*sum[rs[k]]%mod)%mod;\n\t\tCD[k]=(CD[ls[k]]+CD[rs[k]]+sum[ls[k]]*D[rs[k]]%mod)%mod;\n\t\tBCD[k]=(BCD[ls[k]]+BCD[rs[k]]+B[ls[k]]*CD[rs[k]]%mod+BC[ls[k]]*D[rs[k]]%mod)%mod;\n\t}\n\tvoid modify(int k,int l,int r,int x,int Pre,int Suf,int val)\n\t{\n\t\t//printf(\"----%d %d %d %d %d %d %d\\n\",k,l,r,x,Pre,Suf,val);\n\t\tif(l==r){B[k]=Pre;D[k]=Suf;sum[k]+=val;return;}\n\t\tint mid=(l+r)>>1;\n\t\tif(x<=mid){if(!ls[k])ls[k]=++cnt;modify(ls[k],l,mid,x,Pre,Suf,val);}\n\t\telse{if(!rs[k])rs[k]=++cnt;modify(rs[k],mid+1,r,x,Pre,Suf,val);}\n\t\tpush_up(k);\n\t}\n}T;\nsigned main()\t\n{\n\tn=read();\n\tfor(int i=1;i<=n;i++)A[i]=a[i]=read();\n//\tcout<<\"!!!!!!\"<<endl;\n\tsort(a+1,a+1+n);m=unique(a+1,a+1+n)-a-1;\n\tfor(int i=1;i<=n;i++)A[i]=lower_bound(a+1,a+1+m,A[i])-a;\n\tfor(int i=1;i<=n;i++)pre[i]=t.query(A[i]),t.modify(A[i],1);\n\tt.init();\n\tfor(int i=n;i>=1;i--)suf[i]=t.query(A[i]),t.modify(A[i],1);\n//\tfor(int i=1;i<=n;i++)\n//\t{\n//\t\tprintf(\"%d %d\\n\",pre[i],suf[i]);\n//\t}\n\tT.cnt=m;\n\tfor(int i=1;i<=n;i++)T.modify(A[i],1,n,i,pre[i],suf[i],1);\n\tfor(int i=1;i<=m;i++)ans+=T.BCD[i],ans%=mod;;\n\t//cout<<ans<<endl;\n\tq=read();\n\twhile(q--)\n\t{\n\t\tint opt=read(),x=read();\n\t\tans=(ans+mod-T.BCD[A[x]])%mod;\n\t\tif(opt==1)T.modify(A[x],1,n,x,0,0,-1);\n\t\telse T.modify(A[x],1,n,x,pre[x],suf[x],1);\n\t\tans=(ans+T.BCD[A[x]])%mod;\n//\t\tfor(int i=1;i<=T.cnt;i++)\n//\t\t{\n//\t\t\tprintf(\"%d %d %d %d %d %d %d\\n\",i,T.B[i],T.sum[i],T.D[i],T.BC[i],T.CD[i],T.BCD[i]);\n//\t\t}\n\t\tprintf(\"%lld\\n\",ans);\n\t}\n\treturn 0;\n}\n```\n\n",
        "postTime": 1612014375,
        "uid": 179600,
        "name": "shao0320",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 CF788E \u3010New task\u3011"
    },
    {
        "content": "## $\\text{Description}$\n\u6709\u4e00\u4e2a\u957f\u5ea6\u4e3a $n$ \u7684\u6570\u5217 $a_i$\uff0c\u7b2c $i$ \u4e2a\u6570\u6709\u4e00\u4e2a\u96f6\u4e00\u5c5e\u6027 $b_i$\uff0c\u521d\u59cb\u6240\u6709\u7684 $b$   \u90fd\u4e3a $1$.  \n$m$ \u6b21\u64cd\u4f5c\uff0c\u5206\u4e3a\u4e24\u79cd\uff1a\n\n>$1 \\space x$ \uff1a\u4ee4 $b_x=0$.  \n>$2 \\space x$ \uff1a\u4ee4 $b_x=1$\n\n\u6bcf\u6b21\u64cd\u4f5c\u540e\u8f93\u51fa\u6ee1\u8db3\u6761\u4ef6\u7684 $p_1<p_2<p_3<p_4<p_5$\uff0c\u6ee1\u8db3 $a_{p_1} \\le a_{p_2} =a_{p_3}=a_{p_4} \\ge a_{p_5}$ \u4e14 $b_{p_2}=b_{p_3}=b_{p_4}=1$ \u7684\u4e2a\u6570.  \n\u5bf9 $10^9+7$ \u53d6\u6a21\u7684\u503c.  \n\uff08\u4fdd\u8bc1\u6bcf\u6b21\u4fee\u6539\u540e\u7684 $b_i$ \u90fd\u4e0e\u539f\u6765\u4e0d\u540c\uff09\n\n## $\\text{Solution}$\n\u5f88\u9002\u5408\u7ec3\u624b\u7684\u6570\u636e\u7ed3\u6784\u9898.  \n\u4e00\u5f00\u59cb\u53ea\u60f3\u5230\u6811\u5957\u6811\u6b7b\u5361\u7a7a\u95f4\u7136\u540e\u88ab @24KH \u4e00\u8bed\u70b9\u7834\u6839\u672c\u4e0d\u7528\u5957.%%%  \n\u672c\u9898\u7684\u5173\u952e\u5c31\u662f\u52a8\u6001\u7edf\u8ba1\u52a0\u5165\u4e00\u4e2a\u70b9\u7684\u8d21\u732e.  \n\u8bbe $l_i$ \u8868\u793a\u6ee1\u8db3 $j<i,a_j\\le a_i$ \u7684 $j$ \u7684\u4e2a\u6570.  \n$r_i$ \u8868\u793a\u6ee1\u8db3 $j>i,a_j\\le a_i$ \u7684 $j$ \u7684\u4e2a\u6570.  \n\u90a3\u4e48\u6211\u4eec\u8003\u8651\u52a0\u5165\u4e00\u4e2a\u70b9 $p$ \u65f6\u7684\u8d21\u732e\uff1a  \n### p \u4f5c\u4e3a\u4e2d\u95f4\u5143\u7d20  \n\u589e\u52a0\u7684\u65b9\u6848\u6570\u4e3a\uff1a\n\n$$\n\\large\n\\sum_{i<p<j \\land a_i=a_p=a_j}l_i\\times r_j\n$$\n\u4e5f\u5c31\u662f\uff1a\n$$\n\\large\n\\sum_{i<p \\land a_i=a_p}l_i\\times \\sum_{j>p \\land a_j=a_p}r_j\n$$\n### p \u4f5c\u4e3a\u4e24\u7aef\u5143\u7d20\n\u7531\u4e8e\u5bf9\u79f0\uff0c\u5355\u4e3e $p$ \u5728\u6700\u5de6\u4fa7\u4e3a\u4f8b.  \n\u589e\u52a0\u7684\u65b9\u6848\u6570\u4e3a\uff1a\n$$\n\\large\n\\sum_{p<i\\land a_i=a_p}l_p\\times r_i\\times\\sum_{p<j<i}[a_j=a_p]\n$$\n\u6362\u53e5\u8bdd\u8bf4\u5c31\u662f $(p,i)$ \u4e4b\u95f4\u6bcf\u6709\u4e00\u4e2a\u6743\u503c\u76f8\u7b49\u7684\u70b9\uff0c$(p,i)$ \u4f5c\u4e3a\u76f8\u7b49\u7684\u4e24\u7aef\u5c31\u80fd\u4ea7\u751f\u4e00\u6b21\u8d21\u732e.  \n### \u7edf\u8ba1\n\u79bb\u6563\u5316\u540e\u5bf9\u6bcf\u4e2a\u6743\u503c\u5efa\u4e00\u68f5\u7ebf\u6bb5\u6811.  \n$\\sum l_i/r_i$ \u7edf\u8ba1\u8f83\u4e3a\u7b80\u5355.  \n\u6bd4\u8f83\u56f0\u96be\u7684\u5c31\u662f\u7edf\u8ba1\uff1a\n$$\n\\large\n\\sum_{p<i\\land a_i=a_p}r_i\\times\\sum_{p<j<i}[a_j=a_p]\n$$\n\u8fd9\u4e00\u9879.  \n\u8bbe $rans$ \u4e3a\u8fd9\u4e00\u9879\u7684\u7b54\u6848\uff0c$lans$ \u4e3a\u8fd9\u4e00\u9879\u5bf9\u79f0\u7684\u7b54\u6848,\u540c\u65f6\u8bb0\u5f55\u6570\u7684\u4e2a\u6570 $siz$\uff0c$\\sum l_i,\\sum r_i$  \n\u5408\u5e76\u5de6\u53f3\u513f\u5b50\u65f6\uff1a\n$$siz_{ls}+siz_{rs}\\to siz_{fa}$$\n$$lsum_{ls}+lsum_{rs}\\to lsum_{fa}$$\n$$rsum_{ls}+rsum_{rs}\\to rsum_{fa}$$\n$$lans_{ls}+lans_{rs}+lsum_{ls}\\times siz_{rs}\\to lans_{fa}$$\n$$rans_{ls}+rans_{rs}+rsum_{rs}\\times siz_{ls}\\to rans_{fa}$$\n\u5373\u53ef.\n\n## $\\text{Code}$\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define ll long long\n#define double long double \n#define ull unsigned long long\n#define debug(...) fprintf(stderr,__VA_ARGS__)\nconst int N=1e5+100;\nconst int mod=1e9+7;\ninline ll read(){\n  ll x(0),f(1);char c=getchar();\n  while(!isdigit(c)){if(c=='-')f=-1;c=getchar();}\n  while(isdigit(c)){x=(x<<1)+(x<<3)+c-'0';c=getchar();}\n  return x*f;\n}\n\nint n,m;\nll le[N],ri[N];\nint id[N],bac[N];\n\n#define mid ((l+r)>>1)\nstruct node{\n  ll siz;\n  ll lsum,rsum;\n  ll lans,rans;\n};\nnode merge(node a,node b){\n  return (node){a.siz+b.siz,(a.lsum+b.lsum)%mod,(a.rsum+b.rsum)%mod,\n      (a.lans+b.lans+a.lsum*b.siz)%mod,(a.rans+b.rans+a.siz*b.rsum)%mod};\n}\nstruct tree{\n  node o;\n  int ls,rs;\n}tr[N<<5];\nint rt[N],tot;\ninline int copy(int x){\n  ++tot;tr[tot]=tr[x];\n  return tot;\n}\nvoid add(int &k,int l,int r,int p,int w){\n  if(!k) k=copy(k);\n  if(l==r){\n    tr[k].o.siz+=w;\n    tr[k].o.lsum+=w*le[l];\n    tr[k].o.rsum+=w*ri[l];\n    return;\n  }\n  if(p<=mid) add(tr[k].ls,l,mid,p,w);\n  else add(tr[k].rs,mid+1,r,p,w);\n  tr[k].o=merge(tr[tr[k].ls].o,tr[tr[k].rs].o);\n  //printf(\"  k=%d (%d %d) l\")\n}\n//op=1:lsum\n//op=2:lans\n//op=3:rsum\n//op=4:rans\nnode ask(int k,int l,int r,int x,int y){\n  if(!k||x>y) return (node){0,0,0,0,0};\n  if(x<=l&&r<=y) return tr[k].o;\n  if(y<=mid) return ask(tr[k].ls,l,mid,x,y);\n  else if(x>mid) return ask(tr[k].rs,mid+1,r,x,y);\n  else return merge(ask(tr[k].ls,l,mid,x,y),ask(tr[k].rs,mid+1,r,x,y));\n}\n\nint q[N],cnt,a[N];\nint f[N];\ninline void Add(int p){\n  for(;p<=cnt;p+=p&-p) ++f[p];\n  return;\n}\ninline int Ask(int p){\n  int res(0);\n  for(;p;p-=p&-p) res+=f[p];\n  return res;\n}\n\ninline ll calc(int pl){\n  int o=rt[a[pl]];\n  node L=ask(o,1,n,1,pl-1),R=ask(o,1,n,pl+1,n);\n  return (L.lsum*R.rsum%mod+L.lans*ri[pl]%mod+R.rans*le[pl]%mod)%mod;\n}\nll tt;\nsigned main(){\n#ifndef ONLINE_JUDGE\n  freopen(\"a.in\",\"r\",stdin);\n  freopen(\"a.out\",\"w\",stdout);\n#endif\n  n=read();\n  for(int i=1;i<=n;i++) q[i]=a[i]=read();\n  sort(q+1,q+1+n);\n  cnt=unique(q+1,q+1+n)-q-1;\n  for(int i=1;i<=n;i++) a[i]=lower_bound(q+1,q+1+cnt,a[i])-q;\n  for(int i=1;i<=n;i++){\n    le[i]=Ask(a[i]);Add(a[i]);\n  }\n  memset(f,0,sizeof(f));\n  for(int i=n;i>=1;i--){\n    ri[i]=Ask(a[i]);Add(a[i]);\n  }\n  for(int i=1;i<=n;i++) id[i]=++bac[a[i]];\n  //for(int i=1;i<=n;i++) printf(\"i=%d a=%d le=%lld ri=%lld id=%d\\n\",i,a[i],le[i],ri[i],id[i]);\n  for(int i=1;i<=n;i++){\n    tt+=calc(i);tt%=mod;\n    add(rt[a[i]],1,n,i,1);\n  }\n  m=read();\n  for(int i=1;i<=m;i++){\n    int op=read(),x=read();\n    if(op==1){\n      add(rt[a[x]],1,n,x,-1);tt-=calc(x);\n    }\n    else{\n      tt+=calc(x);add(rt[a[x]],1,n,x,1);\n    }\n    tt+=mod;tt%=mod;\n    printf(\"%lld\\n\",tt);\n  }\n  return 0;\n}\n/*\n\n\n*/\n\n```\n",
        "postTime": 1639469296,
        "uid": 449265,
        "name": "wind_whisper",
        "ccfLevel": 10,
        "title": "CF788E New task"
    },
    {
        "content": "[Codeforces \u9898\u76ee\u4f20\u9001\u95e8](https://codeforces.com/contest/788/problem/E) & [\u6d1b\u8c37\u9898\u76ee\u4f20\u9001\u95e8](https://www.luogu.com.cn/problem/CF788E)\n\n~~\u8fd9\u662f\u4e00\u9053 *2900 \u7684 D1E\uff0c\u800c\u4e14\u88ab\uff01\u6211\uff01\u81ea\uff01\u5df1\uff01\u641e\uff01\u51fa\uff01\u6765\uff01\u4e86\uff01~~\n\n~~\u867d\u7136\u6211\u627f\u8ba4\u5b83\u96be\u5ea6\u53ca\u6446\u653e\u7684\u4f4d\u7f6e\u5f02\u5e38\u5f02\u5e38\u865a\u9ad8\uff0c\u5e76\u4e14\u5c31\u7b97\u6211\u5230\u4e86\u73b0\u573a\u4e5f\u4e0d\u53ef\u80fd\u5207\u6389~~\n\n\u4e0b\u8bb0 $t_x$ \u8868\u793a $x$ \u662f\u5426\u53ef\u4ee5\u88ab\u9009\u62e9\u3002\n\n\u9996\u5148\u9898\u76ee\u8981\u6211\u4eec\u7edf\u8ba1\u4e94\u5143\u7ec4 $(a,b,c,d,e)$ \u7684\u4e2a\u6570\uff0c\u4f46\u7a0d\u5fae\u89c2\u5bdf\u4e0b\u5c31\u80fd\u53d1\u73b0 $a,e$ \u7684\u4e2a\u6570\u662f\u5f88\u597d\u7ef4\u62a4\u7684\uff0c\u5e76\u4e14\u5b83\u4e0d\u53d7\u5230 $t_x$ \u7684\u503c\u7684\u5f71\u54cd\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u63d0\u524d\u628a\u5b83\u9884\u5904\u7406\u51fa\u6765\uff0c\u8bb0 $pre_i=\\sum\\limits_{j=1}^{i-1}[a_j\\le a_i]$\uff0c$nxt_i=\\sum\\limits_{j=i+1}^n[a_j\\le a_i]$\uff0c\u90a3\u4e48\u663e\u7136\u5bf9\u4e8e\u56fa\u5b9a\u7684\u4e09\u5143\u7ec4 $(b,c,d)$ \u5408\u6cd5\u7684 $a$ \u7684\u4e2a\u6570\u4e3a $pre_b$\uff0c\u5408\u6cd5\u7684 $e$ \u7684\u4e2a\u6570\u4e3a $nxt_d$\uff0c\u4e5f\u5c31\u662f\u8bf4\u8981\u6c42\u7684\u8fd9\u4e1c\u897f\u7b49\u4ef7\u4e8e $\\sum\\limits_{1\\le b\\le c\\le d\\le n}pre_b\u00b7nxt_d\u00b7[a_b=a_c=a_d]$\n\n\u5176\u6b21\u8003\u8651\u4e00\u6b21\u4fee\u6539\u5bf9\u7b54\u6848\u7684\u5f71\u54cd\uff0c\u663e\u7136\u6bcf\u6b21\u5c06\u67d0\u4e2a\u70b9 $x$ \u7531\u53ef\u9009\u72b6\u6001\u8bbe\u4e3a\u4e0d\u53ef\u9009\u72b6\u6001\uff0c\u7b54\u6848\u7684\u53d8\u5316\u91cf\u4e3a\u5305\u542b $x$ \u7684\u4e09\u5143\u7ec4 $(b,c,d)$ \u7684\u8d21\u732e\u7684\u76f8\u53cd\u6570\uff1b\u53cd\u4e4b\u4e5f\u540c\u7406\u3002\u56e0\u6b64\u6211\u4eec\u53ea\u9700\u7ef4\u62a4\u5305\u542b $x$ \u7684\u4e09\u5143\u7ec4 $(b,c,d)$ \u7684\u8d21\u732e\u4e4b\u548c\u3002\u8fd9\u4e2a\u53ef\u4ee5\u5206\u4e09\u79cd\u60c5\u51b5\uff1a\n\n- $c=x$\uff0c\u7531\u4e8e $b$ \u4e0e $d$ \u7684\u8d21\u732e\u76f8\u4e92\u72ec\u7acb\uff0c\u6545\u53ef\u7b97\u51fa $b,d$ \u7684\u8d21\u732e\u540e\u7528\u4e58\u6cd5\u539f\u7406\u5c06\u5176\u4e58\u8d77\u6765\uff0c\u5373 $\\sum\\limits_{b=1}^{x-1}pre_b[a_b=a_x\\land t_b=1]\\times\\sum\\limits_{d=x+1}^nnxt_d[a_d=a_x\\land t_d=1]$\u3002\n- $b=x$\uff0c\u6211\u4eec\u8bb0 $s_i=\\sum\\limits_{j=1}^i[a_j=a_i\\land t_j=1]$\uff0c\u8003\u8651\u679a\u4e3e $d$\uff0c\u90a3\u4e48\u5408\u6cd5\u7684 $c$ \u7684\u4e2a\u6570\u5373\u4e3a $s_d-s_x-1$\uff0c\u5373 $\\sum\\limits_{d=x+1}^n(s_d-s_x-1)\\times nxt_d\\times[a_d=a_x\\land t_d=1]$\n\n- $d=x$\uff0c\u4e0e $b=x$ \u7684\u60c5\u51b5\u7c7b\u4f3c\uff0c\u8fd9\u91cc\u5c31\u4e0d\u518d\u8d58\u8ff0\u4e86\u3002\n\n\u8003\u8651\u600e\u6837\u7ef4\u62a4\u8fd9\u4e2a\u4e1c\u897f\u3002\u6211\u4eec\u5c06 $a_i$ \u79bb\u6563\u5316\u5e76\u5bf9\u6bcf\u4e2a $a_i$ \u5efa\u4e00\u68f5\u52a8\u6001\u5f00\u70b9\u7ebf\u6bb5\u6811\u3002\u5177\u4f53\u6765\u8bf4\u5047\u8bbe\u5bf9\u4e8e $x$ \u8fd9\u4e2a\u503c\u5b58\u5728 $k_x$ \u4e2a $a_t=x$ \u7684 $t$\uff0c\u4ece\u5c0f\u5230\u5927\u4f9d\u6b21\u662f $p_1,p_2,\\dots,p_{k_x}$\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u5efa\u4e00\u68f5\u957f\u5ea6\u4e3a $k_x$ \u7684\u7ebf\u6bb5\u6811\uff0c\u7ebf\u6bb5\u6811\u4e0a\u6bcf\u4e00\u4e2a\u533a\u95f4 $[l,r]$ \u7ef4\u62a4\u4ee5\u4e0b\u4e94\u4e2a\u503c\uff1a\n\n- $pre0:\\sum\\limits_{i=l}^rpre_{p_i}\\times t_{p_i}$\n- $nxt0:\\sum\\limits_{i=l}^rnxt_{p_i}\\times t_{p_i}$\n- $pre1:\\sum\\limits_{i=l}^rpre_{p_i}\\times t_{p_i}\\times s_{p_i}$\n- $nxt1:\\sum\\limits_{i=l}^rnxt_{p_i}\\times t_{p_i}\\times s_{p_i}$\n- $cnt:\\sum\\limits_{i=l}^rt_{p_i}$\n\n\u90a3\u4e48 $c=x$ \u7684\u60c5\u51b5\u6211\u4eec\u53ea\u9700\u67e5\u4e00\u904d $pre0,nxt0$ \u5373\u53ef\uff0c$b=x$ \u7684\u60c5\u51b5\u6211\u4eec\u53ef\u5c06\u8be2\u95ee\u6539\u5199\u6210 $\\sum\\limits_{d=x+1}^ns_d\\times nxt_d\\times t_d\\times[a_d=a_x]-(s_x+1)\\times\\sum\\limits_{d=x+1}^ns_d\\times t_d\\times[a_d=a_x]$\uff0c\u8fd9\u6837\u6211\u4eec\u53ea\u9700\u67e5\u4e00\u904d $cnt,nxt0,nxt1$ \u5373\u53ef\u3002$d=x$ \u7684\u60c5\u51b5\u4e5f\u53ef\u4ee5\u91c7\u7528\u7c7b\u4f3c\u7684\u6539\u5199\u65b9\u5f0f\uff0c\u53ea\u9700\u67e5\u4e00\u904d $cnt,pre0,pre1$ \u5373\u53ef\uff0c\u8fd9\u6837\u6211\u4eec\u5373\u53ef\u5728\u5bf9\u6570\u65f6\u95f4\u5185\u6c42\u51fa\u5305\u542b $x$ \u7684\u4e09\u5143\u7ec4 $(b,c,d)$ \u7684\u8d21\u732e\u3002\n\n\u6700\u540e\u8003\u8651\u4fee\u6539\u5bf9\u7ebf\u6bb5\u6811\u7ef4\u62a4\u7684\u4e94\u4e2a\u503c\u7684\u5f71\u54cd\uff0c\u663e\u7136\u6700\u521d\u6240\u6709\u7684 $s_{p_i}=i,t_{p_i}=1$\uff0c\u6240\u4ee5\u6211\u4eec\u4ee4\u6240\u6709\u53f6\u5b50\u8282\u70b9 $[i,i]$ \u7684 $pre0$ \u4e3a $pre_{p_i}$\uff0c$nxt0$ \u4e3a $nxt_{p_i}$\uff0c$pre1$ \u4e3a $pre_{p_i}\\times i$\uff0c$nxt1$ \u4e3a $nxt_{p_i}\\times i$\uff0c$cnt$ \u4e3a $1$\uff0c\u800c\u5bf9\u4e8e\u4e00\u6b21\u4fee\u6539\u64cd\u4f5c\uff0c\u5047\u8bbe\u6211\u4eec\u4fee\u6539\u4e86 $x$ \u7684\u72b6\u6001\uff0c\u90a3\u4e48\u663e\u7136\u6211\u4eec\u9700\u8981\u8fdb\u884c\u4e24\u6b21\u64cd\u4f5c\uff1a\n\n- \u4ee4 $t_x=0$ \u6216 $t_x=1$\n- \u5047\u8bbe $x$ \u5728 $a_x$ \u7684\u7ebf\u6bb5\u6811\u4e0a\u7684\u4f4d\u7f6e\u4e3a $p$\uff0c\u90a3\u4e48\u6211\u4eec\u9700\u4ee4 $[p+1,k_{a_x}]$ \u7684 $s$ \u503c\u52a0 $1$ \u6216\u51cf $1$\n\n\u7b2c\u4e00\u4e2a\u64cd\u4f5c\u663e\u7136\u5c31\u9012\u5f52\u5230\u53f6\u5b50\u8282\u70b9\u5355\u8c03\u4fee\u6539\u5373\u53ef\u3002\u7b2c\u4e8c\u4e2a\u64cd\u4f5c\u5c31\u5728\u5bf9\u5e94\u533a\u95f4\u4e0a\u6267\u884c\u533a\u95f4\u52a0\u64cd\u4f5c\uff0c\u5047\u8bbe\u6211\u4eec\u8981\u5bf9 $[l,r]$ \u533a\u95f4\u7684 $s$ \u503c\u6267\u884c $+x$ \u64cd\u4f5c\uff0c\u90a3\u4e48\u6211\u4eec\u663e\u7136\u5c31\u4ee4 $pre_1\\leftarrow pre_1+pre_0\\times x$\uff0c$nxt_1\\leftarrow nxt_1+nxt_0\\times x$\uff0c\u76f4\u63a5\u6253\u4e2a\u61d2\u6807\u8bb0\u5c31\u884c\u4e86\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $n\\log n$\uff0c\u5e38\u6570\u6709\u4ebf\u70b9\u5927\uff0c~~\u56e0\u6b64\u53c8\u4e00\u6b21\u8363\u81ba\u4e86\u6700\u52a3\u89e3~~\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n#define fi first\n#define se second\n#define fill0(a) memset(a,0,sizeof(a))\n#define fill1(a) memset(a,-1,sizeof(a))\n#define fillbig(a) memset(a,63,sizeof(a))\n#define pb push_back\n#define ppb pop_back\n#define mp make_pair\ntemplate<typename T1,typename T2> void chkmin(T1 &x,T2 y){if(x>y) x=y;}\ntemplate<typename T1,typename T2> void chkmax(T1 &x,T2 y){if(x<y) x=y;}\ntypedef pair<int,int> pii;\ntypedef long long ll;\ntypedef unsigned int u32;\ntypedef unsigned long long u64;\nnamespace fastio{\n\t#define FILE_SIZE 1<<23\n\tchar rbuf[FILE_SIZE],*p1=rbuf,*p2=rbuf,wbuf[FILE_SIZE],*p3=wbuf;\n\tinline char getc(){return p1==p2&&(p2=(p1=rbuf)+fread(rbuf,1,FILE_SIZE,stdin),p1==p2)?-1:*p1++;}\n\tinline void putc(char x){(*p3++=x);}\n\ttemplate<typename T> void read(T &x){\n\t\tx=0;char c=getchar();T neg=0;\n\t\twhile(!isdigit(c)) neg|=!(c^'-'),c=getchar();\n\t\twhile(isdigit(c)) x=(x<<3)+(x<<1)+(c^48),c=getchar();\n\t\tif(neg) x=(~x)+1;\n\t}\n\ttemplate<typename T> void recursive_print(T x){if(!x) return;recursive_print(x/10);putc(x%10^48);}\n\ttemplate<typename T> void print(T x){if(!x) putc('0');if(x<0) putc('-'),x=~x+1;recursive_print(x);}\n\tvoid print_final(){fwrite(wbuf,1,p3-wbuf,stdout);}\n}\nconst int MAXN=1e5;\nconst int MOD=1e9+7;\nconst int INV3=333333336;\nint n,qu,a[MAXN+5],key[MAXN+5],uni[MAXN+5],num=0;\nint t[MAXN+5],pre[MAXN+5],nxt[MAXN+5];\nvoid add(int x,int v){for(int i=x;i<=num;i+=(i&-i)) t[i]+=v;}\nint ask(int x){int ret=0;for(int i=x;i;i&=(i-1)) ret+=t[i];return ret;}\nvector<int> pos[MAXN+5];int where[MAXN+5],cnt[MAXN+5];\nstruct node{\n\tint ch[2];\n\tint lz_pre,lz_nxt,cnt;\n\tint pre0,pre1;\n\tint nxt0,nxt1;\n} s[MAXN*4+5];\nint rt[MAXN+5],ncnt=0;\nvoid pushup(int k){\n\ts[k].pre0=(s[s[k].ch[0]].pre0+s[s[k].ch[1]].pre0)%MOD;\n\ts[k].pre1=(s[s[k].ch[0]].pre1+s[s[k].ch[1]].pre1)%MOD;\n\ts[k].nxt0=(s[s[k].ch[0]].nxt0+s[s[k].ch[1]].nxt0)%MOD;\n\ts[k].nxt1=(s[s[k].ch[0]].nxt1+s[s[k].ch[1]].nxt1)%MOD;\n\ts[k].cnt=s[s[k].ch[0]].cnt+s[s[k].ch[1]].cnt;\n}\nvoid build(int &k,int l,int r,int v){\n\tk=++ncnt;\n\tif(l==r){\n\t\ts[k].cnt=1;\n\t\ts[k].pre0=pre[pos[v][l-1]];s[k].pre1=1ll*l*s[k].pre0%MOD;\n\t\ts[k].nxt0=nxt[pos[v][l-1]];s[k].nxt1=1ll*(cnt[v]-l+1)*s[k].nxt0%MOD;\n\t\treturn;\n\t} int mid=l+r>>1;\n\tbuild(s[k].ch[0],l,mid,v);build(s[k].ch[1],mid+1,r,v);\n\tpushup(k);\n}\nvoid pushdown(int k){\n\tif(s[k].lz_pre){\n\t\ts[s[k].ch[0]].pre1=(s[s[k].ch[0]].pre1+1ll*s[k].lz_pre*s[s[k].ch[0]].pre0%MOD)%MOD;\n\t\ts[s[k].ch[0]].lz_pre=(s[s[k].ch[0]].lz_pre+s[k].lz_pre)%MOD;\n\t\ts[s[k].ch[1]].pre1=(s[s[k].ch[1]].pre1+1ll*s[k].lz_pre*s[s[k].ch[1]].pre0%MOD)%MOD;\n\t\ts[s[k].ch[1]].lz_pre=(s[s[k].ch[1]].lz_pre+s[k].lz_pre)%MOD;\n\t\ts[k].lz_pre=0;\n\t} if(s[k].lz_nxt){\n\t\ts[s[k].ch[0]].nxt1=(s[s[k].ch[0]].nxt1+1ll*s[k].lz_nxt*s[s[k].ch[0]].nxt0%MOD)%MOD;\n\t\ts[s[k].ch[0]].lz_nxt=(s[s[k].ch[0]].lz_nxt+s[k].lz_nxt)%MOD;\n\t\ts[s[k].ch[1]].nxt1=(s[s[k].ch[1]].nxt1+1ll*s[k].lz_nxt*s[s[k].ch[1]].nxt0%MOD)%MOD;\n\t\ts[s[k].ch[1]].lz_nxt=(s[s[k].ch[1]].lz_nxt+s[k].lz_nxt)%MOD;\n\t\ts[k].lz_nxt=0;\n\t}\n}\nint query_cnt(int k,int l,int r,int ql,int qr){\n\tif(ql>qr) return 0;\n\tif(ql<=l&&r<=qr) return s[k].cnt;\n\tpushdown(k);int mid=l+r>>1;\n\tif(qr<=mid) return query_cnt(s[k].ch[0],l,mid,ql,qr);\n\telse if(ql>mid) return query_cnt(s[k].ch[1],mid+1,r,ql,qr);\n\telse return query_cnt(s[k].ch[0],l,mid,ql,mid)+query_cnt(s[k].ch[1],mid+1,r,mid+1,qr);\n}\nint query_pre0(int k,int l,int r,int ql,int qr){\n\tif(ql>qr) return 0;\n\tif(ql<=l&&r<=qr) return s[k].pre0;\n\tpushdown(k);int mid=l+r>>1;\n\tif(qr<=mid) return query_pre0(s[k].ch[0],l,mid,ql,qr);\n\telse if(ql>mid) return query_pre0(s[k].ch[1],mid+1,r,ql,qr);\n\telse return (query_pre0(s[k].ch[0],l,mid,ql,mid)+query_pre0(s[k].ch[1],mid+1,r,mid+1,qr))%MOD;\n}\nint query_pre1(int k,int l,int r,int ql,int qr){\n\tif(ql>qr) return 0;\n\tif(ql<=l&&r<=qr) return s[k].pre1;\n\tpushdown(k);int mid=l+r>>1;\n\tif(qr<=mid) return query_pre1(s[k].ch[0],l,mid,ql,qr);\n\telse if(ql>mid) return query_pre1(s[k].ch[1],mid+1,r,ql,qr);\n\telse return (query_pre1(s[k].ch[0],l,mid,ql,mid)+query_pre1(s[k].ch[1],mid+1,r,mid+1,qr))%MOD;\n}\nint query_nxt0(int k,int l,int r,int ql,int qr){\n\tif(ql>qr) return 0;\n\tif(ql<=l&&r<=qr) return s[k].nxt0;\n\tpushdown(k);int mid=l+r>>1;\n\tif(qr<=mid) return query_nxt0(s[k].ch[0],l,mid,ql,qr);\n\telse if(ql>mid) return query_nxt0(s[k].ch[1],mid+1,r,ql,qr);\n\telse return (query_nxt0(s[k].ch[0],l,mid,ql,mid)+query_nxt0(s[k].ch[1],mid+1,r,mid+1,qr))%MOD;\n}\nint query_nxt1(int k,int l,int r,int ql,int qr){\n\tif(ql>qr) return 0;\n\tif(ql<=l&&r<=qr) return s[k].nxt1;\n\tpushdown(k);int mid=l+r>>1;\n\tif(qr<=mid) return query_nxt1(s[k].ch[0],l,mid,ql,qr);\n\telse if(ql>mid) return query_nxt1(s[k].ch[1],mid+1,r,ql,qr);\n\telse return (query_nxt1(s[k].ch[0],l,mid,ql,mid)+query_nxt1(s[k].ch[1],mid+1,r,mid+1,qr))%MOD;\n}\nvoid modify(int k,int l,int r,int p,int x,int ps,int ss,int v){\n\tif(l==r){\n\t\tif(v==-1){\n\t\t\ts[k].cnt=s[k].pre0=s[k].pre1=0;\n\t\t\ts[k].nxt0=s[k].nxt1=0;\n\t\t} else {\n\t\t\ts[k].cnt=1;\n\t\t\ts[k].pre0=pre[x];s[k].pre1=1ll*pre[x]*ps%MOD;\n\t\t\ts[k].nxt0=nxt[x];s[k].nxt1=1ll*nxt[x]*ss%MOD;\n\t\t} return;\n\t} pushdown(k);int mid=l+r>>1;\n\tif(p<=mid) modify(s[k].ch[0],l,mid,p,x,ps,ss,v);\n\telse modify(s[k].ch[1],mid+1,r,p,x,ps,ss,v);\n\tpushup(k);\n}\nvoid modify_pre(int k,int l,int r,int ql,int qr,int x){\n\tif(ql>qr) return;\n\tif(ql<=l&&r<=qr){\n\t\ts[k].pre1=(s[k].pre1+1ll*x*s[k].pre0%MOD)%MOD;\n\t\ts[k].lz_pre=(s[k].lz_pre+x)%MOD;return;\n\t} pushdown(k);int mid=l+r>>1;\n\tif(qr<=mid) modify_pre(s[k].ch[0],l,mid,ql,qr,x);\n\telse if(ql>mid) modify_pre(s[k].ch[1],mid+1,r,ql,qr,x);\n\telse modify_pre(s[k].ch[0],l,mid,ql,mid,x),modify_pre(s[k].ch[1],mid+1,r,mid+1,qr,x);\n\tpushup(k);\n}\nvoid modify_nxt(int k,int l,int r,int ql,int qr,int x){\n\tif(ql>qr) return;\n\tif(ql<=l&&r<=qr){\n\t\ts[k].nxt1=(s[k].nxt1+1ll*x*s[k].nxt0%MOD)%MOD;\n\t\ts[k].lz_nxt=(s[k].lz_nxt+x)%MOD;return;\n\t} pushdown(k);int mid=l+r>>1;\n\tif(qr<=mid) modify_nxt(s[k].ch[0],l,mid,ql,qr,x);\n\telse if(ql>mid) modify_nxt(s[k].ch[1],mid+1,r,ql,qr,x);\n\telse modify_nxt(s[k].ch[0],l,mid,ql,mid,x),modify_nxt(s[k].ch[1],mid+1,r,mid+1,qr,x);\n\tpushup(k);\n}\nint get(int x){\n\tif(!query_cnt(rt[a[x]],1,cnt[a[x]],where[x],where[x])) return 0;\n\tint ret=0;\n\tret=(ret+1ll*query_pre0(rt[a[x]],1,cnt[a[x]],1,where[x]-1)*\n\t\t\t\t query_nxt0(rt[a[x]],1,cnt[a[x]],where[x]+1,cnt[a[x]]))%MOD;\n\tret=(ret+1ll*nxt[x]*\n\t\t(1ll*(query_cnt(rt[a[x]],1,cnt[a[x]],1,where[x])-1)*\n\t\t\t  query_pre0(rt[a[x]],1,cnt[a[x]],1,where[x]-1)%MOD-\n\t\t\t  query_pre1(rt[a[x]],1,cnt[a[x]],1,where[x]-1)+MOD))%MOD;\n\tret=(ret+1ll*pre[x]*\n\t\t(1ll*(query_cnt(rt[a[x]],1,cnt[a[x]],where[x],cnt[a[x]])-1)*\n\t\t\t  query_nxt0(rt[a[x]],1,cnt[a[x]],where[x]+1,cnt[a[x]])%MOD-\n\t\t\t  query_nxt1(rt[a[x]],1,cnt[a[x]],where[x]+1,cnt[a[x]])+MOD))%MOD;\n\treturn ret;\n}\nvoid toggle(int x,int v){\n\tif(v==-1){\n\t\tmodify(rt[a[x]],1,cnt[a[x]],where[x],x,0,0,-1);\n\t\tmodify_pre(rt[a[x]],1,cnt[a[x]],where[x]+1,cnt[a[x]],MOD-1);\n\t\tmodify_nxt(rt[a[x]],1,cnt[a[x]],1,where[x]-1,MOD-1);\n\t} else {\n\t\tint ps=query_cnt(rt[a[x]],1,cnt[a[x]],1,where[x]-1);\n\t\tint ss=query_cnt(rt[a[x]],1,cnt[a[x]],where[x]+1,cnt[a[x]]);\n\t\tmodify(rt[a[x]],1,cnt[a[x]],where[x],x,ps+1,ss+1,1);\n\t\tmodify_pre(rt[a[x]],1,cnt[a[x]],where[x]+1,cnt[a[x]],1);\n\t\tmodify_nxt(rt[a[x]],1,cnt[a[x]],1,where[x]-1,1);\n\t}\n}\nint main(){\n\tscanf(\"%d\",&n);\n\tfor(int i=1;i<=n;i++) scanf(\"%d\",&a[i]),key[i]=a[i];\n\tsort(key+1,key+n+1);\n\tfor(int i=1;i<=n;i++) if(key[i]^key[i-1]) uni[++num]=key[i];\n\tfor(int i=1;i<=n;i++) a[i]=lower_bound(uni+1,uni+num+1,a[i])-uni;\n\tfor(int i=1;i<=n;i++) add(a[i],1),pre[i]=ask(a[i])-1;memset(t,0,sizeof(t));\n\tfor(int i=n;i;i--) add(a[i],1),nxt[i]=ask(a[i])-1;\n\tfor(int i=1;i<=n;i++) pos[a[i]].push_back(i),where[i]=pos[a[i]].size();\n\tfor(int i=1;i<=n;i++) cnt[a[i]]++;\n\tfor(int i=1;i<=num;i++) build(rt[i],1,cnt[i],i);\n\tint ans=0;\n\tfor(int i=1;i<=n;i++) ans=(ans+get(i))%MOD;\n\tans=1ll*ans*INV3%MOD;\n\tint qu;scanf(\"%d\",&qu);\n\twhile(qu--){\n\t\tint opt,x;scanf(\"%d%d\",&opt,&x);\n\t\tif(opt==1){\n\t\t\tans=(ans-get(x)+MOD)%MOD;\n\t\t\ttoggle(x,-1);\n\t\t} else {\n\t\t\ttoggle(x,1);\n\t\t\tans=(ans+get(x))%MOD;\n\t\t}\n\t\tprintf(\"%d\\n\",ans);\n\t}\n\treturn 0;\n}\n/*\n9\n3 4 4 2 4 5 4 4 1\n3\n1 5\n2 5\n1 2\n*/\n```\n\n",
        "postTime": 1615883827,
        "uid": 115194,
        "name": "lTgMFePRoeZ",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 CF788E New task"
    }
]