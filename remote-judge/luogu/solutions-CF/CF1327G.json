[
    {
        "content": "[\u9898\u76ee\u4f20\u9001\u95e8](https://codeforces.com/contest/1327/problem/G)\n\n### \u9898\u89e3\n\n\u4e8b\u5b9e\u4e0a\u8fd9\u4e2a\u9898\u8fd8\u662f\u975e\u5e38\u7b80\u5355\u7684\u3002\uff08\u522b\u95ee\u6211\u4e3a\u4ec0\u4e48\u73b0\u573a\u6ca1\u8fc7\n\n\u9996\u5148\u53ef\u4ee5\u5bf9\u6240\u6709\u6a21\u5f0f\u4e32\u5efa\u4e2a AC \u81ea\u52a8\u673a\uff0c\u6bcf\u4e2a\u70b9\u7684\u6743\u503c\u5c31\u662f\u8fd9\u4e2a\u70b9\u5728 $fail$ \u6811\u4e0a\u5230\u6839\u8def\u5f84\u4e0a\u6240\u6709\u70b9\u5bf9\u5e94\u7684\u5b57\u7b26\u4e32\u7684\u6743\u503c\u548c\u3002\n\n\u5982\u679c\u5b57\u7b26\u4e32 $s$ \u5df2\u7ecf\u5168\u90e8\u786e\u5b9a\uff0c\u90a3\u4e48\u6211\u4eec\u53ea\u8981\u628a $s$ \u5728\u8fd9\u4e2a\u81ea\u52a8\u673a\u4e0a\u8dd1\u4e00\u904d\uff0c\u628a\u7ecf\u8fc7\u8282\u70b9\u7684\u70b9\u6743\u7d2f\u52a0\u5373\u53ef\u3002\n\n\u4f46\u662f\u73b0\u5728 $s$ \u6709\u82e5\u5e72\u4e2a\u5b57\u7b26\u4e0d\u786e\u5b9a\u3002\u6211\u4eec\u8003\u8651\u5bf9\u4e8e $s$ \u7684\u6bcf\u6bb5\u786e\u5b9a\u7684\u6781\u5927\u5b50\u4e32\uff0c\u4ee5\u53ca AC \u81ea\u52a8\u673a\u4e0a\u7684\u70b9 $u$\uff0c\u9884\u5904\u7406\u4ece $u$ \u5f00\u59cb\uff0c\u6309\u7167\u8fd9\u6bb5\u5b50\u4e32\u8dd1\uff0c\u6700\u7ec8\u8dd1\u5230\u7684\u70b9\u4ee5\u53ca\u6cbf\u8def\u7ecf\u8fc7\u7684\u70b9\u6743\u548c\u3002\n\n\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5 DP \u4e86\u3002\u8bb0 $f_{S,u}$ \u8868\u793a\u5f53\u524d\u95ee\u53f7\u7684\u4f4d\u7f6e\u7528\u4e86 $S$ \u8fd9\u4e9b\u5b57\u7b26\uff0c\u8dd1\u5230\u81ea\u52a8\u673a\u4e0a\u7684\u8282\u70b9 $u$ \u65f6\uff0c\u6700\u5927\u7684\u6743\u503c\u548c\u3002\n\n\u8f6c\u79fb\u53ea\u9700\u8981\u679a\u4e3e\u4e0b\u4e00\u4e2a\u95ee\u53f7\u586b\u7684\u5b57\u7b26\u5373\u53ef\u3002\n\n\u8bb0 $n$ \u4e3a\u5b57\u7b26\u4e32 $s$ \u7684\u957f\u5ea6\uff0c$m$ \u4e3a\u6a21\u5f0f\u4e32\u7684\u957f\u5ea6\u4e4b\u548c\uff0c$c$ \u4e3a\u5b57\u7b26\u96c6\u5927\u5c0f\uff0c\u5219\u590d\u6742\u5ea6\u4e3a $O(nm+2^cmc)$\uff0c\u53ef\u4ee5\u901a\u8fc7\u672c\u9898\u3002\n\n### \u4ee3\u7801\n\n```cpp\nconst long long INF = 0x3f3f3f3f3f3f3f3fll;\nconst int N = 1005, C = 14;\nint n;\nchar t[N], s[400005];\nstd::pair<int, long long> go[N][C + 1];\nint bitcnt[1 << C];\nlong long f[1 << C][N];\nstruct AC_Automaton{\n\tint rt, cnt, trans[N][C], fail[N];\n\tlong long w[N];\n\tint new_node(){\n\t\tint u = cnt++;\n\t\tw[u] = 0, fail[u] = -1;\n\t\tfor (register int i = 0; i < C; ++i) trans[u][i] = -1;\n\t\treturn u;\n\t}\n\tvoid init(){\n\t\tcnt = 0, rt = new_node();\n\t}\n\tvoid insert(const std::vector<int> &s, long long _w){\n\t\tint u = rt;\n\t\tfor (register int i = 0; i < (int)s.size(); ++i){\n\t\t\tif (trans[u][s[i]] == -1) trans[u][s[i]] = new_node();\n\t\t\tu = trans[u][s[i]];\n\t\t}\n\t\tw[u] += _w;\n\t}\n\tvoid build(){\n\t\tstd::vector<int> Q;\n\t\tfail[rt] = -1;\n\t\tfor (register int i = 0; i < C; ++i)\n\t\t\tif (~trans[rt][i]) Q.push_back(trans[rt][i]), fail[trans[rt][i]] = rt;\n\t\t\telse trans[rt][i] = rt;\n\t\tfor (register int i = 0; i < (int)Q.size(); ++i){\n\t\t\tint u = Q[i];\n\t\t\tw[u] += w[fail[u]];\n\t\t\tfor (register int j = 0; j < C; ++j)\n\t\t\t\tif (~trans[u][j]) Q.push_back(trans[u][j]), fail[trans[u][j]] = trans[fail[u]][j];\n\t\t\t\telse trans[u][j] = trans[fail[u]][j];\n\t\t}\n\t}\n\tstd::pair<int, long long> run(int u, const std::vector<int> &s){\n\t\tlong long sum = 0;\n\t\tfor (register int i = 0; i < (int)s.size(); ++i)\n\t\t\tu = trans[u][s[i]], sum += w[u];\n\t\treturn {u, sum};\n\t}\n}A;\nint main(){\n#ifdef AT_HOME\n\tfreopen(\"test.in\", \"r\", stdin);\n\tfreopen(\"test.out\", \"w\", stdout);\n#endif\n\tread(n);\n\tA.init();\n\tfor (register int i = 0; i < n; ++i){\n\t\tint m = reads(t), w;\n\t\tstd::vector<int> tmp;\n\t\tread(w);\n\t\tfor (register int j = 0; j < m; ++j) tmp.push_back(t[j] - 'a');\n\t\tA.insert(tmp, w);\n\t}\n\tA.build();\n\tint len = reads(s);\n\tstd::vector<int> tmp;\n\tint cnt = 0;\n\tfor (register int i = 0; i <= len; ++i)\n\t\tif (i == len || s[i] == '?'){\n\t\t\tfor (register int j = 0; j < A.cnt; ++j)\n\t\t\t\tgo[j][cnt] = A.run(j, tmp);\n\t\t\ttmp.clear(), ++cnt;\n\t\t}\n\t\telse tmp.push_back(s[i] - 'a');\n\tbitcnt[0] = 0;\n\tfor (register int i = 1; i < (1 << C); ++i)\n\t\tbitcnt[i] = bitcnt[i >> 1] + (i & 1);\n\tfor (register int i = 0; i < (1 << C); ++i)\n\t\tfor (register int j = 0; j < A.cnt; ++j)\n\t\t\tf[i][j] = -INF;\n\tf[0][go[A.rt][0].first] = go[A.rt][0].second;\n\tlong long ans = -INF;\n\tfor (register int S = 0; S < (1 << C); ++S){\n\t\tint k = bitcnt[S] + 1;\n\t\tif (k == cnt){\n\t\t\tfor (register int u = 0; u < A.cnt; ++u)\n\t\t\t\tans = std::max(ans, f[S][u]);\n\t\t}\n\t\tif (k >= cnt) continue;\n\t\tfor (register int u = 0; u < A.cnt; ++u)\n\t\t\tif (f[S][u] != -INF){\n\t\t\t\tfor (register int i = 0; i < C; ++i)\n\t\t\t\t\tif (!(S >> i & 1)){\n\t\t\t\t\t\tint v = A.trans[u][i];\n\t\t\t\t\t\tint S_ = S | (1 << i), u_ = go[v][k].first;\n\t\t\t\t\t\tf[S_][u_] = std::max(f[S_][u_], f[S][u] + A.w[v] + go[v][k].second);\n\t\t\t\t\t}\n\t\t\t}\n\t}\n\tprint(ans);\n}\n```\n\n\u6211\u8fd8\u662f\u592a\u83dc\u4e86 /kk\n",
        "postTime": 1585143066,
        "uid": 20561,
        "name": "AutumnKite",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 CF1327G \u3010Letters and Question Marks\u3011"
    },
    {
        "content": "\n[**\u9898\u610f**](https://www.luogu.com.cn/problem/CF1327G)\n\n\nAC\u81ea\u52a8\u673a\u597d\u9898\u3002\n\n\u8003\u8651\u4e0d\u5e26\u95ee\u53f7\u7684\u60c5\u51b5\u3002\n\n\u95ee\u9898\u8f6c\u5316\u4e3a\u7ed9\u5b9a\u786e\u5b9a\u7684\u4e32S\uff0c\u5728\u5b57\u7b26\u4e32\u96c6\u5408\u4e2d\u7684\u4ef7\u503c\u6700\u5927\u5316\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u5bf9\u96c6\u5408T\u5efa\u7acbAC\u81ea\u52a8\u673a\u3002\n\n\u6ce8\u610f\u5230\u81ea\u52a8\u673a\u7684\u8282\u70b9\u6570\u4e0d\u8d85\u8fc71000\u4e2a\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5728\u6bcf\u4e2a\u8282\u70b9\u4e0a\u8dd1\u4e00\u904d\u4e32\u3002\n\n\u5373\u7edf\u8ba1\u6bcf\u4e2a\u8282\u70b9\u4f5c\u4e3aS\u5f00\u59cb\u6240\u5f97\u5230\u7684\u4ef7\u503c\uff0c\u6700\u540e\u53d6max\u5373\u53ef\u3002\n\n---\n\n\u5e26\u95ee\u53f7\u7684\u60c5\u51b5\uff0c\u53ef\u4ee5\u770b\u4f5c\u95ee\u53f7\u628a\u4e32S\u5206\u6210\u6700\u591a15\u6bb5\u3002\u53ef\u4ee5\u5c06\u6bcf\u4e00\u6bb5\u7528\u6808\u63d0\u53d6\u51fa\u6765\u3002\n\n\u6bcf\u4e2a\u5b50\u6bb5\u90fd\u53ef\u4ee5\u7528\u4e0a\u9762\u7684\u65b9\u6cd5\u7edf\u8ba1\u6700\u5927\u4ef7\u503c\uff0c\u590d\u6742\u5ea6  $O(|S|*k)$\u3002\n\n\u8bb0 $g[i][j]$ **\u8868\u793a\u4ecei\u53f7\u8282\u70b9\u5f00\u59cb\uff0c\u7b2cj\u4e2a\u5b50\u6bb5\u7684\u6700\u5927\u4ef7\u503c\u3002**\n\n\u540c\u65f6\u8bb0\u5f55 $pos[i][j]$ **\u8868\u793a $g[i][j]$ \u7684\u7ec8\u6b62\u8282\u70b9\u3002**\n\n\u66b4\u529b\u679a\u4e3e\u95ee\u53f7\u7684\u53d6\u503c\u590d\u6742\u5ea6  $ O(t^{14})$\uff0c\u5176\u4e2dt\u8868\u793a\u95ee\u53f7\u7684\u4e2a\u6570\u3002\n\n\u8fd9\u663e\u7136\u65e0\u6cd5\u63a5\u53d7\u3002\n\n\u6240\u4ee5\u53ef\u4ee5\u91c7\u53d6\u5728AC\u81ea\u52a8\u673a\u4e0aDP\u7684\u65b9\u5f0f\u3002\n\n\u53c8\u8003\u8651\u5230\u95ee\u53f7\u7684\u4e2a\u6570\u4e0d\u8d85\u8fc714\u4e2a\uff0c\u5e76\u4e14\u4e0d\u80fd\u91cd\u590d\uff0c\u53ef\u4ee5\u76f4\u63a5\u72b6\u538b\u3002\n\n\u72b6\u538b\u5f53\u524d\u7b2ci\u4f4d\u7684\u5b57\u7b26\u6709\u6ca1\u6709\u88ab\u7528\u8fc7\u3002\n\n---\n\n**\u8bbe $f[S][j]$ \u8868\u793a\u5f53\u524d\u8003\u8651\u8fc7\u7684\u95ee\u53f7\u6240\u7528\u5b57\u7b26\u96c6\u5408\u4e3aS\uff0c\u4e14\u5230\u8fbe\u4e86j\u53f7\u8282\u70b9\u7684\u6700\u5927\u4ef7\u503c\u3002**\n\n\u7531\u4e8e\u6211\u4eec\u8bb0\u5f55\u4e86\u7ec8\u6b62\u8282\u70b9\uff0c\u6240\u4ee5\u8003\u8651\u5b83\u80fd\u8f6c\u79fb\u5230\u54ea\u4e9b\u540e\u7ee7\u3002\n$$\nf[S][j]=\\max\\{f[S_1][u]+g[u][k]\\}\n$$\n\u5176\u4e2d $j=pos[u][k],S=S_1\\cup \\{s[j]\\}$\uff0ck\u4e3a\u5f53\u524d\u8003\u8651\u7684\u5b50\u6bb5\u7f16\u53f7\uff0c\u5b50\u6bb5\u6807\u53f7=\u95ee\u53f7\u6570+1\u3002\n\n\u6700\u540e\u8fbe\u5230\u5df2\u6709\u7684\u5b50\u6bb5\u6570\u65f6\uff0c\u5bf9\u6bcf\u4e2a\u8282\u70b9\u7684f\u53d6max\u8f93\u51fa\u5373\u53ef\u3002\n\n\u8fd8\u6709\u4e00\u4e9b\u7ec6\u8282\u95ee\u9898\uff0c\u5177\u4f53\u89c1\u6ce8\u91ca\u5427qwq\u3002\n\n---\n\n### Code:\n\n```cpp\n#include<cstdio>\n#include<cstring>\n#include<queue>\n#include<utility>\n#include<algorithm>\nusing namespace std;\n#define int long long\nconst int N=1009,INF=0x3f3f3f3f3f3f;\nstruct AC_auto\n{\n\tint ch[14];\n\tint end,fail;\n} AC[400009];\nint n,m,x,ans=-INF,cnt,num,f[(1<<14)+9][N];\nint stk[400009],top,g[N][18],pos[N][18];//g[i][j]\u8868\u793a\u7b2cj\u4e2a\u5b50\u6bb5\uff0c\u4ecei\u4e2a\u8282\u70b9\u51fa\u53d1\u7684\u6700\u5927\u4ef7\u503c,pos\u8868\u793a\u4f4d\u7f6e\nchar ch[400009];\n\ninline void build(char *s,int c)\n{\n\tint now=0,len=strlen(s+1);\n\tfor(int i=1;i<=len;i++)\n\t{\n\t\tif(!AC[now].ch[s[i]-'a']) AC[now].ch[s[i]-'a']=++cnt;\n\t\tnow=AC[now].ch[s[i]-'a'];\n\t}\n\tAC[now].end+=c;\n}\n\ninline void build_fail()\n{\n\tqueue<int> Q;\n\tfor(int i=0;i<14;i++)\n\t{\n\t\tif(AC[0].ch[i])\n\t\t\tQ.push(AC[0].ch[i]);\n\t}\n\tint now=0;\n\twhile (!Q.empty())\n\t{\n\t\tint u=Q.front();Q.pop();\n\t\tAC[u].end+=AC[AC[u].fail].end;\n\t\tfor(int i=0;i<14;i++)\n\t\t{\n\t\t\tif(AC[u].ch[i])\n\t\t\t{\n\t\t\t\tAC[AC[u].ch[i]].fail=AC[AC[u].fail].ch[i];\n\t\t\t\tQ.push(AC[u].ch[i]);\n\t\t\t}\n\t\t\telse AC[u].ch[i]=AC[AC[u].fail].ch[i];\n\t\t}\n\t}\n\t\n}\n\ninline int calc(int u,int x)\n{\n\tint res=0,bu=u;\n\tfor(int i=1;i<=top;i++)\n\t{\n\t\tu=AC[u].ch[stk[i]];\n\t\tres+=AC[u].end;\n\t}\n\tpos[bu][x]=u;\n\treturn res;\n}\n\ninline int get(int x)\n{\n\tint res=0;\n\twhile(x)\n    {\n   \t\tif(x&1)\n        \tres++;\n        x>>=1;\n    }\n\treturn res;\n}\n\nsigned main()\n{\n\tscanf(\"%lld\",&n);\n\tfor(int i=1;i<=n;i++)\n\t{\n\t\tscanf(\"%s\",ch+1);\n\t\tscanf(\"%lld\",&x);\n\t\tbuild(ch,x);\n\t}\n\tbuild_fail();\n\tscanf(\"%s\",ch+1);\n\tint len=strlen(ch+1);\n\tfor(int i=1;i<=len+1;i++)\n\t{\n\t\tif(ch[i]=='?'||i==len+1)//\u6ce8\u610f\u8981\u628a\u6240\u6709\u5b57\u7b26\u8003\u8651\u5b8c\u6574\n\t\t{\n\t\t\tfor(int j=0;j<=cnt;j++)\n\t\t\t\tg[j][num]=calc(j,num);\n\t\t\ttop=0;num++;\n\t\t}\n\t\telse stk[++top]=ch[i]-'a';\n\t}\n\tmemset(f,-INF,sizeof f);\n\tans=-INF;\n\tf[0][pos[0][0]]=g[0][0];\n\tfor(int S=0;S<(1<<14);S++)\n\t{\n\t\tint k=get(S)+1;//\u4e3a\u5b50\u6bb5\u4e2a\u6570\n\t\tif(k>num) continue;\n\t\tif(k==num)\n\t\t{\n\t\t\tfor(int i=0;i<=cnt;i++)\n\t\t\t\tans=max(ans,f[S][i]);\n\t\t\tcontinue;\n\t\t}\n\t\tfor(int i=0;i<=cnt;i++)\n\t\t\tfor(int j=0;j<14;j++)\n\t\t\t\tif(!((1<<j)&S))\n\t\t\t\t{\n\t\t\t\t\tint u=AC[i].ch[j],S1=S|(1<<j),v=pos[u][k];\n\t\t\t\t\tf[S1][v]=max(f[S1][v],f[S][i]+AC[u].end+g[u][k]);\n\t\t\t\t\t//\u8fd9\u91cc\u6211\u5e76\u6ca1\u6709\u7edf\u8ba1u\u81ea\u5df1\u7684\u8d21\u732e\u3002\n\t\t\t\t}\n\t}\n\tprintf(\"%lld\",ans);\n\treturn 0;\n}\n```",
        "postTime": 1597055046,
        "uid": 237308,
        "name": "AlanSP",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF1327G \u3010Letters and Question Marks\u3011"
    },
    {
        "content": "~~\u61a8\u6279\u9898\uff0c\u600e\u4e48\u6211CF\u7684\u65f6\u5019\u5c31\u505a\u4e0d\u51fa\u8fd9\u4e2a\u9898\u554a\u554a\u554a\u554a\u554a\u554a\u554a~~\n\n### \u9898\u610f:\n\n\u7ed9\u4f60 $k$\uff0c$k$\u4e2a\u4e32 $t_i$ \u4ee5\u53ca\u4ef7\u503c $c_i$($\\sum |t_i| \\leq 10^3$)\uff0c\u7136\u540e\u7ed9\u4f60\u4e00\u4e2a\u4e32 $s$($|s|\\leq 4 \\times 10^5$)\uff0c$s$ \u4e2d\u6700\u591a\u5305\u542b $14$ \u4e2a $?$\uff0c\u5b57\u7b26\u96c6\u662f $14$\uff0c\u6bcf\u4e2a $?$ \u4e0d\u80fd\u53d6\u5230\u76f8\u540c\u5b57\u7b26\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u79cd\u586b\u5145\u5b57\u7b26\u7684\u65b9\u5f0f\uff0c\u6c42\u6700\u5927\u7684$\\sum F(s,t_i) \\times c_i$\n\n### sol:\n\n~~ACAutoMaton \u50bb\u5b50\u9898\u3002~~\n\n\u8003\u8651\u5230 AC \u81ea\u52a8\u673a\u5982\u679c\u628a $ed_{fa_i}$ \u4fe1\u606f\u52a0\u5230 $ed_i$ \u4e0a\uff0c\u90a3\u4e48 $ed_i$ \u5c31\u662f $i$ \u8282\u70b9\u5bf9\u5e94\u7684\u5b57\u7b26\u4e32\u5305\u542b\u7684\u6240\u6709\u5b50\u4e32\u7684\u4fe1\u606f\u3002\n\u6211\u4eec\u8003\u8651\u5230\u6700\u591a\u6709 $14$ \u4e2a $?$\uff0c\u6240\u4ee5\u8fd9\u4e2a\u73a9\u610f\u6700\u591a\u88ab\u5206\u6210\u4e86 $14$ \u6bb5\u3002\u90a3\u4e48\u663e\u7136\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u8ba1\u7b97\u5bf9\u4e8e\u6bcf\u4e2a\u8282\u70b9 $j$ \u5728\u7b2c $i$ \u6bb5\u4f1a\u53d8\u6210 AC \u81ea\u52a8\u673a\u4e0a\u7684\u54ea\u4e2a\u8282\u70b9 $nxt_{j,i}$\uff0c\u4ee5\u53ca\u8ba1\u7b97$j$ \u8d70\u8fc7\u7b2c $i$ \u6bb5\u7684\u8d21\u732e $sum_{j,i} = \\sum ed_p$\uff0c\u7136\u540e\u5c31\u53ef\u4ee5 $dp$ \u4e86\u3002\n\n```cpp\n// clang-format off\n// powered by c++11\n// by Isaunoya\n#include<bits/stdc++.h>\n#define rep(i,x,y) for(register int i=(x);i<=(y);++i)\n#define Rep(i,x,y) for(register int i=(x);i>=(y);--i)\nusing namespace std;using db=double;using ll=long long;\nusing uint=unsigned int;using ull=unsigned long long;\nusing pii=pair<int,int>;\n#define Tp template\n#define fir first\n#define sec second\nTp<class T>void cmax(T&x,const T&y){if(x<y)x=y;}Tp<class T>void cmin(T&x,const T&y){if(x>y)x=y;}\n#define all(v) v.begin(),v.end()\n#define sz(v) ((int)v.size())\n#define pb emplace_back\nTp<class T>void sort(vector<T>&v){sort(all(v));}Tp<class T>void reverse(vector<T>&v){reverse(all(v));}\nTp<class T>void unique(vector<T>&v){sort(all(v)),v.erase(unique(all(v)),v.end());}inline void reverse(string&s){reverse(s.begin(),s.end());}\nconst int SZ=1<<23|233;\nstruct FILEIN{char qwq[SZ],*S=qwq,*T=qwq,ch;\n#ifdef __WIN64\n#define GETC getchar\n#else\ninline char GETC(){return(S==T)&&(T=(S=qwq)+fread(qwq,1,SZ,stdin),S==T)?EOF:*S++;}\n#endif\ninline FILEIN&operator>>(char&c){while(isspace(c=GETC()));return*this;}inline FILEIN&operator>>(string&s){s.clear();while(isspace(ch=GETC()));if(!~ch)return*this;s=ch;while(!isspace(ch=GETC())&&~ch)s+=ch;return*this;}\ninline FILEIN&operator>>(char*str){char*cur=str;while(*cur)*cur++=0;cur=str;while(isspace(ch=GETC()));if(!~ch)return*this;*cur=ch;while(!isspace(ch=GETC())&&~ch)*++cur=ch;*++cur=0;return*this;}\nTp<class T>inline void read(T&x){bool f=0;while((ch=GETC())<48&&~ch)f^=(ch==45);x=~ch?(ch^48):0;while((ch=GETC())>47)x=x*10+(ch^48);x=f?-x:x;}\ninline FILEIN&operator>>(int&x){return read(x),*this;}inline FILEIN&operator>>(ll&x){return read(x),*this;}inline FILEIN&operator>>(uint&x){return read(x),*this;}inline FILEIN&operator>>(ull&x){return read(x),*this;}\ninline FILEIN&operator>>(double&x){read(x);bool f=x<0;x=f?-x:x;if(ch^'.')return*this;double d=0.1;while((ch=GETC())>47)x+=d*(ch^48),d*=.1;return x=f?-x:x,*this;}\n}in;\nstruct FILEOUT{const static int LIMIT=1<<22;char quq[SZ],ST[233];int sz,O,pw[233];\nFILEOUT(){set(7);rep(i,pw[0]=1,9)pw[i]=pw[i-1]*10;}~FILEOUT(){flush();}\ninline void flush(){fwrite(quq,1,O,stdout),fflush(stdout),O=0;}\ninline FILEOUT&operator<<(char c){return quq[O++]=c,*this;}inline FILEOUT&operator<<(string str){if(O>LIMIT)flush();for(char c:str)quq[O++]=c;return*this;}\ninline FILEOUT&operator<<(char*str){if(O>LIMIT)flush();char*cur=str;while(*cur)quq[O++]=(*cur++);return*this;}\nTp<class T>void write(T x){if(O>LIMIT)flush();if(x<0){quq[O++]=45;x=-x;}do{ST[++sz]=x%10^48;x/=10;}while(x);while(sz)quq[O++]=ST[sz--];}\ninline FILEOUT&operator<<(int x){return write(x),*this;}inline FILEOUT&operator<<(ll x){return write(x),*this;}inline FILEOUT&operator<<(uint x){return write(x),*this;}inline FILEOUT&operator<<(ull x){return write(x),*this;}\nint len,lft,rig;void set(int l){len=l;}inline FILEOUT&operator<<(double x){bool f=x<0;x=f?-x:x,lft=x,rig=1.*(x-lft)*pw[len];return write(f?-lft:lft),quq[O++]='.',write(rig),*this;}\n}out;\n#define int long long\nstruct Math{\nvector<int>fac,inv;int mod;\nvoid set(int n,int Mod){fac.resize(n+1),inv.resize(n+1),mod=Mod;rep(i,fac[0]=1,n)fac[i]=fac[i-1]*i%mod;inv[n]=qpow(fac[n],mod-2);Rep(i,n-1,0)inv[i]=inv[i+1]*(i+1)%mod;}\nint qpow(int x,int y){int ans=1;for(;y;y>>=1,x=x*x%mod)if(y&1)ans=ans*x%mod;return ans;}int C(int n,int m){if(n<0||m<0||n<m)return 0;return fac[n]*inv[m]%mod*inv[n-m]%mod;}\nint gcd(int x,int y){return!y?x:gcd(y,x%y);}int lcm(int x,int y){return x*y/gcd(x,y);}\n}math;\n// clang-format on\n\nconst int maxn = 1e3 + 31;\nconst int maxm = 4e5 + 54;\nchar t[maxn];\nchar s[maxm];\nint ans = -1e18;\nstruct acautomaton {\n  int cnt;\n  int ch[maxn][14], fail[maxn], ed[maxn];\n  acautomaton() { cnt = 1; }\n\n  void ins(char* s, int val) {\n    char* cur = s;\n    int p = 1;\n    while (*cur) {\n      int c = (*cur++) - 'a';\n      if (!ch[p][c]) ch[p][c] = ++cnt;\n      p = ch[p][c];\n    }\n    ed[p] += val;\n  }\n\n  void build() {\n    queue<int> q;\n    rep(i, 0, 13) if (ch[1][i]) fail[ch[1][i]] = 1, q.push(ch[1][i]);\n    else ch[1][i] = 1;\n    while (q.size()) {\n      int u = q.front();\n      q.pop();\n      rep(i, 0, 13) {\n        if (ch[u][i]) {\n          fail[ch[u][i]] = ch[fail[u]][i];\n          ed[ch[u][i]] += ed[fail[ch[u][i]]];\n          q.push(ch[u][i]);\n        } else {\n          ch[u][i] = ch[fail[u]][i];\n        }\n      }\n    }\n  }\n\n  int pos[16], tot = 0;\n  int nxt[maxn][16], sum[maxn][16];\n  int dp[maxn][1 << 14 | 233];\n\n  void solve(char* s) {\n    int len = strlen(s);\n    for (int i = 0; i < len; i++)\n      if (s[i] == '?') pos[++tot] = i;\n    pos[0] = -1;\n    pos[tot + 1] = len;\n    rep(i, 0, tot) {\n      rep(j, 1, cnt) {\n        int p = j;\n        rep(k, pos[i] + 1, pos[i + 1] - 1) {\n          p = ch[p][s[k] - 'a'];\n          sum[j][i] += ed[p];\n        }\n        nxt[j][i] = p;\n      }\n    }\n\n    rep(i, 1, cnt) rep(j, 0, (1 << 14)) dp[i][j] = -1e18;\n    dp[nxt[1][0]][0] = sum[1][0];\n\n    auto count = [&](int x) {\n      int c = 0;\n      while (x) x ^= x & -x, c++;\n      return c;\n    };\n\n    rep(i, 0, (1 << 14) - 1) {\n      int v = count(i);\n      if (v >= tot) continue;\n      rep(j, 1, cnt) {\n        rep(k, 0, 13) {\n          if (i & (1 << k)) continue;\n          cmax(dp[nxt[ch[j][k]][v + 1]][i ^ (1 << k)], dp[j][i] + sum[ch[j][k]][v + 1] + ed[ch[j][k]]);\n        }\n      }\n    }\n\n    rep(i, 0, (1 << 14) - 1) {\n      if (count(i) ^ tot) continue;\n      rep(j, 1, cnt) cmax(ans, dp[j][i]);\n    }\n  }\n} acam;\n\nsigned main() {\n  // code begin.\n  int _;\n  in >> _;\n  while (_--) {\n    int val;\n    in >> t >> val, acam.ins(t, val);\n  }\n  acam.build(), in >> s, acam.solve(s);\n  out << ans << '\\n';\n  return 0;\n  // code end.\n}\n```",
        "postTime": 1585017360,
        "uid": 96580,
        "name": "SXNhdW5veWE",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 CF1327G \u3010Letters and Question Marks\u3011"
    },
    {
        "content": "## $\\text{Description}$\n\u4f60\u6709\u4e00\u4e2a\u5b57\u7b26\u4e32 $S$ \u548c\u4e00\u4e2a\u5b57\u7b26\u4e32\u6570\u7ec4 $[t_1, t_2, \\ldots, t_k]$.  \n\u4e32 $t_i$ \u4ec5\u5305\u542b $a$ \u548c $n$ \u7684\u5c0f\u5199\u5b57\u6bcd\uff1b$S$ \u4e2d\u4ec5\u5305\u542b $a$ \u5230 $n$ \u4ee5\u5185\u7684\u5c0f\u5199\u5b57\u6bcd\u548c\u4e0d\u8d85\u8fc7 $14$ \u4e2a\u95ee\u53f7.\n\n\u6bcf\u4e00\u4e2a\u5b57\u7b26\u4e32 $t_i$ \u6709\u4e00\u4e2a\u6574\u6570\u82b1\u8d39 $c_i$.\u4e00\u4e2a\u5b57\u7b26\u4e32 $T$ \u7684\u4ef7\u503c\u8ba1\u7b97\u516c\u5f0f\u4e3a $\\displaystyle \\sum_{i = 1} ^ k F(T, t_i) \\cdot c_i$\uff0c\u5176\u4e2d $F(T, t_i)$   \n\u8868\u793a\u5b57\u7b26\u4e32 $t_i$ \u5728 $T$ \u4e2d\u7684\u51fa\u73b0\u6b21\u6570\u3002\u4e3e\u4f8b\u6765\u8bf4\uff0c$F(\\texttt{aaabaaa}, \\texttt{aa}) = 4$.\n\n\u4f60\u9700\u8981\u7528 $a$ \u5230 $n$ \u4ee5\u5185\u7684\u5c0f\u5199\u5b57\u6bcd\u6765\u66ff\u6362 $S$ \u4e2d\u7684\u95ee\u53f7\uff0c\u6bcf\u4e2a\u5c0f\u5199\u5b57\u6bcd\u53ea\u80fd\u66ff\u6362\u4e00\u4e2a\u4f4d\u7f6e\u3002\u8bf7\u6c42\u51fa\u6240\u80fd\u5f97\u5230\u7684 $S$ \u7684\u6700\u5927\u4ef7\u503c.\n## $\\text{Solution}$\n\u4e0d\u96be\u60f3\u5230 AC \u81ea\u52a8\u673a.  \n\u8bbe\u8ba1 $dp_{s,i}$ \u8868\u793a\u5b57\u6bcd\u9009\u53d6\u72b6\u6001\u4e3a $s$ \uff0c\u5728\u81ea\u52a8\u673a\u8dd1\u5230 $i$ \u7ed3\u70b9\uff0c\u7684\u6700\u5927\u4ef7\u503c.  \n\u7531\u4e8e\u95ee\u53f7\u6781\u5176\u7a00\u758f\uff0c\u9884\u5904\u7406\u51fa\u6bcf\u4e2a\u7ed3\u70b9 $x$ \u4ece\u4e0a\u4e00\u4e2a\u95ee\u53f7\u5230\u4e0b\u4e00\u4e2a\u95ee\u53f7\u5728 AC \u81ea\u52a8\u673a\u4e0a\u8d70\u5230\u7684\u4f4d\u7f6e\u548c\u83b7\u5f97\u7684\u4ef7\u503c\uff0c\u76f4\u63a5\u8f6c\u79fb\u5373\u53ef.  \n\u65f6\u95f4\u590d\u6742\u5ea6 $O(14\\times 2^{14}\\sum|s|)$.",
        "postTime": 1639214114,
        "uid": 449265,
        "name": "wind_whisper",
        "ccfLevel": 10,
        "title": "CF1327G Letters and Question Marks"
    },
    {
        "content": "\n\u7ed9$t$\u4e2a\u603b\u957f\u5ea6\u4e0d\u8d85\u8fc7$T$\u7684\u5b57\u7b26\u4e32$t$\uff0c\u6bcf\u4e2a\u5b57\u7b26\u4e32\u6709\u5bf9\u5e94\u7684\u4ee3\u4ef7$c_i$\n\n\u7ed9\u4e00\u4e2a$S$,\u91cc\u9762\u5305\u542b$k$\u4e2a\u95ee\u53f7$?$\uff0c\u4e0d\u91cd\u590d\u5730\u586b$a-l\uff0c14$\u4e2a\u5b57\u7b26\uff0c\u95ee\u6700\u540e\u5f62\u6210\u7684\u5b57\u7b26\u4e32\u5927\u4ef7\u503c=$\\sum (t)\u51fa\u73b0\u7684\u6b21\u6570*c_i$\n\n$k\\leq 14,T\\leq 10^3,S\\leq 4\\times10^5$\n<!--more-->\n\u5982\u679c\u90fd\u662f\u5b8c\u6574\u7684\u76f4\u63a5$AC$\u81ea\u52a8\u673a\u8dd1\u6b65\u4e00\u904d\u5c31\u597d\u4e86\u3002\u8003\u8651\u5230\u4e0d\u91cd\u590d,\u7528$2^{14}$\u5f53\u6bcf\u4e2a\u5b57\u7b26\u4ea7\u751f\u7684\u72b6\u6001\u3002\n\n$dp[i][j][mask]$\u641c\u5230$s[i]$,\u5728$AC$\u81ea\u52a8\u673a\u7b2c$k$\u4e2a\u7ed3\u70b9,\u5b57\u7b26\u4f7f\u7528\u72b6\u6001$mask$\u3002\u663e\u7136\u590d\u6742\u5ea6\u5f88\u9ad8\u3002\n+ \u8003\u8651\u6ca1\u6709\u95ee\u53f7\u7684\u65f6\u5019\uff0c$mask$\u4e0d\u6539\u53d8\uff0c\u679a\u4e3e\u6240\u6709$j$\u5728$AC$\u81ea\u52a8\u673a,\u5c31\u53ef\u4e0d\u7528\u8f6c\u79fb$mask$\u3002\n+ \u8f6c\u79fb$mask$\u7684\u65f6\u5019\u53ea\u8f6c\u79fb\u4e8c\u8fdb\u5236\u6570\u91cf=\u4e4b\u524d\u95ee\u53f7\u6570\u91cf\n\n\u8fd9\u6837\u590d\u6742\u5ea6\u5c31\u53d8\u6210$O(T\\times S+k\\times T\\times(C_{k}^0+C_{k}^1+...C_{k}^{k-1}))=O(k2^{k}T+TS)$\n<details>\n  <summary>\u4ee3\u7801</summary>\n\n```c++\n#include <iostream>\n#include <cstdio>\n#include <algorithm>\n#include <queue>\n#include <cmath>\n#include <cstring>\n#include <vector>\n#include <map>\nusing namespace std;\ntypedef long long ll;\nconst int N = 2e3 + 10;\nconst int mod = 1e9 + 7;\nconst int M = 1 << 14;\nconst int _M = 4e5 + 10;\nconst ll inf = 1e18;\nconst int N_AC = 2e3, M_AC = 14;\nstruct AC\n{\n    int ch[M_AC], fail;\n} tri[N_AC];\nll val[N_AC];\nint tcnt, root;\nint creat()\n{\n    val[++tcnt] = 0;\n    tri[tcnt].fail = 0;\n    memset(tri[tcnt].ch, 0, sizeof(tri[tcnt].ch));\n    return tcnt;\n}\n\nvoid insert(char *t, ll w)\n{\n    int tmp = root;\n    int len = strlen(t);\n    for (int i = 0; i < len; i++)\n    {\n        int k = t[i] - 'a';\n        if (!tri[tmp].ch[k])\n            tri[tmp].ch[k] = creat();\n        tmp = tri[tmp].ch[k];\n    }\n    val[tmp] += w;\n}\nvoid get_AC()\n{\n    queue<int> q;\n    for (int i = 0; i < M_AC; i++)\n        if (tri[root].ch[i])\n        {\n            int k = tri[root].ch[i];\n            tri[k].fail = root;\n            q.push(k);\n        }\n    while (!q.empty())\n    {\n        int x = q.front();\n        q.pop();\n        val[x] += val[tri[x].fail];\n        for (int i = 0; i < M_AC; i++)\n        {\n            int k = tri[x].ch[i];\n            if (k)\n            {\n                tri[k].fail = tri[tri[x].fail].ch[i];\n                q.push(k);\n            }\n            else\n            {\n                tri[x].ch[i] = tri[tri[x].fail].ch[i];\n            }\n        }\n    }\n}\nint n;\nchar s[_M];\n\nll dp[N_AC][M];\nint pos[N_AC];\nll w[N_AC];\nint main()\n{\n    scanf(\"%d\", &n);\n    for (int i = 1; i <= n; i++)\n    {\n        char t[N_AC];\n        ll w;\n        scanf(\"%s%lld\", t, &w);\n        insert(t, w);\n    }\n    get_AC();\n\n    scanf(\"%s\", s + 1);\n\n    int len = strlen(s + 1);\n    for (int i = 0; i <= tcnt; i++)\n        for (int j = 0; j < M; j++)\n            dp[i][j] = -inf;\n    dp[0][0] = 0;\n    for (int p = 0; p <= tcnt; p++)\n    {\n        pos[p] = p;\n        w[p] = 0;\n    }\n    int cnt = 0;\n    for (int i = 1; i <= len; i++)\n    {\n        // cout << \"---\" << endl;\n        if (s[i] == '?')\n        {\n\n            for (int p = 0; p <= tcnt; p++)\n                for (int j = 0; j < M; j++)\n                    if (dp[p][j] != -inf && __builtin_popcount(j) == cnt)\n                    {\n                        //cout << p << \" \" << j << \" \" << __builtin_popcount(j) << endl;\n                        for (int t = 0; t < M_AC; t++)\n                            if (!(j & (1 << t)))\n                            {\n\n                                int ts = j | (1 << t);\n                                int ng = tri[pos[p]].ch[t];\n\n                                dp[ng][ts] = max(dp[ng][ts], dp[p][j] + w[p] + val[ng]);\n                            }\n                    }\n            cnt++;\n            for (int p = 0; p <= tcnt; p++)\n            {\n                pos[p] = p;\n                w[p] = 0;\n            }\n        }\n        else\n        {\n            for (int p = 0; p <= tcnt; p++)\n            {\n                pos[p] = tri[pos[p]].ch[s[i] - 'a'];\n                w[p] += val[pos[p]];\n            }\n        }\n    }\n    ll ans = -inf;\n    for (int p = 0; p <= tcnt; p++)\n        for (int j = 0; j < M; j++)\n            if (dp[p][j] != -inf && __builtin_popcount(j) == cnt)\n                ans = max(ans, dp[p][j] + w[p]);\n\n    printf(\"%lld\\n\", ans);\n}\n```\n</details>\n \n",
        "postTime": 1595168619,
        "uid": 21031,
        "name": "NaCN",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 CF1327G \u3010Letters and Question Marks\u3011"
    },
    {
        "content": "## \u3010AC \u81ea\u52a8\u673a\uff0cDP\u3011CF1327G Letters and Question Marks\n\n### Analysis\n\n\u5bf9\u6240\u6709\u7684 $t$ \u5efa\u51fa AC \u81ea\u52a8\u673a\uff0c\u8003\u8651 $s$ \u7684\u67d0\u4e00\u4f4d\u5339\u914d\u5230\u81ea\u52a8\u673a\u4e0a\u67d0\u4e2a\u8282\u70b9 $u$ \u65f6\uff0c\u8fd9\u4e00\u4f4d\u4ea7\u751f\u7684\u8d21\u732e\u5c31\u662f $u$ \u5728 fail \u6811\u4e0a\u7684\u7956\u5148\u7684 $c$ \u503c\u548c\u3002\n\n\u8003\u8651 DP\u3002\u8bbe $f_{u, S}$ \u662f\u7528\u4e86\u96c6\u5408 $S$ \u5185\u7684\u5b57\u7b26\u66ff\u6362 `?`\uff0c\u5f53\u524d\u5339\u914d\u5230\u4e86\u6811\u4e0a\u7684\u8282\u70b9 $u$ \u7684\u6700\u5927\u4ef7\u503c\u3002\n\n\u5bf9\u4e8e\u4e24\u4e2a\u95ee\u53f7\u4e4b\u95f4\u7684\u5b57\u7b26\uff0c\u53ef\u4ee5\u76f4\u63a5\u5728\u81ea\u52a8\u673a\u4e0a\u8f6c\u79fb\uff0c\u7528 $O(|s||t|)$ \u7684\u590d\u6742\u5ea6\u5904\u7406\u51fa\u6bcf\u4e2a\u6781\u957f\u7684\u8fde\u7eed\u5b57\u6bcd\u4e32\u5728\u81ea\u52a8\u673a\u7684\u6bcf\u4e2a\u8282\u70b9\u4e0a\u5f00\u59cb\u8f6c\u79fb\uff0c\u6700\u7ec8\u4f1a\u8f6c\u79fb\u5230\u54ea\u4e2a\u8282\u70b9\uff0c\u6cbf\u9014\u7d2f\u52a0\u4e86\u591a\u5c11\u4ef7\u503c\u3002\n\n\u5728\u6bcf\u4e2a\u662f\u95ee\u53f7\u7684\u4f4d\u7f6e\uff0c\u679a\u4e3e\u8fd9\u4e00\u4f4d\u7528\u4e86\u4ec0\u4e48\u8f6c\u79fb\u5373\u53ef\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(|s||t| + 2^w |t| w)$\uff0c\u5176\u4e2d $w$ \u4ee3\u8868\u5b57\u7b26\u96c6\u5927\u5c0f\u3002\n\n### Code\n\n```cpp\nnamespace Fusu {\n\nconst int maxt = 14;\nconst int maxh = 1005;\nconst int maxn = 400005;\nconst int maxs = (1 << maxt) + 5;\nconst ll INF = 0x3f3f3f3f3f3f3f3fll;\n\nvoid Init();\nvoid Calc();\nvoid Build();\n\n\nvoid Main() {\n  Init();\n  Build();\n  Calc();\n}\n\nint n;\nchar s[maxn];\n\nstruct Node {\n  ll v;\n  Node *trans[maxt], *fail;\n  std::vector<Node*> fson;\n};\nNode Mem[maxn], *pool = Mem + 1, *rot = Mem;\n\nvoid Init() {\n  qr(n);\n  for (int i = 1, len; i <= n; ++i) {\n    len = qrs(s + 1);\n    auto u = rot;\n    for (int j = 1, k = s[j] - 'a'; j <= len; k = s[++j] - 'a') {\n      u = u->trans[k] ? u->trans[k] : (u->trans[k] = pool++);\n    }\n    qr(len);\n    u->v += len;\n  }\n}\n\nvoid dfs(Node *const u) {\n  for (auto v : u->fson) {\n    v->v += u->v;\n    dfs(v);\n  }\n}\n\nstd::queue<Node*> Q;\nvoid Build() {\n  for (auto &v : rot->trans) if (v != nullptr) {\n    v->fail = rot;\n    Q.push(v);\n  } else {\n    v = rot;\n  }\n  for (Node *u, *v; !Q.empty(); Q.pop()) {\n    u = Q.front(); v = u->fail;\n    v->fson.push_back(u);\n    for (int i = 0; i < maxt; ++i) if (u->trans[i]) {\n      u->trans[i]->fail = v->trans[i];\n      Q.push(u->trans[i]);\n    } else {\n      u->trans[i] = v->trans[i];\n    }\n  }\n  dfs(rot);\n}\n\nstd::vector<std::pair<int, int> > rng;\nll f[maxh][maxs];\nstd::vector<int> sta[maxt];\n\ninline int countbit(int x) { int ret = 0; while (x) { ++ret; x &= x - 1; } return ret; }\n\nvoid Calc() {\n  int nn = qrs(s + 1);\n  int tn = pool - Mem;\n  rng.push_back({0, 0});\n  int jk = 1;\n  for (int i = 1; i <= nn; ++i) if (s[i] == '?') {\n    rng.push_back({jk, i});\n    jk = i + 1;\n  }\n  n = rng.size();\n  int upc = (1 << 14) - 1;\n  for (int i = 0; i <= upc; ++i) {\n    sta[countbit(i)].push_back(i);\n  }\n  memset(f, -0x3f, sizeof f);\n  f[0][0] = 0;\n  for (int i = 1; i < n; ++i) {\n    for (int j = 0; j < tn; ++j) {\n      ll tv = 0;\n      auto u = Mem + j;\n      for (int k = rng[i].first; k < rng[i].second; ++k) {\n        u = u->trans[s[k] - 'a'];\n        tv += u->v;\n      }\n      for (auto s : sta[i - 1]) {\n        for (int k = 0, ss = 1 << k; k < maxt; ss = 1 << ++k) if ((s & ss) == 0) {\n          int pp = u->trans[k] - Mem;\n          f[pp][s | ss] = std::max(f[pp][s | ss], f[j][s] + tv + u->trans[k]->v);\n        }\n      }\n    }\n  }\n  ll ans = -INF;\n  for (int i = 0; i < tn; ++i) {\n    ll tv = 0;\n    auto u = Mem + i;\n    for (int k = jk; k <= nn; ++k) {\n      u = u->trans[s[k] - 'a'];\n      tv += u->v;\n    }\n    for (auto s : sta[n - 1]) {\n      ans = std::max(ans, f[i][s] + tv);\n    }\n  }\n  qw(ans, '\\n');\n}\n\n} // namespace Fusu\n```",
        "postTime": 1591401608,
        "uid": 65363,
        "name": "\u4e00\u6276\u82cf\u4e00",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 CF1327G \u3010Letters and Question Marks\u3011"
    }
]