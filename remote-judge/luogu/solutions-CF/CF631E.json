[
    {
        "content": "//20200804update\uff1a\u62b1\u6b49\uff0c\u63d0\u4ea4\u6b21\u6570\u6709\u70b9\u591a\u662f\u56e0\u4e3aMarkdown\u7206\u70b8\u4e86\uff08\u672c\u673aAC\u63d0\u4ea4RE\u90a3\u79cd\uff09\uff0c\u5e26\u6765\u7684\u9ebb\u70e6\u8bf7\u7ba1\u7406\u5458\u8c05\u89e3\u3002\n## \u3010\u524d\u8a00\u3011\n\n\u4f3c\u4e4e\u697c\u4e0b\u90a3\u7bc7\u659c\u7387\u4f18\u5316\u6ca1\u6709A\u554a\u3002\u3002\u3002\u90a3\u662f\u4e0d\u662f\u6211\u8fd9\u7bc7AC\u4e86\u7684\u66f4\u6709\u53d1\u8a00\u6743\u5462\uff1f\u800c\u4e14\u5199\u6cd5\u663e\u7136\u8981\u597d\u5f97\u591a\uff0c\u7801\u91cf\u4f3c\u4e4e\u662f\u697c\u4e0b\u7684\u4e00\u534a\u3002\n\n## \u3010\u9898\u610f\u3011\n\n\u9898\u610f\u4f3c\u4e4e\u633a\u7b80\u5355\u7684\uff0c\u7ed9\u4f60$n$\u4e2a\u6570\u7684\u4e00\u4e2a\u5e8f\u5217\uff0c\u6743\u503c\u4e3a$\\sum_{i=1}^na_i*i$\uff0c\u8ba9\u4f60\u628a\u4e00\u4e2a\u6570\u79fb\u5230\u53e6\u4e00\u4e2a\u4f4d\u7f6e\uff0c\u4f7f\u5f97\u6743\u503c\u6700\u5927\u3002\u6ce8\u610f\u4e5f\u53ef\u4ee5\u4e0d\u79fb\u3002\n\n## \u3010\u601d\u8def\u3011\n\n\u9996\u5148\u6211\u4eec\u8003\u8651$O(n^2)$\u7684\u66b4\u529b\u505a\u6cd5\u3002\n\n\u5f88\u663e\u7136\uff0c\u7531\u4e8e\u6211\u4eec\u53ea\u79fb\u52a8\u4e00\u4e2a\u6570\uff0c\u56e0\u6b64\u53ea\u9700\u8981\u679a\u4e3e\u8d77\u70b9$i$\u4e0e\u7ec8\u70b9$j$\u5c31\u53ef\u4ee5\u4e86\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u8d77\u70b9\uff0c\u8bbe\u79fb\u52a8\u5b83\u80fd**\u589e\u52a0**\u7684\u6700\u5927\u6743\u503c\u4e3a$ans_i$\uff0c\u6700\u540e\u7b54\u6848\u5373\u4e3a$max(max\\{ans_i\\},0)$\uff08\u6ce8\u610f\u8fd9\u91cc\u662f**\u589e\u52a0**\u7684\u6743\u503c\uff0c\u5373\u5728\u539f\u5e8f\u5217\u57fa\u7840\u4e0a\u6700\u591a\u80fd\u52a0\u591a\u5c11\u6743\u503c\uff0c\u56e0\u6b64\u9700\u8003\u8651\u6240\u6709$ans_i$\u90fd\u5c0f\u4e8e$0$\u65f6\u4e0d\u5982\u4e0d\u52a8\uff0c\u5e76\u540c\u65f6\u8003\u8651\u4e86\u6240\u6709\u4e0d\u52a8\u7684\u60c5\u51b5\uff09\u3002\n\n\u8fd9\u91cc\u6211\u4eec\u5206\u7c7b\u8ba8\u8bba\u3002\n\n\u5bf9\u4e8e$i$\u5411\u524d\u79fb\u52a8\uff08\u5047\u8bbe$i$\u79fb\u5230\u4e86$j$\u7684\u540e\u9762\uff0c\u628a$j+1$\u5411\u540e\u6324\uff09\uff0c\u6211\u4eec\u6709\uff1a\n\n$$ans_i=max\\{\\sum_{k=j+1}^{i-1}a[k]-(i-(j+1))*a[i]\\}(j\\in[0, i-1])$$\n\n\u5176\u4e2d$\\sum_{k=j+1}^{i-1}a[k]$\u8868\u793a\u7b2c$j+1$\u4e2a\u6570\u4e00\u76f4\u5230\u7b2c$i-1$\u4e2a\u6570\uff0c\u6bcf\u4e00\u4e2a\u6570\u90fd\u5411\u540e\u79fb\u52a8\u4e86\u4e00\u4f4d\uff0c\u5373\u7cfb\u6570\u90fd\u589e\u52a0\u4e86$1$\uff0c\u4e5f\u5c31\u662f\u5b83\u7684\u8d21\u732e\u589e\u52a0\u4e86\u5b83\u672c\u8eab\u7684\u6743\u503c\uff0c\u6545\u603b\u6743\u503c\u589e\u52a0$\\sum_{k=j+1}^{i-1}a[k]$\uff0c\u800c\u7b2c$i$\u4e2a\u6570$a[i]$\uff0c\u4f1a\u56e0\u4e3a\u5411\u524d\u79fb\u52a8\u800c\u51cf\u5c0f\u7cfb\u6570\uff0c\u4ece$i$\u53d8\u4e3a$j+1$\u6545\u603b\u6743\u503c\u51cf\u5c11$(i-(j+1))*a[i]$\u3002\n\n\u5bf9\u4e8e$i$\u5411\u540e\u79fb\u52a8\uff08\u540c\u6837\u5047\u8bbe$i$\u79fb\u5230\u4e86$j$\u7684\u540e\u9762\uff0c\u4f46\u8fd9\u6b21\u628a$j$\u5411\u524d\u6324\u4e86\uff09\uff0c\u6b64\u65f6\u6211\u4eec\u6709\uff1a\n\n$$ans_i=max\\{(j-i)*a[i]-\\sum_{k=i+1}^{j}a[k]\\}(j\\in[i+1, n])$$\n\n\u5177\u4f53\u7684\u63a8\u5bfc\u5c31\u4e0d\u518d\u8d58\u8ff0\u4e86\uff0c\u4e0e\u4e0a\u6587\u7c7b\u4f3c\uff0c\u7559\u7ed9\u8bfb\u8005\u81ea\u884c\u601d\u8003\u3002\n\n### \u3010\u5316\u7b80\u3011\n\n\u6211\u4eec\u53d1\u73b0\u8fd9\u751a\u81f3\u4e0d\u662f\u4e00\u4e2a$O(n^2)$\u7684\u7b97\u6cd5\uff0c\u4f46\u5bb9\u6613\u60f3\u5230\u524d\u7f00\u548c\u3002\n\n\u8003\u8651\u8bbe$b[i]=\\sum_{k=1}^i$\u3002\n\n\u6211\u4eec\u6709\uff1a\n$$ans_i=max\\{b[i-1]-b[j]-(i-(j+1))*a[i]\\}(j\\in[0, i-1])$$\n\n$$ans_i=max\\{(j-i)*a[i]-(b[j]-b[i])\\}(j\\in[i+1, n])$$\n\n\u7ed3\u679c\u5199\u5b8c\u73b0\u5728\u7684\u4e24\u4e2a\u5f0f\u5b50\u4e4b\u540e\uff0c\u6211\u4eec\u53d1\u73b0\u4e86\u4e00\u4e9b\u5f88\u6709\u8da3\u7684\u4e8b\u60c5\uff1a\n\n$$ans_i=max\\{b[i-1]-b[j]-(i-(j+1))*a[i]\\}(j\\in[0, i-1])$$\n\n$$=max\\{b[i-1]-b[j]-(i-j-1)*a[i]\\}$$\n\n$$=max\\{b[i-1]-b[j]+(j+1-i)*a[i]\\}$$\n\n$$=max\\{b[i-1]-b[j]+a[i]+(j-i)*a[i]\\}$$\n\n$$=max\\{b[i]-b[j]+(j-i)*a[i]\\}$$\n\n\n$$ans_i=max\\{(j-i)*a[i]-(b[j]-b[i])\\}(j\\in[i+1, n])$$\n\n$$=max\\{b[i]-b[j]+(j-i)*a[i]\\}$$\n\n\u4e8e\u662f\u6211\u4eec\u60ca\u5947\u5730\u53d1\u73b0\u4e24\u4e2a\u5f0f\u5b50**\u5b8c \u5168 \u4e00 \u81f4**\u3002\n\n\u56e0\u6b64\u7801\u91cf**\u5927 \u5927 \u51cf \u5c11**\uff08\u6709\u7528\u90e8\u5206\u5927\u6982$30$\u591a\u884c\uff09\u3002\n\n## \u3010\u4f18\u5316\u3011\n\n\u5f0f\u5b50\u5316\u7b80\u5b8c\u4e86\uff0c\u8003\u8651\u4f18\u5316\u3002\n\n\u8fd9\u4e2a\u5f0f\u5b50\u7b26\u5408\u659c\u7387\u4f18\u5316\u7684\u7279\u70b9\uff0c\u663e\u7136\u53ef\u4ee5\u659c\u7387\u4f18\u5316\u3002\n\n\u8003\u8651\u5316\u5f00\uff0c\u4e0d\u59a8\u8bbe$x < y$\u4e14$x$\u66f4\u4f18\uff0c\u90a3\u4e48\u5bf9\u4e8e\uff1a\n$$ans_i=max\\{b[i]-b[j]+(j-i)*a[i]\\}$$\n\u6709\uff1a\n$$b[i]-b[x]+(x-i)*a[i]>b[i]-b[y]+(y-i)*a[i]$$\n\n\u79fb\u9879\u3001\u6d88\u5143\u5f97\uff1a\n$$-b[x]+x*a[i]>-b[y]+y*a[i]$$\n\n$$(x-y)*a[i]>b[x]-b[y]$$\n\n$$a[i]>\\frac{b[x]-b[y]}{x-y}$$\n\n\u8bbe\u659c\u7387$k=a[i]$\uff0c\u70b9\u5750\u6807\u4e3a$(j, b[j])$\uff0c\u8dd1\u659c\u7387\u4f18\u5316\u5373\u53ef\uff0c\u590d\u6742\u5ea6$O(n)$\u3002\n\n\u7531\u4e8e\u4e00\u5f00\u59cb\u6240\u6709$j$\u90fd\u53ef\u7528\uff0c\u56e0\u6b64\u5148\u628a\u6240\u6709$j$\u5165\u961f\uff0c\u7136\u540e\u76f4\u63a5\u6bcf\u4e00\u4e2a$i$\u626b\u4e00\u904d\u53d6\u6700\u5927\u503c\u5373\u53ef\uff0c\u7531\u4e8e\u659c\u7387\u4e0d\u5355\u8c03\uff0c\u9700\u8981\u4e8c\u5206\u3002\u590d\u6742\u5ea6$O(nlogn)$\uff0c\u53ef\u4ee5\u901a\u8fc7\u672c\u9898\u3002\n\n## \u3010\u4ee3\u7801\u3011\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\ntypedef long long LL;\ntypedef unsigned long long ULL;\ntypedef long double LD;\ntypedef unsigned int UI;\n\ntemplate <typename T>\ninline void read(T &x){\n    x = 0;int fu = 1;\n    char c = getchar();\n    while(c > 57 || c < 48){\n        if(c == 45) fu = -1;\n        c = getchar();\n    }\n    while(c <= 57 && c >= 48){\n        x = (x << 3) + (x << 1) + c - 48;\n        c = getchar();\n    }\n    x *= fu;\n}\ntemplate <typename T>\ninline void fprint(T x){\n    if(x < 0) putchar(45), x = -x;\n    if(x > 9) fprint(x / 10);\n    putchar(x % 10 + 48);\n}\ntemplate <typename T>\ninline void fprint(T x, char ch){\n    fprint(x);putchar(ch);\n}\ntemplate <typename T>\ninline T min(T x, T y) {return x < y ? x : y;}\ntemplate <typename T>\ninline T max(T x, T y) {return x > y ? x : y;}\ntemplate <typename T>\ninline void chmin(T &x, T y) {(x > y) && (x = y);}\ntemplate <typename T>\ninline void chmax(T &x, T y) {(x < y) && (x = y);}\n//\u6709\u6548\u4ee3\u7801\u4ece\u8fd9\u91cc\u5f00\u59cb\nLL b[200010], n, a[200010], ans = 0, ret = 0;\nint ed = 1, q[200010];\ninline LL X(int x) {return x;}\ninline LL Y(int x) {return b[x];}\ninline LL slope_fz(int x, int y) {return Y(x) - Y(y);}//\u7ef4\u62a4\u659c\u7387\uff0c\u5199\u5206\u5b50\u5206\u6bcd\u7684\u539f\u56e0\u5728\u4e8e\u8fd9\u6837\u53ef\u4ee5\u907f\u514d\u7cbe\u5ea6\u7206\u70b8\ninline LL slope_fm(int x, int y) {return X(x) - X(y);}\n\ninline int solve (LL val){//\u4e8c\u5206\u627e\u659c\u7387\n    int L = 2, R = ed, cur = 1;\n    while(L <= R){\n        int mid = (L + R) >> 1;\n        if(slope_fz(q[mid], q[mid - 1]) <= val * slope_fm(q[mid], q[mid - 1])) L = mid + 1, cur = mid;\n        else R = mid - 1;\n    }\n    return q[cur];\n}\n\nint main(){\n    read(n);\n    for (register int i = 1;i <= n;i ++){read(a[i]);b[i] = b[i - 1] + a[i];ans = ans + i * a[i];}//\u6c42\u524d\u7f00\u548c\u4e0e\u539f\u5e8f\u5217\u6743\u503c\uff08\u6bd5\u7adf\u662f\u5728\u6b64\u57fa\u7840\u4e0a\u589e\u52a0\uff09\n    for (register int i = 1;i <= n;i ++){//\u6bcf\u4e2aj\u5165\u961f\n        while(ed > 1 && slope_fz(q[ed], q[ed - 1]) * slope_fm(i, q[ed]) >= slope_fz(i, q[ed]) * slope_fm(q[ed], q[ed - 1])) ed --;\n        q[++ ed] = i;\n    }\n    for (register int i = 1;i <= n;i ++){//\u6bcf\u4e2ai\u626b\u4e00\u904d\n        int j = solve(a[i]);\n        chmax(ret, (j - i) * a[i] + b[i] - b[j]);\n    }\n    fprint(ans + ret);putchar(10);\n}\n```",
        "postTime": 1596541244,
        "uid": 66511,
        "name": "DPair",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF631E \u3010Product Sum\u3011"
    },
    {
        "content": "\u659c\u7387\u4f18\u5316\u5199\u6302\u4e86\uff0c\u4e8e\u662f\u6539\u7528\u597d\u5199\u597d\u8c03\u7684\u674e\u8d85\u7ebf\u6bb5\u6811\u3002\n\n\u5148\u8003\u8651\u5c06 $i$ \u79fb\u52a8\u5230 $j$ \u7684\u60c5\u51b5 ($i<j$) \uff0c\u5bf9\u6570\u7ec4 $a$ \u505a\u524d\u7f00\u548c\uff0c\u8bb0\u4e3a\u6570\u7ec4 $s$ \uff0c\u90a3\u4e48\u589e\u52a0\u7684\u4ef7\u503c\u5373\u4e3a $a_i\\times(j-i)-(s_j-s_i)$ \u3002\n\n\u53bb\u6389\u4e0e $j$ \u65e0\u5173\u7684\u9879\uff0c\u5373\u4e3a $a_i\\times j-s_j$ \u3002\u4ee4 $k=j$ \uff0c $b=-s_j$ \uff0c\u539f\u5f0f\u76f8\u5f53\u4e8e\u76f4\u7ebf $y=kx+b$ \u5728 $x=a_i$ \u65f6\u7684\u503c\u3002\n\n\u7528\u674e\u8d85\u7ebf\u6bb5\u6811\u7ef4\u62a4\u6240\u6709\u76f4\u7ebf\u7684\u6700\u5927\u503c\u5373\u53ef\uff0c\u4e0d\u4f1a\u674e\u8d85\u7ebf\u6bb5\u6811\u7684\u53ef\u4ee5\u53bb\u505a[P4254](https://www.luogu.com.cn/problem/P4254)\u3002\n\n$i>j$ \u7684\u60c5\u51b5\u4e5f\u5dee\u4e0d\u591a\uff0c\u8fd9\u91cc\u5c31\u4e0d\u8d58\u8ff0\u4e86\u3002\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define ll long long\nconst int N=2e5+3,P=1e6+3; \nll a[N],s[N],K[N],b[N],u,v;\nint g[P*5],p;\n#define f(i,j) (K[i]*(j)+b[i])\nvoid upd(int k=1,int l=-P,int r=P){//\u63d2\u5165\u76f4\u7ebf\n\tint m=l+r>>1;\n\tif(f(p,m)>f(g[k],m))swap(p,g[k]);\n\tif(l!=r)K[p]>K[g[k]]?upd(k*2+1,m+1,r):upd(k*2,l,m);\n}\nvoid qry(int k=1,int l=-P,int r=P){//\u67e5\u8be2\u6700\u5927\u503c\n\tif(u=max(u,f(g[k],v)),l==r)return;\n\tint m=l+r>>1;\n\tv>m?qry(k*2+1,m+1,r):qry(k*2,l,m);\n}\nint main(){\n\tint n,i,j,t=0;\n\tll o=0,w=0;\n\tcin>>n,b[0]=-1e18;\n\tfor(i=1;i<=n;++i)cin>>a[i],s[i]=s[i-1]+a[i],o+=i*a[i];\n\tfor(i=1;i<=n;++i)u=-1e18,v=a[i],qry(),w=max(w,u+s[i-1]-a[i]*i),K[++t]=i,b[p=t]=-s[i-1],upd();//i>j\u7684\u60c5\u51b5\n\tmemset(g,t=0,sizeof(g));\n\tfor(i=n;i;--i)u=-1e18,v=a[i],qry(),w=max(w,u+s[i]-a[i]*i),K[++t]=i,b[p=t]=-s[i],upd();//i<j\u7684\u60c5\u51b5\n\tcout<<w+o;\n\treturn 0;\n}\n```\n",
        "postTime": 1590322848,
        "uid": 221955,
        "name": "panyf",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 CF631E \u3010Product Sum\u3011"
    },
    {
        "content": "[${\\large \\color{#ff7daf}{\\text{CF631E Product Sum}}}$](http://xc.fubuki.cn/2019/%E6%96%9C%E7%8E%87%E4%BC%98%E5%8C%96/)\n\n\u9898\u610f\uff1a\u6574\u4e2a\u5e8f\u5217\u7684\u5206\u6570\u4e3a $\\sum\\limits_{i=1}^{n}a_i\u00b7i$ \uff0c\u4f60\u53ef\u4ee5\u5c06\u67d0\u4e2a\u5143\u7d20\u5411\u4efb\u610f\u65b9\u5411\u79fb\u52a8\u4efb\u610f\u4f4d\uff0c\u6c42\u4e00\u6b21\u8be5\u64cd\u4f5c\u540e\u53ef\u83b7\u5f97\u7684\u6700\u5927\u5206\u6570\u3002\n\n\u8bbe $sum_i = \\sum\\limits_{j=1}^{i}a_i$\n\n\u63a5\u4e0b\u6765\u4ee5\u5c06\u7b2c $i$ \u4e2a\u5143\u7d20\u5411\u524d\u79fb\u52a8**\u5230**\u7b2c $j$ \u4e2a\u4f4d\u7f6e\u4e3a\u4f8b\uff1a\n\n\u5c06 $a_i$ \u79fb\u5230 $j$ \u589e\u52a0\u7684\u5206\u6570\uff1a $(j-i)\u00b7a_i-(sum_j-sum_i)$\n\n\u5c1d\u8bd5\u659c\u7387\u4f18\u5316\uff0c\u8bbe $k > j$ \u4e14\u9009\u62e9 $k$ \u8981\u4f18\u4e8e\u9009\u62e9 $j$\uff1a\n\n$(j-i)\u00b7a_i-(sum_j-sum_i)<(k-i)\u00b7a_i-(sum_k-sum_i)$\n\n\u79fb\u9879\u540e\u5408\u5e76\u540c\u7c7b\u9879\uff1a\n\n$j\u00b7a_i-sum_j<k\u00b7a_i-sum_k$\n\n\u518d\u79fb\u9879\uff1a\n\n$sum_k-sum_j<(k-j)\u00b7a_i$\n\n$\\frac{sum_j-sum_k}{j-k}<a_i$\n\n\u7ef4\u62a4\u4e0a\u51f8\u58f3\uff0c\u4e8c\u5206\u8fdb\u884c\u51b3\u7b56\u5373\u53ef\u3002\n\n\u5c06\u67d0\u4e00\u5143\u7d20\u5411\u540e\u79fb\u52a8\u7c7b\u4f3c\uff0c\u6b64\u5904\u4e0d\u505a\u8d58\u8ff0\u3002\n\n\u4ee3\u7801\uff08\u4e0d\u53efAC\uff0c\u4f46\u662f\u6b63\u786e(^_^)\uff09\uff1a\n\n```cpp\n\n#include <cstdio>\n#include <cstring>\n#include <algorithm>\n\n#define maxn 200005\n#define K(x, y) ((1.0 * w[x] - w[y]) / (1.0 * (x) - (y)))\n#define Calc1(x, y) (sum[(x) - 1] - sum[(y) - 1] - a[x] * ((x) - (y)))\n#define Calc2(x, y) (a[x] * ((y) - (x)) - (sum[(y)] - sum[(x)]))\n\nusing namespace std;\ntypedef int LL;\n\nint n, stk[maxn], top = 0;\nLL a[maxn], sum[maxn], ans = 0, w[maxn], res = 0;\n\ninline int read()\n{\n    char ch = getchar();\n    int ret = 0, f = 1;\n    while (ch > '9' || ch < '0')\n    {\n        if (ch == '-')\n            f = -f;\n        ch = getchar();\n    }\n    while (ch >= '0' && ch <= '9')\n        ret = ret * 10 + ch - '0', ch = getchar();\n    return ret * f;\n}\n\nint main()\n{\n    // freopen(\"test.in\", \"r\", stdin);\n    // freopen(\"test.out\", \"w\", stdout);\n    n = read();\n    for (int i = 1; i <= n; ++i)\n    {\n        a[i] = read();\n        sum[i] = sum[i - 1] + a[i];\n        ans += 1ll * i * a[i];\n    }\n    stk[1] = 1, stk[2] = 2, top = 2;\n    w[1] = sum[0], w[2] = sum[1];\n    res = max(0ll, Calc1(2, 1));\n    for (int i = 3; i <= n; ++i)\n    {\n        int l = 1, r = top - 1, j = stk[top];\n        while (l <= r)\n        {\n            int mid = (r - l >> 1) + l;\n            if (K(stk[mid + 1], stk[mid]) > a[i])\n                r = mid - 1, j = stk[mid];\n            else\n                l = mid + 1;\n        }\n        res = max(res, Calc1(i, j));\n        w[i] = sum[i - 1];\n        while (top > 1)\n        {\n            if (K(i, stk[top]) > K(stk[top], stk[top - 1]))\n                break;\n            --top;\n        }\n        stk[++top] = i;\n    }\n    stk[1] = n, stk[2] = n - 1, top = 2;\n    w[n] = sum[n], w[n - 1] = sum[n - 1];\n    res = max(res, Calc2(n - 1, n));\n    for (int i = n - 3; i > 0; --i)\n    {\n        int l = 1, r = top - 1, j = stk[top];\n        while (l <= r)\n        {\n            int mid = (r - l >> 1) + l;\n            if (K(stk[mid + 1], stk[mid]) < a[i])\n                r = mid - 1, j = stk[mid];\n            else\n                l = mid + 1;\n        }\n        res = max(res, Calc2(i, j));\n        w[i] = sum[i];\n        while (top > 1)\n        {\n            if (K(i, stk[top]) < K(stk[top], stk[top - 1]))\n                break;\n            --top;\n        }\n        stk[++top] = i;\n    }\n    printf(\"%I64d\\n\", ans + res);\n    return 0;\n}\n\n```\n\n\u591a\u4e00\u53e5\u5634\uff0c\u7f51\u4e0a\u4e09\u5206\u4ec0\u4e48\u7684\u663e\u7136\u662f\u9519\u7684\uff0c\u6709\u5174\u8da3\u7684\u53ef\u4ee5\u53bb\u53c9\u4e00\u4e0b\u3002$\\color{white}{\\text{\u4e0a\u9762\u7684\u4ee3\u7801\u5f00\u4e0b long long \u5c31\u80fd\u8fc7\u4e86}}$",
        "postTime": 1555504498,
        "uid": 32831,
        "name": "\u5439\u96ea\u5439\u96ea\u5439",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF631E \u3010Product Sum\u3011"
    },
    {
        "content": "### \u524d\u8a00\n\u4e0d\u77e5\u9053\u4e3a\u4ec0\u4e48\u9898\u89e3\u91cc\u7684\u674e\u8d85\u7ebf\u6bb5\u6811\u90fd\u8981\u5206\u4e24\u79cd\u60c5\u51b5\u8ba8\u8bba\uff0c\u6211\u89c9\u5f97\u7684\u5927\u53ef\u4e0d\u5fc5\uff0c\u5176\u5b9e\u4e00\u904d\u5c31\u597d\u4e86\u3002\n\n## \u5206\u6790\n\u8bbe $ans_i$ \u4e3a $i$ \u79fb\u52a8\u5230 \u5176\u4ed6\u4f4d\u7f6e\u65f6\u83b7\u5f97\u7684\u6700\u5927\u53d6\u503c\uff0c$sum_i$ \u4e3a $a_i$ \u7684\u524d\u7f00\u548c\u3002\n\n\u5bf9\u4e8e $ i < j $\uff0c$ans_i=\\max \\{(j-i)\\times a_i-(sum_j-sum_i)\\}$\u3002\n\n\u5bf9\u4e8e $i > j$\uff0c$ans_i=\\max \\{ sum_i-sum_j+[(i-(j+1))]\\times a_i\\}$\u3002\n\n\u5c06\u4e24\u5f0f\u5316\u7b80\u4f1a\u53d1\u73b0\u5b83\u4eec\u90fd\u662f $ans_i=\\max \\{sum_i-sum_j+(j-i)\\times a_i\\}$ \u3002\n\n\u53d1\u73b0\u597d\u50cf\u6ca1\u6709\u5355\u8c03\u6027\uff0c\u5e76\u4e14\u4e8c\u5206\u7684\u659c\u7387\u4f18\u5316\u6211\u4e5f\u4e0d\u4f1a\uff0c\u5c31\u53bb\u8003\u8651\u674e\u8d85\u7ebf\u6bb5\u6811\u3002\n\n\u5c06\u4e0e $j$ \u76f8\u5173\u7684\u5f0f\u5b50\u63d0\u51fa\u4e3a $a_i\\times j-sum_j$\uff0c\u4ee4 $k=j$\uff0c$b=-sum_j$\uff0c\u5c31\u53ef\u4ee5\u5f00\u59cb\u6253\u674e\u8d85\u7ebf\u6bb5\u6811\u4e86\u3002\n\n\u8fd9\u91cc\u5927\u591a\u9898\u89e3\u90fd\u7528\u4e86\u4e24\u6b21 for \u5faa\u73af\uff0c\u6b63\u7740\u53cd\u7740\u90fd\u505a\u4e86\u4e00\u904d\uff0c\u5176\u5b9e\u53ef\u4ee5\u5c06\u7ebf\u6bb5\u5148\u5168\u90e8\u63d2\u5165\uff0c\u518d\u67e5\u8be2\uff0c\u5c31\u53ef\u4ee5\u679a\u4e3e\u4e00\u6b21\u4e86\uff0c\u8be6\u89c1\u4ee3\u7801\uff0c~~\u597d\u50cf\u8fd8\u662f\u4e24\u6b21 for \u5faa\u73af~~\u3002\n\n$code$\n```c\n#include<bits/stdc++.h>\n#define N 200005\n#define T 2000005\n#define int long long\n#define ls u<<1\n#define rs u<<1|1\n#define INF 1e13\nusing namespace std;\nint read(){\n\tint x=0,f=1;char ch=getchar();\n\twhile(ch<'0'||ch>'9'){if(ch=='-')f=-f;ch=getchar();}\n\twhile(ch>='0'&&ch<='9'){x=(x<<1)+(x<<3)+(ch^48);ch=getchar();}\n\treturn x*f;\n}\nint n,ans1,ans2;\nint tree[T<<2];\nint a[N],sum[N],k[N],b[N];\nint calc(int x,int id){return x*k[id]+b[id];}\nint Query(int u,int l,int r,int x){\n\tif(l==r) return calc(x,tree[u]);\n\tint mid=(l+r)>>1,res=calc(x,tree[u]);\n\tif(x<=mid) res=max(res,Query(ls,l,mid,x));\n\telse res=max(res,Query(rs,mid+1,r,x));\n\treturn res;\n}\nvoid UpDate(int u,int l,int r,int id){\n\tif(!tree[u]) return void(tree[u]=id);\n\tif(calc(l,id)>calc(l,tree[u])&&calc(r,id)>calc(r,tree[u])) return void(tree[u]=id);\n\telse if(calc(l,id)<=calc(l,tree[u])&&calc(r,id)<=calc(r,tree[u])) return ;\n\tint mid=(l+r)>>1;\n\tif(k[id]>k[tree[u]]){\n\t\tif(calc(mid,id)>calc(mid,tree[u])) UpDate(ls,l,mid,tree[u]),tree[u]=id;\n\t\telse UpDate(rs,mid+1,r,id);\n\t}else{\n\t\tif(calc(mid,id)>calc(mid,tree[u])) UpDate(rs,mid+1,r,tree[u]),tree[u]=id;\n\t\telse UpDate(ls,l,mid,id);\n\t}\n}\nsigned main(){\n\tn=read();\n\tfor(int i=1;i<=n;++i) a[i]=read(),sum[i]=sum[i-1]+a[i],ans2+=i*a[i];\n\tfor(int i=1;i<=n;++i){\n\t\tk[i]=i,b[i]=-sum[i]; \n\t\tUpDate(1,-1e6,1e6,i);\n\t}\n\tfor(int i=1;i<=n;++i){\n\t\tint x=Query(1,-1e6,1e6,a[i]);\n\t\tans1=max(ans1,x-i*a[i]+sum[i]);\n\t}\n\tprintf(\"%lld\\n\",ans2+ans1);\n\treturn 0;\n}\n```\n",
        "postTime": 1668512541,
        "uid": 220530,
        "name": "jiangchenyangsong",
        "ccfLevel": 6,
        "title": "CF631E Product Sum"
    },
    {
        "content": "[$\\texttt{link}$](https://www.luogu.com.cn/problem/CF631E)\n\n## \u9898\u610f\n\n\u7ed9\u5b9a\u4e00\u4e2a\u957f\u5ea6\u4e3a $n$ \u7684\u5e8f\u5217 $a$\uff0c\u5b9a\u4e49\u8be5\u5e8f\u5217\u7684\u6743\u503c\u4e3a $\\sum\\limits_{i=1}^n i \\cdot a_i$\uff0c\u73b0\u6709\u4e00\u6b21\u5c06\u5e8f\u5217\u4e2d\u67d0\u4e2a\u6570\u79fb\u52a8\u5230\u4efb\u610f\u4f4d\u7f6e\u7684\u673a\u4f1a\uff0c\u53ef\u4ee5\u79fb\u56de\u539f\u4f4d\uff0c\u6c42\u64cd\u4f5c\u540e\u5e8f\u5217 $a$ \u6700\u5927\u6743\u503c\u3002\n\n\u6570\u636e\u8303\u56f4\uff1a$2 \\leq n \\leq 2\\times10^{5},|a_i|\\le10^6$\n\n## \u9898\u89e3\n\n\u8003\u8651\u5148\u7b97\u51fa\u672a\u64cd\u4f5c\u65f6\u7684\u6743\u503c\uff0c\u518d\u53bb\u7b97\u64cd\u4f5c\u540e\u80fd\u4f7f\u7b54\u6848\u589e\u52a0\u7684\u6700\u5927\u503c\u3002\n\n\u8bbe $f_i$ \u8868\u793a\u79fb\u52a8 $a_i$ \u5bf9\u7b54\u6848\u7684\u6700\u5927\u8d21\u732e\u503c\uff0c\u82e5 $a_i$ \u79fb\u5230\u4e86\u4f4d\u7f6e $j$\uff0c\u6211\u4eec\u5206\u7c7b\u8ba8\u8bba\uff1a\n- \u5f53 $i< j$ \u65f6\uff0c$f_i=\\max\\{a_i\\times(j-i)-\\sum\\limits_{k=i+1}^ja_k\\}$\n- \u5f53 $i\\ge j$ \u65f6\uff0c$f_i=\\max\\{\\sum\\limits_{k=j}^{i-1}a_k-a_i\\times(i-j)\\}$\n\n\u540e\u9762\u90a3\u4e2a\u6c42\u548c\u53ef\u4ee5\u7528\u524d\u7f00\u548c\u5f04\u6389\uff0c\u8bbe $sum_i=\\sum\\limits_{j=1}^ia_j$\uff0c\u5219\uff1a\n\n$$f_i=\\begin{cases}\\max\\{a_i\\times(j-i)-sum_j+sum_i\\}&j\\in\\left(i,n\\right]\\\\\\max\\{a_i\\times(j-i)-sum_{j-1}+sum_{i-1}\\}& j\\in\\left[1,i\\right]\\end{cases}$$\n\n\u4e8e\u662f\u6211\u4eec\u5f97\u5230\u4e00\u4e2a $O(n^2)$ \u7684\u505a\u6cd5\u3002\n\n\u5176\u5b9e\u5316\u6210\u8fd9\u6837\u4e5f\u53ef\u4ee5\u505a\uff0c\u4f46\u6bd4\u8f83\u9ebb\u70e6\u3002\n\n\u89c2\u5bdf\u5230\u4e0a\u4e0b\u4e24\u4e2a\u5f62\u5f0f\u5f88\u76f8\u8fd1\uff0c\u8003\u8651\u5f53 $j\\in\\left[1,i\\right]$\uff0c\u4ee4 $j\\gets j-1$ \u8f6c\u5316\u6210\u548c\u4e0a\u9762\u4e00\u6837\u7684\u5f62\u5f0f\u3002\n\n$$\\begin{aligned}f_i&=\\max\\{a_i\\times(j-i)-sum_{j-1}+sum_{i-1}\\}\\ \\ \\ \\ \\ \\ \\ j\\in\\left[1,i\\right]\\\\&=\\max\\{a_i\\times(j+1-i)-sum_{j}+sum_{i-1}\\}\\ \\ \\ \\ \\ \\ \\ j\\in\\left[0,i\\right)\\\\&=\\max\\{a_i\\times(j+1-i)-sum_{j}+sum_{i}-a_i\\}\\ \\ \\ \\ \\ \\ \\ j\\in\\left[0,i\\right)\\\\&=\\max\\{a_i\\times(j-i)-sum_{j}+sum_{i}\\}\\ \\ \\ \\ \\ \\ \\ j\\in\\left[0,i\\right)\\end{aligned}$$\n\n\u53d1\u73b0 $j\\in\\left[0,i\\right)$ \u548c $j\\in\\left(i,n\\right]$ \u65f6\u7684\u8ba1\u7b97\u65b9\u5f0f\u4e00\u6837\uff0c\u6211\u4eec\u4fbf\u5927\u5927\u7b80\u5316\u4e86\u8fc7\u7a0b\u3002\n\n\u4e8e\u662f $f_i=\\max\\{a_i\\times(j-i)-sum_j+sum_i\\}$\u3002\n\n\u62c6\u5f00\u540e $f_i=\\max\\{a_i\\times j-sum_j\\}+sum_i-a_i\\times i$\u3002\n\n\u8fd9\u4e2a\u5f62\u5f0f\u663e\u7136\u53ef\u4ee5\u659c\u7387\u4f18\u5316\uff0c\u82e5 $j_1<j_2$ \u4e14 $i$ \u79fb\u5230 $j_2$ \u65f6\u6bd4\u79fb\u5230 $j_1$ \u65f6\u8d21\u732e\u8981\u5927\uff0c\u6709\uff1a\n$$a_i\\times j_1-sum_{j_1}<a_i\\times{j_2}-sum_{j_2}$$\n$$\\therefore a_i\\times (j_1-j_2)<sum_{j_1}-sum_{j_2}$$\n$$\\therefore a_i>\\dfrac{sum_{j_1}-sum_{j_2}}{j_1-j_2}$$\n\n\u7ef4\u62a4 $(j,sum_{j})$ \u8fd9\u4e9b\u70b9\u7ec4\u6210\u7684\u4e0b\u51f8\u58f3\u5373\u53ef\uff0c\u56e0\u4e3a\u70b9\u5750\u6807\u4e0e $f_j$ \u65e0\u5173\uff0c\u53ef\u4ee5\u5148\u628a\u8fd9\u4e9b\u70b9\u52a0\u8fdb\u6765\uff0c\u6ce8\u610f $a_i$ \u4e0d\u4e00\u5b9a\u662f\u5355\u589e\u7684\uff0c\u53ef\u4ee5\u6709\u4e24\u79cd\u5904\u7406\u65b9\u5f0f\u3002\n\n- \u4e8c\u5206\u4e0b\u51f8\u58f3\uff0c\u627e\u5230\u6bd4 $a_i$ \u5c0f\u7684\u6700\u5927\u659c\u7387\u3002\n\n- \u56e0\u4e3a\u7b54\u6848\u4e0e\u8ba1\u7b97\u987a\u5e8f\u65e0\u5173\uff0c\u5148\u5c06 $a$ \u6392\u5e8f\u540e\u518d\u4e0a\u5355\u8c03\u961f\u5217\u3002\n\n\u8fd9\u4e24\u79cd\u6211\u90fd\u5199\u4e86\uff0c\u4e8c\u5206\u590d\u6742\u5ea6 $O(n\\log n)$\uff0c\u6392\u5e8f\u540e\u5355\u8c03\u961f\u5217\u53ef\u4ee5\u7528\u57fa\u6392\u505a\u5230 $O(n)$\uff0c\u4e0d\u8fc7\u6211\u61d2\u5f97\u5199\u4e86\uff0c\u8c8c\u4f3c\u5355\u8c03\u961f\u5217\u7684\u505a\u6cd5\u4f1a\u5feb\uff08\uff1f\n\n\u53ea\u8d34\u5355\u8c03\u961f\u5217\u7684\u4ee3\u7801\u4e86\u3002\n\n```cpp\n#include <bits/stdc++.h>\n#define ll long long\n#define ld long double\nusing namespace std;\nconst int N = 1e6 + 10;\nint n;\nint q[N], head, tail;\nll sum[N], ans, base;\nstruct node {\n\tint v, id;\n\tfriend bool operator < (const node &qwq, const node &awa) {\n\t\treturn qwq.v < awa.v;\n\t}\n} a[N];\nld slope(int i, int j) {\n\treturn (1. * sum[i] - sum[j]) / (i - j);\n}\nint main() {\n\tscanf(\"%d\", &n);\n\tfor(int i = 1; i <= n; i++) {\n\t\tscanf(\"%d\", &a[i].v);\n\t\tsum[i] = sum[i - 1] + a[i].v, base += 1ll * i * a[i].v;\n\t\ta[i].id = i;\n\t}\n\thead = tail = 1;\n\tfor(int i = 1; i <= n; i++) {\n\t\twhile(tail > 1 && slope(q[tail - 1], i) < slope(q[tail - 1], q[tail])) tail--;\n\t\tq[++tail] = i;\n\t}\n\tsort(a + 1, a + 1 + n);\n\tfor(int i = 1; i <= n; i++) {\n\t\twhile(head < tail && slope(q[head], q[head + 1]) < a[i].v) head++;\n\t\tans = max(ans, 1ll * (q[head] - a[i].id) * a[i].v + sum[a[i].id] - sum[q[head]]);\n\t}\n\tprintf(\"%lld\\n\", ans + base);\n}\n```\n",
        "postTime": 1647656878,
        "uid": 365107,
        "name": "Terac",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF631E Product Sum"
    },
    {
        "content": "\u8003\u8651\u4e00\u6b21\u79fb\u52a8\u4f1a\u7ed9\u603b\u4ef7\u503c\u5e26\u6765\u4ec0\u4e48\u5f71\u54cd\u3002\n\n\u5047\u8bbe\u4e00\u4e2a\u672c\u6765\u5728\u4f4d\u7f6e $i$ \u4e0a\u7684\u6570 $a_i$ \uff0c\u79fb\u52a8\u5230\u4f4d\u7f6e $j$ \u3002\n\n\u82e5 $j<i$ \uff0c\u5219\u7ed9\u603b\u4ef7\u503c\u5e26\u6765\u7684\u8d21\u732e\u4e3a $a_j+a_{j+1}+...+a_{i-1}+a_i\\times (j-i)$ \u3002\n\n\u8bbe $s_i$ \u4e3a $a_i$ \u7684\u524d\u7f00\u548c\uff0c\u5219\u5f0f\u5b50\u53d8\u4e3a $s_{i-1}-s_{j-1}+a_i\\times (j-i)$ \u3002\u53d1\u73b0\u4e0e $j$ \u6709\u5173\u7684\u9879\u53ea\u6709 $a_i\\times j-s_j$ \uff0c\u4e0d\u59a8\u4ee4 $k_j=j,b_j=-s_{j-1}$ \uff0c\u5219\u5f0f\u5b50\u53d8\u4e3a\u4e86\u6c42\u5f53 $x=a_i$ \u65f6\uff0c\u5728\u6240\u6709 $y_j=k_jx+b_j,j<i$ \u7684\u76f4\u7ebf\u4e2d\u6c42\u4e00\u4e2a\u6700\u5927\u7684 $y$ \u503c\u3002\u8fd9\u4e2a\u4e1c\u897f\u5f88\u663e\u7136\u53ef\u4ee5\u7528\u674e\u8d85\u7ebf\u6bb5\u6811\u7ef4\u62a4\u3002\n\n\u540c\u7406\uff0c\u5f53 $j>i$ \u65f6\uff0c\u7ed9\u603b\u4ef7\u503c\u5e26\u6765\u7684\u8d21\u732e\u4e3a $a_i\\times (j-i)-(s_{j}-s_{i})$ \uff0c\u53d1\u73b0\u4e0e $j$ \u6709\u5173\u7684\u9879\u4e3a $a_i\\times j-s_j$ \uff0c\u540c\u6837\u4ee4 $k_j=j,b_j=-s_j$ \uff0c\u674e\u8d85\u7ebf\u6bb5\u6811\u7ef4\u62a4\u5373\u53ef\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(n\\log n)$ \u3002\n\n```cpp\n#include <bits/stdc++.h>\n#define ll long long\n#define maxn 200010\nusing namespace std;\nconst ll maxm=1e6+10;\nconst ll INF=1e18;\n\nll n,c[maxn];\nll t[maxn];\nll a[maxn];\nll b[maxn];\nll u;\n\ninline ll read(){\n    ll x=0,f=0;char c=getchar();\n    while(!isdigit(c)) f|=c=='-',c=getchar();\n    while(isdigit(c)) x=(x<<1)+(x<<3)+(c^48),c=getchar();\n    return f?-x:x;\n}\n\nstruct LC_Tree{\n\n    ll s[maxn*40];\n\n    #define lc k<<1\n    #define rc k<<1|1\n\n    inline void init(){memset(s,0,sizeof(s));}\n\n    inline ll F(ll x,ll y){return a[x]*y+b[x];}\n\n    inline void ins(ll l,ll r,ll k,ll x){\n        if(l==r) return s[k]=(F(s[k],l)>F(x,l))?x:s[k],void();\n        ll mid=(l+r)>>1;\n        if(F(x,mid)>F(s[k],mid)) swap(x,s[k]);\n        if(F(x,l)>F(s[k],l)) ins(l,mid,lc,x);\n        else if(F(x,r)>F(s[k],r)) ins(mid+1,r,rc,x);\n    }\n\n    inline ll qry(ll l,ll r,ll k){\n        ll res=F(s[k],u);\n        if(l==r) return res;\n        ll mid=(l+r)>>1,ans=res;\n        ans=max(ans,u<=mid?qry(l,mid,lc):qry(mid+1,r,rc));\n        return ans;\n    }\n\n\n}tr;\n\nll sm;\nll las;\n\nint main(){\n    n=read();\n    for(register int i=1;i<=n;++i) c[i]=read(),sm+=i*c[i];\n    for(register int i=1;i<=n;++i) t[i]=t[i-1]+c[i],a[i]=i,b[i]=-t[i-1];\n    b[0]=-INF;tr.ins(-maxm,maxm,1,1);las=sm;\n    for(register int i=2;i<=n;++i){\n        u=c[i];las=max(las,sm+tr.qry(-maxm,maxm,1)+t[i-1]-c[i]*i);\n        tr.ins(-maxm,maxm,1,i);\n    }\n    tr.init();\n    for(register int i=1;i<=n;++i) a[i]=i,b[i]=-t[i];\n    b[0]=-INF;tr.ins(-maxm,maxm,1,n);\n    for(register int i=n-1;i>=1;--i){\n        u=c[i];las=max(las,sm+tr.qry(-maxm,maxm,1)+t[i]-c[i]*i);\n        tr.ins(-maxm,maxm,1,i);\n    }\n    printf(\"%lld\\n\",las);\n    return 0;\n}\n```\n\n",
        "postTime": 1647419610,
        "uid": 104163,
        "name": "XeniaF",
        "ccfLevel": 7,
        "title": "CF631E"
    },
    {
        "content": "[\u66f4\u597d\u7684\u9605\u8bfb\u4f53\u9a8c](https://blog.calvincheng1231.org.cn/default/262.html)\n\n## \u5206\u6790\n\u8bbe $sum$ \u4e3a $a$ \u7684\u524d\u7f00\u548c\u6570\u7ec4\u3002\n\n\u4e0b\u9762\u53ea\u8003\u8651 $u>v$ \u7684\u60c5\u51b5\u3002$u<v$ \u65f6\u7c7b\u4f3c\u3002\n\n\u8003\u8651\u5c06 $a_u$ \u79fb\u52a8\u5230 $a_v$ \u4f1a\u7ed9\u7b54\u6848\u5e26\u6765\u591a\u5927\u7684\u8d21\u732e\u3002\n\n\u663e\u7136\u662f $a_u\\times(v-u)+sum_{u-1}-sum_{v-1}$\u3002\n\n\u6574\u7406\u5f97 $(-a_u\\times u+sum_{u-1})+a_u\\times v-sum_{v-1}$\u3002\n\n\u4e5f\u5c31\u662f\u6240\u6709\u76f4\u7ebf $y=vx-sum_{v-1}$ \u5728 $x=a_u$ \u65f6\u7684\u6700\u5927\u53d6\u503c\u3002\n\n\u53ef\u4ee5\u7528\u674e\u8d85\u7ebf\u6bb5\u6811\u7ef4\u62a4\u3002\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log n)$\u3002\n\n\u5b9e\u9645\u6709\u6548\u4ee3\u7801\u53ea\u6709 25 \u884c\uff0c\u800c\u4e14\u6211\u7528\u7684\u662f\u5927\u62ec\u53f7\u6362\u884c\u7684\u7801\u98ce\uff0c\u6240\u4ee5\u5176\u5b9e\u5f88\u597d\u5199\u3002\n\n## \u89e3\u51b3\n```cpp\n#include <algorithm>\n#include <cmath>\n#include <cstdio>\n#include <cstring>\n#include <iostream>\n\nusing namespace std;\nusing LL = long long;\nusing LLL = __int128;\n\nconst int N = 2e5 + 5, S = 1e6 + 5;\nint n, a[N];\nLL sum[N], ans;\n\nclass LCST\n{\nprivate:\n    int mx[N], ls[N], rs[N], k[N], cnt, root, tot;\n    LL b[N];\n\n    int New(int _k, LL _b)\n    {\n        cnt++, k[cnt] = _k, b[cnt] = _b;\n        return cnt;\n    }\n\n    LL y(int id, int x)\n    {\n        return 1LL * x * k[id] + b[id];\n    }\n\n    void insert(int &k, int l, int r, int id)\n    {\n        if (!k)\n            k = ++tot;\n        if (l == r)\n        {\n            if (y(id, l) > y(mx[k], l))\n                mx[k] = id;\n            return;\n        }\n        int mid = ((l + r) >> 1);\n        if (y(id, mid) > y(mx[k], mid))\n            swap(id, mx[k]);\n        if (y(id, l) > y(mx[k], l))\n            insert(ls[k], l, mid, id);\n        if (y(id, r) > y(mx[k], r))\n            insert(rs[k], mid + 1, r, id);\n    }\n\n    LL query(int k, int l, int r, int x)\n    {\n        if (!k)\n            return -1e18;\n        if (l == r)\n            return y(mx[k], x);\n        int mid = ((l + r) >> 1);\n        if (x <= mid)\n            return max(y(mx[k], x), query(ls[k], l, mid, x));\n        else\n            return max(y(mx[k], x), query(rs[k], mid + 1, r, x));\n    }\n\npublic:\n    void insert(int _k, LL _b)\n    {\n        insert(root, -S, S, New(_k, _b));\n    }\n\n    LL query(int x)\n    {\n        return query(root, -S, S, x);\n    }\n\n    void init()\n    {\n        cnt = 0, tot = 1, root = 0, b[0] = -1e18;\n        memset(mx, 0, sizeof(mx));\n        memset(ls, 0, sizeof(ls));\n        memset(rs, 0, sizeof(rs));\n    }\n} lcst;\n\ntemplate<class T>\nvoid read(T &ret)\n{\n    ret = 0;\n    char ch = getchar(), flag = 0;\n    while ((ch < '0' || ch > '9') && ch != '-')\n        ch = getchar();\n    if (ch == '-')\n        ch = getchar(), flag = 1;\n    while (ch >= '0' && ch <= '9')\n        ret = ret * 10 + ch - '0', ch = getchar();\n    if (flag)\n        ret = -ret;\n}\n\ntemplate<class T, class... Args>\nvoid read(T &ret, Args &... rest)\n{\n    read(ret);\n    read(rest...);\n}\n\nint main()\n{\n    read(n);\n    for (int i = 1; i <= n; i++)\n    {\n        read(a[i]);\n        sum[i] = sum[i - 1] + a[i];\n    }\n    lcst.init();\n    for (int i = 1; i <= n; i++)\n    {\n        ans = max(ans, -1LL * a[i] * i + sum[i - 1] + lcst.query(a[i]));\n        lcst.insert(i, -sum[i - 1]);\n    }\n    lcst.init();\n    for (int i = n; i >= 1; i--)\n    {\n        ans = max(ans, -1LL * a[i] * i + sum[i] + lcst.query(a[i]));\n        lcst.insert(i, -sum[i]);\n    }\n    for (int i = 1; i <= n; i++)\n        ans += 1LL * i * a[i];\n    cout << ans << endl;\n    return 0;\n}\n```",
        "postTime": 1633606464,
        "uid": 253946,
        "name": "ClHg2",
        "ccfLevel": 7,
        "title": "CF631E \u9898\u89e3"
    },
    {
        "content": "# \u9898\u76ee\n  \n[\u70b9\u8fd9\u91cc](https://www.luogu.com.cn/problem/CF631E)\u770b\u9898\u76ee\u3002  \n  \n# \u5206\u6790\n     \n\u8bbe\u672a\u4ea4\u6362\u65f6\u7684\u7ed3\u679c\u4e3a $c$\uff0c\u8bb0 $s$ \u4e3a\u524d\u7f00\u548c\u6570\u7ec4\u3002   \n   \n\u90a3\u4e48\u8003\u8651\u5c06 $i$ \u4ea4\u6362\u5230 $j$ \u4e4b\u540e\uff08$j<i$\uff09\uff0c\u4ea4\u6362\u7684\u53d8\u5316\u91cf\u4e3a\uff1a   \n   \n$$\n\\begin{aligned}\n&\\Delta=(s_i-s_j-A_i)+(j+1-i)A_i\\\\\n\\Rightarrow &\\Delta=(jA_i-s_j)+(s_i-iA_i)\n\\end{aligned}\n$$\n\n\u53ef\u4ee5\u53d1\u73b0\u524d\u9762\u7684\u62ec\u53f7\u5185\u662f\u5173\u4e8e $j$ \u548c $i$ \u7684\u51fd\u6570\uff0c\u4e14\u4e0d\u770b $A_i$ \u5219\u662f $j$ \u7684\u4e00\u6b21\u51fd\u6570\u3002   \n   \n\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u674e\u8d85\u7ebf\u6bb5\u6811\u7ef4\u62a4 $0\\sim i-1$ \u7684\u8fd9\u4e9b\u4e00\u6b21\u51fd\u6570\u3002\u5f53\u7136\uff0c\u7531\u4e8e\u659c\u7387\u5355\u8c03\uff0c\u8fd9\u91cc\u53ef\u4ee5\u4f7f\u7528\u5355\u8c03\u6808\u7ef4\u62a4\u4e0b\u51f8\u5305\u3002   \n   \n\u53cd\u8fc7\u6765 $j>i$ \u7684\u60c5\u51b5\u662f\u7c7b\u4f3c\u7684\uff0c\u5316\u7b80\u7684\u7ed3\u679c\u4e3a\uff1a\n   \n$$\n\\Delta=(jA_i+s_j)+(-s_i-iA_i)\n$$     \n   \n\u7c7b\u4f3c\u7ef4\u62a4\u5373\u53ef\u3002\u65f6\u95f4\u662f $O(n\\log_2n)$\u3002   \n   \n# \u4ee3\u7801\n\n```cpp\n#include <cstdio>\n#include <algorithm>\nusing namespace std;\n\ntypedef long long LL;\n\nconst LL INF = 0x3f3f3f3f3f3f3f3f;\nconst int MAXN = 2e5 + 5;\n\ntemplate<typename _T>\nvoid read( _T &x )\n{\n\tx = 0; char s = getchar(); int f = 1;\n\twhile( s < '0' || '9' < s ) { f = 1; if( s == '-' ) f = -1; s = getchar(); }\n\twhile( '0' <= s && s <= '9' ) { x = ( x << 3 ) + ( x << 1 ) + ( s - '0' ), s = getchar(); }\n\tx *= f;\n}\n\ntemplate<typename _T>\nvoid write( _T x )\n{\n\tif( x < 0 ) putchar( '-' ), x = -x;\n\tif( 9 < x ) write( x / 10 );\n\tputchar( x % 10 + '0' );\n}\n\ntemplate<typename _T>\n_T MAX( const _T a, const _T b )\n{\n\treturn a > b ? a : b;\n}\n\ntemplate<typename _T>\nvoid swapp( _T &x, _T &y )\n{\n\t_T t = x; x = y, y = t;\n}\n\nstruct Linear\n{\n\tLL k, b;\n\tLinear() { k = b = 0; }\n\tLinear( LL K, LL B ) { k = K, b = B; }\n\tLL operator () ( const LL x ) const { return k * x + b; }\n};\n\nLinear f[MAXN], func[MAXN];\n\nLL su[MAXN], val[MAXN];\nint A[MAXN], pos[MAXN], coe[MAXN];\nint N, tot;\n\nvoid Build( const int l, const int r )\n{\n\tif( l > r ) return ; \n\tint mid = l + r >> 1;\n\tf[mid] = Linear( 0, -INF );\n\tBuild( l, mid - 1 );\n\tBuild( mid + 1, r );\n}\n\nvoid Update( const int l, const int r, Linear nw )\n{\n\tif( l > r ) return ;\n\tint mid = l + r >> 1;\n\tif( f[mid]( val[mid] ) < nw( val[mid] ) ) swapp( f[mid], nw );\n\tif( f[mid]( val[l] ) <= nw( val[l] ) ) Update( l, mid - 1, nw );\n\telse Update( mid + 1, r, nw );\n}\n\nLL Query( const int l, const int r, const int p )\n{\n\tif( l > r ) return -INF;\n\tint mid = l + r >> 1; LL ret = f[mid]( val[p] );\n\tif( p < mid ) ret = MAX( Query( l, mid - 1, p ), ret );\n\tif( mid < p ) ret = MAX( Query( mid + 1, r, p ), ret );\n\treturn ret;\n}\n\nvoid Discrete()\n{\n\ttot = 0; for( int i = 1 ; i <= N ; i ++ ) val[++ tot] = A[i];\n\tsort( val + 1, val + 1 + tot ); tot = unique( val + 1, val + 1 + tot ) - val - 1;\n\tfor( int i = 1 ; i <= N ; i ++ ) pos[i] = lower_bound( val + 1, val + 1 + tot, A[i] ) - val;\n}\n\nint main()\n{\n\tread( N ); LL ans = 0, base = 0;\n\tfor( int i = 1 ; i <= N ; i ++ ) read( A[i] ), coe[i] = i, base += 1ll * i * A[i];\n\t\n\tDiscrete(), Build( 1, tot ), func[0] = Linear( 0, 0 ), Update( 1, tot, func[0] );\n\tfor( int i = 1 ; i <= N ; i ++ ) func[i] = Linear( i, - ( su[i] = su[i - 1] + A[i] ) );\n\tfor( int i = 1 ; i <= N ; i ++ ) ans = MAX( ans, Query( 1, tot, pos[i] ) + su[i] - 1ll * i * A[i] ), Update( 1, tot, func[i] );\n\tBuild( 1, tot ), func[N + 1] = Linear( N + 1, 0 ), Update( 1, tot, func[N + 1] );\n\tfor( int i = N ; i ; i -- ) func[i] = Linear( i, su[i] = su[i + 1] + A[i] );\n\tfor( int i = N ; i ; i -- ) ans = MAX( ans, Query( 1, tot, pos[i] ) - su[i] - 1ll * i * A[i] ), Update( 1, tot, func[i] );\n\t\n\twrite( ans + base ), putchar( '\\n' );\n\treturn 0;\n}\n```",
        "postTime": 1608297621,
        "uid": 123809,
        "name": "crashed",
        "ccfLevel": 0,
        "title": "[CF631E]Product Sum"
    }
]