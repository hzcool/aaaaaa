[
    {
        "content": "\u5957\u8def\u5f97\u4e00\u9ebb\u6279\n\n\u9898\u610f\uff1a\n\n\u7ed9\u4e00\u9897\u6811\uff0c\u6c42\uff1a\n\n$$\\frac{1}{n(n-1)}\\sum_{i=1}^n\\sum_{j=1}^n\\varphi(a_i*a_j)\u00b7dist(i,j)$$\n\n\u5bf9$10^9+7$\u53d6\u6a21\n\n\u9996\u5148\u6211\u4eec\u77e5\u9053\n\n$$\\varphi(x)=x*\\prod_{p|x}(1-\\dfrac{1}{p})$$\n\n\u6240\u4ee5\u5c31\u6709\uff1a\n\n$$\\varphi(x)*\\varphi(y)=x*y*\\prod_{p|x}(1-\\dfrac{1}{p})*\\prod_{p|y}(1-\\dfrac{1}{p})$$\n\n\u8bbe$k=gcd(x,y)$\n\n\u6211\u4eec\u5047\u88c5\u8ba9$\\varphi(x)*\\varphi(y)=\\varphi(xy)=x*y*\\prod_{p|xy}(1-\\dfrac{1}{p})$\n\n\u4e0d\u96be\u53d1\u73b0\u6709\u5c11\u4e58\u7684\u5acc\u7591...\n\n\u88ab\u5c11\u8ba1\u7b97\u7684\u662f$gcd$\u8d28\u56e0\u6570\u5206\u89e3\u540e\u7684\u90a3\u4e9b\u56e0\u6570\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5f97\u51fa\uff1a\n\n$$\\varphi(xy)=\\dfrac{\\varphi(x)*\\varphi(y)*gcd(x,y)}{\\varphi(gcd(x,y))}$$\n\n\u5ffd\u7565\u6389\u524d\u9762\u7684\u7cfb\u6570\uff0c\u6211\u4eec\u77e5\u9053\u6211\u4eec\u8981\u6c42\u7684\u662f\uff1a\n\n$$\\sum_{i=1}^n\\sum_{j=1}^n\\dfrac{\\varphi(a_i)*\\varphi(a_j)*gcd(a_i,a_j)}{\\varphi(gcd(a_i,a_j))}\u00b7dist(i,j)$$\n\n$$\\sum_{i=1}^n\\sum_{j=1}^n\\dfrac{\\varphi(a_i)*\\varphi(a_j)*gcd(a_i,a_j)}{\\varphi(gcd(a_i,a_j))}(dep_x+dep_y-dep_{lca})$$\n\n\u8fd9\u6837\u505a\u663e\u7136\u5f88\u4e0d\u597d\u505a\n\n\u6211\u4eec\u8003\u8651\u679a\u4e3e$gcd$\uff0c\u53ef\u4ee5\u53d1\u73b0\u6bcf\u4e2a$gcd$\u5bf9\u7b54\u6848\u9020\u6210\u7684\u8d21\u732e\u56fa\u5b9a\n\n\u4e8e\u662f\u5c31\u6709\uff1a\n\n$$\\sum_{d=1}^n\\dfrac{d}{\\varphi(d)}\\sum_{i=1}^n\\sum_{j=1}^n\\varphi(a_i)\\varphi(a_j)(gcd(a_i,a_j)==d)dist(i,j)$$\n\n\u770b\u5230\u4e86\u4e00\u4e2a\u6070\u597d\u7b49\u4e8e...\n\n\u6211\u4eec\u8003\u8651\u8bb0\n\n$$f(d)=\\sum_{i=1}^n\\sum_{j=1}^n\\varphi(a_i)\\varphi(a_j)(gcd(a_i,a_j)==d)dist(i,j)$$\n\n\u5047\u88c5\u6709\uff1a\n\n$$F(x)=\\sum_{x|d}f(d)$$\n\n\u6211\u4eec\u8003\u8651\u6c42\u89e3$F(x)$\n\n\u4e0d\u96be\u53d1\u73b0\n\n$$F(x)=\\sum_{i=1}^n\\sum_{j=1}^n\\varphi(a_i)\\varphi(a_j)[x|gcd(a_i,a_j)]dist(i,j)$$\n\n\u4e14\u6709\uff1a\n\n$$f(x)=\\sum_{x|d}F(d)*\\mu(\\dfrac{d}{x})$$\n\n\u53ef\u4ee5\u53d1\u73b0\u6d89\u53ca\u5230\u7684\u70b9\u53ef\u4ee5\u76f4\u63a5\u679a\u4e3e\u51fa\u6765\uff0c\u800c\u4e14\u56e0\u4e3a$a$\u4e3a$1-n$\u7684\u6392\u5217\uff0c\u6240\u4ee5\u6d89\u53ca\u5230\u7684\u70b9\u7684\u603b\u6570\u5e94\u8be5\u662f\u53ef\u4ee5\u7531\u8c03\u548c\u7ea7\u6570\u5f97\u5230\u4e3a$O(n\\log n)$\u7684\n\n\u4e8e\u662f\u6211\u4eec\u679a\u4e3e$x$\uff0c\u5bf9\u4e8e\u6240\u6709$x|d$\u7684\u70b9\u62ff\u4e0b\u6765\u5efa\u865a\u6811\uff0c\u4e2d\u95f4\u90a3\u4e2a\u827e\u5f17\u68ee\u62ec\u53f7\u5c31\u53ef\u4ee5\u5ffd\u7565\u4e86\n\n\u73b0\u5728\u5f0f\u5b50\u53d8\u6210\uff0c\u7ed9\u7684$m$\u4e2a\u70b9\uff0c\u70b9\u6709\u70b9\u6743\uff0c\u6c42\uff1a\n\n$$\\sum_{i=1}^m\\sum_{j=1}^mv_i*v_j*dist(i,j)$$\n\n$$\\sum_{i=1}^m\\sum_{j=1}^mv_i*v_j*(dep_i+dep_j-2*dep_{lca})$$\n\n\u8bbe$s=v_i*v_j$\n\n$$\\sum_{i=1}^m\\sum_{j=1}^ms*dep_i+s*dep_j-2*s*dep_{lca}$$\n\n\u6211\u4eec\u5c06\u5176\u62c6\u6210$3$\u4e2a$\\sum$\u7684\u5f62\u5f0f\n\n$$\\sum_{i=1}^m\\sum_{j=1}^mv_i*v_j*dep_i+\\sum_{i=1}^m\\sum_{j=1}^mv_i*v_j*dep_j-2\\sum_{i=1}^m\\sum_{j=1}^mv_i*v_j*dep_{lca}$$\n\n\u4e0d\u96be\u53d1\u73b0\u524d\u9762\u4e24\u4e2a\u662f\u76f8\u540c\u7684\n\n$$2\\sum_{i=1}^mv_i*dep_i\\sum_{j=1}^mv_j-2*\\sum_{i=1}^m\\sum_{j=1}^mv_i*v_j*dep_{lca}$$\n\n\u524d\u9762\u90a3\u4e2a\u663e\u7136\u662f\u53ef\u4ee5$O(m)$\u9884\u5904\u7406\u51fa\u6765\u7684\n\n\u4e8e\u662f\u95ee\u9898\u7684\u5173\u952e\u5c31\u5728\u4e8e\u540e\u9762\u90a3\u4e00\u5768\n\n\u6211\u4eec\u8003\u8651\u5728\u865a\u6811\u4e0a$dp$\uff0c\u53ef\u4ee5\u53d1\u73b0\u53ea\u9700\u8981\u5728$lca$\u5904\u5408\u5e76\u7b54\u6848\u5373\u53ef\uff0c\u6240\u4ee5\u8bb0$dp_i$\u8868\u793a$i$\u5185\u90e8\u7684\u5b50\u6811\u6743\u503c\u603b\u548c\u5373\u53ef\uff0c\u590d\u6742\u5ea6\u540c\u6837$O(m)$\n\n\u5f53\u7136\u5efa\u7acb\u865a\u6811\u7684\u590d\u6742\u5ea6\u662f\u5e26$\\log$\u7684\uff0c\u6240\u4ee5\u603b\u590d\u6742\u5ea6\u4e3a$O(n\\log^2n)$ \n\nqwq\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define Next( i, x ) for( register int i = head[x]; i; i = e[i].next )\n#define rep( i, s, t ) for( register int i = s; i <= t; ++ i )\n#define re register\n#define int long long\nint gi() {\n\tchar cc = getchar(); int cn = 0, flus = 1;\n\twhile(cc < '0' || cc > '9') {  if( cc == '-' ) flus = -flus;  cc = getchar();  }\n\twhile(cc >= '0' && cc <= '9')  cn = cn * 10 + cc - '0', cc = getchar();\n\treturn cn * flus;\n}\nconst int N = 4e5 + 5 ; \nconst int P = 1e9 + 7 ;\nint n, cnt, head[N], w[N], rev[N], vis[N], dp[N], Ans ; \nint phi[N], mu[N], p[N], F[N], f[N], top, s[N] ; \nint dfn[N], Fa[N], dep[N], sz[N], Son[N], Top[N], idnex ; \nbool isp[N] ; \nstruct E {\n\tint to, next ; \n} e[N * 2] ;\nvoid add( int x, int y ) {\n\te[++ cnt] = (E){ y, head[x] }, head[x] = cnt , \n\te[++ cnt] = (E){ x, head[y] }, head[y] = cnt ; \n}\nvoid init() {\n\tmu[1] = 1, phi[1] = 1 ; rep( i, 2, n ) {\n\t\tif( !isp[i] ) phi[i] = i - 1, mu[i] = -1, p[++ top] = i ;\n\t\tfor( re int j = 1; j <= top && p[j] * i <= n; ++ j ) {\n\t\t\tisp[i * p[j]] = 1 ; \n\t\t\tif( i % p[j] == 0 ) { phi[i * p[j]] = phi[i] * p[j] ; break ; } \n\t\t\tphi[i * p[j]] = phi[i] * phi[p[j]], mu[i * p[j]] = - mu[i] ; \n\t\t}\n\t}\n}\ninline void dfs( int x, int fa ) {\n\tdfn[x] = ++ idnex, Fa[x] = fa, dep[x] = dep[fa] + 1, sz[x] = 1 ; \n\tNext( i, x ) {\n\t\tint v = e[i].to ; if( v == fa ) continue ; \n\t\tdfs( v, x ), sz[x] += sz[v] ;\n\t\tif( sz[v] > sz[Son[x]] ) Son[x] = v ; \n\t}\n}\ninline void dfs2( int x, int high ) {\n\tTop[x] = high ; \n\tif( Son[x] ) dfs2( Son[x], high ) ;\n\tNext( i, x ) {\n\t\tint v = e[i].to ; if( v == Fa[x] || v == Son[x] ) continue ; \n\t\tdfs2( v, v ) ; \n\t}\n}\ninline int LCA( int x, int y ) {\n\twhile( Top[x] != Top[y] ) {\n\t\tif( dep[Top[x]] < dep[Top[y]] ) swap( x, y ) ;\n\t\tx = Fa[Top[x]] ; \n\t}\n\treturn ( dep[x] < dep[y] ) ? x : y ; \n}\ninline void Dp( int x, int fa ) {\n\tif( vis[x] ) Ans = ( Ans + 2 * phi[w[x]] * phi[w[x]] * dep[x] % P ) % P, dp[x] = phi[w[x]] ; \n\tNext( i, x ) {\n\t\tint v = e[i].to ; if( v == fa ) continue ; \n\t\tDp( v, x ), Ans = ( Ans + 4 * dp[x] * dp[v] % P * dep[x] % P ) % P, \n\t\tdp[x] = ( dp[x] + dp[v] ) % P, dp[v] = 0 ;\n\t}\n\thead[x] = 0 ; \n}\nint fpow( int x, int k ) {\n\tint ans = 1, base = x ; \n\twhile( k ) {\n\t\tif( k & 1 ) ans = ( ans * base ) % P ;\n\t\tbase = ( base * base ) % P, k >>= 1 ;\n\t}\n\treturn ans ;  \n}\nint K[N], tot ; \nbool cmp( int x, int y ) {\n\treturn dfn[x] < dfn[y] ; \n} \nvoid insert( int x ) {\n\tif( top == 1 && x != 1 ) { s[++ top] = x; return ; }\n\tint lca = LCA( s[top], x ) ; if( lca == x ) return ; \n\twhile( top > 1 && dfn[s[top - 1]] > dfn[lca] ) add( s[top - 1], s[top] ), -- top ; \n\tif( dfn[lca] < dfn[s[top]] ) add( lca, s[top] ), -- top ; \n\tif( dfn[lca] > dfn[s[top]] ) s[++ top] = lca ; \n\ts[++ top] = x ; \n}\nvoid input() {\n\tn = gi(), init(), top = 0 ;\n\trep( i, 1, n ) w[i] = gi(), rev[w[i]] = i ; \n\trep( i, 2, n ) add( gi(), gi() ) ; \n\tdfs( 1, 1 ), dfs2( 1, 1 ), memset( head, 0, sizeof(head) ) ;\n}\nvoid solve() {\n\trep( i, 1, n ) {\n\t\tif( i > n / 2 ) break ; \n\t\tint Re = 0, Sum = 0 ;\n\t\tfor( re int j = i; j <= n; j += i ) {\n\t\t\tvis[rev[j]] = 1, Sum = ( Sum + phi[j] * dep[rev[j]] % P ) % P,  \n\t\t\tRe = ( Re + phi[j] ) % P, K[++ tot] = rev[j] ; \n\t\t}\n\t\tsort( K + 1, K + tot + 1, cmp ), s[top = 1] = 1 ;\n\t\trep( i, 1, tot ) insert( K[i] ) ;\n\t\twhile( top > 1 ) add( s[top - 1], s[top] ), -- top ; \n\t\tSum *= Re, Sum %= P, Dp( 1, 1 ), dp[1] = head[1] = 0, F[i] = ( Sum * 2 - Ans + P ) % P ;\n\t\tfor( re int j = i; j <= n; j += i ) vis[rev[j]] = 0 ; Ans = 0, tot = 0, cnt = 0 ;\n\t}\n}\nvoid Get_F() {\n\trep( i, 1, n ) for( re int j = i; j <= n; j += i ) \n\tf[i] += F[j] * mu[j / i], f[i] = ( f[i] + P ) % P ;\n\trep( i, 1, n ) Ans = ( Ans + i * fpow( phi[i], P - 2 ) % P * f[i] ) % P ; \n\tint Ks = Ans * fpow( n, P - 2 ) % P ; Ks = Ks * fpow( n - 1, P - 2 ) % P ;\n\tprintf(\"%I64d\\n\", ( Ks + P ) % P ) ;\n}\nsigned main()\n{\n\tinput(), solve(), Get_F() ; \n\treturn 0 ;\n}\n```",
        "postTime": 1569142244,
        "uid": 30036,
        "name": "Soulist",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 CF809E \u3010Surprise me!\u3011"
    },
    {
        "content": "\u534a\u8282\u653f\u6cbb\u8bfe\u628a\u8fd9\u9898\u63a8\u51fa\u6765\u4e86\u3002\n\n$ans=\\frac{1}{n(n-1)}\\sum\\limits_{i=1}^n\\sum\\limits_{j=1}^n\\varphi(a_ia_j)dist(i,j)$\n\n\u6ce8\u610f\u5230$a_i$\u662f$1$\u5230$n$\u7684\u6392\u5217\uff0c\u56e0\u6b64\u4e3a\u4e86\u65b9\u4fbf\u53ef\u4ee5\u8bbe$p_{a_i}=i$\uff0c\u90a3\u4e48\n\n$ans=\\frac{1}{n(n-1)}\\sum\\limits_{i=1}^n\\sum\\limits_{j=1}^n\\varphi(ij)dist(p_i,p_j)$\n\n\u5982\u679c\u628a\u6b27\u62c9\u51fd\u6570$\\varphi(n)$\u6309\u7167$\\varphi(n)=n\\prod(1-\\frac{1}{q_i})$\uff08$q_i$\u662f$n$\u7684\u8d28\u56e0\u5b50\uff09\u5c55\u5f00\uff0c\u8003\u8651\u91cd\u590d\u7684\u8d28\u56e0\u5b50\u7684\u8d21\u732e\uff0c\u4e0d\u96be\u53d1\u73b0\n\n$\\varphi(xy)=\\frac{\\varphi(x)\\varphi(y)\\gcd(x,y)}{\\varphi(\\gcd(x,y))}$\n\n\u4e8e\u662f\n\n$ans=\\frac{1}{n(n-1)}\\sum\\limits_{i=1}^n\\sum\\limits_{j=1}^n\\frac{\\varphi(i)\\varphi(j)\\gcd(i,j)}{\\varphi(\\gcd(i,j))}dist(p_i,p_j)$\n\n\u6309\u5957\u8def\u679a\u4e3e$\\gcd$\u5e76\u53cd\u6f14\n\n$ans=\\frac{1}{n(n-1)}\\sum\\limits_{d=1}^n\\frac{d}{\\varphi(d)}\\sum\\limits_{i=1}^n\\sum\\limits_{j=1}^n\\varphi(i)\\varphi(j)dist(p_i,p_j)[\\gcd(i,j)=d]$\n\n$=\\frac{1}{n(n-1)}\\sum\\limits_{d=1}^n\\frac{d}{\\varphi(d)}\\sum\\limits_{k=1}^{\\lfloor \\frac{n}{d}\\rfloor}\\mu(k)\\sum\\limits_{i=1}^{\\lfloor\\frac{n}{dk}\\rfloor}\\sum\\limits_{j=1}^{\\lfloor\\frac{n}{dk}\\rfloor}\\varphi(idk)\\varphi(jdk)dist(p_{idk},p_{jdk})$\n\n\u679a\u4e3e$T=dk$\n\n$ans=\\frac{1}{n(n-1)}\\sum\\limits_{T=1}^n\\sum\\limits_{d|T}\\frac{d\\mu(\\frac{T}{d})}{\\varphi(d)}\\sum\\limits_{i=1}^{\\lfloor\\frac{n}{T}\\rfloor}\\sum\\limits_{j=1}^{\\lfloor\\frac{n}{T}\\rfloor}\\varphi(iT)\\varphi(jT)dist(p_{iT},p_{jT})$\n\n\u5f0f\u5b50\u63a8\u5230\u8fd9\u91cc\u5c31\u884c\u4e86\u3002\u9996\u5148$\\sum\\limits_{d|T}\\frac{d\\mu(\\frac{T}{d})}{\\varphi(d)}$\u662f\u5173\u4e8e$T$\u7684\u51fd\u6570\uff0c\u53ef\u4ee5\u679a\u4e3e$d$\u518d\u679a\u4e3e\u5b83\u7684\u500d\u6570\u6765$O(n\\log n)$\u9884\u5904\u7406\u3002\u81f3\u4e8e\u8fd9\u91cc\u7684$\\mu$\u548c$\\varphi$\uff0c\u53ef\u4ee5\u7528\u57c3\u6c0f\u7b5b\u6216\u8005\u7ebf\u6027\u7b5b\u9884\u5904\u7406\u3002\n\n\u518d\u770b\u540e\u9762\u90a3\u4e00\u4e32\uff0c\u53d1\u73b0\u6211\u4eec\u53ef\u4ee5\u628a\u6240\u6709\u70b9\u6743\u662f$T$\u7684\u500d\u6570\u7684\u70b9\u90fd\u627e\u51fa\u6765\u5efa\u865a\u6811\uff0c\u6240\u6709\u865a\u6811\u7684\u603b\u70b9\u6570\u662f$O(n+\\frac{n}{2}+\\frac{n}{3}+...+\\frac{n}{n})=O(n\\log n)$\uff0c\u53ef\u4ee5\u627f\u53d7\u3002\n\n\u4e8e\u662f\u4e0b\u9762\u7684\u95ee\u9898\u5c31\u662f\uff0c\u7ed9\u4e00\u68f5\u6811\uff0c\u6c42\u51fa\n\n$\\sum\\limits_i\\sum\\limits_jb_ib_jdist(i,j)$\n\n\u5176\u4e2d$b_i=\\varphi(a_i)[T|a_i]$\uff08\u8fd9\u91cc\u8981\u5c0f\u5fc3\uff0c\u865a\u6811\u4e0a\u9664\u4e86\u5173\u952e\u70b9\u5916\u7684\u70b9\u6743\u4e3a0\uff09\n\n\u636e\u8bf4\u8fd9\u662f\u4e2a\u5f88\u7b80\u5355\u7684$DP$\uff0c\u4e0d\u8fc7\u6211\u8fd8\u662f\u5927\u529b\u63a8\u4e86\u4e00\u6ce2\u5f0f\u5b50...\n\n\u6811\u5f62$DP$\u7684\u8bdd\uff0c\u8003\u8651\u5408\u5e76\u4e24\u68f5\u5b50\u6811\u7684\u7b54\u6848![](https://cdn.luogu.com.cn/upload/pic/46105.png)\n\n\u8bbe$X,V$\u5206\u522b\u8868\u793a\u4ee5$x,v$\u4e3a\u6839\u7684\u5b50\u6811\uff0c$g_x$\u8868\u793a\u4ee5$x$\u4e3a\u6839\u7684\u5b50\u6811\u7684\u7b54\u6848\uff0c\u90a3\u4e48$g_x=g_x+g_v+w(x,v)$\uff0c\u5176\u4e2d\n\n$w(x,v)=\\sum\\limits_{i\\in X}\\sum\\limits_{j\\in V}b_ib_jdist(i,j)$\n\n$=\\sum\\limits_{i\\in X}b_i\\sum\\limits_{j\\in V}b_jdist(i,j)$\n\n$=\\sum\\limits_{i\\in X}b_i\\sum\\limits_{j\\in V}b_j(dist(i,x)+len+dist(v,j))$\n\n$=(\\sum\\limits_{i\\in X}b_idist(i,x)\\sum\\limits_{j\\in V}b_j)+(len\\sum\\limits_{i\\in X}b_i\\sum\\limits_{j\\in V}b_j)+(\\sum\\limits_{i\\in X}b_i\\sum\\limits_{j\\in V}b_jdist(v,j))$\n\n\u4e8e\u662f\u6211\u4eec\u628a$i$\u548c$x$\uff0c$j$\u548c$V$\u90fd\u653e\u5230\u4e86\u4e00\u8d77\u3002\u5982\u679c\u8bbe\n\n$f_x=\\sum\\limits_{i\\in X}b_idist(i,x)$\n\n$s_x=\\sum\\limits_{i\\in X}b_i$\uff0c\n\n\u90a3\u4e48$w(x,v)=f_xs_v+lens_xs_v+s_xf_v$\uff0c\u5c31\u53ef\u4ee5\u8f6c\u79fb\u4e86\u3002\u81f3\u4e8e$f$\u548c$s$\u7684\u8f6c\u79fb\u4e5f\u5f88\u65b9\u4fbf\uff0c$f_x=f_x+f_v+lens_v,\\ s_x=s_x+s_v$\n\n\u4e8e\u662f\u8fd9\u9053\u9898\u5c31\u505a\u5b8c\u4e86\u3002\n\n\u6c42$LCA$\u5efa\u865a\u6811\u7684\u90e8\u5206\uff0c\u6211\u7528\u7684\u662f\u6b27\u62c9\u5e8f+ST\u8868\uff0c\u8c8c\u4f3c\u6bd4\u500d\u589e\u5feb\u5f88\u591a\uff08\u56e0\u4e3a\u8981\u9891\u7e41\u6c42$LCA$\uff09\n\n```cpp\n#include <cctype>\n#include <cstdio>\n#include <climits>\n#include <algorithm>\n\ntemplate <typename T> inline void read(T& t) {\n    int f = 0, c = getchar(); t = 0;\n    while (!isdigit(c)) f |= c == '-', c = getchar();\n    while (isdigit(c)) t = t * 10 + c - 48, c = getchar();\n    if (f) t = -t;\n}\ntemplate <typename T> void write(T x) {\n    if (x < 0) putchar('-'), x = -x;\n    if (x > 9) write(x / 10);\n    putchar(x % 10 + 48);\n}\ntemplate <typename T> inline void writeln(T x) { write(x); puts(\"\"); }\ntemplate <typename T> inline bool chkmin(T &x, const T &y) { return y < x ? (x = y, 1) : 0; }\ntemplate <typename T> inline bool chkmax(T &x, const T &y) { return x < y ? (x = y, 1) : 0; }\n\ntypedef long long LL;\nconst int maxn = 2e5 + 207;\nconst LL mod = 1e9 + 7;\n\nstruct Tree {\n    int v[maxn << 1], w[maxn << 1], head[maxn], next[maxn << 1], tot;\n    void ae(int x, int y, int z = 0) {\n        v[++tot] = y; w[tot] = z; next[tot] = head[x]; head[x] = tot;\n        v[++tot] = x; w[tot] = z; next[tot] = head[y]; head[y] = tot;\n    }\n};\nTree T, V;\nint dep[maxn], st[maxn], ed[maxn], euler[maxn << 2], xys;\nint md[30][maxn << 2], lg[maxn << 2];\nint p[maxn];\n\nvoid dfs1(int x, int fa) {\n    dep[x] = dep[fa] + 1;\n    euler[++xys] = x;\n    st[x] = xys;\n    for (int i = T.head[x], v = T.v[i]; i; i = T.next[i], v = T.v[i])\n        if (v != fa) { dfs1(v, x); euler[++xys] = x; }\n    ed[x] = xys;\n}\ninline void init() {\n    for (int i = 2; i <= xys; ++i) lg[i] = lg[i >> 1] + 1;\n    for (int i = 1; i <= xys; ++i) md[0][i] = euler[i];\n    for (int j = 1; 1 << j <= xys; ++j)\n        for (int i = 1; i + (1 << j) - 1 <= xys; ++i) {\n            int k = i + (1 << (j - 1));\n            if (dep[md[j - 1][i]] < dep[md[j - 1][k]])\n                md[j][i] = md[j - 1][i];\n            else\n                md[j][i] = md[j - 1][k];\n        }\n}\ninline int getlca(int x, int y) {\n    int l = st[x], r = ed[y];\n    if (l > r) l = st[y], r = ed[x];\n    int k = lg[r - l + 1], t = r - (1 << k) + 1;\n    return dep[md[k][l]] < dep[md[k][t]] ? md[k][l] : md[k][t];\n}\ninline int getdist(int x, int y) { return dep[x] + dep[y] - (dep[getlca(x, y)] << 1); }\n\nLL tmp[maxn], invphi[maxn];\nint phi[maxn];\nint mu[maxn], pri[maxn];\nbool ff[maxn];\n\ninline LL qpow(LL x, LL k) {\n    LL s = 1;\n    for (; k; x = x * x % mod, k >>= 1)\n        if (k & 1) s = s * x % mod;\n    return s;\n}\ninline void sieve(int n) {\n    mu[1] = phi[1] = 1;\n    for (int i = 2; i <= n; ++i) {\n        if (!ff[i]) { phi[i] = i - 1; mu[i] = -1; pri[++pri[0]] = i; }\n        for (int j = 1; j <= pri[0]; ++j) {\n            int x = i * pri[j];\n            if (x > n) break;\n            ff[x] = 1;\n            if (i % pri[j]) {\n                mu[x] = -mu[i];\n                phi[x] = phi[i] * phi[pri[j]];\n            } else {\n                mu[x] = 0;\n                phi[x] = phi[i] * pri[j];\n                break;\n            }\n        }\n    }\n}\n\ninline bool cmp(int a, int b) { return st[a] < st[b]; }\n\nint stk[maxn], top;\nint vs[maxn], vk;\ninline void insert(int x) {\n    if (!top) { stk[++top] = x; return; }\n    int l = getlca(x, stk[top]);\n    while (top > 1 && dep[stk[top - 1]] > dep[l]) {\n        int u = stk[top - 1], v = stk[top];\n        V.ae(u, v, getdist(u, v));\n        --top;\n    }\n    if (dep[l] < dep[stk[top]]) {\n        V.ae(l, stk[top], getdist(l, stk[top]));\n        --top;\n    }\n    if (!top || dep[stk[top]] < dep[l]) stk[++top] = l;\n    stk[++top] = x;\n}\ninline void build() {\n    std::sort(vs + 1, vs + vk + 1, cmp);\n    top = 0;\n    if (vs[1] != 1) stk[top = 1] = 1;\n    V.tot = 0;\n    for (int i = 1; i <= vk; ++i) insert(vs[i]);\n    while (top > 1) {\n        int u = stk[top], v = stk[top - 1];\n        V.ae(u, v, getdist(u, v));\n        --top;\n    }\n}\n\nLL f[maxn], g[maxn], s[maxn];\nint b[maxn], a[maxn];\n\nvoid dfs2(int x, int ffa) {\n    f[x] = g[x] = 0;\n    s[x] = b[x];\n    for (int i = V.head[x]; i; i = V.next[i]) {\n        int v = V.v[i], w = V.w[i];\n        if (v != ffa) {\n            dfs2(v, x);\n            g[x] = (g[x] + g[v] + s[v] * (f[x] + s[x] * w % mod) % mod + f[v] * s[x] % mod) % mod;\n            s[x] = (s[x] + s[v]) % mod;\n            f[x] = (f[x] + f[v] + s[v] * w % mod) % mod;\n        }\n    }\n    V.head[x] = 0;\n    b[x] = 0;\n}\n\nint n;\n\nint main() {\n    read(n);\n    for (int i = 1; i <= n; ++i) read(a[i]), p[a[i]] = i, T.head[i] = 0;\n    T.tot = 0;\n    for (int i = 1; i != n; ++i) {\n        int x, y; read(x); read(y); T.ae(x, y);\n    }\n    dfs1(1, 0);\n    init();\n    sieve(n);\n    for (int i = 1; i <= n; ++i) invphi[i] = qpow(phi[i], mod - 2);\n    for (int d = 1; d <= n; ++d)\n        for (int i = d; i <= n; i += d) {\n            tmp[i] = (tmp[i] + 1ll * d * mu[i / d] % mod * invphi[d] % mod) % mod;\n            if (tmp[i] < 0) tmp[i] += mod;\n        }\n    LL ans = 0;\n    for (int i = 1; i <= n; ++i) {\n        vk = 0;\n        for (int j = i; j <= n; j += i) {\n            vs[++vk] = p[j];\n            b[p[j]] = phi[j];\n        }\n        build();\n        dfs2(1, 0);\n        ans = (ans + tmp[i] * 2ll * g[1] % mod) % mod;\n    }\n    ans = ans * qpow(n, mod - 2) % mod * qpow(n - 1, mod - 2) % mod;\n    writeln(ans);\n    return 0;\n}\n```",
        "postTime": 1544716683,
        "uid": 72071,
        "name": "GKxx",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 CF809E \u3010Surprise me!\u3011"
    },
    {
        "content": "\u5f88\u5957\u8def\u7684\u4e00\u9053\u9898\u3002\n\n\u4e0d\u8fc7$sb$\u9519\u8c03\u4e86\u4e00\u4e2a\u534a\u5c0f\u65f6...\n\n\u597d\u7684\u6211\u4eec\u5f00\u59cb\u5316\u7b80\u5f0f\u5b50\uff1a\n\n\u8bbe$b_{a_i}=i$,\u5373\u6811\u4e0a\u6743\u503c\u4e3a$a_i$\u7684\u7f16\u53f7$i$\n\n$$\\frac 1{n(n-1)}\\sum_{i=1}^n\\sum_{j=1}^n\\varphi(a_ia_j)dis(i,j)$$\n\n$$\\because\\varphi(a_ia_j)=\\frac {\\varphi(a_i)\\varphi(a_j)\\gcd(a_i,a_j)}{\\varphi(\\gcd(a_i,a_j)}$$\n\n$$\\therefore\\ =\\frac 1{n(n-1)}\\sum_{i=1}^n\\sum_{j=1}^n\\frac {\\varphi(a_i)\\varphi(a_j)\\gcd(a_i,a_j)}{\\varphi(\\gcd(a_i,a_j))}dis(i,j)$$\n\n\u679a\u4e3e$gcd$\n\n$$=\\frac 1{n(n-1)}\\sum_{d=1}^n\\sum_{i=1}^n\\sum_{j=1}^n[\\gcd(i,j)==d]\\frac {\\varphi(i)\\varphi(j)d}{\\varphi(d)}dis(b_i,b_j)$$\n\n$$=\\frac 1{n(n-1)}\\sum_{d=1}^n\\frac {d}{\\varphi(d)}\\sum_{i=1}^n\\sum_{j=1}^n[\\gcd(i,j)==d]\\varphi(i)\\varphi(j)dis(b_i,b_j)$$\n\n$$=\\frac 1{n(n-1)}\\sum_{d=1}^n\\frac {d}{\\varphi(d)}\\sum_{i=1}^{\\lfloor \\frac nd\\rfloor}\\sum_{j=1}^{\\lfloor \\frac nd\\rfloor}[\\gcd(i,j)==1]\\varphi(id)\\varphi(jd)dis(b_i,b_j)$$\n\n$$\\frac 1{n(n-1)}\\sum_{d=1}^n\\frac {d}{\\varphi(d)}\\sum_{i=1}^{\\lfloor \\frac nd\\rfloor}\\sum_{j=1}^{\\lfloor \\frac nd\\rfloor}\\sum_{e|i,e|j}\\mu(e)\\varphi(id)\\varphi(jd)dis(b_{id},b_{jd})$$\n\n$$=\\frac 1{n(n-1)}\\sum_{d=1}^n\\frac {d}{\\varphi(d)}\\sum_{e=1}^{\\lfloor \\frac nd\\rfloor}\\mu(e)\\sum_{i=1}^{\\lfloor\\frac n{de}\\rfloor}\\sum_{j=1}^{\\lfloor\\frac n{de}\\rfloor}\\varphi(ide)\\varphi(jde)dis(b_{ide},b_{jde})$$\n\n\u8bbe\n\n$$f(d)=\\sum_{e=1}^{\\lfloor \\frac nd\\rfloor}\\mu(e)\\sum_{i=1}^{\\lfloor\\frac n{de}\\rfloor}\\sum_{j=1}^{\\lfloor\\frac n{de}\\rfloor}\\varphi(ide)\\varphi(jde)dis(b_{ide},b_{jde})$$\n\n\u5957\u8def\u7528\u5b8c\u4e86\uff0c\u7136\u800c\u53d1\u73b0\u6839\u672c\u6ca1\u6709\u529e\u6cd5\u5904\u7406\uff1f\u8fd9\u65f6\u5019\u53d1\u73b0\u53f3\u8fb9\u7684\u9879\u5168\u90e8\u90fd\u662f$ide,jde$\uff0c\u8003\u8651\u628a\u8fd9\u4e2a\u7f29\u6210$i,j$?\n\n\u8bbe$e=ed$\n\n$$f(d)=\\sum_{d|e}\\mu(\\frac ed)\\sum_{i=1}^{\\lfloor\\frac n{e}\\rfloor}\\sum_{j=1}^{\\lfloor\\frac n{e}\\rfloor}\\varphi(ie)\\varphi(je)dis(b_{ie},b_{je})$$\n\n\u8bbe$i=ei,j=ej$\n\n$$f(d)=\\sum_{d|e}\\mu(\\frac ed)\\sum_{e|a_i}^{}\\sum_{e|a_j}\\varphi(i)\\varphi(j)dis(b_{i},b_{j})$$\n\n$$f(d)=\\sum_{d|e}\\mu(\\frac ed)\\sum_{e|a_i}^{}\\sum_{e|a_j}\\varphi(a_i)\\varphi(a_j)dis(i,j)$$\n\n\u4ee3\u5165\u56de\u53bb\n\n$$=\\frac 1{n(n-1)}\\sum_{d=1}^n\\frac {d}{\\varphi(d)}\\sum_{d|e}\\mu(\\frac ed)\\sum_{e|a_i}^{}\\sum_{e|a_j}\\varphi(a_i)\\varphi(a_j)dis(i,j)$$\n\n$$=\\frac 1{n(n-1)}\\sum_{e=1}^n\\frac {d\\mu(\\frac ed)}{\\varphi(d)}\\sum_{d|e}\\sum_{e|a_i}^{}\\sum_{e|a_j}\\varphi(a_i)\\varphi(a_j)dis(i,j)$$\n\n\u8bbe$g(e)=\\sum_{d|e}\\frac {d\\mu(\\frac ed)}{\\varphi(d)}$\n\n\u73b0\u5728\uff0c$g$\u53ef\u4ee5\u8c03\u548c\u7ea7\u6570\u66b4\u529b\u679a\u4e3e\uff08\u4e5f\u53ef\u4ee5\u7ebf\u6027\u7b5b\uff09\n\n\u600e\u4e48\u6c42\u540e\u9762\u7684\u4e00\u5768\u5462\uff1f\uff08\u5bf9\u4e8e\u6bcf\u4e00\u4e2a$e$\uff09\n\n\u53d1\u73b0$e$\u7684\u500d\u6570\u662f\u4e0d\u7b97\u7279\u522b\u591a\u7684\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a$e$\u7684\u500d\u6570\uff0c\u53ea\u6709$\\lfloor\\frac ne\\rfloor$\u4e2a\n\n\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5bf9\u6bcf\u4e00\u4e2a$e$\u5efa\u865a\u6811\uff0c\u590d\u6742\u5ea6$O(nlog^2_2n)$\n\n\u8003\u8651\u8fd9\u4e2a\u5947\u602a\u7684\u5f0f\u5b50\uff1a\n\n$$=\\sum_{i}^{}\\sum_{j}\\varphi(a_i)\\varphi(a_j)(dep[i]+dep[j]-2dep[lca(i,j)])$$\n\n$$=\\sum_{i}\\varphi(a_i)dep[i]\\cdot\\sum_{j}\\varphi(a_j)+\\sum_{i}\\varphi(a_i)\\cdot\\sum_{j}\\varphi(a_j)dep[j]-2\\sum_{i}\\sum_{j}\\varphi(a_i)\\varphi(a_j)dep[lca(i,j)]$$\n\n$$=2\\sum_{i}\\varphi(a_i)dep[i]\\cdot\\sum_{j}\\varphi(a_j)-2\\sum_{i}\\sum_{j}\\varphi(a_i)\\varphi(a_j)dep[lca(i,j)]$$\n\n\u524d\u9762\u8fd9\u4e2a\u5f0f\u5b50\u76f4\u63a5\u51fa\u6765\u3002\n\n\u540e\u9762\u8fd9\u4e2a\u5f0f\u5b50\u600e\u4e48\u6c42\uff1f\u7c7b\u4f3c\u70b9\u5206\u6cbb\u4e00\u6837\u679a\u4e3e\u865a\u6811\u4e0a$lca(i,j)=u$\u7684\u70b9\n\n$$\\sum_{i}\\sum_{j}\\varphi(a_i)\\varphi(a_j)dep[lca(i,j)]$$\n\n$$=dep[u]\\sum_{i}\\varphi(a_i)\\sum_{j}\\varphi(a_j)$$\n\n\u53d1\u73b0$i,j$\u5c5e\u4e8e\u6839\u8282\u70b9\u6216\u8005\u6839\u8282\u70b9\u7684\u4e0d\u540c\u5b50\u6811\uff0c\u50cf\u5e76\u67e5\u96c6\u4e00\u6837\u5408\u5e76\uff0c\u4e58\u4e00\u4e58\uff0c\u5c31\u597d\u4e86\u3002\n\n\u7ec6\u8282\uff1a\u4e0d\u8981\u5fd8\u8bb0\u7b97\u4e0a$u$\u81ea\u5df1\u7684\u7b54\u6848\uff01$(u,u)$\n\n```cpp\n#include<bits/stdc++.h>\n#define ll long long\n#define ljc 1000000007\nusing namespace std;\n#ifdef Fading\n#define gc getchar\n#endif\n#ifndef Fading\ninline char gc(){\n\tstatic char now[1<<16],*S,*T;\n\tif (T==S){T=(S=now)+fread(now,1,1<<16,stdin);if (T==S) return EOF;}\n\treturn *S++;\n}\n#endif\ninline ll read(){\n    register ll x=0,f=1;char ch=gc();\n    while (!isdigit(ch)){if(ch=='-')f=-1;ch=gc();}\n    while (isdigit(ch)){x=(x<<3)+(x<<1)+ch-'0';ch=gc();}\n    return (f==1)?x:-x;\n}\nstruct edge{\n    int to,nxt;\n}g[1000001];\nint tcnt,head[300001],N,tpos[400001][2],dep[500001],f[500001][20],n,m,tot;\ninline void made(int from,int to){\n    g[++tot].to=to;g[tot].nxt=head[from];head[from]=tot; \n}\nvoid dfs(int u,int fa){\n\ttpos[u][0]=++tcnt;\n    dep[u]=dep[fa]+1;f[u][0]=fa;\n    for (int i=1;i<=19;i++) f[u][i]=f[f[u][i-1]][i-1];\n    for (int i=head[u];i;i=g[i].nxt){\n        int v=g[i].to;\n        if (v==fa) continue;\n        dfs(v,u);\n    }\n\ttpos[u][1]=++tcnt;\n}\ninline int lca(int x,int y){\n    if (dep[x]<dep[y]) swap(x,y);\n    for (int i=19;i>=0;i--){\n        if (dep[f[x][i]]>=dep[y]) x=f[x][i];\n    }\n    if (x==y) return x;\n    for (int i=19;i>=0;i--){\n        if (f[x][i]!=f[y][i]) x=f[x][i],y=f[y][i];\n    }\n    return f[x][0];\n}\nll a[300001],yyy,NN,b[300001],mu[300001],inv[300001];\nbool vis[300001];\nll phi[300001],G[300001],p[300001];\ninline void init(){\n\tn=read();\n\tfor (int i=1;i<=n;i++) a[i]=read(),b[a[i]]=i;\n\tfor (int i=1;i<n;i++){\n\t\tint x=read(),y=read();made(x,y);made(y,x);\n\t}\n\tmu[1]=phi[1]=inv[0]=inv[1]=1;\n\tfor (int i=2;i<=n;i++) inv[i]=(ljc-(ljc/i)*inv[ljc%i]%ljc)%ljc;\n    for (int i=2;i<=n;i++){\n        if (!vis[i]){mu[i]=-1;phi[i]=i-1;p[++yyy]=i;}\n        for (int j=1;j<=yyy;j++){\n            if (p[j]*i>n) break;\n            vis[i*p[j]]=1;\n            if (i%p[j]==0){\n            \tphi[i*p[j]]=p[j]*phi[i];mu[i*p[j]]=0;break;\n            }\n            mu[i*p[j]]=-mu[i];phi[i*p[j]]=(p[j]-1)*phi[i];\n        }\n    }\n    NN=inv[n]*inv[n-1]%ljc;\n\tfor (int i=1;i<=n;i++){\n\t\tfor (int j=i;j<=n;j+=i){\n\t\t\tG[j]=(G[j]+1LL*inv[phi[i]]*i%ljc*(ljc+mu[j/i])%ljc)%ljc; \n\t\t}\n\t}\n\tdfs(1,0);\n}\nnamespace VT{\n\tint head[211111],tot;\n\tll a[211111],sz[211111];\n\tstruct edge{\n\t\tint to,nxt;\n\t}g[1000001];\n\tinline void made(int from,int to){\n\t\tg[++tot].to=to;g[tot].nxt=head[from];head[from]=tot;\n\t}\n\tll dp(int u){\n\t\tsz[u]=phi[a[u]];\n\t\tll NOW=sz[u]*sz[u]%ljc,tmp=0;//NOW\u5148\u52a0\u4e0a\u81ea\u5df1\u7684\u7b54\u6848\n\t\tfor (int i=head[u];i;i=g[i].nxt){\n\t\t\tint v=g[i].to;\n\t\t\ttmp=(tmp+dp(v))%ljc;//tmp\u8868\u793a\u5b50\u6811\u7684\u7b54\u6848\u548c\n\t\t\tNOW=(NOW+2*sz[u]*sz[v]%ljc)%ljc;//\u4e582\u662f\u7531\u4e8e\u65e0\u5e8f\n\t\t\tsz[u]=(sz[u]+sz[v])%ljc;\n\t\t}\n\t\treturn (NOW*dep[u]%ljc+tmp)%ljc;\n\t}\n}\nint sta[1000001],top,has[1000001],que[1000001];\ninline bool cmp(int x,int y){\n    int k1=(x>0)?tpos[x][0]:tpos[-x][1],k2=(y>0)?tpos[y][0]:tpos[-y][1];\n    return k1<k2;\n}\nsigned main(){\n\tinit();\n\tll ANS=0;\n\tfor (int i=1;i<=n;i++){\n\t\tint L=0;ll now=0,ai=0,dai=0;\n\t\tfor (int j=i;j<=n;j+=i){\n\t\t\tque[++L]=b[j];has[que[L]]=1;VT::a[b[j]]=j;\n\t\t\tai=(ai+phi[j])%ljc;\n\t\t\tdai=(dai+phi[j]*dep[b[j]]%ljc)%ljc;\n\t\t}\n\t\tnow=2*dai%ljc*ai%ljc;\n\t\tsort(que+1,que+1+L,cmp);\n\t\tint cnt=L;\n\t\tfor (int j=1;j<cnt;j++){\n\t\t\tint lc=lca(que[j],que[j+1]);\n\t\t\tif (!has[lc]) has[lc]=1,que[++L]=lc;\n\t\t}\n\t\tcnt=L;\n\t\tfor (int j=1;j<=cnt;j++) que[++L]=-que[j];\n\t\tif (!has[1]) que[++L]=1,que[++L]=-1,has[1]=1;\n\t\tsort(que+1,que+1+L,cmp);\n\t\tfor (int j=1;j<=L;j++){\n\t\t\tif (que[j]>0){\n\t\t\t\tif (top) VT::made(sta[top],que[j]);\n\t\t\t\tsta[++top]=que[j];\n\t\t\t}else{\n\t\t\t\thas[sta[top--]]=0;\n\t\t\t}\n\t\t}\n\t\tVT::tot=0;\n\t\tnow=(now-2*(VT::dp(1))%ljc+ljc)%ljc;\n\t\tfor (int j=1;j<=L;j++){\n\t\t\tif (que[j]>0) VT::head[que[j]]=0,VT::a[que[j]]=0;\n\t\t}\n\t\tANS=(ANS+now*G[i]%ljc)%ljc;\n\t}\n\tcout<<ANS*NN%ljc;\n\treturn 0;\n}\n\n```\n",
        "postTime": 1559293398,
        "uid": 20309,
        "name": "Fading",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 CF809E \u3010Surprise me!\u3011"
    },
    {
        "content": "\u6211\u4eec\u8981\u6c42\u7684\u67ff\u5b50\u662f\u5f20\u8fd9\u6837\u5b50\u7684\uff1a\n\n$$\\frac{1}{n * (n - 1)} * \\sum_{i = 1}^n\\sum_{j = 1}^{n}\\phi(a_i*a_j)*dis(i, j)$$\n\n\u5176\u4e2d$a_i$\u4e3a\u4e00\u4e2a\u6392\u5217\uff0c$dis(i, j)$\u8868\u793a\u5728\u6811\u4e0a\u7684\u8ddd\u79bb\n\n\u8fd9\u79cd\u9898\u7684\u5957\u8def\u4e00\u822c\u662f\u5148\u62c6\u67ff\u5b50\uff0c\u4f46\u662f\u8fd9\u9053\u9898\u7684\u5f0f\u5b50\u2026\u2026\n\n\u6211\u4eec\u8981\u4ece\u4e00\u4e2a\u6027\u8d28\u4e0b\u624b\uff1a\n$$\\phi(a * b) = \\frac{\\phi(a) * \\phi(b) * gcd(a, b)}{\\phi(gcd(a, b))}$$\n\n\u4ee3\u5165\u539f\u5f0f\u5f97\uff1a\n\n$$\\frac{1}{n * (n - 1)} * \\sum_{i = 1}^n\\sum_{j = 1}^{n}\\frac{\\phi(a_i) * \\phi(a_j) * gcd(a_i, a_j)}{\\phi(gcd(a_i, a_j))}*dis(i, j)$$\n\n\u5148\u5ffd\u7565\u524d\u9762\u7684\u6570\uff0c\u53ea\u770b\u540e\u9762\u7684$\\sum$\uff0c\u679a\u4e3e$gcd(a_i, a_j)$\uff0c\u5f97\u5230\n\n$$\\sum_{k = 1}^n\\frac{k}{\\phi(k)}\\sum_{i = 1}^n\\sum_{j = 1}^{n}\\phi(a_i) * \\phi(a_j)*dis(i, j)*[gcd(a_i, a_j) == k]$$\n\n\u7136\u540e\u53cd\u6f14\u4e00\u6ce2\uff0c\u5f97\u5230\uff1a\n\n$$\\sum_{k = 1}^n\\frac{k}{\\phi(k)}\\sum_{i = 1}^n\\sum_{j = 1}^{n}\\phi(a_i) * \\phi(a_j)*dis(i, j)*\\sum_{(x * k|a[i]) \\& (x * k | a[j])}\\mu(x)$$\n\n\u679a\u4e3e$k * x$\n\n$$\\sum_{T = 1}^n\\sum_{k|T}\\frac{k}{\\phi(k)}\\sum_{i = 1}^n\\sum_{j = 1}^{n}\\phi(a_i) * \\phi(a_j)*dis(i, j)*\\sum_{(T|a[i]) \\& (T | a[j])}\\mu(\\frac{T}{k})$$\n\n\u4ea4\u6362\u987a\u5e8f\u5f97\uff1a\n$$\\sum_{T = 1}^n\\sum_{k|T}\\frac{k}{\\phi(k)} * \\mu(\\frac{T}{k})\\sum_{a[i]\\ |\\ T}\\sum_{a[j]\\ |\\ T}\\phi(a_i) * \\phi(a_j)*dis(i, j)$$\n\n\u6211\u4eec\u8003\u8651\u679a\u4e3eT\uff0c\u5bf9\u4e8e\u540e\u9762\u7684\u67ff\u5b50\uff0c\u6211\u4eec\u53ef\u4ee5\u5355\u72ec\u62ce\u51fa\u6765\uff0c\u5bf9\u6240\u6709$a[i] | T$\u7528\u6811\u5f62DP\u6c42\u51fa\u540e\u9762\u67ff\u5b50\u7684\u7b54\u6848\uff0c\u524d\u9762\u7684\u67ff\u5b50\u53ef\u4ee5\u63d0\u524d\u4e0e\u5904\u7406\u51fa\u6765\n\n\u7531\u4e8e\u865a\u6811\u7684\u603b\u70b9\u6570\u662f$(nlogn)$\u4e2a\uff08\u5e76\u4e0d\u4f1a\u8bc1\u660e\uff09\uff0c\u6240\u4ee5\u590d\u6742\u5ea6\u6b63\u786e\uff0c\u4f46\u7531\u4e8e\u865a\u6811\u4e0a\u7684DP\u548c\u666e\u901aDP\u6709\u4e00\u5b9a\u5dee\u5f02\uff0c\u6240\u4ee5\u6211\u4eec\u8fd8\u9700\u8981\u5bf9\u540e\u9762\u7684\u67ff\u5b50\u7ee7\u7eed\u5316\u7b80\n\n$$\\sum_{a[i]\\ |\\ T}\\sum_{a[j]\\ |\\ T}\\phi(a_i) * \\phi(a_j)*dis(i, j)$$\n\n\u62c6\u5f00$dis(i, j)$\u5f97\uff1a\n\n$$\\sum_{a[i]\\ |\\ T}\\sum_{a[j]\\ |\\ T}\\phi(a_i) * \\phi(a_j)*(dep[i] + dep[j] - 2 * dep[lca(i, j)])$$\n\n\u4ee4$val[i] = \\phi(a_i)$\uff0c\u628a\u6240\u6709$a[i] | T$\u62ce\u51fa\u6765\uff0c\u5047\u8bbe\u6709x\u4e2a\n\n$$\\sum_{i= 1}^{x}\\sum_{j = 1}^xval[i] * val[j]*(dep[i] + dep[j] - 2 * dep[lca(i, j)])$$\n\n$$\\sum_{i= 1}^{x}\\sum_{j = 1}^xval[i] * val[j]*dep[i] + \\sum_{i= 1}^{x}\\sum_{j = 1}^xval[i] * val[j] * dep[j] -2 *  \\sum_{i= 1}^{x}\\sum_{j = 1}^xval[i] * val[j] * dep[lca(i, j)])$$\n$$2 * \\sum_{i= 1}^{x}val[i] *dep[i] \\sum_{j = 1}^xval[j]  -2 *  \\sum_{i= 1}^{x}\\sum_{j = 1}^xval[i] * val[j] * dep[lca(i, j)])$$\n\n\u524d\u9762\u7684\u67ff\u5b50\u53ef\u4ee5\u4e0e\u5904\u7406\u51fa\u6765\uff0c\u540e\u9762\u7684\u67ff\u5b50\u53ea\u9700\u8981\u6211\u4eec\u5728\u865a\u6811\u4e0a\u679a\u4e3elca\uff0c\u6c42\u51fa$\\sum_{i= 1}^{x}\\sum_{j = 1}^xval[i] * val[j]*[lca(i, j) == lca]$\n\n\u8fd9\u4e2a\u503c\u5176\u5b9e\u4e0d\u96be\u6c42\uff0c\u8bb0\u5f55$f(x)= \\sum_{i = 1}^xval[i]$\u5373\u53ef\n## $Code:$\n```\n#include<bits/stdc++.h>\nusing namespace std;\n#define il inline\n#define re register\n#define mod 1000000007\nil int read() {\n    re int x = 0, f = 1; re char c = getchar();\n    while(c < '0' || c > '9') { if(c == '-') f = -1; c = getchar();}\n    while(c >= '0' && c <= '9') x = x * 10 + c - 48, c = getchar();\n    return x * f;\n}\n#define rep(i, s, t) for(re int i = s; i <= t; ++ i)\n#define Next(i, u) for(re int i = head[u]; i; i = e[i].next)\n#define mem(k, p) memset(k, p, sizeof(k))\n#define maxn 400005\nint n, m, Go[maxn], head[maxn], cnt, rev[maxn];\nstruct edge { int v, next; }e[maxn << 1];\nil void add(int u, int v) {\n    e[++ cnt] = (edge){v, head[u]}, head[u] = cnt;\n    e[++ cnt] = (edge){u, head[v]}, head[v] = cnt;\n}\nil int mul(int a, int b) { return 1ll * a * b % mod; }\nil int qpow(int a, int b) {\n    int r = 1;\n    while(b) {\n        if(b & 1) r = mul(a, r);\n        a = mul(a, a), b >>= 1;\n    }\n    return r;\n}\n\nint prim[maxn], tot, Vis[maxn], phi[maxn], mu[maxn], F[maxn], ans, G[maxn];\nil void init(int n) {\n    mu[1] = phi[1] = 1;\n    rep(i, 2, n) {\n        if(!Vis[i]) prim[++ cnt] = i, mu[i] = -1, phi[i] = i - 1;\n        rep(j, 1, cnt) {\n            if(i * prim[j] > n) break;\n            Vis[i * prim[j]] = 1;\n            if(i % prim[j] == 0) {\n                phi[i * prim[j]] = phi[i] * prim[j];\n                break;\n            }\n            mu[i * prim[j]] = -mu[i], phi[i * prim[j]] = phi[i] * phi[prim[j]];\n        }\n    }\n    rep(i, 1, n) \n        for(re int j = i; j <= n; j += i) \n        \tF[j] = (F[j] + mul(mul(i, qpow(phi[i], mod - 2)), mu[j / i])) % mod, F[j] = (F[j] + mod) % mod;\n}\n\nint fa[maxn], dep[maxn], Top[maxn], dfn[maxn], col, son[maxn], size[maxn];\nil void dfs1(int u, int fr) {\n    size[u] = 1, fa[u] = fr, dep[u] = dep[fr] + 1;\n    Next(i, u) {\n        int v = e[i].v;\n        if(v == fr) continue;\n        dfs1(v, u), size[u] += size[v];\n        if(size[v] > size[son[u]]) son[u] = v;\n    }\n}\nil void dfs2(int u, int fr) {\n    dfn[u] = ++ col, Top[u] = fr;\n    if(son[u]) dfs2(son[u], fr);\n    Next(i, u) if(e[i].v != fa[u] && e[i].v != son[u]) dfs2(e[i].v, e[i].v);\n}\nil int LCA(int u, int v) {\n    while(Top[u] != Top[v]) dep[Top[u]] > dep[Top[v]] ? u = fa[Top[u]] : v = fa[Top[v]];\n    return dep[u] > dep[v] ? v : u;\n}\n\nint st[maxn], top, a[maxn], tmp, pax, vis[maxn], f[maxn], val[maxn], g[maxn];\nil bool cmp(int a, int b) { return dfn[a] < dfn[b]; }\nil void insert(int x) {\n    if(top == 1 && x != 1) return (void)(st[++ top] = x);\n    int lca = LCA(st[top], x);\n    if(x == lca) return;\n    while(top > 1 && dep[st[top - 1]] > dep[lca]) {\n        add(st[top], st[top - 1]), -- top; \n    }\n    if(dep[st[top]] > dep[lca]) add(lca, st[top]), -- top;\n    if(dep[st[top]] < dep[lca]) st[++ top] = lca;\n    st[++ top] = x;\n}\nil void build(int n) {\n    sort(a + 1, a + n + 1, cmp), st[top = 1] = 1;\n    rep(i, 1, n) insert(a[i]);\n    while(top > 1) add(st[top - 1], st[top]), -- top;\n}\nil void get_dis(int u, int fr) {\n    if(vis[u]) f[u] = mul(phi[Go[u]], dep[u]), val[u] = phi[Go[u]];\n    int sum = val[u];\n    Next(i, u) {\n        int v = e[i].v;\n        if(v == fr) continue;\n        get_dis(v, u);\n        g[u] = (g[u] + mul(val[v], sum)) % mod;\n        sum = (sum + val[v]) % mod;\n        f[u] = (f[u] + f[v]) % mod, val[u] = (val[u] + val[v]) % mod;\n    }\n    g[u] = mul(g[u], dep[u]);\n}\nil void dfs_mem(int u, int fr) {\n    Next(i, u) if(e[i].v != fr) dfs_mem(e[i].v, u);\n    tmp = (tmp + g[u]) % mod, head[u] = vis[u] = f[u] = val[u] = g[u] = 0;\n}\nil void solve() {\n    rep(T, 1, n / 2) {\n        pax = tmp = cnt = 0;\n        for(re int i = T; i <= n; i += T) a[++ pax] = rev[i], vis[rev[i]] = 1;\n        build(pax), get_dis(1, 0);\n        G[T] = 2ll * mul(f[1], val[1]) % mod;\n        dfs_mem(1, 0), tmp = mul(2, tmp);\n        rep(i, 1, pax) tmp = (tmp + mul(dep[a[i]], mul(phi[Go[a[i]]], phi[Go[a[i]]]))) % mod;\n        G[T] = (G[T] - 2ll * tmp % mod + mod) % mod;\n    }\n}\nint main() {\n    n = read(), init(n);\n\trep(i, 1, n) Go[i] = read(), rev[Go[i]] = i;\n    rep(i, 1, n - 1) add(read(), read());\n    dfs1(1, 0), dfs2(1, 1), mem(head, 0), solve();\n    rep(i, 1, n) ans = (ans + mul(G[i], F[i])) % mod;\n    printf(\"%d\", mul((ans + mod) % mod, qpow(mul(n, n - 1), mod - 2)));\n\treturn 0;\n}\n```",
        "postTime": 1569858398,
        "uid": 57014,
        "name": "Nemlit",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 CF809E \u3010Surprise me!\u3011"
    },
    {
        "content": "\u8fd9\u9053\u9898\u76ee\u7684\u8bdd\uff0c\u63a8\u5f0f\u5b50\u6bd4\u8f83\u4f11\u95f2\uff0c\u5199\u8d77\u6765\u3002\u3002\u3002\n\n\u9996\u5148\u4e0a\u5957\u8def\uff0c\u6839\u636e$\\varphi$\u7684\u4e00\u4e9b\u6027\u8d28\uff0c\u6211\u4eec\u53ef\u4ee5\u8bc1\u660e$\\varphi(ij) = \\frac{\\varphi(i)\\varphi(j)\\gcd(i, j)}{\\varphi(gcd(i,j))}$\u3002\n\n\u5f00\u63a8\uff1a\u9996\u5148\u8bbe$\\textbf{f}(x) = \\frac x {\\varphi(x)}, \\textbf g = \\textbf f * \\mu, p_{a_i} = i$\uff0c\n\n\u90a3\u4e48\u6709\uff08\u6211\u7684\u8fd9\u79cd\u63a8\u6cd5\u662f~~\u5b66\u7684rqy\u7684~~\u6bd4\u8f83\u7b80\u5355\u7684\uff0c\u5efa\u8bae\u53c2\u9605\uff09\uff1a\n\n$$\\begin{aligned}&\\sum_{i=1}^n\\sum_{j=1}^n\\varphi(a_i*a_j)\\cdot \\mathrm{dist}(i,j) \\\\=& \\sum_{i=1}^n\\sum_{j=1}^n\\varphi(i)\\varphi(j)\\mathrm{dist}(p_i, p_j)\\textbf f(\\gcd(i,j)) \\\\=& \\sum_{i=1}^n\\sum_{j=1}^n\\varphi(i)\\varphi(j)\\mathrm{dist}(p_i, p_j)\\sum_{d\\mid i, d\\mid j} \\textbf g(d) \\\\=& \\sum_{d=1}^n\\textbf g(d)\\sum_{d\\mid i}\\sum_{d\\mid j}\\varphi(i)\\varphi(j)\\mathrm{dist}(p_{i},p_{j})\\end{aligned}$$\n\n$\\textbf g$\u53ef\u4ee5\u679a\u4e3e\u500d\u6570\u6c42\uff0c\u590d\u6742\u5ea6\u8c03\u548c\u7ea7\u6570\u3002\n\n\u7136\u540e\u540e\u9762\u90a3\u4e00\u5768\u53ef\u4ee5\u679a\u4e3e\u500d\u6570\uff0c\u5c06\u6240\u6709\u662f$d$\u7684\u500d\u6570\u7684\u70b9\u5168\u90e8\u62c9\u51fa\u6765\u5efa\u4e00\u68f5\u865a\u6811\uff0c\u505a\u4e00\u904d\u6811\u5f62$\\mathrm{dp}$\u5c31\u53ef\u4ee5\u4e86\u3002\n\n\u865a\u6811\u7684\u603b\u70b9\u6570\u5728$\\mathrm{O}(n\\log n)$\u7ea7\u522b\uff0c\u6240\u4ee5\u603b\u590d\u6742\u5ea6\u7ea6\u4e3a$\\mathrm{O}(n\\log^2n)$\n\n\u4ee3\u7801\u89c1\u6211\u7684[$\\texttt{blog}$](https://www.cnblogs.com/cj-xxz/p/10597132.html)",
        "postTime": 1553523461,
        "uid": 46800,
        "name": "xgzc",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 CF809E \u3010Surprise me!\u3011"
    },
    {
        "content": "[\u5b89\u5229$blog$](https://ctz45562.github.io/2019/08/05/%E6%B4%9B%E8%B0%B7-CF809E-Surprise-me/)\n\n[\u4f20\u9001\u95e8](https://www.luogu.org/problem/CF809E)\n\n\u8f6c\u6362\u4e00\u4e0b$a_i$\u7684\u5b9a\u4e49\uff1a\u6743\u503c\u4e3a$i$\u7684\u70b9\u7684\u7f16\u53f7\u3002\n\n\u8fd9\u6837\u6c42\u7684\u7b54\u6848\u5c31\u6210\u4e86$\\sum\\limits_{i=1}^n\\sum\\limits_{j=1}^n\\phi(i*j)dis(a_i,a_j)$\n\n\u53cd\u6f14\u8fd8\u662f\u5f88\u5957\u8def\u7684\uff1a\n\n$=\\sum\\limits_{i=1}^n\\sum\\limits_{j=1}^n\\dfrac{\\phi(i)\\phi(j)gcd(i,j)}{\\phi(gcd(i,j))}dis(a_i,a_j)$\n\n$=\\sum\\limits_{d=1}^n\\dfrac{d}{\\phi(d)}\\sum\\limits_{i=1}^n\\phi(i)\\sum\\limits_{j=1}^n\\phi(j)[gcd(i,j)=d]dis(a_i,a_j)$\n\n$=\\sum\\limits_{d=1}^n\\dfrac{d}{\\phi(d)}\\sum\\limits_{i=1}^{\\lfloor\\frac{n}{d}\\rfloor}\\phi(id)\\sum\\limits_{j=1}^{\\lfloor\\frac{n}{d}\\rfloor}\\phi(jd)dis(a_{id},a_{jd})\\sum\\limits_{a|gcd(i,j)}\\mu(a)$\n\n$=\\sum\\limits_{d=1}^n\\dfrac{d}{\\phi(d)}\\sum\\limits_{a=1}^{\\lfloor\\frac{n}{d}\\rfloor}\\mu(a)\\sum\\limits_{i=1}^{\\lfloor\\frac{n}{ad}\\rfloor}\\phi(iad)\\sum\\limits_{j=1}^{\\lfloor\\frac{n}{ad}\\rfloor}\\phi(jad)dis(a_{iad},a_{jad})$\n\n\u4ee4$T=ad$\uff0c\u679a\u4e3e$T$\uff1a\n\n$=\\sum\\limits_{d=1}^n\\dfrac{d}{\\phi(d)}\\sum\\limits_{T=1}^n[d|T]\\mu(\\dfrac{T}{d})\\sum\\limits_{i=1}^{\\lfloor\\frac{n}{T}\\rfloor}\\phi(iT)\\sum\\limits_{j=1}^{\\lfloor\\frac{n}{T}\\rfloor}\\phi(jT)dis(a_{iT},a_{jT})$\n\n$=\\sum\\limits_{T=1}^n\\sum\\limits_{i=1}^{\\lfloor\\frac{n}{T}\\rfloor}\\phi(iT)\\sum\\limits_{j=1}^{\\lfloor\\frac{n}{T}\\rfloor}\\phi(jT)dis(a_{iT},a_{jT})\\sum\\limits_{d|T}\\mu(\\dfrac{T}{d})\\dfrac{d}{\\phi(d)}$\n\n\u6700\u540e\u9762$\\sum\\limits_{d|T}$\u7684\u4e00\u5768\u662f\u4e2a\u5377\u79ef\u5f62\u5f0f\uff0c\u53ef\u4ee5\u7ebf\u7b5b\uff0c\u4e0d\u8fc7$O(n\\log n)$\u679a\u4e3e\u500d\u6570\u9884\u5904\u7406\u5c31\u591f\u4e86\u3002\n\n\u770b\u4e2d\u95f4\u90a3\u4e00\u5768\uff0c\u8003\u8651\u5b83\u7684\u542b\u4e49\uff0c\u5176\u5b9e\u5c31\u662f\u628a\u7f16\u53f7\u4e3a$a_{iT}$\u7684\u70b9\u62ff\u51fa\u6765\uff0c\u70b9\u6743\u4e3a$\\phi(iT)$\uff0c\u6c42\u5b83\u4eec\u4e24\u4e24\u4e4b\u95f4$value(i)*value(j)*dis(i,j)$\u4e4b\u548c\u3002\n\n\u800c\u8fd9\u4e2a\u5f0f\u5b50\u662f\u4e2a\u8c03\u548c\u7ea7\u6570\uff0c\u603b\u70b9\u6570\u662f$O(n\\log n)$\u7684\uff0c\u5927\u529b\u5bf9\u70b9\u96c6$\\{a_{iT}|i\\in \\mathbb{Z}\\}$\u4e0a\u865a\u6811\u3002\n\n\u8bb0$siz(i)$\u4e3a\u70b9$i$\u7684\u5b50\u6811\u6743\u503c\u548c\uff0c\u8003\u8651\u6bcf\u6761\u8fb9$edge(i,j)$\u7684\u8d21\u732e\uff0c\u4e3a$length(edge(i,j))*siz(j)*(siz(root)-siz(j))$\u3002\n\n\u4e8e\u662f\u5c31\u80fd$O(n\\log^2n)$\u89e3\u51b3\u8fa3\u3002\n\n\u4ee3\u7801\uff1a\n\n``` cpp\n#include <iostream>\n#include <cstdio>\n#include <algorithm>\n#include <cmath>\n#include <cstring>\n#include <vector>\n\n#define maxn 200005\n#define inf 0x3f3f3f3f\n\nconst int mod = 1e9 + 7;\n\nusing namespace std;\n\ninline int read(){\n\tint x=0,y=0;\n\tchar ch=getchar();\n\twhile(ch<'0'||ch>'9'){if(ch=='-')y=1;ch=getchar();}\n\twhile(ch>='0'&&ch<='9')x=(x<<1)+(x<<3)+(ch^48),ch=getchar();\n\treturn y?-x:x;\n}\nint deep[maxn],seg[maxn],a[maxn],all;\nvector<int>p;\nbool vis[maxn];\nnamespace origin{\n\tint top[maxn],fa[maxn],son[maxn],siz[maxn],h[maxn],num;\n\tstruct edge{\n\t\tint pre,to;\n\t}e[maxn<<1];\n\tinline void add(int from,int to){\n\t\te[++num].pre=h[from],h[from]=num,e[num].to=to;\n\t}\n\tvoid dfs1(int node=1){\n\t\tsiz[node]=1;\n\t\tint x;\n\t\tfor(register int i=h[node];i;i=e[i].pre){\n\t\t\tx=e[i].to;\n\t\t\tif(siz[x])continue;\n\t\t\tfa[x]=node,deep[x]=deep[node]+1,dfs1(x),siz[node]+=siz[x];\n\t\t\tif(siz[x]>siz[son[node]])son[node]=x;\n\t\t}\n\t}\n\tvoid dfs2(int node=1){\n\t\tseg[node]=++all;\n\t\tif(son[node]){\n\t\t\tint x=son[node];\n\t\t\ttop[x]=top[node],dfs2(x);\n\t\t\tfor(register int i=h[node];i;i=e[i].pre){\n\t\t\t\tx=e[i].to;\n\t\t\t\tif(!seg[x])top[x]=x,dfs2(x);\n\t\t\t}\n\t\t}\n\t}\n\tint lca(int x,int y){\n\t\twhile(top[x]!=top[y])deep[top[x]]<deep[top[y]]?y=fa[top[y]]:x=fa[top[x]];\n\t\treturn deep[x]<deep[y]?x:y;\n\t}\n}\nnamespace virt{\n\tint siz[maxn],h[maxn],num,ans;\n\tstruct edge{\n\t\tint pre,to,l;\n\t}e[maxn<<1];\n\tinline void add(int from,int to){\n\t\tint l=abs(deep[from]-deep[to]);\n\t\te[++num].pre=h[from],h[from]=num,e[num].to=to,e[num].l=l;\n\t\te[++num].pre=h[to],h[to]=num,e[num].to=from,e[num].l=l;\n\t}\n\tbool cmp(int x,int y){return seg[x]<seg[y];}\n\tstruct Monostack{\n\t\tint sta[maxn],top;\n\t\tvoid push(int x){sta[++top]=x;}\n\t\tvoid clear(){\n\t\t\tfor(register int i=2;i<=top;++i)add(sta[i],sta[i-1]);\n\t\t\ttop=0;\n\t\t}\n\t\tvoid check(int x){\n\t\t\tif(x==1)return;\n\t\t\tint l=origin::lca(x,sta[top]);\n\t\t\th[x]=0;\n\t\t\tif(l!=sta[top]){\n\t\t\t\twhile(seg[l]<seg[sta[top-1]])add(sta[top],sta[top-1]),--top;\n\t\t\t\t--top;\n\t\t\t\tif(l!=sta[top])h[l]=0,add(sta[top+1],l),push(l);\n\t\t\t\telse add(sta[top+1],l);\n\t\t\t}\n\t\t\tpush(x);\n\t\t}\n\t}s;\n\tvoid build(){\n\t\th[1]=0,s.push(1);\n\t\tfor(vector<int>::iterator iter=p.begin();iter!=p.end();++iter)s.check(*iter);\n\t\ts.clear();\n\t}\n\tvoid dfs(int node=1,int fa=0){\n\t\tif(!vis[node])siz[node]=0;\n\t\tint x;\n\t\tfor(register int i=h[node];i;i=e[i].pre){\n\t\t\tx=e[i].to;\n\t\t\tif(x!=fa)dfs(x,node),(siz[node]+=siz[x])%=mod;\n\t\t}\n\t}\n\tvoid calc(int node=1,int fa=0){\n\t\tint x;\n\t\tfor(register int i=h[node];i;i=e[i].pre){\n\t\t\tx=e[i].to;\n\t\t\tif(x!=fa)calc(x,node),(ans+=1ll*e[i].l*siz[x]%mod*(siz[1]-siz[x])%mod)%=mod;\n\t\t}\n\t}\n\tint solve(){\n\t\tsort(p.begin(),p.end(),cmp);\n\t\tnum=0,ans=0,build(),dfs(),calc();\n\t\tfor(vector<int>::iterator iter=p.begin();iter!=p.end();++iter)vis[*iter]=siz[*iter]=0;\n\t\treturn ans;\n\t}\n}\nnamespace mobius{\n\tint phi[maxn],mu[maxn],f[maxn],prime[maxn>>2],inv[maxn],cnt;\n\tbool is[maxn];\n\tvoid solve(int n){\n\t\tint ans=0;\n\t\tis[1]=phi[1]=mu[1]=inv[1]=1;\n\t\tfor(register int i=2;i<=n;++i){\n\t\t\tinv[i]=1ll*(mod-mod/i)*inv[mod%i]%mod;\n\t\t\tif(!is[i])prime[++cnt]=i,phi[i]=i-1,mu[i]=-1;\n\t\t\tfor(register int j=1;j<=cnt&&i*prime[j]<=n;++j){\n\t\t\t\tis[i*prime[j]]=1;\n\t\t\t\tif(i%prime[j]==0){\n\t\t\t\t\tmu[i*prime[j]]=0,phi[i*prime[j]]=phi[i]*prime[j];\n\t\t\t\t\tbreak;\t\n\t\t\t\t}\n\t\t\t\tphi[i*prime[j]]=phi[i]*(prime[j]-1),mu[i*prime[j]]=-mu[i];\n\t\t\t}\n\t\t}\n\t\tfor(register int i=1;i<=n;++i)\n\t\t\tfor(register int j=i;j<=n;j+=i)\n\t\t\t\t(f[j]+=1ll*mu[j/i]*i*inv[phi[i]]%mod)%=mod;\n\t\tfor(register int i=1;i<=n;++i){\n\t\t\tp.clear();\n\t\t\tfor(register int j=i;j<=n;j+=i)\n\t\t\t\tp.push_back(a[j]),vis[a[j]]=1,virt::siz[a[j]]=phi[j];\n\t\t\t(ans+=1ll*virt::solve()*f[i]%mod)%=mod;\n\t\t}\n\t\tans=1ll*(ans<<1)*inv[n]%mod*inv[n-1]%mod;\n\t\tprintf(\"%d\\n\",(ans+mod)%mod);\n\t}\n}\nint main(){\n\tusing namespace origin;\n\tint n=read(),x,y;\n\tfor(register int i=1;i<=n;++i)a[read()]=i;\n\tfor(register int i=1;i<n;++i)x=read(),y=read(),add(x,y),add(y,x);\n\tdfs1(),dfs2();\n\tmobius::solve(n);\n}\n\n```\n\n",
        "postTime": 1564994254,
        "uid": 111762,
        "name": "_ctz",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF809E \u3010Surprise me!\u3011"
    },
    {
        "content": "[\u9898\u76ee](https://www.luogu.org/problemnew/show/CF809E)\n\n\u8fd9\u662f\u4e00\u9053\u795e\u4ed9\u9898\n\n\u770b\u5230\u8fd9\u6837\u4e00\u4e2a\u9b3c\u755c\u7684\u67ff\u5b50\n\n$$\\sum_{i=1}^n\\sum_{j=1}^n\\varphi(a_i\\times a_j)\\times dis(i,j)$$\n\n\u53c8\u662f\u6811\u4e0a\u8ddd\u79bb\u53c8\u662f$\\varphi$\u7684\u770b\u8d77\u6765\u6839\u672c\u5c31\u4e0d\u77e5\u9053\u600e\u4e48\u641e\u554a\n\n\u9996\u5148\u9700\u8981\u77e5\u9053\u4e00\u4e2a\u8fd9\u6837\u7684\u6027\u8d28\n\n$$\\varphi(a\\times b)=\\frac{\\varphi(a)\\times \\varphi(b)\\times d}{\\varphi(d)},d=(a,b)$$\n\n\u8fd9\u4e2a\u6027\u8d28\u975e\u5e38\u663e\u7136\n\n\u8bbe$a=p^{k_1},b=p^{k_2},k_1<k_2$\n\n\u4e8e\u662f$d=p^{k_1}$\n\n$$\\varphi(a\\times b)=\\varphi(p^{k_1+k_2})=p^{k_1+k_2-1}(p-1)$$\n\n$$\\frac{\\varphi(a)\\times \\varphi(b)\\times d}{\\varphi(d)}=\\frac{p^{k_1-1}p^{k_2-1}(p-1)^2p^{k_1}}{p^{k_1-1}(p-1)}=p^{k_1+k_2-1}(p-1)$$\n\n\u8fd9\u4e2a\u4e1c\u897f\u663e\u7136\u662f\u79ef\u6027\u7684\uff0c\u6269\u5c55\u5230\u591a\u4e2a\u8d28\u56e0\u5b50\u4e5f\u662f\u6210\u7acb\u7684\n\n\u4e8e\u662f\u5199\u6210\n\n$$\\sum_{i=1}^n\\sum_{j=1}^n\\frac{\\varphi(a_i)\\times \\varphi(a_j)\\times (a_i,a_j)}{\\varphi((a_i,a_j))}\\times dis(i,j)$$\n\n\u5957\u8def\u679a\u4e3e$gcd$\n\n$$\\sum_{d=1}^n\\frac{d}{\\varphi(d)}\\sum_{i=1}^n\\sum_{j=1}^n[(a_i,a_j)=d]\\varphi(a_i)\\times \\varphi(a_j)\\times dis(i,j)$$\n\n\u8003\u8651\u8bbe\u540e\u9762\u90a3\u4e2a\u4e1c\u897f\u53eb\n\n$$f(d)=\\sum_{i=1}^n\\sum_{j=1}^n[(a_i,a_j)=d]\\varphi(a_i)\\times \\varphi(a_j)\\times dis(i,j)$$\n\n\u663e\u7136\u6211\u4eec\u8fd8\u9700\u8981\u4e00\u4e2a\u51fd\u6570\u53eb\n\n$$F(d)=\\sum_{i=1}^n\\sum_{j=1}^n[d|(a_i,a_j)]\\varphi(a_i)\\times \\varphi(a_j)\\times dis(i,j)$$\n\n\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u53cd\u6f14\u4e86\n\n$$F(d)=\\sum_{d|n}f(n)$$\n\n$$f(d)=\\sum_{d|n}\\mu(\\frac{n}{d})F(n)$$\n\n\u73b0\u5728\u7684\u95ee\u9898\u5c31\u662f\u6c42\u51fa$F$\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u505a\u4e86\n\n\u663e\u7136\u6811\u4e0a\u7684\u70b9\u90fd\u6709\u4e00\u4e2a\u7ea6\u6570$d$\u7684\u65f6\u5019\uff0c\u4efb\u610f\u4e24\u70b9\u7684\u7684$gcd$\u5c31\u4f1a\u662f$d$\u7684\u500d\u6570\n\n\u6211\u4eec\u5982\u679c\u628a$d|a_i$\u7684$i$\u62ff\u51fa\u6765\uff0c\u5efa\u51fa\u4e00\u68f5\u865a\u6811\uff0c\u641e\u4e00\u4e2a\u6811\u5f62$dp$\n\n\u6c42\u4e00\u4e0b\n\n$$dp_i=\\sum_{j=1}^ndis(i,j)\\varphi(a_j)$$\n\n\u5c31\u597d\u4e86\uff0c\u8fd9\u5c31\u662f\u4e00\u4e2a\u5c0f\u5b66\u751f$dp$\u6c42\u6811\u4e0a\u5e26\u6743\u91cd\u5fc3\u4e86\n\n\u4ee3\u7801\n\n```cpp\n#include<algorithm>\n#include<iostream>\n#include<cstring>\n#include<cstdio>\n#define re register\n#define LL long long\nconst int maxn=2e5+5;\nconst LL mod=1e9+7;\ninline int read() {\n\tchar c=getchar();int x=0;while(c<'0'||c>'9') c=getchar();\n\twhile(c>='0'&&c<='9') x=(x<<3)+(x<<1)+c-48,c=getchar();return x;\n}\nstruct E{int v,nxt,w;}e[maxn<<1];\nint dfn[maxn],son[maxn],deep[maxn],a[maxn],b[maxn],P[maxn];\nint Top[maxn],st[maxn],num,n,__,top,head[maxn],fa[maxn];\nint f[maxn],p[maxn>>1],mu[maxn],phi[maxn];\nLL dp[maxn],sum[maxn],S,inv[maxn],F[maxn];\ninline int cmp(int a,int b) {return dfn[a]<dfn[b];}\ninline LL ksm(LL a,int b) {\n\tLL S=1;\n\twhile(b) {if(b&1) S=S*a%mod;b>>=1;a=a*a%mod;}\n\treturn S;\n}\ninline void add(int x,int y,int w) {\n\te[++num].v=y;e[num].nxt=head[x];\n\thead[x]=num;e[num].w=w;\n}\nvoid dfs1(int x) {\n\tint maxx=-1;sum[x]=1;\n\tfor(re int i=head[x];i;i=e[i].nxt) {\n\t\tif(deep[e[i].v]) continue;\n\t\tdeep[e[i].v]=deep[x]+1,fa[e[i].v]=x; \n\t\tdfs1(e[i].v);sum[x]+=sum[e[i].v];\n\t\tif(sum[e[i].v]>maxx) maxx=sum[e[i].v],son[x]=e[i].v;\n\t}\n}\nvoid dfs2(int x,int topf) {\n\tTop[x]=topf;dfn[x]=++__;\n\tif(!son[x]) return;\n\tdfs2(son[x],topf);\n\tfor(re int i=head[x];i;i=e[i].nxt)\n\tif(!Top[e[i].v]) dfs2(e[i].v,e[i].v);\n}\ninline int LCA(int x,int y) {\n\twhile(Top[x]!=Top[y]) {\n\t\tif(deep[Top[x]]<deep[Top[y]]) std::swap(x,y);\n\t\tx=fa[Top[x]];\n\t}\n\tif(deep[x]<deep[y]) return x;return y;\n}\ninline void ins(int x) {\n\tif(top<=1) {st[++top]=x;return;}\n\tint lca=LCA(st[top],x);\n\tif(lca==st[top]) {st[++top]=x;return;}\n\twhile(top>1&&dfn[st[top-1]]>=dfn[lca])\n\t\tadd(st[top-1],st[top],deep[st[top]]-deep[st[top-1]]),top--;\n\tif(lca!=st[top]) {add(lca,st[top],deep[st[top]]-deep[lca]);st[top]=lca;}\n\tst[++top]=x;\n}\nvoid dfs(int x) {\n\tsum[x]=f[x]*phi[a[x]];\n\tfor(re int i=head[x];i;i=e[i].nxt) {\n\t\tdfs(e[i].v);\n\t\tsum[x]+=sum[e[i].v];\n\t\tdp[x]+=(dp[e[i].v]+sum[e[i].v]*(LL)e[i].w%mod)%mod;\n\t\tdp[x]%=mod;\n\t}\n}\nvoid reDfs(int x) {\n\tfor(re int i=head[x];i;i=e[i].nxt) {\n\t\tLL now=dp[x]-(dp[e[i].v]+sum[e[i].v]*(LL)e[i].w%mod)%mod;\n\t\tnow=(now+mod)%mod;\n\t\tdp[e[i].v]=(dp[e[i].v]+now+((S-sum[e[i].v])*(LL)e[i].w)%mod)%mod;\n\t\treDfs(e[i].v);\n\t}\n}\nvoid clear(int x) {\n\tf[x]=dp[x]=sum[x]=0;\n\tfor(re int i=head[x];i;i=e[i].nxt) clear(e[i].v);\n\thead[x]=0;\n}\nint main() {\n\tn=read();\n\tfor(re int i=1;i<=n;i++) a[i]=read();\n\tfor(re int x,y,i=1;i<n;i++)\n\t\tx=read(),y=read(),add(x,y,0),add(y,x,0);\n\tdeep[1]=1,dfs1(1),dfs2(1,1);\n\tfor(re int i=1;i<=n;i++) b[a[i]]=i;\n\tf[1]=mu[1]=phi[1]=1;\n\tfor(re int i=2;i<=n;i++) {\n\t\tif(!f[i]) p[++p[0]]=i,mu[i]=-1,phi[i]=i-1;\n\t\tfor(re int j=1;j<=p[0]&&p[j]*i<=n;j++) {\n\t\t\tf[p[j]*i]=1;\n\t\t\tif(i%p[j]==0) {\n\t\t\t\tphi[p[j]*i]=p[j]*phi[i];\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tmu[p[j]*i]=-1*mu[i];\n\t\t\tphi[p[j]*i]=(p[j]-1)*phi[i];\n\t\t}\n\t}\n\tinv[1]=1;\n\tfor(re int i=2;i<=n;i++) inv[i]=(mod-mod/i)*inv[mod%i]%mod;\n\tmemset(head,0,sizeof(head));\n\tmemset(f,0,sizeof(f));\n\tmemset(sum,0,sizeof(sum));\n\tfor(re int k=1;k<=n;k++) {\n\t\tint tot=0;\n\t\tnum=0,top=0;\n\t\tfor(re int j=k;j<=n;j+=k)\n\t\t\tP[++tot]=b[j],f[P[tot]]=1;\n\t\tstd::sort(P+1,P+tot+1,cmp);\n\t\tint rt=P[1];\n\t\tfor(re int i=2;i<=tot;i++) rt=LCA(rt,P[i]);\n\t\tif(!f[rt]) st[++top]=rt;\n\t\tfor(re int i=1;i<=tot;i++) ins(P[i]);\n\t\twhile(top) add(st[top-1],st[top],deep[st[top]]-deep[st[top-1]]),top--;\n\t\tdfs(rt);S=sum[rt];reDfs(rt);\n\t\tfor(re int i=1;i<=tot;i++)\n\t\t\tF[k]=(F[k]+(LL)phi[a[P[i]]]*dp[P[i]]%mod)%mod;\n\t\tclear(rt);\n\t}\n\tLL ans=0;\n\tfor(re int i=1;i<=n;i++) {\n\t\tLL now=0;\n\t\tfor(re int j=i;j<=n;j+=i) \n\t\t\tnow=(now+F[j]*mu[j/i]%mod)%mod,now=(now+mod)%mod;\n\t\tans=(ans+now*(LL)i%mod*inv[phi[i]]%mod)%mod;\n\t}\n\tLL now=(LL)n*(LL)(n-1);\n\tnow%=mod;\n\tprintf(\"%lld\\n\",ksm(now,mod-2)*ans%mod);\n\treturn 0;\n}\n```\n",
        "postTime": 1553517838,
        "uid": 35178,
        "name": "asuldb",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF809E \u3010Surprise me!\u3011"
    },
    {
        "content": "\u9898\u89e3\uff1a\n\n$$ Ans = \\frac{1}{n(n-1)}\\sum_{i=1}^n\\sum_{j=1}^n\\varphi(a_ia_j)dist(i,j) $$\n\n\u6839\u636e$\\varphi$\u7684\u901a\u9879\u548c\u8003\u8651\u91cd\u590d\u8d28\u56e0\u5b50\u8d21\u732e\u5f97\u5230 $$ \\varphi(ij) = \\frac{\\varphi(i)\\varphi(j)\\gcd(i,j)}{\\varphi(\\gcd(i,j))}$$\n\n$$\\sum_{i=1}^n\\sum_{j=1}^n\\varphi(a_ia_j)dist(i,j)=\\sum_{i=1}^n\\sum_{j=1}^n\\frac{\\varphi(a_i)\\varphi(a_j)\\gcd(a_i,a_j)}{\\varphi(\\gcd(a_i,a_j))}dist(i,j) $$\n\n\u679a\u4e3e $\\gcd$\n\n$$ \\sum_{d=1}^n\\frac{d}{\\varphi(d)}\\sum_{i=1}^n\\sum_{j=1}^n[\\gcd(a_i,a_j)=d]\\varphi(a_i)\\varphi(a_j)dist(i,j)$$\n\n\u83ab\u6bd4\u4e4c\u65af\u53cd\u6f14\n\n$$\\sum_{d=1}^n\\frac{d}{\\varphi(d)}\\sum_{k=1}^n\\mu(k)\\sum_{kd|a_i}\\sum_{kd|a_j}\\varphi(a_i)\\varphi(a_j)dist(i,j)$$\n\n\u679a\u4e3e $kd$\n\n$$\\sum_{T=1}^n\\sum_{d|T}\\frac{d\\mu(\\frac{T}{d})}{\\varphi(d)}\\sum_{T|a_i}\\sum_{T|a_j}\\varphi(a_i)\\varphi(a_j)dist(i,j)$$\n\n\u7136\u540e\u540e\u9762\u7684\u4e1c\u897f\u53ef\u4ee5\u901a\u8fc7\u62c9\u51fa\u6743\u503c\u4e3aT\u7684\u500d\u6570\u7684\u70b9\u505a\u6811\u5f62dp\u6c42\uff0c\u9700\u8981\u5efa\u865a\u6811\n\n\u53d1\u73b0\u603b\u70b9\u6570\u662f $O(n\\log n)$ \u4e2a, \u4e8e\u662f\u65f6\u95f4\u590d\u6742\u5ea6\u662f $O(n\\log^2n)$\n\n\u4ee3\u7801\uff1a\n```cpp\n#include <cstdio>\n#include <algorithm>\n#define N 200005\nconst int mod = 1000000007;\nusing LL = long long;\nnamespace tree {\n\t\nstruct edge { int to, nxt; } e[N << 1];\nint head[N], tot, n, a[N], f[18][N], dep[N], idx, dfn[N];\nvoid addedge(int x, int y) {\n\te[++tot] = (edge) { y, head[x] }; head[x] = tot;\n\te[++tot] = (edge) { x, head[y] }; head[y] = tot;\n}\nvoid dfs0(int x) {\n\tdfn[x] = ++idx;\n\tfor (int i = 1; i < 18; i++) f[i][x] = f[i - 1][f[i - 1][x]];\n\tfor (int i = head[x]; i; i = e[i].nxt) if (e[i].to != f[0][x]) \n\t\tf[0][e[i].to] = x, dep[e[i].to] = dep[x] + 1, dfs0(e[i].to);\n}\nint lca(int x, int y) {\n\tif (dep[x] < dep[y]) std::swap(x, y);\n\tfor (int i = dep[x] - dep[y]; i; i &= i - 1) x = f[__builtin_ctz(i)][x];\n\tfor (int i = 17; i + 1; i--) if (f[i][x] != f[i][y]) x = f[i][x], y = f[i][y];\n\treturn x == y ? x : f[0][x];\n}\n\n}\nvoid up(int &x, int y) { if ((x += y) >= mod) x -= mod; }\n\nnamespace number {\n\tint phi[N], miu[N], pr[N], pt, F[N], inv[N], sie[N];\n\tint pow(int x, int y) {\n\t\tint ans = 1;\n\t\tfor (; y; y >>= 1, x = static_cast<LL> (x) * x % mod)\n\t\t\tif (y & 1) ans = static_cast<LL> (ans) * x % mod;\n\t\treturn ans;\n\t}\n\tvoid sieve(int R) {\n\t\tphi[1] = miu[1] = 1;\n\t\tfor (int i = 2; i <= R; i++) {\n\t\t\tif (!sie[i]) phi[i] = i - 1, miu[i] = mod - 1, pr[++pt] = i;\n\t\t\tfor (int j = 1, t; j <= pt && (t = i * pr[j]) <= R; j++) {\n\t\t\t\tsie[t] = 1; \n\t\t\t\tif (i % pr[j] == 0) { phi[t] = phi[i] * pr[j], miu[t] = 0; break; }\n\t\t\t\tphi[t] = phi[i] * (pr[j] - 1), up(miu[t] = 0, mod - miu[i]);\n\t\t\t}\n\t\t}\n\t\tinv[1] = 1; for (int i = 2; i <= R; i++) inv[i] = static_cast<LL> (inv[mod % i]) * (mod - mod / i) % mod;\n\t\tfor (int i = 1; i <= R; i++)\n\t\t\tfor (int j = i, t = 1; j <= R; j += i, t++)\n\t\t\t\tup(F[j], static_cast<LL> (i) * inv[phi[i]] % mod * miu[t] % mod);\n\t}\n}\nnamespace vtree {\n\tint head[N], tot, size[N], val[N], sum = 0, ans = 0;\n\tstruct edge { int to, nxt, len; } e[N << 1];\n\tvoid addedge(int x, int y, int z) {\n\t\te[++tot] = (edge) { y, head[x], z }; head[x] = tot;\n\t\te[++tot] = (edge) { x, head[y], z }; head[y] = tot;\n\t}\n\tvoid addedge(int x, int y) {\n\t\taddedge(x, y, std::abs(tree::dep[x] - tree::dep[y]));\n\t}\n\tint dfs0(int x, int f) {\n\t\tsize[x] = 0;\n\t\tfor (int i = head[x]; i; i = e[i].nxt)\n\t\t\tif (e[i].to != f) up(size[x], dfs0(e[i].to, x)), up(ans, static_cast<LL> (size[e[i].to]) * (sum - size[e[i].to] + mod) % mod * e[i].len * 2 % mod);\n\t\tup(size[x], val[x]); val[x] = 0; head[x] = 0;\n\t\treturn size[x];\n\t}\n}\nint query[N], ans, stack[N], top, n, a[N], map[N], x, y;\nint main() {\n\tstd::scanf(\"%d\", &n);\n\tfor (int i = 1; i <= n; i++) std::scanf(\"%d\", &a[i]), map[a[i]] = i;\n\tfor (int i = 1; i < n; i++) std::scanf(\"%d%d\", &x, &y), tree::addedge(x, y);\n\tnumber::sieve(n), tree::dfs0(1);\n\tfor (int i = 1; i <= n; i++) {\n\t\tint tot = 0; vtree::sum = vtree::ans = vtree::tot = 0;\n\t\tfor (int j = i; j <= n; j += i) query[++tot] = map[j], up(vtree::sum, number::phi[j]), vtree::val[map[j]] = number::phi[j];\n\t\tstd::sort(query + 1, query + tot + 1, [] (int i, int j) { return tree::dfn[i] < tree::dfn[j]; });\n\t\tint rt = query[1];\n\t\tfor (int j = 2; j <= tot; j++) rt = tree::lca(rt, query[j]);\n\t\tstack[top = 1] = rt;\n\t\tfor (int j = 1; j <= tot; j++) {\n\t\t\tint lca = tree::lca(query[j], stack[top]);\n\t\t\twhile (tree::dep[lca] < tree::dep[stack[top - 1]]) vtree::addedge(stack[top], stack[top - 1]), --top;\n\t\t\tif (lca != stack[top]) vtree::addedge(lca, stack[top--]);\n\t\t\tif (stack[top] != lca) stack[++top] = lca;\n\t\t\tif (stack[top] != query[j]) stack[++top] = query[j];\n\t\t}\n\t\twhile (--top) vtree::addedge(stack[top + 1], stack[top]);\n\t\tvtree::dfs0(rt, 0);\n\t\tup(ans, static_cast<LL> (number::F[i]) * vtree::ans % mod);\n\t}\n\tstd::printf(\"%d\\n\", static_cast<LL> (ans) * number::pow(static_cast<LL> (n) * (n - 1) % mod, mod - 2) % mod);\n\t\n\treturn 0;\n}\n```\n\n",
        "postTime": 1539174492,
        "uid": 26127,
        "name": "Weng_Weijie",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 CF809E \u3010Surprise me!\u3011"
    },
    {
        "content": "\u8fd9\u662f\u9053\u83ab\u6bd4\u4e4c\u65af\u53cd\u6f14+\u865a\u6811\u7684\u597d\u9898\u554a\u3002\n\n\u9996\u5148\u6211\u4eec\u77e5\u9053\n$$\n\\phi(i\\times j)=\\frac{\\phi(i)\\times \\phi(j)\\times gcd(i,j)}{\\phi(gcd(i,j))}\n$$\n\u4e00\u822c$\\phi$\u91cc\u51fa\u73b0\u4e58\u79ef\u7684\u9898\u90fd\u8981\u8fd9\u4e48\u5316\uff0c\u4e4b\u540e\u5c31\u53d8\u6210\u4e86\u4e00\u4e2a\u6570\u5b66\u9898\u3002\n\n\u4e0d\u7ba1$\\frac{1}{n(n-1)}$\uff0c\u539f\u5f0f\u5c31\u53d8\u6210\u4e86\uff1a\n\n$\n\\sum_{i=1}^n\\sum_{j=1}^n\\frac{\\varphi(a_i)\\times \\phi(a_j)\\times gcd(a_i,a_j)}{\\phi(gcd(a_i,a_j))}\\times dist(i,j)\n$\n\n\n$a_i$\u5728$\\phi$\u91cc\u9762\u8ba9\u4eba\u6ca1\u6cd5\u63a8\u4e0b\u53bb\uff0c\u6240\u4ee5\u4ee4$b_{a_i}=i$\uff0c\u5c31\u4f1a\u5f97\u5230\u4e00\u4e2a\u7b49\u4ef7\u7684\u5f0f\u5b50\uff0c\u76f8\u5f53\u4e8e\u5728\u679a\u4e3e$a_i$\n\n$\n\\sum_{i=1}^n\\sum_{j=1}^n\\frac{\\varphi(i)\\times \\phi(j)\\times gcd(i,j)}{\\phi(gcd(i,j))}\\times dist(b_i,b_j)\n$\n\n\u4f3c\u4e4e\u53ef\u4ee5\u53cd\u6f14\u7684\u6837\u5b50\uff0c\u5148\u7ee7\u7eed\u679a\u4e3egcd\uff1a\n\n$\n\\sum_{d=1}^n\\frac{d}{\\phi(d)}\\sum_{i=1}^n\\sum_{j=1}^n[(i,j)=d]\\phi(i)\\phi(j)\\times dist(b_i,b_j)\n$\n\n\u4e0b\u9762\u662f\u5957\u8def\uff0c\u867d\u7136\u6211\u5fc5\u987b\u8981\u5199\uff0c\u4f46\u5927\u5bb6\u53ef\u4ee5\u8df3\u8fc7\u5230\u4e0b\u9762\u7684\u7ed3\u8bba\n\n$\n\\sum_{d=1}^n\\frac{d}{\\phi(d)}\\sum_{i=1}^{n/d}\\sum_{j=1}^{n/d}[(i,j)=1]\\phi(id)\\phi(jd)\\times dist(b_{id},b_{jd})\n$\n\n$\n=\\sum_{d=1}^n\\frac{d}{\\phi(d)}\\sum_{i=1}^{n/d}\\sum_{j=1}^{n/d}\\phi(id)\\phi(jd)\\times dist(b_{id},b_{jd})\\sum_{k|(i,j)}\\mu(k)\n$\n\n$\n=\\sum_{d=1}^n\\frac{d}{\\phi(d)}\\sum_{k=1}^{n/d}\\mu(k)\\sum_{i=1}^{n/dk}\\sum_{j=1}^{n/dk}\\phi(idk)\\phi(jdk)\\times dist(b_{idk},b_{jdk})\n$\n\n\u4ee4$T=dk$\n$\n=\\sum_{T=1}^n\\sum_{d|T}\\frac{d}{\\phi(d)}\\mu(\\frac{T}{d})\\sum_{i=1}^{n/T}\\sum_{j=1}^{n/T}\\phi(iT)\\phi(jT)\\times dist(b_{iT},b_{jT})\n$\n\n\u8df3\u8fc7\u90e8\u5206\u5c31\u5230\u8fd9\u91cc\u4e86\u3002\n\n\u9996\u5148\u4ee4$f(T)=\\sum_{d|T}\\frac{d}{\\phi(d)}\\mu(\\frac{T}{d})$\uff0c\u8fd9\u4e2a\u51fd\u6570\u662f\u53ef\u4ee5\u7ebf\u7b5b\u6216\u8005\uff0c\u679a\u4e3ed\u53bb\u57c3\u7b5b\u7684\uff0c\u6211\u7528\u7684\u662f\u7ebf\u7b5b\uff1a\n\n\u5f53T\u662f\u8d28\u6570\u65f6\uff0c$f(T)=\\frac{1}{T-1}$\uff0c\u5f53T\u662f\u8d28\u6570\u7684m\u6b21\u5e42(m>1)\u65f6\uff0c$f(T)=0$\n\n\u8fd9\u4e2a\u53ef\u4ee5\u81ea\u5df1\u7b97\u4e00\u4e0b\uff0c\u7531\u4e8e\u91cc\u9762\u6709\u4e2a$\\mu$\u6240\u4ee5\u53ea\u7528\u679a\u4e3ed=1\u6216d=\u8d28\u6570\u7684\u4e00\u6b21\u5e42 \u5c31\u884c\u4e86\u3002\n\n\u770b\u540e\u9762\u8fd9\u4e2a\u5f0f\u5b50\uff0c\u5b83\u5176\u5b9e\u5c31\u662f\uff1a\n\n$\n\\sum_{i=1}[i|T]\\sum_{j=1}[j|T]\\phi(i)\\phi(j)\\times dist(b_i,b_j)\n$\n\n\n\u6211\u4eec\u4e4b\u524d\u4e3a\u4e86\u65b9\u4fbf\u53bb\u6389\u4e86$a_i$\uff0c\u52a0\u56de\u6765\u7684\u8bdd\u5c31\u662f\uff1a\n\n$\n\\sum_{i=1}[a_i|T]\\sum_{j=1}[a_j|T]\\phi(a_i)\\phi(a_j)\\times dist(i,j)\n$\n\n\u8fd9\u4e2a\u4e1c\u897f\u7684\u6c42\u6cd5\u662f\u5bf9$a_i|T$\u7684\u70b9\u5efa\u4e00\u68f5\u865a\u6811\uff0c\u4e00\u5171\u5efan\u68f5\u865a\u6811\uff0c\u4e4b\u540e\u53bbdp\u6216\u8005\u679a\u4e3e\u6bcf\u4e00\u6761\u8fb9\u8ba1\u7b97\u8d21\u732e\uff0c\u7531\u4e8e$a_i$\u662f\u4e00\u4e2a\u6392\u5217\uff0c\u6240\u4ee5n\u68f5\u865a\u6811\u7684\u603b\u70b9\u6570\u662f\u8c03\u548c\u7ea7\u6570$nlogn$\u7684\u3002\n\n```c++\n#include<cstdio>\n#include<cstring>\n#include<iostream>\n#include<algorithm>\n#define mod 1000000007\nusing namespace std;\nstruct node{\n\tint next,to,z;\n}w[400001];\nint head[200001],stack[200001],size[200001];\nint prime[100001],o[200001],phi[200001],num;\nint deep[200001],st[400001][18],logg[400001];\nint n,sum,ans,a[200001],b[200001],d[200001],m;\nint f[200001],low[200001],cnt,top,idx[200001];\ninline int add(int x,int y){return x+y>=mod?x+y-mod:x+y;}\ninline int dec(int x,int y){return x-y<0?x-y+mod:x-y;}\ninline int mul(int x,int y){return 1ll*x*y-1ll*x*y/mod*mod;}\ninline void link(int x,int y){\n\tw[++cnt].next=head[x];\n\tw[cnt].to=y; head[x]=cnt;\n\tw[cnt].z=deep[y]-deep[x];\n}\ninline int ksm(int x,int y){\n\tint num=1;\n\twhile (y){\n\t\tif (y&1) num=mul(x,num);\n\t\tx=mul(x,x); y>>=1;\n\t}\n\treturn num;\n}\ninline int cmp(int x,int y){\n\tif (deep[x]<deep[y]) return x; return y;\n}\ninline bool cmp2(int x,int y){return idx[x]<idx[y];}\ninline void euler(){\n\tphi[1]=o[1]=f[1]=1;\n\tfor (int i=2; i<=n; i++){\n\t\tif (!o[i]){\n\t\t\tprime[++prime[0]]=i;\n\t\t\tphi[i]=i-1; low[i]=i;\n\t\t\tf[i]=ksm(i-1,mod-2);\n\t\t}\n\t\tfor (int j=1; j<=prime[0]&&i*prime[j]<=n; j++){\n\t\t\to[i*prime[j]]=1;\n\t\t\tif (i%prime[j]==0){\n\t\t\t\tlow[i*prime[j]]=low[i]*prime[j];\n\t\t\t\tif (low[i]!=i) f[i*prime[j]]=mul(f[i/low[i]],f[low[i]*prime[j]]);\n\t\t\t\tphi[i*prime[j]]=prime[j]*phi[i];\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tphi[i*prime[j]]=phi[i]*phi[prime[j]];\n\t\t\tf[i*prime[j]]=mul(f[i],f[prime[j]]);\n\t\t\tlow[i*prime[j]]=prime[j];\n\t\t}\n\t}\n//\tmemset(f,0,sizeof(f));\n//\tfor (int d=1; d<=n; d++)\n//\t\tfor (int t=d; t<=n; t+=d)\n//\t\t\tf[t]=add(f[t],mul(mul(d,so[phi[d]]),mu[t/d]));\n}\nvoid dfs(int x,int fa){\n\tst[++num][0]=x; idx[x]=num;\n\tfor (int i=head[x]; i; i=w[i].next){\n\t\tif (w[i].to!=fa){\n\t\t\tdeep[w[i].to]=deep[x]+1;\n\t\t\tdfs(w[i].to,x);\n\t\t\tst[++num][0]=x;\n\t\t}\n\t}\n}\ninline int lca(int x,int y){\n\tx=idx[x],y=idx[y];\n\tif (x>y) swap(x,y);\n\tint k=logg[y-x+1];\n\treturn cmp(st[x][k],st[y-(1<<k)+1][k]);\n}\ninline void ins(int x){\n\tif (x==1) return;\n\tif (!top){\n\t\tstack[++top]=x;\n\t\treturn;\n\t}\n\tint l=lca(stack[top],x);\n\twhile (top&&deep[stack[top-1]]>deep[l])\n\t\tlink(stack[top-1],stack[top]),top--;\n\tif (deep[stack[top]]>deep[l]) link(l,stack[top]),top--;\n\tif (stack[top]!=l) stack[++top]=l;\n\tstack[++top]=x;\n}\nvoid get_pre(int x){\n\tsize[x]=phi[a[x]]*o[x];\n\tfor (int i=head[x]; i; i=w[i].next){\n\t\tget_pre(w[i].to);\n\t\tsize[x]=add(size[x],size[w[i].to]);\n\t}\n\thead[x]=0;\n}\nvoid debug(){\n\tfor (int x=1; x<=n; x++)\n\t\tfor (int i=head[x]; i; i=w[i].next)\n\t\t\tprintf(\"%d %d %d\\n\",x,w[i].to,w[i].z);\n}\nint main(){\n\tint x,y;\n\tscanf(\"%d\",&n);\n\tfor (int i=1; i<=n; i++)\n\t\tscanf(\"%d\",&a[i]),b[a[i]]=i;\n\tfor (int i=1; i<n; i++){\n\t\tscanf(\"%d%d\",&x,&y);\n\t\tlink(x,y); link(y,x);\n\t}\n\teuler(); dfs(1,0);\n\tfor (int i=2; i<=num; i++) logg[i]=logg[i>>1]+1;\n\tfor (int j=1; j<=logg[num]; j++)\n\t\tfor (int i=1; i+(1<<(j-1))-1<=num; i++)\n\t\t\tst[i][j]=cmp(st[i][j-1],st[i+(1<<(j-1))][j-1]);\n\tstack[0]=1;\n\tmemset(head,0,sizeof(head));\n\tmemset(o,0,sizeof(o));\n\tfor (int t=1; t<=n; t++){\n\t\tif (!f[t]) continue;\n\t\tm=cnt=sum=0;\n\t\tfor (int i=t; i<=n; i+=t) d[++m]=b[i],o[b[i]]=1;\n\t\tsort(d+1,d+m+1,cmp2);\n\t\tfor (int i=1; i<=m; i++) ins(d[i]);\n\t\twhile (top) link(stack[top-1],stack[top]),top--;\n//\t\tprintf(\"%d\\n\",t); debug();\n\t\tget_pre(1);\n//\t\tif (a[1]%t) size[1]=dec(size[1],phi[a[1]]);\n\t\tfor (int i=1; i<=cnt; i++){\n\t\t\ty=w[i].to;\n\t\t\tsum=add(sum,mul(mul(w[i].z,dec(size[1],size[y])),size[y]));\n\t\t}\n\t\tsum=add(sum,sum);\n\t\tans=add(ans,mul(f[t],sum));\n//\t\tprintf(\"%d\\n\",sum);\n\t\tfor (int i=1; i<=m; i++) o[d[i]]=0;\n\t}\n\tprintf(\"%d\\n\",mul(mul(ans,ksm(n,mod-2)),ksm(n-1,mod-2)));\n\treturn 0;\n}\n```\n\n",
        "postTime": 1564992961,
        "uid": 63661,
        "name": "Taduro",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF809E \u3010Surprise me!\u3011"
    },
    {
        "content": "[$$\\large \\color{purple} My\\;Blog$$](https://www.cnblogs.com/p-b-p-b/p/10644803.html)\n\n---------------------------\n\n\u975e\u5e38\u5957\u8def\u7684\u4e00\u9053\u9898\uff0c\u5f88\u9002\u5408\u6211\u5728\u9677\u5165\u4f4e\u8c37\u65f6\u63d0\u5347\u4fe1\u5fc3\u2026\u2026\n\n------------------------\n\n## \u601d\u8def\n\n\u663e\u7136\u6211\u4eec\u9700\u8981\u5927\u529b\u63a8\u5f0f\u5b50\u3002\n\n\u8bbe$p_{a_i}=i$\uff0c\u5219\u6709\n\n$$n(n-1)ans=\\sum_i \\sum_j \\varphi(ij)dis(p_i,p_j)$$\n$$=\\sum_i \\sum_j \\frac{\\varphi(i)\\varphi(j)\\gcd(i,j)}{\\varphi(\\gcd(i,j))} dis(i,j)$$\n$$=\\sum_d \\frac{d}{\\varphi(d)} \\sum_i\\sum_j [\\gcd(i,j)=d]\\varphi(i)\\varphi(j)dis(i,j)$$\n$$=\\sum_d \\frac{d}{\\varphi(d)} \\sum_{k=1}^{n/d} \\mu(k) \\sum_{i=1}^{n/dk} \\sum_{j=1}^{n/dk} \\varphi(idk)\\varphi(jdk)dis(p_{idk},p_{jdk})$$\n$$=\\sum_{T=1}^n (\\sum_{d|T} \\frac{d\\mu(T/d)}{\\varphi(d)})\\sum_{i=1}^{n/T} \\sum_{j=1}^{n/T} \\varphi(iT)\\varphi(jT)dis(p_{iT},p_{jT})$$\n\u73b0\u5728\u601d\u8def\u5df2\u7ecf\u975e\u5e38\u6e05\u6670\u4e86\u3002\n\n$f(T)=\\sum_{d|T}\\frac{d\\mu(T/d)}{\\varphi(d)}$\uff1a\u8fd9\u663e\u7136\u53ef\u4ee5\u8c03\u548c\u7ea7\u6570$O(n\\log n)$\u5f97\u5230\u3002\n\n\u73b0\u5728\u5c31\u662f\u8981\u6c42\n\n$$X=\\sum_{i\\in S} \\sum_{j\\in S} \\varphi(i)\\varphi(j)dis(p_i,p_j)$$\n\n\u663e\u7136\u901a\u8fc7\u8c03\u548c\u7ea7\u6570\u6211\u4eec\u53d1\u73b0$\\sum|S|$\u662f$O(n\\log n)$\u7ea7\u522b\u7684\u3002\n\n\u8003\u8651\u628a$dis(p_i,p_j)$\u62c6\u5f00\uff0c\u6211\u4eec\u5f97\u5230\n\n$$X=\\sum_{i\\in S}\\sum_{j\\in S} \\varphi(i)\\varphi(j)(dep_{p_i}+dep_{p_j}-2dep_{lca(p_i,p_j)})$$\n$$=M-2\\sum_{i\\in S}\\varphi(i)\\sum_{j\\in S} \\varphi(j)dep_{lca(p_i,p_j)}$$\n\u5176\u4e2d$M$\u53ef\u4ee5\u5f88\u5bb9\u6613\u6c42\u51fa\uff0c\u53ea\u9700\u8981\u6c42\u51fa\u540e\u9762\u3002\n\n\u540e\u9762\u5176\u5b9e\u662f\u4e2a\u7ecf\u5178\u5957\u8def\uff0c\u53ef\u4ee5\u7528\u5927\u4f17\u5316\u7684DP\u6216\u662f\u7528\u201c [HNOI2015]\u5f00\u5e97\u201d\u76f8\u540c\u7684\u65b9\u6cd5\uff08\u94fe\u4e0a\u52a0\uff0c\u6c42\u5230\u6839\u7684\u8ddd\u79bb\uff09\u505a\u3002\n\n\u7531\u4e8e\u6211\u662f\u4e2aSB\uff0c\u6211\u9009\u4e86\u540e\u8005\uff0c\u5199\u4e86\u4e2a\u6811\u4e0a\u5dee\u5206\u3002\n\n\u7136\u540e\u5404\u79cdSB\u9519\u8bef\u8c03\u4e861\u4e2a\u5c0f\u65f6\u2026\u2026\n\n-----------------------------------\n\n## \u4ee3\u7801\n\n```cpp\n#include<bits/stdc++.h>\nclock_t t=clock();\nnamespace my_std{\n\tusing namespace std;\n\t#define pii pair<int,int>\n\t#define fir first\n\t#define sec second\n\t#define MP make_pair\n\t#define rep(i,x,y) for (int i=(x);i<=(y);i++)\n\t#define drep(i,x,y) for (int i=(x);i>=(y);i--)\n\t#define go(x) for (int i=head[x];i;i=edge[i].nxt)\n\t#define templ template<typename T>\n\t#define sz 202020\n\t#define mod 1000000007ll\n\ttypedef long long ll;\n\ttypedef double db;\n\tmt19937 rng(chrono::steady_clock::now().time_since_epoch().count());\n\ttempl inline T rnd(T l,T r) {return uniform_int_distribution<T>(l,r)(rng);}\n\ttempl inline bool chkmax(T &x,T y){return x<y?x=y,1:0;}\n\ttempl inline bool chkmin(T &x,T y){return x>y?x=y,1:0;}\n\ttempl inline void read(T& t)\n\t{\n\t\tt=0;char f=0,ch=getchar();double d=0.1;\n\t\twhile(ch>'9'||ch<'0') f|=(ch=='-'),ch=getchar();\n\t\twhile(ch<='9'&&ch>='0') t=t*10+ch-48,ch=getchar();\n\t\tif(ch=='.'){ch=getchar();while(ch<='9'&&ch>='0') t+=d*(ch^48),d*=0.1,ch=getchar();}\n\t\tt=(f?-t:t);\n\t}\n\ttemplate<typename T,typename... Args>inline void read(T& t,Args&... args){read(t); read(args...);}\n\tchar __sr[1<<21],__z[20];int __C=-1,__zz=0;\n\tinline void Ot(){fwrite(__sr,1,__C+1,stdout),__C=-1;}\n\tinline void print(register int x)\n\t{\n\t\tif(__C>1<<20)Ot();if(x<0)__sr[++__C]='-',x=-x;\n\t\twhile(__z[++__zz]=x%10+48,x/=10);\n\t\twhile(__sr[++__C]=__z[__zz],--__zz);__sr[++__C]='\\n';\n\t}\n\tvoid file()\n\t{\n\t\t#ifndef ONLINE_JUDGE\n\t\tfreopen(\"a.in\",\"r\",stdin);\n\t\t#endif\n\t}\n\tinline void chktime()\n\t{\n\t\t#ifndef ONLINE_JUDGE\n\t\tcout<<(clock()-t)/1000.0<<'\\n';\n\t\t#endif\n\t}\n\t#ifdef mod\n\tll ksm(ll x,int y){ll ret=1;for (;y;y>>=1,x=x*x%mod) if (y&1) ret=ret*x%mod;return ret;}\n\tll inv(ll x){return ksm(x,mod-2);}\n\t#else\n\tll ksm(ll x,int y){ll ret=1;for (;y;y>>=1,x=x*x) if (y&1) ret=ret*x;return ret;}\n\t#endif\n//\tinline ll mul(ll a,ll b){ll d=(ll)(a*(double)b/mod+0.5);ll ret=a*b-d*mod;if (ret<0) ret+=mod;return ret;}\n}\nusing namespace my_std;\n\nint pri[sz],mu[sz],phi[sz],cnt;\nbool npri[sz];\nll f[sz];\nvoid init()\n{\n\tmu[1]=phi[1]=1;\n\t#define x i*pri[j]\n\trep(i,2,sz-1)\n\t{\n\t\tif (!npri[i]) pri[++cnt]=i,mu[i]=-1,phi[i]=i-1;\n\t\tfor (int j=1;j<=cnt&&x<sz;j++)\n\t\t{\n\t\t\tnpri[x]=1;\n\t\t\tif (i%pri[j]) mu[x]=-mu[i],phi[x]=(pri[j]-1)*phi[i];\n\t\t\telse { phi[x]=pri[j]*phi[i]; break; }\n\t\t}\n\t}\n\t#undef x\n\trep(i,1,sz-1) for (int j=i;j<sz;j+=i) (f[j]+=1ll*i*mu[j/i]*inv(phi[i])%mod)%=mod;\n}\n\nint n;\nint p[sz];\nstruct hh{int t,nxt;}edge[sz<<1];\nint head[sz],ecnt;\nvoid make_edge(int f,int t)\n{\n\tedge[++ecnt]=(hh){t,head[f]};\n\thead[f]=ecnt;\n\tedge[++ecnt]=(hh){f,head[t]};\n\thead[t]=ecnt;\n}\n\nint fa[sz][30],dep[sz],dfn[sz],c;\nvoid dfs(int x,int f)\n{\n\tdep[x]=dep[fa[x][0]=f]+1;dfn[x]=++c;\n\trep(i,1,20) fa[x][i]=fa[fa[x][i-1]][i-1];\n\t#define v edge[i].t\n\tgo(x) if (v!=f) dfs(v,x);\n\t#undef v\n}\nint lca(int x,int y)\n{\n\tif (dep[x]<dep[y]) swap(x,y);\n\tdrep(i,20,0)\n\t\tif (fa[x][i]&&dep[fa[x][i]]>=dep[y])\n\t\t\tx=fa[x][i];\n\tif (x==y) return x;\n\tdrep(i,20,0)\n\t\tif (fa[x][i]!=fa[y][i])\n\t\t\tx=fa[x][i],y=fa[y][i];\n\treturn fa[x][0];\n}\n\nnamespace Solve\n{\n\tint m;\n\tstruct hhh{int id,p;}S[sz];\n\tstruct hh{int t,nxt;}edge[sz<<1];\n\tint head[sz],ecnt;\n\tvoid make_edge(int f,int t)\n\t{\n\t\tedge[++ecnt]=(hh){t,head[f]};\n\t\thead[f]=ecnt;\n\t\tedge[++ecnt]=(hh){f,head[t]};\n\t\thead[t]=ecnt;\n\t}\n\t\n\tint st[sz],top;\n\tvoid insert(int x)\n\t{\n\t\tif (top<=1) return void(st[++top]=x);\n\t\tint lca=::lca(x,st[top]);\n\t\tif (lca==st[top]) return void(st[++top]=x);\n\t\twhile (top>1)\n\t\t{\n\t\t\tint q=st[top-1],&p=st[top];\n\t\t\tif (dfn[q]==dfn[lca]) { make_edge(q,p); --top; break; }\n\t\t\tif (dfn[q]<dfn[lca]) { make_edge(lca,p); p=lca; break; }\n\t\t\tmake_edge(p,q),--top;\n\t\t}\n\t\tst[++top]=x;\n\t}\n\t\n\tll D[sz];\n\t#define v edge[i].t\n\tvoid dfs1(int x,int fa)\n\t{\n\t\tgo(x) \n\t\t\tif (v!=fa) \n\t\t\t\tdfs1(v,x),(D[x]+=D[v])%=mod;\n\t}\n\tvoid dfs2(int x,int fa){go(x) if (v!=fa) dfs2(v,x);D[x]=D[x]*(dep[x]-dep[fa])%mod;}\n\tvoid dfs3(int x,int fa){(D[x]+=D[fa])%=mod;go(x) if (v!=fa) dfs3(v,x);}\n\tvoid del(int x,int fa){D[x]=0;go(x) if (v!=fa) del(v,x);head[x]=0;}\n\t#undef v\n\t\n\tll solve()\n\t{\n\t\tbool flg=0;\n\t\trep(i,1,m) flg|=(S[i].p==1);\n\t\tif (!flg) S[++m]=(hhh){0,1};\n\t\tsort(S+1,S+m+1,[](const hhh &x,const hhh &y){return dfn[x.p]<dfn[y.p];});\n\t\trep(i,1,m) insert(S[i].p);\n\t\twhile (top>1) make_edge(st[top],st[top-1]),--top;\n\t\ttop=0;\n\t\trep(i,1,m) (D[S[i].p]+=phi[S[i].id])%=mod;\n\t\tdfs1(1,0);D[1]=0;dfs2(1,0);dfs3(1,0);\n\t\tll ret=0;\n\t\trep(i,1,m) (ret+=phi[S[i].id]*D[S[i].p]%mod)%=mod;\n\t\trep(i,1,m) S[i]=(hhh){0,0};\n\t\tdel(1,0);\n\t\tecnt=m=0;\n\t\treturn ret;\n\t}\n}\n\nll solve(int T)\n{\n\tll ret,S1=0,S2=0;\n\tfor (int i=T;i<=n;i+=T) \n\t\tSolve::S[++Solve::m]=(Solve::hhh){i,p[i]},\n\t\t(S1+=phi[i])%=mod,\n\t\t(S2+=1ll*(dep[p[i]]-1)*phi[i]%mod)%=mod;\n\tret=S1*S2*2%mod;\n\tll t=Solve::solve();\n\tret=(ret-2ll*t+mod+mod)%mod;\n\treturn ret*f[T]%mod;\n}\n\nint main()\n{\n\tfile();\n\tinit();\n\tread(n);\n\tint x,y;\n\trep(i,1,n) read(x),p[x]=i;\n\trep(i,1,n-1) read(x,y),make_edge(x,y);\n\tdfs(1,0);\n\tll ans=0;\n\trep(T,1,n) (ans+=solve(T)+mod)%=mod;\n\tcout<<ans*inv(1ll*n*(n-1)%mod)%mod;\n\treturn 0;\n}\n```",
        "postTime": 1554205325,
        "uid": 76481,
        "name": "p_b_p_b",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF809E \u3010Surprise me!\u3011"
    },
    {
        "content": "hu~\uff0c\u8fd9\u9053\u9898\u65ad\u65ad\u7eed\u7eed\u5199\u4e86\u6211\u4e00\u5929...\n\n\u7ed9\u5b9a\u4e00\u68f5\u6811\uff0c\u6bcf\u4e2a\u70b9\u6709\u6743\u503c$a_i$\uff08\u662f\u4e00\u4e2a\u6392\u5217\uff09\uff0c\u6c42\u51fa$\\sum\\sum dis(i,j)\\phi(a_ia_j)$\n\n\u9996\u5148\uff0c\u6709\u4e00\u4e2a\u91cd\u8981\u7684\u5f0f\u5b50\uff1a\n\n$$\\phi(ab)=\\phi(a)\\phi(b)g/\\phi(g),g=\\gcd(a,b)$$\n\n\u7136\u540e\u4ee3\u5165\uff0c\n\n$$\\begin{aligned}Ans&=\\sum_{i=1}^n\\sum_{j=1}^n\\varphi(a_i)\\varphi(a_j)\\frac{gcd(a_i,a_j)}{\\varphi(gcd(a_i,a_j)}dist(i,j)\\\\&=\\sum_{d=1}^n\\frac{d}{\\varphi(d)}\\sum_{i=1}^n\\sum_{j=1}^n[gcd(a_i,a_j)=d]\\varphi(a_i)\\varphi(a_j)dist(i,j)\\\\\\end{aligned}$$\n\n\u8bbe\n\n$$g(d)=\\sum_{i=1}^n\\sum_{j=1}^n[gcd(a_i,a_j)=d]\\varphi(a_i)\\varphi(a_j)dist(i,j)$$\n\n\u518d\u8bbe\n\n$$f(d)=\\sum_{i=1}^n\\sum_{j=1}^n[d|gcd(a_i,a_j)]\\varphi(a_i)\\varphi(a_j)dist(i,j)$$\n\n\u4e8e\u662fg\u53ef\u4ee5\u7531f\u53cd\u6f14\u5f97\u5230\u3002\n\n\u4e8e\u662f\u7b54\u6848\u5c31\u80fd\u7b97\u4e86\u3002\n\n\u5982\u4f55\u89e3\u51b3dis\u7684\u95ee\u9898\uff1f\u628a\u90a3\u4e9b\u662f\u500d\u6570\u7684\u70b9\u62ff\u51fa\u6765\u5efa\u4e2a\u865a\u6811\u3002\n\n~~\u53ef\u80fd\u70b9\u5206\u6cbb\u4e5f\u53ef\u4ee5\u4ee3\u66ff\u865a\u6811\u505a~~\n\n```\n#define N 200005\nint n;\nbool notp[N];\nint pri[N],cntp,phi[N],mu[N];\nvoid sieve()\n{\n\tnotp[1]=1,mu[1]=phi[1]=1;\n\tfor(ri i=2; i<=n; ++i)\n\t{\n\t\tif(!notp[i]) pri[++cntp]=i,phi[i]=i-1,mu[i]=-1;\n\t\tfor(ri j=1,t; j<=cntp&&(t=pri[j]*i)<=n; ++j)\n\t\t{\n\t\t\tnotp[t]=1;\n\t\t\tif(i%pri[j]==0) {phi[t]=phi[i]*pri[j],mu[t]=0; break;}\n\t\t\telse phi[t]=phi[i]*(pri[j]-1),mu[t]=-mu[i];\n\t\t}\n\t}\n}\nint a[N];\nvector<int>E[N];\nint dfn[N],dk;\nint b[N][18],dep[N];\nvoid pfs(int x,int _fa)\n{\n\tb[x][0]=_fa,dep[x]=dep[_fa]+1,dfn[x]=++dk;\n\tfor(ri i=1; i<=17&&b[x][i-1]; ++i) b[x][i]=b[b[x][i-1]][i-1];\n\tfor(solid v:E[x]) if(v!=_fa) pfs(v,x);\n\tE[x].clear();\n}\nil int lca(int x,int y)\n{\n\tif(dep[x]<dep[y]) swap(x,y);\n\tfor(ri i=17; i>=0; --i)\n\t\tif(dep[b[x][i]]>=dep[y]) x=b[x][i];\n\tif(x==y) return x;\n\tfor(ri i=17; i>=0; --i)\n\t\tif(b[x][i]!=b[y][i]) x=b[x][i],y=b[y][i];\n\treturn b[x][0];\n}\nbool cmp(const int &a,const int &b)\n{\n\treturn dfn[a]<dfn[b];\n}\nint st[N],tp;\nvoid ins(int x)\n{\n\tif(!tp) {st[++tp]=x; return;}\n\tint f=lca(x,st[tp]);\n\twhile(tp>1&&dfn[f]<dfn[st[tp-1]]) E[st[tp-1]].pb(st[tp]),--tp;\n\tif(dfn[f]<dfn[st[tp]]) E[f].pb(st[tp--]);\n\tif(f!=st[tp]) st[++tp]=f;\n\tst[++tp]=x;\n}\nbool vis[N];\nint sump[N];\nint fuc;\nvoid dfs(int x)\n{\n\tif(vis[x])\n\t{\n\t\tsump[x]=phi[a[x]];\n\t\tdec(fuc,mul(dep[x],mul(phi[a[x]],phi[a[x]])));\n\t}\n\tint lcap=0;\n\tfor(solid v:E[x])\n\t{\n\t\tdfs(v);\n\t\tinc(lcap,mul(sump[x],sump[v]));\n\t\tinc(sump[x],sump[v]);\n\t}\n\tlcap=mul(dep[x],mul(2,lcap));\n\tdec(fuc,lcap);\n}\nvoid cfs(int x)\n{\n\tsump[x]=0,vis[x]=0;\n\tfor(solid v:E[x]) cfs(v);\n\tE[x].clear();\n}\nint id[N];\nint f[N],g[N];\nsigned main()\n{\n\tin(n);\n\tfor(ri i=1; i<=n; ++i) in(a[i]),id[a[i]]=i;\n\tfor(ri i=1,a,b; i<n; ++i)\n\t{\n\t\tin(a,b);\n\t\tE[a].pb(b),E[b].pb(a);\n\t}\n\tpfs(1,0);\n\tsieve();\n\tfor(ri d=1; d<=n; ++d)\n\t{\n\t\tstatic int lis[N]; int cnt=0,s1=0,s2=0;\n\t\tfuc=0;\n\t\tfor(ri i=d; i<=n; i+=d)\n\t\t{\n\t\t\tvis[lis[++cnt]=id[i]]=1;\n\t\t\tinc(s1,phi[i]);\n\t\t\tinc(s2,mul(dep[id[i]],phi[i]));\n\t\t}\n\t\tsort(lis+1,lis+1+cnt,cmp);\n\t\ttp=0;\n\t\tfor(ri i=1; i<=cnt; ++i) ins(lis[i]);\n\t\twhile(tp>1) E[st[tp-1]].pb(st[tp]),--tp;\n\t\tdfs(st[1]);\n\t\tfuc=mul(2,add(mul(s1,s2),fuc));\n\t\tf[d]=fuc;\n\t\tcfs(st[1]);\n\t}\n\tfor(ri i=1; i<=n; ++i)\n\t\tfor(ri j=1; j*i<=n; ++j)\n\t\t\tif(mu[j]==1) inc(g[i],f[j*i]);\n\t\t\telse if(mu[j]==-1) dec(g[i],f[j*i]);\n\tint ans=0;\n\tfor(ri i=1; i<=n; ++i) inc(ans,mul(g[i],mul(i,mdinv(phi[i]))));\n\tans=mul(ans,mdinv(mul(n,n-1)));\n\tout(ans);\n\treturn 0;\n}\n```\n",
        "postTime": 1551704120,
        "uid": 58302,
        "name": "i207M",
        "ccfLevel": 0,
        "title": "\u83ab\u6bd4\u4e4c\u65af\u53cd\u6f14-\u865a\u6811-CF809E-\u89e3\u9898\u62a5\u544a"
    }
]