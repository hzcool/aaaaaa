[
    {
        "content": "> *[CF960H Santa's Gift](https://www.luogu.com.cn/problem/CF960H) *3100*\n\n\u5c06\u8d21\u732e\u5f0f\u5c55\u5f00\uff0c\u5f97\u5230 $\\dfrac{b_x ^ 2\\sum S_i ^ 2 + 2b_xC \\sum S_i} n + C ^ 2$\u3002\u56e0\u6b64\u53ea\u9700\u5bf9\u6bcf\u4e2a\u989c\u8272\u7ef4\u62a4\u6bcf\u4e2a\u70b9\u7684\u5b50\u6811\u5185\u542b\u6709\u8be5\u989c\u8272\u7684\u8282\u70b9\u4e2a\u6570\u7684\u548c\u4e0e\u5e73\u65b9\u548c\u3002\u56e0\u4e3a\u53ea\u6709\u5355\u70b9\u4fee\u6539\u989c\u8272\uff0c\u5bf9\u5e94\u4fee\u6539\u4e00\u6761\u94fe\u4e0a\u6240\u6709\u70b9\u5173\u4e8e\u67d0\u4e2a\u989c\u8272\u7684 $S_i$\uff0c\u6240\u4ee5\u5bb9\u6613\u6811\u5256 + \u52a8\u6001\u5f00\u70b9\u7ebf\u6bb5\u6811\u7ef4\u62a4\uff0c\u6ce8\u610f `push_down` \u65f6\u65b0\u5f00\u8282\u70b9\u3002\u65f6\u7a7a\u590d\u6742\u5ea6\u7ebf\u6027\u5bf9\u6570\u5e73\u65b9\u3002\n\n\u60f3\u5fc5\u6765\u5199\u8fd9\u9053\u9898\u76ee\u7684\u540c\u5b66\u5e94\u8be5\u4f1a\u533a\u95f4\u52a0\u533a\u95f4\u5e73\u65b9\u548c\u7f62\u3002$\\sum (x_i + v) ^ 2 = \\sum x_i ^ 2 + v\\sum x_i + Lv ^ 2$\uff0c\u5176\u4e2d $L$ \u662f\u533a\u95f4\u957f\u5ea6\u3002\n\n\u4ee3\u7801\u5f88\u7b80\u5355\u3002\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\nconst int N = 5e4 + 5, K = N * 360;\nlong long sq[K], val[K], C;\nint n, m, q, node, fa[N], a[N], b[N];\nint R[N], ls[K], rs[K], laz[K];\nvoid tag(int l, int r, int &x, long long v) {\n\tif(!x) x = ++node;\n\tsq[x] += 2 * val[x] * v + (r - l + 1) * v * v;\n\tval[x] += (r - l + 1) * v;\n\tlaz[x] += v;\n}\nvoid down(int l, int r, int x) {\n\tif(laz[x]) {\n\t\tint m = l + r >> 1;\n\t\ttag(l, m, ls[x], laz[x]);\n\t\ttag(m + 1, r, rs[x], laz[x]);\n\t\tlaz[x] = 0;\n\t}\n}\nvoid modify(int l, int r, int ql, int qr, int &x, int v) {\n\tif(!x) x = ++node;\n\tif(ql <= l && r <= qr) return tag(l, r, x, v), void();\n\tint m = l + r >> 1;\n\tdown(l, r, x);\n\tif(ql <= m) modify(l, m, ql, qr, ls[x], v);\n\tif(m < qr) modify(m + 1, r, ql, qr, rs[x], v);\n\tval[x] = val[ls[x]] + val[rs[x]];\n\tsq[x] = sq[ls[x]] + sq[rs[x]];\n}\nvector <int> e[N];\nint dn, dfn[N], sz[N], dep[N], son[N], top[N];\nvoid dfs1(int id) {\n\tsz[id] = 1, dep[id] = dep[fa[id]] + 1;\n\tfor(int it : e[id]) {\n\t\tdfs1(it), sz[id] += sz[it];\n\t\tif(sz[it] > sz[son[id]]) son[id] = it;\n\t}\n}\nvoid dfs2(int id, int t) {\n\ttop[id] = t, dfn[id] = ++dn;\n\tif(son[id]) dfs2(son[id], t);\n\tfor(int it : e[id]) if(it != son[id]) dfs2(it, it);\n}\nvoid add(int x, int c, int v) {while(x) modify(1, n, dfn[top[x]], dfn[x], R[c], v), x = fa[top[x]];}\nint main() {\n\tcin >> n >> m >> q >> C;\n\tfor(int i = 1; i <= n; i++) cin >> a[i];\n\tfor(int i = 2; i <= n; i++) cin >> fa[i], e[fa[i]].push_back(i);\n\tfor(int i = 1; i <= m; i++) cin >> b[i];\n\tdfs1(1), dfs2(1, 1);\n\tfor(int i = 1; i <= n; i++) add(i, a[i], 1);\n\tfor(int i = 1; i <= q; i++) {\n\t\tint op, x, y;\n\t\tcin >> op >> x;\n\t\tif(op == 1) cin >> y, add(x, a[x], -1), add(x, a[x] = y, 1);\n\t\telse printf(\"%.10lf\\n\", (double)(b[x] * b[x] * sq[R[x]] - 2 * b[x] * C * val[R[x]]) / n + C * C);\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1648804827,
        "uid": 123294,
        "name": "Alex_Wei",
        "ccfLevel": 10,
        "title": "CF960H Santa's Gift"
    },
    {
        "content": "\u6a21\u62df\u8d5b\u6700\u540e 45min \u7801\u51fa\u4e86 180 \u884c\u7684 *3100 \u6570\u636e\u7ed3\u6784\u9898\uff0c\u7eaa\u5ff5\n\n\u5148\u5047\u8bbe\u4e0b\u9762\u7684 $/n$ \u4e0d\u5b58\u5728\uff0c\u8003\u8651\u7b80\u5316 $\\sum(S_ib_x-C)^2$\u3002\n\n$$\\sum_{i=1}^n(S_ib_x-C)^2$$\n$$\\sum_{i=1}^nS_i^2b_x^2-2S_ib_xC+C^2$$\n$$nC^2-2b_xC\\sum_{i=1}^nS_i+b_x^2\\sum_{i=1}^nS_i^2$$\n\n\u4e8e\u662f\u6211\u4eec\u53ea\u9700\u8981\u5bf9\u6bcf\u4e00\u4e2a\u5143\u7d20\u989c\u8272\u7684 $\\sum S_i$ \u548c $\\sum S_i^2$\u3002\n\n\u53d8\u67d0\u4e00\u4e2a\u8282\u70b9\u7684\u989c\u8272\u53ef\u4ee5\u770b\u505a\u4e3a\u628a\u8fd9\u4e2a\u5230\u6839\u8def\u5f84\u4e0a\u5bf9\u5bf9\u5e94\u989c\u8272\u6240\u6709 $S_i$ \u52a0 1 \u6216\u8005\u51cf 1\u3002$\\sum S_i^2$ \u53ef\u4ee5\u7ef4\u62a4\u53d8\u7684\u65f6\u5019\u7684\u5dee\u3002\u73b0\u5728\u95ee\u9898\u9000\u5316\u6210\u5bf9\u6240\u6709\u989c\u8272\u7ef4\u62a4\u4e00\u4e2a\u652f\u6301\u5230\u6839\u8def\u5f84\u8282\u70b9\u503c\u4e4b\u548c\uff0c\u5230\u6839\u8def\u5f84\u8282\u70b9\u503c\u5168\u90e8\u52a0\u51cf1\u7684\u4e00\u4e2a\u7ed3\u6784\u3002\n\n~~\u4e0d\u77e5\u9053\u51fa\u9898\u4eba\u600e\u4e48\u60f3\u5230\u6dc0\u7c89\u8d28~~\n\n\u8fd9\u4e2a\u76f4\u63a5\u770b\u8d77\u6765\u662f\u6811\u5256\uff0c\u4f46\u662f\u5bf9\u6bcf\u4e00\u4e2a\u989c\u8272\u5f00\u4e00\u4e2a\u5b8c\u5168\u7684\u6811\u5256\u7ed3\u6784\u663e\u7136\u4e0d\u884c\uff08\u5185\u5b58\u70b8\uff09\uff0c\u6240\u4ee5\u7528\u52a8\u6001\u5f00\u70b9\u7ebf\u6bb5\u6811\u3002\n\n\u8fd9\u91cc\u53ea\u9700\u8981\u6ce8\u610f $\\sum S_i^2$ \u662f\u600e\u4e48\u53d8\u4e86\u3002\u5f53\u65f6\u5728\u4e00\u4e2a\u8282\u70b9 $u$ \u6240\u6709 $S_i$ \u52a0 1\uff0c\u5dee\u662f\n\n$$\\sum_{i\\in Link}2S_i+1=|Link|+2\\sum_{i\\in Link}^nS_i$$\n\n$|Link|$ \u5c31\u662f\u8282\u70b9 $u$ \u7684\u6df1\u5ea6\uff0cdfs \u51fa\u6765\u3002\u51cf 1 \u7684\u65f6\u5019\u5e76\u4e0d\u662f\u4e00\u6574\u4e2a\u53d6\u8d1f\uff0c\u800c\u662f\n\n$$\\sum_{i\\in Link}-2S_i+1=|Link|-2\\sum_{i\\in Link}^nS_i$$\n\n\u8fd9\u6837\u66f4\u65b0\u5c31\u53ef\u4ee5\u4e86\u3002\n\n\u8d5b\u65f6\u4ee3\u7801\uff1a\n\n```cpp\n// writer: w33z8kqrqk8zzzx33\n#include <bits/stdc++.h>\nusing namespace std;\n\n#define iter(i, a, b) for(int i=(a); i<(b); i++)\n#define rep(i, a) iter(i, 0, a)\n#define rep1(i, a) iter(i, 1, (a)+1)\n#define fi first\n#define se second\n#define pb push_back\n \n#define ll long long\n#define pii pair<int, int>\n//#define int ll\nconst int MOD = 1000000007;\n/*\nstatic char buf[450 << 20];\nsize_t idx = sizeof buf;\nvoid* operator new(size_t s) {\n\tassert(s < idx);\n\treturn (void*)&buf[idx -= s];\n}\nvoid operator delete(void*) {}\n\ntemplate<class T> struct ptr {\n\tunsigned ind;\n\tptr(T* p = 0) : ind(p ? unsigned((char*)p - buf) : 0) {\n\t\tassert(ind < sizeof buf);\n\t}\n\tT& operator*() const { return *(T*)(buf + ind); }\n\tT* operator->() const { return &**this; }\n\tT& operator[](int a) const { return (&**this)[a]; }\n\texplicit operator bool() const { return ind; }\n};\n*/\nnamespace sst {\n    class SST {\n    public:\n    \tll sum;\n    \tSST* ch[2];\n    \tSST() : sum(0) {\n    \t\tch[0] = nullptr;\n    \t\tch[1] = nullptr;\n    \t}\n    \tvoid inc(int val, int diff, int dep=16) {\n    \t\tsum += diff;\n    \t\tif (!dep) return;\n    \t\tbool cv = val & (1 << (dep - 1));\n    \t\tif (!ch[cv]) ch[cv] = new SST;\n    \t\tch[cv]->inc(val, diff, dep-1);\n    \t}\n    };\n    \n    inline ll psum(SST* root, int val) {\n    \tint dep = 16; ll ans = 0;\n    \twhile(dep && root) {\n    \t\tbool cv = val & (1 << (--dep));\n    \t\tif (cv && root->ch[0]) ans += root->ch[0]->sum;\n    \t\troot = root->ch[cv];\n    \t}\n    \treturn ans + (root ? root->sum : 0);\n    }\n}\n\nclass IaIs {\npublic:\n    sst::SST* di, *idi;\n    IaIs() { using namespace sst; di = new SST(); idi = new SST(); }\n    void ia(int r, int dt) { di->inc(r, dt); idi->inc(r, r*dt); }\n    void ia(int l, int r, int dt) { ia(r+1, -dt); ia(l, dt); }\n    ll is(int r) { using namespace sst; return (r+1) * psum(di, r) - psum(idi, r); }\n    ll is(int l, int r) { return is(r) - is(l-1); }\n};\n\nIaIs colors[50004];\nvector<int> elist[50004];\n\nint size[50004], heavy[50004];\nint hp[50004], par[50004], dep[50004];\n\nvoid dfsSize(int u=1, int f=-1) {\n    if(f == -1) dep[u] = 1;\n    else dep[u] = dep[f] + 1;\n    size[u] = 1, heavy[u] = -1; par[u] = f;\n    for(int& v:elist[u]) if(v != f) {\n        dfsSize(v, u);\n        size[u] += size[v];\n        if(heavy[u] == -1 || size[heavy[u]] < size[v]) heavy[u] = v;\n    }\n}\n\nint clock = 1;\nint toDfs[50004];\n\nll askLink(int L, int R, int color) {\n    return colors[color].is(toDfs[L], toDfs[R]);\n}\n\nvoid addLink(int L, int R, int dt, int color) {\n    return colors[color].ia(toDfs[L], toDfs[R], dt);\n}\n\nvoid dfsHeav(int u=1, int f=-1) {\n    if(f == -1) hp[u] = u;\n    toDfs[u] = clock++;\n    if(heavy[u] != -1) {\n        hp[heavy[u]] = hp[u];\n        dfsHeav(heavy[u], u);\n    }\n    for(int& v:elist[u]) if(v != f && v != heavy[u]) {\n        hp[v] = v;\n        dfsHeav(v, u);\n    }\n}\n\nll askToRoot(int u, int color) {\n    ll ans = 0;\n    while(u != -1) {\n        ans += askLink(hp[u], u, color);\n        u = par[hp[u]];\n    }\n    return ans;\n}\n\nvoid addToRoot(int u, int dt, int color) {\n    while(u != -1) {\n        addLink(hp[u], u, dt, color);\n        u = par[hp[u]];\n    }\n}\n\nint type[50004];\nint ck[50004];\nll sumT[50004], sumT2[50004];\n\nvoid make(int i, int dt) {\n    sumT[type[i]] += dt * dep[i];\n    sumT2[type[i]] += dt * (2 * askToRoot(i, type[i])) + dep[i];\n    addToRoot(i, dt, type[i]);\n}\n\nsigned main() {\n    ios_base::sync_with_stdio(false); cin.tie(0);\n    int n, m, q, c; cin >> n >> m >> q >> c;\n    rep1(i, n) cin >> type[i];\n    iter(i, 2, n+1) {\n        int f; cin >> f;\n        elist[f].pb(i);\n        elist[i].pb(f);\n    }\n    rep1(i, m) cin >> ck[i];\n    dfsSize();\n    dfsHeav();\n    rep1(i, n) {\n        make(i, 1);\n    }\n    while(q--) {\n        int t; cin >> t;\n        if(t == 1) {\n            int x, w; cin >> x >> w;\n            make(x, -1);\n            type[x] = w;\n            make(x, 1);\n        } else {\n            int k; cin >> k;\n            ll ans = 1ll * n * c * c;\n            ans += 1ll * ck[k] * ck[k] * sumT2[k];\n            ans -= 2 * ck[k] * c * sumT[k];\n            long double v = ans;\n            v /= n;\n            cout << fixed << setprecision(20) << v << endl;\n        }\n    }\n}\n\n```",
        "postTime": 1601695235,
        "uid": 220037,
        "name": "w33z8kqrqk8zzzx33",
        "ccfLevel": 7,
        "title": "10/2 \u6a21\u62df\u8d5b \u9898\u89e3 CF960H"
    },
    {
        "content": "### P.S.\n\u953b\u70bc\u7801\u529b\u7684\u597d\u9898  \n\u770b\u57fa\u672c\u6ca1\u4ee3\u7801\u53ef\u8bfb\u7684\u9898\u89e3\u5c31\u6765\u7bc7  \n\n### Description.\n\u7565\n\n### Solution.\n\u9996\u5148\u8be2\u95ee\u4e00\u4e2a\u989c\u8272\u8fd9\u79cd\u9898\u53ef\u4ee5\u5bf9\u6bcf\u4e2a\u989c\u8272\u5206\u522b\u7ef4\u62a4\u3002  \n\u53cd\u6b63\u7b14\u8005\u7b2c\u4e00\u60f3\u6cd5\u5c31\u662f\u5bf9\u6bcf\u4e2a\u989c\u8272\u5efa\u7acb\u865a\u6811\u3002  \n\u4f46\u662f\u53d1\u73b0\u865a\u6811\u4e0a\u65e0\u6cd5\u5220\u9664\uff0c\u6bd4\u8f83\u590d\u6742\uff0c\u800c\u4e14\u865a\u6811\u7ef4\u62a4\u4fe1\u606f\u4e5f\u6bd4\u8f83\u56f0\u96be\u3002  \n\u8f6c\u5ff5\u4e00\u60f3\uff0c\u53d1\u73b0\u5176\u5b9e\u865a\u6811\u4e0a\u6839\u672c\u4e0d\u9700\u8981\u5220\u9664\uff0c\u56e0\u4e3a\u603b\u590d\u6742\u5ea6\u662f $O(n+q)$ \u7684\u3002  \n\n\u62c6\u4e00\u4e0b\u5f0f\u5b50\uff0c\u53d8\u6210\u4e86\u4e0b\u5f0f\u3002  \n$$\n\\begin{aligned}\n&=\\frac1n\\sum_{i=1}^n(S_ib_x-C)^2\\\\\n&=\\frac1n\\sum_{i=1}^nS_i^2b_x^2+C^2-2CS_ib_x\\\\\n&=\\frac{b_x^2}n\\sum_{i=1}^nS_i^2-\\frac{2Cb_x}{n}\\sum_{i=1}^nS_i+C^2\\\\\n\\end{aligned}\n$$\n\n\u6240\u4ee5\u6211\u4eec\u9700\u8981\u6c42\u51fa $S_i^2$ \u548c\u548c $S_i$ \u548c\u3002  \n\u53ef\u4ee5\u76f4\u63a5\u7ef4\u62a4 $S_i$\u3002  \n\u6bcf\u6b21\u4fee\u6539\u989c\u8272\u76f8\u5f53\u4e8e\u5bf9\u4e00\u4e2a\u70b9\u5230\u6839\u7684\u8def\u5f84 $+1$ \u6216 $-1$\u3002  \n\u7136\u540e\u76f8\u5f53\u4e8e\u4e00\u4e2a\u533a\u95f4\u52a0\u3002  \n\n\u4f46\u662f\u8fd9\u6837\u7a7a\u95f4\u80af\u5b9a\u7206\u70b8\uff0c\u8003\u8651\u52a8\u6001\u5f00\u70b9\u3002  \n\u867d\u7136\u662f\u533a\u95f4\u52a0\uff0c\u5c31\u76f8\u5f53\u4e8e\u53ea\u6709\u4e00\u4e2a tag \u7684\u533a\u95f4\u5b9a\u4e49\u4e3a\u7ed3\u675f\u8282\u70b9\u3002  \n\u7136\u540e\u65f6\u7a7a\u590d\u6742\u5ea6\u90fd\u662f $O(n\\log ^2n)$\uff0c$5\\times 10^4$ \u968f\u4fbf\u8fc7\u3002  \n\n### Coding.\n```cpp\n//Coded by Kamiyama_Shiki on 2021.11.10 {{{\n//\u662f\u554a\u2026\u2026\u4f60\u5c31\u662f\u90a3\u53ea\u9b3c\u4e86\u2026\u2026\u6240\u4ee5\u88ab\u4f60\u78b0\u5230\u4ee5\u540e\uff0c\u5c31\u8f6e\u5230\u6211\u53d8\u6210\u9b3c\u4e86\n#include<bits/stdc++.h>\nusing namespace std;typedef long long ll;\ntemplate<typename T>inline void read(T &x)\n{\n\tx=0;char c=getchar(),f=0;\n\tfor(;c<48||c>57;c=getchar()) if(!(c^45)) f=1;\n\tfor(;c>=48&&c<=57;c=getchar()) x=(x<<1)+(x<<3)+(c^48);\n\tf?x=-x:x;\n}\ntemplate<typename T,typename...L>inline void read(T &x,L&...l) {read(x),read(l...);}//}}}\nconst int N=50005;int n,m,Q,cl[N];ll b[N],C;\nstruct node\n{\n\tll _0,_1,_2;\n\tnode(ll w=-1,ll a=-1,ll b=-1)\n\t{\n\t\tif(~a) _0=w,_1=a,_2=b;\n\t\telse if(~w) _0=1,_1=w,_2=w*w;\n\t\telse _0=_1=_2=0;\n\t}\n\tinline node operator+(node a) {return node(_0+a._0,_1+a._1,_2+a._2);}\n\tinline node operator+(ll b) {return node(_0,_1+b*_0,_2+2*b*_1+_0*b*b);}\n};\nstruct segm{int ls,rs;ll tg;char ed;node vl;}T[N*205];int tt,rt[N];\ninline void pushup(int x) {T[x].vl=T[T[x].ls].vl+T[T[x].rs].vl;}\ninline void newnd(int &x,node c) {T[x=++tt]=(segm){0,0,0,1,c};}\ninline void allc(int x,ll w) {T[x].vl=T[x].vl+w,T[x].tg+=w;}\ninline void pushdw(int x)\n{\n\tif(T[x].ed)\n\t{\n\t\tll lnr=T[x].vl._0>>1,lnl=T[x].vl._0-lnr;T[x].ed=0;\n\t\tnewnd(T[x].ls,node(lnl,0,0)),newnd(T[x].rs,node(lnr,0,0));\n\t}\n\tif(T[x].tg) allc(T[x].ls,T[x].tg),allc(T[x].rs,T[x].tg),T[x].tg=0;\n}\ninline void modif(int x,int l,int r,int dl,int dr,int dc)\n{\n\tif(l>dr||dl>r) return;else if(dl<=l&&r<=dr) return allc(x,dc);else pushdw(x);\n\tmodif(T[x].ls,l,(l+r)>>1,dl,dr,dc),modif(T[x].rs,((l+r)>>1)+1,r,dl,dr,dc),pushup(x);\n}\nstruct edge{int to,nxt;}e[N];int et,head[N];\ninline void adde(int x,int y) {e[++et]=(edge){y,head[x]},head[x]=et;}\nint dep[N],f[N],sz[N],sn[N],dfn[N],nfd[N],dt,tp[N];\ninline void dfs0(int x,int fa)\n{\n\tdep[x]=dep[f[x]=fa]+1,sz[x]=1,sn[x]=0;\n\tfor(int i=head[x];i;i=e[i].nxt)\n\t{\n\t\tdfs0(e[i].to,x),sz[x]+=sz[e[i].to];\n\t\tif(sz[e[i].to]>sz[sn[x]]) sn[x]=e[i].to;\n\t}\n}\ninline void dfs1(int x,int top)\n{\n\tdfn[x]=++dt,nfd[dt]=x,tp[x]=top;if(sn[x]) dfs1(sn[x],top);else return;\n\tfor(int i=head[x];i;i=e[i].nxt) if(e[i].to!=sn[x]) dfs1(e[i].to,e[i].to);\n}\ninline void chang(int id,int x,int dc)\n{\n\tfor(;tp[x]!=1;x=f[tp[x]]) modif(rt[id],1,n,dfn[tp[x]],dfn[x],dc);\n\tmodif(rt[id],1,n,1,dfn[x],dc);\n}\ninline void debug(int x,int l,int r)\n{\n\tprintf(\"[ %d %d ] : %lld %lld %lld\\n\",l,r,T[x].vl._0,T[x].vl._1,T[x].vl._2);\n\tif(l==r) return;else pushdw(x),debug(T[x].ls,l,(l+r)>>1),debug(T[x].rs,((l+r)>>1)+1,r);\n}\nint main()\n{\n\tread(n,m,Q,C);for(int i=1;i<=n;i++) read(cl[i]);\n\tfor(int i=2,f;i<=n;i++) read(f),adde(f,i);\n\tfor(int i=1;i<=m;i++) read(b[i]),newnd(rt[i],(node){n,0,0});\n\tdfs0(1,0),dfs1(1,1);for(int i=1;i<=n;i++) chang(cl[i],i,1);\n\tfor(int fg,x,y;Q--;)\n\t{\n\t\tread(fg,x);if(fg&1) {read(y),chang(cl[x],x,-1),chang(cl[x]=y,x,1);continue;}\n\t\tnode w=T[rt[x]].vl;printf(\"%.8lf\\n\",1.0*w._2*b[x]*b[x]/n-2.0*C*b[x]/n*w._1+C*C);\n\t}return 0;\n}\n```",
        "postTime": 1636672812,
        "uid": 44805,
        "name": "Leap_Frog",
        "ccfLevel": 7,
        "title": "CF960H Santa's Gift\uff08\u9898\u89e3\uff09"
    }
]