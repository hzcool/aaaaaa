[
    {
        "content": "# \u8bf7\u5230\u535a\u5ba2\u67e5\u770b\n\n\u9996\u5148\u8bbe\u6839\u4e3a $1$\uff0c\u8bbe $\\text{dep}(x)$ \u4e3a $x$ \u7684\u6df1\u5ea6\uff08$\\text{dep}(1) = 0$\uff09\uff0c\u8bbe $\\text{dis}(x,y), \\text{lca}(x,y)$ \u5206\u522b\u4e3a $x,y$ \u7684\u8ddd\u79bb\u548c\u6700\u8fd1\u516c\u5171\u7956\u5148\uff0c\u663e\u7136\u6709 $\\text{dis}(x,y) = \\text{dep}(x) + \\text{dep}(y) - 2\\text{dep}(\\text{lca}(x,y))$\u3002\n\n\u518d\u8bbe $v(x,c) = [l_x \\le c \\le r_x]$\uff0c$g(x) = r_x - l_x + 1$\uff0c$p = \\prod_{i = 1} ^ n g(i)$\u3002\n\n\u5bf9\u4e8e\u4e24\u4e2a\u70b9 $x,y$ \u548c\u4e00\u4e2a\u989c\u8272 $c$\uff0c\u5176\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u4e3a\n\n$$\n\\begin{aligned}\nans &= [l_x \\le  c \\le r_x][l_y \\le c \\le r_y]\\text{dis}(x,y)\\prod_{z \\ne x,y}(r_z - l_z + 1) \\\\\n&= pv(x,c)v(y,c)(\\text{dep}(x) + \\text{dep}(y) - 2\\text{dep}(\\text{lca}(x,y)))\\frac{1}{g(x)g(y)}\n\\end{aligned}\n$$\n\n\u9996\u5148\u8003\u8651\n\n$$\nA = v(x,c)v(y,c)(\\text{dep}(x) + \\text{dep}(y))\\frac{1}{g(x)g(y)}\n$$\n\n\u6ce8\u610f\u5230\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u70b9 $x$ \u548c\u4e00\u4e2a\u989c\u8272 $c$\uff0c\u5176\u5bf9 $A$ \u8d21\u732e\u4e3a\n\n$$\nv(x,c)\\text{dep}(x)(\\sum_{v(y,c)}\\frac{1}{g(x)g(y)} - \\frac{1}{g^2(x)})\n$$\n\n\u5219\n\n$$\n\\begin{aligned}\nA &= \\sum_{v(x,c)}\\text{dep}(x)(\\sum_{v(y,c)}\\frac{1}{g(x)g(y)} - \\frac{1}{g^2(x)}) \\\\\n&= \\sum_{v(x,c)}\\frac{\\text{dep}(x)}{g(x)}\\sum_{v(x,c)}\\frac{1}{g(x)}-\\sum_{v(x,c)}\\frac{\\text{dep}(x)}{g^2(x)}\n\\end{aligned}\n$$\n\n\u663e\u7136\u53ef\u4ee5\u628a $c$ \u4ece\u5c0f\u5230\u5927\u626b\u4e00\u904d\uff0c\u540c\u65f6\u7ef4\u62a4\n\n$$\n\\begin{aligned}\nA_1 &= \\sum_{v(x,c)}\\frac{\\text{dep}(x)}{g(x)} \\\\\nA_2 &= \\sum_{v(x,c)}\\frac{1}{g(x)} \\\\\nA_3 &= \\sum_{v(x,c)}\\frac{\\text{dep}(x)}{g^2(x)}\n\\end{aligned}\n$$\n\n\u63a5\u4e0b\u6765\u8003\u8651\n\n$$\nB = v(x,c)v(y,c)\\text{dep}(\\text{lca}(x,y))\\frac{1}{g(x)g(y)}\n$$\n\n\u8bbe $s(x)$ \u8868\u793a $x$ \u5bf9 $B$ \u7684\u8d21\u732e\uff0c$S(x)$ \u8868\u793a $x$ \u7684\u6240\u6709\u7956\u5148\u7684 $s$ \u4e4b\u548c\u3002\n\n\u6ce8\u610f\u5230\u5f53\u6211\u4eec\u52a0\u5165\u4e00\u4e2a\u70b9 $x$ \u65f6\uff0c\u5982\u679c\u5c06 $x$ \u7684\u6240\u6709\u7956\u5148\u7684 $s$ \u5168\u90fd\u52a0\u4e0a $g(x)$\uff0c\u90a3\u4e48\u5bf9\u4e8e\u4e00\u4e2a $y$\uff0c\u5176\u5bf9 $B$ \u7684\u8d21\u732e $= \\frac{S(y) - s(1)}{g(y)}$\u3002\n\n\u6811\u5256 + \u6811\u72b6\u6570\u7ec4\u5373\u53ef\u3002\n\n\u603b\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal O(n \\log^2 n)$\u3002\n\n```cpp\nconst int N = 1e5 + 7;\nint n, C, l[N], r[N], d[N], f[N], s[N], son[N], dfn[N], rnk[N], top[N], num;\nmodint g[N], vg[N], p, vp, now, A1, A2, A3, ans, c1[N], c2[N];\nvi e[N], L[N], R[N];\n\nvoid dfs(int x) {\n\ts[x] = 1;\n\tfor (ui i = 0; i < e[x].size(); i++) {\n\t\tint y = e[x][i];\n\t\tif (y == f[x]) continue;\n\t\td[y] = d[x] + 1;\n\t\tf[y] = x;\n\t\tdfs(y);\n\t\ts[x] += s[y];\n\t\tif (s[y] > s[son[x]]) son[x] = y; \n\t}\n}\n\nvoid dfs(int x, int p) {\n\ttop[x] = p;\n\tdfn[x] = ++num;\n\trnk[num] = x;\n\tif (!son[x]) return;\n\tdfs(son[x], p);\n\tfor (ui i = 0; i < e[x].size(); i++) {\n\t\tint y = e[x][i];\n\t\tif (y == f[x] || y == son[x]) continue;\n\t\tdfs(y, y);\n\t}\n}\n\ninline void add(modint *c, int x, modint k) {\n\twhile (x <= n + 1) c[x] += k, x += x & -x;\n}\n\ninline modint ask(modint *c, int x) {\n\tmodint ret = 0;\n\twhile (x) ret += c[x], x -= x & -x;\n\treturn ret;\n}\n\ninline void Add(int x, modint k) {\n\twhile (x) {\n\t\tadd(c1, dfn[top[x]], k);\n\t\tadd(c1, dfn[x] + 1, -k);\n\t\tadd(c2, dfn[top[x]], k * dfn[top[x]]);\n\t\tadd(c2, dfn[x] + 1, -k * (dfn[x] + 1));\n\t\tx = f[top[x]];\n\t}\n}\n\ninline modint Ask(int x) {\n\tmodint ret = -(ask(c1, 1) * 2 - ask(c2, 1));\n\twhile (x) {\n\t\tret += ask(c1, dfn[x]) * (dfn[x] + 1) - ask(c2, dfn[x]);\n\t\tret -= ask(c1, dfn[top[x]] - 1) * dfn[top[x]] - ask(c2, dfn[top[x]] - 1);\n\t\tx = f[top[x]];\n\t}\n\treturn ret;\n}\n\nint main() {\n\trd(n), p = 1;\n\tfor (int i = 1; i <= n; i++) {\n\t\trd(l[i]), rd(r[i]);\n\t\tg[i] = r[i] - l[i] + 1;\n\t\tvg[i] = g[i] ^ -1;\n\t\tp *= g[i];\n\t\tC = max(C, r[i]);\n\t\tL[l[i]].pb(i), R[r[i]].pb(i);\n\t}\n\tfor (int i = 1, x, y; i < n; i++)\n\t\trd(x), rd(y), e[x].pb(y), e[y].pb(x);\n\tvp = p ^ -1;\n\tdfs(1);\n\tdfs(1, 1);\n\tfor (int c = 1; c <= C; c++) {\n\t\tfor (ui i = 0; i < L[c].size(); i++) {\n\t\t\tint x = L[c][i];\n\t\t\tA1 += d[x] * vg[x];\n\t\t\tA2 += vg[x];\n\t\t\tA3 += d[x] * vg[x] * vg[x];\n\t\t\tnow += Ask(x) * vg[x];\n\t\t\tAdd(x, vg[x]);\n\t\t}\n\t\tans += A1 * A2 - A3 - 2 * now;\n\t\tfor (ui i = 0; i < R[c].size(); i++) {\n\t\t\tint x = R[c][i];\n\t\t\tA1 -= d[x] * vg[x];\n\t\t\tA2 -= vg[x];\n\t\t\tA3 -= d[x] * vg[x] * vg[x];\n\t\t\tAdd(x, -vg[x]);\n\t\t\tnow -= Ask(x) * vg[x];\n\t\t}\n\t}\n\tprint(ans * p);\n\treturn 0;\n}\n```",
        "postTime": 1575126117,
        "uid": 100544,
        "name": "xht",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 CF1260F \u3010Colored Tree\u3011"
    },
    {
        "content": "\uff08\u6309\u7167luogu\u7684\u5c3f\u6027\uff0c\u4f30\u8ba1\u5f0f\u5b50\u53c8\u4f1a\u6302\uff0c\u53ef\u4ee5\u5230\u535a\u5ba2\u67e5\u770b\uff09\n\n\u4e00\u5343\u4e2a\u4eba\u6709\u4e00\u5343\u96f6\u4e00\u79cd\u505a\u6cd5\u3002\n\n\u8bb0 $len_i=r_i-l_i+1,p=\\prod_i len_i$\u3002\n\n\u8003\u8651\u5bf9\u6bcf\u79cd\u989c\u8272\u7b97\u8d21\u732e\u3002\u90a3\u4e48\u989c\u8272 $h$ \u7684\u8d21\u732e\u4e3a\uff1a\n\n$\\sum_{l_i\\le h\\le r_i}\\sum_{l_j\\le h\\le r_j,j<i}dis(i,j)\\frac{p}{len_ilen_j}$\n\n\u628a ${dis}(i,j)$ \u62c6\u51fa\u6765\uff1a\n\n$\\sum_{l_i\\le h\\le r_i}\\sum_{l_j\\le h\\le r_j,j<i}[{dep}_i+{dep}_j-2{dep}_{{lca}(i,j)}]\\frac{p}{len_ilen_j}$\n\n\u628a\u4e00\u4e9b\u4e1c\u897f\u5f80\u524d\u632a\uff1a\n\n$\\sum_{l_i\\le h\\le r_i}\\frac{p}{len_i}\\sum_{l_j\\le h\\le r_j,j<i}[{dep}_i+{dep}_j-2{dep}_{{lca}(i,j)}]\\frac{1}{len_j}$\n\n\u6574\u7406\u4e00\u4e0b\uff1a\n\n$\\sum_{l_i\\le h\\le r_i}\\frac{p}{len_i}[({dep}_i\\sum_{l_j\\le h\\le r_j,j<i}\\frac{1}{len_j})+(\\sum_{l_j\\le h\\le r_j,j<i}\\frac{{dep}_j}{len_j})-2(\\sum_{l_j\\le h\\le r_j,j<i}\\frac{{dep}_{{lca}(i,j)}}{len_j})]$\n\n\u4ece $1$ \u5230 $100\\ 000$ \u53bb\u679a\u4e3e $h$\uff0c\u4e00\u4e2a\u70b9\u7684\u8d21\u732e\u81ea\u7136\u662f\u5728 \u52a0\u5165\u65f6\uff08$l$ \u65f6\u523b\uff09\u52a0\u4e0a\uff0c\u7136\u540e\u5728 \u5220\u9664\u65f6\uff08$r$ \u65f6\u523b\uff09\u51cf\u6389\u3002\n\n\u4e8e\u662f\u6211\u4eec\u8981\u7ef4\u62a4\u53f3\u8fb9\u90a3\u4e09\u5768\u4e1c\u897f\u3002\u524d\u9762\u4e24\u4e2a\u968f\u4fbf\u7ef4\u62a4\uff0c\u7b2c\u4e09\u4e2a\u91c7\u53d6 [\u8fd9\u9898](https://www.luogu.com.cn/problem/P4211) \u7684\u65b9\u6cd5\u7ef4\u62a4\u5373\u53ef\u3002\n\n\u4f7f\u7528\u6811\u5256\u5c31\u662f $O(n\\log^2 n)$ \u7684\uff0c\u7528 LCT \u5c31\u662f $O(n\\log n)$\u3002\n\n\u4e8e\u662f\u8fd9\u9898\u5c31\u505a\u5b8c\u4e86\u3002\n\n```cpp\n#include<bits/stdc++.h>\ntypedef long long ll;\nconst int N=1e5+3,M=1e9+7,K=18;\n#define Md (L+R>>1)\nstruct segment_tree{\n\tint s[1<<K],lz[1<<K];\n\tinline void Down(int L,int R,int k){\n\t\tlz[k<<1]=(lz[k<<1]+lz[k])%M;\n\t\tlz[k<<1|1]=(lz[k<<1|1]+lz[k])%M;\n\t\ts[k<<1]=(s[k<<1]+(ll)lz[k]*(Md-L+1))%M;\n\t\ts[k<<1|1]=(s[k<<1|1]+(ll)lz[k]*(R-Md))%M;\n\t\tlz[k]=0;\n\t}\n\tint Sum(int l,int r,int L,int R,int k){\n\t\tif(l>r)return 0;\n\t\tif(l<=L&&R<=r)return s[k];\n\t\tDown(L,R,k);\n\t\tif(l>Md)return Sum(l,r,Md+1,R,k<<1|1);\n\t\tif(r<=Md)return Sum(l,r,L,Md,k<<1);\n\t\treturn(Sum(l,r,L,Md,k<<1)+Sum(l,r,Md+1,R,k<<1|1))%M;\n\t}\n\tvoid Add(int l,int r,int a,int L,int R,int k){\n\t\tif(l>r)return;\n\t\tif(l<=L&&R<=r){\n\t\t  lz[k]=(lz[k]+a)%M;\n\t\t  s[k]=(s[k]+(ll)a*(R-L+1))%M;\n\t\t  return;\n\t\t}\n\t\tDown(L,R,k);\n\t\tif(l<=Md)Add(l,r,a,L,Md,k<<1);\n\t\tif(r>Md)Add(l,r,a,Md+1,R,k<<1|1);\n\t\ts[k]=(s[k<<1]+s[k<<1|1])%M;\n\t}\n}t;\nstruct edge{int v,nxt;}g[N+N];\nint n,head[N],k,dep[N],prod,invl[N],inv[N],s,s0,s1,ans,dfn[N],son[N],siz[N],top[N],fa[N];\ninline void Insert(int u,int v){g[++k]=(edge){v,head[u]};head[u]=k;}\nstruct update{\n\tint x,u,f;\n\tbool operator<(const update&b)const{return x<b.x;}\n}upd[N+N];\nvoid Dfs(int u){\n\tint v;\n\tsiz[u]=1;\n\tfor(int i=head[u];i;i=g[i].nxt)if((v=g[i].v)!=fa[u])\n\t  dep[v]=dep[u]+1,fa[v]=u,Dfs(v),siz[u]+=siz[v],son[u]=siz[son[u]]>siz[v]?son[u]:v;\n}\nvoid Dfs1(int u){\n\tint v;\n\tdfn[u]=++k,top[u]=top[u]?top[u]:u;\n\tif(son[u])top[son[u]]=top[u],Dfs1(son[u]);\n\tfor(int i=head[u];i;i=g[i].nxt)if((v=g[i].v)!=fa[u]&&v!=son[u])\n\t  Dfs1(v);\n}\ninline void Pathadd(int u,int a){\n\tfor(;u;u=fa[top[u]])\n\t  t.Add(dfn[top[u]==1?son[1]:top[u]],dfn[u],a,1,n,1);\n}\ninline int Pathsum(int u){\n\tint s=0;\n\tfor(;u;u=fa[top[u]])\n\t  s=(s+t.Sum(dfn[top[u]==1?son[1]:top[u]],dfn[u],1,n,1))%M;\n\treturn s;\n}\nint main(){\n\tint u,v,l,r,f;\n\tscanf(\"%d\",&n);\n\tinv[1]=1;for(int i=2;i<N;i++)inv[i]=(ll)inv[M%i]*(M-M/i)%M;\n\tprod=1;\n\tfor(u=1;u<=n;u++){\n\t  scanf(\"%d%d\",&l,&r);\n\t  invl[u]=inv[r-l+1];\n\t  prod=(ll)prod*(r-l+1)%M;\n\t  upd[u]=(update){l,u,1};\n\t  upd[u+n]=(update){r+1,u,M-1};\n\t}\n\tstd::sort(upd+1,upd+1+n+n);\n\tfor(int i=1;i<n;i++)scanf(\"%d%d\",&u,&v),Insert(u,v),Insert(v,u);\n\tDfs(1);\n\tk=0,Dfs1(1);\n\tfor(int i=1,j=1;i<N;i++){\n\t  for(;upd[j].x==i;j++){\n\t\tu=upd[j].u,f=upd[j].f;\n\t\ts0=(s0+(ll)invl[u]*f)%M;\n\t\ts1=(s1+(ll)invl[u]*dep[u]%M*f)%M;\n\t\tPathadd(u,(ll)invl[u]*f%M);\n\t\ts=(s+(ll)f*prod%M*invl[u]%M*(((ll)dep[u]*s0+s1-2*Pathsum(u)%M+M)%M))%M;\n\t  }\n\t  ans=(ans+s)%M;\n\t}printf(\"%d\\n\",ans);\n\treturn 0;\n}\n```",
        "postTime": 1583207867,
        "uid": 72487,
        "name": "Dreamunk",
        "ccfLevel": 9,
        "title": "CF1260F Colored Tree"
    },
    {
        "content": "\u5148\u8bf4\u51e0\u53e5\u95f2\u8bdd\u3002\n\n\u5148\u819c\u4e00\u4e0b\u697c\u4e0a xht\uff0cFuyuki \u7b49\u5404\u4f4d\u795e\u4ed9\uff0c\u4ed6\u4eec\u592a\u5f3a\u4e86\u3002\n\n\u8fd9\u662f\u9053\u795e\u9898\uff0c\u7136\u800c\u6211\u5e76\u4e0d\u4f1a\u6570\u636e\u7ed3\u6784\uff0c\u6240\u4ee5\u8fd9\u7bc7\u9898\u89e3**\u6ca1\u6709\u7528\u5230\u4efb\u4f55\u6570\u636e\u7ed3\u6784**\u3002\n\n~~\u4f46\u662f\u4e0d\u77e5\u9053\u4e3a\u4ec0\u4e48\u8fd8\u662f\u8dd1\u5f97\u6162\u6b7b\uff0c\u800c\u4e14\u4ee3\u7801\u8fd8\u6bd4 Fuyuki \u795e\u4ed9\u957f\u591a\u4e86~~\u2026\u2026\u6240\u4ee5\u7ee7\u7eed\u819c Fuyuki \u795e\u4ed9\u3002\n\n\u7136\u800c\u8fd9\u4e2a\u505a\u6cd5\u6211\u8ba4\u4e3a\u8fd8\u662f\u8fd9\u9053\u9898\u76ee\u524d\u6700\u597d\u60f3\u6700\u597d\u5199\u7684\u505a\u6cd5\u3002~~\u5c3d\u7ba1\u6211\u8c03\u4e86\u4e24\u5929\u3002~~\n\n~~\u54e6\u5bf9\u6211\u4e3a\u4ec0\u4e48\u8981\u6765\u505a\u8fd9\u9898\u5462\uff1f\u5176\u5b9e\u662f\u770b\u9519\u4e86\u67d0\u9898\u5355\u91cc\u67d0\u4e00\u9898\u7684\u9898\u53f7\u5566\uff08~~\n\n------------\n\u8fdb\u5165\u6b63\u9898\u3002\n\n\u9996\u5148\u8003\u8651\u5957\u8def\u70b9\u5206\u3002\u5148\u6c42\u51fa\u5f53\u524d\u5b50\u6811\u5185\u6240\u6709\u70b9 $i$ \u5230\u5206\u6cbb\u4e2d\u5fc3\u7684\u8ddd\u79bb $dep_i$\uff0c\u7136\u540e\u8ba1\u7b97\u6240\u6709\u70b9\u4e92\u76f8\u7684\u8d21\u732e\uff0c\u518d\u53bb\u5bb9\u65a5\u6389\u5206\u6cbb\u4e2d\u5fc3\u6240\u6709\u5b50\u6811\u7684\u8d21\u732e\u3002\n\n\u7136\u540e\u2026\u2026\u5c31\u4e0d\u4f1a\u4e86\u3002\u6211\u4eec\u53d1\u73b0\u4f3c\u4e4e\u5355\u72ec\u8003\u8651\u4e00\u4e2a\u70b9\u6ca1\u6cd5\u8ba1\u7b97\u6240\u6709\u70b9\u5bf9\u4ed6\u7684\u8d21\u732e\uff0c\u7136\u540e\u4e5f\u6ca1\u4ec0\u4e48\u597d\u7684\u529e\u6cd5\u53bb\u8ba1\u7b97\u6240\u6709\u70b9\u5bf9\u4e4b\u95f4\u7684\u8d21\u732e\u3002\n\n\u90a3\u6211\u4eec\u4e0d\u59a8\u6362\u4e2a\u601d\u8def\uff0c\u53bb\u8003\u8651\u6bcf\u79cd\u989c\u8272\u3002\n\n\u6240\u4ee5\u6211\u4eec**\u5bf9\u989c\u8272\u505a\u626b\u63cf\u7ebf**\u3002\u5c06\u6240\u6709\u70b9\u5dee\u5206\u6210\u51fa\u73b0\u548c\u6d88\u5931\u4e24\u4e2a\u4e8b\u4ef6\uff0c\u7136\u540e\u6392\u5e8f\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5355\u72ec\u8ba1\u7b97\u6bcf\u4e2a\u989c\u8272\u7684\u8d21\u732e\u4e86\u3002\n\n\u8fd9\u6837\u7684\u8bdd\uff0c\u5047\u8bbe\u5f53\u524d\u6240\u6709\u88ab\u8003\u8651\u5230\u7684\u70b9\u7684\u96c6\u5408\u4e3a $S$\uff0c\u5219\u8d21\u732e\u4e3a\n$$\\sum\\limits_{i,j\\in S,i<j}(dep_i+dep_j)\\prod\\limits_{k=1}^n[k\\ne i,j](r_k-l_k+1)$$\n\u7136\u540e\uff01\u662f\u7684\u6211\u4eec\u5c31\u53ef\u4ee5\u5f00\u59cb\u6109\u5feb\u5730\u63a8\u5f0f\u5b50\u4e86\uff01\n\n\u9996\u5148\u8bb0 $len_i=r_i-l_i+1$\uff0c\u7136\u540e\u5c31\u628a $\\prod\\limits_{i=1}^nlen_i$ \u63d0\u5230\u4e00\u8fb9\u53bb\u6700\u540e\u518d\u7b97\uff0c\u8fd9\u6837\u7684\u8bdd\u5c31\u53d8\u6210\n$$\\sum\\limits_{i,j\\in S,i<j}\\frac{dep_i+dep_j}{len_ilen_j}$$\n\u5047\u88c5\u6bcf\u4e2a\u70b9\u53ef\u4ee5\u4e0e\u5b83\u81ea\u5df1\u9020\u6210\u8d21\u732e\uff08\u53cd\u6b63\u4e5f\u4f1a\u5728\u7b97\u5b50\u6811\u7684\u65f6\u5019\u88ab\u5bb9\u65a5\u6389\uff09\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u628a\u6bcf\u4e2a $dep$ \u5206\u5f00\u7b97\u8d21\u732e\u4e86\uff0c\u6bcf\u4e2a\u70b9 $i$ \u7684\u8d21\u732e\u5c31\u662f\n$$\\sum\\limits_{j\\in S}\\frac{dep_i}{len_ilen_j}=\\frac{dep_i}{len_i}\\sum\\limits_{j\\in S}\\frac1{len_j}$$\n\u90a3\u4e48\u603b\u7684\u8d21\u732e\u5c31\u662f\n$$\\sum\\limits_{i\\in S}\\frac{dep_i}{len_i}\\sum\\limits_{i\\in S}\\frac1{len_i}$$\n\u6240\u4ee5\u6211\u4eec\u5bf9\u989c\u8272\u505a\u626b\u63cf\u7ebf\uff0c\u7ef4\u62a4 $\\sum\\limits_{i\\in S}\\frac{dep_i}{len_i}$ \u548c $\\sum\\limits_{i\\in S}\\frac1{len_i}$\u3002\n\n\u590d\u6742\u5ea6 $O(n\\log^2n)$\u3002\u4ee3\u7801\u968f\u624b\u5199\u7684\uff0c\u7801\u98ce\u6bd4\u8f83\u4e11\uff0c\u8f7b\u55b7\u3002\n```cpp\n#include<algorithm>\n#include<vector>\n#include<cctype>\n#include<cstdio>\nusing namespace std;\ninline int readint(){\n    int x=0;\n    bool f=0;\n    char c=getchar();\n    while(!isdigit(c)&&c!='-') c=getchar();\n    if(c=='-'){\n        f=1;\n        c=getchar();\n    }\n\twhile(isdigit(c)){\n        x=x*10+c-'0';\n        c=getchar();\n    }\n    return f?-x:x;\n}\nconst int maxn=1e5+5;\nint n,l[maxn],r[maxn];\nvector<int> g[maxn];\ntypedef long long ll;\nconst ll mod=1e9+7;\nll inv[maxn];\nbool vis[maxn];\nint size[maxn];\nvoid dfs1(int u,int fa){\n\tsize[u]=1;\n\tfor(int i=0;i<g[u].size();i++){\n\t\tint v=g[u][i];\n\t\tif(v==fa||vis[v]) continue;\n\t\tdfs1(v,u);\n\t\tsize[u]+=size[v];\n\t}\n}\nint cen,res;\nvoid dfs2(int u,int fa,int r){\n\tint maxs=size[r]-size[u];\n\tfor(int i=0;i<g[u].size();i++){\n\t\tint v=g[u][i];\n\t\tif(v==fa||vis[v]) continue;\n\t\tdfs2(v,u,r);\n\t\tmaxs=max(maxs,size[v]);\n\t}\n\tif(!cen||maxs<res){\n\t\tcen=u;\n\t\tres=maxs;\n\t}\n}\nint dep[maxn];\nvoid dfs3(int u,int fa){\n\tdep[u]=dep[fa]+1;\n\tfor(int i=0;i<g[u].size();i++){\n\t\tint v=g[u][i];\n\t\tif(v==fa||vis[v]) continue;\n\t\tdfs3(v,u);\n\t}\n}\ntypedef pair<int,int> pii;\nvoid dfs4(int u,int fa,vector<pii>& res){\n\tres.push_back(pii(l[u],u));\n\tres.push_back(pii(r[u]+1,-u));\n\tfor(int i=0;i<g[u].size();i++){\n\t\tint v=g[u][i];\n\t\tif(v==fa||vis[v]) continue;\n\t\tdfs4(v,u,res);\n\t}\n}\nll calc(int u){\n\tvector<pii> res;\n\tdfs4(u,0,res);\n\tsort(res.begin(),res.end());\n\tll ans=0,s1=0,s2=0;\n\tfor(int i=0;i<res.size()-1;i++){\n\t\tint v=res[i].second;\n\t\tif(v>0){\n\t\t\tll g=inv[r[v]-l[v]+1];\n\t\t\ts1=(s1+dep[v]*g%mod)%mod;\n\t\t\ts2=(s2+g)%mod;\n\t\t}\n\t\telse{\n\t\t\tv=-v;\n\t\t\tll g=inv[r[v]-l[v]+1];\n\t\t\ts1=(s1+mod-dep[v]*g%mod)%mod;\n\t\t\ts2=(s2+mod-g)%mod;\n\t\t}\n\t\tans=(ans+s1*s2%mod*(res[i+1].first-res[i].first)%mod)%mod;\n\t}\n\treturn ans;\n}\nll solve(int u){\n\tdfs3(u,0);\n\tll ans=calc(u);\n\tvis[u]=1;\n\tfor(int i=0;i<g[u].size();i++){\n\t\tint v=g[u][i];\n\t\tif(vis[v]) continue;\n\t\tans=(ans+mod-calc(v))%mod;\n\t}\n\tfor(int i=0;i<g[u].size();i++){\n\t\tint v=g[u][i];\n\t\tif(vis[v]) continue;\n\t\tdfs1(v,0);\n\t\tcen=0;\n\t\tdfs2(v,0,v);\n\t\tans=(ans+solve(cen))%mod;\n\t}\n\treturn ans;\n}\nint main(){\n    #ifdef LOCAL\n    freopen(\"in.txt\",\"r\",stdin);\n    freopen(\"out.txt\",\"w\",stdout);\n    #endif\n    n=readint();\n    for(int i=1;i<=n;i++){\n    \tl[i]=readint();\n    \tr[i]=readint();\n\t}\n\tfor(int i=1;i<n;i++){\n\t\tint u,v;\n\t\tu=readint();\n\t\tv=readint();\n\t\tg[u].push_back(v);\n\t\tg[v].push_back(u);\n\t}\n\tinv[1]=1;\n\tfor(int i=2;i<maxn;i++)\n\t\tinv[i]=inv[mod%i]*(mod-mod/i)%mod;\n\tdfs1(1,0);\n\tcen=0;\n\tdfs2(1,0,1);\n\tdep[0]=-1;\n\tll ans=solve(cen);\n\tfor(int i=1;i<=n;i++) ans=ans*(r[i]-l[i]+1)%mod;\n\tprintf(\"%d\\n\",(int)ans);\n    return 0;\n}\n```\n\u8fd9\u4e48\u597d\u7684\u9898\u89e3\uff0c\u786e\u5b9a\u4e0d\u70b9\u4e2a\u8d5e\u518d\u8d70\u5417\uff1f",
        "postTime": 1585825776,
        "uid": 174045,
        "name": "FZzzz",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF1260F \u3010Colored Tree\u3011"
    },
    {
        "content": "\u8fd9\u9898\u6709\u70b9\u548cLNOI \u5f97 LCA\u90a3\u9898\u7c7b\u4f3c\n\n\u6ca1\u4eba\u5199LCT\u5417qwq\n\n\u663e\u7136\u7a9d\u4eec\u662f\u8981\u6c42\uff1a\n\n$\\Pi_{i=1}^{n}(r_i-l_i+1) \\sum\\limits\n_{i=1}^{n}\\sum\\limits_{j=i+1}^{n}|[max(l_i,l_j),min(r_i,r_j)]|dis(i,j)\\frac{1}{(r_i-l_i+1)(r_j-l_j+1)}$\n\n\u89e3\u91ca\u4e00\u4e0b\uff1a\u5c31\u662f\u679a\u4e3e\u4e24\u4e2a\u70b9$i$ \u4e0e$j$\u4e4b\u95f4\u5f97\u8d21\u732e\uff0c\u5f53\u4e24\u4e2a\u70b9\u53bb\u989c\u8272\u76f8\u540c\u65f6\u5176\u5b83\u70b9\u4efb\u610f\u53d6\uff0c\u518d\u4e58$dis(i,j)$\n\n\u4e5f\u5c31\u662f\u8bf4\u7a9d\u4eec\u8981\u52a8\u6001\u7ef4\u62a4\u4e00\u4e2a\u70b9\u96c6$S$\uff0c\u652f\u6301\u52a8\u6001\u52a0\u5165\u70b9\u4e0e\u5220\u9664\u70b9\n\n\u5b9e\u65f6\u7ef4\u62a4$\\sum\\limits_{i,j\\in S}\\frac{dis(i,j)}{(r_i-l_i+1)(r_j-l_j+1)}$\n\n\u4e0b\u9762\u8bb0$len_i=r_i-l_i+1$\n\n\u8003\u8651\u52a8\u6001\u52a0\u5165\u4e00\u4e2a\u70b9$u$\uff0c\u4ecb\u4e2a\u70b9\u4e0e\u70b9\u96c6\u4e2d\u5176\u4ed6\u70b9\u4ea7\u751f\u7684\u8d21\u732e\u5982\u4e0b\n\n$\\frac{1}{len_u}\\sum_{i \\in S}\\frac{dep_i+dep_u-2dep_{lca(u,i)}}{len_i}$\n\n$\\sum_{i \\in S}\\frac{dep_i}{len_i}$\u4e0e$dep_u\\sum_{i \\in S}\\frac{1}{len_i}$\u90fd\u597d\u7ef4\u62a4\n\n\u540e\u9762\u90a3\u90e8\u5206\u8bfb\u8005\u9614\u4ee5\u5148\u505a\u4e00\u4e0bP4211\n\n\u52a0\u5165\u4e00\u4e2a\u70b9\u65f6\uff0c\u7a9d\u4eec\u5728\u8fd9\u4e2a\u70b9$i$\u5230\u6839\u5f97\u8def\u5f84\u4e0a\u5f97\u6bcf\u4e2a\u70b9\u90fd\u52a0$\\frac{1}{len_i}$\n\n\u6700\u540e\u67e5\u8be2\u4e00\u4e2a\u70b9$u$\u7684$\\sum_{i \\in S}\\frac{dep_{lca(u,i)}}{len_i}$\u5176\u5b9e\u5c31\u662f\u67e5\u8be2$u$\u5230\u6839\u6240\u6709\u70b9\u70b9\u6743\u548c\n\n\u4e8e\u662fLCT\u7ef4\u62a4\u4e4b\uff0c\u90fd\u4e0d\u7528\u6362\u6839\n\nLCT\u4e11\u5417qwq\n\n\u590d\u6742\u5ea6$O(nlogn)$\n```cpp\n#include <bits/stdc++.h>\n#define rep(i,j,k) for(i=j;i<=k;++i)\n#define dow(i,j,k) for(i=j;i>=k;--i)\n#define LL long long\n#define D_ double\n#define sz(X) (int)(X.size())\n#define itr iterator\n#define mkp std::make_pair\n#define pr std::pair\n#define fi first\n#define se second\nconst LL md=1e9+7;\ninline LL fmul(LL x,LL y,const LL P){\n    /*LL res=0;\n    while(y){\n        if(y&1)res+=x,res%=P;\n        x+=x;x%=P;y>>=1;\n    }\n    return res;\n    */\n    //return (x*y-(LL)((long double)x/P*y)*P+P)%P;\n    return (x*y)%P;\n}\ninline LL fpw(LL x,LL y,const LL modol){\n    if(x==modol-1)return y&1 ? modol-1:1;\n    LL res=1;while(y){if(y&1)res=fmul(res,x,modol);x=fmul(x,x,modol);y>>=1;}return res%modol;\n}\nLL exgcd(LL& x,LL& y,LL a,LL b){\n    if(!b){x=1;y=0;return a;}\n    LL res=exgcd(y,x,b,a%b);y-=x*(a/b);return res;\n}\ninline LL ad(LL x,LL y,const LL md){\n    return x+y>=md ? x+y-md:x+y;\n}\ninline LL sub(LL x,LL y,const LL md){\n    return x<y ? md+x-y:x-y;\n}\ninline LL inv(LL o,const LL modol){\n    LL x,y;exgcd(x,y,o,modol);\n    x=(x%modol+modol)%md;return x;\n}\nint read(){\n    int x=0,f=1;char ch=getchar();\n    while(ch<'0'||ch>'9') {if(ch=='-')f=-1;ch=getchar();}\n    while(ch>='0'&&ch<='9'){x=x*10+ch-'0';ch=getchar();}\n    return f*x;\n}\nLL mmax(LL x,LL y){return x>y ? x:y;}\nLL mmin(LL x,LL y){return x<y ? x:y;}\nconst int N=1e5+10;\nint l[N],r[N],n;\nstruct edge{\n\tint nxt,to;\n}e[N<<1];\nint head[N],pos;\nvoid add(int u,int v){e[++pos]=(edge){head[u],v};head[u]=pos;}\n#define son(u,v) tr[u].ch[v]\n#define fu(u) tr[u].f_\nint stk[N],dep[N];\nnamespace lct{\n\tstruct node{\n\t\tint ch[2],f_,siz;LL s,v,ts;\n\t}tr[N];\n\tvoid pushup(int u){\n\t\ttr[u].siz=tr[son(u,0)].siz+tr[son(u,1)].siz+1;\n\t\ttr[u].s=ad(ad(tr[son(u,0)].s,tr[son(u,1)].s,md),tr[u].v,md);\n\t}\n\tvoid fuck(int u,LL d){if(!u)return;\n\t\ttr[u].ts=ad(tr[u].ts,d,md);\n\t\ttr[u].v=ad(tr[u].v,d,md);\n\t\ttr[u].s=ad(tr[u].s,fmul(d,tr[u].siz,md),md);\n\t}\n\tvoid pushdown(int u){\n\t\tif(tr[u].ts){\n\t\t\tfuck(son(u,0),tr[u].ts);fuck(son(u,1),tr[u].ts);\n\t\t\ttr[u].ts=0;\n\t\t}\n\t}\n\tbool isrt(int u){return son(fu(u),0)!=u && son(fu(u),1)!=u;}\n\tint gt(int u){return son(fu(u),1)==u;}\n\tvoid rotate(int D){\n\t\tint B=fu(D),A=fu(B),w1=gt(D),w2=gt(B);\n\t\tif(!isrt(B))son(A,w2)=D;\n\t\tson(B,w1)=son(D,w1^1);fu(son(D,w1^1))=B;\n\t\tson(D,w1^1)=B;fu(B)=D;fu(D)=A;pushup(B);pushup(D);\n\t}\n\tvoid splay(int u){\n\t\tstk[0]=0;stk[++stk[0]]=u;\n\t\tfor(int x=u;!isrt(x);x=fu(x))stk[++stk[0]]=fu(x);\n\t\twhile(stk[0])pushdown(stk[stk[0]--]);\n\t\tfor(int ft=fu(u);!isrt(u);rotate(u),ft=fu(u)){\n\t\t\tif(!isrt(ft))rotate(gt(ft)==gt(u) ? ft:u);\n\t\t}\n\t\tpushup(u);\n\t}\n\tvoid access(int u){\n\t\tfor(int y=0;u;y=u,u=fu(u)){\n\t\t\tsplay(u);son(u,1)=y;pushup(u);\n\t\t}\n\t}\n}\nvoid dfs(int u,int fa){\n\tint i;dep[u]=dep[fa]+1;\n\tfor(i=head[u];i;i=e[i].nxt){\n\t\tint v=e[i].to;if(v==fa)continue;\n\t\tlct::fu(v)=u;dfs(v,u);\n\t}\n}\nstd::vector<int>st[N],ed[N];\nLL ans,pans,sd,sl;\nvoid ad(int u){\n\tlct::access(u);lct::splay(u);\n\tLL sum=lct::tr[u].s;\n\tLL tmp=0;\n\ttmp=ad(sd,fmul(sl,dep[u],md),md);\n\ttmp=sub(tmp,fmul(2,sum,md),md);\n\ttmp=fmul(tmp,inv(r[u]-l[u]+1,md),md);\n\tpans=ad(pans,tmp,md);\n\tsd=ad(sd,fmul(dep[u],inv(r[u]-l[u]+1,md),md),md);\n\tsl=ad(sl,inv(r[u]-l[u]+1,md),md);\n\ttmp=inv(r[u]-l[u]+1,md);\n\tlct::fuck(u,tmp);\n}\nvoid del(int u){\n\tlct::access(u);lct::splay(u);\n\tsd=sub(sd,fmul(dep[u],inv(r[u]-l[u]+1,md),md),md);\n\tsl=sub(sl,inv(r[u]-l[u]+1,md),md);\n\tLL tmp=inv(r[u]-l[u]+1,md);\n\tlct::fuck(u,sub(0,tmp,md));\n\ttmp=0;\n\tLL sum=lct::tr[u].s;\n\ttmp=ad(sd,fmul(sl,dep[u],md),md);\n\ttmp=sub(tmp,fmul(2,sum,md),md);\n\ttmp=fmul(tmp,inv(r[u]-l[u]+1,md),md);\n\tpans=sub(pans,tmp,md);\n}\nint main(){//freopen(\"in.txt\",\"r\",stdin);\n\tint i;n=read();\n\trep(i,1,n)l[i]=read(),r[i]=read();\n\trep(i,2,n){\n\t\tint x,y;x=read();y=read();\n\t\tadd(x,y);add(y,x);\n\t}\n\tdfs(1,0);\n\trep(i,1,n)st[l[i]].push_back(i),ed[r[i]+1].push_back(i);\n\tstd::vector<int>::itr it;\n\trep(i,1,1e5){\n\t\tfor(it=st[i].begin();it!=st[i].end();++it)ad(*it);\n\t\tfor(it=ed[i].begin();it!=ed[i].end();++it)del(*it);\n\t\tans=ad(ans,pans,md);\n\t}\n\trep(i,1,n)ans=fmul(ans,r[i]-l[i]+1,md);\n\tstd::cout<<ans;\n}\n\n```\n",
        "postTime": 1580194975,
        "uid": 24370,
        "name": "meiqwq",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF1260F \u3010Colored Tree\u3011"
    },
    {
        "content": "## Describtion\n\n\u7ed9\u5b9a\u4e00\u68f5\u6811\uff0c\u6bcf\u4e2a\u8282\u70b9\u6709\u4e00\u4e2a\u989c\u8272$h$\uff0c$h_i$\u4e3a$[L_i,R_i]$\u5185\u7684\u4e00\u4e2a\u6574\u6570\u3002\n\n\u73b0\u5728\uff0c\u5bf9\u4e8e\u6240\u6709$\\prod (R_i-L_i+1)$\u79cd\u4e0d\u540c\u7684\u67d3\u8272\u65b9\u6848\uff0c\u6c42\u51fa\u4e0b\u5217\u5f0f\u5b50\u4e4b\u548c\uff1a\n\n$$\\sum_{h_i=h_j,1\\leq i<j\\leq n}dis(i,j)$$\n\n$n\\leq 10^5,1\\leq L_i\\leq R_i\\leq 10^5$\uff0c\u7b54\u6848\u5bf91e9+7\u53d6\u6a21\u3002\n\n## Solution\n\nCER\u771f\u662f\u5bb9\u6613\u964d\u667a\u3002\n\n\u6309\u60ef\u4f8b\u628a$dis(i,j)$\u62c6\u6210$dep_i+dep_j-2dep_{lca(i,j)}$\u3002\n\n\u90a3\u4e48\u5206\u522b\u8003\u8651\u4e00\u4e2a\u70b9\u4f5c\u4e3a\u7aef\u70b9\u7684\u8d21\u732e\u548c\u4f5c\u4e3alca\u7684\u8d21\u732e\u3002\n\n\u4f5c\u4e3a\u7aef\u70b9\u7684\u8d21\u732e\u5c31\u662f\u548c\u81ea\u5df1\u989c\u8272\u76f8\u540c\u7684\u70b9\u7684\u4e2a\u6570\uff0c\u8fd9\u91cc\u6bcf\u4e2a\u989c\u8272\u6bcf\u4e2a\u70b9\u5206\u522b\u8d21\u732e\u72ec\u7acb\uff0c\u505a\u4e00\u4e2a\u533a\u95f4\u6c42\u548c\u5373\u53ef\u3002\n\n\u4f5c\u4e3alca\u7684\u8d21\u732e\u76f8\u5f53\u4e8e\u8de8\u5b50\u6811\u4e4b\u95f4\u5728\u989c\u8272\u4e0a\u505a\u70b9\u4e58\uff0c\u8fd9\u4e2a\u7528dsu on tree\u5904\u7406\u4e4b\u540e\u70b9\u4e58\u7684\u8d21\u732e\u4e4b\u548c\u4e5f\u53ef\u4ee5\u8f6c\u5316\u6210\u533a\u95f4\u6c42\u548c\u3002\n\n\u7528\u6811\u72b6\u6570\u7ec4\u5904\u7406\u7684\u8bdd\u8dd1\u5230\u4e86CF rank1\u3002\n\n```cpp\n#include<cstdio>\n#include<iostream>\n#include<algorithm>\nusing namespace std;\n#define rnt re int\n#define re register\n#define I inline int\n#define V inline void\n#define isnum(ch) ('0'<=ch&&ch<='9')\n#define FOR(i,a,b) for(rnt i=a;i<=b;i++)\n#define REP(u) for(rnt _=h[u],v;v=e[_].t,_;_=e[_].n)if(v^pre[u])\n#define gc (_op==_ed&&(_ed=(_op=_buf)+fread(_buf,1,100000,stdin),_op==_ed)?EOF:*_op++)\nchar _buf[100000],*_op(_buf),*_ed(_buf);\nI getint(){\n\trnt _s=0;re char _ch=gc;\n\twhile(!isnum(_ch))_ch=gc;\n\twhile(isnum(_ch))_s=_s*10+_ch-48,_ch=gc;\n\treturn _s;\n}\nconst int N=1e5+1,mod=1e9+7;\nV check(int&x){x-=mod,x+=x>>31&mod;}\nint n,ans,tot,sum,now,len[N],h[N],w[N];\nint a[N],b[N],c[N],d[N],inv[N],pre[N],siz[N],wes[N],dep[N];\nstruct edge{int t,n;}e[N<<1];\nV add_edge(rnt x,rnt y){\n\te[++tot]=(edge){y,h[x]},h[x]=tot;\n\te[++tot]=(edge){x,h[y]},h[y]=tot;\n}\nV input(){\n\tn=getint();rnt x,y;\n\tFOR(i,1,n)a[i]=getint(),b[i]=getint(),len[i]=b[i]-a[i]+1;\n\tFOR(i,2,n)x=getint(),y=getint(),add_edge(x,y);\n}\nV init(rnt u){\n\tsiz[u]=1,dep[u]=dep[pre[u]]+1;\n\tREP(u){\n\t\tpre[v]=u,init(v),siz[u]+=siz[v];\n\t\tif(siz[v]>siz[wes[u]])wes[u]=v;\n\t}\n}\nI lowbit(const int&x){return x&-x;}\nV add(rnt x,rnt y){\n\tfor(rnt w=1ll*x*y%mod;x<N;x+=lowbit(x))\n\t\tcheck(c[x]+=w),check(d[x]+=y);\n}\nI ask(rnt x){\n\trnt out=0,tmp=0;\n\tfor(rnt i=x;i;i^=lowbit(i))\n\t\tcheck(tmp+=d[i]),check(out+=c[i]);\n\tcheck(out=1ll*(x+1)*tmp%mod+mod-out);\n\treturn out;\n}\nV add(rnt l,rnt r,rnt x){add(l,x),add(r+1,mod-x);}\nI ask(rnt l,rnt r){return (ask(r)-ask(l-1)+mod)%mod;}\nV init(){\n\tinv[0]=1,inv[1]=1,sum=1,init(1);\n\tFOR(i,2,N-1)inv[i]=1ll*(mod-mod/i)*inv[mod%i]%mod;\n\tFOR(i,1,n)sum=1ll*sum*len[i]%mod;\n\tFOR(i,1,n)add(a[i],b[i],w[i]=1ll*sum*inv[len[i]]%mod);\n\tFOR(i,1,n)check(ans+=1ll*(mod+ask(a[i],b[i])-sum)*inv[len[i]]%mod*dep[i]%mod);\n\tFOR(i,1,N-1)c[i]=d[i]=0;\n}\nV once(rnt u){check(ans+=mod-2ll*now*ask(a[u],b[u])%mod*inv[len[u]]%mod);}\nV clean(rnt u){add(a[u],b[u],mod-w[u]);REP(u)clean(v);}\nV calc(rnt u){once(u);REP(u)calc(v);}\nV add(rnt u){add(a[u],b[u],w[u]);REP(u)add(v);}\nV dfs(rnt u){\n\tREP(u)if(v!=wes[u])dfs(v),clean(v);\n\tif(wes[u])dfs(wes[u]);\n\tnow=dep[u],once(u),add(a[u],b[u],w[u]);\n\tREP(u)if(v!=wes[u])calc(v),add(v);\n}\nV work(){dfs(1),cout<<ans;}\nint main(){\n\tinput();\n\tinit();\n\twork();\n\treturn 0;\n}\n```\n",
        "postTime": 1574933342,
        "uid": 109236,
        "name": "Fuyuki",
        "ccfLevel": 10,
        "title": "CF1260F \u9898\u89e3"
    },
    {
        "content": "\u4ee4 $len_i=r_i-l_i=1$\uff0c$all=\\prod len_i$\uff0c\u5982\u679c\u4e00\u5bf9\u70b9 $(x,y)$ \u82e5\u90fd\u80fd\u67d3\u6210\u989c\u8272 $c$\uff0c\u5219\u5bf9\u7b54\u6848\u8d21\u732e $dis(x,y)\\frac{all}{len_xlen_y}$\uff0e\n\n\u5bf9\u989c\u8272\u7f16\u53f7\u7ef4\u8fdb\u884c\u626b\u63cf\u7ebf\uff0c\u73b0\u5728\u95ee\u9898\u5c31\u662f\u6bcf\u6b21\u5c06\u4e00\u4e2a\u70b9\u67d3\u6210\u9ed1\u8272\u6216\u8005\u767d\u8272\u3002\u6c42\u6240\u6709\u9ed1\u8272\u70b9\u5bf9 $(x,y)$ \u7684 $dis(x,y)\\frac{all}{len_xlen_y}$ \u4e4b\u548c\u3002\n\n\u4e0a\u70b9\u5206\u6811\uff0c\u5c31\u628a $(dep_x+dep_y)\\frac{all}{len_xlen_y}$ \u62c6\u6210 $\\frac{dep_xall}{len_x}\\cdot \\frac{1}{len_y}$ \u548c $\\frac{all}{len_x}\\cdot \\frac{dep_y}{len_y}$\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u5206\u6cbb\u4e2d\u5fc3\u7edf\u8ba1\u5176\u4f5c\u4e3a\u5206\u6cbb\u4e2d\u5fc3\u7684\u8fde\u901a\u5757\u4e2d\u9ed1\u70b9\u7684 $\\frac{1}{len_y}$ \u548c $\\frac{dep_y}{len_y}$ \u7684\u548c\u5373\u53ef\u3002\u8981\u53bb\u91cd\u6240\u4ee5\u8fd8\u9700\u8981\u7edf\u8ba1\u5206\u6cbb\u4e2d\u5fc3\u7684\u5404\u4e2a\u5b50\u6811\u5185\u90e8\u7684\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}((n+r)\\log n)$\uff0e\n\n\u867d\u7136\u662f\u4e00\u53ea log\uff0c\u4f46\u662f\u5e38\u6570\u597d\u50cf\u7279\u522b\u5927\uff0c\u4e5f\u6709\u53ef\u80fd\u662f\u70b9\u5206\u6811\u5199\u4e11\u4e86\u3002\n\n```cpp\n#include<cstdio>\n#include<vector>\n#include<queue>\n#include<cstring>\n#include<iostream>\n#include<algorithm>\n#include<ctime>\n#include<random>\n#include<set>\n#include<map>\n#include<unordered_map>\n#include<assert.h>\n#define pb emplace_back\n#define mp make_pair\n#define fi first\n#define se second\n#define dbg(x) cerr<<\"In Line \"<< __LINE__<<\" the \"<<#x<<\" = \"<<x<<'\\n'\n#define dpi(x,y) cerr<<\"In Line \"<<__LINE__<<\" the \"<<#x<<\" = \"<<x<<\" ; \"<<\"the \"<<#y<<\" = \"<<y<<'\\n'\nusing namespace std;\ntypedef long long ll;\ntypedef unsigned long long ull;\ntypedef pair<int,int>pii;\ntypedef pair<ll,int>pli;\ntypedef pair<ll,ll>pll;\ntypedef pair<int,ll>pil;\ntypedef vector<int>vi;\ntypedef vector<ll>vll;\ntypedef vector<pii>vpii;\ntypedef vector<pil>vpil;\ntemplate<typename T>T cmax(T &x, T y){return x=x>y?x:y;}\ntemplate<typename T>T cmin(T &x, T y){return x=x<y?x:y;}\ntemplate<typename T>\nT &read(T &r){\n\tr=0;bool w=0;char ch=getchar();\n\twhile(ch<'0'||ch>'9')w=ch=='-'?1:0,ch=getchar();\n\twhile(ch>='0'&&ch<='9')r=r*10+(ch^48),ch=getchar();\n\treturn r=w?-r:r;\n}\ntemplate<typename T1,typename... T2>\nvoid read(T1 &x,T2& ...y){read(x);read(y...);}\nconst int mod=1000000007;\ninline void cadd(int &x,int y){x=(x+y>=mod)?(x+y-mod):(x+y);}\ninline void cdel(int &x,int y){x=(x-y<0)?(x-y+mod):(x-y);}\ninline int add(int x,int y){return (x+y>=mod)?(x+y-mod):(x+y);}\ninline int del(int x,int y){return (x-y<0)?(x-y+mod):(x-y);}\nint qpow(int x,int y){\n\tint s=1;\n\twhile(y){\n\t\tif(y&1)s=1ll*s*x%mod;\n\t\tx=1ll*x*x%mod;\n\t\ty>>=1;\n\t}\n\treturn s;\n}\nconst int N=100010;\nint n;\nint ans,sum;\nint l[N],r[N],len[N],il[N],all=1,mxr;\nint s1[N*3],s2[N*3],tot;\nvi eg[N];\nvpii vec[N];\nint rt,rs,siz[N],mx[N],vis[N];\nint fa[N];\nunordered_map<int,int>dep[N],bl[N];\nvoid getrt(int x,int fa){\n\tsiz[x]=mx[x]=1;\n\tfor(auto v:eg[x]){\n\t\tif(v==fa||vis[v])continue;\n\t\tgetrt(v,x);\n\t\tsiz[x]+=siz[v];\n\t\tcmax(mx[x],siz[v]);\n\t}\n\tcmax(mx[x],rs-siz[x]);\n\tif(mx[x]<mx[rt])rt=x;\n}\nvoid dfs1(int x,int fa,int t){\n\tdep[t][x]=dep[t][fa]+1;\n\tbl[t][x]=tot;\n\tfor(auto v:eg[x])\n\t\tif(!vis[v]&&v!=fa)\n\t\t\tdfs1(v,x,t);\n}\nvoid dfz(int x){\n\tvis[x]=1;\n\tfor(auto v:eg[x])if(!vis[v]){\n\t\t++tot;\n\t\tdfs1(v,x,x);\n\t}\n\tint tmp=rs;\n\tfor(auto v:eg[x])if(!vis[v]){\n\t\trs=siz[v]>siz[x]?tmp-siz[x]:siz[v];\n\t\trt=0;\n\t\tgetrt(v,x);\n\t\tfa[rt]=x;\n\t\tdfz(rt);\n\t}\n}\nvoid Ins(int x){\n\tint t=x;\n\twhile(t){\n\t\tint p=bl[t][x];\n\t\tcadd(sum,1ll*dep[t][x]*il[x]%mod*all%mod*s1[t]%mod);\n\t\tcadd(sum,1ll*all*il[x]%mod*s2[t]%mod);\n\t\t//\n\t\tif(t!=x){\n\t\t\tcdel(sum,1ll*dep[t][x]*il[x]%mod*all%mod*s1[p]%mod);\n\t\t\tcdel(sum,1ll*all*il[x]%mod*s2[p]%mod);\n\t\t}\n\t\t//\n\t\tcadd(s1[t],il[x]);\n\t\tcadd(s2[t],1ll*dep[t][x]*il[x]%mod);\n\t\tif(t!=x){\n\t\t\tcadd(s1[p],il[x]);\n\t\t\tcadd(s2[p],1ll*dep[t][x]*il[x]%mod);\n\t\t}\n\t\tt=fa[t];\n\t}\n}\nvoid Del(int x){\n\tint t=x;\n\twhile(t){\n\t\tint p=bl[t][x];\n\t\tcdel(s1[t],il[x]);\n\t\tcdel(s2[t],1ll*dep[t][x]*il[x]%mod);\n\t\tif(t!=x){\n\t\t\tcdel(s1[p],il[x]);\n\t\t\tcdel(s2[p],1ll*dep[t][x]*il[x]%mod);\n\t\t}\n\t\t//\n\t\tcdel(sum,1ll*dep[t][x]*il[x]%mod*all%mod*s1[t]%mod);\n\t\tcdel(sum,1ll*all*il[x]%mod*s2[t]%mod);\n\t\t//\n\t\tif(t!=x){\n\t\t\tcadd(sum,1ll*dep[t][x]*il[x]%mod*all%mod*s1[p]%mod);\n\t\t\tcadd(sum,1ll*all*il[x]%mod*s2[p]%mod);\n\t\t}\n\t\tt=fa[t];\n\t}\n}\nsigned main(){\n\t#ifdef do_while_true\n//\t\tassert(freopen(\"data.in\",\"r\",stdin));\n//\t\tassert(freopen(\"data.out\",\"w\",stdout));\n\t#endif\n\tread(n);\n\tfor(int i=1;i<=n;i++){\n\t\tread(l[i],r[i]);cmax(mxr,r[i]);\n\t\tlen[i]=r[i]-l[i]+1;\n\t\tall=1ll*all*len[i]%mod;\n\t\til[i]=qpow(len[i],mod-2);\n\t\tvec[l[i]].pb(mp(i,1));\n\t\tvec[r[i]+1].pb(mp(i,-1));\n\t}\n\tfor(int i=1,u,v;i<n;i++){\n\t\tread(u,v);\n\t\teg[u].pb(v);eg[v].pb(u);\n\t}\n\ttot=n;\n\tmx[rt=0]=N;rs=n;\n\tgetrt(1,0);\n\tdfz(rt);\n\tfor(int o=1;o<=mxr;o++){\n\t\tfor(auto i:vec[o])\n\t\t\tif(i.se==1)Ins(i.fi);\n\t\t\telse Del(i.fi);\n\t\tcadd(ans,sum);\n\t}\n\tcout << ans << '\\n';\n    #ifdef do_while_true\n\t\tcerr<<'\\n'<<\"Time:\"<<1.0*clock()/CLOCKS_PER_SEC*1000<<\" ms\"<<'\\n';\n\t#endif\n\treturn 0;\n}\n```",
        "postTime": 1667741770,
        "uid": 223298,
        "name": "do_while_true",
        "ccfLevel": 8,
        "title": "\u300c\u9898\u89e3\u300dCodeforces 1260F Colored Tree"
    },
    {
        "content": "\u63d0\u4f9b\u53e6\u4e00\u79cd\u65e0\u8111\u70b9\u5206\u7684\u505a\u6cd5\u3002\n\n\u9996\u5148\u8003\u8651\u4e00\u4e9b\u7b80\u5355\u7684\u624b\u6cd5\uff1a\n\n$$\\sum_{ \\large{ \\forall t  \\in [1,n]_{\\mathbb N} ,c_t\\in[l_t,r_t] } }\\sum_{i=1}^n\\sum_{j=i+1}^n \\text{dis}(i,j)[c_i=c_j]$$\n$$= \\sum_{i=1}^n\\sum_{j=i+1}^n\\text{dis}(i,j)\\sum_{ \\large{ \\forall t  \\in [1,n]_{\\mathbb N} ,c_t\\in[l_t,r_t] } } [c_i=c_j]\n$$\n\n\u4ee4$\\mathbf I_i=[l_i,r_i]_{\\mathbb N}$\u8868\u793a\u4e00\u4e2a\u989c\u8272\u533a\u95f4\uff0c\u90a3\u4e48\u539f\u5f0f\u53ef\u4ee5\u8f6c\u5316\u4e3a\uff1a\n\n$$\n\\sum_{i=1}^n\\sum_{j=i+1}^n\\text{dis}(i,j)\\times  \\frac{ \\prod_{k=1}^n |\\mathbf I_k| }{ |\\mathbf{I}_i||\\mathbf{I}_j| } \\times \\Bigg| \\mathbf I_i\\bigcap \\mathbf I_j \\Bigg|\n$$\n$$\n= \\left(\\prod_{k=1}^n |\\mathbf I_k|\\right)\\times  \\sum_{i=1}^n\\sum_{j=i+1}^n\\text{dis}(i,j)\\times  \\frac{ \\big| \\mathbf I_i\\bigcap \\mathbf I_j \\big| }{ |\\mathbf{I}_i||\\mathbf{I}_j| }\n$$\n\n\u8003\u8651\u70b9\u5206\u6cbb\uff0c\u663e\u7136\u53ea\u9700\u8ba1\u7b97\u5f0f\u5b50\u7684\u540e\u534a\u90e8\u5206\uff0c\u4e0d\u59a8\u8bbe\u5f53\u524d\u5206\u6cbb\u91cd\u5fc3\u4e3a$c$\uff0c\u90a3\u4e48\u540e\u5f0f\u5373\u4e3a\uff1a\n\n$$\n\\Big (\\mathrm{dis}(c,x)+\\mathrm{dis}(c,y) \\Big)\\times  \\frac{ \\big| \\mathbf I_x\\bigcap \\mathbf I_y \\big| }{ |\\mathbf{I}_x||\\mathbf{I}_y| }\n$$\n$$\n= \\frac{1}{|\\mathbf I_x|}\\left (\\mathrm{dis}(c,x)\\times  \\frac{ \\big| \\mathbf I_x\\bigcap \\mathbf I_y \\big| }{ |\\mathbf{I}_y| } +\\mathrm{dis}(c,y)\\times  \\frac{ \\big| \\mathbf I_x\\bigcap \\mathbf I_y \\big| }{ |\\mathbf{I}_y| } \\right)\n$$\n\n\u8fd9\u65f6\u5019\u53ef\u4ee5\u628a\u533a\u95f4\u4ea4$|\\mathbf I_x\\cap\\mathbf I_y|$\u653e\u5230\u6570\u636e\u7ed3\u6784\u91cc\u9762\u6765\u5904\u7406\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u6211\u4eec\u53ea\u9700\u8003\u8651\u5176\u4ed6\u90e8\u5206\u7684\u8d21\u732e\uff0c\u8fd9\u4e2a\u7cfb\u6570\u5c31\u5c31\u8ba9\u533a\u95f4\u6570\u636e\u7ed3\u6784\u81ea\u52a8\u7d2f\u52a0\u4e0a\u3002\n\n\u5177\u4f53\u5730\uff0c\u7ef4\u62a4\u4e24\u9897\u6811\u72b6\u6570\u7ec4$T_1,T_2$\uff0c$T_1$**\u4ee5\u533a\u95f4\u4e3a\u4e0b\u6807** \u4fdd\u5b58 \u5df2\u52a0\u5165\u7684\u5b50\u6811 **\u4e2d\u6240\u6709\u70b9$y$\u7684$|\\mathbf I_y|^{-1}$\u4e4b\u548c**\uff0c$T_2$**\u4ee5\u533a\u95f4\u4e3a\u4e0b\u6807** \u4fdd\u5b58 \u5df2\u52a0\u5165\u7684\u5b50\u6811 **\u4e2d\u6240\u6709\u70b9$y$\u7684$\\mathrm{dis}(c,y)\\times |\\mathbf I_y|^{-1}$\u4e4b\u548c**\u3002\u6839\u636e\u70b9\u5206\u7684\u601d\u8def\uff0c\u6211\u4eec\u5728\u52a0\u5165\u4e00\u68f5\u5b50\u6811\u524d \u5148\u8ba1\u7b97\u5b50\u6811\u5185\u6bcf\u4e00\u4e2a\u70b9 \u4e0e \u524d\u9762\u5b50\u6811\u70b9 \u7684\u8d21\u732e\uff0c\u53ea\u9700\u5728\u6811\u72b6\u6570\u7ec4\u5185\u533a\u95f4\u67e5\u8be2\u5373\u53ef\u5f97\u5230\u8d21\u732e\u3002\n\n\u4e3b\u8981\u4ee3\u7801\u5982\u4e0b\uff1a\n\n```cpp\nstruct BinaryIndexedTree {\n\tmodint c1[N], c2[N]; int n; BinaryIndexedTree(int _n = 0) { n = _n; }\n\tinline int Lowbit(int x) { return x & (-x); }\n\tinline void Modify(int p,modint v) { for (int i = p; i <= n; i += Lowbit(i)) c1[i] += v, c2[i] += modint(p) * v; }\n\tinline void Modify(int l,int r,modint v) { Modify( l, v ), Modify( r+1, modint( mod - v.x ) ); }\n\tinline modint Query(int p) { modint s(0); for (int i = p; i; i -= Lowbit(i)) s += modint(p+1) * c1[i] - c2[i]; return s; }\n\tinline modint Query(int l,int r) { return Query(r) - Query(l-1); }\n} T1, T2;\n\nint n, t, Head[N], l[N], r[N], Max; modint Ans, Inv[N];\nint dep[N], flag[N], sz[N], g[N], rt, tot;\n\ninline void Insert(int x,int y) { e[++t] = (Edge) { y, Head[x] }, Head[x] = t; }\n\ninline void Findroot(int x,int Fa) { \n\tsz[x] = 1, g[x] = 0;\n\tfor (int i = Head[x], y; i; i = e[i].next)\n\t\tif ( !flag[ y = e[i].ver ] && y != Fa ) \n\t\t\tFindroot(y,x), sz[x] += sz[y], g[x] = max( g[x], sz[y] );\n\tg[x] = max( g[x], tot - sz[x] ), ( g[x] >= g[rt] ?: rt = x );\n}\n\ninline void Modify(int x,int Fa,modint op) {\n\tmodint _Inv = Inv[ r[x] - l[x] + 1 ];\n\tT1.Modify( l[x], r[x], _Inv * op );\n\tT2.Modify( l[x], r[x], _Inv * op * modint(dep[x]) );\n\tfor (int i = Head[x], y; i; i = e[i].next)\n\t\tif ( !flag[ y = e[i].ver ] && y != Fa ) Modify(y,x,op);\n}\n\ninline void Calc(int x,int Fa) {\n\tmodint val = T1.Query(l[x],r[x]) * modint(dep[x]) + T2.Query(l[x],r[x]);\n\tAns = Ans + val * Inv[ r[x] - l[x] + 1 ];\n\tfor (int i = Head[x], y; i; i = e[i].next)\n\t\tif ( !flag[ y = e[i].ver ] && y != Fa ) Calc(y,x);\n}\n\ninline int Inter(int l1,int r1,int l2,int r2) { return max( min(r1,r2) - max(l1,l2) + 1, 0 ); }\n\ninline void Dfs(int x,int Fa,int rt) {\n\tdep[x] = dep[Fa] + 1;\n\tmodint val = modint(Inter(l[x],r[x],l[rt],r[rt])) * modint(dep[x]);\n\tAns += val * Inv[ r[x] - l[x] + 1 ] * Inv[ r[rt] - l[rt] + 1 ];\n\tfor (int i = Head[x], y; i; i = e[i].next)\n\t\tif ( !flag[ y = e[i].ver ] && y != Fa ) Dfs(y,x,rt);\n}\n\ninline void Divide(int x) {\n\tflag[x] = true, dep[0] = -1, Dfs(x,0,x);\n\tfor (int i = Head[x], y; i; i = e[i].next)\n\t\tif ( !flag[ y = e[i].ver ] ) Calc(y,x), Modify(y,x,modint(1));\n\tfor (int i = Head[x], y; i; i = e[i].next)\n\t\tif ( !flag[ y = e[i].ver ] ) Modify(y,x,modint(mod-1));\n\tfor (int i = Head[x], y; i; i = e[i].next)\n\t\tif ( !flag[ y = e[i].ver ] ) \n\t\t\ttot = sz[y], rt = 0, Findroot(y,0), Divide(rt);\n}\n\nint main(void) {\n\tscanf( \"%d\", &n );\n\tfor (int i = 1; i <= n; i++) \n\t\tscanf( \"%d%d\", &l[i], &r[i] ), Max = max( Max, r[i] );\n\tInv[1] = modint(1);\n\tfor (int i = 2; i <= Max; i++) \n\t\tInv[i] = modint( mod - mod/i ) * Inv[mod%i];\n\tT1 = T2 = BinaryIndexedTree(Max);\n\tfor (int i = 1, u, v; i < n; i++)\n\t\tscanf( \"%d%d\", &u, &v ), Insert(u,v), Insert(v,u);\n\tg[ rt = 0 ] = 1e9, tot = n, Findroot(1,0), Divide(rt);\n\tfor (int i = 1; i <= n; i++) Ans = Ans * modint(r[i]-l[i]+1);\n\treturn printf( \"%d\\n\", Ans.x ) * 0; \n}\n```\n\n",
        "postTime": 1606568277,
        "uid": 59327,
        "name": "Parsnip",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF1260F \u3010Colored Tree\u3011"
    }
]