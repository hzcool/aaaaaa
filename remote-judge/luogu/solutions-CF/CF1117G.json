[
    {
        "content": "\u56e0\u4e3a\u6211\u6bd4\u8f83\u83dc\uff0c\u6240\u4ee5\u6211\u7528\u7684\u662f\u7b1b\u5361\u5c14\u6811\u3002\n\n\u89c2\u5bdf $f(l,r)$ \u7684\u5f0f\u5b50\uff0c\u53ef\u4ee5\u53d1\u73b0\u5b83\u5c31\u662f\u628a\u533a\u95f4 $[l,r]$ \u4e2d\u7684\u6570\u62ff\u51fa\u6765\u5efa\u7b1b\u5361\u5c14\u6811\uff0c\u6811\u4e0a\u6240\u6709\u8282\u70b9\u7684\u6df1\u5ea6\u4e4b\u548c\u3002\n\n\u663e\u7136\u6211\u4eec\u4e0d\u80fd\u5bf9\u4e8e\u6bcf\u6b21\u8be2\u95ee\u90fd\u5efa\u4e00\u68f5\u7b1b\u5361\u5c14\u6811\uff0c\u6240\u4ee5\u6211\u4eec\u5c1d\u8bd5\u5728\u6574\u4e2a\u6570\u7ec4\u7684\u7b1b\u5361\u5c14\u6811\u4e0a\u505a\u4e9b\u6587\u7ae0\u3002\u4f46\u5982\u679c\u6211\u4eec\u628a\u4e00\u4e2a\u533a\u95f4\u5728\u6574\u4e2a\u6570\u7ec4\u7684\u7b1b\u5361\u5c14\u6811\u4e0a\u8868\u793a\u51fa\u6765\uff0c\u533a\u95f4\u4e2d\u7684\u8282\u70b9\u53ef\u80fd\u975e\u5e38\u5206\u6563\uff0c\u4e0d\u597d\u5904\u7406\u3002\u90a3\u8be5\u600e\u4e48\u529e\u5462 qwq\n\n\u89c2\u5bdf[\u7ebf\u6027\u6784\u5efa\u7b1b\u5361\u5c14\u6811\u7684\u7b97\u6cd5](https://www.luogu.com.cn/problem/P5854)\uff0c\u5b83\u662f\u4e00\u4e2a\u5728\u7ebf\u7b97\u6cd5\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u6240\u6709\u533a\u95f4 $[1,r]\\ (1\\le r\\le n)$ \u7684\u7b1b\u5361\u5c14\u6811\u3002\u6211\u4eec\u5c1d\u8bd5\u628a\u533a\u95f4 $[l,r]$ \u5728 $[1,r]$ \u7684\u7b1b\u5361\u5c14\u6811\u4e0a\u8868\u793a\u51fa\u6765\u3002\n\n\u8bb0\u533a\u95f4 $[l,r]$ \u4e2d\u6700\u5927\u503c\u7684\u51fa\u73b0\u4f4d\u7f6e\u4e3a $m$\uff0c\u5219\u5bf9\u4e8e\u533a\u95f4 $[l,r]$ \u7684\u7b1b\u5361\u5c14\u6811\uff0c$m$ \u662f\u5b83\u7684\u6839\u8282\u70b9\uff0c\u6839\u8282\u70b9\u7684\u53f3\u5b50\u6811\u662f\u533a\u95f4 $[m+1,r]$ \u7684\u7b1b\u5361\u5c14\u6811\u3002\n\n\u8003\u8651\u53e6\u4e00\u79cd\u6784\u5efa\u7b1b\u5361\u5c14\u6811\u7684\u7b97\u6cd5\uff1a\u6bcf\u6b21\u53d6\u51fa\u5f53\u524d\u533a\u95f4\u7684\u6700\u5927\u503c\uff0c\u7136\u540e\u9012\u5f52\u5904\u7406\u5de6\u53f3\u533a\u95f4\u3002\u90a3\u4e48\u5bf9\u4e8e\u533a\u95f4 $[1,r]$ \u7684\u7b1b\u5361\u5c14\u6811\uff0c$m$ \u4e00\u5b9a\u662f $[l,r]$ \u4e2d\u6700\u5148\u88ab\u53d6\u51fa\u7684\uff0c\u5373 $m$ \u7684\u6df1\u5ea6\u662f $[l,r]$ \u4e2d\u6700\u5c0f\u7684\u3002$m$ \u88ab\u53d6\u51fa\u540e\uff0c$[m+1,r]$ \u5c31\u6210\u4e3a\u4e86\u5b83\u7684\u53f3\u533a\u95f4\uff0c\u5373 $m$ \u7684\u53f3\u5b50\u6811\u662f\u533a\u95f4 $[m+1,r]$ \u7684\u7b1b\u5361\u5c14\u6811\u3002\n\n\u53ef\u4ee5\u53d1\u73b0\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u533a\u95f4 $[1,r]$ \u7684\u7b1b\u5361\u5c14\u6811\u4e0a\u5f97\u5230\u533a\u95f4 $[m+1,r]$ \u7684\u7b1b\u5361\u5c14\u6811\u3002\u5bf9\u4e8e\u533a\u95f4 $[l,m-1]$ \u7684\u7b1b\u5361\u5c14\u6811\uff0c\u53ef\u4ee5\u628a\u6574\u4e2a\u6570\u7ec4\u7ffb\u8f6c\uff0c\u7528\u540c\u6837\u7684\u65b9\u6cd5\u5f97\u5230\u3002\u5b83\u4eec\u5408\u8d77\u6765\u5c31\u662f\u533a\u95f4 $[l,r]$ \u7684\u7b1b\u5361\u5c14\u6811\u3002\n\n\u90a3\u4e48\u6211\u4eec\u5728\u6784\u5efa\u7b1b\u5361\u5c14\u6811\u65f6\uff0c\u8981\u52a8\u6001\u4fee\u6539\u6bcf\u4e2a\u8282\u70b9\u7684\u6df1\u5ea6\uff0c\u5e76\u67e5\u8be2\u533a\u95f4 $[m+1,r]$ \u4e2d\u6240\u6709\u8282\u70b9\u7684\u6df1\u5ea6\u4e4b\u548c\u4ee5\u53ca $m$ \u7684\u6df1\u5ea6\uff08\u7531\u4e8e $m$ \u7684\u6df1\u5ea6\u4e0d\u4e00\u5b9a\u4e3a $1$\uff0c\u8981\u6ce8\u610f\u51cf\u6389 $m$ \u7684\u6df1\u5ea6\u5e26\u6765\u7684\u5f71\u54cd\uff09\u3002\u8fd9\u662f\u4e00\u4e2a\u533a\u95f4\u52a0\u3001\u533a\u95f4\u6c42\u548c\u7684\u95ee\u9898\uff0c\u7528\u6811\u72b6\u6570\u7ec4\u6216\u7ebf\u6bb5\u6811\u7ef4\u62a4\u5373\u53ef\u3002\n\n\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\u5c31\u662f\u5982\u4f55\u5feb\u901f\u627e\u5230 $m$\u3002\u8003\u8651\u5355\u8c03\u6808\u7ef4\u62a4\u7684\u662f\u4ece\u6839\u8282\u70b9\u5f00\u59cb\u4e0d\u65ad\u5f80\u53f3\u513f\u5b50\u8d70\u5f62\u6210\u7684\u94fe\u3002\u7531\u4e8e $r$ \u4e00\u5b9a\u5728\u8fd9\u6761\u94fe\u4e0a\uff0c\u4e14 $r$ \u5728 $m$ \u7684\u53f3\u5b50\u6811\u4e2d\uff0c\u6240\u4ee5 $m$ \u4e5f\u5728\u8fd9\u6761\u94fe\u4e0a\u3002\u7531\u4e8e $m$ \u7684\u6df1\u5ea6\u662f $[l,r]$ \u4e2d\u6700\u5c0f\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u5728\u5355\u8c03\u6808\u4e0a\u4e8c\u5206\uff0c\u7b2c\u4e00\u4e2a\u6ee1\u8db3\u7f16\u53f7 $\\ge l$ \u7684\u8282\u70b9\u5c31\u662f $m$\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}((n+q)\\log n)$\u3002\n\n```cpp\n#include <cstdio>\n#include <cstring>\n#include <algorithm>\nusing namespace std;\ntypedef long long ll;\nint n,m,a[1000005],stk[1000005],top; //\u8fde\u5de6\u53f3\u513f\u5b50\u90fd\u4e0d\u7528\u8bb0\u5f55\nll sum[1000005],sum2[1000005],ans[1000005];\nstruct qry{\n\tint l,r,id;\n}q[1000005];\ninline bool cmp(qry x,qry y){\n\treturn x.r<y.r;\n}\ninline void modify(ll *a,int x,ll y){\n\tfor(;x<=n;x+=x&-x)a[x]+=y;\n}\ninline ll query(ll *a,int x){\n\tll res=0;\n\tfor(;x;x&=x-1)res+=a[x];\n\treturn res;\n}\ninline void Modify(int l,int r,ll x){\n\tmodify(sum,l,x);\n\tmodify(sum2,l,x*l);\n\tmodify(sum,r+1,-x);\n\tmodify(sum2,r+1,-x*(r+1));\n}\ninline ll Query(int l,int r){\n\treturn (r+1)*query(sum,r)-query(sum2,r)-l*query(sum,l-1)+query(sum2,l-1);\n}\nint main(){\n\tscanf(\"%d%d\",&n,&m);\n\tfor(int i=1;i<=n;++i)\n\t\tscanf(\"%d\",a+i);\n\tfor(int i=1;i<=m;++i)\n\t\tscanf(\"%d\",&q[i].l);\n\tfor(int i=1;i<=m;++i){\n\t\tscanf(\"%d\",&q[i].r);\n\t\tq[i].id=i;\n\t\tans[i]=q[i].r-q[i].l+1;\n\t}\n\tsort(q+1,q+1+m,cmp);\n\tfor(int i=1,j=1,pre,x;i<=n;++i){\n\t\tpre=top;\n\t\twhile(top && a[i]>a[stk[top]])--top;\n\t\tif(top)Modify(i,i,Query(stk[top],stk[top])+1);\n\t\telse Modify(i,i,1);\n\t\tif(top!=pre)Modify(stk[top]+1,i-1,1);\n\t\tstk[++top]=i;\n\t\twhile(j<=m && q[j].r==i){\n\t\t\tx=*lower_bound(stk+1,stk+1+top,q[j].l);\n\t\t\tans[q[j].id]+=Query(x+1,i)-(i-x)*Query(x,x);\n\t\t\t++j;\n\t\t}\n\t}\n\treverse(a+1,a+1+n);\n\tfor(int i=1;i<=m;++i){\n\t\tswap(q[i].l,q[i].r);\n\t\tq[i].l=n-q[i].l+1;\n\t\tq[i].r=n-q[i].r+1;\n\t}\n\tsort(q+1,q+1+m,cmp);\n\tmemset(sum,0,sizeof(sum));\n\tmemset(sum2,0,sizeof(sum2));\n\ttop=0;\n\tfor(int i=1,j=1,pre,x;i<=n;++i){\n\t\tpre=top;\n\t\twhile(top && a[i]>a[stk[top]])--top;\n\t\tif(top)Modify(i,i,Query(stk[top],stk[top])+1);\n\t\telse Modify(i,i,1);\n\t\tif(top!=pre)Modify(stk[top]+1,i-1,1);\n\t\tstk[++top]=i;\n\t\twhile(j<=m && q[j].r==i){\n\t\t\tx=*lower_bound(stk+1,stk+1+top,q[j].l);\n\t\t\tans[q[j].id]+=Query(x+1,i)-(i-x)*Query(x,x);\n\t\t\t++j;\n\t\t}\n\t}\n\tfor(int i=1;i<=m;++i)\n\t\tprintf(\"%lld%c\",ans[i],\" \\n\"[i==m]);\n\treturn 0;\n}\n```\n",
        "postTime": 1621697550,
        "uid": 154520,
        "name": "chen_03",
        "ccfLevel": 9,
        "title": "CF1117G Recursive Queries \u9898\u89e3"
    },
    {
        "content": "\n\n> \u7ed9\u51fa\u4e00\u4e2a\u957f\u4e3a n \u7684\u6392\u5217\uff0c\u6bcf\u6b21\u7ed9\u51fa\u8be2\u95ee $[l_i,r_i]$\uff08\u53ef\u4ee5\u79bb\u7ebf\uff09\uff0c\u6c42 $f(l_i,r_i)$\uff1a\n> $$\n> f(l,r)=\\begin{cases}\n> (r-l+1)+f(l,m_{l,r}-1)+f(m_{l,r}+1,r)\\quad &(l\\le r)\\\\\n> 0\\quad &(l > r)\n> \\end{cases}\n> $$\n>\n> $m_{l,r}$ \u4e3a $[l,r]$ \u7684\u6700\u5927\u503c\u7684\u4f4d\u7f6e\u3002\n\n## \u601d\u8def\n\n### \u8f6c\u5316\u9898\u610f\n\n\u7ed9\u51fa\u7684\u5f0f\u5b50\u5e94\u8be5\u5f88\u597d\u7406\u89e3\u5427\uff0c\u5c31\u662f\u533a\u95f4\u6700\u5927\u503c\u5c06\u533a\u95f4\u5206\u5f00\uff0c\u9012\u5f52\u4e0b\u53bb\u3002\n\n\u90a3\u4e48\u4e00\u4e2a\u533a\u95f4\u7684\u6700\u5927\u503c\u4e5f\u5c31\u4ee3\u8868\u8fd9\u4e2a\u533a\u95f4\uff0c\u5176\u8d21\u732e\u4e3a\u533a\u95f4\u957f\u5ea6\u3002\n\n\u6700\u540e\u8be5\u533a\u95f4\u7684\u7b54\u6848\u5c31\u662f\u6bcf\u4e2a\u70b9\u7684\u8d21\u732e\u4e4b\u548c\u3002\n\n\u8bbe i \u5de6\u8fb9\u7b2c\u4e00\u4e2a\u5927\u4e8e $a_i$ \u7684\u4f4d\u7f6e\u4e3a $lb(i)$\uff0c\u53f3\u8fb9\u7b2c\u4e00\u4e2a\u5927\u4e8e $a_i$ \u7684\u4f4d\u7f6e\u4e3a $rb(i)$\uff0c\uff08\u82e5\u65e0\u8be5\u4f4d\u7f6e\uff0c$lb(i)=0,rb(i)=n+1$\uff09\u3002\n\n\u5176\u5b9e\u5c31\u662f\u8981\u7edf\u8ba1\uff1a\n\n$$\n\\sum_{i=l}^r\\min(rb(i)-1,r)-\\max(lb(i)+1,l)+1\n$$\n\n### \u9884\u5904\u7406 $lb(i),rb(i)$\n\n\u5229\u7528**\u5355\u8c03\u6808** $O(n)$ \u5904\u7406\u5373\u53ef\u3002\n\n```cpp\nint top = 0;\nfor (int i = 1; i <= n; ++i) {\n    while (top && a[stk[top]] < a[i])\n        rb[stk[top--]] = i;\n    lb[i] = stk[top];\n    stk[++top] = i;\n}\nwhile (top) rb[stk[top--]] = n + 1;\n```\n\n### \u79bb\u7ebf\u7edf\u8ba1\n\n\u73b0\u5c06\u6bcf\u4e2a\u70b9\u7684\u8d21\u732e**\u62c6\u5f00**\uff0c\u5206\u522b\u7edf\u8ba1 $lb(i),rb(i)$\uff0c\u9700\u8981\u533a\u95f4\u6c42\u548c\u3002\n\n\u4ee5\u7edf\u8ba1 $lb(i)$ \u4e3a\u4f8b\uff1a\n\n\u6ce8\u610f\u5230\u5982\u679c $i\\in [l,r],lb(i)+1<l$\uff0c\u8be5\u70b9\u8d21\u732e\u4e3a $l$\u3002\n\n\u6211\u4eec\u5c06\u6240\u6709\u8be2\u95ee\u79bb\u7ebf\u4e0b\u6765\uff0c\u56fa\u5b9a l\uff0c\u5bf9\u6bcf\u4e2a r \u533a\u95f4\u6c42\u548c\u3002\n\n\u6bcf\u6b21\u5411\u53f3\u79fb\u52a8 l\uff0c\u6240\u6709 $lb(i)=l$ \u7684\u4f4d\u7f6e\u7684\u8d21\u732e\u90fd\u5e94\u8be5\u6539\u4e3a l\u3002\n\n\u90a3\u4e48\u5c31\u628a\u8fd9\u4e9b\u4f4d\u7f6e\u53bb\u6389\u8d21\u732e\uff0c\u6253\u4e0a tag\uff0c\u6bcf\u6b21\u7edf\u8ba1\u7b54\u6848\u65f6\uff0c\u7edf\u8ba1\u533a\u95f4\u6709 tag \u7684\u4e2a\u6570\u53e6\u5916\u8ba1\u7b97\u3002\n\n\u5355\u70b9\u4fee\u6539\uff0c\u533a\u95f4\u67e5\u8be2\uff0c\u5f00\u4e24\u68f5**\u6811\u72b6\u6570\u7ec4**\u5206\u522b\u7ef4\u62a4 $lb(i)$ \u7684\u8d21\u732e\u548c tag \u4e2a\u6570\u3002\n\n\u7edf\u8ba1 $rb(i)$ \u7684\u8d21\u732e\u540c\u7406\uff0c**\u5012\u7740**\u505a\u5c31\u884c\u3002\n\n## \u4ee3\u7801\n\n```cpp\n#include <vector>\n#include <cstdio>\n#include <cctype>\n#include <cstring>\n#include <algorithm>\nusing namespace std;\n\nnamespace RenaMoe {\ntemplate <typename TT> inline void read(TT &x) {}\n\ntypedef long long LL;\nconst int N = 1e6 + 9;\n\nstruct Ask {\n\tint l, r;\n};\n\nint n, m;\nint a[N], lb[N], rb[N], stk[N];\nLL ans[N];\nAsk q[N];\nvector<int> qry[N], del[N]; // qry[i]\uff1a\u5de6\u7aef\u70b9\u4e3ai\u7684\u8be2\u95ee\uff0cdel[i]\uff1alb\u4e3ai\u7684\u4f4d\u7f6e\n\nstruct Bit {\n\tLL tr[N];\n\tinline void clear() {\n\t\tmemset(tr, 0, sizeof tr);\n\t}\n\tinline void update(int x, LL k) {\n\t\tfor (int i = x; i <= n; i += i & -i)\n\t\t\ttr[i] += k;\n\t}\n\tinline LL query(int x) {\n\t\tLL re = 0;\n\t\tfor (int i = x; i; i -= i & -i)\n\t\t\tre += tr[i];\n\t\treturn re;\n\t}\n} tr1, tr2;\n\nint main() {\n\tread(n), read(m);\n\tfor (int i = 1; i <= n; ++i) read(a[i]);\n\tfor (int i = 1; i <= m; ++i) read(q[i].l);\n\tfor (int i = 1; i <= m; ++i) read(q[i].r);\n\t\n    // \u5355\u8c03\u6808\u6c42lb[i],rb[i]\n\tint top = 0;\n\tfor (int i = 1; i <= n; ++i) {\n\t\twhile (top && a[stk[top]] < a[i])\n\t\t\trb[stk[top--]] = i;\n\t\tif (top) lb[i] = stk[top];\n\t\tstk[++top] = i;\n\t}\n\twhile (top) rb[stk[top--]] = n + 1;\n\n\tfor (int i = 1; i <= n; ++i)\n\t\tdel[lb[i]].push_back(i);\n\tfor (int i = 1; i <= m; ++i)\n\t\tqry[q[i].l].push_back(i);\n\tfor (int i = 1; i <= n; ++i)\n\t\ttr1.update(i, lb[i]); // \u6ce8\u610f+1-1\u7684\u7ec6\u8282\n\tfor (int i = 1; i <= n; ++i) {\n        // \u6e05\u9664\u8d21\u732e\uff0c\u6253tag\n\t\tfor (int j = 0; j < del[i-1].size(); ++j) {\n\t\t\ttr1.update(del[i-1][j], -lb[del[i-1][j]]);\n\t\t\ttr2.update(del[i-1][j], 1);\n\t\t}\n\t\tfor (int j = 0; j < qry[i].size(); ++j) {\n\t\t\tint id = qry[i][j];\n\t\t\tans[id] -= tr1.query(q[id].r) - tr1.query(q[id].l-1);\n\t\t\tans[id] -= (LL)(i - 1) * (tr2.query(q[id].r) - tr2.query(q[id].l-1));\n\t\t}\n\t}\n    \n\tfor (int i = 0; i <= n; ++i)\n\t\tdel[i].clear(), qry[i].clear();\n\tfor (int i = 1; i <= n; ++i)\n\t\tdel[rb[i]].push_back(i);\n\tfor (int i = 1; i <= m; ++i)\n\t\tqry[q[i].r].push_back(i);\n\ttr1.clear(), tr2.clear();\n\tfor (int i = 1; i <= n; ++i)\n\t\ttr1.update(i, rb[i]-1);\n\tfor (int i = n; i; --i) {\n\t\tfor (int j = 0; j < del[i+1].size(); ++j) {\n\t\t\ttr1.update(del[i+1][j], -rb[del[i+1][j]]+1);\n\t\t\ttr2.update(del[i+1][j], 1);\n\t\t}\n\t\tfor (int j = 0; j < qry[i].size(); ++j) {\n\t\t\tint id = qry[i][j];\n\t\t\tans[id] += tr1.query(q[id].r) - tr1.query(q[id].l-1);\n\t\t\tans[id] += (LL)i * (tr2.query(q[id].r) - tr2.query(q[id].l-1));\n\t\t}\n\t}\n\n\tfor (int i = 1; i <= m; ++i)\n\t\tprintf(\"%lld \", ans[i]);\n\tputs(\"\");\n    return 0;\n}\n```\n\n",
        "postTime": 1598270899,
        "uid": 52243,
        "name": "RenaMoe",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 CF1117G \u3010Recursive Queries\u3011"
    },
    {
        "content": "> CF1117G\n\n> \u9898\u610f\uff1a\u7ed9\u51fa\u957f\u5ea6\u4e3a $n$ \u7684\u6392\u5217\uff0c\u5047\u8bbe $m_{l,r}$ \u4e3a\u533a\u95f4 $[l,r]$ \u4e2d\u6700\u5927\u503c\u5bf9\u5e94\u7684**\u4e0b\u6807**\uff0c\u5b9a\u4e49\u51fd\u6570 $f(l,r)=$\n\n> $$\\begin{cases}(r-l+1)+f(l,m_{l,r}-1)+f(m_{l,r}+1,r)&\\text{$l \\leq r$}\\\\0&\\text{l > r}\\end{cases}$$\n\n> \u6709 $q$ \u6b21\u8be2\u95ee\uff0c\u6bcf\u4e00\u6b21\u8ba9\u4f60\u6c42\u51fa $f(l_i,r_i)$ \u7684\u503c\u3002\n\n> $1 \\leq n,q \\leq 10^6$\n\n\u53c8\u662f\u6811\u72b6\u6570\u7ec4\u7684\u795e\u4ed9\u64cd\u4f5c\u3002\n\n\u6211\u4eec\u8bb0 $L_i$ \u4e3a\u6ee1\u8db3 $j<i,a_j>a_i$ \u7684\u6700\u5927\u7684 $j$\uff0c\u5982\u679c\u4e0d\u5b58\u5728\u8fd9\u6837\u7684 $j$\uff0c$L_i=0$\u3002\n\n\u540c\u7406\uff0c\u8bb0 $R_i$ \u4e3a\u6ee1\u8db3 $j>i,a_j>a_i$ \u7684\u6700\u5c0f\u7684 $j$\uff0c\u5982\u679c\u4e0d\u5b58\u5728\u8fd9\u6837\u7684 $j$\uff0c$R_i=n+1$\u3002\n\n\u90a3\u4e48\u7ecf\u8fc7\u6211\u4eec\u8fd9\u4e48\u4e00\u8f6c\u6362\uff0c\u53ef\u4ee5\u5f97\u5230 \n\n$$f(l,r)=\\sum\\limits_{i=l}^r\\min(R_i-1,r)-\\max(L_i+1,l)+1$$\n\n\u8fdb\u4e00\u6b65\u8f6c\u5316\u53ef\u4ee5\u5f97\u5230\n\n$$f(l,r)=\\sum\\limits_{i=l}^r(\\min(i-L_i-1,i-l)+\\min(R_i-i-1,r-i))+r-l+1$$\n\n\u6211\u4eec\u53ea\u9700\u5404\u6c42\u51fa sigma \u91cc\u9762\u7684\u4e24\u4e2a\u4e1c\u897f\u5c31\u53ef\u4ee5\u4e86\u3002\n\n\u4ee5 $\\min(i-L_i-1,i-l)$ \u4e3a\u4f8b\uff0c$\\min(R_i-i-1,r-i)$ \u4e5f\u540c\u7406\u3002\u6211\u4eec\u679a\u4e3e\u53f3\u7aef\u70b9\u3002\u5f00\u4e24\u4e2a\u6811\u72b6\u6570\u7ec4 $sum,cnt$\uff0c\u4f4d\u7f6e $i$ \u4e0a\u7684\u6570\u8868\u793a\u5f53 $l=i$ \u65f6\u5019\u7684\u60c5\u51b5\uff0c\u7531\u4e8e\u4e0a\u9762\u7684\u5f0f\u5b50\u91cc\u65e2\u5305\u542b $i$ \u4e5f\u5305\u542b $l$ \u6240\u4ee5 $sum$ \u8868\u793a\u5bf9\u5e94\u7684 $\\min(i-L_i-1,i-l)$ \u4e0e $i$ \u6709\u5173\u7684\u90e8\u5206\u7684\u548c\uff0c$cnt$ \u8868\u793a\u6709\u591a\u5c11\u4e2a $i$ \u6ee1\u8db3 $i-l<i-L_i+1$\uff0c\u90a3\u4e48\u6700\u7ec8\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u4e00\u5b9a\u662f $sum_i-l \\times cnt_i$\u3002\n\n\u90a3\u4e48\u600e\u4e48\u52a0\u5462\uff1f\u6211\u4eec\u8003\u8651\u53f3\u7aef\u70b9\u4ece $r-1$ \u53d8\u4e3a $r$ \u4f1a\u5e26\u6765\u4ec0\u4e48\u5f71\u54cd\uff0c\u7531\u4e8e\u6211\u4eec\u662f\u5728\u5bf9\u5e94\u7684 $l$ \u7684\u4f4d\u7f6e\u4e0a\u6dfb\u52a0\uff0c\u90a3\u4e48\u53ef\u4ee5\u6839\u636e $l$ \u7684\u5927\u5c0f\u5206\u51fa\u4e24\u5927\u7c7b\uff1a\n\n1. \u5982\u679c $r-l \\leq r-L_r-1$\uff0c\u5373 $l \\geq L_r+1$\uff0c\u90a3\u4e48\u4e0e $r$ \u6709\u5173\u7684\u90e8\u5206\u5c31\u53ea\u6709\u4e00\u4e2a $r$\uff0c\u6b64\u65f6\u6211\u4eec\u5bf9 $sum$ \u4e2d $[L_r+1,r]$ \u7684\u90e8\u5206\u6267\u884c\u533a\u95f4\u52a0 $r$\uff0c$cnt$ \u4e2d\u5bf9\u5e94\u90e8\u5206\u533a\u95f4\u52a0 $1$\u3002\n\n2. \u5982\u679c $r-l > r-L_r-1$\uff0c\u5373 $l \\leq L_i$\uff0c\u90a3\u4e48\u4e0e $r$ \u6709\u5173\u7684\u90e8\u5206\u5c31\u662f $r-L_r-1$\uff0c\u6211\u4eec\u5bf9 $sum$ \u4e2d $[1,L_r]$ \u7684\u90e8\u5206\u6267\u884c\u533a\u95f4\u52a0 $r$ \u5c31\u597d\u4e86\u3002\n\n\u6211\u4eec\u5f00\u4e00\u4e2a\u6876\u8bb0\u5f55\u53f3\u7aef\u70b9\u4e3a $r$ \u7684\u65f6\u5019\u7684\u8be2\u95ee\u7f16\u53f7\uff0c\u90a3\u4e48\u5bf9\u4e8e\u8be2\u95ee $i$ \u7b2c\u4e00\u90e8\u5206\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u5c31\u662f $sum_l-l \\times cnt_l$\u3002\n\n\u53e6\u5916\u4e00\u4e2a\u90e8\u5206\u540c\u7406\u3002\u6700\u540e\u4e24\u90e8\u5206\u7b54\u6848\u52a0\u8d77\u6765\uff0c\u518d\u52a0\u4e0a\u533a\u95f4\u957f\u5ea6\u5c31\u662f\u7b54\u6848\u3002\n\n```cpp\n//Coded by tzc_wk\n/*\n\u6570\u636e\u4e0d\u6e05\u7a7a\uff0c\u7206\u96f6\u4e24\u884c\u6cea\u3002\n\u591a\u6d4b\u4e0d\u8bfb\u5b8c\uff0c\u7206\u96f6\u4e24\u884c\u6cea\u3002\n\u8fb9\u754c\u4e0d\u7279\u5224\uff0c\u7206\u96f6\u4e24\u884c\u6cea\u3002\n\u8d2a\u5fc3\u4e0d\u8bc1\u660e\uff0c\u7206\u96f6\u4e24\u884c\u6cea\u3002\nD P \u987a\u5e8f\u9519\uff0c\u7206\u96f6\u4e24\u884c\u6cea\u3002\n\u5927\u5c0f\u5c11\u7b49\u53f7\uff0c\u7206\u96f6\u4e24\u884c\u6cea\u3002\n\u53d8\u91cf\u4e0d\u7edf\u4e00\uff0c\u7206\u96f6\u4e24\u884c\u6cea\u3002\n\u8d8a\u754c\u4e0d\u5224\u65ad\uff0c\u7206\u96f6\u4e24\u884c\u6cea\u3002\n\u8c03\u8bd5\u4e0d\u6ce8\u91ca\uff0c\u7206\u96f6\u4e24\u884c\u6cea\u3002\n\u6ea2\u51fa\u4e0d l l\uff0c\u7206\u96f6\u4e24\u884c\u6cea\u3002\n*/\n#include <bits/stdc++.h>\nusing namespace std;\n#define fi\t\t\tfirst\n#define se\t\t\tsecond\n#define fz(i,a,b)\tfor(int i=a;i<=b;i++)\n#define fd(i,a,b)\tfor(int i=a;i>=b;i--)\n#define foreach(it,v) for(__typeof(v.begin()) it=v.begin();it!=v.end();it++)\n#define all(a)\t\ta.begin(),a.end()\n#define giveup(...) return printf(__VA_ARGS__),0;\n#define fill0(a)\tmemset(a,0,sizeof(a))\n#define fill1(a)\tmemset(a,-1,sizeof(a))\n#define fillbig(a)\tmemset(a,0x3f,sizeof(a))\n#define fillsmall(a) memset(a,0xcf,sizeof(a))\n#define mask(a)\t\t(1ll<<(a))\n#define maskx(a,x)\t((a)<<(x))\n#define _bit(a,x)\t(((a)>>(x))&1)\n#define _sz(a)\t\t((int)(a).size())\n#define filei(a)\tfreopen(a,\"r\",stdin);\n#define fileo(a)\tfreopen(a,\"w\",stdout);\n#define fileio(a) \tfreopen(a\".in\",\"r\",stdin);freopen(a\".out\",\"w\",stdout)\n#define eprintf(...) fprintf(stderr,__VA_ARGS__)\n#define put(x)\t\tputchar(x)\n#define eoln        put('\\n')\n#define space\t\tput(' ')\n#define y1\t\t\ty_chenxiaoyan_1\n#define y0\t\t\ty_chenxiaoyan_0\n#define int long long\ntypedef pair<int,int> pii;\ninline int read(){\n\tint x=0,neg=1;char c=getchar();\n\twhile(!isdigit(c)){\n\t\tif(c=='-')\tneg=-1;\n\t\tc=getchar();\n\t}\n\twhile(isdigit(c))\tx=x*10+c-'0',c=getchar();\n\treturn x*neg;\n}\ninline void print(int x){\n\tif(x<0){\n\t\tputchar('-');\n\t\tprint(abs(x));\n\t\treturn;\n\t}\n\tif(x<=9)\tputchar(x+'0');\n\telse{\n\t\tprint(x/10);\n\t\tputchar(x%10+'0');\n\t}\n}\ninline int qpow(int x,int e,int _MOD){\n\tint ans=1;\n\twhile(e){\n\t\tif(e&1)\tans=ans*x%_MOD;\n\t\tx=x*x%_MOD;\n\t\te>>=1;\n\t}\n\treturn ans;\n}\nint n=read(),m=read();\nint a[1000005],l[1000005],r[1000005];\nvector<int> ql[1000005],qr[1000005];\nstruct Fenwick_Tree{\n\tint bit[1500005];\n\tinline int lowbit(int x){\n\t\treturn x&(-x);\n\t}\n\tinline void add(int x,int val){\n\t\tfor(int i=x;i<=1500005;i+=lowbit(i))\tbit[i]+=val;\n\t}\n\tinline int query(int x){\n\t\tint ans=0;\n\t\tfor(int i=x;i;i-=lowbit(i))\tans+=bit[i];\n\t\treturn ans;\n\t}\n\tinline void add_range(int l,int r,int val){\n\t\tadd(l,val);add(r+1,-val);\n\t}\n\tinline void clear(){\n\t\tfill0(bit);\n\t}\n} cnt,sum;\nint L[1000005],R[1000005],ans[1000005];\nsigned main(){\n\tfz(i,1,n)\ta[i]=read();\n\tfz(i,1,m)\tl[i]=read(),qr[l[i]].push_back(i);\n\tfz(i,1,m)\tr[i]=read(),ql[r[i]].push_back(i);\n\tfz(i,1,m)\tans[i]=r[i]-l[i]+1;\n\tstack<pii> stk;\n\tfz(i,1,n){\n\t\twhile(!stk.empty()&&stk.top().fi<a[i]){\n\t\t\tR[stk.top().se]=i;\n\t\t\tstk.pop();\n\t\t}\n\t\tif(!stk.empty()){\n\t\t\tL[i]=stk.top().se;\n\t\t}\n\t\tstk.push({a[i],i});\n\t}\n\tfz(i,1,n){\n\t\tif(!R[i])\tR[i]=n+1;\n\t}\n//\tfz(i,1,n)\tcout<<L[i]<<\" \"<<R[i]<<endl;\n\tfz(i,1,n){\n\t\tcnt.add_range(L[i]+1,i,1);\n\t\tsum.add_range(L[i]+1,i,i);\n\t\tsum.add_range(1,L[i],i-L[i]-1);\n\t\tforeach(it,ql[i]){\n\t\t\tint ind=*it;\n\t\t\tint j=l[ind];\n\t\t\tans[ind]+=sum.query(j)-cnt.query(j)*j;\n\t\t}\n\t}\n\tcnt.clear();sum.clear();\n\tfd(i,n,1){\n\t\tsum.add_range(i,R[i]-1,-i);\n\t\tcnt.add_range(i,R[i]-1,1);\n\t\tsum.add_range(R[i],n,R[i]-i-1);\n\t\tforeach(it,qr[i]){\n\t\t\tint ind=*it;\n\t\t\tint j=r[ind];\n\t\t\tans[ind]+=sum.query(j)+cnt.query(j)*j;\n\t\t}\n\t}\n\tfz(i,1,m)\tcout<<ans[i]<<\" \";\n\treturn 0;\n}\n/*\nr-1 -> r\nmin(r-L[r]-1,r-l)\n\nr-l<r-L[r]-1  ->  L[r]+1<l\n\n1. l>=L[r]+1   r-l        sum.add(L[r]+1,r,r),cnt.add(L[r]+1,r,1)\n2. l<=L[r]     r-L[r]-1   sum.add(1,L[r],r-L[r]-1)\n*/\n/*\nl+1 -> l\nmin(R[l]-l-1,r-l)\n\nr-l<R[l]-l-1 -> R[l]-1>r\n\n1. r<=R[l]-1   r-l        sum.add(l,R[l]-1,l),cnt.add(l,R[l]-1,1)\n2. l>=R[l]     R[l]-l-1   sum.add(R[l],n,R[l]-l-1)\n*/\n```",
        "postTime": 1583737735,
        "uid": 115194,
        "name": "lTgMFePRoeZ",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 CF1117G \u3010Recursive Queries\u3011"
    },
    {
        "content": "\u9898\u610f\uff1a\u533a\u95f4\u5efa\u7b1b\u5361\u5c14\u6811\uff0c\u6c42\u6bcf\u4e2a\u8282\u70b9\u7684siz\u4e4b\u548c\u3002\n\n\u9996\u5148\u770b\u5230\u7b1b\u5361\u5c14\u6811\uff0c\u5c31\u5e94\u8be5\u60f3\u5230\uff0c\u56e0\u4e3a\u8fd9\u662f\u4e00\u4e2a\u6392\u5217\uff0c\u53ef\u4ee5\u627e\u5230\u901a\u8fc7\u5de6\u8fb9\u548c\u53f3\u8fb9\u7b2c\u4e00\u4e2a\u6bd4\u81ea\u5df1\u5927\u7684\u5143\u7d20\u6765\u201c\u5efa\u7acb\u201d\u7b1b\u5361\u5c14\u6811\u3002\n\n\u8bbe $ l(u) $ \u4e3a\u4e0b\u6807\u662f $ u $ \u7684\u5143\u7d20\u5de6\u8fb9\u7b2c\u4e00\u4e2a\u6bd4\u81ea\u8eab\u5927\u7684\u5143\u7d20\uff0c$ r(u) $ \u540c\u7406\u3002\n\n\u7b54\u6848\u5c31\u662f\n$$ \\sum_{i=L}^R \\min(r(i)-1,R)-\\max(l(i)+1,L)+1 $$\n\u5c06\u4e24\u90e8\u5206\u62c6\u5f00\u8ba1\u7b97\uff0c\u672c\u8d28\u662f\u4e00\u6837\u7684\u3002\u4e0b\u9762\u4ee5\u53f3\u7aef\u4e3a\u4f8b\n\n\u5bf9\u4e8e\u4e00\u4e2a $ \\sum $\uff0c\u7b54\u6848\u7531\u4e24\u90e8\u5206\u7ec4\u6210\uff1a\n\n1. $ r(i) $\n2. $ R $\n\n\u6211\u4eec\u53ea\u9700\u8981\u5bf9\u5176\u5206\u522b\u6c42\u548c\u5c31\u597d\u4e86\n\n\u6211\u4eec\u4ece $ n $ \u626b\u5230 $ 1 $\uff0c\u5bf9\u4e8e\u4e00\u4e2a $ r(i) $ \u4f1a\u5728\u626b\u5230 $ r(i) $ \u65f6\u53d8\u6210 $ R $\uff0c\u4e14\u53ea\u4f1a\u53d8\u4e00\u6b21\u3002\n\n\u7528\u4e24\u9897\u6811\u72b6\u6570\u7ec4\u548c\u5373\u53ef\u3002\u590d\u6742\u5ea6 $ O(n\\log n) $\n\ncode:\n```cpp\n#include<cstdio>\n#include<vector>\nconst int M=1e6+6;\nint n,m,a[M],l[M],r[M],L[M],R[M],num[M];long long BIT[M],ans[M];\nstd::vector<int>qL[M],qR[M],idL[M],idR[M];\nint top,stk[M];\ninline void Add1(int x,int val){\n\tfor(;x<=n;x+=1<<__builtin_ctz(x))BIT[x]+=val;\n}\ninline void Add2(int x,int val){\n\tfor(;x<=n;x+=1<<__builtin_ctz(x))num[x]+=val;\n}\ninline long long Query1(int x){\n\tlong long ans=0;\n\tfor(;x>=1;x-=1<<__builtin_ctz(x))ans+=BIT[x];\n\treturn ans;\n}\ninline int Query2(int x){\n\tint ans=0;\n\tfor(;x>=1;x-=1<<__builtin_ctz(x))ans+=num[x];\n\treturn ans;\n}\nsigned main(){\n\tregister int i,x;\n\tscanf(\"%d%d\",&n,&m);\n\tfor(i=1;i<=n;++i)scanf(\"%d\",a+i);\n\tfor(i=1;i<=n;++i){\n\t\twhile(top&&a[i]>=a[stk[top]])--top;\n\t\tidL[(L[i]=top?stk[top]:0)+1].push_back(i);stk[++top]=i;\n\t}\n\ttop=0;\n\tfor(i=n;i>=1;--i){\n\t\twhile(top&&a[i]>=a[stk[top]])--top;\n\t\tidR[(R[i]=top?stk[top]:n+1)-1].push_back(i);stk[++top]=i;\n\t}\n\tfor(i=1;i<=m;++i)scanf(\"%d\",l+i),qL[l[i]].push_back(i);\n\tfor(i=1;i<=m;++i)scanf(\"%d\",r+i),qR[r[i]].push_back(i);\n\tfor(i=1;i<=n;++i)Add1(i,R[i]-1);\n\tfor(i=n;i>=1;--i){\n\t\tfor(int&id:idR[i])Add1(id,-R[id]+1),Add2(id,1);\n\t\tfor(int&id:qR[i]){\n\t\t\tans[id]+=(Query1(r[id])-Query1(l[id]-1))+1ll*i*(Query2(r[id])-Query2(l[id]-1));\n\t\t}\n\t}\n\tfor(i=1;i<=n;++i)BIT[i]=num[i]=0;\n\tfor(i=1;i<=n;++i)Add1(i,L[i]+1);\n\tfor(i=1;i<=n;++i){\n\t\tfor(int&id:idL[i])Add1(id,-L[id]-1),Add2(id,1);\n\t\tfor(int&id:qL[i]){\n\t\t\tans[id]-=(Query1(r[id])-Query1(l[id]-1))+1ll*i*(Query2(r[id])-Query2(l[id]-1));\n\t\t}\n\t}\n\tfor(i=1;i<=m;++i)printf(\"%lld \",ans[i]+r[i]-l[i]+1);\n}\n```",
        "postTime": 1622278010,
        "uid": 160839,
        "name": "Prean",
        "ccfLevel": 7,
        "title": "\u6570\u636e\u7ed3\u6784 \u7b1b\u5361\u5c14\u6811+\u6811\u72b6\u6570\u7ec4 CF1117G\u9898\u89e3"
    },
    {
        "content": "\u7b80\u5355\u6570\u636e\u7ed3\u6784\uff1f\n\n\u4ee4 $R_i$ \u662f\u7b2c\u4e00\u4e2a\u5927\u4e8e $i$ \u7684\u6570\u3002\n\n$L_i$ \u540c\u7406\uff0c\u90a3\u4e48\u8d21\u732e\u5176\u5b9e\u5c31\u662f\u3002\n\n$\\sum \\min(R_i - 1, qr) - \\max(L_i + 1, ql)$\u3002\n\n\u663e\u7136\u53ef\u4ee5\u7528\u4e24\u6b21\u5355\u8c03\u6808+\u6811\u72b6\u6570\u7ec4\u505a\u5b8c\u3002\n\n```cpp\n#include<bits/stdc++.h>\n#define rep(i,x,y) for(int i=x,I=y+1;i<I;++i)\n#define per(i,x,y) for(int i=x,I=y-1;i>I;--i)\nusing namespace std;\nusing ll=long long;\nvoid cmax(int&x,const int&y){x=x>y?x:y;}\nvoid cmin(int&x,const int&y){x=x<y?x:y;}\ntemplate<class T>istream&operator>>(istream&in,vector<T>&V){for(auto&x:V)in>>x;return in;}\ntemplate<class T>ostream&operator<<(ostream&out,const vector<T>&V){for(auto x:V)out<<x<<' ';return out;}\ntemplate<class T>void sort(vector<T>&V){sort(V.begin(),V.end());}\ntemplate<class T>void reverse(vector<T>&V){reverse(V.begin(),V.end());}\ntemplate<class T>int SZ(const vector<T>&V){return (int)V.size();}\nvoid debug(){cerr<<\"whxorz\"<<'\\n';}\n\nint n, q;\n\nconst int N = 1e6 + 5;\nint a[N];\n\nint st[N], top;\nint L[N], R[N];\nint QL[N], QR[N];\n\nstruct Binary_Indexed_Tree {\n\tll c[N];\n\t\n\tint lowbit(int x) {\n\t\treturn x & -x;\n\t}\n\t\n\tvoid update(int x, int y) {\n\t\t++x;\n\t\tfor (; x < N; x += lowbit(x))\n\t\t\tc[x] += y;\n\t}\n\t\n\tll query(int x) {\n\t\tll ans = 0;\n\t\t++x;\n\t\tfor (; x; x ^= lowbit(x))\n\t\t\tans += c[x];\n\t\treturn ans;\n\t}\n\t\n\tll query(int l, int r) { return query(r) - query(l - 1); }\n\t\n\tvoid clear() {\n\t\tfor (int i = 0; i < N; i++)\n\t\t\tc[i] = 0;\n\t}\n} t, t2;\n\nvector <int> v[N];\nvoid modify(int i) { int lb = L[i]; t.update(lb, lb); t2.update(lb, 1); }\nvoid modify2(int i) { int rb = R[i]; t.update(rb, rb); t2.update(rb, 1); }\n\nint main(){\n\tios::sync_with_stdio(false);\n\tcin.tie(NULL);\n\t\n\tcin >> n >> q;\n\tfor (int i = 1; i <= n; i++) { cin >> a[i]; }\n\t\n\tfor (int i = 1; i <= n; i++) {\n\t\twhile (top && a[st[top]] < a[i]) { R[st[top--]] = i; }\n\t\tL[i] = st[top]; st[++top] = i;\n\t}\n\twhile (top) { R[st[top--]] = n + 1; }\n\tfor (int i = 1; i <= n; i++) { L[i]++; R[i]--; }\n\tfor (int i = 1; i <= q; i++) { cin >> QL[i]; }\n\tfor (int i = 1; i <= q; i++) { cin >> QR[i]; }\n\tvector <ll> ans(q + 1, 0);\n\tvector <ll> sum(n + 1, 0);\n\t\n\tfor (int i = 1; i <= n; i++) { sum[i] = sum[i - 1] + (R[i] - L[i] + 1); }\n\tfor (int i = 1; i <= q; i++) {\n\t\tint l = QL[i], r = QR[i]; ans[i] = sum[r] - sum[l - 1];\n\t\tv[l - 1].push_back(-i); v[r].push_back(i);\n\t}\n\t\n//\tfor (int i = 1; i <= q; i++) {\n//\t\tcout << ans[i] << ' ';\n//\t}\n//\tcout << '\\n';\n//\t\n//\tfor (int i = 1; i <= n; i++) {\n//\t\tcout << L[i] << ' ' << R[i] << '\\n';\n//\t}\n//\tcout << '\\n';\n//\t\n//\tfor (int i = 1; i <= q; i++) {\n//\t\tcout << QL[i] << ' ' << QR[i] << '\\n';\n//\t}\n//\tcout << '\\n';\n\t\n\tt.clear();\n\tt2.clear();\n\tfor (int i = 1; i <= n; i++) {\n\t\tmodify(i);\n\t\tfor (auto x : v[i]) {\n\t\t\tint f = (x > 0) ? 1 : -1; x *= f;\n\t\t\tans[x] -= 1ll * f * (1ll * QL[x] * t2.query(QL[x]) - t.query(QL[x]));\n\t\t}\n\t}\n\t\n\tt.clear();\n\tt2.clear();\n\tfor (int i = 1; i <= n; i++) {\n\t\tmodify2(i);\n\t\tfor (auto x : v[i]) {\n\t\t\tint f = (x > 0) ? 1 : -1; x *= f;\n\t\t\tans[x] -= 1ll * f * (t.query(QR[x], n) - 1ll * QR[x] * t2.query(QR[x], n));\n\t\t}\n\t}\n\t\n\tfor (int i = 1; i <= q; i++) {\n\t\tcout << ans[i] << ' ';\n\t}\n\tcout << '\\n';\n\treturn 0;\n}\n```",
        "postTime": 1601298713,
        "uid": 96580,
        "name": "SXNhdW5veWE",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 CF1117G \u3010Recursive Queries\u3011"
    },
    {
        "content": "\u9898\u89e3\u533a\u91cc\u597d\u591a\u6811\u72b6\u6570\u7ec4\u554a\u3002\n\n\u4f46\u662f\u60f3\u63d0\u4f9b\u4e00\u79cd ST \u8868 + \u7b1b\u5361\u5c14\u6811\u4e0a\u6811\u5f62 dp $O(n\\log n)$ \u9884\u5904\u7406\uff0c\u7136\u540e\u5728\u7ebf $O(1)$ \u67e5\u8be2\u7684\u505a\u6cd5\u3002\uff08\u74f6\u9888\u5728\u4e8e ST \u8868\u9884\u5904\u7406\uff09\n\n\u9996\u5148 $O(n)$ \u5efa\u7b1b\u5361\u5c14\u6811\uff0c\u4e0d\u6e05\u695a\u7684\u53f3\u8f6c [P5854 \u3010\u6a21\u677f\u3011\u7b1b\u5361\u5c14\u6811](https://www.luogu.com.cn/problem/P5854)\u3002\n\n\u7136\u540e\u8003\u8651\u6bcf\u4e00\u6b21\u7684\u8d21\u732e\u3002\u5047\u8bbe\u5f53\u524d\u7684\u8be2\u95ee\u533a\u95f4\u662f $[l,r]$\uff0c\u90a3\u4e48\u5148\u628a\u8fd9\u4e2a\u533a\u95f4\u7684\u6700\u5927\u503c $m$ \u627e\u51fa\u6765\uff0c\u7b1b\u5361\u5c14\u6811\u7684\u6027\u8d28\u544a\u8bc9\u6211\u4eec\uff0c$m$ \u540c\u65f6\u4e5f\u662f $l,r$ \u4e24\u70b9\u5728\u7b1b\u5361\u5c14\u6811\u4e0a\u7684\u6700\u8fd1\u516c\u5171\u7956\u5148\u3002\n\n\u9996\u5148\u8ba9\u6211\u4eec\u601d\u8003\u5982\u679c\u66b4\u529b\u505a\u5e94\u8be5\u600e\u4e48\u505a\u3002\u5148\u53ea\u8003\u8651\u5de6\u534a\u8fb9\u3002\u90a3\u4e48\u5c31\u662f\u4ece $l$ \u5f00\u59cb\u66b4\u529b\u8df3\uff0c\u5982\u679c $l$ \u5728 $f$ \u5f53\u524d\u7684\u5de6\u5b50\u6811\u4e0a\uff0c\u8bbe\u53f3\u5b50\u6811\u7684\u6700\u5927\u503c\u662f $rm_f$\uff0c\u8fd9\u4e00\u5c42\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u5c31\u662f\n\n$$(rm_f-l+1)+f(m+1,r)$$\n\n\u6211\u4eec\u53d1\u73b0 $f(m+1,r)$ \u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u5b50\u6811\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u7b2c\u4e00\u6b21\u5c31\u9884\u5904\u7406\u51fa\u6765\u3002\n\n\u800c\u5982\u679c $l$ \u5728 $f$ \u7684\u53f3\u5b50\u6811\u4e0a\uff0c\u5219\u8fd9\u4e00\u5c42\u5df2\u7ecf\u8d85\u51fa\u4e86 $[l,r]$ \u7684\u533a\u95f4\uff0c\u4e0d\u4f1a\u5bf9\u7b54\u6848\u6709\u4efb\u4f55\u8d21\u732e\u3002\u8fd9\u6837\u8df3\u94fe\u76f4\u5230 $f=m$\uff0c\u9000\u51fa\u3002\n\n\u6240\u4ee5\u6211\u4eec\u5f97\u5230\u4e00\u79cd $O(nq)$ \u7684\u505a\u6cd5\u3002\n\n\u6211\u4eec\u53d1\u73b0\u5176\u5b9e\u5728\u4ece\u4e0b\u5f80\u4e0a\u63a8\u7b54\u6848\u7684\u65f6\u5019\uff0c\u9664\u4e86\u51cf\u4e86\u51e0\u4e2a $l$ \u4ee5\u5916\uff0c\u6ca1\u6709\u522b\u7684\u548c $l$ \u6709\u5173\u7684\u9879\u3002\u90a3\u4e48\uff0c\u6211\u4eec\u91cd\u65b0\u6539\u5199\u4e00\u4e0b\u8fd9\u4e2a\u5f0f\u5b50\u3002\u5047\u8bbe\u4ece $l$ \u8df3\u5230 $m$ \u4e00\u5171\u6709 $k$ \u6b21\u662f\u8d70\u7684\u5de6\u513f\u5b50\uff08\u5305\u62ec\u81ea\u5df1\uff09\uff0c\u5206\u522b\u662f\u5728\u8282\u70b9 $v_1,v_2,\\cdots,v_k$\uff0c\u90a3\u4e48\n\n$$f(l,m-1)=\\sum_{i=1}^{k}{rm_{v_i}}-k(l-1)+\\sum_{i=1}^{k}{f(rightson_{v_i})}$$\n\n\u6240\u4ee5\uff0c\u6211\u4eec\u53ef\u4ee5\u7ef4\u62a4\u8fd9\u4e09\u4e2a\u4e1c\u897f\uff1a\n\n\u8def\u5f84\u4e0a\u6240\u6709\u8d70\u4e86\u5b83\u7684\u5de6\u513f\u5b50\u7684\u70b9\u7684\u53f3\u5b50\u6811\u7684\u6700\u5927\u503c\u4e4b\u548c $sum_i$\u3002\uff08\u8fd8\u6709 $i$ \u7684\u53f3\u5b50\u6811\uff09\n\n\u4e0a\u8ff0\u60c5\u51b5\u51fa\u73b0\u7684\u6b21\u6570 $k_i$\u3002\n\n\u8def\u5f84\u4e0a\u6240\u6709\u8d70\u4e86\u5b83\u7684\u5de6\u513f\u5b50\u7684\u70b9\u7684\u53f3\u5b50\u6811\u7684\u533a\u95f4\u8d21\u732e\u4e4b\u548c $ans_i$\u3002\n\n\u8f6c\u79fb\u7684\u65f6\u5019\uff0c\u5148\u628a\u5f53\u524d\u8282\u70b9\u7684\u503c\u8d4b\u7ed9\u53f3\u5b50\u6811\uff0c\u7136\u540e\u52a0\u5165\u5b83\u7684\u53f3\u5b50\u6811\u5bf9\u7b54\u6848\u7684\u8d21\u732e\uff0c\u518d\u628a\u5f53\u524d\u8282\u70b9\u7684\u503c\u8d4b\u7ed9\u5de6\u5b50\u6811\u3002\n\n\u6ce8\u610f\u5230\u8fd9\u4e09\u4e2a\u91cf\u90fd\u662f\u76f8\u5f53\u4e8e\u524d\u7f00\u548c\u7684\u5f62\u5f0f\uff08\u4ece\u6839\u5230 $i$ \u7684\u7d2f\u8ba1\u603b\u548c\uff09\u3002\u90a3\u4e48\u7528 $l$ \u7684\u503c\u51cf\u53bb $m$ \u7684\u503c\u5c31\u80fd\u5f97\u5230\u6b63\u786e\u7684\u4e09\u4e2a\u91cf\uff0c\u7136\u540e\u6839\u636e\u516c\u5f0f $O(1)$ \u8ba1\u7b97\u7b54\u6848\u3002\n\n\u5bf9\u4e8e $f(m+1,r)$\uff0c\u5982\u6cd5\u70ae\u5236\u5373\u53ef\u3002\u4f46\u662f\u6ce8\u610f\u7b54\u6848\u5e94\u5f53\u662f\n\n\n$$f(m+1,r)=k(r-1)-\\sum_{i=1}^{k}{lm_i}+\\sum_{i=1}^{k}{f(leftson_i)}$$\n\n\u4e5f\u5c31\u662f\uff0c\u8ba1\u7b97\u7b54\u6848\u7684\u65f6\u5019\u8981\u8bb0\u5f97\u7528 $r$ \u7684\u548c\u53bb\u51cf\u5de6\u7aef\u70b9\u503c\u548c\u3002\n\n\u5de6\u53f3\u7684\u6570\u636e\u8981\u5206\u5f00\u5b58\u50a8\u3002\n\n\n\n\u5c0f Trick\uff1a\u5728\u8ba1\u7b97\u8fc7\u7a0b\u4e2d $ans$ \u548c $sum$ \u7684\u4f20\u9012\u8fc7\u7a0b\u662f\u5b8c\u5168\u4e00\u6837\u7684\uff0c\u53ef\u4ee5\u76f4\u63a5\u5b58\u50a8\u5b83\u4eec\u4e24\u4e2a\u7684\u548c\u3002\n\n```cpp\n/*\n\n\u4e00\u4e9b\u58f0\u660e\uff1a\n1.\u672c\u4ee3\u7801\u4f7f\u7528\u4e86FastIO\uff0c\u56e0\u4e3a\u8fd9\u4e00\u90e8\u5206\u8fc7\u4e8e\u5197\u957f\uff0c\u6240\u4ee5\u53bb\u6389\u4e86\u3002\n2.\u4f7f\u75280\u4ee3\u8868\u5de6\uff0c1\u4ee3\u8868\u53f3\n3.\u4e3a\u4e86\u62a2\u6700\u4f18\u89e3\uff08\u867d\u7136\u6ca1\u62a2\u5230\uff09\uff0c\u6709\u4e00\u5b9a\u5361\u5e38\uff0c\u4f46\u662f\u5e94\u8be5\u4e0d\u5f71\u54cd\u53ef\u8bfb\u6027\n4.\u73b0\u5728\u662fcf\u6700\u4f18\u89e3 rk2\uff0c576ms\n\n*/\n#pragma GCC optimize(2)\n#pragma GCC optimize(\"Ofast\")\n#pragma GCC optimize(\"unroll-loops\")\n#pragma GCC target(\"sse,sse2,sse3,ssse3,sse4,popcnt,abm,mmx,avx,avx2,tune=native\")\n#include<bits/stdc++.h>\nusing namespace std;\n#define rd(i,n) for(int i=0;i<n;i++)\n#define rp(i,n) for(int i=1;i<=n;i++)\n#define rep(i,a,b) for(int i=a;i<=b;i++)\ntypedef long long ll;\nint n,a[1000005],s[1000005],top,q,rt,L[1000005],R[1000005];\nint m[2][1000005];\nint sn[2][1000005],sr[1000005][21];\nll ans[2][1000005],f[1000005];\nint cnt[2][1000005];\nusing namespace FastIO;\ninline int cmp(int &x,int &y){\n\tif(a[x]>a[y])return x;\n\treturn y;\n}\ninline void init(){\n\trep(i,1,n)sr[i][0]=i;\n\trp(j,19)rep(i,1,n)if(i+(1<<j)-1<=n)sr[i][j]=cmp(sr[i][j-1],sr[i+(1<<(j-1))][j-1]);\n}\ninline int rmq(int l,int r){\n\tint x=__lg(r-l+1);\n\treturn cmp(sr[l][x],sr[r-(1<<x)+1][x]);\n}\ninline void build(){// \u7b1b\u5361\u5c14\u6811\u7684\u5efa\u6811 \n\trt=1,s[top=1]=1;\n\trep(i,2,n){\n\t\tint lst=0;\n\t\twhile(top&&a[s[top]]<a[i])lst=s[top--];\n\t\tsn[0][i]=lst;\n\t\tif(lst==rt)rt=i;\n\t\tif(top)sn[1][s[top]]=i;\n\t\ts[++top]=i;\n\t}\n}\ninline void calc(int x){// \u7b2c\u4e00\u6b21dp\uff0c\u5904\u7406\u51fa f \u548c\u5de6\u53f3\u6700\u5c0f\u503c\n\tm[0][x]=m[1][x]=x;\n\tif(sn[0][x])calc(sn[0][x]),m[0][x]=min(m[0][x],m[0][sn[0][x]]),f[x]+=f[sn[0][x]];\n\tif(sn[1][x])calc(sn[1][x]),m[1][x]=max(m[1][x],m[1][sn[1][x]]),f[x]+=f[sn[1][x]];\n\tf[x]+=m[1][x]-m[0][x]+1;\n}\ninline void psh(int p,int x,int f){\n\tans[p][x]=ans[p][f];\n\tcnt[p][x]=cnt[p][f];\n}\ninline void c(int x){// \u7b2c\u4e8c\u6b21dp\uff0c\u5904\u7406\u51fa\u8ba1\u7b97\u7b54\u6848\u9700\u8981\u7684\u503c\n\tif(sn[0][x])psh(1,sn[0][x],x);\n\tif(sn[1][x])psh(0,sn[1][x],x);\n\tans[0][x]+=f[sn[1][x]]+m[1][x],cnt[0][x]++;\n\tans[1][x]+=f[sn[0][x]]-m[0][x],cnt[1][x]++;\n\tif(sn[0][x])psh(0,sn[0][x],x);\n\tif(sn[1][x])psh(1,sn[1][x],x);\n\tif(sn[0][x])c(sn[0][x]);\n\tif(sn[1][x])c(sn[1][x]);\n}\nsigned main(){\n\tn=in(),q=in();\n\trp(i,n)a[i]=in();\n\tbuild();\n\tinit();\n\tcalc(rt);c(rt);\n\trp(i,q)L[i]=in();\n\trp(i,q)R[i]=in();\n\trp(i,q){\n\t\tint p=rmq(L[i],R[i]);\n\t\tout(R[i]-L[i]+1+\n\t\t\tans[0][L[i]]-ans[0][p]+ans[1][R[i]]-ans[1][p]-\n\t\t    1ll*(cnt[0][L[i]]-cnt[0][p])*(L[i]-1)+\n\t\t    1ll*(cnt[1][R[i]]-cnt[1][p])*(R[i]+1))(' ');\n\t}\n\tout('\\n');\n\treturn 0;\n}\n```\n\n\n",
        "postTime": 1668497761,
        "uid": 304222,
        "name": "jucason_xu",
        "ccfLevel": 0,
        "title": "CF1117G\u9898\u89e3"
    },
    {
        "content": "```cpp\n\u521a\u5f00\u59cb\u60f3\u590d\u6742\u4e86, \u8fd8\u4ee5\u4e3a\u662f\u4e2a\u7b1b\u5361\u5c14\u6811....\n\n\u5b9e\u9645\u4e0a\u6211\u4eec\u53d1\u73b0, \u5bf9\u4e8e\u8be2\u95ee(l,r)\u6bcf\u4e2a\u70b9\u7684\u8d21\u732e\u662fmin(r,R[i])\u2212max(l,L[i])+1\n\n\u6570\u636e\u8303\u56f4\u6bd4\u8f83\u5927\u5728\u7ebf\u6811\u5957\u6811\u7684\u8bdd\u660e\u663e\u8fc7\u4e0d\u4e86, \u8fd8\u662f\u60f3\u79bb\u7ebf\u7684\u7b97\u6cd5\u597d\u4e86, \u53ea\u8003\u8651\u6c42\u2211min(r,R[i]), \u5bf9\u4e8e\u2211max(l,L[i])\u540c\u7406\n\n\u5c06\u8be2\u95ee\u6309l\u4ece\u5927\u5230\u5c0f\u6392, \u5c06\u70b9x\u7684\u8d21\u732e\u8f6c\u5316\u4e3a[x,R[x]\u22121]\u533a\u95f4\u52a0\u7b49\u5dee, [R[x],n]\u533a\u95f4\u52a0R[x], \u8fd9\u6837\u2211min(r,R[i])\u5c31\u53d8\u6210\u5bf9\u4f4d\u7f6er\u5355\u70b9\u6c42\u548c\u4e86\n\n\u79bb\u7ebf\u7684\u4ee3\u7801\u5982\u4e0b \n```\n```cpp\n#include <iostream>\n#include <algorithm>\n#include <cstdio>\n#include <math.h>\n#include <set>\n#include <map>\n#include <queue>\n#include <string>\n#include <string.h>\n#define REP(i,a,n) for(int i=a;i<=n;++i)\n#define PER(i,a,n) for(int i=n;i>=a;--i)\n#define hr putchar(10)\n#define pb push_back\n#define lc (o<<1)\n#define rc (lc|1)\n#define mid ((l+r)>>1)\n#define ls lc,l,mid\n#define rs rc,mid+1,r\n#define x first\n#define y second\n#define io std::ios::sync_with_stdio(false)\n#define endl '\\n'\nusing namespace std;\ntypedef long long ll;\ntypedef pair<int,int> pii;\nconst int P = 1e9+7, INF = 0x3f3f3f3f;\nll gcd(ll a,ll b) {return b?gcd(b,a%b):a;}\nll qpow(ll a,ll n) {ll r=1%P;for (a%=P;n;a=a*a%P,n>>=1)if(n&1)r=r*a%P;return r;}\nll inv(ll x){return x<=1?1:inv(P%x)*(P-P/x)%P;}\n//head\n \nconst int N = 1e6+10;\nint n, q;\nint a[N], L[N], R[N];\nstruct _ {int l,r,id;} e[N];\nint v1[N<<2], t1[N<<2];\nll v2[N<<2], t2[N<<2], ans[N];\n \nvoid pd1(int o) {\n    if (t1[o]) {\n        v1[lc]+=t1[o];\n        v1[rc]+=t1[o];\n        t1[lc]+=t1[o];\n        t1[rc]+=t1[o];\n        t1[o]=0;\n    }\n}\nvoid pd2(int o) {\n    if (t2[o]) {\n        v2[lc]+=t2[o];\n        v2[rc]+=t2[o];\n        t2[lc]+=t2[o];\n        t2[rc]+=t2[o];\n        t2[o]=0;\n    }\n}\nvoid upd1(int o, int l, int r, int ql, int qr, int v) {\n    if (ql<=l&&r<=qr) return v1[o]+=v,t1[o]+=v,void();\n    pd1(o);\n    if (mid>=ql) upd1(ls,ql,qr,v);\n    if (mid<qr) upd1(rs,ql,qr,v);\n}\nvoid upd2(int o, int l, int r, int ql, int qr, int v) {\n    if (ql<=l&&r<=qr) return v2[o]+=v,t2[o]+=v,void();\n    pd2(o);\n    if (mid>=ql) upd2(ls,ql,qr,v);\n    if (mid<qr) upd2(rs,ql,qr,v);\n}\nll qry1(int o, int l, int r, int x) {\n    if (l==r) return (ll)l*v1[o];\n    pd1(o);\n    if (mid>=x) return qry1(ls,x);\n    return qry1(rs,x);\n}\nll qry2(int o, int l, int r, int x) {\n    if (l==r) return (ll)v2[o];\n    pd2(o);\n    if (mid>=x) return qry2(ls,x);\n    return qry2(rs,x);\n}\n \nint main() {\n    scanf(\"%d%d\", &n, &q);\n    REP(i,1,n) scanf(\"%d\", a+i);\n    REP(i,1,n) {\n        L[i] = i-1;\n        while (L[i]&&a[i]>a[L[i]]) L[i]=L[L[i]];\n    }\n    PER(i,1,n) {\n        R[i] = i+1;\n        while (R[i]<=n&&a[i]>a[R[i]]) R[i]=R[R[i]];\n    }\n    REP(i,1,n) ++L[i],--R[i];\n    REP(i,1,q) scanf(\"%d\", &e[i].l);\n    REP(i,1,q) scanf(\"%d\", &e[i].r),e[i].id=i;\n    sort(e+1,e+1+q,[](_ a,_ b){return a.l>b.l;});\n    int now = n;\n    REP(i,1,q) {\n        while (now>=e[i].l) {\n            if (now<=R[now]-1) upd1(1,1,n,now,R[now]-1,1);\n            upd2(1,1,n,R[now],n,R[now]);\n            --now;\n        }\n        ans[e[i].id] += qry1(1,1,n,e[i].r)+qry2(1,1,n,e[i].r)+e[i].r-e[i].l+1;\n    }\n    memset(v1,0,sizeof v1);\n    memset(v2,0,sizeof v2);\n    memset(t1,0,sizeof t1);\n    memset(t2,0,sizeof t2);\n    sort(e+1,e+1+q,[](_ a,_ b){return a.r<b.r;});\n    now = 1;\n    REP(i,1,q) {\n        while (now<=e[i].r) {\n            if (L[now]+1<=now) upd1(1,1,n,L[now]+1,now,1);\n            upd2(1,1,n,1,L[now],L[now]);\n            ++now;\n        }\n        ans[e[i].id] -= qry1(1,1,n,e[i].l)+qry2(1,1,n,e[i].l);\n    }\n    REP(i,1,q) printf(\"%lld \", ans[i]);hr;\n}\n\u5728\u7ebf\u7684\u4ee3\u7801\u5982\u4e0b, RE on test 8.\n\n#include <iostream>\n#include <algorithm>\n#include <cstdio>\n#include <math.h>\n#include <set>\n#include <map>\n#include <queue>\n#include <string>\n#include <string.h>\n#define REP(i,a,n) for(int i=a;i<=n;++i)\n#define PER(i,a,n) for(int i=n;i>=a;--i)\n#define hr putchar(10)\n#define pb push_back\n#define lc TL[o]\n#define rc TR[o]\n#define mid ((l+r)>>1)\n#define ls lc,l,mid\n#define rs rc,mid+1,r\n#define x first\n#define y second\n#define io std::ios::sync_with_stdio(false)\n#define endl '\\n'\nusing namespace std;\ntypedef long long ll;\ntypedef pair<int,int> pii;\nconst int P = 1e9+7, INF = 0x3f3f3f3f;\nll gcd(ll a,ll b) {return b?gcd(b,a%b):a;}\nll qpow(ll a,ll n) {ll r=1%P;for (a%=P;n;a=a*a%P,n>>=1)if(n&1)r=r*a%P;return r;}\nll inv(ll x){return x<=1?1:inv(P%x)*(P-P/x)%P;}\n//head\n \nconst int N = 1e6+10, M = 1e7+10;\nint n, q, tot;\nint a[N], L[N], R[N], ql[N], qr[N];\nint cntL[N], cntR[N], sumL[N], sumR[N];\nint TL[M], TR[M];\nll val[M];\n \nvoid add(int &o, int l, int r, int x, int v) {\n    if (!o) o=++tot;\n    val[o] += v;\n    if (l==r) return;\n    if (mid>=x) add(ls,x,v);\n    else add(rs,x,v);\n}\nll query(int o, int l, int r, int ql, int qr) {\n    if (!o) return 0;\n    if (ql<=l&&r<=qr) return val[o];\n    ll ans = 0;\n    if (mid>=ql) ans += query(ls,ql,qr);\n    if (mid<qr) ans += query(rs,ql,qr);\n    return ans;\n}\n \nint main() {\n    scanf(\"%d%d\", &n, &q);\n    REP(i,1,n) scanf(\"%d\", a+i);\n    REP(i,1,n) {\n        L[i] = i-1;\n        while (L[i]&&a[i]>a[L[i]]) L[i]=L[L[i]];\n    }\n    PER(i,1,n) {\n        R[i] = i+1;\n        while (R[i]<=n&&a[i]>a[R[i]]) R[i]=R[R[i]];\n    }\n    REP(i,1,n) ++L[i],--R[i];\n    REP(i,1,n) {\n        for (int j=R[i]; j<=n; j+=j&-j) {\n            add(cntR[j],1,n,i,1);\n            add(sumR[j],1,n,i,R[i]);\n        }\n        for (int j=L[i]; j; j^=j&-j) {\n            add(cntL[j],1,n,i,1);\n            add(sumL[j],1,n,i,L[i]);\n        }\n    }\n    REP(i,1,q) scanf(\"%d\", ql+i);\n    REP(i,1,q) scanf(\"%d\", qr+i);\n    REP(i,1,q) {\n        ll sumr=0,suml=0,cntr=0,cntl=0;\n        int l=ql[i], r=qr[i];\n        for (int j=r; j; j^=j&-j) {\n            sumr += query(sumR[j],1,n,l,r);\n            cntr += query(cntR[j],1,n,l,r);\n        }\n        for (int j=l; j<=n; j+=j&-j) {\n            suml += query(sumL[j],1,n,l,r);\n            cntl += query(cntL[j],1,n,l,r);\n        }\n        ll ans = (ll)(r-l+1-cntr)*r+sumr;\n        ans -= (ll)(r-l+1-cntl)*l+suml;\n        ans += r-l+1;\n        printf(\"%lld \", ans);\n    } hr;\n}\n```\n# https://www.cnblogs.com/uid001/p/10519900.html",
        "postTime": 1559354580,
        "uid": 115514,
        "name": "cbyybccbyybc",
        "ccfLevel": 5,
        "title": "\u9898\u89e3 CF1117G \u3010Recursive Queries\u3011"
    },
    {
        "content": "## \u8fd9\u91cc\u7ed9\u51fa\u4e00\u79cd\u66f4\u52a0\u65b9\u4fbf\u3001\u66f4\u5feb\u7684\u505a\u6cd5\n\n\u5982\u53e6\u4e00\u7bc7\u9898\u89e3\u6240\u8bf4\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a$[l,r]$\uff0c\u6bcf\u4e2a\u70b9$i$\u7684\u8d21\u732e\u662f$min(R[i],r)-max(L[i],l)+1$\uff0c\u5176\u4e2d$L[i],R[i]$\u8868\u793a\u6bcf\u4e2a\u70b9\u5411\u5de6\u53f3\u5ef6\u4f38\u9047\u5230\u7684\u7b2c\u4e00\u4e2a\u6700\u5c0f\u503c\u7684\u4f4d\u7f6e$+1$\u3002\u8fd9\u4e2a\u53ef\u4ee5\u7528\u5355\u8c03\u6808\u6765\u7ef4\u62a4\u3002\n\n\u6211\u4eec\u628a$max(L[i],l)$\u63d0\u51fa\u6765\uff0c$min(R[i],r)$\u540c\u7406\u3002\n\n\u7136\u540e\u6211\u4eec\u8003\u8651\u679a\u4e3e$l$\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u70b9\uff0c\u5b83\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u53ea\u6709\u4e24\u79cd\uff1a$l$\u548c$L[i]$\uff0c\u90a3\u4e48\u4ece$l$\u5230$l+1$\uff0c\u8d21\u732e\u6709\u6539\u53d8\u7684\u53ea\u53ef\u80fd\u662f$L[i]=l$\u7684$i$\uff0c\u90a3\u4e48\u6211\u4eec\u76f4\u63a5\u5bf9\u8fd9\u4e9b\u70b9\u8fdb\u884c\u4fee\u6539\u5c31\u597d\u4e86\u3002\n\n\u6211\u4eec\u8003\u8651\u5982\u4e0b\u7b97\u6cd5\uff1a\n\n\u5f00\u4e24\u68f5\u6811\u72b6\u6570\u7ec4\uff0c\u4e00\u68f5\u7ef4\u62a4\u8868\u793a\u8fd9\u4e2a\u70b9\u5bf9\u4e8e\u7b54\u6848\u7684\u8d21\u732e\u662f\u5c5e\u4e8e$L[i]$\u7684\uff0c\u8bbe\u4e3a$tr1$\uff0c\u53e6\u4e00\u68f5\u7ef4\u62a4\u8fd9\u4e2a\u70b9\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u662f\u5c5e\u4e8e$l$\u7684\uff0c\u8bbe\u4e3a$tr2$\uff0c\u521a\u5f00\u59cb$tr2$\u6e05\u7a7a\uff0c$tr1$\u628a\u6240\u6709$L[i]$\u52a0\u5165\u3002\u6bcf\u6b21\u4ece$l$\u5230$l+1$\u7684\u65f6\u5019\uff0c\u628a$tr1$\u4e2d\u7684\u6240\u6709$L[i]=l$\u7684\u70b9\u8bbe\u4e3a$0$\uff0c\u800c\u5f80$tr2$\u4e2d\u52a0\u5165\u8fd9\u4e9b\u70b9\u5c31\u597d\u4e86\uff0c\u6700\u540e\u8be2\u95ee\u65f6\u76f4\u63a5\u533a\u95f4\u8be2\u95ee\u5c31\u597d\u4e86\u3002\n\nQ\uff1a\u6bcf\u6b21\u8be2\u95ee$l$\u90fd\u4e0d\u540c\uff0c\u600e\u4e48\u529e\uff1f\n\nA\uff1a$tr2$\u7ef4\u62a4\u6bcf\u4e2a\u70b9\u662f\u5426\u6709$l$\u7684\u8d21\u732e\uff0c\u8be2\u95ee\u65f6\u76f4\u63a5\u533a\u95f4\u8be2\u95ee$*l$\u5c31\u597d\u4e86\u3002\n\n\u81f3\u4e8e\u600e\u4e48\u627e\u5230\u6240\u6709$L[i]=l$\u7684\u70b9\uff0c\u53d1\u73b0$l$\u662f\u9012\u589e\u7684\uff0c\u76f4\u63a5\u628a$L[i]$\u6392\u5e8f\u540e\u6307\u9488\u626b\u63cf\u5373\u53ef\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6$O(nlogn)$\uff0c~~\u4f46\u662f\u6211\u4eec\u8981\u575a\u4fe1\u6811\u72b6\u6570\u7ec4\u5e38\u6570\u5c0f\u4e8e1\u2026\u2026~~\n\n### \u4ee3\u7801\u5982\u4e0b\uff1a\n\n```cpp\n#include<cstdio>\n#include<cstring>\n#include<cctype>\n#include<utility>\n#include<algorithm>\n#include<cmath>\nusing namespace std;\n#define res register int\n#define ll long long\n#define lowbit(x) ((x)&-(x))\n//#define cccgift\n#define getchar()(p1==p2&&(p2=(p1=buf)+fread(buf,1,1<<21,stdin),p1==p2)?EOF:*p1++)\nchar buf[1<<21],*p1=buf,*p2=buf;\nnamespace wode{\n    template<typename T>\n    inline void read(T &x)\n    {\n        static char ch;bool f=1;\n        for(x=0,ch=getchar();!isdigit(ch);ch=getchar()) if(ch=='-') f=0;\n        for(;isdigit(ch);x=(x<<1)+(x<<3)+(ch^48),ch=getchar());x=f?x:-x;\n    }\n    template<typename T>\n    void print(T x)\n    {\n        if (x<0) putchar('-'),x=-x;\n        if (x>=10) print(x/10);\n        putchar(x%10+'0');\n    }\n    template<typename T>\n    inline void print(T x,char ap) {print(x);if (ap) putchar(ap);}\n    template<typename T>\n    inline T max(const T &x,const T &y) {return x<y?y:x;}\n    template<typename T>\n    inline T min(const T &x,const T &y) {return x<y?x:y;}\n    template<typename T>\n    inline void chkmax(T &x,const T &y) {x=x<y?y:x;}\n    template<typename T>\n    inline void chkmin(T &x,const T &y) {x=x<y?x:y;}\n}\nusing wode::read;using wode::chkmin;using wode::chkmax;using wode::print;\nstruct node{\n\tint x,id;\n\tbool operator <(const node &b)const {return x<b.x;}\n} L[1000010],R[1000010];\nint n;\nstruct tree{\n\tll c[1000001];\n\tvoid clear() {memset(c,0,sizeof(c));}\n\tvoid modify(int b,int d) {for(;b<=n;c[b]+=d,b+=lowbit(b));}\n\tll query(int b) {ll tot=0;for(;b;tot+=c[b],b^=lowbit(b));return tot;}\n} tr1,tr2;\nint m,a[1000001],a1[1000001],a2[1000001],ver[1000010],edge[1000010],nxt[1000010],head[1000010],ans,ver1[1000010],edge1[1000010],nxt1[1000010],head1[1000010],ans1,stack[1000010],top;\nll tot[1000010];\ninline void add(int x,int y,int z) {ver[++ans]=y,edge[ans]=z,nxt[ans]=head[x],head[x]=ans;}\ninline void add1(int x,int y,int z) {ver1[++ans1]=y,edge1[ans1]=z,nxt1[ans1]=head1[x],head1[x]=ans1;}\nint main()\n{\n\tread(n),read(m);\n\tfor(res i=1;i<=n;++i) read(a[i]);\n\tfor(res i=1;i<=m;++i) read(a1[i]);\n\tfor(res i=1;i<=m;++i) read(a2[i]),add(a2[i],a1[i],i),add1(a1[i],a2[i],i),tot[i]=a2[i]-a1[i]+1; //\u6ce8\u610f\u7b54\u6848\u521d\u59cb\u5316\uff01\n\tfor(res i=1;i<=n;++i) {\n\t\tL[i].id=R[i].id=i;\n\t\tfor(;top&&a[i]>a[stack[top]];R[stack[top--]].x=i);\n\t\tstack[++top]=i;\n\t}\n\ttop=0;\n\tfor(res i=n;i;--i) {\n\t\tfor(;top&&a[i]>a[stack[top]];L[stack[top--]].x=i);\n\t\tstack[++top]=i;\n\t}\n\tfor(res i=1;i<=n;++i) if(!R[i].x) R[i].x=n+1;\n\tfor(res i=1;i<=n;++i) ++L[i].x,--R[i].x;\n//\tfor(res i=1;i<=n;++i) printf(\"%d %d\\n\",L[i].x,R[i].x);\n\tsort(L+1,L+1+n);\n\tfor(res i=1;i<=n;++i) tr1.modify(L[i].id,L[i].x); //\u6ce8\u610f\uff01\u8981\u8bb0\u5f55\u539f\u6765\u7684\u7f16\u53f7\uff0c\u5426\u5219\u7b54\u6848\u9519\u8bef\u3002\n\tint p=1;\n\tfor(res i=1;i<=n;++i) {\n\t\tfor(;p<=n&&L[p].x<=i;++p) tr1.modify(L[p].id,-L[p].x),tr2.modify(L[p].id,1); //\u6307\u9488\u626b\u63cf\n\t\tfor(res j=head1[i];j;j=nxt1[j]) tot[edge1[j]]-=tr1.query(ver1[j])-tr1.query(i-1)+(tr2.query(ver1[j])-tr2.query(i-1))*i;\n\t}\n\ttr1.clear(),tr2.clear(),sort(R+1,R+1+n),p=n;\n\tfor(res i=1;i<=n;++i) tr1.modify(R[i].id,R[i].x);\n\tfor(res i=n;i;--i) {\n\t\tfor(;p&&R[p].x>=i;--p) tr1.modify(R[p].id,-R[p].x),tr2.modify(R[p].id,1);\n\t\tfor(res j=head[i];j;j=nxt[j]) tot[edge[j]]+=tr1.query(i)-tr1.query(ver[j]-1)+(tr2.query(i)-tr2.query(ver[j]-1))*i;\n\t}\n\tfor(res i=1;i<=m;++i) print(tot[i],' ');puts(\"\");\n\treturn 0;\n}\n```",
        "postTime": 1571116787,
        "uid": 43697,
        "name": "chenyewei_1234",
        "ccfLevel": 7,
        "title": "CF1117G Recursive Queries"
    }
]