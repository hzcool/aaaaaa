[
    {
        "content": "wangyo Orz\uff01\n\n## \u9898\u610f\n\n\u6709 $n$ \u4e2a\u4eba\u548c $n$ \u5339\u9a6c\uff0c\u7b2c $i$ \u4e2a\u4eba\u5bf9\u5e94\u7b2c $i$ \u5339\u9a6c\uff0c\u7b2c $i$ \u4e2a\u4eba\u80fd\u529b\u503c\u4e3a $w_i$\uff0c\u7b2c $i$ \u5339\u9a6c\u80fd\u529b\u503c\u4e3a $h_i$\uff0c\u7b2c $i$ \u4e2a\u4eba\u9a91\u7b2c $j$ \u5339\u9a6c\u7684\u603b\u80fd\u529b\u503c\u4e3a $w_i\\times h_j$\uff0c\u6574\u4e2a\u519b\u961f\u7684\u603b\u80fd\u529b\u503c\u4e3a $\\sum w_i\\times h_j$\uff08\u4e00\u4e2a\u4eba\u53ea\u80fd\u9a91\u4e00\u5339\u9a6c\uff0c\u4e00\u5339\u9a6c\u53ea\u80fd\u88ab\u4e00\u4e2a\u4eba\u9a91\uff09\u3002\u6bcf\u4e2a\u4eba\u90fd\u4e0d\u80fd\u9a91\u81ea\u5df1\u5bf9\u5e94\u7684\u9a6c\uff0c\u5236\u5b9a\u9a91\u9a6c\u65b9\u6848\u4f7f\u6574\u4e2a\u519b\u961f\u7684\u603b\u80fd\u529b\u503c\u6700\u5927\u3002\u73b0\u5728\u6709 $q$ \u4e2a\u64cd\u4f5c\uff0c\u6bcf\u6b21\u7ed9\u51fa $a,b$\uff0c\u4ea4\u6362 $a$ \u548c $b$ \u5bf9\u5e94\u7684\u9a6c\uff0c\u6bcf\u6b21\u64cd\u4f5c\u540e\u90fd\u8f93\u51fa\u6700\u5927\u7684\u603b\u80fd\u529b\u503c\u3002\n\n## \u9898\u89e3\n\n\u76ee\u524d\u7f51\u4e0a\u6240\u6709\u9898\u89e3\u5305\u62ec\u5b98\u65b9\u9898\u89e3\u90fd\u6ca1\u6709\u7b2c\u4e8c\u4e2a\u7ed3\u8bba\u7684\u8bc1\u660e\uff0c\u6240\u4ee5\u8fd9\u7bc7\u9898\u89e3\u4e3b\u8981\u662f\u6765\u8865\u8bc1\u660e\u7684\u3002\n\n\u7ed3\u8bba $1$\uff1a\u628a $w,h$ \u6392\u5e8f\u540e\uff0c\u7b2c $i$ \u4e2a\u4eba\u5339\u914d\u7684\u9a6c\u5fc5\u5b9a\u5728 $[i-2, i+2]$ \u4e2d\u3002\n\n\u8bc1\u660e\uff1a\u89c1 [_sys \u7684\u9898\u89e3](https://www.luogu.com.cn/blog/sysblogs/solution-cf573d)\u3002\n\n\u7ed3\u8bba $2$\uff1a\u5728\u4e00\u79cd\u6700\u4f18\u5339\u914d\u4e2d\uff0c\u53ea\u6709\u4e09\u79cd\u53ef\u80fd\u7684\u5339\u914d\u7c7b\u578b\uff1a\u7b2c $i$ \u4e2a\u4eba\u4e0e\u7b2c $i$ \u5339\u9a6c\u5339\u914d\uff1b\u7b2c $i,i-1$ \u4e2a\u4eba\u4e0e\u7b2c $i,i-1$ \u5339\u9a6c\u5339\u914d\uff1b\u7b2c $i,i-1,i-2$ \u4e2a\u4eba\u4e0e\u7b2c $i,i-1,i-2$ \u5339\u9a6c\u5339\u914d\u3002\n\n\u8bc1\u660e\uff1a\u5982\u679c $[i,i+k]$ \u5185\u7684\u4eba\u548c\u9a6c\u80fd\u591f\u5185\u90e8\u5b8c\u5168\u5339\u914d\uff0c\u5219\u79f0\u5176\u4e3a\u4e00\u4e2a\u957f\u5ea6\u4e3a $k-i+1$ \u7684\u8fde\u7eed\u6bb5\u3002\u8be5\u7ed3\u8bba\u7b49\u4ef7\u4e8e\u8bc1\u660e\u5b58\u5728\u6700\u4f18\u65b9\u6848\u6ee1\u8db3\u5176\u4e2d\u6240\u6709\u8fde\u7eed\u6bb5\u957f\u5ea6\u90fd\u4e0d\u8d85\u8fc7 $3$\u3002\n\n\u8003\u8651\u53cd\u8bc1\uff0c\u5373\u5047\u8bbe\u6240\u6709\u6700\u4f18\u65b9\u6848\u4e2d\u90fd\u5b58\u5728\u957f\u5ea6\u8d85\u8fc7 $3$ \u7684\u8fde\u7eed\u6bb5\uff0c\u90a3\u4e48\u6211\u4eec\u8bc1\u660e\u5bf9\u6bcf\u4e00\u6bb5\u957f\u5ea6\u8d85\u8fc7 $3$ \u7684\u8fde\u7eed\u6bb5\u90fd\u53ef\u4ee5\u901a\u8fc7\u8c03\u6574\u4f7f\u5176\u53d8\u4e3a\u82e5\u5e72\u957f\u5ea6\u4e0d\u8d85\u8fc7 $3$ \u7684\u8fde\u7eed\u6bb5\u4e14\u7b54\u6848\u4e0d\u4f1a\u53d8\u52a3\u3002\n\n\u7531\u7ed3\u8bba $1$ \u53ef\u4ee5\u53d1\u73b0\uff0c\u5bf9\u4e8e\u957f\u5ea6\u8d85\u8fc7 $3$ \u7684\u8fde\u7eed\u6bb5\uff0c\u53ea\u6709\u5982\u4e0b\u4e24\u79cd\u7c7b\u578b\u3002\n\n\u7b2c\u4e00\u7c7b\uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/wcmb212l.png)\n\n\u8fd9\u79cd\u60c5\u51b5\u53ea\u6709\u8fde\u7eed\u6bb5\u7684\u957f\u5ea6\u4e3a $4$ \u65f6\u624d\u53ef\u80fd\u51fa\u73b0\u3002\n\n\u7531\u4e8e\u5df2\u7ecf\u662f\u6700\u4f18\u65b9\u6848\u4e86\uff0c\u6240\u4ee5\u6240\u6709\u9006\u5e8f\u5bf9\u90fd\u65e0\u6cd5\u76f4\u63a5\u8c03\u6574\u4f7f\u5176\u6d88\u5931\uff0c\u90a3\u4e48\u53ef\u4ee5\u5217\u51fa\u4e00\u4e9b\u9650\u5236\uff1a\n\nL1 \u4e0e R1 \u662f\u540c\u7ec4\u7684\u6216 L3 \u4e0e R3 \u662f\u540c\u7ec4\u7684\u3002\n\nL2 \u4e0e R2 \u662f\u540c\u7ec4\u7684\u6216 L4 \u4e0e R4 \u662f\u540c\u7ec4\u7684\u3002\n\nL1 \u4e0e R2 \u662f\u540c\u7ec4\u7684\u6216 L4 \u4e0e R3 \u662f\u540c\u7ec4\u7684\u3002\n\nL2 \u4e0e R1 \u662f\u540c\u7ec4\u7684\u6216 L3 \u4e0e R4 \u662f\u540c\u7ec4\u7684\u3002\n\n\u56fe\u4e2d\u8fde\u7684\u8fb9\u7684\u4e24\u7aef\u70b9\u90fd\u4e0d\u662f\u540c\u7ec4\u7684\u3002\n\n\u4e8e\u662f\u5217\u4e2a\u8868\u5c31\u53ef\u4ee5\u53d1\u73b0\u4e00\u5b9a\u80fd\u627e\u5230\u66f4\u4f18\u7684\u7b26\u5408\u6761\u4ef6\u7684\u65b9\u6848\u3002\n\n\u7b2c\u4e8c\u7c7b\uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/yh0fcaxc.png)\n\n\u6ce8\u610f\u8fd9\u79cd\u60c5\u51b5\u662f\u53ef\u4ee5\u65e0\u9650\u5ef6\u4f38\u7684\uff0c\u5373\u5bf9\u4e8e\u4efb\u610f $i\\ge4$\uff0c\u90fd\u80fd\u627e\u5230\u4e00\u79cd\u7c7b\u4f3c\u7684\u60c5\u51b5\uff0c\u6240\u4ee5\u6211\u4eec\u8003\u8651\u5f52\u7eb3\u8bc1\u660e\u3002\n\n1. L1 \u4e0e R2 \u4e0d\u540c\u7ec4\uff0cL4 \u4e0e R3 \u4e0d\u540c\u7ec4\uff0c\u90a3\u4e48\u53ef\u4ee5\u5c06 L1-R3\uff0cL4-R2 \u8c03\u6574\u4e3a L1-R2\uff0cL4-R3\u3002\u5c06\u4e00\u4e2a\u957f\u5ea6\u4e3a $n$ \u7684\u8fde\u7eed\u6bb5\u62c6\u6210\u4e86\u4e00\u4e2a\u957f\u5ea6\u4e3a $2$ \u548c\u4e00\u4e2a\u957f\u5ea6\u4e3a $n-2$ \u7684\u8fde\u7eed\u6bb5\u3002\n\n2. L1 \u4e0e R2 \u540c\u7ec4\uff0cL4 \u4e0e R3 \u4e0d\u540c\u7ec4\uff0c\u90a3\u4e48\u53ef\u4ee5\u5c06 L1-R3\uff0cL2-R1\uff0cL4-R2 \u8c03\u6574\u4e3a L1-R1\uff0cL2-R2\uff0cL4-R3\u3002\u5c06\u4e00\u4e2a\u957f\u5ea6\u4e3a $n$ \u7684\u8fde\u7eed\u6bb5\u62c6\u6210\u4e86\u4e24\u4e2a\u957f\u5ea6\u4e3a $1$ \u548c\u4e00\u4e2a\u957f\u5ea6\u4e3a $n-2$ \u7684\u8fde\u7eed\u6bb5\u3002\n\n3. L1 \u4e0e R2 \u4e0d\u540c\u7ec4\uff0cL4 \u4e0e R3 \u540c\u7ec4\uff0c\u90a3\u4e48\u53ef\u4ee5\u5c06 L1-R3\uff0cL3-R5\uff0cL4-R2 \u8c03\u6574\u4e3a L1-R2\uff0cL3-R3\uff0cL4-R5\u3002\u5c06\u4e00\u4e2a\u957f\u5ea6\u4e3a $n$ \u7684\u8fde\u7eed\u6bb5\u62c6\u6210\u4e86\u4e00\u4e2a\u957f\u5ea6\u4e3a $1$\uff0c\u4e00\u4e2a\u957f\u5ea6\u4e3a $2$ \u548c\u4e00\u4e2a\u957f\u5ea6\u4e3a $n-3$ \u7684\u8fde\u7eed\u6bb5\u3002\n\n4. L1 \u4e0e R2 \u540c\u7ec4\uff0cL4 \u4e0e R3 \u540c\u7ec4\uff0c\u90a3\u4e48\u53ef\u4ee5\u5c06 L1-R3\uff0cL2-R1 \u8c03\u6574\u4e3a L1-R1\uff0cL2-R3\u3002\u5c06\u4e00\u4e2a\u957f\u5ea6\u4e3a $n$ \u7684\u8fde\u7eed\u6bb5\u62c6\u6210\u4e86\u4e00\u4e2a\u957f\u5ea6\u4e3a $1$ \u548c\u4e00\u4e2a\u957f\u5ea6\u4e3a $n-1$ \u7684\u8fde\u7eed\u6bb5\u3002\n\n\u4e0a\u8ff0\u6240\u6709\u60c5\u51b5\u90fd\u80fd\u901a\u8fc7\u8c03\u6574\u4f7f\u5176\u53d8\u4e3a\u82e5\u5e72\u957f\u5ea6\u66f4\u77ed\u7684\u8fde\u7eed\u6bb5\u4e14\u7b54\u6848\u4e0d\u4f1a\u53d8\u52a3\uff0c\u6240\u4ee5\u7531\u5f52\u7eb3\u6cd5\u5f97\u8bc1\u3002\n\n\u6709\u4e86\u7ed3\u8bba $2$ \u540e\u5c31\u53ef\u4ee5\u8bbe\u8ba1 dp \u72b6\u6001\u4e86\uff0c\u5373 $dp_i$ \u8868\u793a\u524d $i$ \u7ec4\u4eba\u548c\u9a6c\u5185\u90e8\u5b8c\u5168\u5339\u914d\u7684\u6700\u5927\u7b54\u6848\uff0c$dp_i$ \u53ea\u80fd\u4ece $dp_{i-3},dp_{i-2},dp_{i-1}$ \u8f6c\u79fb\u6765\uff0c\u4e8e\u662f\u5c31\u53ef\u4ee5\u5217\u51fa\u8f6c\u79fb\u77e9\u9635\u52a8\u6001 dp \u4e86\u3002\n\n## Code\n\n```\n#include<bits/stdc++.h>\n#define LL long long\n#define inf 0x3f3f3f3f3f3f3f3f\nusing namespace std;\nint n,q;\nint idw[30002],idh[30002],tow[30002],toh[30002];\nLL w[30002],h[30002],t[30002];\nstruct Matrix\n{\n\tLL a[3][3];\n}M[30002];\ninline Matrix Mul(Matrix A,Matrix B)\n{\n\tMatrix C;\n\tfor(int i=0;i<3;++i)\n\t\tfor(int j=0;j<3;++j)\n\t\t{\n\t\t\tC.a[i][j]=-inf;\n\t\t\tfor(int k=0;k<3;++k)C.a[i][j]=max(C.a[i][j],A.a[i][k]+B.a[k][j]);\n\t\t}\n\treturn C;\n}\ninline int lson(int x)\n{\n\treturn (x<<1);\n}\ninline int rson(int x)\n{\n\treturn ((x<<1)|1);\n}\nstruct SegTree\n{\n\tMatrix a[120002];\n\tinline void build(int k,int l,int r)\n\t{\n\t\tif(l==r)return (void)(a[k]=M[l]);\n\t\tint mid=((l+r)>>1),ls=lson(k),rs=rson(k);\n\t\tbuild(ls,l,mid),build(rs,mid+1,r),a[k]=Mul(a[rs],a[ls]);\n\t}\n\tinline void modify(int k,int l,int r,int x)\n\t{\n\t\tif(l==r)return (void)(a[k]=M[l]);\n\t\tint mid=((l+r)>>1),ls=lson(k),rs=rson(k);\n\t\tif(x<=mid)modify(ls,l,mid,x);\n\t\telse modify(rs,mid+1,r,x);\n\t\ta[k]=Mul(a[rs],a[ls]);\n\t}\n}S;\ninline bool cmp(int x,int y)\n{\n\treturn t[x]<t[y];\n}\ninline void upd(int x)\n{\n\tM[x]=(Matrix){{idw[x]!=idh[x]? w[x]*h[x]:-inf,x>1? ((idw[x]!=idh[x-1] && idw[x-1]!=idh[x])? w[x]*h[x-1]+w[x-1]*h[x]:-inf):-inf,x>2? max((idw[x]!=idh[x-1] && idw[x-1]!=idh[x-2] && idw[x-2]!=idh[x])? w[x]*h[x-1]+w[x-1]*h[x-2]+w[x-2]*h[x]:-inf,(idw[x-1]!=idh[x] && idw[x-2]!=idh[x-1] && idw[x]!=idh[x-2])? w[x-1]*h[x]+w[x-2]*h[x-1]+w[x]*h[x-2]:-inf):-inf,0,-inf,-inf,-inf,0,-inf}};\n}\nint main()\n{\n\tscanf(\"%d%d\",&n,&q);\n\tfor(int i=1;i<=n;++i)scanf(\"%lld\",&w[i]),idw[i]=i,t[i]=w[i];\n\tsort(idw+1,idw+n+1,cmp);\n\tfor(int i=1;i<=n;++i)w[i]=t[idw[i]];\n\tfor(int i=1;i<=n;++i)scanf(\"%lld\",&h[i]),idh[i]=i,t[i]=h[i];\n\tsort(idh+1,idh+n+1,cmp);\n\tfor(int i=1;i<=n;++i)h[i]=t[idh[i]];\n\tfor(int i=1;i<=n;++i)tow[idw[i]]=toh[idh[i]]=i;\n\tfor(int i=1;i<=n;++i)upd(i);\n\tS.build(1,1,n);\n\tfor(int x,y;q--;)\n\t{\n\t\tscanf(\"%d%d\",&x,&y),swap(toh[x],toh[y]),swap(idh[toh[x]],idh[toh[y]]);\n\t\tfor(int i=toh[x];i<=min(toh[x]+2,n);++i)upd(i),S.modify(1,1,n,i);\n\t\tfor(int i=toh[y];i<=min(toh[y]+2,n);++i)upd(i),S.modify(1,1,n,i);\n\t\tprintf(\"%lld\\n\",S.a[1].a[0][0]);\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1657503931,
        "uid": 121216,
        "name": "18Michael",
        "ccfLevel": 9,
        "title": "CF573D Bear and Cavalry \u9898\u89e3"
    },
    {
        "content": "\u6211\u4eec\u8bbe $\\mathrm{ban}_i$ \u8868\u793a $i$ \u4e0d\u80fd\u5339\u914d\u7684\u9a6c\u3002\n\n\u5219\u6709\u7ed3\u8bba\uff1a\u6211\u4eec\u628a $w, h$ \u6392\u5e8f\u540e\uff0c\u6bcf\u4e2a\u4eba $i$ \u5339\u914d\u7684\u9a6c\u5fc5\u5b9a\u5728 $[i-2, i+2]$ \u4e2d\u3002\n\n\u8bc1\u660e\uff1a\u6211\u4eec\u628a\u6bcf\u4e2a\u4eba\u5f53\u4f5c\u4e00\u4e2a\u70b9\u653e\u5728\u5de6\u8fb9\uff0c\u6bcf\u5339\u9a6c\u5f53\u4f5c\u4e00\u4e2a\u70b9\u653e\u5728\u53f3\u8fb9\u3002\u6839\u636e\u6392\u5e8f\u4e0d\u7b49\u5f0f\uff0c$a_1 \\leq a_2, b_1 \\leq b_2$ \u5219 $a_1b_1+a_2b_2 \\geq a_2b_1+a_1b_2$\u3002\u6211\u4eec\u628a\u5339\u914d\u7684\u4eba\u548c\u9a6c\u8fde\u8fb9\uff0c\u5219\u4e0d\u4ea4\u53c9\u6bd4\u4ea4\u53c9\u7684\u6743\u503c\u66f4\u5927\uff0c\u6216\u8005\u8bf4\uff0c\u9006\u5e8f\u5bf9\u5f80\u66f4\u5c11\u8c03\u6574\uff0c\u6743\u503c\u66f4\u5927\u3002\n\n\u90a3\u4e48\uff0c\u6211\u4eec\u8003\u8651\u4e00\u7ec4\u5339\u914d $(i, i + 3)$\u3002\n\n![](https://codeforces.com/predownloaded/f3/df/f3dfa3aa136abc055d77562bd76f97f8598dfc0d.png)\n\n\u6b64\u65f6\uff0c\u5de6\u4e0b\u6bd4\u53f3\u4e0b\u591a\u4e86\u4e09\u4e2a\u70b9\uff0c\u6240\u4ee5\u81f3\u5c11\u6709\u4e09\u7ec4\u5339\u914d\u8de8\u8d8a\u4e86 $(i, i + 3)$\uff08\u7ea2\u7ebf\uff09\u3002\u7ea2\u7ebf\u4e2d\u53ef\u80fd\u6709\u4e00\u5339\u9a6c\u4e3a $\\mathrm{ban_i}$\uff0c\u6211\u4eec\u65e0\u6cd5\u4ea4\u6362\u5b83\u548c $(i, i+3)$\uff1b\u6709\u4e00\u4e2a\u4eba $j$ \u7684 $\\mathrm{ban}$ \u4e3a $i + 3$\uff0c\u6211\u4eec\u4e5f\u65e0\u6cd5\u4ea4\u6362\u5b83\u548c $(i, i + 3)$\u3002\u4f46\u8fd9\u6837\u603b\u4f1a\u5269\u4e0b\u4e00\u7ec4\u53ef\u4ee5\u4ea4\u6362\u3002\u4ea4\u6362\u540e\uff0c\u9006\u5e8f\u5bf9\u6570\u53d8\u5c11\u4e86\uff0c\u663e\u7136\u6743\u503c\u66f4\u5927\u3002\u6240\u4ee5\u4e0d\u4f1a\u5b58\u5728 $(i, i+3)$ \u7684\u5339\u914d\u3002$(i, i-3)$ \u540c\u7406\u3002\n\n\u540c\u65f6\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u4ea4\u6362\u7684\u8fc7\u7a0b\u5f97\u5230\u4e00\u6761\u6027\u8d28\uff1a\u5982\u679c\u524d $i$ \u4e2a\u4eba\u548c\u524d $i$ \u5339\u9a6c\u5339\u914d\u5b8c\u6210\uff0c\u90a3\u4e48\u5b58\u5728 $k\\leq 3$\uff0c\u4f7f\u5f97 $[i, i+k]$ \u4e2d\u7684\u4eba\u548c\u9a6c\u5339\u914d\u3002\u548c\u4e0a\u6587\u4e00\u6837\u53ef\u4ee5\u7528\u53cd\u8bc1\u6cd5\uff0c\u5f97\u5230\u5fc5\u7136\u5b58\u5728\u4e00\u79cd\u4ea4\u6362\u65b9\u5f0f\u3002\n\n\u6240\u4ee5\uff0c\u6211\u4eec\u8bbe $f_i$ \u8868\u793a\u524d $i$ \u4e2a\u4eba\u548c\u524d $i$ \u5339\u9a6c\u5339\u914d\u5b8c\u6210\u7684\u6700\u5927\u6743\u503c\uff0c\u53ea\u4ece $f_{i-3}, f_{i-2}, f_{i-1}$ \u8f6c\u79fb\u3002\n\n\u7531\u4e8e\u6709\u4fee\u6539\uff0c\u6211\u4eec\u76f4\u63a5\u7528\u52a8\u6001 dp \u5c31\u597d\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a$O(n\\log n \\omega^3)$\uff0c\u5176\u4e2d $\\omega=3$\u3002\n\n\u4ee3\u7801\uff1a\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n\nconst long long inf = 0x3f3f3f3f3f3f3f3fLL;\nconst int Maxn = 30005;\nint n, q, ban[Maxn], ord1[Maxn], ord2[Maxn], pos1[Maxn], pos2[Maxn];\nlong long a[Maxn], b[Maxn];\nstruct Matrix\n{\n\tlong long val[3][3];\n\tMatrix()\n\t{\n\t\tfor (int i = 0; i <= 2; i++)\n\t\t\tfor (int j = 0; j <= 2; j++)\n\t\t\t\tval[i][j] = -inf;\n\t}\n\tMatrix operator * (const Matrix &A) const\n\t{\n\t\tMatrix ans;\n\t\tfor (int i = 0; i <= 2; i++)\n\t\t\tfor (int j = 0; j <= 2; j++)\n\t\t\t\tfor (int k = 0; k <= 2; k++)\n\t\t\t\t\tans.val[i][k] = max(ans.val[i][k], val[i][j] + A.val[j][k]);\n\t\treturn ans;\n\t}\n};\nstruct Tree\n{\n\tint lt, rt;\n\tMatrix val;\n} tree[4 * Maxn];\nMatrix gen(int x)\n{\n\tMatrix result;\n\tresult.val[0][0] = (x > 2 && ban[x - 2] != x - 2) ? a[x - 2] * b[x - 2] : -inf;\n\tresult.val[0][1] = (x > 2 && ban[x - 2] != x - 1 && ban[x - 1] != x - 2) ? a[x - 2] * b[x - 1] + a[x - 1] * b[x - 2] : -inf;\n\tresult.val[0][2] = (x > 2 && ban[x - 2] != x - 1 && ban[x - 1] != x && ban[x] != x - 2) ? a[x - 2] * b[x - 1] + a[x - 1] * b[x] + a[x] * b[x - 2] : -inf;\n\tresult.val[0][2] = max(result.val[0][2], (x > 2 && ban[x - 2] != x && ban[x - 1] != x - 2 && ban[x] != x - 1) ? a[x - 2] * b[x] + a[x - 1] * b[x - 2] + a[x] * b[x - 1] : -inf);\n\tresult.val[1][0] = 0;\n\tresult.val[1][1] = (x > 1 && ban[x - 1] != x - 1) ? a[x - 1] * b[x - 1] : -inf;\n\tresult.val[1][2] = (x > 1 && ban[x - 1] != x && ban[x] != x - 1) ? a[x - 1] * b[x] + a[x] * b[x - 1] : -inf;\n\tresult.val[2][1] = 0;\n\tresult.val[2][2] = (ban[x] != x) ? a[x] * b[x] : -inf;\n\treturn result;\n}\nvoid build(int root, int lt, int rt)\n{\n\ttree[root] = (Tree){lt, rt};\n\tif (lt + 1 == rt)\n\t\ttree[root].val = gen(lt);\n\telse\n\t{\n\t\tint mid = (lt + rt) >> 1;\n\t\tbuild(root << 1, lt, mid);\n\t\tbuild(root << 1 | 1, mid, rt);\n\t\ttree[root].val = tree[root << 1].val * tree[root << 1 | 1].val;\n\t}\n}\nvoid modify(int root, int pos)\n{\n\tif (tree[root].lt + 1 == tree[root].rt)\n\t\ttree[root].val = gen(tree[root].lt);\n\telse\n\t{\n\t\tint mid = (tree[root].lt + tree[root].rt) >> 1;\n\t\tif (pos >= mid) modify(root << 1 | 1, pos);\n\t\telse modify(root << 1, pos);\n\t\ttree[root].val = tree[root << 1].val * tree[root << 1 | 1].val;\n\t}\n}\nint main()\n{\n\tscanf(\"%d%d\", &n, &q);\n\tfor (int i = 1; i <= n; i++)\n\t\tscanf(\"%lld\", &a[i]), ord1[i] = i;\n\tfor (int i = 1; i <= n; i++)\n\t\tscanf(\"%lld\", &b[i]), ban[i] = i, ord2[i] = i;\n\tsort(ord1 + 1, ord1 + 1 + n, [](int x, int y){return a[x] < a[y];});\n\tsort(ord2 + 1, ord2 + 1 + n, [](int x, int y){return b[x] < b[y];});\n\tfor (int i = 1; i <= n; i++)\n\t\tpos1[ord1[i]] = i, pos2[ord2[i]] = i;\n\tfor (int i = 1; i <= n; i++)\n\t\tban[pos1[i]] = pos2[i];\n\tsort(a + 1, a + 1 + n);\n\tsort(b + 1, b + 1 + n);\n\tbuild(1, 1, n + 1);\n\twhile (q--)\n\t{\n\t\tint x, y;\n\t\tscanf(\"%d%d\", &x, &y);\n\t\tswap(ban[pos1[x]], ban[pos1[y]]);\n\t\tfor (int i = max(1, pos1[x] - 2); i <= min(n, pos1[x] + 2); i++)\n\t\t\tmodify(1, i);\n\t\tfor (int i = max(1, pos1[y] - 2); i <= min(n, pos1[y] + 2); i++)\n\t\t\tmodify(1, i);\n\t\tMatrix res;\n\t\tres.val[0][2] = 0;\n\t\tprintf(\"%lld\\n\", (res * tree[1].val).val[0][2]);\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1604112968,
        "uid": 49093,
        "name": "_sys",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 CF573D \u3010Bear and Cavalry\u3011"
    },
    {
        "content": "[CF573D Bear and Cavalry](https://www.luogu.com.cn/problem/CF573D)\n\n\u9996\u5148\u8003\u8651\u6ca1\u6709\u9650\u5236\uff0c\u6839\u636e\u6392\u5e8f\u4e0d\u7b49\u5f0f\uff0c\u5c06$a,b$\u6392\u5e8f\u540e\u5bf9\u5e94\u5339\u914d\u4e00\u5b9a\u6700\u5927\u3002  \n\n\u7b80\u5355\u8bc1\u660e\u4e8c\u5143\u60c5\u51b5\uff1a\u8003\u8651 $w_i < w_j ,h_i < h_j$   \n\n$$\n\\begin{aligned}\n\\\\&\nw_ih_i+w_jh_j-w_ih_j-w_jh_i \\\\&\n=w_i(h_i-h_j)+w_j(h_j-h_i) \\\\&\n=(w_i-w_j)(h_i-h_j)>0\n\n\\end{aligned}\n$$\n\n\u63a8\u5e7f\u540e\uff0c\u6211\u4eec\u5e0c\u671b\u6574\u4e2a\u5e8f\u5217\u7684**\u9006\u5e8f\u5bf9**\u6700\u5c0f\u3002\n\n\u8003\u8651 $p_i \\neq q_i$ \u540e\uff0c\u6709\u4e00\u4e2a\u795e\u5947\u7684\u7ed3\u8bba\uff1a\u5728\u6392\u5e8f\u540e\uff0c\u7b2c $i$ \u4e2a\u4eba\u5339\u914d\u7684\u9a6c\u4e3a $[i-2,i+2]$ \u4e2d\u7684\u67d0\u4e00\u5339\u3002  \n\n\u8bc1\u660e\uff1a  \n\n![img](https://cdn.luogu.com.cn/upload/image_hosting/60ymxfj9.png?x-oss-process=image)\n\n\u82e5 $i$ \u5339\u914d $i-3$\uff08\u7ea2\u7ebf\uff09\uff0c\u5219\u4e00\u5b9a\u6709\u81f3\u5c11\u4e09\u4e2a\u9006\u5e8f\u5bf9\uff08\u7eff\u7ebf\uff09\uff0c\u4f46\u6211\u4eec\u60f3\u8981\u9006\u5e8f\u5bf9\u6700\u5c11\uff0c\u4e09\u4e2a\u4eba\u4e2d\u53ef\u80fd\u6709\u4e00\u4eba\u4e0d\u80fd\u5339\u914d $i-3$ \u9a6c\uff0c\u53ef\u80fd\u6709\u4e00\u4eba\u7684\u9a6c\u4e0d\u80fd\u5339\u914d $i$ \u4eba\uff0c\u5219\u81f3\u5c11\u6709\u4e00\u4e2a\u4eba\u53ef\u4ee5\u4e0e $(i,i-3)$ \u4ea4\u6362\uff0c\u51cf\u5c11\u9006\u5e8f\u5bf9\u3002  \n\n\u8bbe $f_i$ \u8868\u793a\u524d $i$ \u4eba\u5339\u914d\u524d $i$ \u9a6c\uff08\u6392\u5e8f\u540e\uff09\uff0c$f_i=\\max(f_{i-1}+a(i),f_{i-2}+b(i),f_{i-3}+c(i))$\u3002   \n\n$a(i),b(i),c(i)$ \u5206\u522b\u8868\u793a $i$ \u548c\u524d $0,1,2$ \u5339\u9a6c\u5339\u914d\u7684\u5185\u90e8\u7ed3\u679c\u3002\u8fd9\u90e8\u5206\u53ef\u4ee5\u63d0\u524d\u5904\u7406\u51fa\u6765\u3002  \n\n\u56e0\u4e3a\u6709\u4fee\u6539\uff0c\u8003\u8651\u52a8\u6001 $dp$\uff0c\u5217\u51fa\u77e9\u9635\uff08\u5e7f\u4e49\u7684\u77e9\u9635\u4e58\u6cd5\uff09\uff1a     \n$$\n\\left\\{\n\\begin{matrix}\na_i \\ b_i \\ c_i \\\\\n0 \\ - \\infty \\ - \\infty \\\\\n- \\infty \\ 0 \\ - \\infty\n\n\\end{matrix}\n\\right\\}\n\\times\n\\left\\{\n\\begin{matrix}\nf_{i-1}\\\\\nf_{i-2}\\\\\nf_{i-3}\n\\end{matrix}\n\\right\\}\n=\n\\left\\{\n\\begin{matrix}\nf_{i}\\ \\\\\nf_{i-1}\\\\\nf_{i-2}\n\\end{matrix}\n\\right\\}\n$$  \n\n\u4fee\u6539\u65f6\u5c31\u628a $[i,i+2]$ \u7684\u8f6c\u79fb\u77e9\u9635\u4e2d\u7684 $a,b,c$ \u66f4\u65b0\u3002  \n\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u533a\u95f4\u77e9\u9635\u4e58\uff0c\u52a8\u6001 $dp$ \u7684\u677f\u5b50\u3002  \n\n\u7ec6\u8282\uff1a  \n+ \u7528`orda`\uff0c`ordb`\u7ef4\u62a4\u539f\u5e8f\u5217\u5728\u6392\u5e8f\u540e\u7684\u4f4d\u7f6e\u3002  \n+ \u7528`ban`\u7ef4\u62a4\u6392\u5e8f\u540e $i$ \u4eba\u4e0d\u80fd\u5339\u914d\u7684\u9a6c\u3002\n+ \u8ba1\u7b97 $a_i,b_i,c_i$ \u76f4\u63a5\u66b4\u529b\uff08\u6ce8\u610f\u5224\u65ad\u4eba\u548c\u9a6c\u80fd\u4e0d\u80fd\u5339\u914d\uff09\u3002\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\ntypedef long long LL;\n#define fi first\n#define se second\n#define ls u<<1\n#define rs u<<1|1\nconst LL N=30010,inf=1e12;\nLL n,q;\nLL ban[N],ordb[N],orda[N];\npair<LL,LL>a[N],b[N];\nLL res=0;\nstruct matrix{\n\tLL g[4][4];\n\tmatrix operator*(const matrix B)const{\n\t\tmatrix C;\n\t\tmemset(C.g,-0x3f,sizeof C.g);\n\t\tfor(LL i=1;i<=3;i++)\n\t\t\tfor(LL j=1;j<=3;j++)\n\t\t\t\tfor(LL k=1;k<=3;k++)\n\t\t\t\t\tC.g[i][j]=max(C.g[i][j],g[i][k]+B.g[k][j]);\n\t\treturn C;\n\t}\n}Val[N];\nstruct node{\n\tLL l,r;\n\tmatrix M;\n}tr[4*N];\n\nvoid pushup(LL u)\n{\n\ttr[u].M=tr[rs].M*tr[ls].M;\n}\nvoid build(LL u,LL l,LL r)\n{\n\ttr[u].l=l,tr[u].r=r;\n\tif(l==r)\n\t{\n\t\ttr[u].M=Val[l];\n\t\treturn;\n\t } \n\tLL mid=(l+r)>>1;\n\tbuild(ls,l,mid);\n\tbuild(rs,mid+1,r);\n\tpushup(u);\n}\nvoid modify(LL u,LL x)\n{\n\tif(tr[u].l==tr[u].r)\n\t{\n\t\ttr[u].M=Val[x];\n\t\treturn;\n\t}\n\tLL mid=(tr[u].l+tr[u].r)>>1;\n\tif(x<=mid) modify(ls,x);\n\telse modify(rs,x);\n\tpushup(u);\n}\nvoid update(LL i)\n{\n\tVal[i].g[2][1]=Val[i].g[3][2]=0;\n\tVal[i].g[3][1]=Val[i].g[2][2]=Val[i].g[2][3]=Val[i].g[3][3]=Val[i].g[1][1]=Val[i].g[1][2]=Val[i].g[1][3]=-inf;\n\tif(i>=1) Val[i].g[1][1]=a[i].fi*b[i].fi*(ban[i]!=i);\n\tif(i>=2) Val[i].g[1][2]=max((a[i].fi*b[i].fi+a[i-1].fi*b[i-1].fi)*(ban[i]!=i)*(ban[i-1]!=i-1),(a[i].fi*b[i-1].fi+a[i-1].fi*b[i].fi)*(ban[i]!=i-1)*(ban[i-1]!=i));\n\tif(i>=3)\n\t{\n\t\tLL g[3];\n\t\tg[0]=0,g[1]=1,g[2]=2;\n\t\tdo\n\t\t{\n\t\t\tLL res=0;\n\t\t\tfor(LL j=0;j<=2;j++)\n\t\t\t\tres+=a[i-j].fi*b[i-g[j]].fi;\n\t\t\tfor(LL j=0;j<=2;j++)\n\t\t\t\tres*=(ban[i-j]!=i-g[j]);\n\t\t\tVal[i].g[1][3]=max(Val[i].g[1][3],res);\n\t\t}while(next_permutation(g,g+3));\n\t}\n\tfor(int j=1;j<=3;j++)\n\t\tif(!Val[i].g[1][j])\n\t\t\tVal[i].g[1][j]=-inf;\n\tmodify(1,i);\n}\nint main()\n{\n\tcin>>n>>q;\n\tfor(int i=1;i<=n;i++)\n\t\tscanf(\"%lld\",&a[i].fi),a[i].se=i;\n\tfor(int i=1;i<=n;i++)\t\n\t\tscanf(\"%lld\",&b[i].fi),b[i].se=i;\n\tsort(a+1,a+1+n);\n\tsort(b+1,b+1+n);\n\tfor(int i=1;i<=n;i++)\n\t\tordb[b[i].se]=i,orda[a[i].se]=i;\n\tfor(int i=1;i<=n;i++)\n\t\tban[i]=ordb[a[i].se];\n\tfor(int i=1;i<=n;i++)\n\t\tupdate(i);\n\tbuild(1,1,n);\n\tfor(int h=1;h<=q;h++)\n\t{\n\t\tLL x,y;\n\t\tscanf(\"%lld%lld\",&x,&y);\n\t\tx=orda[x],y=orda[y];\n\t\tswap(ban[x],ban[y]);\n\t\tfor(LL i=x;i<=min(n,x+2);i++) update(i);\n\t\tfor(LL i=y;i<=min(n,y+2);i++) update(i);\n\t\tmatrix ans=tr[1].M;\n\t\tprintf(\"%lld\\n\",max(ans.g[1][1],max(ans.g[1][2],ans.g[1][3])));\n\t}\n\t\n\treturn 0;\n}\n```\n\n",
        "postTime": 1656373668,
        "uid": 370005,
        "name": "tanyulin",
        "ccfLevel": 0,
        "title": "CF573D"
    },
    {
        "content": "####  CF573D Bear and Cavalry \n\n$dp$\u597d\u9898\u3002\n\n\u5148\u8003\u8651\u5982\u679c\u6ca1\u6709\u81ea\u5df1\u4e0d\u80fd\u9a91\u81ea\u5df1\u9a6c\u7684\u8981\u6c42\uff0c\u90a3\u4e48\u6839\u636e\u6392\u5e8f\u4e0d\u7b49\u5f0f\uff0c\u4e00\u5b9a\u662f\u6392\u5e8f\u540e\u5bf9\u5e94\u4f4d\u7f6e\u9a91\u5bf9\u5e94\u4f4d\u7f6e\u7684\u9a6c\u662f\u6700\u4f18\u7684\u3002\n\n\u800c\u6839\u636e\u6392\u5e8f\u4e0d\u7b49\u5f0f\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\uff0c\u6392\u5e8f\u540e\u9006\u5e8f\u5bf9\u8d8a\u5c11\u8d8a\u4f18\u3002\n\n\u4e8e\u662f\u4e4e\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u4e00\u4e2a\u7ed3\u8bba\u5462\uff0c\u5c31\u662f\u4e0d\u4f1a\u5b58\u5728$(i,i+3)$\u8fd9\u6837\u7684\u5339\u914d\u3002\n\n\u4e5f\u5c31\u662f\u8bf4\uff0c\u8bbe$f_i$\u8868\u793a\u524d$i$\u4e2a\u9a6c\u548c\u4eba\u7684\u5339\u914d\u6700\u5927\u6743\u503c\u548c\uff0c$f_i$\u53ea\u80fd\u4ece$f_{i-1},f_{i-2},f_{i-3}$\u8f6c\u79fb\u800c\u6765\u3002\n\n\u8003\u8651\u4fee\u6539\uff0c\u663e\u7136\u8fd9\u662f\u4e00\u4e2a\u52a8\u6001$dp$\u95ee\u9898\u3002\n\n\u800c\u8f6c\u79fb\u65b9\u7a0b\u662f\u8fd9\u4e2a\u5f62\u5f0f\n$$\nF(i)=\\max(F(i-1)+a(i),F(i-2)+b(i),F(i-3)+c(i))\n$$\n\u5176\u4e2d$a(i),b(i),c(i)$\u5206\u522b\u8868\u793a\u6700\u540e$1,2,3$\u4e2a\u9a6c\u548c\u4eba\u5185\u90e8\u5339\u914d\u7684\u6700\u4f18\u65b9\u6848\u3002\n\n\u6ce8\u610f\u5230$F(i)$\u7684\u8f6c\u79fb\u53ea\u548c\u524d\u4e09\u4e2a\u6709\u5173\uff0c\u56e0\u6b64\u4e0a\u8ff0\u5f62\u5f0f\u662f\u53ef\u4ee5\u5199\u6210\u4e00\u4e2a\u52a0\u540e\u53d6$\\max$\u7684\u5e7f\u4e49\u77e9\u9635\u4e58\u6cd5\u7684\u3002\n$$\n\\begin{bmatrix}   a(i) & b(i)& c(i)\\\\   0 &-\\infty & -\\infty\\\\   -\\infty &0 &-\\infty\\end{bmatrix}\\begin{bmatrix}   f_{i-1}\\\\   f_{i-2}\\\\   f_{i-3}\\end{bmatrix}=\\begin{bmatrix}   f_{i}\\\\   f_{i-1}\\\\   f_{i-2}\\end{bmatrix}\n$$\n\u4e4b\u540e\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u6bcf\u4e2a\u70b9\u7684\u77e9\u9635\uff0c\u4e58\u8d77\u6765\u5373\u53ef\u3002\n\n\uff08\u6ce8\u610f\u4e58\u7684\u65f6\u5019\u4e00\u5b9a\u8981\u662f\u53f3\u5b50\u6811\u4e58\u5de6\u5b50\u6811\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u77e9\u9635\u4e58\u6cd5\u4e0d\u6ee1\u8db3\u4ea4\u6362\u5f8b\u3002\uff09\n\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<cstring>\n#include<algorithm>\n#define N 200005\n#define int long long\nusing namespace std;\nint read()\n{\n\tint x=0,f=1;char ch=getchar();\n\twhile(ch<'0'||ch>'9'){if(ch=='-')f=-1;ch=getchar();}\n\twhile(ch>='0'&&ch<='9'){x=(x<<3)+(x<<1)+(ch^48);ch=getchar();}\n\treturn x*f;\n}\nint n,q,ban[N],posa[N],posb[N],A[N],B[N],newa[N],newb[N];\nstruct Martix\n{\n\tint a[4][4];\n\tvoid init(){memset(a,-0x3f,sizeof(a));}\n};\nMartix operator*(Martix a,Martix b)\n{\n\tMartix c;c.init();\n\tfor(int k=1;k<=3;k++)for(int i=1;i<=3;i++)for(int j=1;j<=3;j++)c.a[i][j]=max(c.a[i][j],a.a[i][k]+b.a[k][j]);\n\treturn c;\n}\nint cmpa(int x,int y){return A[x]<A[y];}\nint cmpb(int x,int y){return B[x]<B[y];}\nstruct Segment_Tree\n{\n\tMartix v[N*4];\n\tvoid update(int x,int k)\n\t{\n\t\tv[k].init();v[k].a[2][1]=v[k].a[3][2]=0;\n\t\tif(ban[x]!=x)v[k].a[1][1]=A[x]*B[x];\n\t\tif(x>=2)\n\t\t{\n\t\t\tif(ban[x]!=x-1&&ban[x-1]!=x)v[k].a[1][2]=A[x]*B[x-1]+A[x-1]*B[x];\n\t\t}\n\t\tif(x>=3)\n\t\t{\t\n            if(ban[x-2]!=x&&ban[x-1]!=x-1&&ban[x]!=x-2)v[k].a[1][3]=max(v[k].a[1][3],A[x-2]*B[x]+A[x-1]*B[x-1]+A[x]*B[x-2]);\n            if(ban[x-2]!=x-1&&ban[x-1]!=x&&ban[x]!=x-2)v[k].a[1][3]=max(v[k].a[1][3],A[x-2]*B[x-1]+A[x-1]*B[x]+A[x]*B[x-2]);\n            if(ban[x-2]!=x&&ban[x-1]!=x-2&&ban[x]!=x-1)v[k].a[1][3]=max(v[k].a[1][3],A[x-2]*B[x]+A[x-1]*B[x-2]+A[x]*B[x-1]);\n\t\t}\n\t}\n\tvoid build(int l,int r,int k)\n\t{\n\t\tif(l==r){update(l,k);return;}\n\t\tint mid=(l+r)>>1;\n\t\tbuild(l,mid,k*2);\n\t\tbuild(mid+1,r,k*2+1);\n\t\tv[k]=v[k*2+1]*v[k*2];\n\t}\n\tvoid modify(int l,int r,int k,int x)\n\t{\n\t\tif(l==r){update(l,k);return;}\n\t\tint mid=(l+r)>>1;\n\t\tif(x<=mid)modify(l,mid,k*2,x);\n\t\telse modify(mid+1,r,k*2+1,x);\n\t\tv[k]=v[k*2+1]*v[k*2];\n\t}\n\tvoid check()\n\t{\n\t\tfor(int i=1;i<=7;i++)\n\t\t{\n\t\t\tprintf(\"%lld\\n\",i);\n\t\t\tfor(int j=1;j<=3;j++)\n\t\t\t{\n\t\t\t\tfor(int k=1;k<=3;k++)\n\t\t\t\t{\n\t\t\t\t\tprintf(\"%lld \",v[i].a[j][k]);\n\t\t\t\t}\n\t\t\t\tputs(\"\");\n\t\t\t}\n\t\t}\n\t}\n}S;\nsigned main()\n{\n\tn=read();q=read();\n\tfor(int i=1;i<=n;i++)\n\t{\n\t\tA[i]=read();\n\t\tposa[i]=i;\n\t}\n\tfor(int i=1;i<=n;i++)\n\t{\n\t\tB[i]=read();\n\t\tposb[i]=i;\n\t}\n\tsort(posa+1,posa+n+1,cmpa);\n\tsort(posb+1,posb+n+1,cmpb);\n\tfor(int i=1;i<=n;i++)newa[posa[i]]=i,newb[posb[i]]=i;\n\tfor(int i=1;i<=n;i++)ban[newa[i]]=newb[i];\n\tsort(A+1,A+1+n);\n\tsort(B+1,B+1+n);\n//\tfor(int i=1;i<=n;i++)\n//\t{\n//\t\tprintf(\"%lld %lld %lld %lld %lld\\n\",posa[i],posb[i],newa[i],newb[i],ban[i]);\n//\t}\n\tS.build(1,n,1);\n//\tS.check();\n\twhile(q--)\n\t{\n\t\tint x=read(),y=read();\n\t\tx=newa[x];y=newa[y];\n//\t\tcout<<\"@@@@@@@@@@@@@@@@\"<<x<<\" \"<<y<<endl;\n\t\tswap(ban[x],ban[y]);\n//\t\tputs(\"################\");\n//\t\tfor(int i=1;i<=n;i++)\n//\t\t{\n//\t\t\tprintf(\"%lld \",ban[i]);\n//\t\t}\n\t\tfor(int i=max(1ll,x-2);i<=min(n,x+2);i++)S.modify(1,n,1,i);\n\t\tfor(int i=max(1ll,y-2);i<=min(n,y+2);i++)S.modify(1,n,1,i);\n//\t\tputs(\"!!!!!!!!!!!!!!!!!!!!!!!\");\n\t\tprintf(\"%lld\\n\",S.v[1].a[1][1]);\n//\t\tS.check();\n\t}\n\treturn 0;\n}\n\n```\n\n",
        "postTime": 1611566820,
        "uid": 179600,
        "name": "shao0320",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 CF573D \u3010Bear and Cavalry\u3011"
    }
]