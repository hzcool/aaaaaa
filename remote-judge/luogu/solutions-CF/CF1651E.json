[
    {
        "content": "\u8bb0 $g(l,r,L,R)=MM(G(l,r,L,R))$\uff0c\u8bbe $f(l,r)=\\sum_{n+1\\le L\\le R\\le 2n} g(l,r,L,R)$\u3002\r\n\r\n\u8003\u8651\u5bf9\u4e8e $\\forall 1\\le l \\le r\\le n$\uff0c\u8ba1\u7b97 $f(l,r)$ \u7684\u548c\u3002\r\n\r\n\u8003\u8651\u589e\u91cf\u6cd5\u3002\u6ce8\u610f\u5230 $g(l,r,L,R)-g(l,r-1,L,R)\\in\\{0,1\\}$\uff0c\u56e0\u6b64\u53ef\u4ee5\u8003\u8651\u7531 $f(l,r-1)$ \u5f97\u5230 $f(l,r)$\u3002\r\n\r\n\u5bf9\u4e8e $g(l,r,L,R)-g(l,r-1,L,R)=1$ \u7684\u60c5\u51b5\uff0c\u9996\u5148 $r$ \u4e00\u5b9a\u8981\u88ab\u5339\u914d\u5230\uff0c\u5426\u5219\u7b54\u6848\u4e0d\u4f1a\u589e\u5927\u3002\u9898\u76ee\u4e2d\u6bcf\u4e2a\u70b9\u7684\u5ea6\u6570\u4e3a $2$ \u4fdd\u8bc1\u4e86\u56fe\u7531\u82e5\u5e72\u4e2a\u5076\u73af\u6784\u6210\uff0c\u4e14\u6bcf\u4e2a\u5076\u73af\u7531 $[1,n]$ \u4e0e $[n+1,2n]$ \u4e2d\u7684\u6570\u4ea4\u66ff\u6784\u6210\u3002\u56e0\u6b64\u76f4\u63a5\u8003\u8651 $r$ \u6240\u5728\u7684\u73af\uff0c\u8bb0 $r$ \u6240\u5728\u7684\u73af\u6309\u73af\u4e0a\u7684\u987a\u5e8f\u5206\u522b\u4e3a $a_1,a_2,\\dots,a_{2m}$\uff0c\u4e14 $a_1=r$\u3002\r\n\r\n\u5047\u8bbe $g(l,r-1,L,R)$ \u4e2d\u524d\u82e5\u5e72\u4e2a\u8fde\u7eed\u7684\u5339\u914d\u4e3a $(a_2,a_3),(a_4,a_5),\\dots,(a_{2k},a_{2k+1})$\uff0c\u5219 $a_1$ \u4e0e $a_2$ \u5339\u914d\u540e\u80fd\u6539\u53d8\u6700\u5927\u5339\u914d\u5f53\u4e14\u4ec5\u5f53 $a_{2k+2}\\in [L,R]$\uff0c\u540c\u65f6\u7531\u4e8e $a_{2k+2}$ \u4e0d\u80fd\u4e0e $a_{2k+3}$ \u5339\u914d\uff0c\u5219 $a_{2k+3}\\notin [l,r]$\u3002\u90a3\u4e48\u8fd9\u6837\u7684 $k$ \u5bf9\u4e8e\u786e\u5b9a\u7684 $l,r$ \u6765\u8bf4\u662f\u552f\u4e00\u7684\uff0c\u6240\u4ee5\u901a\u8fc7\u9650\u5236 $a_2,a_4,\\dots,a_{2k+2}\\in [L,R]$\uff0c\u5219\u7b26\u5408\u8981\u6c42\u7684 $[L,R]$ \u7684\u5bf9\u6570\u53ef\u4ee5\u76f4\u63a5\u8ba1\u7b97\u5f97\u51fa\u3002\u5bf9\u4e8e $a_1$ \u4e0e $a_{2m}$ \u5339\u914d\u7684\u60c5\u51b5\u662f\u7c7b\u4f3c\u7684\u3002\u5c06\u4e24\u79cd\u65b9\u6848\u5408\u5e76\u5728\u4e00\u8d77\uff0c\u5373\u53ef\u8ba1\u7b97\u51fa\u6ee1\u8db3 $g(l,r,L,R)-g(l,r-1,L,R)=1$ \u7684 $(L,R)$ \u7684\u5bf9\u6570\u3002\u5bf9\u4e8e $a_1,a_3,\\dots,a_{2m-1}$ \u5168\u90e8\u5728 $[l,r]$ \u5185\u7684\u60c5\u51b5\u53ef\u4ee5\u5355\u72ec\u8ba8\u8bba\u3002\r\n\r\n\u679a\u4e3e $l,r$ \u540e\u76f4\u63a5\u66b4\u529b\u627e\u5230 $r$ \u6240\u5728\u73af\u4e0a\u7684\u5206\u754c\u70b9\uff0c\u5373\u53ef\u505a\u5230\u6548\u7387 $O(n^3)$\uff0c\u7531\u4e8e $(l,r)$ \u7684\u5bf9\u6570\u6709\u9650\uff0c\u4e14\u73af\u4e0a\u5206\u754c\u70b9\u5bf9\u4e8e $(l,r)$ \u4e0d\u540c\u7684\u60c5\u51b5\u4e5f\u4e92\u4e0d\u76f8\u540c\uff0c\u56e0\u6b64\u5b9e\u9645\u8ba1\u7b97\u7684\u6b21\u6570\u8fdc\u4f4e\u4e8e $n^3$\uff0c\u5728\u6781\u9650\u6570\u636e\u4e0b\u4e5f\u80fd\u901a\u8fc7\u3002\u5982\u679c\u91c7\u7528\u500d\u589e/\u6570\u636e\u7ed3\u6784\u4f18\u5316\u627e\u5230\u5206\u754c\u70b9\u4e0e\u6c42\u6700\u503c\u7684\u8fc7\u7a0b\u53ef\u4ee5\u505a\u5230 $O(n^2\\log n)$\u3002\r\n\r\n\u4ee3\u7801\uff1a\r\n```cpp\r\n#include<bits/stdc++.h>\r\nint n,tot,id[3010],id0[3010],id1[3010],cir[3010][6010];\r\nint cnt[3010],min[3010][2],max[3010][2];\r\nstd::vector<int> e[3010]; long long ans[3010][3010],Ans;\r\ninline void dfs ( int u )\r\n{\r\n\tid[u]=tot; cir[tot][++cnt[tot]]=u;\r\n\tif ( !id[e[u][0]] ) dfs(e[u][0]);\r\n\tif ( !id[e[u][1]] ) dfs(e[u][1]);\r\n}\r\nsigned main()\r\n{\r\n\tscanf(\"%d\",&n);\r\n\tfor ( int i=1,u,v;i<=2*n;i++ ) scanf(\"%d%d\",&u,&v),e[u].push_back(v),e[v].push_back(u);\r\n\tfor ( int i=1;i<=n;i++ ) if ( !id[i] )\r\n\t{\r\n\t\t++tot; dfs(i); min[tot][0]=max[tot][0]=cir[tot][1]; min[tot][1]=max[tot][1]=cir[tot][2];\r\n\t\tfor ( int j=3;j<=cnt[tot];j+=2 ) min[tot][0]=std::min(min[tot][0],cir[tot][j]),max[tot][0]=std::max(max[tot][0],cir[tot][j]);\r\n\t\tfor ( int j=4;j<=cnt[tot];j+=2 ) min[tot][1]=std::min(min[tot][1],cir[tot][j]),max[tot][1]=std::max(max[tot][1],cir[tot][j]);\r\n\t\tmin[tot][1]-=n; max[tot][1]-=n;\r\n\t\tfor ( int j=1;j<=cnt[tot];j++ ) cir[tot][j+cnt[tot]]=cir[tot][j],id0[cir[tot][j]]=j,id1[cir[tot][j]]=j+cnt[tot];\r\n\t}\r\n\tfor ( int l=1;l<=n;l++ )\r\n\t{\r\n\t\tfor ( int r=l;r<=n;r++ )\r\n\t\t{\r\n\t\t\tint i=id[r];\r\n\t\t\tif ( l<=min[i][0] and max[i][0]<=r ) ans[l][r]=ans[l][r-1]+min[i][1]*(n-max[i][1]+1);\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tint endpos1=0,endpos2=0;\r\n\t\t\t\tint l1=n+1,r1=0,l2=n+1,r2=0;\r\n\t\t\t\tfor ( int p=id0[r];;p+=2 ) if ( cir[i][p]<l or cir[i][p]>r ) { endpos1=p; break; }\r\n\t\t\t\tfor ( int p=id1[r];;p-=2 ) if ( cir[i][p]<l or cir[i][p]>r ) { endpos2=p; break; }\r\n\t\t\t\tfor ( int p=id0[r]+1;p<endpos1;p+=2 ) l1=std::min(l1,cir[i][p]-n),r1=std::max(r1,cir[i][p]-n);\r\n\t\t\t\tfor ( int p=id1[r]-1;p>endpos2;p-=2 ) l2=std::min(l2,cir[i][p]-n),r2=std::max(r2,cir[i][p]-n);\r\n\t\t\t\tans[l][r]=ans[l][r-1]+l1*(n-r1+1)+l2*(n-r2+1)-std::min(l1,l2)*(n-std::max(r1,r2)+1);\r\n\t\t\t}\r\n\t\t}\r\n\t\tfor ( int r=l;r<=n;r++ ) Ans+=ans[l][r];\r\n\t}\r\n\treturn !printf(\"%lld\\n\",Ans);\r\n```\r\n}",
        "postTime": 1647169613,
        "uid": 46197,
        "name": "_RSY_",
        "ccfLevel": 10,
        "title": "\u3010\u9898\u89e3\u3011CF1651E"
    },
    {
        "content": "\u663e\u7136\u539f\u56fe\u53ef\u4ee5\u5206\u6210\u82e5\u5e72\u4e2a\u70b9\u6570\u4e3a\u5076\u6570\u7684\u73af\u3002\n\n\u5148\u6765\u8003\u8651\u600e\u4e48\u7b97\u539f\u56fe\u7684\u4efb\u610f\u4e00\u4e2a\u5b50\u56fe\u7684\u6700\u5927\u5339\u914d\uff1a\u663e\u7136\u8fd9\u4e2a\u5b50\u56fe\u4e00\u5b9a\u53ef\u4ee5\u5206\u6210\u82e5\u5e72\u4e2a\u957f\u5ea6\u4e3a\u5076\u6570\u7684\u73af\u548c\u82e5\u5e72\u6761\u94fe\uff0c\u5bf9\u6700\u5927\u5339\u914d\u7684\u8d21\u732e\u90fd\u662f\u957f\u5ea6\u9664\u4ee5 $2$\uff08\u4e0b\u53d6\u6574\uff09\u3002\n\n\u6240\u4ee5\u53ef\u4ee5\u679a\u4e3e\u539f\u56fe\u7684\u6bcf\u4e00\u6761\u94fe\u548c\u6bcf\u4e00\u4e2a\u73af\uff0c\u8ba1\u7b97\u5176\u5728\u591a\u5c11\u4e2a\u5b50\u56fe\u4e2d\u4f1a\u6709\u76f4\u63a5\u8d21\u732e\uff08\u4e0d\u88ab\u5305\u542b\u5728\u5176\u4ed6\u73af\u6216\u94fe\u4e2d\uff09\uff0c\u4e58\u4e0a\u81ea\u8eab\u8d21\u732e\u52a0\u5230\u7b54\u6848\u91cc\u3002\u8ba1\u7b97\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u5206\u522b\u8bb0\u5f55\u73af / \u94fe\u4e0a $[1, n]$ \u548c $[n+1, 2n]$ \u4e24\u90e8\u5206\u7684\u6700\u5927\u548c\u6700\u5c0f\u503c\uff0c\u5f97\u51fa $l, r, L, R$ \u7684\u4e0a\u4e0b\u754c\uff1b\u5bf9\u4e8e\u94fe\u8fd8\u8981\u5904\u7406\u4e0e\u4e24\u4e2a\u7aef\u70b9\u76f8\u8fde\u4e14\u4e0d\u5728\u94fe\u4e0a\u7684\u4e24\u4e2a\u70b9\uff0c\u8981\u6c42\u5b50\u56fe\u4e0d\u80fd\u5305\u542b\u8fd9\u4e24\u4e2a\u70b9\u3002\u5b9e\u73b0\u7ec6\u8282\u89c1\u4ee3\u7801\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(n^2)$\u3002\n\n---\n\n```cpp\n#ifdef ONLINE_JUDGE\n#define NDEBUG\n#endif\n\n#include <cassert>\n\n#include <algorithm>\n#include <iostream>\n#include <utility>\n#include <vector>\n\nbool inRange(int l, int r, int x) {\n  assert(l <= r);\n  return x >= l && x <= r;\n}\n\n// \u4ece [l0, r0] \u4e2d\u9009\uff08\u4e0b\u540c\uff09\n// \u5305\u542b [l, r]\nlong countRanges(int l, int r, int l0, int r0) {\n  assert(l >= l0 && r <= r0 && l <= r);\n  return (l - l0 + 1L) * (r0 - r + 1);\n}\n\n// \u5305\u542b [l, r]\uff0c\u4e0d\u5305\u542b x\nlong countRanges(int l, int r, int l0, int r0, int x) {\n  assert(l >= l0 && r <= r0 && l <= r);\n  if (!inRange(l0, l, x) && !inRange(r, r0, x))\n    return (l - l0 + 1L) * (r0 - r + 1);\n  return inRange(l0, l, x) ? (l - x) * (r0 - r + 1L) : (l - l0 + 1L) * (x - r);\n}\n\n// \u5305\u542b [l, r]\uff0c\u4e0d\u5305\u542b x, y\nlong countRanges(int l, int r, int l0, int r0, int x, int y) {\n  assert(l >= l0 && r <= r0 && l <= r);\n  if (!inRange(l0, l, x) && !inRange(r, r0, x))\n    return countRanges(l, r, l0, r0, y);\n  if (!inRange(l0, l, y) && !inRange(r, r0, y))\n    return countRanges(l, r, l0, r0, x);\n  if (inRange(l0, l, x) && inRange(l0, l, y))\n    return countRanges(l, r, l0, r0, std::max(x, y));\n  if (inRange(r, r0, x) && inRange(r, r0, y))\n    return countRanges(l, r, l0, r0, std::min(x, y));\n  if (inRange(r, r0, x))\n    std::swap(x, y);\n  assert(inRange(l0, l, x) && inRange(r, r0, y));\n  return static_cast<long>(l - x) * (y - r);\n}\n\n// \u5bf9\u4e8e\u4e00\u4e2a\u73af\uff0c\u8ba1\u7b97\u672c\u8eab\u53ca\u73af\u4e0a\u7684\u6240\u6709\u94fe\u7684\u8d21\u732e\nlong long calc(const std::vector<int> &nodes, int n) {\n  const int m = nodes.size();\n  assert(m % 2 == 0);\n  long long sum = 0;\n  for (int i = 0; i < m; ++i) {\n    int s[4]{n - 1, 0, 2 * n - 1, n};\n    for (int j = i, cnt = 1; (j + 1) % m != i; j = (j + 1) % m, ++cnt) {\n      if (nodes[j] < n) {\n        if (nodes[j] < s[0])\n          s[0] = nodes[j];\n        if (nodes[j] > s[1])\n          s[1] = nodes[j];\n      } else {\n        if (nodes[j] < s[2])\n          s[2] = nodes[j];\n        if (nodes[j] > s[3])\n          s[3] = nodes[j];\n      }\n      if (cnt == 1)\n        continue;\n      const int u = nodes[(i + m - 1) % m], v = nodes[(j + 1) % m];\n      if (inRange(s[0], s[1], u) || inRange(s[2], s[3], u) ||\n          inRange(s[0], s[1], v) || inRange(s[2], s[3], v))\n        continue;\n      const auto c0 = cnt / 2LL;\n      const auto c1 = countRanges(s[0], s[1], 0, n - 1, u, v),\n                 c2 = countRanges(s[2], s[3], n, n * 2 - 1, u, v);\n      sum += c0 * c1 * c2;\n    }\n  }\n  int s[4]{n - 1, 0, 2 * n - 1, n};\n  for (int i = 0; i < m; ++i) {\n    if (nodes[i] < n) {\n      if (nodes[i] < s[0])\n        s[0] = nodes[i];\n      if (nodes[i] > s[1])\n        s[1] = nodes[i];\n    } else {\n      if (nodes[i] < s[2])\n        s[2] = nodes[i];\n      if (nodes[i] > s[3])\n        s[3] = nodes[i];\n    }\n  }\n  return sum + m / 2LL * countRanges(s[0], s[1], 0, n - 1) *\n                   countRanges(s[2], s[3], n, n * 2 - 1);\n}\n\nint main() {\n  std::ios::sync_with_stdio(false);\n  std::cin.tie(nullptr);\n  int n;\n  std::cin >> n;\n  std::vector<std::vector<int>> edges(n * 2);\n  for (int i = 0; i < n * 2; ++i) {\n    int x, y;\n    std::cin >> x >> y;\n    --x;\n    --y;\n    edges[x].push_back(y);\n    edges[y].push_back(x);\n  }\n  std::vector<bool> vis(n * 2, false);\n  long long answer = 0;\n  for (int i = 0; i < n * 2; ++i) {\n    if (vis[i])\n      continue;\n    std::vector<int> v{i, edges[i][0]};\n    while (v.back() != i) {\n      vis[v.back()] = true;\n      v.push_back(edges[v.back()][*(v.end() - 2) == edges[v.back()][0]]);\n    }\n    v.pop_back();\n    answer += calc(v, n);\n  }\n  std::cout << answer << '\\n';\n  return 0;\n}\n```",
        "postTime": 1647263189,
        "uid": 110634,
        "name": "zhanghengrui",
        "ccfLevel": 9,
        "title": "CF1651E Sum of Matchings \u9898\u89e3"
    },
    {
        "content": "## Solution\n\n\u8ba1\u7b97\u5339\u914d\u7684\u70b9\u6570\u663e\u7136\u6bd4\u8ba1\u7b97\u5339\u914d\u7684\u8fb9\u6570\u66f4\u4e3a\u7b80\u5355\u3002\n\n\u8003\u8651\u8ba1\u7b97\u6bcf\u4e2a\u5b50\u56fe $G'(l,r,L,R)$ \u4e2d\u5339\u914d\u7684\u70b9\u6570\u7684\u548c\uff0c\u9664\u4ee5 $2$ \u5373\u4e3a\u7b54\u6848\u3002\n\n\u5bf9\u4e8e\u672c\u9898\uff0c\u8ba1\u7b97\u6ca1\u5339\u914d\u7684\u70b9\u6570\u663e\u7136\u6bd4\u8ba1\u7b97\u5339\u914d\u7684\u70b9\u6570\u7b80\u5355\u3002\n\n\u5bf9\u4e8e\u4e00\u5f20\u5b50\u56fe $G'(l,r,L,R)$\uff0c\u6839\u636e\u6bcf\u4e2a\u70b9\u5ea6\u6570\u5c0f\u4e8e\u7b49\u4e8e $2$ \u7684\u6761\u4ef6\uff0c\u53ef\u4ee5\u5f97\u51fa\u5b50\u56fe\u4e00\u5b9a\u662f\u7531\u82e5\u5e72\u4e2a\u5076\u6570\u73af\u548c\u82e5\u5e72\u6761\u8def\u5f84\u7ec4\u6210\u7684\u3002\n\n\u5176\u4e2d\uff0c\u672a\u5339\u914d\u7684\u70b9\u4e00\u5b9a\u53ea\u5728\u5947\u6570\u8def\u5f84\u4e0a\uff0c\u4e14\u6bcf\u6761\u8def\u4e0a\u53ea\u6709\u4e00\u4e2a\u65e0\u6cd5\u5339\u914d\u3002\n\n\u95ee\u9898\u5c31\u5728\u4e8e\u5982\u4f55\u8ba1\u7b97\u6bcf\u4e2a\u5b50\u56fe $G'(l,r,L,R)$ \u7684\u5947\u6570\u8def\u5f84\u6761\u6570\u603b\u548c\u3002\n\n\u8003\u8651\u679a\u4e3e\u4e00\u4e2a\u5947\u6570\u8def\u5f84\u5e76\u5224\u65ad\u5b83\u4f1a\u5728\u51e0\u5f20\u5b50\u56fe\u4e2d\u51fa\u73b0\u3002\n\n\u5947\u6570\u8def\u5f84\u663e\u7136\u53ef\u4ee5\u7531\u552f\u4e00\u4e00\u4e2a\u4e8c\u5143\u7ec4 $(u, k)$ \u786e\u5b9a\u3002\u5176\u4e2d $u$ \u662f\u8fd9\u4e2a\u8def\u5f84\u7684\u4e2d\u70b9\uff0c $2k+1$ \u662f\u8fd9\u6761\u8def\u5f84\u7684\u957f\u5ea6\u3002\n\n\u4e8e\u662f\u8003\u8651\u679a\u4e3e $(u,k)$ \u5e76\u8fdb\u884c\u5224\u65ad\u3002\n\n\u5f53\u4e00\u4e2a\u8def\u5f84 $(u,k)$ \u5408\u6cd5\uff0c\u9700\u8981\u6ee1\u8db3\u4e24\u4e2a\u6761\u4ef6\uff1a\n\n1. \u5230 $u$ \u8ddd\u79bb\u5c0f\u4e8e\u7b49\u4e8e $k$ \u7684\u8282\u70b9\u7f16\u53f7\u90fd\u8981\u5728\u533a\u95f4 $[l, r]$ \u6216 $[L,R]$ \u5185\uff1b\n2. \u5230 $u$ \u8ddd\u79bb\u4e3a $k+1$ \u7684\u8282\u70b9\u4e0d\u80fd\u5728 $[l,r]$ \u6216 $[L,R]$ \u5185\u3002\n\n\u7ef4\u62a4\u8282\u70b9\u7f16\u53f7\u5728\u533a\u95f4 $[l,r]$ \u5185\u548c $[L,R]$ \u5185\u7684\u6700\u5c0f\u503c\u548c\u6700\u5927\u503c\uff0c\u5f97\u5230\u8fd9\u4e9b\u4fe1\u606f\u540e\u663e\u7136\u53ef\u4ee5 $\\mathcal O(1)$ \u6c42\u89e3\u65b9\u6848\u6570\u3002\n\n\u6240\u4ee5\u53ef\u4ee5\u5f97\u5230\u4e00\u4e2a\u6e05\u6670\u7684\u6d41\u7a0b\uff1a\n\n1. \u627e\u5230\u539f\u56fe\u4e0a\u7684\u4e00\u4e2a\u5076\u6570\u73af\uff0c\u8bb0\u73af\u957f\u4e3a $s$\uff1b\n2. \u5bf9\u4e8e\u73af\u4e0a\u6bcf\u4e2a\u70b9 $u$\uff0c\u5bf9 $k$ \u4ece $0$ \u5230 $\\frac{s}{2}$ \u679a\u4e3e\uff0c\u8ba1\u7b97\u7b54\u6848\u3002\n\n\u521d\u59cb\u65f6\u603b\u70b9\u6570\u5e94\u8be5\u662f\u5b50\u56fe\u6570\u91cf\u4e58\u4e0a $2n$\uff08\u5047\u8bbe\u6bcf\u4e2a\u70b9\u5728\u6bcf\u5f20\u5b50\u56fe\u90fd\u88ab\u5339\u914d\uff1b\u5bf9\u4e8e\u5b9e\u9645\u4e0a\u6839\u672c\u5c31\u4e0d\u5728\u5b50\u56fe\u4e2d\u7684\u70b9\uff0c\u6700\u540e\u6263\u6389\u5b83\u4e0d\u88ab\u9009\u4e2d\u7684\u65b9\u6848\u6570\u65f6\u5c31\u5305\u542b\u4e86\u8fd9\u4e2a\u53ef\u80fd\uff09\u3002\n\n\u603b\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal O(n^2)$\u3002\n\n## Code\n\n```cpp\n// Problem: E. Sum of Matchings\n// From: Codeforces - Educational Codeforces Round 124 (Rated for Div. 2)\n// URL: https://codeforces.com/contest/1651/problem/E\n// Time: 2022-03-14 18:02\n// Author: lingfunny\n\n#include <bits/stdc++.h>\n#define LL long long\nusing namespace std;\nconst int mxn = 3005;\n\nint n, m, vis[mxn], circle[mxn], len;\nLL tot;\nvector <int> G[mxn];\ninline void upd(int v, int& i, int& x) { i = min(i, v); x = max(x, v); }\ninline LL S(int x) { if(x<=0) return 0; return (LL)x*(x+1)>>1; }\ninline LL calc(int lr, int rl, vector <int> blks) {\n\t// blk: \u4e0d\u80fd\u9009\u7684\u70b9\n\tif(lr > rl) {\n\t\tint mn = *min_element(blks.begin(), blks.end()),\n\t\tmx = *max_element(blks.begin(), blks.end());\n\t\tif(mn > n) mn -= n, mx -= n;\n\t\treturn S(mn-1) + S(n-mx) + S(mx-mn-1);\n\t}\n\tint ll = 1, rr = n;\n\tfor(int c: blks) {\n\t\tif(c > n) c -= n;\n\t\tif(lr <= c && c <= rl) return 0;\n\t\telse if(c < lr) ll = max(ll, c+1);\n\t\telse if(c > rl) rr = min(rr, c-1);\n\t}\n\treturn (LL)(lr-ll+1) * (rr-rl+1);\n}\nvoid dfs(int u) { circle[++len] = vis[u] = u; for(int v: G[u]) if(!vis[v]) dfs(v); }\ninline int Q(int pos) {\n\tif(pos > len) pos -= len;\n\tif(pos < 1) pos += len;\n\treturn circle[pos];\n}\nvoid solve() {\n\tint K = len >> 1;\n\tfor(int i = 1, u; u = circle[i], i <= len; ++i) {\n\t\tint minl = n, maxl = 0, minr = n, maxr = 0;\n\t\tif(u <= n) maxl = minl = u; else minr = maxr = u - n;\n\t\tfor(int k = 1, l, r; k <= K; ++k) {\t\t// k \u5b9e\u6307 k+1\n\t\t\tl = i + k, r = i - k;\n\t\t\tvector <int> blks = {Q(l), Q(r)};\n\t\t\tLL res;\n\t\t\tif(blks[0] > n) res = calc(minl, maxl, {}) * calc(minr, maxr, blks);\n\t\t\telse res = calc(minl, maxl, blks) * calc(minr, maxr, {});\n\t\t\ttot += res;\n\t\t\tfor(int v: blks) if(v > n) minr = min(minr, v-n), maxr = max(maxr, v-n);\n\t\t\telse minl = min(minl, v), maxl = max(maxl, v);\n\t\t}\n\t}\n}\n\nsigned main() {\n\tscanf(\"%d\", &n); m = n << 1;\n\tfor(int i = 1, u, v; i <= m; ++i) {\n\t\tscanf(\"%d%d\", &u, &v);\n\t\tG[u].push_back(v);\n\t\tG[v].push_back(u);\n\t}\n\tfor(int u = 1; u <= n; ++u) if(!vis[u]) { len = 0; dfs(u); solve(); }\n\tfor(int u = 1; u <= n; ++u) tot += S(n) * (S(u-1) + S(n-u)) << 1;\t\t// \u6839\u672c\u4e0d\u9009 u\uff1b\u8fd9\u8fb9\u53ea\u679a\u4e3e\u4e86 1~n\uff0c\u6240\u4ee5\u4e58 2\n\tLL res = S(n)*S(n)*(n<<1);\n\tprintf(\"%lld\\n\", (res-tot)>>1);\n\treturn 0;\n}\n```\n\n",
        "postTime": 1647250227,
        "uid": 280800,
        "name": "lingfunny",
        "ccfLevel": 7,
        "title": "CF-EduRd-124E \u9898\u89e3"
    },
    {
        "content": "\u5f88\u4e0d\u9519\u7684\u4e00\u4e2a\u9898\u3002\n\n\u9996\u5148\u8003\u8651\u6211\u4eec\u4ece\u4e24\u4fa7\u5404\u622a\u51fa\u4e00\u4e2a\u533a\u95f4\u4e4b\u540e\u5f97\u5230\u7684\u56fe\u662f\u4ec0\u4e48\u6837\u5b50\u3002\u5ffd\u7565\u6389\u4e8c\u5206\u56fe\uff0c\u539f\u6765\u7684\u56fe\u662f\u4e00\u5806\u4e0d\u76f8\u4ea4\u7684\u73af\u3002\u7136\u540e\u622a\u51fa\u6765\u4e4b\u540e\u81ea\u7136\u5c31\u662f\u4e00\u5806\u4e0d\u76f8\u4ea4\u7684\u73af\u548c\u88ab\u62e6\u8170\u622a\u65ad\u7684\u73af\uff08\u4e5f\u5c31\u662f\u94fe\uff09\u3002\n\n\u7136\u540e\u6211\u4eec\u8003\u8651\u5339\u914d\u3002\u65e2\u7136\u539f\u6765\u662f\u4e2a\u4e8c\u5206\u56fe\uff0c\u90a3\u4e48\u622a\u51fa\u6765\u8fd8\u662f\u73af\u7684\u73af\u80af\u5b9a\u957f\u5ea6\u90fd\u662f\u5076\u6570\uff0c\u5339\u914d\u6570\u91cf\u5c31\u662f\u4e00\u4fa7\u7684\u70b9\u6570\u3002\u5173\u952e\u5728\u4e8e\u94fe\u3002\u7ecf\u8fc7\u4e00\u4e9b\u89c2\u5bdf\u5bb9\u6613\u53d1\u73b0\u5339\u914d\u6570\u662f \u94fe\u4e0a\u7684\u70b9\u6570\u9664\u4ee5 $2$ \u4e0b\u53d6\u6574\u3002\n\n\u90a3\u4e48\u6574\u4e2a\u56fe\u7684\u5339\u914d\u6570\u5c31\u662f \u70b9\u6570 \u51cf\u53bb \u6709\u5947\u6570\u4e2a\u70b9\u7684\u94fe\u7684\u4e2a\u6570 \u9664\u4ee5 $2$\u3002\n\n\u73b0\u5728\u6211\u4eec\u7528\u8fd9\u4e2a\u6765\u8ba1\u7b97\u8d21\u732e\u3002\u524d\u534a\u90e8\u5206\uff0c\u5373\u6240\u6709\u622a\u51fa\u6765\u7684\u5b50\u56fe\u7684\u70b9\u6570\u7684\u548c\u662f\u597d\u7b97\u7684\uff0c\u8003\u8651\u540e\u534a\u90e8\u5206\u3002\u8fd9\u91cc\u6211\u4eec\u6ce8\u610f\u5230\u6574\u4e2a\u56fe\u53ea\u6709 $3000$ \u4e2a\u70b9\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u628a\u6240\u6709\u6709\u5947\u6570\u4e2a\u70b9\u7684\u94fe\u5168\u90fd DFS \u679a\u4e3e\u51fa\u6765\uff0c\u7136\u540e\u8003\u8651\u6709\u591a\u5c11\u4e2a\u533a\u95f4\u5bf9\u4f7f\u5f97\u8fd9\u4e2a\u533a\u95f4\u5bf9\u622a\u51fa\u7684\u5b50\u56fe\u5305\u542b\u8fd9\u4e2a\u94fe\uff0c\u4e14\u8fd9\u4e2a\u94fe\u5728\u5b50\u56fe\u4e2d\u662f\u4e00\u4e2a\u72ec\u7acb\u7684\u8fde\u901a\u5757\u3002\u9650\u5236\u5c31\u662f\u8981\u5305\u542b\u8fd9\u4e2a\u94fe\u4e0a\u6240\u6709\u7684\u70b9\uff0c\u4e14\u4e0d\u5305\u542b\u4e0e\u8fd9\u6761\u94fe\u76f4\u63a5\u76f8\u8fde\u7684\u70b9\u3002\u8fd9\u4e2a\u76f4\u63a5\u7ef4\u62a4\u51fa\u94fe\u4e0a\u4e24\u4fa7\u5206\u522b\u7684 max/min \u7136\u540e\u5206\u7c7b\u8ba8\u8bba\u4e00\u624b\u5c31\u53ef\u4ee5\u7b97\u4e86\u3002\n\n\u90a3\u4e48\u8fd9\u6837\u8fd9\u9898\u5c31\u505a\u5b8c\u4e86\uff0c\u590d\u6742\u5ea6 $O(n^2)$\u3002\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n\nconst int N = 3005;\nstruct Edge {\n\tint to, nxt;\n\tEdge() {\n\t\tnxt = -1;\n\t}\n};\nint n, hd[N], pnt;\nEdge e[N << 1];\nlong long ans;\n\ninline void AddEdge(int u, int v) {\n\te[++pnt].to = v;\n\te[pnt].nxt = hd[u];\n\thd[u] = pnt;\n}\n\ninline void Read() {\n\tcin >> n;\n\tfor (int i = 1;i <= 2 * n;i++) {\n\t\tint u, v; cin >> u >> v;\n\t\tAddEdge(u, v);\n\t\tAddEdge(v, u);\n\t}\n}\n\ninline long long Totcnt(int n) {\n\treturn 1ll * n * (n + 1) / 2;\n}\n\ninline void Dfs1(int u, int fa, int dep, int lmn, int lmx, int rmn, int rmx, int le1) {\n\tif (u <= n) {\n\t\tfor (int i = hd[u];~i;i = e[i].nxt) {\n\t\t\tif (e[i].to != fa) Dfs1(e[i].to, u, dep + 1, lmn, lmx, min(rmn, e[i].to), max(rmx, e[i].to), le1);\n\t\t}\n\t} else {\n\t\tfor (int i = hd[u];~i;i = e[i].nxt) {\n\t\t\tif (e[i].to != fa) {\n\t\t\t\tint le2 = e[i].to;\n\t\t\t\tint ncl = min(le1, le2), ncr = max(le1, le2);\n\t\t\t\tlong long curans = ans;\n\t\t\t\tlong long rfc = 1ll * (rmn - n) * (2 * n - rmx + 1);\n\t\t\t\tif (dep == 1) ans -= (Totcnt(ncr - ncl - 1) + Totcnt(n - ncr) + Totcnt(ncl - 1)) * rfc;\n\t\t\t\telse {\n\t\t\t\t\tif (ncl > lmx) ans -= 1ll * lmn * max(ncl - lmx, 0) * rfc;\n\t\t\t\t\telse if (ncr < lmn) ans -= 1ll * max(lmn - ncr, 0) * (n - lmx + 1) * rfc;\n\t\t\t\t\telse ans -= 1ll * max(lmn - ncl, 0) * max(ncr - lmx, 0) * rfc;\n\t\t\t\t}\n\t\t\t\tif (e[i].to != le1) Dfs1(e[i].to, u, dep + 1, min(lmn, e[i].to), max(lmx, e[i].to), rmn, rmx, le1);\n\t\t\t}\n\t\t}\n\t}\n}\n\ninline void Dfs2(int u, int fa, int dep, int lmn, int lmx, int rmn, int rmx, int le1) {\n\tif (u > n) {\n\t\tfor (int i = hd[u];~i;i = e[i].nxt) {\n\t\t\tif (e[i].to != fa) Dfs2(e[i].to, u, dep + 1, lmn, lmx, min(rmn, e[i].to), max(rmx, e[i].to), le1);\n\t\t}\n\t} else {\n\t\tfor (int i = hd[u];~i;i = e[i].nxt) {\n\t\t\tif (e[i].to != fa) {\n\t\t\t\tint le2 = e[i].to;\n\t\t\t\tint ncl = min(le1, le2), ncr = max(le1, le2);\n\t\t\t\tlong long rfc = 1ll * rmn * (n - rmx + 1);\n\t\t\t\tif (dep == 1) ans -= (Totcnt(ncr - ncl - 1) + Totcnt(2 * n - ncr) + Totcnt(ncl - n - 1)) * rfc;\n\t\t\t\telse {\n\t\t\t\t\tif (ncl > lmx) ans -= 1ll * (lmn - n) * max(ncl - lmx, 0) * rfc;\n\t\t\t\t\telse if (ncr < lmn) ans -= 1ll * max(lmn - ncr, 0) * (2 * n - lmx + 1) * rfc;\n\t\t\t\t\telse ans -= 1ll * max(lmn - ncl, 0) * max(ncr - lmx, 0) * rfc;\n\t\t\t\t}\n\t\t\t\tif (e[i].to != le1) Dfs2(e[i].to, u, dep + 1, min(lmn, e[i].to), max(lmx, e[i].to), rmn, rmx, le1);\n\t\t\t}\n\t\t}\n\t}\n}\n\ninline void Solve() {\n\tfor (int i = 1;i <= n;i++) {\n\t\tfor (int j = hd[i];~j;j = e[j].nxt) Dfs2(i, e[j].to, 1, 0x3f3f3f3f, 0xf3f3f3f3, i, i, e[j].to);\n\t}\n\tfor (int i = n + 1;i <= 2 * n;i++) {\n\t\tfor (int j = hd[i];~j;j = e[j].nxt) Dfs1(i, e[j].to, 1, 0x3f3f3f3f, 0xf3f3f3f3, i, i, e[j].to);\n\t}\n\tans /= 2;\n\tfor (int i = 1;i <= n;i++) {\n\t\tfor (int j = i;j <= n;j++) ans += 1ll * n * (n + 1) * (j - i + 1);\n\t}\n\tcout << ans / 2 << endl;\n}\n\nint main() {\n\tmemset(hd, -1, sizeof(hd));\n\tRead();\n\tSolve();\n\treturn 0;\n}\n```\n\n~~\u4ee3\u7801\u521a\u597d 100 \u884c\uff01~~",
        "postTime": 1647178224,
        "uid": 61088,
        "name": "Solystic",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 CF1651E \u3010Sum of Matchings\u3011"
    }
]