[
    {
        "content": "\u7ed9\u5b9a $n$ \u4e2a\u70b9 $\\mathbf{f_i}$ \u5e26\u6743 $a_i$ \u548c $k$ \u4e2a\u5411\u91cf $\\mathbf{v_i}$\uff0c$q$ \u6b21\u8be2\u95ee $\\mathbf p$ \u548c $t$\uff0c\u6c42\u5b58\u5728\u5b9e\u6570 $w_j\\in[-t,t]$ \u6ee1\u8db3 $\\mathbf{f_i}+\\sum w_j\\mathbf{v_j}=\\mathbf p$ \u7684 $a_i$ \u4e4b\u548c\u3002\n\n$2\\le k\\le 10$\uff0c$1\\le n\\le 10^5$\uff0c$|vx_i|,|vy_i|\\le 10^3$\uff0c$|fx_i|,|fy_i|,|px|,|py|\\leq 10^9$\uff0c$1\\leq a_i\\leq 10^9$\uff0c$1\\leq t_i\\leq 10^5$\u3002\n\n---\n\n[\u66f4\u4e0d\u597d\u7684\u9605\u8bfb\u4f53\u9a8c](https://www.cnblogs.com/AThousandMoons/p/14906122.html)\n\n\u540e\u9762\u7684 $\\sum w_j\\mathbf{v_j}$ \u663e\u7136\u662f\u4e00\u4e2a\u51f8\u5305\uff08Minkowski \u548c\uff09\uff0c\u4f46\u8fd9\u4e2a\u51f8\u5305\u548b\u6c42\u5462\uff1f\n\n\u82e5 $vx_i<0\\land vx_i=0\\lor vy_i<0$ \u5219\u4ee4 $\\mathbf{v_i}$ \u53d6\u53cd\uff0c\u4ee4 $\\mathbf p=\\mathbf p-t\\sum\\mathbf{v_j}$\uff0c\u5e76\u79fb\u9879\u5f97\u5230 $\\mathbf{f_i}=\\mathbf p+\\sum w_j\\mathbf{v_j}$\uff0c$w_j$ \u7684\u53d6\u503c\u8303\u56f4\u53d8\u4e3a $[0,2t]$\uff0c\u6b64\u65f6\u76f4\u63a5\u628a\u6240\u6709 $\\mathbf{v_j}$ \u6309\u659c\u7387\u6392\u5e8f\uff0c\u6309\u4ece\u5c0f\u5230\u5927\u7684\u987a\u5e8f\u4ece $\\mathbf p$ \u5f00\u59cb\u52a0\u5c31\u662f\u4e0b\u51f8\u58f3\uff0c\u4ece\u5927\u5230\u5c0f\u7684\u987a\u5e8f\u5c31\u662f\u4e0a\u51f8\u58f3\u3002\n\n\u56e0\u4e3a\u51f8\u5305\u7684\u8fb9\u53ea\u6709 $2k$ \u6761\uff0c\u6240\u4ee5\u53ef\u4ee5\u62c6\u6210\u4e00\u5806\u5e95\u8fb9\u4e0e $y$ \u8f74\u5e73\u884c\uff0c\u76f4\u89d2\u8fb9\u5728 $-\\infty$ \u7684\u76f4\u89d2\u68af\u5f62\uff0c\u7ea6\u675f\u5373\u4e3a $x\\in[l,r]$ \u548c $y-kx\\leq b$\uff0c\u4ee4 $y:=y-kx$ \u4e4b\u540e\u5c31\u662f\u4e8c\u7ef4\u6570\u70b9\uff0c\u5bf9\u7eb5\u5750\u6807\u626b\u63cf\u7ebf\uff0c\u5bf9\u6a2a\u5750\u6807\u79bb\u6563\u5316\u4e4b\u540e\u7528\u6811\u72b6\u6570\u7ec4\u7ef4\u62a4\u5373\u53ef\u3002\n\n\u6ce8\u610f\u626b\u63cf\u7ebf\u505a\u76f8\u540c\u7eb5\u5750\u6807\u65f6\u7684\u987a\u5e8f\uff08\u5148\u8be2\u95ee\u8fd8\u662f\u5148\u4fee\u6539\uff09\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $O((n+q)k\\log n)$\u3002\n\n```cpp\n#include<bits/stdc++.h>\n#define MP make_pair\n#define PB emplace_back\n#define all(x) x.begin(), x.end()\n#define fi first\n#define se second\nusing namespace std;\ntypedef long long LL;\ntypedef pair<int, int> pii;\nconst int N = 100010;\nint rd(){\n\tint ch = getchar(), x = 0; bool f = false;\n\tfor(;ch < '0' || ch > '9';ch = getchar()) f |= ch == '-';\n\tfor(;ch >= '0' && ch <= '9';ch = getchar()) x = x * 10 + ch - '0';\n\treturn f ? -x : x;\n}\nint k, n, q, sx, sy, x[N], y[N], a[N], px[N], py[N], t[N];\npii v[11];\nLL ans[N], tr[N];\nvector<int> val;\nint pos(int x){return upper_bound(all(val), x) - val.begin();}\nstruct Node {\n\tdouble a;\n\tint x, y, id;\n\tNode(double _a = 0, int _x = 0, int _y = 0, int _z = 0): a(_a), x(_x), y(_y), id(_z){}\n\tbool operator < (const Node &o) const {return fabs(a-o.a)<1e-7?id<o.id:a<o.a;}\n} w[N<<1];\nbool cmp(const pii &a, const pii &b){\n\tif(!b.fi) return a.fi || a.se < b.se;\n\treturn a.se * b.fi < b.se * a.fi;\n}\nvoid upd(int p, int v){for(;p < N;p += p & -p) tr[p] += v;}\nLL qry(int p){LL r = 0; for(;p;p -= p & -p) r += tr[p]; return r;}\nint main(){\n\tk = rd(); n = rd(); q = rd();\n\tfor(int i = 1;i <= k;++ i){\n\t\tv[i].fi = rd(); v[i].se = rd();\n\t\tif(v[i].fi < 0){\n\t\t\tv[i].fi = -v[i].fi;\n\t\t\tv[i].se = -v[i].se;\n\t\t} else if(!v[i].fi && v[i].se < 0)\n\t\t\tv[i].se = -v[i].se;\n\t\tsx += v[i].fi; sy += v[i].se;\n\t}\n\tsort(v+1, v+k+1, cmp);\n\tfor(int i = 1;i <= n;++ i){\n\t\tval.PB(x[i] = rd());\n\t\ty[i] = rd(); a[i] = rd();\n\t}\n\tsort(all(val));\n\tval.erase(unique(all(val)), val.end());\n\tfor(int i = 1;i <= q;++ i){\n\t\tpx[i] = rd(); py[i] = rd(); t[i] = rd();\n\t\tpx[i] -= sx*t[i]; py[i] -= sy*t[i]; t[i] <<= 1;\n\t}\n\tfor(int i = 1;i <= k;++ i){\n\t\tif(!v[i].fi){\n\t\t\tfor(int j = 1;j <= q;++ j)\n\t\t\t\tpy[j] += v[i].se * t[j];\n\t\t\tcontinue;\n\t\t}\n\t\tdouble k = 1.*v[i].se/v[i].fi;\n\t\tfor(int j = 1;j <= n;++ j)\n\t\t\tw[j] = Node(y[j] - k*x[j], x[j], a[j], 0);\n\t\tfor(int j = 1;j <= q;++ j){\n\t\t\tw[n+j] = Node(py[j] - k*px[j], px[j], px[j] + v[i].fi*t[j], -j);\n\t\t\tpx[j] += v[i].fi*t[j]; py[j] += v[i].se*t[j]; \n\t\t}\n\t\tsort(w+1, w+n+q+1); memset(tr, 0, sizeof tr);\n\t\tfor(int j = 1;j <= n+q;++ j)\n\t\t\tif(w[j].id) ans[-w[j].id] -= qry(pos(w[j].y))-qry(pos(w[j].x-(i<2)));\n\t\t\telse upd(pos(w[j].x), w[j].y);\n\t}\n\tfor(int i = 1;i <= k;++ i){\n\t\tif(!v[i].fi) break;\n\t\tdouble k = 1.*v[i].se/v[i].fi;\n\t\tfor(int j = 1;j <= n;++ j)\n\t\t\tw[j] = Node(y[j] - k*x[j], x[j], a[j], 0);\n\t\tfor(int j = 1;j <= q;++ j){\n\t\t\tw[n+j] = Node(py[j] - k*px[j], px[j] - v[i].fi*t[j], px[j], j);\n\t\t\tpx[j] -= v[i].fi*t[j]; py[j] -= v[i].se*t[j];\n\t\t}\n\t\tsort(w+1, w+n+q+1); memset(tr, 0, sizeof tr);\n\t\tfor(int j = 1;j <= n+q;++ j)\n\t\t\tif(w[j].id) ans[w[j].id] += qry(pos(w[j].y-(i>1))) - qry(pos(w[j].x-1));\n\t\t\telse upd(pos(w[j].x), w[j].y);\n\t}\n\tfor(int i = 1;i <= q;++ i) printf(\"%lld\\n\", ans[i]);\n}\n```",
        "postTime": 1624154059,
        "uid": 68148,
        "name": "watermoon",
        "ccfLevel": 10,
        "title": "CF853E"
    }
]