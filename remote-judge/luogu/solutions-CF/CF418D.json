[
    {
        "content": "\u6211\u4eec\u8003\u8651\u5148\u9884\u5904\u7406\u51fa\u76f4\u5f84\uff0c\u7136\u540e\u500d\u589e\u7ef4\u62a4\u76f4\u5f84\u4e0a\u533a\u95f4 $w_i$ \u7684\u6700\u5927\u503c\uff0c\n\n$w_i$ \u8868\u793a\u8be5\u70b9\u5b50\u6811\u5185\u7684\u70b9\u5230\u76f4\u5f84\u4e24\u7aef\u70b9\u7684\u6700\u5927\u503c\n\n\u53ef\u4ee5\u7528RMQ\u9884\u5904\u7406\uff0c\u505a\u5230\u5355\u6b21\u67e5\u8be2$O(1)$\n\n\u7136\u540e\u6211\u4eec\u8003\u8651\u67e5\u8be2\uff0c\u5bf9\u4e8e\u6bcf\u6b21\u67e5\u8be2\n\n\u6700\u8fdc\u70b9\u53ea\u6709\u53ef\u80fd\u662f\u4e24\u79cd\u60c5\u51b5\uff0c\u4e00\u79cd\u662f\u5230\u4e24\u4e2a\u4e3b\u65c5\u9986\u8ddd\u79bb\u5dee\u4e0d\u8d85\u8fc7$1$\u7684\u70b9\n\n\u6216\u8005\u662f\u76f4\u5f84\u7aef\u70b9\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5927\u529b\u5206\u7c7b\u8ba8\u8bba $u,v$ \u7684\u60c5\u51b5\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(nlogn+m)$ \n\n**Code:**\n\n```\n#include<bits/stdc++.h>\n\n#define rd(x) x=read()\n#define inf 1e9\n\n#define N 100005\n\nusing namespace std;\n\nint n,m;\nvector<int>e[N],rec;\nconst int B=17;\nint fa[N],tp[N],f[N],vis[N];\nint maxlen,pos,dep[N];\nint st[2][18][N],lg[N];\nconst int base=2333,p=19260817;\n\ninline int read()\n{\n    int x=0,f=1;char ch=getchar();\n    while(ch>'9'||ch<'0'){if(ch=='-')f=-1;ch=getchar();}\n    while(ch>='0'&&ch<='9'){x=x*10+ch-'0';ch=getchar();}\n    return x*f;\n}\n\ninline void write(int x)\n{\n    if(x<0){putchar('-');x=-x;}\n    if(x>=10)write(x/10);\n    putchar(x%10+'0');\n}\n\ninline void addEdge(int u,int v){e[u].push_back(v);}\n\nvoid dfs(int u,int faa,int dis,int flg)\n{\n\tif(maxlen<dis)maxlen=dis,pos=u;\n\tif(flg)fa[u]=faa;\n\tfor(int i=0;i<e[u].size();i++)\n\t{\n\t\tint v=e[u][i];\n\t\tif(v==faa)continue;\n\t\tdfs(v,u,dis+1,flg);\n\t}\n}//\u6c42\u76f4\u5f84\u957f\u5ea6 \n\nvoid dfss(int u,int fa,int top)\n{\n\tf[top]=max(f[top],dep[u]),tp[u]=top;//tp[i]\u8868\u793ai\u6240\u5728\u94fe\u7684\u6700\u9876\u7aef \n\tfor(int i=0;i<e[u].size();i++)\n\t{\n\t\tint v=e[u][i];\n\t\tif(v==fa)continue;\n\t\tif(vis[v])continue;\n\t\tdep[v]=dep[u]+1,dfss(v,u,top);\n\t}\n}\n\ninline int query(int k,int l,int r)\n{\n\tif(l>r)return -inf;int t=lg[r-l+1];\n\treturn max(st[k][t][l],st[k][t][r-(1<<t)+1]);\n}//O(1)\u67e5\u8be2 \n\ninline int Hash(string s)\n{\n\tlong long ans=0;\n\tfor(int i=0;i<s.length();i++)ans=(ans*base+s[i])%p;\n\treturn (int)ans;\n}\n\nint ans;\n\nsigned main()\n{\n\trd(n),lg[1]=0;for(int i=2;i<=n;i++)lg[i]=lg[i>>1]+1;//\u9884\u5904\u7406log2 \n\tfor(int i=1,u,v;i<n;i++)rd(u),rd(v),addEdge(u,v),addEdge(v,u);\n\trd(m),dfs(1,0,0,0),maxlen=0,dfs(pos,0,0,1);int u=pos;rec.push_back(Hash(\"I AK IOI\"));\n\twhile(u)vis[u]=1,rec.push_back(u),u=fa[u];int tot=rec.size()-1;\n\tfor(int i=1;i<=tot;i++)dfss(rec[i],0,i);\n\tfor(int i=1;i<=tot;i++)st[0][0][i]=i+f[i],st[1][0][i]=f[i]-i;//\u521d\u59cb\u5316 \n\tfor(int k=0;k<=1;k++)\n\t\tfor(int i=1;i<=B;i++)\n\t\t\tfor(int j=1;j+(1<<i)-1<=tot;j++)\n\t\t\t\tst[k][i][j]=max(st[k][i-1][j],st[k][i-1][j+(1<<(i-1))]);//\u9884\u5904\u7406ST\u8868 \n\twhile(m--)\n\t{\n\t\tint x,y,ans=0;rd(x),rd(y);\n\t\tif(tp[x]>tp[y])swap(x,y);\n\t\tif(tp[x]==tp[y]){ans=min(dep[x],dep[y])+max(tot-tp[x],tp[x]-1);printf(\"%d\\n\",ans);continue;}\n\t\tint mid=(tp[x]+tp[y]-dep[x]+dep[y]);\n\t\tif((tp[x]<<1)>=mid)ans=dep[y]+max(tot-tp[y],tp[y]-1);\n\t\telse if((tp[y]<<1)<=mid)ans=dep[x]+max(tot-tp[x],tp[x]-1);\n\t\telse ans=max(max(query(0,tp[x]+1,mid>>1)-tp[x],tp[x]-1)+dep[x],max(tot-tp[y],query(1,(mid>>1)+1,tp[y]-1)+tp[y])+dep[y]);//\u6839\u636e\u4e2d\u70b9\u5206\u7c7b\u8ba8\u8bba \n\t\tprintf(\"%d\\n\",ans);\n\t}\n\t\n\n    return 0;\n}\n```",
        "postTime": 1573561502,
        "uid": 53807,
        "name": "Erusel",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF418D \u3010Big Problems for Organizers\u3011"
    }
]