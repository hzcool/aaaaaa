[
    {
        "content": "\u8fd9\u9898\u660e\u660e\u548cNOIP2018d2t3\u5dee\u4e0d\u591a\u554a...\u751a\u81f3\u66f4\u7b80\u5355\u4e00\u4e9b\uff0c~~\u4e0d\u662f\u5e94\u8be5\u84dd\u4e86\u5417~~\n\n\u7b80\u5316\u7248\u7ffb\u8bd1\uff1a\u6709\u4e00\u68f5\u6811\uff0c\u5728\u6811\u4e0a\u8d70\u7684\u4eba\u67090,1\u4e24\u79cd\u5f62\u6001\uff0c\u4e24\u79cd\u72b6\u6001\u8d70\u540c\u4e00\u6761\u8fb9\u7684\u4ee3\u4ef7\u4e0d\u540c\uff0c\u6bcf\u4e2a\u8282\u70b9\u5207\u6362\u5f62\u6001\u4ee3\u4ef7\u4e0d\u540c\uff0c\u591a\u7ec4\u8be2\u95ee\u6811\u4e0a\u6700\u77ed\u8ddd\u79bb\uff0c\u6bcf\u7ec4\u8be2\u95ee\u90fd\u7ed9\u5b9a\u521d\u672b\u5f62\u6001\u548c\u8282\u70b9\u3002\n\n\u5148\u9884\u5904\u7406\u51fa\u6bcf\u4e2a\u8282\u70b9\u8f6c\u6362\u5f62\u6001\u7684\u6700\u5c0f\u4ee3\u4ef7\uff0c\u6ce8\u610f\u53ef\u4ee5\u8d70\u5230\u5176\u4ed6\u70b9\u8f6c\u6362\u518d\u56de\u6765\uff0c\u6811dp\u89e3\u51b3\u3002\u7b2c\u4e00\u904ddp\u6c42\u51fa\u5728\u67d0\u4e2a\u70b9\u8f6c\u6362\u6216\u8005\u5230\u5176\u5b50\u6811\u8f6c\u6362\u518d\u56de\u6765\uff0c\u7b2c\u4e8c\u904ddp\u6c42\u51fa\u5728\u67d0\u4e2a\u70b9\n\n\u8003\u8651\u8bbe $g[x][i][j]$ \u8868\u793a\u8f6c\u79fb\u5230 $f[x]$ \u540e\u7684\u72b6\u6001\u4e3a $i$ \u800c\u5728 $x$ \u7684\u72b6\u6001\u4e3a$j$\u7684\u60c5\u51b5\u4e0b $x->f[x]$ \u7684\u4ee3\u4ef7\uff0c\u5219\u53ef\u4ee5\u901a\u8fc7 $+\\max$ \u5f62\u7684\u77e9\u9635\u4e58\u6cd5\u7ef4\u62a4\uff0c\u5373 $g[x][i][j]->\\max(g[x][i][k]+g[f[x][k][j])$\uff0c\u76f8\u5f53\u4e8e\u679a\u4e3e $f[x]$ \u7684\u72b6\u6001\u3002\u8003\u8651\u7528\u5e26\u6743\u5e76\u67e5\u96c6\u7ef4\u62a4\uff0c\u7528tarjan lca\u65b9\u6cd5\u628a\u8be2\u95ee\u6302\u5230lca\u4e0a\uff0c\u7136\u540e\u679a\u4e3elca\u72b6\u6001\u5373\u53ef\u3002\u6ce8\u610f\u7279\u5224\u5404\u79cd\u8fb9\u754c\uff0c\u603b\u590d\u6742\u5ea6$O(n+q)$\uff0c\u6bd4\u500d\u589e\u548cddp\u4e0d\u77e5\u5feb\u5230\u54ea\u91cc\u53bb\u4e86\n\n```cpp\n#include <stdio.h>\n#include <string.h>\n#include <algorithm>\nusing namespace std;\ntypedef long long ll;\nconst int N=3e5+2,M=6e5+2,O=1.2e6+2;\nll len1[M],len2[M],v[N],g[N][4],ans[M];\nll lx,ly;\nint lj[M],nxt[M],fir[N],f[N],qlj[O],qnxt[O],qfir[N],xw[O][3];\nint flj[M],fnxt[M],ffir[N];\nint n,q,i,x,y,c,bs,qs,fs;\nbool ed[N];\ninline void read(int &x)\n{\n\tc=getchar();\n\twhile ((c<48)||(c>57)) c=getchar();\n\tx=c^48;c=getchar();\n\twhile ((c>=48)&&(c<=57))\n\t{\n\t\tx=x*10+(c^48);\n\t\tc=getchar();\n\t}\n}\ninline void read(ll &x)\n{\n\tc=getchar();\n\twhile ((c<48)||(c>57)) c=getchar();\n\tx=c^48;c=getchar();\n\twhile ((c>=48)&&(c<=57))\n\t{\n\t\tx=x*10+(c^48);\n\t\tc=getchar();\n\t}\n}\ninline void add()\n{\n\tlj[++bs]=y;\n\tlen1[bs]=lx;\n\tlen2[bs]=ly;\n\tnxt[bs]=fir[x];\n\tfir[x]=bs;\n\tlj[++bs]=x;\n\tlen1[bs]=lx;\n\tlen2[bs]=ly;\n\tnxt[bs]=fir[y];\n\tfir[y]=bs;\n}\ninline void fadd(int x,int y)\n{\n\tflj[++fs]=y;\n\tfnxt[fs]=ffir[x];\n\tffir[x]=fs;\n}\ninline void qadd(int x,int y,int i)\n{\n\tqlj[++qs]=i;\n\tqnxt[qs]=qfir[x];\n\tqfir[x]=qs;\n}\nvoid dfs1(int x)\n{\n\ted[x]=1;\n\tfor (int i=fir[x];i;i=nxt[i]) if (!ed[lj[i]])\n\t{\n\t\tdfs1(lj[i]);\n\t\tv[x]=min(v[x],v[lj[i]]+len1[i]+len2[i]);\n\t}\n\ted[x]=0;\n}\nvoid dfs2(int x)\n{\n\ted[x]=1;\n\tfor (int i=fir[x];i;i=nxt[i]) if (!ed[lj[i]])\n\t{\n\t\tv[lj[i]]=min(v[lj[i]],v[x]+len1[i]+len2[i]);\n\t\tdfs2(lj[i]);\n\t}\n\ted[x]=0;\n}\nvoid dfs3(int x)\n{\n\ted[x]=1;\n\tfor (int i=fir[x];i;i=nxt[i]) if (!ed[lj[i]])\n\t{\n\t\tg[lj[i]][0]=min(len2[i],v[x]+v[lj[i]]+len1[i]);\n\t\tg[lj[i]][1]=min(len2[i]+v[lj[i]],len1[i]+v[x]);\n\t\tg[lj[i]][2]=min(len1[i]+v[lj[i]],len2[i]+v[x]);\n\t\tg[lj[i]][3]=min(len1[i],v[x]+v[lj[i]]+len2[i]);\n\t\tdfs3(lj[i]);\n\t}\n\ted[x]=0;\n}\nvoid getf(register int x)\n{\n\tif (f[f[x]]==f[x]) return;\n\tgetf(f[x]);\n\tg[0][0]=min(g[x][0]+g[f[x]][0],g[x][2]+g[f[x]][1]);\n\tg[0][1]=min(g[x][1]+g[f[x]][0],g[x][3]+g[f[x]][1]);\n\tg[0][2]=min(g[x][0]+g[f[x]][2],g[x][2]+g[f[x]][3]);\n\tg[0][3]=min(g[x][1]+g[f[x]][2],g[x][3]+g[f[x]][3]);\n\tmemcpy(g[x],g[0],32);\n\tf[x]=f[f[x]];\n}\nvoid dfs4(int x)\n{\n\ted[x]=1;int i;\n\tfor (i=qfir[x];i;i=qnxt[i]) if (ed[y=xw[qlj[i]][2]])\n\t{\n\t\tgetf(y);\n\t\tfadd(f[y],qlj[i]);\n\t}\n\tfor (i=fir[x];i;i=nxt[i]) if (!ed[lj[i]])\n\t{\n\t\tdfs4(lj[i]);\n\t\tf[lj[i]]=x;\n\t}\n\tfor (i=ffir[x];i;i=fnxt[i])\n\t{\n\t\ty=flj[i];\n\t\tif (y>q) c=y-q; else c=y;\n\t\tif (xw[y][2]!=x)\n\t\t{\n\t\t\tqs=xw[y][0]>>1&1;bs=xw[y][0]&1;\n\t\t\tgetf(xw[y][1]);getf(xw[y][2]);\n\t\t\tans[c]=min(g[xw[y][1]][bs]+g[xw[y][2]][qs],g[xw[y][1]][bs|2]+g[xw[y][2]][qs|2]);\n\t\t}\n\t\telse {getf(xw[y][1]);ans[c]=g[xw[y][1]][xw[y][0]];}\n\t}\n}\nint main()\n{\n\tread(n);\n\tfor (i=1;i<=n;i++) read(v[i]);\n\tfor (i=1;i<n;i++)\n\t{\n\t\tread(x);read(y);read(lx);read(ly);\n\t\tadd();f[i]=i;\n\t}dfs1(1);dfs2(1);dfs3(1);\n\tread(q);\n\tfor (i=1;i<=q;i++)\n\t{\n\t\tread(x);read(y);\n\t\tif (x+1>>1==y+1>>1) {if (x!=y) ans[i]=v[x+1>>1];continue;}\n\t\txw[i][0]=(x&1)|(y&1)<<1;\n\t\txw[i+q][0]=(y&1)|(x&1)<<1;\n\t\tqadd(xw[i][1]=xw[i+q][2]=x=x+1>>1,xw[i][2]=xw[i+q][1]=y=y+1>>1,i);\n\t\tqadd(y,x,i+q);\n\t}\n\tdfs4(1);\n\tfor (i=1;i<=q;i++) printf(\"%lld\\n\",ans[i]);\n}\n```\n",
        "postTime": 1556446215,
        "uid": 29826,
        "name": "SSerxhs",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 CF1140G \u3010Double Tree\u3011"
    },
    {
        "content": "\u672c\u9898\u6709\u5f88\u591anb\u7684\u505a\u6cd5\uff0c\u4f46\u8fd9\u91cc\u8bb2\u7684\u662f\u4e00\u4e2a\u6bd4\u8f83\u83dc\u7684\u7eaf\u6811\u5f62\u500d\u589edp\u7684\u505a\u6cd5\n\n---\n\n### \u9898\u89e3\uff1a\n\n\u5047\u5982\u73b0\u5728\u53ea\u6709\u4e00\u68f5\u6811\uff0c\u9664\u4e86\u524d\u7f00\u548c\u7684\u505a\u6cd5\u5916\uff0c\u663e\u7136\u53ef\u4ee5\u7528\u500d\u589e\u7ef4\u62a4\u6bcf\u4e2a\u8282\u70b9\u5411\u4e0a\u82e5\u5e72\u7ea7\u7684\u4ee3\u4ef7\uff0c\u7b54\u6848\u5c31\u662f\u4e24\u4e2a\u8be2\u95ee\u70b9\u5404\u81ea\u5230lca\u5904\u7684\u4ee3\u4ef7\u548c\n\n\u73b0\u5728\u6709\u4e86\u4e24\u68f5\u6811\uff0c\u540c\u6837\u7684\u601d\u8def\uff0c\u4f46\u7531\u4e8e\u53ef\u4ee5\u5728\u4e24\u68f5\u6811\u4e4b\u95f4\u5207\u6362\uff0c\u9700\u8981\u63d0\u524d\u9884\u5904\u7406\u51fa$w[x]$\u8868\u793a$x$\u5230$x'$\u6216$x'$\u5230$x$\u7684\u6700\u5c0f\u4ee3\u4ef7\n\n$w[x]$\u5f88\u7b80\u5355\uff0c\u56e0\u4e3a\u6362\u6811\u64cd\u4f5c\u53ea\u6709\u4e09\u79cd\u65b9\u5f0f\uff1a\u76f4\u63a5\u6362\u3001\u7236\u4eb2\u6362\u3001\u513f\u5b50\u6362\uff0c\u6240\u4ee5\u76f4\u63a5\u8dd1\u4e24\u6b21dfs\u5c31\u53ef\u4ee5\u89e3\u51b3\uff0c\u6ce8\u610f\u5982\u679c\u7ed5\u8def\u7684\u8bdd\u4f1a\u589e\u52a0\u4e24\u6761\u8fb9\u7684\u4ee3\u4ef7\uff08\u4e24\u68f5\u6811\u4e0a\u5404\u4e00\u6b21\uff09\n\n\u63a5\u4e0b\u6765\u5c31\u662f\u7ef4\u62a4\u500d\u589e\u6570\u7ec4\u4e86\uff0c\u8bbe$f[x][i][0/1][0/1]$\u8868\u793a$x$\u5411\u4e0a\u8df3$2^i$\u6b21\uff0c\u8d77\u70b9\u662f\u5426\u5728\u4e8c\u53f7\u6811\uff0c\u7ec8\u70b9\u662f\u5426\u5728\u4e8c\u53f7\u6811\u65f6\u7684\u6700\u5c0f\u4ee3\u4ef7\n\n\u8f6c\u79fb\u4e5f\u5f88\u7b80\u5355\uff0c\u7531\u4e8e\u4e2d\u9014\u70b9\u8981\u4e48\u5728\u4e00\u53f7\u6811\u8981\u4e48\u5728\u4e8c\u53f7\u6811\uff0c\u6240\u4ee5\u76f4\u63a5\u4e24\u79cd\u60c5\u51b5\u53d6\u4e2amin\u5373\u53ef\n\n\u9884\u5904\u7406\u5b8c\uff0c\u8003\u8651\u67e5\u8be2\n\n\u5bf9\u4e8e\u8d77\u70b9\u7ec8\u70b9\u5206\u522b\u7ef4\u62a4\u4e24\u4e2a\u53d8\u91cf$dp0,dp1$\uff0c\u8868\u793a\u5f53\u524d\u8df3\u8dc3\u4f4d\u7f6e\u662f\u5426\u5728\u4e8c\u53f7\u6811\u4e0a\u65f6\u7684\u6700\u5c0f\u4ee3\u4ef7\uff0c\u8f6c\u79fb\u4e0e\u500d\u589e\u9884\u5904\u7406\u57fa\u672c\u4e0a\u4e00\u6a21\u4e00\u6837\n\n\u7531\u4e8e\u8d77\u70b9\u7ec8\u70b9\u8df3\u5230lca\u65f6\u8981\u4e48\u90fd\u5728\u4e00\u53f7\u6811\uff0c\u8981\u4e48\u90fd\u5728\u4e8c\u53f7\u6811\uff0c\u6240\u4ee5\u7b54\u6848\u5c31\u662f$\\min\\{dp0+dp0',dp1+dp1'\\}$\n\n---\n\n### \u4ee3\u7801\uff1a\n\n```cpp\n#pragma GCC optimize(3,\"Ofast\",\"inline\")\n#pragma GCC target(\"avx\")\n#include <bits/stdc++.h>\nusing namespace std;\ntemplate<class t> inline t read(t &x){\n\tchar c=getchar();bool f=0;x=0;\n\twhile(!isdigit(c)) f|=c=='-',c=getchar();\n\twhile(isdigit(c)) x=(x<<1)+(x<<3)+(c^48),c=getchar();\n\tif(f) x=-x;return x;\n}\ntemplate<class t,class ...A> inline void read(t &x,A &...a){\n\tread(x);read(a...);\n}\ntemplate<class t> inline void write(t x){\n\tif(x<0) putchar('-'),write(-x);\n\telse{if(x>9) write(x/10);putchar('0'+x%10);}\n}\n\n#define int long long\n\nconst int N=3e5+5;\nint w[N],f[N][20][2][2],fx[2],fy[2],d[N],lg,n,h[N],en,fa[N][20];\n\nstruct edge{\n\tint n,v,w1,w2;\n}e[N<<1];\n\nvoid add(int x,int y,int a,int b){\n\te[++en]=(edge){h[x],y,a,b};\n\th[x]=en;\n}\n\nvoid dfs1(int x,int fa){\n\t::fa[x][0]=fa;d[x]=d[fa]+1;\n\tfor(int i=h[x];i;i=e[i].n){\n\t\tint y=e[i].v,w1=e[i].w1,w2=e[i].w2;\n\t\tif(y==fa) continue;\n\t\tdfs1(y,x);\n\t\tw[x]=min(w[x],w[y]+w1+w2);\n\t}\n}\n\nvoid dfs2(int x,int fa){\n\tfor(int i=h[x];i;i=e[i].n){\n\t\tint y=e[i].v,w1=e[i].w1,w2=e[i].w2;\n\t\tif(y==fa) continue;\n\t\tw[y]=min(w[y],w[x]+w1+w2);\n\t\tdfs2(y,x);\n\t}\n}\n\nvoid dfs(int x,int fa){\n\tfor(int i=h[x];i;i=e[i].n){\n\t\tint y=e[i].v,w1=e[i].w1,w2=e[i].w2;\n\t\tif(y==fa) continue;\n\t\tdfs(y,x);\n\t\tf[y][0][0][0]=min(w1,w[y]+w2+w[x]);\n\t\tf[y][0][0][1]=min(w[y]+w2,w1+w[x]);\n\t\tf[y][0][1][0]=min(w[y]+w1,w2+w[x]);\n\t\tf[y][0][1][1]=min(w2,w[x]+w1+w[y]);\n\t}\n}\n\nint lca(int x,int y){\n\tif(d[x]<d[y]) swap(x,y);\n\tfor(int i=lg;~i;i--) if(d[y]<=d[fa[x][i]]) x=fa[x][i];\n\tif(x==y) return x;\n\tfor(int i=lg;~i;i--) if(fa[x][i]^fa[y][i]) x=fa[x][i],y=fa[y][i];\n\treturn fa[x][0];\n}\n\nvoid doit(){\n\tint x,y,opx,opy,lca;\n\topx=read(x)+1&1;opy=read(y)+1&1;\n\tx=x+1>>1,y=y+1>>1;lca=::lca(x,y);\n\tfx[opx]=fy[opy]=0;fx[!opx]=w[x];fy[!opy]=w[y];\n\tfor(int i=lg;~i;i--) if(d[fa[x][i]]>=d[lca]){\n\t\tint w0=fx[0],w1=fx[1];\n\t\tfx[0]=min(w0+f[x][i][0][0],w1+f[x][i][1][0]);\n\t\tfx[1]=min(w0+f[x][i][0][1],w1+f[x][i][1][1]);\n\t\tx=fa[x][i];\n\t}\n\tfor(int i=lg;~i;i--) if(d[fa[y][i]]>=d[lca]){\n\t\tint w0=fy[0],w1=fy[1];\n\t\tfy[0]=min(w0+f[y][i][0][0],w1+f[y][i][1][0]);\n\t\tfy[1]=min(w0+f[y][i][0][1],w1+f[y][i][1][1]);\n\t\ty=fa[y][i];\n\t}\n\twrite(min(fx[0]+fy[0],fx[1]+fy[1]));puts(\"\");\n}\n\nsigned main(){\n\tmemset(f,31,sizeof f);\n\tlg=log2(read(n));\n\tfor(int i=1;i<=n;i++) read(w[i]);\n\tfor(int i=1,x,y,a,b;i<n;i++) read(x,y,a,b),add(x,y,a,b),add(y,x,a,b);\n\tdfs1(1,0);dfs2(1,0);\n\tdfs(1,0);\n\tfor(int i=1;i<=lg;i++) for(int x=1;x<=n;x++){\n\t\tfa[x][i]=fa[fa[x][i-1]][i-1];\n\t\tf[x][i][0][0]=min(f[x][i-1][0][0]+f[fa[x][i-1]][i-1][0][0],f[x][i-1][0][1]+f[fa[x][i-1]][i-1][1][0]);\n\t\tf[x][i][0][1]=min(f[x][i-1][0][0]+f[fa[x][i-1]][i-1][0][1],f[x][i-1][0][1]+f[fa[x][i-1]][i-1][1][1]);\n\t\tf[x][i][1][0]=min(f[x][i-1][1][0]+f[fa[x][i-1]][i-1][0][0],f[x][i-1][1][1]+f[fa[x][i-1]][i-1][1][0]);\n\t\tf[x][i][1][1]=min(f[x][i-1][1][0]+f[fa[x][i-1]][i-1][0][1],f[x][i-1][1][1]+f[fa[x][i-1]][i-1][1][1]);\n\t}\n\tint t;read(t);\n\twhile(t--) doit();\n}\n```",
        "postTime": 1594551175,
        "uid": 65735,
        "name": "yuzhechuan",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 CF1140G \u3010Double Tree\u3011"
    }
]