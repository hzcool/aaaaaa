[
    {
        "content": "\u9996\u5148\uff0c\u5982\u679c\u5b58\u5728\u4e00\u79cd\u5206\u914d\u65b9\u6848\uff0c\u90a3\u4e48\u663e\u7136\u7b54\u6848 $k$ \u5728 $[1,n]$ \u4e2d\u3002\n\n\u800c\u663e\u7136 $k$ \u5177\u6709\u5355\u8c03\u6027\uff0c\u6240\u4ee5\u53ef\u4ee5\u4e8c\u5206\u3002\n\n\u63a5\u4e0b\u6765\u8003\u8651\u5224\u5b9a\u5bf9\u4e8e\u4e00\u4e2a\u7ed9\u5b9a\u7684\u7b54\u6848 $k$ \u662f\u5426\u53ef\u884c\u5e76\u4e14\u7ed9\u51fa\u4e00\u7ec4\u6784\u9020\u3002\n\n\u8003\u8651\u6811\u4e0a\u7684\u6bcf\u6761\u8fb9 $(u,p_u)$ \uff0c\u5982\u679c\u5b83\u6ca1\u6709\u88ab\u4efb\u4f55\u8def\u5f84\u8986\u76d6\uff0c\u5219\u53ef\u4ee5\u4e0d\u8003\u8651\u8fd9\u6761\u8fb9\u3002\n\n\u5426\u5219\uff0c\u7531\u4e8e\u5b83\u88ab\u67d0\u51e0\u6761\u8def\u5f84\u8986\u76d6\uff0c\u5219\u5b83\u7684\u4e24\u4e2a\u7aef\u70b9\u5fc5\u5b9a\u4e3a\u4ee5\u4e0b\u4e24\u79cd\u72b6\u6001\u4e4b\u4e00\uff08\u79f0\u4e3a $d_i$\uff09\uff1a\n\n- $c_u<c_{p_u}$\uff0c\u79f0\u8fd9\u79cd\u8fb9\u4e3a $A$ \u7c7b\u8fb9\u3002\n  \n- $c_u>c_{p_u}$\uff0c\u79f0\u8fd9\u79cd\u8fb9\u4e3a $B$ \u7c7b\u8fb9\u3002\n  \n\n\u800c\u4e00\u6761\u8def\u5f84\u7684\u4f5c\u7528\u5c31\u662f\u9650\u5236\u82e5\u5e72\u4e2a $d_i$ \u7684\u53d6\u503c\u76f8\u540c\u6216\u76f8\u53cd\u3002\n\n\u8fd9\u91cc\u53ef\u4ee5\u62ff\u4e2a\u6743\u503c\u5e76\u67e5\u96c6\u6765\u505a\u3002\n\n\u56e0\u6b64\u6240\u6709\u88ab\u8986\u76d6\u7684\u8fb9 $(u,p_u)$ \u5c31\u88ab\u5212\u5206\u6210\u4e86\u82e5\u5e72\u4e2a\u8054\u901a\u5757\uff0c\u4e14\u4e00\u6574\u4e2a\u8054\u901a\u5feb\u53ea\u6709\u4e24\u79cd\u53d6 $d_i$ \u7684\u65b9\u6848\u3002\n\n\u7136\u540e\u8003\u8651\u6811\u5f62 DP\u3002\u4ee4 $dp_u$ \u8868\u793a\u8fb9 $(u,p_u)$ \u4e3a $A$ \u7c7b\u8fb9\uff08\u82e5\u6ca1\u6709\u88ab\u4efb\u4f55\u8fb9\u8986\u76d6\u53ef\u4ee5\u76f4\u63a5\u5ffd\u7565\uff09\u65f6 $c_v$ \u7684\u6700\u5c0f\u503c\u3002\u4e14\u6839\u636e\u5bf9\u79f0\u6027\uff0c\u82e5\u8fb9 $(u,p_u)$ \u4e3a $B$ \u7c7b\u8fb9\uff0c\u5219\u6700\u5927\u503c\u4e3a $k+1-c_u$\u3002\n\n\u7136\u540e\u8003\u8651\u600e\u4e48\u6c42\u51fa $dp$\u3002\n\n\u82e5 $u$ \u4e3a\u53f6\u8282\u70b9\u5219\u6709 $dp_u=1$\u3002\n\n\u800c\u5bf9\u4e8e\u5176\u4ed6\u8282\u70b9\uff0c\u5219\u8003\u8651\u5bf9\u4e8e\u6bcf\u4e2a\u5b50\u6811\u627e\u51fa\u5bf9 $dp_u$ \u9650\u5236\u7684\u533a\u95f4\u6216\u96c6\u5408\uff0c\u6700\u540e\u53d6\u4ea4\u96c6\u7684\u6700\u5c0f\u503c\u3002\n\n\u800c $u$ \u7684\u5b50\u6811 $v$ \u5206\u4e3a\u4e09\u79cd\u60c5\u51b5\uff1a\n\n1. $(v,u)$ \u6ca1\u6709\u88ab\u4efb\u4f55\u8def\u5f84\u8986\u76d6\uff1a\n  \n  \u540c\u7406\u53ef\u4ee5\u76f4\u63a5\u5ffd\u7565\u3002\n  \n2. $(v,u)$ \u548c $(u,p_u)$ \u5728\u540c\u4e00\u4e2a\u8054\u901a\u5feb\u4e2d\uff1a\n  \n  \u7531\u4e8e\u5df2\u7ecf\u5047\u8bbe $(u,p_u)$ \u4e3a $A$ \u578b\u8fb9\uff0c\u4e8e\u662f\u540c\u6837\u53ef\u4ee5\u77e5\u9053 $(v,u)$ \u7684\u7c7b\u578b\uff0c\u6240\u4ee5\uff1a\n  \n  - \u82e5 $(v,u)$ \u4e3a $A$ \u578b\u8fb9\uff0c\u5219 $c_u> c_v$\uff0c\u9650\u5236\u533a\u95f4\u4e3a $[c_v+1,k]$\u3002\n    \n  - \u82e5 $(v,u)$ \u4e3a $B$ \u578b\u8fb9\uff0c\u5219 $c_u<c_v$\uff0c\u9650\u5236\u533a\u95f4\u4e3a $[1,c_v-1]$\u3002\n    \n3. $(v,u)$ \u548c $(u,p_u)$ \u4e0d\u5728\u540c\u4e00\u4e2a\u8054\u901a\u5feb\u4e2d\uff1a\n  \n  \u5047\u8bbe $(v,u)$ \u6240\u5728\u7684\u8054\u901a\u5757\u4e3a $C$\uff0c\u90a3\u4e48\u6b64\u65f6 $C$ \u4e2d\u7684\u6240\u6709\u8fb9\u90fd\u5728 $u$ \u7684\u5b50\u6811\u5185\uff0c\u6b64\u65f6\u5bf9\u6574\u4e2a $C$ \u4e00\u8d77\u5904\u7406\u3002\u8bb0\u8054\u901a\u5757 $C$ \u4e2d\u548c $u$ \u6709\u5173\u8054\u7684\u8fb9\u6709 $(v_1,u),(v_2,u)\\cdots (v_k,u)$\u3002\u548c\u4e0a\u9762\u540c\u7406\uff0c\u56e0\u4e3a\u53ef\u4ee5\u94a6\u5b9a\u8fd9\u4e9b\u8fb9\u7684\u7c7b\u578b\uff0c\u518d\u53d6\u4ea4\u6c42\u51fa $c_u$ \u7684\u9650\u5236\u533a\u95f4 $[l,r]$\u3002\u518d\u7531\u5bf9\u79f0\u6027\u53e6\u4e00\u79cd\u94a6\u5b9a\u5bf9 $c_u$ \u7684\u9650\u5236\u533a\u95f4\u5c31\u662f $[k+1-r,k+1-l]$\u3002\u56e0\u6b64\u6574\u4e2a $C$ \u5bf9 $c_u$ \u7684\u9650\u5236\u96c6\u5408\u5c31\u662f $[l,r]\\cup [k+1-r,k+1-l]$\u3002\n  \n\n\u6700\u540e\u5c31\u662f\u5bf9\u6240\u6709\u9650\u5236\u53d6\u4ea4\u96c6\u7136\u540e\u53d6\u6700\u5c0f\u5143\u7d20\u3002\n\n\u5982\u679c\u6ca1\u6709\u7b2c\u4e09\u79cd\u60c5\u51b5\u5c31\u662f\u533a\u95f4\u6c42\u4ea4\uff0c\u76f4\u63a5\u53d6\u5de6\u7aef\u70b9\u7684\u6700\u5927\u503c\u548c\u53f3\u7aef\u70b9\u7684\u6700\u559c\u54e6\u503c\u5373\u53ef\u3002\u4f46\u662f\u7b2c\u4e09\u79cd\u60c5\u51b5\u6709\u53ef\u80fd\u4e0d\u662f\u4e00\u4e2a\u533a\u95f4\u3002\n\n\u8003\u8651\u8fd9\u4e2a\u96c6\u5408\u7684\u6027\u8d28\uff0c\u5982\u679c $[l,r]\\cup [k+1-r,k+1-l]$ \u4e0d\u662f\u4e00\u4e2a\u533a\u95f4\uff0c\u5219\u5b83\u4e00\u5b9a\u662f\u5173\u4e8e $\\frac{k+1}{2}$ \u5bf9\u79f0\u7684\u4e24\u4e2a\u533a\u95f4\u3002\n\n\u56e0\u6b64\u8fd9\u6837\u4e00\u4e2a\u96c6\u5408\u90fd\u53ef\u4ee5\u5206\u4e3a\u5de6\u8fb9\u548c\u53f3\u8fb9\u4e24\u4e2a\u533a\u95f4\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5bf9\u5de6\u8fb9\u7684\u533a\u95f4\u6c42\u4ea4\uff0c\u7136\u540e\u518d\u5bf9\u79f0\u5230\u53f3\u8fb9\u7684\u533a\u95f4\uff0c\u5373\u53ef\u5f97\u5230\u6700\u7ec8\u4ea4\uff0c\u8bb0\u4e3a $[l',r']\\cup [k+1-r',k+1-l']$\u3002\n\n\u7136\u540e\u8003\u8651\u8ba1\u7b97 $dp_u$ \u3002\n\n\u8bbe\u5176\u4ed6\u6b63\u5e38\u4ea4\u51fa\u6765\u7684\u533a\u95f4\u4e3a $[l,r]$\uff0c\u5982\u679c $\\max(l,l')$ \u4e0d\u5728 $(r;,k+1-r')$ \u4e2d\uff0c\u5219 $dp_u=\\max(l,l')$\u3002\n\n\u5426\u5219\u8003\u8651 $k+1-r'$ \u662f\u5426\u8d85\u8fc7 $\\max(r,k+1-l')$ \u5982\u679c\u8d85\u8fc7\u663e\u7136\u65e0\u89e3\u3002\u5426\u5219\u7b54\u6848\u5c31\u662f $k+1-r'$\u3002\n\n\u6700\u540e\u56e0\u4e3a\u53ef\u4ee5\u901a\u8fc7 $dp_u$ \u6c42\u51fa\u5b83\u5404\u4e2a\u5b50\u6811\u6bcf\u88ab\u8def\u5f84\u8986\u76d6\u7684\u8fb9\u662f\u4ec0\u4e48\u7c7b\u578b\u3002\u6240\u4ee5\u53ea\u9700\u8981\u5bf9\u6bcf\u6761\u8fb9\u8bb0\u5f55\u5728\u6700\u7ec8\u65b9\u6848\u65f6\u5b83\u662f\u5426\u548c\u4e0a\u4e00\u6761\u8fb9\u7c7b\u578b\u76f8\u540c\u5373\u53ef\uff0c\u76f4\u63a5\u8f93\u51fa\u5373\u53ef\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal O(n\\log n)$\u3002\n\n```cpp\n#include<bits/stdc++.h>\n#define R(i,a,b) for(int i=(a),i##E=(b);i<=i##E;i++)\n#define L(i,a,b) for(int i=(b),i##E=(a);i>=i##E;i--)\nusing namespace std;\nint n,m;\nvector<int>e[555555];\ninline void ns()\n{\n\tcout<<\"-1\"<<endl;\n\texit(0);\n}\nstruct dsu\n{\n\tint fa[555555];\n\tbool v[555555];\n\tinline void clear()\n\t{\n\t\tR(i,1,n) fa[i]=i,v[i]=0;\n\t}\n\tint fnd(int x)\n\t{\n\t\tif(x==fa[x]) return x;\n\t\tint f=fa[x];\n\t\tfa[x]=fnd(fa[x]);\n\t\tv[x]^=v[f];\n\t\treturn fa[x];\n\t}\n\tinline void mrg(int x,int y,int k)\n\t{\n\t\t//printf(\"mrg: x:%d y:%d k:%d\\n\",x,y,k);\n\t\tint fx=fnd(x),fy=fnd(y),t=v[x]^v[y]^k;\n\t\tif(fx==fy) \n\t\t{\n\t\t\tif(t) ns();\n\t\t}\n\t\telse fa[fx]=fy,v[fx]=t;\n\t}\n}dsu;\nstruct tree\n{\n\tint hson[555555],htop[555555],dfn[555555],pos[555555],tim;\n\tint siz[555555],dep[555555],fa[555555];\n\tint v[555555],vv[555555];\n\n\tvoid dfs1(int u,int f)\n\t{\n\t\tsiz[u]=1;\n\t\tint mx=-1;\n\t\tfor(int v:e[u]) if(v^f)\n\t\t{\n\t\t\tfa[v]=u;dep[v]=dep[u]+1;\n\t\t\tdfs1(v,u);\n\t\t\tsiz[u]+=siz[v];\n\t\t\tif(siz[v]>mx) hson[u]=v,mx=siz[v];\n\t\t}\n\t}\n\tvoid dfs2(int u,int topf)\n\t{\n\t\tdfn[u]=++tim;\n\t\tpos[tim]=u;\n\t\thtop[u]=topf;\n\t\tif(!hson[u]) return;\n\t\tdfs2(hson[u],topf);\n\t\tfor(int v:e[u]) if(v^fa[u]&&v^hson[u]) dfs2(v,v);\n\t}\n\tinline int LCA(int x,int y)\n\t{\n\t\twhile(htop[x]^htop[y])\n\t\t{\n\t\t\tif(dep[htop[x]]<dep[htop[y]]) swap(x,y);\n\t\t\tx=fa[htop[x]];\n\t\t}\n\t\treturn dep[x]<dep[y]?x:y;\n\t}\n\tint jmp(int x,int y)\n\t{\n\t\twhile(1)\n\t\t{\n\t\t\tif(dep[htop[x]]<=dep[y]) return pos[dfn[y]+1];\n\t\t\tif(dep[htop[x]]==dep[y]+1) return htop[x];\n\t\t\tx=fa[htop[x]];\n\t\t}\n\t\tassert(0);\n\t}\n\tvoid ins(int x,int y)\n\t{\n\t\tint l_a=LCA(x,y);\n\t\t++v[x],++v[y],v[l_a]-=2;\n\t\tif(x^l_a) ++vv[x],--vv[x=jmp(x,l_a)];\n\t\tif(y^l_a) ++vv[y],--vv[y=jmp(y,l_a)];\n\t\tif((x^l_a)&&(y^l_a)) dsu.mrg(x,y,1);\n\t}\n\tvoid mian()\n\t{\n\t\tL(i,1,n)\n\t\t{\n\t\t\tint x=pos[i];\n\t\t\tv[fa[x]]+=v[x],vv[fa[x]]+=vv[x];\n\t\t\tif(vv[x]) dsu.mrg(x,fa[x],0);\n\t\t}\n\t}\n}tr;\nint vis[555555],tim;\nint dp[555555];\nint vl[555555],vr[555555];\nint rev[555555],s[555555];\n\ninline int check(int k)\n{\n\tdeque<int>q;\n\tL(i,1,n)\n\t{\n\t\tint u=tr.pos[i],f=tr.fa[u];\n\t\tint l=0,r=0;\n\t\t++tim;\n\t\tfor(int v:e[u]) if(v^f&&tr.v[v])\n\t\t{\n\t\t\tint fv=dsu.fa[v];\n\t\t\tif(vis[fv]!=tim) vis[fv]=tim,vl[fv]=vr[fv]=0,q.emplace_back(fv);\n\t\t\tif(!dsu.v[v]) vl[fv]=max(vl[fv],dp[v]);\n\t\t\telse vr[fv]=max(vr[fv],dp[v]);\n\t\t}\n\t\tint fv=dsu.fa[u];\n\t\tif(vis[fv]==tim)\n\t\t{\n\t\t\tl=vl[fv],r=vr[fv];\n\t\t\tif(dsu.v[u]) swap(l,r);\n\t\t}\n\t\tint mn=0,mx=0;\n\t\twhile(q.size())\n\t\t{\n\t\t\tint x=q.front();\n\t\t\tq.pop_front();\n\t\t\tif(x!=fv)\n\t\t\t{\n\t\t\t\tif(vl[x]>vr[x]) swap(vl[x],vr[x]);\n\t\t\t\tmn=max(mn,vl[x]),mx=max(mx,vr[x]);\n\t\t\t}\n\t\t}\n\t\tif(max(mn,min(l,r))+max(mx,max(l,r))>=k) return 0;\n\t\tdp[u]=(max(mn,l)+max(mx,r)>=k?max(mx,l):max(mn,l))+1;\n\t}\n\treturn 1;\n}\nvoid solve(int k)\n{\n\tdeque<int>q;\n\tR(i,1,n)\n\t{\n\t\tint u=tr.pos[i],f=tr.fa[u];\n\t\t++tim;\n\t\tfor(int v:e[u]) if(v^f&&tr.v[v])\n\t\t{\n\t\t\tint fv=dsu.fa[v];\n\t\t\tif(vis[fv]!=tim) vis[fv]=tim,vl[fv]=vr[fv]=0,q.emplace_back(fv);\n\t\t\tif(!dsu.v[v]) vl[fv]=max(vl[fv],dp[v]);\n\t\t\telse vr[fv]=max(vr[fv],dp[v]);\n\t\t}\n\t\twhile(q.size())\n\t\t{\n\t\t\tint x=q.front();\n\t\t\tq.pop_front();\n\t\t\ts[x]=rev[u];\n\t\t\tif(x!=dsu.fa[u]) s[x]^=((vl[x]>=dp[u])||(vr[x]+dp[u]>k));\n\t\t\telse s[x]^=dsu.v[u];\n\t\t}\n\t\tfor(int v:e[u]) if(v^f&&tr.v[v]) rev[v]=s[dsu.fa[v]]^dsu.v[v];\n\t}\n}\nsigned main()\n{\n\tios::sync_with_stdio(false);\n\tcin.tie(NULL);\n\tcin>>n>>m;\n\tR(i,1,n-1)\n\t{\n\t\tint x,y;\n\t\tcin>>x>>y;\n\t\te[x].emplace_back(y),e[y].emplace_back(x);\n\t}\n\tdsu.clear();tr.dfs1(1,0);tr.dfs2(1,1);\n\tR(i,1,m)\n\t{\n\t\tint x,y;\n\t\tcin>>x>>y;\n\t\ttr.ins(x,y);\n\t}\n\ttr.mian();\n\tR(i,1,n) dsu.fnd(i);\n\tint l=1,r=n,ans=0;\n\twhile(r-l>5)\n\t{\n\t\tint mid=(l+r)>>1;\n\t\tif(check(mid)) ans=mid,r=mid-1;\n\t\telse l=mid+1;\n\t}\n\tR(i,l,r) if(check(i)) \n\t{\n\t\tans=i;\n\t\tbreak;\n\t}\n\tcout<<ans<<endl;\n\tcheck(ans);\n\tsolve(ans);\n\tR(i,1,n) cout<<((!rev[i])?dp[i]:ans+1-dp[i])<<\" \";\n\tcout<<endl;\n\n}\n```",
        "postTime": 1639109260,
        "uid": 115779,
        "name": "\u6781\u5bd2\u795e\u51b0",
        "ccfLevel": 0,
        "title": "1322f"
    }
]