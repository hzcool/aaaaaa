[
    {
        "content": "[\u9898\u4f20](https://www.luogu.com.cn/problem/CF607D)\n\n\u8bb0 $(a, b)$ \u4e3a\u6811\u4e0a $a$ \u5230 $b$ \u8def\u5f84\u4e0a\u7684\u6240\u6709\u70b9\u7684\u96c6\u5408\u3002\n\n\u8fd9\u4e2a\u8d21\u732e\u592a\u96be\u7b97\u4e86\uff0c\u4e00\u7edf\u8ba1\u5c31\u662f\u6574\u9897\u5b50\u6811\uff0c\u6211\u4eec\u4e0d\u59a8\u7edf\u8ba1 $u$ \u7684\u5b50\u6811\u4e2d\u6bcf\u4e2a\u8282\u70b9 $z$ \u7684\u8d21\u732e\uff0c\u5728 $z$ \u4e0d\u65ad\u5411\u4e0a\u8df3\u7684\u8fc7\u7a0b\u4e2d\uff0c\u6bcf\u7ecf\u8fc7\u4e00\u4e2a\u70b9 $y$\uff0c\u5c31\u8981\u4e58\u4e0a $siz_y$\uff0c\u6240\u4ee5\u4e0d\u96be\u5f97\u51fa\uff1a\n\n$$f(u)=\\sum_{z \\in S_u} w_z \\times \\prod_{y \\in (u, z)} siz_y$$\n\n\u6211\u4eec\u6709\u591a\u6b21\u8be2\u95ee\uff0c$x$ \u4e0d\u5b9a\uff0c\u6240\u4ee5 $\\prod_{y \\in (x, z)} siz_y$ \u6bd4\u8f83\u96be\u641e\uff0c\u4ee4 $f_x$ \u4e3a $x$ \u7684\u7236\u4eb2\uff0c\u7c7b\u4f3c\u4e8e\u524d\u7f00\u548c\u4f18\u5316\uff0c\u6709\uff1a\n\n$$\\prod_{y \\in (x, z)} siz_y=\\frac{\\prod_{y \\in (1, z)} siz_y}{\\prod_{y \\in (1, f_x)} siz_y}$$\n\n\u4ee4 $pre_x=\\prod_{y \\in (1, x)} siz_y$\uff0c\u5e26\u56de\u539f\u5f0f\uff0c\u53ef\u5f97\uff1a\n\n$$f(u)=\\sum_{z \\in S_u} w_z \\times \\frac{pre_z}{pre_{f_u}}$$\n\n\u6ce8\u610f\u5230 $pre_x$ \u662f\u5b9a\u503c\uff0c\u6240\u4ee5\u73c2\u4ee5\u63d0\u51fa\uff0c\n\n$$=\\frac{\\sum_{z \\in S_u} w_z \\times pre_z}{pre_{f_u}}$$\n\n\u73b0\u5728\u7740\u624b\u8003\u8651 $w_z \\times pre_z$ \u4e0e $pre_{f_u}$ \u7684\u7ef4\u62a4\u3002\n\n\u8003\u8651\u65b0\u589e\u4e00\u4e2a\u70b9\u7684\u5f71\u54cd\uff0c\u5b83\u7684\u7236\u4eb2\u53ea\u5f71\u54cd\u5230\u6574\u9897\u7236\u4eb2\u7684\u5b50\u6811\uff0c\u4e14\u6bcf\u6b21\u589e\u52a0 1\uff0c\u6211\u4eec\u9700\u8981\u5148\u9664\u53bb\u65e7\u7684 $siz_{f}$ \u7684\u8d21\u732e\uff0c\u518d\u4e58\u4e0a\u65b0\u7684\u8d21\u732e $siz_f+1$\u3002\u5373\u4e58\u4e0a $\\frac{siz_f+1}{siz_f}$\uff0c\u8fd9\u4e2a\u62ff\u7ebf\u6bb5\u6811\u73c2\u4ee5\u8f7b\u677e\u89e3\u51b3\uff08\u8bb0\u5f97\u62cd\u6210 dfs \u5e8f\uff09\uff0c\u6ce8\u610f\uff0c\u8fd9\u91cc\u7684\u6574\u68f5\u5b50\u6811\u662f\u5305\u62ec **\u8fd8\u672a\u5efa\u51fa\u7684\u70b9**\uff01\uff08\u4e0d\u7136\u4f60\u4ee5\u540e\u8fd8\u5f97\u628a\u8d21\u732e\u7b97\u4e0a\uff09\n\n\u9700\u8981\u6ce8\u610f\u7684\u4e00\u4e2a\u70b9\u662f\uff0c\u7b97\u5b8c\u7236\u7684\u8d21\u732e\u4e4b\u540e\uff0c\u9700\u8981\u628a\u81ea\u5df1\u7684\u8d21\u732e\u8865\u4e0a\u3002\n\n\u590d\u6742\u5ea6 $O(Q\\log n)$\u3002\n\n### Code\uff1a\n\n\n```cpp\n#include <stdio.h>\n#include <algorithm>\n#include <string.h>\n#include <cctype>\n#include <vector>\nusing namespace std;\nconst int N=200005;\nconst int mo=1e9+7;\ninline int read(){\n\tchar ch=getchar();int x=0, f=1;\n\twhile(!isdigit(ch)) f=(ch=='-'?-1:f), ch=getchar();\n\twhile(isdigit(ch)) x=(x<<3)+(x<<1)+ch-'0', ch=getchar();\n\treturn x*f;\n}\ninline int ksm(int a, int b){\n\tint res=1;for(; b; b>>=1, a=1ll*a*a%mo) if(b&1) res=1ll*res*a%mo;\n\treturn res;\n}\n#define ls k<<1\n#define rs k<<1|1\n#define mid (l+r>>1)\nint sum[N*4], mu[N*4];\nvoid build(int k, int l, int r){mu[k]=1;if(l==r) return ;build(ls, l, mid), build(rs, mid+1, r);}\nvoid upd(int k, int t){\n\tsum[k]=1ll*sum[k]*t%mo;\n\tmu[k]=1ll*mu[k]*t%mo;\n}\nvoid pushdown(int k){\n\tif(mu[k]==1) return ;\n\tupd(ls, mu[k]), upd(rs, mu[k]);mu[k]=1;\n\treturn ; \n}\nvoid pushup(int k){\n\tsum[k]=(sum[ls]+sum[rs])%mo;\n\treturn ;\n}\nvoid insert(int k, int l, int r, int x, int w){\n\tif(l==r){\n\t\tsum[k]=1ll*w*mu[k]%mo;\n\t\treturn ;\n\t}pushdown(k);\n\tif(x<=mid) insert(ls, l, mid, x, w);\n\telse insert(rs, mid+1, r, x, w);\n\treturn pushup(k);\n}\nvoid mul(int k, int l, int r, int x, int y, int w){\n\tif(x<=l&&r<=y) return upd(k, w);pushdown(k);\n\tif(x<=mid) mul(ls, l, mid, x, y, w);\n\tif(mid<y) mul(rs, mid+1, r, x, y, w);\n\treturn pushup(k);\n}\nint query(int k, int l, int r, int x, int y, bool flg){\n\tif(x>r||y<l) return 0;\n\tif(x<=l&&r<=y) return flg?mu[k]:sum[k];pushdown(k);\n\treturn (query(ls, l, mid, x, y, flg)+query(rs, mid+1, r, x, y, flg))%mo;\n}\n#undef ls\n#undef rs\n#undef mid\nint n=1, Q, W[N], pos[N], op[N], dfn[N], siz[N], f[N], tot, nw[N];\nvector <int> G[N];\nvoid dfs(int x){\n\tsiz[x]=1;dfn[x]=++tot;\n\tfor(int i=0; i<G[x].size(); i++)\n\t\tf[G[x][i]]=x, dfs(G[x][i]), siz[x]+=siz[G[x][i]];\n}\nsigned main(){\n\tW[1]=read(), Q=read();\n\tfor(int i=1; i<=Q; i++){\n\t\top[i]=read(), pos[i]=read();\n\t\tif(op[i]&1) W[++n]=read(), G[pos[i]].push_back(n), pos[i]=n;\n\t}\n\tdfs(1);build(1, 1, n);\n\tinsert(1, 1, n, 1, W[1]);\n\tfor(int i=1; i<=n; i++) nw[i]=1;\n\tfor(int i=1; i<=Q; i++){\n\t\tint x=pos[i], fa=f[x];\n\t\tif(op[i]&1){\n\t\t\tint w=1ll*(nw[fa]+1)*ksm(nw[fa], mo-2)%mo;nw[fa]++;\n\t\t\tmul(1, 1, n, dfn[fa], dfn[fa]+siz[fa]-1, w);\n\t\t\tinsert(1, 1, n, dfn[x], W[x]);\n\t\t}\n\t\telse{\n\t\t\tint S=query(1, 1, n, dfn[x], dfn[x]+siz[x]-1, 0);\n\t\t\tint Z=1;\n\t\t\tif(x>1) Z=query(1, 1, n, dfn[fa], dfn[fa], 1);\n\t\t\tprintf(\"%d\\n\", 1ll*S*ksm(Z, mo-2)%mo);\n\t\t}\n\t}\n\treturn 0;\n}\n```\n\n\n",
        "postTime": 1634617554,
        "uid": 341102,
        "name": "ReKoJ",
        "ccfLevel": 0,
        "title": "CF607D Power Tree"
    },
    {
        "content": "\u9898\u610f:\u7ed9\u4f60\u4e00\u4e9b\u64cd\u4f5c,\u5176\u4e2d\u4e00\u4e2a\u64cd\u4f5c\u662f\u52a0\u5165\u4e00\u4e2a\u70b9,\u53e6\u4e00\u4e2a\u64cd\u4f5c\u662f\u67e5\u8be2\u4e00\u4e2a\u70b9\u7684\u8d21\u732e.\n\n\u5bf9\u4e8e\u4e00\u4e2a\u70b9,\u5b83\u7684\u8d21\u732e\u4e3a:$|S|*\\sum_{d \\in s}d$\n\n\u5176\u4e2dS\u662f\u5b83\u7684\u6743\u503c$w_i$\u4e0e\u5b83\u7684\u513f\u5b50 **(\u4e0d\u662f\u5b50\u6811)** \u7684\u53ef\u91cd\u96c6\u5408.\n\n\u8003\u8651\u5982\u4f55\u7ef4\u62a4.\n\n\u5f53\u52a0\u5165\u4e00\u4e2a\u70b9$i$\u65f6,\u5b83\u53ea\u4f1a\u8ba9\u5b83\u7684\u7236\u4eb2\u7684$|S|$\u52a0\u4e00,\u5e76\u4e14\u5bf9\u5305\u542b\u5b83\u7684\u7956\u5148\u4ea7\u751f$w_i$\u7684\u8d21\u732e.\n\n\u6211\u4eec\u53ef\u4ee5\u60f3\u5230,\u7ef4\u62a4dfs\u5e8f,\u5e76\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u6743\u503c.\n\n\u90a3\u4e48\u5982\u4f55\u7ef4\u62a4\u5462.\n\n\u6211\u4eec\u53d1\u73b0\u5982\u679c\u6211\u4eec\u5c06$f(i)$\u89c6\u4e3a$query(d[i],d[i]+sz[i]-1)$ \u7684\u8bdd,\u5f53\u52a0\u5165\u4e00\u4e2a\u70b9\u65f6,\u5b83\u7684\u7236\u4eb2\u7684$|S|$\u4f1a\u53d8\u6210$|S|+1$,\u6240\u4ee5\u6211\u4eec\u5c06$d[f]+sz[f]-1$\u533a\u95f4\u9664\u4e0a$|S|$\u518d\u4e58\u4e0a$|S|+1$,\u5c31\u4e0d\u4f1a\u51fa\u9519.,\u4f46\u6b64\u65f6\u52a0\u5165\u7684\u70b9\u6743\u4e0d\u80fd\u8bbe\u6210$w_i$\u4e86,\u9700\u8981\u8bbe\u6210$w_i * query(d[f],d[f])/w[f]$ .\u8fd9\u4e48\u505a\u662f\u56e0\u4e3a\u4f60\u9700\u8981\u7ef4\u62a4\u603b\u4f53\u7684\u548c.\u5728\u67e5\u8be2\u65f6\u6211\u4eec\u518d\u9664\u4e0a$query(d[f],d[f])/w[f]$\u5c31\u884c\u4e86.\u81f3\u4e8e\u4e0d\u5355\u7eaf\u4e58\u4e0a$s_f$\u7684\u539f\u56e0,\u662f\u56e0\u4e3a\u4f60\u7684\u7956\u5148\u4e5f\u5bf9\u4f60\u8fdb\u884c\u4e86\u4e58\u6cd5\u64cd\u4f5c,\u5982\u679c\u4f60\u5355\u7eaf\u7684\u53bb\u4e58$s_f$\u7684\u8bdd\u90a3\u4e48\u8d21\u732e\u5c31\u4e0d\u5bf9\u4e86.\n\n\u4ee3\u7801:\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define ls (i<<1)\n#define rs (i<<1|1)\n#define mid ((l+r)>>1)\n#define rep(i,j,k) for(int i=(j);i<=(k);i++)\n#define ll long long\nconst int N=1514514;\nconst int mod=1e9+7;\nvector<int> v[N],q[N];\nint fa[N],sz[N],d[N];\nint n,m,pos,as[N];\nll tr[N],s[N],lz[N],w[N];\nll msk(ll a){ll b=mod-2,k=1;\n\twhile(b){if(b&1)k=k*a%mod;a=a*a%mod;b>>=1;}return k;\n}\nvoid down(int i){\n \tll k=lz[i];lz[i]=1;if(k<=1)return;\n \tlz[ls]=lz[ls]*k%mod;lz[rs]=lz[rs]*k%mod;\n \ttr[ls]=tr[ls]*k%mod;tr[rs]=tr[rs]*k%mod;\n}\nvoid add(int i,int l,int r,int s,int t,ll w1,ll w2){\n\tif(s<=l&&r<=t){tr[i]=(tr[i]+w1)*w2%mod;lz[i]=lz[i]*w2%mod;return;}\n\tdown(i);if(s<=mid)add(ls,l,mid,s,t,w1,w2);\n\tif(t>mid) add(rs,mid+1,r,s,t,w1,w2);tr[i]=(tr[ls]+tr[rs])%mod;\n}//\u4e58\u6cd5\u548c\u52a0\u6cd5\u653e\u4e00\u8d77\u4e86()\nvoid dfs(int x){d[x]=++pos;sz[x]=1;\n\tfor(int i=0;i<v[x].size();i++)\n\t\tdfs(v[x][i]),sz[x]+=sz[v[x][i]];\n}ll query(int i,int l,int r,int s,int t){\n\tif(s<=l&&r<=t)return tr[i];down(i);\n\tll ans=0;if(s<=mid)ans=query(ls,l,mid,s,t);\n\tif(t>mid)ans=(ans+query(rs,mid+1,r,s,t))%mod;return ans;\n}\nint main(){\n\tscanf(\"%d%d\",&w[1],&m);n=1;\n\tfor(int i=1,op,x;i<=m;i++){\n\t\tscanf(\"%d%d\",&op,&x);\n\t\tif(op==1)n++,scanf(\"%d\",&w[n]),fa[n]=x,v[x].push_back(n);\n\t\telse q[n].push_back(x);\n\t}dfs(1);add(1,1,n,1,1,w[1],1);s[1]=1;\n\tfor(int j=0;j<q[1].size();j++)printf(\"%lld\\n\",w[1]);\n\trep(i,2,n){int f=fa[i];\n\t\tadd(1,1,n,d[f],d[f]+sz[f]-1,0,(s[f]+1)*msk(s[f])%mod);s[f]++;s[i]=1;\n\t\tadd(1,1,n,d[i],d[i],query(1,1,n,d[f],d[f])*msk(w[f])%mod*w[i]%mod,1);\n        //\u8fd9\u91cc\u5148\u4e58\u518d\u52a0\u4e0e\u5148\u52a0\u518d\u4e58\u6ca1\u6709\u533a\u522b\n\t\tfor(int j=0;j<q[i].size();j++){\n\t\t\tint u=q[i][j];ll kkr=query(1,1,n,d[u],d[u]+sz[u]-1);\n\t\t\tif(u==1)printf(\"%lld\\n\",kkr);//\u7279\u52241\u9632\u6b62\u67e5\u8be2 0\n\t\t\telse printf(\"%lld\\n\",kkr*w[fa[u]]%mod*msk(query(1,1,n,d[fa[u]],d[fa[u]]))%mod);//\u8bb0\u5f97\u9664\u4e0a\u81ea\u5df1\u4e58\u7684\u8d21\u732e\u6570\n\t\t}\n\t}\n}\n\n```",
        "postTime": 1610111629,
        "uid": 53852,
        "name": "\u5f26\u5dfb\u3053\u3053\u308d",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 CF607D \u3010Power Tree\u3011"
    }
]