[
    {
        "content": "\u795e\u4ed9\u7ebf\u6027\u4ee3\u6570\u9898\u3002\n\n\u9996\u5148\u628a\u53a8\u5e08\u4e4b\u95f4\u7684\u5173\u7cfb\u5199\u6210\u4e00\u4e2a\u77e9\u9635 $A$\u3002\n\n\u5176\u4e2d $A_{i,i}=i$\uff0c\u5982\u679c $i$ \u53ef\u4ee5\u5b66\u4e60 $j$ \u5219 $A_{i,j}=j$\uff0c\u5426\u5219 $A_{i,j}=0$\u3002\u53ef\u4ee5\u53d1\u73b0\u8fd9\u662f\u4e00\u4e2a\u4e0a\u4e09\u89d2\u77e9\u9635\u3002\n\n\u8bbe $x_k$ \u662f\u4e00\u4e2a\u5217\u5411\u91cf\uff0c\u5176\u4e2d\u7b2c $i$ \u884c\u7684\u503c\u4e3a\u7b2c $k$ \u5929\u4e4b\u540e\u7b2c $i$ \u4e2a\u4eba\u7684\u53a8\u827a\u6c34\u5e73\u3002\n\n\u8bbe $d_i$ \u4e3a\u6700\u5c0f\u7684 $k$\uff0c\u6ee1\u8db3\u5728 $x_{k,i}>0$\u3002\u5982\u679c\u4e0d\u5b58\u5728\u8fd9\u6837\u7684 $k$ \u5219 $d_i=+\\infty$\u3002**\u6ce8\u610f\u8fd9\u91cc\u5fc5\u987b\u662f\u4e25\u683c\u5927\u4e8e**\u3002\n\n\u56e0\u4e3a\u4efb\u4f55\u4eba\u90fd\u80af\u5b9a\u4e0d\u4f1a\u5b66\u4e60\u6743\u503c $<0$ \u7684\u4eba\uff0c\u6240\u4ee5\u7b2c $i$ \u4e2a\u4eba\u5728\u7b2c $d_i$ \u5929\u53ca\u4e4b\u524d\u90fd\u4e0d\u4f1a\u5f80\u5916\u4ea7\u751f\u8d21\u732e\u3002\n\n\u6b64\u65f6\u6709\u4e00\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684 observation\uff1a$d_i=\\min\\{d_j+1\\}$\uff0c\u5176\u4e2d $i$ \u80fd\u5b66\u4e60 $j$\u3002\n\n\u8fd9\u4e2a\u6027\u8d28\u6210\u7acb\u7684\u539f\u56e0\u662f\u9898\u76ee\u7ed9\u7684\u6761\u4ef6 $|a_i|\\le i$ \u5e76\u4e14 $i$ \u80fd\u5b66\u4e60\u7684\u6240\u6709 $j$ \u4e00\u5b9a\u6ee1\u8db3 $i<j$\u3002\n\n\u90a3\u4e48\u53ef\u4ee5\u5217\u51fa\u5f0f\u5b50\n\n$$x_k=\\sum\\limits_{d_i\\le k} A^{k-d_i}e_ia_i$$\n\n\u5176\u4e2d $e_i$ \u662f\u53ea\u6709\u7b2c $i$ \u884c\u4e3a $1$\uff0c\u5176\u4f59\u90fd\u662f $0$ \u7684\u5217\u5411\u91cf\u3002\n\n\u4f46\u662f $A$ \u975e\u5e38\u5de8\u5927\uff0c\u611f\u89c9\u6839\u672c\u6ca1\u6cd5\u505a\u3002\n\n\u6b64\u65f6\u5c31\u8981\u8bf7\u51fa\u672c\u9898\u7684\u6838\u5fc3\uff1a\u7279\u5f81\u503c\u4e0e\u7279\u5f81\u5411\u91cf\u3002\n\n\u5982\u679c\u53d8\u91cf $\\lambda$ \u548c\u5217\u5411\u91cf $f$ \u6ee1\u8db3 $Af=\\lambda f$\uff0c\u90a3\u4e48\u5c31\u53ef\u4ee5\u79f0 $\\lambda$ \u548c $f$ \u4e3a $A$ \u7684\u4e00\u7ec4\u7279\u5f81\u503c\u4e0e\u7279\u5f81\u5411\u91cf\u3002\n\n\u5bb9\u6613\u63a8\u51fa\n\n$$A^kf=A^{k-1}(Af)=A^{k-1}\\lambda f=\\lambda A^{k-1}f$$\n\n\u56e0\u6b64\n\n$$A^kf=\\lambda^k f$$\n\n$A$ \u662f\u4e0a\u4e09\u89d2\u77e9\u9635\uff0c\u5e76\u4e14\u5bf9\u89d2\u7ebf\u4e0a\u90fd\u4e0d\u4e3a $0$\uff0c\u6240\u4ee5\u5b83\u6709 $n$ \u7ec4\u7279\u5f81\u503c\u4e0e\u7279\u5f81\u5411\u91cf\uff0c\u5e76\u4e14\u6240\u6709\u7279\u5f81\u5411\u91cf\u7ebf\u6027\u65e0\u5173\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u7528\u7279\u5f81\u5411\u91cf\u6765\u7ebf\u6027\u8868\u793a\u51fa\u6240\u6709 $e_i$\u3002\u8bbe $e_i=\\sum\\limits_{j} w_{i,j}f_j$\u3002\n\n\u53ef\u4ee5\u5f97\u51fa\n\n$$x_k=\\sum\\limits_{d_i\\le k} A^{k-d_i}e_ia_i$$\n$$=\\sum\\limits_{d_i\\le k} A^{k-d_i}\\sum\\limits_j w_{i,j}f_ja_i$$\n$$=\\sum\\limits_j \\lambda_j^kf_j\\sum\\limits_{d_i\\le k} \\lambda_j^{-d_i}w_{i,j}a_i$$\n\n\u6211\u4eec\u53ea\u9700\u8981\u67e5\u8be2\u533a\u95f4\u548c\uff0c\u6240\u4ee5\u5bf9\u6bcf\u4e2a $f$ \u7ef4\u62a4\u524d\u7f00\u548c\u3002\n\n\u6bcf\u6b21\u8be2\u95ee\u65f6\u53ea\u9700\u8981\u5bf9\u6bcf\u4e2a $j$ \u8ba1\u7b97\u51fa $f_j$ \u524d\u9762\u7684\u7cfb\u6570\u5373\u53ef\u3002\n\n\u76f4\u63a5\u66b4\u529b\u662f $O(n^3+qn^2)$ \u7684\uff0c\u8003\u8651\u4f18\u5316\u3002\n\n\u5982\u679c $d$ \u56fa\u5b9a\u4e0d\u53d8\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u5bf9\u4e8e\u6bcf\u4e00\u4e2a $j$ \u5f00\u4e00\u4e2a\u6811\u72b6\u6570\u7ec4\u6765\u7ef4\u62a4\u5355\u70b9\u4fee\u6539\u524d\u7f00\u6c42\u548c\u3002\n\n\u53ef\u4ee5\u53d1\u73b0\uff0c\u53ea\u6709\u5728 $a_i\\le0$ \u4e14 $a_i+x>0$ \u7684\u4fee\u6539\u64cd\u4f5c\u624d\u4f1a\u4f7f\u5f97 $d$ \u53d1\u751f\u53d8\u5316\u3002\u800c\u56e0\u4e3a $x>0$\uff0c\u6240\u4ee5\u8fd9\u6837\u7684\u64cd\u4f5c\u53ea\u6709 $O(n)$ \u4e2a\u3002\u56e0\u6b64\u9047\u5230\u8fd9\u79cd\u60c5\u51b5\u65f6\u76f4\u63a5\u66b4\u529b\u91cd\u6784\u6240\u6709\u6811\u72b6\u6570\u7ec4\u5373\u53ef\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(n^3+qn\\log n)$ \u6216 $O(n^3\\log n+qn\\log n)$\uff0c\u53d6\u51b3\u4e8e\u91cd\u6784\u6811\u72b6\u6570\u7ec4\u662f $O(n)$ \u8fd8\u662f $O(n\\log n)$\u3002\n\n\u53c2\u8003\u4ee3\u7801 $O(n^3+qn\\log n)$\uff1a\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n#define N 305\n#define M 1005\n#define LIM 1000005\n#define MOD 1000000007\n#define gc() (P1==P2 && (P2=(P1=buf)+fread(buf,1,LIM,stdin),P1==P2)?EOF:*P1++)\nconst int lim=1e3,INF=1e9;char *P1,*P2,buf[LIM];\nint n,m,b[N],d[N],s[N],a[N][N],z[N][N],z1[N][N],pw[N][M],invPw[N][M];\nint add(int x,int y) {x+=y;return x<MOD?x:x-MOD;}\nvoid W(int &x,int y) {x+=y;if(x>=MOD) x-=MOD;}\nint rd()\n{\n\tint res=0;char c=0;bool fl=0;while(!isdigit(c)) fl|=c=='-',c=gc();\n\twhile(isdigit(c)) res=res*10+c-48,c=gc();return fl?-res:res;\n}\nvoid print(int x) {if(x<10) {putchar(x+48);return;}print(x/10);putchar(x%10+48);}\nstruct BitArray \n{\n\tint vl[N];void clear() {for(int i=0;i<=n;++i) vl[i]=0;}\n\tvoid build()\n\t{\n\t\tfor(int i=1;i<=n;++i) s[i]=add(s[i-1],vl[i-1]);\n\t\tfor(int i=1;i<=n;++i) vl[i]=add(s[i],MOD-s[i&i-1]);\n\t}\n\tvoid upd(int x,int w) {x=min(x+1,n);for(;x<=n;x+=x&-x) W(vl[x],w);}\n\tint qry(int x) {x=min(x+1,n);int res=0;for(;x;x-=x&-x) W(res,vl[x]);return res;}\n}BIT[N];\nint qPow(int x,int y)\n{int res=1;for(;y;y/=2,x=1ll*x*x%MOD) if(y&1) res=1ll*res*x%MOD;return res;}\nvoid init()\n{\n\tfor(int i=1,t;i<=n;++i)\n\t{\n\t\tpw[i][0]=invPw[i][0]=1;t=qPow(i,MOD-2);\n\t\tfor(int j=1;j<=lim;++j)\n\t\t\tpw[i][j]=1ll*pw[i][j-1]*i%MOD,invPw[i][j]=1ll*invPw[i][j-1]*t%MOD;\n\t}\n}\nvoid calc(int x)\n{\n\tfor(int i=x-1,t;i;--i)\n\t{\n\t\tt=0;for(int j=i+1;j<=x;++j) W(t,1ll*a[i][j]*z[x][j]%MOD);\n\t\tz[x][i]=1ll*t*qPow(x-i,MOD-2)%MOD; \n\t}\n}\nvoid calc1()\n{\n\tfor(int i=1;i<=n;++i) for(int j=1;j<i;++j) for(int k=1;k<=j;++k)\n\t\tW(z1[i][k],MOD-1ll*z[i][j]*z1[j][k]%MOD);\n}\nvoid build()\n{\n\tfor(int i=n;i;--i)\n\t{d[i]=b[i]>0?0:INF;for(int j=i+1;j<=n;++j) if(a[i][j]) d[i]=min(d[i],d[j]+1);}\n\tfor(int i=1;i<=n;++i)\n\t{\n\t\tBIT[i].clear();\n\t\tfor(int j=i;j<=n;++j) if(d[j]<INF)\n\t\t\tW(BIT[i].vl[d[j]],1ll*z1[j][i]*add(b[j],MOD)%MOD*invPw[i][d[j]]%MOD);\n\t\tBIT[i].build(); \n\t}\n}\nvoid upd(int x,int w)\n{\n\tif(d[x]<INF) for(int i=1;i<=x;++i)\n\t\tBIT[i].upd(d[x],1ll*z1[x][i]*w%MOD*invPw[i][d[x]]%MOD);b[x]+=w;\n}\nint qry(int x,int l,int r)\n{\n\tint res=0;for(int i=l;i<=r;++i) if(d[i]>x) W(res,add(b[i],MOD));\n\tfor(int i=1;i<=n;++i)\n\t\tW(res,1ll*BIT[i].qry(x)*pw[i][x]%MOD*add(z[i][r],MOD-z[i][l-1])%MOD);\n\treturn res;\n}\nint main()\n{\n\tn=rd();for(int i=1;i<=n;++i) a[i][i]=i,z[i][i]=z1[i][i]=1,b[i]=rd();\n\tfor(int i=1,x,y;i<=n;++i) {x=rd();for(int j=1;j<=x;++j) y=rd(),a[i][y]=y;}\n\tm=rd();init();for(int i=1;i<=n;++i) calc(i);calc1();\n\tfor(int i=1;i<=n;++i) for(int j=1;j<=n;++j) W(z[i][j],z[i][j-1]);build();\n\tfor(int i=1,F[4];i<=m;++i)\n\t{\n\t\tF[0]=rd();F[1]=rd();F[2]=rd();\n\t\tif(F[0]==1) F[3]=rd(),print(qry(F[1],F[2],F[3])),puts(\"\");\n\t\tif(F[0]==2)\n\t\t{\n\t\t\tif(b[F[1]]<=0 && b[F[1]]+F[2]>0) b[F[1]]+=F[2],build();\n\t\t\telse upd(F[1],F[2]);\n\t\t}\n\t}return 0;\n}\n```",
        "postTime": 1646363631,
        "uid": 119621,
        "name": "Kubic",
        "ccfLevel": 10,
        "title": "CF1540E Tasty Dishes"
    }
]