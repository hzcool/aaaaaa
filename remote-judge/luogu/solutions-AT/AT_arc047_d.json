[
    {
        "content": "[link](https://www.luogu.com.cn/problem/AT_arc047_d)\r\n\r\n\u9898\u76ee\u5927\u610f\uff1a\r\n\r\n\u6709\u4e00\u4e2a $n\\times n$\uff08$1\\le n \\le 5000$\uff09\u7684\u6b63\u65b9\u5f62\u77e9\u9635\uff0c\u521d\u59cb\u5168\u90e8\u4e3a $0$\uff0c\u4e0b\u6807\u4ece $0$ \u5f00\u59cb\u3002\r\n\r\n\u6709 $q$\uff08$1 \\le q \\le 5000$\uff09\u6b21\u64cd\u4f5c\uff1a\r\n\r\n+ $1$ $a$ $b$ $c$ \u5c06\u6240\u6709\u6ee1\u8db3 $a \\le x+y \\le b$ \u7684\u70b9 $(x,y)$ \u7684\u503c\u52a0\u4e0a $c$\u3002\r\n\r\n+ $2$ $a$ $b$ $c$ \u5c06\u6240\u6709\u6ee1\u8db3 $a \\le x-y \\le b$ \u7684\u70b9 $(x,y)$ \u7684\u503c\u52a0\u4e0a $c$\u3002\r\n\r\n+ $3$ $a$ $b$ $c$ $d$ \u67e5\u8be2\u6240\u6709\u6ee1\u8db3 $a \\le x \\le b$\uff0c $c \\le y \\le d$ \u7684\u70b9 $(x,y)$ \u7684\u6700\u5927\u503c\uff0c\u5e76\u6c42\u51fa\u503c\u4e3a\u6700\u5927\u503c\u7684\u70b9\u7684\u4e2a\u6570\u3002\r\n\r\n\u90e8\u5206\u5206\uff1a$1 \\le n \\le 500$\r\n\r\n\u9898\u89e3\uff1a\r\n\r\n\u6211\u4eec\u8003\u8651\u7ef4\u62a4\u4e24\u4e2a\u6570\u7ec4 $s1,s2$\uff0c\u5176\u4e2d $s1_i$ \u8868\u793a\u6240\u6709\u6ee1\u8db3 $x+y=i$ \u7684\u70b9\u52a0\u7684\u548c\uff0c$s2_i$ \u8868\u793a\u6240\u6709\u6ee1\u8db3 $x-y=i$ \u7684\u70b9\u52a0\u7684\u548c\u3002\r\n\r\n\u5bf9\u4e8e\u4e00\u4e2a\u70b9 $(x,y)$\uff0c\u4ed6\u7684\u503c\u5c31\u662f $s1_{x+y}+s2_{x-y}$\uff0c\u6240\u4ee5\u6211\u4eec\u7ef4\u62a4 $s1,s2$ \u5c31\u53ef\u4ee5\u77e5\u9053\u5168\u77e9\u9635\u7684\u503c\u4e86\uff0c$1$ \u548c $2$ \u64cd\u4f5c\u7684\u590d\u6742\u5ea6\u90fd\u4e3a $O(nq)$\u3002\r\n\r\n\u5173\u952e\u5728\u4e8e\u8fd9\u4e2a\u8be2\u95ee\u3002\r\n\r\n\u6211\u4eec\u53ef\u4ee5\u679a\u4e3e\u6240\u6709\u53ef\u80fd\u7684 $sum$\uff08\u5c31\u662f $x+y$ \u7684\u503c\uff09\uff0c\u90a3\u4e48\u53ef\u4ee5\u53d1\u73b0\uff0c\u90a3\u4e9b\u5728 $sum$ \u5df2\u77e5\u7684\u6761\u4ef6\u4e0b\u53ef\u884c\u7684 $x-y$ \u5c31\u662f\u8fde\u7eed\u7684\u4e00\u4e9b\u5947\u6570\u6216\u8005\u5076\u6570\u3002\u7528\u6570\u636e\u7ed3\u6784\u7ef4\u62a4\u53ef\u4ee5\u505a\u5230 $O(qn\\log n)$\uff0c\u5f97\u5230\u90e8\u5206\u5206\u3002\r\n\r\n\u518d\u7ee7\u7eed\u8003\u8651\u3002\r\n\r\n\u8003\u8651\u7279\u6b8a\u5316\uff0c\u67e5\u8be2\u7684\u662f\u4e00\u4e2a\u6b63\u65b9\u5f62\u3002\r\n\r\n\u5982\u679c\u6211\u4eec\u4ece\u5c0f\u5230\u5927\u679a\u4e3e\u6240\u6709\u7684 $sum$\uff0c\u4e14\u679a\u4e3e\u7684\u65f6\u5019\u8ba9 $step=2$\uff08\u5c31\u662f\u6309\u7167 $sum$\uff0c$sum+2$\uff0c$sum+4 \\dots$ \u7684\u987a\u5e8f\u679a\u4e3e\uff09\uff0c\u53ef\u4ee5\u53d1\u73b0\u6bcf\u6b21\u53ea\u4f1a\u65b0\u589e\u4e24\u4e2a\u53ef\u80fd\u7684 $x-y$\uff0c\u4e0d\u4f1a\u53d8\u5c11\uff0c\u6240\u4ee5\u6211\u4eec\u53ea\u8981\u66b4\u529b\u7528\u65b0\u589e\u7684\u4e24\u4e2a $x-y$ \u66f4\u65b0\u5c31\u884c\u4e86\u3002\r\n\r\n\u540c\u7406\uff0c\u6211\u4eec\u518d\u6309\u7167 $sum+1$\uff0c$sum+3\\dots$ \u7684\u987a\u5e8f\u679a\u4e3e\uff0c\u4e24\u79cd\u60c5\u51b5\u5408\u5e76\u540e\u5c31\u662f\u7b54\u6848\u4e86\u3002\r\n\r\n\u518d\u8003\u8651\u628a\u67e5\u8be2\u4e00\u822c\u5316\u4e3a\u957f\u65b9\u5f62\uff0c\u5219\u53ef\u4ee5\u6309\u7167\u7c7b\u4f3c\u8f97\u8f6c\u76f8\u51cf\u6cd5\u7684\u65b9\u6cd5\u6bcf\u6b21\u5272\u51fa\u6700\u5927\u7684\u6b63\u65b9\u5f62\u53bb\u67e5\u8be2\uff0c\u7136\u540e\u5408\u5e76\u6240\u6709\u7684\u7b54\u6848\uff0c\u53ef\u4ee5\u8bc1\u660e\u5355\u6b21\u8be2\u95ee\u590d\u6742\u5ea6\u4e3a $O(n)$\uff0c\u6545\u603b\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(nq)$\u3002\r\n\r\n---\r\n\r\nCode:\r\n\r\n```cpp\r\n#include<bits/stdc++.h>\r\nusing namespace std;\r\nconst int mxn=1e4+9;\r\nconst int base=5003;\r\nint n,q,s1[mxn],s2[mxn];\r\ninline pair<int,int> G(pair<int,int> x,pair<int,int> y){\r\n\tif(x.first!=y.first){\r\n\t\tif(x.first>y.first)return x;\r\n\t\telse return y;\r\n\t}\r\n\tx.second+=y.second;\r\n\treturn x;\r\n}\r\ninline pair<int,int> go(int a,int b,int c,int d){\r\n\tint cur,cnt,len;\r\n\tpair<int,int>rt={-1145141919,0};\r\n\tcur=-1145141919,cnt=0,len=-2;\r\n\tfor(int sum1=a+b,sum2=c+d;sum1<=a+d;sum1+=2,sum2-=2){ //\u7b2c\u4e00\u7c7b\r\n\t\tlen+=2;\r\n\t\tif(s2[a-b+base-len]>cur)cur=s2[a-b+base-len],cnt=1;\r\n\t\telse if(s2[a-b+base-len]==cur)++cnt;\r\n\t\tif(len!=0){\r\n\t\t\tif(s2[a-b+base+len]>cur)cur=s2[a-b+base+len],cnt=1;\r\n\t\t\telse if(s2[a-b+base+len]==cur)++cnt;\t\t\t\r\n\t\t}\r\n\t\tif(s1[sum1]+cur>rt.first){\r\n\t\t\trt.first=s1[sum1]+cur;\r\n\t\t\trt.second=cnt;\r\n\t\t}else if(s1[sum1]+cur==rt.first){\r\n\t\t\trt.second+=cnt;\r\n\t\t}\r\n\t\tif(sum1!=sum2){\r\n\t\t\tif(s1[sum2]+cur>rt.first){\r\n\t\t\t\trt.first=s1[sum2]+cur;\r\n\t\t\t\trt.second=cnt;\r\n\t\t\t}else if(s1[sum2]+cur==rt.first){\r\n\t\t\t\trt.second+=cnt;\r\n\t\t\t}\t\t\t\r\n\t\t}\r\n\t}\r\n\tlen=-1,cnt=0,cur=-1145141919;\r\n\tfor(int sum1=a+b+1,sum2=c+d-1;sum1<=a+d;sum1+=2,sum2-=2){ //\u7b2c\u4e8c\u7c7b\r\n\t\tlen+=2;\r\n\t\tif(s2[a-b+base-len]>cur)cur=s2[a-b+base-len],cnt=1;\r\n\t\telse if(s2[a-b+base-len]==cur)++cnt;\r\n\t\tif(len!=0){\r\n\t\t\tif(s2[a-b+base+len]>cur)cur=s2[a-b+base+len],cnt=1;\r\n\t\t\telse if(s2[a-b+base+len]==cur)++cnt;\t\t\t\r\n\t\t}\r\n\t\tif(s1[sum1]+cur>rt.first){\r\n\t\t\trt.first=s1[sum1]+cur;\r\n\t\t\trt.second=cnt;\r\n\t\t}else if(s1[sum1]+cur==rt.first){\r\n\t\t\trt.second+=cnt;\r\n\t\t}\r\n\t\tif(sum1!=sum2){\r\n\t\t\tif(s1[sum2]+cur>rt.first){\r\n\t\t\t\trt.first=s1[sum2]+cur;\r\n\t\t\t\trt.second=cnt;\r\n\t\t\t}else if(s1[sum2]+cur==rt.first){\r\n\t\t\t\trt.second+=cnt;\r\n\t\t\t}\t\t\t\r\n\t\t}\r\n\t}\r\n\treturn rt;\r\n}\r\ninline auto solve(int a,int b,int c,int d){//\u5272\u6210\u6781\u5927\u6b63\u65b9\u5f62\r\n\tif(c-a==d-b)return go(a,b,c,d);\r\n\tint l=min(c-a,d-b);\r\n\tif(c-a>d-b){\r\n\t\tpair<int,int> rt=go(a,b,a+l,b+l);\r\n\t\trt=G(rt,solve(a+l+1,b,c,d));\r\n\t\treturn rt;\r\n\t}else{\r\n\t\tpair<int,int> rt=go(a,b,a+l,b+l);\r\n\t\trt=G(rt,solve(a,b+l+1,c,d));\r\n\t\treturn rt;\r\n\t}\r\n}\r\nint main(){\r\n\tios_base::sync_with_stdio(false);\r\n\tcin.tie(0),cout.tie(0);\r\n\tcin>>n>>q;\r\n\tfor(;q--;){\r\n\t\tint tp,a,b,c,d;\r\n\t\tcin>>tp;\r\n\t\tif(tp==1){\r\n\t\t\tcin>>a>>b>>c;\r\n\t\t\tfor(int i=a;i<=b;++i)s1[i]+=c;\r\n\t\t}\r\n\t\tif(tp==2){\r\n\t\t\tcin>>a>>b>>c;\r\n\t\t\ta+=base,b+=base;\r\n\t\t\tfor(int i=a;i<=b;++i)s2[i]+=c;\r\n\t\t}\r\n\t\tif(tp==3){\r\n\t\t\tcin>>a>>b>>c>>d;\r\n\t\t\tauto p=solve(a,c,b,d);\r\n\t\t\tcout<<p.first<<' '<<p.second<<'\\n';\r\n\t\t}\r\n\t}\r\n}\r\n```",
        "postTime": 1674996722,
        "uid": 226760,
        "name": "RedLycoris",
        "ccfLevel": 7,
        "title": "Never gonna let you down"
    }
]