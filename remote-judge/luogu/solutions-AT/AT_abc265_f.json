[
    {
        "content": "# [[ABC265F] Manhattan Cafe](https://www.luogu.com.cn/problem/AT_abc265_f) Solution\n\n[TOC]\n\n## [\u66f4\u597d\u7684\u9605\u8bfb\u4f53\u9a8c\u6233\u6b64\u8fdb\u5165](http://blog.tsawke.com?t=ABC265F)\n\n## \u9898\u9762\n\n\u5728 $ n $ \u7ef4\u7a7a\u95f4\u4e2d\u5b58\u5728 $ p, q $ \u4e24\u70b9\uff0c\u6c42\u6709\u591a\u5c11\u4e2a\u6574\u70b9\u6ee1\u8db3\u5230 $ p, q $ \u7684\u66fc\u54c8\u987f\u8ddd\u79bb\u5747\u4e0d\u5927\u4e8e $ d $\u3002\n\n## Solution\n\n\u7ec6\u8282\u5de8\u591a\u7684 DP\u3002\n\n\u9996\u5148\u6709\u4e00\u4e2a\u8f83\u4e3a\u663e\u7136\u7684 $ \\texttt{3D1D} $ \u7684 $ O(nd^3) $ \u7684\u505a\u6cd5\uff0c\u5373\u4ee4 $ dp(i, j, k) $ \u8868\u793a\u8003\u8651\u524d $ i $ \u7ef4\u5230 $ p $ \u66fc\u54c8\u987f\u8ddd\u79bb\u4e3a $ j $\uff0c\u5230 $ q $ \u66fc\u54c8\u987f\u8ddd\u79bb\u4e3a $ k $ \u7684\u65b9\u6848\u6570\uff0c\u7136\u540e\u8fd9\u4e2a\u4e1c\u897f $ O(d) $ \u7684\u8f6c\u79fb\u8f83\u4e3a\u663e\u7136\uff0c\u5373\u679a\u4e3e $ i $ \u7ef4\u7684\u5750\u6807\uff0c\u4ee4\u5176\u4e3a $ x $ \u5219\u8f6c\u79fb\u4e3a\uff1a\n$$\ndp(i, j, k) = \\sum_x dp(i, j - \\lvert x - p_i \\rvert, k - \\lvert x - q_i \\rvert) \\times [\\lvert x - p_i \\rvert \\le d \\land \\lvert x - q_i \\rvert \\le d]\n$$\n\u7136\u540e\u8fd9\u4e2a\u4e1c\u897f\u5b9e\u9645\u4e0a\u662f\u53ef\u4ee5\u901a\u8fc7\u7c7b\u4f3c\u524d\u7f00\u548c\u7684\u4e1c\u897f\u8f6c\u79fb\u7684\uff0c\u4f46\u662f\u662f\u7c7b\u4f3c\u5bf9\u89d2\u7ebf\u524d\u7f00\u548c\u7684\uff0c\u6bd4\u8f83\u590d\u6742\u7ec6\u8282\u5de8\u591a\uff0c\u6240\u4ee5\u8fd9\u91cc\u53c2\u8003\u4ee5\u4e0b\u673a\u623f\u5927\u4f6c @sssmzy \u7684\u505a\u6cd5\u3002\n\n\u8003\u8651\u5c06\u72b6\u6001\u4fee\u6539\u4e3a $ dp(i, j, k) $ \u8868\u793a\u8003\u8651\u524d $ i $ \u7ef4\uff0c\u5230 $ p $ \u548c $ q $ \u7684\u66fc\u54c8\u987f\u8ddd\u79bb\u548c\u4e3a $ j $\uff0c\u5230 $ p $ \u7684\u66fc\u54c8\u987f\u8ddd\u79bb\u4e3a $ k $\u3002\n\n\u8fd9\u4e2a\u65f6\u5019\u8003\u8651\u4e24\u79cd\u53ef\u80fd\u6027\uff0c\u5bf9\u4e8e\u67d0\u6b21\u679a\u4e3e\u7684\u4f4d\u7f6e $ x $\uff0c\u82e5\u6ee1\u8db3 $ p_i \\le x \\le q_i \\lor q_i \\le x \\le p_i $\uff0c\u4e5f\u5c31\u662f\u8bf4 $ x $ \u5728 $ p, q $ \u4e4b\u95f4\uff0c\u90a3\u4e48 $ j $ \u8fd9\u4e00\u7ef4\u662f\u4ece $ j - \\lvert p_i - q_i \\rvert $ \u8f6c\u79fb\u800c\u6765\uff0c\u800c $ k $ \u4ece $ k $ \u5230 $ k - \\lvert p_i - q_i \\rvert $ \u8fd9\u6bb5\u533a\u95f4\u8f6c\u79fb\u800c\u6765\uff0c\u90a3\u4e48\u5373\u53ef\u4ee5\u7528\u524d\u7f00\u548c\u8f6c\u79fb\u3002\n\n\u8003\u8651\u5bf9\u4e8e $ x $ \u5728 $ p, q $ \u4e4b\u5916\u7684\u60c5\u51b5\uff0c\u90a3\u4e48\u5bf9\u4e8e\u6bcf\u4e2a $ x \\leftarrow x + 1 \\lor x \\leftarrow x - 1 $\uff0c\u663e\u7136\u5b58\u5728 $ j \\leftarrow j + 2, k \\leftarrow j + 1 $\u3002\u6240\u4ee5\u6211\u4eec\u53ea\u9700\u8981\u518d\u7ef4\u62a4\u4e00\u4e2a\u524d\u7f00\u548c $ sum_2(j, k) = sum_2(j - 2, k - 1) + dp(j, k) $ \u5373\u53ef\u3002\n\n\u5177\u4f53\u6765\u8bf4\uff0c\u7ef4\u62a4\u4e00\u4e2a $ sum $ \u548c $ sum_2 $\uff0c\u610f\u4e49\u540c\u4e0a\u3002\u540c\u65f6\u56e0\u4e3a\u7a7a\u95f4\u95ee\u9898\u6211\u4eec\u9700\u8981\u628a\u7b2c\u4e00\u7ef4\u6eda\u52a8\u6389\u3002\u5177\u4f53\u7684\u8f6c\u79fb\u5373\u82e5 $ j \\lt \\lvert p_i - q_i \\rvert $ \u90a3\u4e48 $ dp(j, k) = 0 $\u3002\u5426\u5219\u4ee4 $ dis = \\lvert p_i - q_i \\rvert $\uff0c\u5373\u4e3a\uff1a\n$$\ndp(j, k) = sum(j - dis, k) - sum(j - dis, k - dis - 1) + sum_2(j - dis - 2, k - 1) + sum_2(j - dis - 2, k - dis - 1)\n$$\n\u8f6c\u79fb\u7684\u610f\u4e49\u5373\u4e3a\u5728 $ p, q $ \u4e2d\u95f4\u548c\u5206\u522b\u5728 $ p, q $ \u7684\u4e24\u4fa7\u3002\n\n\u4e8e\u662f\u6bcf\u6b21\u5904\u7406\u5b8c DP \u540e\u6e05\u7a7a\u5e76\u91cd\u65b0\u7ef4\u62a4 $ sum, sum_2 $ \u5373\u53ef\u3002\n\n\u6700\u7ec8\u590d\u6742\u5ea6\u4e3a $ O(nd^2) $\uff0c\u53ef\u4ee5\u901a\u8fc7\u3002\n\n## Code\n\n```cpp\n#define _USE_MATH_DEFINES\n#include <bits/stdc++.h>\n\n#define PI M_PI\n#define E M_E\n#define npt nullptr\n#define SON i->to\n#define OPNEW void* operator new(size_t)\n#define ROPNEW(arr) void* Edge::operator new(size_t){static Edge* P = arr; return P++;}\n\nusing namespace std;\n\nmt19937 rnd(random_device{}());\nint rndd(int l, int r){return rnd() % (r - l + 1) + l;}\nbool rnddd(int x){return rndd(1, 100) <= x;}\n\ntypedef unsigned int uint;\ntypedef unsigned long long unll;\ntypedef long long ll;\ntypedef long double ld;\n\n#define MOD (998244353ll)\n\ntemplate < typename T = int >\ninline T read(void);\n\nint N, D;\nint P[110], Q[110];\nll dp[2100][1100];\nll sum[2100][1100];\nll sum2[2100][1100];\nll ans(0);\n\nint main(){\n    N = read(), D = read();\n    for(int i = 1; i <= N; ++i)P[i] = read();\n    for(int i = 1; i <= N; ++i)Q[i] = read();\n    dp[0][0] = 1;\n    for(int j = 0; j <= D * 2; ++j)\n        for(int k = 0; k <= D; ++k)\n            sum[j][k] = ((k - 1 >= 0 ? sum[j][k - 1] : 0) + dp[j][k]) % MOD,\n            sum2[j][k] = ((j - 2 >= 0 && k - 1 >= 0 ? sum2[j - 2][k - 1] : 0) + dp[j][k]) % MOD;\n    for(int i = 1; i <= N; ++i){\n        for(int j = 0; j <= D * 2; ++j)\n            for(int k = 0; k <= D; ++k){\n                int dis = abs(P[i] - Q[i]);\n                dp[j][k] = j >= dis\n                    ?\n                        ((sum[j - dis][k] - (k - dis - 1 >= 0 ? sum[j - dis][k - dis - 1] : 0) + MOD) % MOD +\n                        (j - dis - 2 >= 0 && k - 1 >= 0 ? sum2[j - dis - 2][k - 1] % MOD : 0) +\n                        (j - dis - 2 >= 0 && k - dis - 1 >= 0 ? sum2[j - dis - 2][k - dis - 1] % MOD : 0)) % MOD\n                    : 0;\n            }\n        memset(sum, 0, sizeof sum), memset(sum2, 0, sizeof sum2);\n        for(int j = 0; j <= D * 2; ++j)\n            for(int k = 0; k <= D; ++k)\n                sum[j][k] = ((k - 1 >= 0 ? sum[j][k - 1] : 0) + dp[j][k]) % MOD,\n                sum2[j][k] = ((j - 2 >= 0 && k - 1 >= 0 ? sum2[j - 2][k - 1] : 0) + dp[j][k]) % MOD;\n    }\n    for(int j = 0; j <= D * 2; ++j)for(int k = 0; k <= min(j, D); ++k)\n        if(j - k <= D) (ans += dp[j][k]) %= MOD;\n    printf(\"%lld\\n\", ans);\n    fprintf(stderr, \"Time: %.6lf\\n\", (double)clock() / CLOCKS_PER_SEC);\n    return 0;\n}\n\ntemplate < typename T >\ninline T read(void){\n    T ret(0);\n    int flag(1);\n    char c = getchar();\n    while(c != '-' && !isdigit(c))c = getchar();\n    if(c == '-')flag = -1, c = getchar();\n    while(isdigit(c)){\n        ret *= 10;\n        ret += int(c - '0');\n        c = getchar();\n    }\n    ret *= flag;\n    return ret;\n}\n```\n\n## UPD\n\nupdate-2023_01_05 \u521d\u7a3f",
        "postTime": 1672902884,
        "uid": 362938,
        "name": "Tsawke",
        "ccfLevel": 6,
        "title": "[ABC265F] Manhattan Cafe \u9898\u89e3"
    }
]