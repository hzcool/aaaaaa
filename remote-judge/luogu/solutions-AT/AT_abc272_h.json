[
    {
        "content": "### Solution\n\n\u8da3\u5473\u3002\n\n\n\n------------\n\n\n\u9996\u5148\u5f15\u5165\u4e00\u4e2a\u4e1c\u897f\uff1arook polynomial\u3002\u4e00\u4e2a\u5927\u5c0f\u4e3a $n\\times n$\u3001\u6709\u82e5\u5e72\u7279\u6b8a\u4f4d\u7f6e\u7684\u68cb\u76d8 $A$ \u7684 rook polynomial \u901a\u5e38\u610f\u4e49\u4e0b\u5177\u6709\u8fd9\u6837\u7684\u5b9a\u4e49\uff1a\n\n$$\nR(x,A)=\\sum_{k\\geq 0}r_k(A)x^k\n$$\n\n\u5176\u4e2d $r_k(A)$ \u8868\u793a\u5728\u68cb\u76d8 $A$ \u7684\u7279\u6b8a\u4f4d\u7f6e\u4e0a\u653e $k$ \u4e2a\u4e92\u4e0d\u653b\u51fb\u7684\u8f66\u7684\u65b9\u6848\u6570\u3002\u4e00\u4e2a\u8f66\u80fd\u653b\u51fb\u5230\u540c\u884c\u540c\u5217\u7684\u4f4d\u7f6e\u3002\n\n\u7136\u540e\u8003\u8651\u5206\u6790\u8fd9\u4e2a\u4e1c\u897f\u7684\u6027\u8d28\u3002\n\n#### Lemma 1\n\n\u8bbe $w_k(A)$ \u8868\u793a\u5728 $A$ \u4e0a\u653e $n$ \u4e2a\u4e92\u4e0d\u653b\u51fb\u7684\u8f66\uff0c\u5176\u4e2d $k$ \u4e2a\u5728\u7279\u6b8a\u4f4d\u7f6e\u4e0a\u7684\u65b9\u6848\u6570\uff0c\u5e76\u8bbe $W(x,A)=\\sum_{k\\geq 0}w_k(A)x^k$\uff0c\u90a3\u4e48\u6709\uff1a\n$$\nW(x,A)=\\sum_{k\\geq 0}r_k(A)(n-k)!(x-1)^k\n$$\n\n#### Proof\n\n\u8003\u8651\u4e8c\u9879\u5f0f\u53cd\u6f14\uff1a\n$$\n\\begin{aligned}\nr_k(A)(n-k)!=\\sum_{j\\geq 0}\\binom{j}{k}w_j(A) \\iff w_k(A)=\\sum_{j\\geq 0}\\binom{j}{k}(-1)^{j-k}r_j(A)(n-j)!\n\n\\end{aligned}\n$$\n\n\u4e24\u4fa7\u540c\u65f6\u4e58\u4e0a $x^k$ \u5e76\u5bf9 $k$ \u6c42\u548c\uff1a\n$$\n\\sum_{k\\geq 0}w_k(A)x^k=\\sum_{k\\geq 0}\\sum_{j\\geq 0}\\binom{j}{k}(-1)^{j-k}x^kr_j(A)(n-j)!\n$$\n\n$$\n\\sum_{k\\geq 0}w_k(A)x^k=\\sum_{j\\geq 0}r_j(A)(n-j)!\\sum_{k\\geq 0}\\binom{j}{k}(-1)^{j-k}x^k\n$$\n\n$$\n\\sum_{k\\geq 0}w_k(A)x^k=\\sum_{j\\geq 0}r_j(A)(n-j)!(x-1)^j\n$$\n\n$$\nW(x,A)=\\sum_{k\\geq 0}r_k(A)(n-k)!(x-1)^k\n$$\n\n#### Lemma 2 (Rook Factorization Theorem)\n\n\u5982\u679c\u68cb\u76d8 $A$ \u7684\u7279\u6b8a\u4f4d\u7f6e\u5f62\u6210\u4e86\u4e00\u4e2a ferrers board $(h_0,h_1,\\ldots,h_{n-1})$\uff0c\u90a3\u4e48\u6709\uff1a\n\n$$\n\\sum_{k\\geq 0}r_k(A)x^{\\underline{n-k}}=\\prod_{i=0}^{n-1}(h_i-i+x)\n$$\n\n#### Proof\n\n\u4e0d\u59a8\u4ee4 $x$ \u4e3a\u975e\u8d1f\u6574\u6570\uff0c\u5176\u5b83\u7684\u60c5\u51b5\u53ef\u4ee5\u7528\u591a\u9879\u5f0f\u5f52\u7eb3\u6cd5\u8bc1\u660e\u3002\u8003\u8651\u53e6\u4e00\u4e2a ferrers board $(h_0+x,h_1+x,\\ldots,h_{n-1}+x)$\uff0c\u5728\u8fd9\u4e2a ferrers board \u4e0a\u653e\u7f6e $n$ \u4e2a\u4e92\u4e0d\u653b\u51fb\u7684\u8f66\u7684\u65b9\u6848\u6570\u600e\u4e48\u7b97\u3002\u4e00\u79cd\u662f\u76f4\u63a5\u7b97\uff0c\u5f97\u5230 $\\prod_{i=0}^{n-1}(h_i-i+x)$\uff1b\u53e6\u4e00\u79cd\u662f\u5206\u4e3a\u4e24\u4e2a ferrers board $(h_0,h_1,\\ldots,h_{n-1})$ \u548c $(x,x,\\ldots,x)$ \u8003\u8651\uff0c\u679a\u4e3e $k$ \u8868\u793a\u7b2c\u4e00\u4e2a ferrers \u4e2d\u653e\u7f6e\u4e86 $k$ \u4e2a\u8f66\uff0c\u6b64\u65f6\u7684\u65b9\u6848\u6570\u662f $r_k(A)x^{\\underline{n-k}}$\uff0c\u603b\u7684\u65b9\u6848\u6570\u5c31\u662f $\\sum_{k\\geq 0}r_k(A)x^{\\underline{n-k}}$\n\n\n\n------------\n\u7136\u540e\u6765\u5206\u6790\u8fd9\u9898\u3002\u89c2\u5bdf\u5230\u663e\u7136\u6bcf\u4e2a\u4f4d\u7f6e\u7684\u671f\u671b\u90fd\u662f\u76f8\u540c\u7684\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u8ba1\u7b97\u4e00\u4e2a\u4f4d\u7f6e\u7684\u671f\u671b\u6700\u540e\u518d\u4e58\u4e0a $n$\u3002\u8003\u8651\u8ba1\u7b97\u4f4d\u7f6e $n-1$ \u7684\u671f\u671b\uff0c\u5f53\u4f4d\u7f6e $n$ \u88ab\u7ffb\u8f6c\u5076\u6570\u6b21\u65f6\u6709 $1$ \u7684\u8d21\u732e\uff0c\u5947\u6570\u6b21\u8d21\u732e\u4e3a $0$\uff0c\u56e0\u6b64\u8003\u8651\u8ba1\u7b97\u88ab\u7ffb\u8f6c\u5076\u6570\u6b21\u7684\u6982\u7387\u3002\n\n\u6211\u4eec\u5c06 $a$ \u964d\u5e8f\u6392\u5e8f\uff0c\u82e5\u8981\u8ba9\u64cd\u4f5c $i$ \u80fd\u4f7f $n-1$ \u7ffb\u8f6c\uff0c\u5219\u9700\u8981\u9009\u53d6 $a$ \u7684\u4e00\u6bb5\u524d\u7f00 $h_i$\uff0c\u5e76\u4e14\u53ef\u4ee5\u53d1\u73b0 $i$ \u589e\u5927\u65f6 $h_i$ \u4e0d\u964d\uff0c\u5c06 $(h_0,h_1,\\ldots,h_n)$ \u753b\u51fa\u6765\u5c31\u662f\u4e00\u4e2a ferrers board\uff0c\u6211\u4eec\u60f3\u8981\u6c42\u653e\u7f6e $n$ \u4e2a\u4e92\u4e0d\u653b\u51fb\u7684\u8f66\uff0c\u5176\u4e2d\u5076\u6570\u4e2a\u5728 $(h_0,h_1,\\ldots,h_n)$ \u4e0a\u7684\u65b9\u6848\u6570\u3002\n\n\u6211\u4eec\u77e5\u9053\u5947\u6570\u548c\u5076\u6570\u4e4b\u548c\u662f $n!$\uff0c\u5982\u679c\u6211\u4eec\u77e5\u9053\u5076\u6570\u548c\u5947\u6570\u4e4b\u5dee\u5c31\u80fd\u6c42\u5f97\u5076\u6570\u7684\u65b9\u6848\u6570\u3002\u800c\u5076\u6570\u548c\u5947\u6570\u4e4b\u5dee $\\sum_{k\\geq 0}w_k(A)(-1)^k$ \u5c31\u662f $W(-1,A)$\uff0c\u6839\u636e Lemma 1 \u53ef\u5f97 $W(-1,A)=\\sum_{k\\geq 0}r_k(A)(n-k)!(-2)^k$\uff0c\u90a3\u4e48\u5c31\u8f6c\u5316\u4e3a\u6c42 $R(x,A)$ \u7684\u5404\u9879\u7cfb\u6570\u3002\n\n\u6839\u636e Lemma 2\uff0c\u666e\u901a\u591a\u9879\u5f0f $F(x)=\\prod_{i=0}^{n-1}(h_i-i+x)$ \u5bf9\u5e94\u7684\u4e0b\u964d\u5e42\u591a\u9879\u5f0f $G(x)=\\sum_{k\\geq 0}g_n x^{\\underline{n}}$ \u7684\u7cfb\u6570\u7ffb\u8f6c\u540e\u5c31\u662f $R(x,A)$ \u7684\u5404\u9879\u7cfb\u6570\u3002\n\n$F$ \u53ef\u4ee5\u7528\u5206\u6cbb NTT \u5728 $O(n\\log^2n)$ \u7684\u590d\u6742\u5ea6\u5185\u6c42\u51fa\uff0c\u7531 $F$ \u8ba1\u7b97 $G$ \u5c31\u662f\u666e\u901a\u591a\u9879\u5f0f\u8f6c\u4e0b\u964d\u5e42\u591a\u9879\u5f0f\uff0c\u4e5f\u53ef\u4ee5\u5728 $O(n\\log^2n)$ \u7684\u590d\u6742\u5ea6\u5185\u6c42\u51fa\uff0c\u603b\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u5c31\u4e3a $O(n\\log^2n)$\u3002\n\n### Code\n```cpp\nnamespace polynomial{\n    typedef vector<int> poly;\n    const int G=3,invG=ksm(G,djq-2),inv2=ksm(2,djq-2),I=86583718,invI=ksm(I,djq-2);\n    int rev[1200005];\n    inline int BSGS(int a,int b){\n        map<int,int> mp; b%=djq;\n        int t=ceil(sqrt((double)djq)),epow=1;\n        for(rg int j=0;j<t;++j,epow=1ll*epow*a%djq) mp[1ll*b*epow%djq]=j;\n        a=epow,epow=1;\n        for(rg int i=0;i<=t;++i,epow=1ll*epow*a%djq) if(mp.find(epow)!=mp.end()&&1ll*i*t-mp[epow]>=0) return 1ll*i*t-mp[epow];\n        return b;\n    }\n    inline int modsqrt(int x){ return (!x||x==1)?x:ksm(3,BSGS(3,x)>>1); }\n    inline int initrev(const int n){\n        int len=1,lgn=0;\n        while(len<=n) len<<=1,++lgn;\n        for(rg int i=0;i<len;++i) rev[i]=(rev[i>>1]>>1)|((i&1)<<(lgn-1));\n        return len;\n    }\n    inline void NTT(poly &A,const int len,const int opt){\n        A.resize(len);\n        for(rg int i=0;i<len;++i) if(i<rev[i]) swap(A[i],A[rev[i]]);\n        for(rg int i=1;i<len;i<<=1){\n            const int g=ksm(opt?G:invG,(djq-1)/(i<<1));\n            for(rg int j=0,mid=(i<<1);j<len;j+=mid){\n            \tint gn=1;\n                for(rg int k=0;k<i;++k,gn=1ll*gn*g%djq){\n                    const int x=A[j+k],y=1ll*gn*A[i+j+k]%djq;\n                    A[j+k]=(x+y)%djq,A[i+j+k]=(x-y+djq)%djq;\n                }\n            }\n        }\n        const int invlen=ksm(len,djq-2);\n        if(!opt) for(rg int i=0;i<len;++i) A[i]=1ll*A[i]*invlen%djq;\n    }\n    poly mul(poly A,poly B){\n        const int n=A.size()+B.size()-1,len=initrev(n);\n        poly C; C.resize(len);\n        NTT(A,len,1),NTT(B,len,1);\n        for(rg int i=0;i<len;++i) C[i]=1ll*A[i]*B[i]%djq;\n        NTT(C,len,0),C.resize(n);\n        return C;\n    }\n    poly inv(poly F,int n){\n        if(n==1) return poly(1,ksm(F[0],djq-2));\n        poly A(F.begin(),F.begin()+n);\n        poly B=inv(F,n+1>>1);\n        int len=initrev(n<<1);\n        NTT(A,len,1),NTT(B,len,1);\n        for(rg int i=0;i<len;++i) A[i]=1ll*B[i]*(2-1ll*A[i]*B[i]%djq+djq)%djq;\n        return NTT(A,len,0),A.resize(n),A;\n    }\n    poly mod(poly F,poly G){\n    \tpoly RF=F,RG=G,H; const int n=F.size(),m=G.size();\n\t\treverse(RF.begin(),RF.end()),reverse(RG.begin(),RG.end());\n\t\tRF.resize(n-m+1),RG.resize(n-m+1);\n\t\tH=mul(RF,inv(RG,n-m+1)),H.resize(n-m+1),reverse(H.begin(),H.end());\n\t\tH=mul(H,G),H.resize(m-1);\n\t\tfor(rg int i=0;i<m-1;++i) H[i]=(F[i]-H[i]+djq)%djq;\n\t\treturn H;\n    }\n    poly dif(poly A){\n        const int n=A.size();\n        for(rg int i=1;i<n;++i) A[i-1]=1ll*A[i]*i%djq;\n        return A.resize(n-1),A;\n    }\n    poly idif(poly A){\n        const int n=A.size(); A.resize(n+1);\n        for(int i=n;i;--i) A[i]=1ll*A[i-1]*ksm(i,djq-2)%djq;\n        return A[0]=0,A;\n    }\n    poly ln(poly A,int n){\n        poly B=idif(mul(dif(A),inv(A,n)));\n        return B.resize(n),B;\n    }\n    poly exp(poly F,int n) {\n        if(n==1) return poly(1,1);\n        poly A=exp(F,n+1>>1); A.resize(n);\n        poly B=ln(A,n);\n        for(rg int i=0;i<n;++i) B[i]=(F[i]-B[i]+djq)%djq;\n        const int len=initrev(n<<1);\n        NTT(A,len,1),NTT(B,len,1);\n        for(rg int i=0;i<len;++i) A[i]=1ll*A[i]*(1+B[i])%djq;\n        return NTT(A,len,0),A.resize(n),A;\n    }\n    poly sqrt(poly F, int n) {\n        if(n==1) return poly(1,modsqrt(F[0]));\n        poly A(F.begin(),F.begin()+n);\n        poly B=sqrt(F,n+1>>1),C=inv(B,n);\n        const int len=initrev(n<<1);\n        NTT(A,len,1),NTT(C,len,1);\n        for(rg int i=0;i<len;++i) A[i]=1ll*A[i]*C[i]%djq;\n        NTT(A,len,0);\n        for(rg int i=0;i<n;++i) A[i]=1ll*(A[i]+B[i])*inv2%djq;\n        return A.resize(n),A;\n    }\n    poly qpow(poly A,const int k,const int n){\n        A.resize(n); A=ln(A,n); \n        for(rg int i=0;i<n;++i) A[i]=1ll*A[i]*k%djq;\n        return exp(A,n);\n    }\n    poly cos(poly A){\n    \tpoly B,C; const int n=A.size(); B.resize(n),C.resize(n);\n    \tfor(rg int i=0;i<n;++i) B[i]=1ll*A[i]*I%djq,C[i]=djq-1ll*A[i]*I%djq;\n    \tB=exp(B,n),C=exp(C,n);\n    \tfor(rg int i=0;i<n;++i) B[i]=1ll*(B[i]+C[i])*inv2%djq;\n    \treturn B;\n    }\n    poly sin(poly A){\n    \tpoly B,C; const int n=A.size(); B.resize(n),C.resize(n);\n    \tfor(rg int i=0;i<n;++i) B[i]=1ll*A[i]*I%djq,C[i]=djq-1ll*A[i]*I%djq;\n    \tB=exp(B,n),C=exp(C,n);\n    \tfor(rg int i=0;i<n;++i) B[i]=1ll*(B[i]-C[i]+djq)*inv2%djq*invI%djq;\n    \treturn B;\n    }\n}\nusing namespace polynomial;\npoly spmul(poly A,poly B){\n\tconst int n=A.size(),m=B.size();\n\tif(n<m) return poly();\n\treverse(B.begin(),B.end()),B=mul(A,B);\n\tfor(rg int i=0;i<n-m+1;++i) B[i]=B[i+m-1];\n\treturn B.resize(n-m+1),B;\n}\nint ey[200005];\npoly p[200005<<2];\nvoid evabuild(int x,int l,int r){\n\tif(l==r) return p[x].resize(2),p[x][0]=1,p[x][1]=djq-l,void();\n\tconst int mid=l+r>>1;\n\tevabuild(x<<1,l,mid),evabuild(x<<1|1,mid+1,r),p[x]=mul(p[x<<1],p[x<<1|1]);\n}\nvoid evadown(int x,int l,int r,poly A){\n\tif(l==r) return ey[l]=A[0],void();\n\tconst int mid=l+r>>1;\n\tevadown(x<<1,l,mid,spmul(A,p[x<<1|1])),evadown(x<<1|1,mid+1,r,spmul(A,p[x<<1]));\n}\npoly f,g;\nint n,a[200005],h[200005],ifac[200005],fac[200005];\npoly get(int l,int r){\n\tif(l==r) return (poly){inc(h[l],l),1};\n\tconst int mid=l+r>>1;\n\treturn mul(get(l,mid),get(mid+1,r));\n}\nsigned main(){\n\t//file();\n\tn=read();\n\trep(i,n) a[i]=read();\n\tsort(a+1,a+1+n);\n\tfor(rg int i=0,j=n;i<n;++i){\n\t\twhile(j&&i+a[j]>=n-1) --j;\n\t\th[i]=n-j; \n\t}\n\tf=get(0,n-1); ++n; g.resize(n); fac[0]=ifac[0]=1;\n\tfor(rg int i=1;i<n;++i) fac[i]=1ll*fac[i-1]*i%djq;\n\tifac[n-1]=ksm(fac[n-1],djq-2);\n\tfor(rg int i=n-1;i;--i) ifac[i-1]=1ll*ifac[i]*i%djq;\n\tfor(rg int i=0;i<n;++i) g[i]=((i&1)?djq-ifac[i]:ifac[i]);\n\tf.resize(n*2),evabuild(1,0,n-1),evadown(1,0,n-1,spmul(f,inv(p[1],p[1].size())));\n\tfor(rg int i=0;i<n;++i) f[i]=1ll*ey[i]*ifac[i]%djq;\n\tf.resize(n); f=mul(f,g); f.resize(n); reverse(all(f));\n\tint ans(0);\n\tfor(rg int i=0;i<n;++i) pls(ans,1ll*f[i]*fac[n-1-i]%djq*ksm(djq-2,i)%djq);\n\tpls(ans,fac[n-1]); ans=1ll*ans*ksm(2,djq-2)%djq; ans=1ll*ans*(n-1)%djq*ifac[n-1]%djq;\n\tprintf(\"%d\\n\",ans);\n\treturn 0;\n}\n```",
        "postTime": 1667569257,
        "uid": 241977,
        "name": "Legitimity",
        "ccfLevel": 8,
        "title": "ABC272H"
    }
]