[
    {
        "content": "\u672c\u9898\u540c\u6b65\u6536\u5f55\u5728 [Atcoder \u9898\u76ee\u8865\u5168\u8ba1\u5212](https://www.luogu.com.cn/training/256520) \u4e2d\uff0c\u6b22\u8fce\u652f\u6301\u3002\n\n\u8fd9\u4e2a\u9898\u7ed9\u6211\u4eec\u5199\u7389\u7389\u4e86\uff0cATcoder \u7684\u9898\u5bf9\u53d6\u6a21\u662f\u5426\u6709\u4ec0\u4e48\u7279\u522b\u7684\u8ffd\u6c42\uff0c\u6700\u540e\u624b\u5199\u4e86\u4e00\u4e2a `modint` \u7c7b\u624d\u901a\u8fc7\u3002\n\n### \u9898\u76ee\u5206\u6790\uff1a\n\n\u6392\u5217\u65b9\u6848\uff0c\u5254\u9664\u4e00\u90e8\u5206\uff0c\u5927\u6982\u53ef\u4ee5\u60f3\u5230\u5bb9\u65a5\u5427\u3002\n\n\u6211\u4eec\u8bbe\u533a\u95f4 $[L,R)$ \u4e2d $i$ \u51fa\u73b0\u7684\u6b21\u6570\u4e3a $cnt_i$\uff0c\u5219\u6709\n\n$$\\sum_{S \\in [N]} (-1)^{\\lvert S \\rvert}(N - \\lvert S \\rvert)!\\prod \\limits_{i \\in S} cnt_i$$\n\n$S$ \u4e3a\u4e0d\u5408\u6cd5\u6574\u6570\u96c6\u5408\uff0c$[N]= \\{0,1,\\cdots,n-1 \\}$\u3002\n\n\u524d\u9762\u4e24\u4e2a\u4e1c\u897f\u90fd\u633a\u597d\u641e\u7684\uff0c$\\prod \\limits_{i \\in S} cnt_i$ \u6709\u70b9\u96be\uff0c\u5b83\u5c5e\u4e8e\u4e00\u5806\u6570\u7684\u7ec4\u5408\u3002\n\n\u7ec4\u5408\uff1f\u90a3\u518d\u751f\u6210\u51fd\u6570\u4e00\u4e0b\u5427\uff0c\u5b83\u7684\u751f\u6210\u51fd\u6570\u8868\u793a\u51fa\u6765\u5c31\u662f\n\n$$f(x)=(1+cnt_0x)(1+cnt_1x) \\cdots(1+cnt_{n-1}x) = \\prod \\limits_{i=0}^{n-1}(1+cnt_i)$$\n\n\u8bbe $\\prod \\limits_{i \\in S} cnt_i$ \u4e2d\u96c6\u5408 $S$ \u7684\u5143\u7d20\u4e2a\u6570\u4e3a $k$\uff0c\u5219 $\\prod \\limits_{i \\in S} cnt_i$ \u5c31\u662f $f(x)$ \u7684 $k$ \u6b21\u9879\u7cfb\u6570\u3002\n\n\u5df2\u7ecf\u5f88\u52aa\u529b\u4e86\uff0c\u4f46\u8fd9\u6837\u5355\u6b21\u786c\u7b97\u662f $n^2$\uff0c\u5982\u679c\u4f60 $O(n^3)$ \u78be\u8fc7\u53bb\u4e86\u90a3\u6211\u4e0d\u597d\u8bf4\u3002\n\n\u8fdb\u4e00\u6b65\u7684\uff0c\u5982\u679c\u53ea\u662f $cnt_i$ \u52a0 $1$ \u7684\u8bdd\uff0c\u5c31\u76f8\u5f53\u4e8e\u4e58\u4e0a $\\frac{1+(cnt_i+1)x}{1+cnt_ix}$\uff1b\u53cd\u4e4b\uff0c\u51cf $1$ \u5c31\u662f\u4e58\u4e0a $\\frac{1+(cnt_i-1)x}{1+cnt_ix}$\u3002\u8fd9\u6837\u64cd\u4f5c\u662f $O(n)$ \u7684\u3002\n\n\u4ec0\u4e48\u4e1c\u897f\uff0c\u67d0\u4e2a\u5c42\u9762\u4e0a\u53ef\u4ee5\u5feb\u901f\u7ef4\u62a4\u52a0\u4e00\u51cf\u4e00\uff1f\u83ab\u961f\u3002\n\n\u6240\u4ee5\u6211\u4eec\u6bcf\u6b21\u6307\u9488\u79fb\u52a8\u6539\u53d8 $cnt_i$ \u7684\u65f6\u5019\u5c31\u987a\u4fbf $O(n)$ \u7684\u7ef4\u62a4\u4e00\u4e0b\u591a\u9879\u5f0f $f(x)$ \u5c31\u53ef\u4ee5\u4e86\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a$O(n^2 \\sqrt n)$\u3002\n\n### Code.\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nint read()\n{\n\tint x=0;char c=getchar(); bool f=0;\n\tfor(;c<'0'||c>'9';c=getchar()) f|=(c=='-');\n\tfor(;c>='0' && c<='9';c=getchar()) x=(x<<1)+(x<<3)+(c^48);\n\treturn x=f ? -x : x;\n}\nconst int N=2010,p=998244353;\nstruct modint\n{\n\tint x;\n\tmodint(int o=0) {x=o;}\n\tmodint &operator = (int o){return x=o,*this;}\n\tmodint &operator +=(modint o){return x=x+o.x>=p?x+o.x-p:x+o.x,*this;}\n\tmodint &operator -=(modint o){return x=x-o.x<0?x-o.x+p:x-o.x,*this;}\n\tmodint &operator *=(modint o){return x=1ll*x*o.x%p,*this;}\n\tfriend modint operator +(modint a,modint b) {return a+=b;}\n\tfriend modint operator -(modint a,modint b) {return a-=b;}\n\tfriend modint operator *(modint a,modint b) {return a*=b;}\n\tmodint operator - () {return x?p-x:0;}\n} ans[N],fin[N];\nint a[N],n,m,len,cnt[N]; vector<modint> f;\nint get(int x) {return x/len;}\nstruct node\n{\n\tint l,r,id;\n\tbool operator < (const node &o) const {\n\t\tif(get(l) == get(o.l)) return get(l)&1 ? r < o.r : r > o.r;\n\t\treturn get(l) < get(o.l);\n\t}\n} q[N];\nvoid mul(int x)\n{\n\tif(! x) return ; f.emplace_back(0);\n\tfor(int i=(int)f.size()-1;i;i--) f[i]+=f[i-1]*x;\n}\nvoid div(int x)\n{\n\tif(! x) return ;\n\tfor(int i=1;i<(int)f.size();i++) f[i]-=f[i-1]*x;\n\tf.pop_back();\n}\nvoid del(int x) {div(cnt[a[x]]); cnt[a[x]]--; mul(cnt[a[x]]);}\nvoid add(int x) {div(cnt[a[x]]); cnt[a[x]]++; mul(cnt[a[x]]);}\nint main()\n{\n\tfin[0]=1; for(int i=1;i<=2000;i++) fin[i]=fin[i-1]*i; f.emplace_back(1);\n\tn=read(); m=read(); len=(int)sqrt(n)+1; for(int i=1;i<=n;i++) a[i]=read();\n\tfor(int i=1;i<=m;i++) q[i].l=read()+1,q[i].r=read(),q[i].id=i;\n\tstable_sort(q+1,q+1+m); int l=1,r=0;\n\tfor(int i=1;i<=m;i++)\n\t{\n\t\tint l1=q[i].l,r1=q[i].r,id=q[i].id;\n\t\twhile(l > l1) add(--l);\n\t\twhile(r < r1) add(++r);\n\t\twhile(l < l1) del(l++);\n\t\twhile(r > r1) del(r--);\n\t\tfor(int k=0;k<(int)f.size();k++) {k&1 ? ans[id]-=(f[k]*fin[n-k]) : ans[id]+=(f[k]*fin[n-k]);}\n\t}\n\tfor(int i=1;i<=m;i++) printf(\"%d\\n\",ans[i].x);\n\treturn 0;\n}\n```",
        "postTime": 1670405398,
        "uid": 897035,
        "name": "Shiina_Mahiru",
        "ccfLevel": 0,
        "title": "[JSC2019ed F] Count Permutations Many Times \u9898\u89e3"
    }
]