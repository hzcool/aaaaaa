[
    {
        "content": "## \u9898\u610f\n\u7ed9\u5b9a $N$ \u4e2a\u70b9\u548c\u4e00\u6761\u7ebf\u6bb5 $(D_1,E_1),(D_2,E_2)$\uff0c\u6bcf\u4e2a\u70b9\u6709\u4e00\u4e2a $C_i$\uff0c$Q$ \u6b21\u8be2\u95ee\uff0c\u6c42\u4ece $C_i=A$ \u7684\u70b9\u5230 $C_j=B$ \u7684\u70b9\u7684\u6240\u6709\u5c04\u7ebf\u4e0e\u7ebf\u6bb5\u6709\u4ea4\u7684\u4e2a\u6570\u662f\u591a\u5c11\u3002\u4fdd\u8bc1\u4e0d\u4f1a\u8be2\u95ee\u91cd\u590d\u7684\u3002\n\n\u5750\u6807\u4e92\u4e0d\u76f8\u540c\uff0c\u4e0d\u5b58\u5728\u4e09\u70b9\u5171\u7ebf\u3002\n\n\u503c\u57df $[-10^9,10^9]$\uff0c$N\\le 3\\times 10^4$\uff0c$Q\\le 5\\times 10^4$\n## \u9898\u89e3\n\u8bb0 $P_A$ \u8868\u793a $C_i=A$ \u7684\u70b9\u7684\u96c6\u5408\u3002\n\n\u9996\u5148\u5982\u679c\u6211\u4eec\u80fd\u591f\u5728 $\\mathcal O(C)$ \u7684\u590d\u6742\u5ea6\u5185\u8ba1\u7b97\u4ee5\u8fd9\u4e2a\u70b9\u4e3a\u8d77\u70b9\uff0c\u7ec8\u70b9\u5728\u53e6\u4e00\u4e2a\u96c6\u5408\u4e2d\u7684\u5c04\u7ebf\u4e0e\u7ebf\u6bb5\u6709\u4ea4\u7684\u4e2a\u6570 \u6216 \u4ee5\u8fd9\u4e2a\u70b9\u4e3a\u7ec8\u70b9\uff0c\u8d77\u70b9\u5728\u53e6\u4e00\u4e2a\u96c6\u5408\u5185\u7684\u5c04\u7ebf\u4e0e\u7ebf\u6bb5\u6709\u4ea4\u7684\u4e2a\u6570\uff0c\u5c31\u80fd\u5728 $\\mathcal O(\\min(|P_A|,|P_B|)C)$ \u7684\u65f6\u95f4\u89e3\u51b3\u4e00\u6b21\u8be2\u95ee\u4e86\u3002\n\n\u7136\u540e\u8fd9\u4e2a\u4e1c\u897f\u7684\u590d\u6742\u5ea6\u662f\u6b63\u786e\u7684\uff0c\u56e0\u4e3a\u8003\u8651\u5982\u679c $\\min(|P_A|,|P_B|)\\le \\sqrt N$ \u90a3\u4e48\u4e00\u6b21\u7684\u590d\u6742\u5ea6\u5c31\u662f $\\mathcal O(\\sqrt N)$\uff0c\u5426\u5219\u4e24\u8005\u90fd $\\ge \\sqrt N$\uff0c\u5219\u6bcf\u4e2a $|P_A|$ \u6700\u591a\u88ab\u8ba1\u7b97 $\\sqrt N$ \u6b21\uff0c\u6240\u4ee5\u4e0a\u9762\u8fd9\u4e2a\u4e1c\u897f\u7684\u590d\u6742\u5ea6\u662f\u4e0d\u8d85\u8fc7 $\\mathcal O((N+Q)\\sqrt NC)$ \u7684\u3002\n\n\u4e8e\u662f\u6211\u4eec\u73b0\u5728\u53ea\u9700\u8981\u89e3\u51b3\u4e00\u4e2a\u70b9\u5bf9\u4e00\u4e2a\u96c6\u5408\u7684\u95ee\u9898\u4e86\u3002\u753b\u4e00\u753b\u53d1\u73b0\u662f\u8d77\u70b9\u548c\u7ec8\u70b9\u5408\u6cd5\u7684\u53e6\u4e00\u4e2a\u70b9\u7684\u4f4d\u7f6e\u5982\u4e0b\u56fe\uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/noa074tw.png)\n\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/h7w7lufo.png)\n\n\u5206\u6790\u4e00\u4e0b\u7b2c\u4e00\u79cd\u60c5\u51b5\uff0c\u628a\u4e00\u4e2a\u70b9\u5199\u6210 $(\\theta_1,\\theta_2)$\uff0c\u8868\u793a $(\\angle CAB,\\angle CBA)$\uff0c\u90a3\u4e48 $(\\theta_1,\\theta_2)$ \u4e3a\u8d77\u70b9 $(\\gamma_1,\\gamma_2)$ \u7ec8\u70b9\u53ef\u884c\u5f53\u4e14\u4ec5\u5f53\u4e24\u70b9\u5728\u540c\u4e00\u4fa7\u4e14 $\\gamma_1<\\theta_1\\land\\gamma_2<\\theta_2$ \u6216\u4e24\u70b9\u5f02\u4fa7\u4e14 $\\gamma_1<\\pi-\\theta_1\\land \\gamma_2<\\pi-\\theta_2$\u3002\u8fd9\u662f\u4e00\u4e2a\u4e8c\u7ef4\u6570\u70b9\uff0c\u4e3b\u5e2d\u6811\u5373\u53ef\u505a\u5230 $\\mathcal O(\\log N)$\u3002\n\n\u5bf9\u4e8e\u7b2c\u4e8c\u79cd\u60c5\u51b5\u4e5f\u662f\u7c7b\u4f3c\u7684\u3002\n\n\u590d\u6742\u5ea6 $\\mathcal O((N+Q)\\sqrt N\\log N)$\u3002\n\n\u6ce8\u610f\u4e00\u70b9\u5c31\u662f\u7cbe\u5ea6\u8981\u6c42\u6bd4\u8f83\u9ad8\uff0c\u5982\u679c `atan2(int, int)` \u8fd4\u56de\u503c\u662f `double` \u9700\u8981\u7528 `atan2l` \u6216\u8005 `atan2(long double, long double)` \u7cbe\u5ea6\u624d\u591f\u3002\n\n## \u4ee3\u7801\n```cpp\n#include<bits/stdc++.h>\n#define mp make_pair\n#define mt make_tuple\n#define eb emplace_back\n#define pb push_back\n#define pc putchar\n#define chkmx(a,b) (a)=max((a),(b))\n#define chkmn(a,b) (a)=min((a),(b))\n#define fi first\n#define se second\nusing namespace std;\ntemplate<class T>\nvoid read(T&x){x=0;char c=getchar();bool f=0;for(;!isdigit(c);c=getchar())f^=c=='-';for(;isdigit(c);c=getchar())x=x*10+c-'0';if(f)x=-x;}\ntemplate<class T,class ...ARK>void read(T&x,ARK&...ark){read(x);read(ark...);}\ntemplate<class T>void write(T x){if(x<0)pc('-'),x=-x;if(x>=10)write(x/10);pc(x%10+'0');}\ntemplate<class T,class ...ARK>void write(T x,ARK...ark){write(x);pc(' ');write(ark...);}\ntemplate<class ...ARK>void writeln(ARK...ark){write(ark...);pc('\\n');}\ntypedef long long ll;\nconst int mod=998244353;\nstruct mint{\n\tint x;mint(int o=0){x=o;}mint&operator+=(mint a){return(x+=a.x)%=mod,*this;}mint&operator-=(mint a){return(x+=mod-a.x)%=mod,*this;}\n\tmint&operator*=(mint a){return(x=1ll*x*a.x%mod),*this;}mint&operator^=( int b){mint a=*this;x=1;while(b)(b&1)&&(*this*=a,1),a*=a,b>>=1;return*this;}\n\tmint&operator/=(mint a){return*this*=(a^=mod-2);}friend mint operator+(mint a,mint b){return a+=b;}friend mint operator-(mint a,mint b){return a-=b;}\n\tfriend mint operator*(mint a,mint b){return a*=b;}friend mint operator/(mint a,mint b){return a/=b;}friend mint operator^(mint a, int b){return a^=b;}\n};\n#define lowbit(x) ((x)&-(x))\n#define mid ((l+r)>>1)\ntypedef long double db;\nconst int N=3e4+10;\nconst db pi=acosl(-1);\nstruct point{\n\tint x,y;\n\tpoint(int x=0,int y=0):x(x),y(y){}\n\tpoint operator-(point rhs){return point(x-rhs.x,y-rhs.y);}\n\tdb ang(){return atan2l(y,x);}\n};\nint n,m,q;point S,T,P[N];int c[N];\ndb ad(db ang){while(ang>=2*pi)ang-=2*pi;while(ang<0)ang+=2*pi;return ang;}\nint get(vector<db>&v,db x){return lower_bound(v.begin(),v.end(),x)-v.begin();}\nstruct SGT{\n\t//\u53ef\u6301\u4e45\u5316\u7ebf\u6bb5\u6811\n\tstruct node{\n\t\tint sum,lc,rc;\n\t}t[N<<5];\n\tint cnt;\n\tvoid add(int&nw,int od,int l,int r,int p){\n\t\tnw=++cnt;t[nw]=t[od];\n\t\tif(l==r)return t[nw].sum++,void();\n\t\tif(p<=mid)add(t[nw].lc,t[od].lc,l,mid,p);\n\t\telse add(t[nw].rc,t[od].rc,mid+1,r,p);\n\t\tt[nw].sum=t[t[nw].lc].sum+t[t[nw].rc].sum;\n\t}\n\tint qry(int x,int l,int r,int ql,int qr){\n\t\tif(!x||r<ql||qr<l)return 0;\n\t\tif(ql<=l&&r<=qr)return t[x].sum;\n\t\treturn qry(t[x].lc,l,mid,ql,qr)+qry(t[x].rc,mid+1,r,ql,qr);\n\t}\n}SG;\nstruct DS{\n\tvector<pair<db,db>>ds;\n\tvector<db>d0,d1;//\u79bb\u6563\u5316\n\tvector<int>rt;\n\tvoid init(){\n\t\tsort(ds.begin(),ds.end());\n\t\tfor(auto d:ds)d0.pb(d.fi),d1.pb(d.se);\n\t\tsort(d1.begin(),d1.end());\n\t\trt.resize(ds.size()+1);\n\t\tfor(int i=1;i<=(int)ds.size();i++)\n\t\t\tSG.add(rt[i],rt[i-1],0,d1.size()-1,get(d1,ds[i-1].se));\n\t}\n\tint qry(db l1,db r1,db l2,db r2){\n\t\tint L1=upper_bound(d0.begin(),d0.end(),l1)-d0.begin()+1;\n\t\tint R1=lower_bound(d0.begin(),d0.end(),r1)-d0.begin();\n\t\tint L2=upper_bound(d1.begin(),d1.end(),l2)-d1.begin();\n\t\tint R2=lower_bound(d1.begin(),d1.end(),r2)-d1.begin()-1;\n\t\treturn SG.qry(rt[R1],0,d1.size()-1,L2,R2)-SG.qry(rt[L1-1],0,d1.size()-1,L2,R2);\n\t}\n}D[N][2];\nsigned main(){\n\tread(n,m);\n\tfor(int i=1;i<=n;i++)read(P[i].x,P[i].y,c[i]);\n\tread(S.x,S.y,T.x,T.y);\n\tfor(int i=1;i<=n;i++){\n\t\tif(ad((P[i]-T).ang()-(S-T).ang())<pi)\n\t\t\tD[c[i]][0].ds.eb(ad((P[i]-T).ang()-(S-T).ang()),ad((T-S).ang()-(P[i]-S).ang()));\n\t\telse D[c[i]][1].ds.eb(ad((S-T).ang()-(P[i]-T).ang()),ad((P[i]-S).ang()-(T-S).ang()));\n\t}\n\tfor(int i=1;i<=m;i++)D[i][0].init(),D[i][1].init();\n\tread(q);while(q--){\n\t\tint a,b,ans=0;read(a,b);\n\t\tif(D[a][0].ds.size()+D[a][1].ds.size()<D[b][0].ds.size()+D[b][1].ds.size())\n\t\t\tfor(int t=0;t<2;t++)for(auto d:D[a][t].ds)\n\t\t\t\tans+=D[b][t].qry(0,d.fi,0,d.se),\n\t\t\t\tans+=D[b][t^1].qry(0,pi-d.fi,0,pi-d.se);\n\t\telse\n\t\t\tfor(int t=0;t<2;t++)for(auto d:D[b][t].ds)\n\t\t\t\tans+=D[a][t].qry(d.fi,pi,d.se,pi),\n\t\t\t\tans+=D[a][t^1].qry(0,pi-d.fi,0,pi-d.se);\n\t\twriteln(ans);\n\t}\n}\n```",
        "postTime": 1654079986,
        "uid": 174304,
        "name": "jun\u5934\u5409\u5409",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 AT2544 \u3010\u30c9\u30e9\u30b4\u30f3 2 (Dragon 2)\u3011"
    }
]