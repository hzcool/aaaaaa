[
    {
        "content": "\u5148\u770b $m=2$\u3002\u4f17\u6240\u5468\u77e5\u7684\u662f $2\\times n$ \u586b\u9aa8\u724c\u7684\u65b9\u6848\u662f\u6590\u6ce2\u90a3\u5951\u6570\u5217 $f_{n+1}$\uff0c\u5176\u4e2d $f_0=0,f_1=1, f_n=f_{n-1}+f_{n-2}$\uff0c\u800c\u8981\u6c42\u7684\u4e1c\u897f\u5c31\u662f $\\sum_{n=l}^r{f_n\\choose k}$ \uff08\u4e3a\u4e86\u65b9\u4fbf\u6211\u4eec\u5047\u8bbe\u65b9\u6848\u662f $f_n$ \u800c\u4e0d\u662f $f_{n+1}$\uff0c\u53cd\u6b63\u53ea\u9700\u8981\u628a $l,r$ \u90fd\u52a0\u4e0a $1$ \u5c31\u53ef\u4ee5\u4e86\uff09\n\n\u7136\u800c\u6590\u6ce2\u90a3\u5951\u6570\u5217\u7684\u901a\u9879\u516c\u5f0f\u4e3a\n\n$$f_n=\\frac1{\\sqrt5}\\left(\\frac{1+\\sqrt5}{2}\\right)^n-\\frac1{\\sqrt5}\\left(\\frac{1-\\sqrt5}{2}\\right)^n$$\n\n\u8bbe $A=\\frac1{\\sqrt5},B=-\\frac1{\\sqrt5},x=\\frac{1+\\sqrt5}{2},y=\\frac{1-\\sqrt5}{2}$\uff0c\u90a3\u4e48\u6709 $f_n=Ax^n+Bx^n$\n\n\u518d\u52a0\u4e0a\u4e0b\u964d\u5e42\u4e0e\u9636\u4e58\u5e42\u4e4b\u95f4\u7684\u8f6c\u6362\n\n$$x^{\\underline k}=\\sum_{i=0}^k(-1)^{k-i}s(k,i)x^i$$\n\n\uff08\u5176\u4e2d $s(k,i)$ \u4e3a\u7b2c\u4e00\u7c7b\u65af\u7279\u6797\u6570\uff09\n\n\u4e8e\u662f\n\n$$\\begin{aligned}&\\sum_{n=l}^r{f_n\\choose k}\\\\=&\\frac1{k!}\\sum_{n=l}^r\\sum_{i=0}^k(-1)^{k-i}s(k,i)f_n^i\\\\=&\\frac1{k!}\\sum_{n=l}^r\\sum_{i=0}^k(-1)^{k-i}s(k,i)(Ax^n+By^n)^i\\\\=&\\frac1{k!}\\sum_{n=l}^r\\sum_{i=0}^k(-1)^{k-i}s(k,i)\\sum_{j=0}^i{i\\choose j}A^jB^{i-j}(x^jy^{i-j})^n\\\\=&\\frac1{k!}\\sum_{i=0}^k(-1)^{k-i}s(k,i)\\sum_{j=0}^i{i\\choose j}A^jB^{i-j}\\sum_{n=l}^r(x^jy^{i-j})^n\\\\\\end{aligned}$$\n\n\u53ea\u9700\u8981\u679a\u4e3e $i,j$\uff0c\u7136\u540e\u540e\u9762\u90a3\u4e2a $\\sum$ \u5c31\u662f\u4e00\u4e2a\u7b49\u6bd4\u6570\u5217\u3002\n\n\u4e0d\u8fc7\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\u5c31\u662f\uff0c $\\sqrt5$ \u8fd9\u4e2a\u4e1c\u897f\u5728 $\\bmod998244353$ \u610f\u4e49\u4e0b\u4e0d\u5b58\u5728\u3002\n\n\u6211\u4eec\u5bf9\u5269\u4f59\u7cfb\u8fdb\u884c\u6269\u57df\uff0c\u628a\u6bcf\u4e2a\u6570\u8868\u793a\u6210 $a+b\\sqrt5$ \u7684\u5f62\u5f0f\uff0c\u5c31\u53ef\u4ee5\u505a\u4e86\u3002\n\n\u5bf9\u4e8e $m=3$\uff0c\u53ef\u4ee5\u53d1\u73b0 $n$ \u662f\u5947\u6570\u7684\u65f6\u5019\u65b9\u6848\u6570\u662f $0$\uff0c\u800c\u5076\u6570\u7684\u65f6\u5019\uff08\u4ee4 $g_n$ \u8868\u793a $2n$ \u7684\u7b54\u6848\uff09\u53ef\u4ee5\u641e\u51fa\u9012\u63a8\u5f0f $g_n=4g_{n-1}-g_{n-2}$\uff0c\u4ece\u800c\u89e3\u51fa\u901a\u9879\u516c\u5f0f $g_n=\\frac{3+\\sqrt3}6(2+\\sqrt3)^n+\\frac{3-\\sqrt3}6(2-\\sqrt3)^n$\uff0c\u4ecd\u7136\u7528\u4e0a\u8ff0\u65b9\u6cd5\u8ba1\u7b97\u5373\u53ef\u3002\n\n\uff08\u4e0d\u8fc7\u6709\u4e00\u4e2a\u672c\u9898\u4e2d\u6ca1\u4ec0\u4e48\u7528\u5904\u7684\u5c31\u662f\uff0c\u5b9e\u9645\u4e0a\u6a21\u7d20\u6570\u610f\u4e49\u4e0b\u5f53 $\\sqrt{x}$ \u4e0d\u5b58\u5728\u7684\u65f6\u5019 $\\sqrt{-x}$ \u4e00\u5b9a\u662f\u5b58\u5728\u7684\uff0c\u56e0\u6b64\u53ef\u4ee5\u5c06 $a+b\\sqrt x$ \u5199\u6210 $a+b'i$\uff0c\u5176\u4e2d $b'=b\\sqrt{-x}$ \u800c $i^2=1$ \uff08\u6a21\u610f\u4e49\u590d\u6570\uff01\uff09\uff09\n\n\u9644\u4ee3\u7801\uff1a\n\n```cpp\n#include <algorithm>\n#include <cstdio>\n#include <cstring>\n \ntypedef long long LL;\nconst int mod = 998244353;\n \nLL pow_mod(LL a, LL b) {\n  LL ans = 1;\n  for (a %= mod; b; b >>= 1, a = a * a % mod)\n    if (b & 1) ans = ans * a % mod;\n  return ans;\n}\n \ntemplate <int a>\nstruct Sq { // x + y*sqrt(a) (mod 998244353)\ntypedef Sq<a> sq;\n \nLL x, y;\nSq(LL x = 0, LL y = 0) : x(x % mod), y(y % mod) {}\n \ninline sq conj() const { return sq(x, -y); }\n// assume a is small (a * mod * mod < 2^63)\nfriend inline sq operator+(const sq &l, const sq &r) { return sq(l.x + r.x, l.y + r.y); }\nfriend inline sq operator-(const sq &l, const sq &r) { return sq(l.x - r.x, l.y - r.y); }\nfriend inline sq operator*(const sq &l, const sq &r) { return sq(l.x * r.x + a * l.y * r.y, l.x * r.y + l.y * r.x); }\nfriend inline sq operator/(const sq &l, const sq &r) { return sq(l.x * r.x - a * l.y * r.y, l.y * r.x - l.x * r.y) * pow_mod(r.x * r.x - a * r.y * r.y, mod - 2); }\ninline sq& operator+=(const sq &t) { x = (x + t.x) % mod; y = (y + t.y) % mod; return *this; }\ninline sq& operator-=(const sq &t) { x = (x - t.x) % mod; y = (y - t.y) % mod; return *this; }\ninline sq& operator*=(const sq &t) { return *this = *this * t; }\nsq operator^(LL t) const {\n  sq ans = 1, x = *this;\n  for (; t; t >>= 1, x *= x) if (t & 1) ans *= x;\n  return ans;\n}\ninline sq sum_pow(LL t) { return (1 + this->pow(t + 1)) / (1 + *this); } // (x^(t+1)-1) / (x-1)\ninline void put() { printf(\"%lld+%llds%d\", (x + mod) % mod, (y + mod) % mod, a); }\n};\n \nconst int K = 550;\nLL C[K][K], ss[K][K], fac[K];\n \ntemplate <int a>\nSq<a> Solve(Sq<a> A, Sq<a> p, Sq<a> B, Sq<a> q, int k, LL l, LL r) {\n  ++r;\n  Sq<a> ans = 0, qr = q^r, ql = q^l, pr = p^r, pl = p^l;\n  Sq<a> ppl = 1, ppr = 1, pp = 1, pA = 1;\n  for (int u = 0; u <= k; ++u) {\n    Sq<a> pql = 1, pqr = 1, pq = 1, pB = 1;\n    for (int v = 0; u + v <= k; ++v) {\n      Sq<a> quq = pp * pq - 1, qvq = ppr * pqr - ppl * pql;\n      Sq<a> qaq = !quq.x && !quq.y ? (r - l) % mod : qvq / quq;\n      Sq<a> qwq = ss[k][u + v] * C[u + v][u] % mod * pA * pB * qaq;\n      ans += qwq;\n      pB *= B; pql *= ql; pqr *= qr; pq *= q;\n    }\n    pA *= A; ppl *= pl; ppr *= pr; pp *= p;\n  }\n  return ans * pow_mod(fac[k], mod - 2);\n}\n \nvoid Init() {\n  for (int i = 0; i < K; ++i)\n    for (int j = C[i][0] = 1; j <= i; ++j)\n      C[i][j] = (C[i - 1][j] + C[i - 1][j - 1]) % mod;\n  fac[0] = 1;\n  for (int i = 1; i < K; ++i) fac[i] = i * fac[i - 1] % mod;\n  ss[0][0] = 1;\n  for (int i = 0; i + 1 < K; ++i) {\n    ss[i + 1][0] = - i * ss[i][0];\n    for (int j = 1; j <= i + 1; ++j)\n      ss[i + 1][j] = (ss[i][j - 1] - i * ss[i][j]) % mod;\n  }\n}\n \nint main() {\n  Init();\n  int T, m;\n  scanf(\"%d%d\", &T, &m);\n  while (T--) {\n    LL l, r; int k;\n    scanf(\"%lld%lld%d\", &l, &r, &k);\n    if (m == 2) {\n      Sq<5> p = Sq<5>(1, 1) / 2, t = Sq<5>(0, 1) / 5;\n      printf(\"%lld\\n\", (Solve(t, p, t.conj(), p.conj(), k, l + 1, r + 1).x * pow_mod(r - l + 1, mod - 2) % mod + mod) % mod);\n    } else {\n      Sq<3> p = Sq<3>(2, 1), t = Sq<3>(3, 1) / 6;\n      printf(\"%lld\\n\", (Solve(t, p, t.conj(), p.conj(), k, (l + 1) / 2, r / 2).x * pow_mod(r - l + 1, mod - 2) % mod + mod) % mod);\n    }\n  }\n}\n```",
        "postTime": 1555832076,
        "uid": 7868,
        "name": "_rqy",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P5320 \u3010[BJOI2019]\u52d8\u7834\u795e\u673a\u3011"
    },
    {
        "content": "EI \u7684\u9898\u89e3\u5199\u7684\u6709\u4e9b\u7b80\u77ed\uff0c\u6211\u5c31\u505a\u4e00\u70b9\u5fae\u5c0f\u7684\u5de5\u4f5c\uff0c\u8be6\u7ec6\u89e3\u91ca\u4e00\u4e0b\u5427\u3002\n****\n\u5148\u6765\u8bf4\u4e00\u4e0b $m=3$ \u7684\u60c5\u51b5\u3002  \n\u5df2\u77e5\u957f\u5ea6\u4e3a $2n$ \u7684\u65f6\u5019\uff0c\u586b\u5145\u65b9\u6848\u4e3a\uff1a\n$$g_n=\\frac{3+\\sqrt 3}{6}(2+\\sqrt 3)^n+\\frac{3-\\sqrt 3}{6}(2-\\sqrt 3)^n$$\n\u7531\u4e8e\u9012\u63a8\u5f0f\u7279\u5f81\u65b9\u7a0b\u7684\u4e24\u4e2a\u6839\u4e92\u4e3a\u5012\u6570\uff0c\u6240\u4ee5 $g_n$ \u5c31\u53ef\u4ee5\u5199\u6210\u8fd9\u6837\u7684\u5f62\u5f0f\uff1a\n$$g_n=A\\alpha^n+B\\alpha^{-n}$$\n\u5176\u4e2d $\\alpha = 2+\\sqrt 3$\u3002\n\n\u518d\u4ee3\u5165\u90a3\u4e2a\u7ec4\u5408\u6570\u4e2d\n$$\\binom{g_n}{k}$$\n$$=\\frac 1{k!}\\left(A\\alpha^n+B\\alpha^{-n} \\right)^{\\underline k}$$\n$$=\\frac{1}{k!}\\prod_{i=0}^{k-1}(A\\alpha^{n}-i+B\\alpha^{-n})$$\n\u7528 $x$ \u6362\u6389 $\\alpha^n$ \u5c31\u6210\u4e86\n$$\\frac{1}{k!}\\prod_{i=0}^{k-1}(Ax-i+Bx^{-1})$$\n\u8fd9\u6837\u5c31\u53ef\u4ee5\u628a $G(2n,k)$ \u8868\u793a\u4e3a\u5173\u4e8e $\\alpha^n$ \u7684\u4e00\u4e2a $\\Theta(k)$ \u6b21\u591a\u9879\u5f0f\u3002\uff08\u867d\u7136\u6709\u8d1f\u6570\u6b21\u9879\uff0c\u4f46\u8fd9\u91cc\u8fd8\u662f\u53eb\u591a\u9879\u5f0f\uff09\n\n\u8bbe $p_n$ \u4e3a\u8fd9\u4e2a\u591a\u9879\u5f0f\u7684 $n$ \u6b21\u9879\u7cfb\u6570\uff0c\u7b54\u6848\u5c31\u80fd\u8868\u793a\u4e3a\n$$\\sum_{i=l}^r\\sum_{j=-k}^k p_j\\alpha^{ij}$$\n$$=\\sum_{j=-k}^kp_j\\sum_{i=l}^r \\alpha^{ji}$$\n\uff08\u4e3a\u65b9\u4fbf\u8868\u793a\uff0c\u8fd9\u91cc $l,r$ \u5206\u522b\u662f\u539f\u6765\u7684 $(l+1)/2$ \u548c $r/2$\uff09  \n\u76f4\u63a5\u679a\u4e3e $j$\uff0c\u7b49\u6bd4\u6570\u5217\u6c42\u548c\u7b97\u51fa\u540e\u9762\u90a3\u5757\uff0c\u8fd9\u90e8\u5206\u5c31\u662f $\\Theta(k \\log r)$ \u7684\u3002\n\n\u7136\u540e\u5c31\u662f\u6c42\u90a3\u4e2a\u591a\u9879\u5f0f\u7cfb\u6570\u7684\u95ee\u9898\u3002  \n\u5176\u5b9e\u5f88\u7b80\u5355\uff0c\u91cc\u9762\u6bcf\u4e00\u9879\u90fd\u4e58 $x$\uff0c\u5206\u6cbb\u4e58\u89e3\u51b3\uff0c\u6700\u540e\u9664\u4e2a $x^k$ \u5c31\u5b8c\u4e86\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $\\Theta(k \\log^2 k)$\u3002  \n\n\u6216\u8bb8\u590d\u6742\u5ea6\u8fd8\u53ef\u4ee5\u53bb\u6389\u4e00\u4e2a $\\log$\uff0c\u5230\u65f6\u5019\u518d\u8865\uff08\n****\n\u5bf9\u4e8e $m=2$ \u7684\u60c5\u51b5\uff0c\u770b\u8d77\u6765\u5c31\u8981\u9ebb\u70e6\u4e00\u4e9b\uff0c\uff0c\u56e0\u4e3a\u65b9\u6848\u6570\u53ea\u80fd\u8868\u793a\u6210\u8fd9\u6837\u7684\u5f62\u5f0f\uff1a\n$$f_n=A \\alpha^n+B(-\\alpha)^{-n}$$\n\u5c31\u662f\u8fd9\u4e2a\u5c0f\u5c0f\u7684\u7b26\u53f7\uff0c\u5374\u6210\u4e86\u4e00\u5757\u7eca\u811a\u77f3 \u2014\u2014 \u4f46\u4e0d\u7528\u614c\uff0c\u6211\u4eec\u76f4\u63a5\u5206\u7c7b\u8ba8\u8bba $n$ \u7684\u5947\u5076\u6027\u3002\n\n\u7136\u540e\u5c31\u80fd\u5f97\u51fa\u5bf9\u4e8e\u5947\u3001\u5076\u7684 $n$ \u65f6\uff0c\u7ec4\u5408\u6570\u5173\u4e8e $\\alpha^n$ \u7684\u7cfb\u6570\u591a\u9879\u5f0f\uff1a\n$$\\frac{1}{k!}\\prod_{i=0}^{k-1}(Ax-i-Bx^{-1}) \\ \\ (n \\bmod 2 = 1)$$\n$$\\frac{1}{k!}\\prod_{i=0}^{k-1}(Ax-i+Bx^{-1}) \\ \\ (n \\bmod 2 = 0)$$\n\u8bbe $p_n,q_n$ \u5206\u522b\u4e3a\u4e0a\u9762\u4e24\u4e2a\u591a\u9879\u5f0f\u7684\u7cfb\u6570\uff0c\u7b54\u6848\u5c31\u80fd\u8868\u793a\u4e3a\n$$\\sum_{j=-k}^k \\left( p_j\\sum_{i=l}^r[2|(i-1)]\\alpha^{ji}\\right)+\\left( q_j\\sum_{i=l}^r[2|i]\\alpha^{ji}\\right)$$\n$$=\\frac 12\\sum_{j=-k}^k\\left( p_j\\sum_{i=l}^r(1+(-1)^{i-1})\\alpha^{ji}\\right)+\\left(q_j\\sum_{i=l}^r(1+(-1)^i)\\alpha^{ji} \\right)$$\n$$=\\frac 12\\sum_{j=-k}^k \\left(p_j \\sum_{i=l}^{r}\\alpha^{ji}-(-\\alpha^j)^i\\right)+\\left( q_j\\sum_{i=l}^r \\alpha^{ji}+(-\\alpha^j)^i\\right)$$\n$$=\\frac 12\\sum_{j=-k}^k\\left((q_j+p_j)\\sum_{i=l}^r\\alpha^{ji}\\right)+\\left( (q_j-p_j)\\sum_{i=l}^r(-\\alpha^j)^i\\right)$$\n\u7136\u540e\u5c31\u80fd\u50cf $m=3$ \u7684\u60c5\u51b5\u4e00\u6837\u76f4\u63a5\u8ba1\u7b97\u4e86\uff0c\u65f6\u95f4\u590d\u6742\u5ea6\u540c\u6837\u662f $\\Theta(k\\log ^2 k + k \\log r)$\u3002\n\n\u4ee3\u7801\uff1a\n```cpp\n#pragma GCC optimize (2)\n#pragma GCC optimize (\"unroll-loops\")\n#include<cstdio>\n#include<iostream>\n#include<algorithm>\n#include<cstring>\n#include<cmath>\n#define N 4102\n#define ll long long\n#define reg register\n#define p 998244353\nusing namespace std;\n\ninline int add(const int& x,const int& y){ return x+y>=p?x+y-p:x+y; }\ninline int dec(const int& x,const int& y){ return x<y?x-y+p:x-y; }\n\ninline int intpow(int a,int t){\n    int res = 1;\n    while(t){\n        if(t&1) res = (ll)res*a%p;\n        a = (ll)a*a%p;\n        t >>= 1;\n    }\n    return res;\n}\n\nint sq;\n\nstruct complex{\n    int r,i;\n    inline complex(int _r=0,int _i=0):r(_r),i(_i){}\n};\n\ninline complex operator + (const complex& lhs,const complex& rhs){ return complex(add(lhs.r,rhs.r),add(lhs.i,rhs.i)); }\ninline complex operator - (const complex& lhs,const complex& rhs){ return complex(dec(lhs.r,rhs.r),dec(lhs.i,rhs.i)); }\ninline complex operator * (const complex& lhs,const complex& rhs){ return complex(((ll)lhs.r*rhs.r+(ll)lhs.i*rhs.i*sq)%p,((ll)lhs.r*rhs.i+(ll)lhs.i*rhs.r)%p); }\ninline complex operator - (const complex& x){ return complex(dec(0,x.r),dec(0,x.i)); }\ninline complex operator * (const complex& lhs,const int& rhs){ return complex((ll)lhs.r*rhs%p,(ll)lhs.i*rhs%p); } \n\ninline complex power(complex a,ll t){\n    complex res = complex(1,0);\n    while(t){\n        if(t&1) res = res*a;\n        a = a*a;\n        t >>= 1;\n    }\n    return res;\n}\n\ninline complex inv(complex x){\n    int d = ((ll)x.r*x.r-(ll)x.i*x.i*sq%p+p)%p;\n    return complex(x.r,p-x.i)*intpow(d,p-2);\n}\n\ninline complex operator / (const complex& lhs,const complex& rhs){ return lhs*inv(rhs); }\n\nint rt[N],rev[N],fac[N],ifac[N];\nint siz;\n\ninline int getlen(int n){\n    return 1<<(32-__builtin_clz(n));\n}\n\nvoid init(int n){\n    int w,lim = 1;\n    while(lim<=n) lim <<= 1,++siz;\n    for(reg int i=1;i!=lim;++i) rev[i] = (rev[i>>1]>>1)|((i&1)<<(siz-1));\n    w = intpow(3,(p-1)>>siz);\n    fac[0] = fac[1] = ifac[0] = ifac[1] = rt[lim>>1] = 1;\n    for(reg int i=(lim>>1)+1;i!=lim;++i) rt[i] = (ll)rt[i-1]*w%p;\n    for(reg int i=(lim>>1)-1;i;--i) rt[i] = rt[i<<1];\n    for(reg int i=2;i<=n;++i) fac[i] = (ll)fac[i-1]*i%p;\n    ifac[n] = intpow(fac[n],p-2);\n    for(reg int i=n-1;i;--i) ifac[i] = (ll)ifac[i+1]*(i+1)%p;\n}\n\ninline void dft(int *f,int lim){\n    static unsigned long long a[N];\n    reg int x,shift = siz-__builtin_ctz(lim);\n    for(reg int i=0;i!=lim;++i) a[rev[i]>>shift] = f[i];\n    for(reg int mid=1;mid!=lim;mid<<=1)\n    for(reg int j=0;j!=lim;j+=(mid<<1))\n    for(reg int k=0;k!=mid;++k){\n        x = a[j|k|mid]*rt[mid|k]%p;\n        a[j|k|mid] = a[j|k]+p-x;\n        a[j|k] += x;\n    }\n    for(reg int i=0;i!=lim;++i) f[i] = a[i]%p;\n}\n\ninline void idft(int *f,int lim){\n    reverse(f+1,f+lim);\n    dft(f,lim);\n    int x = p-((p-1)>>__builtin_ctz(lim));\n    for(reg int i=0;i!=lim;++i) f[i] = (ll)f[i]*x%p;\n}\n\ninline void multiply(const complex *f,const complex *g,int n,int m,complex *t,int len){\n    if(n+m<=64){\n        for(reg int i=0;i<=len;++i) t[i] = complex(0,0);\n        for(reg int i=0;i<=n;++i)\n        for(reg int j=0;j<=m;++j){\n            if(i+j>len) break;\n            t[i+j] = t[i+j]+f[i]*g[j];\n        }\n        return;\n    }\n    static int a[N],b[N],P[N],q[N],r[N],s[N];\n    int lim = getlen(n+m);\n    for(reg int i=0;i<=n;++i) P[i] = f[i].r,q[i] = f[i].i;\n    for(reg int i=0;i<=m;++i) r[i] = g[i].r,s[i] = g[i].i;\n    memset(P+n+1,0,(lim-n)<<2),memset(q+n+1,0,(lim-n)<<2);\n    memset(r+m+1,0,(lim-m)<<2),memset(s+m+1,0,(lim-m)<<2);\n    dft(P,lim),dft(q,lim),dft(r,lim),dft(s,lim);\n    for(reg int i=0;i!=lim;++i){\n        a[i] = ((ll)P[i]*r[i]+(ll)q[i]*s[i]*sq)%p;\n        b[i] = ((ll)P[i]*s[i]+(ll)q[i]*r[i])%p;\n    }\n    idft(a,lim),idft(b,lim);\n    for(reg int i=0;i<=len;++i) t[i] = complex(a[i],b[i]);\n}\n\nvoid product(int l,int r,complex x,complex y,complex *t){\n    if(l==r){\n        t[0] = x,t[2] = y;\n        t[1] = complex(l==0?0:p-l,0);\n        return;\n    }\n    int mid = (l+r)>>1;\n    int ls = mid-l+1,rs = r-mid;\n    complex f[(ls+2)<<1],g[(rs+2)<<1];\n    product(l,mid,x,y,f);\n    product(mid+1,r,x,y,g);\n    multiply(f,g,ls<<1,rs<<1,t,(ls+rs)<<1);\n}\n\ninline complex sum(ll l,ll r,complex q){\n    if(q.r==1&&q.i==0) return (r-l+1)%p;\n    return (power(q,r+1)-power(q,l))/complex(dec(q.r,1),q.i);\n}\n\nint subtask2(ll l,ll r,int k){\n    sq = 5;\n    int inv2 = 499122177,inv5 = intpow(5,p-2);\n    complex q,alpha = complex(inv2,inv2),ans = complex(0,0);\n    complex A = complex(0,inv5),B = complex(0,p-inv5);\n    static complex f[N],g[N];\n    product(0,k-1,-B,A,f);\n    product(0,k-1,B,A,g);\n    q = power(inv(alpha),k);\n    for(reg int i=0;i<=(k<<1);++i){\n        complex fi = g[i]+f[i],gi = g[i]-f[i];\n        ans = ans+sum(l,r,q)*fi+sum(l,r,-q)*gi;\n        q = q*alpha;\n    }\n    return (ll)ans.r*ifac[k]%p*inv2%p;\n}\n\nint subtask3(ll l,ll r,int k){\n    int inv6 = intpow(6,p-2);\n    l = (l+1)>>1,r >>= 1;\n    sq = 3;\n    complex q,alpha = complex(2,1),ans = complex(0,0);\n    complex A = complex(3,1)*inv6,B = complex(3,p-1)*inv6;\n    static complex f[N];\n    product(0,k-1,B,A,f);\n    q = power(inv(alpha),k);\n    for(reg int i=0;i<=(k<<1);++i){\n        ans = ans+sum(l,r,q)*f[i];\n        q = q*alpha;\n    }\n    return (ll)ans.r*ifac[k]%p;\n}\n\nint main(){\n    int T,m,k,ans;\n    ll l,r;\n    scanf(\"%d%d\",&T,&m);\n    init(1025);\n    while(T--){\n        scanf(\"%lld%lld%d\",&l,&r,&k);\n        if(m==3) ans = subtask3(l,r,k);\n        else ans = subtask2(l+1,r+1,k);\n        ans = (ll)ans*intpow((r-l+1)%p,p-2)%p;\n        printf(\"%d\\n\",ans);\n    }\n    return 0;   \n}\n```",
        "postTime": 1586451941,
        "uid": 115864,
        "name": "NaCly_Fish",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 P5320 \u3010[BJOI2019]\u52d8\u7834\u795e\u673a\u3011"
    },
    {
        "content": "\u6269\u57df\u4ee5\u53ca\u600e\u4e48\u7528\u7279\u5f81\u6839\u4f18\u5316\u5230 $\\Theta(k^2\\log r)$ \u7684\u90e8\u5206\u76f8\u4fe1 rqy \u5df2\u7ecf\u8bb2\u5f97\u5f88\u6e05\u695a\u4e86\uff0c\u518d\u6b64\u4e0d\u4e88\u8d58\u8ff0\uff0c\u4f46\u662f\u8fd9\u9053\u9898\u53ef\u4ee5\u8fdb\u4e00\u6b65\u4f18\u5316\u3002\n\n\u4e8b\u60c5\u7684\u7ecf\u8fc7\u5176\u5b9e\u662f\u8fd9\u6837\u7684\u2026\u2026\u5076\u7136\u770b\u5230\u4e86 cz_xuyixuan \u7528 BM \u76f4\u63a5\u7ed9[\u83bd\u8fc7\u53bb](https://loj.ac/submission/783025)\u4e86\uff0c\u611f\u5230\u6709\u70b9\u8be7\u5f02\uff0c\u4e8e\u662f\u5c31\u51b7\u9759\u4e86\u4e00\u4e0b\uff0c\u53d1\u73b0\u8fd9\u9053\u9898\u7684\u7279\u5f81\u6839\u6709\u5f88\u5f3a\u7684\u6027\u8d28\uff1a\n\n- \u5bf9\u4e8e $T=2$ \u7684\u90e8\u5206\uff0c\u56e0\u4e3a\u9012\u63a8\u5f0f\u662f $x^2-x-1$\uff0c\u6240\u4ee5\u4e24\u4e2a\u7279\u5f81\u6839\u7684\u4e58\u79ef\u662f $-1$\u3002\n- \u5bf9\u4e8e $T=3$ \u7684\u90e8\u5206\uff0c\u56e0\u4e3a\u9012\u63a8\u5f0f\u662f $x^2-4x+1$\uff0c\u6240\u4ee5\u4e24\u4e2a\u7279\u5f81\u6839\u7684\u4e58\u79ef\u662f $1$\u3002\n\n\u6240\u4ee5\uff0c\u6211\u4eec\u539f\u4ee5\u4e3a $\\alpha^i \\beta^j$ \u603b\u5171\u6709 $\\Theta(k^2)$ \u79cd\uff0c\u4f46\u662f\u5728\u6b64\u9898\u4e2d\u53ea\u6709 $\\Theta(k)$ \u79cd\u2026\u2026\n\n\u90a3\u4e48\u5982\u4f55\u505a\u5230\u66f4\u5feb\u5c31\u547c\u4e4b\u6b32\u51fa\u4e86\uff0c\u6211\u4eec\u53ea\u9700\u8981\u7b97\u51fa\u6bcf\u4e2a $\\alpha^i\\beta^j$ \u7684\u7cfb\u6570\u5c31\u884c\u4e86\u3002\n\n- \u5bf9\u4e8e $T=3$ \u7684\u60c5\u51b5\uff0c\u56e0\u4e3a $\\alpha\\beta = 1$\uff0c\u6211\u4eec\u6b32\u6c42 $\\displaystyle\\sum_n \\binom{\\lambda \\alpha^n + \\mu \\alpha^{-n}} k$ \u8868\u4e3a $\\displaystyle\\sum_{-k\\le j\\le k} \\nu _j \\alpha^{jn}$ \u7684\u7cfb\u6570 $\\nu_j$\uff0c\u53ea\u9700\u8ba1\u7b97 $\\displaystyle\\frac1{k!}\\prod_{i=0}^{k-1} (\\lambda x - i + \\mu x^{-1})$ \u7684\u7cfb\u6570\u8868\u793a\uff0c\u53ef\u4ee5 $O(k \\log^2 k)$\u3002\n\n- \u5bf9\u4e8e $T=2$ \u7684\u60c5\u51b5\uff0c\u56e0\u4e3a $\\alpha \\beta = -1$\uff0c\u6211\u4eec\u6240\u6c42\u53ef\u4ee5\u8868\u4e3a $\\displaystyle \\sum_{-k \\le j\\le k} \\xi_j \\alpha^{jn} + \\zeta _j (-\\alpha)^{jn}$\uff0c\u53ea\u9700\u8ba1\u7b97 $\\displaystyle\\frac1{k!}\\prod_{i=0}^{k-1} (\\lambda x - i + \\mu x^{-1}t) \\bmod (t^2-1)$ \u7684\u7cfb\u6570\u8868\u793a\uff0c\u5176\u4e2d $[t^0]$ \u5bf9\u5e94 $\\xi$ \u6570\u5217\uff0c$[t^1]$ \u5bf9\u5e94 $\\zeta$ \u6570\u5217\uff0c\u53ef\u4ee5 $O(k\\log^2 k)$\u3002\n\n\u7531\u6b64\uff0c\u53ef\u4ee5\u5728 $O(k\\log^2 k + k\\log r)$ \u65f6\u95f4\u5185\u8ba1\u7b97\u51fa\u3002\n\n",
        "postTime": 1586422913,
        "uid": 21423,
        "name": "Elegia",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P5320 \u3010[BJOI2019]\u52d8\u7834\u795e\u673a\u3011"
    },
    {
        "content": "[cnblogs~ qwq](https://www.cnblogs.com/maoyiting/p/16415793.html)\n\n### Description\n\n\u8bbe $F_n$ \u8868\u793a\u7528 $1\\times 2$ \u7684\u9aa8\u724c\u586b\u6ee1 $2\\times n$ \u7684\u77e9\u9635\u7684\u65b9\u6848\u6570\uff0c$G_n$ \u8868\u793a\u7528 $1\\times 2$ \u7684\u9aa8\u724c\u586b\u6ee1 $3\\times n$ \u7684\u77e9\u9635\u7684\u65b9\u6848\u6570\u3002\u7ed9\u51fa $l,r,k$\uff0c\u5206\u522b\u6c42\u51fa\uff1a\n\n$$\\frac{1}{r-l+1}\\sum_{n=l}^r\\binom{F_n}{k}$$\n$$\\frac{1}{r-l+1}\\sum_{n=l}^r\\binom{G_n}{k}$$\n\n\u5bf9 $998244353$ \u53d6\u6a21\u3002$1\\leq T\\leq 5$\uff0c$1\\leq l\\leq r\\leq 10^{18}$\uff0c$k\\leq 501$\u3002\n\n### Solution\n\n#### m=2\n\n\u8003\u8651\u7b2c $i$ \u5217\u662f\u7ad6\u7740\u653e\u8fd8\u662f\u6a2a\u7740\u653e\uff0c$F_i=F_{i-1}+F_{i-2}$\uff0c$F_0=1$\u3002\u53d1\u73b0 $F_i=f_{i+1}$\uff08\u5176\u4e2d $f_i$ \u4e3a\u6590\u6ce2\u90a3\u5951\u6570\u5217\uff0c$f_1=f_2=1$\uff09\u3002\u4e3a\u4e86\u65b9\u4fbf\uff0c\u4e00\u5f00\u59cb\u5c31\u4ee4 $l,r$ \u52a0 $1$\uff0c\u6211\u4eec\u5b9e\u9645\u4e0a\u8981\u6c42 $\\sum_{n=l}^r\\binom{f_n}{k}$\u3002\n\n\u76f4\u63a5\u5e26 $f$ \u4e0d\u592a\u597d\u505a\uff0c\u8003\u8651\u901a\u9879\u516c\u5f0f\uff1a\n$$\nf_n=\\frac{1}{\\sqrt 5}(\\frac{1+\\sqrt 5}{2})^n-\\frac{1}{\\sqrt 5}(\\frac{1-\\sqrt 5}{2})^n\n$$\n\u4e0d\u59a8\u8bbe $A=\\frac{1}{\\sqrt 5}$\uff0c$B=-\\frac{1}{\\sqrt 5}$\uff0c$x=\\frac{1+\\sqrt 5}{2}$\uff0c$y=\\frac{1-\\sqrt 5}{2}$\uff0c\u5219 $f_n=Ax^n+By^n$\u3002\u6ce8\u610f\u5230 $\\sqrt 5$ \u5728\u7ec4\u5408\u6570\u4e0a\u6307\u6807\u4e0a\u4e0d\u592a\u597d\u7ef4\u62a4\u3002\u6839\u636e $\\binom n m=\\frac{n^{\\underline m}}{m!}$\uff0c\u8003\u8651\u4e0b\u964d\u5e42\u8f6c\u666e\u901a\u5e42\u7684\u516c\u5f0f $x^{\\underline k}=\\sum_{i=0}^k\\begin{bmatrix}k\\\\i\\end{bmatrix}(-1)^{k-i}x^i$\uff1a\n\n$$\n\\begin{aligned}\n\\sum_{n=l}^r\\binom{f_n}{k}\n&=\\frac{1}{k!}\\sum_{n=l}^r f_n^{\\underline k}\n=\\frac{1}{k!}\\sum_{n=l}^r\\sum_{i=0}^k(-1)^{k-i}\\begin{bmatrix}k\\\\i\\end{bmatrix}f_n^i\\\\\n&=\\frac{1}{k!}\\sum_{n=l}^r\\sum_{i=0}^k(-1)^{k-i}\\begin{bmatrix}k\\\\i\\end{bmatrix}(Ax^n+By^n)^i\\\\\n&=\\frac{1}{k!}\\sum_{n=l}^r\\sum_{i=0}^k(-1)^{k-i}\\begin{bmatrix}k\\\\i\\end{bmatrix}\\sum_{j=0}^i\\binom i j A^jB^{i-j}(x^jy^{i-j})^n\\\\\n&=\\frac{1}{k!}\\sum_{i=0}^k(-1)^{k-i}\\begin{bmatrix}k\\\\i\\end{bmatrix}\\sum_{j=0}^i\\binom i j A^jB^{i-j}\\sum_{n=l}^r (x^jy^{i-j})^n\n\\end{aligned}\n$$\n\u6700\u540e\u9762\u7684 $\\sum_{n=l}^r(x^jy^{i-j})^n$ \u662f\u4e2a\u7b49\u6bd4\u6570\u5217\u6c42\u548c\u3002\u8fd9\u6837\u5c31\u80fd $\\mathcal O(k^2\\log n)$ \u8ba1\u7b97\u4e86\u3002\u6ce8\u610f\uff1a\n\n- \u7279\u5224\u516c\u6bd4\u4e3a $1$ \u7684\u60c5\u51b5\u3002\n\n- $\\sqrt 5$ \u5728 $\\bmod 998244353$ \u610f\u4e49\u4e0b\u4e0d\u5b58\u5728\uff0c\u7c7b\u4f3c\u8868\u793a\u865a\u6570\u7684\u65b9\u6cd5\uff0c\u5c06\u6bcf\u4e2a\u6570\u8868\u793a\u6210 $A+B\\sqrt 5$\uff0c\u52a0\u51cf\u4e58\u9664\u7167\u6837\u5b9a\u4e49\u3002\u6700\u540e\u7b97\u51fa\u6765\u7684\u7b54\u6848\u4e00\u5b9a\u6ee1\u8db3 $B=0$\uff0c\u4e0d\u5fc5\u62c5\u5fc3\u3002\n\n  \u9664\u6cd5 $\\frac{a+b\\sqrt 5}{c+d\\sqrt 5}=\\frac{(a+b\\sqrt 5)(c-d\\sqrt 5)}{(c+d\\sqrt 5)(c-d\\sqrt 5)}=\\frac{ac-5bd}{c^2-5d^2}+\\frac{bc-ad}{c^2-5d^2}\\sqrt 5$\u3002\n\n##### m=3\n\n\u5148\u8003\u8651\u6c42\u51fa\u9012\u63a8\u5f0f\u3002$G_i=3G_{i-2}+2\\sum_{k\\geq 1}G_{i-2k-2}$\u3002\n\n![image.png](https://s2.loli.net/2022/06/27/3OTtM4lPHZyrpKo.png)\n\n\u5f53 $n$ \u4e3a\u5947\u6570\u65f6\u7b54\u6848\u4e3a $0$\uff0c\u8bbe $g_i=G_{2i}$\uff0c\u90a3\u4e48 $g_i=3g_{i-1}+2\\sum_{k=1}^{i-1}g_{i-k-1}=3g_{i-1}+2\\sum_{k=0}^{i-2}g_k$\u3002\n$$\n\\begin{cases}\ng_i=3g_{i-1}+2\\sum_{k=0}^{i-2}g_k\\\\\ng_{i+1}=3g_i+2g_{i-1}+2\\sum_{k=0}^{i-2}g_k\n\\end{cases}\n\\Rightarrow g_{i+1}=3g_i+(g_i-g_{i-1})\n\\Rightarrow\ng_{i+1}=4g_i-g_{i-1}\n$$\n\u7279\u5f81\u65b9\u7a0b\u4e3a $x^2=4x-1$\uff0c\u89e3\u5f97 $x_1=2+\\sqrt 3,x_2=2-\\sqrt 3$\u3002\u5219 $g_i=Ax_1^n+Bx_2^n$\u3002\u518d\u6839\u636e $g_0=1,g_1=3$\uff1a\n$$\n\\begin{cases}\nA+B=1\\\\\n(2+\\sqrt 3)A+(2-\\sqrt 3)B=3\n\\end{cases}\n\\Rightarrow\n\\begin{cases}\nA=\\frac{3+\\sqrt 3}{6}\\\\\nB=\\frac{3-\\sqrt 3}{6}\n\\end{cases}\n$$\n\u7136\u540e\u5c31\u548c $m=2$ \u4e00\u6837\u4e86\u3002\u53ea\u662f\u8fd9\u91cc $l,r$ \u6ca1\u6709 $+1$ \u800c\u53d8\u6210\u4e86 $/2$\u3002\n\n```cpp\n#include<bits/stdc++.h>\n#define ll long long\nusing namespace std;\nconst int N=510,mod=998244353;\nint t,m,w,c[N][N],s[N][N],inv[N],k,iv2=(mod+1)/2,tmp;\nll l,r;\nint qpow(int x,int n){\n\tint ans=1;\n\tfor(;n;n>>=1,x=1ll*x*x%mod) if(n&1) ans=1ll*ans*x%mod;\n\treturn ans;\n}\nstruct num{\n\tint x,y;\n\tnum operator+(num a){return {(x+a.x)%mod,(y+a.y)%mod};}\n\tnum operator-(num a){return {(x-a.x+mod)%mod,(y-a.y+mod)%mod};}\n\tnum operator*(int a){return {1ll*x*a%mod,1ll*y*a%mod};}\n\tnum operator*(num a){return {(1ll*x*a.x%mod+1ll*y*a.y%mod*w%mod)%mod,(1ll*x*a.y%mod+1ll*y*a.x%mod)%mod};}\n\tnum operator/(num a){\n\t\tint iv=qpow((1ll*a.x*a.x%mod-1ll*w*a.y%mod*a.y%mod+mod)%mod,mod-2);\n\t\treturn {1ll*(1ll*x*a.x%mod-1ll*w*y%mod*a.y%mod+mod)%mod*iv%mod,1ll*(1ll*y*a.x%mod-1ll*x*a.y%mod+mod)%mod*iv%mod};\n\t}\n}a,b,x,y;\nnum qpow(num x,ll n){\n\tnum ans={1,0};\n\tfor(;n;n>>=1,x=x*x) if(n&1) ans=ans*x;\n\treturn ans;\n}\nint calc(){\n\tint ans=0;\n\tfor(int i=0;i<=k;i++){\n\t\tint cnt=0;\n\t\tfor(int j=0;j<=i;j++){\n\t\t\tnum p=qpow(a,j)*qpow(b,i-j)*c[i][j],q=qpow(x,j)*qpow(y,i-j);\n\t\t\tq=q.x==1&&q.y==0?(num){(r-l+1)%mod,0}:(qpow(q,r+1)-qpow(q,l))/(q-(num){1,0});\n\t\t\tcnt=(cnt+(p*q).x)%mod;\n\t\t}\n\t\tans=(ans+1ll*((k-i)&1?mod-1:1)*s[k][i]%mod*cnt%mod)%mod;\n\t}\n\treturn 1ll*inv[k]%mod*ans%mod;\n}\nsigned main(){\n\tinv[0]=inv[1]=1;\n\tfor(int i=2;i<N;i++) inv[i]=1ll*inv[mod%i]*(mod-mod/i)%mod;\n\tc[0][0]=s[0][0]=1;\n\tfor(int i=1;i<N;i++){\n\t\tc[i][0]=1,inv[i]=1ll*inv[i-1]*inv[i]%mod;\n\t\tfor(int j=1;j<=i;j++){\n\t\t\tc[i][j]=(c[i-1][j]+c[i-1][j-1])%mod; \n\t\t\ts[i][j]=(1ll*s[i-1][j]*(i-1)%mod+s[i-1][j-1])%mod;\n\t\t}\n\t}\n\tscanf(\"%d%d\",&t,&m);\n\tif(m==2) w=5,a=(num){0,1}/(num){5,0},b=(num){0,-1}/(num){5,0},x={iv2,iv2},y={iv2,mod-iv2};\n\telse w=3,a=(num){3,1}/(num){6,0},b=(num){3,mod-1}/(num){6,0},x={2,1},y={2,mod-1};\n\twhile(t--){\n\t\tscanf(\"%lld%lld%d\",&l,&r,&k),tmp=qpow((r-l+1)%mod,mod-2);\t//\u6ce8\u610f\u540e\u9762 r-l+1 \u6539\u53d8\u4e86\n\t\tm==2?(l++,r++):(l=(l+1)/2,r/=2),printf(\"%lld\\n\",1ll*tmp*calc()%mod);\n\t}\n\treturn 0;\n}\n```\n\n",
        "postTime": 1656307207,
        "uid": 171807,
        "name": "maoyiting",
        "ccfLevel": 7,
        "title": "P5320 [BJOI2019]\u52d8\u7834\u795e\u673a"
    },
    {
        "content": "[\u6ecb\u78c1\u53bb\u6211\u7684\u535a\u5ba2\u770b\u5416](http://www.vixbob-lwc.pw/2019/05/18/BJOI2019/)\r\n\r\n\u53c8\u662f\u4e8c\u5408\u4e00...\r\n\r\n\u4e0b\u6587\u4e2d$x^{\\underline{n}}$\u8868\u793a$x$\u7684$n$\u6b21\u4e0b\u964d\u5e42\uff0c\u5373\uff1a$x^{\\underline{n}}=\\prod_{i=1}^n(x-i+1)$\r\n\r\n\u5148\u8003\u8651\u7b2c\u4e00\u95ee\uff1a\r\n\r\n\u8fd9\u4e2a\u4e1c\u897f\u5b9e\u9645\u4e0a\u5c31\u4e0a\u8981\u6211\u4eec\u6c42\uff1a\r\n$$\\sum_{i=l}^r\\binom{f[i]}{k}$$\r\n$f[i] = fib[i+1]$.\r\n\r\n\u8003\u8651\u5c55\u5f00\uff1a\r\n$$\\sum_{i=l}^r\\frac{f[i]^{\\underline{k}}}{k!}$$\r\n\u60f3\u7684\u65f6\u5019\u662f\u5f80\u751f\u6210\u51fd\u6570\u65b9\u9762\u60f3\u7684\uff0c\u4f60\u76f4\u63a5\u628a$x^{\\underline{n}}$\u770b\u6210\u4e00\u4e2a$n$\u6b21\u591a\u9879\u5f0f\u5c31\u53ef\u4ee5\u628a\u8fd9\u4e2a\u4e0b\u964d\u5e42\u8f6c\u6210\u4e00\u4e2a\u5e42\u548c\u7684\u5f62\u5f0f\u4e86\u3002\u4e8b\u540e\u53d1\u73b0\u539f\u6765\u8fd9\u4e2a\u591a\u9879\u5f0f\u7684\u7cfb\u6570\u5c31\u662f\u6709\u7b26\u53f7\u7b2c\u4e00\u7c7b\u65af\u7279\u6797\u6570.....(~~\u6ca1\u5b66\u8fc7\uff0c\u544a\u8f9e~~)\r\n\r\n\u7136\u540e\u6709\uff1a\r\n$$\\frac{1}{k!}\\sum_{i=l}^r\\sum_{j=1}^k\\begin{bmatrix}k\\\\j\\end{bmatrix}_sf[i]^j$$\r\n\u663e\u7136\u6709$f[i]$\u7684\u9012\u63a8\u5f0f\uff1a\r\n$$\\begin{cases}f[n]=1, 0\\le n\\le1\\\\f[n]=f[n-1]+f[n-2],n>1\\end{cases}$$\r\n\u7136\u540e\u6211\u4eec\u7528\u7279\u5f81\u65b9\u7a0b\u89e3\u4e00\u4e0b\u53ef\u5f97\uff1a\r\n$$f[n]=\\frac{5+\\sqrt5}{10}\\left(\\frac{1+\\sqrt5}{2}\\right)^n+\\frac{5-\\sqrt5}{10}\\left(\\frac{1-\\sqrt5}{2}\\right)^n$$\r\n\u5219$f[n]$\u53ef\u4ee5\u88ab\u8868\u793a\u4e3a$A\\alpha^n+B\\beta^n$\u7684\u5f62\u5f0f\uff0c\u6211\u4eec\u628a\u8fd9\u4e2a\u4ee3\u56de\u4e0a\u5f0f\u6709\uff1a\r\n$$\\begin{aligned}&\\frac{1}{k!}\\sum_{i=l}^r\\sum_{j=1}^k\\begin{bmatrix}k\\\\j\\end{bmatrix}_s\\left(A\\alpha^i+B\\beta^i\\right)^j\\\\=&\\frac{1}{k!}\\sum_{i=l}^r\\sum_{j=1}^k\\begin{bmatrix}k\\\\j\\end{bmatrix}_s\\sum_{v=0}^j\\binom{j}{v}A^v\\alpha^{iv}B^{j-v}\\beta^{i(j-v)}\\\\=&\\frac{1}{k!}\\sum_{j=1}^k\\begin{bmatrix}k\\\\j\\end{bmatrix}_s\\sum_{v=0}^j\\binom{j}{v}A^vB^{j-v}\\sum_{i=l}^r(\\alpha^{v}\\beta^{j-v})^i\\end{aligned}$$\r\n\u540e\u9762\u660e\u663e\u662f\u4e2a\u7b49\u5dee\u6570\u5217\u7684\u5f62\u5f0f\u76f4\u63a5\u7528\u516c\u5f0f\u5c31\u597d\u4e86\u3002(\u6ce8\u610f\u5b58\u5728\u516c\u6bd4\u4e3a\u4e00\u7684\u60c5\u51b5)\r\n\r\n\u4f46\u662f\u6709\u4e2a\u95ee\u9898\u5c31\u662f$\\sqrt5$\u5728\u819c$998244353$\u7684\u610f\u4e49\u4e0b\u5e76\u4e0d\u5b58\u5728\u3002\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u6a21\u4eff\u590d\u6570\uff0c\u4e5f\u641e\u4e00\u4e2a\"\u865a\u90e8\"$i$\uff0c\u53ea\u4e0d\u8fc7\u8fd9\u4e2a$i^2=5$\u3002\u56e0\u4e3a\u6590\u6ce2\u90a3\u5951\u6570\u5217\u6700\u540e\u6c42\u51fa\u6765\u4e00\u5b9a\u662f\u4e2a\u6574\u6570\u6240\u4ee5\u865a\u90e8\u7684\u7cfb\u6570\u4e00\u5b9a\u4e3a$0$.\r\n\r\n\u8003\u8651\u7b2c\u4e8c\u95ee\uff1a\r\n\r\n\u5148\u8003\u8651\u6c42\u51fa\u8fd9\u4e2a\u4e1c\u897f\u7684\u9012\u63a8\u5f0f\uff0c\u9996\u5148$n$\u4e3a\u5947\u6570\u7684\u65f6\u5019\u65b9\u6848\u80af\u5b9a\u7b49\u4e8e\u96f6\u3002\u6240\u4ee5\u6211\u4eec\u8bbe$g_i$\u8868\u793a$n =2\\times i$\u7684\u65b9\u6848\u6570\u3002\r\n\r\n\u8003\u8651\u600e\u4e48\u9012\u63a8\uff0c\u9996\u5148\u6700\u540e\u7684\u4e00\u4e2a$3 \\times 2$\u7684\u5757\u4e2d\u6709\u4e09\u79cd\u6446\u653e\u65b9\u5f0f\uff0c\u4f46\u8fd9\u4e00\u79cd\u8f6c\u79fb\u80af\u5b9a\u662f\u6f0f\u6389\u4e86\u4e00\u4e9b\u65b9\u6848\u7684\uff0c\u5b9e\u5219\u6211\u4eec\u53ef\u4ee5\u8de8\u8d8a\u6700\u540e\u4e00\u4e2a\u5076\u6570\u4f4d\u7f6e\uff0c\u5982\u56fe\uff1a\r\n\r\n![](https://s2.ax1x.com/2019/05/18/EOkqzR.png)\r\n\r\n\u7136\u540e\u6211\u4eec\u679a\u4e3e\u4e00\u4e0b\u7b2c\u4e8c\u79cd\u60c5\u51b5\u8de8\u8d8a\u7ea2\u7ebf\u7684\u6570\u91cf\u5c31\u6709\u9012\u63a8\u5f0f\uff1a\r\n$$\\begin{aligned}g[n]&=3\\times g[n-1]+2\\times\\sum_{i=1}^{n-1}g[n-1-i]\\\\&=3 \\times g[n-1]+2\\times\\sum_{i=0}^{n-2}g[i]\\end{aligned}$$\r\n\u5219\u6709\uff1a\r\n$$\\begin{cases}g[n]=3 \\times g[n-1]+2\\times\\sum_{i=0}^{n-2}g[i]\\\\g[n+1]=3\\times g[n]+2\\times g[n-1]+2\\times \\sum_{i=0}^{n-2}g[i]\\end{cases}$$\r\n\u5dee\u5206\u4e00\u4e0b\uff1a\r\n$$g[n+1]=4 \\times g[n]-g[n-1]$$\r\n\u4e5f\u5c31\u662f\u8bf4$g[n]$\u7684\u9012\u63a8\u5f0f\u4e3a\uff1a\r\n$$\\begin{cases}g[n]=1,n=0\\\\g[n]=3,n=1\\\\g[n]=4 \\times g[n-1]-g[n-2],n>1\\end{cases}$$\r\n\u7528\u7279\u5f81\u65b9\u7a0b\u65b9\u7a0b\u89e3\u5f97\uff1a\r\n$$g[n]=\\frac{3+\\sqrt3}{6}(2+\\sqrt3)^n+\\frac{3-\\sqrt3}{6}(2-\\sqrt3)^n$$\r\n\u7136\u540e\u5c31\u662f\u4e00\u6a21\u4e00\u6837\u7684\u4e86\u3002\u590d\u6742\u5ea6$O(k^2 \\log{(r-l)})$\u3002\r\n\r\n\u4ee3\u7801\uff1a\r\n\r\n```cpp\r\n/*\r\n * 3090.cpp\r\n * This file is part of 3090\r\n *\r\n * Copyright (C) 2019 - ViXbob\r\n *\r\n * 3090 is free software; you can redistribute it and/or\r\n * modify it under the terms of the GNU Lesser General Public\r\n * License as published by the Free Software Foundation; either\r\n * version 2.1 of the License, or (at your option) any later version.\r\n *\r\n * 3090 is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\r\n * Lesser General Public License for more details.\r\n *\r\n * You should have received a copy of the GNU Lesser General Public License\r\n * along with 3090. If not, see <http://www.gnu.org/licenses/>.\r\n */\r\n\r\n/**\r\n * There is no end though there is a start in space. ---Infinity.\r\n * It has own power, it ruins, and it goes though there is a start also in the star. ---Finite.\r\n * Only the person who was wisdom can read the most foolish one from the history.\r\n * The fish that lives in the sea doesn't know the world in the land.\r\n * It also ruins and goes if they have wisdom.\r\n * It is funnier that man exceeds the speed of light than fish start living in the land.\r\n * It can be said that this is an final ultimatum from the god to the people who can fight.\r\n *\r\n * Steins;Gate\r\n */\r\n#include <bits/stdc++.h>\r\n#define rep(i, j, k) for(int i = j; i <= k; ++i)\r\n#define dep(i, j, k) for(int i = j; i >= k; --i)\r\n#define SIZE(x) ((int)x.size())\r\n#define mp(x, y) make_pair(x, y)\r\n#define pb(x) push_back(x)\r\n#define inv(x) (ksm(x, P - 2))\r\n\r\ntypedef long long ll;\r\ntypedef unsigned long long ull;\r\n\r\nusing namespace std;\r\n\r\nconst int maxn = 5e2 + 15;\r\nconst int P = 998244353;\r\nconst int inf = 0x3f3f3f3f;\r\n\r\nint T, m, k, sqr, C[maxn][maxn], S[maxn][maxn], V, ans, fac[maxn], ifac[maxn];\r\nll l, r, n, N;\r\n\r\ninline ll read() {\r\n\tchar ch = getchar(); ll u = 0, f = 1;\r\n\twhile(!isdigit(ch)) { if(ch == '-') f = -1; ch = getchar(); }\r\n\twhile(isdigit(ch))  { u = u * 10 + ch - 48; ch = getchar(); } return u * f;\r\n}\r\n\r\nstruct Complex {\r\n\tint x, y;\r\n\tComplex(int a = 0, int b = 0) { x = a; y = b; }\r\n\tComplex operator + (const Complex &t) const { return Complex((x + t.x) % P, (y + t.y) % P); }\r\n\tComplex operator - (const Complex &t) const { return Complex((x - t.x + P) % P, (y - t.y + P) % P); }\r\n\tComplex operator * (const Complex &t) const { return Complex((1ll * x * t.x % P + 1ll * V * y % P * t.y % P) % P, (1ll * x * t.y % P + 1ll * y * t.x % P) % P); }\r\n\tComplex operator * (const int &t) const { return Complex(1ll * x * t % P, 1ll * y * t % P); }\r\n} A, B, alpha, beta;\r\n\r\ninline int pls(int x, int y) { x += y; return x >= P ? x - P : x; }\r\ninline int dec(int x, int y) { x -= y; return x < 0 ? x + P : x; }\r\ninline int mul(int x, int y) { return 1ll * x * y % P; }\r\ninline int ksm(int x, ll k, int rnt = 1) {\r\n\tfor(ll i = k; i; i >>= 1, x = 1ll * x * x % P) if(i & 1) rnt = 1ll * rnt * x % P;\r\n\treturn rnt;\r\n}\r\ninline Complex ksm(Complex x, ll k, Complex rnt = Complex(1, 0)) {\r\n\tfor(ll i = k; i; i >>= 1, x = x * x) if(i & 1) rnt = rnt * x;\r\n\treturn rnt;\r\n}\r\ninline Complex Inv(Complex a) { return Complex(a.x, P - a.y) * inv((1ll * a.x * a.x % P - 1ll * V * a.y % P * a.y % P + P) % P); }\r\n\r\nconst int inv2 = inv(2), inv10 = inv(10), inv6 = inv(6);\r\n\r\nint main() {\r\n//\tfreopen(\"1.in\", \"r\", stdin);\r\n//\tfreopen(\"my.out\", \"w\", stdout);\r\n\tT = read(); m = read(); V = (m == 2) ? 5 : 3; S[1][1] = 1;\r\n\trep(i, 0, maxn - 1) C[i][0] = 1;\r\n\trep(i, 1, maxn - 1) rep(j, 1, i) C[i][j] = pls(C[i - 1][j - 1], C[i - 1][j]);\r\n\trep(i, 2, maxn - 1) rep(j, 1, i) S[i][j] = dec(S[i - 1][j - 1], mul(i - 1, S[i - 1][j]));\r\n\tfac[0] = 1;\r\n\trep(i, 1, maxn - 1) fac[i] = 1ll * fac[i - 1] * i % P;\r\n\tifac[maxn - 1] = inv(fac[maxn - 1]);\r\n\tdep(i, maxn - 2, 0) ifac[i] = 1ll * ifac[i + 1] * (i + 1) % P;\r\n\twhile(T--) {\r\n\t\tl = read(); r = read(); k = read(); ans = 0; N = r - l + 1;\r\n\t\tif(m == 2) {\r\n\t\t\tA = Complex(inv2, inv10); B = Complex(inv2, P - inv10);\r\n\t\t\talpha = Complex(inv2, inv2); beta = Complex(inv2, P - inv2);\r\n\t\t} else {\r\n//\t\t\tl -= !(l & 1); r += (r & 1);\r\n//\t\t\tl = l + 1 >> 1; r >>= 1;\r\n\t\t\tl = l + 1 >> 1; r >>= 1;\r\n\t\t\tA = Complex(inv2, inv6); B = Complex(inv2, P - inv6);\r\n\t\t\talpha = Complex(2, 1); beta = Complex(2, P - 1);\r\n\t\t} n = r - l + 1;\r\n//\t\tcerr << (A * ksm(alpha, 3) + B * ksm(beta, 3)).x << endl;\r\n//\t\tcerr << l << \" \" << r << \" \" << n << endl;\r\n\t\trep(i, 1, k) {\r\n\t\t\tComplex tmp(0, 0);\r\n\t\t\trep(j, 0, i) {\r\n\t\t\t\tComplex c = ksm(A, j) * ksm(B, i - j);\r\n\t\t\t\tComplex q = ksm(alpha, j) * ksm(beta, i - j);\r\n\t\t\t\tComplex goal = (ksm(q, n + 1) - q) * Inv(q - Complex(1, 0));\r\n\t\t\t\tif(q.x == 1 && q.y == 0) goal = q * (n % P);\r\n\t\t\t\ttmp = tmp + c * goal * C[i][j] * ksm(q, l - 1);\r\n\t\t\t}\r\n//\t\t\tcerr << tmp.x << \" \" << tmp.y << \" \" << S[k][i] << endl;\r\n\t\t\tans = (ans + 1ll * S[k][i] * tmp.x % P) % P;\r\n\t\t}\r\n\t\tprintf(\"%d\\n\", 1ll * ans * inv(N % P) % P * ifac[k] % P);\r\n\t}\r\n\treturn 0;\r\n}\r\n/*\r\n1 2 3 5\r\n1 + 3 + 10\r\n14 / 3\r\nx\r\nx(x-1)=-x+x^2\r\nx(x-1)(x-2)=(x^2-x)(x-2)=2x-3x^2+x^3\r\n(x^3-3x^2+2x)(x-3)=-6x+11x^2-6x^3+x^4\r\n\r\n0 0 0 0 0 0 0  0  1 -1\r\n0 0 0 0 0 0 0  1 -3  2\r\n0 0 0 0 0 0 1 -6 11 -6\r\n0 0 0 0 0 1 -10 35 -50 24\r\n\r\nf[1]\r\nf[2]\r\nf[3] = f[1] * f[2]\r\nf[4] = f[1] * f[2] ^ 2\r\nf[5] = f[1] ^ 2 * f[2] ^ 3\r\nf[6] = f[1] ^ 3 * f[2] ^ 5\r\nf[7] = f[1] ^ 5 * f[2] ^ 8\r\nf[n] = f[n - 1] * f[n - 2]\r\nf[n] = f[1] ^ fib[n - 2] * f[2] ^ fib[n - 1];\r\n\r\n1 1 2 3 5 8 13\r\n\r\n*/\r\n```",
        "postTime": 1558149264,
        "uid": 50971,
        "name": "ViXbob",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P5320 \u3010[BJOI2019]\u52d8\u7834\u795e\u673a\u3011"
    },
    {
        "content": "\u5f3a\u884c\u591a\u5408\u4e00\uff0c\u800c\u4e14\u9898\u610f\u662f\u4ec0\u4e48\u7834\u73a9\u610f\u554a\u3002\u3002\u3002\n\n### \u9898\u610f\uff1a\u8bbe$m=2$\u7684\u65b9\u6848\u6570\u662f$f_n,m=3$\u65f6\u662f$g_n$\u3002\n\n### \u6c42\n\n$$\\frac 1{r-l+1}\\sum_{i=l}^rC_{f_i}^k$$\n\n$$\\frac 1{r-l+1}\\sum_{i=l}^rC_{g_i}^k$$\n\n## \u5f53$m=2$\n\n\u6253\u8868\u53d1\u73b0$f_1=1,f_2=2,f_3=3,f_4=5,...$\n\n\u5f88\u663e\u7136\u662f\u6590\u6ce2\u90a3\u5951\u6570\u5217\u5427\uff0c\u8bc1\u660e\u4e5f\u5f88\u7b80\u5355\u3002\u5c31\u4e0d\u63d0\u4e86\uff0c\u4f46\u662f\u6ce8\u610f$f_i=F_{i+1}$\uff0c\u6240\u4ee5\u6211\u4eec\u628a$l++,r++$\n\n$F$\u662f\u771f\u5b9e\u7684\u6590\u6ce2\u90a3\u5951\u6570\u5217$(F_0=0,F_1=1)$\n\n\u6211\u4eec\u4e0d\u8003\u8651\u524d\u9762\u7684\u5206\u5f0f\uff0c\u4e5f\u4e0d\u8003\u8651$l,r$\uff0c\u6211\u4eec\u5148\u6c42\u4e00\u4e2a\u524d\u7f00\u548c\uff0c\u5176\u4ed6\u540c\u7406\u3002\n\n\u7136\u540e\u5c31\u662f\u66b4\u529b\u62c6\u5f0f\u5b50\u4e86\u3002\n\n$$\\sum_{i=0}^{n}C_{F_i}^k$$\n\n$$=\\sum_{i=0}^{n}\\frac {(F_i)!}{k!(F_i-k)!}$$\n\n\u8fd9\u4e2a\u9636\u4e58\u4ec0\u4e48\u9b3c\u554a\uff0c\u4f60\u7ed9\u6211\u6c42\u4e00\u4e2a$10^{18}!$\u8bd5\u8bd5$???$\n\n\u6240\u4ee5\u8f6c\u5316\u6210\u53ef\u4ee5\u6c42\u7684\u5b9a\u4e49\u5f0f\u3002\n\n$$=\\sum_{i=0}^{n}\\frac {A_{F_i}^{k}}{A_{k}^{k}}$$\n\n$$=\\frac 1{k!}\\sum_{i=0}^{n}A_{F_i}^{k}$$\n\n$$=\\frac 1{k!}\\sum_{i=0}^{n}F_i^{\\underline k}$$\n\n\u5982\u679c\u4f60\u4e0d\u77e5\u5230\u65af\u7279\u6797\u6570\u548c\u4e0b\u964d\u5e42\u7684\u5173\u7cfb\uff0c\u53ef\u4ee5\u770b\u770b\u6211\u7684[\u7ec4\u5408\u6570\u5b66\u7684\u4e00\u4e9b\u5c0f\u77e5\u8bc6\u603b\u7ed3](https://www.luogu.org/blog/wohaocaia/zu-ge-shuo-xue-di-yi-suo-xiao-zhi-shi-zong-jie-wei-wan-post)\u624d\u521a\u5f00\u59cb\u5199\uff0c\u672a\u5b8c\u5f85\u7eed\uff0c\u5927\u4f6c\u8f7b\u55b7\u3002\n\n\u6839\u636e\u4e0b\u964d\u5e42\u548c\u7b2c\u4e00\u7c7b\u65af\u7279\u6797\u6570\u7684\u5173\u7cfb$($\u8bbe$s$\u4e3a\u7b2c\u4e00\u7c7b\u65af\u7279\u6797\u6570$)$\uff1a\n\n$$x^{\\underline k}=\\sum_{i=1}^ks_k^i(-1)^{k-i}x^i$$\n\n$$\\therefore\\ =\\frac 1{k!}\\sum_{i=0}^{n}\\sum_{j=1}^ks_k^j(-1)^{k-j}(F_i)^j$$\n\n$$\\therefore\\ =\\frac 1{k!}\\sum_{j=1}^k\\sum_{i=0}^{n}s_k^j(-1)^{k-j}(F_i)^j$$\n\n$$\\therefore\\ =\\frac 1{k!}\\sum_{j=1}^ks_k^j(-1)^{k-j}\\sum_{i=0}^{n}(F_i)^j$$\n\n\u7136\u540e\u5c31\u662f\u7ecf\u5178\u95ee\u9898\u4e86(\u597d\u50cf\u4ee5\u524d\u5728\u54ea\u91cc\u505a\u8fc7...)\n\n\u6c42\n\n$$\\sum_{i=0}^n(F_i)^j$$\n\n\u6ce8\u610f\u5230$k\\leq 50$\uff0c\u53ef\u4ee5\u7528\u77e9\u9635\u5feb\u901f\u5e42\u3002\n\n\u7b49\u7b49\u770b\u9519\u4e86$k\\leq 501?????$\n\n\u90a3\u5c31\u66b4\u529b\u5c55\u5f00...\n\n\u6211\u4eec\u8003\u8651\u6c42\u51fa\u901a\u9879\u516c\u5f0f~~\u5982\u679c\u8fd9\u4e2a\u90fd\u4e0d\u4f1a\u4f60\u53ef\u4ee5\u53bb\u5b66\u9ad8\u8003\u4e86~~\n\n$$F_n=\\frac 1{\\sqrt5}\\left[\\left(\\frac{1+\\sqrt5}{2}\\right)^n-\\left(\\frac{1-\\sqrt5}{2}\\right)^n\\right]$$\n\n\u4e3a\u4e86\u65b9\u4fbf\u6211\u4eec\u8bbe$\\alpha=\\frac{1+\\sqrt5}{2},\\beta=\\frac{1-\\sqrt5}{2},A=\\frac 1{\\sqrt5},B=-\\frac 1{\\sqrt5}$\n\n$$F_i=A\\alpha^i+B\\beta^i$$\n\n$$\\sum_{i=0}^n(F_i)^j$$\n\n$$=\\sum_{i=0}^n(A\\alpha^i+B\\beta^i)^j$$\n\n$$=\\sum_{i=0}^n\\sum_{d=0}^jC_j^kA^{j-k}B^k\\alpha^{i(j-k)}\\beta^{ik}$$\n\n$$=\\sum_{d=0}^jC_j^dA^{j-d}B^d\\sum_{i=0}^n\\alpha^{ij-id}\\beta^{id}$$\n\n\u8bbe$c_i=\\alpha^{ij-id}\\beta^{id}$\n\n\u6709\n\n$$\\frac {c_{i+1}}{c_i}=\\frac {\\alpha^{ij-id-d+j}\\beta^{id+d}}{\\alpha^{ij-id}\\beta^{id}}=\\frac {\\beta^{d}}{\\alpha^{d-j}}$$\n\n$\\therefore\\ c_i$\u4e3a\u7b49\u6bd4\u6570\u5217\u3002\n\n$$c_0=1,c_1=\\frac {\\beta^{d}}{\\alpha^{d-j}}$$\n\n$$F_i=A\\alpha^i+B\\beta^i$$\n\n$$=\\sum_{d=0}^jC_j^kA^{j-d}B^d\\sum_{i=0}^n\\alpha^{ij-id}\\beta^{id}$$\n\n$$=\\sum_{d=0}^jC_j^dA^{j-d}B^d\\left(\\frac {1-(\\frac {\\beta^{d}}{\\alpha^{d-j}})^{n+1}}{1-\\frac {\\beta^{d}}{\\alpha^{d-j}}}\\right)$$\n\n\u518d\u5e26\u5165\u56de\u539f\u5f0f\uff1a\n\n$$\\therefore\\ =\\frac 1{k!}\\sum_{j=1}^ks_k^j(-1)^{k-j}\\sum_{i=1}^{n}(F_i)^j$$\n\n$$\\therefore\\ =\\frac 1{k!}\\sum_{j=1}^ks_k^j(-1)^{k-j}\\sum_{d=0}^jC_j^dA^{j-d}B^d\\left(\\frac {1-(\\frac {\\beta^{d}}{\\alpha^{d-j}})^{n+1}}{1-\\frac {\\beta^{d}}{\\alpha^{d-j}}}\\right)$$\n\n$$\\therefore\\ =\\frac 1{k!}\\sum_{j=1}^ks_k^j(-1)^{k-j}\\sum_{d=0}^jC_j^dA^{j-d}B^d\\left(\\frac {1-(\\beta^{d}\\alpha^{j-d})^{n+1}}{1-\\beta^{d}\\alpha^{j-d}}\\right)$$\n\n\u8fd9\u6837\u5c31\u505a\u5b8c\u4e86\u3002\u9884\u5904\u7406\u7b2c\u4e00\u7c7b\u65af\u7279\u6797\u6570\u53ef\u4ee5\u505a\u5230$O(k^2log_2k)$\n\n\u4eff\u4f5b\u662f\u4e00\u4e2a\u5377\u79ef\u7684\u5f62\u5f0f\uff1f\u6240\u4ee5\u53ef\u4ee5\u6570\u636e\u51fa\u5230$10^5?$\u778e\u731c\u7684\n\n\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u89e3\u4e8c\u6b21\u5269\u4f59\u65f6\u53d1\u73b0$\\sqrt5$\u5728\u6a21$998244353$\u4e0b\u65e0\u89e3\uff01\n~~\u7b2c\u4e00\u6b21998244353\u4e0d\u662f\u826f\u5fc3\u6a21\u6570~~\n\n\u6ce8\u610f\u5230\u7b54\u6848\u4e00\u5b9a\u662f\u6574\u6570(\u5e9f\u8bdd)\uff0c\u6240\u4ee5$\\sqrt5$\u6700\u540e\u4e00\u5b9a\u4f1a\u88ab\u6d88\u6389\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0e Cipolla \u7c7b\u4f3c\u7684\u65b9\u6cd5\uff0c\u8bbe$C=a+\\sqrt5b$\uff0c\u91cd\u8f7d\u4e00\u4e2a\u7c7b\u4f3c\u4e8e\u590d\u6570\uff08\u5411\u91cf\uff09\u7684\u4e1c\u897f\u3002\n\n\u8fd9\u6837\u6700\u540e\u7684\u7b54\u6848$b$\u4e00\u5b9a$\\ =0$\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u7b97\u4e86\u3002\n\n\u5f53\u7136\u201c\u590d\u6570\u201d\u4e58\u6cd5\u4e5f\u8981\u91cd\u5b9a\u4e49\u3002\n\n$$(a_1+\\sqrt5b_1)\\times (a_2+\\sqrt5b_2)=(a_1a_2+5b_1b_2)+\\sqrt5(a_1b_2+a_2b_1)$$\n\n\u9006\u5143\uff1a\n\n$$\\frac 1{(a_1+\\sqrt5b_1)}=\\frac {(a_1-\\sqrt5b_1)}{(a_1^2-5b_1^2)}$$\n\n$$=\\frac {a_1}{a_1^2-5b_1^2}-\\sqrt5\n\\frac {b_1}{a_1^2-5b_1^2}$$\n\n## \u5f53$m=3$\n\n\u597d\u591a\u4eba\u90fd\u6ca1\u6709\u8bb2\u6e05\u695a\u554a\uff0c\u867d\u7136\u8bf4\u662f\u5f3a\u884c\u4e8c\u5408\u4e00\uff0c\u4f46\u8fd9\u4e00\u5757\u8fd8\u662f\u6709\u601d\u7ef4\u542b\u91cf\u7684\u5427\uff1f\n\n\u4e00\u6837\u7684\u65b9\u6cd5\uff0c\u4e0d\u4e00\u6837\u7684\u901a\u9879\u516c\u5f0f\u3002\n\n\u8fd9\u91cc\u6211\u4eec\u53ea\u8ba8\u8bba\u5982\u4f55\u6c42\u901a\u9879\u516c\u5f0f\u4ee5\u53ca$A,B,\\alpha,\\beta$\n\n\u611f\u8c22@ViXbob \u5927\u4f6c\u7684\u7075\u611f~\u4e0d\u8fc7\u597d\u50cf\u6709\u4e00\u4e9b\u7ec6\u8282\u6ca1\u6709\u8bb2\u6e05\u695a\uff0c\u6211\u6765\u8865\u5145\u4e00\u4e0b\u3002\n\n\u6211\u4eec\u8bbe$g_i$\u4e3a$3\\times i$\u65f6\u7684\u7b54\u6848\u3002\n\n\u663e\u7136$g_{k}=0\\ (k\\equiv1\\pmod 2)$\n\n\u90a3\u6211\u4eec\u5c31\u7b80\u5316\u4e00\u4e0b\uff0c\u8bbe$G_i$\u4e3a$3\\times 2i$\u65f6\u7684\u7b54\u6848\u3002\n\n\u5e76\u8ba9$l/=2,r/=2$\n\n[![VTA18e.md.png](https://s2.ax1x.com/2019/06/16/VTA18e.md.png)](https://imgchr.com/i/VTA18e)\n\n\u7b2c\u4e00\u79cd\u60c5\u51b5\uff1a\n\n$$3G_{i-1}$$\n\n\u7b2c\u4e8c\u79cd\u60c5\u51b5\uff1a\n\n\u679a\u4e3e**\u53ea**\u8de8\u8fc7$j$\u6761\u9ed1\u7ebf\n\n$$2\\sum_{j=1}^{i-1}G_{i-j-1}$$\n\n\u4e14\n\n$$G_0=1$$\n\n$$\\therefore\\  G_i=3G_{i-1}+2\\sum_{j=1}^{i-1}G_{i-j-1}\\ \\ (1)$$\n\n$$\\because\\ G_{i-1}=3G_{i-2}+2\\sum_{j=1}^{i-2}G_{i-j-2}\\ \\ (2)$$\n\n$$(1)-(2)\\rightarrow G_i-G_{i-1}=3G_{i-1}-3G_{i-2}+2G_{i-2}$$\n\n$$\\therefore\\ G_i=4G_{i-1}-G_{i-2}$$\n\n\u6211\u4eec\u89e3\u7279\u5f81\u6839\u65b9\u7a0b\n\n$$x^2-4x+1=0$$\n\n$$\\alpha=2-\\sqrt3,\\beta=2+\\sqrt3$$\n\n\u5f85\u5b9a\u7cfb\u6570\n\n$$G_0=1,G_2=3$$\n\n$$\\therefore A=\\frac {3-\\sqrt3}6,B=\\frac {3+\\sqrt3}6$$\n\n\u90a3\u4e48\u5c31\u548c$m=2$\u4e00\u6a21\u4e00\u6837\u4e86\uff0c\u8fd9\u9053\u9898\u5c31\u505a\u5b8c\u5566\uff01\n\n\u5982\u679c\u8fd8\u662f\u4e0d\u61c2\u53ef\u4ee5\u95ee\u6211\u3002\n\n## \u603b\u7ed3+\u7ec6\u8282\n\n\u4e0d\u4e00\u5b9a\u6709\u4e8c\u6b21\u5269\u4f59\uff0c\u6b64\u65f6\u5c31\u9700\u8981\u91cd\u8f7d\uff01\n\n**\u7b49\u6bd4\u6570\u5217\u6c42\u548c\u4e00\u5b9a\u8981\u5224\u65ad\u516c\u6bd4\u4e3a$1$\u7684\u60c5\u51b5\uff01**\n\n**\u4e0d\u5224\u4f1aWA,\u6837\u4f8b\u90fd\u8fc7\u4e0d\u4e86\uff01**\n\n\u4ee3\u7801\uff1a\n\n```cpp\n#include<bits/stdc++.h>\n#define ll long long\n#define ljc 998244353\nusing namespace std;\ninline ll fast_pow(ll a,ll b,ll p){\n\tll t=1;a%=p;\n\twhile (b){\n\t\tif (b&1) t=t*a%p;\n\t\tb>>=1;a=a*a%p; \n\t}\n\treturn t;\n}\nll ljc2;\n#ifdef Fading\n#define gc getchar\n#endif\n#ifndef Fading\ninline char gc(){\n    static char now[1<<16],*S,*T;\n    if (T==S){T=(S=now)+fread(now,1,1<<16,stdin);if (T==S) return EOF;}\n    return *S++;\n}\n#endif\ninline ll read(){\n    register ll x=0,f=1;char ch=gc();\n    while (!isdigit(ch)){if(ch=='-')f=-1;ch=gc();}\n    while (isdigit(ch)){x=(x<<3)+(x<<1)+ch-'0';ch=gc();}\n    return (f==1)?x:-x;\n}\nint T,m;\nll sqr,L,R,K;//sqr \u662f 3\u62165 \u8868\u793a\u6839\u53f7\u91cc\u9762\u7684\u6570\nstruct Comp{//\u91cd\u8f7d\u201c\u590d\u6570\u201d\n\tll a,b;\t\n};\nComp A,B,ar,be;\ninline Comp init(ll a,ll b){\n\treturn (Comp){a%ljc,b%ljc};\n}\nComp operator + (Comp a,Comp b){\n\treturn init(a.a+b.a,a.b+b.b);\n}\nComp operator - (Comp a,Comp b){\n\treturn init(a.a-b.a+ljc,a.b-b.b+ljc);\n}\nComp operator * (Comp a,Comp b){//\u4e58\u6cd5\n\treturn init(a.a*b.a+sqr*a.b%ljc*b.b,a.b*b.a+a.a*b.b);\n}\ninline Comp inv(Comp a){//\u9006\u5143\n\tll FM=fast_pow(ljc+a.a*a.a%ljc-sqr*a.b%ljc*a.b%ljc,ljc-2,ljc); \n\treturn init(a.a*FM,ljc-a.b*FM%ljc);\n}\ninline Comp cfast_pow(Comp a,ll b){//\u201c\u590d\u6570\u201d\u5feb\u901f\u5e42\u3002\n\tComp t=init(1,0);a.a%=ljc;a.b%=ljc;\n\twhile (b){\n\t\tif (b&1) t=t*a;\n\t\tb>>=1;a=a*a;\n\t}\n\treturn t;\n}\nll s[1001][1001],C[1001][1001];\ninline ll calc(ll n,ll K){//\u8ba1\u7b97\u524d\u7f00\u548c\n\tll fac=1;Comp One=init(1,0);\n\tfor (ll i=1;i<=K;i++) fac=1LL*fac*i%ljc;\n\tfac=fast_pow(fac,ljc-2,ljc);\n\tll ans=0;\n\tfor (ll j=0,one=((K)%2LL?ljc-1:1);j<=K;j++,one=ljc-one){\n\t\tComp now=init(0,0);\n\t\tfor (ll d=0;d<=j;d++){\n\t\t\tComp rev=cfast_pow(be,d)*cfast_pow(ar,j-d);\n\t\t\tComp Rev=cfast_pow(rev,n+1);\n\t\t\tif (rev.a==1&&rev.b==0) Rev.a=(n+1)%ljc,Rev.b=0;//\u516c\u6bd4\u7b49\u4e8e1\u7684\u7279\u6b8a\u60c5\u51b5\n\t\t\telse{\n\t\t\t\trev=inv(One-rev);Rev=(One-Rev)*rev;\n\t\t\t}\n\t\t\tRev=Rev*cfast_pow(B,d)*cfast_pow(A,j-d);\n\t\t\tRev.a=Rev.a*C[j][d]%ljc;\n\t\t\tRev.b=Rev.b*C[j][d]%ljc;\n\t\t\tnow=now+Rev;\n\t\t}\n\t\tans=(ans+s[K][j]*one%ljc*now.a%ljc)%ljc;\n\t}\n\treturn ans*fac%ljc;\n}\nsigned main(){\n\tT=read();m=read();\n\ts[0][0]=C[0][0]=1;\n\tfor (ll i=1;i<=502;i++){\n\t\tC[i][0]=1;\n\t\tfor (ll j=1;j<=502;j++){\n\t\t\tC[i][j]=(C[i-1][j]+C[i-1][j-1])%ljc;\n\t\t\ts[i][j]=(s[i-1][j]*(i-1)%ljc+s[i-1][j-1])%ljc;\n\t\t}\n\t}\n\tljc2=fast_pow(2,ljc-2,ljc);\n\tif (m==2){//\u521d\u59cb\u5316\n\t\tsqr=5,ar=init(ljc2,ljc2),be=init(ljc2,ljc-ljc2);\n\t\tA=init(0,fast_pow(5,ljc-2,ljc)),B=init(0,ljc-fast_pow(5,ljc-2,ljc));\n\t}else{\n\t\tsqr=3,ar=init(2,ljc-1),be=init(2,1);\n\t\tA=init(ljc2,ljc-fast_pow(6,ljc-2,ljc)),B=init(ljc2,fast_pow(6,ljc-2,ljc));\n\t}\n\twhile (T--){\n\t\tll L=read(),R=read(),K=read();\n\t\tll INV=fast_pow(R-L+1+ljc,ljc-2,ljc);\n\t\tif (m==2) R++; \n\t\telse L=(L-1)/2,R/=2;\n\t\tprintf(\"%lld\\n\",(calc(R,K)-calc(L,K)+ljc)%ljc*INV%ljc);\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1560482568,
        "uid": 20309,
        "name": "Fading",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P5320 \u3010[BJOI2019]\u52d8\u7834\u795e\u673a\u3011"
    },
    {
        "content": "## \u524d\u8a00\n\n~~\u9000\u5f79\u9009\u624b\u4e0d\u597d\u597d\u5b66 whk \u8dd1\u6765\u9893\u5e9f~~\n\n\u9898\u89e3\u91cc\u90fd\u662f\u65af\u7279\u6797\u6570\u63a8\u5f0f\u5b50 + \u6269\u57df\uff0c\u5bf9\u6211\u8fd9\u6837\u8111\u5bb9\u91cf\u4e0d\u8db3\u7684\u66b4\u529b\u9009\u624b\u4e0d\u591f\u53cb\u597d\u3002\n\n\u8fd9\u91cc\u8bb2\u4e00\u4e2a\u5341\u5206\u66b4\u529b\u7684 BM + \u7ebf\u6027\u9012\u63a8\u505a\u6cd5\u3002\n\n\u524d\u7f6e\u77e5\u8bc6\u4e0d\u4f1a\u53ef\u4ee5\u5de6\u8f6c\u6a21\u677f\u9898\uff1a\n\n[P4723 \u3010\u6a21\u677f\u3011\u5e38\u7cfb\u6570\u9f50\u6b21\u7ebf\u6027\u9012\u63a8](https://www.luogu.com.cn/problem/P4723)\n\n[P5487 \u3010\u6a21\u677f\u3011Berlekamp\u2013Massey \u7b97\u6cd5](https://www.luogu.com.cn/problem/P5487)\n\n## \u89e3\u6cd5\n\n\u521d\u6b65\u63a8\u5bfc\u5f97\u5230\u7684\u5f0f\u5b50\u90fd\u662f $\\sum_{i = 1}^{n} \\binom{f_i}{k}$ \u8fd9\u6837\u7684\u5f62\u5f0f\uff0c\u5176\u4e2d $\\{f\\}$ \u4e3a\u4e00\u4e2a\u4f4e\u9636\u7684\u5e38\u7cfb\u6570\u9f50\u6b21\u7ebf\u6027\u9012\u63a8\u6570\u5217\uff08\u4ee5\u4e0b\u201c\u5e38\u7cfb\u6570\u9f50\u6b21\u7ebf\u6027\u9012\u63a8\u201d\u7b80\u79f0\u4e3a\u201c\u7ebf\u6027\u9012\u63a8\u201d\uff09\u3002\n\n\u8003\u8651\u8bc1\u660e\u8fd9\u662f\u4e00\u4e2a\u7ebf\u6027\u9012\u63a8\u6570\u5217\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u5927\u529b\u5957 BM \u4e86\u3002\n\n\u9996\u5148\u5bf9\u4e0e\u7ebf\u6027\u9012\u63a8\u6709\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u6027\u8d28\uff1a\u7ebf\u6027\u9012\u63a8\u7684\u5c01\u95ed\u6027\u3002\n\n\u5bf9\u4e8e\u7ebf\u6027\u9012\u63a8\u6570\u5217 $\\{a\\},\\{b\\}$\uff0c\u6709\u5982\u4e0b\u51e0\u6761\uff1a\n\n- $\\{a_ip\\}$ \u662f\u7ebf\u6027\u9012\u63a8\u3002\n- $\\{a_i + b_i\\}$ \u662f\u7ebf\u6027\u9012\u63a8\u3002\n- $\\{a_{i + 1}\\}$ \u662f\u7ebf\u6027\u9012\u63a8\u3002\n- $\\{a_i b_i\\}$ \u662f\u7ebf\u6027\u9012\u63a8\u3002\n- $\\{\\sum_{j = 0}^{i}a_j b_{i - j}\\}$ \u662f\u7ebf\u6027\u9012\u63a8\u3002\n\n\u8003\u8651\u539f\u5f0f\uff0c\u524d\u7f00\u548c\u76f8\u5f53\u4e8e\u5377\u4e0a $\\{1,1,1,\\cdots\\}$\uff0c\u53ef\u4ee5\u6458\u6389\u3002\n\n\u5269\u4e0b\u90e8\u5206\u4e3a\uff1a\n\n$$\\large\\begin{aligned}\n\\binom{f_i}{k} &= \\frac{\\prod_{j = 0}^{k - 1}f_i - j}{k!}\\\\\n\\end{aligned}$$\n\n$\\dfrac{1}{k!}$ \u662f\u5e38\u6570\uff0c$f_i - j$ \u662f\u7ebf\u6027\u9012\u63a8\u3002\n\n\u7efc\u4e0a\uff0c$\\sum_{i = 1}^{n} \\binom{f_i}{k}$ \u4e3a\u4e00\u4e2a\u7ebf\u6027\u9012\u63a8\u6570\u5217\uff0c\u6211\u4eec\u53ef\u4ee5 $\\mathcal{O} (k ^2)$ \u66b4\u529b\u6c42\u51fa\u524d\u9762\u4e00\u5b9a\u7684\u9879\u6570\u7136\u540e\u4e22\u8fdb BM \u91cc\u3002\n\nBM \u6253\u8868\u53ef\u77e5\uff0c\u6700\u957f\u7684\u9012\u63a8\u5f0f\u957f\u5ea6\u4e0d\u8d85\u8fc7 $2507$\uff0c\u66b4\u529b\u6c42\u5176\u4e8c\u500d\u5373\u6570\u5217\u524d\u9762\u7ea6 $5000$ \u9879\u5373\u53ef\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O(k^2 + k \\log k \\log n)}$\uff0c\u7528 $k^2 \\log$ \u7ebf\u6027\u9012\u63a8\u5728\u6d1b\u8c37\u548c loj \u90fd\u4f1a\u88ab\u5361\u3002\n\n## \u4ee3\u7801\n\n[\u5b8c\u6574\u4ee3\u7801](https://www.luogu.com.cn/paste/czm6527n)\n\n\u535a\u5ba2\u91cc\u5c31\u653e\u4e2a\u6838\u5fc3\u90e8\u5206\u5427\uff0c\u7ebf\u6027\u9012\u63a8\u548c BM \u90fd\u662f\u677f\u5b50\u3002\n\n```cpp\n#define rep(a,b,c) for(int a = (b);a <= (c);++a)\n#define repl(a,b,c) for(int a = (b);a < (c);++a)\n#define add(x,y) ( (((x) += (y)) >= MOD) && ((x) -= MOD) )\n#define red(x,y) ( (((x) -= (y)) < 0) && ((x) += MOD) )\n\n\n// \u66b4\u529b\u7ec4\u5408\u6570\ninline int binom(int n,int m) {\n\tint x = 1,y = 1;\n\trep(i,1,m) {\n\t\tx = (i64)x * (n - i + 1) % MOD;\n\t\ty = (i64)y * i % MOD;\n\t}\n\treturn (i64)x * qpow(y) % MOD;\n}\n\nint m;\n\nvoid solve() {\n\ti64 l = readI(),r = readI();\n\tint k = readI();\n\tint frac = qpow((r - l + 1) % MOD);\n\tif(m == 3) {\n\t\tr >>= 1,l = ((l - 1) >> 1) + 1;\n\t\tif(l > r) {\n\t\t\tPutC('0'),enter;\n\t\t\treturn ;\n\t\t}\n\t}\n\tconst int lim = 5000;// \u66b4\u529b\u8ba1\u7b97\u524d 5000 \u9879\n\tg[0] = 1;\n\trep(i,1,lim) {\n\t\tg[i] = g[i - 1],f[i] = f[i - 1];\n\t\tif(m == 3) {\n\t\t\tg[i] = g[i] * 4ll % MOD;\n\t\t\tif(i ^ 1)\n\t\t\t\tadd(g[i],MOD - g[i - 2]);\n\t\t\telse\n\t\t\t\tadd(g[i],MOD - 1);\n\t\t}\n\t\telse if(i ^ 1)\n\t\t\tadd(g[i],g[i - 2]);\n\t\tadd(f[i],binom(g[i],k));\n\t}\n\tint kk = BerlekampMassey(f,a,lim);// BM \u6c42\u9012\u63a8\u5f0f\n\tint ans = LinearRecurrence(f + 1,a,r - 1,kk);\n\tif(l ^ 1)\n\t\tadd(ans,MOD - LinearRecurrence(f + 1,a,l - 2,kk));\n\tans = (i64)ans * frac % MOD;\n\twriteI(ans),enter;\n}\n```",
        "postTime": 1637458925,
        "uid": 122520,
        "name": "\u671b\u6708Asta",
        "ccfLevel": 6,
        "title": "P5320 \u9898\u89e3"
    },
    {
        "content": "\u9996\u5148\u6709\uff1a\n\n$${f_n \\choose k}=\\frac{f_n^{\\underline k}}{k!}$$\n\n\u7531\u4e8e\uff1a\n\n$$x^{\\underline{n}}= \\sum_{i=0}^{n} \\begin{bmatrix} n \\\\ i \\end{bmatrix}(-1)^{n-i} x^i$$\n\n\u53ef\u4ee5\u5f97\u51fa\uff1a\n\n$$f_{n}^{\\underline k}=\\sum_{i=0}^{k} \\begin{bmatrix}k\\\\i \\end{bmatrix} (-1)^{k-i} f_n^i$$\n\n\u5219\uff1a\n\n$$\\begin{aligned} &\\sum_{i=l}^{r} {f_i \\choose k} \\\\ =&\\frac{1}{k!} \\sum_{i=l}^{r} f_i^{\\underline k} \\\\ =&\\frac{1}{k!}\\sum_{i=l}^{r} \\sum_{j=0}^{k} \\begin{bmatrix}k\\\\j \\end{bmatrix} (-1)^{k-j} f_{i}^j \\\\ =&\\frac{1}{k!}\\sum_{j=0}^{k} \\begin{bmatrix}k\\\\j \\end{bmatrix} (-1)^{k-j} \\sum_{i=l}^{r} f_i^j \\end{aligned}$$\n\n---\n\n\u5f3a\u884c\u4e8c\u5408\u4e00\uff0c\u90a3\u4e48\u5148\u89e3\u51b3\u524d\u534a\u90e8\u5206\n\n\u663e\u7136\u6709\uff1a\n\n$$\\begin{cases} f_0=1 \\\\ f_1=1 \\\\ f_{n}=f_{n-1}+f_{n-2} \\end{cases}$$\n\n\u5bf9\u4e8e\u65b9\u7a0b $x^2=x+1$\uff0c\u6709\u6839 $x=\\frac{1 \\pm \\sqrt{5}}{2}$\n\n\u5373\uff1a\n\n$$f_n=a\\left( \\frac{1 + \\sqrt{5}}{2} \\right)^n+b\\left( \\frac{1-\\sqrt{5}}{2} \\right)^n$$\n\n\u7531 $f_0=f_1=1$\uff0c\u89e3\u5f97\uff1a\n\n$$\\begin{cases} a=\\frac{1+\\frac{1}{\\sqrt{5}}}{2} \\\\ b=\\frac{1-\\frac{1}{\\sqrt{5}}}{2} \\end{cases}$$\n\n\u5373\uff1a\n\n$$f_n=\\frac{1+\\frac{1}{\\sqrt{5}}}{2} \\left( \\frac{1+\\sqrt{5}}{2} \\right)^n + \\frac{1-\\frac{1}{\\sqrt{5}}}{2} \\left( \\frac{1-\\sqrt{5}}{2} \\right)^n$$\n\n\u4e5f\u5c31\u662f\uff1a\n\n$$f_n=\\frac{5+\\sqrt{5}}{10} \\left(\\frac{1+\\sqrt{5}}{2}\\right)^n + \\frac{5-\\sqrt{5}}{10} \\left(\\frac{1-\\sqrt{5}}{2}\\right)^n$$\n\n\u8003\u8651\u5728 $\\mathbb{Z}[\\sqrt{5}]$ \u4e0a\u5b9a\u4e49 $(a,b)$\uff0c\u76f8\u5f53\u4e8e\u6620\u5c04\u5230 $\\mathbb{R}$ \u4e0a\u7684 $a\\sqrt{5}+b$\uff0c\u5b9a\u4e49\u5176\u4e0a\u7684\u8fd0\u7b97\u5982\u4e0b\uff1a\n\n\u5bf9\u4e8e\u4e8c\u5143\u8fd0\u7b97 $+$\uff0c\u6709\uff1a\n\n$$(a,b)+(c,d)=(a+c,b+d)$$\n\n\u5bf9\u4e8e\u4e8c\u5143\u8fd0\u7b97 $-$\uff0c\u6709\uff1a\n\n$$(a,b)-(c,d)=(a-c,b-d)$$\n\n\u5bf9\u4e8e\u4e8c\u5143\u8fd0\u7b97 $\\times$\uff0c\u6709\uff1a\n\n$$(a,b) \\times (c,d) = (ad+bc,5ac+bd)$$\n\n\u5bf9\u4e8e\u4e00\u5143\u8fd0\u7b97 $(a,b)^{-1}$\uff0c\u6709\uff1a\n\n$$(a,b)^{-1}=(\\frac{a}{5a^2-b^2}, -\\frac{b}{5a^2-b^2})$$\n\n\u5373\uff1a\n\n$$f_n=(\\frac{1}{10}, \\frac{1}{2}) \\times (\\frac{1}{2},\\frac{1}{2})^n+(-\\frac{1}{10}, \\frac{1}{2}) \\times (-\\frac{1}{2},\\frac{1}{2})^n$$\n\n\u4e3a\u4e86\u7b80\u4fbf\u8d77\u89c1\uff0c\u8bb0 $f_n=ax_0^n+bx_1^n$\n\n\u90a3\u4e48\u73b0\u5728\u53ea\u9700\u8981\u6c42\uff1a\n\n$$\\sum_{i=1}^{n} f_i^k$$\n\n\u4e5f\u5c31\u662f\uff1a\n\n$$\\begin{aligned} &\\sum_{i=1}^{n} \\sum_{j=0}^{k} {k \\choose j} (ax_0^i)^j (bx_1^i)^{k-j} \\\\ =&\\sum_{j=0}^{k} {k \\choose j} \\sum_{i=1}^{n} a^j(x_0^j)^i b^{k-j}(x_1^{k-j})^i \\\\ =&\\sum_{j=0}^{k} {k \\choose j} a^jb^{k-j}\\sum_{i=1}^{n} (x_0^jx_1^{k-j})^i \\\\ \\end{aligned}$$\n\n\u901a\u8fc7\u7b49\u6bd4\u6570\u5217\u6c42\u548c\uff0c\u6709\uff1a\n\n$$\\sum_{i=1}^{n} (a,b)^i=\\frac{(a,b)^{n+1}-(a,b)}{(a,b)-(0,1)}$$\n\n\u524d\u534a\u90e8\u5206\u7ed3\u675f\u4e86\n\n---\n\n\u5bf9\u4e8e\u540e\u534a\u90e8\u5206\uff0c\u663e\u7136\u6709\uff1a\n\n$$\\begin{cases} f_{2n}= f_{2n-2} + 2 \\sum_i f_{2n-2i} \\\\ f_{2n+1}=0 \\end{cases}$$\n\n\u8bbe $h_n=f_{2n}$\uff0c\u5219\uff1a\n\n$$\\begin{aligned} & \\begin{cases} h_n=h_{n-1}+2\\sum_{i}h_{n-i} \\\\ h_{n+1}=h_{n}+2\\sum_{i}h_{n+1-i}=h_{n}+2h_{n}+2\\sum_{i}h_{n-i} \\\\ \\end{cases} \\\\ \\Rightarrow & h_{n}-h_{n+1}=h_{n-1}-3h_{n} \\\\ \\Rightarrow & h_{n+1}=4h_{n}-h_{n-1} \\\\ \\Rightarrow & h_{n}=4h_{n-1}-h_{n-2} \\end{aligned}$$\n\n\u5373\uff1a\n\n$$\\begin{cases} h_0=1 \\\\ h_1=3 \\\\ h_n=4h_{n-1}-h_{n-2} \\end{cases}$$\n\n\u5bf9\u4e8e\u65b9\u7a0b $x^2=4x-1$\uff0c\u6709\u6839 $x=2 \\pm \\sqrt{3}$\n\n\u5373\uff1a\n\n$$h_n=ax_0^n+bx_1^n$$\n\n\u89e3\u5f97\uff1a\n\n$$\\begin{cases} a=\\frac{3+\\sqrt{3}}{6} \\\\ b=\\frac{3-\\sqrt{3}}{6} \\end{cases}$$\n\n\u5373\uff1a\n\n$$h_n=\\frac{3+\\sqrt{3}}{6} (2+\\sqrt{3})^n+\\frac{3-\\sqrt{3}}{6}(2-\\sqrt{3})^n$$\n\n\u4e0d\u59a8\u8bbe $h_n=ax_0^n+bx_1^n$\n\n\u5373\uff1a\n\n$$f_n=[2|n] \\left( ax_0^{\\frac{n}{2}} + bx_1^{\\frac{n}{2}} \\right)$$\n\n\u76ee\u6807\u662f\u8981\u6c42\uff1a\n\n$$\\frac{1}{k!}\\sum_{j=0}^{k} \\begin{bmatrix}k\\\\j \\end{bmatrix} (-1)^{k-j} \\sum_{i=l}^{r} f_i^j$$\n\n\u4e5f\u5c31\u662f\u6c42\uff1a\n\n$$\\sum_{i=1}^{n} f_{i}^{j}=\\sum_{i=1}^{n}[2|n]f_i^j=\\sum_{i=1}^{\\lfloor \\frac{n}{2} \\rfloor} h_i^j$$\n\n\u548c\u7b2c\u4e00\u95ee\u7684\u505a\u6cd5\u4e00\u6837\n\n---\n\n\u5e0c\u671b\u4ee5\u540e\u4e0d\u4f1a\u9047\u5230\u8fd9\u79cd\u5f3a\u884c\u591a\u5408\u4e00\u7684\u51fa\u9898\u4eba\u2026\u2026",
        "postTime": 1555820549,
        "uid": 47111,
        "name": "nekko",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P5320 \u3010[BJOI2019]\u52d8\u7834\u795e\u673a\u3011"
    },
    {
        "content": "### \u9898\u610f\u8fd9\u91cc\u4e0d\u518d\u8d58\u8ff0\n\n[P5320 [BJOI2019]\u52d8\u7834\u795e\u673a](https://www.luogu.com.cn/problem/P5320)\n\n### \u77e5\u8bc6\u70b9\n\n**\u6570\u5217\u7279\u5f81\u65b9\u7a0b\uff0c\u7b2c\u4e00\u7c7b\u65af\u7279\u6797\u6570\uff0c\u4e8c\u9879\u5f0f\u5b9a\u7406\uff0c\u6269\u5c55\u57df**\n\n### \u505a\u6cd5\u5206\u6790\n\n\u96be\u5ea6\u548c\u524d\u9762\u51e0\u9898\u5b8c\u5168\u4e0d\u662f\u4e00\u4e2a\u7ea7\u522b\u7684\u3002\n\n\u9996\u5148\u6211\u4eec\u5148\u8003\u8651\u7b2c\u4e00\u79cd\u60c5\u51b5\uff0c\u65e0\u8bba\u54ea\u79cd\u60c5\u51b5\u6211\u4eec\u90fd\u8bbe $F_i$ \u8868\u793a\u5171\u6709 $i$ \u5217\u4e00\u4e2a\u6838\u5fc3\u7684\u65b9\u6848\u6570\uff0c\u90a3\u5b9e\u9645\u4e0a\u5c31\u662f\u8ba9\u6211\u4eec\u6c42\uff1a$\\sum_{i=l}^r {{F_i}\\choose k}$\u3002\n\n\u9996\u5148\u53ef\u4ee5\u53d1\u73b0\u7b2c\u4e00\u79cd\u60c5\u51b5\u7684 $F_n$ \u5373\u662f\u6590\u6ce2\u90a3\u5951\u6570\u5217**\u7b2c $n+1$ \u9879**\uff0c\u6211\u4eec\u8fd9\u91cc\u9700\u8981\u6c42\u901a\u9879\u516c\u5f0f\u3002\n\n#### \u6590\u6ce2\u90a3\u5951\u6570\u5217\u901a\u9879\u516c\u5f0f\n\n\u9996\u5148\u6211\u4eec\u5047\u8bbe\u5b58\u5728 $z$ \u4f7f\u5f97 $z^n=z^{n-1}+z^{n-2}$\uff0c\u53ef\u4ee5\u53d1\u73b0\u8fd9\u6837 $z^n$ \u662f\u7b26\u5408\u6590\u6ce2\u90a3\u5951\u6570\u5217\u7684\u9012\u63a8\u5f0f\u7684\u3002\u90a3\u6211\u4eec\u89e3 $z^2=z+1$ \u5f97\u5230 $z_0=\\frac{1+\\sqrt 5}{2},z_1=\\frac{1-\\sqrt 5}{2}$\uff0c\u6b64\u65f6 $z^n$ \u6ee1\u8db3\u9012\u63a8\u516c\u5f0f\u4f46\u9996\u9879\u4e0d\u7b26\u5408\u8981\u6c42\u3002\u4f46\u6211\u4eec\u53ef\u4ee5\u8bc1\u660e\u5b58\u5728 $A,B$ \u4f7f\u5f97 $F_n=Az_0^n+Bz_1^n$\uff1a\n\n$$\nF_{n-1}+F_{n-2}=Az_0^n+Bz_1^n+Az_0^{n-1}+Bz_1^{n-1}\\\\\n=Az_0^{n-1}(z_0+1)+Bz_1^{n-1}(z_1+1)\n$$\n\n$$\n\\because z_0^2=z_0+1,z_1^2=z_1+1\\\\\n\\therefore F_{n-1}+F_{n-2}=Az_0^n+Bz_1^n=F_n\n$$\n\n\u4e8e\u662f\u5f97\u8bc1\uff0c\u5e26\u5165\u5f97\u5230 $A=\\frac{1}{\\sqrt 5},B=-\\frac{1}{\\sqrt 5}$\uff0c\u4e3a\u4e86\u65b9\u4fbf\u6211\u4eec\u628a\u7279\u5f81\u65b9\u7a0b\u8868\u793a\u4e3a $F_n=Ax^n+By^n$ \u7684\u5f62\u5f0f\uff0c\u5176\u4e2d $A=\\frac{1}{\\sqrt 5},B=-\\frac{1}{\\sqrt 5},x=\\frac{1+\\sqrt 5}{2},y=\\frac{1-\\sqrt 5}{2}$\u3002\n\n#### \u63a8\u5f0f\u5b50\u6c42\u89e3\n\n\u56e0\u4e3a $F_i=fab_{i+1}$ \u6240\u4ee5 $l,r$ \u5b9e\u9645\u4ee3\u8868 $l+1,r+1$\u3002\n\n$$\n=\\frac{1}{k!}\\sum_{i=l}^rF_i^{\\underline k}\n$$\n\n\u7136\u540e\u6839\u636e\u7b2c\u4e00\u7c7b\u65af\u7279\u6797\u6570 $S(n,m)=S(n-1,m-1)+(n-1)\\times S(n-1,m)$\uff0c\u6709\uff1a\n\n$$\nx^{\\underline k}=\\sum_{i=0}^k(-1)^{k-i}S(k,i)x^i\n$$\n\n\u7136\u540e\u5e26\u5165\u63a5\u7740\u63a8\uff1a\n\n$$\n=\\frac{1}{k!}\\sum_{i=l}^r\\sum_{j=0}^k(-1)^{k-j}S(k,j)F_i^j\\\\\n=\\frac{1}{k!}\\sum_{j=0}^k (-1)^{k-j}S(k,j)\\sum_{i=l}^rF_{i}^j\n$$\n\n\u7136\u540e\u4e3a\u4e86\u7528\u4e8c\u9879\u5f0f\u5b9a\u7406\u5c55\u5f00\u6700\u540e\u7684 $F_i^j$\uff0c\u6211\u4eec\u8bbe $G(j,l,r)=\\sum_{i=l}^r F_i^j$\uff0c\u5219\u6709:\n\n$$\nG(j,l,r)=\\sum_{i=l}^j\\sum_{k=0}^j {j\\choose k}A^kB^{j-k}(x^ky^{j-k})^i\\\\\n=\\sum_{k=0}^j {j\\choose k}A^kB^{j-k}\\sum_{i=l}^r (x^ky^{j-k})^i\n\n$$\n\n\n\u8fd9\u91cc\u6211\u4eec\u8bbe $H(x,l,r)=\\sum_{i=l}^r x^j=\\frac{x^{r+1}-x^l}{x-1}$\uff0c\u5173\u4e8e\u8fd9\u4e2a\u9664\u6cd5\u6c42\u9006\u5143\u53ef\u4ee5\u5148\u4e0a\u4e0b\u540c\u4e58\u5171\u8f6d\u8868\u8fbe\u5f0f\uff08\u5373\u5229\u7528\u5e73\u65b9\u5dee\u516c\u5f0f\uff09\u53bb\u6389\u5e26\u6839\u53f7\u7684\u9879\uff08\u5df2\u7ecf\u8fdb\u884c\u4e86\u6269\u5c55\u57df\u5904\u7406\uff0c\u6570\u90fd\u8868\u793a\u6210 $a+b\\sqrt 5$\u200b\uff09\u5c31\u53ef\u4ee5\u6c42\u89e3\uff0c\u4e8e\u662f\u6709\uff1a\n\n$$\nG(j,l,r)=\\sum_{k=0}^j{j\\choose k}A^kB^{j-k}H(x^ky^{j-k},l,r)\n\n$$\n\u7136\u540e\u5e26\u5165\u539f\u5f0f\u6709\uff1a\n\n$$\n=\\frac{1}{k!}\\sum_{j=0}^k(-1)^{k-j}S(k,j)G(j,l,r)\n\n$$\n\u4e8e\u662f\u5f97\u89e3\u3002\u8bb0\u5f97\u628a $l,r$ \u5206\u522b $+1$\uff0c\u7136\u540e\u8fd8\u8981\u4e58\u4e0a $\\frac{1}{r-l+1}$\u3002\n\n### \u7b2c\u4e8c\u90e8\u5206\n\n\u540c\u6837\u63a8\u5f0f\u5b50\uff0c\u53ef\u4ee5\u53d1\u73b0\u80fd\u51d1\u6210\u51e0\u4e2a\u6574\u5217\u7684\u72ec\u7acb\u60c5\u51b5\u6709\uff1a\n\n```\n--  --  ||  ----  ------ \n--  ||  ||  |--|  |----|\n--  ||  --  |--|  |----|\uff08\u53ca\u6700\u540e\u4e24\u79cd\u4e0a\u4e0b\u98a0\u5012\u4ee5\u53ca8,10,12,...\u5217\u7684\u60c5\u51b5\uff09\n```\n\n\u7136\u540e\u53ef\u4ee5\u53d1\u73b0\u5b8c\u6574\u7684\u5217\u5757\u5bbd\u5ea6\u90fd\u662f\u5076\u6570\uff0c\u90a3\u4e48\u6211\u4eec\u8bbe $F_i$ \u8868\u793a\u4e00\u5171 $2i$ \u5217\u7684\u65b9\u6848\u6570\uff0c\u90a3\u4e48\u9012\u63a8\u5f0f\u5b50\u662f\uff1a\n\n$$\nF_i=F_{i-1}+2\\sum_{j=1}^{i-1}F_{i-j},F_0=1,F_1=3\n$$\n\u7136\u540e\u8003\u8651\u548c $F_{i-1}$ \u7684\u5f0f\u5b50\u505a\u5dee\uff0c\u53ef\u4ee5\u5f97\u5230\uff1a\n$$\nF_i=4F_{i-1}-F_{i-2}\n$$\n\u7136\u540e\u4f9d\u65e7\u662f\u89e3\u7279\u5f81\u65b9\u7a0b\uff0c\u5f97\u5230\uff1a\n$$\nA=\\frac{3+\\sqrt 3}{6},x=2+\\sqrt 3,B=\\frac{3-\\sqrt 3}{6},y=2-\\sqrt 3\n$$\n\u4e8e\u662f\u50cf\u539f\u6765\u90a3\u6837\u6c42\u89e3\u5c31\u53ef\u4ee5\u4e86\u3002\n\n### \u6ce8\u610f\n\n\u7b49\u6bd4\u6570\u5217\u6c42\u548c\u9700\u8981\u5224\u516c\u6bd4\u4e3a $1$ \u7684\u60c5\u51b5\uff01\uff01\u5426\u5219\u76f4\u63a5\u53d8\u6210 $\\frac{0}{0}$\u200b \u5c31\u70b8\u4e86\u3002\n\n### \u8d34\u4ee3\u7801\n\n\u56e0\u4e3a\u5b9a\u4e49\u51fd\u6570\u6bd4\u8f83\u591a\u6240\u4ee5\u5c01\u88c5\u6027\u5e94\u8be5\u4e0d\u9519\uff1f\n\n```cpp\n#include <bits/stdc++.h>\n#define lint long long\nusing namespace std;\ninline lint read(){\n\tchar c;lint f=1,res=0;\n\twhile(c=getchar(),!isdigit(c))if(c=='-')f=-f;\n\twhile(isdigit(c))res=res*10+c-'0',c=getchar();\n\treturn res*f;\n}\nconst lint md=998244353;\nlint sq;\nstruct ex{//\u6269\u5c55\u57df \n\tlint a,b;\n\tex(lint _a=0,lint _b=0)\n\t\t{a=(_a%md+md)%md;b=(_b%md+md)%md;}\n};\ninline ex operator+(ex x,ex y)\n\t{return ex(x.a+y.a,x.b+y.b);}\ninline ex operator-(ex x,ex y)\n\t{return ex(x.a-y.a,x.b-y.b);}\ninline ex operator*(ex x,ex y)\n\t{return ex(x.a*y.a%md+sq*x.b*y.b%md,x.a*y.b%md+x.b*y.a%md);}\ninline ex qpow(ex x,lint y){\n\tex res=ex(1,0);\n\twhile(y){\n\t\tif(y&1)res=res*x;\n\t\tx=x*x;y>>=1;\n\t}return res;\n}\ninline ex operator/(ex x,ex y){\n\tex z=ex(y.a,-y.b);x=x*z;\n\treturn x*qpow(y*z,md-2);\n}\nconst int K=605;\nex s[K][K],c[K][K],fac[K],ifac[K];\ninline void calc(){//\u9884\u5904\u7406C,S,fac,ifac \n\ts[0][0]=c[0][0]=ex(1,0);\n\tfac[0]=ifac[0]=ex(1,0);\n\tfor(int i=1;i<K;++i){\n\t\tfor(int j=1;j<=i;++j)\n\t\t\ts[i][j]=s[i-1][j-1]+s[i-1][j]*ex(i-1,0);\n\t\tc[i][0]=c[i][i]=ex(1,0);\n\t\tfor(int j=1;j<i;++j)\n\t\t\tc[i][j]=c[i-1][j-1]+c[i-1][j];\n\t\tfac[i]=fac[i-1]*ex(i,0);\n\t\tifac[i]=qpow(fac[i],md-2);\n\t}\n}\nex A,B,x,y;\ninline void init(int m){//\u9884\u8bbe \n\tif(m==2){sq=5;\n\t\tA=ex(1,0)/ex(0,1);\n\t\tB=ex(-1,0)/ex(0,1);\n\t\tx=ex(1,1)/ex(2,0);\n\t\ty=ex(1,-1)/ex(2,0);\n\t}else{sq=3;\n\t\tA=ex(3,1)/ex(6,0);\n\t\tB=ex(3,-1)/ex(6,0);\n\t\tx=ex(2,1);y=ex(2,-1);\n\t}\n}\n//\u51fd\u6570\u5b9a\u4e49\u8be6\u89c1\u9898\u89e3 \ninline ex S(int i,int j){return s[i][j];}\ninline ex C(int i,int j){return c[i][j];}\ninline ex H(ex x,lint l,lint r){\n\tif(x.a==1&&x.b==0)\n\t\treturn ex(r-l+1,0);\n\tex res=qpow(x,r+1);\n\tres=res-qpow(x,l);\n\treturn res/(x-ex(1,0));\n}\ninline ex G(int j,lint l,lint r){\n\tex res;\n\tfor(int k=0;k<=j;++k){\n\t\tex upd=C(j,k)*qpow(A,k)*qpow(B,j-k);\n\t\tupd=upd*H(qpow(x,k)*qpow(y,j-k),l,r);\n\t\tres=res+upd;\n\t}return res;\n}\ninline lint solve(int m,int k,lint l,lint r){\n\tinit(m);ex res;\n\tlint _l=l,_r=r;\n\tif(m==2)++l,++r;\n\telse l=(l+1)/2,r/=2;\n\tfor(int j=0;j<=k;++j){\n\t\tex upd=ex((k-j&1)?-1:1,0);\n\t\tupd=upd*S(k,j)*G(j,l,r);\n\t\tres=res+upd;\n\t}\n\tres=res/ex(_r-_l+1,0);\n\treturn (res*ifac[k]).a;\n}\nint T,m;\nint main(){\n\tcalc();\n\tT=read();m=read();\n\twhile(T--){\n\t\tlint l=read(),r=read();\n\t\tint k=read();\n\t\tprintf(\"%lld\\n\",solve(m,k,l,r));\n\t}\n\treturn 0;\n}\n```\n\n\n\n",
        "postTime": 1638535713,
        "uid": 206258,
        "name": "SDNetFriend",
        "ccfLevel": 7,
        "title": "P5320 [BJOI2019]\u52d8\u7834\u795e\u673a \u9898\u89e3"
    }
]