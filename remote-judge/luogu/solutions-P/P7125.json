[
    {
        "content": "$5\\times 10^5$ \u5df2\u6210\u4e3a\u5e38\u89c1\u7684\u6839\u53f7\u590d\u6742\u5ea6\u8303\u56f4.jpg\n\n\u672c\u9898\u53ef\u4ee5\u5206\u4e3a\u4e24\u4e2a\u90e8\u5206\uff0c\u4e0b\u9762\u5206\u522b\u5bf9\u5176\u5206\u6790\u3002\n\n- \u7b2c\u4e00\u90e8\u5206\uff08\u9884\u5904\u7406\uff09\n\n  \u6211\u4eec\u5bf9\u6bcf\u4e2a\u4e0d\u540c\u7684\u6570\u503c\u8fdb\u884c\u8003\u8651\u3002\u8003\u8651\u5f53\u524d\u7684\u6570\u4e3a $v$\uff0c\u5b83\u7684\u51fa\u73b0\u6b21\u6570\u4e3a $c$\u3002\n\n  \u7531\u4e8e $v$ \u80fd\u4ea7\u751f\u8d21\u732e\u7684\u533a\u95f4\u7684\u4e2d\u70b9\u4f4d\u7f6e\u5fc5\u987b\u662f $v$\uff0c\u56e0\u6b64\u6211\u4eec\u8003\u8651\u679a\u4e3e\u4e24\u4e2a\u7aef\u70b9\u5230\u4e2d\u70b9\u7684\u8ddd\u79bb $L$\u3002$v$ \u5728\u533a\u95f4\u7684\u51fa\u73b0\u6b21\u6570\u663e\u7136\u968f\u7740 $L$ \u7684\u589e\u5927\u800c\u5355\u8c03\u4e0d\u964d\uff0c\u4e14\u51fa\u73b0\u6b21\u6570\u4e3a $0\\sim c$\u3002\n\n  \u6211\u4eec\u518d\u5bf9 $v$ \u7684\u6bcf\u4e2a\u4e0d\u540c\u7684\u51fa\u73b0\u6b21\u6570\u8fdb\u884c\u8003\u8651\u3002\u5bf9\u4e8e $v$ \u51fa\u73b0\u4e86 $i$ \u6b21\uff0c\u5b83\u5bf9\u5e94\u7684 $L$ \u662f\u8fde\u7eed\u7684\uff0c\u8bbe\u4e3a\u533a\u95f4 $[l,r]$\u3002\u6211\u4eec\u53ef\u4ee5\u627e\u5230\u4e00\u4e2a $m\\in[l-1,r]$ \u6ee1\u8db3\u5f53 $L\\in[l,m]$ \u65f6\uff0c$v$ \u662f\u533a\u95f4\u7684\u4f17\u6570\uff0c\u800c\u5f53 $L\\in[m+1,r]$ \u65f6\uff0c$v$ \u4e0d\u662f\u533a\u95f4\u7684\u4f17\u6570\u3002\u8bc1\u660e\u5f88\u7b80\u5355\uff0c\u8fd9\u91cc\u7565\u53bb\u3002\n\n  \u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e8c\u5206\u6765\u627e\u5230\u8fd9\u4e2a $m$ \u7684\u503c\uff0c\u4ece\u800c\u80fd\u5f97\u51fa\u6240\u6709\u80fd\u4ea7\u751f\u8d21\u732e\u7684 $L$ \u7684\u8303\u56f4\u3002\u7531\u4e8e\u603b\u5171\u6709 $c$ \u4e2a\u4e0d\u540c\u7684\u51fa\u73b0\u6b21\u6570\uff08$0$ \u6b21\u4e0d\u53ef\u80fd\u6210\u4e3a\u4f17\u6570\uff0c\u6545\u7565\u53bb\uff09\uff0c\u56e0\u6b64\u53ef\u4ee5\u5f97\u5230 $c$ \u4e2a\u4e92\u4e0d\u76f8\u4ea4\u7684\u8303\u56f4\u3002\n\n  \u7531\u4e8e\u4e8c\u5206\u7684\u65f6\u5019\u8fd8\u9700\u8981\u6c42\u533a\u95f4\u4f17\u6570\uff0c\u56e0\u6b64\u5bf9\u4e8e\u4e00\u4e2a $v$\uff0c\u6c42\u5b83\u7684 $L$ \u7684\u8303\u56f4\u9700\u8981 $O(c\\sqrt n\\log n)$ \u6216 $O(c\\sqrt{n\\log n})$ \u7684\u65f6\u95f4\u590d\u6742\u5ea6\u3002\u800c\u6240\u6709\u7684 $v$ \u7684 $c_v$ \u7684\u548c\u4e3a $n$\uff0c\u56e0\u6b64\u8fd9\u90e8\u5206\u7684\u603b\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n\\sqrt n\\log n)$ \u6216 $O(n\\sqrt{n\\log n})$\u3002\u8fd9\u4e2a\u590d\u6742\u5ea6\u8fd8\u4e0d\u80fd\u63a5\u53d7\u3002\n\n  ---\n\n  \u8003\u8651\u4f18\u5316\u4e0a\u8ff0\u8fc7\u7a0b\u3002\n\n  \u5bb9\u6613\u53d1\u73b0\uff0c$c_v\\gt \\sqrt n$ \u7684\u4e0d\u540c\u7684 $v$ \u6700\u591a\u6709 $\\sqrt n$ \u4e2a\uff0c\u8fd9\u90e8\u5206\u6211\u4eec\u53ef\u4ee5\u66b4\u529b\u679a\u4e3e $L$ \u5e76\u8fdb\u884c\u5224\u65ad\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\sqrt n)$\uff08\u8bb0\u5f97\u628a\u8fde\u7eed\u7684 $L$ \u5e76\u6210\u4e00\u4e2a\u533a\u95f4\uff0c\u5426\u5219\u7a7a\u95f4\u590d\u6742\u5ea6\u5c06\u4e3a $O(n\\sqrt n)$\uff09\u3002\n\n  \u800c\u5bf9\u4e8e $c_v\\leq \\sqrt n$ \u7684\u6240\u6709 $v$\uff0c\u6211\u4eec\u4e0d\u59a8\u8003\u8651\u679a\u4e3e\u4f17\u6570\u7684\u51fa\u73b0\u6b21\u6570\u3002\n\n  \u5047\u8bbe\u5f53\u524d\u4f17\u6570\u7684\u51fa\u73b0\u6b21\u6570\u4e3a $(k-1)$\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 $O(n)$ \u5185\u6c42\u51fa $p_{1..n}$\uff0c\u5176\u4e2d $p_i$ \u8868\u793a\u6700\u5c0f\u7684\u6ee1\u8db3 $[i,j]$ \u7684\u533a\u95f4\u4f17\u6570\u51fa\u73b0\u6b21\u6570\u4e3a $k$ \u7684 $j$\u3002\n\n  \u4ee5\u4e0b\u662f\u6c42\u6570\u7ec4 $p$ \u7684\u65b9\u6cd5\uff1a\n\n  > \u53ef\u4ee5\u8bc1\u660e $a_{p_i}$ \u662f\u533a\u95f4 $[i,p_i]$ \u7684**\u552f\u4e00**\u4f17\u6570\uff0c\u5426\u5219 $[i,p_i-1]$ \u7684\u4f17\u6570\u7684\u51fa\u73b0\u6b21\u6570\u4e5f\u4e3a $k$\u3002\n  >\n  > \u540c\u7406\uff0c\u82e5 $a_i\\neq a_{p_i}$\uff0c\u5219 $[i+1,p_i]$ \u7684\u4f17\u6570\u7684\u51fa\u73b0\u6b21\u6570\u4e5f\u4e3a $k$\u3002\n  >\n  > \u6211\u4eec\u5bf9\u4e00\u4e2a $[i,p_i]$ \u7684\u5de6\u7aef\u70b9\u4e0d\u65ad\u6309\u6b64\u6cd5\u5411\u53f3\u79fb\u52a8\uff0c\u5f97\u5230\u7684 $[j,p_i]$ \u4f1a\u6ee1\u8db3 $a_j=a_{p_i}$\uff0c\u5373 $p_i$ \u662f\u4f4d\u7f6e $j$ \u4e4b\u540e\u7b2c $(k-1)$ \u4e2a $a_j$\u3002\n  >\n  > \u8003\u8651\u4ee4 $q_i$ \u8868\u793a $i$ \u4e4b\u540e\u7b2c $(k-1)$ \u4e2a $a_i$ \u7684\u51fa\u73b0\u4f4d\u7f6e\uff0c\u90a3\u4e48\u5bf9\u4e8e\u4e00\u4e2a $i$\uff0c\u5c31\u6709 $p_i=\\min_{j>i} q_j$\u3002\n  >\n  > \u4e5f\u5c31\u662f\u8bf4 $p_i$ \u662f $q_i$ \u7684\u540e\u7f00 $\\min$ \u6570\u7ec4\u3002\n  >\n  > \u7528 vector \u6309\u987a\u5e8f\u5b58\u6bcf\u4e2a\u6570\u503c\u7684\u51fa\u73b0\u4f4d\u7f6e\uff0c\u7136\u540e\u518d\u5bf9\u6bcf\u4e2a\u4f4d\u7f6e\u8bb0\u4e00\u4e0b\u5b83\u5728 vector \u91cc\u7684\u4e0b\u6807\uff0c\u5c31\u53ef\u4ee5 $O(1)$ \u5f97\u5230\u5355\u4e2a $q_i$\u3002\n  >\n  > \u90a3\u4e48\u8fd9\u90e8\u5206\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n)$\u3002\n\n  \u679a\u4e3e\u53ef\u80fd\u7684\u6570\u503c $v$\uff0c\u5e76\u53d6\u51fa $l,r$ \u6ee1\u8db3\u5f53\u4e14\u4ec5\u5f53 $L\\in[l,r]$ \u65f6\uff0c$v$ \u7684\u51fa\u73b0\u6b21\u6570\u6070\u597d\u4e3a $k$\u3002\n\n  \u6211\u4eec\u5728\u4e0a\u9762\u63d0\u5230\u4e86\u4e8c\u5206\u8fd9\u4e2a $m$\uff0c\u5728\u4e8c\u5206\u7684\u65f6\u5019\uff0c\u6211\u4eec\u9700\u8981\u5224\u65ad\u7684\u5176\u5b9e\u662f\uff0c\u662f\u5426\u5b58\u5728\u4e00\u4e2a\u533a\u95f4 $[s,t]\\in[v-m,v+m]$ \u6ee1\u8db3 $[s,t]$ \u7684\u533a\u95f4\u4f17\u6570\u5927\u4e8e\u7b49\u4e8e $k$\u3002\u800c\u6211\u4eec\u53ea\u9700\u8981\u5bf9\u6240\u6709\u7684 $i\\in[v-m,v+m]$ \u68c0\u67e5\uff1a\u6ee1\u8db3 $[i,j]$ \u7684\u4f17\u6570\u51fa\u73b0\u6b21\u6570\u6070\u597d\u4e3a $k$ \u7684\u6700\u5c0f\u7684 $j$ \u662f\u5426\u5927\u4e8e $v+m$\uff0c\u8fd9\u4e2a $j$ \u5c31\u662f\u4e0a\u9762\u6211\u4eec\u6c42\u51fa\u7684 $p_i$\u3002\u800c\u7531\u4e8e $p_i$ \u5177\u6709\u5355\u8c03\u6027\uff0c\u56e0\u6b64\u6211\u4eec\u53ea\u9700\u8981\u68c0\u67e5 $p_{v-m}$ \u662f\u5426\u5927\u4e8e $v+m$ \u5373\u53ef\u3002\u56e0\u6b64\u5355\u6b21\u68c0\u9a8c\u662f $O(1)$ \u7684\uff0c\u4e00\u6b21\u4e8c\u5206\u7684\u590d\u6742\u5ea6\u5c31\u662f $O(\\log n)$\u3002\n\n  \u7531\u4e8e\u6240\u6709\u7684 $v$ \u7684 $c_v$ \u603b\u548c\u4e3a $n$\uff0c\u56e0\u6b64\u8fd9\u91cc\u7684\u4e8c\u5206\u7684\u6b21\u6570\u4e0d\u4f1a\u8d85\u8fc7 $n$ \u6b21\uff0c\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n\\log n)$\u3002\n\n  \u800c\u6211\u4eec\u9700\u8981\u5bf9\u6bcf\u4e2a $k\\leq \\sqrt n$ \u8ba1\u7b97\u5bf9\u5e94\u7684 $p$ \u6570\u7ec4\uff0c\u56e0\u6b64\u8fd9\u90e8\u5206\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u662f $O(n\\sqrt n)$\u3002\n\n- \u7b2c\u4e8c\u90e8\u5206\uff08\u56de\u7b54\u8be2\u95ee\uff09\u3002\n\n  \u6211\u4eec\u63a5\u4e0b\u6765\u9700\u8981\u89e3\u51b3\u7684\u95ee\u9898\u5982\u4e0b\uff1a\n\n  > \u7ed9\u5b9a\u4e0d\u8d85\u8fc7 $n$ \u4e2a\u4e09\u5143\u7ec4 $(v,x,y)$ \u6ee1\u8db3 $x\\leq y$\u3002\u5bf9\u6bcf\u4e2a\u4e09\u5143\u7ec4\uff0c\u679a\u4e3e $i\\in[x,y]$\uff0c\u5e76\u4ee4 $A_{v-i,v+i}$ \u589e\u52a0 $1$\u3002\n  >\n  > $m$ \u6b21\u8be2\u95ee\uff0c\u6bcf\u6b21\u7ed9\u5b9a $l,r$\uff0c\u6c42 $\\sum\\limits_{i=l}^r\\sum\\limits_{j=l}^r A_{i,j}$ \u7684\u503c\u3002\n\n  \u8fd9\u4e2a\u95ee\u9898\u6709\u591a\u79cd\u505a\u6cd5\uff0c\u8fd9\u91cc\u4ecb\u7ecd\u4e00\u79cd\u8f83\u65b9\u4fbf\u4e14\u5bb9\u6613\u7406\u89e3\u7684\u505a\u6cd5\uff08\u611f\u8c22 memset0 \u63d0\u4f9b\u4e86\u8be5\u505a\u6cd5\u7684\u601d\u8def\uff09\u3002\n\n  \u4e0a\u9762\u8fd9\u4e2a\u4e8c\u7ef4\u7684\u95ee\u9898\u662f\u6bd4\u8f83\u5bb9\u6613\u60f3\u5230\u7684\u8f6c\u5316\u540e\u7684\u9898\u610f\uff0c\u4e0d\u8fc7\u6211\u4eec\u8fd8\u662f\u76f4\u63a5\u8ba8\u8bba\u4e00\u4e2a\u4e09\u5143\u7ec4 $(v,x,y)$ \u5bf9 $l,r$ \u7684\u8d21\u732e\u3002\n\n  \u4ee4 $a$ \u4e3a $[v-y,v-x]\\cap[l,r]$ \u7684\u957f\u5ea6\uff0c$b$ \u4e3a $[v+x,v+y]\\cap[l,r]$ \u7684\u957f\u5ea6\uff0c\u5219\u8d21\u732e\u4e3a $\\min(a,b)$\u3002\n\n  \u4ee4 $mid=\\lfloor\\frac{l+r}2\\rfloor$\uff0c\u53ef\u4ee5\u53d1\u73b0\uff0c\u5f53 $mid\\leq v$ \u65f6\uff0c\u603b\u6709 $a\\geq b$\uff0c\u5f53 $mid\\gt v$ \u65f6\uff0c\u603b\u6709 $a\\lt b$\u3002\n\n  \u90a3\u4e48\u6211\u4eec\u5bf9 $mid\\leq v$ \u548c $mid\\gt v$ \u4e24\u79cd\u60c5\u51b5\u5206\u5f00\u7edf\u8ba1\u8d21\u732e\u5373\u53ef\u3002\u6bcf\u79cd\u60c5\u51b5\u90fd\u662f\u4e00\u4e2a\u7b80\u5355\u7684**\u4e8c\u7ef4\u6570\u70b9**\u95ee\u9898\uff0c\u4f7f\u7528\u79bb\u7ebf\u6811\u72b6\u6570\u7ec4\u89e3\u51b3\u5373\u53ef\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $O((n+m)\\log n)$\uff0c\u7a7a\u95f4\u590d\u6742\u5ea6 $O(n+m)$\u3002\n\n\u7efc\u4e0a\uff0c\u7b97\u6cd5\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n\\sqrt n+m\\log n)$\uff0c\u7a7a\u95f4\u590d\u6742\u5ea6\u4e3a $O(n+m)$\uff0c\u53ef\u4ee5\u901a\u8fc7\u672c\u9898\u3002",
        "postTime": 1609751616,
        "uid": 6813,
        "name": "mrsrz",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P7125 \u3010[Ynoi2008] rsmemq\u3011"
    },
    {
        "content": "## Section 1\n\u8003\u8651\u4ece\u6bcf\u4e2a\u4e2d\u5fc3\u62d3\u5c55\u51fa\u53bb\uff0c\u6c42\u51fa\u6bcf\u4e2a\u53ef\u884c\u533a\u95f4\u3002\n\n\u6bd4\u5982 $\\{2,6,5,2,5,2,3,7,2\\}$\uff0c\u6211\u4eec\u4ece\u4e2d\u95f4\u7684 $5$ \u5f00\u59cb\u5411\u5916\u62d3\u5c55\u3002\n\n\u62d3\u5c55\u5230 $[5,5]$\uff0c\u5f53\u524d\u6570\u51fa\u73b0\u6b21\u6570\u4e3a $1$\uff0c\u4f17\u6570\u51fa\u73b0\u6b21\u6570\u4e3a $1$\uff0c\u5408\u6cd5\u3002  \n\u62d3\u5c55\u5230 $[4,6]$\uff0c\u5f53\u524d\u6570\u51fa\u73b0\u6b21\u6570\u4e3a $1$\uff0c\u4f17\u6570\u51fa\u73b0\u6b21\u6570\u4e3a $2$\uff0c\u4e0d\u5408\u6cd5\u3002  \n\u62d3\u5c55\u5230 $[3,7]$\uff0c\u5f53\u524d\u6570\u51fa\u73b0\u6b21\u6570\u4e3a $2$\uff0c\u4f17\u6570\u51fa\u73b0\u6b21\u6570\u4e3a $2$\uff0c\u5408\u6cd5\u3002  \n\u62d3\u5c55\u5230 $[2,8]$\uff0c\u5f53\u524d\u6570\u51fa\u73b0\u6b21\u6570\u4e3a $2$\uff0c\u4f17\u6570\u51fa\u73b0\u6b21\u6570\u4e3a $2$\uff0c\u5408\u6cd5\u3002  \n\u62d3\u5c55\u5230 $[1,9]$\uff0c\u5f53\u524d\u6570\u51fa\u73b0\u6b21\u6570\u4e3a $2$\uff0c\u4f17\u6570\u51fa\u73b0\u6b21\u6570\u4e3a $4$\uff0c\u4e0d\u5408\u6cd5\u3002\n\n\u4e0d\u96be\u53d1\u73b0\uff0c\u5408\u6cd5\u7684\u533a\u95f4\u4f1a\u8fde\u6210\u82e5\u5e72\u6bb5\uff0c\u5176\u4e2d\u6bcf\u6bb5**\u5f53\u524d\u6570\u51fa\u73b0\u6b21\u6570**\u7b49\u4e8e**\u4f17\u6570\u6700\u5927\u51fa\u73b0\u6b21\u6570**\u3002\u800c\u6bcf\u4e2a\u6570\u7684\u51fa\u73b0\u6b21\u6570\u52a0\u8d77\u6765\u53ea\u6709 $n$\uff0c\u56e0\u6b64\u53ea\u6709 $n$ \u6bb5\u533a\u95f4\u3002\n\n\u56e0\u6b64\uff0c\u6211\u4eec\u6709\u4e00\u4e2a Naive \u7684\u60f3\u6cd5\uff1a\u5bf9\u4e8e\u6bcf\u4e2a\u533a\u95f4\uff0c\u7528 vector \u627e\u6bcf\u4e00\u6bb5\u8d77\u70b9\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $O(1)$\uff0c\u4e8c\u5206\u533a\u95f4\u4f17\u6570\u4f7f\u7528\u5206\u5757\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $O(\\sqrt{n\\log n})$\uff0c\u603b\u590d\u6742\u5ea6 $O(n\\sqrt{n\\log n})$\uff0c\u88ab lxl \u5361\u4e86\u3002\n\n\u8003\u8651\u6839\u53f7\u5206\u6cbb\u3002\n\n\u5bf9\u4e8e\u51fa\u73b0\u6b21\u6570 $\\geq\\sqrt n$ \u7684\u6570\uff0c\u66b4\u529b\u679a\u4e3e\u533a\u95f4\uff0c\u590d\u6742\u5ea6\u5355\u6b21 $n$\uff0c\u603b\u590d\u6742\u5ea6 $O(n\\sqrt n)$\u3002\n\n\u5bf9\u4e8e\u51fa\u73b0\u6b21\u6570 $<\\sqrt n$ \u7684\u6570\uff0c\u6211\u4eec\u9700\u8981\u5bf9\u4e8e\u6bcf\u4e2a $i$ \u627e\u5230\u6bcf\u4e2a\u533a\u95f4**\u4f17\u6570\u51fa\u73b0\u6b21\u6570 $\\leq1,2,\\cdots,\\sqrt n$ \u7684\u6700\u5927\u533a\u95f4**\uff08\u56e0\u4e3a\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\u6700\u5c0f\u533a\u95f4\u4e86\uff09\u3002\n\n\u8fd9\u4e2a\u7ef4\u62a4\u7684\u65b9\u6cd5\u5176\u5b9e\u5f88 trival\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06 $i$ \u7684\u72b6\u6001\u4ece $i-1$ \u8fdb\u884c\u8f6c\u79fb\u3002\u5bf9\u4e8e\u6bcf\u4e2a\u51fa\u73b0\u6b21\u6570\uff0c\u663e\u7136\u590d\u6742\u5ea6\u4e3a $O(n)$\uff0c\u56e0\u6b64\u603b\u590d\u6742\u5ea6\u4e3a $O(n\\sqrt n)$\u3002\n## Section 2\n\u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u6c42\u51fa\u6240\u6709\u51fa\u73b0\u6b21\u6570\u4e86\uff0c\u9700\u8981\u56de\u7b54\u8be2\u95ee\u3002\n\n\u6211\u4eec\u8003\u8651\u5bf9\u4e8e\u6bcf\u4e2a\u4e2d\u5fc3\u6c42\u7b54\u6848\u3002\n\n\u4ece\u4e0a\u9762\u7684\u7ed3\u8bba\u4e2d\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\uff0c\u6bcf\u4e2a\u6570\u80fd\u6269\u5c55\u5c55\u51fa\u6765\u7684\u957f\u5ea6\u96c6\u5408\u53ef\u4ee5\u7528\u4e00\u4e9b\u533a\u95f4\u8868\u793a\uff0c\u533a\u95f4\u603b\u6570 $\\leq n$\u3002\n\n\u8003\u8651\u8be2\u95ee $[l,r]$ \u65f6\uff0c\u6700\u591a\u80fd\u4ece $x$ \u6269\u5c55\u591a\u957f\uff0c\u663e\u7136\u6700\u957f\u6269\u5c55\u957f\u5ea6\u4e3a $\\min(x-l,r-x)$\u3002\n\n\u4e0d\u96be\u53d1\u73b0\uff0c$\\min(x-l,r-x)$ \u662f\u4e2a\u5355\u5cf0\u51fd\u6570\uff0c\u659c\u7387\u4e3a $-1$ \u6216\u8005 $1$\u3002\n\n\u56e0\u6b64\uff0c\u6211\u4eec\u4e8b\u5b9e\u4e0a\u8981\u5728 $n$ \u6761\u7ea2\u8272\u7ebf\u6bb5\u4e2d\uff0c\u6570\u8fd9\u6761\u7eff\u8272\u7ebf\u6bb5\u4e0b\u65b9\u7ea2\u8272\u7ebf\u6bb5\u7684\u603b\u957f\u3002\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/ffsghibp.png)\n\n\uff08\u5907\u6ce8\uff1a\u56fe\u662f\u4ece THUPC \u8bb2\u8bc4 PPT \u8d3a\u7684\uff0c\u5e0c\u671b\u6ca1\u6709\u7248\u6743\u95ee\u9898\uff09\n\n\u8fd9\u4e2a\u95ee\u9898\u6bd4\u8f83 Trival\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u4e0a\u5347\u7684\u90a3\u6bb5\u548c\u4e0b\u964d\u7684\u90a3\u6bb5\u5206\u522b\u8ba1\u7b97\u3002\u6bcf\u4e00\u6bb5\u5fc5\u7136\u5305\u62ec\u4e86\u4e00\u4e9b\u5b8c\u5168\u5305\u542b\u7684\u7ebf\u6bb5\u548c\u4e00\u4e9b\u6ca1\u6709\u5b8c\u5168\u5305\u542b\u7684\u7ebf\u6bb5\u3002\n\n\u663e\u7136\u4e24\u79cd\u7ebf\u6bb5\u7684\u957f\u5ea6\u662f\u53ef\u4ee5\u8f7b\u677e\u8ba1\u7b97\u7684\uff0c\u8fd9\u91cc\u4e0d\u518d\u8d58\u8ff0\u3002\n\n\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u5728 $O(n\\sqrt n+m\\log n)$ \u7684\u65f6\u95f4\u5185\u89e3\u51b3\u95ee\u9898\u3002\n## Section 3\n\u5199\u5b8c\u4e86\u53d1\u73b0 TLE \u4e86\u4e00\u70b9\u70b9\uff0c\u8003\u8651\u5361\u5e38\u3002\n\n\u7136\u540e\u53d1\u73b0\u80fd\u8c03\u7684\u53ea\u6709\u5757\u957f\u4e86\uff08\u60b2\uff09\u3002\n\n\u7136\u540e\u53d1\u73b0\u8003\u8651\u5c06\u4e00\u4e9b\u6570\u9012\u63a8\uff0c\u5269\u4e0b\u7684\u66b4\u529b\uff0c\u6211\u4eec\u80fd\u5f97\u5230\u5927\u81f4\u7684\u8fd0\u7b97\u6b21\u6570\u3002\n\n\u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u52a8\u6001\u8c03\u5757\u957f\uff0c\u4e8e\u662f\u5c31\u80fd\u8fc7\u4e86\u3002\n## Code\n```cpp\n#pragma GCC target(\"sse,sse2,sse3,ssse3,sse4,popcnt,abm,mmx,avx,avx2,tune=native\")\n#include<bits/stdc++.h>\n#define ll long long\nusing namespace std;\nchar buf[1<<21],*p1=buf,*p2=buf,obuf[1<<23],*O=obuf;\n#define getchar() (p1==p2&&(p2=(p1=buf)+fread(buf,1,1<<21,stdin),p1==p2)?EOF:*p1++)\nvoid print(ll x) {\n    if(x>9) print(x/10);\n    *O++=x%10+'0';\n}\ninline int read()\n{\n\tint s=0;\n\tchar ch=getchar();\n\twhile(ch<'0'||ch>'9') ch=getchar();\n\twhile(ch>='0'&&ch<='9') s*=10,s+=ch^48,ch=getchar();\n\treturn s;\n}\nint a[500003];\nvector<int> v[500003];\nint L;\nint dp[1000];\nint _[500003];\nint n=read(),m=read(),C;\nvoid GETL()\n{\n\tfor(int i=1; i<=n; ++i) _[i]=v[i].size();\n\tsort(_+1,_+n+1);\n\tll mn=1e18,cost;\n\tfor(int i=2; i<=n; ++i) \n\t\tcost=8ll*_[i]+(n-i),(cost<mn)&&(mn=cost,L=_[i]+1);\n\treturn ;\n}\nstruct modify\n{\n\tint pos,k,ds,dc;\n\tbool operator<(const modify&t)const\n\t{\n\t\treturn k<t.k;\n\t}\n}m1[1000003],m2[1000003];\nstruct query\n{\n\tint l,r,k,id;\n\tbool operator<(const query&t)const\n\t{\n\t\treturn k<t.k;\n\t}\n}q1[500003],q2[500003];\nvoid add(int pos,int l,int r)\n{\n\tif(l>r) return ;\n\t++C,\n\tm1[C]=(modify){pos,l+pos-1,-(l+pos-2),1},\n\tm2[C]=(modify){pos,n-pos+l,-(n-pos+l-1),1},\n\t++C,\n\tm1[C]=(modify){pos,r+pos,r+pos-1,-1},\n\tm2[C]=(modify){pos,n-pos+r+1,n-pos+r,-1};\n\treturn ;\n}\nint c[500003],cc[500003],mx;\ninline void add(int&x)\n{\n\t--cc[c[x]],++c[x],++cc[c[x]],\n\t(mx<c[x])&&(mx=c[x]);\n\treturn ;\n}\ninline void del(int&x)\n{\n\t(mx==c[x]&&cc[c[x]]==1)&&(--mx),\n\t--cc[c[x]],--c[x],++cc[c[x]];\n\treturn ;\n}\nll ans[500003],tsum[1000003];\nint tcnt[1000003];\nvoid adds(int x,int k)\n{\n\twhile(x<=(n<<1)) tsum[x]+=k,x+=x&(-x);\n\treturn ;\n}\nvoid addc(int x,int k)\n{\n\twhile(x<=(n<<1)) tcnt[x]+=k,x+=x&(-x);\n\treturn ;\n}\nll sums(int x)\n{\n\tll res=0;\n\twhile(x) res+=tsum[x],x-=x&(-x);\n\treturn res;\n}\nint sumc(int x)\n{\n\tint res=0;\n\twhile(x) res+=tcnt[x],x-=x&(-x);\n\treturn res;\n}\nsigned main()\n{\n    for(int i=1; i<=n; ++i) a[i]=read(),v[a[i]].push_back(abs(i-a[i])+1);\n    GETL();\n    for(int i=1,l,r; i<=m; ++i)\n    \tl=read(),r=read(),\n    \tq2[i]=(query){l,(l+r)>>1,n+1-l,i},\n    \tq1[i]=(query){((l+r)>>1)+1,r,r,i};\n    for(int i=1; i<=n; ++i) sort(v[i].begin(),v[i].end());\n    for(int i=1; i<=n; ++i) if(v[i].size()>=L)\n    {\n    \tint l=i,r=i,lst=(a[i]==i),cur=1,mx=0;\n    \t++c[a[i]]; \n    \twhile(l>1&&r<n)\n    \t{\n    \t\t--l,++r,\n    \t\t++c[a[l]],++c[a[r]],\n    \t\tmx=max(mx,c[a[l]]),\n    \t\tmx=max(mx,c[a[r]]),\n    \t\t((c[i]==mx)?\n    \t\t((!lst)&&(lst=cur+1)):\n    \t\t((lst)&&(add(i,lst,cur),lst=0))),\n    \t\t++cur;\n    \t}\n    \tif(lst) add(i,lst,cur);\n    \tfor(int i=l; i<=r; ++i) c[a[i]]=0;\n    }\n    if(a[1]==1&&v[1].size()<L) add(1,1,1);\n    for(int i=1; i<L; ++i)\n    {\n    \tcc[0]=1000000,mx=0;\n    \tint l=1,r=1,len=1;\n    \tadd(a[1]);\n    \t// int C1=0,C2=0,C3=0;\n    \tfor(int j=2; j<=n; ++j)\n    \t{\n    \t\tdel(a[l++]),del(a[l++]),--len;\n    \t\t// ++C1;\n    \t\twhile(mx<=i&&l>1&&r<n&&((a[l-1]==a[r+1])?(c[a[l-1]]<=i-2):(c[a[l-1]]<=i-1&&c[a[r+1]]<=i-1))) \n    \t\t\tadd(a[--l]),add(a[++r]),++len;\n    \t\t// if(i==1) printf(\"%d %d %d\\n\",l,r,len); \n    \t\tif(v[j].size()>i&&v[j].size()<L&&v[j][i]!=v[j][i-1])\n    \t\tadd(j,v[j][i-1],len);\n    \t\tif(v[j].size()==i) add(j,v[j][i-1],len);\n    \t}\n    \tfor(int i=1; i<=mx; ++i) cc[i]=0;\n    \tfor(int i=l; i<=r; ++i) c[a[i]]=0;\n    \t// printf(\"%d %d %d\\n\",C1,C2,C3);\n    }\n    //\u5de6\u4e0a->\u53f3\u4e0b\n    sort(m1+1,m1+C+1);\n    sort(q1+1,q1+m+1);\n    for(int i=1,j=0; i<=m; ++i)\n    {\n    \twhile(j<C&&m1[j+1].k<=q1[i].k)\n    \t// printf(\"%d %d %d\\n\",m1[j+1].pos,m1[j+1].ds,m1[j+1].dc),\n    \t++j,adds(m1[j].pos,m1[j].ds),addc(m1[j].pos,m1[j].dc);\n    \tans[q1[i].id]+=1ll*q1[i].k*(sumc(q1[i].r)-sumc(q1[i].l-1)),\n    \tans[q1[i].id]+=sums(q1[i].r)-sums(q1[i].l-1);\n    }\n    // for(int i=1; i<=m; ++i) printf(\"%lld\\n\",ans[i]);\n    //\u5de6\u4e0b->\u53f3\u4e0a\n    memset(tsum,0,sizeof(tsum));\n    memset(tcnt,0,sizeof(tcnt));\n    sort(m2+1,m2+C+1);\n    sort(q2+1,q2+m+1);\n    for(int i=1,j=0; i<=m; ++i)\n    {\n    \twhile(j<C&&m2[j+1].k<=q2[i].k)\n    \t++j,adds(m2[j].pos,m2[j].ds),addc(m2[j].pos,m2[j].dc);\n    \tans[q2[i].id]+=1ll*q2[i].k*(sumc(q2[i].r)-sumc(q2[i].l-1)),\n    \tans[q2[i].id]+=sums(q2[i].r)-sums(q2[i].l-1);\n    }\n    for(int i=1; i<=m; ++i) print(ans[i]),*O++='\\n';\n    fwrite(obuf,O-obuf,1,stdout);\n\treturn 0;\n}\n```",
        "postTime": 1619496446,
        "uid": 111055,
        "name": "dead_X",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P7125"
    },
    {
        "content": "\u5bf9\u4e8e\u4e00\u4e2a\u6570 $x$\uff0c\u8bbe\u5b83\u5728\u5e8f\u5217\u4e2d\u51fa\u73b0\u6b21\u6570\u4e3a $c_x$\u3002\n\n\u6211\u4eec\u56fa\u5b9a $x$ \u4e3a\u533a\u95f4\u7684\u4e2d\u5fc3\uff0c\u4e0d\u65ad\u589e\u52a0\u533a\u95f4\u7684\u534a\u5f84 $R$\uff0c\u8003\u8651\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u54ea\u4e9b\u533a\u95f4\u662f\u5408\u6cd5\u7684\u3002\u5728\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0c$x$ \u5728\u533a\u95f4\u4e2d\u7684\u51fa\u73b0\u6b21\u6570\u4e0d\u65ad\u589e\u52a0\uff0c\u533a\u95f4\u4f17\u6570\u7684\u51fa\u73b0\u6b21\u6570\u4e5f\u4e0d\u65ad\u589e\u52a0\u3002\u5f53\u4e14\u4ec5\u5f53\u4e24\u8005\u76f8\u7b49\u65f6\uff0c\u533a\u95f4\u5408\u6cd5\u3002\n\n\u679a\u4e3e\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d $x$ \u7684\u51fa\u73b0\u6b21\u6570 $k$\u3002\u6613\u77e5\u6ee1\u8db3 $x$ \u51fa\u73b0\u6b21\u6570\u4e3a $k$ \u7684 $R$ \u4e00\u5b9a\u662f\u8fde\u7eed\u7684\uff0c\u8bbe\u4e3a $[l,r]$\u3002\u53c8\u56e0\u4e3a\u5728 $R$ \u4ece $l$ \u589e\u52a0\u5230 $r$ \u7684\u8fc7\u7a0b\u4e2d\u533a\u95f4\u4f17\u6570\u7684\u51fa\u73b0\u6b21\u6570\u4e0d\u65ad\u589e\u52a0\uff0c\u56e0\u6b64\u4e00\u5b9a\u5b58\u5728 $m \\in [l-1,r]$ \u4f7f\u5f97\u5f53 $R \\in [l,m]$ \u65f6\u533a\u95f4\u5408\u6cd5\uff0c\u5f53 $R \\in [m+1,r]$ \u65f6\u533a\u95f4\u4e0d\u5408\u6cd5\u3002 \n\n\u56e0\u4e3a $k$ \u4e0d\u4f1a\u8d85\u8fc7 $c_x$ \u800c $\\sum_{i=1}^nc_i=n$\uff0c\u6240\u4ee5\u5bf9\u4e8e\u6240\u6709 $x$\uff0c\u5408\u6cd5\u7684\u534a\u5f84\u533a\u95f4\u603b\u5171\u4e0d\u4f1a\u8d85\u8fc7 $n$ \u4e2a\u3002\u8003\u8651\u9884\u5904\u7406\u51fa\u6240\u6709\u8fd9\u6837\u7684\u5408\u6cd5\u534a\u5f84\u533a\u95f4\uff0c\u518d\u56de\u7b54\u8be2\u95ee\u3002\n\n### \u7b2c\u4e00\u90e8\u5206\uff1a\u9884\u5904\u7406\n\n\u8003\u8651\u4e0a\u6587\u4e2d\u56fa\u5b9a $x$ \u4e3a\u4e2d\u5fc3\u589e\u52a0 $R$ \u7684\u8fc7\u7a0b\uff0c\u6211\u4eec\u53ef\u4ee5\u5bf9\u4e8e\u6bcf\u4e2a $k$ \u4e8c\u5206\u6c42\u51fa\u5bf9\u5e94\u7684 $m$\uff0c\u901a\u8fc7\u5206\u5757\u6c42\u533a\u95f4\u4f17\u6570\u3002\u6b64\u65f6\u5bf9\u4e8e\u6bcf\u4e2a $x$ \u7684\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(c_x \\sqrt{n} \\log n)$\uff0c\u603b\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n \\sqrt{n} \\log n)$\uff0c\u5e76\u4e0d\u80fd\u901a\u8fc7\u6b64\u9898\u3002\n\n\u6ce8\u610f\u5230 $\\sum_{i=1}^nc_i=n$ \u8fd9\u6761\u6027\u8d28\uff0c\u5b83\u63d0\u9192\u6211\u4eec\u53ef\u4ee5\u6839\u53f7\u5206\u6cbb\u3002\n\n\u8bbe\u5757\u957f\u4e3a $B$\u3002\u5bf9\u4e8e $c_x \\geq B$ \u7684 $x$\uff0c\u8fd9\u6837\u4e0d\u540c\u7684 $x$ \u6700\u591a\u6709 $\\dfrac{n}{B}$ \u4e2a\u3002\u5bf9\u4e8e\u6bcf\u4e2a $x$ \u6211\u4eec\u66b4\u529b\u679a\u4e3e\u533a\u95f4\u534a\u5f84\u5373\u53ef\u3002\u6b64\u90e8\u5206\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(\\dfrac{n^2}{B})$\u3002\n\n\u5bf9\u4e8e\u5269\u4e0b\u7684 $c_x < B$ \u7684\u6240\u6709 $x$\uff0c\u4ee5 $x$ \u4e3a\u4e2d\u5fc3\u7684\u5408\u6cd5\u533a\u95f4\u4e2d\u4f17\u6570\u7684\u51fa\u73b0\u6b21\u6570\u4e00\u5b9a $<B$\u3002\u56e0\u6b64\u6211\u4eec\u8003\u8651\u679a\u4e3e $k$\uff0c\u5e76\u6c42\u51fa\u6240\u6709\u4f17\u6570\u51fa\u73b0\u6b21\u6570\u4e3a $k$ \u7684\u5408\u6cd5\u533a\u95f4\u3002\n\n\u6211\u4eec\u8fd8\u662f\u7528\u6587\u7ae0\u4e00\u5f00\u5934\u63d0\u5230\u7684\u65b9\u6cd5\uff0c\u56fa\u5b9a\u4e2d\u5fc3 $x$\uff0c\u8bbe\u6ee1\u8db3 $x$ \u51fa\u73b0\u6b21\u6570\u4e3a $k$ \u7684 $R \\in [l,r]$\u3002\u6211\u4eec\u4ecd\u7136\u8003\u8651\u4e8c\u5206 $m$\uff0c\u6b64\u65f6\u53ea\u9700\u5224\u65ad\u5728 $[x-m,x+m]$ \u662f\u5426\u6709\u6570\u51fa\u73b0\u4e86\u8d85\u8fc7 $k$ \u6b21\uff0c\u5982\u679c\u6ca1\u6709\u8fd9\u6837\u7684\u6570\u5219\u5408\u6cd5\u3002\u6211\u4eec\u53ef\u4ee5\u5904\u7406\u51fa $p$ \u6570\u7ec4\uff0c$p_i$ \u8868\u793a\u6700\u5c0f\u7684 $j$ \u4f7f $[i,j]$ \u4e2d\u533a\u95f4\u4f17\u6570\u7684\u51fa\u73b0\u6b21\u6570 $>k$\u3002\u5bf9\u4e8e\u6bcf\u4e2a $i$ \u6211\u4eec\u8bbe $q_i$ \u8868\u793a\u4ece $i$ \u5f00\u59cb\u5f80\u53f3\u7b2c $k+1$ \u4e2a $a_i$ \u51fa\u73b0\u7684\u4f4d\u7f6e\uff0c\u800c $p$ \u6570\u7ec4\u5c31\u662f $q$ \u6570\u7ec4\u6c42\u4e00\u4e0b\u540e\u7f00\u6700\u5c0f\u503c\u3002\u4e8e\u662f\u6211\u4eec\u5728 $O(n)$ \u65f6\u95f4\u590d\u6742\u5ea6\u5185\u6c42\u51fa\u4e86 $p$ \u6570\u7ec4\u3002\u8fd9\u6837\u6211\u4eec\u4e8c\u5206\u65f6\u53ea\u9700\u5224\u65ad\u662f\u5426\u6709 $p_{x-m}>x+m$ \u5373\u53ef\uff0c\u80fd\u505a\u5230 $O(1)$ \u5224\u65ad\u3002\n\n\u8003\u8651\u5230\u5bf9\u4e8e\u6240\u6709 $k$\uff0c\u4e00\u5171\u53ea\u6709\u4e0d\u8d85\u8fc7 $n$ \u4e2a\u9700\u8981\u4e8c\u5206\u7684\u533a\u95f4\uff0c\u56e0\u6b64\u4e8c\u5206\u7684\u603b\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n \\log n)$\uff0c\u4e0d\u4f1a\u6210\u4e3a\u74f6\u9888\u3002\u6211\u4eec\u9700\u8981\u679a\u4e3e $B$ \u4e2a $k$\uff0c\u5bf9\u4e8e\u6bcf\u4e2a $k$ \u6c42\u89e3\u7684\u590d\u6742\u5ea6\u4e3a $O(n)$\uff0c\u6240\u4ee5\u6b64\u90e8\u5206\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(nB)$\u3002\n\n\u7efc\u4e0a\uff0c\u9884\u5904\u7406\u90e8\u5206\u603b\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(\\dfrac{n^2}{B}+nB)$\uff0c\u7406\u8bba\u4e0a\u53d6 $B=\\sqrt{n}$ \u65f6\u65f6\u95f4\u590d\u6742\u5ea6\u6700\u5c0f\uff0c\u4e3a $O(n \\sqrt{n})$\uff0c\u4f46\u56e0\u4e3a\u4e24\u90e8\u5206\u5e38\u6570\u5927\u5c0f\u7684\u5dee\u5f02\uff0c$B$ \u8f83\u5c0f\u65f6\u7a0b\u5e8f\u8fd0\u884c\u66f4\u5feb\u3002\n\n### \u7b2c\u4e8c\u90e8\u5206\uff1a\u56de\u7b54\u8be2\u95ee\n\n\u8003\u8651\u4e00\u4e2a\u5408\u6cd5\u7684\u4e2d\u5fc3 $x$ \u548c\u534a\u5f84\u533a\u95f4 $[L,R]$ \u5bf9\u8be2\u95ee $[l,r]$ \u7684\u8d21\u732e\u3002\u5bf9\u4e8e\u6bcf\u4e2a $i \\in [L,R]$\uff0c\u82e5 $x-i \\in [l,r]$ \u4e14 $x+i \\in [l,r]$\uff0c\u5219\u4f1a\u4ea7\u751f $1$ \u7684\u8d21\u732e\u3002\n\n\u4ee4 $mid=\\lfloor \\dfrac{l+r}{2} \\rfloor$\u3002\u82e5 $mid \\leq x$\uff0c\u5219\u5f53 $x+i \\in [l,r]$ \u65f6\u4e00\u5b9a\u6709 $x-i \\in [l,r]$\uff0c\u8d21\u732e\u5373\u4e3a $[x+L,x+R] \\cap [l,r]$ \u7684\u957f\u5ea6\u3002\u82e5 $mid > x$\uff0c\u5219\u5f53 $x-i \\in [l,r]$ \u65f6\u4e00\u5b9a\u6709 $x+i \\in [l,r]$\uff0c\u8d21\u732e\u5373\u4e3a $[x-R,x-L] \\cap [l,r]$ \u7684\u957f\u5ea6\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u5bf9 $mid \\leq x$ \u548c $mid > x$ \u4e24\u79cd\u60c5\u51b5\u5206\u5f00\u7edf\u8ba1\u8d21\u732e\u3002\u8fd9\u9898\u5c31\u88ab\u8f6c\u5316\u4e3a\u4e86\u4e00\u4e2a\u4e8c\u7ef4\u6570\u70b9\u95ee\u9898\uff0c\u628a\u8be2\u95ee\u79bb\u7ebf\u4e0b\u6765\u4f7f\u7528\u6811\u72b6\u6570\u7ec4\u6216\u7ebf\u6bb5\u6811\u89e3\u51b3\u5373\u53ef\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $O(m \\log n)$\u3002\n\n\u8fd9\u6837\u6211\u4eec\u4fbf\u5f97\u5230\u4e86\u4e00\u4e2a\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n \\sqrt{n}+m \\log n)$ \u7684\u505a\u6cd5\uff0c\u8fdb\u884c\u4e00\u4e9b\u5361\u5e38\u4fbf\u80fd\u901a\u8fc7\u6b64\u9898\u3002\n\n```cpp\n#include<bits/stdc++.h>\n#define ll long long\nusing namespace std;\nconst int N=500010,B=80,INF=1e9;\ninline int read(){\n\tint x=0,f=1;char c=getchar();\n\twhile(c<48){if(c=='-')f=0;c=getchar();}\n\twhile(c>=48) x=(x<<3)+(x<<1)+(c^48),c=getchar();\n\treturn f?x:-x;\n}\ninline void write(ll x){\n\tif(x>=10) write(x/10);\n\tputchar(48+x%10);\n}\nstruct query{\n\tint mid,l,r,id;\n};\nint n,m;\nint a[N],c[N],cnt[N],idx[N];\nll ans[N<<1];\nvector<int> pos[N],v[N];\nvector<query> q;\ninline query make_query(int mid,int l,int r,int id){\n\tquery ret;\n\tret.id=id;ret.l=l;ret.r=r;ret.mid=mid;\n\treturn ret;\n}\ninline void solve_big(int x){\n\tmemset(cnt,0,sizeof(cnt));\n\tint mx=0,flg=0,st=0;\n\tfor(int i=0;x-i>=1&&x+i<=n;i++){\n\t\tmx=max(mx,++cnt[a[x-i]]);\n\t\tif(i) mx=max(mx,++cnt[a[x+i]]);\n\t\tif(cnt[x]==mx&&!flg) st=i;\n\t\tif(cnt[x]!=mx&&flg) q.push_back(make_query(x,st,i-1,0));\n\t\tif(cnt[x]==mx) flg=1;\n\t\telse flg=0;\n\t}\n\tif(flg) q.push_back(make_query(x,st,min(x-1,n-x),0));\n}\nint tmp;\nint p[N],pp[N];\ninline void solve_small(int x){\n\tfor(int i=1;i<=n;i++){\n\t\tif(idx[i]+x<(int)v[a[i]].size()) pp[i]=v[a[i]][idx[i]+x];\n\t\telse pp[i]=INF;\n\t}\n\tp[n+1]=INF;\n\tfor(int i=n;i>=1;i--) p[i]=min(p[i+1],pp[i]);\n\tfor(int i=1;i<=n;i++)\n\t\tif(c[i]<B&&c[i]>=x){\n\t\t\tint L=pos[i][x-1],R=min((c[i]>x?pos[i][x]-1:INF),min(i-1,n-i));\n\t\t\tif(L>R) continue;\n\t\t\tint l=L-1,r=R;\n\t\t\twhile(l<r){\n\t\t\t\tint mid=(l+r+1)/2;\n\t\t\t\tif(p[i-mid]>i+mid) l=mid;\n\t\t\t\telse r=mid-1;\n\t\t\t}\n\t\t\tif(l>=L) q.push_back(make_query(i,L,l,0));\n\t\t}\n}\nbool cmp(const query &_a,const query &b){\n\tif(_a.mid!=b.mid) return _a.mid<b.mid;\n\treturn _a.id<b.id;\n}\ninline int lowbit(int x){\n\treturn x&(-x);\n}\nstruct BIT{\n\tll tr[N];\n\tinline void clear(){memset(tr,0,sizeof(tr));}\n\tinline void upd(int x,ll val){\n\t\twhile(x<=n){\n\t\t\ttr[x]+=val;\n\t\t\tx+=lowbit(x);\n\t\t}\n\t}\n\tinline ll qry(int x){\n\t\tll res=0;\n\t\twhile(x){\n\t\t\tres+=tr[x];\n\t\t\tx-=lowbit(x);\n\t\t}\n\t\treturn res;\n\t}\n} t1,t2;\ninline void upd(int l,int r,int val){\n\tt1.upd(l,val);\n\tt1.upd(r+1,-val);\n\tt2.upd(l,val*l);\n\tt2.upd(r+1,-val*(r+1));\n}\ninline ll qry(int x){\n\treturn (x+1)*t1.qry(x)-t2.qry(x);\n}\nsigned main(){\n\tn=read();m=read();\n\tfor(int i=1;i<=n;i++){\n\t\ta[i]=read();\n\t\tc[a[i]]++;\n\t\tpos[a[i]].push_back(abs(i-a[i]));\n\t\tv[a[i]].push_back(i);idx[i]=v[a[i]].size()-1;\n\t}\n\tfor(int i=1;i<=n;i++)\n\t\tif(c[i]>=B) solve_big(i);\n\tfor(tmp=1;tmp<=n;tmp++) sort(pos[tmp].begin(),pos[tmp].end());\n\tfor(int x=1;x<B;x++) solve_small(x);\n\tfor(int i=1;i<=m;i++){\n\t\tint l=read(),r=read();\n\t\tq.push_back(make_query((l+r)/2,l,r,i));\n\t}\n\tsort(q.begin(),q.end(),cmp);t1.clear();t2.clear();\n\tfor(auto i:q){\n\t\tif(i.id) ans[i.id]+=qry(i.r)-qry(i.l-1);\n\t\telse upd(i.mid-i.r,i.mid-i.l,1);\n\t}\n\treverse(q.begin(),q.end());t1.clear();t2.clear();\n\tfor(auto i:q){\n\t\tif(i.id) ans[i.id]+=qry(i.r)-qry(i.l-1);\n\t\telse upd(i.mid+i.l,i.mid+i.r,1);\n\t}\n\tfor(int i=1;i<=m;i++) write(ans[i]),putchar('\\n');\n\treturn 0;\n}\n```\n",
        "postTime": 1643071123,
        "uid": 213870,
        "name": "Yudanjun",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P7125 [Ynoi2008] rsmemq"
    }
]