[
    {
        "content": "### dfs \u5e8f + \u7ebf\u6bb5\u6811\n\n\u5f88\u597d\u7684\u4e00\u9053\u9898\uff0c\u601d\u8003\u8fc7\u7a0b\u975e\u5e38\u81ea\u7136\u3001\u8212\u9002\u3002\n\n------------\n\n#### \u4e58\u6cd5\u9006\u5143\n\n\u5f88\u81ea\u7136\u7684\u601d\u8def\uff0c\u4f46\u662f\u5728\u672c\u9898\u4e2d\u4e0d\u53ef\u884c\u3002\n\n\u7528 dfs \u5e8f\u628a\u6811\u6620\u5c04\u5230\u5e8f\u5217\u4e0a\uff0c\u7136\u540e\u5206\u522b\u7ef4\u62a4 $c,v$ \u7684\u524d\u7f00\u79ef\uff0c\u7531\u4e8e\u8282\u70b9\u7684\u5b50\u6811\u5728 dfs \u5e8f\u4e2d\u4e3a\u4e00\u6bb5\u8fde\u7eed\u533a\u95f4\uff0c\u53ef\u4ee5\u7528\u9006\u5143\u53d6\u51fa\u5b50\u6811\u4e2d $c$ \u7684\u4e58\u79ef\uff0c\u540c\u6837\u53ef\u4ee5\u7528\u9006\u5143\u8ba1\u7b97\u4e0d\u5305\u62ec\u5f53\u524d\u5b50\u6811\u6240\u6709 $v$ \u7684\u4e58\u79ef\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log n)$\uff0c\u7ebf\u6027\u6c42\u9006\u5143\u53ef\u5c06\u590d\u6742\u5ea6\u964d\u81f3 $O(n)$\u3002\n\n\u4f7f\u7528\u9006\u5143\u6c42\u89e3\u7684\u6761\u4ef6\u662f\u6240\u6709\u53c2\u4e0e\u8ba1\u7b97\u7684\u503c\u90fd\u5b58\u5728\u9006\u5143\uff0c\u9700\u8981\u6a21\u6570\u4e0e\u4efb\u610f $c,v$ \u4e92\u8d28\u3002\u9898\u76ee\u4e2d\u6ca1\u6709\u7ed9\u51fa\u76f8\u5173\u6027\u8d28\uff0c\u6240\u4ee5\u5373\u4f7f\u8d5b\u540e\u6539\u9898\u4ee4\u6a21\u6570\u4e3a\u8d28\u6570\uff0c\u4e5f\u4e0d\u4f1a\u5bf9\u89e3\u6cd5\u4ea7\u751f\u4efb\u4f55\u5f71\u54cd\uff0c\u53cd\u800c\u8bf1\u5bfc\u4eba\u5411\u9006\u5143\u65b9\u5411\u601d\u8003\uff0c\u7ed9\u89e3\u9898\u589e\u52a0\u96be\u5ea6\u3002\n\n------------\n\n#### \u7ebf\u6bb5\u6811\n\ndfs \u5e8f\u7684\u601d\u8def\u6682\u65f6\u627e\u4e0d\u5230\u95ee\u9898\uff0c\u73b0\u5728\u9700\u8981\u4e00\u79cd\u4e0d\u4f9d\u8d56\u9006\u5143\u7684\u65b9\u6cd5\u5feb\u901f\u6c42\u51fa\u67d0\u4e2a\u533a\u95f4\u5185\u6570\u5b57\u7684\u4e58\u79ef\uff0c\u4e0d\u96be\u60f3\u5230\u7ebf\u6bb5\u6811\u3002\n\n\u524d\u7f6e\u77e5\u8bc6\uff1a[\u7ebf\u6bb5\u6811 II](https://www.luogu.com.cn/problem/P3373)\u3002\n\n\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u533a\u95f4\u5185 $c,v$ \u7684\u4e58\u79ef\uff0c\u652f\u6301\u533a\u95f4\u67e5\u8be2\u5373\u53ef\uff0c\u4e0d\u9700\u8981\u5ef6\u8fdf\u6807\u8bb0\u3002\n\n\u8bb0\u5f97\u5bf9\u7b54\u6848\u53d6\u6a21\uff0c\u9898\u76ee\u662f ACM \u8d5b\u5236\u7684\uff0c\u540c\u6837\u7684\u4ee3\u7801\u591a\u6b21 WA \u53cd\u9988\u7684\u6570\u636e\u70b9\u53ef\u80fd\u4e0d\u540c\uff0c\u5bf9\u67e5\u9519\u4e0d\u662f\u5f88\u53cb\u597d\u3002\u5982\u679c\u88ab\u5361\u5e38\uff0c\u4f7f\u7528\u94fe\u5f0f\u524d\u5411\u661f\u4ee3\u66ff ```vector``` \u53ef\u4ee5\u83b7\u5f97\u4e00\u5b9a\u7a0b\u5ea6\u63d0\u901f\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log n)$\u3002\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nstruct Segment{int l,r,c,v;}s[1200001];\nconstexpr Segment emp=Segment{0,0,1,1};\nint n,mod,pos,c[300001],v[300001],w[300001],ex[300001],dfn[300001];\nvector<int> e[300001];//ex[x]\u8bb0\u5f55dfs\u5e8f\u4e2d\u4f4d\u7f6ex\u5bf9\u5e94\u70b9\u7684\u7f16\u53f7,\u5efa\u6811\u7528\nlong long ans;\nvoid dfs(int x,int las){\n\tw[x]=1,dfn[x]=++pos,ex[pos]=x;\n\tfor(int i:e[x]) if(i!=las) dfs(i,x),w[x]+=w[i];\n}\nvoid pushup(Segment &u,const Segment &ls,const Segment &rs){\n\tu.c=1ll*ls.c*rs.c%mod,u.v=1ll*ls.v*rs.v%mod;\n}\nvoid build(int u,int l,int r){\n\ts[u].l=l,s[u].r=r;\n\tif(l==r) return s[u].c=c[ex[l]],s[u].v=v[ex[l]],void();\n\tbuild(u*2,l,(l+r)/2);\n\tbuild(u*2+1,(l+r)/2+1,r);\n\tpushup(s[u],s[u*2],s[u*2+1]);\n}\nSegment query(int u,int l,int r){\n\tif(s[u].l>r||s[u].r<l) return emp;\n\tif(s[u].l>=l&&s[u].r<=r) return s[u];\n\tauto ret=emp,ls=query(u*2,l,r),rs=query(u*2+1,l,r);\n\tpushup(ret,ls,rs);\n\treturn ret;\n}\nint main(){\n\tscanf(\"%d%d\",&n,&mod);\n\tfor(int i=1;i<=n-1;i++){\n\t\tstatic int x,y;\n\t\tscanf(\"%d%d\",&x,&y);\n\t\te[x].push_back(y);\n\t\te[y].push_back(x);\n\t}\n\tfor(int i=1;i<=n;i++) scanf(\"%d\",&c[i]);\n\tfor(int i=1;i<=n;i++) scanf(\"%d\",&v[i]);\n\tdfs(1,0),build(1,1,n),ans=s[1].c;//\u6839\u8282\u70b9\u7b54\u6848\u72ec\u7acb\u7edf\u8ba1 \n\tfor(int i=2;i<=n;i++){\n\t\tstatic Segment lot,son,rot;//dfs\u5e8f\u5de6\u8fb9 \u5b50\u6811 dfs\u5e8f\u53f3\u8fb9 \n\t\tlot=query(1,1,dfn[i]-1);\n\t\tson=query(1,dfn[i],dfn[i]+w[i]-1);\n\t\trot=query(1,dfn[i]+w[i],n);\n\t\tans+=1ll*lot.v*rot.v%mod*son.c%mod;\n\t}\n\tans%=mod;\n\tprintf(\"%lld\\n\",ans);\n\treturn 0;\n}\n```\n------------\n\n**Updated on 2023/4/15**\n\n#### \u524d\u7f00\u79ef & \u540e\u7f00\u79ef\n\n\u53ef\u4ee5\u53d1\u73b0\u7ebf\u6bb5\u6811\u53ea\u9700\u8981\u7ef4\u62a4 $c$ \u7684\u533a\u95f4\u4e58\u79ef\uff0cdfs \u5e8f\u5de6\u53f3\u4e24\u7aef\u7684\u67e5\u8be2\u5b9e\u9645\u4e0a\u662f $v$ \u7684\u4e00\u6bb5\u524d\u7f00\u79ef\u548c\u4e00\u6bb5\u540e\u7f00\u79ef\u3002\u7ef4\u62a4 $v$ \u7684\u524d\u7f00\u79ef\u548c\u540e\u7f00\u79ef\u53ef\u4ee5\u5927\u5e45\u964d\u4f4e\u4ee3\u7801\u5e38\u6570\u3002\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nstruct Segment{int l,r,w;}s[1200001];\nint n,mod,pos,c[300001],v[300001],w[300001],ex[300001],dfn[300001],mul[300001],pre[300005],suf[300005];\nvector<int> e[300001];\nlong long ans;\nvoid dfs(int x,int las){\n\tw[x]=1,dfn[x]=++pos,ex[pos]=x;\n\tfor(int i:e[x]) if(i!=las) dfs(i,x),w[x]+=w[i];\n}\nvoid build(int u,int l,int r){\n\ts[u].l=l,s[u].r=r;\n\tif(l==r) return s[u].w=c[ex[l]],mul[l]=v[ex[l]],void();\n\tbuild(u*2,l,(l+r)/2),build(u*2+1,(l+r)/2+1,r);\n\ts[u].w=1ll*s[u*2].w*s[u*2+1].w%mod;\n}\nint query(int u,int l,int r){\n\tif(s[u].l>r||s[u].r<l) return 1;//\u6ce8\u610f\u8fd4\u56de\u503c \n\tif(s[u].l>=l&&s[u].r<=r) return s[u].w;\n\treturn 1ll*query(u*2,l,r)*query(u*2+1,l,r)%mod;\n}\nint main(){\n\tscanf(\"%d%d\",&n,&mod);\n\tfor(int i=1;i<=n-1;i++){\n\t\tstatic int x,y;\n\t\tscanf(\"%d%d\",&x,&y);\n\t\te[x].push_back(y);\n\t\te[y].push_back(x);\n\t}\n\tfor(int i=1;i<=n;i++) scanf(\"%d\",&c[i]);\n\tfor(int i=1;i<=n;i++) scanf(\"%d\",&v[i]);\n\tdfs(1,0),build(1,1,n),ans=s[1].w;\n\tpre[0]=1,suf[n+1]=1;//\u5728pre\u548csuf\u7684\u8d8a\u754c\u5904\u8bbe\u7f6e\u6781\u503c,\u65e0\u9700\u7279\u5224 \n\tfor(int i=1;i<=n;i++) pre[i]=1ll*mul[i]*pre[i-1]%mod;//\u524d\u7f00\u79ef \n\tfor(int i=n;i>=1;i--) suf[i]=1ll*mul[i]*suf[i+1]%mod;//\u540e\u7f00\u79ef \n\tfor(int i=2;i<=n;i++){\n\t\tstatic int lot,son,rot;\n\t\tlot=pre[dfn[i]-1];\n\t\tson=query(1,dfn[i],dfn[i]+w[i]-1);\n\t\trot=suf[dfn[i]+w[i]];\n\t\tans+=1ll*lot*rot%mod*son%mod;\n\t}\n\tans%=mod;\n\tprintf(\"%lld\\n\",ans);\n\treturn 0;\n}\n```\n",
        "postTime": 1681227916,
        "uid": 662295,
        "name": "Flanksy",
        "ccfLevel": 0,
        "title": "P9208 \u865a\u4eba\u300c\u65e0\u300d"
    },
    {
        "content": "[\u4f20\u9001\u95e8](https://www.luogu.com.cn/problem/P9208)\n\n### \u601d\u8def\uff1a\n\n\u5f53 $m$ \u4e3a\u8d28\u6570\uff0c\u8fd9\u9898\u53ef\u4ee5\u7528\u9006\u5143\u505a\u3002\n\n\u5f00\u51e0\u4e2a\u6570\u7ec4\uff1a$x_i$ \u8868\u793a $\\prod_{v \\in \\operatorname{substree}(i)} c_{v}$ \u9664\u4ee5 $m$ \u7684\u4f59\u6570\uff0c$y_i$ \u8868\u793a\u628a $\\prod_{v \\in \\operatorname{substree}(i)} v_{v}$ \u4e2d\u7684\u6240\u6709\u56e0\u5b50 $m$ \u7ea6\u53bb\u540e\uff0c\u8fd9\u4e2a\u6570\u9664\u4ee5 $m$ \u7684\u4f59\u6570\uff0c$mod_i$ \u8868\u793a $\\prod_{v \\in \\operatorname{substree}(i)} v_{v}$ \u4e2d\u6709\u591a\u5c11\u4e2a\u56e0\u5b50 $m$\u3002\n\n\u5148\u5efa\u6811\uff0c\u5728\u6811\u4e0a\u8fdb\u884c dfs\uff0c\u53ef\u4ee5\u5904\u7406\u51fa\u4e09\u4e2a\u6570\u7ec4\u3002\n\n\u6700\u540e\u4ece $i=2$ \u5f00\u59cb\u7edf\u8ba1\u3002\u5728\u7edf\u8ba1\u7684\u65f6\u5019\uff0c\u5982\u679c\u53d1\u73b0 $mod_i < mod_1$\uff0c\u8bf4\u660e $\\prod_{v \\notin \\text { substree }(u)} v_{v}$ \u542b\u6709\u56e0\u5b50 $m$\uff0c\u6240\u4ee5\u8fd9\u4e2a\u70b9\u5bf9\u7b54\u6848\u5c31\u6ca1\u6709\u8d21\u732e\u3002\u5426\u5219\uff0c\u6240\u6709\u7684\u56e0\u5b50 $m$ \u90fd\u4f1a\u5728\u9664\u6cd5\u4e2d\u7ea6\u53bb\uff0c\u7b54\u6848\u5c31\u662f $x_i\\times\\dfrac{y_1}{y_i}$\uff0c\u6c42\u51fa $y_i$ \u5728\u6a21 $m$ \u4e0b\u7684\u7684\u9006\u5143\u5373\u53ef\u3002\n\n\u8fd9\u79cd\u505a\u6cd5\u5728 $m$ \u4e0d\u4e3a\u8d28\u6570\u65f6\u4e5f\u53ef\u4ee5\u505a\uff0c\u5bf9 $m$ \u7684\u6bcf\u4e00\u4e2a\u8d28\u56e0\u5b50\u90fd\u8fdb\u884c\u7edf\u8ba1\u5c31\u884c\u4e86\u3002\n\n\u4e0b\u9762\u4ee3\u7801\u662f $m$ \u4e3a\u8d28\u6570\u65f6\u901a\u8fc7\u7684\u4ee3\u7801\u3002\n\n### AC Code:\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define ll long long\nll n,m,home[300001],cnt,c[300001],v[300001],mod[300001];//c\u662f\u9898\u89e3\u4e2d\u7684x\uff0cv\u662f\u9898\u89e3\u4e2d\u7684y\u3002\nstruct node{\n\tll next,to;\n}e[600001];\nvoid add(ll a,ll b){\n\te[++cnt].to=b;\n\te[cnt].next=home[a];\n\thome[a]=cnt;\n}\nvoid dfs(ll h,ll fa){\n\twhile(v[h]%m==0){\n\t\tmod[h]++;\n\t\tv[h]/=m;\n\t}\n\tfor(ll i=home[h];i;i=e[i].next){\n\t\tll t=e[i].to;\n\t\tif(t==fa) continue;\n\t\tdfs(t,h);\n\t\tc[h]=c[h]*c[t]%m;\n\t\tv[h]=v[h]*v[t];\n\t\tmod[h]+=mod[t];\n\t\twhile(v[h]&&v[h]%m==0){\n\t\t\tmod[h]++;\n\t\t\tv[h]/=m;\n\t\t}\n\t\tv[h]%=m;\n\t}\n}\nvoid exgcd(ll a,ll b,ll &x,ll &y){\n\tif(!b) x=1,y=0;\n\telse{\n\t\texgcd(b,a%b,y,x);\n\t\ty-=a/b*x;\n\t}\n}\nint main(){\n\tscanf(\"%lld %lld\",&n,&m);\n\tll x,y;\n\tfor(ll i=1;i<n;i++){\n\t\tscanf(\"%lld %lld\",&x,&y);\n\t\tadd(x,y);\n\t\tadd(y,x);\n\t}\n\tfor(ll i=1;i<=n;i++){\n\t\tscanf(\"%lld\",&c[i]);\n\t\tc[i]%=m;\n\t}\n\tfor(ll j=1;j<=n;j++){\n\t\tscanf(\"%lld\",&v[j]);\n\t}\n\tdfs(1,-1);\n\tll vsum=v[1];\n\tll ans=c[1]%m;\n\tfor(ll i=2;i<=n;i++){\n\t\tif(mod[1]>mod[i]) continue;\n\t\tll x=0,y=0;\n\t\texgcd(v[i],m,x,y);\n\t\tx=(x%m+m)%m;\n\t\tans=(ans+c[i]*vsum%m*x%m)%m;\n\t}\n\tprintf(\"%lld\",ans);\n\treturn 0;\n}\n```",
        "postTime": 1681051053,
        "uid": 660641,
        "name": "0zhouyq",
        "ccfLevel": 5,
        "title": "P9208\u9898\u89e3"
    },
    {
        "content": "\u4e00\u773c\u4e01\u771f\uff0c\u9274\u5b9a\u4e3a\u725b\u5b50\u9898\u3002\n\n\u6ce8\u610f\u5230 $m$ \u5373\u4f7f\u4e3a\u8d28\u6570\uff0c\u70b9\u6743\u4e5f\u4e0d\u4e00\u5b9a\uff08\u4e8b\u5b9e\u4e0a\u6570\u636e\u662f\u4e00\u5b9a\u4e0d\uff09\u5b58\u5728\u9006\u5143\uff0c\u56e0\u6b64\u8fd9\u9898\u662f\u4e2a\u725b\u5b50\u9898\u3002\n\n\u5b50\u6811\u5185 $c$ \u7684\u79ef\u5bb9\u6613\u7528\u6811\u5f62 dp \u6c42\u51fa\uff0c\u6545\u91cd\u70b9\u8003\u8651\u5b50\u6811\u8865\u7684 $v$ \u79ef\u3002\n\n\u5c06\u6811\u6309 dfn \u5e8f\u62cd\u5e73\u5230\u5e8f\u5217\u4e0a\uff0c\u8003\u5bdf\u67d0\u4e2a\u70b9\u5b50\u6811\u8865\u5728\u5e8f\u5217\u4e0a\u7684\u7ed3\u6784\uff0c\u663e\u7136\u662f\u4e00\u6bb5\u524d\u7f00\u62fc\u4e0a\u4e00\u6bb5\u540e\u7f00\u7684\u5f62\u5f0f\uff0c\u7ef4\u62a4\u524d\u7f00\u79ef\u548c\u540e\u7f00\u79ef\uff0c\u7136\u540e\u4e58\u8d77\u6765\u5373\u53ef\u3002\n\n\u5fc3\u60c5\u597d\uff0c\u7ed9\u4e2a\u4ee3\u7801\u5427\u3002\n\n```\n#include<bits/stdc++.h>\n#define Maxn 1000007\nusing namespace std;\nint fa[Maxn], dfn[Maxn], c[Maxn], v[Maxn], p, n, vpre[Maxn], g[Maxn], f[Maxn], vsuf[Maxn], cnt, L[Maxn], R[Maxn]; vector<int> e[Maxn];\nchar buf[1<<21], *p1, *p2;\n#define GC p1 == p2 and (p2 = (p1 = buf) + fread(buf, 1, 1<<21, stdin), p1 == p2) ? EOF : *p1++\ninline int read() {\n\tint x = 0; char ch = GC;\n\twhile(ch > '9' || ch < '0') ch = GC;\n\twhile(ch >= '0' && ch <= '9') x = (x<<1) + (x<<3) + (ch^48), ch = GC;\n\treturn x;\n}\nvoid dfs(int u, int fa) {\n\tL[u] = dfn[u], R[u] = dfn[u];\n\tfor(auto v : e[u]) if(v != fa) dfn[v] = ++ cnt, dfs(v, u);\n\tfor(auto v : e[u]) if(v != fa) L[u] = min(L[u], L[v]), R[u] = max(R[u], R[v]);\n}\nvoid dp(int u, int fa) {\n\tg[u] = c[u]; for(auto v : e[u]) if(v != fa) dp(v, u), g[u] = 1ll * g[u] * g[v] % p;\n\tf[u] = 1ll * g[u] * vpre[L[u] - 1] % p * vsuf[R[u] + 1] % p;\n}\nint main() {\n\tn = read(); p = read(); // 4 + 2 + 4;\n\tfor(int i = 2, u, v; i <= n; i ++) u = read(), v = read(), e[u].push_back(v), e[v].push_back(u); dfn[1] = ++ cnt; dfs(1, 0);\n\tfor(int i = 1; i <= n; i ++) c[i] = read(); for(int i = 1; i <= n; i ++) v[i] = read();\n\tfor(int i = 1; i <= n; i ++) vpre[dfn[i]] = vsuf[dfn[i]] = v[i]; vpre[0] = 1; \n\tfor(int i = 2; i <= n; i ++) vpre[i] = 1ll * vpre[i] * vpre[i - 1] % p; vsuf[n + 1] = 1;\n\tfor(int i = n - 1; i; i --) vsuf[i] = 1ll * vsuf[i] * vsuf[i + 1] % p; int ans = 0; dp(1, 0);\n\tfor(int i = 1; i <= n; i ++) ans = (ans + f[i]) % p; cout << ans;\n}\n```",
        "postTime": 1681739152,
        "uid": 340803,
        "name": "InoueTakina",
        "ccfLevel": 0,
        "title": "P9208 \u865a\u4eba\u300c\u65e0\u300d"
    },
    {
        "content": "\u672c\u9898\u7528\u5230\u4e86 dfs \u5e8f\u3001\u524d\u7f00\u79ef\u548c\u540e\u7f00\u79ef\u3002\n\n\u5148\u4e00\u904d dfs \u6c42\u51fa\u6bcf\u4e2a\u8282\u70b9\u5728 dfs \u5e8f\u4e2d\u7684\u4f4d\u7f6e\uff08\u8bb0\u4e3a $w_i$\uff09\u3001\u6bcf\u4e2a\u8282\u70b9\u5b50\u6811\u7684\u5927\u5c0f\uff08\u8bb0\u4e3a $sz_i$\uff09\u3001\u6bcf\u4e2a\u8282\u70b9\u5b50\u6811 $c$ \u7684\u4e58\u79ef\uff08\u8bb0\u4e3a $zs_i$\uff09\u3002\u8bb0 $qz_i,hz_i$ \u4e3a dfs \u5e8f\u7684 $v$ \u7684\u524d\u7f00\u79ef\u548c\u540e\u7f00\u79ef\uff0c\u5219\u6bcf\u4e2a\u8282\u70b9\u7684\u6743\u503c\u7b49\u4e8e $zs_i\\times qz_{w_i-1}\\times hz_{w_i+sz_i}$\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(n)$\u3002\n\n## Code\n```\n#include<cstdio>\nconst int N=3e5+5;\nint n,m,a,b,tot,head[N],nxt[N<<1],to[N<<1],ans;\nint c[N],v[N],cnt,dx[N],zs[N],qz[N],hz[N],sz[N],w[N];\nvoid add(int u,int v){\n\tnxt[++tot]=head[u];\n\thead[u]=tot;\n\tto[tot]=v;\n}//\u94fe\u5f0f\u524d\u5411\u661f\nvoid dfs(int u,int fa,const int mod){\n\tdx[++cnt]=u;w[dx[i]]=i;\n\tfor(int i=head[u];i;i=nxt[i]){\n\t\tint v=to[i];\n\t\tif(v==fa)continue;\n\t\tdfs(v,u,mod);\n\t\tzs[u]=1ll*zs[u]*zs[v]%mod;\n\t\tsz[u]+=sz[v];\n\t}\n}\nvoid prez(const int mod){\n\tqz[0]=hz[n+1]=1;\n\tfor(int i=1;i<=n;++i)\n\t\tqz[i]=1ll*qz[i-1]*v[dx[i]]%mod;\n\tfor(int i=n;i;--i)\n\t\thz[i]=1ll*hz[i+1]*v[dx[i]]%mod;\n\tfor(int i=1;i<=n;++i)\n\t\tans=(ans+1ll*zs[i]*qz[w[i]-1]%mod*hz[w[i]+sz[i]])%mod;\n}\nint main(){\n\tscanf(\"%d%d\",&n,&m);\n\tfor(int i=1;i<n;++i){\n\t\tscanf(\"%d%d\",&a,&b);\n\t\tadd(a,b);\n\t\tadd(b,a);//\u8fde\u8fb9\n\t}\n\tfor(int i=1;i<=n;++i){\n\t\tscanf(\"%d\",c+i);\n\t\tzs[i]=c[i];\n\t\tsz[i]=1;\n\t}\n\tfor(int i=1;i<=n;++i)\n\t\tscanf(\"%d\",v+i);\n\tdfs(1,0,m);\n\t/*\u9884\u5904\u7406\u51fadfs\u5e8f\uff0c\u53ca\u6bcf\u4e2a\u70b9\u5728dfs\u5e8f\u4e2d\u7684\u4f4d\u7f6e\uff0c\n\t\u548c\u6bcf\u4e2a\u8282\u70b9\u5b50\u6811\u7684\u6743\u503c\u79ef\u3001\u5b50\u6811\u5927\u5c0f*/\n\tprez(m);//\u8ba1\u7b97\u7b54\u6848\n\tprintf(\"%d\\n\",ans);\n\treturn 0;\n}\n```\n\n**\u6ce8\u610f\uff1a\u672c\u9898\u4e0d\u8981\u4f7f\u7528\u9006\u5143\uff0c\u56e0\u4e3a\u5b50\u6811\u6743\u503c\u79ef\u53ef\u80fd\u662f $m$ \u7684\u500d\u6570\u3002**",
        "postTime": 1684566376,
        "uid": 530915,
        "name": "zyc200156",
        "ccfLevel": 5,
        "title": "P9208 \u865a\u4eba\u300c\u65e0\u300d"
    },
    {
        "content": "## Question \u95ee\u9898 [P9208 \u865a\u4eba\u300c\u65e0\u300d](https://www.luogu.com.cn/problem/P9208)\n\n\u7ed9\u5b9a\u4e8c\u5143\u5e8f\u5217 $\\{(v_i,c_i)\\}$ \u548c\u4e00\u68f5\u4ee5 $1$ \u4e3a\u6839\u7684\u6709\u6839\u6811\u3002\u7b2c $i$ \u4e2a\u70b9\u7684\u70b9\u6743\u662f $(v_i,c_i)$\u3002\n\n- \u5b9a\u4e49\u4e00\u4e2a\u975e\u6839\u8282\u70b9\u7684\u6743\u503c\u4e3a\u5176\u5b50\u6811\u5185\u7684 $c$ \u7684\u79ef\u4e58\u4e0a\u5176\u5b50\u6811\u8865\u7684 $v$ \u7684\u79ef\u3002\n- \u5b9a\u4e49\u4e00\u4e2a\u6839\u8282\u70b9\u7684\u6743\u503c\u4e3a\u5176\u5b50\u6811\u5185\u7684 $c$ \u7684\u79ef\u3002\n\n\u5f62\u5f0f\u5316\u7684\u8bb2\uff0c\u82e5 $u$ \u4e0d\u4e3a\u6839\u8282\u70b9\uff0c\u5219 $u$ \u7684\u6743\u503c $f_u$ \u4e3a\uff1a\n\n$$f_u=\\prod\\limits_{v\\in \\operatorname{substree}(u)} c_v\\times \\prod\\limits_{v\\notin \\operatorname{substree}(u)} v_v$$\n\n\u5426\u5219\uff0c\u5176\u6743\u503c $f_u$ \u4e3a\uff1a\n\n$$f_u=\\prod\\limits_{v=1}^n c_v$$\n\n\u8bd5\u6c42\u6574\u68f5\u6811**\u6240\u6709\u8282\u70b9\u7684\u6743\u503c\u4e4b\u548c**\uff0c\u7b54\u6848\u5bf9 $m$ \u53d6\u6a21\u3002\u8bf7\u6ce8\u610f\uff1a**\u4fdd\u8bc1 $\\bm m$ \u662f\u8d28\u6570**\u3002\n\n## Analysis \u5206\u6790 \n\n#### \u5b9a\u4e49\uff1a\n\n$dfn_x$ \u4e3a $x$ \u7684 $dfs$ \u5e8f\u3002\n\n$siz_x$ \u4e3a $x$ \u7684\u5b50\u6811\u5927\u5c0f\u3002\n\n### \u5148\u8bb2\u6b63\u89e3\uff1adfs \u5e8f & \u7ebf\u6bb5\u6811\u67e5\u8be2\n\n\u6211\u4eec\u8dd1\u4e00\u904d $dfs$ \u5e8f\u4e4b\u540e\uff0c\u601d\u8003\u5bf9\u4e8e\u4e00\u4e2a\u70b9 $x$\uff0c\u5176\u5b50\u8282\u70b9\u6240\u5728\u7684 $dfs$ \u5e8f\u5fc5\u7136\u5728\u533a\u95f4 $dfn_{x} \\sim dfn_{x}+siz_{x}-1$ \u4e4b\u4e2d\u3002\n\n\u63a5\u4e0b\u6765\u6211\u4eec\u53ea\u9700\u8981\u7ef4\u62a4\u533a\u95f4\u5185 $c,v$ \u7684\u4e58\u79ef\uff0c\u663e\u7136\u6211\u4eec\u53ea\u9700\u8981\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u4e00\u4e0b\u4e58\u79ef\u5c31\u884c\u4e86\u3002\n\n### \u4ee5\u4e0b\u662f\u9519\u89e3\uff1a\u9006\u5143(\u53ef\u9009\u62e9\u4e0d\u770b)\n\n\u8003\u8651\u4e00\u4e2a\u975e\u5e38\u81ea\u7136\u5c31\u80fd\u60f3\u5230\u7684\u65b9\u6cd5\uff0c\u770b\u5230\u53d6\u6a21\uff0c\u60f3\u7528\u9006\u5143\u3002\u4f46\u662f\u5728\u672c\u9898\u4e0d\u884c\u3002\u56e0\u4e3a\u4f7f\u7528\u9006\u5143\u9700\u8981\u5f53\u6240\u6709\u53c2\u4e0e\u8ba1\u7b97\u7b54\u6848\u7684\u503c\u5747\u5b58\u5728\u9006\u5143\uff0c\u5373\u6a21\u6570 $m \\perp c_i,v_i$\u3002\n\n\u6240\u4ee5\u8fd9\u9053\u9898\u53ef\u4ee5\u901a\u8fc7\u7279\u6b8a\u6784\u9020\u5361\u6389\u9006\u5143\u505a\u6cd5\u3002\n\n## Code \u4ee3\u7801\n\n```cpp\n#include<bits/stdc++.h>\n#define rint register int\n#define ls (p<<1)\n#define rs (p<<1|1)\nusing namespace std;\ntypedef long long ll;\nconst int N=3e5+8;\nint n,x,y,tot,cnt,mod;\nint head[N],siz[N],dfn[N];\nll c[N],v[N],ans;\nstruct edge{\n\tint nxt,to;\n}e[N<<1];\nstruct tree{\n\tint l,r;\n\tll csum,vsum;\n\t#define l(p) t[p].l\n\t#define r(p) t[p].r\n\t#define cs(p) t[p].csum\n\t#define vs(p) t[p].vsum\n}t[N<<2];\ninline void add(int a,int b){e[++tot]={head[a],b};head[a]=tot;}\ninline void add(int a,int b,string s){add(a,b);add(b,a);}\ninline void dfs(int x,int fa){\n\tsiz[x]=1;dfn[x]=++cnt;\n\tfor(rint i=head[x];i;i=e[i].nxt){\n\t\tint y=e[i].to;\n\t\tif(y!=fa){\n\t\t\tdfs(y,x);\n\t\t\tsiz[x]+=siz[y];\n\t\t}\n\t}\n}\nvoid build(int p,int l,int r){\n\tl(p)=l;r(p)=r;\n\tif(l==r){cs(p)=c[l],vs(p)=v[l];return;}\n\tint Mid=l+r>>1;\n\tbuild(ls,l,Mid),build(rs,Mid+1,r);\n\tcs(p)=cs(ls)*cs(rs)%mod;\n\tvs(p)=vs(ls)*vs(rs)%mod;\n\treturn ;\n}\nll query(int p,int l,int r,int cmd){\n\tif(l<=l(p)&&r(p)<=r){\n\t\tif(cmd) return vs(p);\n\t\telse return cs(p);\n\t}\n\tll res=1;int Mid=l(p)+r(p)>>1;\n\tif(l<=Mid) res=query(ls,l,r,cmd);\n\tif(r>Mid) res=res*query(rs,l,r,cmd)%mod;\n\treturn res;\n}\nint main(){\n\tread(n,mod);\n\tfor(rint i=1;i<n;i++) read(x,y),add(x,y,\"Mr.Az\");\n\tdfs(1,0);\n\tfor(rint i=1;i<=n;i++) read(c[dfn[i]]);\n\tfor(rint i=1;i<=n;i++) read(v[dfn[i]]);\n\tbuild(1,1,n);\n\tfor(rint i=1;i<=n;i++){\n\t\tll res=1;\n\t\tif(dfn[i]!=1) res=query(1,1,dfn[i]-1,1);\n\t\tres=res*query(1,dfn[i],dfn[i]+siz[i]-1,0)%mod;\n\t\tif(dfn[i]+siz[i]<=n) res=res*query(1,dfn[i]+siz[i],n,1)%mod;\n\t\tans=(ans+res)%mod;\n\t}\n\tprintf(\"%lld\\n\",ans);\n    return 0;\n}\n```",
        "postTime": 1682423866,
        "uid": 536560,
        "name": "Mr_Az",
        "ccfLevel": 4,
        "title": "P9208 \u865a\u4eba\u300c\u65e0\u300d"
    },
    {
        "content": "\u9996\u5148\u4e86\u89e3\u4e0b dfn \u7684\u6027\u8d28\u3002\n\n\u5bf9\u4e8e\u4e00\u4e2a\u70b9 $x$\uff0c\u5176\u5b50\u8282\u70b9\u6240\u5728\u7684 dfn \u5e8f\u5fc5\u7136\u5728\u533a\u95f4 $dfn[x]\\sim dfn[x]+size[x]-1$\uff0c\u5176\u4e2d `size[x]` \u4e3a\u70b9 $x$ \u7684\u5b50\u6811\u5927\u5c0f\u3002\n\n\u663e\u7136\u6211\u4eec\u7528\u4e24\u4e2a\u7ebf\u6bb5\u6811\u7ef4\u62a4\u4e00\u4e0b\u533a\u95f4\u7684\u4e58\u79ef\u5c31\u884c\u4e86,\u679a\u4e3e\u6bcf\u4e2a\u70b9\uff0c\u5c06\u5b83\u662f\u6839\u8282\u70b9\u4e0e\u5426\u7684\u6743\u503c\u6c42\u548c\u5c31\u884c\u3002\n\n```cpp\n#include<bits/stdc++.h>\n#define mi(...) <%__VA_ARGS__%>\n#define int long long\nusing namespace std;\n\nconst int N=3e5+5;\nint n,m,dfn[N],d[N],c[2][N],siz[N],id;\nvector<int> vec[N];\nvoid dfs(int x,int fa) {\n\tdfn[++id]=x;\n\td[x]=id;\n\tsiz[x]=1;\n\tfor(auto u:vec[x]) {\n\t\tif(u==fa)continue;\n\t\tdfs(u,x);\n\t\tsiz[x]+=siz[u];\n\t}\n}\nint mul[2][N<<2];\nvoid pushup(int p,int op) {\n\tmul[op][p]=(mul[op][p<<1]*mul[op][p<<1|1])%m;\n}\nvoid build(int p,int l,int r,int op) {\n\tif(l==r) {\n\t\tmul[op][p]=c[op][dfn[l]];\n\t\treturn ;\n\t}\n\tint mid=l+r>>1;\n\tbuild(p<<1,l,mid,op);\n\tbuild(p<<1|1,mid+1,r,op);\n\tpushup(p,op);\n}\nint query(int p,int l,int r,int L,int R,int op) {\n\tif(L>R)return 1;\n\tint res=1;\n\tif(l>=L && r<=R)return mul[op][p];\n\tint mid=l+r>>1;\n\tif(L<=mid)(res*=query(p<<1,l,mid,L,R,op))%=m;\n\tif(R>mid)(res*=query(p<<1|1,mid+1,r,L,R,op))%=m;\n\treturn res;\n}\nsigned main() {\n\tn=read(),m=read();\n\tfor(int i=1,u,v; i<n; ++i)\n\t\tu=read(),v=read(),\n\t\tvec[u].push_back(v),\n\t\tvec[v].push_back(u);\n\tint ans=1;\n\tfor(int i=1; i<=n; ++i)(ans*=(c[0][i]=read())%m)%=m;\n\tfor(int i=1; i<=n; ++i)c[1][i]=read();\n\tdfs(1,0);\n\tbuild(1,1,n,0);\n\tbuild(1,1,n,1);\n\tfor(int i=2;i<=n;++i)\n\t\t(ans+=query(1,1,n,d[i],d[i]+siz[i]-1,0)*query(1,1,n,1,d[i]-1,1)%m*query(1,1,n,d[i]+siz[i],n,1)%m)%=m;\n\twrite(ans),puts(\"\");\n\treturn(0-0);\n}\n```\n\n",
        "postTime": 1681118351,
        "uid": 388414,
        "name": "comcopy",
        "ccfLevel": 0,
        "title": "P9208 \u9898\u89e3"
    },
    {
        "content": "### \u9898\u76ee\u5206\u6790\uff1a\n\n\u8d77\u5148\u7684\u505a\u6cd5\u662f\u9884\u5904\u7406\u51fa\u6bcf\u4e2a\u7ed3\u70b9\u5176\u5b50\u6811\u7684 $c_i$ \u548c $v_i$ \u4e4b\u79ef\uff0c\u5206\u522b\u8bb0\u4f5c $S1_i$ \u548c $S2_i$\uff0c\u663e\u7136\u7b54\u6848\u5c31\u662f $\\begin{aligned}\\sum_{i=1}^n S1_i\\times S2_1\\times \\operatorname{inv}(S2_i)\\end{aligned}$ \u3002\u4f46\u662f\u8fd9\u9053\u9898 $m$ \u8d77\u5148\u4e0d\u662f\u8d28\u6570\uff0c\u5373\u4f7f\u540e\u6765\u6539\u6210\u8d28\u6570\u4ecd\u7136\u5b58\u5728\u6ca1\u6709\u9006\u5143\u7684\u60c5\u51b5\u3002\u8fd9\u79cd\u505a\u6cd5\u4e0d\u884c\u3002\n\n\u90a3\u4e48\u6362\u79cd\u505a\u6cd5\u3002\u5c06\u8fd9\u68f5\u6811\u62cd\u6241\u6210 dfs \u5e8f\uff0c\u663e\u7136\u5bf9\u4e8e\u7b2c $i$ \u4e2a\u7ed3\u70b9\uff0c\u5176\u5bf9\u5e94\u7684 dfs \u5e8f\u4e3a $id_i$\uff0c\u5b50\u6811\u5927\u5c0f $sz_i$\uff0c\u90a3\u4e48\u5176\u5b50\u6811\u5bf9\u5e94\u5e8f\u5217 $id_i\\sim id_i+sz_i-1$\uff0c\u5176\u4f59\u90e8\u5206\u5bf9\u5e94\u5176\u8865\u6811\u3002\n\n\u8003\u8651\u4e00\u4e2a\u80fd\u533a\u95f4\u8be2\u95ee\u7684\u6570\u636e\u7ed3\u6784\u6216\u7b97\u6cd5\uff0c\u663e\u7136\u524d\u7f00\u548c\u548c\u6811\u72b6\u6570\u7ec4\u4e0d\u884c\u3002\u56e0\u4e3a\u4ed6\u4eec\u6d89\u53ca\u5230\u9006\u5143\u3002\u6240\u4ee5\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811\u6765\u7ef4\u62a4\u533a\u95f4\u548c\u3002\n\n### \u4ee3\u7801\u5982\u4e0b\uff1a\n\n```\n#include<bits/stdc++.h>\nusing namespace std;\ntypedef long long ll;\nconst int N=3e5+10;\n//===\n//\u7f3a\u7701\u6e90\n//===\nint n;\nll mod;\nvector<int> a[N];\nll c[N],v[N],w1[N],w2[N],s1[N],s2[N],id[N],cnt=0;\nint sz[N];\nvoid dfs1(int x,int F){\n\tid[x]=++cnt;w1[cnt]=c[x],w2[cnt]=v[x];sz[x]=1;\n\tfor(auto y:a[x]){\n\t\tif(y==F)continue;\n\t\tdfs1(y,x);sz[x]+=sz[y];\n\t}\n}ll ans=0;\nll tr1[N<<2],tr2[N<<2];\nvoid pushup(int rt){tr1[rt]=tr1[rt<<1]*tr1[rt<<1|1]%mod,tr2[rt]=tr2[rt<<1]*tr2[rt<<1|1]%mod;}\nvoid build(int rt,int l,int r){\n\tif(l==r)return tr1[rt]=w1[l],tr2[rt]=w2[l],void();\n\tint mid=l+r>>1;\n\tbuild(rt<<1,l,mid);\n\tbuild(rt<<1|1,mid+1,r);\n\tpushup(rt);\n}ll query1(int rt,int l,int r,int x,int y){\n\tif(x<=l&&r<=y)return tr1[rt];\n\tint mid=l+r>>1;ll ans=1;\n\tif(x<=mid)ans=ans*query1(rt<<1,l,mid,x,y)%mod;\n\tif(y>mid)ans=ans*query1(rt<<1|1,mid+1,r,x,y)%mod;\n\treturn ans;\n}ll query2(int rt,int l,int r,int x,int y){\n\tif(x>y||x>n)return 1;//\u7279\u5224\n\tif(x<=l&&r<=y)return tr2[rt];\n\tint mid=l+r>>1;ll ans=1;\n\tif(x<=mid)ans=ans*query2(rt<<1,l,mid,x,y)%mod;\n\tif(y>mid)ans=ans*query2(rt<<1|1,mid+1,r,x,y)%mod;\n\treturn ans;\n}\nint main(){\n\t//freopen(\".in\",\"r\",stdin);\n\t//freopen(\".out\",\"w\",stdout);\n\tn=IO::readInt(),mod=IO::readInt();\n\tfor(int i=1;i<n;i++){\n\t\tint x=IO::readInt(),y=IO::readInt();\n\t\ta[x].pd(y),a[y].pd(x);\n\t}for(int i=1;i<=n;i++)c[i]=IO::readInt();\n\tfor(int i=1;i<=n;i++)v[i]=IO::readInt();\n\tfor(int i=1;i<=n*4;i++)tr1[i]=tr2[i]=1;\n\tdfs1(1,0);build(1,1,n);\n\tll ans=0;\n\tfor(int i=1;i<=n;i++)\n\t\tans=(ans+query1(1,1,n,id[i],id[i]+sz[i]-1)*query2(1,1,n,1,id[i]-1)%mod*query2(1,1,n,id[i]+sz[i],n)%mod)%mod;\n\tprintf(\"%lld\\n\",ans);\n\treturn 0;\n}\n\n\n```\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a$O(n\\log n)$\u3002",
        "postTime": 1681118202,
        "uid": 511271,
        "name": "\u30c0\u6708",
        "ccfLevel": 5,
        "title": "\u865a\u4eba\u300c\u65e0\u300d"
    }
]