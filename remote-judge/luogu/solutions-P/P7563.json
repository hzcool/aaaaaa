[
    {
        "content": "\u8003\u8651 $i$ \u5411 $a_i$ \u8fde\u8fb9\uff0c\u6784\u6210\u4e00\u4e2a\u5185\u5411\u57fa\u73af\u6811\uff0c\u6ce8\u610f\u5230\u73af\u4e0a\u7684\u4eba\u7684 Rating \u90fd\u5e94\u76f8\u7b49\uff0c\u800c\u6811\u4e0a\u7956\u5148\u7684 Rating \u90fd\u6bd4\u540e\u4ee3\u5c0f\u3002\n\n\u5047\u8bbe\u53ea\u6709\u4e00\u68f5\u6811\u7684\u60c5\u51b5\u3002\u6ce8\u610f\u5230\u8fd9\u6837\u4e00\u4e2a\u4e8b\u5b9e\uff1a\n\n\u5f53\u786e\u5b9a\u597d\u4e0d\u66f4\u6539\u54ea\u4e00\u4e9b\u4eba\u7684 Rating \u65f6\uff0c\u5982\u679c\u8fd9\u4e9b\u4eba\u7684 Rating \u6ee1\u8db3\u4e86\u4ed6\u4eec\u4e4b\u95f4\u5df2\u7ecf\u6709\u4e86\u7684\u9650\u5236\u5173\u7cfb\uff0c\u5269\u4e0b\u7684\u4eba\u901a\u8fc7\u66f4\u6539 Rating \u4e00\u5b9a\u80fd\u591f\u6ee1\u8db3\u9898\u610f\u3002\n\n\u95ee\u9898\u8f6c\u5316\u6210\u4e86\u4fdd\u7559\u4e00\u5b9a\u6570\u91cf\u7684\u70b9\u6ee1\u8db3\u9650\u5236\u5173\u7cfb\uff0c\u4e14\u8fd9\u4e9b\u70b9\u7684\u6743\u503c\u548c\u6700\u5927\uff0c\u60f3\u5230\u6811\u5f62 DP\u3002\n\n\u8bbe $f_u$ \u8868\u793a\u7b2c $u$ \u4e2a\u4eba\u5fc5\u987b\u9009\uff0c\u5176\u5b50\u6811\u4e2d\u7684\u9009\u62e9\u7684\u70b9\u6743\u503c\u548c\u7684\u6700\u5927\u503c\u3002\n\n$$f_u=c_u+\\max_{S\\in subtree(u)/\\{u\\}}\\sum_{v \\in S} f_v$$\n\n\u5176\u4e2d $S$ \u662f\u4e24\u4e24\u6ca1\u6709\u7956\u5148\u5173\u7cfb\u4e14 Rating \u90fd\u5927\u4e8e $h_u$ \u7684\u4e00\u4e9b\u70b9\u7684\u96c6\u5408\u3002\n\n\u53d1\u73b0\u8fd9\u4e9b\u70b9\u7684\u9009\u53d6\u8ddf $h_u$ \u6709\u5173\uff0c\u628a $h_u$ \u79bb\u6563\u5316\u540e\u8bb0\u8fd9\u4e9b\u8f6c\u79fb\u5f0f\u53f3\u8fb9\u90a3\u5768\u4e3a $g_{u,i}$\uff0c\u8868\u793a\u4ec5\u8003\u8651\u90a3\u4e9b $h_v\\geq i$ \u7684\u70b9\u7684\u7b54\u6848\u3002\n\n\u8fd9\u6837\u5b50\u5c31 $f_u=c_u+g_{u,h_u}$ \u4e86\u3002\n\n\u8f6c\u79fb $g$ \u6570\u7ec4\u5c31\u628a\u5404\u4e2a\u513f\u5b50\u5bf9\u5e94\u4f4d\u7f6e\u7684\u503c\u76f8\u52a0\uff0c\u518d\u4e0e\u7236\u4eb2\u7684 DP \u503c $[1,h_u]$ \u524d\u7f00\u53d6 max \u5373\u53ef\uff0c\u7ebf\u6bb5\u6811\u5408\u5e76\u7ef4\u62a4\u3002\n\n\u73b0\u5728\u7ebf\u6bb5\u6811\u8981\u652f\u6301\u533a\u95f4\u53d6 max \u548c\u5408\u5e76\uff0c\u4e5f\u5c31\u662f\u8bf4\u8981\u53d6 max \u8fd8\u8981\u52a0\uff0c\u60f3\u4e86\u5f88\u4e45\u3002\n\n\u540e\u6765\u95ee\u4e86\u540c\u673a\u623f\u6570\u636e\u7ed3\u6784\u795e\u4ed9\u624d\u77e5\u9053\u8981\u7ef4\u62a4\u4e24\u4e2a\u61d2\u6807\u8bb0\uff0c\u50cf\u7ebf\u6bb5\u68112\u4e00\u6837\u5148 max \u540e +\uff0c\u672c\u8d28\u4e0a\u662f\u5e7f\u4e49\u77e9\u9635\u4e58\u6cd5\uff0c\u5199\u4e00\u4e2a struct \u590d\u5408\u61d2\u6807\u8bb0\u5373\u53ef\u3002\n\n\u81f3\u4e8e\u73af\u4e0a\u7684\u8bdd\u679a\u4e3e\u5c06\u503c\u4fee\u6539\u6210\u73af\u4e0a\u7684\u54ea\u4e00\u4e2a\u503c\u6216\u8005\u662f\u5168\u5c40\u6700\u5c0f\u503c\uff0c\u53d6\u6700\u5927\u503c\u7edf\u8ba1\u7b54\u6848\u3002\n\n\u4ee3\u7801\uff1a\n\n```cpp\n#include <cstdio>\n#include <algorithm>\nusing namespace std;\nconst int _=200003;\nint n,cnt;\nint a[_],h[_],c[_],t[_];\nint read(){\n\tchar c=getchar();int x=0;\n\twhile (c<48||c>57) c=getchar();\n\tdo x=(x<<1)+(x<<3)+(c^48),c=getchar();\n\twhile (c>=48&&c<=57);\n\treturn x;\n}\ntypedef long long ll;\nstruct tags{ll a,c;tags(ll A=0,ll C=0):a(A),c(C){}};\ntags operator*(const tags x,const tags y){\n\treturn tags(max(x.a,y.a-x.c),x.c+y.c); //\u8fd9\u91cc\u9700\u8981\u7a0d\u5fae\u63a8\u4e0b\u5f0f\u5b50\n}\nint hd[_],ver[_],nxt[_],tot;\nvoid add(int u,int v){nxt[++tot]=hd[u];hd[u]=tot;ver[tot]=v;}\ntags sg[_<<6];\nint lc[_<<6],rc[_<<6];\nvoid pushdown(int p){\n\tif (sg[p].a||sg[p].c){\n\t\tif (!lc[p]) lc[p]=++cnt;\n\t\tsg[lc[p]]=sg[lc[p]]*sg[p];\n\t\tif (!rc[p]) rc[p]=++cnt;\n\t\tsg[rc[p]]=sg[rc[p]]*sg[p];\n\t\tsg[p]=tags();\n\t}\n}\nll query(int x,int &p,int l=1,int r=n){\n\tif (!p) p=++cnt;\n\tif (l==r) return sg[p].a+sg[p].c;\n\tpushdown(p);\n\tint mid=(l+r)>>1;\n\tif (x<=mid) return query(x,lc[p],l,mid);\n\telse return query(x,rc[p],mid+1,r);\n}\nvoid modify(int x,ll v,int &p,int l=1,int r=n){\n\tif (!p) p=++cnt;\n\tif (x>=r) {sg[p]=sg[p]*tags(v,0);return;}\n\tpushdown(p);\n\tint mid=(l+r)>>1;\n\tmodify(x,v,lc[p],l,mid);\n\tif (x>mid) modify(x,v,rc[p],mid+1,r);\n}\nint merge(int u,int v){\n\tif (!u||!v) return u^v;\n\tif (!lc[u]&&!rc[u]) u^=v^=u^=v;\n\tif (!lc[v]&&!rc[v]) sg[u]=sg[u]*tags(0,sg[v].a+sg[v].c);\n    //\u6bcf\u4e00\u6b21\u90fdpushdown\u5f3a\u884c\u65b0\u5efa\u8282\u70b9\u590d\u6742\u5ea6\u4f1a\u7206\u70b8\uff0c\u6240\u4ee5\u6ca1\u6709\u513f\u5b50\u8282\u70b9\u65f6\u6539\u4e3a\u6dfb\u52a0\u52a0\u6cd5\u61d2\u6807\u8bb0\n\telse pushdown(u),pushdown(v);\n\tlc[u]=merge(lc[u],lc[v]);\n\trc[u]=merge(rc[u],rc[v]);\n\treturn u;\n}\nint rt[_];ll buc[_];\nbool vis[_],cir[_],tmp[_];\nvoid dfs(int u){\n\tfor (int i=hd[u]; i; i=nxt[i]){\n\t\tint v=ver[i];\n\t\tif (cir[v]) continue;\n\t\tdfs(v);\n\t\trt[u]=merge(rt[u],rt[v]);\n\t}\n\tll v=query(h[u],rt[u])+c[u];\n\tif (!cir[u]) modify(h[u],v,rt[u]);\n}\nint main(){\n\tll sum=0; n=read();\n\tfor (int i=1; i<=n; ++i){\n\t\ta[i]=read(); t[i]=h[i]=read();\n\t\tsum+=c[i]=read(); add(a[i],i);\n\t}\n\tsort(t+1,t+n+1);\n\tint rk=unique(t+1,t+n+1)-t-1;\n\tfor (int i=1; i<=n; ++i) h[i]=lower_bound(t+1,t+rk+1,h[i])-t;\n\tfor (int i=1; i<=n; ++i)\n\t\tif (!vis[i]){\n\t\t\tint cur=i;\n\t\t\twhile (!vis[cur]) tmp[cur]=vis[cur]=1,cur=a[cur];\n\t\t\tif (tmp[cur]) while (!cir[cur]) cir[cur]=1,cur=a[cur];\n\t\t\tcur=i;while (tmp[cur]) tmp[cur]=0,cur=a[cur];\n\t\t}\n\tfor (int i=1; i<=n; ++i) if (cir[i]) dfs(i);\n\tfor (int i=1; i<=n; ++i)\n\t\tif (cir[i]){\n\t\t\tint cur=i;\n\t\t\twhile (cir[cur]){\n\t\t\t\tcir[cur]=0;\n\t\t\t\tif (cur^i) rt[i]=merge(rt[i],rt[cur]);\n\t\t\t\tbuc[h[cur]]+=c[cur];\n\t\t\t\tcur=a[cur];\n\t\t\t}\n\t\t\tll res=query(1,rt[i]);\n\t\t\twhile (!tmp[cur]){\n\t\t\t\ttmp[cur]=1;\n\t\t\t\tres=max(res,query(h[cur],rt[i])+buc[h[cur]]);\n\t\t\t\tcur=a[cur];\n\t\t\t}\n\t\t\tsum-=res;\n\t\t\twhile (tmp[cur]){\n\t\t\t\ttmp[cur]=0;\n\t\t\t\tbuc[h[cur]]=0;\n\t\t\t\tcur=a[cur];\n\t\t\t}\n\t\t}\n\tprintf(\"%lld\\n\",sum);\n\treturn 0;\n}\n```\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(n\\log_2n)$",
        "postTime": 1643100167,
        "uid": 163729,
        "name": "yyyyxh",
        "ccfLevel": 7,
        "title": "[JOISC 2021 Day4] \u6700\u60aa\u306e\u8a18\u8005 4 \u9898\u89e3"
    },
    {
        "content": "## Description\n\u6709 $n$ \u4e2a\u4eba\uff0c\u7b2c $i$ \u4e2a\u4eba\u7684\u5206\u6570\u4e3a $h_i$\uff0c\u4fee\u6539 $h_i$ \u9700\u8981 $c_i$ \u5143\uff0c\u8981\u6c42 $h_i \\ge h_{a_i}$\uff0c\u6c42\u6700\u5c0f\u4fee\u6539\u8d39\u7528\u3002\n![\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0](https://img-blog.csdnimg.cn/20210718134829554.png)\n![\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0](https://img-blog.csdnimg.cn/20210718134842633.png)\n\n\n## Solution\n\u9996\u5148\u8003\u8651\u6839\u636e\u9898\u76ee\u7ed9\u51fa\u7684\u4e0d\u7b49\u5173\u7cfb\u5efa\u56fe\uff0c\u6211\u4eec\u53d1\u73b0 Subtask 1 \u548c Subtask 2 \u5c31\u662f\u4e00\u68f5\u5185\u5411\u6811\uff0c\u8fdb\u4e00\u6b65\u63a8\u5bfc\u51fa\u65e0\u7279\u6b8a\u9650\u5236\u65f6\u7684\u56fe\u4e3a\u57fa\u73af\u5185\u5411\u6811\u68ee\u6797\u3002\n\n\u8003\u8651\u9488\u5bf9 Subtask 1 \u8bbe\u8ba1\u4e00\u4e2a ${\\rm O}(n^2)$ \u7684\u7b97\u6cd5\uff0c\u5bb9\u6613\u53d1\u73b0\u5e94\u9009\u62e9\u6811\u5f62 DP\u3002\u7531\u4e8e\u6211\u4eec\u53ea\u9700\u8981\u5224\u65ad\u4fee\u6539\u540e\u7684 $h_i$ \u4e0e\u539f $h_i$ \u7684\u4e0d\u7b49\u5173\u7cfb\uff0c\u6240\u4ee5\u53ef\u4ee5\u5c06 $h_i$ \u79bb\u6563\u5316\uff0c\u65b9\u4fbf\u5b58\u50a8\u7a7a\u95f4\u3002\n\n\u6211\u4eec\u8bbe $f_{i,j}$ \u4e3a\u4fee\u6539 $h_i$ \u4e3a $j$ \u540e\uff0c\u6ee1\u8db3 $i$ \u5b50\u6811\u4e2d\u7684\u4e0d\u7b49\u5173\u7cfb\u6240\u9700\u7684\u6700\u5c0f\u82b1\u8d39\uff0c\u8bbe $m$ \u4e3a\u79bb\u6563\u5316\u540e\u7684 $h_i$ \u4e0a\u754c\u3002\u53ef\u4ee5\u63a8\u5bfc\u51fa\u72b6\u6001\u8f6c\u79fb\u65b9\u7a0b\n\n$$f_{i,j}=c_i \\times [j\\not=h_i]+\\sum_{k \\in {\\rm son}_i} \\min_{j \\le l \\le m} \\big\\{f_{k,l}\\big\\}$$\n\n\u8fd9\u4e2a\u7b97\u6cd5\u867d\u7136\u8d85\u65f6\uff0c\u4f46\u662f\u662f\u6b63\u786e\u7684\uff0c\u8fd9\u542f\u53d1\u6211\u4eec\u8fdb\u4e00\u6b65\u4f18\u5316 DP \u8f6c\u79fb\u3002\u4f18\u5316\u5230 ${\\rm O}(n)$ \u6bd4\u8f83\u4e0d\u73b0\u5b9e\uff0c\u8003\u8651\u4f18\u5316\u5230 ${\\rm O}(n \\log n)$\u3002\n\n\u6211\u4eec\u53d1\u73b0 $f_{i,j}$ \u4e2d\u7b2c\u4e8c\u7ef4\u6709\u503c\u7684 $c_i \\times [j\\not=h_i]$ \u5360\u6570\u7ec4\u7684\u5927\u90e8\u5206\uff0c\u5982\u679c\u7528\u6570\u636e\u7ed3\u6784\u6765\u7ef4\u62a4\u7684\u8bdd\u4f1a\u589e\u52a0\u8bb8\u591a\u8d58\u4f59\u7684\u64cd\u4f5c\u3002\u4f46\u662f $c_{1} \\sim c_n$ \u7684\u548c\u662f\u4e0d\u53d8\u7684\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u5c06\u72b6\u6001\u8f6c\u79fb\u65b9\u7a0b\u53d8\u6210\u8fd9\u6837\uff1a\n\n$$f_{i,j}=\\sum_{k \\in {\\rm son}_i} \\min_{j \\le l \\le m} \\big\\{f_{k,l}\\big\\}-c_i \\times [j=h_i]$$\n\n\u7136\u540e\u518d\u7528 $c_{1} \\sim c_n$ \u7684\u548c\u52a0\u4e0a $\\min f_{1,i}$\uff0c\u8fd9\u6837\u53ea\u9700\u8981\u8fdb\u884c\u5355\u70b9\u51cf\u503c\uff0c\u5374\u6709\u76f8\u540c\u7684\u6548\u679c\uff0c\u5927\u5927\u7f29\u77ed\u4e86\u65f6\u95f4\u3002\n\n\u72b6\u6001\u8f6c\u79fb\u4e2d\u53ea\u6709\u7b80\u5355\u7684\u5355\u70b9\u52a0\u503c\u548c\u533a\u95f4\u67e5\u8be2\u6700\u5c0f\u503c\u64cd\u4f5c\uff0c\u4e0d\u59a8\u4f7f\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4 $f_{i,j}$ \u4e2d\u7684\u7b2c\u4e8c\u7ef4\uff0c\u7ed9\u6bcf\u4e2a\u70b9\u5f00\u4e00\u68f5\u7ebf\u6bb5\u6811\u663e\u7136\u4e0d\u53ef\u884c\uff0c\u56e0\u6b64\u60f3\u5230\u91c7\u7528\u7ebf\u6bb5\u6811\u5408\u5e76\u3002\n\n\u627e\u533a\u95f4\u6700\u5c0f\u503c\u65f6\u7684\u533a\u95f4\u662f $[j,m]$\uff0c\u7136\u540e\u518d\u5c06\u6bcf\u4e2a\u5b50\u6811\u4e2d\u7684\u6700\u5c0f\u503c\u52a0\u8d77\u6765\u3002\u5408\u5e76\u6811 $u$ \u548c\u6811 $v$ \u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u8bb0\u5f55 $u_{\\min}$ \u548c $v_{\\min}$ \u4e3a\u4e24\u68f5\u6811\u5404\u81ea\u7684\u6700\u5c0f\u503c\u3002\u8bbe\u5f53\u524d\u7ed3\u70b9\u4e3a $p$ \u548c $q$\uff0c\u7136\u540e\u8ba8\u8bba $p+v_{\\min}$ \u662f\u5426\u5c0f\u4e8e $q+u_{\\min}$\u3002\n\n$j$ \u867d\u7136\u4e0d\u786e\u5b9a\uff0c\u4f46\u662f\u53f3\u7aef\u70b9 $m$ \u662f\u56fa\u5b9a\u7684\u3002\u56e0\u6b64\u6211\u4eec\u5728\u5408\u5e76\u65f6\u4e0d\u53ef\u4ee5\u7528\u5e73\u5e38\u7684\u65b9\u5f0f\u5408\u5e76\uff0c\u800c\u662f\u5148\u5408\u5e76\u53f3\u5b50\u6811\uff0c\u518d\u5408\u5e76\u5de6\u5b50\u6811\u3002\uff08\u60f3\u4e00\u60f3\uff0c\u4e3a\u4ec0\u4e48\uff09\u7136\u540e\u7b80\u5355\u7ef4\u62a4 $c_i \\times [j=h_i]$ \u7684\u5355\u70b9\u4fee\u6539\u548c\u5408\u5e76\u65f6\u9047\u5230\u4e00\u8fb9\u7a7a\u6811\u7684\u533a\u95f4\u52a0\u6807\u8bb0\u5c31\u597d\u4e86\u3002\n\n\u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u5f97\u5230\u4e86\u9488\u5bf9 Subtask 1 \u548c Subtask 2 \u7684 ${\\rm O}(n \\log n)$ \u6811\u5f62 DP \u7b97\u6cd5\u3002\u6211\u4eec\u53d1\u73b0\u5b83\u540c\u6837\u9002\u7528\u4e8e\u5185\u5411\u6811\u68ee\u6797\uff0c\u53ea\u9700\u8981\u5bf9\u6bcf\u4e00\u68f5\u6811\u5206\u522b\u8dd1\u4e00\u904d DP \u5c31\u597d\u4e86\u3002\n\n\u5bf9\u4e8e\u57fa\u73af\u6811\uff0c\u6211\u4eec\u53ef\u4ee5\u5148\u505a\u4e00\u6b21\u62d3\u6251\u6392\u5e8f\u6216\u8005 Tarjan \u7b97\u6cd5\u627e\u5f3a\u8fde\u901a\u5206\u91cf\u3002\u627e\u51fa\u73af\u540e\u5c06\u5176\u770b\u4f5c\u4e00\u4e2a\u70b9\uff0c\u5c06\u4e0e\u73af\u76f8\u8fde\u7684\u6240\u6709\u5b50\u6811\u7684\u7ebf\u6bb5\u6811\u8fdb\u884c\u5408\u5e76\u3002\u5bb9\u6613\u53d1\u73b0\u73af\u4e0a\u6bcf\u4e2a\u70b9\u7684\u6700\u7ec8\u503c\u4e00\u5b9a\u76f8\u7b49\uff0c\u800c\u4e14\u662f\u73af\u4e0a\u7684\u67d0\u4e2a\u503c\u6216\u8005\u6700\u5c0f\u503c $1$\u3002\u4e8e\u662f\u6211\u4eec\u679a\u4e3e\u73af\u7684\u6700\u7ec8\u503c\uff0c\u540c\u65f6\u5728\u7ebf\u6bb5\u6811\u4e0a\u67e5\u8be2 $[h_i,m]$ \u7684\u6700\u5c0f\u503c\u66f4\u65b0\u7b54\u6848\u3002\u81f3\u6b64\u672c\u9898\u5f97\u5230\u5b8c\u6574\u89e3\u6cd5\u3002\n\n### Warning\n\u7ebf\u6bb5\u6811\u5408\u5e76\u7684\u7a7a\u95f4\u590d\u6742\u5ea6\u4e3a ${\\rm O}(n \\log n)$ \u800c\u975e ${\\rm O}(n)$\uff0c\u8fd8\u5e26\u70b9\u9644\u52a0\u5e38\u6570\uff0c\u56e0\u6b64\u8bf7\u5f00 $\\log_2 (2 \\times 10^5) \\times 3 \\approx 54$ \u500d\u7a7a\u95f4\u3002\n\n## Code\n\n```cpp\ntypedef long long LL;\nconst int N=2e5+5;\n\nint n,NumE,rb,tot,a[N],Fir[N],d[N],in[N],dfn[N];\nLL Ret,h[N],c[N];\n\ninline LL Read() {\n\tLL x=0;\n\tchar ch=getchar();\n\n\twhile (ch<'0' || ch>'9') ch=getchar();\n\t\n\twhile (ch>='0' && ch<='9') {\n\t\tx=(x<<3)+(x<<1)+(ch^48);\n\t\tch=getchar();\n\t}\n  \n\treturn x;\n}\n\nstruct Edge {int v,nxt;}E[N];\n\nvoid AddE(int u,int v) {\n\tE[++NumE]={v,Fir[u]};\n\tFir[u]=NumE;\n}\n\nnamespace Seg {\n\tint cnt,rt[N],nt[N],ls[N*54],rs[N*54];\n\tLL d1,d2,v[N*54],t[N*54];\n\t\n\tvoid Chg(int x,LL u) {if (x) v[x]+=u,t[x]+=u;}\n\t\n\tvoid Up(int x) {v[x]=min(v[ls[x]],v[rs[x]]);}\n\t\n\tvoid Dw(int x) {\n\t\tif (!t[x]) return;\n\t\tChg(ls[x],t[x]),Chg(rs[x],t[x]),t[x]=0;\n\t}\n\t\n\tint Upd(int x,int l,int r,int p,LL k) {\n\t\tif (!x) x=++cnt;\n\t\t\n\t\tif (l==r) {\n\t\t\tv[x]=k;\n\t\t\treturn x;\n\t\t}\n\t\t\n\t\tDw(x);\n\t\t\n\t\tint mid=(l+r)>>1;\n\t\tif (p<=mid) ls[x]=Upd(ls[x],l,mid,p,k);\n\t\telse rs[x]=Upd(rs[x],mid+1,r,p,k);\n\t\t\n\t\tUp(x);\n\t\t\n\t\treturn x;\n\t}\n\t\n\tLL Qry(int x,int l,int r,int L,int R) {\n\t\tif (!x) return 0;\n\t\tif (L<=l && r<=R) return v[x];\n\t\t\n\t\tDw(x);\n\t\t\n\t\tint mid=(l+r)>>1;\n\t\tLL Res=0;\n\t\t\n\t\tif (L<=mid) Res=min(Res,Qry(ls[x],l,mid,L,R));\n\t\tif (R>mid) Res=min(Res,Qry(rs[x],mid+1,r,L,R));\n\t\t\n\t\treturn Res;\n\t}\n\t\n\tint Mrg_Dfs(int p,int q,int l,int r) {\n\t\tif (!p && !q) return 0;\n\t\t\n\t\tif (!p) {\n\t\t\td2=min(d2,v[q]),Chg(q,d1);\n\t\t\treturn q;\n\t\t}\n\t\tif (!q) {\n\t\t\td1=min(d1,v[p]),Chg(p,d2);\n\t\t\treturn p;\n\t\t}\n\t\t\n\t\tif (l==r) {\n\t\t\td1=min(d1,v[p]),d2=min(d2,v[q]);\n\t\t\t\n\t\t\tif (v[p]+d2<=v[q]+d1) {\n\t\t\t\tv[p]+=d2;\n\t\t\t\treturn p;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tv[q]+=d1;\n\t\t\t\treturn q;\n\t\t\t}\n\t\t}\n\t\t\n\t\tDw(p),Dw(q);\n\t\t\n\t\tint mid=(l+r)>>1;\n\t\t\n\t\trs[p]=Mrg_Dfs(rs[p],rs[q],mid+1,r);\n\t\tls[p]=Mrg_Dfs(ls[p],ls[q],l,mid);\n\t\t\n\t\tUp(p);\n\t\t\n\t\treturn p;\n\t}\n\t\n\tint Mrg(int x,int y) {\n\t\td1=d2=0;\n\t\treturn Mrg_Dfs(x,y,1,rb);\n\t}\n}\n\nusing namespace Seg;\n\nstruct Cir {\n\tLL h,c;\n\tbool operator<(const Cir& rhs) const {return h<rhs.h;}\n};\nvector<Cir> cr[N];\n\nvoid Dfs(int x) {\n\tfor (int i=Fir[x];i;i=E[i].nxt) {\n\t\tDfs(E[i].v);\n\t\trt[x]=Mrg(rt[x],rt[E[i].v]);\n\t}\n\n\trt[x]=Upd(rt[x],1,rb,h[x],Qry(rt[x],1,rb,h[x],rb)-c[x]);\n}\n\nvoid PushT(int x) {\n\tdfn[x]=tot;\n\tcr[tot].push_back({h[x],c[x]});\n\tif (!dfn[a[x]]) PushT(a[x]);\n}\n\nvoid TopS(int n) {\n\tqueue<int> q;\n\tq=queue<int>();\n\t\n\tFor(i,1,n) if (!in[i]) q.push(i);\n\t\n\twhile (!q.empty()) {\n\t\tint u=q.front();\n\t\tq.pop();\n\t\tif (!--in[a[u]]) q.push(a[u]);\n\t}\n\t\n\tFor(i,1,n) if (!dfn[i] && in[i])\n\t\ttot++,PushT(i);\n}\n\nvoid Calc(int n) {\n\tFor(i,1,n) if (!in[i] && in[a[i]])\n\t\tDfs(i),nt[dfn[a[i]]]=Mrg(nt[dfn[a[i]]],rt[i]);\n\t\n\tFor(i,1,tot) {\n\t\tsort(cr[i].begin(),cr[i].end());\n\t\t\n\t\tLL Cnt=v[nt[i]],sh=cr[i][0].h,sc=cr[i][0].c;\n\t\t\n\t\tFor(j,1,cr[i].size()-1)\n\t\t\tif (sh==cr[i][j].h) sc+=cr[i][j].c;\n\t\t\telse {\n\t\t\t\tCnt=min(Cnt,Qry(nt[i],1,rb,sh,rb)-sc);\n\t\t\t\tsh=cr[i][j].h,sc=cr[i][j].c;\n\t\t\t}\n\t\t\n\t\tCnt=min(Cnt,Qry(nt[i],1,rb,sh,rb)-sc);\n\t\tRet+=Cnt;\n\t}\n}\n\nint main() {\n\tn=Read();\n\t\n\tFor(i,1,n) {\n\t\ta[i]=Read(),h[i]=Read(),c[i]=Read();\n\t\tAddE(a[i],i),in[a[i]]++,d[i]=h[i],Ret+=c[i];\n\t}\n\t\n\tsort(d+1,d+n+1);\n\trb=unique(d+1,d+n+1)-d-1;\n\t\n\tFor(i,1,n) h[i]=lower_bound(d+1,d+rb+1,h[i])-d;\n\t\n\tTopS(n),Calc(n);\n\t\n\tprintf(\"%lld\",Ret);\n\t\n\treturn 0;\n}\n```",
        "postTime": 1626590345,
        "uid": 283913,
        "name": "ZillionX",
        "ccfLevel": 6,
        "title": "\u300c\u9898\u89e3\u300d[JOISC 2021 Day4] \u6700\u60aa\u306e\u8a18\u8005 4"
    },
    {
        "content": "### \u7ebf\u6bb5\u6811\u5408\u5e76\n\n\u4ece\u65e9\u4e0a\u7814\u7a76\u5230\u665a\u4e0a\uff0c\u7ec8\u4e8e\u5e72\u6389\u4e86\u8fd9\u9053\u9898![](//\u5567.tk/fendou)\u3002\n\n\u5bf9\u4e8e\u9898\u76ee\u4e2d**rating**\u5173\u7cfb\u5efa\u56fe\u3002\n\n\u9996\u5148\uff0c\u6bcf\u4e2a\u70b9\u7684\u51fa\u5ea6\u4e3a$1$\uff0c\u56e0\u6b64\u6574\u5f20\u56fe\u662f\u7531\u591a\u4e2a\u57fa\u73af\u5185\u5411\u6811\u7ec4\u6210\u7684\uff0c\u6211\u4eec\u9700\u8981\u5bf9\u4e8e\u6bcf\u4e2a\u57fa\u73af\u5185\u5411\u6811\u8ba1\u7b97\u7b54\u6848\uff0c\u76f8\u52a0\u5373\u53ef\u3002\n\n\u5bb9\u6613\u53d1\u73b0\uff0c\u5728\u4e00\u68f5\u57fa\u73af\u5185\u5411\u6811\u4e0a\uff0c\u73af\u4e0a\u70b9\u7684\u6743\u503c\u5fc5\u7136\u76f8\u7b49\u3002\n\n\u6211\u4eec\u5148\u8003\u8651\u6811\u7684\u60c5\u51b5\uff0c\u9700\u8981\u6ee1\u8db3\u5b50\u8282\u70b9\u7684\u6743\u503c$\\ge$\u7236\u8282\u70b9\u7684\u6743\u503c\uff0c\u53ef\u4ee5\u53d1\u73b0\u6700\u4f18\u65b9\u6848\u4e2d\uff0c\u7236\u8282\u70b9\u7684\u6743\u503c\u4e00\u5b9a\u662f\u4fdd\u6301\u81ea\u5df1\u7684\u6743\u503c\u4e0d\u53d8\uff0c\u6216\u8005\u53d6\u5b50\u8282\u70b9\u4e2d\u7684\u6700\u5c0f\u6743\u503c\u3002\u7136\u540e\u518d\u8003\u8651\u53f6\u5b50\u8282\u70b9\uff0c\u663e\u7136\u5b83\u7684\u6743\u503c\u8981\u4e48\u4fdd\u6301\u4e0d\u53d8\uff0c\u8981\u4e48\u53d6$INF=10^9$\u3002\n\n\u56e0\u6b64\u5728\u4e00\u68f5\u5927\u5c0f\u4e3a$n$\u7684\u57fa\u73af\u5185\u5411\u6811\u4e2d\uff0c\u8282\u70b9\u6743\u503c\u53d6\u503c\u8303\u56f4\u6700\u591a\u53ea\u6709$n+1$\u4e2a\u6570\u3002\u6211\u4eec\u53ef\u4ee5\u8fdb\u884c$dp$\uff0c\u7ef4\u62a4\u4e00\u4e2a\u5b50\u6811\u7684\u6839\u8282\u70b9\u6743\u503c\u7b49\u4e8e\u4efb\u610f\u5728\u5176\u5b50\u6811\u5185\u8282\u70b9\u6743\u503c\uff08\u6216$INF$\uff09\u65f6\u7684\u6700\u5c0f\u4ee3\u4ef7\u3002\u8003\u8651\u5230\u4ece\u5b50\u8282\u70b9\u63a8\u5230\u7236\u8282\u70b9\uff0c\u6bd4\u5982\u4e24\u68f5\u6839\u8282\u70b9\u6743\u503c\u5206\u522b\u4e3a$s,t(s<t)$\u7684\u5b50\u6811\uff0c\u6700\u7ec8\u6211\u4eec\u4f1a\u5c06\u4ed6\u4eec\u4fe9\u7ec4\u6210\u7684\u7b54\u6848\u5408\u5e76\u5230$s$\u4e2d\uff0c\u8fd9\u4e2a\u53ef\u4ee5\u5728\u7ebf\u6bb5\u6811\u5408\u5e76\u7684\u8fc7\u7a0b\u4e2d\u5b9e\u73b0\u3002\u6700\u7ec8\uff0c\u5bf9\u4e8e\u4e00\u68f5\u6811\uff0c\u6211\u4eec\u53ef\u4ee5\u53d6\u51fa\u6839\u8282\u70b9\u7684\u6743\u503c\u7b49\u4e8e\u4efb\u610f\u5728\u5176\u5b50\u6811\u5185\u7684\u8282\u70b9\u6743\u503c\uff08\u6216$INF$\uff09\u60c5\u51b5\u4e0b\u7684\u6700\u5c0f\u4ee3\u4ef7\u3002\n\n\u56e0\u6b64\uff0c\u5bf9\u4e8e\u4e00\u68f5\u57fa\u73af\u5185\u5411\u6811\uff0c\u6211\u4eec\u5148\u5904\u7406\u6bcf\u68f5\u5b50\u6811\uff0c\u7136\u540e\u76f4\u63a5\u679a\u4e3e\u6bcf\u4e2a\u6743\u503c\u6765\u8ba1\u7b97\u7b54\u6848\u3002\u5bf9\u4e8e\u679a\u4e3e\u7684\u6743\u503c$V$\u6765\u8bf4\uff0c\u6bcf\u68f5\u5b50\u6811\u6839\u8282\u70b9\u7684\u6743\u503c\u5fc5\u987b$\\ge V$\uff0c\u6211\u4eec\u53ef\u4ee5\u9ed8\u8ba4\u6839\u8282\u70b9\u6743\u503c\u5fc5\u987b\u66f4\u6539\uff0c\u7136\u540e\u5bf9\u4e8e\u90a3\u4e9b\u6839\u8282\u70b9\u6743\u503c\u4e0d\u66f4\u6539\u7684\u8fdb\u884c\u7279\u5224\u3002\n\n\u6211\u4eec\u4f18\u5316\u8fd9\u4e00\u8fc7\u7a0b\uff0c\u4ece\u5927\u5230\u5c0f\u679a\u4e3e\u6743\u503c\uff0c\u7136\u540e\u5bf9\u4e8e\u6bcf\u68f5\u5b50\u6811\uff0c\u4e0d\u65ad\u62d3\u5c55\u5b83\u7684\u53d6\u503c\u8303\u56f4\uff0c\u8fd9\u53ef\u4ee5\u7528\u4f18\u5148\u961f\u5217\u8fdb\u884c\u52a8\u6001\u7ef4\u62a4\u3002\u540c\u6837\uff0c\u5bf9\u6839\u8282\u70b9\u6743\u503c\u4e0d\u66f4\u6539\u7684\u60c5\u51b5\u8fdb\u884c\u7279\u5224\u3002\n\n\u7136\u540e\u6211\u4eec\u5c31\u89e3\u51b3\u4e86\u8fd9\u9053\u9898\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a$O(n \\log n)$\u3002\n\n$Code:$\n\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<algorithm>\n#include<vector>\n#include<queue>\n#include<map>\n#define N 200005\n#define M 10000005\n#define ll long long\n#define pr pair<int,ll>\n#define mp make_pair\n#define IT vector<int> :: iterator\n#define pIT vector< pr > :: iterator\n#define mIT map<int,bool> :: iterator\nusing namespace std;\nconst ll INF=1919191919191919;\nint n,cc,a[N],h[N],c[N],d[N],rd[N],rt[N];\nvector<int>e[N],val[N];\nvector< pr >co[N];\nqueue<int>q;\nmap<int,bool>ht;\nint z0,z[N];\nbool vis[N];\nint cnt,n1,n2;\nll ans,sz[N],g[N];\n#define ls(p) tr[p].ch[0]\n#define rs(p) tr[p].ch[1]\n#define mn(p) tr[p].Mn\n#define tag(p) tr[p].Tag\nstruct node\n{\n    int ch[2];\n    ll Mn,Tag;\n}tr[M];\nvoid push_tag(int p,ll z)\n{\n    if (!p)\n        return;\n    mn(p)+=z,tag(p)+=z;\n    mn(p)=min(mn(p),INF),tag(p)=min(tag(p),INF);\n}\nvoid push_down(int p)\n{\n    if (tag(p))\n    {\n        push_tag(ls(p),tag(p));\n        push_tag(rs(p),tag(p));\n        tag(p)=0;\n    }\n}\nvoid update(int p)\n{\n    mn(p)=min(mn(ls(p)),mn(rs(p)));\n}\nvoid modify(int &p,int l,int r,int x,int y)\n{\n    if (!p)\n        p=++cnt;\n    if (l==r)\n    {\n        mn(p)+=y;\n        return;\n    }\n    push_down(p);\n    int mid(l+r >> 1);\n    if (x<=mid)\n        modify(ls(p),l,mid,x,y); else\n        modify(rs(p),mid+1,r,x,y);\n    update(p);\n}\nvoid modify2(int &p,int l,int r,int x,ll y)\n{\n    if (!p)\n        p=++cnt;\n    if (l==r)\n    {\n        mn(p)=y;\n        return;\n    }\n    push_down(p);\n    int mid(l+r >> 1);\n    if (x<=mid)\n        modify2(ls(p),l,mid,x,y); else\n        modify2(rs(p),mid+1,r,x,y);\n    update(p);\n}\nint combine(int x,int y,int l,int r,ll xm,ll ym)\n{\n    if (!x && y)\n        push_tag(y,xm);\n    if (x && !y)\n        push_tag(x,ym);\n    if (!x || !y)\n        return x|y;\n    if (l==r)\n    {\n        mn(x)=min(mn(x)+min(ym,mn(y)),mn(y)+min(xm,mn(x)));\n        return x;\n    }\n    push_down(x),push_down(y);\n    int mid(l+r >> 1);\n    ls(x)=combine(ls(x),ls(y),l,mid,min(xm,mn(rs(x))),min(ym,mn(rs(y))));\n    rs(x)=combine(rs(x),rs(y),mid+1,r,xm,ym);\n    update(x);\n    return x;\n}\nll calc(int p,int l,int r,int x,int y)\n{\n    if (!p)\n        return INF;\n    if (l==x && r==y)\n        return mn(p);\n    push_down(p);\n    int mid(l+r >> 1);\n    if (y<=mid)\n        return calc(ls(p),l,mid,x,y); else\n    if (x>mid)\n        return calc(rs(p),mid+1,r,x,y); else\n        return min(calc(ls(p),l,mid,x,mid),calc(rs(p),mid+1,r,mid+1,y));\n}\nvoid dfs(int p,int l,int r,int u)\n{\n    if (!p)\n        return;\n    if (l==r)\n    {\n        co[u].push_back(mp(l,mn(p)));\n        return;\n    }\n    push_down(p);\n    int mid(l+r >> 1);\n    dfs(ls(p),l,mid,u),dfs(rs(p),mid+1,r,u);\n}\nvoid dfs(int u)\n{\n    ht[h[u]]=true;\n    vis[u]=true;\n    sz[u]=c[u];\n    int ct(0);\n    for (IT it=e[u].begin();it!=e[u].end();++it)\n    {\n        int v(*it);\n        if (v==n1 || v==n2)\n            continue;\n        ++ct;\n    }\n    if (!ct)\n    {\n        modify(rt[u],1,cc,h[u],0);\n        modify(rt[u],1,cc,cc,c[u]);\n    } else\n    {\n        for (IT it=e[u].begin();it!=e[u].end();++it)\n        {\n            int v(*it);\n            if (v==n1 || v==n2)\n                continue;\n            dfs(v);\n            sz[u]+=sz[v];\n            if (!rt[u])\n                rt[u]=rt[v]; else\n                rt[u]=combine(rt[u],rt[v],1,cc,INF,INF);\n        }\n        ll zt(calc(rt[u],1,cc,h[u],cc));\n        push_tag(rt[u],c[u]);\n        modify2(rt[u],1,cc,h[u],zt);\n    }\n}\nstruct node2\n{\n    pIT it;\n    int id;\n    node2 () {}\n    node2 (pIT It,int Id):it(It),id(Id) {}\n    bool operator < (const node2 &A) const\n    {\n        return it->first<A.it->first;\n    }\n};\nint main()\n{\n    scanf(\"%d\",&n);\n    for (int i=1;i<=n;++i)\n        scanf(\"%d%d%d\",&a[i],&h[i],&c[i]),e[a[i]].push_back(i),++rd[a[i]],d[i]=h[i];\n    sort(d+1,d+n+1);\n    cc=unique(d+1,d+n+1)-d-1;\n    for (int i=1;i<=n;++i)\n        h[i]=lower_bound(d+1,d+cc+1,h[i])-d;\n    ++cc;\n    for (int i=1;i<=n;++i)\n        if (!rd[i])\n            q.push(i);\n    while (!q.empty())\n    {\n        int u(q.front());\n        vis[u]=true;\n        q.pop();\n        --rd[a[u]];\n        if (!rd[a[u]])\n            q.push(a[u]);\n    }\n    mn(0)=INF;\n    for (int i=1;i<=n;++i)\n        if (!vis[i])\n        {\n            z0=0;\n            z[++z0]=i;\n            for (int j=a[i];j!=i;j=a[j])\n                z[++z0]=j;\n            ll oc(0);\n            priority_queue<node2>Q;\n            for (int j=1;j<=z0;++j)\n            {\n                n1=(j==1)?z[z0]:z[j-1];\n                n2=(j==z0)?z[1]:z[j+1];\n                dfs(z[j]);\n                modify(rt[z[j]],1,cc,h[z[j]],c[z[j]]);\n                dfs(rt[z[j]],1,cc,j);\n                val[h[z[j]]].push_back(j);\n                g[j]=sz[z[j]];\n                oc+=g[j];\n                pIT it=co[j].end();\n                --it;\n                Q.push(node2(it,j));\n            }\n            ht[cc]=true;\n            ll tas(INF);\n            mIT mt=ht.end();\n            --mt;\n            for (;;--mt)\n            {\n                int x(mt->first);\n                while (!Q.empty() && (Q.top().it->first)>=x)\n                {\n                    int u(Q.top().id);\n                    pIT it(Q.top().it);\n                    Q.pop();\n                    oc-=g[u];\n                    g[u]=min(g[u],it->second);\n                    oc+=g[u];\n                    if (it!=co[u].begin())\n                        --it,Q.push(node2(it,u));\n                }\n                tas=min(tas,oc);\n                ll kt(oc);\n                for (IT it=val[x].begin();it!=val[x].end();++it)\n                {\n                    int u(*it);\n                    ll vt(calc(rt[z[u]],1,cc,x,x));\n                    kt+=min(0LL,vt-c[z[u]]-g[u]);\n                }\n                val[x].clear();\n                tas=min(tas,kt);\n                if (mt==ht.begin())\n                    break;\n            }\n            ans+=tas;\n            for (int j=1;j<=z0;++j)\n                co[j].clear();\n            ht.clear();\n        }\n    printf(\"%lld\\n\",ans);\n    return 0;\n}\n```",
        "postTime": 1619868178,
        "uid": 10341,
        "name": "GK0328",
        "ccfLevel": 0,
        "title": "P7563 [JOISC 2021 Day 4] \u6700\u60aa\u306e\u8a18\u8005 4 \u9898\u89e3"
    },
    {
        "content": "## \u5927\u610f\n\u7ed9\u5b9a $n$ \u70b9\u5185\u5411\u57fa\u73af\u6811\uff0c\u957f\u5ea6\u4e3a $n$ \u7684\u5e8f\u5217 $H, C$\uff0c\u5728\u6709\u5411\u8fb9 $u\\to v$ \u4e2d\u8981\u6c42 $H_u\\le H_v$\u3002\u4f60\u53ef\u4ee5\u82b1\u8d39 $C_u$ \u7684\u4ee3\u4ef7\u4f7f\u5f97 $H_u$ \u4efb\u53d6\uff0c\u6c42\u4f7f\u6240\u6709\u8fb9\u5408\u6cd5\u7684\u6700\u5c0f\u4ee3\u4ef7\u3002\n\n$n\\le 2\\times 10^5$\n## Sol\n\u7ed9\u51fa\u4e00\u79cd\u4e0d\u7528\u7ebf\u6bb5\u6811\u7684\u505a\u6cd5\u3002\n\n\u8003\u8651\u6811\u4e0a\u7684\u60c5\u51b5\u600e\u4e48\u505a\u3002\n\n\u9996\u5148\u539f\u6761\u4ef6\u53ef\u4ee5\u8f6c\u5316\u4e3a\u94a6\u5b9a\u4e00\u4e9b\u70b9\u7684\u70b9\u6743\u4e3a $H_u$\uff0c\u4ef7\u503c\u4e3a $C_u$\uff0c\u5176\u4ed6\u70b9\u4efb\u9009\u7684\u6700\u5927\u4ef7\u503c\u3002\n\n\u8003\u8651\u52a8\u6001\u89c4\u5212\uff0c\u8bbe $f(u, i)$ \u8868\u793a\u5728 $u$ \u7684\u5b50\u6811\u5185\u6240\u6709\u70b9\u70b9\u6743 $\\ge i$ \u7684\u6700\u5927\u4ef7\u503c\uff0c\u5219\u6709\u8f6c\u79fb\n$$\nf(u, i)=\n\\begin{cases}\n\\displaystyle\\sum_{v\\in son_u}f(v,i)&i > H_u\\\\\n\\displaystyle\\max\\left\\{\\sum_{v\\in son_u}f(v,i), C_u+\\sum_{v\\in son_u}f(v,H_u)\\right\\}&i \\le H_u\\\\\n\\end{cases}\n$$\n\u66b4\u529b\u8f6c\u79fb\u662f $O(n^2)$ \u7684\uff0c\u8003\u8651\u4f18\u5316\u3002\n\n\u4e0d\u96be\u53d1\u73b0\uff0c$f(u,i)$ \u662f\u5355\u8c03\u4e0d\u5347\u7684\uff0c\u8003\u8651\u7ef4\u62a4 $f(u,i)$ \u7684\u5dee\u5206\u3002\n\n\u6211\u4eec\u5229\u7528 `std::map` \u7ef4\u62a4 $f(u,i)$ \u7684\u6bcf\u4e00\u4e2a\u62d0\u70b9\uff08\u5373\u659c\u7387\u4e0d\u4e3a $0$\uff09\uff0c\u6bcf\u6b21\u4ece\u513f\u5b50\u8282\u70b9\u8f6c\u79fb\u65f6\u5148\u4e0d\u8003\u8651 $H_u$ \u7684\u9650\u5236\u542f\u53d1\u5f0f\u5408\u5e76\uff0c\u6700\u540e\u52a0\u4e0a $H_u$ \u7684\u9650\u5236\u65f6\u540c\u65f6\u66f4\u65b0\u627e\u5230\u4e00\u6bb5\u533a\u95f4 $[i,H_u]$ \u7684\u659c\u7387\u4e3a $0$\uff08\u8fd9\u6bb5\u533a\u95f4\u88ab $f(u,H_u)$ \u66f4\u65b0\uff09\uff0c\u53ef\u4ee5\u8fd0\u7528 `std::map::lower_bound` \u548c `std::map::erase` \u5b8c\u6210\u3002\n\n\u518d\u8003\u8651\u73af\u4e0a\u7684\u60c5\u51b5\uff0c\u73af\u4e0a\u7684 $H$ \u5fc5\u7136\u76f8\u7b49\uff0c\u53ef\u4ee5\u9012\u589e\u7684\u679a\u4e3e\u73af\u4e0a\u7684\u70b9\u6743 $H_u$\uff0c\u518d\u7528\u53cc\u6307\u9488\u53bb\u9664\u6389\u6811\u4e0a\u5c0f\u4e8e $H_u$ \u7684\u8d21\u732e\uff0c\u66f4\u65b0\u7b54\u6848\u5373\u53ef\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal O(n\\log^2 n)$\uff08`std::map` + \u542f\u53d1\u5f0f\u5408\u5e76\uff09\u3002\n\n**Code**\n```cpp\nint n;\nstd::cin >> n;\nstd::vector<int> a(n), b(n), fa(n);\nstd::vector<std::vector<int>> e(n);\nfor (int i = 0; i < n; ++i) {\n    std::cin >> fa[i] >> a[i] >> b[i];\n    --fa[i];\n    e[fa[i]].emplace_back(i);\n}\nstd::vector<bool> vis(n), cir(n);\nusing i64 = long long;\nusing Info = std::map<int, i64>;\ni64 ans = std::accumulate(b.begin(), b.end(), 0ll);\nstd::vector<Info> f(n);\nfor (int i = 0; i < n; ++i) {\n    if (vis[i]) continue;\n    std::vector<int> c;\n    {\n        int u = i;\n        for (; !vis[u]; u = fa[u])\n            vis[u] = true;\n        for (; !cir[u]; u = fa[u])\n            cir[u] = true, c.push_back(u);\n    }\n    auto Merge = [&](Info &a, Info &b) {\n        if (a.size() < b.size()) a.swap(b);\n        for (auto &[v, w] : b) a[v] += w;\n    };\n    std::function<void(int)> DFS = [&](int u) {\n        vis[u] = true;\n        for (auto &v : e[u]) {\n            DFS(v);\n            Merge(f[u], f[v]);\n        }\n        f[u][a[u]] += b[u];\n        for (;;) {\n            auto it = f[u].lower_bound(a[u]);\n            if (it == f[u].begin()) break;\n            --it;\n            i64 _ = std::min(1ll * b[u], it -> second);\n            b[u] -= _;\n            it -> second -= _;\n            if (it -> second == 0) f[u].erase(it);\n            if (b[u] == 0) break;\n        }\n    };\n    Info rt, cur;\n    for (auto &u : c) {\n        cur[a[u]] += b[u];\n        for (auto &v : e[u])\n            if (!cir[v]) {\n                DFS(v);\n                Merge(rt, f[v]);\n            }\n    }\n    i64 ret = 0, mx = 0;\n    for (auto &[v, w] : rt) ret += w;\n    mx = ret;\n    auto it = rt.begin();\n    for (auto &[v, w] : cur) {\n        for (; it != rt.end() && it -> first < v; ++it) ret -= it -> second;\n        mx = std::max(mx, w + ret);\n    }\n    ans -= mx;\n}\nstd::cout << ans << '\\n';\n```",
        "postTime": 1668139039,
        "uid": 188760,
        "name": "Henry__Chen",
        "ccfLevel": 7,
        "title": "\u300cJOISC 2021 Day 4\u300d C Worst Reporter 4"
    },
    {
        "content": "### \u5b50\u4efb\u52a1 $1$ \n\n\u6811\uff0c$n\\le 5\\times 10^3$ \u3002\n\n\u8003\u8651 $n^2$ \u52a8\u6001\u89c4\u5212\u3002\n\n\u5b9a\u4e49 $f[i][j]$ \u8868\u793a\u5df2 $i$ \u4e3a\u6839\uff0c\u6839\u7684\u503c\u4e3a $j$ \u7684\u6700\u5c0f\u4ee3\u4ef7\u3002\n\n\u663e\u7136 $j$ \u53ea\u80fd\u53d6\u51fa\u73b0\u8fc7\u7684\u6570\uff0c\u4e00\u5171 $n$ \u79cd\u3002\n\n$$f[i][j]=c_i\\times[j=h_i]+\\sum \\limits_{u\\in son}\\min\\limits_{k\\ge j}\\{f[u][k]\\}$$ \n\n\u76f4\u63a5\u8f6c\u79fb\u5373\u53ef\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(n^2)$ \u3002\n\n```cpp\n#include<bits/stdc++.h>\n#define rep(i,a,b) for(int i=a;i<=b;i++)\n#define pre(i,a,b) for(int i=a;i>=b;i--)\n#define N 5005\nusing namespace std;\nint n,a[N],u[N],c[N],o[N],T,b[N],h[N],tot;long long f[N][N];\nstruct edge{int to,nxt;}e[N<<1];\nvoid add(int x,int y){e[++tot].nxt=h[x];h[x]=tot;e[tot].to=y;}\nvoid dfs(int x){\n\tint cur=lower_bound(b+1,b+T+1,u[x])-b;\n\trep(i,1,T)f[x][i]=c[x];f[x][cur]=0;\n\tfor(int i=h[x];i;i=e[i].nxt){\n\t\tdfs(e[i].to);long long mn=0x7fffffffffffffffLL;\n\t\tpre(j,T,1)mn=min(mn,f[e[i].to][j]),f[x][j]+=mn;\n\t}\n}\nint main(){\n\tscanf(\"%d\",&n);\n\trep(i,1,n)scanf(\"%d%d%d\",&a[i],&u[i],&c[i]),o[i]=u[i];\n\tsort(o+1,o+n+1);rep(i,1,n)if(o[i]!=o[i-1])b[++T]=o[i];\n\trep(i,2,n)add(a[i],i);dfs(1);long long ans=0x7fffffffffffffffLL;\n\trep(i,1,T)ans=min(ans,f[1][i]);printf(\"%lld\\n\",ans);\n\treturn 0;\n} \n```\n### \u5b50\u4efb\u52a1 $2$ \n\n\u6811\uff0c $n\\le 2\\times 10^5$ \u3002\n\n\u5bf9\u4e8e\u4ee5 $i$ \u4e3a\u6839\u7684\u5b50\u6811\uff0c$f[i][j]$ \u4e2d $j$ \u7684\u53d6\u503c\u4e00\u5b9a\u662f\u5176\u5b50\u6811\u4e2d\u7684\u503c\u3002\n\n\u8003\u8651\u7ebf\u6bb5\u6811\u5408\u5e76\u4f18\u5316 $\\rm DP$ \u3002\n\n\u5408\u5e76\u65f6\u5148\u5408\u5e76\u53f3\u5b50\u6811\uff0c\u518d\u5408\u5e76\u5de6\u5b50\u6811\uff0c\u8bb0\u5f55 $u$ \u8868\u793a\u5f53\u524d\u7b2c\u4e00\u9897\u6811\u4e2d\u7684\u6700\u5c0f\u503c\uff0c$v$ \u8868\u793a\u7b2c\u4e8c\u9897\u6811\u4e2d\u7684\u6700\u5c0f\u503c\u3002\n\n\u5bf9\u4e8e\u7ebf\u6bb5\u6811\u4e0a\u6bcf\u4e2a\u8282\u70b9\uff0c\u7ef4\u62a4\u533a\u95f4\u6700\u5c0f\u503c\uff0c\u548c\u533a\u95f4\u52a0\u7684\u6807\u8bb0\u3002\u6ce8\u610f\u53ca\u65f6\u4e0b\u4f20\u6807\u8bb0\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(n\\log n)$ \u3002\n\n```cpp\n#include<bits/stdc++.h>\n#define rep(i,a,b) for(int i=a;i<=b;i++)\n#define pre(i,a,b) for(int i=a;i>=b;i--)\n#define int long long\n#define N 200005\nusing namespace std;\nint n,h[N],tot,u[N],c[N],o[N],t,b[N],w[N];\nstruct edge{int to,nxt;}e[N];\nvoid add(int x,int y){e[++tot].nxt=h[x];h[x]=tot;e[tot].to=y;}\nstruct node{\n\tint l,r,mn,tag;\n}a[N<<6];\n#define ls a[x].l\n#define rs a[x].r\n#define S a[x].mn\n#define T a[x].tag\nint idx,rt[N],pm,qm;\nvoid pushup(int x,int val){if(x)S+=val,T+=val;}\nvoid down(int x){if(T)pushup(ls,T),pushup(rs,T),T=0;}\nint ins(int x,int l,int r,int pos,int val){\n\tif(!x){x=++idx,T=S=0;}\n\tif(l==r){S=val;return x;}\n\tdown(x);int mid=(l+r)>>1;\n\tif(mid>=pos)ls=ins(ls,l,mid,pos,val);\n\telse rs=ins(rs,mid+1,r,pos,val);\n\tS=min(a[ls].mn,a[rs].mn);return x;\n}\nint merge(int x,int y,int l,int r){\n\tif(!x&&!y)return 0;\n\tif(!x){qm=min(qm,a[y].mn);pushup(y,pm);return y;}\n\tif(!y){pm=min(pm,a[x].mn);pushup(x,qm);return x;}\n\tif(l==r){\n\t\tpm=min(pm,a[x].mn);qm=min(qm,a[y].mn);\n\t\tif(a[x].mn+qm<=a[y].mn+pm){pushup(x,qm);return x;}\n\t\tpushup(y,pm);return y;\n\t}\n\tdown(x);down(y);int mid=(l+r)>>1;\n\trs=merge(a[x].r,a[y].r,mid+1,r);\n\tls=merge(a[x].l,a[y].l,l,mid);\n\tS=min(a[ls].mn,a[rs].mn);return x;\n}\nint ask(int x,int l,int r,int L,int R){\n\tif(!x)return 0;\n\tif(L>=l&&R<=r)return S;\n\tdown(x);\n\tint mid=(L+R)>>1,cur=0;\n\tif(mid>=l)cur=min(cur,ask(ls,l,r,L,mid));\n\tif(mid<r)cur=min(cur,ask(rs,l,r,mid+1,R));\n\treturn cur;\n}\nvoid dfs(int x){\n\trt[x]=ins(0,1,t+1,t+1,0);\n\tfor(int i=h[x];i;i=e[i].nxt){\n\t\tdfs(e[i].to);pm=qm=0;\n\t\trt[x]=merge(rt[x],rt[e[i].to],1,t+1);\n\t\tw[x]+=w[e[i].to];\n\t}\n\tint cur=lower_bound(b+1,b+t+1,u[x])-b;\n\tint now=ask(rt[x],cur,t+1,1,t+1);\n\trt[x]=ins(rt[x],1,t+1,cur,now-c[x]);w[x]+=c[x];\n}\nsigned main(){\n\tscanf(\"%lld\",&n);\n\trep(i,1,n){\n\t\tint x;scanf(\"%lld%lld%lld\",&x,&u[i],&c[i]);\n\t\to[i]=u[i];if(i>1)add(x,i);\n\t}\n\tsort(o+1,o+n+1);rep(i,1,n)if(o[i]!=o[i-1])b[++t]=o[i];\n\tdfs(1);\n\tprintf(\"%lld\\n\",a[rt[1]].mn+w[1]);\n\tputs(\"No Copy\");return 0;\n}\n```\n\n### \u5b50\u4efb\u52a1 $3$\n\n\u57fa\u73af\u5185\u5411\u6811\u68ee\u6797\uff0c$n\\le 2\\times 10^5$ \u3002\n\n\u5148\u4e00\u904d\u62d3\u6251\u5c06\u73af\u5220\u6389\uff0c\u5bf9\u4e8e\u5269\u4e0b\u7684\u6811\u8dd1\u5b50\u4efb\u52a1 $2$ \u3002\n\n\u5c06\u73af\u770b\u6210\u4e00\u4e2a\u70b9\uff0c\u5c06\u5b83\u7684\u5b50\u6811\u5408\u5e76\u5230\u4e00\u9897\u7ebf\u6bb5\u6811\u4e2d\u3002\n\n\u6700\u540e\u679a\u4e3e\u6574\u4e2a\u73af\u7684\u6700\u7ec8\u503c\uff0c\u540c\u65f6\u5728\u7ebf\u6bb5\u6811\u4e2d\u533a\u95f4\u67e5\u8be2\u6700\u5c0f\u503c\uff0c\u66f4\u65b0\u7b54\u6848\u3002\n\n\u73af\u7684\u6700\u7ec8\u503c\u4e00\u5b9a\u662f\u73af\u4e0a\u67d0\u4e2a\u70b9\u7684\u503c\uff0c\u6216\u8005\u662f\u6700\u5c0f\u503c $1$ \u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O} (n\\log n)$ \u3002\n\n```cpp\n#include<bits/stdc++.h>\n#define rep(i,a,b) for(int i=a;i<=b;i++)\n#define pre(i,a,b) for(int i=a;i>=b;i--)\n#define int long long\n#define N 200005\nusing namespace std;\nint n,h[N],tot,u[N],c[N],o[N],t,b[N],w;\nstruct edge{int to,nxt;}e[N];\nvoid add(int x,int y){e[++tot].nxt=h[x];h[x]=tot;e[tot].to=y;}\nstruct node{\n\tint l,r,mn,tag;\n}a[N<<6];\n#define ls a[x].l\n#define rs a[x].r\n#define S a[x].mn\n#define T a[x].tag\nint idx,rt[N],pm,qm,wt[N];\nvoid pushup(int x,int val){if(x)S+=val,T+=val;}\nvoid down(int x){if(T)pushup(ls,T),pushup(rs,T),T=0;}\nint ins(int x,int l,int r,int pos,int val){\n\tif(!x){x=++idx,T=S=0;}\n\tif(l==r){S=val;return x;}\n\tdown(x);int mid=(l+r)>>1;\n\tif(mid>=pos)ls=ins(ls,l,mid,pos,val);\n\telse rs=ins(rs,mid+1,r,pos,val);\n\tS=min(a[ls].mn,a[rs].mn);return x;\n}\nint change(int x,int l,int r,int pos,int val){\n\tif(!x){x=++idx,T=S=0;}\n\tif(l==r){S+=val;return x;}\n\tdown(x);int mid=(l+r)>>1;\n\tif(mid>=pos)ls=ins(ls,l,mid,pos,val);\n\telse rs=ins(rs,mid+1,r,pos,val);\n\tS=min(a[ls].mn,a[rs].mn);return x;\n}\nint merge(int x,int y,int l,int r){\n\tif(!x&&!y)return 0;\n\tif(!x){qm=min(qm,a[y].mn);pushup(y,pm);return y;}\n\tif(!y){pm=min(pm,a[x].mn);pushup(x,qm);return x;}\n\tif(l==r){\n\t\tpm=min(pm,a[x].mn);qm=min(qm,a[y].mn);\n\t\tif(a[x].mn+qm<=a[y].mn+pm){pushup(x,qm);return x;}\n\t\tpushup(y,pm);return y;\n\t}\n\tdown(x);down(y);int mid=(l+r)>>1;\n\trs=merge(a[x].r,a[y].r,mid+1,r);\n\tls=merge(a[x].l,a[y].l,l,mid);\n\tS=min(a[ls].mn,a[rs].mn);return x;\n}\nint ask(int x,int l,int r,int L,int R){\n\tif(!x)return 0;\n\tif(L>=l&&R<=r)return S;\n\tdown(x);\n\tint mid=(L+R)>>1,cur=0;\n\tif(mid>=l)cur=min(cur,ask(ls,l,r,L,mid));\n\tif(mid<r)cur=min(cur,ask(rs,l,r,mid+1,R));\n\treturn cur;\n}\nvoid dfs(int x){\n\trt[x]=ins(0,1,t,t,0);\n\tfor(int i=h[x];i;i=e[i].nxt){\n\t\tdfs(e[i].to);pm=qm=0;\n\t\trt[x]=merge(rt[x],rt[e[i].to],1,t);\n\t}\n\tint cur=lower_bound(b+1,b+t+1,u[x])-b;\n\tint now=ask(rt[x],cur,t,1,t);\n\trt[x]=ins(rt[x],1,t,cur,now-c[x]);\n}\nqueue<int>q;int in[N],cnt,dfn[N],f[N];vector<pair<int,int> >cir[N];\nvoid mark(int x){\n\tdfn[x]=cnt;\n\tcir[cnt].push_back(make_pair(lower_bound(b+1,b+t+1,u[x])-b,-c[x]));\n\tif(!dfn[f[x]])mark(f[x]);\n}\nvoid topo(){\n\trep(i,1,n)if(!in[i])q.push(i);\n\twhile(!q.empty()){\n\t\tint x=q.front();q.pop();\n\t\tin[f[x]]--;\n\t\tif(!in[f[x]])q.push(f[x]);\n\t}\n\trep(i,1,n)if(!dfn[i]&&in[i])++cnt,mark(i);\n}\nvoid calc(){\n\trep(i,1,n)if(!in[i]&&in[f[i]])dfs(i),qm=pm=0,wt[dfn[f[i]]]=merge(wt[dfn[f[i]]],rt[i],1,t);\n\trep(i,1,cnt){\n\t\tsort(cir[i].begin(),cir[i].end());int mn=a[wt[i]].mn;\n\t\tint sum=cir[i][0].second,pre=cir[i][0].first;\n\t\tfor(int j=1;j<(int)cir[i].size();j++){\n\t\t\tif(cir[i][j].first==pre)sum+=cir[i][j].second;\n\t\t\telse {\n\t\t\t\tmn=min(mn,ask(wt[i],pre,t,1,t)+sum);\n\t\t\t\tsum=cir[i][j].second,pre=cir[i][j].first;\n\t\t\t}\n\t\t}\n\t\tw+=min(mn,ask(wt[i],pre,t,1,t)+sum);\n\t}\n}\nsigned main(){\n\tscanf(\"%lld\",&n);\n\trep(i,1,n){\n\t\tscanf(\"%lld%lld%lld\",&f[i],&u[i],&c[i]);\n\t\to[i]=u[i];w+=c[i];add(f[i],i);in[f[i]]++;\n\t}\n\tsort(o+1,o+n+1);rep(i,1,n)if(o[i]!=o[i-1])b[++t]=o[i];\n\tputs(\"No Copy\");topo();calc();\n\tprintf(\"%lld\\n\",w);\n\treturn 0;\n}\n```",
        "postTime": 1622287778,
        "uid": 119261,
        "name": "7KByte",
        "ccfLevel": 0,
        "title": "\u3010\u9898\u89e3\u3011[JOISC 2021 Day4] \u6700\u60aa\u306e\u8a18\u8005 4"
    }
]