[
    {
        "content": "## \u9898\u610f\u7b80\u8ff0\n\n\u7ed9\u5b9a\u4e00\u68f5 $n$ \u4e2a\u8282\u70b9\u7684\u6811\uff0c\u7b2c $u$ \u4e2a\u70b9\u7684\u6743\u503c\u4e3a $a_u$\u3002\u6709 $q$ \u6b21\u67e5\u8be2\uff0c\u6bcf\u6b21\u8be2\u95ee\u7ed9\u51fa\u4e00\u4e2a\u7f16\u53f7 $id$\uff0c\u8868\u793a\u8be2\u95ee\u201c**\u5220\u9664\u7b2c $id$ \u6761\u8fb9\u548c\u5176\u4f59\u67d0\u6761\u8fb9\u540e $3$ \u4e2a\u8fde\u901a\u5757\u70b9\u6743\u548c\u7684\u4e58\u79ef**\u201d\u7684**\u6240\u6709\u60c5\u51b5\u4e4b\u548c**\u3002\n\n**\u6570\u636e\u8303\u56f4**\uff1a$n,q \\le 10^6$\n\n## \u5206\u6790 + \u9898\u89e3\n\n\u7531\u4e8e\u8be2\u95ee\u6570\u91cf $q$ \u4e0e $n$ \u540c\u9636\uff0c\u8be5\u95ee\u9898\u9700\u8981\u5bf9**\u4efb\u610f\u4e00\u4e2a\u8fde\u901a\u5757**\u6c42**\u70b9\u6743\u548c**\u4ee5\u53ca**\u5220\u9664\u5176\u4e2d\u67d0\u6761\u8fb9\u540e\u7684 $2$ \u4e2a\u8fde\u901a\u5757\u70b9\u6743\u548c\u4e58\u79ef\u7684\u6240\u6709\u60c5\u51b5\u4e4b\u548c**\uff0c\u524d\u4e00\u4e2a\u95ee\u9898\u5f88\u597d\u5904\u7406\uff0c\u540e\u4e00\u4e2a\u95ee\u9898\u4e0d\u96be\u60f3\u5230**\u6362\u6839**\uff08\u4e25\u683c\u6765\u8bf4\u4e0d\u7b97 DP\uff09\u3002\n\n\u6b64\u5904\u4ee5**\u5bf9\u4ee5 $x$ \u4e3a\u6839\u7684\u5b50\u6811\u6c42\u89e3**\u4e0a\u8ff0\u95ee\u9898\u4e3a\u4f8b\u8fdb\u884c\u8bb2\u89e3\u3002\n\n\u8bbe $x$ \u5b50\u6811\u7684\u70b9\u6743\u548c\u4e3a $sum_x$\uff0c\u5bf9 $x$ \u5b50\u6811\u6c42\u89e3\u4e0a\u8ff0\u95ee\u9898\u6240\u5f97\u7ed3\u679c\u4e3a $ans_x$\uff0c\u5219\u6709\uff1a\n\n$$ans_x=\\sum_{y \\in subtree_x}sum_y(sum_x-sum_y)=sum_x \\cdot (\\sum_{y \\in subtree_x} sum_y)-(\\sum_{y \\in subtree \\;x} sum^2_y)$$\n\n\u5176\u4e2d $subtree_x$ \u8868\u793a $x$ \u5b50\u6811\u4e2d\u5305\u62ec $x$ \u7684\u70b9\u7ec4\u6210\u7684\u96c6\u5408\u3002\n\n\u8bbe $dp_x=\\sum_{y \\in subtree_x} sum_y$\uff0c$dp2_x=\\sum_{y \\in subtree_x} sum^2_y$\uff0c\u5219\u4e0a\u5f0f\u5316\u7b80\u4e3a\uff1a\n\n$$ans_x=sum_x \\cdot dp_x - dp2_x$$\n\n\u800c $dp_x$ \u548c $dp2_x$ \u90fd\u5f88\u597d\u6c42\uff1a\n\n$$dp_x=sum_x+\\sum_{y \\in son_x}dp_y ,dp2_x=sum^2_x+\\sum_{y \\in son_x}dp2_y$$\n\n\u518d\u52a0\u4e0a\u8fd9\u662f\u4e00\u4e2a\u6c42\u548c\u5f0f\uff0c**\u65e0\u9700\u91c7\u7528\u201c\u524d\u7f00+\u540e\u7f00\u201d\u7684\u6362\u6839\u5f62\u5f0f**\uff0c\u53ea\u9700\u4f7f\u7528\u7b80\u5355\u7684\u6362\u6839\u5373\u53ef\uff0c\u5177\u4f53\u5b9e\u73b0\u89c1\u4ee3\u7801\u3002\n\n## \u4ee3\u7801\n\n``` cpp\n#include<bits/stdc++.h>\nusing namespace std;\nconst int P=99991;//\u6ce8\u610f\u6a21\u6570 \ninline void add(int &a,int b)\n{\n\ta=a+b-(a+b>=P?P:0);\n}\ninline void sub(int &a,int b)\n{\n\ta=a-b+(a-b<0?P:0);\n}\ninline int get_sum(int a,int b)\n{\n\treturn a+b-(a+b>=P?P:0);\n}\ninline int get_dif(int a,int b)\n{\n\treturn a-b+(a-b<0?P:0);\n}\ninline int get_pro(int a,int b)\n{\n\treturn 1ll*a*b%P;\n}\ninline int get_square(int x)\n{\n\treturn 1ll*x*x%P;\n}\n//\u4ee5\u4e0a\u662f\u6a21\u610f\u4e49\u8fd0\u7b97 \nconst int max_n=1e6+5;\nint End[max_n<<1],Last[max_n],Next[max_n<<1],e;\ninline void add_edge(int x,int y)\n{\n\tEnd[++e]=y;\n\tNext[e]=Last[x];\n\tLast[x]=e;\n\tEnd[++e]=x;\n\tNext[e]=Last[y];\n\tLast[y]=e;\n}\nint a[max_n],fath[max_n],sum_in[max_n],dp_in[max_n],dp2_in[max_n];//in \u8868\u793a\u5b50\u6811\u5185 \nvoid dfs1(int x,int fa)\n{\n\tfath[x]=fa;\n\tsum_in[x]=a[x];\n\tfor(int i=Last[x];i;i=Next[i])\n\t{\n\t\tint y=End[i];\n\t\tif(y!=fa)\n\t\t{\n\t\t\tdfs1(y,x);\n\t\t\tadd(sum_in[x],sum_in[y]);\n\t\t\tadd(dp_in[x],dp_in[y]);\n\t\t\tadd(dp2_in[x],dp2_in[y]);\n\t\t}\n\t}\n\tadd(dp_in[x],sum_in[x]);\n\tadd(dp2_in[x],get_square(sum_in[x]));\n}\nint sum_out[max_n],dp_out[max_n],dp2_out[max_n],sum_all;//out \u8868\u793a\u5b50\u6811\u5916 \nvoid dfs2(int x,int fa)\n{\n\tif(fa!=0)\n\t{\n\t\tdp_out[x]=get_sum(dp_out[fa],sum_out[x]);//\u8fd9\u4e24\u9879\u5206\u522b\u5bf9\u5e94\u4e0b\u56fe\u7684\u7ea2\u8272\u548c\u9ec4\u8272\u90e8\u5206 \n\t\tadd(dp_out[x],dp_in[fa]);\n\t\tsub(dp_out[x],get_sum(sum_in[fa],dp_in[x]));//\u8fd9\u4e24\u884c\u5bf9\u5e94\u4e0b\u56fe\u4e2d\u7684\u84dd\u8272\u90e8\u5206 \n\t\tdp2_out[x]=get_sum(dp2_out[fa],get_square(sum_out[x]));\n\t\tadd(dp2_out[x],dp2_in[fa]);\n\t\tsub(dp2_out[x],get_sum(get_square(sum_in[fa]),dp2_in[x]));\n\t}\n\tfor(int i=Last[x];i;i=Next[i])\n\t{\n\t\tint y=End[i];\n\t\tif(y!=fa)\n\t\t\tdfs2(y,x);\n\t}\n}\nint ans_in[max_n],ans_out[max_n];//ans \u4e0e\u4e0a\u6587\u6240\u8ff0\u542b\u4e49\u76f8\u540c \nbool vis_in[max_n],vis_out[max_n];\ninline int work_in(int x)//\u8bb0\u5fc6\u5316\u6c42\u89e3 \n{\n\tif(vis_in[x])\n\t\treturn ans_in[x];\n\tvis_in[x]=true;\n\tans_in[x]=get_dif(get_pro(dp_in[x],sum_in[x]),dp2_in[x]);\n\treturn ans_in[x];\n}\ninline int work_out(int x)\n{\n\tif(vis_out[x])\n\t\treturn ans_out[x];\n\tvis_out[x]=true;\n\tans_out[x]=get_dif(get_pro(dp_out[x],sum_out[x]),dp2_out[x]);\n\treturn ans_out[x];\n}\nint u[max_n],v[max_n];//\u5b58\u50a8\u8fb9\u7684\u7aef\u70b9 \nint main()\n{\n\tint n,q;\n\tscanf(\"%d%d\",&n,&q); \n\tfor(int i=1;i<=n;++i)\n\t{\n\t\tscanf(\"%d\",a+i);\n\t\ta[i]%=P;//\u8bb0\u5f97\u8bfb\u5165\u65f6\u6a21\u4e00\u6b21 \n\t\tadd(sum_all,a[i]);//sum_all \u8bb0\u5f55 n \u4e2a\u70b9\u7684\u70b9\u6743\u548c \n\t}\n\tfor(int i=1;i<=n-1;++i)\n\t{\n\t\tscanf(\"%d%d\",u+i,v+i);\n\t\tadd_edge(u[i],v[i]);\n\t}\n\tdfs1(1,0);\n\tfor(int i=1;i<=n-1;++i)\n\t{\n\t\tif(fath[v[i]]==u[i])\n\t\t\tswap(u[i],v[i]);//\u4f7f u[i] \u662f v[i] \u7684\u513f\u5b50 \n\t}\n\tfor(int i=1;i<=n;++i)\n\t\tsum_out[i]=get_dif(sum_all,sum_in[i]);\n\tdfs2(1,0);\n\tlong long ans1=0;//\u5f00 long long \n\tint ans2=0;\n\twhile(q--)\n\t{\n\t\tint id;\n\t\tscanf(\"%d\",&id);\n\t\tint x=u[id];\n\t\tint ans=get_pro(work_in(x),sum_out[x]);//\u8ba8\u8bba\u5220\u9664 x \u5b50\u6811\u5185\u8fb9\u7684\u60c5\u51b5 \n\t\tadd(ans,get_pro(sum_in[x],work_out(x)));//\u8ba8\u8bba\u5220\u9664 x \u5b50\u6811\u5916\u8fb9\u7684\u60c5\u51b5\n\t\tans1+=ans,ans2^=ans;\n\t}\n\tprintf(\"%lld\\n%d\\n\",ans1,ans2);\n\treturn 0;\n}\n```\n\n\u4ee3\u7801\u4e2d\u63d0\u5230\u7684\u56fe\u7247\u5982\u4e0b\uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/ibsnc9pv.png)\n\n\u53ef\u7ed3\u5408\u56fe\u7247\u7406\u89e3\u6362\u6839\u90e8\u5206\u7684\u4ee3\u7801\u3002",
        "postTime": 1611415244,
        "uid": 145355,
        "name": "wsyhb",
        "ccfLevel": 0,
        "title": "\u3010\u9898\u89e3\u3011\u6d1b\u8c37 P7288 \u300cEZEC-5\u300d\u6811\u6728\u7684\u6124\u6012"
    },
    {
        "content": "\u7eaa\u5ff5\u6b64\u9898\u662f $700th$ AC\uff01\uff01\uff01\n\n\u63d0\u4f9b\u4e00\u79cd\u79bb\u7ebf\u505a\u6cd5\u3002\n\n\u4f18\u70b9\uff1a\u601d\u7ef4\u96be\u5ea6\u5c0f\uff0c\u6613\u4e8e\u5904\u7406\uff0c\u9002\u5408\u65b0\u624b\u98df\u7528\u3002\n\n\u9996\u5148\uff0c\u6211\u4eec\u9700\u5c06\u8fd9\u68f5\u6811\u8f6c\u5316\u4e3a\u6709\u6839\u6811\uff08\u82e5\u65e0\u7279\u6b8a\u8bf4\u660e\uff0c\u9ed8\u8ba4\u6839\u4e3a $1$\uff09\uff0c\u8fd9\u6837\u6bcf\u6761\u8fb9\u5c31\u5bf9\u5e94\u7740\u4e00\u4e2a\u70b9\uff08\u8fd9\u6761\u8fb9\u8fde\u7740\u7236\u8282\u70b9\u548c\u5b50\u8282\u70b9\uff0c\u5728\u8fd9\u91cc\u6211\u4eec\u53d6\u5b50\u8282\u70b9\uff09\uff0c\u5176\u5b9e\u5c31\u53d8\u6210\u4e86\u8ba9\u4f60\u9009\u62e9\u53e6\u4e00\u4e2a\u70b9\uff0c\u5c06\u8fd9\u68f5\u6811\u53d8\u6210\u4e09\u90e8\u5206\u3002\u8fd9\u6837\u7684\u8bdd\u8fd9\u9053\u9898\u5c31\u53ef\u4ee5\u8f6c\u5316\u4e3a\u6b63\u7ecf\u7684\u6811\u5f62 dp \u95ee\u9898\u4e86\u3002\n\n\u5728\u8fd9\u91cc\u6211\u4eec\u8bbe $dp_i$ \u4e3a\u4ee5 $i$ \u8282\u70b9\u4e3a\u6839\u7684\u5b50\u6811\u4e2d\u7684\u6240\u6709\u70b9\u7684\u6743\u503c\u4e4b\u548c\uff0c$dp1_i$ \u4e3a\u4ee5 $i$ \u8282\u70b9\u4e3a\u6839\u7684\u5b50\u6811\u7684\u6240\u6709\u5b50\u6811\u4e2d\u7684\u6240\u6709\u70b9\u7684\u6743\u503c\u4e4b\u548c\u4e4b\u548c\uff0c$dp2_i$ \u4e3a\u4ee5 $i$ \u8282\u70b9\u4e3a\u6839\u7684\u5b50\u6811\u7684\u6240\u6709\u5b50\u6811\u4e2d\u7684\u6240\u6709\u70b9\u7684\u6743\u503c\u4e4b\u548c\u7684\u5e73\u65b9\u548c\u3002\n\n\u90a3\u4e48\u6211\u4eec\u77e5\u9053\u8fd9\u68f5\u6811\u9009\u4e86 $i$ \u4e4b\u540e\uff0c\u4f7f\u5176\u53d8\u6210\u4e86\u5927\u5c0f\u5206\u522b\u4e3a $dp_i$ \u548c $n-dp_i$ \u4e24\u90e8\u5206\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u9700\u8981\u5206\u7c7b\u8ba8\u8bba\u4e86\uff1a\n\n\u5728\u8fd9\u91cc\u4f60\u9700\u8981\u77e5\u9053\u4e00\u4ef6\u4e8b\uff1a\u5982\u679c\u4f60\u9009\u4e86 $j$ \u8282\u70b9\uff0c\u6240\u9700\u5206\u5272\u7684\u5b50\u6811\u7684\u5927\u5c0f\u4e3a $k$ \u7684\u8bdd\uff0c\u90a3\u4e48\u4ea7\u751f\u7684\u8d21\u732e\u4e3a $dp_j(k-dp_j)=dp_jk-dp_j^2$\uff0c\u90a3\u4e48\u9009\u62e9\u6240\u6709\u8282\u70b9\u5c31\u662f $dp1_kk-dp2_k$\n\n\u6240\u4ee5\u4e3a\u4ec0\u4e48\u8981\u7b97\u51fa\u5b50\u6811\u548c\u548c\u5b50\u6811\u5e73\u65b9\u548c\u4e5f\u81ea\u7136\u5c31\u660e\u767d\u4e86\u3002\n\n\u5047\u8bbe\u9009\u7684\u53e6\u4e00\u4e2a\u70b9\u5728\u4ee5 $i$ \u8282\u70b9\u4e3a\u6839\u7684\u5b50\u6811\u4e0a\uff0c\u90a3\u4e48\u8d21\u732e\u4e3a\uff1a\n\n$(dp_i\\times dp1_i-dp2_i)\\times(n-dp_i)$\n\n\u5047\u8bbe\u9009\u7684\u53e6\u4e00\u4e2a\u70b9\u4e0d\u5728\u4ee5 $i$ \u8282\u70b9\u4e3a\u6839\u7684\u5b50\u6811\u4e0a\uff0c\u90a3\u4e48\u8d21\u732e\u4e3a\uff1a\n\n$dp_i[(n-dp_i)\\times(now1_{fa_i}-dp1_i-dp_i)-now2_{fa_i}+dp2_i+n^2-(n-dp_i)^2]$\n\n\u5728\u8fd9\u91cc\u89e3\u91ca\u4e00\u4e0b\u4ebf\u4e9b\u5f0f\u5b50\uff1a\n\n$now1_i$ \u4e3a\u5f53\u6839\u4e3a $i$ \u65f6\u7684\u6811\u7684\u6240\u6709\u5b50\u6811\u4e2d\u7684\u6240\u6709\u70b9\u7684\u6743\u503c\u4e4b\u548c\u4e4b\u548c\u3002\n\n\u9012\u63a8\u5f0f\uff1a$now1_i=now1_{fa_i}-2dp_i+n$\n\n$now2_i$ \u4e3a\u5f53\u6839\u4e3a $i$ \u65f6\u7684\u6811\u7684\u6240\u6709\u5b50\u6811\u4e2d\u7684\u6240\u6709\u70b9\u7684\u6743\u503c\u4e4b\u548c\u7684\u5e73\u65b9\u548c\u3002\n\n\u9012\u63a8\u5f0f\uff1a$now2_i=now2_{fa_i}-dp_i^2+(n-dp_i)^2$\n\n$now1_{fa_i}-dp1_i-dp_i$ \u4e3a\u5f53\u6811\u7684\u6839\u4e3a $fa_i$ \u65f6\uff0c\u53bb\u6389\u6839\u4e3a $i$ \u7684\u5b50\u6811\u65f6\u7684\u6240\u6709\u5b50\u6811\u4e2d\u7684\u6240\u6709\u70b9\u7684\u6743\u503c\u4e4b\u548c\u3002\n\n$now2_{fa_i}-dp2_i-n^2+(n-dp_i)^2$ \u4e3a\u5f53\u6811\u7684\u6839\u4e3a $fa_i$ \u65f6\uff0c\u53bb\u6389\u6839\u4e3a $i$ \u7684\u5b50\u6811\u65f6\u7684\u6240\u6709\u5b50\u6811\u4e2d\u7684\u6240\u6709\u70b9\u7684\u6743\u503c\u7684\u5e73\u65b9\u548c\u3002\n\n\u6b64\u64cd\u4f5c\u9700\u8981\u7528\u6362\u6839 dp \u89e3\u51b3\u3002\n\n\u5bf9\u4e8e\u8be2\u95ee\u7684 $q$ \u4e2a\u70b9\uff0c\u6211\u4eec\u53ea\u9700\u8981\u7528\u4e00\u4e2a $ask$ \u6570\u7ec4\u6807\u8bb0\u4e00\u4e0b\uff0c\u7136\u540e\u628a\u5b83\u4ee3\u5165\u5230\u6362\u6839 dp \u4e2d\u4e00\u8d77\u6c42\u89e3\u5373\u4e3a\u79bb\u7ebf\u505a\u6cd5\u3002\n\n**\u6ce8\u610f\u53d6\u6a21\uff0c\u6ce8\u610f\u8bfb\u9898\uff01\uff01\uff01**\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a$O(n+q)$\n\n**\u6ce8\u610f\uff1a\u672c\u9898\u5e38\u6570\u8f83\u5927\uff0c\u8bf7\u6ce8\u610f\u5e38\u6570\u4f18\u5316\u3002**\n\n# AC code:\n```\n#include<cstdio>\n#include<cstring>\n#include<vector>\n#include<algorithm>\nusing namespace std;\nconst int modd=99991;\nint a[1000005],dfn[1000005],cnt;\nlong long dp[1000005],dp1[1000005],dp2[1000005];\npair<int,int> b[1000005];\nvector<int> edge[1000005];\nint ask[1000005];\nbool vis[1000005];\nlong long sum,xorsum;\nlong long mod(long long x){\n\treturn (x%modd+modd)%modd;\n}\nvoid dfs(int x){\n\tint i;\n\tvis[x]=1;\n\tdfn[x]=++cnt;\n\tdp[x]=a[x];\n\tfor(i=0;i<edge[x].size();i++){\n\t\tif(!vis[edge[x][i]]){\n\t\t\tdfs(edge[x][i]);\n\t\t\tdp[x]+=dp[edge[x][i]];\n\t\t\tdp[x]%=modd;\n\t\t}\n\t}\n}\nvoid dfs1(int x){\n\tint i;\n\tvis[x]=1;\n\tdp1[x]=dp[x];\n\tdp2[x]=mod(dp[x]*dp[x]);\n\tfor(i=0;i<edge[x].size();i++){\n\t\tif(!vis[edge[x][i]]){\n\t\t\tdfs1(edge[x][i]);\n\t\t\tdp1[x]+=dp1[edge[x][i]];\n\t\t\tdp2[x]+=dp2[edge[x][i]];\n\t\t\tdp1[x]%=modd;\n\t\t\tdp2[x]%=modd;\n\t\t}\n\t}\n}\nvoid dfs2(int x,long long last1,long long last2){\n\tint i;\n\tvis[x]=1;\n\tfor(i=0;i<edge[x].size();i++){\n\t\tif(!vis[edge[x][i]]){\n\t\t\tlong long now1=mod(mod(last1-mod(dp[edge[x][i]]*2))+dp[1]),now2=mod(mod(last2-dp[edge[x][i]]*dp[edge[x][i]])+mod(mod(dp[1]-dp[edge[x][i]])*mod(dp[1]-dp[edge[x][i]])));\n\t\t\tdfs2(edge[x][i],now1,now2);\n\t\t\tif(ask[edge[x][i]]){\n\t\t\t\tlong long k;\n\t\t        k=mod(mod(mod(mod(dp[edge[x][i]]*dp1[edge[x][i]])-dp2[edge[x][i]])*mod(dp[1]-dp[edge[x][i]])));\n\t\t        k+=mod(mod(mod(mod(mod(mod(mod(mod(dp[1]-dp[edge[x][i]])*mod(mod(last1-dp1[edge[x][i]])-dp[edge[x][i]])-last2)+dp2[edge[x][i]])+mod(dp[1]*dp[1]))-mod(mod(dp[1]-dp[edge[x][i]])*mod(dp[1]-dp[edge[x][i]]))))*dp[edge[x][i]]));\n\t\t        k%=modd;\n\t\t        sum+=k*ask[edge[x][i]];\n\t\t        if(ask[edge[x][i]]&1){\n\t\t        \txorsum^=k;\n\t\t        }\n\t        }\n\t\t}\n\t}\n}\nint main(){\n\tint n,q,i;\n\tscanf(\"%d%d\",&n,&q);\n\tfor(i=1;i<=n;i++){\n\t\tscanf(\"%d\",&a[i]);\n\t\ta[i]%=modd;\n\t}\n\tfor(i=1;i<n;i++){\n\t\tscanf(\"%d%d\",&b[i].first,&b[i].second);\n\t\tedge[b[i].first].push_back(b[i].second);\n\t\tedge[b[i].second].push_back(b[i].first);\n\t}\n\tdfs(1);\n\tmemset(vis,0,sizeof(vis));\n\tdfs1(1);\n\tfor(i=1;i<=q;i++){\n\t\tint x;\n\t\tscanf(\"%d\",&x);\n\t\tif(dfn[b[x].first]<dfn[b[x].second]){\n\t\t\task[b[x].second]++;\n\t\t}\n\t\telse{\n\t\t\task[b[x].first]++;\n\t\t}\n\t}\n\tmemset(vis,0,sizeof(vis));\n\tdfs2(1,dp1[1],dp2[1]);\n\tprintf(\"%lld\\n%lld\",sum,xorsum);\n\treturn 0;\n}\n```",
        "postTime": 1611799271,
        "uid": 80614,
        "name": "ZCPB",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P7288 \u3010\u300cEZEC-5\u300d\u6811\u6728\u7684\u6124\u6012\u3011"
    },
    {
        "content": "\u63d0\u4f9b\u4e00\u4e2a\u66f4\u52a0\u7b80\u4fbf\u7684 dp \u65b9\u6cd5\u3002\n\n\u53ef\u4ee5\u53d1\u73b0\u8fd9\u9898\u7684\u91cd\u70b9\u5728\u4e8e\u8fb9\uff0c\u6240\u4ee5\u53ef\u4ee5\u8003\u8651\u679a\u4e3e\u8fb9\u7b97\u8d21\u732e\uff0c\u540c\u65f6\u4ee5\u8fb9\u4e3a\u72b6\u6001\u505a dp\uff0c\u6ce8\u610f\u8fd9\u91cc\u7684\u8fb9\u90fd\u662f\u6709\u5411\u8fb9\u3002\n\n\u8bbe $f_{(u, v)}$ \u8868\u793a\u5ffd\u7565\u8fb9 $u \\to v$\uff0c\u5728 $v$ \u5b50\u6811\u5185\u5220\u6389\u4e00\u6761\u8fb9\u7684\u6743\u503c\u548c\uff0c$g_{(u, v)}$ \u8868\u793a\u5ffd\u7565\u8fb9 $u \\to v$\uff0c\u5728 $v$ \u5b50\u6811\u5185\u5220\u6389\u4e00\u6761\u8fb9\uff0c\u5220\u6389\u7684\u7684\u5b50\u6811\u5927\u5c0f\u4e4b\u548c\uff0c$s_{(u, v)}$ \u8868\u793a\u5ffd\u7565\u8fd9\u6761\u8fb9\u4e4b\u540e $v$ \u5b50\u6811\u7684\u5927\u5c0f\uff0c\u53ef\u4ee5\u53d1\u73b0\uff0c\u53ea\u8981\u80fd\u591f\u6c42\u51fa $f$ \u5c31\u80fd\u5f88\u65b9\u4fbf\u8ba1\u7b97\u7b54\u6848\u3002\n\n\u90a3\u4e48\u6709\u8f6c\u79fb\uff1a\n\n$$\n\\begin{aligned}\nf_{(u, v)} &= \\sum_{w \\neq u, (v, w) \\in E} g_{(v, w)} + s_{(v, w)} (s_{u, v} - s_{v, w}) + f_{(v, w)}\\\\\ng_{(u, v)} &= \\sum_{w \\neq u, (v, w) \\in E} g_{(v, w)} + s_{(v, w)}\n\\end{aligned}\n$$\n\n\u8bb0\u5fc6\u5316\u641c\u7d22\u4e00\u4e0b\u5c31\u53ef\u4ee5\u4e86\uff0c\u611f\u89c9\u4f1a\u6bd4\u6362\u6839 dp \u597d\u5199\u5f88\u591a\u3002\n\n```cpp\n#include <cstdio>\n#include <algorithm>\n#include <vector>\n#define file(x) freopen(#x\".in\", \"r\", stdin), freopen(#x\".out\", \"w\", stdout)\n\ninline int read()\n{\n\tint data = 0, w = 1; char ch = getchar();\n\twhile (ch != '-' && (ch < '0' || ch > '9')) ch = getchar();\n\tif (ch == '-') w = -1, ch = getchar();\n\twhile (ch >= '0' && ch <= '9') data = data * 10 + (ch ^ 48), ch = getchar();\n\treturn data * w;\n}\n\nconst int N(1e6 + 10), Mod(99991);\ninline int upd(const int &x) { return x + (x >> 31 & Mod); }\nstruct edge { int next, to; } e[N << 1];\nint n, Q, a[N], siz[N << 1], vis[N << 1], f[N << 1], g[N << 1], head[N], e_num = 1;\ninline void add_edge(int from, int to)\n\t{ e[++e_num] = (edge) {head[from], to}, head[from] = e_num; }\n\nvoid dfs(int e)\n{\n\tif (vis[e]) return; int x = ::e[e].to;\n\tvis[e] = 1, siz[e] = a[x], f[e] = g[e] = 0;\n\tfor (int i = head[x]; i; i = ::e[i].next) if (i != (e ^ 1))\n\t\tdfs(i), siz[e] = upd(siz[e] + siz[i] - Mod), g[e] = (g[e] + siz[i] + g[i]) % Mod, f[e] = upd(f[e] + f[i] - Mod);\n\tfor (int i = head[x]; i; i = ::e[i].next) if (i != (e ^ 1))\n\t\tf[e] = (f[e] + 1ll * (g[i] + siz[i]) * (siz[e] - siz[i] + Mod)) % Mod;\n}\n\nint main()\n{\n#ifndef ONLINE_JUDGE\n\tfile(cpp);\n#endif\n\tn = read(), Q = read();\n\tfor (int i = 1; i <= n; i++) a[i] = read() % Mod;\n\tfor (int i = 1, a, b; i < n; i++)\n\t\ta = read(), b = read(), add_edge(a, b), add_edge(b, a);\n\tlong long s1 = 0, s2 = 0;\n\twhile (Q--)\n\t{\n\t\tint x = read() << 1, y = x | 1, res = 0; dfs(x), dfs(y);\n\t\tres = (1ll * f[x] * siz[y] + 1ll * f[y] * siz[x]) % Mod;\n\t\ts1 += res, s2 ^= res;\n\t}\n\tprintf(\"%lld\\n%lld\\n\", s1, s2);\n\treturn 0;\n}\n```",
        "postTime": 1611668611,
        "uid": 46800,
        "name": "xgzc",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P7288 \u3010\u300cEZEC-5\u300d\u6811\u6728\u7684\u6124\u6012\u3011"
    },
    {
        "content": "## Description\n\n\u5220\u9664\u4e24\u6761\u8fb9\uff0c\u5c06\u6811\u5206\u6210\u4e09\u4e2a\u8fde\u901a\u5757 $A,B,C$\uff0c\u8d21\u732e\u4e3a\u8fde\u901a\u5757\u70b9\u6743\u548c\u4e4b\u79ef\n\n\u5220\u53bb\u4e00\u6761\u8fb9\uff0c\u95ee\u518d\u5220\u53bb\u4efb\u610f\u4e00\u6761\u8fb9\u540e\u7684\u8d21\u732e\u548c\n\n## Solution\n\n\u8003\u8651\u9884\u5904\u7406\u51fa\u6240\u6709\u7b54\u6848\n\n\u5148\u5c06\u8fb9\u4e0b\u653e\u5230\u5b50\u8282\u70b9\n\n$O(n^2)$ \u505a\u6cd5\uff1a\n\n\u679a\u4e3e\u5220\u9664\u7684\u4efb\u610f\u4e24\u6761\u8fb9\uff0c\u7b97\u51fa\u8d21\u732e\uff0c\u7d2f\u52a0\u5230\u4e24\u6761\u8fb9\u4e0a\n\n\u8003\u8651\u4f18\u5316\n\n\u53d1\u73b0\u5220\u53bb\u4e00\u6761\u8fb9\u540e\uff0c\u518d\u5220\u7b2c\u4e8c\u6761\u8fb9\u65f6\uff0c\u5bf9\u4e8e\u5f88\u591a\u60c5\u51b5\uff0c\u90fd\u4f1a\u6709\u4e00\u4e2a\u8fde\u901a\u5757\u4e0d\u53d8\uff0c\u8003\u8651\u5269\u4e0b\u8fde\u901a\u5757\u7684\u8d21\u732e\u4e00\u8d77\u7b97\uff0c\u518d\u4e58\u4e0a\u8fd9\u4e2a\u8fde\u901a\u5757\u7684\u8d21\u732e\n\n\u5206\u7c7b\u8ba8\u8bba\n\n\u5b9a\u4e49 $s_u$ \u4e3a\u5b50\u6811 $u$ \u7684\u70b9\u6743\u548c\n\n- \u5220\u7684\u7b2c\u4e8c\u6761\u8fb9\u5728\u5b50\u6811\u5185\n\n![\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0](https://img-blog.csdnimg.cn/20210126212858351.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hvbmdrb25ncmVwb3J0ZXI=,size_16,color_FFFFFF,t_70)\n\n\u8d21\u732e\u4e3a\n\n$$\n(s_1-s_u)\\sum_{v\\in son_u}(s_u-s_v)s_v\\\\\n=(s_1-s_u)\\sum_{v\\in son_u}(s_us_v-s_v^2)\\\\\n=(s_1-s_u)(s_u\\sum_{v\\in son_u}s_v-\\sum_{v\\in son_u}s_v^2))\n$$\n\n\u5c06 $s$ \u505a\u5b50\u6811\u548c\uff0c\u5e73\u65b9\u7684\u5b50\u6811\u548c\uff0c$O(n)$ \u7edf\u8ba1\u8d21\u732e\n\n- \u5220\u7684\u7b2c\u4e8c\u6761\u8fb9\u5728\u5230\u6839\u7684\u8def\u5f84\u4e0a\n\n![\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0](https://img-blog.csdnimg.cn/20210126213342414.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hvbmdrb25ncmVwb3J0ZXI=,size_16,color_FFFFFF,t_70)\n\n\u8d21\u732e\u4e3a\n\n$$\ns_u\\sum_{v\\in road_{1,u}}(s_1-s_v)(s_v-s_u)\\\\\n=s_u\\sum_{v\\in road_{1,u}}(s_1s_v-s_1s_u-s_v^2+s_us_v)\\\\\n=s_u(s_1\\sum_{v\\in road_{1,u}}s_v-\\sum_{v\\in road_{1,u}}s_1s_u-\\sum_{v\\in road_{1,u}}s_v^2+s_u\\sum_{v\\in road_{1,u}}s_v)\n$$\n\n\u53d1\u73b0$\\sum_{v\\in road_{1,u}}s_1s_u=s_1s_u(dep_u-1)$\n\n\u4ece\u6839\u5411\u4e0b **dfs**\uff0c\u7ef4\u62a4\u8def\u5f84\u6743\u503c\u548c\uff0c\u6743\u503c\u5e73\u65b9\u548c\uff0c$O(n)$ \u7edf\u8ba1\u8d21\u732e\n\n- \u5220\u7684\u7b2c\u4e8c\u6761\u8fb9\u5728\u5176\u4ed6\u90e8\u5206\n\n![\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0](https://img-blog.csdnimg.cn/20210126213747334.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2hvbmdrb25ncmVwb3J0ZXI=,size_16,color_FFFFFF,t_70)\n\n\u8d21\u732e\u4e3a\n\n$$\ns_u\\sum_{v\\notin son_u,v\\notin road_{1,u}} s_v(s_1-s_u-s_v)\\\\\n=s_u\\sum_{v\\notin son_u,v\\notin road_{1,u}}(s_1s_v-s_us_v-s_v^2)\\\\\n=s_u(s_1\\sum_{v\\notin son_u,v\\notin road_{1,u}}s_v-s_u\\sum_{v\\notin son_u,v\\notin road_{1,u}}s_v-\\sum_{v\\notin son_u,v\\notin road_{1,u}}s_v^2)\n$$\n\n\u5148\u5c06\u8282\u70b9\u5230\u6839\u7684\u8def\u5f84\u4e0a\u7684\u70b9\u7b97\u8fdb\u6765\uff0c\u5c06 $s$ \u505a\u5b50\u6811\u548c\uff0c\u5e73\u65b9\u7684\u5b50\u6811\u548c\uff0c$O(n)$ \u7edf\u8ba1\u8d21\u732e\n\n\u518d\u4ece\u6839\u5411\u4e0b **dfs**\uff0c\u7ef4\u62a4\u8def\u5f84\u6743\u503c\u548c\uff0c\u6743\u503c\u5e73\u65b9\u548c\uff0c\u51cf\u53bb\u8282\u70b9\u5230\u6839\u7684\u8def\u5f84\u4e0a\u591a\u4f59\u7684\u8d21\u732e\n\n\u5c06\u4ee5\u4e0a\u4e09\u4e2a\u8d21\u732e\u7d2f\u52a0\u5230\u4e00\u8d77\uff0c\u8fd9\u9053\u9898\u5c31 $O(n)$ \u505a\u5b8c\u4e86\n\n## Code\n\n\u653e\u4e2a\u6ca1\u538b\u884c\u7684\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n\n#define re register\n#define LL long long\ntypedef unsigned int uint;\ntypedef unsigned long long ull;\n\n#define int long long\n\n#define Pr pair<int, int>\n#define fir first\n#define sec second\n#define pb push_back\n#define mp make_pair\n\nnamespace IO {\nchar buf_[1 << 21], *p1_ = buf_, *p2_ = buf_;\n#define ch()                                                                 \\\n  (p1_ == p2_ &&                                                             \\\n           (p2_ = (p1_ = buf_) + fread(buf_, 1, 1 << 21, stdin), p1_ == p2_) \\\n       ? EOF                                                                 \\\n       : *p1_++)\ninline int in() {\n  int s = 0, f = 1;\n  char x = ch();\n  for (; x < '0' || x > '9'; x = ch())\n    if (x == '-') f = -1;\n  for (; x >= '0' && x <= '9'; x = ch()) s = (s * 10) + (x & 15);\n  return f == 1 ? s : -s;\n}\nchar _buf[1 << 21];\nint _pos = -1;\ninline void flush() { fwrite(_buf, 1, _pos + 1, stdout), _pos = -1; }\ninline void pc(char x) {\n  if (_pos == (1 << 21) - 1) flush();\n  _buf[++_pos] = x;\n}\ninline void out(int x) {\n  char k[30];\n  int pos = 0;\n  if (!x) return pc('0');\n  if (x < 0) pc('-'), x = -x;\n  while (x) k[++pos] = (x % 10) | 48, x /= 10;\n  for (int i = pos; i; i--) pc(k[i]);\n}\ninline void out(string x) {\n  int len = x.size();\n  for (int i = 0; i < len; i++) pc(x[i]);\n}\n}  // namespace IO\nusing namespace IO;\n\nconst int A = 1e6 + 5;\nconst int mod = 99991;\ninline int add(int x, int y) { return x + y >= mod ? x + y - mod : x + y; }\ninline int dec(int x, int y) { return x - y < 0 ? x - y + mod : x - y; }\ninline int mul(int x, int y) { return x * y % mod; }\ninline void Add(int &x, int y) { x = add(x, y); }\ninline void Dec(int &x, int y) { x = dec(x, y); }\ninline void Mul(int &x, int y) { x = mul(x, y); }\nint n, Q;\nint a[A];\nstruct Node {\n  int x, y;\n  Node(int _x = 0, int _y = 0) { x = _x, y = _y; }\n} r[A];\nint head[A], tot_road;\nstruct Road {\n  int nex, to;\n} road[2 * A];\ninline void edge(int x, int y) {\n  road[++tot_road] = (Road){head[x], y}, head[x] = tot_road;\n}\nint dep[A], down[A];\nint ans[A];\n\nint s[A];\n\ninline void DFS0(int fa, int x) {\n  dep[x] = dep[fa] + 1, s[x] = a[x];\n  for (int y = head[x]; y; y = road[y].nex) {\n    int z = road[y].to;\n    if (z == fa) continue;\n    DFS0(x, z);\n    Add(s[x], s[z]);\n  }\n  return;\n}\n\nint s1[A], s2[A];\n\ninline void DFS1(int fa, int x) {\n  s1[x] = s[x], s2[x] = mul(s[x], s[x]);\n  for (int y = head[x]; y; y = road[y].nex) {\n    int z = road[y].to;\n    if (z == fa) continue;\n    DFS1(x, z);\n    Add(s1[x], s1[z]);\n    Add(s2[x], s2[z]);\n  }\n  return;\n}\n\ninline void calc_in() {\n  for (int i = 1; i <= n; i++)\n    Add(ans[i], mul(dec(s[1], s[i]), dec(mul(s[i], s1[i]), s2[i])));\n  return;\n}\n\ninline void DFS2(int fa, int x, int ss1, int ss2) {\n  Dec(ans[x], mul(s[x], dec(mul(dec(s[1], s[x]), ss1), ss2)));\n  Add(ss1, s[x]);\n  Add(ss2, mul(s[x], s[x]));\n  for (int y = head[x]; y; y = road[y].nex) {\n    int z = road[y].to;\n    if (z == fa) continue;\n    DFS2(x, z, ss1, ss2);\n  }\n  return;\n}\n\ninline void calc_out() {\n  for (int i = 1; i <= n; i++)\n    Add(ans[i], mul(s[i], dec(mul(dec(s[1], s[i]), dec(s1[1], s1[i])),\n                              dec(s2[1], s2[i]))));\n  DFS2(0, 1, 0, 0);\n  return;\n}\n\ninline void DFS3(int fa, int x, int ss1, int ss2) {\n  Add(ans[x], mul(mul(s[x], s[1]), ss1));\n  Dec(ans[x], mul(s[x], ss2));\n  Add(ans[x], mul(mul(s[x], s[x]), ss1));\n  Add(ss1, s[x]);\n  Add(ss2, mul(s[x], s[x]));\n  for (int y = head[x]; y; y = road[y].nex) {\n    int z = road[y].to;\n    if (z == fa) continue;\n    DFS3(x, z, ss1, ss2);\n  }\n  return;\n}\n\ninline void calc_fa() {\n  for (int i = 1; i <= n; i++)\n    Dec(ans[i], mul(mul(s[i], s[i]), mul(s[1], dep[i] - 1)));\n  DFS3(0, 1, 0, 0);\n  return;\n}\n\nsigned main() {\n  n = in(), Q = in();\n  for (int i = 1; i <= n; i++) a[i] = in() % mod;\n  for (int i = 1; i < n; i++) {\n    int u = in(), v = in();\n    r[i] = Node(u, v);\n    edge(u, v), edge(v, u);\n  }\n  DFS0(0, 1);\n  for (int i = 1; i < n; i++) {\n    if (dep[r[i].x] > dep[r[i].y])\n      down[i] = r[i].x;\n    else\n      down[i] = r[i].y;\n  }\n  DFS1(0, 1);\n  calc_in();\n  calc_out();\n  calc_fa();\n  int res1 = 0, res2 = 0;\n  while (Q--) {\n    int x = in();\n    res1 += ans[down[x]];\n    res2 ^= ans[down[x]];\n  }\n  out(res1), pc('\\n'), out(res2), pc('\\n');\n  flush();\n  return 0;\n}\n```\n",
        "postTime": 1611668599,
        "uid": 225048,
        "name": "ghr_226",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P7288 \u300cEZEC-5\u300d\u6811\u6728\u7684\u6124\u6012"
    },
    {
        "content": "## \u9898\u76ee\u5927\u610f\n\n\n\u6709\u4e00\u68f5\u5927\u5c0f\u4e3a $n$ \u7684\u65e0\u6839\u6811\uff0c\u8282\u70b9\u4e0a\u6709\u6743\u503c $w_i$ \u3002\n\n\u5b9a\u4e49\u4e09\u4e2a\u8fde\u901a\u5757 $A,B,C$ \u7684\u6743\u503c\u4e3a\uff1a\n\n\n$$f(A,B,C)=\\left(\\sum_{u\\in A} w_u\\right)\\times \\left(\\sum_{u\\in B} w_u\\right)\\times \\left(\\sum_{u\\in C} w_u\\right)$$\n\n\u6709 $q$ \u6b21\u8be2\u95ee\uff0c\u6bcf\u6b21\u9009\u5b9a\u4e00\u6761\u8fb9\u5220\u53bb\u3002\u73b0\u5728\u8be2\u95ee\uff0c\u679a\u4e3e\u5220\u53bb\u53e6\u5916\u4e00\u6761\u8fb9\uff0c\u5206\u88c2\u51fa\u7684\u4e09\u4e2a\u8fde\u901a\u5757 $A,B,C$ \u7684\u6743\u503c\u7684\u6240\u6709\u60c5\u51b5\u7684\u548c\u3002\n\n## \u9898\u89e3\n\n\u7b97\u662f $\\text{Div2}$ \u91cc\u9762\u6700\u53cd\u4eba\u7c7b\u7684\u4e00\u9053\u9898\u76ee\u4e86\u2026\u2026\n\n\u867d\u7136\u9898\u76ee\u4e2d\u7ed9\u51fa\u7684\u662f\u65e0\u6839\u6811\uff0c\u4f46\u662f\u6211\u4eec\u4ecd\u7136\u56fa\u5b9a\u8282\u70b9 $1$ \u4e3a\u6839\u8282\u70b9\u3002\n\n- \u5b9a\u4e49 $e_u$ \u8868\u793a\u8282\u70b9 $u$ \u4e0e\u7236\u4eb2\u8282\u70b9\u6240\u8fde\u7684\u90a3\u6761\u8fb9\u3002\u7279\u522b\u7684\uff0c $e_1$ \u65e0\u5b9a\u4e49\u3002\n\n- \u5b9a\u4e49 $T(u)$ \u8868\u793a\u6839\u8282\u70b9\u4e3a $u$ \u7684\u8fd9\u68f5\u5b50\u6811\uff0c\u5b83\u5305\u542b\u4e86\u91cc\u9762\u6240\u6709\u7684\u70b9\u548c\u8fb9\uff08\u4e0d\u5305\u62ec $v_u$ \uff09\uff0c $T(1)$ \u5c31\u662f\u539f\u6811\uff1b\u540c\u65f6 $D(u)$ \u662f\u8282\u70b9 $u$ \u5230\u6811\u6839\u7684\u8ddd\u79bb\uff0c $(1,u)$ \u8868\u793a $1$ \u5230 $u$ \u8fd9\u6761\u8def\u5f84\u7684\u96c6\u5408\uff0c**\u4e0d\u5305\u62ec\u7aef\u70b9**\u3002 \n\n- \u5b9a\u4e49 $S(u)$ \u4e3a\u5b50\u6811 $u$ \u4e2d\u6240\u6709\u8282\u70b9\u7684\u6743\u503c\u548c\uff0c\u5373 $S_u=\\sum_{v\\in T(u)}w_v$ \uff1b $P(A)$ \u8868\u793a $\\sum_{v\\in A} S(v)$ \uff0c$Q(A)$ \u8868\u793a $\\sum_{v\\in A} S^2(v)$ \u3002\n\n\u6bcf\u4e2a\u8be2\u95ee\u76f8\u5f53\u4e8e\u5220\u9664\u4e86 $e_x$ \u3002\u90a3\u4e48\u5220\u9664\u7684\u7b2c\u4e8c\u6761\u8fb9 $e_y$ \uff0c\u53ef\u4ee5\u4f5c\u4e3a\u4e09\u79cd\u60c5\u51b5\u8fdb\u884c\u8ba8\u8bba\uff1a\n\n- $1.$ \u5220\u9664\u7684\u90a3\u6761 $e_y$ \u5728 $x$ \u5b50\u6811\u4e2d\u3002\n\n- $2.$ \u5220\u9664\u7684\u90a3\u6761 $e_y$ \u5728 $(1,x)$ \u8fd9\u6761\u8def\u5f84\u4e0a\u3002\n\n- $3.$ \u5176\u4ed6\u6240\u6709\u60c5\u51b5\u3002\n\n\u4e3a\u4ec0\u4e48\u662f\u8fd9\u6837\u5462\uff1f\n\n\u5148\u8bb2\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u53c8\u5bb9\u6613\u7406\u89e3\u7684\u5c0f\u5f15\u7406\uff0c\u5b83\u80fd\u544a\u8bc9\u6211\u4eec\u5e94\u8be5\u7ef4\u62a4\u4ec0\u4e48\u4e1c\u897f\u3002\n\n$$\\begin{aligned}\n\\sum_{v\\in A}(x-S(v))(S(v))&=\\sum_{v\\in A}\\left( xS(v)-S(v)^2\\right) \\cr\n&=x\\sum_{v\\in A} S(v)-\\sum_{v\\in A} S^2(v) \\cr\n&=xP(A)-Q(A)\n\\end{aligned}$$\n\n\u4e8e\u662f\u8981\u60f3\u8ba1\u7b97\u5de6\u5f0f \uff0c\u53ea\u8981\u7ef4\u62a4 $P(A),Q(A)$ \u5c31\u884c\u4e86\u3002\n\n### \u60c5\u5f62 $1$ \uff0c $e_y\\in T_x/\\{x\\}$\n\n\u8fd9\u65f6\u5019\uff0c\u5206\u88c2\u51fa\u7684\u4e09\u4e2a\u5757\u7684\u6743\u503c\u548c\u5206\u522b\u4e3a\uff1a$S(y),S(x)-S(y),S_1-S(x)$ \u3002\u7b80\u5355\u8ba1\u7b97\u4e00\u4e0b\u8fd9\u90e8\u5206\u7684\u8d21\u732e $W_1$ \u3002\n\n$$\\begin{aligned}\nW_1&=\\sum_{y\\in T(x)/\\{x\\}}S(y)\\cdot (S(x)-S(y))\\cdot (S_1-S(x)) \\cr\n&=(S_1-S(x))\\sum_{y\\in T(x)/\\{x\\}}S(y)\\cdot (S(x)-S(y)) \\cr\n&=(S_1-S(x))\\Big(S(x)P\\big(T(x)/\\{x\\}\\big)-Q\\big(T(x)/\\{x\\}\\big)\\Big)\n\\end{aligned}$$\n\n\u6211\u4eec\u53ea\u8981\u7ef4\u62a4\u4e00\u4e0b\uff0c $P(T(x)/\\{x\\}),Q(T(x)/\\{x\\})$ \u5c31\u884c\u4e86\u3002\n\n### \u60c5\u5f62 $2$ \uff0c $e_y\\in (1,x)$\n\n\u8fd9\u65f6\u5019\uff0c\u5206\u88c2\u51fa\u7684\u4e09\u4e2a\u5757\u7684\u6743\u503c\u548c\u5206\u522b\u4e3a\uff1a $S(y),S(x),S(1)-S(y)$ \u3002\u540c\u6837\u7684\uff0c\u6211\u4eec\u8ba1\u7b97\u51fa\u8fd9\u4e00\u5757\u7684\u8d21\u732e $W_2$ \u3002\n\n$$\\begin{aligned}\nW_1&=\\sum_{y\\in (1,x)}(S(y)-S(x))\\cdot S(x)\\cdot (S(1)-S(y)) \\cr\n&=S(x)\\sum_{y\\in (1,x)}(S(y)-S(x))(S(1)-S(y)) \\cr\n&=\\left(S(x)\\sum_{y\\in (1,x)}(S(1)-S(y))S(y)\\right)-\\left(S^2(x)\\sum_{y\\in (1,x)}(S(1)-S(y))\\right) \\cr\n&=S(x)\\Big(S(1)P((1,x))-Q((1,x))\\Big)-S^2(x)\\Big(D(x)-2-P((1,x))\\Big)\n\\end{aligned}$$\n\n\u5176\u4e2d $D(x)$ \u662f $x$ \u7684\u6df1\u5ea6\u3002\n\n\u5c3d\u7ba1\u67ff\u5b50\u6bd4\u8f83\u4e11\u964b\uff0c\u4f46\u662f\u6211\u4eec\u4ecd\u7136\u53ea\u8981\u7ef4\u62a4 $P((1,x))$ \u548c $Q((1,x))$ \u5c31\u884c\u4e86\u3002\n\n### \u60c5\u5f62 $3$ \uff0c $e_y$ \u5728\u5176\u4ed6\u5730\u65b9\n\n\u4e0d\u59a8\u8bbe $y$ \u6240\u5904\u7684\u96c6\u5408\u4e3a $O$ \u3002\u540c\u6837\u7684\uff0c\u5206\u88c2\u51fa\u7684\u4e09\u4e2a\u5757\u7684\u5927\u5c0f\u5e94\u8be5\u662f $S(x),S(y),S(1)-S(x)-S(y)$ \u3002\u63a8\u51fa\u8fd9\u90e8\u5206\u67ff\u5b50\u7684\u603b\u8d21\u732e $W_3$ \u3002\n\n\n$$\\begin{aligned}\nW_3&=\\sum_{y\\in O} S(x)S(y)\\Big(S(1)-S(x)-S(y)\\Big) \\cr\n&=S(x)\\sum_{y\\in O}S(y)\\Big(S(1)-S(x)-S(y)\\Big) \\cr\n&=S(x)\\Big((S(1)-S(x))P(O)-Q(O)\\Big) \\cr\n\\end{aligned}$$\n\n\u5176\u4e2d $P(O),Q(O)$ \u53ef\u4ee5\u901a\u8fc7\u5bb9\u65a5\u5f97\u5230\u3002\u663e\u7136\uff0c\n\n$$\\begin{aligned}\nP(O)&=P(T(1))-P(T(x))-P((1,x))-S(1) \\cr\nQ(O)&=Q(T(1))-Q(T(x))-Q((1,x))-S^2(1) \\cr\n\\end{aligned}$$\n\n\u6700\u7ec8\u7684\u7b54\u6848\u5c31\u51fa\u6765\u4e86\uff1a\n\n$$ans=W_1+W_2+W_3$$\n\n\u6211\u4eec\u53ef\u4ee5\u5728 $\\text{dfs}$ \u7684\u540c\u65f6\u987a\u5e26\u5c06\u5404\u79cd\u4e1c\u897f\u6c42\u51fa\u6765\u3002\u4e8e\u662f\u8be5\u9898\u5728 $\\mathcal O(n)$ $\\sout{+\\text{\u5de8\u5927\u591a\u5e38\u6570}}$ \u590d\u6742\u5ea6\u5185\u89e3\u51b3\u3002\n\n## \u53c2\u8003\u4ee3\u7801\n\n```cpp\n#include<bits/stdc++.h>\n#define up(l,r,i) for(int i=l,END##i=r;i<=END##i;++i)\n#define dn(r,l,i) for(int i=r,END##i=l;i>=END##i;--i)\nusing namespace std;\ntypedef long long i64;\nconst int INF =2147483647;\nint qread(){\n    int w=1,c,ret;\n    while((c=getchar())> '9'||c< '0') w=(c=='-'?-1:1); ret=c-'0';\n    while((c=getchar())>='0'&&c<='9') ret=ret*10+c-'0';\n    return ret*w;\n}\nconst int MOD =99991;\nconst int MAXN=1e6+3;\nint head[MAXN*2],ver[MAXN*2],nxt[MAXN*2],tot;\nvoid add(int u,int v){\n    ver[++tot]=v,nxt[tot]=head[u],head[u]=tot;\n}\nint n,q,A[MAXN],S[MAXN],D[MAXN];\nint F[MAXN],G[MAXN],P[MAXN],Q[MAXN]; i64 ans1,ans2;\ni64 mod(i64 t){ return ((t%MOD)+MOD)%MOD;}\nvoid dfs1(int u,int fa){\n    // printf(\"%d\\n\",u);\n    S[u]=A[u]; for(int i=head[u],v;i;i=nxt[i]){\n        v=ver[i]; if(v==fa) continue;\n        D[v]=D[u]+1,dfs1(v,u),S[u]=mod(S[u]+S[v]);\n    }\n}\nvoid dfs2(int u,int fa){\n    for(int i=head[u],v;i;i=nxt[i]){\n        v=ver[i]; if(v==fa) continue;\n        P[v]=mod(P[v]+P[u]+S[u]),Q[v]=mod(1ll*Q[v]+1ll*Q[u]+1ll*S[u]*S[u]);\n        if(u==1) P[v]=Q[v]=0; dfs2(v,u);\n        F[u]=mod(F[u]+S[v]+F[v]),G[u]=mod(1ll*G[u]+1ll*G[v]+1ll*S[v]*S[v]);\n    }\n}\nint clc(int a,int b,int s){return mod(1ll*s*a-b);}\nint U[MAXN],V[MAXN];\nsigned main(){\n    n=qread(),q=qread(); up(1,n,i) A[i]=qread();\n    up(1,n-1,i){\n        U[i]=qread(),V[i]=qread(); add(U[i],V[i]),add(V[i],U[i]);\n    }\n    D[1]=-1,dfs1(1,0),dfs2(1,0);\n    up(1,q,i){\n        int x=qread(),u,s1=0,s2=0,s3=0; u=D[U[x]]>D[V[x]]?U[x]:V[x];\n        s1=mod(1ll*clc(F[u],G[u],S[u])*(S[1]-S[u]));\n        int t1=mod(1ll*P[u]-1ll*D[u]*S[u]);\n        int t2=mod(-2ll*S[u]*P[u]+1ll*Q[u]+1ll*S[u]*S[u]*D[u]);\n        s2=mod(1ll*clc(t1,t2,S[1]-S[u])*S[u]);\n        int p1=mod(1ll*F[1]-S[u]-F[u]-P[u]);\n        int p2=mod(-1ll*S[u]*S[u]+G[1]-G[u]-Q[u]);\n        s3=mod(1ll*clc(p1,p2,S[1]-S[u])*S[u]);\n        int o=(s1+s2+s3)%MOD; ans1+=o,ans2^=o;\n        // printf(\"%d,%d,%d\\n\",s1,s2,s3);\n        // printf(\"%d\\n\",o);\n    }\n    printf(\"%lld\\n%lld\\n\",ans1,ans2);\n    return 0;\n}\n```\n\n\n",
        "postTime": 1623638644,
        "uid": 344628,
        "name": "MatKave",
        "ccfLevel": 0,
        "title": "P7288 \u300cEZEC-5\u300d\u6811\u6728\u7684\u6124\u6012 \u9898\u89e3"
    }
]