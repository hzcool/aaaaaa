[
    {
        "content": "###### \u6811\u5206\u6cbb\u597d\u9898\uff0c\u81f3\u5c11\u5bf9\u4e8e\u6211\u8fd9\u4e2a\u6811\u5206\u6cbb\u521d\u5b66\u8005\n[\u6d1b\u8c37P6009](https://www.luogu.com.cn/problem/P6009)\n### \u9898\u76ee\uff1a\n\u6c42\u533a\u95f4\u4e0d\u4e0b\u964d\u5b50\u5e8f\u5217\u4e2a\u6570\n\u4e14$a_i\\leq k,k\\leq 20,N\\leq 5\\times 10^4,Q\\leq 2\\times 10^5$\n### \u9898\u89e3\uff1a\n\u5f88\u96be\u60f3\u5230\uff0c\u8981\u7528CDQ\u5206\u6cbb\n\u8981\u5206\u4e86\u4e4b\u540e\u600e\u4e48\u8fdb\u884c\u7ef4\u62a4\u590d\u6742\u5ea6\u5c3d\u91cf\u5c0f\uff0c\u8fd9\u662fCDQ\u5206\u6cbb\u5f88\u96be\u53d7\u7684\u5730\u65b9\u3002\n\n - \u5b9a\u4e49\u6570\u7ec4\n \u5728\u6bcf\u4e2a$solve(l,r)$\u4e2d\u90fd\u6709\n \n $f_{i,j}$  \u8868\u793a\n \n $(l\\leq j \\leq mid)j$\u4e3a\u5de6\u7aef\u70b9 \uff0c$k\\in [j,mid]$\u4e2d\u6240\u6709$a_{k}=i$\u7684$k$\u4e3a\u53f3\u7aef\u70b9\uff0c\u4e0d\u4e0b\u964d\u5b50\u5e8f\u5217\u4e2a\u6570\n \n  $(mid < j\\leq r)j$\u4e3a\u53f3\u7aef\u70b9 \uff0c $k\\in (mid,j]$\u4e2d\u6240\u6709$a_{k}=i$\u7684$k$\u4e3a\u5de6\u7aef\u70b9\uff0c\u4e0d\u4e0b\u964d\u5b50\u5e8f\u5217\u4e2a\u6570\n - \u7ef4\u62a4\u6570\u7ec4\n \n  \u5c3d\u53ef\u80fd\u7684\u627e\u6570\u7ec4\u4e4b\u95f4\u7684\u8054\u7cfb\n  \n  \u9996\u5148\u56e0\u4e3a$mid$\u5c06$f_{i,j}$\u5206\u4e3a\u4e86\u4e24\u4e2a\u90e8\u5206\uff0c\u610f\u4e49\u4e0d\u540c\uff08\u5176\u5b9e\u6cdb\u6cdb\u6765\u8bf4\u5dee\u4e0d\u591a\uff09,\u6240\u4ee5\u6211\u4eec\u4e5f\u5206\u4e24\u90e8\u5206\u8ba8\u8bba\n  \n  \u8fd9\u91cc\u6211\u4eec\u5148\u53ea\u5206\u6790\u53f3\u8fb9\u7684\uff0c\u5de6\u8fb9\u7684\u540c\u7406\u7406\u89e3\n  \n  $$f_{i,j}= \\ [a_j==i]+\\sum_{mid\\leq k<j,a_k\\leq a_j}f_{i,k}$$\n   \u7136\u540e\u6211\u5f00\u59cb\u770b\u5230\u8fd9\u5f0f\u5b50\uff0c\u662f\u61f5\u903c\u7684\n   \n   $[a_j==i]$\u6307\u5982\u679c$a_j==i$\u7684\u8bdd\uff0c$j->j$\u5c31\u662f\u4e00\u4e2a\u5408\u6cd5\u533a\u95f4\uff0c$f_{i,j}+1$\n   \n   $\\sum_{mid\\leq k<j,a_k\\leq a_j}f_{i,k}$\u6307\u4e0e\u524d\u9762\u7684\u5df2\u5408\u6cd5\u533a\u95f4\u62fc\u63a5\uff0c\u56e0\u4e3a\u8fd8\u8981\u6ee1\u8db3\u62fc\u63a5\u540e\u4e0d\u4e0b\u964d\uff0c\u6240\u4ee5$a_k\\leq a_j$\n   \n   \u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u60f3\u5230\u6811\u72b6\u6570\u7ec4\u7ef4\u62a4\uff08\u7565\uff09\n   \n\n###### \u6ce8\u610f\uff1a\n \u53f3\u8fb9\u5faa\u73af\u987a\u5e8f\u662f$mid+1->r$\uff0c\u4f46\u5de6\u8fb9\u5faa\u73af\u987a\u5e8f\u662f$mid->l$,\u56e0\u4e3a\u662f\u9006\u7740\u6765\u7684\uff0c\u6240\u4ee5\u6ce8\u610f\u6811\u72b6\u6570\u7ec4\u4e5f\u8981\u9006\u4e00\u4e0b\n \n\u56e0\u4e3a\u7a7a\u96c6\u4e5f\u7b97\u5408\u6cd5\u533a\u95f4\uff0c\u6240\u4ee5\u8981\u628a$f_{1,mid},f_{k,mid+1}$\u90fd\u8981+1\n - \u8be2\u95ee\u6c42\u503c\n \n yy\u4e00\u4e0b\u6211\u4eec\u60f3\u5230\uff0c\u6211\u4eec\u9700\u8981\u5c06\u6211\u4eec\u7684$f_{i,j}$\u524d\u7f00\u548c\u4e00\u4e0b\uff08\u5de6\u8fb9\u662f\u540e\u7f00\u548c\uff09\n \n \u6211\u4eec\u5148\u53ea\u8003\u8651\u8de8\u8fc7$mid$\u7684\u8be2\u95ee\u533a\u95f4\uff08ql,qr\u5206\u522b\u4e3a\u8be2\u95ee\u7684\u5de6\u53f3\u7aef\u70b9\uff09\n $$ans=\\sum_{1\\leq i\\leq k}F_{i,ql}\\sum_{i\\leq j\\leq k}F_{j,qr}$$\n \u7406\u89e3\u4e0b\uff0c\u5c31\u662f\u5de6\u53f3\u4e24\u7aef\u62fc\u63a5\uff0c\u4e58\u6cd5\u539f\u7406\n \n \uff08\u6211\u66fe\u8ff7\u60d1\uff1a$ql->s,s->qr$\uff0c$mid<s$\u7684\u60c5\u51b5\u6ca1\u6709\u8003\u8651\u554a\uff0c\u4f46\u5176\u5b9e\u5c06$s$\u79fb\u5230 $\\overline{s}<mid$\uff0c$ql->\\overline{s},\\overline{s}<qr$\u8fd9\u6837\u662f\u7b49\u6548\u7684\uff09\n - \u590d\u6742\u5ea6 $O(nklognlogk+qk)$\n```cpp\n#include<bits/stdc++.h>\n#define ll long long\nusing namespace std;\nconst ll mod=1e9+7;\nconst int N=5e4+10,K=25,Q=2e5+10;\nint n,k,q;\nint a[N];\nstruct qus{int l,r;}qs[Q];\nll ans[Q];\nll f[K][N];\n//---\nll t[K];\nint lowbit(int x){return x&(-x);}\nvoid clear(){memset(t,0,sizeof(t));}\nvoid add(int i,int x){for(;i<=k;i+=lowbit(i))t[i]=(t[i]+x)%mod;}\nll qur(int i){ll res=0;for(;i;i-=lowbit(i))res=(res+t[i])%mod;return res;}\n//----\nll ls[N];\nvoid solve(int l,int r,vector<ll>v)\n{\n\tif(l==r)\n\t{\n\t\tfor(int i=0;i<v.size();i++)ans[v[i]]=2;\n\t\treturn ;\n\t}\n\tint mid=(l+r)>>1;\n\tfor(int i=1;i<=k;i++)\n\t{\n\t\tclear();\n\t\tfor(int j=mid;j>=l;j--)\n\t\t{\n\t\t\tf[i][j]=qur(k+1-a[j]);\n\t\t\tif(a[j]==i)f[i][j]=(f[i][j]+1)%mod;//\u81ea\u5df1->\u81ea\u5df1 \n\t\t\tadd(k+1-a[j],f[i][j]);//\u9006\u8f6c\u6811\u72b6\u6570\u7ec4 \n\t\t}\n\t\tfor(int j=mid-1;j>=l;j--)f[i][j]=(f[i][j]+f[i][j+1])%mod;//\u524d\u7f00\u548c \n\t}\n\tfor(int j=l;j<=mid;j++)f[1][j]=(f[1][j]+1)%mod;//\u7a7a\u96c6\n\tfor(int i=1;i<=k;i++)\n\t{\n\t\tclear();\n\t\tfor(int j=mid+1;j<=r;j++)\n\t\t{\n\t\t\tf[i][j]=qur(a[j]);\n\t\t\tif(a[j]==i)f[i][j]=(f[i][j]+1)%mod;\n\t\t\tadd(a[j],f[i][j]);\n\t\t}\n\t\tfor(int j=mid+2;j<=r;j++)f[i][j]=(f[i][j]+f[i][j-1])%mod;\n\t}\n\tfor(int j=mid+1;j<=r;j++)f[k][j]=(f[k][j]+1)%mod;\n\tvector<ll>vl,vr;\n\tvl.resize(0);vr.resize(0); \n\tfor(int i=0;i<v.size();i++)\n\t{\n\t\tint l=qs[v[i]].l,r=qs[v[i]].r;\n\t\tif(r<=mid)\t  vl.push_back(v[i]);\n\t\telse if(mid<l)vr.push_back(v[i]);\n\t\telse\n\t\t{\n\t\t\tfor(int j=k;j>=1;j--)ls[j]=(ls[j+1]+f[j][r])%mod;//\u524d\u7f00\u53c8\u540e\u7f00\u3002\u3002\u3002\n\t\t\tfor(int j=1;j<=k;j++)ans[v[i]]=(ans[v[i]]+ls[j]*f[j][l]%mod)%mod;\n\t\t}\n\t}\n\tif(vl.size())solve(l,mid,vl);\n\tif(vr.size())solve(mid+1,r,vr);\n}\nvector<ll>v;\nint main()\n{\n\tscanf(\"%d%d\",&n,&k);\n\tfor(int i=1;i<=n;i++)scanf(\"%d\",&a[i]);\n\tscanf(\"%d\",&q);\n\tfor(int i=1;i<=q;i++)scanf(\"%d%d\",&qs[i].l,&qs[i].r);\n\tfor(int i=1;i<=q;i++)v.push_back(i);\n\tsolve(1,n,v);\n\tfor(int i=1;i<=q;i++)printf(\"%lld\\n\",ans[i]);\n}\n```\n\n[\u4ece\u8fd9\u4f4d\u5de8\u4f6c\u535a\u5ba2\u770b\u61c2\u7684](https://www.cnblogs.com/xh092113/p/12283379.html)\n",
        "postTime": 1585098168,
        "uid": 62298,
        "name": "YFXj_38",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 P6009 \u3010[USACO20JAN]Non-Decreasing Subsequences P\u3011"
    },
    {
        "content": "\u9898\u76ee\u7684 DP \u663e\u7136\u53ef\u4ee5\u5199\u6210\u77e9\u4e58\u7684\u5f62\u5f0f\u3002\u7c7b\u4f3c LNRD1T1\uff0c\u8bb0\u4e0b\u8f6c\u79fb\u77e9\u9635\u548c\u9006\u77e9\u9635\u7684\u524d\u7f00\u79ef $pref,ipref$\uff0c\u7b54\u6848\u5373\u4e3a \n$$\\sum_{i=1}^{K}(ipref[L-1]\\cdot pref[R])[1][i]$$\n\n\u6ce8\u610f\u53ea\u6709 $O(K)$ \u4e2a\u4f4d\u7f6e\u6709\u503c\uff0c\u6240\u4ee5\u77e9\u4e58\u7684\u590d\u6742\u5ea6\u662f $O(K^2)$ \u7684\uff0c\u76f4\u63a5\u505a\u590d\u6742\u5ea6\u662f $O((N+Q)K^2)$ \u7684\uff0c\u7cbe\u7ec6\u5b9e\u73b0\u53ef\u4ee5\u901a\u8fc7\u3002\n\n\u4e5f\u53ef\u4ee5\u8bb0\u524d\u7f00\u79ef\u7684\u524d\u7f00\u548c\uff1a\n\n$$\\sum_{i=1}^{K}ipref[L-1][1][i]\\cdot \\left(\\sum_{j=1}^{K}pref[R][i][j]\\right)$$\n\n\u53ef\u4ee5\u505a\u5230 $O(NK^2+QK)$.\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\ninline int gi()\n{\n\tchar c=getchar(); int x=0;\n\tfor(;c<'0'||c>'9';c=getchar());\n\tfor(;c>='0'&&c<='9';c=getchar())x=(x<<1)+(x<<3)+c-'0';\n\treturn x;\n}\nconst int N=5e4+5,K=23,Mod=1e9+7,iM=Mod+1>>1;\nint m[K][K],im[K][K],pre[N][K],inv[N][K],n,k,q;\n#define mul(x,y) (1ll*(x)*(y)%Mod)\ninline int add(int x, int y)\n{\treturn (x+y>=Mod?x+y-Mod:x+y);\n}\ninline int sub(int x, int y)\n{\treturn (x-y<0?x-y+Mod:x-y);\n}\nint main()\n{\n\tn=gi(),k=gi();\n\tfor(int i=1;i<=k;++i) m[i][i]=im[i][i]=pre[0][i]=1;\n\tinv[0][1]=1;\n\tfor(int l=1;l<=n;++l)\n\t{\n\t\tint x=gi();\n\t\tfor(int i=1;i<=x;++i)\n\t\t\tfor(int j=x;j>=i;--j) m[i][x]=add(m[i][x],m[i][j]);\n\t\tfor(int i=1;i<x;++i)\n\t\t\tfor(int j=x;j<=k;++j) im[i][j]=sub(im[i][j],mul(iM,im[x][j]));\n\t\tfor(int i=x;i<=k;++i) im[x][i]=mul(im[x][i],iM);\n\t\tfor(int i=1;i<=k;++i)\n\t\t{\n\t\t\tinv[l][i]=im[1][i];\n\t\t\tfor(int j=i;j<=k;++j) pre[l][i]=add(pre[l][i],m[i][j]);\n\t\t}\n\t}\n\tq=gi();\n\twhile(q--)\n\t{\n\t\tint l=gi(),r=gi(),ans=0;\n\t\tfor(int i=1;i<=k;++i) ans=add(ans,mul(pre[r][i],inv[l-1][i]));\n\t\tprintf(\"%d\\n\",ans);\n\t}\n}\n```",
        "postTime": 1581558691,
        "uid": 9757,
        "name": "x_faraway_x",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P6009 \u3010[USACO20JAN]Non-Decreasing Subsequences P\u3011"
    },
    {
        "content": "\n## [\u300cUSACO 2020.1 Platinum\u300dNon-Decreasing Subsequences](https://loj.ac/problem/3247)\n\n\u6211\u4eec\u8981\u5feb\u901f\u6c42\u51fa\u591a\u7ec4\u8be2\u95ee\u4e00\u4e2a\u533a\u95f4\u5185\u4e0d\u4e0b\u964d\u5e8f\u5217\u7684\u4e2a\u6570\u3002\uff08\u4e0d\u8fc7\u4e0d\u540c\u7684\u6570\u4e0d\u8d85\u8fc720\uff09\n\n\u8bbe\u8ba1dp\u65b9\u7a0b\uff0c$f[i][j]$\u8868\u793a\u5de6\u7aef\u70b9\u4e3ai\uff0c\u6709\u6bb5\u70b9\u503c\u4e3aj\u7684\u65b9\u6848\u6570\u3002$g[i][j]$\u8868\u793a\u53f3\u7aef\u70b9\u4e3ai\uff0c\u5de6\u7aef\u70b9\u503c\u4e3aj\u7684\u65b9\u6848\u6570\u3002\n\n\u6211\u4eec\u9006\u5411\u601d\u7ef4\uff0c\u5982\u4f55\u6c42\u51fa\u4e00\u4e2a\u8be2\u95ee\u3002\n\n- \u8003\u8651\u62fc\u63a5\u7684\u601d\u60f3\uff0c\u4ece\u8fd9\u4e2a\u8be2\u95ee\u4e2d\u95f4\u7684\u67d0\u4e00\u4e2a\u70b9\uff0c\u53ea\u8981\u77e5\u9053\u4ecel[i]\u5230mid\u7684\u6240\u6709f[i][j]\u548cmid+1\u5230r[i]\u7684\u6240\u6709g[i][j]\uff0c\u663e\u7136\u6bcf\u4e00\u79cd\u8981\u5417\u53ea\u5728\u5de6\u8fb9\u6216\u53ea\u5728\u53f3\u8fb9\uff08\u52a0\u4e00\u4e2a\u7a7a\u96c6\u5373\u53ef\uff09\uff0c\u5426\u5219\u5fc5\u5b9a\u8fc7mid\uff0c\u6240\u6709\u6211\u4eec\u53ef\u4ee5\u679a\u4e3e\u62fc\u63a5\u7684\u5730\u65b9\uff0c\u7136\u540e\u4ecel\u5230mid\u5de6\u53f3f[l][i]\u4e4b\u548c\u4e58\u4e0a\u4ecer\u5230mid+1\u6240\u6709g[r][j]\uff08j>=i\uff09\u4e4b\u548c\u5c31\u662f\u7b54\u6848\u3002\n\n\u6240\u4ee5\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u8be2\u95ee\uff0c\u6211\u4eec\u53ea\u9700\u77e5\u9053\u4efb\u610f\u4e00\u4e2a\u5728\u5176\u4e2d\u7684\u70b9\u7684\u6240\u6709f\u548cg\u6570\u7ec4\u5c31\u53ef\u4ee5O\uff08n\uff09\u6c42\u51fa\u7b54\u6848\u3002\n\n\u4f46\u662f\u6211\u4eec\u73b0\u5728\u6709m\u4e2a\u8be2\u95ee\uff0c\u5982\u4f55\u627e\u51fa\u8fd9\u4e9bmid\u4e14\u4fdd\u8bc1\u590d\u6742\u5ea6\u3002\n\n\u5206\u6cbb\u5927\u6cd5\u597d\u3002\n\n\u8003\u8651\u4e8c\u5206\u5207\u5272\u3002\n\n\u4e8e\u662f\u5bf9\u4e8e\u6bcf\u4e00\u4e2al\u5230r\uff0c\u6211\u4eec\u9884\u5904\u7406\u51famid\u7684f\uff0cg\u6570\u7ec4\uff0c\u7528\u6570\u636e\u7ed3\u6784\u603b\u5171$n*log_n^2$\u3002\n\n\u7136\u540e\u628a\u8fc7mid\u7684\u6240\u6709\u8be2\u95ee\u5904\u7406\u6389\u3002\u628a\u5728\u5de6\u4fa7\u548c\u53f3\u4fa7\u7684\u8be2\u95ee\u5206\u5f00\u4fdd\u8bc1\uff0c\u5206\u522b\u5206\u6cbb\u5373\u53ef\u3002\n\ncode\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define int long long\nconst int mod=1e9+7;\nconst int M=1e6+5;\nint n,m,ans[M],tr[50005],a[M],k;\nstruct node{\n\tint l,r,id;\n}q[M];\ninline void add(int pos,int val){\n\tfor(int i=pos;i<=n;i+=(i&-i)) tr[i]+=val,tr[i]%=mod;\n}\ninline int qusum(int pos){\n\tint sum=0;\n\tfor(int i=pos;i>0;i-=(i&-i)) sum+=tr[i],sum%=mod;\n\treturn sum;\n}\nqueue <int> qu;\nint f[50005][22],g[50005][22];\nvoid cdq(int l,int r){\n\tif(qu.empty()) return;\n\tif(l==r){\n\t\twhile(!qu.empty()){\n\t\t\tans[q[qu.front()].id]=2;qu.pop();\n\t\t}return;\n\t}\n\tint mid=l+r>>1;\n\tfor(int i=1;i<=k;i++){\n\t\tmemset(tr,0,sizeof(tr));\n\t\tfor(int j=mid;j>=l;j--) f[j][i]=qusum(k-a[j]+1)+(a[j]==i),add(k-a[j]+1,f[j][i]);\n\t}\n\tfor(int i=mid-1;i>=l;i--) \n\t  for(int j=1;j<=k;j++) f[i][j]+=f[i+1][j],f[i][j]%=mod;\n\t  \n\tfor(int i=1;i<=k;i++){\n\t\tmemset(tr,0,sizeof(tr));\n\t\tfor(int j=mid+1;j<=r;j++) g[j][i]=qusum(a[j])+(a[j]==i),add(a[j],g[j][i]);\n\t}\n\tfor(int i=mid+2;i<=r;i++)\n\t  for(int j=1;j<=k;j++) g[i][j]+=g[i-1][j],g[i][j]%=mod;\n\tfor(int i=l;i<=mid;i++) f[i][1]++;\n\tfor(int i=mid+1;i<=r;i++) g[i][k]++;\n\tqueue <int> qw,qt;\n\twhile(!qu.empty()){\n\t\tint i=qu.front();\n\t\tif(q[i].r<=mid) qt.push(i);\n\t\telse if(q[i].l>mid) qw.push(i);\n\t\telse\n\t\t  for(int j=1;j<=k;j++)  \n\t\t    for(int z=j;z<=k;z++) \n\t\t\t  ans[q[i].id]+=f[q[i].l][j]*g[q[i].r][z],ans[q[i].id]%=mod;\n\t    qu.pop();  \n\t}\n\twhile(!qt.empty()) qu.push(qt.front()),qt.pop();\n\tcdq(l,mid);\n\twhile(!qu.empty()) qu.pop();\n\twhile(!qw.empty()) qu.push(qw.front()),qw.pop();\n\tcdq(mid+1,r);\n}\nsigned main(){\n\tcin>>n>>k;\n\tfor(int i=1;i<=n;i++) scanf(\"%lld\",&a[i]);\n\tcin>>m;\n\tfor(int i=1;i<=m;i++) scanf(\"%lld%lld\",&q[i].l,&q[i].r),q[i].id=i;\n\tfor(int i=1;i<=m;i++) qu.push(i);\n\tcdq(1,n);\n\tfor(int i=1;i<=m;i++) cout<<(ans[i]%mod+mod)%mod<<\"\\n\";\n\treturn 0;\n}\n```\n\n",
        "postTime": 1585410045,
        "uid": 48324,
        "name": "detect",
        "ccfLevel": 0,
        "title": "P6009"
    },
    {
        "content": "### \u9898\u610f\n\n\u7ed9\u4e00\u4e2a\u957f\u5ea6\u4e3a $n$\uff0c\u503c\u57df\u5728 $[1,k]$ \u5185\u7684\u5e8f\u5217 $a$\uff0c$q$ \u6b21\u8be2\u95ee\uff0c\u6bcf\u6b21\u8be2\u95ee\u7ed9 $l,r$\uff0c\u95ee\u4f60 $a_l\\sim a_r$ \u5185\u4e0d\u964d\u5b50\u5e8f\u5217\u7684\u603b\u6570\u3002\n\n$\\texttt{Data Range:}n\\leq 5\\times 10^4,k\\leq 20,q\\leq 10^5$\n\n### \u9898\u89e3\n\n\u8003\u8651\u5982\u4f55\u6c42 $l=1,r=n$ \u65f6\u7684\u7b54\u6848\u3002\n\n\u6ce8\u610f\u5230\u503c\u57df\u8303\u56f4\u5f88\u5c0f\uff0c\u4e8e\u662f\u53ef\u4ee5 $\\texttt{dp}$\uff0c\u8bbe $f_{i,j}$ \u8868\u793a\u524d $i$ \u4e2a\u6570\uff0c\u94a6\u5b9a\u6700\u540e\u4e00\u4e2a\u4e3a $j$ \u7684\u4e0d\u964d\u5b50\u5e8f\u5217\u603b\u6570\uff0c\u679a\u4e3e\u4e00\u4e0b\u5f97\u5230\n\n$$f_{i,j}\\begin{cases}f_{i-1,j},&j\\neq a_i\\\\f_{i-1,j}+\\sum\\limits_{k=1}^{j}f_{i-1,k},&j=a_i\\end{cases}$$\n\n\u6ce8\u610f\u5230\u53ef\u4ee5\u7ef4\u62a4\u77e9\u9635\u6765\u8fdb\u884c\u8f6c\u79fb\uff0c\u7b2c $r$ \u4e2a\u4f4d\u7f6e\u7684\u8f6c\u79fb\u77e9\u9635\u5927\u6982\u957f\u8fd9\u6837\uff1a\n\n$$T_{r,i,j}=[i=j]+[i\\leq j][j=a_r]$$\n\n\u8fd9\u6837\u53ef\u4ee5\u6c42\u5f97\u7b54\u6848\u4e3a\n\n$$\\begin{pmatrix}1&0&\\cdots&0\\end{pmatrix}\\prod\\limits_{i=1}^{n}T_i\\begin{pmatrix}1\\\\1\\\\\\vdots\\\\1\\end{pmatrix}$$\n\n\u73b0\u5728\u628a\u4ed6\u8fc1\u79fb\u5230\u4efb\u610f\u533a\u95f4\u4e0a\u6765\uff0c\u5f97\u5230\n\n$$\\begin{pmatrix}1&0&\\cdots&0\\end{pmatrix}\\prod\\limits_{i=l}^{r}T_i\\begin{pmatrix}1\\\\1\\\\\\vdots\\\\1\\end{pmatrix}$$\n\n\u8003\u8651\u5dee\u5206\uff0c\u5f97\u5230\n\n$$\\begin{pmatrix}1&0&\\cdots&0\\end{pmatrix}\\prod\\limits_{i=l-1}^{1}T_i^{-1}\\prod\\limits_{i=1}^{r}T_i\\begin{pmatrix}1\\\\1\\\\\\vdots\\\\1\\end{pmatrix}$$\n\n\u8003\u8651\u8fd9\u4e2a\u4e1c\u897f\u7684\u9006\u77e9\u9635\u662f\u5565\u3002\u6839\u636e\u4eba\u7c7b\u667a\u6167\u5f97\u5230\n\n$$T_{r,i,j}^{-1}=[i=j]-\\frac{1}{2}[i\\leq j][j=a_r]$$\n\n\u4e8e\u662f\u7ef4\u62a4 \n\n$$L_x=\\prod\\limits_{i=1}^{x}T_i\\begin{pmatrix}1\\\\1\\\\\\vdots\\\\1\\end{pmatrix}$$\n\n\u548c\n\n$$R_x=\\begin{pmatrix}1&0&\\cdots&0\\end{pmatrix}\\prod\\limits_{i=x}^{1}T_i^{-1}$$\n\n\u5c31\u53ef\u4ee5\u5f97\u5230\u7b54\u6848\u4e3a $R_{l-1}L_r$\u3002\n\n\u4f46\u662f\uff0c\u66b4\u529b\u77e9\u4e58\u4e0d\u53ef\u53d6\uff0c\u8003\u8651\u4f18\u5316\u3002\n\n\u6ce8\u610f\u5230 $T_r=I+A_r$\uff0c\u5e76\u4e14 $A_{r,i,j}=[i\\leq j][j=r]$\n\n\u53f3\u4e58\u548c\u5de6\u4e58\u90fd\u53ef\u4ee5 $O(n^2)$ \u6c42\u51fa\uff0c\u603b\u65f6\u95f4\u590d\u6742\u5ea6 $O(nk^2+qk)$\u3002\n\n### \u4ee3\u7801\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\ntypedef int ll;\ntypedef long long int li;\nconst ll MAXN=2e5+51,MOD=1e9+7;\nll n,kk,qcnt,l,r,res;\nll x[MAXN],p[25][25],f[MAXN][25],g[MAXN][25];\ninline ll read()\n{\n    register ll num=0,neg=1;\n    register char ch=getchar();\n    while(!isdigit(ch)&&ch!='-')\n    {\n        ch=getchar();\n    }\n    if(ch=='-')\n    {\n        neg=-1;\n        ch=getchar();\n    }\n    while(isdigit(ch))\n    {\n        num=(num<<3)+(num<<1)+(ch-'0');\n        ch=getchar();\n    }\n    return num*neg;\n}\nint main()\n{\n    n=read(),kk=read();\n    for(register int i=1;i<=kk;i++)\n    {\n\t\tp[i][i]=1;\n    }\n    for(register int i=1;i<=n;i++)\n    {\n\t\tx[i]=read();\n\t\tfor(register int j=1;j<=kk;j++)\n\t\t{\n\t\t\tfor(register int k=x[i];k;k--)\n\t\t\t{\n\t\t\t\tp[j][x[i]]=(p[j][k]+p[j][x[i]])%MOD;\n\t\t\t}\n\t\t}\n\t\tfor(register int j=1;j<=kk;j++)\n\t\t{\n\t\t\tfor(register int k=1;k<=kk;k++)\n\t\t\t{\n\t\t\t\tf[i][j]=(f[i][j]+p[j][k])%MOD;\n\t\t\t}\n\t\t}\n    }\n    memset(p,0,sizeof(p)),qcnt=read(),g[0][1]=1;\n    for(register int i=1;i<=kk;i++)\n    {\n\t\tp[i][i]=1;\n    }\n    for(register int i=1;i<=n;i++)\n    {\n\t\tfor(register int j=1;j<=x[i];j++)\n\t\t{\n\t\t\tfor(register int k=1;k<=kk;k++)\n\t\t\t{\n\t\t\t\tp[j][k]=(p[j][k]+(li)(5e8+3)*p[x[i]][k]%MOD)%MOD;\n\t\t\t}\n\t\t}\n\t\tfor(register int j=1;j<=kk;j++)\n\t\t{\n\t\t\tg[i][j]=p[1][j];\n\t\t}\n    }\n    for(register int i=0;i<qcnt;i++)\n    {\n\t\tl=read(),r=read(),res=0;\n\t\tfor(register int j=1;j<=kk;j++)\n\t\t{\n\t\t\tres=(res+(li)g[l-1][j]*f[r][j]%MOD)%MOD;\n\t\t}\n\t\tprintf(\"%d\\n\",res);\n    }\n}\n```",
        "postTime": 1590392416,
        "uid": 60990,
        "name": "Karry5307",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P6009 \u3010[USACO20JAN]Non-Decreasing Subsequences P\u3011"
    }
]