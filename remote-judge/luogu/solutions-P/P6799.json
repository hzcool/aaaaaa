[
    {
        "content": "upd on 2021.3.16\uff1a\u4fee\u6539\u4e86\u539f\u505a\u6cd5\u548c\u4ee3\u7801\u4e2d\u7684\u9519\u8bef\uff0c\u73b0\u5728\u80fd\u901a\u8fc7 hack \u6570\u636e\u4e86\u3002\n\n------------\n\n\u663e\u7136\u8fd9\u662f\u9053\u6811\u5f62 dp\uff0c\u4e3a\u4e86\u65b9\u4fbf\u5904\u7406\u4fe1\u606f\uff0c\u6211\u4eec\u8003\u8651\u5c06\u8fd9 $m$ \u6761\u94fe\u653e\u5230 lca \u4e0a\u7ef4\u62a4\u3002\n\n\u8bbe $f_{i,0/1}$ \u8868\u793a\u4ee5 $i$ \u4e3a\u6839\u7684\u5b50\u6811\u4e2d\u6ca1\u6709\u9009\u53d6/\u6709\u9009\u53d6\u4ee5 $i$ \u4e3a lca \u7684\u94fe\u65f6\uff0c\u9009\u53d6\u94fe\u7684\u65b9\u6848\u6570\uff0c$g_i$ \u4e3a\u4e24\u8005\u4e4b\u548c\u3002\n\n\u6613\u5f97\u8f6c\u79fb\u65b9\u7a0b $f_{i,0}=\\prod\\limits_{j\\text{\u662f}i\\text{\u7684\u5b69\u5b50}}g_j,f_{i,1}=\\sum\\limits_{\\text{\u94fe}L\\text{\u7684lca\u662f}i}\\prod\\limits_{j\\text{\u4e0d\u5728}L\\text{\u4e0a\uff0c\u4e14}\\atop j\\text{\u7684\u7236\u4eb2\u5728}L\\text{\u4e0a}}g_j$\u3002\n\n$f_{i,0}$ \u5f88\u5bb9\u6613\u8ba1\u7b97\u51fa\uff0c\u8003\u8651\u5982\u4f55\u8ba1\u7b97 $f_{i,1}$\u3002\n\n\u53d1\u73b0\u8fde\u4e58\u7684\u5f62\u5f0f\u548c $f_{i,0}$ \u5f88\u50cf\uff0c\u4e8e\u662f\u8003\u8651\u5f80\u8fd9\u4e2a\u65b9\u5411\u53d8\u5f62\u3002\n\n\u5f97 $f_{i,1}=\\sum\\limits_{\\text{\u94fe}L\\text{\u7684lca\u662f}i}\\dfrac{\\prod\\limits_{j\\text{\u7684\u7236\u4eb2\u5728}L\\text{\u4e0a}}g_j}{\\prod\\limits_{k\\text{\u5728}L\\text{\u4e0a\u4e14}k\\neq i}g_k}=\\sum f_{i,0}\\prod\\limits_{j\\text{\u5728}L\\text{\u4e0a\u4e14}j\\neq i}\\dfrac{f_{j,0}}{g_j}$\u3002\n\n\u663e\u7136\u8fd9\u662f\u4e00\u4e2a\u6811\u4e0a\u7684\u533a\u95f4\u6c42\u4e58\u79ef\uff0c\u6700\u7b80\u5355\u7684\u65b9\u6cd5\u662f \u6811\u5256+\u7ebf\u6bb5\u6811\uff0c\u4f46\u5e76\u4e0d\u80fd\u901a\u8fc7\u6b64\u9898\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u5bf9\u6811\u5256\u7684\u6bcf\u6761\u91cd\u94fe\u7ef4\u62a4\u540e\u7f00\u79ef\uff0c\u56e0\u4e3a\u6574\u4e2a dp \u7684\u8fc7\u7a0b\u662f\u4ece\u4e0b\u5f80\u4e0a\u7684\uff0c\u800c\u4e14\u6211\u4eec\u53ea\u9700\u8981\u7528\u5230\u4e0b\u9762\u7684\u4fe1\u606f\u70b9\uff0c\u6240\u4ee5\u5bf9\u4e8e\u6bcf\u4e2a\u70b9\u6211\u4eec\u90fd\u53ef\u4ee5\u505a\u5230 $O(1)$ \u7ef4\u62a4\u540e\u7f00\u79ef+\u6bcf\u6761\u94fe $O(\\log n\\log p)$ \u67e5\u8be2\uff0c\u9884\u5904\u7406\u9006\u5143\u540e\u53ef\u4ee5\u6bcf\u4e2a\u70b9 $O(\\log p)$ \u7ef4\u62a4+\u6bcf\u6761\u94fe $O(\\log n)$ \u67e5\u8be2\uff0c\u53ef\u4ee5\u901a\u8fc7\u3002\n\n~~\u4ee5\u4e0a\u505a\u6cd5\u5df2\u88ab hack~~\n\n------------\n\n\u4e0a\u9762\u505a\u6cd5\u7684\u6700\u5927\u95ee\u9898\u662f $f_{i,0}$ \u548c $g_i$ \u5728\u5bf9 $998244353$ \u53d6\u6a21\u610f\u4e49\u4e0b\u53ef\u80fd\u4e3a $0$\uff0c\u5bfc\u81f4\u9006\u5143\u65e0\u6cd5\u4f7f\u7528\u3002\u4f46\u6211\u4eec\u4e5f\u53ef\u4ee5\u4ece\u4e2d\u83b7\u5f97\u4e00\u4e9b\u542f\u793a\u3002\n\n\u6211\u4eec\u628a\u4e58\u79ef\u5f0f\u4e2d\u7684\u5143\u7d20\u5206\u4e3a $j$ \u662f $i$ \u7684\u513f\u5b50\u4ee5\u53ca\u4e0d\u662f $i$ \u7684\u513f\u5b50\u4e24\u90e8\u5206\uff0c\u53d1\u73b0\u5bf9\u4e8e $j$ \u662f $i$ \u7684\u513f\u5b50\u7684\u90e8\u5206\uff0c\u6700\u591a\u53ea\u4f1a\u6709\u4e24\u4e2a\u5143\u7d20\u7f3a\u5931\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u7ed9 $i$ \u7684\u6bcf\u4e2a\u513f\u5b50\u4e00\u4e2a\u6807\u53f7\uff0c\u7528\u7ebf\u6bb5\u6811\u5904\u7406\u51fa\u533a\u95f4\u4e58\u79ef\uff0c\u5bf9\u4e8e\u6bcf\u6761\u94fe\u6700\u591a\u53ea\u4f1a\u6709 $3$ \u6b21\u8be2\u95ee\uff0c\u6240\u4ee5\u5bf9\u4e8e\u6bcf\u6761\u94fe\u590d\u6742\u5ea6\u662f $O(\\log n)$\u3002\n\n\u5bf9\u4e8e\u4e0d\u662f $i$ \u7684\u513f\u5b50\u7684\u90e8\u5206\uff0c\u53ef\u4ee5\u53d1\u73b0\u5bf9\u4e8e\u6240\u6709\u94fe $L$ \u4e0a\u7684\u70b9 $j$\uff0c\u90fd\u6700\u591a\u53ea\u4f1a\u7f3a\u5931\u4e00\u4e2a\u5143\u7d20\uff0c\u5e76\u4e14\u7f3a\u5931\u7684\u5143\u7d20\u5c31\u662f\u94fe $L$ \u4e0a\u7684\u70b9\u3002\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u53e6\u8bbe $h_i$ \u8868\u793a $fa_i$ \u7684\u513f\u5b50\u4e2d\u9664\u4e86 $i$ \u4ee5\u5916\u6240\u6709 $g$ \u7684\u4e58\u79ef\uff0c\u90a3\u4e48\u6211\u4eec\u76f8\u5f53\u4e8e\u9700\u8981\u67e5\u8be2\u4e00\u6761\u94fe\u4e0a\u6240\u6709\u5143\u7d20\u7684\u4e58\u79ef\uff0c\u6211\u4eec\u53ef\u4ee5\u8f6c\u5316\u4e3a\u6bcf\u6b21\u5bf9\u4ee5\u67d0\u4e2a\u70b9\u4e3a\u6839\u7684\u5b50\u6811\u5185\u6240\u6709\u5143\u7d20\u4e58\u4e0a\u4e00\u4e2a\u6570\uff0c\u7136\u540e\u8fdb\u884c\u5355\u70b9\u67e5\u8be2\u3002\u56e0\u6b64\u590d\u6742\u5ea6\u8fd8\u662f $O(\\log n)$ \u7684\u3002\n\n\u603b\u590d\u6742\u5ea6\u5e94\u8be5\u662f $O\\left((n+m)\\log n\\right)$\uff0c\u7ec6\u8282\u76f8\u5bf9\u8f83\u591a\u3002\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define p 998244353\nint lsw[500005],bi[1000005][2],bs;\nint fa[500005],so[500005],si[500005],de[500005],to[500005],xh[500005],dfn;\nint lw[500005],la[500005][3];\nint n,m,ff[2][500005],f[500005];\nint dr()\n{\n    int xx=0;char ch=getchar();\n    while(ch<'0'||ch>'9')ch=getchar();\n    while(ch>='0'&&ch<='9')xx=xx*10+ch-'0',ch=getchar();\n    return xx;\n}\nint P(int x,int y=p-2)\n{\n    int z=1;\n    for(;y;x=1ll*x*x%p,y>>=1)if(y&1)z=1ll*z*x%p;\n    return z;\n}\nvoid tj(int u,int v){++bs,bi[bs][0]=lsw[u],bi[bs][1]=v,lsw[u]=bs;}\nvoid dfs_1(int w,int f)\n{\n    fa[w]=f,si[w]=1,de[w]=de[f]+1;\n    for(int o_o=lsw[w];o_o;o_o=bi[o_o][0])\n    {\n        int v=bi[o_o][1];\n        if(v!=f)\n        {\n            dfs_1(v,w),si[w]+=si[v];\n            if(si[v]>si[so[w]])so[w]=v;\n        }\n    }\n}\nvoid dfs_2(int w,int t)\n{\n    to[w]=t,xh[w]=++dfn;\n    if(so[w])dfs_2(so[w],t);\n    for(int o_o=lsw[w];o_o;o_o=bi[o_o][0])\n    {\n        int v=bi[o_o][1];\n        if(v!=fa[w]&&v!=so[w])dfs_2(v,v);\n    }\n}\nint fi(int x,int y)\n{\n    int fx=to[x],fy=to[y];\n    while(fx!=fy)\n    {\n        if(de[fx]>=de[fy])x=fa[fx],fx=to[x];\n        else y=fa[fy],fy=to[y];\n    }\n    return de[x]<de[y]? x:y;\n}\nint ju(int x,int y)\n{\n\tint fx=to[x],fy=to[y];\n\twhile(fx!=fy)\n\t{\n\t\tif(fa[fx]==y)return fx;\n\t\tx=fa[fx],fx=to[x];\n\t}\n\treturn so[y];\n}\nint tree[2000005],ltree[2000005],a[500005],lxh[500005];\n#define ls(w) (w<<1)\n#define rs(w) (ls(w)^1)\nvoid d(int w){if(tree[w]!=1)tree[ls(w)]=1ll*tree[ls(w)]*tree[w]%p,tree[rs(w)]=1ll*tree[rs(w)]*tree[w]%p,tree[w]=1;}\nvoid csh1(int w,int l,int r)\n{\n\ttree[w]=1;\n\tif(l==r)return;\n\tint mid=(l+r)>>1;\n\tcsh1(ls(w),l,mid),csh1(rs(w),mid+1,r);\n}\nvoid xg1(int w,int l,int r,int L,int R,int x)\n{\n\tif(L<=l&&r<=R){tree[w]=1ll*tree[w]*x%p;return;}\n\td(w);\n\tint mid=(l+r)>>1;\n\tif(L<=mid)xg1(ls(w),l,mid,L,R,x);\n\tif(mid<R)xg1(rs(w),mid+1,r,L,R,x);\n}\nint cx1(int w,int l,int r,int xh)\n{\n\tif(l==r)return tree[w];\n\td(w);\n\tint mid=(l+r)>>1;\n\tif(xh<=mid)return cx1(ls(w),l,mid,xh);\n\telse return cx1(rs(w),mid+1,r,xh);\n}\nvoid u(int w){ltree[w]=1ll*ltree[ls(w)]*ltree[rs(w)]%p;}\nvoid csh2(int w,int l,int r)\n{\n\tif(l==r){ltree[w]=a[l];return;}\n\tint mid=(l+r)>>1;\n\tcsh2(ls(w),l,mid),csh2(rs(w),mid+1,r);\n\tu(w);\n}\nint cx2(int w,int l,int r,int L,int R)\n{\n\tif(L>R)return 1;\n\tif(L<=l&&r<=R)return ltree[w];\n\tint mid=(l+r)>>1,x=1;\n\tif(L<=mid)x=1ll*x*cx2(ls(w),l,mid,L,R)%p;\n\tif(mid<R)x=1ll*x*cx2(rs(w),mid+1,r,L,R)%p;\n\treturn x;\n}\nvoid dp(int w)\n{\n    ff[0][w]=1;int tot=0;\n    for(int o_o=lsw[w];o_o;o_o=bi[o_o][0])\n    {\n        int v=bi[o_o][1];\n        if(v!=fa[w])dp(v),lxh[v]=++tot,ff[0][w]=1ll*ff[0][w]*f[v]%p;\n    }\n    for(int o_o=lsw[w];o_o;o_o=bi[o_o][0])\n    {\n    \tint v=bi[o_o][1];\n    \tif(v!=fa[w])a[lxh[v]]=f[v];\n\t}\n\tif(tot)csh2(1,1,tot);\n    for(int o_o=lw[w];o_o;o_o=la[o_o][0])\n\t{\n\t\tint u=la[o_o][1],v=la[o_o][2];\n\t\tif(u!=w&&v!=w)\n\t\t{\n\t\t\tint x=ju(u,w),y=ju(v,w);\n\t\t\tif(lxh[x]>lxh[y])swap(x,y);\n\t\t\tff[1][w]=(ff[1][w]+(1ll*cx1(1,1,n,xh[u])*ff[0][u]%p)*(1ll*cx1(1,1,n,xh[v])*ff[0][v]%p)%p*(1ll*cx2(1,1,tot,1,lxh[x]-1)*cx2(1,1,tot,lxh[x]+1,lxh[y]-1)%p*cx2(1,1,tot,lxh[y]+1,tot)%p))%p;\n\t\t}\n\t\telse if(u==w&&v==w)\n\t\t{\n\t\t\tff[1][w]=(ff[1][w]+ff[0][w])%p;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif(v==w)swap(u,v);\n\t\t\tint x=ju(v,w);\n\t\t\tff[1][w]=(ff[1][w]+1ll*cx1(1,1,n,xh[v])*ff[0][v]%p*cx2(1,1,tot,1,lxh[x]-1)%p*cx2(1,1,tot,lxh[x]+1,tot))%p;\n\t\t}\n\t}\n\tfor(int o_o=lsw[w];o_o;o_o=bi[o_o][0])\n\t{\n\t\tint v=bi[o_o][1];\n    \tif(v!=fa[w])\n    \t{\n    \t\tint x=1ll*cx2(1,1,tot,1,lxh[v]-1)*cx2(1,1,tot,lxh[v]+1,tot)%p;\n    \t\txg1(1,1,n,xh[v],xh[v]+si[v]-1,x);\n\t\t}\n\t}\n    f[w]=(ff[0][w]+ff[1][w])%p;\n}\nint main()\n{\n    n=dr(),m=dr();\n    for(int i=1;i<n;i++)\n    {\n        int u=dr(),v=dr();\n        tj(u,v),tj(v,u);\n    }\n    dfs_1(1,0),dfs_2(1,1);\n    for(int i=1;i<=m;i++)\n    {\n        int u=dr(),v=dr(),g=fi(u,v);\n        la[i][0]=lw[g],la[i][1]=u,la[i][2]=v,lw[g]=i;\n    }\n    csh1(1,1,n),dp(1);\n    printf(\"%d\",f[1]);\n}\n\n```\n",
        "postTime": 1606995584,
        "uid": 104581,
        "name": "kkk\u7684\u5c0f\u8214\u72d7",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P6799 \u3010\u300cStOI-2\u300d\u72ec\u7acb\u96c6\u3011"
    }
]