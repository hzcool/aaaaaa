[
    {
        "content": "\u4e00\u9053\u6bd4\u8f83\u7b80\u5355\u7684\u6570\u636e\u7ed3\u6784\u9898\u3002\r\n\r\n\u5982\u679c\u53ea\u6709\u4e00\u79cd\u5b57\u7b26\u4e32\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u6811\u94fe\u5256\u5206+\u7ebf\u6bb5\u6811\u6765\u89e3\u51b3\u3002\r\n\r\n\u8fd9\u91cc\u6709\u591a\u79cd\u5b57\u7b26\u4e32\uff0c\u90a3\u4e48\u6211\u4eec\u8fd8\u662f\u6811\u94fe\u5256\u5206\uff0c\u7136\u540e\u5bf9\u6bcf\u79cd\u4e0d\u540c\u7684\u5b57\u7b26\u4e32\u5f00\u7ebf\u6bb5\u6811\u5c31\u53ef\u4ee5\u4e86\u3002\u7a7a\u95f4\u7528\u52a8\u6001\u5f00\u70b9\u6765\u89e3\u51b3\u3002\r\n\r\n\u64cd\u4f5c2\u30013\u5c31\u662f\u57fa\u672c\u7684\u7ebf\u6bb5\u6811\u533a\u95f4\u4fee\u6539\u533a\u95f4\u67e5\u8be2\u3002\u64cd\u4f5c1\u76f4\u63a5\u8be2\u95eeLCA\u5373\u53ef\u3002\r\n\r\n\u5bf9\u4e8e\u5224\u65ad\u5b57\u7b26\u4e32\u76f8\u7b49\u7684\u95ee\u9898\uff0c\u7531\u4e8e\u5b57\u7b26\u4e32\u957f\u5ea6\u4e0d\u8d85\u8fc76\uff0c\u56e0\u6b64\u6211\u4eec\u628a\u5b57\u7b26\u4e32\u770b\u505a\u4e00\u4e2a**27**\u8fdb\u5236\u6570\uff0c\u7528```long long```\u5b58\uff0c```map```\u79bb\u6563\u5316\u5373\u53ef\u3002\r\n\r\n\u8bbe\u5b57\u7b26\u4e32\u603b\u6570\u4e3a$S$\uff0c\u5219\u65f6\u95f4\u590d\u6742\u5ea6$O(n+m\\log^2 n+S\\log n)$\uff0c\u7a7a\u95f4\u590d\u6742\u5ea6$O(n+S\\log n)$\u3002\r\n\r\n## Code\uff1a\r\n```cpp\r\n#include<iostream>\r\n#include<vector>\r\n#include<cstring>\r\n#include<map>\r\nusing namespace std;\r\ntypedef long long LL;\r\nconst int N=1e5+5,M=N*5;\r\nchar ss[233];\r\nvector<int>G[N];\r\nint n,m,fa[N],son[N],top[N],sz[N],dfn[N],idx,dep[N],rt[M],ls[M*20],rs[M*20],d[M*20],tot,num;\r\nmap<LL,int>ys;\r\ninline LL Hx(char*s,int n){\r\n\tLL ret=0,x=1;\r\n\tfor(int i=2;i<n;++i,x*=27)\r\n\tret+=(s[i]-'a'+1)*x;\r\n\treturn ret;\r\n}\r\nvoid dfs(int now){\r\n\tsz[now]=1;\r\n\tfor(int to:G[now])\r\n\tif(!dep[to]){\r\n\t\tdep[to]=dep[now]+1,fa[to]=now,dfs(to);\r\n\t\tsz[now]+=sz[to];\r\n\t\tif(!son[now]||sz[son[now]]<sz[to])son[now]=to;\r\n\t}\r\n}\r\nvoid dfs2(int now){\r\n\tdfn[now]=++idx;\r\n\tif(son[now])top[son[now]]=top[now],dfs2(son[now]);\r\n\tfor(int to:G[now])\r\n\tif(to!=son[now]&&to!=fa[now])dfs2(top[to]=to);\r\n}\r\ninline int LCA(int x,int y){\r\n\twhile(top[x]!=top[y])\r\n\tif(dep[top[x]]>dep[top[y]])x=fa[top[x]];else y=fa[top[y]];\r\n\treturn dep[x]<dep[y]?x:y;\r\n}\r\ninline int dist(int u,int v){return dep[u]+dep[v]-2*dep[LCA(u,v)];}\r\nvoid add(int&o,int l,int r,const int&pos){\r\n\tif(!o)o=++tot;\r\n\t++d[o];\r\n\tif(l<r){\r\n\t\tconst int mid=l+r>>1;\r\n\t\tif(pos<=mid)add(ls[o],l,mid,pos);else add(rs[o],mid+1,r,pos);\r\n\t}\r\n}\r\nint erase(int&o,int l,int r,const int&L,const int&R){\r\n\tif(!o)return 0;\r\n\tint ret=0;\r\n\tif(L<=l&&r<=R){\r\n\t\tret+=d[o],o=0;return ret;\r\n\t}\r\n\tconst int mid=l+r>>1;\r\n\tif(L<=mid)ret+=erase(ls[o],l,mid,L,R);\r\n\tif(mid<R)ret+=erase(rs[o],mid+1,r,L,R);\r\n\td[o]=d[ls[o]]+d[rs[o]];\r\n\tif(!d[o])o=0;\r\n\treturn ret;\r\n}\r\nint erase(int&o,int x,int y){\r\n\tint ret=0;\r\n\twhile(top[x]!=top[y])\r\n\tif(dep[top[x]]>dep[top[y]])\r\n\tret+=erase(o,1,n,dfn[top[x]],dfn[x]),x=fa[top[x]];else\r\n\tret+=erase(o,1,n,dfn[top[y]],dfn[y]),y=fa[top[y]];\r\n\tif(dep[x]<dep[y])ret+=erase(o,1,n,dfn[x],dfn[y]);else ret+=erase(o,1,n,dfn[y],dfn[x]);\r\n\treturn ret;\r\n}\r\nint query(int o,int l,int r,const int&L,const int&R){\r\n\tif(!o)return 0;\r\n\tif(L<=l&&r<=R)return d[o];\r\n\tconst int mid=l+r>>1;\r\n\tif(L<=mid&&mid<R)return query(ls[o],l,mid,L,R)+query(rs[o],mid+1,r,L,R);\r\n\tif(L<=mid)return query(ls[o],l,mid,L,R);return query(rs[o],mid+1,r,L,R);\r\n}\r\nint query(int o,int x,int y){\r\n\tint ret=0;\r\n\twhile(top[x]!=top[y])\r\n\tif(dep[top[x]]>dep[top[y]])\r\n\tret+=query(o,1,n,dfn[top[x]],dfn[x]),x=fa[top[x]];else\r\n\tret+=query(o,1,n,dfn[top[y]],dfn[y]),y=fa[top[y]];\r\n\tif(dep[x]<dep[y])ret+=query(o,1,n,dfn[x],dfn[y]);else ret+=query(o,1,n,dfn[y],dfn[x]);\r\n\treturn ret;\r\n}\r\nint main(){\r\n\tios::sync_with_stdio(0),cin.tie(0),cout.tie(0);\r\n\tcin>>n>>m;\r\n\tfor(int i=1;i<n;++i){\r\n\t\tint u,v;\r\n\t\tcin>>u>>v;\r\n\t\tG[u].push_back(v),G[v].push_back(u);\r\n\t}\r\n\tdfs(dep[1]=1),dfs2(1);\r\n\tss[0]=ss[1]=' ';\r\n\tfor(int i=1,k;i<=n;++i)\r\n\tfor(cin>>k;k--;){\r\n\t\tcin>>(ss+2);\r\n\t\tLL hx=Hx(ss,strlen(ss));\r\n\t\tif(!ys.count(hx))ys[hx]=++num;\r\n\t\tadd(rt[ys[hx]],1,n,dfn[i]);\r\n\t}\r\n\twhile(m--){\r\n\t\tcin>>ss;\r\n\t\tif(*ss=='q'){\r\n\t\t\tcin>>ss;\r\n\t\t\tif(ss[1]=='p'){\r\n\t\t\t\tint u,v;\r\n\t\t\t\tcin>>u>>v;\r\n\t\t\t\tcout<<dist(u,v)<<'\\n';\r\n\t\t\t}else{\r\n\t\t\t\tint u,v;\r\n\t\t\t\tcin>>u>>v>>ss;\r\n\t\t\t\tLL hx=Hx(ss,strlen(ss));\r\n\t\t\t\tif(!ys.count(hx))cout<<\"0\\n\";else\r\n\t\t\t\tcout<<query(rt[ys[hx]],u,v)<<'\\n';\r\n\t\t\t}\r\n\t\t}else{\r\n\t\t\tint u,v;\r\n\t\t\tcin>>ss>>u>>v>>ss;\r\n\t\t\tLL hx=Hx(ss,strlen(ss));\r\n\t\t\tif(!ys.count(hx))cout<<\"0\\n\";else\r\n\t\t\tcout<<erase(rt[ys[hx]],u,v)<<'\\n';\r\n\t\t}\r\n\t}\r\n\treturn 0;\r\n}\r\n```",
        "postTime": 1559710855,
        "uid": 6813,
        "name": "mrsrz",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P4947 \u3010PION\u540e\u7f00\u81ea\u52a8\u673a\u3011"
    },
    {
        "content": "\n**\u524d\u8a00\uff1a**\n\n1.\u6211\u7684\u65b9\u6cd5\u662f\u6211\u5728\u51fa\u597d\u8fd9\u9053\u9898\u4e4b\u524d\u60f3\u51fa\u7684\uff0c\u5f53\u65f6\u5148\u60f3\u7684\u5bf9\u7ebf\u6027\u5e8f\u5217\u7684\u64cd\u4f5c\uff0c\u51fa\u8fd9\u9053\u9898\u65f6\u6539\u4e3a\u6811\u4e0a\u64cd\u4f5c\uff0c\u800c\u4e14\u4e3a\u4e86\u589e\u52a0\u96be\u5ea6\uff0c\u6bcf\u4e2a\u8282\u70b9\u4e0a\u5143\u7d20\u6570\u91cf\u53ef\u80fd\u4e0d\u76f8\u540c\uff0c\u4e8e\u662f\u9700\u8981\u5bf9\u6811\u94fe\u5256\u5206\u8fdb\u884c\u8f83\u5927\u7684\u53d8\u5f62\u3002\n\n2.\u5f88\u5e78\u8fd0\uff0c\u8fd9\u9053\u9898\u65b9\u6cd5\u4e0d\u552f\u4e00\uff0c\u5b83\u53ef\u4ee5\u7528\u6211\u4e0d\u4f1a\u7684\u6570\u636e\u7ed3\u6784\u505a\uff0c\u4f46\u5177\u4f53\u600e\u4e48\u505a\u6211\u5c31\u4e0d\u77e5\u9053\u4e86\u3002\uff08\u53ef\u4ee5\u8bf7\u6559AC\u7684\u5927\u4f6c\uff09\u3002\n\n---\n\n\u8003\u5bdf\u77e5\u8bc6\uff1a\u6811\u94fe\u5256\u5206\uff0c\u7ebf\u6bb5\u6811\uff0c\u94fe\u8868\uff0c\u6392\u5e8f\uff0c\u4e8c\u5206\uff0c\u5b57\u7b26\u4e32\u5904\u7406\n\n\u7b97\u6cd5\u96be\u5ea6\uff1aXXXXX \u5b9e\u73b0\u96be\u5ea6\uff1aXXXXX\n\n---\n\n\u5206\u6790\uff1a\u7b97\u6cd5\u8f83\u590d\u6742\uff0c\u4ee3\u7801\u91cf\u5927\uff08\u677f\u5b50\u592a\u591a\uff09\uff01\u8fd9\u662f\u4e00\u9053\u5178\u578b\u7684\u8003\u573a\u4e0a\u6b63\u89e3\u4e0d\u5982\u5199\u66b4\u529b\u7684\u9898\uff01\n\n\u5148\u4ecb\u7ecd**\u66b4\u529b\u7b97\u6cd5**\uff0855\u5206\uff09\uff1a\n\n\u5982\u679c\u4f60\u7684\u7a0b\u5e8f\u8d85\u65f6\uff0c\u4f60\u53ef\u4ee5\u5148\u5c1d\u8bd5\u8fd9\u9053\u9898\uff1a[PION\u540e\u7f00\u81ea\u52a8\u673a\uff08\u6570\u636e\u5f31\u5316\u7248\uff09](https://www.luogu.org/problemnew/show/U41487)\n\n\u7b97\u6cd5\u96be\u5ea6\uff1aXXX \u5b9e\u73b0\u96be\u5ea6\uff1aXXX+\n\n\u663e\u7136\u50a8\u5b58\u6587\u4ef6\u540e\u7f00\u4fe1\u606f\u4e0d\u80fd\u7528\u6570\u7ec4\uff0c\u7a7a\u95f4\u5f00\u4e0d\u4e0b\uff0c\u6240\u4ee5\u6211\u4eec\u7528\u94fe\u8868\u50a8\u5b58\u6240\u6709\u6587\u4ef6\u5939\u4e2d\u6587\u4ef6\u7684\u540e\u7f00\u4fe1\u606f\uff1b\n\n\u7136\u540e\u662f\u540e\u7f00\u7684\u5904\u7406\uff0c\u6ce8\u610f\u5230\u5b57\u7b26\u4e32\u957f\u5ea6\u5c0f\u4e8e6\uff0c\u5982\u679c\u6211\u4eec\u7528 1 \u8868\u793a a \uff0c2 \u8868\u793a b \uff0c... ... \uff0c26 \u8868\u793a z\uff0c\u8fd9\u5c31\u76f8\u5f53\u4e8e\u5c06\u5b57\u7b26\u4e32\u770b\u505a\u4e00\u4e2a27\u8fdb\u5236\u6570\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u5728 int \u8303\u56f4\u5185\u7528\u6570\u5b57\u8868\u793a\u5b57\u7b26\u4e32\u4e86\n\n\u89e3\u51b3\u4e86\u4e0a\u9762\u4e24\u4e2a\u95ee\u9898\u4e4b\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5efa\u6811\u7136\u540e\u5bf9\u6bcf\u4e2a\u64cd\u4f5c\u7528\u66b4\u529b\u7684 \u201c\u9010\u6b65\u722c\u5c71\u6cd5\u201d \uff08\u5373\u6309\u8def\u5f84\u4e00\u4e2a\u8282\u70b9\u4e00\u4e2a\u8282\u70b9\u7684\u7edf\u8ba1\uff09\u89e3\u51b3\u4e86\uff0c\u5b9e\u73b0\u96be\u5ea6\u4e0d\u5927\n\n\u5176\u5b9e\u8fd9\u79cd\u65b9\u6cd5\u5bf9\u968f\u673a\u6570\u636e\u6548\u679c\u8fd8\u662f\u6bd4\u8f83\u597d\u7684\uff08\u751a\u81f3\u6bd4\u4e0b\u9762\u7684\u6ee1\u5206\u7b97\u6cd5\u8fd8\u7565\u5feb\u4e00\u70b9\uff09\uff0c\u4f46\u662f\u4f60\u89c9\u5f97\u6570\u636e\u53ef\u80fd\u5b8c\u5168\u968f\u673a\u4e48\uff1f\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a\u6781\u7aef\u60c5\u51b5\u7ea6$O(mn)$\n\n**\u6ee1\u5206\u7b97\u6cd5\uff1a**\n\n\u4ee3\u7801\u91cf\u6bd4\u8f83\u5927\u3002\n\n\u770b\u5230\u8fd9\u9053\u9898\u6211\u4eec\u5e94\u8be5\u53ef\u4ee5\u60f3\u5230\u7528\u6811\u94fe\u5256\u5206\u6765\u505a\u3002\n\n\u6211\u4eec\u5148\u8003\u8651\u600e\u4e48\u5bf9\u5e8f\u5217\u8fdb\u884c\u7edf\u8ba1\u548c\u4fee\u6539\uff0c\u5bf9\u4e8e\u64cd\u4f5c2\uff0c\u6211\u4eec\u9700\u8981\u627e\u5230\u4e00\u4e2a\u5e8f\u5217\u4e2d\u7684\u5b50\u5e8f\u5217\u3002\u6211\u4eec\u53ef\u4ee5\u7528\u4e00\u4e2a\u7ed3\u6784\u4f53\u6765\u50a8\u5b58\uff0c\u7ed3\u6784\u4f53\u50a8\u5b58\u5e8f\u5217\u4e2d\u6bcf\u4e2a\u5143\u7d20\u7684\u503c\uff08\u5b57\u7b26\u4e32\u7684hash\u503c\uff09\u548c\u5e8f\u5217\u4e2d\u6bcf\u4e2a\u5143\u7d20\u5728\u5e8f\u5217\u4e2d\u7684\u4f4d\u7f6e\u3002\u7136\u540e\u5c06\u8fd9\u4e2a\u7ed3\u6784\u4f53\u5e8f\u5217\u6309\u5143\u7d20\u503c\u7684\u6392\u5e8f\uff08\u5143\u7d20\u503c\u76f8\u540c\u7684\u6309\u5728\u5e8f\u5217\u4e2d\u7684\u4f4d\u7f6e\u6392\u5e8f\uff09\u3002\u5f53\u6211\u4eec\u9700\u8981\u67e5\u627e\u4e00\u4e2a\u5e8f\u5217\u76f8\u540c\u6570\u503c\u6240\u5728\u7684\u533a\u95f4\u7684\u65f6\u5019\u7528 lower_bound \u548c upper_bound \u5c31\u53ef\u4ee5\u5b8c\u6210\uff0c\u5bf9\u4e8e\u67e5\u627e\u51fa\u6765\u7684\u76ee\u6807\u533a\u95f4\uff0c\u8fd8\u9700\u8981\u7528\u4e8c\u5206\u6cd5\u6765\u67e5\u627e\u8be5\u533a\u95f4\u4e2d\u5143\u7d20\u7684\u4e0b\u6807\u5728\u76ee\u6807\u5b50\u5e8f\u5217\u4e2d\u7684\u6570\u91cf\u3002\n\n\u81f3\u4e8e\u4fee\u6539\uff0c\u7528\u7ebf\u6bb5\u6811\u7684\u533a\u95f4\u7ef4\u62a4\u5b9e\u73b0\u3002\n\n\u89e3\u51b3\u4e86\u5bf9\u5e8f\u5217\u7684\u4fee\u6539\uff0c\u6211\u4eec\u8fd8\u8981\u89e3\u51b3\u6811\u4e2d\u6bcf\u4e2a\u8282\u70b9\u542b\u6709\u7684\u6587\u4ef6\u6570\u76ee\u4e0d\u76f8\u540c\u7684\u95ee\u9898\uff0c\u5982\u679c\u4e00\u4e2a\u8282\u70b9\u6ca1\u6709\u6587\u4ef6\uff0c\u90a3\u4e48\u4e00\u4e2a\u7b80\u5355\u7684\u65b9\u6cd5\u662f\u65b0\u5efa\u4e00\u4e2a\u4f2a\u6587\u4ef6\uff0c\u53ef\u4ee5\u5c06hash\u503c\u8d4b\u4e3a -1\u3002\n\n\u4e4b\u540e\u5c31\u662f\u6811\u94fe\u5256\u5206\u4e86\uff0c\u4e0d\u540c\u4e8e\u6811\u94fe\u5256\u5206\u6a21\u677f\uff0c\u6211\u4eec\u8fd8\u8981\u65b0\u5efa\u4e00\u4e2a\u8f85\u52a9\u6570\u7ec4\u00a0low[i] \uff0c\u8868\u793a\u8282\u70b9 i \u7684\u91cd\u5b50\u5b59\u53ef\u4ee5\u5230\u8fbe\u7684\u6700\u6df1\u8282\u5b50\u8282\u70b9\u7684\u7f16\u53f7\uff0c\u6211\u4eec\u5148\u5bf9$[\\,top[i],low[i]\\,]$\u6392\u5e8f\uff0c\u4e4b\u540e\u67e5\u8be2\u7684\u65f6\u5019\u6211\u4eec\u6309\u6811\u94fe\u5256\u5206\u6811\u4e0a\u8def\u5f84\u67e5\u8be2\u7684\u65b9\u6cd5\u67e5\u8be2$[\\,top[i],low[i]\\,]$\u4e4b\u95f4\u7684\u5e8f\u5217\u5373\u53ef\u3002\n\n\u8fd9\u9053\u9898\u5728\u6811\u4e0a\u5c06\u8def\u5f84\u62c6\u5f00\u67e5\u8be2\u7684\u601d\u60f3\u7c7b\u4f3c\u4e8e\u5206\u5757\u3002\n\n\u5176\u5b9e\u5427\uff0c\u4e0a\u9762\u53ea\u662f\u4ee3\u7801\u5b9e\u73b0\u7684\u4e00\u90e8\u5206\uff0c\u5177\u4f53\u7ec6\u8282\u8fdc\u4e0d\u6b62\u8fd9\u4e9b\uff0c\u66f4\u591a\u7684\u7ec6\u8282\u8bf7\u53c2\u8003\u4ee3\u7801\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a\u6781\u7aef\u60c5\u51b5\u7ea6$O((n+m)log^2n)$\n\n---\n\n\u4ee3\u7801\u8bf7\u53c2\u8003\uff1a[\u3010\u6d1b\u8c37\u3011NOIP2018\u539f\u521b\u6a21\u62df\u8d5bDAY2\u9898\u89e3T3](https://blog.csdn.net/hi_ker/article/details/82820861#t3)",
        "postTime": 1540974183,
        "uid": 85423,
        "name": "Voldermod",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P4947 \u3010PION\u540e\u7f00\u81ea\u52a8\u673a\u3011"
    },
    {
        "content": "\u6570\u636e\u7ed3\u6784\u597d\u9898\u3002\n\n\u6211\u4eec\u8003\u8651\u5bf9\u8fd9\u9897\u6811\u8fdb\u884c\u6811\u94fe\u5256\u5206\u3002\n\n\u6bcf\u6b21\u8be2\u95ee\u7684\u65f6\u5019\uff0c\u6211\u4eec\u8981\u67e5\u8be2\u4e00\u6761\u8def\u5f84\u4e0a\u7684\u6709\u8be5\u540e\u7f00\u540d\u7684\u4e2a\u6570\u3002\n\n\u56e0\u4e3a\u4e00\u4e2a\u70b9\u4e0a\u53ef\u80fd\u6709\u591a\u4e2a\u540e\u7f00\u540d\uff0c\u6211\u4eec\u5bf9\u6bcf\u4e2a\u540e\u7f00\u540d\u5efa\u4e00\u9897\u7ebf\u6bb5\u6811\u3002\n\n\u56e0\u4e3a\u7a7a\u95f4\u53ef\u80fd\u4f1a\u5f88\u5927\uff0c\u6240\u4ee5\u6211\u4eec\u4f7f\u7528\u52a8\u6001\u5f00\u70b9\u7ebf\u6bb5\u6811\u3002\n\n\u64cd\u4f5c\u4e00\u5c31\u662f\u6c42\u4e24\u70b9\u4e4b\u95f4\u8ddd\u79bb\uff0c\u7528\u6811\u5256\u6c42 lca \u5373\u53ef\u3002\n\n\u540e\u9762\u4e24\u4e2a\u64cd\u4f5c\uff0c\u5373\u4e3a\u7ebf\u6bb5\u6811\u7684\u533a\u95f4\u4fee\u6539\u548c\u533a\u95f4\u6c42\u548c\u7684\u64cd\u4f5c\u3002\n\n\u5bf9\u4e8e\u5efa\u6811\u95ee\u9898\uff0c\u5176\u5b83\u4e24\u7bc7\u9898\u89e3\u90fd\u662f\u5c06\u5b57\u7b26\u4e32\u8f6c\u4e3a $26$ \u8fdb\u5236\uff0c\u7136\u800c\u4f46\u662f\u6ca1\u6709\u5fc5\u8981\u3002\u6211\u4eec\u76f4\u63a5\u7528 map \u5bf9\u5b57\u7b26\u4e32\u8fdb\u884c\u6570\u503c\u8d4b\u503c\u5c31\u884c\u4e86\u3002\n\n\n```cpp\n#include<bits/stdc++.h>\n#define inf 0x3f3f3f3f\n//#define LL_inf 1145141919810\n#define ull unsigned long long\n#define ll long long\nusing namespace std;\n//#define int long long\ninline int read()\n{\n\tint s=0,w=1;\n\tchar ch=getchar();\n\twhile(ch<'0' || ch>'9')\n\t{\n\t\tif(ch=='-') w=-1;\n\t\tch=getchar();\n\t}\n\twhile(ch>='0' && ch<='9')\n\t{\n\t\ts=s*10+ch-'0';\n\t\tch=getchar();\n\t}\n\treturn w*s;\n}\nvoid write(int x)\n{\n\tif(x<0)\n\t{\n\t\tputchar('-');\n\t\tx=-x;\n\t}\n\tif(x<10)\n\t{\n\t\tputchar(x+'0');\n\t\treturn ;\n\t}\n\twrite(x/10);\n\tputchar(x%10+'0');\n}\nconst int Maxn=4e5+10;\nint n,m;\nint son[Maxn],siz[Maxn];\nint Top[Maxn],dfn[Maxn];\nint dep[Maxn],fat[Maxn];\nint dfsTime;\nint head[Maxn],tot;\nstruct Edge{\n\tint to;\n\tint nxt;\n}E[Maxn<<1];\nvoid addedge(int u,int v)\n{\n\ttot++;\n\tE[tot].to=v;\n\tE[tot].nxt=head[u];\n\thead[u]=tot;\n}\nvoid dfs1(int u,int fa)\n{\n\tdep[u]=dep[fa]+1;\n\tfat[u]=fa;\n\tsiz[u]=1;\n\tfor(int i=head[u];i;i=E[i].nxt)\n\t{\n\t\tint v=E[i].to;\n\t\tif(v==fa) continue;\n\t\tdfs1(v,u);\n\t\tsiz[u]+=siz[v];\n\t\tif(siz[son[u]]<siz[v])\n\t\t{\n\t\t\tson[u]=v;\n\t\t}\n\t}\n}\nvoid dfs2(int u,int tp)\n{\n\tTop[u]=tp;\n\tdfn[u]=++dfsTime;\n\tif(!son[u])\n\t{\n\t\treturn ;\n\t}\n\tdfs2(son[u],tp);\n\tfor(int i=head[u];i;i=E[i].nxt)\n\t{\n\t\tint v=E[i].to;\n\t\tif(v==fat[u] || v==son[u])\n\t\t{\n\t\t\tcontinue;\n\t\t}\n\t\tdfs2(v,v);\n\t}\n}\nint root[Maxn<<5];\nstruct Segmenttree{\n\tstruct segtree{\n\t\tint lson,rson;\n\t\tint nums;\n\t}t[Maxn<<5];\n\tint totnum;\n\tint newnode()\n\t{\n\t\treturn ++totnum;\n\t}\n\tvoid pushup(int node)\n\t{\n\t\tt[node].nums=t[t[node].lson].nums+t[t[node].rson].nums;\n\t}\n\tvoid update(int &node,int l,int r,int pos)\n\t{\n\t\tif(!node)\n\t\t{\n\t\t\tnode=newnode();\n\t\t}\n\t\tt[node].nums++;\n\t\tif(l==r)\n\t\t{\n\t\t\treturn ;\n\t\t}\n\t\tint mid=(l+r)>>1;\n\t\tif(pos<=mid)\n\t\t{\n\t\t\tupdate(t[node].lson,l,mid,pos);\n\t\t}else{\n\t\t\tupdate(t[node].rson,mid+1,r,pos);\n\t\t}\n\t}\n\tint delet(int &node,int l,int r,int ql,int qr)\n\t{\n\t\tif(!node)\n\t\t{\n\t\t\treturn 0;\n\t\t}\n\t\tint res=0;\n\t\tif(ql<=l && r<=qr)\n\t\t{\n\t\t\tres=t[node].nums;\n\t\t\tnode=0;\n\t\t\treturn res;\n\t\t}\n\t\tint mid=(l+r)>>1;\n\t\tif(ql<=mid)\n\t\t{\n\t\t\tres+=delet(t[node].lson,l,mid,ql,qr);\n\t\t}\n\t\tif(qr>mid)\n\t\t{\n\t\t\tres+=delet(t[node].rson,mid+1,r,ql,qr);\n\t\t}\n\t\tpushup(node);\n\t\tif(!t[node].nums)\n\t\t{\n\t\t\tnode=0;\n\t\t}\n\t\treturn res;\n\t}\n\tint query(int &node,int l,int r,int ql,int qr)\n\t{\n\t\tif(!node) return 0;\n\t\tif(ql<=l && r<=qr)\n\t\t{\n\t\t\treturn t[node].nums;\n\t\t}\n\t\tint mid=(l+r)>>1,ans=0;\n\t\tif(ql<=mid)\n\t\t{\n\t\t\tans+=query(t[node].lson,l,mid,ql,qr);\n\t\t}\n\t\tif(qr>mid)\n\t\t{\n\t\t\tans+=query(t[node].rson,mid+1,r,ql,qr);\n\t\t}\n\t\treturn ans;\n\t}\n}seg;\n\nint queryedge(int &node,int u,int v)\n{\n\tint ans=0;\n\twhile(Top[u]!=Top[v])\n\t{\n\t\tif(dep[Top[u]]<dep[Top[v]])\n\t\t{\n\t\t\tswap(u,v);\n\t\t}\n\t\tans+=seg.query(node,1,n,dfn[Top[u]],dfn[u]);\n\t\tu=fat[Top[u]];\n\t}\n\tif(dep[u]>dep[v])\n\t{\n\t\tswap(u,v);\n\t}\n\tans+=seg.query(node,1,n,dfn[u],dfn[v]);\n\treturn ans;\n}\nint deledge(int &node,int u,int v)\n{\n\tint ans=0;\n\twhile(Top[u]!=Top[v])\n\t{\n\t\tif(dep[Top[u]]<dep[Top[v]])\n\t\t{\n\t\t\tswap(u,v);\n\t\t}\n\t\tans+=seg.delet(node,1,n,dfn[Top[u]],dfn[u]);\n\t\tu=fat[Top[u]];\n\t}\n\tif(dep[u]>dep[v])\n\t{\n\t\tswap(u,v);\n\t}\n\tans+=seg.delet(node,1,n,dfn[u],dfn[v]);\n\treturn ans;\n}\nint lca(int u,int v)\n{\n\twhile(Top[u]!=Top[v])\n\t{\n\t\tif(dep[Top[u]]<dep[Top[v]])\n\t\t{\n\t\t\tswap(u,v);\n\t\t}\n\t\tu=fat[Top[u]];\n\t}\n\tif(dep[u]>dep[v])\n\t{\n\t\tswap(u,v);\n\t}\n\treturn u;\n}\nint main()\n{\n\tn=read();\n\tm=read();\n\tfor(int i=1;i<n;i++)\n\t{\n\t\tint u,v;\n\t\tu=read(),v=read();\n\t\taddedge(u,v);\n\t\taddedge(v,u);\n\t}\n\tdfs1(1,0);\n\tdfs2(1,1);\n\tunordered_map<string,int> mp;\n\tint cnts=0;\n\tfor(int i=1;i<=n;i++)\n\t{\n\t\tint nums;\n\t\tnums=read();\n\t\twhile(nums--)\n\t\t{\n\t\t\tstring str;\n\t\t\tcin>>str;\n\t\t\tif(mp[str]==0)\n\t\t\t{\n\t\t\t\tmp[str]=++cnts;\n\t\t\t}\n\t\t\tseg.update(root[mp[str]],1,n,dfn[i]);\n\t\t}\n\t}\n\tint tot=0;\n\twhile(m--)\n\t{\n\t\tstring str;\n\t\tcin>>str;\n\t\tif(str==\"query\")\n\t\t{\n\t\t\tstring str2;\n\t\t\tcin>>str2;\n\t\t\tif(str2==\"/p\")\n\t\t\t{\n\t\t\t\tint u,v;\n\t\t\t\tu=read();\n\t\t\t\tv=read();\n\t\t\t\tint Lca=lca(u,v);\n\t\t\t\twrite(dep[u]+dep[v]-2*dep[Lca]);\n\t\t\t\tputchar('\\n');\n\t\t\t}else{\n\t\t\t\tint u,v;\n\t\t\t\tu=read(),v=read();\n\t\t\t\tstring qaq;\n\t\t\t\tcin>>qaq;\n\t\t\t\tstring tmp=\"\";\n\t\t\t\tbool flags=0;\n\t\t\t\tfor(int i=0;i<qaq.size();i++)\n\t\t\t\t{\n\t\t\t\t\tif(qaq[i]=='.')\n\t\t\t\t\t{\n\t\t\t\t\t\tflags=1;\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t\tif(flags) tmp+=qaq[i];\n\t\t\t\t}\n//\t\t\t\tcout<<\"tmp=\"<<tmp<<endl;\n\t\t\t\tif(mp[tmp]==0) puts(\"0\");\n\t\t\t\telse{\n\t\t\t\t\twrite(queryedge(root[mp[tmp]],u,v));\n\t\t\t\t\tputchar('\\n');\n\t\t\t\t}\n\t\t\t}\n\t\t}else{\n\t\t\tstring lrh;\n\t\t\tcin>>lrh;\n\t\t\tint u,v;\n\t\t\tu=read();\n\t\t\tv=read();\n\t\t\tstring qaq;\n\t\t\tcin>>qaq;\n\t\t\tstring tmp=\"\";\n\t\t\tbool flags=0;\n\t\t\tfor(int i=0;i<qaq.size();i++)\n\t\t\t{\n\t\t\t\tif(qaq[i]=='.')\n\t\t\t\t{\n\t\t\t\t\tflags=1;\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tif(flags) tmp+=qaq[i];\n\t\t\t}\n\t\t\tif(mp[tmp]==0) puts(\"0\");\n\t\t\telse{\n\t\t\t\twrite(deledge(root[mp[tmp]],u,v));\n\t\t\t\tputchar('\\n');\n\t\t\t}\n\t\t}\n\t}\n\treturn 0;\n}\n\n```",
        "postTime": 1682735224,
        "uid": 358739,
        "name": "BFSDFS123",
        "ccfLevel": 0,
        "title": "P4947 PION\u540e\u7f00\u81ea\u52a8\u673a \u9898\u89e3"
    }
]