[
    {
        "content": "## \u9898\u610f\r\n\r\n\u7ed9\u5b9a $A_{1, \\dots, n}, B_{1 \\dots n}$,\r\n\u4ee5\u53ca $m$ \u4e2a\u63d0\u95ee, \u6bcf\u6b21\u63d0\u95ee\u7ed9\u51fa $l, r$, \u6c42\r\n\r\n$$\r\n\\sum_{p = l}^r \\sum_{q = p}^r \\bigl(\\max\\nolimits_{i=p}^q A_i\\bigr)\\bigl(\\max\\nolimits_{i=p}^q B_i\\bigr).\r\n$$\r\n\r\n## \u9898\u89e3\r\n\r\n\u6211\u4eec\u79bb\u7ebf\u6240\u6709\u8be2\u95ee, \u5bf9\u53f3\u7aef\u70b9 $r$ \u8fdb\u884c\u626b\u63cf\u7ebf.\r\n\r\n\u5728\u626b\u63cf\u8fc7\u7a0b\u4e2d, \u6211\u4eec\u8bbe $X_l$ \u548c $Y_l$ \u5206\u522b\u8868\u793a\r\n$l, \\dots, r$ \u8303\u56f4\u5185 $A_i$ \u548c $B_i$ \u7684\u6700\u5927\u503c.\r\n\r\n\u4e8b\u5b9e\u4e0a\u5e94\u8be5\u662f $X_{l, r}$ \u548c $Y_{l, r}$. \u6211\u4eec\u53ea\u662f\u7b80\u8bb0.\r\n\r\n\u5728\u626b\u63cf\u53f3\u7aef\u70b9\u7684\u540c\u65f6, \u6211\u4eec\u7ef4\u62a4 $A, B$ \u7684\u5355\u8c03\u6808.\r\n\u8fd9\u6837\u5982\u679c\u626b\u63cf\u5230 $i$, \u8f6e\u5230 $i$ \u5165\u6808\u65f6, \u8bbe\u4e24\u4e2a\u6808\u9876\u5206\u522b\u662f $u, v$,\r\n\u90a3\u4e48 $u+1, \\dots, i$ \u533a\u95f4\u7684 $X$ \u4f1a\u533a\u95f4\u4fee\u6539\u4e3a $A_i$,\r\n$v+1, \\dots, i$ \u533a\u95f4\u7684 $Y$ \u4f1a\u533a\u95f4\u4fee\u6539\u4e3a $B_i$.\r\n\r\n\u5982\u679c\u6211\u4eec\u8981\u67e5\u8be2\u7684 $l, r$ \u7684\u7b54\u6848, \u90a3\u4e48\u76f8\u5f53\u4e8e\u5728\u626b\u63cf\u5230 $r$ \u7684\u65f6\u5019,\r\n\u67e5\u8be2 $l, \\dots, r$ \u533a\u95f4\u7684 _\u5386\u53f2 $X \\times Y$ \u548c_.\r\n\r\n\u8fd9\u4e48\u8bf4\u53ef\u80fd\u6709\u70b9\u5947\u602a, \u4e0d\u592a\u597d\u8c08.\r\n\r\n\u6211\u4eec\u53ef\u4ee5\u5728\u626b\u63cf\u7684\u65f6\u5019, \u5bf9\u6bcf\u4e2a $l$, \u7ef4\u62a4\r\n\r\n$$S_{l, r} = \\sum_{r' = l}^r X_{l, r'} \\times Y_{l, r'}.$$\r\n\r\n\u8fd9\u6837\u7684\u8bdd, \u6211\u4eec\u8981\u67e5\u8be2\u7684\u5c31\u662f $l, \\dots, r$ \u7684\u533a\u95f4 $S$ \u548c.\r\n\r\n\u800c\u6211\u4eec\u7684\u64cd\u4f5c\u5219\u662f\u533a\u95f4 $X$ \u4fee\u6539 (\u8986\u76d6), \u533a\u95f4 $Y$ \u4fee\u6539 (\u8986\u76d6),\r\n\u4ee5\u53ca**\u533a\u95f4 $S \\mathrel{+}= X \\times Y$**.\r\n\r\n\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4. \u590d\u6742\u5ea6 $O(n \\log n)$.\r\n\r\n### \u7ec6\u8282\r\n\r\n\u6211\u4eec\u53d1\u73b0 tag \u662f\u82e5\u5e72\u533a\u95f4 $X$ \u4fee\u6539 (\u8986\u76d6), \u533a\u95f4 $Y$ \u4fee\u6539 (\u8986\u76d6),\r\n\u4ee5\u53ca\u533a\u95f4 $S \\mathrel{+}= X \\times Y$ \u7684\u590d\u5408, \u53ef\u4ee5\u7ef4\u62a4\u4e3a\r\n$\\mathrm{Tag}(s_X, s_Y, a_X, a_Y, a_{XY}, a)$, \u8868\u793a\r\n\r\n$$\\begin{aligned}\r\nS' &= S + a_XX + a_YY+a_{XY}X \\times Y+a \\\\\r\nX' &= \\begin{cases} X & sX = 0 \\\\ sX & sX \\neq 0\\end{cases} \\\\\r\nY' &= \\begin{cases} Y & sY = 0 \\\\ sY & sY \\neq 0\\end{cases}\r\n\\end{aligned}$$\r\n\r\n\u4e5f\u5c31\u662f\u8bf4 $s_X, s_Y$ \u8868\u793a $X, Y$ \u7684\u533a\u95f4\u8986\u76d6, \u800c $a_X, a_Y, a_{XY}, a$ \u5206\u522b\u8868\u793a $S$ \u52a0\u4e0a\u5bf9\u5e94\u500d\u7684 $X, Y, X \\times Y, 1$.\r\n\r\n\u6211\u4eec\u8981\u7ef4\u62a4\u533a\u95f4 $S$ \u548c, \u7ed3\u5408\u4e0a\u9762\u7684 $\\mathrm{Tag}$ \u5c31\u77e5\u9053\u6211\u4eec\u8fd8\u8981\u540c\u65f6\u7ef4\u62a4\u533a\u95f4 $X$ \u548c, \u533a\u95f4 $Y$ \u548c\u4ee5\u53ca\u533a\u95f4 $X \\times Y$ \u548c.\r\n\r\n\u5269\u4e0b\u7684\u5177\u4f53\u770b\u4ee3\u7801.\r\n\r\n## \u4ee3\u7801\r\n\r\n```cpp\r\n#include <algorithm>\r\n#include <cctype>\r\n#include <cstdio>\r\n#include <cstring>\r\n\r\nint read() {\r\n  int ans = 0, c;\r\n  while (!isdigit(c = getchar()));\r\n  do ans = ans * 10 + c - '0';\r\n  while (isdigit(c = getchar()));\r\n  return ans;\r\n}\r\n\r\ntypedef unsigned long long ULL;\r\n\r\nstruct Msg {\r\n  ULL sumX, sumY, sumXY, sumS;\r\n  Msg() : sumX(0), sumY(0), sumXY(0), sumS(0) {}\r\n  Msg(ULL sx, ULL sy, ULL sxy, ULL sb) : sumX(sx), sumY(sy), sumXY(sxy), sumS(sb) {}\r\n  inline Msg operator+(const Msg &t) const {\r\n    return Msg(sumX + t.sumX, sumY + t.sumY, sumXY + t.sumXY, sumS + t.sumS);\r\n  }\r\n};\r\n\r\nstruct Tag {\r\n  // first add, then set\r\n  ULL addX, addY, addXY, addC; // S += addX * X + addY * Y + addXY * XY + addC\r\n  ULL setX, setY; // = 0: not set\r\n  Tag() : addX(0), addY(0), addXY(0), addC(0), setX(0), setY(0) {}\r\n  Tag(ULL ax, ULL ay, ULL axy, ULL ac, ULL sx, ULL sy)\r\n    : addX(ax), addY(ay), addXY(axy), addC(ac), setX(sx), setY(sy) {}\r\n\r\n  operator bool() const { return addX || addY || addXY || addC || setX || setY; } // check if tag is non trivial\r\n\r\n  // tag1 * tag2: first apply tag2, then apply tag1\r\n  inline Tag operator*(const Tag &t) const {\r\n    ULL ax = t.addX, ay = t.addY, axy = t.addXY, ac = t.addC;\r\n    ULL sx = t.setX, sy = t.setY;\r\n\r\n    if (sx) {\r\n      ac += addX * sx;\r\n      if (sy) {\r\n        ac += addXY * sx * sy;\r\n      } else {\r\n        ay += addXY * sx;\r\n      }\r\n    } else {\r\n      ax += addX;\r\n      if (sy) {\r\n        ax += addXY * sy;\r\n      } else {\r\n        axy += addXY;\r\n      }\r\n    }\r\n\r\n    if (sy) {\r\n      ac += addY * sy;\r\n    } else {\r\n      ay += addY;\r\n    }\r\n\r\n    ac += addC;\r\n\r\n    if (setX) sx = setX;\r\n    if (setY) sy = setY;\r\n\r\n    return Tag(ax, ay, axy, ac, sx, sy);\r\n  }\r\n\r\n  inline Msg apply(const Msg &m, ULL len) const { // len: length of range\r\n    return Msg(/* sumX  */ setX ? setX * len : m.sumX,\r\n               /* sumY  */ setY ? setY * len : m.sumY,\r\n               /* sumXY */ setX ? (setY ? setX * setY * len : setX * m.sumY) : (setY ? m.sumX * setY : m.sumXY),\r\n               /* sumS  */ m.sumS + addX * m.sumX + addY * m.sumY + addXY * m.sumXY + addC * len);\r\n  }\r\n};\r\n\r\nconst int N = 250050;\r\nconst int NN = 550000;\r\n\r\nTag tag[NN];\r\nMsg msg[NN];\r\n\r\ninline void upd(int o, int l, int r) {\r\n  msg[o] = tag[o].apply(msg[o << 1] + msg[o << 1 | 1], r - l + 1);\r\n}\r\n\r\ninline void app(int o, int l, int r, const Tag &t) {\r\n  tag[o] = t * tag[o];\r\n  msg[o] = t.apply(msg[o], r - l + 1);\r\n}\r\n\r\ninline void pushd(int o, int l, int r) {\r\n  if (tag[o]) {\r\n    int m = (l + r) / 2;\r\n    app(o << 1, l, m, tag[o]);\r\n    app(o << 1 | 1, m + 1, r, tag[o]);\r\n    tag[o] = Tag();\r\n  }\r\n}\r\n\r\nvoid Modify(int o, int l, int r, int L, int R, const Tag &t) {\r\n  if (L <= l && r <= R) {\r\n    app(o, l, r, t);\r\n    return;\r\n  }\r\n  pushd(o, l, r);\r\n  int m = (l + r) / 2;\r\n  if (L <= m) Modify(o << 1, l, m, L, R, t);\r\n  if (R > m) Modify(o << 1 | 1, m + 1, r, L, R, t);\r\n  upd(o, l, r);\r\n}\r\n\r\nULL QueryS(int o, int l, int r, int L, int R) {\r\n  if (L <= l && r <= R) return msg[o].sumS;\r\n  pushd(o, l, r);\r\n  int m = (l + r) / 2;\r\n  ULL ans = 0;\r\n  if (L <= m) ans += QueryS(o << 1, l, m, L, R);\r\n  if (R > m) ans += QueryS(o << 1 | 1, m + 1, r, L, R);\r\n  return ans;\r\n}\r\n\r\nstruct Qry {\r\n  int l, r, id;\r\n  bool operator <(const Qry &t) const {\r\n    return r < t.r;\r\n  }\r\n} Q[N];\r\n\r\nint n, m, A[N], B[N];\r\nint sA[N], sB[N];\r\nULL ans[N];\r\n\r\nint main() {\r\n  read();\r\n  n = read();\r\n  for (int i = 1; i <= n; ++i) A[i] = read();\r\n  for (int i = 1; i <= n; ++i) B[i] = read();\r\n  // Init(1, 1, n);\r\n  m = read();\r\n  for (int i = 0; i < m; ++i) {\r\n    Q[i].l = read();\r\n    Q[i].r = read();\r\n    Q[i].id = i;\r\n  }\r\n  std::sort(Q, Q + m);\r\n  int lA = 0, lB = 0;\r\n  for (int i = 1, j = 0; i <= n; ++i) {\r\n    while (lA && A[sA[lA]] < A[i]) --lA;\r\n    while (lB && B[sB[lB]] < B[i]) --lB;\r\n    Modify(1, 1, n, sA[lA] + 1, i, Tag(0, 0, 0, 0, A[i], 0)); // set X\r\n    Modify(1, 1, n, sB[lB] + 1, i, Tag(0, 0, 0, 0, 0, B[i])); // set Y\r\n    Modify(1, 1, n, 1, i, Tag(0, 0, 1, 0, 0, 0)); // S += X * Y\r\n    sA[++lA] = sB[++lB] = i;\r\n    for (; j < m && Q[j].r == i; ++j)\r\n      ans[Q[j].id] = QueryS(1, 1, n, Q[j].l, i);\r\n  }\r\n  for (int i = 0; i < m; ++i)\r\n    printf(\"%llu\\n\", ans[i]);\r\n}\r\n```",
        "postTime": 1669477331,
        "uid": 7868,
        "name": "_rqy",
        "ccfLevel": 10,
        "title": "NOIP T4 \u9898\u89e3"
    },
    {
        "content": "**sol of P8868**\n\n\u6055\u6211\u76f4\u8a00\uff0c\u6b64\u9898\u7684\u96be\u70b9\u5728\u4e8e\u6784\u9020\u53cc\u534a\u7fa4\u6a21\u578b\uff0c\u5982\u679c\u53ea\u662f\u8bb2\u89e3\u7ef4\u62a4\u7684\u4fe1\u606f\uff0c\u90a3\u4e48\u53ef\u4ee5\u770b\u61c2\u6b64\u9898\uff0c\u4f46\u662f\u82e5\u5728\u4e4b\u540e\u78b0\u5230\u7c7b\u4f3c\u7684\u9898\u76ee\u5374\u8fd8\u662f\u53ea\u80fd\u778e\u6784\u9020\u534a\u5929\u5bfc\u81f4\u6d6a\u8d39\u5927\u91cf\u65f6\u95f4\uff0c\u5bfc\u81f4\u75db\u5931\u5176\u4ed6\u9898\u7684\u5206\u3002\n\n\u672c\u7bc7\u9898\u89e3\u60f3\u5927\u81f4\u63a2\u7d22\u4e00\u4e0b\u5e7a\u534a\u7fa4\u4fe1\u606f\u6784\u9020\u7684\u65b9\u6cd5\uff0c\u4f46\u5e76\u4e0d\u662f\u6781\u5176\u4e25\u8c28\u4e0e~~\u79d1\u5b66~~\uff0c\u4f60\u53ef\u4ee5\u7406\u89e3\u6210\u6c11\u79d1\u5427\uff01\u4e3b\u8981\u662f\u5e02\u9762\u4e0a\u6ca1\u6709\u5565\u8bb2\u4fe1\u606f\u6784\u9020\u7684\uff0c\u5982\u679c\u4f60\u505a\u9898\u4e0d\u591a\u5176\u5b9e\u5f88\u5bb9\u6613\u88ab\u5751\u3002\n\n------------------------------------------------------\n\n\u4e00\u4e9b\u6781\u5176\u4e00\u773c\u7684\u601d\u8003\uff1a\u626b\u63cf\u7ebf\uff0c\u7136\u540e\u8f6c\u5316\u6210\u5e26\u5386\u53f2\u548c\u7684 $X_{i} \\times Y_{i}$\uff0c\u4fee\u6539\u64cd\u4f5c\u662f\u4e8c\u5143\u4fe1\u606f\u533a\u95f4\u8986\u76d6\uff0c\u4fe1\u606f\u662f\u6c42\u548c\uff0c\u76f2\u731c\u53ef\u505a\uff0c\u4e8e\u662f\u96be\u70b9\u6765\u5230\u5982\u4f55\u8bbe\u8ba1\u53cc\u534a\u7fa4\u6a21\u578b\uff0c\u6784\u9020\u4fe1\u606f\u3002\n\n------------------------------------------\n\n\u4ece\u81ea\u5df1\u535a\u5ba2\u91cc\u642c\u70b9\u4e1c\u897f\u8fc7\u6765\u3002\n\n**\u534a\u7fa4**\n\n\u7ed9\u5b9a\u4e00\u4e2a\u96c6\u5408 $D$ \u4ee5\u53ca\u4e00\u4e2a\u96c6\u5408 $D$ \u4e0a\u7684\u4e8c\u5143\u8fd0\u7b97 $\\times$ \u6ee1\u8db3 $D \\times D \\rightarrow D$\u3002\n\n\u5bf9\u4e8e\u8be5\u8fd0\u7b97\u6ee1\u8db3\u7ed3\u5408\u5f8b\uff1a$a,b,c \\in D,(a \\times b)\\times c = a \\times (b \\times c)$\u3002\n\n**\u5e7a\u534a\u7fa4**\n\n\u7ed9\u5b9a\u4e00\u4e2a\u96c6\u5408 $D$ \u4ee5\u53ca\u4e00\u4e2a\u96c6\u5408 $D$ \u4e0a\u7684\u4e8c\u5143\u8fd0\u7b97 $\\times$ \u6ee1\u8db3 $D \\times D \\rightarrow D$\u3002\n\n\u5bf9\u4e8e\u8be5\u8fd0\u7b97\u6ee1\u8db3\u7ed3\u5408\u5f8b\uff1a$a,b,c \\in D,(a \\times b)\\times c = a \\times (b \\times c)$\u3002\n\n\u6ee1\u8db3\u5e7a\u5143\u5b58\u5728\u4f7f\u5f97\uff1a$a,\\epsilon \\in D,a \\times \\epsilon = \\epsilon \\times a = a$\u3002\n\n**\u4ea4\u6362\u534a\u7fa4**\n\n\u7ed9\u5b9a\u4e00\u4e2a\u96c6\u5408 $D$ \u4ee5\u53ca\u4e00\u4e2a\u96c6\u5408 $D$ \u4e0a\u7684\u4e8c\u5143\u8fd0\u7b97 $\\times$ \u6ee1\u8db3 $D \\times D \\rightarrow D$\u3002\n\n\u5bf9\u4e8e\u8be5\u8fd0\u7b97\u6ee1\u8db3\u7ed3\u5408\u5f8b\uff1a$a,b,c \\in D,(a \\times b)\\times c = a \\times (b \\times c)$\u3002\n\n\u5bf9\u4e8e\u8be5\u8fd0\u7b97\u6ee1\u8db3\u4ea4\u6362\u5f8b\uff1a$a,b,c \\in D,a \\times b = b \\times a$\u3002\n\n**\u8303\u56f4**\n\n\u5e38\u89c1\u7684\u8303\u56f4\u6709\u5e8f\u5217\u533a\u95f4\uff0c\u6811\u7b80\u5355\u8def\u5f84\uff0c\u4e8c\u7ef4\u5e73\u9762\u77e9\u5f62\uff0c\u9ad8\u7ef4\u6b63\u4ea4\u8303\u56f4\uff0c\u534a\u5e73\u9762\u8303\u56f4\uff0c\u5706\u8303\u56f4\u3002\n\n\u6211\u4eec\u4e00\u822c\u7406\u89e3\u6210\u5bf9\u4e8e\u8fdb\u884c\u4fee\u6539\u548c\u67e5\u8be2\u7684\u4fe1\u606f\u7684\u9650\u5236\u3002\n\n**\u53cc\u534a\u7fa4\u6a21\u578b**\n\n\u76f4\u63a5~~\u518d\u6b21~~\u8d3a\u4e00\u4e0b lxl PPT \u91cc\u7684\u56fe\u3002\n\n![zcrGPP.png](https://s1.ax1x.com/2022/12/07/zcrGPP.png)\n\n\u8fd8\u9700\u8981\u6ce8\u610f\u7684\u662f\u5bf9\u4e8e $D \\times M \\rightarrow D$ \u7684 $\\times$ \u8fd0\u7b97\u5bf9\u4e8e $(D,+)$ \u8fd0\u7b97\u5177\u6709\u5206\u914d\u5f8b\u3002\n\n\u6211\u4eec\u79f0\u8fd9\u6837\u7684\u6a21\u578b\u4e3a\u53cc\u534a\u7fa4\u6a21\u578b\u3002\n\n\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u91c7\u53d6\u7ebf\u6bb5\u6811\uff0c\u7ef4\u62a4\u7684\u4fe1\u606f\u81f3\u5c11\u662f\u534a\u7fa4\u4fe1\u606f\uff0c\u7136\u800c\u5927\u591a\u6570\u65f6\u5019\u4e5f\u662f\u4ea4\u6362\u534a\u7fa4\u4fe1\u606f\u3002\n\n\u90a3\u4e48\u6211\u4eec\u9700\u8981\u505a\u5230\u7684\u662f\u8bbe\u8ba1 $D,M$ \u53bb\u6ee1\u8db3\u4e0a\u8ff0\u7684\u53cc\u534a\u7fa4\u6a21\u578b\uff0c\u5728\u5927\u591a\u6570\u65f6\u5019\u6211\u4eec\u91c7\u53d6\u7684\u4e0b\u4f20\u6807\u8bb0\u4fe1\u606f\u90fd\u662f\u7ef4\u62a4 $D$ \u7684\u589e\u91cf\uff0c\u6839\u636e\u9898\u610f\u4e5f\u5e94\u5f53\u9002\u5f53\u6dfb\u52a0\u5176\u5b83\u4e0b\u4f20\u6807\u8bb0\u4fe1\u606f\u50cf\u533a\u95f4\u8986\u76d6\u533a\u95f4\u4e58\u6cd5\u7b49\u7b49\uff0c\u6b64\u9898\u5c31\u662f\u533a\u95f4\u8986\u76d6\u3002\n\n\u6211\u4eec\u6839\u636e\u4e00\u4e9b\u8868\u8c61\u7684\u4fe1\u606f\uff0c\u6bd4\u5982\u8fd9\u91cc\u6709\u533a\u95f4\u8986\u76d6\uff0c\u90a3\u6211\u4eec\u77e5\u9053\u6211\u4eec\u7684\u4e0b\u4f20\u6807\u8bb0\u4fe1\u606f\u81f3\u5c11\u6709\u4e00\u4e2a $c_x,c_y$ \u8868\u793a\u5bf9\u4e8e\u533a\u95f4 $x$ \u5143\u548c $y$ \u5143\u7684\u8986\u76d6\u3002\n\n\u5176\u6b21\u5c1d\u8bd5\u6784\u9020 $D$\u3002\u6211\u4eec\u5148\u6765\u5c1d\u8bd5\u4e00\u4e9b\u533a\u95f4\u8986\u76d6\u7684\u5f71\u54cd\uff0c\u5047\u8bbe\u4e00\u76f4\u4fee\u6539 $x$ \u90a3\u4e48\u8c8c\u4f3c\u6211\u4eec\u53ef\u4ee5\u52a0 $\\sum y$ \u8fd9\u6837\u7684\u4e1c\u897f\u3002\u5f53\u7136\u5982\u679c\u4f60\u8981\u5957\u8def\u5316\uff0c\u5728\u89c2\u5bdf\u5230 $X_i \\times Y_i$ \u8fd9\u6837\u7684\u7ed3\u6784\u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u4ee5\u6b64\u4e3a\u6700\u9ad8\u6b21\uff0c\u6784\u9020\u4e00\u4e2a\u591a\u9879\u5f0f\u5f62\u5f0f\u7684 $D$ \u7c7b\u4fe1\u606f\uff0c\u5373\u7ef4\u62a4\u626b\u63cf\u7ebf\u65f6\u5f53\u524d\u7684 $\\sum X_i \\times Y_i,\\sum X_i,\\sum Y_i$ \u4ee5\u53ca $s$ \u8868\u793a\u533a\u95f4\u5386\u53f2\u548c $len$ \u8868\u793a\u533a\u95f4\u957f\uff0c\u5f62\u5f0f\u5316\u5730\u8bb0\u4e3a $D = (s_{xy},s_x,s_y,s,len)$\u3002\n\n\u5bf9\u4e8e\u4e0b\u4f20\u6807\u8bb0\u7684\u4fe1\u606f\uff0c\u901a\u8fc7\u5c1d\u8bd5\u4fee\u6539\u5e26\u6765\u7684\u5f71\u54cd\uff0c\u6216\u8005\u653e\u5f03\u601d\u8003\uff0c\u5957\u8def\u5316\u5730\u8bbe\u6210 $M = (c_x,c_y,m_{xy},m_x,m_y,m)$\uff0c\u8868\u793a\u533a\u95f4\u8986\u76d6 $x/y$\uff0c**\u5728\u8be5\u5408\u5e76\u4fe1\u606f $M$ \u4e2d\u7684\u8986\u76d6\u6807\u8bb0\u672a\u4e0b\u4f20\u524d\uff0c\u5bf9\u4e8e\u5b50\u6811\u5185 $D$ \u4e2d $s$ \u7684\u8d21\u732e\u9700\u8981\u52a0\u4e0a $m_{xy} \\times D_{s_{xy}} + m_x \\times D_{s_{x}} + m_y \\times D_{s_y} + m \\times D_{len}$**\u3002\n\n\u5b9a\u4e49\u4e0b\u4f20\u6807\u8bb0\u4fe1\u606f\u4e2d\u5bf9\u4e8e\u8d21\u732e\u52a0\u6cd5\u7684\u4f18\u5148\u7ea7\u9ad8\u4e8e\u8986\u76d6\u6807\u8bb0\u662f\u6709\u7406\u7531\u7684\uff0c\u6bd4\u5982\u8bf4\u7eaf\u533a\u95f4\u8986\u76d6\uff0c\u533a\u95f4\u52a0\uff0c\u533a\u95f4\u6c42\u548c\uff0c\u4e00\u79cd\u5b9e\u73b0\u65b9\u6cd5\u5c31\u662f\u4e0b\u4f20\u4fe1\u606f\u65f6\u5148\u8ba9\u52a0\u6807\u8bb0\u4e0b\u4f20\uff0c\u7136\u540e\u518d\u4e0b\u4f20\u533a\u95f4\u8986\u76d6\u6807\u8bb0\uff0c\u56e0\u4e3a\u52a0\u6807\u8bb0\u7684\u4fe1\u606f\u4f9d\u8d56\u4e8e\u672a\u88ab\u8986\u76d6\u4e4b\u524d\u7684\u533a\u95f4\u4fe1\u606f\uff0c\u4f60\u8ba9\u8986\u76d6\u6807\u8bb0\u4f18\u5148\u4e8e\u52a0\u6cd5\u6807\u8bb0\u4e0b\u4f20\u5c31\u4f1a\u8ba9\u52a0\u6807\u8bb0\u65e0\u6240\u4f9d\u8d56\uff0c\u96be\u4ee5\u7ef4\u62a4\u3002\n\n\u5728\u5927\u591a\u6570\u65f6\u5019\uff0c\u4f60\u8981\u76f8\u4fe1\u4f60\u901a\u8fc7\u5e38\u89c4\u7684\u6807\u8bb0\u8bbe\u8ba1\u51fa\u6765\u7684 $D,M$ \u662f\u6ee1\u8db3 $D$ \u662f\u4ea4\u6362\u534a\u7fa4\u548c\u534a\u7fa4\u4fe1\u606f\u7684\uff0c\u4ee5\u9632\u4e07\u4e00\u4f60\u53ef\u4ee5\u9a8c\u8bc1\u4e00\u4e0b\u3002\n\n\u6240\u4ee5\u53ea\u9700\u8981\u6784\u9020\u51fa\u6765\u4e09\u7c7b\u5173\u7cfb\uff0c$D \\times M \\rightarrow D,D + D \\rightarrow D,M \\text * M \\rightarrow M$ \u7684\u5177\u4f53\u64cd\u4f5c\u5c31\u597d\u4e86\u3002\n\n\u6784\u9020\u96be\u5ea6\u57fa\u672c\u548c $D,M$ \u7684\u7ef4\u62a4\u6807\u8bb0\u4e2a\u6570\u6b63\u76f8\u5173\u3002\u6b64\u9898\u4f60\u53d1\u73b0 $D + D \\rightarrow D$ \u5c31\u662f\u6700\u7b80\u5355\u7684\uff01\u5199\u6210\u4ee3\u7801\u5c31\u662f\uff1a\n\n```cpp\ninline info merge(info x,info y){return info(x.s + y.s , x.sx + y.sx , x.sy + y.sy , x.sxy + y.sxy);}\t\n```\n\u5176\u6b21\u6211\u4eec\u6784\u9020 $D \\times M \\rightarrow D$\uff0c\u76f4\u63a5\u653e\u4ee3\u7801\u7136\u540e\u89e3\u91ca\uff1a\n```cpp\ninline info merge(info x,tag y,int len)\n{\n\tx.s += y.axy * x.sxy + y.ax * x.sx + y.ay * x.sy + y.c * len;\n\tif(y.cx && y.cy)\n\t{\n\t\tx.sxy = len * y.cx * y.cy;\n\t\tx.sx = len * y.cx;\n\t\tx.sy = len * y.cy;\n\t}\n\telse if(y.cx)\n\t{\n\t\tx.sxy = x.sy * y.cx;\n\t\tx.sx = len * y.cx;\n\t}\n\telse if(y.cy)\n\t{\n\t\tx.sxy = x.sx * y.cy;\n\t\tx.sy = len * y.cy;\n\t}\n\treturn x;\n}\n```\n\u5373\u5bf9\u4e8e $s$ \u6211\u4eec\u6839\u636e\u5b9a\u4e49\u5148\u76f4\u63a5\u66f4\u65b0\u4e00\u904d\uff1b\u7136\u540e\u518d\u6839\u636e\u662f\u5426\u6709\u8986\u76d6\u6807\u8bb0\u4fee\u6539 $s_{xy},s_x,s_y$\uff0c\u8fd9\u4e2a\u6bd4\u8f83\u7b80\u5355\u5c31\u4e0d\u591a\u8bf4\u4e86\u3002\n\n\u6700\u540e\u6211\u4eec\u6784\u9020 $M \\text{*} M \\rightarrow M$\u3002\n\n\u8fd8\u662f\u8d34\u4ee3\u7801\u89e3\u91ca\uff1a\n\n```cpp\ninline tag merge(tag x,tag y)//x -> y\n{ \n\tif(y.cx && y.cy) y.c += x.axy * y.cx * y.cy + x.ax * y.cx + x.ay * y.cy + x.c;\n\telse if(y.cx) \n\t{\n\t\ty.ay += x.axy * y.cx + x.ay;\n\t\ty.c += x.c + x.ax * y.cx;\n\t}\n\telse if(y.cy)\n\t{\n\t\ty.ax += x.axy * y.cy + x.ax;\n\t\ty.c += x.c + x.ay * y.cy;\n\t}\n\telse \n\t{\n\t\ty.axy += x.axy;\n\t\ty.ax += x.ax;\n\t\ty.ay += x.ay;\n\t\ty.c += x.c;\n\t}\n\tif(x.cx) y.cx = x.cx;\n\tif(x.cy) y.cy = x.cy;\n\treturn y;\n}\n```\n$M1 \\text{*} M2 \\rightarrow M$\uff0c\u8bbe $M1$ \u4f5c\u7528\u5728 $M2$ \u4e0a\uff0c\u8bbe\u533a\u95f4\u957f\u4e3a $len$\uff0c\u5206\u7c7b\u8ba8\u8bba\uff1a\n\n- \u82e5 $M2$ \u4e2d\u7684 $c_x,c_y$ \u90fd\u6709\u503c\uff0c\u6211\u4eec\u4e0d\u59a8\u8f6c\u5316\u4e3a\u5bf9\u4e8e\u6bcf\u4e2a\u4f4d\u7f6e\u589e\u91cf\u7684\u5f62\u5f0f($D_m$)\uff0c\u5219\u5f53\u524d\u7684\u72b6\u6001\u5c31\u662f\u533a\u95f4\u5185\u7684 $X_i,Y_i$ \u90fd\u76f8\u540c\uff0c\u8003\u8651\u8d21\u732e\u662f ${M1}_{m_{xy}} \\times \\sum X_i \\times Y_i$\uff0c\u7531\u4e8e $X_i,Y_i$ \u90fd\u76f8\u7b49\uff0c\u53d8\u6210 ${M1}_{m_{xy}} \\times {M2}_{c_x} \\times M2_{c_y} \\times len$\uff0c\u5219\u589e\u91cf\u662f ${M1}_{m_{xy}} \\times {M2}_{c_x} \\times M2_{c_y}$\u3002\u7c7b\u4f3c\u5730\u6211\u4eec\u5199\u51fa\u6765\u5176\u5b83\u4e09\u4e2a\u589e\u91cf\u5373\u53ef\u3002\n\n- \u82e5\u4ec5 $M2$ \u4e2d\u7684 $c_x$ \u6709\u503c\uff0c\u5bf9\u4e8e ${M1}_{m_{xy}} \\times \\sum X_i \\times Y_i$ \u6211\u4eec\u5199\u6210 ${M1}_{m_{xy}} \\times M2_{c_x} \\times \\sum  Y_i$\uff0c\u53d1\u73b0\u5bf9\u4e8e $\\sum Y_i$ \u5c31\u53c8\u53ef\u4ee5\u8fed\u4ee3\u4e0b\u53bb\uff0c\u5c06 ${M1}_{m_{xy}} \\times M2_{c_x}$ \u52a0\u5230 $M2_{m_y}$ \u4e0a\u9762\u53bb\u5373\u53ef\uff1b\u800c\u5bf9\u4e8e $M1_{m_x} \\times \\sum X_i$ \u6211\u4eec\u5199\u6210 $M1_{m_x} \\times M2_{c_x} \\times len$ \u7684\u5f62\u5f0f\uff0c\u5373\u5c06 $M1_{m_x} \\times M2_{c_x}$ \u52a0\u5230 $M2_{m_c}$ \u4e0a\u9762\u53bb\uff1b\u7136\u540e $M2_{m_y} \\leftarrow M2_{m_y} + M1_{m_y},M2_{m_c} \\leftarrow M2_{m_c} + M1_{m_c}$\u3002\n\n- \u82e5\u4ec5 $M2$ \u4e2d\u7684 $c_y$ \u6709\u503c\u7c7b\u4f3c\u4e0a\u8ff0\u60c5\u51b5\uff1b\n\n- \u82e5 $M2$ \u4e2d\u7684 $c_x,c_y$ \u90fd\u65e0\u503c\uff0c\u5c31\u76f4\u63a5\u5bf9\u5e94\u9879\u76f8\u52a0\u5373\u53ef\u3002\n\n\u5728 $M1 \\text{*} M2 \\rightarrow M$ \u6784\u9020\u65f6\uff0c\u4e2a\u4eba\u8ba4\u4e3a\u6700\u91cd\u8981\u7684\u4e00\u70b9\u662f\uff0c\u6839\u636e\u5206\u8ba8\u7684\u60c5\u51b5\u6211\u4eec\u8981\u8f6c\u5316\u5f0f\u5b50\uff0c\u7136\u540e**\u5c06\u5df2\u7ecf\u786e\u5b9a\u7684\u5e38\u6570\u9879\u6839\u636e\u4e0b\u4f20\u6807\u8bb0\u7684\u5b9a\u4e49\u5206\u914d\u5230\u66f4\u4f4e\u6b21\u5e42\u7684\u589e\u91cf\u4e0a**\u3002\n\n\u4e00\u4e2a\u5361\u5e38\u7684\u529e\u6cd5\u662f\u4e00\u6b21\u5355\u8c03\u6808\u5f39\u6808\u8fc7\u7a0b\u8fdb\u884c\u5230\u5e95\uff0c\u4e0d\u8981\u5f39\u4e00\u6b21\u533a\u95f4\u4fee\u6539\u4e00\u6b21\uff1b\u5c06 $D,M$ \u5355\u72ec\u5b9a\u4e49\u6210\u7ed3\u6784\u4f53\u4f1a\u65b9\u4fbf\u8c03\u8bd5\u4e00\u4e9b\u3002\n\n\u5f53\u7136\u5982\u679c\u4f60\u795e\u901a\u5e7f\u5927\uff0c\u76f4\u63a5\u5199\u6210\u77e9\u4e58\u7136\u540e\u62c6\u62c6\u62c6\u4e5f\u662f\u53ef\u4ee5\u7684\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O((n + q) \\log n)$\u3002\n\n\u5355\u6839\u505a\u6cd5\u76f8\u5bf9\u6709\u70b9\u5e73\u51e1\uff0c\u800c\u4e14\u5f88\u5bb9\u6613\u88ab\u5361\u5e38\u5c31\u6ca1\u6709\u8bb2\u7684\u5fc5\u8981\u4e86\uff1f\n\n```cpp\n#include \"bits/stdc++.h\"\nusing namespace std;\nconst int Len = 2.5e5 + 5;\n#define ull unsigned long long\null n,q;\ninline ull read() {\n    char ch = getchar();\n    ull x = 0, f = 1;\n    while (ch < '0' || ch > '9') ch = getchar();\n    while ('0' <= ch && ch <= '9') {\n        x = x * 10 + ch - '0';\n        ch = getchar();\n    }\n    return x * f;\n}\nvoid write(ull x) {\n    if (x > 9)\n        write(x / 10);\n    putchar(x % 10 + '0');\n}\nstruct info\n{\n\tull s,sx,sy,sxy;\n\tinfo(){s = sx = sy = sxy = 0;}\n\tinfo(ull S,ull SX,ull SY,ull SXY){s = S , sx = SX , sy = SY , sxy = SXY;}\n\tinline void clr(){s = sx = sy = sxy = 0;}\n\tinline void output(){printf(\"%llu %llu %llu %llu\\n\",s,sx,sy,sxy);}\n}inf[Len << 2];\nstruct tag\n{\n\tull cx,cy,ax,ay,axy,c;\n\ttag(){cx = cy = ax = ay = axy = c = 0;}\n\ttag(ull CX,ull CY,ull AX,ull AY,ull AXY,ull C){cx = CX , cy = CY , ax = AX , ay = AY , axy = AXY , c = C;}\n\tinline void clr(){cx = cy = ax = ay = axy = c = 0;}\n\tinline bool empty(){return !(cx || cy || ax || ay || axy || c);}\n\tinline void output(){printf(\"%llu %llu %llu %llu %llu %llu\\n\",cx,cy,ax,ay,axy,c);}\n}tg[Len << 2];\n//\u9700\u8981\u5b9e\u73b0 O + T -> O,T + T -> T,O + O -> O\n//\u91cd\u70b9\u5728\u4e8e T + T -> T \n//\u82e5 c_x,c_y \u90fd\u5b58\u5728\uff0c\u5219\u5f53\u524d\u7684\u6807\u8bb0\u7ef4\u62a4\u7684\u662f cx,cy \u7684\u4fe1\u606f\uff0c\u53ea\u9700\u8981\u5c06\u4fe1\u606f\u53e0\u52a0\u5230 c \u4e0a\u5373\u53ef\n//\u82e5 c_x \u5b58\u5728\uff0c\u5219\u5f53\u524d ay,c \u4f1a\u88ab\u5f71\u54cd\uff0c \n//\u82e5 c_y \u5b58\u5728\uff0c\u5219\u5f53\u524d ax,c \u4f1a\u88ab\u5f71\u54cd\uff0c\n//\u82e5\u90fd\u4e0d\u5b58\u5728\uff0c\u542b\u4e49\u5c31\u662f\u66b4\u529b\u66f4\u65b0 \n//\u6bcf\u6b21\u7ed3\u675f\u540e\u4e0b\u4f20\u4e00\u4e2a axy = 1 \u7684 tag\n//emmmm\u3002\ninline info merge(info x,info y){return info(x.s + y.s , x.sx + y.sx , x.sy + y.sy , x.sxy + y.sxy);}\t\ninline tag merge(tag x,tag y)//x -> y\n{ \n\tif(y.cx && y.cy) y.c += x.axy * y.cx * y.cy + x.ax * y.cx + x.ay * y.cy + x.c;\n\telse if(y.cx) \n\t{\n\t\ty.ay += x.axy * y.cx + x.ay;\n\t\ty.c += x.c + x.ax * y.cx;\n\t}\n\telse if(y.cy)\n\t{\n\t\ty.ax += x.axy * y.cy + x.ax;\n\t\ty.c += x.c + x.ay * y.cy;\n\t}\n\telse \n\t{\n\t\ty.axy += x.axy;\n\t\ty.ax += x.ax;\n\t\ty.ay += x.ay;\n\t\ty.c += x.c;\n\t}\n\tif(x.cx) y.cx = x.cx;\n\tif(x.cy) y.cy = x.cy;\n\treturn y;\n}\ninline info merge(info x,tag y,int len)\n{\n\tx.s += y.axy * x.sxy + y.ax * x.sx + y.ay * x.sy + y.c * len;\n\tif(y.cx && y.cy)\n\t{\n\t\tx.sxy = len * y.cx * y.cy;\n\t\tx.sx = len * y.cx;\n\t\tx.sy = len * y.cy;\n\t}\n\telse if(y.cx)\n\t{\n\t\tx.sxy = x.sy * y.cx;\n\t\tx.sx = len * y.cx;\n\t}\n\telse if(y.cy)\n\t{\n\t\tx.sxy = x.sx * y.cy;\n\t\tx.sy = len * y.cy;\n\t}\n\treturn x;\n}\n#define ls(p) (p << 1)\n#define rs(p) (p << 1 | 1)\ninline void push_up(int p){inf[p] = merge(inf[ls(p)] , inf[rs(p)]);}\ninline void push_down(int p,int l,int r)\n{\n\tif(!tg[p].empty())\n\t{\n\t\tint mid = (l + r) >> 1;int l1 = (mid - l + 1) , l2 = (r - mid);\n\t\ttg[ls(p)] = merge(tg[p] , tg[ls(p)]) , tg[rs(p)] = merge(tg[p] , tg[rs(p)]);\n\t\tinf[ls(p)] = merge(inf[ls(p)] , tg[p] , l1) , inf[rs(p)] = merge(inf[rs(p)] , tg[p] , l2);\n\t\ttg[p].clr();\n\t\treturn;\n\t}\n}\nvoid update(int p,int l,int r,int nl,int nr,tag t)\n{\n\tif(nl <= l && nr >= r) \n\t{\n\t\ttg[p] = merge(t , tg[p]);\n\t\tinf[p] = merge(inf[p] , t , r - l + 1);\n\t\t//printf(\"#%d %d:\\n\",l,r);\n\t\t//tg[p].output();\n\t\t//inf[p].output();\n\t\treturn;\n\t}\n\tpush_down(p , l , r);\n\tint mid = (l + r) >> 1;\n\tif(nl <= mid) update(ls(p) , l , mid , nl , nr , t);\n\tif(nr > mid) update(rs(p) , mid + 1 , r , nl , nr , t);\n\tpush_up(p);\n}\null query(int p,int l,int r,int nl,int nr)\n{\n\tif(nl <= l && nr >= r) \n\t{\n\t\t/*if(l == 2 && r == 2)\n\t\t{\n\t\t\tprintf(\"?%d %d:\\n\",l,r);\n\t\t\ttg[p].output();\n\t\t\tinf[p].output();\n\t\t}*/\n\t\treturn inf[p].s;\n\t}\n\tpush_down(p , l , r);\n\tint mid = (l + r) >> 1;ull res = 0;\n\tif(nl <= mid) res += query(ls(p) , l , mid , nl , nr);\n\tif(nr > mid) res += query(rs(p) , mid + 1 , r , nl , nr);\n\treturn res;\n}\null a[Len],b[Len],stk[Len][2],top[2];\nstruct Node\n{\n\tull l,id;\n\tNode(){l = id = 0;}\n\tNode(ull L,ull ID){l = L , id = ID;}\n}Qs[Len];\nvector<Node> vec[Len];\null Pt[Len];ull sz[Len];\nsigned main()\n{\n\tfreopen(\"match.in\",\"r\",stdin);\n\tfreopen(\"match.out\",\"w\",stdout);\n\tint TP = read();\n\tn = read();\n\tfor(int i = 1 ; i <= n ; i ++) a[i] = read();\n\tfor(int i = 1 ; i <= n ; i ++) b[i] = read();\n\tq = read();\n\tfor(int i = 1 ; i <= q ; i ++)\n\t{\n\t\tQs[i].l = read() , Qs[i].id = read();\n\t\tsz[Qs[i].id] ++;\n\t}\n\tfor(int i = 1 ; i <= n ; i ++) vec[i].reserve(sz[i]);\n\tfor(int i = 1 ; i <= q ; i ++) vec[Qs[i].id].push_back(Node(Qs[i].l , i));\n\tfor(int i = 1 ; i <= n ; i ++)\n\t{\n\t\twhile(top[0] > 0 && a[stk[top[0]][0]] < a[i]) top[0] --;\n\t\tupdate(1 , 1 , n , stk[top[0]][0] + 1 , i , tag(a[i] , 0 , 0 , 0 , 0 , 0));\n\t\tstk[++ top[0]][0] = i;\n\t\twhile(top[1] > 0 && b[stk[top[1]][1]] < b[i]) top[1] --;\n\t\tupdate(1 , 1 , n , stk[top[1]][1] + 1 , i , tag(0 , b[i] , 0 , 0 , 0 , 0));\n\t\tstk[++ top[1]][1] = i;\n\t\tupdate(1 , 1 , n , 1 , i , tag(0 , 0 , 0 , 0 , 1 , 0));\n\t\tint Sz = (int)vec[i].size();for(int j = 0 ; j < Sz ; j ++) Pt[vec[i][j].id] = query(1 , 1 , n , vec[i][j].l , i);\t\n\t} \n\tfor(int i = 1 ; i <= q ; i ++) write(Pt[i]) , putchar('\\n');\n\treturn 0;\n}\n```",
        "postTime": 1672481800,
        "uid": 132533,
        "name": "Hakuoro",
        "ccfLevel": 0,
        "title": "\u65e2\u5df2\u8eab\u62ab\u82f1\u96c4\u4e4b\u540d\uff0c\u5c31\u5e94\u5177\u5907\u4e0d\u5bb9\u64bc\u52a8\u7684\u89c9\u609f"
    },
    {
        "content": "\n\u76f4\u63a5\u66b4\u529b\u505a\u662f $O(n^2q)$ \u7684\uff0c\u53ef\u4ee5\u62ff\u5230 $8$ \u5206\u7684\u9ad8\u5206\u3002\n\n\u8003\u8651\u79bb\u7ebf\u505a\uff0c\u5bf9\u6240\u6709\u8be2\u95ee\u6309\u7167 $r$ \u4ece\u5c0f\u5230\u5927\u4e00\u4e2a\u4e2a\u6765\u3002\u5047\u8bbe\u5f53\u524d\u8003\u8651\u5230 $r$\uff0c\u8bb0 $x_i=\\max\\limits_{j=i}^r a_j$\uff0c$y_i=\\max\\limits_{j=i}^r b_j$\uff0c$f_i=\\sum\\limits_{j=i}^rx_j y_j$\uff0c\u90a3\u4e48\u5bf9\u4e8e\u8be2\u95ee $(l,r)$\uff0c\u7b54\u6848\u5c31\u662f $\\sum\\limits_{i=l}^r f_i$\u3002\u8fd9\u6837\u65f6\u95f4\u590d\u6742\u5ea6\u53d8\u4e3a $O(n^2+nq)$\uff0c\u53ef\u4ee5\u62ff\u5230 $20$ \u5206\u7684\u9ad8\u5206\uff0c\u53c2\u8003\u4ee3\u7801\u5982\u4e0b\uff1a\n\n```c++\nstruct Node {\n    int l, id;\n};\nvector<Node> d[N];\nULL a[N], b[N];\nULL f[N], x[N], y[N];\nULL ans[N];\nint main() {\n    int n, q;\n    scanf(\"%*d%d\", &n);\n    for (int i = 1; i <= n; i++) {\n        scanf(\"%llu\", &a[i]);\n    }\n    for (int i = 1; i <= n; i++) {\n        scanf(\"%llu\", &b[i]);\n    }\n    scanf(\"%d\", &q);\n    for (int i = 1; i <= q; i++) {\n        int l, r;\n        scanf(\"%d%d\", &l, &r);\n        d[r].push_back({l, i});\n    }\n    for (int r = 1; r <= n; r++) {\n        for (int i = 1; i <= r; i++) {\n            x[i] = max(x[i], a[r]);\n            y[i] = max(y[i], b[r]);\n            f[i] += x[i] * y[i];\n        }\n        for (auto [l, id] : d[r]) {\n            for (int i = l; i <= r; i++)\n                ans[id] += f[i];\n        }\n    }\n    for (int i = 1; i <= q; i++) printf(\"%llu\\n\", ans[i]);\n    return 0;\n}\n```\n\n\u8003\u8651\u4f18\u5316\uff0c\u7528\u7ebf\u6bb5\u6811\u6765\u7ef4\u62a4 $f_i$\uff0c\u8fd9\u6837 $O(\\log n)$ \u65f6\u95f4\u80fd\u6c42\u51fa $\\sum\\limits_{i=l}^r f_i$ \u3002\n\n\u7528\u5355\u8c03\u6808\u6216\u8005 DP \u9884\u5904\u7406\u51fa $a,b$ \u6570\u7ec4\u6bcf\u4e2a\u5143\u7d20\u4f5c\u4e3a\u6700\u5927\u503c\u5f80\u5de6\u80fd\u63a7\u5236\u5230\u7684\u6700\u8fdc\u4f4d\u7f6e\uff0c\u8fd9\u6837\u6bcf\u4e2a $a_r$ \u53ea\u4f1a\u66f4\u65b0\u4e00\u6bb5\u540e\u7f00\u7684 $x_i$ \uff0c$b_r$ \u4e5f\u540c\u7406\uff0c\u90fd\u5229\u7528\u7ebf\u6bb5\u6811\u6765\u505a\u533a\u95f4\u8986\u76d6\u3002\u4e5f\u5c31\u8bf4\uff0c\u6bcf\u5230\u4e00\u4e2a\u65b0\u7684 $r$\uff0c\u5728\u56de\u7b54\u8be2\u95ee\u524d\u8fdb\u884c\u4e0b\u9762 $3$ \u4e2a\u6b65\u9aa4\uff1a\n\n1. \u533a\u95f4\u66f4\u65b0\u4e00\u6bb5\u540e\u7f00\u7684 $x_i$ \u4e3a $a_r$\n2. \u533a\u95f4\u66f4\u65b0\u4e00\u6bb5\u540e\u7f00\u7684 $y_i$ \u4e3a $b_r$\n3. \u5728 $[1,r]$ \u533a\u95f4\u6bcf\u4e2a $f_i$ \u4e0a\u52a0\u4e0a $x_i\\times y_i$\n\n\u7ebf\u6bb5\u6811\u8bb0\u5f55\u56db\u4e2a\u4fe1\u606f $s$ \u8868\u793a $f_i$ \u7684\u533a\u95f4\u548c\uff0c$xy$ \u8868\u793a\u533a\u95f4\u5185 $\\sum x_iy_i$ \uff0c$x$ \u8868\u793a\u533a\u95f4\u5185 $\\sum x_i$\uff0c$y$ \u8868\u793a\u533a\u95f4\u5185 $\\sum y_i$ \u3002\n\n\u5b9a\u4e49 $6$ \u4e2a\u5ef6\u8fdf\u6807\u8bb0\uff0c$c_x,c_y$ \u662f\u8986\u76d6\u6807\u8bb0\uff0c\u540e\u9762\u56db\u4e2a\u6807\u8bb0 $add_{xy},add_{x},add_{y},add_c$ \u5206\u522b\u4e3a $\\sum x_iy_i,\\sum x_i,\\sum y_i,\\sum1$ \uff08\u76f8\u5f53\u4e8e\u533a\u95f4\u957f\u5ea6\uff09\u7684\u589e\u91cf\uff0c\u4e5f\u5c31\u662f\u5404\u81ea\u589e\u52a0\u7684\u500d\u6570\u3002\n\n\u89c4\u5b9a\u5ef6\u8fdf\u6807\u8bb0\u7684\u4f18\u5148\u7ea7\u4e3a\uff0c\u52a0\u6807\u8bb0\u5e94\u7528\u5728\u8986\u76d6\u6807\u8bb0\u4e4b\u524d\uff0c\u8fd9\u6837\u5728\u4e0b\u4f20\u7684\u65f6\u5019\uff0c\u4e0b\u4f20\u7684\u52a0\u6807\u8bb0\u4f1a\u4f5c\u7528\u5728\u539f\u5148\u7684\u4fe1\u606f\u4e0a\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u539f\u5148\u5b58\u5728\u8986\u76d6\u6807\u8bb0\uff0c\u4e0b\u4f20\u7684\u52a0\u6807\u8bb0\u4f1a\u9000\u5316 \u3002\n\n\u6bd4\u5982\u539f\u5148\u53ea\u6709 $x$ \u662f\u88ab\u8986\u76d6\u6210 $c_x$ \u7684\uff0c\u90a3\u4e48 $add_y$ \u548c $add_c$ \u4e0d\u53d7\u5f71\u54cd\uff0c\u76f4\u63a5\u548c\u539f\u6807\u8bb0\u5408\u5e76\uff0c\u800c $add_{xy}\\sum x_iy_i=add_{xy}c_x\\sum y_i$ \uff0c\u4e5f\u5c31\u662f $add_{xy}$ \u8f6c\u6362\u6210\u4e86 $add_{xy}\\times c_x$ \u52a0\u5230 $add_y$ \u91cc\uff0c\u540c\u7406 $add_x$ \u8f6c\u6362\u6210 $add_x\\times c_x$ \u52a0\u5230 $add_c$ \u91cc\u3002\u8fd9\u6837\u66f4\u65b0\u540e\uff0c\u6240\u6709\u52a0\u6807\u8bb0\u53c8\u90fd\u662f\u5e94\u7528\u5728\u8986\u76d6\u6807\u8bb0\u4e4b\u524d\u7684\uff0c**\u52a0\u7684\u90fd\u662f\u539f\u503c\u7684\u500d\u6570**\u3002\n\n\u5bf9\u4e8e\u533a\u95f4\u4fe1\u606f\u7684\u66f4\u65b0\uff0c\u9996\u5148 $s$ \u5e94\u8be5\u52a0\u4e0a $add_{xy}\\times \\sum x_iy_i+add_{x}\\times \\sum x_i+add_{y}\\times\\sum y_i +add_c\\times \\sum1$\uff0c\u7136\u540e\u6839\u636e\u662f\u5426\u6709\u8986\u76d6\u6807\u8bb0\u6765\u66f4\u65b0 $\\sum x_iy_i,\\sum x_i,\\sum y_i$\u3002\n\n\u603b\u65f6\u95f4\u590d\u6742\u5ea6 $O((n+q)\\log n)$\uff0c[\u66f4\u591a\u7ec6\u8282\u89c1\u4ee3\u7801](https://www.luogu.com.cn/paste/vsacq6lm)\u3002\n\n",
        "postTime": 1670328886,
        "uid": 54357,
        "name": "OMG_wc",
        "ccfLevel": 0,
        "title": "[NOIP2022] \u6bd4\u8d5b \u9898\u89e3"
    },
    {
        "content": "> $q$ \u6b21\u8be2\u95ee\uff0c\u6bcf\u6b21\u7ed9\u5b9a\u533a\u95f4 $[l,r]$\uff0c\u6c42\u6240\u6709\u5b50\u533a\u95f4\u7684 $a$ \u6700\u5927\u503c\u548c $b$ \u6700\u5927\u503c\u4e58\u79ef\u7684\u548c\u3002\n\n\u5148\u79bb\u7ebf\uff0c\u7136\u540e\u626b\u63cf\u7ebf\u626b\u8fc7\u53bb\u53f3\u7aef\u70b9\u3002\u8003\u8651\u8bb0 $f_i$ \u4e3a\u5f53\u524d\u53f3\u7aef\u70b9\u4e0b\u4ee5 $i$ \u4e3a\u5de6\u7aef\u70b9\u7684\u7b54\u6848\uff0c\u90a3\u4e48\u6bcf\u6b21\u65b0\u589e\u4e00\u4e2a\u70b9\u7684\u65f6\u5019\u4f1a\u8fdb\u884c\u4e00\u4e9b\u533a\u95f4\u52a0\u64cd\u4f5c\uff0c\u53ef\u4ee5\u7528\u5355\u8c03\u6808\u7ef4\u62a4\u4e00\u4e0b\u3002\u5bb9\u6613\u53d1\u73b0\u8fd9\u4e9b\u533a\u95f4\u5747\u644a\u4e2a\u6570\u662f $O(n)$ \u7684\u3002\u67e5\u8be2\u5c31\u662f\u5386\u53f2\u548c\u3002\u90a3\u4e48\u95ee\u9898\u53d8\u6210\u4e86\uff1a\n\n- \u5bf9 $a$ \u533a\u95f4 $[l,r]$ \u6574\u4f53 $+x$\uff1b\n- \u5bf9 $b$ \u533a\u95f4 $[l,r]$ \u6574\u4f53 $+x$\uff1b\n- \u5bf9\u4e8e\u6bcf\u4e2a $s_i$\uff0c\u52a0\u4e0a $a_i\\times b_i$\uff1b\n- \u67e5\u8be2\u4e00\u6bb5 $s_i$ \u7684\u548c\u3002\n\n\u5148\u56de\u987e\u4e00\u4e0b\u533a\u95f4\u52a0\uff0c\u5386\u53f2\u548c\u662f\u600e\u4e48\u505a\u7684\u3002\u7ebf\u6bb5\u6811\u4e0a\u7684\u6bcf\u4e2a\u8282\u70b9\u7ef4\u62a4\u4e00\u4e2a\u7c7b\u4f3c\u201c\u6807\u8bb0\u961f\u5217\u201d\uff0c\u961f\u5217\u6bcf\u4e00\u9879\u662f\u5f62\u5982 $+x$ \u7684\u52a0\u6cd5\u64cd\u4f5c\u6216\u662f `upd` \u7684\u66f4\u65b0\u5386\u53f2\u548c\u64cd\u4f5c\u3002\u6211\u4eec\u4e0d\u663e\u5f0f\u7ef4\u62a4\u961f\u5217\uff0c\u53ea\u8981\u7ef4\u62a4\u8fd9\u4e2a\u961f\u5217\u7684\u4e00\u4e9b\u7279\u5f81\u503c\u5c31\u597d\u4e86\u3002\u4e0b\u4f20\u6807\u8bb0\u5c31\u662f\u5408\u5e76\u4e24\u4e2a\u961f\u5217\u3002\n\n\u8003\u8651\u4e00\u4e0b\u7ebf\u6bb5\u6811\u8282\u70b9\u4e0a\u8981\u7ef4\u62a4\u54ea\u4e9b\u503c\u3002\u9996\u5148\u6709\u533a\u95f4\u548c $sum$\uff0c\u533a\u95f4\u5386\u53f2\u548c $ans$\uff0c\u52a0\u6cd5\u6807\u8bb0 $add$\u3002\u8003\u8651\u6bcf\u4e2a\u6807\u8bb0\u5e26\u6765\u7684\u5f71\u54cd\uff1a\n\n- $+x$ \u6807\u8bb0\uff1a$sum\\gets sum+x\\times len$\uff0c$add\\gets add+x$\uff1b\n- `upd` \u6807\u8bb0\uff1a$ans\\gets ans+sum$\u3002\n\n\u8003\u8651\u5408\u5e76\u4e24\u4e2a\u961f\u5217\uff08\u5047\u8bbe\u513f\u5b50\u4e0a\u7684\u662f $1$\uff0c\u7236\u4eb2\u7684\u662f $2$\uff09\u7684\u65f6\u5019\u4f1a\u600e\u6837\uff0c$add_1$ \u548c $sum_1$ \u662f\u5bb9\u6613\u7684\uff0c$ans_1\\gets ans_1+sum_1\\times upd_2+h_2\\times len_1$\uff0c\u5176\u4e2d $upd$ \u8868\u793a\u961f\u5217\u91cc\u6709\u591a\u5c11 `upd` \u64cd\u4f5c\uff0c$h$ \u8868\u793a\u6bcf\u6b21 `upd` \u64cd\u4f5c\u7684 $add$ \u7684\u548c\u3002\u4f1a\u53d1\u73b0\u8fd8\u9700\u8981\u7ef4\u62a4 $upd$ \u548c $h$\uff0c$upd$ \u662f\u597d\u7ef4\u62a4\u7684\uff0c\u518d\u770b\u4e00\u4e0b $h_1\\gets h_1+add_1\\times upd_2+h_2$\u3002\u5177\u4f53\u63a8\u5bfc\u53ef\u4ee5[\u53c2\u8003\u535a\u5ba2](https://www.luogu.com.cn/blog/command-block/guan-yu-xian-duan-shu-shang-di-yi-suo-jin-jie-cao-zuo)\u3002\n\n\u518d\u56de\u5230\u8fd9\u4e2a\u9898\u3002\u6211\u4eec\u8fd8\u662f\u8003\u8651\u7ebf\u6bb5\u6811\u8282\u70b9\u4e0a\u8981\u7ef4\u62a4\u4ec0\u4e48\u3002\u9996\u5148\u80af\u5b9a\u8981\u6709\u7684\uff1a\u533a\u95f4 $ab$ \u7684\u548c $s$\uff0c\u533a\u95f4 $a$ \u7684\u548c $sa$\uff0c\u533a\u95f4 $b$ \u7684\u548c $sb$\uff0c$ab$ \u7684\u5386\u53f2\u7248\u672c\u548c $ans$\uff0c\u52a0 $a$ \u6807\u8bb0 $adda$\uff0c\u52a0 $b$ \u6807\u8bb0 $addb$\u3002\u8003\u8651\u6bcf\u4e2a\u6807\u8bb0\u5e26\u6765\u7684\u5f71\u54cd\uff1a\n\n- $a+x$ \u6807\u8bb0\uff1a$s\\gets s+x\\times sb$\uff0c$sa\\gets sa+x\\times len$\uff0c$adda\\gets adda+x$\uff1b\n- $b+x$ \u6807\u8bb0\uff1a$s\\gets s+x\\times sa$\uff0c$sb\\gets sb+x\\times len$\uff0c$addb\\gets addb+x$\uff1b\n- `upd` \u6807\u8bb0\uff1a$ans\\gets ans+s$\u3002\n\n\u8003\u8651\u5408\u5e76\u4e24\u4e2a\u961f\u5217\uff08\u5047\u8bbe\u513f\u5b50\u4e0a\u7684\u662f $1$\uff0c\u7236\u4eb2\u7684\u662f $2$\uff09\u7684\u65f6\u5019\u4f1a\u600e\u6837\uff0c\u4f3c\u4e4e\u9664\u4e86 $ans$ \u90fd\u662f\u5bb9\u6613\u7684\uff0c$ans_1\\gets ans_1+s_1\\times upd_2+hb_2\\times sa_1+ha_2\\times sb_1+h_2\\times len_1$\uff0c\u5176\u4e2d $upd$ \u8868\u793a\u961f\u5217\u91cc\u6709\u591a\u5c11 `upd` \u64cd\u4f5c\uff0c$ha$ \u8868\u793a\u6bcf\u6b21 `upd` \u64cd\u4f5c\u7684 $adda$ \u7684\u548c\uff0c$hb$ \u8868\u793a\u6bcf\u6b21 `upd` \u64cd\u4f5c\u7684 $addb$ \u7684\u548c\uff0c$h$ \u8868\u793a\u6bcf\u6b21 `upd` \u64cd\u4f5c $adda\\times addb$ \u7684\u548c\u3002\u4f1a\u53d1\u73b0\u8fd8\u9700\u8981\u7ef4\u62a4 $upd$\uff0c$ha$\uff0c$hb$\uff0c$h$\u3002$upd$ \u662f\u597d\u7ef4\u62a4\u7684\uff0c\u518d\u770b\u4e00\u4e0b $ha_1\\gets ha_1+adda_1\\times upd_2+ha_2$\uff0c$hb$ \u540c\u7406\u3002\u63a8\u4e00\u4e0b $h$ \u4f1a\u600e\u4e48\u53d8\uff0c\u53ef\u4ee5\u53d1\u73b0\uff1a$h_1\\gets h_1+adda_1\\times addb_1\\times upd_2+adda_1\\times hb_2+addb_1\\times ha_2+h_2$\u3002\n\n\u7ef4\u62a4\u4ee5\u4e0a\u6240\u6709\u6807\u8bb0\u5373\u53ef\u3002\u4e0a\u8ff0\u6807\u8bb0\u7ef4\u62a4\u8fc7\u7a0b\u5199\u6210\u4ee3\u7801\u5982\u4e0b\uff1a\n\n```cpp\ninline void spread(int u,point v)\n{\n\ts[u].ans+=s[u].s*v.upd+s[u].sa*v.hb+s[u].sb*v.ha+v.h*s[u].l;\n\ts[u].h+=s[u].adda*s[u].addb*v.upd+s[u].adda*v.hb+s[u].addb*v.ha+v.h;\n\ts[u].ha+=s[u].adda*v.upd+v.ha;\n\ts[u].hb+=s[u].addb*v.upd+v.hb;\n\ts[u].s+=s[u].sa*v.addb+s[u].sb*v.adda+v.addb*v.adda*s[u].l;\n\ts[u].sa+=v.adda*s[u].l;\n\ts[u].sb+=v.addb*s[u].l;\n\ts[u].upd+=v.upd;\n\ts[u].adda+=v.adda;\n\ts[u].addb+=v.addb;\n}\n```\n\n\u4e8e\u662f\u8fd9\u9053\u9898\u5c31\u505a\u5b8c\u4e86\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log n)$\u3002\n\n```cpp\n// Author: Little09\n// Problem: P8868 [NOIP2022] \u6bd4\u8d5b\n// Contest: Luogu\n// URL: https://www.luogu.com.cn/problem/P8868\n// Memory Limit: 512 MB\n// Time Limit: 2000 ms\n// Start Time: 2022-12-23 15:37:28\n// \n// Powered by CP Editor (https://cpeditor.org)\n\n#include <bits/stdc++.h>\nusing namespace std;\n#define ull unsigned long long\n#define mkp make_pair\n#define pii pair<int,int>\n#define fi first\n#define se second\nconst int N=3e5+5;\nint n,m;\nstruct point\n{\n\tull adda,addb,s,sa,sb,upd,h,ha,hb,ans,l;\n}s[N*4];\null ans[N],a[N],b[N];\ninline void push_up(int u)\n{\n\ts[u].s=s[u*2].s+s[u*2+1].s;\n\ts[u].sa=s[u*2].sa+s[u*2+1].sa;\n\ts[u].sb=s[u*2].sb+s[u*2+1].sb;\n\ts[u].ans=s[u*2].ans+s[u*2+1].ans;\n}\ninline void spread(int u,point v)\n{\n\ts[u].ans+=s[u].s*v.upd+s[u].sa*v.hb+s[u].sb*v.ha+v.h*s[u].l;\n\ts[u].h+=s[u].adda*s[u].addb*v.upd+s[u].adda*v.hb+s[u].addb*v.ha+v.h;\n\ts[u].ha+=s[u].adda*v.upd+v.ha;\n\ts[u].hb+=s[u].addb*v.upd+v.hb;\n\ts[u].s+=s[u].sa*v.addb+s[u].sb*v.adda+v.addb*v.adda*s[u].l;\n\ts[u].sa+=v.adda*s[u].l;\n\ts[u].sb+=v.addb*s[u].l;\n\ts[u].upd+=v.upd;\n\ts[u].adda+=v.adda;\n\ts[u].addb+=v.addb;\n}\ninline void push_down(int u)\n{\n\tspread(u*2,s[u]),spread(u*2+1,s[u]);\n\ts[u].h=0,s[u].ha=0,s[u].hb=0,s[u].upd=0,s[u].adda=0,s[u].addb=0;\n}\nvoid build(int u,int l,int r)\n{\n\ts[u].l=r-l+1;\n\tif (l==r) return;\n\tint mid=(l+r)>>1;\n\tbuild(u*2,l,mid),build(u*2+1,mid+1,r);\n}\nvoid update(int u,int L,int R,int l,int r,ull x,int tp)\n{\n\tif (l>r) return;\n\tif (l<=L&&R<=r) \n\t{\n\t\tif (tp==0) spread(u,(point){x,0,0,0,0,0,0,0,0,0,R-L+1});\n\t\telse spread(u,(point){0,x,0,0,0,0,0,0,0,0,R-L+1});\n\t\treturn;\n\t}\n\tpush_down(u);\n\tint mid=(L+R)>>1;\n\tif (l<=mid) update(u*2,L,mid,l,r,x,tp);\n\tif (mid<r) update(u*2+1,mid+1,R,l,r,x,tp);\n\tpush_up(u);\n}\null ask(int u,int L,int R,int l,int r)\n{\n\tif (l<=L&&R<=r) return s[u].ans;\n\tint mid=(L+R)>>1;\n\tpush_down(u);\n\tull res=0;\n\tif (l<=mid) res+=ask(u*2,L,mid,l,r);\n\tif (mid<r) res+=ask(u*2+1,mid+1,R,l,r);\n\treturn res;\n}\nvector<pii>t[N];\nint sta[N],topa,stb[N],topb;\n\nint main()\n{\n\tios_base::sync_with_stdio(false);\n\tcin.tie(0);cout.tie(0);\n\tint T;\n\tcin >> T >> n;\n\tfor (int i=1;i<=n;i++) cin >> a[i];\n\tfor (int i=1;i<=n;i++) cin >> b[i];\n\tcin >> m;\n\tfor (int i=1;i<=m;i++)\n\t{\n\t\tint l,r;\n\t\tcin >> l >> r;\n\t\tt[r].push_back(mkp(l,i));\n\t}\n\tbuild(1,1,n);\n\ttopa=1,topb=1;\n\ta[0]=n+1,b[0]=n+1;\n\tfor (int i=1;i<=n;i++)\n\t{\n\t\twhile (a[sta[topa]]<a[i]) \n\t\t{\n\t\t\tupdate(1,1,n,sta[topa-1]+1,sta[topa],-a[sta[topa]],0);\n\t\t\ttopa--;\n\t\t}\n\t\tupdate(1,1,n,sta[topa]+1,i,a[i],0);\n\t\tsta[++topa]=i;\n\t\twhile (b[stb[topb]]<b[i]) \n\t\t{\n\t\t\tupdate(1,1,n,stb[topb-1]+1,stb[topb],-b[stb[topb]],1);\n\t\t\ttopb--;\n\t\t}\n\t\tupdate(1,1,n,stb[topb]+1,i,b[i],1);\n\t\tstb[++topb]=i;\n\t\tspread(1,(point){0,0,0,0,0,1,0,0,0,0,0});\n\t\tfor (auto j:t[i]) ans[j.se]=ask(1,1,n,j.fi,i);\n\t}\n\tfor (int i=1;i<=m;i++) cout << ans[i] << '\\n';\n\treturn 0;\n}\n\n```\n",
        "postTime": 1671784066,
        "uid": 151475,
        "name": "Little09",
        "ccfLevel": 8,
        "title": "\u597d\u96be\u554a"
    },
    {
        "content": "## \u66b4\u529b\uff088pts\uff09\n\u663e\u7136\uff0c\u66b4\u529b\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 ST \u8868\uff0c\u6bcf\u4e2a\u8be2\u95ee\u76f4\u63a5\u66b4\u529b\u679a\u4e3e\uff0c\u590d\u6742\u5ea6 $O(qn^2)$\uff0c\u671f\u671b\u5f97\u5206\uff1a$8$\u3002\n\n## \u83ab\u961f\uff0852pts\uff09\n\n\u770b\u5230\u533a\u95f4\u64cd\u4f5c\u53ef\u4ee5\u4f7f\u7528\u83ab\u961f\u3002\u5148\u770b\u6dfb\u52a0\u64cd\u4f5c\u3002\u4f8b\u5982\uff1a\u4ece\u533a\u95f4 $[a,b]$ \u8f6c\u79fb\u5230\u533a\u95f4 $[a,b+1]$\u3002\n\n\u663e\u7136\uff0c\u6b64\u65f6\u591a\u51fa\u6765\u7684\u533a\u95f4\u662f $[a,b+1],[a+1,b+1],[a+2,b+1],\u00b7\u00b7\u00b7,[b+1,b+1]$\u3002\n\n\u628a\u8fd9\u4e9b\u533a\u95f4\u76f4\u63a5\u53d6\u6700\u503c\uff0c\u590d\u6742\u5ea6\u662f $O(n^2\\sqrt n)$\uff0c\u8fd8\u662f\u5f88\u9ad8\u3002\u8003\u8651\u4f18\u5316\u8f6c\u79fb\u7684\u8fc7\u7a0b\u3002\u601d\u8003\u8f6c\u79fb\u65f6\uff0c\u54ea\u4e2a\u533a\u95f4\u7684\u6700\u503c\u4f1a\u6539\u53d8\u3002\u663e\u7136\uff0c\u53ea\u9700\u8981\u627e\u5230 $b+1$ \u5de6\u8fb9\u7b2c\u4e00\u4e2a\u6bd4\u8fd9\u4e2a\u6570\u5927\u7684\u4f4d\u7f6e $k$\uff0c\u90a3\u4e48 $[k+1$~$b+1,b+1]$ \u8fd9\u4e9b\u533a\u95f4\u7684\u6700\u5927\u503c\u90fd\u662f $b+1$\uff0c\u5176\u4ed6\u533a\u95f4\u5219\u4e0d\u53d8\u3002\u800c\u8f6c\u79fb\u9700\u8981\u6c42 $[a$~$b+1,b+1]$ \u7684\u548c\u3002\u5b9a\u4e49\u4e24\u4e2a\u6570\u7ec4 $m,n$\uff0c$m_i$ \u8868\u793a $A_{[i,b+1]}$ \u7684\u6700\u5927\u503c\uff0c$n_i$ \u8868\u793a $B_{[i,b+1]}$ \u7684\u6700\u5927\u503c\u3002\u8f6c\u79fb\u5c31\u53ef\u4ee5\u8f6c\u5316\u6210\uff1a\n\n1. \u5c06\u533a\u95f4 $m_{[k+1,b+1]}$ \u7684\u503c\u66f4\u6539\u4e3a $A_{b+1}$\u3002\u5c06\u533a\u95f4 $n_{[k+1,b+1]}$ \u7684\u503c\u66f4\u6539\u4e3a $B_{b+1}$\u3002\n\n2. \u6c42\u533a\u95f4 $[a,b],m_i\u00d7n_i$ \u7684\u548c\u3002\n\n\u5176\u4e2d\uff0c$A,B$ \u5206\u522b\u8868\u793a\u521d\u59cb\u7684\u4e24\u4e2a\u6570\u7ec4\u3002\n\n\u76f4\u63a5\u7ebf\u6bb5\u6811\u7ef4\u62a4\u5373\u53ef\uff0c\u6c42 $k$ \u53ef\u4ee5\u7528\u5355\u8c03\u6808\u3002\u590d\u6742\u5ea6 $O(n\\sqrt n\\log n)$\u3002\uff08\u672c\u849f\u84bb\u6b62\u6b65\u4e8e\u6b64\uff09\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n#define int unsigned long long\nstruct nodes{\n\tint l,r,sets1,sets2,sum1,sum2,sum3;\n};\nstruct tr{\n\tnodes p[1000005];\n\tvoid upset(int x){\n\t\tp[x].sum1=p[x<<1].sum1+p[x<<1|1].sum1;\n\t\tp[x].sum2=p[x<<1].sum2+p[x<<1|1].sum2;\n\t\tp[x].sum3=p[x<<1].sum3+p[x<<1|1].sum3;\n\t}\n\tvoid setss1(int x,int sum){\n\t\tp[x].sets1=sum;\n\t\tp[x].sum1=sum*(p[x].r-p[x].l+1);\n\t\tp[x].sum3=p[x].sum2*sum;\n\t}\n\tvoid setss2(int x,int sum){\n\t\tp[x].sets2=sum;\n\t\tp[x].sum2=sum*(p[x].r-p[x].l+1);\n\t\tp[x].sum3=p[x].sum1*sum;\n\t}\n\tvoid dnset(int x){\n\t\tif(p[x].sets1){\n\t\t\tsetss1(x<<1,p[x].sets1);\n\t\t\tsetss1(x<<1|1,p[x].sets1);\n\t\t\tp[x].sets1=0;\n\t\t}\n\t\tif(p[x].sets2){\n\t\t\tsetss2(x<<1,p[x].sets2);\n\t\t\tsetss2(x<<1|1,p[x].sets2);\n\t\t\tp[x].sets2=0;\n\t\t}\n\t}\n\tvoid reset(int x,int l,int r){\n\t\tp[x].l=l,p[x].r=r;p[x].sum1=p[x].sum2=p[x].sum3=p[x].sets1=p[x].sets2=0;\n\t\tif(l==r)return;\n\t\tint mid=l+r>>1;\n\t\treset(x<<1,l,mid);\n\t\treset(x<<1|1,mid+1,r); \n\t} \n\tvoid sets(int x,int l,int r,int sum,int lx){ \n\t\tif(l<=p[x].l&&r>=p[x].r){\n\t\t\tif(lx==1){\n\t\t\t\tsetss1(x,sum);\n\t\t\t\treturn;\n\t\t\t}else{\n\t\t\t\tsetss2(x,sum);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tint mid=p[x].l+p[x].r>>1;\n\t\tdnset(x);\n\t\tif(l<=mid)sets(x<<1,l,r,sum,lx);\n\t\tif(r>mid)sets(x<<1|1,l,r,sum,lx);\n\t\tupset(x);\n\t}\n\tint gets(int x,int l,int r,int lx){\n\t\tif(l<=p[x].l&&r>=p[x].r){\n\t\t\tif(lx==1)return p[x].sum1;\n\t\t\tif(lx==2)return p[x].sum2;\n\t\t\tif(lx==3)return p[x].sum3;\n\t\t}\n\t\tdnset(x);\n\t\tint mid=p[x].l+p[x].r>>1,res=0;\n\t\tif(l<=mid)res+=gets(x<<1,l,r,lx);\n\t\tif(r>mid)res+=gets(x<<1|1,l,r,lx);\n\t\tupset(x);\n\t\treturn res;\n\t}\n}p1,p2,p3;\nint t,n,a[250005],b[250005],bh[250005],T,rr1,rr2,q,st[250005],ed[250005],f1[250005][25],f2[250005][25],lg2[250005],res,l1[250005],l2[250005],r1[250005],r2[250005],r[250005];\nstruct node{\n\tint l,r,bhs;\n\tfriend bool operator<(node a,node b){\n\t\tif(bh[a.l]==bh[b.l])return a.r<b.r;\n\t\treturn a.l<b.l;\n\t}\n}p[250005];\nstack<int>q1,q2;\nint gets(int l,int r,int rr){\n\tif(l>r)return res;\n\tint ans=res;\n\tfor(int i=1;i<=3*n;i++)p2.p[i]=p3.p[i];\n\tfor(int i=r;i>=l;i--){\n\t\tint t1=r1[i],t2=r2[i];\n\t//\tcout<<i<<\" \"<<t1<<\" \"<<t2<<\" \"<<rr<<endl;\n\t\tif(t1<=rr)p2.sets(1,i,t1-1,a[i],1);\n\t\telse p2.sets(1,i,rr,a[i],1);\n\t\tif(t2<=rr)p2.sets(1,i,t2-1,b[i],2);\n\t\telse p2.sets(1,i,rr,b[i],2);\n\t\tans+=p2.gets(1,i,rr,3);\n\t}\n\treturn ans;\n}\nsigned main(){\n\tfor(int i=1;i<=250000;i++)lg2[i]=log2(i);\n\tcin>>t>>n;\n\tT=sqrt(n);\n\tfor(int i=1;i<=n;i++)scanf(\"%lld\",&a[i]);\n\tfor(int i=1;i<=n;i++)scanf(\"%lld\",&b[i]);\n\ta[0]=1e9,b[0]=1e9;\n\tq1.push(0);q2.push(0);\n\tfor(int i=1;i<=n;i++){\n\t\twhile(q1.size()&&a[q1.top()]<=a[i])q1.pop();\n\t\twhile(q2.size()&&b[q2.top()]<=b[i])q2.pop();\n\t\tl1[i]=q1.top();l2[i]=q2.top();\n\t\tq1.push(i);q2.push(i);\n\t}\n\twhile(q1.size())q1.pop();while(q2.size())q2.pop();\n\ta[n+1]=1e9,b[n+1]=1e9;\n\tq1.push(n+1);q2.push(n+1);\n\tfor(int i=n;i>=1;i--){\n\t\twhile(q1.size()&&a[q1.top()]<=a[i])q1.pop();\n\t\twhile(q2.size()&&b[q2.top()]<=b[i])q2.pop();\n\t\tr1[i]=q1.top();r2[i]=q2.top();\n\t\tq1.push(i);q2.push(i);\n\t}\n\tfor(int i=1;i<=n;i++)bh[i]=(i-1)/T+1; \n\tfor(int i=1;i<=1000;i++)st[i]=ed[i-1]+1,ed[i]=i*T;\n\tcin>>q;\n\tfor(int i=1;i<=q;i++){\n\t\tint l,r;\n\t\tscanf(\"%lld%lld\",&l,&r);\n\t\tp[i]=(node){l,r,i};\n\t}\n\tsort(p+1,p+q+1);\n\tfor(int i=1;i<=q;i++){\n\t\tif(bh[p[i].l]!=bh[p[i-1].l]){\n\t\t\tp1.reset(1,1,n);\n\t\t\tp3.reset(1,1,n);\n\t\t\tres=0;rr1=rr2=0;\n\t\t\tfor(int j=ed[bh[p[i].l]];j<=p[i].r;j++){\n\t\t\t\tint t1=l1[j],t2=l2[j];\n\t\t\t\tif(t1>=ed[bh[p[i].l]])p1.sets(1,t1+1,j,a[j],1);\n\t\t\t\telse p1.sets(1,ed[bh[p[i].l]],j,a[j],1);\n\t\t\t\tif(t2>=ed[bh[p[i].l]])p1.sets(1,t2+1,j,b[j],2);\n\t\t\t\telse p1.sets(1,ed[bh[p[i].l]],j,b[j],2);\n\t\t\t\tres+=p1.gets(1,ed[bh[p[i].l]],j,3);\n\t\t\t\trr1=max(rr1,a[j]);rr2=max(rr2,b[j]);\n\t\t\t\tp3.sets(1,j,j,rr1,1);p3.sets(1,j,j,rr2,2);\n\t\t\t}\n\t\t\tr[p[i].bhs]=gets(p[i].l,min(p[i].r,ed[bh[p[i].l]]-1),p[i].r);\n\t\t\tcontinue;\n\t\t}\n\t\tfor(int j=max(p[i-1].r+1,ed[bh[p[i].l]]);j<=p[i].r;j++){\n\t\t\tint t1=l1[j],t2=l2[j];\n\t\t    if(t1>=ed[bh[p[i].l]])p1.sets(1,t1+1,j,a[j],1);\n\t\t\telse p1.sets(1,ed[bh[p[i].l]],j,a[j],1);\n\t\t\tif(t2>=ed[bh[p[i].l]])p1.sets(1,t2+1,j,b[j],2);\n\t\t\telse p1.sets(1,ed[bh[p[i].l]],j,b[j],2);\n\t\t\tres+=p1.gets(1,ed[bh[p[i].l]],j,3);\n\t\t\trr1=max(rr1,a[j]);rr2=max(rr2,b[j]);\n\t\t\tp3.sets(1,j,j,rr1,1);p3.sets(1,j,j,rr2,2);\n\t\t}\n\t\tr[p[i].bhs]=gets(p[i].l,min(p[i].r,ed[bh[p[i].l]]-1),p[i].r);\n\t}\n\tfor(int i=1;i<=q;i++)cout<<r[i]<<endl;\n}\n```\n\n\n## \u5206\u5757\uff08100pts\uff09\n\n\u5c06\u8be2\u95ee\u6309\u53f3\u7aef\u70b9\u6392\u5e8f\u3002\u5b9a\u4e49\u4e24\u4e2a\u6570\u7ec4 $m,n$\u3002\n\n\u7528 $i$ \u904d\u5386 $1-n$\u3002\n\n$m_j$ \u8868\u793a $A_{[j,i]}$ \u7684\u6700\u5927\u503c\uff0c$n_j$ \u8868\u793a $B_{[j,i]}$ \u7684\u6700\u5927\u503c\u3002\n\n$r_j$ \u8868\u793a\u533a\u95f4 $[j,i]$ \u7684\u7b54\u6848\u3002\u5f53 $i$ \u52a0 $1$ \u65f6\uff0c\u5bf9\u4e8e\u6240\u6709\u7684 $k$\uff0c\u90fd\u9700\u8981\u8ba9 $r_k$ \u52a0\u4e0a $m_k\u00d7n_k$\u3002\u6c42\u7b54\u6848\u7684\u65f6\u5019\u5c31\u9700\u8981\u6c42 $r_{[a,b]}$ \u7684\u548c\u3002\n\n\u4e5f\u5c31\u662f\u95ee\u9898\u8f6c\u5316\u6210\u4e86\uff1a\n\n\u6709\u4e09\u4e2a\u6570\u7ec4 $m,n,r$\u3002\n\n\u9700\u8981\u7ef4\u62a4\u4e09\u79cd\u64cd\u4f5c\uff1a\n\n- \u6570\u7ec4 $m,n$ \u533a\u95f4\u8d4b\u503c\u3002\n\n- \u6570\u7ec4 $r$\uff0c\u5bf9\u4e8e\u533a\u95f4\u5185\u7684\u6bcf\u4e2a $k$\uff0c\u90fd\u8ba9 $r_k$ \u52a0\u4e0a $m_k\u00d7n_k$\u3002\n\n- \u6c42\u6570\u7ec4 $r$ \u533a\u95f4\u548c\u3002\n\n\u5206\u5757\uff0c\u6bd4\u8f83\u96be\u7684\u662f\u6574\u5757\u4fee\u6539\u3002\u53ef\u4ee5\u5206\u7c7b\u8ba8\u8bba\u3002\u5bf9\u4e8e\u8fd9\u4e00\u5757\u7684\u503c\u662f\u5426\u76f8\u540c\u8fdb\u884c\u5206\u7c7b\u8ba8\u8bba\u5373\u53ef\uff0c\u8be6\u7ec6\u505a\u6cd5\u770b\u4ee3\u7801\u3002\u590d\u6742\u5ea6 $O(n\\sqrt n)$\u3002\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n#define int unsigned long long\nint t,n,a[250005],b[250005],rr1,rr2,q,jl1[250005],jl3[250005],l1[250005],jl[250005],jl2[250005],sm6[250005],bh[250005],l2[250005],r1[250005],r[250005],p1[250005],sm5[250005],p2[250005],st1[250005],st2[250005],T,sm4[250005],st[250005],ed[250005],sn,sm21[250005],sm11[250005],sm3[250005];\nstruct node{\n\tint l,r,bhs;\n\tfriend bool operator<(node a,node b){\n\t\treturn a.r<b.r;\n\t}\n}p[250005];\nstack<int>q1,q2;\nvoid gx(int u){\n\tif(jl1[u]||jl2[u]||jl[u]||jl3[u]){\n\t\tfor(int i=st[u];i<=ed[u];i++){\n\t\t\tsm4[i]+=jl[u]*p1[i]*p2[i]+jl1[u]*p2[i]+jl2[u]*p1[i]+jl3[u];\n\t\t}\n\t\tjl[u]=0;jl1[u]=0;jl2[u]=0;jl3[u]=0;\n\t}\n\tif(st1[u]){\n\t\tfor(int i=st[u];i<=ed[u];i++)p1[i]=st1[u];\n\t\tst1[u]=0;\n\t}\n\tif(st2[u]){\n\t\tfor(int i=st[u];i<=ed[u];i++)p2[i]=st2[u];\n\t\tst2[u]=0;\n\t}\n}\nvoid setss(int l,int r,int sum,int lx){\n\tint u=bh[l];\n\tgx(u);\n\tfor(int i=st[u];i<=ed[u];i++)sm3[u]-=p1[i]*p2[i];\n\tif(lx==1){\n\t\tfor(int i=l;i<=r;i++)p1[i]=sum;\n\t\tsm11[u]=0;\n\t\tfor(int i=st[u];i<=ed[u];i++)sm11[u]+=p1[i];\n    }else{\n\t\tfor(int i=l;i<=r;i++)p2[i]=sum;\n\t\tsm21[u]=0;\n\t\tfor(int i=st[u];i<=ed[u];i++)sm21[u]+=p2[i];\n\t}\n\tfor(int i=st[u];i<=ed[u];i++)sm3[u]+=p1[i]*p2[i];\n}\nvoid sets(int l,int r,int sum,int lx){\n\tif(bh[l]==bh[r]){\n\t\tsetss(l,r,sum,lx);\n\t\treturn;\n\t}\n\tint ll=bh[l]+1,rr=bh[r]-1;\n\tfor(int i=ll;i<=rr;i++){\n\t\tif(lx==1){\n\t\t\tst1[i]=sum;\n\t\t\tsm3[i]=sum*sm21[i];\n\t\t\tsm11[i]=sum*T;\n\t\t}else{\n\t\t\tst2[i]=sum;\n\t\t\tsm3[i]=sum*sm11[i];\n\t\t\tsm21[i]=sum*T;\n\t\t}\n\t}\n\tsetss(l,st[ll]-1,sum,lx);setss(ed[rr]+1,r,sum,lx);\n}\nvoid ads(int l,int r){\n\tgx(bh[l]);\n\tfor(int i=l;i<=r;i++){\n\t\tsm4[i]+=p1[i]*p2[i];\n\t}\n\tsm5[bh[l]]=0;\n\tfor(int i=st[bh[l]];i<=ed[bh[l]];i++)sm5[bh[l]]+=sm4[i];\n}\nvoid adds(int l,int r){\n\tif(bh[l]==bh[r]){\n\t\tads(l,r);\n\t\treturn;\n\t}\n\tint ll=bh[l]+1,rr=bh[r]-1;\n\tfor(int i=ll;i<=rr;i++){\n\t\tif(st1[i]&&st2[i]){\n\t\t\tjl3[i]+=st1[i]*st2[i];\n\t\t\tsm5[i]+=st1[i]*st2[i]*T;\n\t\t}else if(st1[i]==0&&st2[i]==0){\n\t\t\tsm5[i]+=sm3[i];\n\t\t\tjl[i]++;\n\t\t}else if(st1[i]){\n\t\t\tsm5[i]+=sm21[i]*st1[i];\n\t\t\tjl1[i]+=st1[i];\n\t\t}else{\n\t\t\tsm5[i]+=sm11[i]*st2[i];\n\t\t\tjl2[i]+=st2[i];\n\t\t}\n\t}\n\tads(l,st[ll]-1);ads(ed[rr]+1,r);\n}\nint getss(int l,int r){\n\tint res=0,u=bh[l];\n\tfor(int i=l;i<=r;i++){\n\t\tres+=sm4[i]+jl[u]*p1[i]*p2[i]+jl1[u]*p2[i]+jl2[u]*p1[i]+jl3[u];\n\t}\n\treturn res;\n}\nint gets(int l,int r){\n\tif(bh[l]==bh[r])return getss(l,r);\n\tint res=0,ll=bh[l]+1,rr=bh[r]-1;\n\tfor(int i=ll;i<=rr;i++){\n\t\tres+=sm5[i];\n\t}\n\treturn res+getss(l,st[ll]-1)+getss(ed[rr]+1,r);\n}\nsigned main(){\n\tcin>>t>>n;\n\tT=300;\n\tsn=(n-1)/T+1;\n\tfor(int i=1;i<=n;i++)bh[i]=(i-1)/T+1;\n\tfor(int i=1;i<=sn;i++)st[i]=ed[i-1]+1,ed[i]=i*T;\n\tfor(int i=1;i<=n;i++)scanf(\"%lld\",&a[i]);\n\tfor(int i=1;i<=n;i++)scanf(\"%lld\",&b[i]);\n\ta[0]=1e9,b[0]=1e9;\n\tq1.push(0);q2.push(0);\n\tfor(int i=1;i<=n;i++){\n\t\twhile(q1.size()&&a[q1.top()]<=a[i])q1.pop();\n\t\twhile(q2.size()&&b[q2.top()]<=b[i])q2.pop();\n\t\tl1[i]=q1.top();l2[i]=q2.top();\n\t\tq1.push(i);q2.push(i);\n\t}\n\tcin>>q;\n\tfor(int i=1;i<=q;i++){\n\t\tint l,r;\n\t\tscanf(\"%lld%lld\",&l,&r);\n\t\tp[i]=(node){l,r,i};\n\t}\n\tsort(p+1,p+q+1);\n\tfor(int i=1;i<=q;i++){\n\t\tfor(int j=p[i-1].r+1;j<=p[i].r;j++){\n\t\t\tint t1=l1[j],t2=l2[j];\n\t\t\tsets(t1+1,j,a[j],1);\n\t\t\tsets(t2+1,j,b[j],2);\n\t\t\tadds(1,j);\n\t\t}\n\t\tr[p[i].bhs]=gets(p[i].l,p[i].r);\n\t}\n\tfor(int i=1;i<=q;i++)cout<<r[i]<<endl;\n}\n```\n",
        "postTime": 1669556157,
        "uid": 555287,
        "name": "_ANIG_",
        "ccfLevel": 5,
        "title": "\u6bd4\u8d5b \u9898\u89e3"
    },
    {
        "content": "\u8fd9\u91cc\u662f\u5206\u6cbb\u505a\u6cd5\u3002\n\n\u4e0b\u9762\u8bb0 $A(l,r)=\\max_{i=l}^r a_i$\uff0c$B(l,r)=\\max_{i=l}^r b_i$\u3002\n\n## 52pts\n\n\u6bcf\u4e00\u4e2a\u8be2\u95ee\u90fd\u5206\u6cbb\u4e00\u904d\u3002\n\n\u5047\u8bbe\u6211\u4eec\u6c42\u597d\u4e86\u4e0b\u9762\u4e24\u8fb9\u5404\u81ea\u7684\u7b54\u6848\uff0c\u73b0\u5728\u8ba1\u7b97\u8de8\u8fc7\u4e2d\u95f4\u7684\u533a\u95f4\u7684\u8d21\u732e\u3002\n\n\u94a6\u5b9a $a$\uff0c$b$ \u4e2d\u7684\u6700\u5927\u503c\u90fd\u5728\u53f3\u8fb9\uff0c\u679a\u4e3e\u53f3\u7aef\u70b9 $i$\uff0c\u90a3\u4e48\u53ef\u4ee5\u5728\u5de6\u8fb9\u627e\u5230\u4e00\u4e2a\u6700\u9760\u5de6\u7684 $j$\u3002\n\n\u6b64\u65f6\u8d21\u732e\u4e3a $(mid-j+1)\\times A(mid+1,i)\\times B(mid+1,i)$\u3002\n\n\u6211\u4eec\u53d1\u73b0 $i$ \u5f80\u53f3\u79fb\u52a8\u7684\u65f6\u5019 $A(mid+1,i)$ \u548c $B(mid+1,i)$ \u662f\u5355\u589e\u7684\uff0c\u5f80\u5de6\u540c\u7406\u3002\n\n\u53ef\u4ee5\u53cc\u6307\u9488\uff0c\u5bf9\u4e8e\u6bcf\u4e2a $i$ \u6c42\u51fa $j$\u3002\n\n\u518d\u8003\u8651 $a$ \u6700\u5927\u503c\u5728\u53f3\u8fb9\uff0c$b$ \u6700\u5927\u503c\u5728\u5de6\u8fb9\u7684\u60c5\u51b5\u3002\u4f9d\u7136\u679a\u4e3e\u53f3\u7aef\u70b9 $i$\uff0c\u53ef\u4ee5\u5728\u5de6\u8fb9\u627e\u5230\u4e00\u6bb5\u533a\u95f4\uff08\u5f53\u7136\u4e5f\u53ef\u80fd\u6ca1\u6709\uff09$[j,k]$ \u4f7f\u5f97\u533a\u95f4\u4e2d\u6240\u6709\u4f4d\u7f6e\u90fd\u6ee1\u8db3\u6761\u4ef6\u3002\n\n\u8fd8\u662f\u53cc\u6307\u9488\u3002\n\n\u53e6\u5916\u4e24\u79cd\u60c5\u51b5\u540c\u7406\u3002\n\n```cpp\ninline void solve(int l, int r) {\n\tif (l > r) return;\n\tif (l == r) return void(ans += 1LL * a[l] * b[l]);\n\tint mid = l + r >> 1;\n\tsolve(l, mid); solve(mid + 1, r);\n\tal[mid + 1] = 0; ar[mid] = 0;\n\tbl[mid + 1] = 0; br[mid] = 0;\n\tfor (int i = mid; i >= l; i--) {\n\t\tal[i] = max(al[i + 1], a[i]);\n\t\tbl[i] = max(bl[i + 1], b[i]);\n\t}\n\tfor (int i = mid + 1; i <= r; i++) {\n\t\tar[i] = max(ar[i - 1], a[i]);\n\t\tbr[i] = max(br[i - 1], b[i]);\n\t}\n\tfor (int i = mid, j = mid; i >= l; i--) {\n\t\twhile (j < r && ar[j + 1] < al[i] && br[j + 1] < bl[i]) ++j;\n\t\tans += 1LL * al[i] * bl[i] * (j - mid);\n\t}\n\tfor (int i = mid + 1, j = mid + 1; i <= r; i++) {\n\t\twhile (j > l && ar[i] > al[j - 1] && br[i] > bl[j - 1]) --j;\n\t\tans += 1LL * ar[i] * br[i] * (mid + 1 - j);\n\t}\n\tULL s = 0;\n\tfor (int i = mid, j = mid, k = mid + 1; i >= l; i--) {\n\t\twhile (j < r && al[i] > ar[j + 1]) s += br[++j];\n\t\twhile (k <= j && bl[i] > br[k]) s -= br[k++];\n\t\tans += s * al[i];\n\t}\n\ts = 0;\n\tfor (int i = mid + 1, j = mid + 1, k = mid; i <= r; i++) {\n\t\twhile (j > l && ar[i] > al[j - 1]) s += bl[--j];\n\t\twhile (k >= j && br[i] > bl[k]) s -= bl[k--];\n\t\tans += s * ar[i];\n\t}\n}\n```\n## 100pts\n\n\u663e\u7136\u4e0d\u80fd\u5bf9\u6bcf\u4e00\u4e2a\u8be2\u95ee\u90fd\u6c42\u4e00\u904d\u7b54\u6848\uff0c\u8fd9\u4e2a\u65f6\u5019\u8981\u79bb\u7ebf\u3002\n\n\u8003\u8651\u628a\u8be2\u95ee\u6302\u5230\u5206\u6cbb\u7684\u533a\u95f4\u4e0a\u3002\n\n\u5bf9\u4e8e\u4e00\u4e2a\u5206\u6cbb\u7684\u533a\u95f4 $[i,j]$\uff1a\n\n\u5982\u679c $l\\le i\\le j\\le r$\uff0c\u90a3\u4e48\u6302\u4e0a\u53bb\u5e76\u8fd4\u56de\u3002\n\n\u5982\u679c\u8be2\u95ee\u8de8\u8fc7\u4e86\u4e2d\u70b9\uff0c\u5c31\u6302\u5728\u8fd9\u4e2a\u70b9\u4e0a\u5e76\u5f80\u5de6\u53f3\u5b50\u533a\u95f4\u9012\u5f52\u3002\n\n\u5982\u679c\u6ca1\u8de8\u8fc7\u4e2d\u70b9\u5c31\u5f80\u8be2\u95ee\u6240\u5728\u7684\u5b50\u533a\u95f4\u9012\u5f52\u3002\n\n\u8fd9\u6837\u6302\u7684\u6b21\u6570\u662f $O(\\log m)$ \u7684\u3002~~\u89c9\u5f97\u62bd\u8c61\u53ef\u4ee5\u770b\u4ee3\u7801\u91cc\u7684 `add`\u3002~~\n\n\u8fd8\u662f\u679a\u4e3e\u53f3\u7aef\u70b9 $i$\uff0c\u53cc\u6307\u9488\u5f97\u5230 $j,k$\uff0c\u5176\u4e2d $[j,k)$ \u4e2d\u90fd\u662f\u6ee1\u8db3 $a$ \u6700\u5927\u503c\u5728\u53f3\u800c $b$ \u6700\u5927\u503c\u5728\u5de6\u7684\u5de6\u7aef\u70b9\uff0c$[k,mid]$ \u4e2d\u90fd\u662f\u6ee1\u8db3\u4e24\u4e2a\u6700\u5927\u503c\u90fd\u5728\u53f3\u7684\u5de6\u7aef\u70b9\u3002\n\n\u6bcf\u6b21\u53f3\u7aef\u70b9\u7684\u53f3\u79fb\u90fd\u4f1a\u4f7f\u7b54\u6848\u8fd9\u6837\u53d8\u5316\uff1a\n\n\u5bf9\u4e8e\u6bcf\u4e2a\u5728 $[j,k)$ \u4e2d\u7684\u5de6\u7aef\u70b9 $L$ \u5206\u522b\u52a0\u4e0a $A(mid+1,i)\\times B(L,mid)$\uff1b\n\n\u5bf9\u533a\u95f4 $[k,mid]$ \u4e2d\u7684\u6bcf\u4e00\u4e2a\u90fd\u52a0\u4e0a $A(mid+1,i)\\times B(mid+1,i)$\u3002\n\n\u5982\u679c $i$ \u662f\u67d0\u4e2a\u8be2\u95ee\u7684\u53f3\u7aef\u70b9\uff08\u8bb0\u4e3a $[L_2,i]$\uff09\uff0c\u5c31\u628a $[L_2,mid]$ \u533a\u95f4\u4e2d\u7684\u5de6\u7aef\u70b9\u7684\u7b54\u6848\u52a0\u8d77\u6765\u3002\n\n\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u8fd9\u4e2a\u4e1c\u897f\u3002\n\n\u53e6\u5916\u7684\u60c5\u51b5\u4e5f\u540c\u7406\u3002\n\n```cpp\n#define lx x << 1\n#define rx x << 1 | 1\ntypedef unsigned long long ULL;\nconst int N = 3e5 + 5;\nint n, num, m;\nULL a[N], b[N], amx[N], bmx[N], ans[N << 2], Ans[N];\nstruct Node {\n\tint l, r;\n} h[N];\nvector <int> t[N << 2], er[N], el[N];\nstruct SGT {\n\tULL sum[N << 2], sumb[N << 2], tag[N << 2];\n\tinline void pushup(int x) {\n\t\tsum[x] = sum[lx] + sum[rx];\n\t\tsumb[x] = sumb[lx] + sumb[rx];\n\t}\n\tinline void pushdown(int x) {\n\t\tif (!tag[x]) return;\n\t\tsum[lx] += tag[x] * sumb[lx];\n\t\tsum[rx] += tag[x] * sumb[rx];\n\t\ttag[lx] += tag[x]; tag[rx] += tag[x];\n\t\ttag[x] = 0;\n\t}\n\tinline void build(int x, int L, int R, int op) {\n\t\tsum[x] = tag[x] = 0;\n\t\tif (L == R) return void(sumb[x] = op ? bmx[L] : 1);\n\t\tint mid = L + R >> 1;\n\t\tbuild(lx, L, mid, op);\n\t\tbuild(rx, mid + 1, R, op);\n\t\tpushup(x);\n\t}\n\tinline void change(int x, int l, int r, ULL w, int L, int R) {\n\t\tif (l <= L && R <= r) {\n\t\t\tsum[x] += w * sumb[x];\n\t\t\ttag[x] += w; return;\n\t\t}\n\t\tpushdown(x);\n\t\tint mid = L + R >> 1;\n\t\tif (l <= mid) change(lx, l, r, w, L, mid);\n\t\tif (r > mid) change(rx, l, r, w, mid + 1, R);\n\t\tpushup(x);\n\t}\n\tinline ULL query(int x, int l, int r, int L, int R) {\n\t\tif (l <= L && R <= r) return sum[x];\n\t\tpushdown(x);\n\t\tint mid = L + R >> 1; ULL res = 0;\n\t\tif (l <= mid) res += query(lx, l, r, L, mid);\n\t\tif (r > mid) res += query(rx, l, r, mid + 1, R);\n\t\treturn res;\n\t}\n} T[2];\ninline void add(int x, int l, int r, int id) {\n\tif (h[id].l <= l && r <= h[id].r) {\n\t\tt[x].push_back(id);\n\t\treturn;\n\t}\n\tint mid = l + r >> 1;\n\tif (h[id].r <= mid) add(lx, l, mid, id);\n\telse if (h[id].l > mid) add(rx, mid + 1, r, id);\n\telse {\n\t\tt[x].push_back(id);\n\t\tadd(lx, l, mid, id);\n\t\tadd(rx, mid + 1, r, id);\n\t}\n}\ninline void solve(int x, int l, int r) {\n\tif (l > r) return;\n\tif (l == r) {\n\t\tans[x] = a[l] * b[l];\n\t\tfor (int p : t[x]) Ans[p] += ans[x];\n\t\treturn;\n\t}\n\tint mid = l + r >> 1; solve(lx, l, mid); solve(rx, mid + 1, r); ans[x] = ans[lx] + ans[rx];\n\tfor (int i = l; i <= r; i++) {\n\t\tel[i].clear();\n\t\ter[i].clear();\n\t}\n\tvector <int> tmp;\n\tfor (int p : t[x]) {\n\t\tif (h[p].r >= r && h[p].l <= l) tmp.push_back(p);\n\t\telse {\n\t\t\ter[min(h[p].r, r)].push_back(p);\n\t\t\tel[max(h[p].l, l)].push_back(p);\n\t\t}\n\t}\n\tamx[mid] = a[mid]; amx[mid + 1] = a[mid + 1];\n\tbmx[mid] = b[mid]; bmx[mid + 1] = b[mid + 1];\n\tfor (int i = mid - 1; i >= l; i--) {\n\t\tamx[i] = max(a[i], amx[i + 1]);\n\t\tbmx[i] = max(b[i], bmx[i + 1]);\n\t}\n\tfor (int i = mid + 2; i <= r; i++) {\n\t\tamx[i] = max(a[i], amx[i - 1]);\n\t\tbmx[i] = max(b[i], bmx[i - 1]);\n\t}\n\tT[0].build(1, l, mid, 0); T[1].build(1, l, mid, 1);\n\tfor (int i = mid + 1, j = mid + 1, k = mid + 1; i <= r; i++) {\n\t\twhile (j > l && amx[j - 1] < amx[i]) j--;\n\t\twhile (k > j && bmx[k - 1] < bmx[i]) k--;\n\t\tif (k <= mid) T[0].change(1, k, mid, amx[i] * bmx[i], l, mid);\n\t\tif (j < k) T[1].change(1, j, k - 1, amx[i], l, mid);\n\t\tfor (int p : er[i]) {\n\t\t\tint L = max(l, h[p].l);\n\t\t\tAns[p] += T[0].query(1, L, mid, l, mid);\n\t\t\tAns[p] += T[1].query(1, L, mid, l, mid);\n\t\t}\n\t}\n\tans[x] += T[0].query(1, l, mid, l, mid) + T[1].query(1, l, mid, l, mid);\n\tT[0].build(1, mid + 1, r, 0); T[1].build(1, mid + 1, r, 1);\n\tfor (int i = mid, j = mid, k = mid; i >= l; i--) {\n\t\twhile (j < r && amx[j + 1] < amx[i]) j++;\n\t\twhile (k < j && bmx[k + 1] < bmx[i]) k++;\n\t\tif (k > mid) T[0].change(1, mid + 1, k, amx[i] * bmx[i], mid + 1, r);\n\t\tif (k < j) T[1].change(1, k + 1, j, amx[i], mid + 1, r);\n\t\tfor (int p : el[i]) {\n\t\t\tint R = min(r, h[p].r);\n\t\t\tAns[p] += T[0].query(1, mid + 1, R, mid + 1, r);\n\t\t\tAns[p] += T[1].query(1, mid + 1, R, mid + 1, r);\n\t\t}\n\t}\n\tans[x] += T[0].query(1, mid + 1, r, mid + 1, r) + T[1].query(1, mid + 1, r, mid + 1, r);\n\tfor (int p : tmp) Ans[p] += ans[x];\n}\ninline void Solve() {\n\tnum = read(); n = read();\n\tfor (int i = 1; i <= n; i++) a[i] = read();\n\tfor (int i = 1; i <= n; i++) b[i] = read();\n\tm = read();\n\tfor (int i = 1; i <= m; i++) {\n\t\th[i].l = read();\n\t\th[i].r = read();\n\t\tadd(1, 1, n, i);\n\t}\n\tsolve(1, 1, n);\n\tfor (int i = 1; i <= m; i++) printf(\"%llu\\n\", Ans[i]);\n}\n```",
        "postTime": 1671002486,
        "uid": 246099,
        "name": "dalao_see_me",
        "ccfLevel": 6,
        "title": "P8868 \u9898\u89e3"
    },
    {
        "content": "\u672c\u9898\u89e3\u4e3a**\u7ebf\u6bb5\u6811\u7ef4\u62a4\u533a\u95f4\u5386\u53f2\u7248\u672c\u548c**\u505a\u6cd5\uff0c\u8bb2\u89e3\u81ea\u8ba4\u4e3a\u8f83\u8be6\u7ec6\u3002\n\n## \u9898\u610f\n\n\u7ed9\u5b9a $a_{1,\\dots,n}, b_{1,\\dots,n}$\uff0c\u4ee5\u53ca $m$ \u4e2a\u8be2\u95ee, \u6bcf\u6b21\u8be2\u95ee\u7ed9\u51fa $l, r$ \u6c42\uff1a\n\n$$\\sum_{p=l}^{r}\\sum_{q=p}^{r}(\\max_{i=p}^{q}a_i) \\times (\\max_{i=p}^{q}b_i)$$\n\n\u6570\u636e\u8303\u56f4\uff1a$n,m \\leq 2.5 \\times 10^5$\u3002\n\n## \u9898\u89e3\n\n### 52 pts \u505a\u6cd5\n\n\u53d1\u73b0 $n \\times m$ \u4e3a $10^6$ \u7ea7\u522b\uff0c\u8003\u8651\u63a5\u8fd1 $O(nm)$ \u7684\u505a\u6cd5\u3002\n\n\u5bf9\u4e8e\u533a\u95f4\u6700\u5927\u503c\u6c42\u548c\u95ee\u9898\uff0c\u4e00\u79cd\u5e38\u89c1\u7684\u65b9\u6cd5\u662f\u8003\u8651\u6bcf\u4e2a\u6570\u7684\u8d21\u732e\u3002  \n\u6240\u4ee5\uff0c\u4ee4 $apre_i$ \u8868\u793a $1 \\sim i$ \u4e2d\u6700\u5927\u7684 $j$ \u6ee1\u8db3 $a_j \\gt a_i$\uff0c$bpre_i$ \u540c\u7406\u3002  \n$apre_i, bpre_i$ \u53ef\u4ee5\u4f7f\u7528\u5355\u8c03\u6808 $O(n)$ \u5f97\u5230\u3002\n\n\u4f9d\u6b21\u8003\u8651\u5b50\u533a\u95f4\u53f3\u8fb9\u754c\u4ece $l$ \u5230 $r$ \u9012\u589e\u3002\n\n\u53f3\u8fb9\u754c $q$ \u786e\u5b9a\u65f6\uff0c\u4e3a\u8868\u793a\u65b9\u4fbf\uff0c\u4ee4 $A_p = \\max_{i=p}^{q}a_i, B_p = \\max_{i=p}^{q}b_i$\u3002  \n\n\u53ef\u4ee5\u53d1\u73b0\uff0c\u5f53\u53f3\u8fb9\u754c $q$ \u6269\u5c55\u5230 $k$ \u65f6\uff0c$A_p$ \u5728 $1 \\sim apre_k$ \u5904\u7684\u503c\u4e0d\u53d8\uff0c\u5728 $apre_k + 1 \\sim k$ \u5904\u7684\u503c\u53d8\u4e3a $a_k$\u3002$B_p$ \u540c\u7406\u3002  \n\u56e0\u6b64\uff0c\u6211\u4eec\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u5e8f\u5217 $A_p, B_p$ \u548c $\\sum_{p=l}^{q}A_p \\times B_p$\uff0c\u652f\u6301\u533a\u95f4\u8d4b\u503c $A_p, B_p$\u3002  \n\u7b54\u6848\u4e3a $\\sum_{q=l}^{r}(\\sum_{p=l}^{q}A_p \\times B_p)$\u3002\n\n\u603b\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(m n \\log n)$\uff0c\u9884\u671f 52 pts\u3002\n\n### 100 pts \u505a\u6cd5\n\n\u53ef\u4ee5\u53d1\u73b0\uff0c\u5f53\u53f3\u8fb9\u754c $q$ \u6269\u5c55\u5230 $k$ \u65f6\uff0c\u5e8f\u5217\u7684\u4fee\u6539\u4e0e\u8be2\u95ee\u7684 $l$ \u65e0\u5173\uff0c\u4e14\u4e0d\u4f1a\u4fee\u6539 $A_{k+1,\\dots,n}, B_{k+1,\\dots,n}$\u3002  \n\u6240\u4ee5\uff0c\u53f3\u8fb9\u754c $q$ \u4ece $1$ \u5f00\u59cb\u8fd8\u662f\u4ece $l$ \u5f00\u59cb\u4e0d\u4f1a\u5f71\u54cd\u8be2\u95ee\u7684\u7b54\u6848\u3002\n\n\u7531\u6b64\u53ef\u77e5\uff0c\u4ee5\u4e0b\u505a\u6cd5\u4e5f\u662f\u6b63\u786e\u7684\uff1a\n\n$A_p, B_p$ \u521d\u59cb\u503c\u4e3a $0$\u3002  \n\u4ee4 $q$ \u4f9d\u6b21\u6269\u5c55\u5230 $1 \\sim n$\uff0c\u7ef4\u62a4 $A_p, B_p, \\sum A_p \\times B_p$\u3002  \n\u7136\u540e\u5c06\u6240\u6709 $r \\ge q$ \u7684\u8be2\u95ee\u7684\u7b54\u6848\u589e\u52a0 $\\sum_{p=l}^{r}A_p \\times B_p$\u3002\n\n\u56e0\u6b64\uff0c\u6bcf\u4e00\u4e2a\u8be2\u95ee\u7684\u7b54\u6848\u662f $r = q$ \u65f6 $\\sum_{p=l}^{r}A_p \\times B_p$ \u7684\u5386\u53f2\u7248\u672c\u548c\u3002\n\n---\n\n\u4ee5\u4e0b\u8bb2\u89e3\u5982\u4f55\u7ef4\u62a4\u533a\u95f4\u5386\u53f2\u7248\u672c\u548c\u3002\n\n\u5bf9\u4e8e\u666e\u901a\u7684\u533a\u95f4\u5386\u53f2\u7248\u672c\u548c\uff0c2016 \u5e74\u96c6\u8bad\u961f\u8bba\u6587\u4e2d\u6709\u4ecb\u7ecd\u3002\n![](https://cdn.luogu.com.cn/upload/image_hosting/khxm4021.png)\n\n\u7c7b\u6bd4\u7740\u505a\uff0c\u4ee4 $S_i = A_i \\times B_i$\uff0c\u8bbe $Ans_i$ \u4e3a\u5386\u53f2\u7248\u672c\u548c\uff0c\u540c\u65f6\u6211\u4eec\u8ba9 $gt$ \u4e3a\u5f53\u524d\u7ed3\u675f\u7684\u65f6\u95f4\uff08\u4e8c\u8005\u5747\u4e0d\u5305\u542b\u5f53\u524d\u64cd\u4f5c\uff09\u3002\u540c\u6837\uff0c\u5b9a\u4e49 $C_i$\uff0c\u6bcf\u4e00\u65f6\u523b\u7ed3\u675f\u90fd\u8ba9 $C_i = Ans_i - gt \\cdot S_i$\u3002\n\n\u4ee4 $x'$ \u8868\u793a\u4fee\u6539\u524d\u7684 $x$ \u4fe1\u606f\uff0c$\\Delta x$ \u8868\u793a\u4fee\u6539\u524d\u540e $x$ \u7684\u53d8\u5316\u91cf\u3002\n\n$$\\begin{aligned}\\Delta C_i\n&= \\Delta Ans_i - \\Delta(gt \\cdot S_i) \\\\ \n&= \\Delta gt \\cdot S_i' - (gt' + \\Delta gt)\\cdot(S_i' + \\Delta S_i) + gt' \\cdot S_i' \\\\ \n&= -\\Delta gt \\cdot \\Delta S_i -gt' \\cdot \\Delta S_i \\\\ \n&= -(gt' + \\Delta gt) \\cdot \\Delta S_i \\\\ \n&= -gt \\cdot \\Delta S_i\n\\end{aligned}$$\n\n\u7ef4\u62a4\u7ebf\u6bb5\u6811\u6807\u8bb0\u903b\u8f91\u5f88\u9ebb\u70e6\uff0c\u6211\u4eec\u8003\u8651\u501f\u52a9\u77e9\u9635\u7406\u89e3\u3002\n\n\u5148\u786e\u5b9a\u72b6\u6001\u77e9\u9635\uff08\u884c\u5411\u91cf\uff09\u5982\u4e0b\uff1a\n\n$$\\begin{bmatrix} \\sum S_i & \\sum A_i & \\sum B_i & len & \\sum C_i\\end{bmatrix}$$\n\n\u5176\u4e2d $len$ \u4e3a\u5f53\u524d\u533a\u95f4\u7684\u957f\u5ea6\u3002  \n\u53ef\u5f97\u8f6c\u79fb\u77e9\u9635\uff1a\n\n$$\\begin{bmatrix}\n[a=b=0] & 0 & 0 & 0 & c \\\\ \n[a=0]b & [a=0] & 0 & 0 & ca \\\\ \n[b=0]a & 0 & [b=0] & 0 & cb \\\\ \na \\cdot b & a & b & 1 & cl \\\\ \n0 & 0 & 0 & 0 & 1\n\\end{bmatrix}$$\n\n\u5176\u4e2d $a$ \u975e\u96f6\u65f6\u8868\u793a\u5c06\u533a\u95f4\u4e2d\u6240\u6709 $A_i$ \u8d4b\u503c\u4e3a $a$\uff0c$b$ \u540c\u7406\uff0c$c, ca, cb, cl$ \u4ec5\u4f9b\u8ba1\u7b97\u3002  \n\u8be5\u77e9\u9635\u4e2d\u5de6\u4e0a $4 \\times 4$ \u7684\u90e8\u5206\u548c $52$ pts \u7684\u6807\u8bb0\u662f\u7b49\u4ef7\u7684\uff0c\u7ed3\u5408\u5b9e\u9645\u610f\u4e49\u7ef4\u62a4\u5373\u53ef\uff0c\u800c $\\sum C_i$ \u6211\u4eec\u9009\u62e9\u7528\u77e9\u9635\u7ef4\u62a4\u3002\n\n\u8fd9\u91cc\u662f\u6211\u5bf9\u8be5\u6807\u8bb0\u7684\u5b9e\u73b0\uff1a\n\n```cpp\nstruct Tag {\n\tull a, b;\n\tull c, ca, cb, cl;\n\tinline bool empty() const {\n\t\treturn !(a || b || c || ca || cb || cl);\n\t}\n\tinline void clear() {\n\t\ta = b = 0;\n\t\tc = ca = cb = cl = 0;\n\t}\n\tinline void add(const Tag &t) {\n\t\tif (this->empty()) return (void) (*this = t);\n\t\t// matrix 1\n\t\tconst ull a1s = a ? 0 : b, b1s = b ? 0 : a;\n\t\tconst ull a1a = a ? 0 : 1, b1b = b ? 0 : 1;\n\t\tconst ull l1s = a*b, l1a = a, l1b = b;\n\t\tconst ull s1c = c, a1c = ca, b1c = cb, l1c = cl;\n\t\t// matrix 2\n\t\tconst ull s2c = t.c, a2c = t.ca, b2c = t.cb, l2c = t.cl;\n\t\t// matrix result\n\t\tconst ull sc =                                       s1c*1;\n\t\tconst ull ac = a1s*s2c + a1a*a2c                   + a1c*1;\n\t\tconst ull bc = b1s*s2c           + b1b*b2c         + b1c*1;\n\t\tconst ull lc = l1s*s2c + l1a*a2c + l1b*b2c + 1*l2c + l1c*1;\n\t\t// assign\n\t\tc = sc, ca = ac, cb = bc, cl = lc;\n\t\tif (t.a) a = t.a;\n\t\tif (t.b) b = t.b;\n\t}\n};\n```\n\n\u5176\u4e2d `add` \u65b9\u6cd5\u4e3a\u5408\u5e76\u4e24\u4e2a\u6807\u8bb0\uff08\u8f6c\u79fb\u77e9\u9635\uff09\u3002  \nP.S. `add` \u65b9\u6cd5\u7684\u4ee3\u7801\u590d\u6742\u7a0b\u5ea6\u8f83\u9ad8\uff0c\u5efa\u8bae\u4ee5\u53ef\u8bfb\u6027\u4e3a\u91cd\u70b9\uff0c\u76f8\u4fe1\u73b0\u4ee3\u7f16\u8bd1\u5668\u662f\u5b8c\u5168\u80fd\u591f\u4f18\u5316\u8fd9\u7b80\u5355\u7684\u903b\u8f91\u7684\u3002\n\n\n\u5c06\u6807\u8bb0\u5e94\u7528\u4e8e\u7ebf\u6bb5\u6811\u4e0a\u7684\u8282\u70b9\uff1a\n\n```cpp\nstruct Node {\n\tull s, sa, sb, c;\n\tTag tag;\n} tree[N*4+10];\n\ninline void set_val(int p, int l, int r, const Tag &tag) {\n\tNode &self = tree[p];\n\tconst ull len = r - l + 1;\n\tconst ull s = self.s, sa = self.sa, sb = self.sb;\n\tif (tag.a && tag.b) {\n\t\tself.s = tag.a * tag.b * len;\n\t\tself.sa = tag.a * len;\n\t\tself.sb = tag.b * len;\n\t} else if (tag.a) {\n\t\tself.s = tag.a * sb;\n\t\tself.sa = tag.a * len;\n\t} else if (tag.b) {\n\t\tself.s = tag.b * sa;\n\t\tself.sb = tag.b * len;\n\t}\n\tself.c += tag.c * s + tag.ca * sa + tag.cb * sb + tag.cl * len;\n\tself.tag.add(tag);\n\t// if (l < r) push_down(p, l, r);\n\t// tree[p].tag = tag;\n}\n```\n\nP.S. \u8fd9\u91cc\u6709\u4e2a\u8c03\u8bd5\u7684\u5c0f\u6280\u5de7\uff0c\u56e0\u4e3a\u5408\u5e76\u4e24\u4e2a\u6807\u8bb0\u5f88\u96be\u8c03\u8bd5\uff0c\u6240\u4ee5\u8c03\u8bd5\u65f6\u901a\u8fc7\u518d\u6b21\u4e0b\u4f20\u6807\u8bb0\u907f\u514d\u5408\u5e76\uff0c\u4ece\u800c\u65b9\u4fbf\u5176\u5b83\u90e8\u5206\u7684\u8c03\u8bd5\u3002\u4e0d\u8fc7\u8fd9\u4f1a\u5bfc\u81f4\u7ebf\u6bb5\u6811\u65f6\u95f4\u590d\u6742\u5ea6 $O(n^2)$\uff0c\u4f46\u8c03\u8bd5\u65f6\u53ef\u4ee5\u63a5\u53d7\u3002\n\n\u5f53\u6211\u4eec\u628a\u4e00\u6bb5\u533a\u95f4\u7684 $A_i$ \u8d4b\u503c\u4e3a $v$ \u65f6\uff0c\u4ee5\u4e0a\u77e9\u9635 $a = v, b = 0$\u3002  \n$\\sum C_i$ \u53ef\u7531 $\\Delta C_i = -gt \\cdot \\Delta S_i$ \u63a8\u5bfc\uff0c\u5f97\u5230 $c = gt, ca = 0, cb = -v \\cdot gt, cl = 0$\u3002\n\n\u540c\u7406\u5f97\u628a $B_i$ \u8d4b\u503c\u4e3a $v$ \u65f6\uff0c$a = 0, b = v, c = gt, ca = -v \\cdot gt, cb = 0, cl = 0$\u3002\n\n\u6240\u4ee5\u6269\u5c55\u53f3\u8fb9\u754c\u65f6\u7684\u4ee3\u7801\u5982\u4e0b\uff1a\n\n```cpp\n++cntR; // \u6269\u5c55\u53f3\u8fb9\u754c\null a = arr[cntR].val, b = brr[cntR].val, gt = cntR;\nupdate(1, 1, n, arr[cntR].pre + 1, cntR, Tag { a, 0, gt, 0, -gt*a, 0 });\nupdate(1, 1, n, brr[cntR].pre + 1, cntR, Tag { 0, b, gt, -gt*b, 0, 0 });\n```\n\n\u5bf9\u4e8e\u67e5\u8be2\uff0c\u6ce8\u610f $Ans_i$ \u662f\u4e0d\u5305\u542b\u5f53\u524d\u64cd\u4f5c\u7684\uff0c\u6240\u4ee5\u67e5\u8be2\u7684\u7b54\u6848\u4e3a $\\sum_{i=l}^{r} C_i + (gt + 1) \\cdot S_i$\u3002\n\n\u603b\u65f6\u95f4\u590d\u6742\u5ea6 $O(n \\log n)$\uff0c\u9884\u671f 100 pts\u3002\n\n[\u5b8c\u6574\u4ee3\u7801](https://www.luogu.com.cn/paste/fm6c7wd4)\u3002\n\n\n",
        "postTime": 1670546395,
        "uid": 561644,
        "name": "CuiZhenhang",
        "ccfLevel": 0,
        "title": "[NOIP 2022] T4 \u6bd4\u8d5b \u9898\u89e3"
    },
    {
        "content": "\u9996\u5148\u79bb\u7ebf\u4e4b\u540e\u5bb9\u6613\u8f6c\u6362\u6210\u6709\u4e24\u4e2a\u5e8f\u5217 $a$ \u548c $b$\uff0c\u7136\u540e\u5bf9 $a,b$ \u533a\u95f4\u52a0\uff0c\u7136\u540e\u6c42 $\\sum a_ib_i$ \u7684\u5386\u53f2\u548c\u3002\n\n\u9996\u5148\u8003\u8651\u53ea\u6709\u4e00\u7ef4\u7684\u5386\u53f2\u548c\u662f\u600e\u4e48\u505a\u7684\uff0c\u8fd9\u662f\u4e2a\u7ecf\u5178\u7684\u95ee\u9898\uff0c\u5982\u679c\u4f60\u53bb\u7f51\u4e0a\u641c\u9898\u89e3\uff0c\u51e0\u4e4e\u6240\u6709\u7684\u505a\u6cd5\u90fd\u662f\u6253\u4e09\u4e2a\u6807\u8bb0\u3002\n\n\u4f46\u662f\u8fd9\u6709\u4e2a\u66f4\u597d\u7684\u7406\u89e3\u65b9\u5f0f\uff1a\u4f7f\u7528\u77e9\u9635\u7ef4\u62a4\u957f\u5ea6\uff0c\u5f53\u524d\u7684\u548c\u548c\u5386\u53f2\u548c\uff0c\u7136\u540e\u8fd9\u6837\u6bcf\u4e2a\u8282\u70b9\u90fd\u662f\u4e24\u4e2a\u53f6\u5b50\u7684\u548c\uff0c\u7136\u540e\u77e9\u9635\u4e58\u6cd5\u6709\u7ed3\u5408\u5f8b\u548c\u5206\u914d\u7387\uff0c\u90a3\u4e48\u6253 tag \u5373\u53ef\u3002\n\n\u90a3\u4e48\u539f\u9898\u4e5f\u975e\u5e38\u7b80\u5355\u4e86\uff0c\u77e9\u9635\u7ef4\u62a4\u957f\u5ea6\uff0c\u5e8f\u5217 $a$ \u7684\u548c\uff0c\u5e8f\u5217 $b$ \u7684\u548c\uff0c $a_ib_i$ \u7684\u548c\u548c\u5386\u53f2\u548c\u3002\n\n\u76f4\u63a5\u5199\u77e9\u9635\u4e58\u6cd5\u4f1a TLE\uff0c\u6ce8\u610f\u5230\u4f60\u9700\u8981\u7ef4\u62a4\u7684\u77e9\u9635\u672c\u8d28\u4e0d\u540c\u7684\u6570\u53ea\u6709 $7$ \u4e2a\uff0c\u76f4\u63a5\u7ef4\u62a4\u90a3 $7$ \u4e2a\u6570\u7136\u540e\u624b\u52a8\u77e9\u4e58\u5373\u53ef\u3002\n\n[\u6734\u7d20\u5b9e\u73b0](https://www.luogu.com.cn/paste/zp5fg5z2) [\u80fd\u8fc7\u6d1b\u8c37\u6c11\u95f4\u6570\u636e\u7684\u5b9e\u73b0](https://www.luogu.com.cn/paste/sdmubcwv)\u3002\n\n\n----\n\n\u6240\u4ee5\u8bf4\u56db\u4e2a\u7b80\u5355\u9898\u7684 noip \u6211\u662f\u600e\u4e48\u6253\u51fa\u6765\u8fd9\u4e48\u70c2\u7684\u6210\u7ee9\u7684\uff1f\uff1f\u592a\u5c0f\u4e11\u4e86\u5427\u3002",
        "postTime": 1669897465,
        "uid": 141179,
        "name": "pigstd",
        "ccfLevel": 9,
        "title": "noip T4 \u4e0d\u7528\u52a8\u8111\u5b50\u7684\u505a\u6cd5"
    },
    {
        "content": "[\u53ef\u80fd\u66f4\u597d\u7684\u9605\u8bfb\u4f53\u9a8c](https://charleswu.site/archives/2455)\n\n**[\u6d1b\u8c37\u9898\u5e93 P8868 [NOIP2022] \u6bd4\u8d5b](https://www.luogu.com.cn/problem/P8868)**\n\n\u672c\u6587\u8bb0\u53f7\u53ef\u80fd\u7a0d\u663e\u51cc\u4e71\uff0c\u4f46\u90fd\u80fd\u5728\u9898\u9762\u6216\u8005\u524d\u6587\u4e2d\u627e\u5230\u5b9a\u4e49\u3002\n## \u90e8\u5206\u5206\n### $\\text{20 pts}$ - $n,Q\\leq 3000$\n\u8003\u8651\u679a\u4e3e\u6240\u6709 $\\operatorname{O}(n^2)$ \u4e2a\u533a\u95f4\uff0c\u9884\u5148\u8ba1\u7b97\u5b83\u4eec\u672c\u8eab\u7684\u7b54\u6848\u3002\u8bb0\n$$\\begin{aligned}g_a(l,r)&=\\begin{cases}\\max\\{a_i\\mid l\\leq i\\leq r\\},&(1\\leq l\\leq r\\leq n)\\\\0&\\text{otherwise}\\end{cases}\\\\g_b(l,r)&=\\begin{cases}\\max\\{b_i\\mid l\\leq i\\leq r\\},&(1\\leq l\\leq r\\leq n)\\\\0&\\text{otherwise}\\end{cases}\\end{aligned}$$\n\u5219\u505a\u524d\u7f00\u548c $s(l,r)=\\sum_{i=l}^{r}g_a(l,i)g_b(l,i)$\uff0c\u5bf9\u4e8e\u8be2\u95ee $[\\text{ql},\\text{qr}]$ \u53ea\u9700\u56de\u7b54 $\\sum_{i=\\text{ql}}^{\\text{qr}}s(i,\\text{qr})$ \u5373\u53ef\u3002\n\n\u4ee4 $n, Q$ \u540c\u9636\uff0c\u65f6\u7a7a\u590d\u6742\u5ea6 $\\operatorname{O}(n^2)$\u3002\n### $\\text{32 pts}$ - $n\\leq 2.5\\times 10^5, Q\\leq 5$\n\u601d\u8003\u5355\u72ec\u8ba1\u7b97\u6bcf\u4e2a\u8be2\u95ee\u7684\u7b54\u6848\u3002\n\n\u8bbe $\\operatorname{lbd}(i)$ \u6ee1\u8db3 $(\\operatorname{lbd}(i)=1\\lor a_{\\operatorname{lbd}(i)-1}>a_i)\\land \\max\\{a_j\\mid \\operatorname{lbd}(i)\\leq j<i\\}<a_i$\uff0c\u4e5f\u5373 $g_a(l,r)=\\max\\{a_j\\mid l\\leq j\\leq r\\}=a_i$\uff0c\u5e94\u6ee1\u8db3 $\\operatorname{lbd}(i)\\leq l\\leq i$\uff1b$\\operatorname{rbd}(i)$ \u540c\u7406\u3002\u5b83\u4eec\u53ef\u4ee5\u7531\u524d\u540e\u4e24\u904d\u5355\u8c03\u6808 $\\operatorname{O}(n)$ \u6c42\u51fa\u3002\n\n\u5bf9\u4e8e\u8be2\u95ee $[\\text{ql},\\text{qr}]$\uff0c*\u4ece $a$ \u7684\u89d2\u5ea6\u51fa\u53d1\u8003\u8651\u8d21\u732e*\u3002\u8bb0\n$$f_b(p,i,j,q)=\\sum_{l=p}^{i}\\sum_{r=j}^{q} g_b(l,r)\\quad(p\\leq i\\land j\\leq q)$$\n\u82e5\u5bf9\u4e8e\u6240\u6709 $i\\in[\\text{ql},\\text{qr}]$\uff0c\u6211\u4eec\u80fd\u6c42\u51fa $f_b(\\max(\\operatorname{lbd}(i),\\text{ql}),i,i,\\min(\\operatorname{rbd}(i),\\text{qr}))$\uff0c\u90a3\u4e48\u5c06\u5176\u4e58\u4e0a $a_i$ \u7d2f\u52a0\u5230\u7b54\u6848\u4e2d\u3002\n\n\u8bbe\u60f3\u4e00\u4e2a\u77e9\u9635 $\\mathbf{B}$\uff0c\u6709 $\\mathbf{B}_{l,r}=g_b(l,r)$\uff0c\u5219\u73b0\u5728\u6211\u4eec\u6709 $\\text{qr}-\\text{ql}+1$ \u4e2a\u4e0a\u8ff0\u8be2\u95ee\uff0c\u8981\u6c42\u51fa\u77e9\u9635\u533a\u57df\u548c\u3002\n\n\u5982\u679c\u6211\u4eec\u53ea\u8ba1\u7b97\u4e00\u5217\u4e2d\u8fde\u7eed\u51e0\u884c\u5143\u7d20\u7684\u548c\uff0c\u5b83\u662f\u4e00\u4e2a\u7ecf\u5178\u626b\u63cf\u7ebf\u95ee\u9898\uff1a\u501f\u52a9**\u5355\u8c03\u6808**\u548c**\u533a\u95f4\u52a0\u7ebf\u6bb5\u6811**\uff0c\u6211\u4eec\u80fd\u8f7b\u677e\u7ef4\u62a4\u201c\u5728 $r$ \u5206\u522b\u4e3a $1,2,\\cdots,n$ \u65f6\uff0c\u4efb\u610f $l\\ (l\\leq r)$ \u7684 $g_b(l,r)$\u201d\u3002\u66f4\u5177\u4f53\u5730\uff0c\u6211\u4eec\u7ef4\u62a4\u4e00\u4e2a $b$ \u7684\u6700\u5927\u503c\u5355\u8c03\u6808\uff0c\u5e76\u4ece\u5c0f\u5230\u5927\u679a\u4e3e $r$\u3002\u8bb0\u73b0\u5728\u5355\u8c03\u6808\u4fdd\u5b58\u7684\u4e0b\u6807\u4e3a $t_1,t_2,\\cdots,t_k$\uff0c\u4ee4 $t_0=0$\uff0c\u6ee1\u8db3 $\\forall i \\in [1, k),b_{t_i}>b_{t_{i+1}}$\u3002\u6211\u4eec\u8bd5\u56fe\u5c06 $r$ \u538b\u5165\u6808\u4e2d\uff0c\u8003\u8651 $g_b(l,r-1)$ \u600e\u6837\u53d8\u5316\u5230 $g_b(l,r)$\u3002\u5f53\u6211\u4eec\u5f39\u51fa $t_i$ \u65f6\uff0c\u663e\u7136\u6709 $\\forall l\\in(t_{i-1},t_i],g_b(l,r-1)=b_{t_i},g_b(l,r)=b_r\\Rightarrow g_b(l,r)-g_b(l,r-1)=b_r-b_{t_i}$\u3002\u4e8e\u662f\u5728\u5f39\u51fa\u8fc7\u7a0b\u4e2d\uff0c\u5728\u7ebf\u6bb5\u6811\u4e0a\u5bf9\u533a\u95f4 $(t_{i-1},t_i]$ \u4e2d\u6bcf\u4e2a\u5143\u7d20\u52a0\u4e0a $b_r-b_{t_i}$\uff0c\u5373\u53ef\u7ef4\u62a4 $r$ \u65f6\u7684 $g_b(l,r)$\uff1b\u81ea\u7136\uff0c\u5982\u679c $l$ \u5728\u5f39\u51fa\u8fc7\u7a0b\u4e2d\u672a\u88ab\u6ce2\u53ca\uff0c\u5219 $g_b(l,r)=g(l,r-1)$\u3002\uff08\u6700\u540e\u5355\u70b9\u66f4\u65b0 $g_b(r,r)=b_r$\uff09\n\n\u4f46\u6211\u4eec\u8981\u8ba1\u7b97\u7684\u662f\u82e5\u5e72\u8fde\u7eed\u5217\u7684\u548c\u3002\u5148\u5229\u7528\u524d\u7f00\u548c\u7b80\u5316\uff1a\u6709 $f_b(p,i,j,q)=f_b(p,i,1,q)-f_b(p,i,1,j-1)$\u3002$f_b(p,i,1,q)$ \u5373\u4e0a\u8ff0\u8fc7\u7a0b\u4e2d\u7ebf\u6bb5\u6811\u4e0a\u533a\u95f4 $[p,i]$ \u5185\u5143\u7d20\u524d $q$ \u8f6e\u7684***\u5386\u53f2\u7248\u672c\u548c***\u3002\u4e0d\u59a8\u8003\u8651\u4e0a\u8ff0\u8fc7\u7a0b\u4e2d***\u6bcf\u4e00\u6b21\u7684\u589e\u91cf***\u5728\u6700\u7ec8\u7b54\u6848\u4e2d\u7684\u8d21\u732e\u3002\u5bb9\u6613\u53d1\u73b0\uff0c\u5982\u679c\u5728 $r$ \u5904\u6267\u884c\u4e86\u67d0\u6b21\u533a\u95f4\u52a0\u64cd\u4f5c\uff0c\u589e\u91cf\u4e3a $\\Delta$\uff0c\u4e14\u4e0b\u6807 $l$ \u5728\u8be5\u533a\u95f4\u5185\uff0c\u90a3\u4e48\u5b83\u5bf9\u6240\u6709 $g_b(l,r')\\ \\ (r'\\geq r)$ \u90fd\u6709 $\\Delta$ \u7684\u7ebf\u6027\u8d21\u732e\uff0c\u4e8e\u662f\u5bf9 $f_b(p,i,1,q)\\ \\ (q\\geq r,l\\in[p,i])$ \u7684\u8d21\u732e\u4e3a $(q-r+1)\\Delta={\\color{blue}q\\Delta}-{\\color{red}(r-1)\\Delta}$\u3002\u6613\u5f97\u4f4d\u7f6e $l$ \u5728\u524d $r$ \u8f6e\u7d2f\u52a0\u7684\u6240\u6709 $\\Delta$ \u5c31\u662f $g_a(l,r)$\uff1b\u800c $r,\\Delta$ \u53ea\u4e0e\u533a\u95f4\u52a0\u64cd\u4f5c\u76f8\u5173\uff0c$q$ \u53ea\u4e0e\u67e5\u8be2\u76f8\u5173\uff0c\u6545\u800c\u6211\u4eec\u5f00\u8bbe\u53e6\u4e00\u68f5\u7ebf\u6bb5\u6811\uff0c\u7ef4\u62a4\u6240\u6709 $-(r-1)\\Delta$ \u7684\u533a\u95f4\u548c\u5373\u53ef\u8ba1\u7b97\u4e0a\u8ff0\u5f0f\u5b50\u3002\n\n![](https://charleswu.site/wp-content/uploads/2022/11/noip_t4_partial_52pts_figure.png)\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\operatorname{O}(Qn\\log n)$\u3002\u53ef\u4ee5\u5c06\u4e0a\u6587\u4e2d\u5bf9\u6bcf\u4e2a\u8be2\u95ee\u6784\u9020\u7684 $f_b$ \u67e5\u8be2\u5168\u90e8\u8bb0\u5f55\u540e\uff0c\u53ea\u6267\u884c\u4e00\u904d\u626b\u63cf\u7ebf\u6c42\u51fa\u7b54\u6848\uff0c\u6700\u540e\u7edf\u4e00\u56de\u7b54\uff0c\u5e38\u6570\u66f4\u5c0f\u3002\n\n[**\u8d5b\u65f6\u4ee3\u7801**](https://www.luogu.com.cn/paste/0wmpvuvr)\uff08$\\text{52 pts}$\uff09\n### $\\text{32 pts}$ - $a$ \u662f\u7b49\u6982\u7387\u968f\u673a\u751f\u6210\u7684\u6392\u5217\nCWOI \u597d\u50cf\u53ea\u6709 hfy \u8d5b\u573a\u4e0a\u5199\u4e86\u8be5\u90e8\u5206\u5206\u3002~~\u4e0d\u8fc7\u4ed6\u7684\u7ebf\u6bb5\u6811\u88ab\u5361\u5e38\u4e86\uff0c\u602a\u51fa\u9898\u4eba\u53ea\u7ed9\u4e86 $\\text{2s}$\u3002~~\n#### \u5f15\u7406\n> \u5728 $n!$ \u4e2a\u5168\u6392\u5217\u4e2d\u7b49\u6982\u7387\u968f\u673a\u9009\u62e9\u4e00\u4e2a\u6392\u5217 $p$\uff0c$p$ \u6240\u6784\u5efa\u7684**\u7b1b\u5361\u5c14\u6811**\u7684\u6811\u9ad8\u671f\u671b\u662f $\\operatorname{O}(\\log n)$ \u7684\u3002\n\n#### [\u8bc1\u660e](http://www.cs.cmu.edu/afs/cs/academic/class/15210-s12/www/lectures/lecture16.pdf)\n\n\u6211\u4eec\u8bd5\u56fe\u627e\u5230\u4e00\u4e2a\u590d\u6742\u5ea6\u53ea\u8ddf $a$ \u5f3a\u76f8\u5173\u7684\u7b97\u6cd5\uff0c\u4ee5\u5145\u5206\u5229\u7528\u8fd9\u4e00\u6027\u8d28\u3002\n\n\u4e0d\u96be\u53d1\u73b0\uff0c\u5047\u5982\u6709 $\\operatorname{lbd}(i)\\geq \\text{ql}\\land \\operatorname{rbd}(i)\\leq \\text{qr}$\uff0c\u90a3\u4e48\u6211\u4eec\u603b\u662f\u53ef\u4ee5\u76f4\u63a5\u7d2f\u52a0 $a_if_b(\\operatorname{lbd}(i),i,i,\\operatorname{rbd}(i))$ \u5230\u7b54\u6848\u4e2d\uff0c\u4e0d\u7528\u8003\u8651\u8be2\u95ee\u7ed9\u5b9a\u7684\u9650\u5236\u3002\u5219\u6211\u4eec\u53ef\u4ee5\u7528\u4e0a\u6587\u6240\u8ff0\u65b9\u6cd5\u5728 $\\operatorname{O}(n\\log n)$ \u65f6\u95f4\u5185\u6c42\u51fa $a_if_b(\\operatorname{lbd}(i),i,i,\\operatorname{rbd}(i))\\ \\ (i=1,2,\\cdots,n)$\u3002\n\n\u8003\u8651*\u5728 $a$ \u968f\u673a\u7684\u60c5\u51b5\u4e0b*\uff0c\u6709\u591a\u5c11\u4f4d\u7f6e $i$ \u4e0d\u80fd\u91c7\u7528\u4e0a\u5f0f\u7ed3\u679c\uff0c\u800c\u987b\u8003\u8651 $\\text{ql},\\text{qr}$ \u7684\u5f71\u54cd\u3002\u663e\u7136\uff0c\u82e5 $a_{\\text{mx}}=g_a(\\text{ql},\\text{qr})$\uff0c\u5219\u4f4d\u7f6e $\\text{mx}$ \u7684\u7b54\u6848\u53ef\u80fd\u8981\u91cd\u65b0\u8ba1\u7b97\u2014\u2014\u5fc5\u6709 $\\operatorname{lbd}(\\text{mx})\\leq \\text{ql}\\land \\operatorname{rbd}(\\text{mx})\\geq \\text{qr}$\uff08\u5426\u5219\u548c\u5b83\u662f\u533a\u95f4\u6700\u503c\u7684\u6761\u4ef6\u76f8\u6096\uff09\u3002\n\n\u8003\u8651\u4e0d\u65ad\u4ece\u533a\u95f4\u6700\u503c\u4f4d\u7f6e\u5411\u4e24\u4fa7\u8fed\u4ee3\uff0c\u4e5f\u5373\n$$\\begin{aligned}&\\begin{cases}\\operatorname{lmx}_k=\\text{mx},& (k=0)\\\\a_{\\operatorname{lmx}_k}=g_a(\\text{ql},\\operatorname{lmx}_{k-1}-1),& (\\operatorname{lmx}_{k-1}>\\text{ql})\\\\\\operatorname{lmx}_k\\text{\\ is undefined}&\\text{otherwise}\\end{cases}\\\\&\\begin{cases}\\operatorname{rmx}_k=\\text{mx},& (k=0)\\\\a_{\\operatorname{rmx}_k}=g_a(\\operatorname{rmx}_{k-1}+1,\\text{qr}),& (\\operatorname{rmx}_{k-1}<\\text{qr})\\\\\\operatorname{rmx}_k\\ \\text{is undefined}&\\text{otherwise}\\end{cases}\\end{aligned}$$\n\u5219\u4e0d\u96be\u8bf4\u660e\u6709\u4e14\u4ec5\u6709 $\\operatorname{lmx}_k,\\operatorname{rmx}_k\\ \\ (k=0,1,\\cdots)$ \u8fd9\u4e9b\u4f4d\u7f6e\u9700\u8981\u91cd\u65b0\u8ba1\u7b97\u7b54\u6848\u2014\u2014\u5176\u4ed6\u6240\u6709\u4f4d\u7f6e $i$ \u7684 $\\operatorname{lbd}(i),\\operatorname{rbd}(i)$ \u6700\u591a\u5ef6\u4f38\u5230\uff08\u5411\u5de6\uff09$\\operatorname{lmx}_k+1$ \u6216\u8005\uff08\u5411\u53f3\uff09 $\\operatorname{rmx}_k-1$\uff0c\u53ef\u4ee5\u76f4\u63a5\u91c7\u7eb3\u9884\u5904\u7406\u7b54\u6848\u3002\n\n\u7531\u4e8e\u5747\u6709 $\\operatorname{lmx}_k$ \u662f $\\operatorname{lmx}_{k-1}$ \u5728\u7b1b\u5361\u5c14\u6811\u4e0a\u7684\u5b50\u6811\u5143\u7d20\uff08$\\operatorname{rmx}$ \u540c\u7406\uff09\uff0c\u4e14\u6811\u9ad8\u4e3a $\\operatorname{O}(\\log n)$ \u7684\uff0c\u6545\u800c\u66b4\u529b\u91cd\u7b97\u7684\u590d\u6742\u5ea6\u5f97\u5230\u4fdd\u969c\u3002\u6211\u4eec\u7528 **ST \u8868**\u627e\u5230 $\\operatorname{lmx}_k$ \u548c $\\operatorname{rmx}_k$\uff0c\u5c06 $\\operatorname{O}(Q\\log n)$ \u4e2a\u8be2\u95ee\u6302\u8f7d\u5230\u5bf9\u5e94\u53f3\u7aef\u70b9\uff0c\u6700\u540e\u7edf\u4e00\u505a\u4e00\u904d\u4e0a\u6587\u6240\u8ff0\u7684\u626b\u63cf\u7ebf\uff0c\u590d\u6742\u5ea6\u4e3a $\\operatorname{O}(Q\\log^2 n+n\\log n)$\u3002\n\n\u9700\u8981\u4f7f\u7528**\u533a\u95f4\u52a0\u533a\u95f4\u6c42\u548c\u6811\u72b6\u6570\u7ec4**\u4f18\u5316\u5e38\u6570\u624d\u80fd\u901a\u8fc7\uff0c\u6216\u8005\u5c1d\u8bd5\u7528 $\\operatorname{O}(\\sqrt{n})$ \u4fee\u6539 $\\operatorname{O}(1)$ \u67e5\u8be2\u7684\u5757\u72b6\u6570\u636e\u7ed3\u6784\u5e73\u8861\u590d\u6742\u5ea6\u3002\uff08\u5b9e\u9645\u4e0a\u672c\u89e3\u6cd5\u53ef\u4ee5\u76f4\u63a5\u901a\u8fc7\u4e0a\u4e00\u90e8\u5206\u5206\u3002\uff09\n\n**[\u4ee3\u7801](https://www.luogu.com.cn/paste/cnzhbyjj)**\uff08$\\text{84 pts}$\uff09\n\n## \u6b63\u89e3\uff08\u7ebf\u6bb5\u6811\uff09\n~~\u5f53\u7136\u4e86\uff0c\u6211\u4eec\u6709\u66f4\u7b80\u6d01\u6613\u5199\u7684\u5206\u5757\u505a\u6cd5\u3002\u60a8\u53ef\u4ee5\u79fb\u6b65\u522b\u7684\u9898\u89e3\u3002~~\n\n\u6211\u89c9\u5f97\u51fa\u9898\u4eba\u5b8c\u5168\u53ef\u4ee5\u518d\u7ed9\u4e00\u7ec4\u90e8\u5206\u5206\uff1a$\\sum \\text{qr}-\\text{ql}+1\\leq ?\\times 10^5$\u3002\n\n\u8bbe\u60f3\u77e9\u9635 $\\mathbf{F}$\uff0c\u6ee1\u8db3 $\\mathbf{F}_{i,j}=g_a(i,j)g_b(i,j)$\u3002\u8bb0\n$$f(p,i,j,q)=\\sum_{l=p}^{i}\\sum_{r=j}^{q}\\mathbf{F}_{l,r}=\\sum_{l=p}^{i}\\sum_{r=j}^{q}g_a(l,r)g_b(l,r)$$\n\u5219\u9898\u76ee\u6240\u7ed9\u8be2\u95ee\uff0c\u7b49\u4ef7\u4e8e\u95ee\u5de6\u4e0a\u89d2\u4e3a $(\\text{ql},\\text{ql})$\uff0c\u53f3\u4e0b\u89d2\u4e3a $(\\text{qr},\\text{qr})$ \u7684\u5b50\u77e9\u9635\u5143\u7d20\u4e4b\u548c\u3002\u53c8\u56e0\u4e3a\u6709 $\\forall l,r, n\\geq l>r\\geq 1,\\mathbf{F}_{l,r}=0$\uff0c\u5219\u6211\u4eec\u628a\u5de6\u4e0a\u89d2\u53d8\u6210 $(\\text{ql},1)$\uff0c\u4e0d\u5f71\u54cd\u7ed3\u679c\u3002\u4e8e\u662f\u5c31\u53d8\u6210\u4e86\u6c42 $f(\\text{ql},\\text{qr},1,\\text{qr})$\u3002\n\n\u6211\u4eec\u5c1d\u8bd5\u5bf9\u4e8e $r=1,2,\\cdots,n$\uff0c\u76f4\u63a5\u7ef4\u62a4\u6bcf\u4e2a $l$ \u7684 $g_a(l,r)g_b(l,r)$\uff0c\u540c\u65f6\u7ef4\u62a4 $a,b$ \u4e24\u5e8f\u5217\u7684\u6700\u5927\u503c\u5355\u8c03\u6808\u3002\u7531\u4e8e\u4e8c\u8005\u53ef\u80fd\u5728\u7b2c $r$ \u8f6e\u5185\u5148\u540e\u66f4\u65b0\uff0c\u6545\u4e3a\u884c\u6587\u65b9\u4fbf\uff0c\u4e0b\u6587\u4e2d ***\u5c06\u7528 $g_a(l)$ \u76f4\u63a5\u4ee3\u6307\u76ee\u524d\u7ebf\u6bb5\u6811\u4e0a\u7ef4\u62a4\u7684 $g_a(l,r)$*** \uff0c$g_a(l)'$ \u5219\u662f\u76f8\u5bf9\u4e8e\u76ee\u524d\u53d1\u751f\u4e86\u6539\u53d8\u7684\u503c\uff1b$g_b(l)$ \u540c\u7406\u3002\n\n\u5219\u5728\u66f4\u65b0 $a$ \u7684\u5355\u8c03\u6808\u65f6\uff0c\u5728\u67d0\u4e2a\u4f4d\u7f6e $l$ \u4ea7\u751f\u7684\u589e\u91cf $\\Delta_a=g_a(l)'-g_a(l)$ \u5c06\u4f1a\u5bfc\u81f4 $l$ \u7684\u7b54\u6848\u4ece $g_a(l)g_b(l)$ \u53d8\u6210 $(g_a(l)+\\Delta_a)g_b(l)$\uff1b\u66f4\u65b0 $b$ \u7684\u5355\u8c03\u6808\u65f6\u540c\u7406\u3002\u5219\u82e5\u6211\u4eec\u5728\u7ebf\u6bb5\u6811\u4e0a\u6bcf\u4e2a\u8282\u70b9\u7ef4\u62a4\u5b50\u533a\u95f4\u7684 $g_a(l)$ \u4e4b\u548c\uff0c$g_b(l)$ \u4e4b\u548c\u4ee5\u53ca $g_a(l)g_b(l)$ \u4e4b\u548c\uff0c\u73b0\u5728\u6bcf\u4e2a\u4f4d\u7f6e\u4ea7\u751f\u589e\u91cf $\\Delta_a,\\Delta_b$\uff0c\u6709 \n$$\\begin{aligned}\n\\sum_{l}g_a(l)'g_b(l)'&=\\sum_{l}(g_a(l)+\\Delta_a)(g_b(l)+\\Delta_b)\\\\&=\\left(\\sum_{l}g_a(l)g_b(l)\\right)+\\left(\\sum_{l}g_a(l)\\right)\\Delta_b+\\left(\\sum_{l}g_b(l)\\right)\\Delta_a+\\sum_{l}\\Delta_a\\Delta_b\\end{aligned}$$\n\n$\\Delta_a,\\Delta_b$ \u5747\u5bfc\u81f4\u7ebf\u6027\u8d21\u732e\uff0c\u663e\u7136\u6ee1\u8db3\u7ed3\u5408\u5f8b\u3002\u4e8e\u662f\u7528\u5e26 $\\Delta_a,\\Delta_b$ **\u5ef6\u8fdf\u6807\u8bb0**\u7684\u7ebf\u6bb5\u6811\u7ef4\u62a4\uff0c\u5c31\u80fd\u5728 $\\operatorname{O}(\\log n)$ \u7684\u65f6\u95f4\u5185\uff0c\u5728\u53f3\u7aef\u70b9\u626b\u63cf\u5230 $r$ \u65f6\uff0c\u67e5\u8be2 $g_a(l,r)g_b(l,r)$ \u7684\u533a\u95f4\u548c\u3002\n\n\u73b0\u5728\u56de\u987e\u90e8\u5206\u5206 $\\operatorname{O}(n\\log n)$ \u5904\u7406\u5355\u4e2a\u67e5\u8be2\u7684\u89e3\u6cd5\u3002\u6211\u4eec\u5206\u79bb\u4e86\u6bcf\u4e00\u6b21\u7684\u589e\u91cf\u9020\u6210\u7684\u8d21\u732e\uff0c\u5e76\u5728\u6700\u7ec8\u7ebf\u6027\u7d2f\u52a0\u56de\u53bb\u3002\u5b9e\u9645\u4e0a\u5bf9\u4e8e\u4e0a\u8ff0\u66f4\u590d\u6742\u7684\u8d21\u732e\uff0c\u4e5f\u80fd\u5982\u6cd5\u70ae\u5236\uff1a\u540c\u6837\u6709 $f(p,i,1,q)$ \u662f\u7ebf\u6bb5\u6811\u4e0a\u7684\u533a\u95f4\u5386\u53f2\u7248\u672c\u548c\u3002\u4ecd\u8003\u8651 $g_a(l)g_b(l)$ \u600e\u6837\u53d8\u5316\u5230 $g_a(l)'g_b(l)'$\u3002\u626b\u63cf\u5230 $r$ \u5904\u66f4\u65b0 $a$ \u7684\u5355\u8c03\u6808\u65f6\uff0c\u82e5\u5728\u4f4d\u7f6e $l$ \u4ea7\u751f\u589e\u91cf $\\Delta_a$\uff0c\u5219\u5bf9\u4e8e $q\\geq r$ \u7684\u6240\u6709\u7248\u672c\uff0c$g_a(l,q)g_b(l,q)$ \u90fd\u5305\u542b\u589e\u91cf $\\Delta_ag_b(l)$\u3002\u90a3\u4e48\uff0c\u5bf9\u4e8e\u67d0\u4e2a\u67e5\u8be2 $f(p,i,1,q)\\ \\ (l\\in[p,i],q\\geq r)$\uff0c\u8be5\u6b21\u66f4\u65b0\u7684\u589e\u91cf\u9020\u6210\u7684\u603b\u8d21\u732e\u4e3a $\\Delta_ag_b(l)(q-r+1)$\uff0c\u62c6\u5206\u6210 ${\\color{blue}\\Delta_ag_b(l)}q-{\\color{red}\\Delta_a(r-1)g_b(l)}$\u3002$b$ \u7684\u66f4\u65b0\u540c\u7406\uff1a${\\color{blue}\\Delta_bg_a(l)}q-{\\color{red}\\Delta_b(r-1)g_a(l)}$\u3002\n\n\u4e0d\u96be\u9a8c\u8bc1\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u786e\u5b9a\u7684 $l$\uff0c\u5728\u6240\u6709 $r\\ \\ (r\\leq q)$ \u5904\u7684\u4e24\u4e2a\u84dd\u5b57\u90e8\u5206\u8d21\u732e\u4e4b\u548c\u4ecd\u6070\u7b49\u4e8e $g_a(l,q)g_b(l,q)$\uff0c\u76f4\u63a5\u4f9d\u7167\u4e0a\u6587\u5728\u7ebf\u6bb5\u6811\u4e0a\u7ef4\u62a4\u533a\u95f4\u548c\u5373\u53ef\u3002\u73b0\u5728\u7740\u91cd\u8003\u8651\u7ea2\u5b57\u7684\u6c42\u548c\u3002\n\n\u6211\u4eec\u5c1d\u8bd5\u5bf9\u4e8e\u6bcf\u4e2a\u4f4d\u7f6e $l$ \u7ef4\u62a4 $h(l)$\uff0c\u8868\u793a ***\u626b\u63cf\u7ebf\u626b\u5230 $r$ \u65f6\u4f4d\u7f6e $l$ \u7684\u7ea2\u5b57\u8d21\u732e\u4e4b\u548c***\u3002\n#### \u5f15\u7406 $1$\n> \u5bf9\u4e8e\u4e00\u68f5\u672a\u91c7\u7528\u6807\u8bb0\u6c38\u4e45\u5316\u7684\u7ebf\u6bb5\u6811\uff0c\u67d0\u4e2a\u53f6\u5b50\u7ed3\u70b9\u5230\u6839\u7684\u8def\u5f84\u4e0a\uff0c\u672a\u4e0b\u653e\u5ef6\u8fdf\u6807\u8bb0\u7684\u8282\u70b9\u662f\u4ee5\u53f6\u5b50\u4e3a\u9996\u7684\u4e00\u4e2a\u975e\u7a7a\u524d\u7f00\u3002\n#### \u5f15\u7406 $2$\n> **\u8bb0\u4e0a\u6587\u4e2d\u201c\u53ea\u7ef4\u62a4\u7b2c $r$ \u8f6e\u7684 $g_a(l,r)g_b(l,r)$ \u533a\u95f4\u548c\u201d\u7ebf\u6bb5\u6811\u4e0a\uff0c\u8282\u70b9 $x$ \u7684\u5ef6\u8fdf\u6807\u8bb0\u4e3a $\\Delta_{a,x},\\Delta_{b,x}$**\u3002\u8bbe\u7ebf\u6bb5\u6811\u4e0a\u7ba1\u8f96 $g_a(l)g_b(l)$ \u7684\u53f6\u5b50\u7ed3\u70b9\u4e3a $x_1$\uff0c\u5b83\u548c\u82e5\u5e72\u7956\u5148\u6784\u6210\u7684\u94fe\u4e3a $x_1,x_2,\\cdots,x_k$\uff0c$x_k$ \u4e3a\u67d0\u6b21\u64cd\u4f5c\u9012\u5f52\u8bbf\u95ee\u7684\u7ec8\u6b62\u8282\u70b9\uff08\u6b64\u5373\u5f15\u7406 $1$ \u4e2d\u7684**\u524d\u7f00**\uff09\u3002\u5219\u4efb\u4e00\u65f6\u523b\uff0c$g_a(l)$ \u7684\u771f\u5b9e\u503c\u7b49\u4e8e $\\sum_{i=1}^k\\Delta_{a,x_i}$\uff0c\u800c $x_i$ \u91c7\u7528\u7684\u201c$g_a(l)$\u201d\u5b9e\u9645\u4e0a\u662f $\\sum_{j=1}^{i}\\Delta_{a,x_j}$\uff1b$g_b(l)$ \u4e4b\u4e8e $\\Delta_{b,x}$ \u4ea6\u7136\u3002\n\n\u8fd9\u4e24\u6761\u5f15\u7406\u90fd\u662f\u5f88\u5bb9\u6613\u9a8c\u8bc1\u7684\u3002\n\n![](https://charleswu.site/wp-content/uploads/2022/12/noip_t4_sol_figure.png)\n\n\u8003\u8651\u600e\u6837\u7ef4\u62a4 $h(l)$ \u7684\u533a\u95f4\u548c\u3002\u5047\u82e5\u626b\u63cf\u7ebf\u626b\u63cf\u5230\u7b2c $r$ \u8f6e\uff0c\u6211\u4eec\u66f4\u65b0\u4e86 $b$ \u7684\u5355\u8c03\u6808\uff0c\u4f7f\u5f97\u4e00\u6bb5\u533a\u95f4\u7684 $h(l)'=h(l)+\\Delta_b(r-1)g_a(l)$\u3002\u5219\u5c06\u5f53\u524d $g_a(l)$ \u7684\u503c\u8bb0\u4f5c $c_a$\uff0c\u5b83\u7684\u8d21\u732e\u4ecd\u7136\u662f\u7ebf\u6027\u7684\uff1a\u8bbf\u95ee\u7ebf\u6bb5\u6811\u67d0\u4e00\u8282\u70b9\u65f6\uff0c\u7531\u4e8e\u5176\u6240\u6709\u7956\u5148\u7684\u5ef6\u8fdf\u6807\u8bb0\u90fd\u5df2\u4e0b\u653e\uff0c\u6211\u4eec\u83b7\u5f97\u7684\u6b63\u662f $g_a(l)$ \u7684\u771f\u5b9e\u503c\u3002\u6545\u53ef\u4ee5\u7acb\u523b\u66f4\u65b0\u8282\u70b9 $x_k$ \u7684\n$$\\sum_{l}h(l)'=\\left(\\sum_{l}h(l)\\right)+\\Delta_b(r-1)\\sum_{l}g_a(l)$$\n\n\u6b64\u540e\u8be5\u533a\u95f4\u53ef\u80fd\u7ecf\u8fc7\u4e86\u82e5\u5e72\u6b21\u66f4\u65b0\uff0c\u7ef4\u62a4\u7684 $g_a(l)$ \u548c $\\Delta_{a,x}$ *\u53ef\u80fd\u53d1\u751f\u53d8\u5316*\uff0c\u4f46\u90a3\u4e00\u6b21\u4fee\u6539\u6240\u91c7\u7528\u7684\u7684 $c_a$ \u662f\u4e0d\u53d8\u7684\uff08\u53c2\u89c1\u4e0a\u56fe\uff09\u3002\u4e3a\u4e86\u4fdd\u8bc1\u4e0b\u653e\u540e $h(l)$ \u589e\u91cf\u7684\u4e00\u81f4\u6027\uff0c\u6211\u4eec\u5c06 $c_a$ \u62c6\u5206\u6210 ${\\color{red}\\Delta_{a,x_k}}+{\\color{blue}\\sum_{i=1}^{k-1}\\Delta_{a,x_i}}$\uff0c$h(l)$ \u7684\u589e\u91cf\u53d8\u6210\n$$c_a\\Delta_b(r-1)={\\color{red}\\Delta_{a,x_k}}\\Delta_b(r-1)+{\\color{blue}\\sum_{i=1}^{k-1}\\Delta_{a,x_i}}\\Delta_b(r-1)$$\n\n\u5982\u4e0a\u56fe\u6240\u793a\uff0c\u84dd\u5b57\u5c31\u662f $x_{k-1}$ \u6240\u7ef4\u62a4\u7684\u201c$g_a(l)$\u201d\uff0c\u5b83\u5728\u628a\u6807\u8bb0 $\\Delta_{a,x_k}$ \u4e0b\u653e\u5230 $x_{k-1}$ \u524d*\u4fdd\u6301\u4e0d\u53d8*\uff0c\u6211\u4eec\u5c06\u5176\u52a0\u4ee5\u5229\u7528\u3002\u6545\u800c\u4e0b\u653e\u65f6\uff0c\u4f9d\u6b21\u4f5c\u5982\u4e0b\u66f4\u65b0\uff1a\u4ee4\u5ef6\u8fdf\u6807\u8bb0 $\\Delta_{\\beta,x}$ \u4e3a ***\u5e94\u7528\u5230 $x$ \u4e0a\u4e14\u8fd8\u672a\u4e0b\u653e\u7684 $\\Delta_b(r-1)$ \u4e4b\u548c***\uff08$\\Delta_{\\alpha,x}$ \u662f $\\Delta_a(r-1)$ \u4e4b\u548c\uff09\uff1b\u6709 $x_{k-1}$ \u7ef4\u62a4\u7684\n$$\\sum_{l}h(l)'=\\left(\\sum_{l}h(l)\\right)+\\Delta_{\\beta,x_k}\\left(\\sum_l{\\color{blue}g_a(l)}\\right)+\\Delta_{\\alpha,x_k}\\left(\\sum_l{g_b(l)}\\right)$$\n\uff08$\\sum_lg_a(l),\\sum_lg_b(l)$ \u6682\u672a\u66f4\u65b0\uff09\uff1b\u5bf9\u4e8e\u7ea2\u5b57\uff0c\u6211\u4eec\u5728\u5bf9 $x_k$ \u4f5c\u4fee\u6539\u65f6\u5373\u7acb\u523b\u4fdd\u5b58 $\\Delta_b(r-1){\\color{red}\\Delta_{a,x_k}}$\uff0c\u5c06\u5176\u7d2f\u52a0\u5230\u53e6\u4e00\u5ef6\u8fdf\u6807\u8bb0\u4e2d\uff0c\u8bb0\u4f5c $\\Delta_{\\text{co},x_k}$\uff1b\u4e0b\u653e\u65f6\u5373\u6709\n$$\\sum_{l}h(l)'=\\left(\\sum_{l}h(l)\\right)+\\left(\\sum_{l}\\Delta_{\\text{co},x_k}\\right)$$\n\uff08\u6ce8\u610f\u5230\u7ea2\u5b57\u7d2f\u52a0\u7684\u662f\u5e38\u7cfb\u6570\uff0c\u4e0e\u6765\u81ea\u4e8e\u5bf9 $a$ \u8fd8\u662f\u5bf9 $b$ \u7684\u4fee\u6539\u65e0\u5173\uff0c\u6545\u800c $a$ \u7684\u4fee\u6539\u5171\u7528 $\\Delta_{\\text{co},x_k}$\uff09\n\n$\\Delta_{\\beta,x_k},\\Delta_{\\alpha,x_k}$ \u7684\u4e0b\u653e\u66f4\u65b0\u662f\u7b80\u5355\u7684\uff0c\u5c06\u5b83\u76f4\u63a5\u7d2f\u52a0\u5230 $\\Delta_{\\beta,x_{k-1}},\\Delta_{\\alpha,x_{k-1}}$ \u4e0a\u5373\u53ef\uff1b\u800c $\\Delta_{\\text{co},x_k}$ \u4e0b\u653e\u65f6\uff0c\u7531\u4e0a\u56fe\u53ef\u5f97\u6709\n$${\\Delta_{\\text{co},x_{k-1}}}'=\\Delta_{a,x_{k-1}}\\Delta_{\\beta,x_k}+\\Delta_{b,x_{k-1}}\\Delta_{\\alpha,x_k}+\\Delta_{\\text{co},x_k}$$\n\n\u8fd9\u4e9b\u66f4\u65b0\u5b8c\u6210\u540e\uff0c\u518d\u884c\u5904\u7406 $\\sum_{l}g_a(l),\\sum_{l}g_b(l)$ \u548c $\\sum_{l}g_a(l)g_b(l)$ \u7684\u66f4\u65b0\u3002\u4e8e\u662f\u6211\u4eec\u5bf9\u6bcf\u4e2a\u8282\u70b9 $x$ \u7ef4\u62a4\u4e5d\u5143\u7ec4 $(\\sum_{l}g_a(l),\\sum_{l}g_b(l),\\sum_{l}g_a(l)g_b(l),\\sum_{l}h(l),\\Delta_{a,x},\\Delta_{b,x},\\Delta_{\\alpha,x},\\Delta_{\\beta,x},\\Delta_{\\text{co},x})$\u3002\u9898\u76ee\u6240\u7ed9\u6bcf\u4e2a\u8be2\u95ee $[\\text{ql},\\text{qr}]$\uff0c\u90fd\u53ea\u9700\u5728\u626b\u5230\u7b2c $\\text{qr}$ \u8f6e\u65f6\u533a\u95f4\u67e5\u8be2 $\\sum_{l=\\text{ql}}^{\\text{qr}}\\text{qr}g_a(l)g_b(l)-h(l)$\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\operatorname{O}(Q\\log n+n\\log n)$\uff0c\u5e38\u6570\u5927\u3002\n\n### \u4ee3\u7801\n[**R96818778 \u8bb0\u5f55\u8be6\u60c5**](https://www.luogu.com.cn/record/96818778)\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n\n#define inl inline\n// \u5feb\u8bfb\u5df2\u7701\u7565\u3002\n#define newl putchar('\\n')\ntypedef long long ll;\ntypedef unsigned long long ull;\ntypedef pair <int, int> pint;\n#define fst first\n#define scd second\n#define all(p) begin (p), end (p)\n#define empb emplace_back\n\nconstexpr int N = 250010;\nint _test, n, m, l, r, a[N], b[N]; ull ans[N];\nint sta[N], topa, stb[N], topb;\nvector <pint> q[N];\n\nstruct seg_tree {\n\tstruct info { ull da, db, dalp, dbta, dco; };\n\tstruct node { ull l, r, gasum, gbsum, gagbsum, hsum; info tag; } t[N<<2];\n\tinfo inc; ull idx, L, R;\n\n\tvoid build (int x, int l, int r) {\n\t\tt[x].l = l, t[x].r = r;\n\t\tif (l == r) return;\n\t\tint mid = l + r >> 1;\n\t\tbuild (x<<1, l, mid),\n\t\tbuild (x<<1|1, mid + 1, r);\n\t}\n\tinl void saku (node &nde, const info &tag) {\n\t\tstatic ull len; len = nde.r - nde.l + 1;\n\t\tinfo &_tag = nde.tag;\n\t\tconst auto &[da, db, dalp, dbta, dco] = tag;\n\t\tnde.hsum += dalp * nde.gbsum + dbta * nde.gasum + dco * len;\n\t\tnde.gasum += da * len, nde.gbsum += db * len;\n\t\tnde.gagbsum += da * db * len + db * nde.gasum + da * nde.gbsum;\n\t\t_tag.dco += dco + _tag.db * dalp + _tag.da * dbta;\n\t\t_tag.da += da, _tag.db += db,\n\t\t_tag.dalp += dalp, _tag.dbta += dbta;\n\t}\n\tinl void down (int x) {\n\t\tsaku (t[x<<1], t[x].tag),\n\t\tsaku (t[x<<1|1], t[x].tag),\n\t\tmemset (&t[x].tag, 0, 40);\n\t}\n\tinl void post (int x) {\n\t\tnode &nde = t[x], &ls = t[x<<1], &rs = t[x<<1|1];\n\t\tnde.gasum = ls.gasum + rs.gasum,\n\t\tnde.gbsum = ls.gbsum + rs.gbsum,\n\t\tnde.gagbsum = ls.gagbsum + rs.gagbsum,\n\t\tnde.hsum = ls.hsum + rs.hsum;\n\t}\n\t\n\tvoid add (int x) {\n\t\tif (t[x].l >= L && t[x].r <= R)\n\t\t\treturn saku (t[x], inc);\n\t\tull mid = t[x].l + t[x].r >> 1; down (x);\n\t\tif (L <= mid) add (x<<1);\n\t\tif (R > mid) add (x<<1|1);\n\t\tpost (x);\n\t}\n\tinl void add (int l, int r, ull da, ull db, ull idx) {\n\t\tinc = { da, db, (1ull-idx)*da, (1ull-idx)*db,\n\t\t\t(da&&db) * (1ull-idx)*da*db } /* \u7279\u5224\u5bf9r\u7684\u5355\u70b9\u66f4\u65b0\uff0c\u6b64\u65f6\u7531\u4e8eda,db\u540c\u65f6\u66f4\u65b0\u8981\u589e\u52a0\u989d\u5916\u7cfb\u6570 */;\n\t\tL = l, R = r, add (1);\n\t}\n\tull query (int x) {\n\t\tif (t[x].l >= L && t[x].r <= R)\n\t\t\treturn t[x].gagbsum * idx + t[x].hsum;\n\t\tull mid = t[x].l + t[x].r >> 1;\n\t\tdown (x); ull res = 0;\n\t\tif (L <= mid) res += query (x<<1);\n\t\tif (R > mid) res += query (x<<1|1);\n\t\treturn res;\n\t}\n\tinl ull query (int l, int r, int _idx) {\n\t\treturn L = l, R = r, idx = _idx, query (1);\n\t}\n} seg;\n\nint main () {\n\t/* NOIP 2022 SC-067 \u5434\u79cb\u5b9e */\n\t// freopen (\"match.in\", \"r\", stdin);\n\t// freopen (\"match.out\", \"w\", stdout);\n\n\tread (_test, n);\n\tfor (int i = 1; i <= n; ++i) read (a[i]);\n\tfor (int i = 1; i <= n; ++i) read (b[i]);\n\tseg.build (1, 1, n);\n\tread (m);\n\tfor (int i = 1; i <= m; ++i)\n\t\tread (l, r), q[r].empb (l, i);\n\tfor (int r = 1; r <= n; ++r) {\n\t\tstatic int dt;\n\t\t// \u66f4\u65b0\u5355\u8c03\u6808\u3002\n\t\twhile (topa && (dt = a[r] - a[sta[topa]]) > 0)\n\t\t\tseg.add (sta[topa-1]+1, sta[topa], dt, 0, r), --topa;\n\t\twhile (topb && (dt = b[r] - b[stb[topb]]) > 0)\n\t\t\tseg.add (stb[topb-1]+1, stb[topb], 0, dt, r), --topb;\n\t\tseg.add (r, r, a[r], b[r], r);\n\t\tsta[++topa] = stb[++topb] = r;\n\t\tfor (const auto [l, id] : q[r])\n\t\t\tans[id] = seg.query (l, r, r);\n\t}\n\tfor (int i = 1; i <= m; ++i)\n\t\tprint (ans[i]), newl;\n\n\treturn 0;\n}\n```",
        "postTime": 1670485724,
        "uid": 241614,
        "name": "NGC5457",
        "ccfLevel": 8,
        "title": "NOIP 2022 T4 - \u6bd4\u8d5b (match) - \u9898\u89e3"
    },
    {
        "content": "\u9898\u610f\uff1a\u7ed9\u5b9a\u5e8f\u5217 $a_i$\uff0c$b_i$\uff0c\u8bbe $f(l,r)=\\max\\limits_{i=l}^ra_i\\max\\limits_{i=l}^rb_i$\u3002\u6c42 $g(l,r)=\\sum\\limits_{l\\le l'\\le r'\\le r}f(l',r')$\u3002\n\n\u8bbe $h(l,r)$ \u8868\u793a $\\sum\\limits_{i=1}^lf(i,r)$\uff0c\u8003\u8651\u5bf9\u4e8e\u6bcf\u4e00\u4e2a $r$ \u7ef4\u62a4\u540e\u7f00\u6700\u5927\u503c\uff0c\u53d1\u73b0\u540e\u7f00\u6700\u5927\u503c\u662f\u5355\u8c03\u4e0d\u5347\u7684\uff0c\u4e8e\u662f\u6bcf\u6b21\u53f3\u7aef\u70b9\u53f3\u79fb\u76f8\u5f53\u4e8e\u8fdb\u884c\u4e86\u4e00\u6b21\u540e\u7f00\u8d4b\u503c\uff0c\u663e\u7136\u53ea\u4f1a\u6709 $O(1)$ \u6b21\u8fb9\u5757\u8d4b\u503c\uff0c\u8fd9\u79cd\u60c5\u51b5\uff0c\u6211\u4eec\u9700\u8981\u5bf9\u5757\u91cd\u6784\u3002\u53ea\u6709\u524d\u540e\u90fd\u662f\u6574\u5757\uff0c\u624d\u4e0d\u9700\u8981\u91cd\u6784\u3002\n\n\u5bf9\u5757\u5185\u7ef4\u62a4 $\\sum\\limits_{i=L}^xf(i,r)$\uff0c\u6574\u5757\u7ef4\u62a4 $\\sum\\limits_{i=1}^Rf(i,r)$\uff0c\u5c06 $r$ \u4ece $1$ \u679a\u4e3e\u5230 $n$\uff0c\u8fd9\u6837\u91cd\u6784\u5757\u7684\u6b21\u6570\u4e3a $O(n)$\uff0c\u5e73\u644a\u4e3a $O(n\\sqrt n)$\uff0c\u53ef\u4ee5\u505a\u5230 $O(1)$ \u67e5\u8be2 $h(l,r)$\u3002\n\n\u5f53\u7136\uff0c\u4f60\u8fd8\u9700\u8981\u7ef4\u62a4\u5de6\u7aef\u70b9\uff0c\u7136\u540e\u5957\u4e0a\u83ab\u961f\u5c31\u53ef\u4ee5\u4e86\uff0c\u6ce8\u610f\u4fee\u6539\u590d\u6742\u5ea6\u8fdc\u8fdc\u8d85\u8fc7\u4e86\u67e5\u8be2\u590d\u6742\u5ea6\uff0c\u4e8e\u662f\u4e8c\u6b21\u79bb\u7ebf\u53ef\u4ee5\u505a\u5230 $O(n(\\sqrt n+\\sqrt q))$\uff0c\u7a7a\u95f4 $O(n+q)$\u3002\n\n\u56e0\u4e3a\u6ca1\u6709\u5bf9\u62cd $\\text{NOIP}$ \u8fde $150$ \u90fd\u6ca1\u4e0a\uff0c\u6211\u5df2\u7ecf\u662f\u534a\u9000\u5f79\u72b6\u6001\uff0c\u5199\u4e0d\u51fa\u4ee3\u7801\u4e86\uff0c\u4f46\u76ee\u6d4b\u4e0d\u5230 $1s$\uff0c\u5982\u679c\u6709\u9519\u8bef\u8bf7\u6307\u51fa\u3002",
        "postTime": 1670407148,
        "uid": 502410,
        "name": "EnofTaiPeople",
        "ccfLevel": 0,
        "title": "[NOIP2022] \u6bd4\u8d5b \u9898\u89e3"
    },
    {
        "content": "\u6bcf\u7ec4\u8be2\u95ee $[L,R]$ \u8981\u6c42\n$$\n\\sum_{[l,r]\\in[L,R]}(\\max_{i\\in[l,r]} A_i)(\\max_{i\\in[l,r]}B_i)\n$$\n\u987a\u5e8f\u626b $r$\uff0c\u7ef4\u62a4 $\\{a\\},\\{b\\}$ \u5206\u522b\u8868\u793a\u4ee5\u6bcf\u4e2a\u4f4d\u7f6e\u4e3a $l$ \u65f6\u7684 $\\max_{i\\in[l,r]} A_i,\\max_{i\\in[l,r]}B_i$\u3002\n\n\u5bf9\u4e8e\u8be2\u95ee $[L,R]$\uff0c\u7b54\u6848\u4e3a $r$ \u521a\u521a\u626b\u5b8c $R$ \u65f6 $[L,R]$ \u7684\u5386\u53f2\u4e58\u79ef\u548c\u3002\n\n\u5c31\u5f97\u5230\u4e86 20pts \u66b4\u529b\uff1a\n\n```cpp\nint orz,n,q,A[N],B[N],sa[N],sb[N],ta=0,tb=0;\null a[N],b[N],c[N];\nvector<pi> ask[N];\null ans[N];\nsigned main(){ios::sync_with_stdio(false),cin.tie(nullptr);\n\tcin>>orz>>n;\n\trep(i,1,n) cin>>A[i];\n\trep(i,1,n) cin>>B[i];\n\tcin>>q;\n\trep(i,1,q){\n\t\tint l,r;cin>>l>>r;\n\t\task[r].pb(l,i);\n\t}\n\trep(i,1,n){\n\t\twhile(ta && A[sa[ta]]<=A[i]) ta--;\n\t\twhile(tb && B[sb[tb]]<=B[i]) tb--;\n\t\trep(j,sa[ta]+1,i) a[j]=A[i];\n\t\trep(j,sb[tb]+1,i) b[j]=B[i];\n\t\tsa[++ta]=i;\n\t\tsb[++tb]=i;\n\t\trep(j,1,i) c[j]+=a[j]*b[j];\n\t\tfor(auto j:ask[i]){\n\t\t\tull x=0;\n\t\t\trep(k,j.fir,i) x+=c[k];\n\t\t\tans[j.sec]=x;\n\t\t}\n\t}\n\trep(i,1,q) cout<<ans[i]<<\"\\n\";\nreturn 0;}\n```\n\n\u63a5\u4e0b\u6765\u53c2\u8003 CF1083D \u7684\u505a\u6cd5\uff0c\u7528\u4e24\u4e2a\u5355\u8c03\u6808\u7ef4\u62a4\u540e\u7f00\u6700\u5927\u503c\u4f4d\u7f6e\uff0c\u95ee\u9898\u5c31\u8f6c\u5316\u4e3a\uff1a\n\n* $\\{a\\}$ \u533a\u95f4\u8d4b\u503c\u3002\n\n* $\\{b\\}$ \u533a\u95f4\u8d4b\u503c\u3002\n\n* \u533a\u95f4\u5185 $\\{c\\}$ \u52a0\u4e0a\u5bf9\u5e94\u9879 $\\{a\\},\\{b\\}$ \u76f8\u4e58\u3002\n\n* \u67e5\u8be2 $\\{c\\}$ \u533a\u95f4\u548c\u3002\n\n\u7ebf\u6bb5\u6811 $O(n\\log n)$ \u53ef\u505a\u3002\n\n\u6811\u8282\u70b9\u7ef4\u62a4\uff1a$c,a,b,ab$ \u7684\u548c\u3002\n\ntag \u7ef4\u62a4\uff1a$ab,a,b,1$ \u52a0\u5230 $c$ \u4e2d\u7684\u7cfb\u6570\uff0c$a,b$ \u7684\u8d4b\u503c\u6807\u8bb0\u3002\n\n100pts \u4ee3\u7801\u592a\u4e11\u4e86\uff0c\u4e0d\u653e\u4e86\u5427\u3002\n\n\u5176\u5b9e\u4e5f\u53ef\u4ee5\u7528\u77e9\u9635\u7ef4\u62a4\u6807\u8bb0\uff0c\u4ee3\u7801\u66f4\u7b80\u5355\u4e0d\u8fc7\u5e38\u6570\u5927\u3002",
        "postTime": 1670988384,
        "uid": 101868,
        "name": "I_am_Accepted",
        "ccfLevel": 0,
        "title": "P8868 [NOIP2022] \u6bd4\u8d5b\uff08\u5355\u8c03\u6808/\u5386\u53f2\u548c\u7ebf\u6bb5\u6811\uff09"
    }
]