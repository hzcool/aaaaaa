[
    {
        "content": "## \u63d2\u5934 DP\u3002\n\n~~\u4e3a\u4ec0\u4e48\u4e00\u7bc7\u9898\u89e3\u90fd\u6ca1\u6709\u5bb3\u5f97\u6211\u8c03\u4e86\u4e00\u5929\u3002~~\n\n\u672c\u9898\u6570\u636e\u8303\u56f4 $n,m \\le 9,k \\le 10$\u3002\n\n\u8bb0\u5f55\u5f53\u524d\u63d2\u5934\u72b6\u6001\u7684\u6700\u77ed\u7ebf\u8def\u957f\u5ea6\u548c\u65b9\u6848\u6570\u3002\u63d2\u5934\u5206 $k$ \u79cd\uff0c\u8fd9\u91cc\u53ef\u4ee5\u4e0d\u4f7f\u7528\u62ec\u53f7\u8868\u793a\u6cd5\uff0c\u56e0\u4e3a\u5982\u679c\u51fa\u73b0\u4e00\u4e9b\u4e0d\u5408\u6cd5\u7684\u8def\u5f84\uff08\u6bd4\u5982\u7a7a\u5730\u4e0a\u65e0\u7535\u6e90\u51fa\u73b0\u56de\u8def\uff09\u4e00\u5b9a\u4e0d\u4f18\u4f1a\u88ab\u820d\u53bb\u3002\n\n\u7136\u540e\u5c31\u662f\u5206\u7c7b\u8ba8\u8bba\uff1a\n\n\u4ee4 $fr$ \u4e3a\u5f53\u524d\u5de6\u63d2\u5934\uff0c$fd$ \u4e3a\u5f53\u524d\u4e0a\u63d2\u5934\u3002\n\n1. \u5f53\u524d\u683c\u4e3a\u969c\u788d\u7269\uff1a\n\n \t - \u5f53\u524d\u683c\u975e\u7535\u6e90\u4e14 $fr=fd=0$ \u8f6c\u79fb\u5230\u65e0\u4e0a\u4e0b\u63d2\u5934\u3002\n     \n2. \u5f53\u524d\u683c\u4e3a\u7535\u6e90\uff1a\n\n\t - \u5f53\u524d\u6709\u4e24\u4e2a\u76f8\u540c\u63d2\u5934\u4e0d\u5408\u6cd5\u3002\n     \n  \t - \u5f53\u524d\u7684\u63d2\u5934\u4e0d\u5c5e\u4e8e\u8be5\u7535\u6e90\u4e0d\u5408\u6cd5\u3002\n\n\t - \u5982\u679c\u8be5\u7535\u6e90\u7684\u4ecd\u9700\u8981\u5411\u5916\u8fde\u63a5 $>2$ \u6761\u7ebf\u8def\u4e0d\u5408\u6cd5\u3002\n     \n\t - \u679a\u4e3e\u51fa\u8def\u8f6c\u79fb\u3002\n     \n3. \u5f53\u524d\u683c\u4e3a\u7a7a\u5730\uff1a\n\n\t - $fr=fd=0$ \uff1a\u8f6c\u79fb\u5230\u65e0\u63d2\u5934\u6216\u65b0\u5efa\u4ece\u53f3\u81f3\u4e0b\u7684\u67d0\u79cd\u7535\u7ebf\u3002\n     \n\t - $(fr=0 \\land fd>0)\\lor(fr>0 \\land fd=0)$\uff1a\u5ef6\u7eed\u63d2\u5934\u81f3\u4e0b\u6216\u53f3\u3002\n     \n\t - $fr>0 \\land fd>0 \\land fr \\ne fd$\uff1a\u5ef6\u7eed\u81f3\u201c\u5de6-\u4e0b\uff0c\u4e0a-\u53f3\u201d\u63d2\u5934\u3002\n     \n\t - $fr=fd \\land fr>0$ \u5408\u5e76\u63d2\u5934\uff0c\u8f6c\u79fb\u5230\u8f6c\u79fb\u5230\u65e0\u63d2\u5934\u6216\u65b0\u5efa\u4ece\u53f3\u81f3\u4e0b\u7684\u67d0\u79cd\u7535\u7ebf\u3002\n     \n\u6ce8\u610f\u4e8b\u9879\uff1a\n\n1. \u82e5\u67d0\u79cd\u7535\u7ebf\u8d77\u70b9\u7ec8\u70b9\u4e3a\u540c\u4e00\u683c\u5b50\u5219\u65e0\u89e3\u3002\n\n2. \u79ef\u6781\u63d0\u524d\u5224\u65ad\u4e0d\u5408\u6cd5\u72b6\u6001\u4f18\u5316\u72b6\u6001\u6570\u91cf\u3002\n\n3. \u591a\u6d4b\u6e05\u7a7a\u3002\n\n## CODE\n\n```cpp\n#include<bits/stdc++.h>\n#define N 10\n#define M 100010\n#define S 3000010\n#define LL long long\n#define DB double\n#define rep(i,a,b) for(int i=a;i<=b;i++)\n#define per(i,a,b) for(int i=a;i>=b;i--)\n#define mod 25619849\n#define INF 0x3f3f3f3f\n#define pir pair<int,int>\n#define mp(i,j) make_pair(i,j)\n#define fi first\n#define se second\n#define w(i,j) (1ll*((1ll*i)<<(j)))\n#define e(i,j) (1ll*(((1ll*i)>>(j))&15))\nusing namespace std;\ntemplate <typename T> inline void read(T &a)\n{\n\ta=0;T w=1;char ch=getchar();\n\twhile(ch<'0'||ch>'9'){if(ch=='-')w=-1;ch=getchar();}\n\twhile(ch>='0'&&ch<='9'){a=(a<<3)+(a<<1)+(ch^48);ch=getchar();}\n\ta*=w;\n}\ntemplate <typename T,typename ...Args> inline\nvoid read(T &x,Args &...args){read(x);read(args...);}\nint n,m,q,maap[N][N],num[N+1],ncc;\nbool suc;\nconst LL lim=(1ll<<40)-1;\nbool cur,hav[N][N][11];\nvector<int> node[N][N];\nstruct HASH_TABLE\n{\n\t#define Mod 500009\n\tstruct NODE{int pre,id;}a[S];\n\tint head[500010],cc,pcc;//\u63d2\u59344*9=36\u4f4d\uff1f \n\tLL state[S],f[S];int g[S];\n\tinline void init(){pcc=0;memset(head,0,sizeof(head));}\n\tinline void insert(LL sta,LL val,int len)\n\t{\n\t\tsta&=lim;int key=1ll*sta%Mod;\n\t\tfor(int cur=head[key];cur;cur=a[cur].pre) if(state[a[cur].id]==sta)\n\t\t{\n\t\t\tint id=a[cur].id;\n\t\t\tif(g[id]>len){g[id]=len;f[id]=val;return;}\n\t\t\telse if(g[id]==len){(f[id]+=val)%=mod;return;}\n\t\t\telse return;\n\t\t}\n\t\ta[++pcc]={head[key],++cc};head[key]=pcc;state[cc]=sta;f[cc]=val;g[cc]=len;\n\t}\n\t#undef Mod\n}hs[2];\ninline void Main()\n{\n\tmemset(hav,0,sizeof(hav));\n\tswap(n,m);cur=0;suc=1;\n\trep(i,1,n) rep(j,1,m) read(maap[i][j]),node[i][j].clear();\n\trep(i,1,q)\n\t{\n\t\tint x,y,_x,_y;read(x,y,_x,_y);\n\t\tx++;y++;_x++;_y++;\n\t\tif(x==_x&&y==_y){suc=0;}\n\t\tnode[ x][ y].push_back(i);\n\t\tnode[_x][_y].push_back(i);\n\t\thav[x][y][i]=hav[_x][_y][i]=1;\n\t\tif(node[ x][ y].size()>4){suc=0;}\n\t\tif(node[_x][_y].size()>4){suc=0;}\n\t}\n\trep(i,1,n) rep(j,1,m) if(!node[i][j].size()) rep(k,1,q) hav[i][j][k]=1;\n\tif(!suc){printf(\"-1 0\\n\");return;}\n\ths[0].init();hs[0].cc=0;\n\ths[1].init();hs[1].cc=0;\n\ths[cur].init();hs[cur].cc=0;hs[cur].insert(0,1,0);\n\trep(i,1,n)\n\t{\n\t\trep(j,1,hs[cur].cc) (hs[cur].state[j]<<=4)&=lim;\n\t\trep(j,1,m)\n\t\t{\n\t\t\ths[cur].init();cur^=1;hs[cur].cc=0;\n\t\t\trep(k,1,hs[cur^1].cc)\n\t\t\t{\n\t\t\t\tLL sta=hs[cur^1].state[k]&lim,val=hs[cur^1].f[k];int len=hs[cur^1].g[k];\n\t\t\t\tint fr=e(sta,(j-1)*4),fd=e(sta,j*4);\n\t\t\t\tLL base=sta^w(fr,(j-1)*4)^w(fd,j*4);\n\t\t\t\tif(maap[i][j]==1)\n\t\t\t\t{\n\t\t\t\t\tif(node[i][j].size()) continue;\n\t\t\t\t\tif(!fd&&!fr) hs[cur].insert(base,val,len);\n\t\t\t\t}\n\t\t\t\telse if(!node[i][j].size())\n\t\t\t\t{\n\t\t\t\t\tif(!fr&&!fd)\n\t\t\t\t\t{\n\t\t\t\t\t\ths[cur].insert(base,val,len);\n\t\t\t\t\t\tif(j<m&&!maap[i][j+1]&&i<n&&!maap[i+1][j]) rep(typ,1,q) if(hav[i][j+1][typ]&&hav[i+1][j][typ]) hs[cur].insert(base|w(typ,(j-1)*4)|w(typ,j*4),val,len+2);\n\t\t\t\t\t}\n\t\t\t\t\telse if((fr&&!fd)||(!fr&&fd))\n\t\t\t\t\t{\n\t\t\t\t\t\tif(i<n&&!maap[i+1][j]&&hav[i+1][j][fr|fd]) hs[cur].insert(base|w(fr|fd,(j-1)*4),val,len+1);\n\t\t\t\t\t\tif(j<m&&!maap[i][j+1]&&hav[i][j+1][fr|fd]) hs[cur].insert(base|w(fr|fd,j*4),val,len+1);\n\t\t\t\t\t}\n\t\t\t\t\telse if(fr&&fd)\n\t\t\t\t\t{\n\t\t\t\t\t\tif(fd==fr)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ths[cur].insert(base,val,len);\n\t\t\t\t\t\t\tif(j<m&&!maap[i][j+1]&&i<n&&!maap[i+1][j]) rep(typ,1,q) if(typ^fr&&hav[i][j+1][typ]&&hav[i+1][j][typ]) hs[cur].insert(base|w(typ,(j-1)*4)|w(typ,j*4),val,len+2);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if(j<m&&!maap[i][j+1]&&i<n&&!maap[i+1][j]&&hav[i][j+1][fd]&&hav[i+1][j][fr]) hs[cur].insert(base|w(fr,(j-1)*4)|w(fd,j*4),val,len+2);\n\t\t\t\t\t}\n\t\t\t\t\telse assert(0);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif(fr==fd&&fr) continue;\n\t\t\t\t\tbool afr=0,afd=0;ncc=0;\n\t\t\t\t\tfor(int x:node[i][j]){if(x==fr) afr=1;if(x==fd) afd=1;}\n\t\t\t\t\tif(fr&&!afr) continue;\n\t\t\t\t\tif(fd&&!afd) continue;\n\t\t\t\t\tfor(int x:node[i][j]) if(x^fr&&x^fd) num[++ncc]=x;\n\t\t\t\t\tif(ncc==0)\n\t\t\t\t\t{\n\t\t\t\t\t\ths[cur].insert(base,val,len);\n\t\t\t\t\t}\n\t\t\t\t\telse if(ncc==1)\n\t\t\t\t\t{\n\t\t\t\t\t\tint x=num[1];\n\t\t\t\t\t\tif(j<m&&!maap[i][j+1]&&hav[i][j+1][x]) hs[cur].insert(base|w(x,j    *4),val,len+1);\n\t\t\t\t\t\tif(i<n&&!maap[i+1][j]&&hav[i+1][j][x]) hs[cur].insert(base|w(x,(j-1)*4),val,len+1);\n\t\t\t\t\t}\n\t\t\t\t\telse if(ncc==2)\n\t\t\t\t\t{\n\t\t\t\t\t\tif(j>=m||i>=n||maap[i][j+1]||maap[i+1][j]) continue;\n\t\t\t\t\t\tif(hav[i+1][j][num[1]]&&hav[i][j+1][num[2]]) hs[cur].insert(base|w(num[1],(j-1)*4)|w(num[2],j*4),val,len+2);\n\t\t\t\t\t\tif(hav[i+1][j][num[2]]&&hav[i][j+1][num[1]]) hs[cur].insert(base|w(num[2],(j-1)*4)|w(num[1],j*4),val,len+2);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\trep(i,1,hs[cur].cc) if(!hs[cur].state[i]) return printf(\"%d %lld\\n\",hs[cur].g[i],hs[cur].f[i]),void();\n\tprintf(\"-1 0\\n\");\n}\nsigned main()\n{\n\twhile(1)\n\t{\n\t\tread(n,m,q);\n\t\tif(!(n+m+q)) break;\n\t\tMain();\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1679401852,
        "uid": 251324,
        "name": "stntn",
        "ccfLevel": 0,
        "title": "P3314 [SDOI2014]\u7535\u8def\u677f"
    }
]