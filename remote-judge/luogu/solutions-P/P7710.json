[
    {
        "content": "\u5bf9 [@LHF](https://www.luogu.com.cn/user/99506) dalao \u7684\u9898\u89e3\u8fdb\u884c\u4e00\u4e9b\u8865\u5145\u8bf4\u660e\u3002\u56e0\u4e3a\u4ed6\u8bb2\u7684\u5b9e\u5728\u662f\u592a\u96be\u61c2\u4e86\u3002\u6700\u540e\u5728 [@\\_\u2022\u0301\u3078\u2022\u0301\u256c\\_](https://www.luogu.com.cn/user/90693) dalao \u7684\u5e2e\u52a9\u4e0b\u624d\u52c9\u5f3a\u77e5\u9053\u600e\u4e48\u505a\u3002\u4e0d\u8fc7\u4ed6\u7684\u4ee3\u7801\u975e\u5e38\u7b80\u6d01\u6613\u61c2\uff0c\u6709\u9700\u6c42\u7684\u53ef\u4ee5\u53bb\u770b\u4ed6\u7684\u4ee3\u7801\u3002\u6211\u5c31\u4e0d\u653e\u4e86\u3002\n\n\u672c\u6587\u7ae0\u5206\u6790\u590d\u6742\u5ea6\u65f6\u8ba4\u4e3a $n$ \u4e0e $m$ \u540c\u9636\u3002\n\n---\n\n\u9996\u5148\u9700\u8981\u660e\u786e\u7684\u662f\uff0c$a$ \u5b50\u6811\u4e2d\u6240\u6709\u4e0e $a$ \u7684\u8ddd\u79bb\u6a21 $x$ \u7b49\u4e8e $y$ \u7684\u8282\u70b9\u5c31\u662f $a$ \u5b50\u6811\u4e2d\u6df1\u5ea6\u6a21 $x$ \u7b49\u4e8e $(dep_a+y)\\bmod x$\uff08\u4e0b\u6587\u8bbe\u5176\u4e3a $k$\uff09\u7684\u8282\u70b9\u3002\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u628a\u4fee\u6539\u8f6c\u5316\u4e3a\u5c06\u4e00\u4e2a\u70b9\u7684\u5b50\u6811\u5185\u6240\u6709\u6df1\u5ea6\u6a21 $x$ \u4e3a $k$ \u7684\u8282\u70b9\u6743\u503c\u52a0\u4e0a $z$\u3002\n\n\u663e\u7136\u8fd9\u79cd\u6570\u636e\u7ed3\u6784\u9898\u4e0d\u53ef\u80fd\u4e00\u4e2a\u70b9\u4e00\u4e2a\u70b9\u5730\u53bb\u4fee\u6539\u3002\u56e0\u6b64\u5148\u6c42\u51fa dfn \u5e8f\u3002\u8fd9\u6837\u5c31\u53ef\u4ee5\u628a\u4fee\u6539\u53d8\u4e3a\u5bf9 $[dfn_a,dfn_a+size_a-1]$ \u8303\u56f4\u5185\uff08\u4e0b\u6587\u8bbe\u5176\u4e3a $[l,r]$\uff09\u7684\u70b9\u8fdb\u884c\u4e00\u6b21\u533a\u95f4\u64cd\u4f5c\u3002\n\n\u4f46\u662f\u6211\u4eec\u4e0d\u53ef\u80fd\u5c06 $[l,r]$ \u8303\u56f4\u5185\u7684\u6240\u6709\u503c\u7edf\u4e00\u52a0\u4e0a\u67d0\u6570\u3002\u56e0\u6b64\u8003\u8651\u5efa\u7acb\u4e00\u4e2a\u4ee5 dfn \u5e8f\u4e3a $x$ \u8f74\uff0c\u6df1\u5ea6\u4e3a $y$ \u8f74\u7684\u5e73\u9762\u76f4\u89d2\u5750\u6807\u7cfb\u3002\u628a\u7b2c $i$ \u4e2a\u70b9\u653e\u5728\u5750\u6807 $(dfn_i,dep_i)$ \u4e0a\u3002\u8fd9\u6837\u6211\u4eec\u5c31\u628a\u4fee\u6539\u8f6c\u5316\u4e3a\u5c06\u6240\u6709\u6a2a\u5750\u6807\u5728 $[l,r]$ \u8303\u56f4\u5185\uff0c\u7eb5\u5750\u6807\u6a21 $x=k$ \u7684\u8282\u70b9\u6743\u503c\u5168\u90e8\u52a0\u4e0a $z$\u3002\n\n\u8003\u8651\u76f4\u63a5\u66b4\u529b\u8df3\u7eb5\u5750\u6807\uff0c\u5c06\u8df3\u5230\u7684\u6c34\u5e73\u7ebf\u7684 $[l,r]$ \u90e8\u5206\u5168\u90e8\u52a0\u4e0a $z$\u3002\u56e0\u4e3a dfn \u5e8f\u4e0e\u6df1\u5ea6\u4e0d\u5bf9\u5e94\u7684\u5750\u6807\u662f\u7a7a\u7740\u7684\uff0c\u6ca1\u6709\u653e\u70b9\u3002\u6240\u4ee5\u628a $[l,r]$ \u7684\u6574\u4e2a\u90e8\u5206\u5168\u90e8\u52a0\u4e0a $z$ \u4e0d\u4f1a\u5f71\u54cd\u6b63\u786e\u6027\u3002\n\n\u7528\u67d0\u79cd\u6570\u636e\u7ed3\u6784\u7ef4\u62a4\u6bcf\u4e2a\u7eb5\u5750\u6807\u5bf9\u5e94\u7684\u6c34\u5e73\u7ebf\u3002\u5f53 $x > \\sqrt n$ \u65f6\uff0c\u66b4\u8df3\u7684\u590d\u6742\u5ea6\u5c31\u662f $O(\\sqrt n) \\times O(Modify)$ \u7684\u3002\u67e5\u8be2\u65f6\u76f4\u63a5\u5355\u70b9\u67e5\u8be2\uff0c\u56e0\u6b64\u590d\u6742\u5ea6\u662f $O(1) \\times O(Query)$ \u7684\u3002\u5176\u4e2d $O(Modify)$ \u8868\u793a\u8fd9\u79cd\u6570\u636e\u7ed3\u6784\u4fee\u6539\u7684\u590d\u6742\u5ea6\uff0c$O(Query)$ \u8868\u793a\u5b83\u67e5\u8be2\u7684\u590d\u6742\u5ea6\u3002\u56e0\u6b64\u4f7f\u7528\u4fee\u6539 $O(1)$\uff0c\u67e5\u8be2 $O(\\sqrt n)$ \u7684\u5e8f\u5217\u5206\u5757+\u5dee\u5206\u5373\u53ef\u8fbe\u5230\u6700\u4f18\u603b\u590d\u6742\u5ea6\u3002\n\n\u5f53 $x \\leq \\sqrt n$ \u65f6\uff0c\u66b4\u8df3\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u53ef\u80fd\u4f1a\u76f4\u63a5\u9000\u5316\u5230 $O(n)$\u3002\u56e0\u6b64\u8003\u8651\u6839\u53f7\u5206\u6cbb\uff0c\u5c06\u8fd9\u90e8\u5206\u7279\u6b8a\u5904\u7406\u3002\u5f00\u4e00\u4e2a $\\sqrt n \\times \\sqrt n$ \u7684\u67d0\u79cd\u6570\u636e\u7ed3\u6784\u7684\u6570\u7ec4\uff0c\u8bb0\u4e3a $DS_{i,j}$\u3002\u6bcf\u6b21\u4fee\u6539\u5bf9 $DS_{x,k}$ \u6267\u884c\u4e00\u6b21\u8ba9 $[l,r]$ \u533a\u95f4\u52a0 $z$ \u7684\u64cd\u4f5c\u3002\u8be2\u95ee\u65f6\u7ed9\u7b54\u6848\u52a0\u4e0a $\\sum\\limits_{i=1}^{\\sqrt n} DS(i,dep_a \\bmod i,dfn_a)$ \u5373\u53ef\u3002\u4fee\u6539\u590d\u6742\u5ea6\u4e3a $O(1) \\times O(Modify)$\uff0c\u8be2\u95ee\u590d\u6742\u5ea6\u4e3a $O(\\sqrt n) \\times O(Query)$\u3002\u56e0\u6b64\u4f7f\u7528\u4fee\u6539 $O(\\sqrt n)$\uff0c\u67e5\u8be2 $O(1)$ \u7684\u5e8f\u5217\u5206\u5757\u5373\u53ef\u8fbe\u5230\u6700\u4f18\u603b\u590d\u6742\u5ea6\u3002\n\n\u56e0\u4e3a\u8fd9\u4e24\u79cd\u5904\u7406\u90fd\u7528\u5230\u5206\u5757\uff0c\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u628a\u6563\u5757\u66b4\u529b\u7b97\uff0c\u6574\u5757\u518d\u5206\u7c7b\u8ba8\u8bba\u3002\n\n\u65f6\u7a7a\u590d\u6742\u5ea6 $O(n \\sqrt n)$\u3002\u65f6\u95f4\u9650\u5236\u5341\u5206\u5145\u88d5\uff0c\u4f46\u7a7a\u95f4\u9650\u5236\u4e0d\u591f\u3002\u53ef\u4ee5\u901a\u8fc7\u8c03\u5757\u957f\u548c\u6839\u53f7\u5206\u6cbb\u7684\u9608\u503c\u5361\u8fc7\u53bb\u3002\n\n\u4ee3\u7801\u5c31\u4e0d\u653e\u4e86\uff0c\u6709\u9700\u6c42\u7684\u53ef\u4ee5\u53bb\u770b [@LHF](https://www.luogu.com.cn/user/99506) dalao \u7684\u9898\u89e3\u4e2d\u7684\u4ee3\u7801\u3002\n",
        "postTime": 1670949589,
        "uid": 111789,
        "name": "DRPLANT",
        "ccfLevel": 5,
        "title": "P7710 [Ynoi2077] stdmxeypz \u9898\u89e3"
    },
    {
        "content": "\u4e00\u4e2a\u590d\u6742\u5ea6\u6b63\u786e\uff08$O((n+q)\\sqrt n)$\uff09\u7684\u505a\u6cd5\uff0c\u4f46\u662f\u5e38\u6570\u592a\u5927\u4e0d\u4e00\u5b9a\u80fd\u8fc7\u3002\n\n\u9996\u5148\u770b\u9898\uff0c\u53d1\u73b0\u5c31\u5dee\u628a\u6839\u53f7\u5206\u6cbb\u5199\u5728\u8138\u4e0a\u4e86\u3002\u76f4\u63a5\u8003\u8651\u5bf9 $x$ \u6839\u53f7\u5206\u6cbb\uff0c\u8bbe\u9608\u503c $T$\u3002\n\n\u5bf9\u4e8e $x\\leq T$\uff0c\u79bb\u7ebf\u6240\u6709\u64cd\u4f5c\uff0c\u679a\u4e3e $x$\uff0c\u63d0\u53d6\u51fa\u6a21\u6570\u662f $x$ \u7684\u4fee\u6539\u548c\u6240\u6709\u67e5\u8be2\u3002\u7136\u540e\u679a\u4e3e\u4f59\u6570 $r$\uff0c\u5bf9\u4e8e\u64cd\u4f5c\u6df1\u5ea6\uff08\u5373\u4fee\u6539\u3001\u67e5\u8be2\u7684\u70b9\u7684\u6df1\u5ea6\uff09\u6a21 $x$ \u7b49\u4e8e $r$ \u7684\u6240\u6709\u64cd\u4f5c\u8fdb\u884c\u5904\u7406\u3002\u6b64\u65f6\u53ef\u4ee5\u53d1\u73b0\u95ee\u9898\u88ab\u8f6c\u5316\u4e3a\u5b50\u6811\u52a0\u5355\u70b9\u6c42\u503c\u3002\n\n\u63a5\u4e0b\u6765\u9700\u8981\u5206\u6790\u4e00\u4e0b\u64cd\u4f5c\u6b21\u6570\u3002\u4e00\u4e2a\u4fee\u6539\u8fd8\u662f\u4e00\u4e2a\u4fee\u6539\uff0c\u6ca1\u6709\u53d8\u5316\uff1b\u4f46\u662f\u6b64\u65f6\u4e00\u4e2a\u67e5\u8be2\u4f1a\u88ab\u62c6\u6210 $T$ \u4e2a\u67e5\u8be2\u3002\u56e0\u6b64\u9700\u8981\u5f15\u5165\u6839\u53f7\u5e73\u8861\uff0c\u5177\u4f53\u6765\u8bf4\u9700\u8981\u652f\u6301 $O(\\sqrt n)$ \u533a\u95f4\u52a0 $O(1)$ \u5355\u70b9\u6c42\u503c\uff0c\u5bb9\u6613\u4f7f\u7528\u5206\u5757\u5b8c\u6210\u3002\n\n\u5bf9\u4e8e $x>T$\uff0c\u66b4\u529b\u5c06\u4fee\u6539\u62c6\u6210\u6bcf\u4e00\u5c42\u4e0a\u9762\u7684\u533a\u95f4\u52a0\uff0c\u7136\u540e\u679a\u4e3e\u6bcf\u4e00\u5c42\uff0c\u95ee\u9898\u518d\u6b21\u53d8\u4e3a\u533a\u95f4\u52a0\u5355\u70b9\u6c42\u503c\uff0c\u4f46\u662f\u4e0d\u540c\u7684\u662f\u8fd9\u4e00\u6b21\u4fee\u6539\u64cd\u4f5c\u88ab\u62c6\u7684\u5f88\u591a\uff0c\u800c\u4e0d\u662f\u67e5\u8be2\u64cd\u4f5c\u3002\u4f7f\u7528\u5206\u5757+\u5dee\u5206\u53ef\u4ee5\u5b9e\u73b0 $O(1)$ \u533a\u95f4\u52a0 $O(\\sqrt n)$ \u5355\u70b9\u6c42\u503c\u3002\n\n\u53d6 $T=\\sqrt n$\uff0c\u5373\u53ef\u505a\u5230\u603b\u590d\u6742\u5ea6 $O((n+q)\\sqrt n)$\u3002\n\n\u5361\u5e38\uff1a\n\n- \u6254\u6389\u6240\u6709 vector\uff0c\u7528\u6570\u7ec4+\u6307\u9488\u9759\u6001\u5206\u914d\u5185\u5b58\u3002\n- $\\leq T$ \u7684\u90e8\u5206\u53ef\u4ee5\u628a\u6ca1\u6709\u4fee\u6539\u7684 $x$ \u8df3\u8fc7\uff0c\u4e0d\u7528\u518d\u904d\u5386\u4e00\u904d\u64cd\u4f5c\u3002\n- \u5faa\u73af\u5c55\u5f00\u3002\n- \u8c03\u9608\u503c\u3002\n- ~~\u591a\u4ea4\u51e0\u6b21\u3002~~\n\n\u987a\u4fbf\u731c\u4e00\u4e0b\u9898\u76ee\u540d\u542b\u4e49\uff1a**s**ub**t**ree **d**istance **m**odulo **x** **e**qual **y** **p**lus **z**\n\n```cpp\nconst int N = 300005, S = 555;\nstruct Edge {\n\tint to, nxt;\n\tEdge() {\n\t\tnxt = -1;\n\t}\n};\nstruct Decomp {\n\tint n, s, val[N], sum[S], pos[N], bl[S], br[S], tag[S];\n\tinline void Init(int len) {\n\t\tn = len;\n\t\ts = max(1, (int)sqrt(n));\n\t\tfor (int i = 1;i <= n;i++) {\n\t\t\tpos[i] = (i - 1) / s + 1;\n\t\t\tval[i] = sum[pos[i]] = tag[pos[i]] = 0;\n\t\t}\n\t\tfor (int i = 1;i <= pos[n];i++) {\n\t\t\tbl[i] = (i - 1) * s + 1;\n\t\t\tbr[i] = i * s;\n\t\t}\n\t\tbr[pos[n]] = n;\n\t}\n\tinline void Add(int l, int r, int x) {\n\t\tif (r > n) return;\n\t\tif (pos[l] == pos[r]) {\n\t\t\tfor (int i = l;i <= r;i++) {\n\t\t\t\tval[i] += x;\n\t\t\t}\n\t\t\tsum[pos[l]] += (r - l + 1) * x;\n\t\t\treturn;\n\t\t}\n\t\tint i;\n\t\tfor (i = l;i + 7 <= br[pos[l]];i += 8) {\n\t\t\tval[i + 0] += x;\n\t\t\tval[i + 1] += x;\n\t\t\tval[i + 2] += x;\n\t\t\tval[i + 3] += x;\n\t\t\tval[i + 4] += x;\n\t\t\tval[i + 5] += x;\n\t\t\tval[i + 6] += x;\n\t\t\tval[i + 7] += x;\n\t\t}\n\t\tswitch (br[pos[l]] - i) {\n\t\t\tcase 6: val[i + 6] += x;\n\t\t\tcase 5: val[i + 5] += x;\n\t\t\tcase 4: val[i + 4] += x;\n\t\t\tcase 3: val[i + 3] += x;\n\t\t\tcase 2: val[i + 2] += x;\n\t\t\tcase 1: val[i + 1] += x;\n\t\t\tcase 0: val[i + 0] += x;\n\t\t}\n\t\tsum[pos[l]] += (br[pos[l]] - l + 1) * x;\n\t\tfor (i = pos[l] + 1;i + 7 < pos[r];i += 8) {\n\t\t\ttag[i + 0] += x; sum[i + 0] += (br[i + 0] - bl[i + 0] + 1) * x;\n\t\t\ttag[i + 1] += x; sum[i + 1] += (br[i + 1] - bl[i + 1] + 1) * x;\n\t\t\ttag[i + 2] += x; sum[i + 2] += (br[i + 2] - bl[i + 2] + 1) * x;\n\t\t\ttag[i + 3] += x; sum[i + 3] += (br[i + 3] - bl[i + 3] + 1) * x;\n\t\t\ttag[i + 4] += x; sum[i + 4] += (br[i + 4] - bl[i + 4] + 1) * x;\n\t\t\ttag[i + 5] += x; sum[i + 5] += (br[i + 5] - bl[i + 5] + 1) * x;\n\t\t\ttag[i + 6] += x; sum[i + 6] += (br[i + 6] - bl[i + 6] + 1) * x;\n\t\t\ttag[i + 7] += x; sum[i + 7] += (br[i + 7] - bl[i + 7] + 1) * x;\n\t\t}\n\t\tswitch (pos[r] - i - 1) {\n\t\t\tcase 6: tag[i + 6] += x; sum[i + 6] += (br[i + 6] - bl[i + 6] + 1) * x;\n\t\t\tcase 5: tag[i + 5] += x; sum[i + 5] += (br[i + 5] - bl[i + 5] + 1) * x;\n\t\t\tcase 4: tag[i + 4] += x; sum[i + 4] += (br[i + 4] - bl[i + 4] + 1) * x;\n\t\t\tcase 3: tag[i + 3] += x; sum[i + 3] += (br[i + 3] - bl[i + 3] + 1) * x;\n\t\t\tcase 2: tag[i + 2] += x; sum[i + 2] += (br[i + 2] - bl[i + 2] + 1) * x;\n\t\t\tcase 1: tag[i + 1] += x; sum[i + 1] += (br[i + 1] - bl[i + 1] + 1) * x;\n\t\t\tcase 0: tag[i + 0] += x; sum[i + 0] += (br[i + 0] - bl[i + 0] + 1) * x;\n\t\t}\n\t\tfor (i = bl[pos[r]];i + 7 <= r;i += 8) {\n\t\t\tval[i + 0] += x;\n\t\t\tval[i + 1] += x;\n\t\t\tval[i + 2] += x;\n\t\t\tval[i + 3] += x;\n\t\t\tval[i + 4] += x;\n\t\t\tval[i + 5] += x;\n\t\t\tval[i + 6] += x;\n\t\t\tval[i + 7] += x;\n\t\t}\n\t\tswitch (r - i) {\n\t\t\tcase 6: val[i + 6] += x;\n\t\t\tcase 5: val[i + 5] += x;\n\t\t\tcase 4: val[i + 4] += x;\n\t\t\tcase 3: val[i + 3] += x;\n\t\t\tcase 2: val[i + 2] += x;\n\t\t\tcase 1: val[i + 1] += x;\n\t\t\tcase 0: val[i + 0] += x;\n\t\t}\n\t\tsum[pos[r]] += (r - bl[pos[r]] + 1) * x;\n\t}\n\tinline int Query(int l, int r) {\n\t\tif (pos[l] == pos[r]) {\n\t\t\tint ans = 0;\n\t\t\tfor (int i = l;i <= r;i++) ans += val[i];\n\t\t\treturn ans + (r - l + 1) * tag[pos[l]];\n\t\t}\n\t\tint ans = 0;\n\t\tfor (int i = l;i <= br[pos[l]];i++) ans += val[i];\n\t\tans += (br[pos[l]] - l + 1) * tag[pos[l]];\n\t\tfor (int i = pos[l] + 1;i < pos[r];i++) ans += sum[i];\n\t\tfor (int i = bl[pos[r]];i <= r;i++) ans += val[i];\n\t\tans += (r - bl[pos[r]] + 1) * tag[pos[r]];\n\t\treturn ans;\n\t}\n};\nint n, q, ans[N], dfn[N], pst[N], _time, dep[N];\nbool flag[N];\nstruct Query {\n\tint type, a, x, y, z, idx;\n};\nQuery qry[N];\nstruct smallXsolver {\n\tDecomp dcp;\n\tint stk[N], stktop, optcnt[S];\n\tQuery poolOpt[2 * N], *opt[S];\n\tvector <Query> idx;\n\tinline void Work(int x, int *h, Edge *g) {\n\t\t_time = 0;\n\t\tdep[1] = 0;\n\t\tidx.clear();\n\t\tmemset(optcnt, 0, sizeof(optcnt));\n\t\tfor (int i = 1;i <= q;i++) {\n\t\t\tif (qry[i].type == 1 && qry[i].x == x || qry[i].type == 2) idx.push_back(qry[i]);\n\t\t\tif (qry[i].type == 1 && qry[i].x == x) optcnt[(dep[qry[i].a] + qry[i].y) % x]++;//opt[(dep[qry[i].a] + qry[i].y) % x].push_back(qry[i]);\n\t\t\telse if (qry[i].type == 2) optcnt[dep[qry[i].a] % x]++;//opt[dep[qry[i].a] % x].push_back(qry[i]);\n\t\t}\n\t\topt[0] = poolOpt;\n\t\tfor (int i = 1;i < x;i++) opt[i] = opt[i - 1] + optcnt[i - 1] + 2;\n\t\tmemset(optcnt, 0, sizeof(optcnt));\n\t\tint siz = idx.size();\n\t\tfor (int i = 0;i < siz;i++) {\n\t\t\tif (idx[i].type == 1) {\n\t\t\t\topt[(dep[idx[i].a] + idx[i].y) % x][++optcnt[(dep[idx[i].a] + idx[i].y) % x]] = idx[i];\n\t\t\t} else {\n\t\t\t\topt[dep[idx[i].a] % x][++optcnt[dep[idx[i].a] % x]] = idx[i];\n\t\t\t}\n\t\t}\n\t\tdcp.Init(n);\n\t\tfor (int i = 0;i < x;i++) {\n\t\t\tint siz = optcnt[i];\n\t\t\t/*\n\t\t\tfor (int j = 0;j < siz;j++) {\n\t\t\t\tif (opt[i][j].type == 1) printf(\"Add [%d,%d] %d\\n\", dfn[opt[i][j].a], pst[opt[i][j].a], opt[i][j].z);\n\t\t\t\telse printf(\"Query %d\\n\", dfn[opt[i][j].a]);\n\t\t\t}\n\t\t\t*/\n\t\t\tfor (int j = 1;j <= siz;j++) {\n\t\t\t\tif (opt[i][j].type == 1) dcp.Add(dfn[opt[i][j].a], pst[opt[i][j].a], opt[i][j].z);\n\t\t\t\telse ans[opt[i][j].idx] += dcp.Query(dfn[opt[i][j].a], dfn[opt[i][j].a]);\n\t\t\t}\n\t\t\tfor (int j = 1;j <= siz;j++) {\n\t\t\t\tif (opt[i][j].type == 1) dcp.Add(dfn[opt[i][j].a], pst[opt[i][j].a], -opt[i][j].z);\n\t\t\t}\n\t\t}\n\t}\n};\nsmallXsolver sol1;\nint hd[N], pnt, mxd;\nEdge e[N << 1];\nint cnt[N], pool[100000005], *lev[N], modcnt[N], qrycnt[N];\nDecomp dcp;\n\ninline void AddEdge(int u, int v) {\n\te[++pnt].to = v;\n\te[pnt].nxt = hd[u];\n\thd[u] = pnt;\n}\n\ninline void Read() {\n\tn = qread(); q = qread();\n\tfor (int i = 2;i <= n;i++) AddEdge(qread(), i);\n\tfor (int i = 1;i <= q;i++) {\n\t\tqry[qry[i].idx = i].type = qread(); qry[i].a = qread();\n\t\tif (qry[i].type == 1) {\n\t\t\tflag[qry[i].x = qread()] = 1; qry[i].y = qread(); qry[i].z = qread();\n\t\t}\n\t}\n}\n\ninline void Dfs(int u, int fa) {\n\tmxd = max(mxd, dep[u]);\n\tdfn[u] = ++_time;\n\tfor (int i = hd[u];~i;i = e[i].nxt) {\n\t\tif (e[i].to != fa) {\n\t\t\tdep[e[i].to] = dep[u] + 1;\n\t\t\tDfs(e[i].to, u);\n\t\t}\n\t}\n\tpst[u] = _time;\n}\n\ninline void Solve() {\n\tint T = max(1, (int)(sqrt(mxd) / 1.3));\n\t//T = 2;\n\t//printf(\"T=%d\\n\", T);\n\tfor (int i = 1;i <= T;i++) {\n\t\tif (flag[i]) sol1.Work(i, hd, e);\n\t}\n\t/*\n\tfor (int i = 1;i <= q;i++) {\n\t\tif (qry[i].type == 2) printf(\"%d\\n\", ans[i]);\n\t}\n\tputs(\"------\");\n\t*/\n\tfor (int i = 1;i <= q;i++) {\n\t\tif (qry[i].type == 1 && qry[i].x > T) {\n\t\t\tfor (int j = dep[qry[i].a] + qry[i].y;j <= mxd;j += qry[i].x) {\n\t\t\t\tcnt[j]++;\n\t\t\t\tmodcnt[j]++;\n\t\t\t}\n\t\t} else if (qry[i].type == 2) {\n\t\t\tcnt[dep[qry[i].a]]++; qrycnt[dep[qry[i].a]]++;\n\t\t}\n\t}\n\tlev[0] = pool;\n\tfor (int i = 1;i <= mxd;i++) lev[i] = lev[i - 1] + cnt[i - 1] + 1;\n\tmemset(cnt, 0, sizeof(cnt));\n\tfor (int i = 1;i <= q;i++) {\n\t\tif (qry[i].type == 1 && qry[i].x > T) {\n\t\t\tfor (int j = dep[qry[i].a] + qry[i].y;j <= mxd;j += qry[i].x) lev[j][cnt[j]++] = i;\n\t\t} else if (qry[i].type == 2) {\n\t\t\tlev[dep[qry[i].a]][cnt[dep[qry[i].a]]++] = i;\n\t\t}\n\t}\n\tdcp.Init(n);\n\tfor (int i = 0;i <= mxd;i++) {\n\t\tint siz = cnt[i];\n\t\tif (!modcnt[i] || !qrycnt[i]) continue;\n\t\tfor (int j = 0;j < siz;j++) {\n\t\t\tQuery cur = qry[lev[i][j]];\n\t\t\tif (cur.type == 1) {\n\t\t\t\t//printf(\"add [%d,%d] %d\\n\", dfn[cur.a], pst[cur.a], cur.z);\n\t\t\t\tdcp.Add(dfn[cur.a], dfn[cur.a], cur.z);\n\t\t\t\tdcp.Add(pst[cur.a] + 1, pst[cur.a] + 1, -cur.z);\n\t\t\t} else {\n\t\t\t\t//printf(\"query %d\\n\", dfn[cur.a]);\n\t\t\t\tans[cur.idx] += dcp.Query(1, dfn[cur.a]);\n\t\t\t}\n\t\t}\n\t\tfor (int j = 0;j < siz;j++) {\n\t\t\tQuery cur = qry[lev[i][j]];\n\t\t\tif (cur.type == 1) {\n\t\t\t\tdcp.Add(dfn[cur.a], dfn[cur.a], -cur.z);\n\t\t\t\tdcp.Add(pst[cur.a] + 1, pst[cur.a] + 1, cur.z);\n\t\t\t}\n\t\t}\n\t}\n\tfor (int i = 1;i <= q;i++) {\n\t\tif (qry[i].type == 2) printf(\"%d\\n\", ans[i]);\n\t}\n}\n```",
        "postTime": 1628414359,
        "uid": 61088,
        "name": "Solystic",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P7710 \u3010[Ynoi2077] stdmxeypz\u3011"
    },
    {
        "content": "\u5410\u69fd\u4e00\u4e0b\uff0c\u4e3a\u4ec0\u4e48 $O(n\\sqrt{n}\\log n)$ \u6ca1\u5361\u5e38\u80fd\u8fc7 $3\\times 10^5$\uff1f\uff1f\uff1f  \n\u601d\u8def\u662f\u8fd9\u6837\u7684\uff0c\u8fd9\u4e2a\u9898\u76ee\u770b\u8d77\u6765\u4e0d\u597d\u76f4\u63a5\u5bf9\u5b50\u6811\u8fdb\u884c\u4fee\u6539\uff0c\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u79bb\u7ebf\u3002  \n\u4e00\u4e2a\u4fee\u6539\u5bf9\u4e00\u4e2a\u8be2\u95ee\u4ea7\u751f\u8d21\u732e\u7684\u6761\u4ef6\u662f\u8fd9\u4e2a\u8be2\u95ee\u7ed3\u70b9\u5728\u4fee\u6539\u7ed3\u70b9\u7684\u5b50\u6811\u4e2d\uff0c\u8be2\u95ee\u7684\u65f6\u95f4\u5728\u4fee\u6539\u540e\uff0c\u800c\u4e14\u8be2\u95ee\u7ed3\u70b9\u7684\u6df1\u5ea6\u6ee1\u8db3\u4fee\u6539\u7684\u8981\u6c42\u3002\u6211\u4eec\u53ef\u4ee5\u7528 dfn \u5e8f\u5c06\u6811\u62cd\u6241\uff0c\u8bbe dfn \u5e8f\u4e0a\u4e00\u4e2a\u70b9\u7684\u5b50\u6811\u5de6\u53f3\u533a\u95f4\u4e3a $l_i\\sim r_i$\u3002  \n\u5219\u5f62\u5f0f\u5316\u8868\u793a\u4fee\u6539\u5bf9\u8be2\u95ee\u7684\u8d21\u732e\u6761\u4ef6\u4e3a $t_i<t_j,l_j\\in [l_i,r_i],d_j\\equiv y_i+d_i\\pmod{x_i}$\uff0c\u7b2c\u4e00\u7ef4\u5929\u7136\u5df2\u7ecf\u5f04\u597d\uff0c\u7b2c\u4e8c\u7ef4\u6211\u4eec\u5c06\u5176\u5dee\u5206\u6210 $l$ \u548c $r+1$ \u4e24\u4e2a\u4fee\u6539\u5373\u53ef\u7528 cdq \u5206\u6cbb\u5b8c\u6210\u3002\u7b2c\u4e09\u7ef4\u6211\u4eec\u7528\u9608\u503c\u5206\u6cbb\u5373\u53ef\u3002\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\sqrt{n}\\log n)$\uff0c\u5e38\u6570\u8f83\u5c0f\uff0c\u76ee\u524d\u4e0d\u9700\u8981\u5361\u5e38\u3002  \n\u5982\u679c\u88ab\u5361\u5e38\u4e86\uff0c\u4e5f\u6709\u65b9\u6cd5\u5e94\u5bf9\uff08\u4f46\u5f3a\u5236\u5728\u7ebf\u7684\u8bdd\u76f4\u63a5\u5b8c\u86cb\uff09\uff1a\u6211\u4eec\u9700\u8981\u60f3\u4e00\u4e9b\u7384\u5b66\u529e\u6cd5\u51cf\u5c11\u4fee\u6539\u6b21\u6570\u3002  \n1. \u5982\u679c\u4e00\u4e2a\u4fee\u6539 $r_i-l_i\\le \\sqrt{n}$\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u66b4\u529b\u4fee\u6539\u3002  \n2. \u5982\u679c\u4e00\u4e2a\u4fee\u6539 $l_i\\le \\sqrt{n}$\uff0c\u6211\u4eec\u53ef\u4ee5\u8f6c\u5316\u4e3a\u4e00\u4e2a\u5168\u5c40\u4fee\u6539\uff0c\u518d\u79fb\u9664\u524d\u9762\u7684\u8d21\u732e\u3002  \n3. \u5982\u679c\u4e00\u4e2a\u4fee\u6539 $r_i\\ge n-\\sqrt{n}$\uff0c\u6211\u4eec\u53ef\u4ee5\u66b4\u529b\u64a4\u9500\u8d21\u732e\u3002\n\n\u52a0\u4e0a\u8fd9\u4e09\u4e2a\u5361\u5e38\uff0c\u4ee5\u53ca fread\uff0c\u80fd\u5728 3 \u79d2\u5185\u8dd1\u51fa\u4e00\u4e2a\u70b9\u3002\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nconst int maxn=3e5+5,maxm=549;\ninline int read() {\n\tint __x=0,__f=1;\n\tchar __c=getchar();\n\twhile(__c<'0'||__c>'9') {\n\t\tif(__c=='-')__f=-1;\n\t\t__c=getchar();\n\t}\n\twhile(__c>='0'&&__c<='9') {\n\t\t__x=__x*10+__c-'0';\n\t\t__c=getchar();\n\t}\n\treturn __x*__f;\n}\nstruct node {\n\tint p,op,x,y,v;//v->id when op=1\n\tnode() {}\n\tnode(int P,int Op,int V,int X,int Y=0) {\n\t\tp=P,op=Op,v=V,x=X,y=Y;\n\t}\n} p[maxn*2],zc[maxn*2];\nstruct edge {\n\tint next,to;\n} e[maxn];\nint l[maxn],r[maxn],d[maxn],h[maxn],cnt,d1[maxm][maxm],d2[maxn],maxd,n,m,pos,ans[maxn],sn,qc,tot;\nvoid addedge(int x,int y) {\n\te[++cnt].next=h[x];\n\te[cnt].to=y;\n\th[x]=cnt;\n}\nvoid dfs(int u) {\n\tl[u]=++pos;\n\tmaxd=max(maxd,d[u]);\n\tfor(register int i=h[u]; i; i=e[i].next) {\n\t\tint j=e[i].to;\n\t\td[j]=d[u]+1;\n\t\tdfs(j);\n\t}\n\tr[u]=pos;\n}\nvoid add(int x,int y,int v) {\n\tif(x<=sn)d1[x][y]+=v;\n\telse for(; y<=maxd; y+=x)d2[y]+=v;//\u7ed9\u6a21x\u4e3ay\u52a0v\n}\nvoid clr(int x,int y) {\n\tif(x<=sn)d1[x][y]=0;\n\telse for(; y<=maxd; y+=x)d2[y]=0;//\u6e05\u7a7a\n}\nint ask(int x) {\n\tint sum=d2[x];\n\tfor(register int i=1; i<=sn; i++)sum+=d1[i][x%i];\n\treturn sum;//\u5c06\u4e24\u90e8\u5206\u7b54\u6848\u52a0\u8d77\u6765\n}\nvoid cdq(int l,int r) {\n\tif(l==r)return;\n\tint mid=(l+r)/2,i=l,j=mid+1,k=l;\n\tcdq(l,mid),cdq(mid+1,r);\n\twhile(i<=mid&&j<=r) {\n\t\tif(p[i].p<=p[j].p) {\n\t\t\tif(!p[i].op)add(p[i].x,p[i].y,p[i].v);\n\t\t\tzc[k++]=p[i++];\n\t\t} else {\n\t\t\tif(p[j].op)ans[p[j].v]+=ask(p[j].x);\n\t\t\tzc[k++]=p[j++];\n\t\t}\n\t}\n\twhile(j<=r) {\n\t\tif(p[j].op)ans[p[j].v]+=ask(p[j].x);\n\t\tzc[k++]=p[j++];\n\t}\n\tfor(register int w=l; w<i; w++)if(!p[w].op)clr(p[w].x,p[w].y);\n\twhile(i<=mid)zc[k++]=p[i++];\n\tfor(register int w=l; w<=r; w++)p[w]=zc[w];//\u4e00\u4e2a\u666e\u901a\u7684cdq\u5206\u6cbb\n}\nint main() {\n\tint op,a,x,y,v;\n\tn=read(),m=read();\n\tsn=sqrt(n);\n\tfor(register int i=2; i<=n; i++)a=read(),addedge(a,i);\n\tdfs(1);\n\tfor(register int i=1; i<=m; i++) {\n\t\top=read(),a=read();\n\t\tif(op==2)p[++tot]=node(l[a],1,++qc,d[a]);\n\t\telse {\n\t\t\tx=read(),y=read(),v=read();\n\t\t\tp[++tot]=node(l[a],0,v,x,(d[a]+y)%x);\n\t\t\tp[++tot]=node(r[a]+1,0,-v,x,(d[a]+y)%x);\n\t\t}\n\t}\n\tcdq(1,tot);\n\tfor(register int i=1; i<=qc; i++)printf(\"%d\\n\",ans[i]);\n\treturn 0;\n}\n```",
        "postTime": 1618132022,
        "uid": 104324,
        "name": "abruce",
        "ccfLevel": 7,
        "title": "\u9898\u89e3--[Ynoi2012] WC, THUWC, CTSC \u4e0e APIO2017"
    },
    {
        "content": "\u65f6\u95f4\u590d\u6742\u5ea6$O(n\\sqrt{n})$\u7684\u505a\u6cd5\u5df2\u7ecf\u6709\u4eba\u5199\u8fc7\u4e86\uff0c\u4f46\u662f\u90a3\u4f4ddalao\u7684\u7a7a\u95f4\u590d\u6742\u5ea6\u4e5f\u662f$O(n\\sqrt{n})$\u7684\u3002\u90a3\u4e48\uff0c\u6211\u5c31\u6765\u5199\u4e00\u4e2a\u65f6\u95f4$O(n\\sqrt{n})$\u4f46\u7a7a\u95f4\u590d\u6742\u5ea6\u66f4\u4f18\u7684\u505a\u6cd5\u3002\n\n\u8fb9\u753b\u56fe\u8fb9\u770b\u7406\u89e3\u6548\u679c\u66f4\u597d\u54e6\n\n#### \u524d\u7f6e\u829d\u58eb\n\n\u5fc5\u987b\uff1a\u6839\u53f7\u5206\u6cbb\uff0c\u5206\u5757\uff0cdfs\u5e8f\uff0cbfs\u5e8f\n\n\u53ef\u9009\uff1a\u957f\u94fe\u5256\u5206\uff08\u5982\u679c\u4f60\u60f3\u505a\u5230$O(nlogn)$\u7a7a\u95f4\u7684\u8bdd\uff09\uff0c\u770b\u8bba\u6587\u5e76\u5b9e\u73b0\u5176\u7b97\u6cd5\u7684\u80fd\u529b\uff08\u5982\u679c\u4f60\u60f3\u505a\u5230\u7ebf\u6027\u7a7a\u95f4\u7684\u8bdd\uff09\n\n### \u9898\u610f\n\n\u5927\u6982\u5c31\u662fp5309\u7684\u6811\u4e0a\u7248\uff0c\u53ea\u662f\u67e5\u8be2\u6539\u6210\u4e86\u5355\u70b9\u6c42\u503c\uff08\u5e76\u4e0d\u77e5\u9053\u5982\u679c\u6539\u6210\u5b50\u6811\u548c\u5565\u7684\u8fd8\u80fd\u4e0d\u80fd\u505a\uff09\n\n## \u9898\u89e3\n\n\u4ee5\u4e0b\u5047\u8bben\u4e0em\u540c\u9636\n\n\u65e2\u7136p5309\u662f\u5feb\u4e50\u7684\u6839\u53f7\u5206\u6cbb\uff0c\u90a3\u8fd9\u9898\u4e5f\u5148\u60f3\u60f3\u6839\u53f7\u5206\u6cbb\u600e\u4e48\u641e\u5566\n\n\u9996\u5148\u5f88\u660e\u663e\u7684\uff0c\u4e00\u4e2a\u70b9\u6240\u6709\u7684k\u7ea7\u540e\u4ee3\u5728bfs\u5e8f\u4e0a\u662f\u8fde\u7eed\u7684\uff0c\u6240\u4ee5\u53ea\u8981\u627e\u51fa\u8fd9\u4e2a\u533a\u95f4\u7136\u540e\u968f\u4fbf\u5f04\u4e2a\u6570\u636e\u7ed3\u6784\u6765\u641e\u8fd9\u4e2a\u533a\u95f4\u52a0\u5355\u70b9\u6c42\u503c\u5c31\u884c\u4e86\u3002\u7136\u540e\u5f53$x>\\sqrt{n}$\u65f6\u6700\u591a\u5c31\u5f80\u4e0b\u8df3$\\sqrt{n}$\u6b21\uff0c\u6240\u4ee5\u603b\u5171$O(n\\sqrt{n})$\u6b21\u533a\u95f4\u52a0\uff0c$O(n)$\u6b21\u5355\u70b9\u67e5\u8be2\uff0c\u7528\u5206\u5757\u5c31\u80fd\u505a\u5230$O(1)$\u4fee\u6539$O(\\sqrt{n})$\u67e5\u8be2\uff0c\u4e8e\u662f\u8fd9\u91cc\u5c31\u662f$O(n\\sqrt{n})$\u7684\u4e86\uff0c\u7a7a\u95f4\u7ebf\u6027\u3002\u53ea\u6709\u4e00\u4e2a\u95ee\u9898\uff0ck\u7ea7\u540e\u4ee3\u600e\u4e48\u627e\uff0c\u8fd9\u4e2a\u5f85\u4f1a\u8bf4\u3002\n\n\u5bf9\u4e8e$x\u2264\\sqrt{n}$\u7684\u90e8\u5206\u5c31\u4e0d\u80fd\u8fd9\u4e48\u641e\u4e86\u3002\u5bf9\u4e8e\u8fd9\u4e2a\uff0c\u6211\u4eec\u679a\u4e3ex\uff0c\u5efa\u8f85\u52a9\u6811(\u68ee\u6797)$T_{x}$\uff0c\u5728$T_{x}$\u91cc\u4e00\u4e2a\u70b9\u7684\u7236\u4eb2\u662f\u5b83\u5728\u539f\u6811\u91cc\u7684\u7b2cx\u7ea7\u7956\u5148\uff0c\u5982\u679c\u6ca1\u6709\u90a3\u5c31\u8bbe\u4e3a0\u3002\u4e8e\u662f\u5f53$y=0$\u65f6\u5c31\u53d8\u6210\u4e86\u4e2a\u5b50\u6811\u52a0\u5355\u70b9\u67e5\u8be2\u95ee\u9898\uff0c\u7528dfs\u5e8f\u8f6c\u5316\u6210\u5e8f\u5217\u533a\u95f4\u52a0\u5355\u70b9\u67e5\u8be2\u3002\u90a3\u5982\u679c$y\u22600$\u5462\uff1f\u5982\u679c\u5728\u5f04dfs\u5e8f\u65f6\u6309\u539f\u6811bfs\u5e8f\u6765\u679a\u4e3e\u7236\u4eb2\u4e3a0\u7684\u70b9\u7136\u540e\u8fdb\u884cdfs\uff0c\u56e0\u4e3a$y<x$\uff0c\u53ef\u4ee5\u8bc1\u660e\u5f53$y\u22600$\u65f6\u5e94\u8be5\u52a0\u503c\u7684\u70b9\uff08\u5373\u70b9a\u7684y\u7ea7\u540e\u4ee3\u548c\u4ee5\u5b83\u4eec\u4e3a\u6839\u7684\u5b50\u6811\uff09\u5728\u8fd9\u4e2adfs\u5e8f\u4e0a\u8fd8\u662f\u8fde\u7eed\u7684\uff0c\u6240\u4ee5\u53ea\u8981\u77e5\u9053\u8fd9\u4e9b\u70b9\u5728dfs\u5e8f\u4e0a\u5bf9\u5e94\u7684\u533a\u95f4\u5c31\u884c\u4e86\uff0c\u5efa$T_{x}$\u65f6\u9884\u5904\u7406\u4e00\u4e9b\u4fe1\u606f\u5c31\u53c8\u53d8\u6210\u4e86\u627e\u4e00\u4e2a\u70b9\u7684k\u7ea7\u540e\u4ee3\u7684\u95ee\u9898\u4e86\u3002\u5173\u4e8e\u5efa$T_{x}$\u90e8\u5206\uff0c$T_{x}$\u53ef\u4ee5\u7531$T_{x-1}$\u7ebf\u6027\u65f6\u95f4\u5904\u7406\u800c\u6765\u3002\u7136\u540e\u6bcf\u6b21\u90fd\u8981\u626b\u4e00\u904d\u6240\u6709\u8be2\u95ee\uff0c\u53ea\u5904\u7406\u6a21\u6570\u4e3ax\u7684\u4fee\u6539\uff0c\u4f46\u5bf9\u6240\u6709\u8be2\u95ee\u90fd\u8981\u67e5\u8be2\u4e00\u6b21\u7b97\u8d21\u732e\uff0c\u8fd9\u91cc\u6709$O(n)$\u6b21\u533a\u95f4\u52a0\uff0c$O(n\\sqrt{n})$\u6b21\u5355\u70b9\u67e5\u8be2\uff0c\u5206\u5757\u6539\u6539\u5c31\u80fd\u505a\u5230$O(\\sqrt{n})$\u4fee\u6539$O(1)$\u67e5\u8be2\uff0c\u4e8e\u662f\u8fd9\u91cc\u53c8\u662f\u65f6\u95f4$O(n\\sqrt{n})$\u7a7a\u95f4\u7ebf\u6027\u7684\u4e86\u3002\n\n\u63a5\u4e0b\u6765\u8981\u89e3\u51b3\u5982\u4f55\u627e\u4e00\u4e2a\u70b9\u7684k\u7ea7\u540e\u4ee3\u7684\u95ee\u9898\u3002\u7531\u4e8e\u8fd9\u4e9b\u70b9\u5728bfs\u5e8f\u4e0a\u8fde\u7eed\uff0c\u6240\u4ee5\u5b9e\u9645\u8981\u627e\u7684\u662f\u8fd9\u4e9b\u70b9\u91cc\u6700\u5de6\u8fb9\u7684\u4e00\u4e2a\u548c\u6700\u53f3\u8fb9\u7684\u4e00\u4e2a\u3002~~\u6559\u7ec3\u6211\u4f1a\u500d\u589e~~ \u5148\u4e0d\u8bf4\u7528\u500d\u589e\u65f6\u95f4\u590d\u6742\u5ea6\u4f1a\u591a\u4e2alog\uff0c\u6709\u4e2a\u95ee\u9898\uff0c\u70b9a\u7684y\u7ea7\u540e\u4ee3\u6700\u5de6\u8fb9\u7684\u4e00\u4e2a\uff0cy+x\u7ea7\u540e\u4ee3\u6700\u5de6\u8fb9\u7684\u4e00\u4e2a\uff0cy+2x\u7ea7\u540e\u4ee3\u6700\u5de6\u8fb9\u7684\u4e00\u4e2a\u2026\u2026\u8fd9\u4e9b\u70b9\u4e0d\u4e00\u5b9a\u5728\u4ee5a\u4e3a\u8def\u5f84\u7aef\u70b9\u7684\u4e00\u6761\u8def\u5f84\u4e0a\uff0c\u6bd4\u5982\u4e0b\u9762\u8fd9\u68f5\u6811\uff08\u5148\u4e0d\u7ba1\u865a\u7ebf\uff09\uff0c1\u53f7\u8282\u70b9\u76841\u7ea7\u540e\u4ee3\u6700\u5de6\u8fb9\u7684\u662f2\uff0c2\u7ea7\u540e\u4ee3\u662f5\uff0c\u8fd9\u79cd\u60c5\u51b5\u76f4\u63a5\u641e\u500d\u589e\u5c31\u4e0d\u884c\uff0c\u6240\u4ee5\u9700\u8981\u4e00\u70b9\u5904\u7406\u3002\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/ehdcg53n.png)\n\n\u4ee5\u627e\u6700\u5de6\u8fb9\u7684\u70b9\u4e3a\u4f8b\uff0c\u5b9a\u4e49\u70b9a\u7684$lson$\u4e3a\uff1a\u5982\u679ca\u6709\u513f\u5b50\uff0c\u90a3\u5c31\u662f\u513f\u5b50\u91cc\u6700\u5de6\u8fb9\u7684\u90a3\u4e2a\uff1b\u5982\u679ca\u6ca1\u6709\u513f\u5b50\uff0c\u90a3\u5c31\u627e\u5230\u6df1\u5ea6\u4e0ea\u76f8\u540c\uff0cbfs\u5e8f\u91cc\u6392\u5728a\u540e\u9762\u7684\u7b2c\u4e00\u4e2a\u6709\u513f\u5b50\u7684\u70b9\uff0c\u7136\u540e\u70b9a\u7684$lson$\u5c31\u662f\u627e\u5230\u7684\u8fd9\u4e2a\u70b9\u7684\u513f\u5b50\u91cc\u6700\u5de6\u8fb9\u7684\u90a3\u4e2a\uff0c\u5982\u679c\u627e\u4e0d\u5230\u8fd9\u6837\u7684\u70b9\uff0c\u90a3\u4e48a\u7684$lson$\u8bbe\u4e3a0\u3002\u6bd4\u5982\u56fe\u91cc\u76842\u53f7\u8282\u70b9\uff0c\u5b83\u6ca1\u6709\u513f\u5b50\uff0c\u4f46\u5b83\u53f3\u8fb9\u76843\u6709\u513f\u5b505\uff0c\u4e8e\u662f\u5c31\u628a2\u7684$lson$\u8bbe\u4e3a5\uff0c\u800c4\u53f7\u8282\u70b9\u53f3\u8fb9\u6ca1\u6709\u70b9\uff0c\u6240\u4ee5\u5b83\u7684$lson$\u4e3a0\u3002\u7136\u540e\u4e00\u4e2a\u70b9k\u7ea7\u540e\u4ee3\u6700\u5de6\u8fb9\u7684\u70b9\u5c31\u662f\u4e00\u4e2a\u70b9\u7684k\u7ea7$lson$\u3002\n\n\u7136\u540e\u627e\u6700\u53f3\u8fb9\u7684\u70b9\u4e5f\u662f\u7c7b\u4f3c\u7684\u641e\u6cd5\uff0c\u7136\u540e\u52a0\u4e2a\u5224\u5b9a\uff0c\u6700\u5de6\u8fb9\u7684\u70b9\u5728bfs\u5e8f\u4e0a\u7684\u4f4d\u7f6e\u4e00\u5b9a\u4e0d\u4f1a\u5728\u6700\u53f3\u8fb9\u7684\u70b9\u540e\u9762\uff0c\u8fd9\u6837\u5c31\u89e3\u51b3\u4e86\u627ek\u7ea7\u540e\u4ee3\u7684\u95ee\u9898\u4e86...\n\n...\u5417\uff1f\u65f6\u95f4\u590d\u6742\u5ea6\u548c\u7a7a\u95f4\u590d\u6742\u5ea6\u5462\uff1f\u9996\u5148\u5904\u7406\u51fa\u6240\u6709\u70b9\u7684$lson$\u53ef\u4ee5\u7ebf\u6027\u65f6\u95f4\u7a7a\u95f4\u89e3\u51b3\uff0c\u7136\u540e\u53ef\u4ee5\u53d1\u73b0\u4e00\u4e2a\u70b9\u6700\u591a\u5c31\u4e00\u4e2a$lson$\uff0c\u628a\u8fd9\u4e2a\u7236\u5b50\u5173\u7cfb\u53cd\u8fc7\u6765\u5c31\u5f97\u5230\u4e86\u4e00\u4e2a\u68ee\u6797\uff0c\u95ee\u9898\u53d8\u6210\u4e86\u627e\u4e00\u4e2a\u70b9\u7684k\u7ea7\u7956\u5148\u3002\u5728\u8fd9\u4e2a\u89e3\u6cd5\u91cc\u8fd9\u79cd\u8be2\u95ee\u4f1a\u6709$O(n\\sqrt{n})$\u6b21\uff0c\u6240\u4ee5\u4e3a\u4e86\u4fdd\u8bc1\u65f6\u95f4\u590d\u6742\u5ea6\uff0c\u9700\u8981\u4e00\u4e2a\u67e5\u8be2$O(1)$\u7684\u505a\u6cd5\u3002\n\n\u7136\u540e\u957f\u94fe\u5256\u5206$O(nlogn)-O(1)$\u627ek\u7ea7\u7956\u5148\u5df2\u7ecf\u70c2\u5927\u8857\u4e86\u2026\u2026\u4f46\u662f\u5b83\u7684\u7a7a\u95f4\u590d\u6742\u5ea6\u4e5f\u662f$O(nlogn)$\u3002\u6709\u6ca1\u6709\u66f4\u597d\u7684\u505a\u6cd5\uff1f\n\n\u6709\uff0clxl\u544a\u8bc9\u6211\u6709$O(n)-O(1)$\u5f3a\u5236\u5728\u7ebf\u7684k\u7956\u5148\u7b97\u6cd5\uff0c~~\u7136\u540e\u4ed6\u5c31\u53eb\u6211\u53bb\u7ffb\u8bba\u6587~~\u3002\u6211\u8fd8\u771f\u5c31\u7ffb\u5230\u4e86\u4e00\u4e9b\uff0c\u4e0d\u8fc7\u53ea\u770b\u4e86\u4e00\u4e2a\u505a\u6cd5\u662f\u7528\u6b27\u62c9\u5e8f\u8f6c\u6210\u5e8f\u5217\u95ee\u9898\u7136\u540e\u50cf$O(n)-O(1)$rmq\u90a3\u6837log\u5206\u5757\uff0c\u5757\u5185\u9884\u5904\u7406\u7b54\u6848\uff0c\u5757\u95f4\u6570\u636e\u7ed3\u6784\u7ef4\u62a4\uff0c\u7136\u540e\u5206\u7c7b\u8ba8\u8bba\u5b9e\u73b0$O(1)$\u67e5\u8be2\u7684\u3002~~\u7136\u800c\u6211\u592a\u5f31\u4e86\u6ca1\u80fd\u5199\u51fa\u5b9e\u73b0\uff0c\u6211\u5199\u7684\u662f\u957f\u94fe\u5256\u5206~~\uff0c\u6709\u5174\u8da3\u4e14\u6709\u80fd\u529b\u7684\u53ef\u4ee5\u53bb\u770b\u770b\u90a3\u4e9b\u8bba\u6587\u3002\n\n\u6240\u4ee5\u8fd9\u9053\u9898\u5c31\u8fd9\u6837\u65f6\u95f4$O(n\\sqrt{n})$\uff0c\u7a7a\u95f4$O(nlogn)$\u6216\u8005$O(n)$\u7684\u89e3\u51b3\u4e86\u3002\n\n#### \u4e00\u4e9b\u5c0f\u95ee\u9898\n\n\u6211\u7684\u4ee3\u7801\u5199\u7684\u592a\u4e11\u4e86\u5bfc\u81f4\u8dd1\u7684\u6162\u4e0d\u8bf4\uff0c$O(nlogn)$\u7684\u7a7a\u95f4\u4e5f\u6ca1\u6bd4$O(n\\sqrt{n})$\u7684\u597d\u591a\u5c11\uff0c\u4f46\u662f\u8d77\u7801\u662f\u6ca1\u9047\u5230\u8fc7\u5361\u7a7a\u95f4\u3002\n\n\u8fd8\u6709\uff0c\u8fd9\u9898\u9898\u76ee\u6570\u636e\u8303\u56f4\u63cf\u8ff0\u6709\u9519\uff0c\u6811\u7684\u6df1\u5ea6\u4e0d\u6b62114514\uff08\u751a\u81f3\u6000\u7591\u5b58\u5728\u4e00\u67613e5\u7684\u94fe\u7684\u6570\u636e\uff09\uff0c\u5982\u679c\u5199\u957f\u94fe\u5256\u5206\uff0c\u500d\u589e\u6b21\u6570\u90e8\u5206\u8bb0\u5f97\u5199\u523018\u4ee5\u4e0a\u3002\uff08\u6211\u5c31\u56e0\u4e3a\u8fd9\u4e2awa\u4e86\u597d\u4e45\uff09\n\n### \u4ee3\u7801\n\n~~\u81ea\u4ece\u5f00\u59cb\u5199Ynoi\u6211\u5c31\u518d\u4e5f\u6ca1\u5728\u610f\u8fc7\u6211\u4ee3\u7801\u7684\u957f\u5ea6\u4e86~~\n\n```cpp\n#pragma GCC optimize(\"-O3\")\n\n#include<iostream>\n#include<cstdlib>\n#include<cstdio>\n#include<algorithm>\n#include<vector>\n#include<queue>\n#include<cmath>\nusing namespace std;\nconst int N=3e5+5,M=18+1,M2=18;\nint n,m;\ninline int read()\n{\n\tint sum=0;\n\tchar c=getchar();\n\twhile(c<'0'||c>'9')c=getchar();\n\twhile(c>='0'&&c<='9')\n\t{\n\t\tsum=sum*10+c-'0';\n\t\tc=getchar();\n\t}\n\treturn sum;\n}\ninline void write(int x)\n{\n\tprintf(\"%d\\n\",x);\n}\n\nstruct miaow\n{\n\tint f,t,l;\n\tmiaow(int f=0,int t=0,int l=0):f(f),t(t),l(l){}\n}imap[N*2+1];\nint str[N]={0},cou=1;\ninline void jb(int f,int t)\n{\n\timap[cou]=miaow(f,t,str[f]);str[f]=cou++;\n\timap[cou]=miaow(t,f,str[t]);str[t]=cou++;\n}\n\nstruct pr\n{\n\tint a,b;\n\tpr(int a=0,int b=0):a(a),b(b){}\n};\n\nstruct fk1\n{\n\tint a[N]={0},n2,b[600+5]={0},zks,wks;\n\tinline void csh()\n\t{\n\t\tn2=sqrt(n);\n\t\tzks=(n+1)/n2,wks=(n+1)%n2;\n\t}\n\tinline void add(int x,int k)\n\t{\n\t\ta[x]+=k;\n\t\tb[x/n2]+=k;\n\t}\n\tinline int cx(int x)\n\t{\n\t\tint ll=x/n2;\n\t\tint kl=ll*n2;\n\t\tint sum=0;\n\t\tfor(int i=0;i<ll;++i)sum+=b[i];\n\t\tfor(int i=kl;i<=x;++i)sum+=a[i];\n\t\treturn sum;\n\t}\n\tinline void clr()\n\t{\n\t\tfor(int *S=a-1,*E=a+n+1;S!=E;)*++S=0;\n\t\tfor(int *S=b-1,*E=b+600;S!=E;)*++S=0;\n\t}\n\t\n}ss2;\nstruct fk2\n{\n\tint a[N]={0},n2,b[600+5]={0},zks,wks;\n\tinline void csh()\n\t{\n\t\tn2=sqrt(n);\n\t\tzks=(n+1)/n2,wks=(n+1)%n2;\n\t}\n\tinline void add(int l,int r,int k)\n\t{\n\t\tint ll=l/n2,rr=r/n2;\n\t\tif(ll==rr)\n\t\t{\n\t\t\tfor(int i=l;i<=r;++i)a[i]+=k;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tint kl=ll*n2+n2-1,kr=rr*n2;\n\t\t\tfor(int i=l;i<=kl;++i)a[i]+=k;\n\t\t\tfor(int i=kr;i<=r;++i)a[i]+=k;\n\t\t\tfor(int i=ll+1;i<=rr-1;++i)b[i]+=k;\n\t\t}\n\t}\n\tinline int cx(int x)\n\t{\n\t\tint ll=x/n2;\n\t\treturn a[x]+b[ll];\n\t}\n\tinline void clr()\n\t{\n\t\tfor(int *S=a-1,*E=a+n+1;S!=E;)*++S=0;\n\t\tfor(int *S=b-1,*E=b+600;S!=E;)*++S=0;\n\t}\n}ss3;\n\n\nint lo[N];\nstruct clpf\n{\n\tvector<int> son;\n\tint fa;\n\tint hson;\n\tint dep,d;\n\tint hfa;\n\tint bz[M]={0};\n\tint len;\n\tclpf(int fa=0,int hson=0,int dep=0,int d=0,int hfa=0,int len=0):fa(fa),hson(hson),dep(dep),d(d),hfa(hfa),len(len){}\n}tt[2][N];\nvector<int> slen[2][N],xlen[2][N];\ninline void dfspf1(int o,int d,int qwe)\n{\n\ttt[qwe][o].d=d;\n\tif(!tt[qwe][o].son.size())\n\t{\n\t\ttt[qwe][o].hson=-1;\n\t\ttt[qwe][o].dep=1;\n\t\treturn;\n\t}\n\tint imax=0,imax2=0;\n\tfor(int i=0;i<tt[qwe][o].son.size();++i)\n\t{\n\t\tint t=tt[qwe][o].son[i];\n\t\tdfspf1(t,d+1,qwe);\n\t\tif(tt[qwe][t].dep>imax2)\n\t\t{\n\t\t\timax2=tt[qwe][t].dep;\n\t\t\timax=i;\n\t\t}\n\t}\n\ttt[qwe][o].hson=imax;\n\ttt[qwe][o].dep=imax2+1;\n}\ninline void dfspf2(int o,int t,int qwe)\n{\n\ttt[qwe][o].hfa=t;\n\tif(tt[qwe][o].hson==-1)\n\t{\n\t\ttt[qwe][o].len=1;\n\t\treturn;\n\t}\n\tfor(int i=0;i<tt[qwe][o].son.size();++i)\n\t{\n\t\tif(i==tt[qwe][o].hson)\n\t\t{\n\t\t\tdfspf2(tt[qwe][o].son[i],t,qwe);\n\t\t\ttt[qwe][o].len=tt[qwe][tt[qwe][o].son[i]].len+1;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tdfspf2(tt[qwe][o].son[i],tt[qwe][o].son[i],qwe);\n\t\t}\n\t}\n\tif(o==t)\n\t{\n\t\tint l=tt[qwe][o].len,asd=o,zxc=o;\n\t\tfor(int i=1;i<=l;++i)\n\t\t{\n\t\t\tslen[qwe][o].push_back(zxc);\n\t\t\txlen[qwe][o].push_back(asd);\n\t\t\tif(tt[qwe][asd].hson==-1)break;\n\t\t\tasd=tt[qwe][asd].son[tt[qwe][asd].hson];\n\t\t\tzxc=tt[qwe][zxc].fa;\n\t\t}\n\t}\n}\ninline void pfbzcsh(int qwe)\n{\n\tfor(int i=1;i<=n;++i)\n\t{\n\t\ttt[qwe][i].bz[0]=tt[qwe][i].fa;\n\t}\n\tfor(int i=1;i<=M2;++i)\n\t{\n\t\tfor(int j=1;j<=n;++j)\n\t\t{\n\t\t\ttt[qwe][j].bz[i]=tt[qwe][tt[qwe][j].bz[i-1]].bz[i-1];\n\t\t}\n\t}\n}\ninline int cxkzx(int o,int k,int qwe)\n{\n\tif(k>tt[qwe][o].d)return 0;\n\tif(!k)return o;\n\to=tt[qwe][o].bz[lo[k]];\n\tk^=(1<<lo[k]);\n\tif((!k)||(!o))return o;\n\tint o2=tt[qwe][o].hfa,asd=tt[qwe][o].d-tt[qwe][o2].d;\n\tif(asd==k)return o2;\n\tif(asd>k)return asd-k>=xlen[qwe][o2].size()?0:xlen[qwe][o2][asd-k];\n\treturn k-asd>=slen[qwe][o2].size()?0:slen[qwe][o2][k-asd];\n}\n\nstruct meow\n{\n\tint fa,dep;\n\tvector<int> son;\n}t[N];\nint dfsxl[N],dfsl[N],dfsr[N],dfscou=1;\ninline void dfs1(int o,int fa,int d)\n{\n\tt[o].dep=d;\n\tt[o].fa=fa;\n\tdfsl[o]=dfscou;\n\tdfsxl[dfscou++]=o;\n\tfor(int i=str[o];i;i=imap[i].l)\n\t{\n\t\tint tt=imap[i].t;\n\t\tif(tt==fa)continue;\n\t\tt[o].son.push_back(tt);\n\t\tdfs1(tt,o,d+1);\n\t}\n\tdfsr[o]=dfscou-1;\n}\nint bfsxl1[N],bfsxl2[N];\nint bfs1cou=1,bfs2cou=1;\nint bfswz1[N],bfswz2[N];\ninline void bfs1(int o)\n{\n\tqueue<int> qwe;\n\tqwe.push(o);\n\twhile(!qwe.empty())\n\t{\n\t\tint x=qwe.front();\n\t\tqwe.pop();\n\t\tbfswz1[x]=bfs1cou;\n\t\tbfsxl1[bfs1cou++]=x;\n\t\tfor(int i=0;i<t[x].son.size();++i)\n\t\t{\n\t\t\tqwe.push(t[x].son[i]);\n\t\t}\n\t}\n}\ninline void bfs2(int o)\n{\n\tqueue<int> qwe;\n\tqwe.push(o);\n\twhile(!qwe.empty())\n\t{\n\t\tint x=qwe.front();\n\t\tqwe.pop();\n\t\tbfswz2[x]=bfs2cou;\n\t\tbfsxl2[bfs2cou++]=x;\n\t\tfor(int i=t[x].son.size()-1;i>=0;--i)\n\t\t{\n\t\t\tqwe.push(t[x].son[i]);\n\t\t}\n\t}\n}\nint bzl[N]={0},bzr[N]={0};\nint dl[N],dlt=0;\ninline void bzcsh()\n{\n\tint s=0,sd=t[bfsxl1[bfs1cou-1]].dep,s2=0;\n\tfor(int i=n;i>=1;--i)\n\t{\n\t\tint x=bfsxl1[i];\n\t\tif(sd!=t[x].dep)\n\t\t{\n\t\t\tsd=t[x].dep;\n\t\t\ts=0;\n\t\t}\n\t\tif(t[x].son.size())\n\t\t{\n\t\t\ts=t[x].son[0];\n\t\t}\n\t\tbzl[x]=s;\n\t\ttt[0][x].fa=s;\n\t\tif(s)tt[0][s].son.push_back(x);\n\t}\n\ts=0,sd=t[bfsxl2[bfs2cou-1]].dep,s2=0;\n\tfor(int i=n;i>=1;--i)\n\t{\n\t\tint x=bfsxl2[i];\n\t\tif(sd!=t[x].dep)\n\t\t{\n\t\t\tsd=t[x].dep;\n\t\t\ts=0;\n\t\t}\n\t\tif(t[x].son.size())\n\t\t{\n\t\t\ts=t[x].son[t[x].son.size()-1];\n\t\t}\n\t\tbzr[x]=s;\n\t\ttt[1][x].fa=s;\n\t\tif(s)tt[1][s].son.push_back(x);\n\t}\n\tfor(int i=1;i<=n;++i)\n\t{\n\t\tif(!tt[0][i].fa)\n\t\t{\n\t\t\tdfspf1(i,1,0);\n\t\t}\n\t\tif(!tt[1][i].fa)\n\t\t{\n\t\t\tdfspf1(i,1,1);\n\t\t}\n\t}\n\tfor(int i=1;i<=n;++i)\n\t{\n\t\tif(!tt[0][i].fa)\n\t\t{\n\t\t\tdfspf2(i,i,0);\n\t\t}\n\t\tif(!tt[1][i].fa)\n\t\t{\n\t\t\tdfspf2(i,i,1);\n\t\t}\n\t}\n\tpfbzcsh(0),pfbzcsh(1);\n\tint mx_div=1;\n    for(int i=1;i<=n;++i)\n    {\n\t\tif((i>>mx_div)&1)mx_div++;\n        lo[i]=mx_div-1;\n    }\n}\ninline pr bzcx(int o,int k)\n{\n\tint l=o,r=o;\n\tl=cxkzx(o,k,0);\n\tr=cxkzx(o,k,1);\n\treturn pr(l,r);\n}\ninline void jf(int o,int x,int y,int k)\n{\n\tfor(int i=x;;i+=y)\n\t{\n\t\tpr qwe=bzcx(o,i);\n\t\tint l=qwe.a,r=qwe.b;\n\t\tif(l==0||r==0||(bfswz1[l]>bfswz1[r]))break;\n\t\tss2.add(bfswz1[l],k);\n\t\tss2.add(bfswz1[r]+1,-k);\n\t}\n}\ninline int cx1(int o)\n{\n\tint qwe=bfswz1[o];\n\tint sum=ss2.cx(qwe);\n\treturn sum;\n}\n\nstruct nya\n{\n\tint fa,wz;\n\tint rson,siz;\n\tint nsiz;\n\tinline void clr()\n\t{\n\t\twz=0,siz=1,nsiz=1;\n\t}\n\tnya(int fa=0):fa(fa){}\n}t2[N];\ninline void blcsh()\n{\n\tfor(int i=0;i<=n;++i)t2[i].clr(),t2[i].rson=i;\n\tfor(int i=n;i>=1;--i)\n\t{\n\t\tint i2=bfsxl1[i],&i3=t2[i2].fa;\n\t\ti3=t[i2].fa;\n\t\tif(t2[i3].rson==i3)t2[i3].rson=t2[i2].rson;\n\t\tt2[i3].siz+=t2[i2].siz;\n\t}\n\tfor(int i=1;i<=n;++i)\n\t{\n\t\tint i2=bfsxl1[i],&i3=t2[i2].fa;\n\t\tt2[i2].wz=t2[i3].wz+t2[i3].nsiz;\n\t\tt2[i3].nsiz+=t2[i2].siz;\n\t}\n}\ninline void upd()\n{\n\tss3.clr();\n\tfor(int i=0;i<=n;++i)t2[i].clr(),t2[i].rson=i;\n\tfor(int i=n;i>=1;--i)\n\t{\n\t\tint i2=bfsxl1[i],&i3=t2[i2].fa;\n\t\ti3=t[i3].fa;\n\t\tif(t2[i3].rson==i3)t2[i3].rson=t2[i2].rson;\n\t\tt2[i3].siz+=t2[i2].siz;\n\t}\n\tfor(int i=1;i<=n;++i)\n\t{\n\t\tint i2=bfsxl1[i],&i3=t2[i2].fa;;\n\t\tt2[i2].wz=t2[i3].wz+t2[i3].nsiz;\n\t\tt2[i3].nsiz+=t2[i2].siz;\n\t}\n}\ninline void jf2(int o,int x,int k)\n{\n\tpr qwe=bzcx(o,x);\n\tint l=qwe.a,r=qwe.b;\n\tif(l==0||r==0||(bfswz1[l]>bfswz1[r]))return;\n\tss3.add(t2[l].wz,t2[t2[r].rson].wz,k);\n}\ninline int cx2(int o)\n{\n\tint sum=ss3.cx(t2[o].wz);\n\treturn sum;\n}\n\nint n2;\n\nstruct qry\n{\n\tint t,x,y,z,k;\n\tqry(int t=0,int x=0,int y=0,int z=0,int k=0):t(t),x(x),y(y),z(z),k(k){}\n}q[N];\ninline void csh()\n{\n\tn=read(),m=read();\n\tfor(int i=2;i<=n;++i)\n\t{\n\t\tint f=read(),t=i;\n\t\tjb(f,t);\n\t}\n\tfor(int i=1;i<=m;++i)\n\t{\n\t\tint t=read(),x=read(),y=0,z=0,k=0;\n\t\tif(t==1)y=read(),z=read(),k=read();\n\t\tq[i]=qry(t,x,z,y,k);\n\t}\n\tdfs1(1,0,1);\n\tbfs1(1),bfs2(1);\n\tbzcsh();\n\tblcsh();\n}\ninline void solve()\n{\n\tss2.csh();\n\tss3.csh();\n\tn2=sqrt(min(n,114514))-150;\n\tfor(int i=1;i<=m;++i)\n\t{\n\t\tif(q[i].t==1)\n\t\t{\n\t\t\tif(q[i].z>=n2)\n\t\t\t{\n\t\t\t\tjf(q[i].x,q[i].y,q[i].z,q[i].k);\n\t\t\t}\n\t\t\telse if(q[i].z==1)\n\t\t\t{\n\t\t\t\tjf2(q[i].x,q[i].y,q[i].k);\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tint sum1=cx1(q[i].x),sum2=cx2(q[i].x);\n\t\t\tq[i].k+=sum1+sum2;\n\t\t}\n\t}\n\tfor(int i=2;i<n2;++i)\n\t{\n\t\tupd();\n\t\tfor(int j=1;j<=m;++j)\n\t\t{\n\t\t\t//int j=qq[i][j2];\n\t\t\tif(q[j].t==1)\n\t\t\t{\n\t\t\t\tif(q[j].z==i)\n\t\t\t\t{\n\t\t\t\t\tjf2(q[j].x,q[j].y,q[j].k);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tint sum=cx2(q[j].x);\n\t\t\t\tq[j].k+=sum;\n\t\t\t}\n\t\t}\n\t}\n\tfor(int i=1;i<=m;++i)\n\t{\n\t\tif(q[i].t==2)\n\t\t{\n\t\t\twrite(q[i].k);\n\t\t}\n\t}\n}\nint main()\n{\n\tcsh();\n\tsolve();\n\treturn 0;\n}\n```\n",
        "postTime": 1571578190,
        "uid": 13105,
        "name": "miaow",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P5528 \u3010[Ynoi2012]D2T2\u3011"
    },
    {
        "content": "[$\\text{Link}$](https://www.luogu.com.cn/problem/P5528)\n## \u9898\u610f\n\u5b50\u6811\u8ddd\u79bb $\\equiv y(\\bmod x)$ \u52a0\uff0c\u5355\u70b9\u6c42\u503c\u3002\n## \u601d\u8def\n\u66b4\u529b\u4e07\u5c81\uff01\n\n\u8003\u8651\u5c06\u6811\u8f6c\u5316\u4e3a\u5e8f\u5217\uff0c\u4e00\u4e2a\u70b9 $i$ \u7684\u5b50\u6811\u53ef\u8868\u793a\u4e3a $\\text{dfn}$ \u5e8f\u5217\u4e2d\u7684\u4e00\u4e2a\u8fde\u7eed\u6bb5\uff0c\u8bbe\u4e3a $l_i,r_i$\u3002\n\n\u5219\u539f\u9898\u8f6c\u5316\u4e3a\u533a\u95f4 $\\equiv y(\\bmod x)$ \u52a0\uff0c\u5355\u70b9\u6c42\u503c\uff0c\u8fd9\u4e2a\u5f88\u50cf[[Ynoi2011] \u521d\u59cb\u5316](https://www.luogu.com.cn/problem/P5309)\uff0c\u6ca1\u505a\u8fc7\u7684\u53ef\u4ee5\u505a\u4e00\u4e0b\u3002\u8003\u8651\u7ef4\u62a4\u5dee\u5206\uff0c\u7136\u540e\u6839\u53f7\u5206\u6cbb\uff0c$x\\le \\sqrt{n}$ \u65f6 $v_{x,y}\\gets v_{x,y}+v$\uff0c$x>\\sqrt{n}$ \u65f6\u66b4\u529b\u52a0\u5373\u53ef\u3002\n\n```cpp\nstruct data_structer{\n\tint val1[sq+10][sq+10],val2[N];\n\tinline void add(int x,int y,int v){\n\t\tif(x<=sq){\n\t\t\tval1[x][y]+=v;\n\t\t}else{\n\t\t\tfor(int i=y;i<=deep;i+=x){\n\t\t\t\tval2[i]+=v;\n\t\t\t}\n\t\t}\n\t} \n\tinline void clear(int x,int y){\n\t\tif(x<=sq){\n\t\t\tval1[x][y]=0;\n\t\t}else{\n\t\t\tfor(int i=y;i<=deep;i+=x){\n\t\t\t\tval2[i]=0;\n\t\t\t}\n\t\t}\n\t}\n\tinline int query(int x){\n\t\tint ans=val2[x];\n\t\tfor(int i=1;i<=sq;i++){\n\t\t\tans+=val1[i][x%i];\n\t\t}\n\t\treturn ans;\n\t}\n}t;\n```\n\u8003\u8651\u6240\u6709\u4fee\u6539\u5bf9\u8be2\u95ee\u7684\u8d21\u732e\u7684\u6761\u4ef6\uff1a\n\n- $time_i<time_j$\uff1a\u4fee\u6539 $i$ \u7684\u65f6\u95f4\u524d\u4e8e\u8be2\u95ee $j$\uff1b\n- $l_{a_i}\\le a_j\\le r_{a_i}$\uff1a\u8be2\u95ee\u70b9\u5728\u4fee\u6539\u533a\u95f4\u5185\uff1b\n- $dep_{a_j}\\equiv y_i+dep_{a_i}(\\bmod x_i)$\uff1a\u6ee1\u8db3\u540c\u4f59\u6761\u4ef6\u3002\n\n\u63a5\u4e0b\u6765\u5c31\u53ef\u4ee5 $\\text{cdq}$ \u505a\u4e86\u3002\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define ll long long\nconst int N=3e5+10,sq=550;\nint cnt,head[N],dep[N],l[N],r[N],deep,tim,ask;\nstruct Edge{\n\tint to,nxt;\n}a[N];\ninline void add(int x,int y){\n\tcnt++;\n\ta[cnt].to=y;\n\ta[cnt].nxt=head[x];\n\thead[x]=cnt;\n} \ninline void dfs(int x){\n\ttim++;\n\tl[x]=tim;\n\tdeep=max(deep,dep[x]);\n\tfor(int i=head[x];i;i=a[i].nxt){\n\t\tint t=a[i].to;\n\t\tdep[t]=dep[x]+1;\n\t\tdfs(t);\n\t}\n\tr[x]=tim;\n}\nstruct data_structer{\n\tint val1[sq+10][sq+10],val2[N];\n\tinline void add(int x,int y,int v){\n\t\tif(x<=sq){\n\t\t\tval1[x][y]+=v;\n\t\t}else{\n\t\t\tfor(int i=y;i<=deep;i+=x){\n\t\t\t\tval2[i]+=v;\n\t\t\t}\n\t\t}\n\t} \n\tinline void clear(int x,int y){\n\t\tif(x<=sq){\n\t\t\tval1[x][y]=0;\n\t\t}else{\n\t\t\tfor(int i=y;i<=deep;i+=x){\n\t\t\t\tval2[i]=0;\n\t\t\t}\n\t\t}\n\t}\n\tinline int query(int x){\n\t\tint ans=val2[x];\n\t\tfor(int i=1;i<=sq;i++){\n\t\t\tans+=val1[i][x%i];\n\t\t}\n\t\treturn ans;\n\t}\n}t;\nstruct num{\n\tint pos,x,y,opt,val;\n};\nint n,m,ans[N];\nnum b[N<<1],c[N<<1];\ninline void cdq(int l,int r){\n\tif(l==r) return;\n\tint mid=l+r>>1;\n\tcdq(l,mid),cdq(mid+1,r);\n\tint q=l;\n\tint k=l;\n\tfor(int i=mid+1;i<=r;i++){\n\t\twhile(b[q].pos<=b[i].pos&&q<=mid){\n\t\t\tif(!b[q].opt)t.add(b[q].x,b[q].y,b[q].val);\n\t\t\tc[k++]=b[q++];\n\t\t}\n\t\tif(b[i].opt){\n\t\t\tans[b[i].val]+=t.query(b[i].x);\n\t\t}\n\t\tc[k++]=b[i];\n\t}\n\tfor(int i=l;i<q;i++){\n\t\tif(!b[i].opt)t.clear(b[i].x,b[i].y);\n\t}\n\tfor(;q<=mid;)c[k++]=b[q++];\n\tfor(int i=l;i<=r;i++){\n\t\tb[i]=c[i];\n\t}\n}\nint main(){\n\tn=read(),m=read();\n\tfor(int i=2;i<=n;i++){\n\t\tadd(read(),i);\n\t}\n\tdfs(1);\n\tcnt=0;\n\tfor(int i=1;i<=m;i++){\n\t\tint opt=read(),a=read();\n\t\tswitch(opt){\n\t\t\tcase 1:{\n\t\t\t\tint x=read(),y=read(),v=read();\n\t\t\t\tb[++cnt]=(num){l[a],x,(dep[a]+y)%x,0,v};\n\t\t\t\tb[++cnt]=(num){r[a]+1,x,(dep[a]+y)%x,0,-v};\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 2:{\n\t\t\t\tb[++cnt]=(num){l[a],dep[a],0,1,++ask};\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\tcdq(1,cnt);\n\tfor(int i=1;i<=ask;i++){\n\t\twrite(ans[i]);\n\t\tputc('\\n');\n\t}\n\tflush();\n    return 0;\n}\n```\n\u7136\u540e\u60a8\u4e00\u4ea4\uff0c\u53ea\u6709 95pts\u3002\n\n\u6211\u4eec\u53d1\u73b0\u8fd9\u4e2a\u7b97\u6cd5\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n\\sqrt n\\log n)$\uff0c\u88ab\u5361\u5e38\u4e86\u3002\n\n\u7136\u540e\u8fd9\u4e2a\u505a\u6cd5\u5c31\u4e0d\u80fd\u505a\u4e86\u5417\uff1f\u4e0d\uff0c\u6211\u4eec\u53ef\u4ee5\u5361\u5e38\u3002\n\n\u5728 $l_i\\le\\sqrt n$ \u6216 $r_i+\\sqrt n\\ge n$ \u65f6\u7279\u6b8a\u5904\u7406\uff0c\u540c\u6837\u6839\u53f7\u5206\u6cbb\u7ef4\u62a4\uff0c\u4f46\u662f\u53ef\u4ee5\u8f6c\u6362\u4e3a\u5168\u5c40\u51cf\u53bb\u672a\u8986\u76d6\u90e8\u5206\u3002\n\n\u7136\u540e\u5c31\u80fd\u8fc7\u4e86\u3002\n\n\u4fee\u6539\u8fc7\u540e\u7684\u4e3b\u51fd\u6570\uff1a\n\n```cpp\nint main(){\n\tn=read(),m=read();\n\tfor(int i=2;i<=n;i++){\n\t\tadd(read(),i);\n\t}\n\tdfs(1);\n\tcnt=0;\n\tfor(int i=1;i<=m;i++){\n\t\tint opt=read(),a=read();\n\t\tswitch(opt){\n\t\t\tcase 1:{\n\t\t\t\tint x=read(),y=read(),v=read();\n\t\t\t\tint c=(dep[a]+y)%x;\n\t\t\t\tif(l[a]<=sq){\n\t\t\t\t\tif(x<=sq){\n\t\t\t\t\t\tval1[x][c]+=v;\n\t\t\t\t\t}else{\n\t\t\t\t\t\tfor(int i=c;i<=deep;i+=x){\n\t\t\t\t\t\t\tval2[i]+=v;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tfor(int i=1;i<l[a];i++){\n\t\t\t\t\t\tif(dep[as[i]]%x==c){\n\t\t\t\t\t\t\tval0[as[i]]-=v;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}else{\n\t\t\t\t\tb[++cnt]=(num){l[a],x,c,0,v};\n\t\t\t\t}\n\t\t\t\tif(r[a]+sq>=n){\n\t\t\t\t\tfor(int i=r[a]+1;i<=n;i++){\n\t\t\t\t\t\tif(dep[as[i]]%x==c){\n\t\t\t\t\t\t\tval0[as[i]]-=v;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}else{\n\t\t\t\t\tb[++cnt]=(num){r[a]+1,x,c,0,-v};\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase 2:{\n\t\t\t\tb[++cnt]=(num){l[a],dep[a],0,1,++ask};\n\t\t\t\tans[ask]=val0[a]+val2[dep[a]];\n\t\t\t\tfor(int i=1;i<=sq;i++){\n\t\t\t\t\tans[ask]+=val1[i][dep[a]%i];\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\tcdq(1,cnt);\n\tfor(int i=1;i<=ask;i++){\n\t\twrite(ans[i]);\n\t\tputc('\\n');\n\t}\n\tflush();\n    return 0;\n}\n```\n\u5982\u679c\u6211\u4e4b\u540e\u88ab\u5361\u6389\u4e86\uff0c\u63d0\u9192\u6211\u4e00\u4e0b\uff08\n\n\u518d\u89c1 qwq~",
        "postTime": 1620547873,
        "uid": 365127,
        "name": "cyffff",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P5528\u3010[Ynoi2012] WC, THUWC, CTSC \u4e0e APIO2017\u3011"
    },
    {
        "content": "[\u8fd9\u91cc\u4e5f\u53ef\u4ee5\u770b\u54e6](https://foreverlasting1202.github.io/2019/10/01/YNOI2012D2T2/)\n\n\u4e00\u9053\u4e0d\u96be\u60f3\u800c\u4e14\u4ee3\u7801\u8f83\u77ed\u7684$YNOI$\u9898\u3002\u6240\u4ee5\u4e3a\u4ec0\u4e48\u90fd\u6ca1\u4eba\u5199\u5199$YNOI$\u4e86\u554a\uff0c\u611f\u89c9$YNOI2012$\u51b7\u6e05\u6e05\u7684\u3002\n\n<!--more-->\n\n\u62ff\u8fc7\u6765\u4e00\u770b\uff0c\u8fd9\u4e2a\u64cd\u4f5c$1$\u611f\u89c9\u5c31\u5f88\u9ebb\u70e6\u3002\u5b50\u6811\u5148\u770b\u6210$dfs$\u5e8f\u3002\u6a21$x$\u7b49\u4e8e$y$\uff0c\u8fd9\u79cd\u64cd\u4f5c\u597d\u50cf\u4e5f\u6ca1\u6709\u4ec0\u4e48\u6570\u636e\u7ed3\u6784\u53ef\u4ee5\u7ef4\u62a4\uff08\u53ef\u80fd\u662f\u6211\u5b64\u964b\u5be1\u95fb\u4e86\uff1f\uff09\uff0c\u4e8e\u662f\u8003\u8651\u66b4\u529b\u3002\n\n\u6709\u4e00\u79cd\u663e\u7136\u7684\u66b4\u529b\u5c31\u662f\u76f4\u63a5\u5bf9\u65f6\u95f4\u8f74\u5206\u5757\uff0c\u7136\u540e\u8be2\u95ee\u7684\u65f6\u5019\u5c31\u904d\u5386$O(B)$\u4e2a\u4fee\u6539\uff0c\u770b\u770b\u662f\u5426\u5f71\u54cd\u5f53\u524d\u8be2\u95ee\u70b9\u3002\u6bcf$B$\u4e2a\u4fee\u6539\u5c31\u66b4\u529b\u66f4\u65b0\u4e00\u4e0b\uff0c\u5373\u5bf9\u4e8e\u6bcf\u4e2a\u4fee\u6539\u6bcf\u6b21\u4e00\u76f4\u8df3$x$\u7684\u6df1\u5ea6\uff0c\u7136\u540e\u66f4\u65b0\u4e00\u4e0b\u8fd9\u4e9b\u70b9\u3002\n\n\u8fd9\u6837\u8df3\u6709\u5f88\u591a\u4e0d\u597d\u7684\u5730\u65b9\uff0c\u6bd4\u5982\u540c\u4e00\u6df1\u5ea6\u5982\u679c\u70b9\u5f88\u591a\u5c31\u4f1a\u8d8a\u8df3\u8d8a\u591a\u3002\u4e8e\u662f\u6211\u4eec\u7a0d\u5fae\u4f18\u5316\u4e00\u4e0b\uff0c\u6309$dfs$\u5e8f\u904d\u5386\u6bcf\u4e2a\u8be2\u95ee\uff0c\u7136\u540e\u53ea\u7ef4\u62a4\u6a21$x$\u7b49\u4e8e$y$\u7684\u6df1\u5ea6\u4e0a\u7684\u6743\u503c\uff0c\u8fd9\u6837\u590d\u6742\u5ea6\u5c31\u662f$O(n+B\\ast \\frac{n}{x})$\uff0c\u7a0d\u5fae\u6ce8\u610f\u4e00\u4e0b\u4e0d\u5728\u4e00\u68f5\u5b50\u6811\u5c31\u8981\u53bb\u6389\u4e4b\u524d\u8d21\u732e\u7684\u7ec6\u8282\u3002\u8fd9\u6837\u603b\u590d\u6742\u5ea6\u5c31\u662f\uff08$n,m$\u540c\u9636\uff09$O(\\frac{n}{B}(n+B\\ast \\frac{n}{x})+nB)$\uff0c\u5373$O(\\frac{n^2}{B}+\\frac{n^2}{x}+nB)$\u3002\u4f46\u8fd9\u4e2a$x$\u6bd5\u7adf\u662f$[1,n]$\u7684\uff0c\u590d\u6742\u5ea6\u5c31\u4f1a\u9000\u5316\u5230$O(n^2)$\u4e86\u3002\n\n\u6ce8\u610f\u5230\u5f53$x$\u6bd4\u8f83\u5c0f\u7684\u65f6\u5019\uff0c\u6211\u4eec\u5bf9$dfs$\u5e8f\u5206\u5757\u6709\u5947\u6548\u3002\u6211\u4eec\u5728\u6bcf\u4e2a\u5757\u91cc\u7ef4\u62a4\u4e00\u4e2a\u4e8c\u7ef4\u6570\u7ec4$sum[x][y]$\uff0c\u8868\u793a\u5f53\u524d\u5757\u5185\u6a21$x$\u7b49\u4e8e$y$\u7684\u70b9\u8981\u52a0$sum[x][y]$\u7684\u6743\u503c\u3002\u663e\u7136\u8fd9\u4e2a\u5f53$x$\u6bd4\u8f83\u5c0f\u7684\u65f6\u5019\u80fd\u5f00\u7684\u4e0b\u3002\u4e8e\u662f\u8bbe\u4e2a\u9608\u503c$lim$\uff0c\u5f53$x\\leq lim$\u7684\u65f6\u5019\u7ef4\u62a4$dfs$\u5e8f\u5206\u5757\uff0c\u5426\u5219\u7ee7\u7eed\u5bf9\u65f6\u95f4\u8f74\u5206\u5757\u3002\u8fd9\u6837\u65f6\u95f4\u590d\u6742\u5ea6\u5c31\u662f$O(\\frac{n^2}{B}+\\frac{n^2}{lim}+nB+n\\sqrt{n})$\uff0c\u5728$B$\u53d6$\\sqrt{n}$,$lim$\u53d6$\\sqrt{n}$\u65f6\u6700\u4f18\uff0c\u505a\u5230$O(n\\sqrt{n})$\uff0c\u53ea\u4e0d\u8fc7\u6b64\u65f6\u7a7a\u95f4\u590d\u6742\u5ea6\u662f$O(n\\ast lim)$\uff0c\u6240\u4ee5\u4e14\u884c\u4e14\u73cd\u60dc\u3002\n\n\u5176\u5b9e\u5220\u53bb\u5176\u4ed6\u5b50\u6811\u8d21\u732e\u8fd9\u4e2a\u7ec6\u8282\u633a\u96be\u5199\u7684\u3002\u3002\u3002\n\ncode:\n```cpp\n//2019.10.1 by ljz\n//email 573902690@qq.com\n//if you find any bug in my code\n//please tell me\n#include<bits/stdc++.h>\n//#include<ext/pb_ds/tree_policy.hpp>\n//#include<ext/pb_ds/assoc_container.hpp>\nusing namespace std;\n//using namespace __gnu_pbds;\n//using namespace __gnu_cxx;\n#define res register int\n#define LL long long\n#define inf 0x3f3f3f3f\n#define INF 0x3f3f3f3f3f3f3f\n#define unl __int128\n#define eps 5.6e-8\n#define RG register\n#define db double\n#define pc(x) __builtin_popcount(x)\n#define ctz(x) __builtin_ctz(x)\n//#define pc(x) __builtin_popcountll(x)\ntypedef pair<int,int> Pair;\n#define mp make_pair\n#define fi first\n#define se second\n#define pi acos(-1.0)\n#define pb push_back\n#define ull unsigned LL\n#define lowbit(x) (x&-x)\n#define gc getchar\n#define kcz 1000000007\n//template <class T>using Tree=tree<T,null_type,less<T>,rb_tree_tag,tree_order_statistics_node_update>;\n//inline char gc() {\n//    static char buf[100000],*p1,*p2;\n//    return p1==p2&&(p2=(p1=buf)+fread(buf,1,100000,stdin),p1==p2)?EOF:*p1++;\n//}\ninline int read() {\n    res s=0,ch=gc();\n    while(ch<'0'||ch>'9')ch=gc();\n    while(ch>='0'&&ch<='9')s=s*10+ch-'0',ch=gc();\n    return s;\n}\n//char sr[1<<21],z[20];\n//int C=-1,Z=0;\n//inline void Ot(){fwrite(sr,1,C+1,stdout),C=-1;}\n//inline void print(res x){\n//    if(C>1<<20)Ot();if(x<0)sr[++C]='-',x=-x;\n//    while(z[++Z]=x%10+48,x/=10);\n//    while(sr[++C]=z[Z],--Z);sr[++C]='\\n';\n//}\n//inline int read() {\n//    res s=0,ch=gc(),w=1;\n//    while(ch<'0'||ch>'9'){if(ch=='-')w=-1;ch=gc();}\n//    while(ch>='0'&&ch<='9')s=s*10+ch-'0',ch=gc();\n//    return s*w;\n//}\ninline LL Read() {\n    RG LL s=0;\n    res ch=gc();\n    while(ch<'0'||ch>'9')ch=gc();\n    while(ch>='0'&&ch<='9')s=s*10+ch-'0',ch=gc();\n    return s;\n}\n//inline LL Read() {\n//    RG LL s=0;\n//    res ch=gc(),w=1;\n//    while(ch<'0'||ch>'9'){if(ch=='-')w=-1;ch=gc();}\n//    while(ch>='0'&&ch<='9')s=s*10+ch-'0',ch=gc();\n//    return s*w;\n//}\n//inline void write(RG unl x){\n//    if(x>10)write(x/10);\n//    putchar(int(x%10)+'0');\n//}\n//inline void swap(res &x,res &y) {\n//    x^=y^=x^=y;\n//}\ninline void add(res &x,const res &y){\n    x+=y,x>=kcz?x-=kcz:(x<0?x+=kcz:1);\n}\ninline int Add(const res &x,const res &y){\n    return x+y>=kcz?x+y-kcz:(x+y<0?x+y+kcz:x+y);\n}\ninline int mul(const res &x,const res &y){\n    return int(1LL*x*y%kcz);\n}\ninline int sqr(const res &x){\n    return mul(x,x);\n}\ninline int mul(const res &x,const res &y,const res &d){\n    return int(1LL*x*y/d%kcz);\n}\ninline int qpow(res x,res y){\n    res ret=1;\n    while(y){\n        if(y&1)ret=mul(ret,x);\n        x=mul(x,x),y>>=1;\n    }\n    return ret;\n}\ninline LL Qpow(RG LL x,res y){\n    RG LL ret=1;\n    while(y){\n        if(y&1)ret*=x;\n        x*=x,y>>=1;\n    }\n    return ret;\n}\n//mt19937 rng(chrono::steady_clock::now().time_since_epoch().count());\n//clock_t start=clock();\n//inline void ck(){\n//    if(1.0*(clock()-start)/CLOCKS_PER_SEC>0.1)exit(0);\n//}\nconst int N=3e5+10;\nconst int B=600;\nconst int C=300;\nnamespace MAIN{\n    int n,m;\n    vector<int> G[N];\n    int dfn[N],low[N],idx,dep[N],pos[N],mxdep;\n    void dfs(res x,res depx){\n        mxdep=max(mxdep,dep[pos[dfn[x]=++idx]=x]=depx);\n        for(auto tox:G[x])dfs(tox,depx+1);\n        low[x]=idx;\n    }\n    int lim;\n    int val[N],sum[B][C+10][C+10];\n    int pr[B],pl[B];\n    struct Que{\n        int a,l,r,x,y,z;\n        Que() {}\n        Que(res a,res l,res r,res x,res y,res z):a(a),l(l),r(r),x(x),y(y),z(z) {}\n    }que[B];\n    int quex;\n    vector<Que> E[N],F[N];\n    inline void MAIN(){\n        n=read(),m=read(),lim=int(sqrt(n));\n        for(res i=2;i<=n;i++)G[read()].pb(i);\n        dfs(1,0);\n        for(res i=1;i<=n;i++)pr[i/lim]=i;\n        for(res i=n;i;i--)pl[i/lim]=i;\n        while(m--){\n            res opt=read();\n            if(opt==1){\n                res a=read(),x=read(),y=read(),z=read(),l=dfn[a],r=low[a];\n                if(x<=C){\n                    res L=l/lim,R=r/lim;\n                    if(L==R){\n                        for(res i=l;i<=r;i++)if((dep[pos[i]]-dep[a])%x==y)val[i]+=z;\n                    }\n                    else {\n                        for(res i=l;i<=pr[L];i++)if((dep[pos[i]]-dep[a])%x==y)val[i]+=z;\n                        for(res i=pl[R];i<=r;i++)if((dep[pos[i]]-dep[a])%x==y)val[i]+=z;\n                        for(res i=L+1;i<R;i++)sum[i][x][(dep[a]+y)%x]+=z;\n                    }\n                }\n                else {\n                    que[++quex]=Que(a,l,r,x,y,z);\n                    if(quex==lim){\n                        for(res i=1;i<=n;i++)E[i].clear(),F[i].clear();\n                        for(res i=1;i<=quex;i++)E[que[i].l].pb(que[i]),F[que[i].r+1].pb(que[i]);\n                        static int dept[N];\n                        for(res i=0;i<=mxdep;i++)dept[i]=0;\n                        for(res i=1;i<=n;i++){\n                            for(auto w:E[i]){\n                                res now=dep[w.a]+w.y;\n                                while(now<=mxdep)dept[now]+=w.z,now+=w.x;\n                            }\n                            for(auto w:F[i]){\n                                res now=dep[w.a]+w.y;\n                                while(now<=mxdep)dept[now]-=w.z,now+=w.x;\n                            }\n                            val[i]+=dept[dep[pos[i]]];\n                        }\n                        quex=0;\n                    }\n                }\n            }\n            else {\n                res a=read(),id=dfn[a],I=id/lim,ans=val[id];\n                for(res x=1;x<=C;x++)ans+=sum[I][x][dep[a]%x];\n                for(res i=1;i<=quex;i++)if(que[i].l<=id&&id<=que[i].r&&(dep[a]-dep[que[i].a])%que[i].x==que[i].y)ans+=que[i].z;\n                printf(\"%d\\n\",ans);\n            }\n        }\n    }\n}\nint main() {\n//    srand(19260817);\n//    freopen(\"path.in\",\"r\",stdin);\n//    freopen(\"path.out\",\"w\",stdout);\n    MAIN::MAIN();\n//    Ot();\n    return 0;\n}\n```",
        "postTime": 1569924395,
        "uid": 32878,
        "name": "foreverlasting",
        "ccfLevel": 7,
        "title": "\u3010Ynoi2012\u3011D2T2"
    },
    {
        "content": "~~\u5982\u679c\u60a8\u4f1a\u4e8c\u7ef4\u5206\u5757\u5e76\u4e14\u505a\u8fc7P5309\u90a3\u4e48\u60a8\u5c31\u4f1a\u8fd9\u9053\u9898\u4e86~~            \n\n\u63d0\u4f9b\u4e00\u4e2a\u65f6\u95f4 $O(n \\sqrt {n \\log n})$ \u7a7a\u95f4 $O(n \\log  n )$ \u7684\u88ab\u8e29\u7206\u505a\u6cd5\u3002             \n\n\u6211\u4eec\u8003\u8651\u7ef4\u62a4 $n$ \u4e2a\u4ee5 $dfn$ \u5e8f\u4e3a\u7b2c\u4e00\u7ef4\u4ee5 $bfs$ \u5e8f\u4e3a\u7b2c\u4e8c\u7ef4\u7684\u4e8c\u7ef4\u70b9\u5bf9\u4ee5\u53ca\u4e00\u4e2a\u957f\u4e3a $n$ \u7684\u5e8f\u5217\u3002            \n\n\u521d\u59cb\u65f6\u4e8c\u7ef4\u70b9\u5bf9\u6309 $dfn$ \u5e8f\u6392\u5e8f\uff0c\u5e8f\u5217\u6309 $bfs$ \u5e8f\u6392\u5e8f\uff0c\u5e76\u4e14\u6211\u4eec\u8981\u7565\u5fae\u6539\u53d8\u4e00\u4e0b\u6811\u7684\u5f62\u6001\u4f7f\u5f97\u6bcf\u4e00\u5c42\u8282\u70b9\u7684 $dfn$ \u5e8f\u5347\u5e8f\u6392\u5217\u518d\u53bb\u6c42 $bfs$ \u5e8f\u3002\u8fd9\u4e2a\u540e\u9762\u4f1a\u8bb2\u600e\u4e48\u7528\u8fd9\u4e2a\u6027\u8d28\u3002\n\n\u9996\u5148\u5bf9\u4e8e\u64cd\u4f5c $1$ \uff0c\u8fd9\u663e\u7136\u5c31\u662f P5309 \u6539\u4e00\u6539\u653e\u4e0a\u6765\u4e86\uff0c\u6211\u4eec\u7167\u6837\u8003\u8651\u9608\u503c\u5206\u6cbb\u5b83\u3002           \n\n- \u4ee4 $Lim$ \u4e3a\u9608\u503c\uff0c$B$ \u4e3a\u5757\u5927\u5c0f\u3002\n\n- \u5982\u679c $x \\leq Lim$ \u90a3\u4e48\u6211\u4eec\u8003\u8651\u76f4\u63a5\u5728\u4e8c\u7ef4\u70b9\u5bf9\u4e0a\u9762\u7ef4\u62a4\uff0c\u7531\u4e8e\u4f60\u5df2\u7ecf\u6309 $dfn$ \u6392\u597d\u4e86\u5e8f\uff0c\u90a3\u4e48\u8fd9\u65f6\u5019\u7531\u4e8e\u4f60\u7684\u4fee\u6539\u90fd\u5728\u5b50\u6811\u4e0a\uff0c\u4f60\u5c31\u53ef\u4ee5\u786e\u5b9a\u51fa\u4e00\u4e2a\u5927\u81f4\u7684\u533a\u95f4\uff0c\u8fd9\u65f6\u5019\u6563\u5757\u66b4\u529b\u6539\u6bcf\u4e2a\u6574\u5757\u5185\u90e8\u7ef4\u62a4\u4e00\u4e2a\u5f62\u5982 ```f[x][y]``` \u8868\u793a\u5bf9 $x$ \u53d6\u6a21\u4f59 $y$ \u7684\u6570\u7684\u61d2\u6807\u8bb0\uff0c\u76f4\u63a5\u7d2f\u52a0\u4e0a\u53bb\u5c31\u597d\u4e86\uff0c\u8fd9\u91cc\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(B + \\frac{n}{B})$ \u3002             \n\n- \u5982\u679c $Lim + 1 \\leq x$ \uff0c\u6211\u4eec\u8003\u8651\u76f4\u63a5\u5728\u7b2c\u4e8c\u4e2a\u5e8f\u5217\u4e0a\u9762\u66f4\u6539\uff0c\u7531\u4e8e\u662f\u5355\u70b9\u67e5\u8be2\u6240\u4ee5\u6211\u4eec\u76f4\u63a5\u8003\u8651\u4fee\u6539\u65f6\u88f8\u4e00\u4e2a\u5dee\u5206\u4e0a\u53bb\uff0c\u7531\u4e8e\u81f3\u591a\u53ea\u4f1a\u6709 $\\frac{n}{x}$ \u5c42\u4f1a\u88ab\u4fee\u6539\u4e14\u6bcf\u4e00\u5c42\u4fee\u6539\u7684 $bfs$ \u5e8f\u8fde\u7eed\uff0c\u6211\u4eec\u8003\u8651\u4e8c\u5206\u51fa\u6bcf\u5c42\u9700\u8981\u88ab\u4fee\u6539\u7684\u4f4d\u7f6e\u5373\u53ef\u505a\u5230\u5355\u5c42 $O(1)$ \u4fee\u6539\uff0c\u6574\u4f53\u5355\u6b21\u4fee\u6539\u5c31\u662f $O(\\frac{n}{x} \\log n)$ \u4e86\u3002             \n\n- \u5bf9\u4e8e\u67e5\u8be2\uff0c\u7b54\u6848\u5c31\u662f\u4e8c\u7ef4\u6570\u70b9\u4e0a\u7684\u7b54\u6848\u4e0e $bfs$ \u5e8f\u5217\u4e0a\u7684\u7b54\u6848\u4e4b\u548c\uff0c\u4e8c\u7ef4\u6570\u70b9\u7684\u7b54\u6848\u5f88\u663e\u7136\u662f $O(Lim)$ \u6765\u6c42\uff0c\u800c $BFS$ \u5e8f\u4e0a\u7684\u7b54\u6848\u8f6c\u5316\u6210\u533a\u95f4\u67e5\u8be2\u5c31\u662f $O(B)$ \u3002       \n\n\u5f53 $B = \\sqrt n , Lim = \\sqrt {n \\log n}$ \u65f6\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u4e00\u4e2a\u65f6\u95f4 $n \\sqrt {n \\log n}$ \uff0c\u7a7a\u95f4 $O(n \\sqrt n \\log n)$ \u7684\u505a\u6cd5\uff0c\u4f60\u4e00\u7b97\u8fd9\u9053\u9898\u8fde $O(n \\sqrt n)$ \u7a7a\u95f4\u90fd\u4e0d\u8ba9\u8dd1\u5c31\u5f97\u8003\u8651\u4f18\u5316\u7a7a\u95f4\u4e86\u3002          \n\n\u7136\u540e\u53c8\u662f Ynoi \u7684\u4e00\u4e2a\u5e38\u89c1\u5957\u8def\uff1a\u6211\u4eec\u8003\u8651\u7b54\u6848\u5177\u6709\u7d2f\u52a0\u6027\uff0c\u6240\u4ee5\u76f4\u63a5\u5bf9\u4e8e\u6bcf\u4e2a\u5757\u5355\u72ec\u62c9\u51fa\u6765\u8dd1\u7b54\u6848\u5c31\u53ef\u4ee5\u4f18\u5316\u6389\u7a7a\u95f4\u7684\u4e00\u7ef4\uff0c\u7a7a\u95f4\u590d\u6742\u5ea6\u5c31\u53d8\u6210\u4e86 $O(n \\log n)$ \u3002 \n\n\u4e0d\u8fc7\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u4e00\u4e0b\u6bcf\u6b21\u4fee\u6539\u64cd\u4f5c\u7684 $a$ \uff0c\u5982\u679c\u6b64\u65f6 $y$ \u4e3a $0$ \u65f6\u5f53\u524d\u7684 $a$ \u4e5f\u8981\u88ab\u4fee\u6539\uff0c\u8fd9\u91cc\u9700\u8981\u6253\u4e2a\u7279\u5224\u7136\u540e\u6bcf\u6b21\u505a\u5b8c\u540e\u8fd8\u5f97\u628a\u8fd9\u4e9b\u4fee\u6539\u7684\u70b9\u7ed9\u66b4\u529b\u6539\u56de\u6765\u4e0d\u7136\u4e0b\u4e00\u6b21\u67e5\u8be2\u53c8\u8981\u9519\u2026\u2026\u6709\u70b9\u9ebb\u70e6\u3002           \n\n\u7136\u540e\u5c31\u662f\u6570\u636e\u95ee\u9898\uff0c\u8fd9\u9053\u9898\u4e0d\u77e5\u9053\u4e3a\u4ec0\u4e48\u628a $O(n \\sqrt {n \\log n})$ \u5361\u6389\u4e86\uff0c\u4f46\u662f $O(n \\sqrt n \\log n)$ \u53ef\u4ee5\u8fc7\u2026\u2026\u6240\u4ee5\u5927\u5bb6\u770b\u7740\u529e\u5427\u3002\n \n```cpp\n#include \"bits/stdc++.h\"\nusing namespace std;\nconst int Len = 3e5 + 5 , SIZE = 555;\nint n,m,t,fir[Len],num[Len],dep[Len],Use[Len],id[Len],siz[Len],Maxdep;\n/*\n\u8003\u8651\u4e8c\u7ef4\u5206\u5757 + \u6839\u53f7\u5206\u6cbb \n\u9996\u5148\u62c9\u4e24\u4e2a\u5e8f\u5217\u51fa\u6765\uff0c\u7b2c\u4e00\u4e2a\u662f\u4e00\u4e2a\u4e8c\u7ef4\u70b9\u5bf9\u5305\u542b\u6df1\u5ea6\u548cdfn\u5e8f\u4e24\u4e2a\u7ef4\u5ea6\u7684\u5e8f\u5217\uff0c\u7b2c\u4e8c\u4e2a\u662f\u4e00\u4e2aBFS\u62c9\u597d\u7684\u5e8f\u5217\n\u63a5\u7740\u6211\u4eec\u8003\u8651\u5bf9\u7b2c\u4e00\u7ef4 dfn \u6392\u5e8f\uff0c\u90a3\u4e48\u6211\u4eec\u73b0\u5728\u5c31\u53ef\u4ee5\u786e\u5b9a\u51fa\u6211\u4eec\u9700\u8981\u5728\u54ea\u4e9b\u5757\u91cc\u9762\u4fee\u6539\n\u5bf9\u4e8e\u6574\u5757\uff0c\u6211\u4eec\u8003\u8651\u64cd\u4f5c1\u548c\u521d\u59cb\u5316\u5f88\u50cf\uff0c\u6240\u4ee5\u6839\u53f7\u5206\u6cbb\u5b83\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u5757\u5f00\u4e00\u4e2a[SIZE][SIZE]\u6765\u7ef4\u62a4 x \u5728\u6839\u53f7\u5185\u4ee5\u5185\u7684\u6240\u6709\u4fee\u6539\uff0c\u6563\u5757\u76f4\u63a5\u66b4\u529b\u505a\u5c31\u597d\u4e86\u3002\n\u7531\u4e8e\u67e5\u8be2\u662f\u5f88\u5f31\u7684\u5355\u70b9\u67e5\u8be2\u6240\u4ee5\u6211\u4eec\u67e5\u8be2\u65f6\u76f4\u63a5\u66b4\u529b\u628a\u5757\u5185\u7684\u8fd9\u4e2a\u503c\u626b\u4e00\u904d\u5c31\u597d\u4e86\uff0c\u65f6\u95f4\u590d\u6742\u5ea6O(\\sqrt n)\n\u63a5\u7740\u6211\u4eec\u8003\u8651 x \u5927\u4e8e \\sqrt n \u7684\u60c5\u51b5\uff0c\u4e5f\u5c31\u662f\u8bf4\u6211\u4eec\u81f3\u591a\u53ea\u6709 \\sqrt n \u5c42\u7684\u4fee\u6539\uff0c\u518d\u7531\u4e8e\u8003\u8651\u5230\u67e5\u8be2\u662f\u5355\u70b9\u67e5\u8be2\uff0c\u6211\u4eec\u76f4\u63a5\u5dee\u5206\u7ef4\u62a4\u5c31\u597d\u4e86\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 \\sqrt n \n\u603b\u7684\u65f6\u95f4\u590d\u6742\u5ea6 O(n \\sqrt n)\uff0c\u7a7a\u95f4\u6709\u70b9\u5371\u9669\u2026\u2026\u4e0d\u8fc7\u6211\u4eec\u53ef\u4ee5\u6eda\u5757\u6eda\u6210 O(n) ((( \n512\u597d\u554a\uff0c\u90a3\u6211\u5e0c\u671b\u60a8\u4e0d\u8981\u5361\u7a7a\u95f4\n\u597d\u50cf\u4e0d\u592a\u4f1a\u5feb\u901f\u627e\u5230\u6bcf\u4e00\u5c42\u8981\u4fee\u6539\u7684l,r\u8fd9\u5c31\u5f88\u6de6\u2026\u2026\u867d\u7136\u53ef\u4ee5log\u67e5\u4f46\u662f\u8fd9\u6837\u4e0d\u5c31\u5e9f\u4e86\u5417(((\n\u5b9e\u5728\u4e0d\u884c\u5c31\u628a\u9608\u503c\u8c03\u4e00\u4e0b\u2026\u2026\u53d8\u6210 n \\sqrt n log n \u7a7a\u95f4\u5427\uff0c\u867d\u7136\u6eda\u5b8c\u540e\u7a7a\u95f4\u8fd8\u662f\u4e0d\u4f1a\u7206/xia\n\u7ffb\u4e86\u7ffb\u8ba8\u8bba\uff0c\u5148\u5199\u4e00\u4e2a n \\sqrt n log n\u7684\u518d\u8bf4\uff0c\u53e6\u5916\u4e24\u79cd\u6211\u76f4\u63a5\u5c31\u5f53\u6211\u662f\u80e1\u7684\u597d\u4e0d\u597d\u554a\n\u800c\u4e14\u4f60\u8fd8\u5361\u4e0d\u6ee1\u6211\u8fd9\u4e2a\u65f6\u95f4\u590d\u6742\u5ea6 \nlxl\uff0cfnmjn \n\u83ab\u540dWA\u6389\u4e86 \n*/\nvector<int> G[Len];\nstruct Node\n{\n\tint x,y;//\u5206\u522b\u662fdfn\u5e8f\u548c\u6df1\u5ea6 \n}P[Len];\nbool cmp(Node x,Node y){return x.x < y.x;}\nint dfn[Len],tot,BFS[Len],cnt;\nbool cmd(int x,int y){return dfn[x] < dfn[y];}\nvoid add(int x,int y){G[x].push_back(y);}\nvoid dfs(int x)\n{\n\tsiz[x] = 1;\n\tMaxdep = max(Maxdep , dep[x]);\n\tnum[dep[x]] ++;\n\tdfn[x] = ++ tot;\n\tid[dfn[x]] = x;\n\tP[x].x = dfn[x];\n\tP[x].y = dep[x];\n\tfor(int i = 0 ; i < G[x].size() ; i ++)\n\t{\n\t\tint to = G[x][i];\n\t\tdep[to] = dep[x] + 1;\n\t\tdfs(to);\n\t\tsiz[x] += siz[to];\n\t} \n\tsort(G[x].begin() , G[x].end() , cmd);\n}\nbool flag[Len];\nvoid bfs(int x)\n{\n\tqueue<int> q;\n\tq.push(1);\n\tflag[1] |= 1;\n\tfir[1] = 1;\n\tBFS[1] = ++ cnt;\n\twhile(!q.empty())\n\t{\n\t\tint s = q.front() ; q.pop();\n\t\tfor(int i = 0 ; i < G[s].size() ; i ++)\n\t\t{\n\t\t\tint to = G[s][i];\n\t\t\tif(!flag[dep[to]])\n\t\t\t{\n\t\t\t\tflag[dep[to]] |= 1;\n\t\t\t\tfir[dep[to]] = cnt + 1; \n\t\t\t}\n\t\t\tBFS[to] = ++ cnt;\n\t\t\tUse[BFS[to]] = dfn[to];\n\t\t\tq.push(to);\n\t\t}\n\t}\n}\nvector<int> sim;\nstruct node\n{\n\tint L[SIZE],R[SIZE],num[SIZE][SIZE],t,val[Len],pos[Len];\n\tinline void maintain(int x)\n\t{\n\t\tfor(int i = 0 ; i <= t ; i ++)\n\t\t\tfor(int j = 0 ; j <= t ; j ++) num[i][j] = 0;\n\t\tfor(int i = 0 ; i < sim.size() ; i ++) val[sim[i]] = 0;\n\t}\n\tvoid Init()\n\t{\n\t\tt = sqrt(n);\n\t\tfor(int i = 1 ; i <= t ; i ++) L[i] = (i - 1) * t + 1 , R[i] = i * t;\n\t\tif(R[t] < n) R[t] = n;\n\t\tfor(int i = 1 ; i <= t ; i ++)\n\t\t\tfor(int j = L[i] ; j <= R[i] ; j ++) pos[j] = i;\n\t}\n\tinline void upd(int l,int r,int x,int y,int upd)\n\t{\n\t\tfor(int i = l ; i <= r ; i ++) if(P[i].y % x == y) val[i] += upd;\n\t\treturn;\n\t}\n\tinline int qry(int x)\n\t{\n\t\tint res = 0;\n\t\tfor(int i = 1 ; i <= t ; i ++) res += num[i][P[x].y % i];\n\t\treturn res + val[x];\n\t}\n}S1;\nstruct Pnode\n{\n\tint L[SIZE],R[SIZE],t,sum[SIZE],val[Len],pos[Len];\n\tvoid Init()\n\t{\n\t\tt = sqrt(n);\n\t\tfor(int i = 1 ; i <= t ; i ++) L[i] = (i - 1) * t + 1 , R[i] = i * t , sum[i] = 0;\n\t\tif(R[t] < n) R[t] = n;\n\t\tfor(int i = 1 ; i <= t ; i ++) \t\n\t\t\tfor(int j = L[i] ; j <= R[i] ; j ++) pos[j] = i , val[j] = 0;\n\t}\n\tinline void Upd(int l,int r,int Upd)\n\t{\n\t\tval[l] += Upd , sum[pos[l]] += Upd;\n\t\tval[r + 1] -= Upd , sum[pos[r + 1]] -= Upd;\n\t}\n\tinline int qry(int l)\n\t{\n\t\tint res = 0;\n\t\tfor(int i = 1 ; i < pos[l] ; i ++) res += sum[i];\n\t\tfor(int i = L[pos[l]] ; i <= l ; i ++) res += val[i];\n\t\treturn res;\n\t}\n}S2;\ninline void update(int a,int L,int R,int x,int y,int z)\n{\n\tfor(int i = dep[a] + y ; i <= Maxdep ; i += x) \n\t{\n\t\tint l = lower_bound(Use + fir[i] , Use + fir[i] + num[i] , L) - Use ;\n\t\tint r = upper_bound(Use + fir[i] , Use + fir[i] + num[i] , R) - Use - 1;\n\t\tif(l > r) continue;\n\t\tS2.Upd(l , r , z);\n\t}\n\treturn;\n}\ninline int query(int x){return S2.qry(BFS[x]);}\nstruct NNode\n{\n\tint opt,a,x,y,z;\n}Sec[Len];\nint L,R,Print[Len];\nvoid J(int x,int y,int a,int b)\n{\n\tif(a <= x && y <= b) L = x , R = y;\n\telse\n\t{\n\t\tif(x < a) L = a , R = y;\n\t\telse if(x == a) L = x , R = min(y , b);\n\t\telse L = x , R = b;\n\t}\n}\n\nsigned main()\n{\n\tscanf(\"%d %d\",&n,&m);t = sqrt(n);\n\tS1.Init() , S2.Init();\n\tfor(int i = 2 ; i <= n ; i ++) \n\t{\n\t\tint x;scanf(\"%d\",&x); \n\t\tadd(x , i);\n\t}\n\tdep[1] = 1;\n\tdfs(1);\n\tbfs(1);\n\t//for(int i = 1 ; i <= Maxdep ; i ++) printf(\"%d %d\\n\",i,num[i]); \n\tsort(P + 1 , P + 1 + n , cmp);\n\t//for(int i = 1 ; i <= n ; i ++) printf(\"%d %d\\n\",i,siz[i]);\n\tfor(int i = 1 ; i <= m ; i ++) \n\t{\n\t\tscanf(\"%d\",&Sec[i].opt);\n\t\tif(Sec[i].opt == 1) scanf(\"%d %d %d %d\",&Sec[i].a,&Sec[i].x,&Sec[i].y,&Sec[i].z);\n\t\telse scanf(\"%d\",&Sec[i].x);\n\t}\n\tfor(int i = 1 ; i <= t ; i ++)//\u5148\u6765\u505a\u7b2c\u4e00\u4e2a\u5e8f\u5217\u7684\u64cd\u4f5c \n\t{\n\t\tS1.maintain(i);\n\t\tsim.clear();\n\t\tfor(int j = 1 ; j <= m ; j ++)\n\t\t{\n\t\t\tif(Sec[j].opt == 1)\n\t\t\t{\n\t\t\t\tif(Sec[j].x > t) continue;\n\t\t\t\tif(!Sec[j].y && dep[Sec[j].a] % Sec[j].x != (dep[Sec[j].a] + Sec[j].y) % Sec[j].x) \n\t\t\t\t{\n\t\t\t\t\tS1.val[dfn[Sec[j].a]] += Sec[j].z;\n\t\t\t\t\tsim.push_back(dfn[Sec[j].a]);\n\t\t\t\t}\n\t\t\t\tif(dfn[Sec[j].a] + siz[Sec[j].a] - 1 < S1.L[i] || S1.R[i] < dfn[Sec[j].a]) continue;\n\t\t\t\t//printf(\"###%d %d %d %d\\n\",dfn[Sec[j].a] , dfn[Sec[j].a] + siz[Sec[j].a] - 1 , S1.L[i] , S1.R[i]);\n\t\t\t\tif(dfn[Sec[j].a] <= S1.L[i] && S1.R[i] <= dfn[Sec[j].a] + siz[Sec[j].a] - 1)\n\t\t\t\t{\n\t\t\t\t\tS1.num[Sec[j].x][(dep[Sec[j].a] + Sec[j].y) % Sec[j].x] += Sec[j].z;\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tJ(dfn[Sec[j].a] , dfn[Sec[j].a] + siz[Sec[j].a] - 1 , S1.L[i] , S1.R[i]);\n\t\t\t\t//printf(\"%d %d %d %d %d %d\\n\",dfn[Sec[j].a] , dfn[Sec[j].a] + siz[Sec[j].a] - 1 , S1.L[i] , S1.R[i] , L , R);\n\t\t\t\tS1.upd(L , R , Sec[j].x , (dep[Sec[j].a] + Sec[j].y) % Sec[j].x , Sec[j].z);\n\t\t\t}\n\t\t\telse \n\t\t\t{\n\t\t\t\tif(dfn[Sec[j].x] < S1.L[i] || S1.R[i] < dfn[Sec[j].x]) continue;\n\t\t\t\tPrint[j] += S1.qry(dfn[Sec[j].x]);\n\t\t\t}\n\t\t}\n\t}\n\tfor(int j = 1 ; j <= m ; j ++) \n\t{\n\t\tif(Sec[j].opt == 1)\n\t\t{\n\t\t\tif(Sec[j].x <= t) continue;\n\t\t\tupdate(Sec[j].a , dfn[Sec[j].a] , dfn[Sec[j].a] + siz[Sec[j].a] - 1 , Sec[j].x , Sec[j].y , Sec[j].z);\n\t\t}\n\t\telse Print[j] += query(Sec[j].x);\n\t}\n\tfor(int i = 1 ; i <= m ; i ++) if(Sec[i].opt == 2) printf(\"%d\\n\",Print[i]);\n\treturn 0;\n} \n```",
        "postTime": 1622389297,
        "uid": 132533,
        "name": "Hakuoro",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 [Ynoi2012] WC, THUWC, CTSC \u4e0e APIO2017"
    },
    {
        "content": "\u8bb2\u4e00\u79cd\u4ee3\u7801\u5341\u5206\u7b80\u77ed\u7684\u505a\u6cd5\uff081.34k\uff0c\u76ee\u524d(2022.9.17)\u662f\u6700\u77ed\u89e3\uff09\u3002\n\n\u9996\u5148\u53ef\u4ee5\u628a\u5b50\u6811\u64cd\u4f5c\u53d8\u6210 DFS \u5e8f\u4e0a\u7684\u64cd\u4f5c\uff0c\u8003\u8651\u5bf9\u5e8f\u5217\u8fdb\u884c\u5206\u5757\uff0c\u8bbe\u5757\u7684\u5927\u5c0f\u4e3a $B1$\uff0c\u5bf9\u4e8e\u6563\u5757\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u66b4\u529b\u7ef4\u62a4\uff0c\u800c\u5bf9\u4e8e\u6574\u5757\uff0c\u6211\u4eec\u53e6\u5916\u8003\u8651\u65b9\u6cd5\u3002\n\n\u6211\u4eec\u53d1\u73b0\u6574\u5757\u76f4\u63a5\u7ef4\u62a4\u6bd4\u8f83\u56f0\u96be\uff0c\u4f46\u8003\u8651\u5230\u6709 $\\bmod x=y$\uff0c\u8fd9\u663e\u7136\u5c31\u662f\u6839\u53f7\u5206\u6cbb\u561b\uff0c\u518d\u8bbe\u9608\u503c $B2$\uff0c\u5f53 $x\\le B2$ \u7684\u65f6\u5019\u8003\u8651\u76f4\u63a5\u5728\u5bf9\u5e94\u7684\u5757\u4e0a\u9762\u66b4\u529b\u6253\u6807\u8bb0\uff0c\u8003\u8651 $x>B2$ \u7684\u65f6\u5019\u600e\u4e48\u505a\u3002\n\n\u6211\u4eec\u8003\u8651\u6df1\u5ea6\u4e3a $i$ \u5e76\u4e14\u5728\u7b2c $j$ \u4e2a\u5757\u7684\u70b9\u7684\u6807\u8bb0\u6570\u7ec4\uff0c\u663e\u7136\u5f53 $x>B2$ \u7684\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u66b4\u529b\u5728\u5bf9\u5e94\u6df1\u5ea6\u4e0a\u6253\u6807\u8bb0\uff0c\u7531\u4e8e\u4e00\u6a2a\u884c\u53ea\u6709 $n/B1$ \u4e2a\u5143\u7d20\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5148\u5dee\u5206\uff0c\u67e5\u8be2\u7684\u65f6\u5019\u76f4\u63a5\u66b4\u529b\u67e5\u5373\u53ef\u3002\n\n\u603b\u590d\u6742\u5ea6 $O(\\frac{nq}{B1}+\\frac{nq}{B2}+q(B1+B2))$\uff0c\u6b63\u5e38\u6765\u8bf4\u662f $B1=B2=\\sqrt n$ \u65f6\u6bd4\u8f83\u4f18\uff0c\u4f46\u8fd9\u6837\u7a7a\u95f4\u5c31\u662f $2n^{1.5}$ \u4e86\uff0c\u8fc7\u4e0d\u53bb\uff0c\u6240\u4ee5\u9700\u8981\u8c03\u6574\u4e00\u4e0b\uff0c\u6211\u628a $B1$ \u8c03\u5230\u4e86 $1500$\uff0c$B2$ \u8c03\u5230\u4e86 $200$ \u5c31\u8fc7\u4e86\u3002\n\n\u4e0b\u9762\u662f\u4ee3\u7801\uff08\u6ca1\u52a0\u5feb\u8bfb\u6ca1\u5361\u5e38\u80fd\u8fc7\uff09\n\n```cpp\n#include<cstdio>\n#include<cmath>\nusing namespace std;\nconst int N=3e5+2,M=202;\nint dep[N],dfn[N],cnt,id[N],s[N],B,B1;\nstruct edge{\n\tint next,to;\n}e[N];\nint first[N],len,T,n,siz[N],ans;\nint t1[N][M],t2[M][M][M];\nvoid add(int a,int b)\n{\n\te[++len]=edge{first[a],b};\n\tfirst[a]=len;\n}\nvoid BF(int l,int r,int x,int y,int z)\n{\n\tfor(int i=l;i<=r;i++)\n\t\tif(dep[i]%x==y) s[i]+=z;\n}\nvoid modify(int l,int r,int x,int y,int z)\n{\n\ty%=x;\n\tif(id[l]==id[r]) BF(l,r,x,y,z);\n\telse\n\t{\n\t\tBF(l,id[l]*B,x,y,z);\n\t\tBF((id[r]-1)*B+1,r,x,y,z);\n\t\tif(x<=B1)\n\t\t\tfor(int i=id[l]+1;i<id[r];i++)\n\t\t\t\tt2[i][x][y]+=z;\n\t\telse\n\t\t\tfor(int i=y;i<=n;i+=x)\n\t\t\t\tt1[i][id[l]+1]+=z,t1[i][id[r]]-=z;\n\t}\n}\nvoid dfs(int x)\n{\n\tsiz[x]=1;\n\tfor(int i=first[x],y;i;i=e[i].next)\n\t\tdep[dfn[y=e[i].to]=++cnt]=dep[dfn[x]]+1,dfs(y),siz[x]+=siz[y];\n}\nint a,x,y,z,op;\nint main()\n{\n\tscanf(\"%d%d\",&n,&T);\n\tfor(int i=2;i<=n;i++) scanf(\"%d\",&x),add(x,i);\n\tdfn[cnt=1]=1,dfs(1);\n\tB=1500,B1=200;\n\tfor(int i=1;i<=n;i++) id[i]=(i-1)/B+1;\n\twhile(T--)\n\t{\n\t\tscanf(\"%d\",&op);\n\t\tif(op==1)\n\t\t{\n\t\t\tscanf(\"%d%d%d%d\",&a,&x,&y,&z);\n\t\t\tmodify(dfn[a],dfn[a]+siz[a]-1,x,dep[dfn[a]]+y,z);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tscanf(\"%d\",&x);\n\t\t\tans=s[x=dfn[x]];\n\t\t\tfor(int i=1;i<=id[x];i++)\n\t\t\t\tans+=t1[dep[x]][i];\n\t\t\tfor(int i=1;i<=B1;i++)\n\t\t\t\tans+=t2[id[x]][i][dep[x]%i];\n\t\t\tprintf(\"%d\\n\",ans);\n\t\t}\n\t}\n}\n```",
        "postTime": 1664284166,
        "uid": 99506,
        "name": "_LHF_",
        "ccfLevel": 0,
        "title": "[Ynoi2077] stdmxeypz \u89e3\u9898\u62a5\u544a"
    },
    {
        "content": "[$\\tt Link$](/problem/P7710)\n\n## \u524d\u8a00\n\n\u7ecf\u8fc7\u4e86\u4e00\u5468\u7684\u6323\u624e\uff0c\u7ec8\u4e8e\u5bf9\u8fd9\u9898\u6709\u4e86\u4e00\u70b9\u7406\u89e3\uff08\u6211\u592a\u5f31\u4e86\uff08\u60b2\n\n\u6211\u7684\u505a\u6cd5\u76ee\u524d\u7684\u590d\u6742\u5ea6\u662f**\u6839\u53f7\u5e26 $\\log$ \u7684**\uff0c\u9700\u8981**\u795e\u5947\u7684\u5361\u5e38\u6280\u672f**\u3002\u4f46\u662f\u5728\u6211\u7684\u75af\u72c2\u5361\u5e38\u4e0b\uff08**\u540e\u9762\u4f1a\u7ed9\u51fa\u8be6\u7ec6\u65b9\u6cd5**\uff09\uff0c\u83b7\u5f97\u4e86**\u6700\u4f18\u89e3\u524d $7$** \u7684\u597d\u6210\u7ee9\u3002\n\n## \u9898\u89e3\n\n\u9996\u5148\u8fd9\u4e2a\u9898\u957f\u5f97\u975e\u5e38\u50cf [[Ynoi] \u521d\u59cb\u5316](/problem/P5309)\uff0c\u8003\u8651\u6839\u53f7\u5206\u6cbb\u3002\n\n---\n\n\u5bf9\u4e8e $x\\gt\\sqrt n$ \u7684\u4fee\u6539\uff0c\u8fd9\u79cd\u4fee\u6539\u8981\u6539\u7684\u5c42\u6570\u662f $\\sqrt n$ \u7ea7\u522b\u7684\u3002\u6211\u4eec\u8003\u8651\u5b58\u4e0b\u6811\u7684\u6bcf\u4e00\u5c42\uff0c\u7136\u540e\u628a\u6bcf\u4e00\u5c42\u90fd\u6309 $\\tt DFN$ \u6392\u5e8f\u3002\u5bf9\u4e8e\u6bcf\u4e00\u5c42\u7684\u4fee\u6539\u53ef\u4ee5\u4e8c\u5206\u51fa\u5b50\u6811\u5728\u8fd9\u4e00\u5c42\u4e0a\u5bf9\u5e94\u7684\u533a\u95f4\uff0c\u4e8c\u5206\u5b8c\u4e4b\u540e\u533a\u95f4\u4fee\u6539\u3002\u67e5\u8be2\u76f4\u63a5\u5728\u90a3\u4e2a\u70b9\u6240\u5728\u5c42\u4e0a\u5355\u70b9\u67e5\u8be2\u3002\u5206\u5757 $O(1)$ \u533a\u95f4\u4fee\u6539 $O(\\sqrt n)$ \u5355\u70b9\u67e5\u8be2\u5373\u53ef\u5e73\u8861\u590d\u6742\u5ea6\u3002\n\n\u7136\u540e\u4f60\u610f\u8bc6\u5230\u4e00\u4e2a\u95ee\u9898\uff1a**\u4e8c\u5206\u662f\u590d\u6742\u5ea6\u74f6\u9888**\u3002\u4e8e\u662f\u4f60\u60f3\u4e86\u5f88\u4e45\u5982\u4f55\u628a\u8fd9\u4e2a $\\log$ \u4f18\u5316\u6389\uff0c\u7136\u540e\u6253\u5f00\u9898\u89e3\u533a\uff0c\u53d1\u73b0\u4e86\u957f\u94fe\u5256\u5206\u3002\u3002\u3002~~\u5982\u679c\u65e9\u77e5\u9053\u8981\u7528\u957f\u5256\uff0c\u6211\u751a\u81f3\u5b81\u613f\u5199\u9ad8\u590d\u6742\u5ea6\u505a\u6cd5~~\n\n\u53d1\u73b0\u4e86\u53ef\u4ee5\u79bb\u7ebf\u5904\u7406\u6bcf\u4e00\u5c42\uff0c\u7136\u540e\u6784\u9020\u4e8c\u5206\u6570\u7ec4\u3002\u4f46\u662f\u597d\u50cf\u8fd9\u6837\u5b50\u7684\u8bdd\u66f4\u5bb9\u6613\u590d\u6742\u5ea6\u7206\u70b8\uff0c\u679c\u7136\u6211\u662f\u5927\u53e3\u80e1\u9009\u624b/kk\n\n---\n\n\u5bf9\u4e8e $x\\le\\sqrt n$ \u7684\u4fee\u6539\uff0c\u8003\u8651\u79bb\u7ebf\u95ee\u9898\uff0c\u7136\u540e\u679a\u4e3e $d$ \u4f5c\u4e3a\u4fee\u6539\u7684\u6a21\u6570\uff0c$r$ \u4f5c\u4e3a\u4fee\u6539\u7684\u4f59\u6570 $(1\\le d\\le\\sqrt n,0\\le r\\lt d)$\uff0c\u63d0\u53d6\u51fa **\u6240\u6709 $x=d,y=r$ \u7684\u4fee\u6539** \u4ee5\u53ca **\u8be2\u95ee\u7684\u70b9\u6df1\u5ea6\u6a21 $d$ \u4f59 $r$ \u7684\u8be2\u95ee**\uff0c\u7136\u540e\u628a\u8fd9\u4e2a\u5947\u602a\u7684\u4fee\u6539\u8f6c\u5316\u4e3a\u5b50\u6811\u52a0\uff0c\u8be2\u95ee\u8f6c\u5316\u4e3a\u5355\u70b9\u67e5\uff0c\u8dd1\u51fa $\\tt DFS$ \u5e8f\u5373\u53ef\u3002\n\n\u4f60\u53c8\u610f\u8bc6\u5230\u4e00\u70b9\uff1a\u8fd9\u79cd\u60c5\u51b5\u4e0b\u6bcf\u4e2a\u4fee\u6539\u53ea\u4f1a\u88ab\u7528\u4e00\u6b21\uff0c\u4f46\u662f\u6bcf\u4e2a\u8be2\u95ee\u4f1a\u88ab\u62c6\u6210 $\\sqrt n$ \u4e2a\uff08\u5bf9\u4e8e\u6bcf\u4e2a\u6a21\u6570\u5b83\u90fd\u4f1a\u88ab\u62c6\u51fa\u4e00\u4e2a\uff09\uff0c\u6240\u4ee5\u4f60\u9700\u8981\u4f7f\u7528 $O(\\sqrt n)$ \u533a\u95f4\u4fee\u6539 $O(1)$ \u533a\u95f4\u67e5\u8be2\u7684\u5206\u5757\u5c31\u884c\u4e86\u3002\n\n\u5982\u4f55\u63d0\u53d6\u51fa\u6211\u4eec\u60f3\u8981\u7684\u4fee\u6539\u548c\u8be2\u95ee\u5462\uff1f\u53ef\u4ee5\u8003\u8651\u679a\u4e3e $d=1,\\cdots,\\sqrt n$ \u4f5c\u4e3a\u6a21\u6570\uff0c\u4f7f\u7528 $d$ \u4e2a `vector` \u88c5\u4e0b\u6bcf\u4e2a $r=0,\\cdots,d-1$ \u4f5c\u4e3a\u4f59\u6570\u7684\u8be2\u95ee\u3002\n\n+ \u5bf9\u4e8e\u4e00\u4e2a\u4fee\u6539\uff0c\u5982\u679c\u6a21\u6570 $=d$\uff0c\u4f59\u6570 $=k$\uff0c\u8003\u8651\u5c06\u5176\u88c5\u5165\u7b2c $k$ \u4e2a `vector` \u91cc\u3002\n+ \u5bf9\u4e8e\u4e00\u4e2a\u8be2\u95ee\uff0c\u5982\u679c $a$ \u7684\u6df1\u5ea6\u6a21 $d=k$\uff0c\u8003\u8651\u5c06\u5176\u88c5\u5165\u7b2c $k$ \u4e2a `vector` \u91cc\u3002\n\n---\n\n\u518d\u7ed9\u4e00\u7ec4\u6570\u636e\n\n$\\texttt{in.txt}$\n\n```\n9 7\n1 1 2 2 3 4 4 8\n1 3 1 0 2\n2 6\n1 1 3 1 1\n1 4 8 2 4\n2 3\n2 2\n2 9\n```\n\n$\\texttt{out.txt}$\n\n```\n2\n3\n1\n5\n```\n\n\u5173\u4e8e\u6837\u4f8b\u8fc7\u4e0d\u4e86\u7684 $\\tt debug$\uff1a\u8003\u8651\u5c06\u6839\u53f7\u5206\u6cbb\u7684\u9608\u503c\u5206\u522b\u8c03\u5230 $0$ \u548c $10$\uff0c\u7136\u540e\u8dd1\u6837\u4f8b\u6216\u8005\u6211\u7684\u6570\u636e\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u6d4b\u8bd5\u6839\u53f7\u5206\u6cbb\u4e24\u90e8\u5206\u7684\u7a0b\u5e8f\u662f\u5426\u6b63\u786e\u3002\n\n## \u5b9e\u73b0\n\n\u8fd9\u4e2a\u4e0d\u592a\u7b80\u5355\uff0c\u6211\u8fd8\u662f\u9700\u8981\u8bb2\u51e0\u70b9\u3002\n\n$x\\gt\\sqrt n$ \u7684\u90e8\u5206\u3002\u9996\u5148\u4f60\u53ea\u9700\u8981\u5b58\u6bcf\u4e00\u5c42\u7684 $\\tt dfn$ \u5c31\u884c\u4e86\u3002\u6bd5\u7adf\u4f60\u4e5f\u53ea\u9700\u8981\u5c06\u5176\u6392\u5e8f\u5e76\u5728\u8fd9\u91cc\u9762\u4e8c\u5206\u3002\u63a5\u7740\u662f\u5173\u4e8e `vector` \u7684\u95ee\u9898\u3002\u770b\u5230\u6709\u7684\u9898\u89e3\u8bf4 \u6570\u7ec4+\u5185\u5b58\u9759\u6001\u5206\u914d \u4f1a\u66f4\u5feb\uff0c\u4f46\u662f\u6211\u5b9e\u8df5\u4e0b `vector` \u5feb\u5f97\u591a\u3002\n\n$x\\le\\sqrt n$ \u7684\u90e8\u5206\u3002\u4f60\u4e0d\u662f\u8981\u7528 $\\sqrt n$ \u4e2a `vector` \u6765\u5b58\u8be2\u95ee\u5417\uff1f\u90a3\u4f60\u5982\u4f55\u6e05\u7a7a\u4e00\u4e2a `vector` \u5462\uff1f\u6709\u4e00\u79cd\u5199\u6cd5\u662f\u5148 `clear()` \u518d `shrink_to_fit()`$\\texttt{(c++11)}$\u3002\u4f46\u662f\u5b9e\u8df5\u4e0b\u66f4\u5feb\u7684\u65b9\u5f0f\u662f\u5c06\u8fd9\u4e2a `vector` \u4e0e\u4e00\u4e2a\u7a7a\u7684 `vector` \u8fdb\u884c `swap`\u3002\n\n\u6ca1\u5361\u5e38\u7684\u4ee3\u7801\uff0c\u5220\u53bb\u5feb\u8bfb\u3001\u5934\u6587\u4ef6\u7b49\u90e8\u5206\uff0c[\u6211\u653e\u5728\u4e86\u8fd9\u91cc](https://www.luogu.com.cn/paste/42y2ltq5)\n\n[$\\tt 50pts$](https://www.luogu.com.cn/record/74222973)\n\n\u778e\u6761\u5757\u957f\u53ef\u4ee5\u83b7\u5f97\u66f4\u597d\u7684\u6210\u7ee9\uff08\u5757\u957f\u4e3a $0$ \u53ef\u4ee5\u83b7\u5f97 $\\tt 59pts$\uff09\uff0c\u8fd9\u90e8\u5206\u5c31\u4e0d\u8bb2\u4e86\uff0c\u4e0b\u9762\u5168\u662f\u66f4\u597d\u7684\u4f18\u5316\n\n## \u5361\u5e38\n\n\u5361\u5e38\u7684\u6280\u5de7\u5206\u4e3a\u4ee5\u4e0b\u51e0\u4e2a\u9636\u6bb5\u3002\uff08\u5757\u957f\u8fd9\u79cd\u4e3b\u8981\u662f\u548c\u5e38\u6570\u6709\u5173\uff0c\u6240\u4ee5\u6211\u7684\u548c\u60a8\u7684\u53ef\u80fd\u4e0d\u592a\u4e00\u6837\uff09\n\n1. \u4f7f\u7528\u4e00\u4e2a `flg` \u6570\u7ec4\uff0c\u5982\u679c $x\\le\\sqrt n$ \u90e8\u5206\u679a\u4e3e\u51fa\u4e86\u4e00\u4e2a $d$\uff0c\u4f46\u662f\u8fd9\u4e2a $d$ \u6ca1\u6709\u4efb\u4f55\u4e0e\u4e4b\u914d\u5bf9\u7684\u4fee\u6539\uff0c\u90a3\u4e48\u5c31\u8df3\u8fc7\uff08\u6bd5\u7adf\u8be2\u95ee\u4e5f\u53ea\u80fd\u662f $0$\uff09\u3002\n\n2. \u4f7f\u7528\u4e00\u4e2a `Flg` \u6570\u7ec4\uff0c\u5982\u679c $x\\le\\sqrt n$ \u90e8\u5206\u679a\u4e3e\u51fa\u4e86\u4e00\u4e2a $d$\uff0c\u90a3\u4e48\u6807\u6ce8\u51fa\u6240\u6709\u7684 $r=1,\\cdots,d-1$\uff0c$r$ \u6709\u6ca1\u6709\u5bf9\u5e94\u7684\u4fee\u6539\uff0c\u6ca1\u6709\u5c31\u8df3\u8fc7\u3002\n\n3. \u778e\u8c03\u9608\u503c\uff0c\u53d1\u73b0 $\\sqrt n$ \u8fc7\u4e0d\u53bb\uff08\u663e\u7136\u590d\u6742\u5ea6\u5c31\u6709\u95ee\u9898\uff09\uff0c$\\sqrt{n\\log n}$ \u4e5f\u8fc7\u4e0d\u53bb\uff08\u56e0\u4e3a\u9020\u6570\u636e\u4eba\u5361\u4e86\uff09\u3002\n\n+ \u9009\u5728 $\\sqrt n$\uff0c\u4e0a\u9762\u90e8\u5206\u70b9 $\\tt AC$\uff0c\u4e0b\u9762\u90e8\u5206\u70b9 $\\tt TLE$\u3002\n+ \u9009\u5728 $\\mathtt{900\\sim 1000}$\uff0c\u4e0a\u9762\u90e8\u5206\u70b9 $\\tt TLE$\uff0c\u4e0b\u9762\u90e8\u5206\u70b9 $\\tt AC$\u3002\n+ \u6700\u540e\u8bf7\u6765 [$\\tt\\color{black}o \\color{red}rz\\_z$](https://www.luogu.com.cn/user/257146)\uff0c\u4ed6\u5e2e\u6211\u4f18\u5316\u4e86\u5feb\u8bfb\uff0c\u6539\u4e3a\u4e86 $\\texttt{C++98}$\uff0c\u52a0\u4e86 `register`\uff0c\u4ee5\u53ca**\u628a\u5757\u957f\u9002\u5ea6\u8c03\u5c0f**\uff0c\u83b7\u5f97\u4e86\u66f4\u9ad8\u7684\u6210\u7ee9\u3002\n\n4. \u9002\u5f53\u5f03\u7528 `STL`\u3002\u6211\u60f3\u8fc7\u4e22\u6389 `vector`\uff0c\u4f46\u662f\u53d8\u6162\u4e86\u3002\u4e8e\u662f\u6211\u5c1d\u8bd5\u624b\u5199\u4e86 `lower_bound` \u548c `upper_bound`\uff0c\u7136\u540e\u5feb\u4e86\u5f88\u591a\u3002\n\n5. \u6700\u540e\u7684\u4e00\u6b65\u4e86\u3002\u8fd9\u65f6\u6211\u5df2\u7ecf\u80fd\u628a\u6240\u6709\u7684\u70b9 $\\tt AC$ \u4e00\u904d\uff08\u4f46\u4e0d\u662f\u540c\u65f6\uff09\uff0c\u4e8e\u662f\u6211\u51b3\u5b9a\u5199\u4e00\u4e2a\u7a0b\u5e8f\u6765\u4f18\u5316\u81ea\u5df1\u7684\u9608\u503c\u7684\u9009\u62e9\u3002\n\n```cpp\n// \u8ba1\u7b97\u4ee5 Lm \u4e3a\u9608\u503c\uff0c\u8981\u8ba1\u7b97\u591a\u5c11\u6b21\u3002;\nconst double d1,d2,d3,d4;\n// d1\uff1ax>lim\u90e8\u5206\u7684\u4fee\u6539\u5e38\u6570\n// d2\uff1ax<=lim\u90e8\u5206\u7684\u4fee\u6539\u5e38\u6570\n// d3\uff1ax>lim\u90e8\u5206\u7684\u8be2\u95ee\u5e38\u6570\n// d4\uff1ax<=lim\u90e8\u5206\u7684\u8be2\u95ee\u5e38\u6570\nint blkcnt(int Lm){\n\tint cnt = 0\n\tfor(int i = 1;i <= m;++i){\n\t\ta = qa[i],x = qx[i];\n\t\tif(qo[i] == 1){\n\t\t\tif(x > Lm) cnt += (K - dep[a]) / x * d1 + 1;\n\t\t\telse cnt += sqrt(n) * d2;\n\t\t} else {\n\t\t\tcnt += sqrt(C[dep[a]]) * d3;\n\t\t\tcnt += Lm * d4;\n\t\t}\n\t}\n\treturn cnt;\n}\n```\n\n\u7136\u540e\u7528 $\\tt 550$ \u548c $\\tt 950$ \u6765\u8ba1\u7b97\uff0c\u7528\u603b\u6b21\u6570\u6700\u5c0f\u7684\u90a3\u4e2a\u503c\u6765\u505a\u5757\u957f\u3002\n\n\u7136\u540e\u5206\u6ca1\u6709\u53d8\uff0c\u6211\u610f\u8bc6\u5230\u4e0d\u80fd\u53ea\u7528\u4e24\u4e2a\uff0c\u6211\u7528\u4e86 $\\mathtt{200\\sim 1150}$ \u7684\u6240\u6709 $\\tt 50$ \u7684\u500d\u6570\u7684\u6570\u6d4b\u8bd5\uff0c\u53c8\u7a0d\u5fae\u66f4\u6539\u4e86 $d1,\\cdots,d4$ \u7684\u53d6\u503c\uff0c\u83b7\u5f97\u4e86 $\\tt AC$\u3002\n\n[**AC \u4ee3\u7801**](https://www.luogu.com.cn/paste/waz4mgqb)",
        "postTime": 1650603496,
        "uid": 368107,
        "name": "xfrvq",
        "ccfLevel": 7,
        "title": "\u9898\u89e3-P7710 [Ynoi2077] stdmxeypz"
    },
    {
        "content": "\u4e0d\u7406\u89e3\u4e3a\u4ec0\u4e48\u9898\u89e3\u533a\u5168\u662f\u8981\u4e48\u5e26 $\\log$ \u8981\u4e48\u7a7a\u95f4\u4e0d\u4f18\u7684\u505a\u6cd5\u3002\n\n\u663e\u7136\u7684\u6839\u53f7\u5206\u6cbb\uff0c\u4ee4 $B=O(\\sqrt n)$\u3002\n\n\u5bf9 $x\\ge B$ \u7684\u8be2\u95ee\uff0c\u8003\u8651\u539f\u6811\u7684 bfs \u5e8f\uff0c\u4e00\u6b21\u81f3\u591a\u53ea\u4f1a\u66f4\u65b0 $O(\\sqrt n)$ \u5c42\uff0c\u800c\u6bcf\u5c42\u5728 bfs \u5e8f\u4e0a\u8fde\u7eed\uff0c\u53ea\u8981\u80fd\u5feb\u901f\u5b9a\u4f4d\u51fa\u8fd9\u4e9b\u533a\u95f4\u5c31\u53ef\u4ee5\u62ff\u4e2a $O(1)-O(\\sqrt n)$ \u7684\u5206\u5757\u7ef4\u62a4\u3002\u5982\u679c\u5728 dfs \u5e8f\u4e0a\u4e8c\u5206\u4f1a\u591a\u534a\u4e2a $\\log$\uff0c\u975e\u5e38\u4e0d\u723d\u3002\u7136\u800c\u7531\u4e8e\u6811\u7684\u6027\u8d28\u6211\u4eec\u53ef\u4ee5\u4f18\u5316\u3002\u6211\u4eec\u9700\u8981\u7684\u4e1c\u897f\u663e\u7136\u662f $a$ \u5b50\u6811\u5185\u5230 $a$ \u8ddd\u79bb\u819c $x$ \u4f59 $y$ \u7684\u70b9\u4e2d\u6700\u5927/\u6700\u5c0f\u7684 bfs \u5e8f\u3002\u6ce8\u610f\u5230\u548c\u5b50\u6811\u6df1\u5ea6\u6709\u5173\uff0c\u4f7f\u7528\u957f\u94fe\u5256\u5206\uff0c\u79bb\u7ebf\u64cd\u4f5c\u5373\u53ef\u89e3\u51b3\u3002\n\n\u5bf9 $x<B$ \u7684\u8be2\u95ee\uff0c\u5bf9\u6bcf\u4e2a $x$ \u5206\u5f00\u8003\u8651\uff0c\u5c06\u8282\u70b9\u6309\u6df1\u5ea6\u819c $x$ \u4e3a\u7b2c\u4e00\u5173\u952e\u5b57\uff0cdfs \u5e8f\u4e3a\u7b2c\u4e8c\u5173\u952e\u5b57\u91cd\u65b0\u7f16\u53f7\uff0c\u5bb9\u6613\u77e5\u9053\u6bcf\u6b21\u66f4\u65b0\u7684\u662f\u4e00\u4e2a\u533a\u95f4\uff0c\u7528 $O(\\sqrt n)-O(1)$ \u7684\u5206\u5757\u7ef4\u62a4\u3002\u8fd9\u4e2a\u5b9a\u4f4d\u53ef\u4ee5\u76f4\u63a5\u4e8c\u5206\uff0c\u4e0d\u6784\u6210\u590d\u6742\u5ea6\u74f6\u9888\u3002\n\n\u8fd9\u6837\u505a\u65f6\u7a7a\u590d\u6742\u5ea6\u90fd\u662f $O(n\\sqrt n)$\uff0c\u4f46\u7a7a\u95f4\u663e\u7136\u53ef\u4ee5\u4f18\u5316\u3002\u6ce8\u610f\u5230\u7a7a\u95f4\u7684\u74f6\u9888\u662f\u5b58\u4e0b\u6bcf\u4e2a $x\\ge B$ \u7684\u8be2\u95ee\u5bf9\u5e94\u7684\u6240\u6709\u533a\u95f4\uff0c\u4e8e\u662f\u5c1d\u8bd5\u51cf\u5c11\u5b58\u50a8\u7684\u533a\u95f4\u6570\u3002\u53d1\u73b0\u957f\u5256\u7684\u590d\u6742\u5ea6\u5e76\u6ca1\u6709\u5361\u6ee1\uff0c\u90a3\u5c31\u597d\u89e3\u51b3\u4e86\uff0c\u6bcf\u6b21\u6211\u4eec\u53ea\u5904\u7406 $O(\\sqrt n)$ \u4e2a\u4fee\u6539\uff0c\u8fd9\u6837\u7a7a\u95f4\u590d\u6742\u5ea6\u964d\u4e3a $O(n)$\u3002\n\n\u5e38\u6570\u76f8\u6bd4\u5176\u4ed6\u9898\u7b97\u662f\u5c0f\u95ee\u9898\uff0c\u968f\u4fbf\u5361\u5361\u5c31\u8fc7\u4e86\u3002\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nconst int N=3e5+5,L=4005;\nint read(){\n\tint res=0;char c=getchar();\n\twhile(c<48)c=getchar();\n\twhile(c>=48)res=res*10+c-48,c=getchar();\n\treturn res;\n}\nint n,m,B,B1,rb[L],b[N],sb[L],vp[N],dep[N],id0[N],id1[N],id[N],cntn,cntq,ans[N],sz[N],rkk[N];\nint len[N],lson[N],ff[N<<1],gg[N<<1],*buff=ff,*bufg=gg,cntt[L],*cnt=cntt+1,rk[N],rp[L];\nstruct event{int a,x,y,z;} q[N];vector<event> qw[N];vector<pair<int,int> > vq[L];vector<int> son[N];\nvoid modify(int x,int v){sb[b[x]]+=v,vp[x]+=v;}\nint query(int x){int res=0;for(int i=1;i<b[x];i++)res+=sb[i];for(int i=rb[b[x]-1]+1;i<=x;i++)res+=vp[i];return res;}\nvoid modify2(int x,int v){for(int i=x;i<=rb[b[x]];i++)vp[i]+=v;for(int i=b[x];i<=b[n];i++)sb[i]+=v;}\nint query2(int x){return sb[b[x]-1]+vp[x];}\nvoid dfs(int x){\n\trk[id0[x]=++cntn]=x,sz[x]=1;\n\tfor(int y:son[x]){dep[y]=dep[x]+1,dfs(y),sz[x]+=sz[y];if(len[y]>len[x])len[x]=len[y],lson[x]=y;}\n\tlen[x]++;\n}\nvoid bfs(){\n\tqueue<int> q;q.push(1),cntn=0;\n\twhile(!q.empty()){\n\t\tint x=q.front();q.pop(),id1[x]=++cntn;\n\t\tfor(int y:son[x])q.push(y);\n\t}\n}\nvoid dp(int x,int *f,int *g){\n\tf[0]=g[0]=id1[x];\n\tif(lson[x])dp(lson[x],f+1,g+1);\n\tfor(int y:son[x])if(y!=lson[x]){\n\t\tint *tf=buff,*tg=bufg;buff+=len[y]+1,bufg+=len[y]+1;\n\t\tdp(y,tf,tg);\n\t\tfor(int i=0;i<len[y];i++)f[i+1]=max(f[i+1],tf[i]),g[i+1]=min(g[i+1],tg[i]);\n\t}\n\tfor(auto j:qw[x])\n\t\tfor(int i=j.y;i<len[x];i+=j.x)vq[j.z].push_back(make_pair(g[i],f[i]));\n}\nint getfir(int p,int x){\n\tint l=(p==0?1:rp[p-1]+1),r=rp[p];x=id0[x];\n\twhile(l<=r){\n\t\tint mid=l+r>>1;\n\t\tif(id0[rkk[mid]]<x)l=mid+1;\n\t\telse r=mid-1;\n\t}\n\treturn l;\n}\nint getlst(int p,int x){\n\tint l=(p==0?1:rp[p-1]+1),r=rp[p];x=id0[x]+sz[x]-1;\n\twhile(l<=r){\n\t\tint mid=l+r>>1;\n\t\tif(id0[rkk[mid]]>x)r=mid-1;\n\t\telse l=mid+1;\n\t}\n\treturn r;\n}\nint main(){\n\tn=read(),m=read(),B=sqrt(n),B1=0.6*sqrt(n);\n\tfor(int i=1;i<=n;i++)b[i]=(i-1)/B+1;\n\tfor(int i=1;i<b[n];i++)rb[i]=i*B;rb[b[n]]=n;\n\tfor(int i=2,x;i<=n;i++)x=read(),son[x].push_back(i);\n\tdfs(1),bfs();\n\tfor(int i=1,op;i<=m;i++){\n\t\top=read();\n\t\tif(op==1)q[i].a=read(),q[i].x=read(),q[i].y=read(),q[i].z=read();\n\t\telse q[i].a=read(),q[i].z=++cntq;\n\t}\n\tfor(int i=1,j=1;i<=m;i=j){\n\t\tint tc=0;\n\t\tfor(int j=1;j<L;j++)vq[j].clear(),vq[j].shrink_to_fit();\n\t\tfor(int j=1;j<=n;j++)qw[j].clear();\n\t\tfor(j=i;j<=m&&tc<L-2;j++)if(q[j].x>=B1)qw[q[j].a].push_back((event){q[j].a,q[j].x,q[j].y,++tc});\n\t\tbuff=ff+len[1]+1,bufg=gg+len[1]+1,dp(1,ff,gg),tc=0;\n\t\tfor(int j=i;j<=m&&tc<L-2;j++)\n\t\t\tif(q[j].x==0)ans[q[j].z]+=query(id1[q[j].a]);\n\t\t\telse if(q[j].x>=B1){tc++;for(auto t:vq[tc])modify(t.first,q[j].z),modify(t.second+1,-q[j].z);}\n\t}\n\tfor(int k=1;k<B1;k++){\n\t\tcntn=0;\n\t\tfor(int i=-1;i<k;i++)cnt[i]=0;\n\t\tfor(int i=1;i<=n;i++)cnt[dep[i]%k]++;\n\t\tfor(int i=0;i<k;i++)rp[i]=(cnt[i]+=cnt[i-1]);\n\t\tfor(int i=1;i<=n;i++)rkk[id[rk[i]]=++cnt[dep[rk[i]]%k-1]]=rk[i];\n\t\tfill(sb,sb+B+2,0),fill(vp,vp+n+1,0);\n\t\tfor(int i=1;i<=m;i++)\n\t\t\tif(q[i].x==0)ans[q[i].z]+=query2(id[q[i].a]);\n\t\t\telse if(q[i].x==k){\n\t\t\t\tint ll=getfir((q[i].y+dep[q[i].a])%k,q[i].a),rr=getlst((q[i].y+dep[q[i].a])%k,q[i].a);\n\t\t\t\tif(ll>rr)continue;\n\t\t\t\tmodify2(ll,q[i].z);if(rr<n)modify2(rr+1,-q[i].z);\n\t\t\t}\n\t}\n\tfor(int i=1;i<=cntq;i++)printf(\"%d\\n\",ans[i]);\n\treturn 0;\n}\n```",
        "postTime": 1643018131,
        "uid": 77174,
        "name": "FunnyCreatress",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P7710\u3010 [Ynoi2077] stdmxeypz\u3011"
    },
    {
        "content": "\u8fd9\u9898\u4e3a\u4ec0\u4e48 $O(n\\sqrt n\\log n)$ \u5361\u4e0d\u6389\uff0c\u8fd9\u590d\u6742\u5ea6\u90fd\u9ad8\u4e00\u500d\u4e86\u5427...\n\n**\u524d\u7f6e\u829d\u58eb**\n\n\u5148\u505a[\u521d\u59cb\u5316](https://www.luogu.com.cn/problem/P5309)\uff0c\u9608\u503c\u5206\u6cbb\uff0ccdq \u5206\u6cbb\uff0c$dfs$ \u5e8f\u3002\n\n**Solution**\n\n\u8fd9\u4e2a\u9898\u7684\u9608\u503c\u5206\u6cbb\u6781\u5176\u660e\u663e\uff0c\u5c31\u662f\u524d\u7f6e\u829d\u58eb\u91cc\u90a3\u9053\u9898\u7684\u6811\u4e0a\u7248\u3002\u56e0\u4e3a\u6bcf\u6761\u8fb9\u7684\u957f\u5ea6\u4e3a $1$\uff0c\u6240\u4ee5\u201c\u8ddd\u79bb\u6a21 $x$ \u7b49\u4e8e $y$ \u7684\u8282\u70b9\u201d\u5c31\u662f\u201c\u6df1\u5ea6\u5dee\u6a21 $x$ \u7b49\u4e8e $y$ \u7684\u8282\u70b9\u201d\uff0c\u7528\u9608\u503c\u5206\u6cbb\u5c31\u5f88\u597d\u5b9e\u73b0\u3002\n\n\u7136\u540e\u662f\u4e00\u4e2a\u201c\u5b50\u6811\u201d\u7684\u9650\u5236\uff0c\u60f3\u5230 $dfs$ \u5e8f\u91cc\u7684\u6027\u8d28\uff0c\u8003\u8651\u5c06\u6811\u6620\u5c04\u5728\u5e8f\u5217\u91cc\uff0c\u7136\u540e\u628a\u5b50\u6811\u9650\u5236\u8f6c\u6362\u4e3a\u5e8f\u5217\u4e0a\u7684\u533a\u95f4\u9650\u5236\u3002\n\n\u56e0\u4e3a\u6bcf\u6b21\u4fee\u6539\u53ea\u80fd\u5728\u4e00\u4e2a\u533a\u95f4\u8303\u56f4\u5185\uff0c\u800c\u9608\u503c\u5206\u6cbb\u901a\u5e38\u662f\u5168\u5c40\u7684\u6570\u7ec4\uff0c\u6240\u4ee5\u5047\u8bbe $a$ \u8282\u70b9\u7684\u5b50\u6811\u5728 $dfs$ \u5e8f\u91cc\u7684\u533a\u95f4\u662f $l_a,r_a$\uff08$l_a$ \u662f\u5176\u7b2c\u4e00\u6b21\u9012\u5f52\u7684\u4f4d\u7f6e\uff0c$r_a$ \u662f\u5b83\u56de\u6eaf\u65f6\u5e8f\u5217\u7684\u957f\u5ea6\uff09\uff0c\u8fd9\u4e1c\u897f\u5c31\u53ef\u4ee5\u5dee\u5206\u6210\u4e24\u4e2a\u540e\u7f00\u3002\n\n\u60f3\u5230\u8fd9\u91cc\uff0c\u53d1\u73b0\u9650\u5236\u6709\u70b9\u591a\uff0c\u8003\u8651 cdq \u5206\u6cbb\uff1a\u4e00\u4e2a\u64cd\u4f5c\u5bf9\u4e00\u4e2a\u8be2\u95ee\u751f\u6548\u5f53\u4e14\u4ec5\u5f53 $tim_i<tim_j,l_{a_i}\\le l_{a_j}\\le r_{a_i},depth_{a_j}\\equiv depth_{a_i}+y_i(\\mod x_i)$\uff0c\u7b2c\u4e8c\u4e2a\u9650\u5236\u6211\u4eec\u5dee\u5206\u6210\u4e86\u4e24\u4e2a\u540e\u7f00\u5dee\uff0c\u7b2c\u4e09\u4e2a\u7528\u9608\u503c\u5206\u6cbb\u5b9e\u73b0\uff0c\u7136\u540e cdq \u5c31\u884c\u4e86\u3002\n\n~~\u5e38\u6570\u5c0f\u5c31\u662f $96pts$\uff0c\u5e38\u6570\u5927\u7684\u4e0d\u597d\u8bf4......~~\n\n\u8003\u8651\u5728 $O(\\sqrt n)$ \u7684\u5730\u65b9\u7384\u5b66\u4f18\u5316\uff1a\u53d1\u73b0\u4e24\u4e2a\u540e\u7f00\u6709\u65f6\u5019\u6709\u70b9\u957f\uff0c\u6240\u4ee5\u5f53 $l_a\\le \\sqrt n$ \u65f6\u5c31\u5168\u5c40\u66b4\u529b\uff0c\u7136\u540e\u64a4\u9500\u524d $\\sqrt n$ \u7684\u8d21\u732e\uff0c\u5982\u679c $r_a\\ge n-\\sqrt n$\uff0c\u5c31\u5411\u4e0a\u9762\u90a3\u6837\u66b4\u529b\u51cf\u3002\u5982\u679c $r_a-l_a\\le\\sqrt n$\uff0c\u90a3\u76f4\u63a5\u66b4\u529b\u5373\u53ef\u3002\n\n\u9a6c\u826f\u597d\u5c0f\u554a qwq\u3002\n\n**\u7eaf cdq \u4ee3\u7801**\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\ntemplate<typename zqw>void qr(zqw &x) {\n\tbool f=x=0;\n\tchar c=getchar();\n\twhile(!isdigit(c)) f|=c=='-',c=getchar();\n\twhile(isdigit(c)) x=(x<<3)+(x<<1)+(c^48),c=getchar();\n\tx=f?~(x-1):x;\n\treturn ;\n}\nconst int N=300005,lim=600;\nstruct node{int op,x,delta,mod,dep,id;}q[N<<1],tmp[N<<1];\nint srz[lim+5][lim+5],n,m,lxl[N],ans[N],fa[N],head[N],nxt[N],to[N],pos[N][2],cnt,ccnt,order,depth[N],op,a,tim,x,y,z,depthest;\ninline void update1(int p) {srz[q[p].mod][q[p].dep]+=q[p].delta;return ;}\ninline void update2(int p) {for(int i=q[p].dep;i<=depthest;i+=q[p].mod) lxl[i]+=q[p].delta;return ;}\ninline void init(int p) {if(q[p].mod<=lim) srz[q[p].mod][q[p].dep]=0;else for(int i=q[p].dep;i<=depthest;i+=q[p].mod) lxl[i]=0;return ;}\ninline int ask(int x,bool typ) {int tot=lxl[x];for(int i=1;i<=lim;i++) tot+=srz[i][x%i];return tot;}\ninline void add(int u,int v) {nxt[++ccnt]=head[u],head[u]=ccnt,to[ccnt]=v;return ;}\nvoid dfs(int x) {\n\tpos[x][0]=++order,depthest=max(depthest,depth[x]);\n\tfor(int i=head[x];i;i=nxt[i]) depth[to[i]]=depth[x]+1,dfs(to[i]);\n\tpos[x][1]=order;\n}\nvoid cdq(int l,int r) {\n\tif(l==r) return ;\n\tint mid=l+r>>1;\n\tcdq(l,mid),cdq(mid+1,r);\n\tint p1=l,p2=mid+1,top=l-1;\n\twhile(p1<=mid&&p2<=r) {\n\t\tif(q[p1].x<=q[p2].x) {\n\t\t\tif(q[p1].op) {\n\t\t\t\tif(q[p1].mod<=lim) update1(p1);\n\t\t\t\telse update2(p1);\n\t\t\t}tmp[++top]=q[p1++];\n\t\t}else (!q[p2].op)&&(ans[q[p2].id]+=ask(q[p2].dep,0)),tmp[++top]=q[p2++];\n\t}\n\twhile(p2<=r) (!q[p2].op)&&(ans[q[p2].id]+=ask(q[p2].dep,1)),tmp[++top]=q[p2++];\n\tfor(int i=l;i<p1;i++) if(q[i].op) init(i); while(p1<=mid) tmp[++top]=q[p1++];\n\tfor(int i=l;i<=r;i++) q[i]=tmp[i];\n\treturn ;\n}\nint main() {\n\tqr(n),qr(m);\n\tfor(int i=2;i<=n;i++) qr(fa[i]),add(fa[i],i);dfs(1);\n\tfor(int i=1;i<=m;i++) {\n\t\tqr(op),qr(a);\n\t\tif(op^1) {\n\t\t\tq[++cnt]=(node){0,pos[a][0],0,0,depth[a],++tim};\n\t\t}else {\n\t\t\tqr(x),qr(y),qr(z);\n\t\t\tq[++cnt]=(node){1,pos[a][0],z,x,(depth[a]+y)%x,0};\n\t\t\tq[++cnt]=(node){1,pos[a][1]+1,-z,x,(depth[a]+y)%x,0};\n\t\t}\n\t}\n\tcdq(1,cnt);\n\tfor(int i=1;i<=tim;i++) printf(\"%d\\n\",ans[i]);\n\treturn 0;\n}\n```\n\n**\u7384\u5b66\u4f18\u5316\u4ee3\u7801**\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\nnamespace IO{//by cyffff\n\tchar ibuf[(1<<20)+1],*iS,*iT;\n\t#if ONLINE_JUDGE\n\t#define gh() (iS==iT?iT=(iS=ibuf)+fread(ibuf,1,(1<<20)+1,stdin),(iS==iT?EOF:*iS++):*iS++)\n \t#else\n\t#define gh() getchar()\n\t#endif\n\t#define reg register\n\tinline long long read(){\n\t\treg char ch=gh();\n\t\treg long long x=0;\n\t\treg char t=0;\n\t\twhile(ch<'0'||ch>'9')   t|=ch=='-',ch=gh();\n\t\twhile(ch>='0'&&ch<='9') x=x*10+(ch^48),ch=gh();\n\t\treturn t?-x:x;\n\t}\n}\nusing IO::read;\nconst int N=300005,lim=559;\nstruct node{int op,x,delta,mod,dep,id;}q[N<<1],tmp[N<<1];\nint srz[lim+5][lim+5],n,m,lxl[N],Lxl[N],ord[N],ans[N],fa[N],head[N],nxt[N],to[N],pos[N][2],cnt,ccnt,order,depth[N],op,a,tim,x,y,z,depthest;\ninline void update1(const int&p) {srz[q[p].mod][q[p].dep]+=q[p].delta;return ;}\ninline void update2(const int&p) {for(register int i=q[p].dep;i<=depthest;i+=q[p].mod) lxl[i]+=q[p].delta;return ;}\ninline void init(const int&p) {if(q[p].mod<=lim) srz[q[p].mod][q[p].dep]=0;else for(register int i=q[p].dep;i<=depthest;i+=q[p].mod) lxl[i]=0;return ;}\ninline int ask(const int&x) {int tot=lxl[x];for(register int i=1;i<=lim;i++) tot+=srz[i][x%i];return tot;}\ninline void add(const int&u,const int&v) {nxt[++ccnt]=head[u],head[u]=ccnt,to[ccnt]=v;return ;}\nvoid dfs(int x) {\n\tpos[x][0]=++order,depthest=max(depthest,depth[x]),ord[order]=x;\n\tfor(register int i=head[x];i;i=nxt[i]) depth[to[i]]=depth[x]+1,dfs(to[i]);\n\tpos[x][1]=order;\n}\nvoid cdq(const int l,const int r) {\n\tif(l==r) return ;\n\tconst int mid=l+r>>1;\n\tcdq(l,mid),cdq(mid+1,r);\n\tint p1=l,p2=mid+1,top=l-1;\n\twhile(p1<=mid&&p2<=r) {\n\t\tif(q[p1].x<=q[p2].x) {\n\t\t\tif(q[p1].op) {\n\t\t\t\tif(q[p1].mod<=lim) update1(p1);\n\t\t\t\telse update2(p1);\n\t\t\t}tmp[++top]=q[p1++];\n\t\t}else (!q[p2].op)&&(ans[q[p2].id]+=ask(q[p2].dep)),tmp[++top]=q[p2++];\n\t}\n\twhile(p2<=r) (!q[p2].op)&&(ans[q[p2].id]+=ask(q[p2].dep)),tmp[++top]=q[p2++];\n\tfor(register int i=l;i<p1;i++) if(q[i].op) init(i); while(p1<=mid) tmp[++top]=q[p1++];\n\tfor(register int i=l;i<=r;i++) q[i]=tmp[i];\n\treturn ;\n}\nint main() {\n\tn=read(),m=read();\n\tfor(register int i=2;i<=n;i++) fa[i]=read(),add(fa[i],i);dfs(1);\n\tfor(register int j=1;j<=m;j++) {\n\t\top=read(),a=read();\n\t\tif(op==2) {\n\t\t\tq[++cnt]=(node){0,pos[a][0],0,0,depth[a],++tim};\n\t\t\tans[tim]+=lxl[depth[a]]+Lxl[a];\n\t\t\tfor(int i=1;i<=lim;i++) ans[tim]+=srz[i][depth[a]%i];\n\t\t}else {\n\t\t\tx=read(),y=read(),z=read();\n\t\t\tif(pos[a][1]-pos[a][0]<=lim) {\n\t\t\t\tfor(int i=pos[a][0];i<=pos[a][1];i++) if(depth[ord[i]]%x==(depth[a]+y)%x) Lxl[ord[i]]+=z;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif(pos[a][0]<=lim) {\n\t\t\t\tif(x<=lim) srz[x][(depth[a]+y)%x]+=z;\n\t\t\t\telse for(int i=(depth[a]+y)%x;i<=depthest;i+=x) lxl[i]+=z;\n\t\t\t\tfor(int i=1;i<pos[a][0];i++) if(depth[ord[i]]%x==(depth[a]+y)%x) Lxl[ord[i]]-=z;\n\t\t\t}else q[++cnt]=(node){1,pos[a][0],z,x,(depth[a]+y)%x,0};\n\t\t\tif(pos[a][1]>=n-lim) {\n\t\t\t\tfor(int i=pos[a][1]+1;i<=order;i++) if(depth[ord[i]]%x==(depth[a]+y)%x) Lxl[ord[i]]-=z;\n\t\t\t}else q[++cnt]=(node){1,pos[a][1]+1,-z,x,(depth[a]+y)%x,0};\n\t\t}\n\t}\n\tmemset(srz,0,sizeof(srz)),memset(lxl,0,sizeof(lxl));\n\tcdq(1,cnt);\n\tfor(register int i=1;i<=tim;i++) printf(\"%d\\n\",ans[i]);\n\treturn 0;\n}\n```",
        "postTime": 1646741601,
        "uid": 383791,
        "name": "Others",
        "ccfLevel": 7,
        "title": "P7710 \u9898\u89e3"
    }
]