[
    {
        "content": "#### \u3010Ynoi2012\u3011 \u68a6\u65ad SCOI2017\n\u9898\u76ee\u5927\u610f\uff1a\n- \u6709\u4e00\u9897\u9759\u6001\u6811\uff0c\u4e00\u5171\u6709 30 \u79cd\u989c\u8272\uff0c\u6bcf\u6b21\u4f1a\u5355\u70b9\u6216\u8005\u540c\u8272\u5757\u4fee\u6539\u989c\u8272\u3002\n- \u8be2\u95ee\uff1a\n  - \u67d0\u4e2a\u8282\u70b9\u7684\u989c\u8272\u3002\n   - \u8fd9\u4e2a\u8282\u70b9\u7684\u540c\u8272\u5757\u7684\u5927\u5c0f\u3002\n   - \u8fd9\u4e2a\u8282\u70b9\u540c\u8272\u5757\u7684\u6df1\u5ea6\u6700\u5927\u503c\u548c\u6700\u5c0f\u503c\u3002\n\n\u9898\u89e3\uff1asplay & \u62ec\u53f7\u5e8f\u3002\n- \u6211\u4eec\u8003\u8651\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u8282\u70b9\u7ef4\u62a4\u6bcf\u4e00\u79cd\u4e0d\u540c\u4e8e\u81ea\u5df1\u989c\u8272\u7684\u513f\u5b50\u7684 ETT \uff0c\u5982\u679c\u4e00\u4e2a\u8282\u70b9\u7684\u989c\u8272\u4e0e\u7236\u4eb2\u76f8\u540c\uff0c\u90a3\u4e48\u8fd9\u4e2a\u8282\u70b9\u5e94\u4e0e\u7236\u4eb2\u5728\u540c\u4e00\u9897 ETT \u5f53\u4e2d\u3002\u5373\u6211\u4eec\u7528 ETT \u68ee\u6797\u7ef4\u62a4\u6bcf\u4e00\u4e2a\u540c\u8272\u8fde\u901a\u5757\u3002\u5982\u679c\u4e24\u4e2a\u8fde\u901a\u5757\u6709\u76f8\u540c\u7684\u989c\u8272\u548c\u7236\u4eb2\u5e76\u4e14\u989c\u8272\u4e0d\u540c\u4e8e\u7236\u4eb2\uff0c\u90a3\u4e48\u663e\u7136\u4ed6\u4eec\u53ef\u4ee5\u7b80\u5355\u5730\u6536\u5c3e\u76f8\u63a5\u5c06\u4e8c\u8005\u5408\u5e76\u3002\u5e76\u7ef4\u62a4\u51fa\u94fe\u63a5\u5f02\u8272\u8282\u70b9\u7684\u7236\u5b50\u8fb9\uff0c\u628a\u6807\u8bb0\u6253\u5728\u7236\u4eb2\u4e0a\u3002\n- \u90a3\u4e48\u627e\u5230\u4e00\u4e2a\u5757\u7684\u4fe1\u606f\u5c31\u662f\u5728 ETT \u4e0a\u76f4\u63a5 splay \u540e\u5f97\u5230\u7684\u4fe1\u606f\u3002\u5f02\u8272\u5757\u7684\u4fe1\u606f\u90fd\u88ab\u4e13\u95e8\u7ef4\u62a4\u7684\u5f02\u8272\u8fb9\u9694\u79bb\u5f00\u3002\u4e00\u4e2a ETT \u4e0a\u7684\u6839\u5c31\u662f\u4e00\u4e2a\u540c\u8272\u8fde\u901a\u5757\u7684\u6839\u3002\n- \u8003\u8651\u64cd\u4f5c\u4e00\uff0c\u5982\u679c\u5bf9\u5355\u70b9\u989c\u8272\u8fdb\u884c\u4fee\u6539\u3002\u90a3\u4e48\u6211\u4eec\u8003\u8651\u4fe1\u606f\u53d8\u66f4\u7684\u90e8\u5206\uff1a\n  - \u5b83\u4e0e\u7236\u4eb2\u7684\u5173\u7cfb\uff1a\u53ef\u80fd\u4ece\u7236\u4eb2\u7684 ETT \u4e2d\u88ab\u6316\u51fa\u6765\uff0c\u4e5f\u53ef\u80fd\u88ab\u653e\u5165\u7236\u4eb2\u7684 ETT \u4e2d\u3002\n  - \u5b83\u4e0e\u513f\u5b50\u7684\u5173\u7cfb\uff1a\u5f53\u524d ETT \u5b50\u6811\u533a\u95f4\u7684\u6240\u6709\u513f\u5b50\u90fd\u4f1a\u53d8\u6210\u5f02\u8272\u7684\uff0c\u540c\u65f6\u53ef\u80fd\u4f1a\u6709\u672c\u6765\u5f02\u8272\u7684\u513f\u5b50\u53d8\u4e3a\u540c\u8272\u7684\u3002\u56e0\u4e3a\u5728\u521a\u521a\u6211\u4eec\u5c06\u989c\u8272\u76f8\u540c\u4e14\u7236\u4eb2\u76f8\u540c\u7684\u513f\u5b50\u7684 ETT \u6536\u5c3e\u76f8\u63a5\uff0c\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u628a\u6574\u4e2a splay \u6302\u5728\u5f53\u524d\u7684\u70b9\u7684\u62ec\u53f7\u5e8f\u4e4b\u95f4\u3002\n- \u8003\u8651\u64cd\u4f5c\u4e8c\uff0c\u5bf9\u5757\u989c\u8272\u8fdb\u884c\u4fee\u6539\uff0c\u90a3\u4e48\u5c31\u662f\u6574\u4e2a ETT \u88ab\u5e26\u7740\u8dd1\u3002\u8003\u8651\u4fe1\u606f\u6539\u53d8\u90e8\u5206\u3002\n  - \u5b83\u7684\u5757\u6839\u4e0e\u7236\u4eb2\u7684\u5173\u7cfb\uff1a\u53ef\u80fd\u6574\u9897 ETT \u88ab\u653e\u5165\u5757\u6839\u7236\u4eb2\u7684\u62ec\u53f7\u5e8f\u4e4b\u95f4\uff0c\u6216\u8005\u4ec0\u4e48\u4e5f\u6ca1\u6709\u3002\n  - \u6574\u4e2a\u5757\u5411\u5916\u8fde\u51fa\u7684\u5f02\u8272\u8fb9\uff1a\u6709\u53ef\u80fd\u4fee\u6539\u7684\u76ee\u6807\u989c\u8272\u4f1a\u6d89\u53ca\u591a\u4e2a\u5f02\u8272\u8fb9\u3002\n- \u524d\u8005\u5f88\u597d\u7ef4\u62a4\uff0c\u540e\u8005\u6211\u4eec\u770b\u6240\u8c13\u7684\u201c\u5f02\u8272\u8fb9\u201d\u7684\u672c\u8d28\u3002\u5148\u628a\u201c\u5f02\u8272\u8fb9\u201d\u65b0\u5b9a\u4e49\u653e\u8fd9\uff1a\u6bcf\u4e2a\u8282\u70b9\u5411\u67d0\u4e2a\u5f02\u8272\u4eb2\u513f\u5b50\u70b9\u96c6\u7684\u8fde\u8fb9\u3002\uff08\u4e00\u4e2a\u96c6\u5408\u7b97\u4e00\u6761\uff09\n- \u56e0\u4e3a\u6211\u4eec\u5c06\u989c\u8272\u3001\u7236\u4eb2\u76f8\u540c\u7684\u5757\u6839\u7684 ETT \u76f8\u63a5\uff0c\u56e0\u6b64\u53ef\u4ee5\u76f4\u63a5\u96c6\u5408\u64cd\u4f5c\u3002\u5373\u5f02\u8272\u8fb9\u7684\u672c\u8d28\u5e94\u8be5\u662f\uff1a\u6bcf\u4e2a\u8282\u70b9\u7684\u4eb2\u513f\u5b50\u5f53\u4e2d\u4e0d\u540c\u4e8e\u5f53\u524d\u8282\u70b9\u989c\u8272\u7684\u79cd\u6570\uff0c\u5904\u4e8e $O(n)$\uff0c\u518d\u770b\u5f02\u8272\u8fb9\u7684\u53d8\u5316\uff0c\u6bcf\u6b21\u64cd\u4f5c\u4e00\u6700\u591a\u589e\u52a0 2 \u7684\u5f02\u8272\u8fb9\uff0c\u5206\u522b\u4e3a\u64cd\u4f5c\u8282\u70b9\u7684\u7236\u4eb2\u4e0e\u64cd\u4f5c\u8282\u70b9\u5f53\u524d\u540c\u8272\u7684\u513f\u5b50\u3002\u64cd\u4f5c\u4e8c\u4f1a\u904d\u5386\u4e00\u9897 ETT \u6765\u627e\u5230\u5c06\u5220\u9664\u7684\u5f02\u8272\u8fb9\uff0c\u56e0\u4e3a\u7528\u4e86\u5e73\u8861\u6811\u4f5c\u4e3a\u7ef4\u62a4 ETT \u7684\u4e1c\u897f\uff0c\u6240\u4ee5\u627e\u5230\u4e00\u4e2a\u8282\u70b9\u7684\u590d\u6742\u5ea6\u662f\u5747\u644a $O(\\log n)$ \u7684\uff0c\u6bcf\u4e2a\u8282\u70b9\u5bf9\u4e8e\u4e00\u79cd\u989c\u8272\u6700\u591a\u53ea\u6709\u4e00\u6761\u5f02\u8272\u8fb9\u3002\u6240\u4ee5\u590d\u6742\u5ea6\u662f\u5747\u644a $O(\\log n)$ \u51cf\u5c11\u4e00\u6761\u201c\u5f02\u8272\u8fb9\u201d\u3002\u5168\u5c40\u5747\u644a\u590d\u6742\u5ea6\u662f\u5b8c\u5168\u80fd\u591f\u63a5\u53d7\u7684\u3002\n\n```\n//ayame\u4fdd\u4f51\uff0c\u5938\u54e5\u4fdd\u4f51\uff0c\u72d7\u5988\u4fdd\u4f51\uff0cMDR\u4fdd\u4f51\uff0c\u9509\u5200\u602a\u4fdd\u4f51\uff0cM99\u4fdd\u4f51\uff0c\u514b\u7239\u4fdd\u4f51\n#include<bits/stdc++.h>\nusing namespace std;\nint p1=1000000,p2=0;\nchar buf[1000005],wb[1000005];\nint gc() {\n\tif(p1>=1000000)fread(buf,1,1000000,stdin),p1=0;\n\treturn buf[p1++];\n}\n#define gc getchar\n#define Loli true\n#define Kon xor true\nlong long getint() {\n\tlong long ret=0,flag=1;\n\tchar c=gc();\n\twhile(c<'0'||c>'9') {\n\t\tif(c=='-')flag=-1;\n\t\tc=gc();\n\t}\n\twhile(c<='9'&&c>='0') {\n\t\tret=(ret<<3)+(ret<<1)+c-'0';\n\t\tc=gc();\n\t}\n\treturn ret*flag;\n}\nvoid pc(char x) {\n\tif(p2>=1000000)fwrite(wb,1,1000000,stdout),p2=0;\n\twb[p2++]=x;\n}\nvoid wrt(long long x) {\n\tif(x<0)pc('-'),x=-x;\n\tint c[24]= {0};\n\tif(!x)return pc('0'),void();\n\twhile(x)c[++c[0]]=x%10,x/=10;\n\twhile(c[0])pc(c[c[0]--]+'0');\n}\nint n,m,a[100005];\nint fa[100005],dep[100005];\nint o[100005][31],prt[20][100005];\nnamespace ETT {\n\tstruct node {\n\t\tint ch[2],fa,pre,suf;\n\t\tint vl,sz,dep,mx,mi,etag,stag;\n\t\tint col,ctag;\n\t} v[200005];\n\tvoid push_down(int rt) {\n\t\tif(v[rt].ctag) {\n\t\t\tif(v[rt].ch[0])v[v[rt].ch[0]].ctag=v[v[rt].ch[0]].col=v[rt].ctag;\n\t\t\tif(v[rt].ch[1])v[v[rt].ch[1]].ctag=v[v[rt].ch[1]].col=v[rt].ctag;\n\t\t\tv[rt].ctag=0;\n\t\t}\n\t}\n\tvoid push_up(int rt) {\n\t\tv[rt].pre=v[rt].suf=rt;\n\t\tv[rt].mx=v[rt].mi=v[rt].dep;\n\t\tif(v[rt].ch[0])v[rt].pre=v[v[rt].ch[0]].pre,v[rt].mx=max(v[rt].mx,v[v[rt].ch[0]].mx),v[rt].mi=min(v[rt].mi,v[v[rt].ch[0]].mi);\n\t\tif(v[rt].ch[1])v[rt].suf=v[v[rt].ch[1]].suf,v[rt].mx=max(v[rt].mx,v[v[rt].ch[1]].mx),v[rt].mi=min(v[rt].mi,v[v[rt].ch[1]].mi);\n\t\tv[rt].stag=v[rt].etag|v[v[rt].ch[0]].stag|v[v[rt].ch[1]].stag;\n\t\tv[rt].sz=v[v[rt].ch[0]].sz+v[rt].vl+v[v[rt].ch[1]].sz;\n\t}\n\tvoid rot(int x) {\n\t\tint p=v[x].fa,g=v[p].fa;\n\t\tbool d=v[p].ch[1]==x;\n\t\tif(g)v[g].ch[v[g].ch[1]==p]=x;\n\t\tv[p].ch[d]=v[x].ch[d^1];\n\t\tv[v[x].ch[d^1]].fa=p;\n\t\tv[x].ch[d^1]=p;\n\t\tv[x].fa=g,v[p].fa=x;\n\t\tpush_up(p),push_up(x);\n\t}\n\tvoid pre_push_down(int rt) {\n\t\tif(v[rt].fa)pre_push_down(v[rt].fa);\n\t\tpush_down(rt);\n\t}\n\tvoid splay(int x,int f=0) {\n\t\tif(!x)return;\n\t\tpre_push_down(x);\n\t\twhile(v[x].fa!=f) {\n\t\t\tint p=v[x].fa,g=v[p].fa;\n\t\t\tif(g!=f)rot(v[g].ch[0]==p^v[p].ch[0]==x?x:p);\n\t\t\trot(x);\n\t\t}\n\t}\n\tvoid init() {\n\t\tfor(int i=1; i<=n; i++) {\n\t\t\tv[i<<1].vl=1,v[i<<1].ch[1]=i<<1|1,v[i<<1|1].fa=i<<1,v[i<<1].col=a[i];\n\t\t\tv[i<<1].dep=v[i<<1|1].dep=dep[i],push_up(i<<1|1),push_up(i<<1);\n\t\t}\n\t}\n\tint merge_bro(int x,int y) {\n\t\tif(!x||!y)return x|y;\n\t\tsplay(x),splay(y);\n\t\tint d=v[x].suf;\n\t\tsplay(d),v[d].ch[1]=y,v[y].fa=d,push_up(d);\n\t\treturn x;\n\t}\n\tvoid merge_prt(int x,int y) {\n\t\tsplay(x<<1),splay(v[v[x<<1].ch[1]].pre,x<<1),splay(y);\n\t\tv[v[x<<1].ch[1]].ch[0]=y,v[y].fa=v[x<<1].ch[1],push_up(v[x<<1].ch[1]),push_up(x<<1);\n\t}\n\tint ask(int x) {\n\t\tif(x==0)return x;\n\t\treturn splay(x),v[x].pre;\n\t}\n\tvoid dfs(int x,int c,vector<int>&vec) {\n\t\tpush_down(x);\n\t\tif(v[x].etag>>c&1)vec.push_back(x>>1),v[x].etag^=1<<c;\n\t\tif(v[v[x].ch[0]].stag>>c&1)dfs(v[x].ch[0],c,vec);\n\t\tif(v[v[x].ch[1]].stag>>c&1)dfs(v[x].ch[1],c,vec);\n\t\tpush_up(x);\n\t}\n}\nvoid ask(int x) {\n\tint p=x;\n\tfor(int i=19; i>=0; i--)if(ETT::ask(p<<1)==ETT::ask(prt[i][p]<<1))p=prt[i][p];\n\tETT::splay(p<<1),ETT::splay(p<<1|1,p<<1);\n\tint sz=ETT::v[ETT::v[p<<1|1].ch[0]].sz+1,len=max(ETT::v[ETT::v[p<<1|1].ch[0]].mx-dep[p],0)+1;\n\twrt(ETT::v[p<<1].col),pc(' '),wrt(sz),pc(' '),wrt(len),pc('\\n');\n}\nvoid paint_point(int x,int gc) {\n\tint p=x;\n\tfor(int i=19; i>=0; i--)if(ETT::ask(p<<1)==ETT::ask(prt[i][p]<<1))p=prt[i][p];\n\tETT::splay(x<<1),ETT::splay(x<<1|1,x<<1);\n\tint l=ETT::v[x<<1].ch[0],r=ETT::v[x<<1|1].ch[1],col=ETT::v[x<<1].col;\n\tETT::v[l].fa=0,ETT::v[r].fa=0,ETT::v[x<<1].ch[0]=0,ETT::v[x<<1|1].ch[1]=0;\n\tETT::push_up(x<<1|1),ETT::push_up(x<<1);\n\n\tif(fa[x]) {\n\t\tint tmp=ETT::merge_bro(l,r);\n\t\to[fa[p]][col]=tmp;\n\t\tETT::splay(fa[p]<<1);\n\t\tif(!o[fa[p]][col])ETT::v[fa[p]<<1].etag^=1<<col;\n\t\tETT::push_up(fa[p]<<1);\n\t} else ETT::merge_bro(l,r);\n\n\tif(ETT::v[x<<1|1].ch[0]) {\n\t\tint d=ETT::v[x<<1|1].ch[0];\n\t\tETT::v[d].fa=0,ETT::v[x<<1|1].ch[0]=0;\n\t\tETT::push_up(x<<1|1),ETT::push_up(x<<1);\n\t\to[x][col]=d,ETT::v[x<<1].etag|=1<<col,ETT::push_up(x<<1);\n\t}\n\n\tETT::v[x<<1].col=ETT::v[x<<1|1].col=gc;\n\n\tif(o[x][gc]) {\n\t\tint d=o[x][gc];\n\t\to[x][gc]=0,ETT::splay(d),ETT::v[x<<1|1].ch[0]=d,ETT::v[d].fa=x<<1|1;\n\t\tETT::v[x<<1].etag^=1<<gc,ETT::push_up(x<<1|1),ETT::push_up(x<<1);\n\t}\n\n\tif(fa[x]) {\n\t\tETT::splay(fa[x]<<1);\n\t\tif(gc!=ETT::v[fa[x]<<1].col) {\n\t\t\to[fa[x]][gc]=ETT::merge_bro(o[fa[x]][gc],x<<1);\n\t\t\tETT::splay(fa[x]<<1);\n\t\t\tETT::v[fa[x]<<1].etag|=1<<gc;\n\t\t\tETT::push_up(fa[x]<<1);\n\t\t} else ETT::merge_prt(fa[x],x<<1);\n\t}\n}\nvoid paint_block(int x,int gc) {\n\tfor(int i=19; i>=0; i--)if(ETT::ask(x<<1)==ETT::ask(prt[i][x]<<1))x=prt[i][x];\n\tETT::splay(x<<1),ETT::splay(x<<1|1,x<<1);\n\tint l=ETT::v[x<<1].ch[0],r=ETT::v[x<<1|1].ch[1],col=ETT::v[x<<1].col;\n\tETT::v[l].fa=0,ETT::v[r].fa=0,ETT::v[x<<1].ch[0]=0,ETT::v[x<<1|1].ch[1]=0;\n\tETT::push_up(x<<1|1),ETT::push_up(x<<1);\n\n\tif(fa[x]) {\n\t\to[fa[x]][col]=ETT::merge_bro(l,r);\n\t\tETT::splay(fa[x]<<1);\n\t\tif(!o[fa[x]][col])ETT::v[fa[x]<<1].etag^=1<<col;\n\t\tETT::push_up(fa[x]<<1);\n\t} else ETT::merge_bro(l,r);\n\n\tETT::v[x<<1].col=ETT::v[x<<1].ctag=gc;\n\n\tvector<int> vec;\n\tETT::dfs(x<<1,gc,vec);\n\tfor(int w:vec)ETT::merge_prt(w,o[w][gc]),o[w][gc]=0;\n\n\tif(fa[x]) {\n\t\tETT::splay(fa[x]<<1);\n\t\tif(gc!=ETT::v[fa[x]<<1].col) {\n\t\t\to[fa[x]][gc]=ETT::merge_bro(o[fa[x]][gc],x<<1);\n\t\t\tETT::splay(fa[x]<<1);\n\t\t\tETT::v[fa[x]<<1].etag|=1<<gc;\n\t\t\tETT::push_up(fa[x]<<1);\n\t\t} else ETT::merge_prt(fa[x],x<<1);\n\t}\n}\nint main() {\n\tn=getint();\n\tfor(int i=1; i<=n; i++)prt[0][i]=fa[i]=getint(),dep[i]=dep[fa[i]]+1;\n\tfor(int j=1; j<20; j++)\n\t\tfor(int i=1; i<=n; i++)prt[j][i]=prt[j-1][prt[j-1][i]];\n\tfor(int i=1; i<=n; i++)a[i]=getint();\n\tETT::init(),m=getint();\n\tfor(int i=n; i>=2; i--) {\n\t\tif(a[fa[i]]==a[i])ETT::merge_prt(fa[i],i<<1);\n\t\telse o[fa[i]][a[i]]=ETT::merge_bro(o[fa[i]][a[i]],i<<1),ETT::splay(fa[i]<<1),ETT::v[fa[i]<<1].etag|=1<<a[i],ETT::push_up(fa[i]<<1);\n\t}\n\tfor(int i=1; i<=m; i++) {\n\t\tint opt=getint();\n\t\tif(opt==1) {\n\t\t\tint x=getint(),c=getint();\n\t\t\tpaint_point(x,c);\n\t\t}\n\t\tif(opt==2) {\n\t\t\tint x=getint(),c=getint();\n\t\t\tpaint_block(x,c);\n\t\t}\n\t\tif(opt==3)ask(getint());\n\t}\n\tfwrite(wb,1,p2,stdout);\n\treturn Loli Kon;\n}\n```",
        "postTime": 1625820024,
        "uid": 27338,
        "name": "jerry3128",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P5529 \u3010[Ynoi2012] \u68a6\u65ad SCOI2017\u3011"
    },
    {
        "content": "\u9898\u610f\n\n\u73b0\u5728\u6709\u4e00\u68f5\u6811\uff0c\u603b\u5171\u6709 $c$ \u79cd\u989c\u8272$(c\\le30)$\uff0c\u4f60\u9700\u8981\u652f\u6301\u4ee5\u4e0b\u64cd\u4f5c\n\n1.\u4fee\u6539\u67d0\u4e2a\u70b9\u7684\u989c\u8272\n\n2.\u4fee\u6539\u67d0\u4e2a\u70b9\u6240\u5728\u8fde\u901a\u5757\u6240\u6709\u70b9\u7684\u989c\u8272\n\n3.\u67e5\u8be2\u67d0\u4e2a\u70b9\u7684\u989c\u8272\uff0c\u6240\u5728\u8fde\u901a\u5757\u5927\u5c0f\uff0c\u6240\u5728\u8fde\u901a\u5757\u7684\u6240\u6709\u70b9\u6df1\u5ea6\u5dee\u7684\u6700\u5927\u503c\n\n\u505a\u6cd5\u8ddf jerry3128 \u7684\u4e00\u6837\uff0c\u5c31\u662f\u7528 splay \u7ef4\u62a4\u62ec\u53f7\u5e8f\uff0c\u4f46\u662f\u4ed6\u662f DS \u5e26\u5e08\u800c\u6211\u4e0d\u662f\uff0c\u6240\u4ee5\u6211\u4f1a\u5728\u4ed6\u7684\u57fa\u7840\u4e0a\u8bf4\u4e00\u4e9b\u5b9e\u73b0\u7684\u5c0f\u7ec6\u8282\n\n\u6211\u4eec\u5c06\u76f8\u90bb\u7684\u6216\u8005\u4e92\u4e3a\u5144\u5f1f\u7684\u540c\u8272\u70b9\u7528 splay \u4e32\u5728\u4e00\u8d77\u3002\u5982\u679c\u4e24\u4e2a\u540c\u8272\u70b9\u6709\u7236\u5b50\u5173\u7cfb\uff0c\u5c31\u628a\u513f\u5b50\u7684\u62ec\u53f7\u653e\u5230\u7236\u4eb2\u7684\u62ec\u53f7\u91cc\u9762\uff0c\u4e3a\u4e86\u65b9\u4fbf\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u513f\u5b50\u7684\u62ec\u53f7\u653e\u5230\u6700\u9760\u8fd1\u7236\u4eb2\u7684\u53f3\u62ec\u53f7\u7684\u4f4d\u7f6e\uff1b\u5982\u679c\u662f\u5144\u5f1f\u5173\u7cfb\uff0c\u5c31\u8ba9\u4e00\u4e2a\u7684\u5de6\u62ec\u53f7\u8fde\u5728\u53e6\u4e00\u4e2a\u7684\u53f3\u62ec\u53f7\u540e\u9762\n\n\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u8282\u70b9 $x$\uff0c\u6211\u4eec\u7ef4\u62a4\u4e00\u4e2a\u5927\u5c0f\u4e3a $30$ \u7684 $nxt$ \u6570\u7ec4\uff0c\u8868\u793a\u4e0e\u5b83\u989c\u8272\u4e0d\u540c\u7684\u67d0\u79cd\u989c\u8272\u7684\u513f\u5b50\u7684\u4e00\u4e2a\u4ee3\u8868\n\n\u5bf9\u4e8e $1$ \u64cd\u4f5c\uff0c\u5047\u8bbe $x$ \u7684\u989c\u8272\u4ece $lc$ \u6539\u5230 $c$\uff0c\u5e76\u4e14 $lc$ \u4e0e $c$ \u4e0d\u540c\uff0c\u6211\u4eec\u5148\u8003\u8651 $x$ \u4e0e\u5b83\u7684\u7236\u4eb2 $fa$ \u7684\u76f8\u5bf9\u5173\u7cfb\n\n\u5982\u679c $col_{fa}=lc$\uff0c\u90a3\u4e48\u6211\u4eec\u9700\u8981\u628a $x$ \u4ece $fa$ \u7684\u62ec\u53f7\u4e2d\u79fb\u9664\n\n\u5982\u679c $col_{fa}=c$\uff0c\u90a3\u4e48\u6211\u4eec\u9700\u8981\u628a $x$ \u52a0\u5165\u5230 $fa$ \u7684\u62ec\u53f7\u4e2d\n\n\u7136\u540e\u8fd9\u4e00\u90e8\u5206\u957f\u6210\u8fd9\u6837\n\n```cpp\n\tint p=find(x);\n\tS.splay(l[x]),S.splay(r[x],l[x]),S.pushdown(l[x]),S.pushdown(r[x]);\n\tif(c==S.col[l[x]]) return ;\n\tint L=S.ch[l[x]][0],R=S.ch[r[x]][1],lc=S.col[l[x]];\n\tS.f[L]=S.f[R]=0,S.ch[l[x]][0]=S.ch[r[x]][1]=0,S.pushup(r[x]),S.pushup(l[x]);\n\tS.add(L,R),S.splay(l[x]);\n\tint fa=pa[x];\n\tS.splay(l[fa]);\n\tint an=pa[p];\n\tif(fa) {\n\t\tS.splay(l[an]);\n\t\tif(S.col[l[an]]!=lc) {\n\t\t\tif(L) nxt[an][lc]=L;\n\t\t\telse if(R) nxt[an][lc]=R;\n\t\t\telse nxt[an][lc]=0,S.splay(l[an]),S.ctag[l[an]]&=(A^(1<<lc));\n\t\t}\n\t}\n......\n\tif(fa) {\n\t\tS.splay(l[fa]);\n\t\tif(nxt[fa][c]) S.add(nxt[fa][c],l[x]);\n\t\telse nxt[fa][c]=l[x],S.splay(l[fa]),S.splay(r[fa],l[fa]),S.ctag[l[fa]]|=1<<c;\n\t\tif(S.col[l[fa]]==c) S.ctag[l[fa]]&=(A^(1<<c)),nxt[fa][c]=0,S.merge(r[fa],l[x]);\n\t}\n```\n\n\u8fd9\u91cc\u7684 $find$ \u8868\u793a\u627e\u5230\u4e0e $x$ \u989c\u8272\u76f8\u540c\u7684\u6df1\u5ea6\u6700\u5c0f\u7684\u8282\u70b9\n\n\u6ce8\u610f\u8fd9\u4e2a $find$ \u4e00\u5b9a\u8981\u500d\u589e\u7136\u540e\u5224\u65ad\uff0c\u4e0d\u80fd\u76f4\u63a5 $splay(l_x)$ \u7136\u540e\u628a $pre_{l_x}$ \u5bf9\u5e94\u7684\u70b9\u5f53\u4f5c\u7b54\u6848\uff0c\u56e0\u4e3a\u6240\u6709\u540c\u8272\u5144\u5f1f\u662f\u4e32\u5728\u4e00\u8d77\u7684\n\n\u524d\u4e00\u90e8\u5206\u662f\u65ad\u8fb9\uff0c\u540e\u4e00\u90e8\u5206\u662f\u52a0\u8fb9\uff0c\u6ce8\u610f\u540c\u65f6\u7ef4\u62a4\u4e00\u4e0b $nxt$\uff0c\u8c28\u8bb0\u540c\u8272\u513f\u5b50\u4e0d\u8bb0 $nxt$\n\n\u90a3\u4e48\u4f60\u53d1\u73b0\u6211\u4eec\u8fd9\u91cc\u524d\u4e00\u90e8\u5206\u4fee\u6539\u7684\u662f $nxt_{an}$ \u800c\u4e0d\u662f $nxt_{fa}$\n\n\u539f\u56e0\u662f\u8fd9\u6837\u7684\n\n\u5047\u8bbe\u6211\u4eec\u73b0\u5728\u662f\u7b2c\u4e00\u6b21\u4fee\u6539\uff0c\u90a3\u4e48\u8fd9\u4e2a $an$ \u80af\u5b9a\u5c31\u662f $fa$ \uff0c\u8fd9\u4e2a $L$ \u7684\u6700\u53f3\u7aef\u70b9\u80af\u5b9a\u5c31\u662f $fa$ \u7684\u67d0\u4e2a\u513f\u5b50\uff0c$R$ \u7684\u6700\u5de6\u7aef\u70b9\u4e5f\u80af\u5b9a\u662f $fa$ \u7684\u67d0\u4e2a\u513f\u5b50\uff0c\u4f46\u662f $L,R$ \u5c31\u4e0d\u4e00\u5b9a\u662f\u4e86\uff0c\u6240\u4ee5\u6309\u7167\u6211\u8fd9\u79cd\u5199\u6cd5\uff0c$nxt$ \u53ef\u80fd\u4f1a\u53d8\u5230\u5b83\u5b50\u6811\u4e2d\u67d0\u4e2a\u4e0e\u5b83\u4e0d\u76f4\u63a5\u76f8\u8fde\u7684\u8282\u70b9\u4e0a\u53bb\n\n\u89e3\u51b3\u65b9\u6848\u5c31\u662f\u6539\u8fd9\u4e2a $an$ \u7684 $nxt$\u3002\n\n\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u5c06 $L$ \u4e2d\u6700\u53f3\u4fa7\u7684\u70b9\u65cb\u5230\u6839\uff0c$R$ \u4e2d\u6700\u5de6\u4fa7\u70b9\u65cb\u5230\u6839\uff0c\u7136\u540e\u5c31\u4e0d\u7528\u53bb\u6539\u8fd9\u4e2a $an$\uff0c\u76f4\u63a5\u6539 $fa$ \u5c31\u884c\u4e86\n\n\u7136\u540e\u8003\u8651\u5bf9\u4e8e $x$ \u513f\u5b50\u7684\u76f8\u5bf9\u5173\u7cfb\u7684\u6539\u53d8\n\n\u9996\u5148\u539f\u6765\u5728 $x$ \u62ec\u53f7\u5185\u90e8\u7684\u70b9\u5168\u90fd\u4f1a\u88ab\u79fb\u9664\uff0c\u7136\u540e $nxt_{x,c}$ \u7684\u62ec\u53f7\u4f1a\u88ab\u653e\u5230 $x$ \u5185\u90e8\uff0c\u540c\u65f6\u6ce8\u610f\u4e00\u4e0b\u4fee\u6539 $nxt$\n\n```cpp\n\tif((p=S.ch[r[x]][0]))\n\t\tnxt[x][lc]=p,S.ctag[l[x]]|=1<<lc,S.f[p]=0,S.ch[r[x]][0]=0,S.pushup(r[x]),S.pushup(l[x]);\n\tS.col[l[x]]=S.col[r[x]]=c;\n\tif(nxt[x][c])\n\t\tS.ctag[l[x]]&=(A^(1<<c)),S.merge(r[x],nxt[x][c]),nxt[x][c]=0;\n```\n\n\u4f60\u4f1a\u53d1\u73b0\u6211\u4eec\u8fd9\u91cc\u7ef4\u62a4\u4e86\u4e00\u4e2a $ctag$\uff0c\u800c\u4e14\u8fd9\u4e2a $ctag$ \u53ea\u88ab\u6253\u5728\u4e86\u5de6\u62ec\u53f7\u4e0a\n\n$ctag$ \u7684\u542b\u4e49\u662f\u8fd9\u4e2a\u5de6\u62ec\u53f7\u5bf9\u5e94\u7684\u8282\u70b9\u7684\u5f02\u8272\u513f\u5b50\u5b58\u5728\u6027\uff0c\u56e0\u4e3a $c\\le30$ \u6240\u4ee5\u7528\u4e00\u4e2a $int$ \u538b\u4e00\u4e0b\u5c31\u884c\u4e86\uff0c\u4f5c\u7528\u6211\u4eec\u4f1a\u5728\u64cd\u4f5c $2$ \u4e2d\u63d0\u5230\n\n\u5982\u679c\u540c\u65f6\u6253\u5728\u53f3\u62ec\u53f7\u4e0a\u540e\u7eed\u4f1a\u88ab\u7edf\u8ba1\u591a\u6b21\uff0c\u6240\u4ee5\u53ea\u8bb0\u5728\u5de6\u62ec\u53f7\u4e0a\n\n\u5355\u70b9\u4fee\u6539\u5c31\u957f\u8fd9\u6837\n\n\u7136\u540e\u662f\u8fde\u901a\u5757\u67d3\u8272\uff0c\u8fd8\u662f\u5047\u8bbe\u989c\u8272\u4ece $lc$ \u53d8\u6210 $c$\n\n\u5bf9\u4e8e\u989c\u8272\u7684\u4fee\u6539\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5728 splay \u4e0a\u9762\u6253\u6807\u8bb0\uff0c\u7136\u540e\u8003\u8651 $nxt$ \u4ee5\u53ca\u62ec\u53f7\u4f4d\u7f6e\u7684\u53d8\u5316\n\n\u56e0\u4e3a\u662f\u8fde\u901a\u5757\u67d3\u8272\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u627e\u5230\u8fde\u901a\u5757\u5185\u6df1\u5ea6\u6700\u5c0f\u7684\u70b9\u6765\u64cd\u4f5c\n\n\u9996\u5148\u662f $x$ \u4e0e $fa$\uff0c\u8fd9\u4e2a\u6539\u53d8\u4e0e\u5355\u70b9\u4fee\u6539\u4e00\u6837\n\n\u7136\u540e\u662f\u5f02\u8272\u513f\u5b50\u7684\u4fee\u6539\u4e86\n\n\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u904d\u5386\u4e00\u904d $l_x$ \u6240\u5728\u7684 splay\uff0c\u628a\u5176\u4e2d $ctag_c=1$ \u7684\u70b9\u90fd\u62ff\u51fa\u6765\uff0c\u7136\u540e\u628a $ctag_c$ \u8d4b\u4e3a $0$\uff0c\u5f53\u7136\u904d\u5386\u7684\u65f6\u5019\u5bf9\u4e8e\u6bcf\u4e2a\u70b9\u6211\u4eec\u9700\u8981\u7ef4\u62a4\u4e00\u4e2a $stag$\uff0c\u8868\u793a\u8fd9\u4e2a\u70b9\u7684\u5b50\u6811\u4e2d\uff08\u662f splay \u6811\uff09$ctag$ \u8fdb\u884c\u6216\u64cd\u4f5c\u7684\u7ed3\u679c\uff0c\u5bf9\u8fd9\u4e2a\u904d\u5386\u8fdb\u884c\u526a\u679d\n\n```cpp\nvoid dfs(int x,int c) {\n\tpushdown(x);\n\tif(ctag[x]&(1<<c)) vec.push_back(op[x]),ctag[x]^=(1<<c);\n\tif(lc&&(stag[lc]&(1<<c))) dfs(lc,c);\n\tif(rc&&(stag[rc]&(1<<c))) dfs(rc,c);\n\tpushup(x);\n}\n```\n\u6ce8\u610f\u8fd9\u91cc\u4e00\u5b9a\u8981 $pushup$\uff0c\u4e0d\u7136\u4f1a $T$ \u6389\n\n\u7136\u540e\u8fd9\u4e2a\u590d\u6742\u5ea6\u5747\u644a\u4e0b\u6765\u662f\u5bf9\u7684\uff0c\u56e0\u4e3a\u6bcf\u6b21 $2$ \u64cd\u4f5c\u7528 $cnt_{ctag_c=1}\\log n$ \u7684\u590d\u6742\u5ea6\u9664\u6389\u4e86 $cnt_{ctag_c=1}$ \u6761\u5f02\u8272\u8fb9\uff0c\u4e5f\u5c31\u662f\u8bf4\u5728\u6ca1\u6709 $1$ \u64cd\u4f5c\u7684\u60c5\u51b5\u4e0b\uff0c$2$ \u64cd\u4f5c\u6b21\u6570\u5c31\u662f $O(n)$ \u7684\n\n\u7136\u540e\u6bcf\u6b21 $1$ \u64cd\u4f5c\uff0c\u6211\u4eec\u770b\u5230\u81f3\u591a\u53ea\u4f1a\u4f7f $fa$ \u4e0e $x$ \u5404\u589e\u52a0\u4e00\u6761\u5f02\u8272\u8fb9\uff0c\u90a3\u4e48\u6700\u591a\u4e5f\u53ea\u4f1a\u589e\u52a0 $O(n)$ \u6761\u5f02\u8272\u8fb9\uff0c\u6240\u4ee5 $2$ \u64cd\u4f5c\u5747\u644a\u4e0b\u6765\u4ecd\u7136\u6b63\u786e\n\n\u653e\u4e0b\u4ee3\u7801\uff0c\u4e0d\u592a\u597d\u5199\n\n\u5176\u4ed6\u7ec6\u8282\u90fd\u5728\u6ce8\u91ca\u91cc\u9762\u4e86\n\n```cpp\n#include<stdio.h>\n#include<string.h>\n#include<math.h>\n#include<vector>\n#include<algorithm>\nusing namespace std;\n\ninline int read() {\n\tint res=0,f=1;char ch;\n\twhile(ch=getchar(),ch<'0'||ch>'9') if(ch=='-') f=-1;\n\twhile(ch>='0'&&ch<='9') res=res*10+ch-'0',ch=getchar();\n\treturn res*f;\n}\n\nconst int N=2e5+5,A=(1u<<31)-1,INF=0x3f3f3f3f;\n\nstruct Edge {\n\tint next,to;\n}a[N];\n\nint head[N],sze;\n\ninline void add(int u,int v) {a[++sze].next=head[u],a[sze].to=v,head[u]=sze;}\n\nint l[N],r[N],pa[N],n,cnt,op[N];\nint dep[N],c[N];\n\ninline bool cmp(int a,int b) {return c[a]<c[b];}\n\nint nxt[N][31],f[N][21],ln[N];\n\nvector <int> vec;\n\nstruct Splay {\n\t#define lc ch[x][0]\n\t#define rc ch[x][1]\n\tint ch[N][2],f[N],sz[N],mx[N],mn[N],val[N];\n\tint ctag[N],stag[N],tag[N],col[N];\n\tint pre[N],suf[N];\n\tinline bool get(int x) {return ch[f[x]][1]==x;}\n\tinline void pushc(int x,int c) {tag[x]=c,col[x]=c;}\n\tinline void pushdown(int x) {\n\t\tif(tag[x]) {\n\t\t\tif(lc) pushc(lc,tag[x]);\n\t\t\tif(rc) pushc(rc,tag[x]);\n\t\t\ttag[x]=0;\n\t\t}\n\t}\n\tinline void pushup(int x) {\n\t\tsz[x]=sz[lc]+sz[rc]+1,pre[x]=suf[x]=x;\n\t\tif(lc) pre[x]=pre[lc];\n\t\tif(rc) suf[x]=suf[rc];\n\t\tmx[x]=max(max(mx[lc],mx[rc]),val[x]);\n\t\tmn[x]=min(min(mn[lc],mn[rc]),val[x]);\n\t\tstag[x]=stag[lc]|stag[rc]|ctag[x];\n\t}\n\tinline void rotate(int x) {\n\t\tint fa=f[x],grfa=f[fa],k=get(x),c=ch[x][!k];\n\t\tpushdown(grfa),pushdown(fa);\n\t\tif(grfa) ch[grfa][get(fa)]=x;ch[x][!k]=fa;ch[fa][k]=c;\n\t\tif(c) f[c]=fa;f[fa]=x;f[x]=grfa;\n\t\tpushup(fa),pushup(x);\n\t}\n\tinline void splay(int x,int to=0) {\n\t\twhile(f[x]!=to) {\n\t\t\tif(f[f[x]]!=to) rotate(get(x)!=get(f[x])?x:f[x]);\n\t\t\trotate(x);\n\t\t}\n\t}\n\tinline void insertl(int x,int y,int fa) {\n\t\tif(!x) ch[fa][0]=y,f[y]=fa,splay(y);\n\t\telse while(pushdown(x),x)\n\t\t\tif(rc) x=rc;\n\t\t\telse return rc=y,f[y]=x,splay(y);\n\t}\n\tinline void insertr(int x,int y,int fa) {\n\t\tif(!x) ch[fa][1]=y,f[y]=fa,splay(y);\n\t\telse while(pushdown(x),x)\n\t\t\tif(lc) x=lc;\n\t\t\telse return lc=y,f[lc]=x,splay(y); \n\t}\n\tinline void merge(int x,int y) {//\u628ay\u653e\u8fdbx\u5bf9\u5e94\u70b9\u62ec\u53f7\u5185\u90e8 \n\t\tif(!x||!y) return ;\n\t\tsplay(x),splay(y);\n\t\tinsertl(ch[x][0],y,x);\n\t}\n\tinline void add(int x,int y) {//\u628ay\u8fde\u5728x\u540e\u9762 \n\t\tif(!x||!y) return ;\n\t\tsplay(x);int p=suf[x];//suf\u4e0d\u80fd\u5c11 \n\t\tsplay(y),insertr(ch[p][1],y,p);\n\t}\n\tinline int asktop(int x) {return x?splay(x,0),pre[x]:0;}\n\tvoid dfs(int x,int c) {\n\t\tpushdown(x);\n\t\tif(ctag[x]&(1<<c)) vec.push_back(op[x]),ctag[x]^=(1<<c);\n\t\tif(lc&&(stag[lc]&(1<<c))) dfs(lc,c);\n\t\tif(rc&&(stag[rc]&(1<<c))) dfs(rc,c);\n\t\tpushup(x);\n\t}\n\tvoid print(int x) {\n\t\tpushdown(x);\n\t\tif(lc) print(lc);\n\t\tprintf(\"%d \",x);\n\t\tif(rc) print(rc);\n\t\tif(!f[x]) puts(\"\");\n\t}\n\t#undef lc\n\t#undef rc\n}S;\n\ninline int find(int x) {\n\tfor(int i=20 ; ~i ; --i) if(S.asktop(l[x])==S.asktop(l[f[x][i]])) x=f[x][i];\n\treturn x;\n}\n\nvoid dfs(int u) {\n\tl[u]=++cnt,S.val[l[u]]=dep[u],op[l[u]]=u;\n\tfor(int i=1 ; i<=ln[dep[u]] ; ++i)\n\t\tf[u][i]=f[f[u][i-1]][i-1];\n\tfor(int i=head[u],v ; i ; i=a[i].next)\n\t\tdep[v=a[i].to]=dep[u]+1,f[v][0]=u,dfs(v);\n\tr[u]=++cnt,S.val[r[u]]=dep[u],op[r[u]]=u;\n\tS.col[l[u]]=S.col[r[u]]=c[u],S.sz[l[u]]=S.sz[r[u]]=1;//\u6ce8\u610f\u8fd9\u91cc\u8981\u628a l[u]\u4e0e r[u]\u8fde\u63a5\u8d77\u6765 \n\tS.ch[l[u]][1]=r[u],S.f[r[u]]=l[u],S.pushup(r[u]),S.pushup(l[u]);\n\tstatic vector <int> vec;\n\tvector<int>().swap(vec);\n\tfor(int i=head[u] ; i ; i=a[i].next) vec.push_back(a[i].to);\n\tsort(vec.begin(),vec.end(),cmp);\n\tfor(unsigned i=0 ; i<vec.size() ; ++i)\n\t\tif(c[vec[i]]!=c[u]&&(i==0||c[vec[i-1]]!=c[vec[i]]))\n\t\t\tS.ctag[l[u]]|=1<<c[vec[i]];\n\tfor(unsigned i=0 ; i<vec.size() ; ++i)\n\t\tif(!nxt[u][c[vec[i]]]&&c[vec[i]]!=c[u]) nxt[u][c[vec[i]]]=l[vec[i]];\n\tfor(unsigned i=1 ; i<vec.size() ; ++i)\n\t\tif(c[vec[i-1]]==c[vec[i]]) S.add(r[vec[i-1]],l[vec[i]]);\n\tfor(unsigned i=0 ; i<vec.size() ; ++i)\n\t\tif(c[vec[i]]==c[u])\n\t\t\t{S.merge(r[u],l[vec[i]]);break ;}\n}\n\ninline void change(int x,int c) {\n\tint p=find(x);\n\tS.splay(l[x]),S.splay(r[x],l[x]),S.pushdown(l[x]),S.pushdown(r[x]);\n\tif(c==S.col[l[x]]) return ;//\u6ce8\u610f\u6bcf\u6b21\u8be2\u95ee\u67d0\u4e2a\u70b9\u7684\u989c\u8272\u4e4b\u524d\u4e00\u5b9a\u8981splay \n\tint L=S.ch[l[x]][0],R=S.ch[r[x]][1],lc=S.col[l[x]];\n\tS.f[L]=S.f[R]=0,S.ch[l[x]][0]=S.ch[r[x]][1]=0,S.pushup(r[x]),S.pushup(l[x]);\n\tS.add(L,R),S.splay(l[x]);//\u6ce8\u610f\u8fd9\u91cc\u662fadd\u4e0d\u662fmerge\uff0c\u5148\u524d\u56e0\u4e3a\u8fd9\u4e2a\u9519\u4e86\u8c03\u4e86\u597d\u4e45qwq \n\tint fa=pa[x];\n\tS.splay(l[fa]);\n\tint an=pa[p];\n\tif(fa) {\n\t\tS.splay(l[an]);\n\t\tif(S.col[l[an]]!=lc) {\n\t\t\tif(L) nxt[an][lc]=L;\n\t\t\telse if(R) nxt[an][lc]=R;\n\t\t\telse nxt[an][lc]=0,S.splay(l[an]),S.ctag[l[an]]&=(A^(1<<lc));\n\t\t}\n\t}\n\tif((p=S.ch[r[x]][0]))\n\t\tnxt[x][lc]=p,S.ctag[l[x]]|=1<<lc,S.f[p]=0,S.ch[r[x]][0]=0,S.pushup(r[x]),S.pushup(l[x]);\n\tS.col[l[x]]=S.col[r[x]]=c;\n\tif(nxt[x][c])\n\t\tS.ctag[l[x]]&=(A^(1<<c)),S.merge(r[x],nxt[x][c]),nxt[x][c]=0;\n\tif(fa) {\n\t\tS.splay(l[fa]);\n\t\tif(nxt[fa][c]) S.add(nxt[fa][c],l[x]);\n\t\telse nxt[fa][c]=l[x],S.splay(l[fa]),S.splay(r[fa],l[fa]),S.ctag[l[fa]]|=1<<c;\n\t\tif(S.col[l[fa]]==c) S.ctag[l[fa]]&=(A^(1<<c)),nxt[fa][c]=0,S.merge(r[fa],l[x]);\n\t}\n}\n\ninline void modify(int x,int c) {\n\tx=find(x);\n\tS.splay(l[x]),S.splay(r[x],l[x]),S.pushdown(l[x]),S.pushdown(r[x]);\n\tif(S.col[l[x]]==c) return ;\n\tint L=S.ch[l[x]][0],R=S.ch[r[x]][1],lc=S.col[l[x]];\n\tS.f[L]=S.f[R]=0,S.ch[l[x]][0]=S.ch[r[x]][1]=0,S.pushup(r[x]),S.pushup(l[x]);\n\tS.add(L,R),S.splay(l[x]);\n\tint fa=pa[x];\n\tS.splay(l[fa]);\n\tif(fa) {\n\t\tif(S.col[l[fa]]!=lc) {\n\t\t\tif(L) nxt[fa][lc]=L;\n\t\t\telse if(R) nxt[fa][lc]=R;\n\t\t\telse nxt[fa][lc]=0,S.splay(l[fa]),S.ctag[l[fa]]&=(A^(1<<lc));\n\t\t}\n\t}\n\tvector <int> ().swap(vec);\n\tS.splay(l[x]),S.dfs(l[x],c),S.pushc(l[x],c);\n\tfor(unsigned i=0 ; i<vec.size() ; ++i) {\n\t\tint y=vec[i];\n\t\tS.merge(r[y],nxt[y][c]);\n\t\tnxt[y][c]=0;\n\t}\n\tif(fa) {\n\t\tS.splay(l[fa]);\n\t\tif(nxt[fa][c]) S.add(nxt[fa][c],l[x]);\n\t\telse nxt[fa][c]=l[x],S.splay(l[fa]),S.splay(r[fa],l[fa]),S.ctag[l[fa]]|=1<<c;\n\t\tif(S.col[l[fa]]==c) S.ctag[l[fa]]&=(A^(1<<c)),nxt[fa][c]=0,S.merge(r[fa],l[x]);\n\t}\n}\n\ninline void query(int x) {\n\t//\u4e00\u5b9a\u4e0d\u80fd\u76f4\u63a5\u628al[x]\u8f6c\u5230\u6839\u7136\u540e\u8f93\u51fa\u7b54\u6848\n\t//\u56e0\u4e3a\u4e0e\u5b83\u5728splay\u4e0a\u76f8\u8fde\u7684\u70b9\u6709\u53ef\u80fd\u53ea\u662f\u989c\u8272\u4e0e\u5b83\u76f8\u540c\u7684\u5144\u5f1f\uff0c\u4f46\u662f\u5b83\u7684\u7236\u4eb2\u989c\u8272\u53ef\u80fd\u4e0e\u5b83\u4e0d\u540c \n\tint p=find(x);\n\tS.splay(l[p]),S.splay(r[p],l[p]);\n\tint a1=S.col[l[p]];\n\tint a2=S.sz[S.ch[r[p]][0]]/2+1;\n\tint a3=max(S.mx[S.ch[r[p]][0]],dep[p])-min(S.mn[S.ch[r[p]][0]],dep[p])+1;\n\tprintf(\"%d %d %d\\n\",a1,a2,a3);\n}\n\nint main() {\n\tn=read(),S.mx[0]=-INF,S.mn[0]=INF,ln[0]=-1;\n\tfor(int i=1 ; i<=n ; ++i) add(pa[i]=read(),i),ln[i]=ln[i>>1]+1;\n\tfor(int i=1 ; i<=n ; ++i) c[i]=read();\n\tdfs(1);\n\tint q=read();\n\twhile(q--) {\n\t\tint op=read(),x=read(),y;\n\t\tif(op==1) y=read(),change(x,y);\n\t\telse if(op==2) y=read(),modify(x,y);\n\t\telse if(op==3) query(x);\n\t}\n\treturn 0;\n}\n```\n\n\n\n\n",
        "postTime": 1631350059,
        "uid": 79075,
        "name": "mzgwty",
        "ccfLevel": 7,
        "title": "P5529 [Ynoi2012] \u68a6\u65ad SCOI2017 \u9898\u89e3"
    }
]