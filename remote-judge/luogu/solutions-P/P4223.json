[
    {
        "content": "\u76ee\u524d\u8fd9\u9898\u7684\u4e24\u7bc7\u9898\u89e3\u4e00\u7bc7\u8fc7\u4e8e\u7b80\u7565\uff08\u81f3\u5c11\u5bf9\u6211\u8fd9\u79cd\u83dc\u9e21\u6765\u8bf4\uff09\uff0c~~\u4e00\u7bc7\u6709\u4e00\u4e9b\u9519\u8bef~~\uff08\u662f\u6211\u5f53\u65f6\u592a\u83dc\u4e86\u770b\u4e0d\u61c2QAQ\uff09\uff0c\u6240\u4ee5\u5728\u81ea\u5df1\u6478\u7d22\u51fa\u8fd9\u9898\u7684\u505a\u6cd5\u540e\uff0c\u5728\u8fd9\u91cc\u5bf9\u7b2c\u4e8c\u7bc7\u9898\u89e3\u505a\u4e00\u4e9b\u8865\u5145\uff1a\n\n\u9996\u5148\uff0c\u671f\u671b\u6570\u4e58\u4ee5 $\\tbinom{n}{2}^k$ \u540e\uff0c\u53d8\u4e3a\u7edf\u8ba1\u6240\u6709\u65b9\u6848\u4e0b\u7684\u9006\u5e8f\u5bf9\u6570\u91cf\u7684\u8ba1\u6570\u95ee\u9898\u3002\n\n\u7136\u540e\uff0c\u6211\u4eec\u73b0\u5728\u6709\u4e00\u4e2a\u6392\u5217 $\\{x_i\\}$ \uff0c \u5bf9\u4e8e\u521d\u59cb\u72b6\u6001\u4e0b\u7684 $x_A$ \u548c $x_B$ \uff0c\u6211\u4eec\u5b9a\u4e49\u4e00\u4e2a\u6570\u5bf9 $(p,q)$ \u8868\u793a\u8fd9\u4e24\u4e2a\u6570\u6700\u7ec8\u7684\u4f4d\u7f6e\uff0c\u7531\u4e8e\u9664\u4e86 $A,B$ \u4e4b\u5916\u7684\u4efb\u610f\u4f4d\u7f6e\u5bf9\u4e8e $a_A,a_B$ \u90fd\u662f\u7b49\u4ef7\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u6240\u6709\u5176\u5b83\u4f4d\u7f6e\u4e3a $C$\uff0c\u4e8e\u662f\u6211\u4eec\u6700\u540e\u7684\u4f4d\u7f6e\u5bf9\u53ea\u6709 $7$ \u79cd\uff1a$(A,B),(B,A),(C,B),(B,C),(A,C),(C,A),(C,C)$ \u3002\n\n\u5c1d\u8bd5\u6784\u9020\u77e9\u9635\u5229\u7528\u77e9\u9635\u5feb\u901f\u5e42\u6c42\u51fa\u8f6c\u79fb $k$ \u6b21\u540e\u51fa\u73b0\u8fd9\u4e9b\u60c5\u51b5\u7684\u65b9\u6848\u6570\uff0c\u7531\u4e8e\u6784\u9020\u8f83\u4e3a\u663e\u7136\uff0c\u8fd9\u91cc\u4e0d\u8be6\u7ec6\u5c55\u5f00\uff0c\u5177\u4f53\u77e9\u9635\u5982\u4e0b\uff08\u7b2c $1$ \u5230 $7$ \u884c\u3001\u5217\u5206\u522b\u5bf9\u5e94 $(A,B),(B,A),(C,B),(B,C),(A,C),(C,A),(C,C)$ \u4e03\u4e2a\u72b6\u6001\uff09\uff1a\n\n$\n\\left|\n\\begin{matrix}\n\t\\tbinom{n-2}{2}&1&n-2&0&n-2&0&0\\\\\n\t1&\\tbinom{n-2}{2}&0&n-2&0&n-2&0\\\\\n\t1&0&\\tbinom{n-2}{2}+(n-3)&1&0&1&n-3\\\\\n\t0&1&1&\\tbinom{n-2}{2}+(n-3)&1&0&n-3\\\\\n   1&0&0&1&\\tbinom{n-2}{2}+(n-3)&1&n-3\\\\\n   0&1&1&0&1&\\tbinom{n-2}{2}+(n-3)&n-3\\\\\n   0&0&1&1&1&1&\\tbinom{n-2}{2}+2(n-4)+1\n\\end{matrix}\n\\right|\n$\n\n\u505a\u5b8c\u4e86\u77e9\u9635\u5feb\u901f\u5e42\u4e4b\u540e\uff0c\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\u4e86\u8fd9\u4e03\u79cd\u4f4d\u7f6e\u5bf9\u6240\u5bf9\u5e94\u7684\u65b9\u6848\u6570\uff0c\u63a5\u4e0b\u6765\u5c31\u662f\u7edf\u8ba1\u7b54\u6848\u7684~~\u6298\u78e8~~\u5feb\u4e50\u65f6\u95f4\uff1a\n\n\u8bbe\u4ee5\u4e0a\u4e03\u79cd\u4f4d\u7f6e\u5bf9\u7684\u65b9\u6848\u6570\u5206\u522b\u4e3a $p_0,p_1 \\dots p_6$\uff0c\u5e76\u4ee4 $a_B,fa_B,ga_B$ \u8868\u793a\u521d\u59cb\u72b6\u6001\u4e0b $B$ \u524d\u9762\u7684\u6570\u4e2d\uff0c\u6bd4 $x_B$ \u5c0f\u7684\u6570\u7684\u4e2a\u6570\uff0c\u6bd4 $x_B$ \u5c0f\u7684\u6570\uff08\u4f4d\u7f6e\u7528 $pos$ \u8868\u793a\uff09\u7684 $pos-1$ \u7684\u548c\u4ee5\u53ca\u6bd4 $x_B$ \u5c0f\u7684\u6570\u7684\u4f4d\u7f6e\u7684 $n-pos-1$ \u7684\u548c\u3002\u540c\u7406\u5904\u7406\u51fa\u5927\u4e8e $x_B$ \u610f\u4e49\u4e0b\u7684\u6570 $b_B,fb_B,fb_B$ \uff0c\u7136\u540e\u6211\u4eec\u679a\u4e3e\u6bcf\u4e00\u4e2a\u4f4d\u7f6e $B$ \uff0c\u5e76\u8003\u8651\u4e0e\u5b83\u914d\u5bf9\u7684\u4f4d\u7f6e\u5728\u5b83\u524d\u9762\u7684\u8d21\u732e\u548c\uff08\u5f0f\u5b50\u4e2d\u7701\u7565\u4e0b\u6807 $B$ \uff09\uff1a\n\n\n\u7ed3\u675f\u72b6\u6001\u4e3a $(A,B)$ \u7684\u8d21\u732e\uff08\u540e\u9762\u76f4\u63a5\u7701\u7565\u4e3a\u72b6\u6001\u4e86QAQ\uff09\uff1a$p_0 * b$\n\n\u89e3\u91ca\uff1a\u5bf9\u4e8e\u6240\u6709\u5927\u4e8e $x_B$ \u7684\u6570\uff0c\u5728\u8be5\u7ed3\u675f\u72b6\u6001\u4e0b\u90fd\u6709 $1$ \u7684\u8d21\u732e\u3002\n\n$(B,A)$ \uff1a$p_1 * a$ \n\n\u89e3\u91ca\uff1a\u5bf9\u4e8e\u6240\u6709\u5c0f\u4e8e $x_B$ \u7684\u6570\uff0c\u5728\u8be5\u7ed3\u675f\u72b6\u6001\u4e0b\u90fd\u6709 $1$ \u7684\u8d21\u732e\u3002\n\n$(C,B)$ \uff1a$p_2*(b\\frac{(B-2)}{n-2}+a\\frac{(n-B)}{n-2})$ \n\n\u89e3\u91ca\uff1a\u8be5\u7ed3\u675f\u72b6\u6001\u4e0b\uff0c\u5bf9\u4e8e\u5927\u4e8e $x_B$ \u7684\u6570\uff0c\u4e0d\u662f $x_B$ \u7684\u90a3\u4e00\u4e2a\u6570\u5171\u6709 $B-2$ \u4e2a\u4f4d\u7f6e\u4e0e $x_B$ \u6784\u6210\u9006\u5e8f\u5bf9\uff0c\u800c\u5bf9\u4e8e\u6240\u6709 $C$ \u7c7b\u4f4d\u7f6e\uff0c\u843d\u5728\u4e0a\u9762\u7684\u6982\u7387\u5e94\u8be5\u662f\u76f8\u7b49\u7684\uff08\u663e\u7136\uff09\uff0c\u4e8e\u662f\u8d21\u732e\u5373\u4e3a $p_2 * b\\frac{(B-2)}{n-2}$ \uff0c\u540c\u7406\u5206\u6790\u5c0f\u4e8e $x_B$ \u7684\u6570\u5373\u53ef\u3002\n\n$(B,C)$ \uff1a$p_3*(a\\frac{(B-2)}{n-2}+b\\frac{(n-B)}{n-2})$ \n\n\u89e3\u91ca\uff1a\u5bf9\u4e8e\u6240\u6709\u5c0f\u4e8e $x_B$ \u7684\u6570\uff0c $x_B$ \u90fd\u6709 $B-2$ \u4e2a\u4f4d\u7f6e\u4e0e\u5b83\u6784\u6210\u9006\u5e8f\u5bf9\uff0c\u4e8e\u662f\u5206\u6790\u4e0e\u4e0a\u9898\u7c7b\u4f3c\u3002\n\n$(A,C)$ \uff1a$p_4*(\\frac{gb}{n-2}+\\frac{fa}{n-2})$ \n\n\u89e3\u91ca\uff1a\u5bf9\u4e8e\u4e00\u4e2a\u4f4d\u7f6e\u4e3a $pos~(pos<B,x_{pos}<x_B)$ \u7684\u6570\uff0c\u5982\u679c\u9009\u62e9\u5b83\u4e0e $x_B$ \u914d\u5bf9\uff0c\u90a3\u4e48 $x_B$ \u5171\u6709 $pos-1$ \u4e2a\u4f4d\u7f6e\u4e0e\u5b83\u6784\u6210\u9006\u5e8f\u5bf9\uff0c\u7136\u540e\u7528\u7c7b\u4f3c\u4e8e\u60c5\u51b5 $3$ \u7684\u5206\u6790\uff0c\u603b\u8d21\u732e\u4e3a $\\displaystyle(\\sum_{x_{pos}<x_B,pos<B}\\frac{pos-1}{n-2})=\\frac{fa_B}{n-2}$ \uff0c\u540c\u7406\u5206\u6790\u5927\u4e8e $x_B$ \u7684\u6570\u5373\u53ef\u3002 \n\n$(C,A)$ \uff1a$p_5*(\\frac{fb}{n-2}+\\frac{ga}{n-2})$ \n\n\u89e3\u91ca\uff1a\u540c\u4e0a\u3002\n\n$(C,C)$ \uff1a\u8be5\u60c5\u51b5\u6700\u540e\u5355\u72ec\u7edf\u8ba1\u5373\u53ef\uff0c\u7b54\u6848\u4e3a $\\frac{p_6*\\tbinom{n}{2}}{2}$ \n\n\u7531\u4e8e $a,b,fa,fb,ga,gb$ \u53ef\u4ee5\u7528\u6811\u72b6\u6570\u7ec4 $O(n\\log n)$ \u5730\u6c42\u51fa\uff0c\u6240\u4ee5\u603b\u590d\u6742\u5ea6\u662f $O(n\\log n)$ \u7684\uff0c\u4f46\u6709\u4e9b\u5361\u5e38\uff0c\u6ce8\u610f $b,fb,gb$ \u53ef\u4ee5\u7528 $a,fa,ga$ \u63a8\u51fa\uff0c\u7136\u540e\u53ef\u4ee5\u51cf\u5c0f\u4e00\u534a\u5e38\u6570\uff0c\u5c31\u80fd\u901a\u8fc7\u672c\u9898\u4e86\u3002\n\n\u4ee3\u7801\uff1a\n```cpp\n#include<bits/stdc++.h>\n#define lb(x) (x&(-x))\n#define M(x) (now.dt[0][x])\nusing namespace std;\ntypedef long long ll;\nconst int mod=1e9+7,N=5e5+10;\nll inv2,n,k,nm[N],dt[2][N];\nll ans;\nstruct aa\n{\n\tll dt[10][10];\n\taa operator *(const aa &b)const\n\t{\n\t\taa res; memset(res.dt,0,sizeof(res.dt));\n\t\tfor(int i=0;i<7;i++)\n\t\t\tfor(int j=0;j<7;j++)\n\t\t\t\tfor(int li=0;li<7;li++) res.dt[i][j]=(res.dt[i][j]+dt[i][li]*b.dt[li][j])%mod;\n\t\treturn res;\n\t}\n}mt,now;\nint read()\n{\n\tint res=0,fl=0; char a=getchar();\n\twhile(a<'0'||a>'9') {if(a=='-') fl=1;a=getchar();}\n\twhile(a>='0'&&a<='9') res=res*10+a-'0',a=getchar();\n\treturn fl? -res:res;\n}\nll ksm(ll di,ll mi) {ll res=1; for(;mi;mi>>=1,di=di*di%mod) if(mi&1) res=res*di%mod; return res;}\nll c2(ll x) {return x*(x-1)/2%mod;}\nvoid add(ll fl,ll x,ll k) {for(;x<=n;x+=lb(x)) dt[fl][x]=(dt[fl][x]+k)%mod;}\nll query(ll fl,ll x) {ll res=0; for(;x;x-=lb(x)) res=(res+dt[fl][x])%mod; return res;}\nint main()\n{\n\tll i,j,ff=0,gg=0;\n\tn=read(),k=read(),inv2=ksm(2,mod-2);\n\tfor(i=1;i<=n;i++) nm[i]=read();\n\tmt=aa{{\n\t{c2(n-2),1,n-2,0,n-2,0,0},\n\t{1,c2(n-2),0,n-2,0,n-2,0},\n\t{1,0,(c2(n-2)+(n-3))%mod,1,0,1,n-3},\n\t{0,1,1,(c2(n-2)+(n-3))%mod,1,0,n-3},\n\t{1,0,0,1,(c2(n-2)+(n-3))%mod,1,n-3},\n\t{0,1,1,0,1,(c2(n-2)+(n-3))%mod,n-3},\n\t{0,0,1,1,1,1,(c2(n-2)+2*(n-4)+1)%mod}\n\t}},now.dt[0][0]=1;\n\tfor(;k;k>>=1,mt=mt*mt) if(k&1) now=now*mt;\n\tfor(i=1;i<=n;i++)\n\t{\n\t\tll a=query(0,nm[i]),b=i-1-a,fa=query(1,nm[i]),fb=(ff-fa+mod)%mod,ga=((n-2)*a-fa)%mod,gb=(gg-ga+mod)%mod;\n\t\tans=(ans+b*M(0)+a*M(1)+((b*(i-2)+a*(n-i))%mod*M(2)%mod+(a*(i-2)+b*(n-i))%mod*M(3)%mod+(gb+fa)*M(4)%mod+(ga+fb)*M(5)%mod)%mod*ksm(n-2,mod-2))%mod;\n\t\tadd(0,nm[i],1),add(1,nm[i],i-1),ff=(ff+i-1)%mod,gg=(gg+n-i-1)%mod;\n\t}\n\tcout<<(ans+c2(n)*inv2%mod*M(6))%mod;\n\treturn 0;\n}\n```\n",
        "postTime": 1600155615,
        "uid": 223768,
        "name": "Yukikaze_",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P4223 \u3010\u671f\u671b\u9006\u5e8f\u5bf9\u3011"
    },
    {
        "content": "\u8fd9\u662f\u6211\u5728$\\texttt{post-icpc.org}$\u4e0a\u770b\u5230\u7684$\\texttt{idea}$,\u53ea\u4e0d\u8fc7\u6765\u5ba3\u4f20\u4e00\u4e0b\u7f62\u4e86\u3002\u3002\u3002\n\n\u5148\u60f3\u66b4\u529b\uff0c$O(n^2)$\u8003\u8651\u6bcf\u4e00\u5bf9\u6570\u7684\u8d21\u732e\uff0c\u90a3\u4e48\u5bf9\u4e8e\u6bcf\u4e00\u5bf9\u6570\uff0c\u5e8f\u5217\u5b9e\u9645\u4e0a\u88ab\u5206\u6210\u4e863\u90e8\u5206:CCCCACCCBCCC\uff0cA,B\u662f\u8fd9\u4e24\u4e2a\u6570\uff0cC\u662f\u5176\u4ed6\u6570\u3002\u90a3\u4e48\u53ea\u9700\u8981\u8003\u8651A,B\u5728k\u6b21\u4ea4\u6362\u540e\u5230\u4e86\u54ea\u4e00\u90e8\u5206\u5373\u53ef\uff08\u56e0\u4e3aC\u90e8\u5206\u65e0\u8bba\u5728\u54ea\u90fd\u7b49\u4ef7\uff09\u8fd9\u6837\u4e00\u5171\u67097\u79cd\u60c5\u51b5\uff1a\u6700\u540e\u5728(A,B)(A,C)(B,A)(B,C)(C,A)(C,B)(C,C)\u3002\u77e9\u9635\u5feb\u901f\u5e42\u5373\u53ef\uff08\u77e9\u9635\u8981\u63a8\u4e00\u63a8\uff09\n\n$O(nlogn)$\u53ea\u9700\u8981\u6539\u6210\u6811\u72b6\u6570\u7ec4\u5c31\u884c\u4e86\n\n```cpp\n#include<bits/stdc++.h>\n#define mod 1000000007\n#define maxn 1001000\nusing namespace std;\nstruct matrix{\n    int a[7][7];\n    matrix(){memset(a,0,sizeof(a));}\n    matrix operator*(const matrix& ma)const{\n        matrix ret;\n        for(int i=0;i<7;++i)\n            for(int j=0;j<7;++j)\n                for(int k=0;k<7;++k)\n                    ret.a[i][j]=(ret.a[i][j]+1ll*a[i][k]*ma.a[k][j])%mod;\n        return ret;\n    }\n}A,B;\nint n,a[maxn],k,ans,tr[10][maxn];\nvoid add(int x,int A,int b,int C,int D,int E,int F,int G){\n    B.a[x][0]+=A,B.a[x][1]+=b,B.a[x][2]+=C,B.a[x][3]+=D;\n    B.a[x][4]+=E,B.a[x][5]+=F,B.a[x][6]+=G;\n}\nint qpow(int a,int b){\n    int ans=1,tmp=a;\n    for(;b;b>>=1,tmp=1ll*tmp*tmp%mod)\n        if(b&1)ans=1ll*ans*tmp%mod;\n    return ans;\n}\nvoid add(int tr[],int x,int a){for(;x<=n;x+=x&-x)tr[x]=(tr[x]+a)%mod;}\nint query(int tr[],int x){int ans=0;for(;x;x-=x&-x)ans=(ans+tr[x])%mod;return ans;}\nint main(){\n//\tfreopen(\"in.txt\",\"r\",stdin);\n    scanf(\"%d%d\",&n,&k);\n    for(int i=0;i<7;++i)A.a[i][i]=1;\n    for(int i=0;i<7;++i)B.a[i][i]=1ll*(n-2)*(n-3)/2%mod;\n    add(0,0,n-2,0,n-2,0,1,0);\n    add(1,1,n-3,1,0,n-3,0,1);\n    add(2,0,1,n-3,1,n-3,1,0);\n    add(3,1,0,1,n-3,n-3,0,1);\n    add(4,0,1,1,1,2*(n-4)+1,0,1);\n    add(5,1,0,n-2,0,0,0,n-2);\n    add(6,0,1,0,1,n-3,1,n-3);\n    int inv=qpow(n-2,mod-2),inv2=qpow(2,mod-2);\n    for(;k;k>>=1,B=B*B)\n        if(k&1)A=A*B;\n    for(int i=1;i<=n;++i)\n        scanf(\"%d\",&a[i]);\n//\tfor(int i=0;i<7;++i)printf(\"[%d]\",A.a[0][i]);puts(\"\");\n    long long sum1=0,sum2=0;\n    for(int i=1;i<=n;++i){\n        int x=query(tr[0],n+1-(a[i]+1)),_x=i-1-x,pans=0;\n        ans=(ans+1ll*x*A.a[0][0])%mod;\n        ans=(ans+1ll*_x*A.a[0][5])%mod;\n        int y=query(tr[1],n+1-(a[i]+1));//p>q:Y+Z\n        int z=query(tr[2],n+1-(a[i]+1));//p>q:X\n        int _y=sum1-y,_z=sum2-z;\n//\t\tprintf(\"[%d,%d,%d]\",y,_z,sum2);\n        pans=(pans+1ll*(y+_z)*A.a[0][1])%mod;\n        pans=(pans+1ll*(_y+z)*A.a[0][2])%mod;\n        pans=(pans+1ll*(1ll*(i-2)*x+1ll*(n-i)*_x)%mod*A.a[0][3])%mod;\n        pans=(pans+1ll*(1ll*(i-2)*_x+1ll*(n-i)*x)%mod*A.a[0][6])%mod;\n        sum1=(sum1+n-i-1)%mod;\n        sum2=(sum2+i-1)%mod;\n        add(tr[0],n+1-a[i],1);\n        add(tr[1],n+1-a[i],n-i-1);\n        add(tr[2],n+1-a[i],i-1);\n        ans=(ans+1ll*pans*inv)%mod;\n    }\n    ans=(ans+1ll*n*(n-1)/2%mod*A.a[0][4]%mod*inv2)%mod;\n    printf(\"%d\",(ans+mod)%mod);\n}\n```",
        "postTime": 1518439852,
        "uid": 11751,
        "name": "ComeIntoPower",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P4223 \u3010\u671f\u671b\u9006\u5e8f\u5bf9\u3011"
    },
    {
        "content": "# \u9898\u76ee\u5206\u6790\n\n\u795e\u4ed9\u9898\u3002\n\n\u6211\u4eec\u8003\u8651\u4e00\u4e0b\u4e00\u4e2a\u7279\u5b9a\u7684\u6570\u5bf9(A,B)\uff0c\u539f\u6765\u5728A\u4f4d\u7f6e\u548c\u5728B\u4f4d\u7f6e\u7684\u6570\u5728k\u6b21\u4ea4\u6362\u4e4b\u540e\uff0c\u4f1a\u5728\u54ea\u4e9b\u4f4d\u7f6e\u3002\u53ef\u4ee5\u53d1\u73b0\uff0c\u5982\u679c\u5b83\u4eec\u6ca1\u6709\u843d\u5728A\u4f4d\u7f6e\u548cB\u4f4d\u7f6e\uff0c\u843d\u5728\u5176\u4ed6\u4f4d\u7f6e\u7684\u6982\u7387\u662f\u4e00\u6837\u7684\uff0c\u90a3\u4e48\u6211\u4eec\u628a\u6240\u6709\u5176\u4ed6\u4f4d\u7f6e\u90fd\u8bb0\u505aC\u4f4d\u7f6e\u3002\n\n\u521d\u59cb\u72b6\u6001\u662f(A,B)\uff0c\u73b0\u5728\u6211\u4eec\u8981\u7b97\u51fa\u7ed3\u675f\u72b6\u6001\u5206\u522b\u662f(A,B),(A,C),(B,A),(B,C),(C,A),(C,B),(C,C)\u7684\u65b9\u6848\u6570\u3002\n\n\u8003\u8651\u77e9\u9635\u4e58\u6cd5\uff0c\u53ef\u4ee5\u6784\u9020\u8f6c\u79fb\u77e9\u9635\u8868\u793a\u4e00\u6b21\u4ea4\u6362\u64cd\u4f5c\u4e4b\u540e\u5230\u8fbe\u67d0\u4e2a\u72b6\u6001\u7684\u65b9\u6848\u6570\u3002\n\n\u884c\u4ee3\u8868\u8d77\u59cb\u72b6\u6001\u5217\u8868\u793a\u7ec8\u6b62\u72b6\u6001\uff0c\u4ece0\u53f7\u52306\u53f7\u72b6\u6001\u5206\u522b\u662f(A,B),(A,C),(B,A),(B,C),(C,A),(C,B),(C,C)\uff0c\u8f6c\u79fb\u77e9\u9635\u5e94\u8be5\u662f\uff1a\n\nQAQ\u6211\u4e0d\u4f1a\u5728\u6d1b\u8c37\u4e0a\u5199\u77e9\u9635\uff0c\u6240\u4ee5\u8bf7\u79fb\u6b65\uff1a[\u8fd9\u91cc](https://blog.csdn.net/litble/article/details/80876793)\n\n\u597d\u7684\uff0c\u73b0\u5728\u6211\u4eec\u679a\u4e3e\u5176\u4e2d\u7684B\uff0c\u5047\u8bbe\u5f53\u524dB\u4f4d\u7f6e\u7684\u6743\u503c\u4e3a$x$\uff0c\u7136\u540e\u8003\u8651A\u7684\u60c5\u51b5\u3002\u7528\u6811\u72b6\u6570\u7ec4\u7ef4\u62a4\u6bd4$x$\u5c0f\u7684\u6570\u7684\u4e2a\u6570$a$\uff0c\u6bd4$x$\u5c0f\u7684\u6240\u6709\u6570\u524d\u9762\u7684\u4f4d\u7f6e\u6570\u548c$fa$\uff0c\u6bd4$x$\u5c0f\u7684\u6240\u6709\u6570\u540e\u9762\uff08\u9664\u53bbB\u4f4d\u7f6e\u4ee5\u5916\uff09\u7684\u4f4d\u7f6e\u6570\u548c$ga$\u3002\u540c\u65f6\u7b97\u51fa\u5bf9\u5e94\u7684\u6bd4$x$\u5927\u7684\u6570\u7684\u8fd9\u4e9b\u76f8\u5173\u91cf$b$\uff0c$fb$\uff0c$gb$\u3002\n\n\u8bbe\u77e9\u9635\u7684$k$\u6b21\u5e42\u7684\u7b2c0\u884ci\u5217\u4e3a$t(i)$\uff0c\u90a3\u4e48\u6211\u5c31\u77e5\u9053\u4e86\u7edf\u8ba1\u7b54\u6848\u7684\u65b9\u6cd5\uff1a\n\n$(A,B):b*t(0)$\n\n$(A,C):(a*(n-B)+b*(B-2))*t(1)*\\frac{1}{n-2}$\n\n$(B,A):a*t(2)$\n\n$(B,C):(fb+ga)*t(3)*\\frac{1}{n-2}$\n\n$(C,A):(a*(B-2)+b*(n-B))*t(4)*\\frac{1}{n-2}$\n\n$(C,B):(gb+fa)*t(5)*\\frac{1}{n-2}$\n\n\u679a\u4e3e\u5b8c\u4e86B\u540e\uff0c\u518d\u7edf\u4e00\u7b97$(C,C)$\u7684\u8d21\u732e\u3002\n\n$(C,C):C_{n}^2*\\frac{1}{2}*t(6)$\n\n\u5443\uff0c\u7406\u89e3\u5c31\u4e0d\u5199\u4e86\uff0c\u4e0d\u7136\u4eca\u5929\u5c31\u5e9f\u4e86......\u53cd\u6b63\u89e3\u91ca\u4e00\u4e0b\u8981\u4e58\u4ee5$\\frac{1}{n-2}$\u7684\u539f\u56e0\uff0c\u662f\u62b5\u6d88\u6389\u77e9\u9635\u4e58\u6cd5\u91cc\u5df2\u7ecf\u8ba1\u7b97\u8fc7\u7684\u9009\u4f4d\u7f6e\u7684\u5f71\u54cd\u3002\n\n# \u4ee3\u7801\n\n\u4f3c\u4e4e\u8fd8\u8981\u989d\u5916\u8003\u8651\u4e00\u4e0b$n$\u6bd4\u8f83\u5c0f\u7684\u60c5\u51b5\uff1f\u4f46\u662f\u53cd\u6b63\u8fc7\u4e86\u6211\u5c31\u61d2\u5f97\u7ba1\u4e86=\u3002=\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define RI register int\nint read() {\n\tint q=0;char ch=' ';\n\twhile(ch<'0'||ch>'9') ch=getchar();\n\twhile(ch>='0'&&ch<='9') q=q*10+ch-'0',ch=getchar();\n\treturn q;\n}\ntypedef long long LL;\nconst int mod=1000000007,N=500005;\nint n,K,inv,inv2,ans,w[N];LL tr[3][N];\nstruct matrix{int t[7][7];}re,X;\nint qm(int x) {return x>=mod?x-mod:x;}\nint ksm(int x,int y) {\n\tint re=1;\n\tfor(;y;y>>=1,x=1LL*x*x%mod) if(y&1) re=1LL*re*x%mod;\n\treturn re;\n}\nmatrix operator * (matrix a,matrix b) {\n\tmatrix c;\n\tfor(RI i=0;i<7;++i)\n\t\tfor(RI j=0;j<7;++j) {\n\t\t\tc.t[i][j]=0;\n\t\t\tfor(RI k=0;k<7;++k)\n\t\t\t\tc.t[i][j]=qm(c.t[i][j]+1LL*a.t[i][k]*b.t[k][j]%mod);\n\t\t}\n\treturn c;\n}\n\nvoid build() {//\u77e9\u9635\u4e58\u6cd5\n\tfor(RI i=0;i<7;++i) re.t[i][i]=1;\n\tfor(RI i=0;i<7;++i) X.t[i][i]=1LL*(n-2)*(n-3)%mod*inv2%mod;\n\tX.t[0][1]=n-2,X.t[0][2]=1,X.t[0][5]=n-2;\n\tX.t[1][0]=1,X.t[1][1]=qm(X.t[1][1]+n-3),X.t[1][3]=X.t[1][4]=1,X.t[1][6]=n-3;\n\tX.t[2][0]=1,X.t[2][3]=X.t[2][4]=n-2;\n\tX.t[3][1]=X.t[3][2]=1,X.t[3][3]=qm(X.t[3][3]+n-3),X.t[3][5]=1,X.t[3][6]=n-3;\n\tX.t[4][1]=X.t[4][2]=1,X.t[4][4]=qm(X.t[4][4]+n-3),X.t[4][5]=1,X.t[4][6]=n-3;\n\tX.t[5][0]=1,X.t[5][3]=X.t[5][4]=1,X.t[5][5]=qm(X.t[5][5]+n-3),X.t[5][6]=n-3;\n\tX.t[6][1]=X.t[6][3]=X.t[6][4]=X.t[6][5]=1,X.t[6][6]=(X.t[6][6]+n+n-7)%mod;\n\tfor(RI i=K;i;i>>=1,X=X*X) if(i&1) re=re*X;\n}\n\n#define lowbit(x) (x&(-x))\nvoid add(int o,int x,LL num) {\n\twhile(x<=n) tr[o][x]=qm(tr[o][x]+num),x+=lowbit(x);\n}\nLL query(int o,int x) {\n\tLL re=0;\n\twhile(x) re=qm(re+tr[o][x]),x-=lowbit(x);\n\treturn re;\n}\nint main()\n{\n\tn=read(),K=read();\n\tfor(RI i=1;i<=n;++i) w[i]=read();\n\tinv=ksm(n-2,mod-2),inv2=ksm(2,mod-2),build();\n\tLL sumf=0,sumg=0;\n\tfor(RI i=1;i<=n;++i) {\n\t\tLL a=query(0,w[i]),b=i-1-a;\n\t\tLL fa=query(1,w[i]),fb=sumf-fa;\n\t\tLL ga=query(2,w[i]),gb=sumg-ga;\n\t\tans=qm(ans+1LL*b*re.t[0][0]%mod);\n\t\tans=qm(ans+1LL*(a*(n-i)%mod+b*(i-2)%mod)%mod*re.t[0][1]%mod*inv%mod);\n\t\tans=qm(ans+1LL*a*re.t[0][2]%mod);\n\t\tans=qm(ans+1LL*(fb+ga)%mod*re.t[0][3]%mod*inv%mod);\n\t\tans=qm(ans+1LL*(a*(i-2)%mod+b*(n-i)%mod)%mod*re.t[0][4]%mod*inv%mod);\n\t\tans=qm(ans+1LL*(gb+fa)%mod*re.t[0][5]%mod*inv%mod);\n\t\tsumf+=(LL)(i-1),sumg+=(LL)(n-i-1);\n\t\tadd(0,w[i],1),add(1,w[i],i-1),add(2,w[i],n-i-1);\n\t}\n\tans=qm(ans+1LL*n*(n-1)%mod*inv2%mod*inv2%mod*re.t[0][6]%mod);\n\tprintf(\"%d\\n\",ans);\n    return 0;\n}\n```\n",
        "postTime": 1530501487,
        "uid": 20604,
        "name": "litble",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P4223 \u3010\u671f\u671b\u9006\u5e8f\u5bf9\u3011"
    },
    {
        "content": "BJ \u96c6\u8bad\u8003\u4e86\u8fd9\u4e2a\u9898\uff0c\u8003\u573a\u4e0a\u778e DP \u5f97\u5230\u4e86 $O(n^3k)$ \u7684\u4f18\u79c0\u7b97\u6cd5/cy\u3002\n\n\u89c2\u5bdf\u5230\u5bf9\u4e8e\u4e24\u4e2a\u6570 $x_A,x_B$\uff0c\u5982\u679c\u5b83\u4eec\u539f\u6765\u5206\u522b\u5728 $A,B$ \u4f4d\u7f6e\uff0c\u90a3\u4e48\u5176\u4ed6\u4f4d\u7f6e\u90fd\u662f\u7b49\u4ef7\u7684\u3002\n\n\u6240\u4ee5\u5c06\u5176\u4ed6\u6240\u6709\u4f4d\u7f6e\u5168\u5b9a\u4e49\u4e3a $C$\uff0c\u90a3\u4e48\u53ef\u80fd\u7684\u4f4d\u7f6e\u5bf9\u5c31\u53ea\u6709 $7$ \u4e2a\uff1a$(A,B)$\uff0c$(B,A)$\uff0c$(A,C)$\uff0c$(C,A)$\uff0c$(B,C)$\uff0c$(C,B)$\uff0c$(C,C)$\uff0c\u4f9d\u6b21\u7f16\u53f7\u4e3a\u72b6\u6001 $1-7$\u3002\n\n\u7136\u540e\u8003\u8651\u8f6c\u79fb\uff1a\n\n1. $(A,B)$ \u7684\u8f6c\u79fb\n\t1. \u6ca1\u6362\u5230\u8fd9\u4e24\u4e2a\u6570\uff0c$f_{1,1}=\\binom{n-2}{2}$\uff1b\n   1. $A$ \u548c $B$ \u5bf9\u8c03\uff0c$f_{1,2}=1$\uff1b\n   1. $B$ \u6362\u5230\u4e00\u4e2a $C$\uff0c$f_{1,3}=n-2$\uff1b\n   1. $A$ \u6362\u5230\u4e00\u4e2a $C$\uff0c$f_{1,6}=n-2$\uff1b\n1. $(B,A)$ \u7684\u8f6c\u79fb\n\t1. $A$ \u548c $B$ \u5bf9\u8c03\uff0c$f_{2,1}=1$\uff1b\n\t1. \u6ca1\u6362\u5230\u8fd9\u4e24\u4e2a\u6570\uff0c$f_{2,2}=\\binom{n-2}{2}$\uff1b\n   1. $B$ \u6362\u5230\u4e00\u4e2a $C$\uff0c$f_{2,4}=n-2$\uff1b\n   1. $A$ \u6362\u5230\u4e00\u4e2a $C$\uff0c$f_{2,5}=n-2$\uff1b\n1. $(A,C)$ \u7684\u8f6c\u79fb\n\t1. $C$ \u6362\u5230 $B$ \u7684\u4f4d\u7f6e\u4e0a\uff0c$f_{3,1}=1$\uff1b\n   1. \u6ca1\u6362\u5230\u8fd9\u4e24\u4e2a\u6570\u6216\u8005 $C$ \u6362\u5230\u53e6\u5916\u4e00\u4e2a $C$\uff0c$f_{3,3}=\\binom{n-2}{2}+n-3$\uff1b\n   1. \u5bf9\u8c03\uff0c$f_{3,4}=1$\uff1b\n   1. $A$ \u6362\u5230 $B$ \u4e0a\uff0c$f_{3,5}=1$\uff1b\n   1. $A$ \u6362\u5230 $C$ \u4e0a\uff0c$f_{3,7}=n-3$\uff1b\n1. $(C,A)$ \u7684\u8f6c\u79fb\n\t1. $C$ \u6362\u5230 $B$ \u7684\u4f4d\u7f6e\u4e0a\uff0c$f_{4,2}=1$\uff1b\n   1. \u5bf9\u8c03\uff0c$f_{4,3}=1$\uff1b\n   1. \u6ca1\u6362\u5230\u8fd9\u4e24\u4e2a\u6570\u6216\u8005 $C$ \u6362\u5230\u53e6\u5916\u4e00\u4e2a $C$\uff0c$f_{4,4}=\\binom{n-2}{2}+n-3$\uff1b\n   1. $A$ \u6362\u5230 $B$ \u4e0a\uff0c$f_{4,6}=1$\uff1b\n   1. $A$ \u6362\u5230 $C$ \u4e0a\uff0c$f_{4,7}=n-3$\uff1b\n1. $(B,C)$ \u7684\u8f6c\u79fb\uff1a\n\t1. $C$ \u6362\u5230 $A$ \u7684\u4f4d\u7f6e\u4e0a\uff0c$f_{5,2}=1$\uff1b\n   1. $B$ \u6362\u5230 $A$ \u4e0a\uff0c$f_{5,3}=1$\uff1b\n   1. \u6ca1\u6362\u5230\u8fd9\u4e24\u4e2a\u6570\u6216\u8005 $C$ \u6362\u5230\u53e6\u5916\u4e00\u4e2a $C$\uff0c$f_{5,5}=\\binom{n-2}{2}+n-3$\uff1b\n   1. \u5bf9\u8c03\uff0c$f_{5,6}=1$\uff1b\n   1. $B$ \u6362\u5230 $C$ \u4e0a\uff0c$f_{5,7}=n-3$\uff1b\n1. $(C,B)$ \u7684\u8f6c\u79fb\uff1a\n\t1. $C$ \u6362\u5230 $A$ \u7684\u4f4d\u7f6e\u4e0a\uff0c$f_{6,1}=1$\uff1b\n   1. $B$ \u6362\u5230 $A$ \u4e0a\uff0c$f_{6,4}=1$\uff1b\n   1. \u5bf9\u8c03\uff0c$f_{6,5}=1$\uff1b\n   1. \u6ca1\u6362\u5230\u8fd9\u4e24\u4e2a\u6570\u6216\u8005 $C$ \u6362\u5230\u53e6\u5916\u4e00\u4e2a $C$\uff0c$f_{6,6}=\\binom{n-2}{2}+n-3$\uff1b\n   1. $B$ \u6362\u5230 $C$ \u4e0a\uff0c$f_{6,7}=n-3$\uff1b\n1. $(C,C)$ \u7684\u8f6c\u79fb\uff1a\n\t1. \u7b2c\u4e00\u4e2a $C$ \u6362\u5230 $A$\uff0c$f_{7,3}=1$\uff1b\n   1. \u7b2c\u4e8c\u4e2a $C$ \u6362\u5230 $A$\uff0c$f_{7,4}=1$\uff1b\n   1. \u7b2c\u4e00\u4e2a $C$ \u6362\u5230 $B$\uff0c$f_{7,5}=1$\uff1b\n   1. \u7b2c\u4e8c\u4e2a $C$ \u6362\u5230 $B$\uff0c$f_{7,6}=1$\uff1b\n   1. \u6ca1\u6362\u5230\u8fd9\u4e24\u4e2a\u6570\u6216\u8005\u5176\u4e2d\u4e00\u4e2a $C$ \u88ab\u6362\u5230\u4e0d\u540c\u4e8e\u8fd9\u4e24\u4e2a $C$ \u7684 $C$ \u6216\u8005\u4e24\u4e2a $C$ \u5bf9\u8c03\uff0c$f_{7,7}=\\binom{n-2}{2}+2(n-4)+1$\u3002\n   \n\u4e8e\u662f\u6839\u636e\u8fd9\u4e2a\u6784\u9020\u51fa\u8f6c\u79fb\u77e9\u9635 $T$\uff0c\u521d\u59cb\u77e9\u9635\u4e3a $A=[1,0,0,0,0,0,0]$\uff0c\u5c31\u53ef\u4ee5\u5f97\u5230\u8f6c\u79fb $k$ \u6b21\u7684 7 \u79cd\u60c5\u51b5\u7684\u65b9\u6848\u6570 $B=A\\times T^k$\u3002\n\n\u63a5\u4e0b\u6765\u8003\u8651\u7edf\u8ba1\u7b54\u6848\u3002\n\n\u5bf9\u4e8e\u4e00\u5bf9\u6570 $(i,j)$\uff0c\u5982\u679c $a_i<a_j$\uff0c\u8003\u8651\u5b83\u5728 $7$ \u79cd\u65b9\u6848\u4e2d\u7684\u8d21\u732e\uff1a\n\n1. $(A,B)$\uff0c\u4e0d\u53ef\u80fd\u6709\u8d21\u732e\uff0c\u7cfb\u6570\u4e3a $0$\uff1b\n2. $(B,A)$\uff0c\u5fc5\u7136\u6709\u8d21\u732e\uff0c\u7cfb\u6570\u4e3a $1$\uff1b\n3. $(A,C)$\uff0c$C$ \u6362\u5230 $i$ \u524d\u9762\u624d\u6709\u8d21\u732e\uff0c\u7cfb\u6570\u4e3a $\\dfrac{i-1}{n-2}$\uff1b\n4. $(C,A)$\uff0c$C$ \u6362\u5230 $i$ \u540e\u9762\u624d\u6709\u8d21\u732e\uff0c\u540c\u65f6\u4e0d\u80fd\u6362\u5230 $j$\uff0c\u7cfb\u6570\u4e3a $\\dfrac{n-i-1}{n-2}$\uff1b\n5. $(B,C)$\uff0c$C$ \u6362\u5230 $j$ \u524d\u9762\u6709\u8d21\u732e\uff0c\u540c\u65f6\u4e0d\u80fd\u6362\u5230 $i$\uff0c\u7cfb\u6570\u4e3a $\\dfrac{j-2}{n-2}$\uff1b\n6. $(C,B)$\uff0c$C$ \u6362\u5230 $j$ \u540e\u9762\u6709\u8d21\u732e\uff0c\u7cfb\u6570\u4e3a $\\dfrac{n-j}{n-2}$\uff1b\n7. $(C,C)$\uff0c\u76f8\u5f53\u4e8e\u56fa\u5b9a\u4e24\u4e2a\u5143\u7d20\u7684\u987a\u5e8f\u5173\u7cfb\uff0c\u7cfb\u6570\u4e3a $\\dfrac{1}{2}$\u3002\n\n$a_i>a_j$ \u540c\u7406\uff0c\u4e0d\u518d\u8d58\u8ff0\u3002\n\n\u8fd9\u4e2a\u5f62\u5f0f\u663e\u7136\u53ef\u4ee5\u6811\u72b6\u6570\u7ec4\u7ef4\u62a4\uff0c\u4e8e\u662f\u8fd9\u9898\u5c31\u505a\u5b8c\u4e86\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log n)$\u3002\n\n\u6ce8\u610f\u4e00\u4e2a\u5c0f\u7ec6\u8282\uff1a$\\binom{n-2}{2}$ \u53ef\u80fd\u4f1a\u7206\u6a21\u6570\uff0c\u6ce8\u610f\u53d6\u6a21\u3002~~\u6211\u4eec\u6559\u7ec3\u8003\u573a\u4e0a\u56e0\u4e3a\u8fd9\u4e2a 100\u219256~~\n\n```cpp\n#include <iostream>\n#include <cmath>\n#include <cstring>\n#include <cstdio>\nusing namespace std;\n\n#define getchar() (p1==p2&&(p2=(p1=buf)+fread(buf,1,1<<21,stdin),p1==p2)?EOF:*p1++)\nchar buf[1 << 21], *p1 = buf, *p2 = buf;\n\ninline int qread() {\n\tregister char c = getchar();\n\tregister int x = 0, f = 1;\n\twhile (c < '0' || c > '9') {\n\t\tif (c == '-') f = -1;\n\t\tc = getchar();\n\t}\n\twhile (c >= '0' && c <= '9') {\n\t\tx = (x << 3) + (x << 1) + c - 48;\n\t\tc = getchar();\n\t}\n\treturn x * f;\n}\n\ninline int Abs(const int& x) {return (x > 0 ? x : -x);}\ninline int Max(const int& x, const int& y) {return (x > y ? x : y);}\ninline int Min(const int& x, const int& y) {return (x < y ? x : y);}\n\nconst long long mod = 1000000007, inv2 = 500000004;\nint n, k, a[500005];\nlong long c[3][500005];\nstruct Matrix {\n\tlong long a[10][10];\n\tint n, m;\n\tMatrix() {\n\t\tmemset(a, 0, sizeof(a));\n\t\tn = m = 0;\n\t}\n\tinline Matrix operator * (const Matrix& b) const {\n\t\tMatrix c;\n\t\tc.n = n;\n\t\tc.m = b.m;\n\t\tfor (int i = 1;i <= n;i++) {\n\t\t\tfor (int j = 1;j <= b.m;j++) {\n\t\t\t\tfor (int k = 1;k <= m;k++) c.a[i][j] = (c.a[i][j] + a[i][k] * b.a[k][j] % mod) % mod;\n\t\t\t}\n\t\t}\n\t\treturn c;\n\t}\n};\nMatrix ans, trans;\n\ninline Matrix Unit(int n) {\n\tMatrix res;\n\tres.n = res.m = n;\n\tfor (int i = 1;i <= n;i++) res.a[i][i] = 1;\n\treturn res;\n}\n\ninline Matrix Power(Matrix x, long long y) {\n\tMatrix ans = Unit(x.n);\n\twhile (y) {\n\t\tif (y & 1) ans = ans * x;\n\t\tx = x * x;\n\t\ty >>= 1;\n\t}\n\treturn ans;\n}\n\ninline long long Power(long long x, long long y) {\n\tlong long ans = 1;\n\twhile (y) {\n\t\tif (y & 1) ans = ans * x % mod;\n\t\tx = x * x % mod;\n\t\ty >>= 1;\n\t}\n\treturn ans;\n}\n\ninline void Read() {\n\tn = qread(); k = qread();\n\tfor (int i = 1;i <= n;i++) a[i] = qread();\n}\n\ninline void Prefix() {\n\ttrans.n = trans.m = ans.m = 7;\n\tans.n = 1;\n\n\tlong long tmp = 1ll * (n - 2) * (n - 3) / 2 % mod;\n\n\ttrans.a[1][1] = tmp;\n\ttrans.a[1][3] = n - 2;\n\ttrans.a[1][6] = n - 2;\n\ttrans.a[1][2] = 1;\n\n\ttrans.a[2][2] = tmp;\n\ttrans.a[2][5] = n - 2;\n\ttrans.a[2][4] = n - 2;\n\ttrans.a[2][1] = 1;\n\n\ttrans.a[3][1] = 1;\n\ttrans.a[3][3] = (tmp + n - 3) % mod;\n\ttrans.a[3][5] = 1;\n\ttrans.a[3][7] = n - 3;\n\ttrans.a[3][4] = 1;\n\n\ttrans.a[4][2] = 1;\n\ttrans.a[4][6] = 1;\n\ttrans.a[4][4] = (tmp + n - 3) % mod;\n\ttrans.a[4][7] = n - 3;\n\ttrans.a[4][3] = 1;\n\n\ttrans.a[5][2] = 1;\n\ttrans.a[5][3] = 1;\n\ttrans.a[5][5] = (tmp + n - 3) % mod;\n\ttrans.a[5][6] = 1;\n\ttrans.a[5][7] = n - 3;\n\n\ttrans.a[6][1] = 1;\n\ttrans.a[6][4] = 1;\n\ttrans.a[6][5] = 1;\n\ttrans.a[6][6] = (tmp + n - 3) % mod;\n\ttrans.a[6][7] = n - 3;\n\n\ttrans.a[7][3] = 1;\n\ttrans.a[7][4] = 1;\n\ttrans.a[7][5] = 1;\n\ttrans.a[7][6] = 1;\n\ttrans.a[7][7] = (tmp + n - 4 + n - 4 + 1) %mod;\n\n\tans.a[1][1] = 1;\n\tans = ans * Power(trans, k);\n\t//printf(\"%lld %lld %lld %lld %lld %lld %lld\\n\", ans.a[1][1], ans.a[1][2], ans.a[1][3], ans.a[1][4], ans.a[1][5], ans.a[1][6], ans.a[1][7]);\n}\n\ninline int Lowbit(int x) {\n\treturn x & -x;\n}\n\ninline void Update(int k, int i, int x) {\n\tfor (int j = i;j <= n;j += Lowbit(j)) c[k][j] += x;\n}\n\ninline long long Query(int k, int i) {\n\tlong long ans = 0;\n\tfor (int j = i;j >= 1;j -= Lowbit(j)) ans += c[k][j];\n\treturn ans;\n}\n\ninline void Solve() {\n\tlong long res = 0, invn = Power(n - 2, mod - 2);\n\tfor (int i = 1;i <= n;i++) {\n\t\tlong long s1l = Query(0, a[i]), sil = Query(1, a[i]), snil = Query(2, a[i]), s1r = Query(0, n) - s1l, sir = Query(1, n) - sil, snir = Query(2, n) - snil;\n\t\tsil %= mod; sir %= mod; snil %= mod; snir %= mod;\n\t\tres = (res + s1r * ans.a[1][1]) % mod;\n\t\tres = (res + s1l * ans.a[1][2]) % mod;\n\t\tres = (res + (s1l * (i - 2) + s1r * (n - i)) % mod * invn % mod * ans.a[1][5]) % mod;\n\t\tres = (res + (s1r * (i - 2) + s1l * (n - i)) % mod * invn % mod * ans.a[1][6]) % mod;\n\t\tres = (res + (sil + snir) % mod * invn % mod * ans.a[1][3] % mod) % mod;\n\t\tres = (res + (snil + sir) % mod * invn % mod * ans.a[1][4] % mod) % mod;\n\t\tUpdate(0, a[i], 1);\n\t\tUpdate(1, a[i], i - 1);\n\t\tUpdate(2, a[i], n - i - 1);\n\t}\n\tprintf(\"%lld\", (res + inv2 * n % mod * (n - 1) % mod * inv2 % mod * ans.a[1][7] % mod) % mod);\n}\n\nint main() {\n\tRead();\n\tPrefix();\n\tSolve();\n\t#ifdef CFA_44\n\twhile (1);\n\t#endif\n\treturn 0;\n}\n```",
        "postTime": 1617185976,
        "uid": 61088,
        "name": "Solystic",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P4223 \u3010\u671f\u671b\u9006\u5e8f\u5bf9\u3011"
    },
    {
        "content": "## \uff08\u4e00\uff09\u6bcf\u4e24\u4e2a\u521d\u59cb\u4f4d\u7f6e\u6700\u7ec8\u7684\u4f4d\u7f6e\u72b6\u6001\n\n\u8bbe\u539f\u5e8f\u5217\u4e3a $a_1,a_2,\\dots,a_n$\u3002\n\n\u53ea\u8003\u8651\u4e24\u4e2a\u6570 $a_L,a_R(L<R)$\uff0c\u6211\u4eec\u5206\u7c7b\u8ba8\u8bba\u6700\u540e\u8fd9\u4e24\u4e2a\u6570\u8dd1\u54ea\u91cc\u53bb\u4e86\uff08\u524d\u8005\u4e3a $a_L$ \u53bb\u7684\u5730\u65b9\uff0c\u540e\u8005\u4e3a $a_R$ \u7684\uff0c$O$ \u4e3a\u9664\u4e86 $L,R$ \u5269\u4e0b\u7684\u4f4d\u7f6e\uff09\uff1a\n\n$$(L,R),(R,L),(O,R),(R,O),(L,O),(O,L),(O,O)$$\n\n\u8fd9\u4e00\u6b65 Swap \u524d\u5404\u4e2a\u72b6\u6001\u7684\u65b9\u6848\u6570\u548c\u8fd9\u4e00\u6b65\u540e\u7684\u65b9\u6848\u6570\n\n$$Bef=\\begin{bmatrix}\nLR\n\\\\RL\n\\\\OR\n\\\\RO\n\\\\LO\n\\\\OL\n\\\\OO\n\\end{bmatrix}\n,Aft=\\begin{bmatrix}\nLR'\n\\\\RL'\n\\\\OR'\n\\\\RO'\n\\\\LO'\n\\\\OL'\n\\\\OO'\n\\end{bmatrix}$$\n\n\u5219\n\n$$M^k\\cdot Bef=Aft$$\n\n\u800c\u4e14\u4e0d\u8bba $L,R$ \u53d6\u5565\uff0c\u8f6c\u79fb\u77e9\u9635 $M$ \u59cb\u7ec8\u4e0d\u53d8\uff1a\n\n$$\\begin{aligned}\nA&=n-2\n\\\\\nB&=n-3\n\\\\\nC&=\\binom{n-2}{2}\n\\\\\nD&=\\binom{n-2}{2}+n-3\n\\\\\nE&=\\binom{n-2}{2}+2(n-4)+1\n\\end{aligned}$$\n\n$$M=\\begin{bmatrix}\nC&1&1&0&1&0&0\n\\\\\n1&C&0&1&0&1&0\n\\\\\nA&0&D&1&0&1&1\n\\\\\n0&A&1&D&1&0&1\n\\\\\nA&0&0&1&D&1&1\n\\\\\n0&A&1&0&1&D&1\n\\\\\n0&0&B&B&B&B&E\n\\end{bmatrix}$$\n\n\u901a\u8fc7\u77e9\u9635\u5feb\u901f\u5e42 $O(7^3\\log k)$ \u5f97\u51fa\u6bcf\u4e24\u4e2a\u521d\u59cb\u4f4d\u7f6e\u6700\u7ec8\u7684\u4f4d\u7f6e\u72b6\u6001\u3002\n\n\u540e\u9762\u4e3a\u65b9\u4fbf\u5217\u5f0f\u5b50\uff0c\u5c06 $Aft$ \u4e2d\u7b2c $i(=0,\\dots,6)$ \u4e2a\u5143\u7d20\u7684\u503c\u8bbe\u4e3a $p_i$\u3002\n\n## \uff08\u4e8c\uff09\u6bcf\u4e24\u4e2a\u521d\u59cb\u4f4d\u7f6e\u6700\u540e\u662f\u5426\u662f\u9006\u5e8f\u5bf9\n\n\u6211\u4eec\u8fd9\u91cc\u8bbe $a_L<a_R$\uff0c\u53cd\u4e4b\u4e0d\u518d\u8d58\u8ff0\u3002\n\n\u6309\u6700\u7ec8\u72b6\u6001\u5206\u7c7b\uff08\u5f00\u5934\u4e3a\u8d21\u732e\uff09\uff1a\n\n### LR\n\n$$p_0\\cdot 0$$\n\n### RL\n\n$$p_1\\cdot 1$$\n\n### OR\n\n$$p_2\\cdot\\frac{n-R}{n-2}$$\n\n\u89e3\u91ca\uff1a\n\n$a_L$ \u8981\u8dd1\u5230 $R$ \u53f3\u8fb9\u624d\u5f62\u6210\u9006\u5e8f\u5bf9\u3002\n\n\u56e0\u4e3a $n-2$ \u4e2a $O$ \u7684\u4f4d\u7f6e\u5b8c\u5168\u7b49\u4ef7\uff08\u5bf9\u4e8e $a_L$ \u51fa\u73b0\u7684\u6982\u7387\u7b49\uff09\uff0c\u6240\u4ee5$a_L$ \u8981\u8dd1\u5230 $R$ \u540e\u9762\u7684\u6982\u7387\u4e3a $\\frac{n-R}{n-2}$\u3002\n\n### RO\n\n$$p_3\\cdot\\frac{R-2}{n-2}$$\n\n\u89e3\u91ca\uff1a\n\n$a_R$ \u8981\u8dd1\u5230 $R$ \u5de6\u8fb9\u624d\u5f62\u6210\u9006\u5e8f\u5bf9\u3002\n\n\u5269\u4e0b\u540c\u7406\u3002\n\n### LO\n\n$$p_4\\cdot\\frac{L-1}{n-2}$$\n\n\u89e3\u91ca\uff1a\n\n$a_R$ \u8981\u8dd1\u5230 $L$ \u5de6\u8fb9\u624d\u5f62\u6210\u9006\u5e8f\u5bf9\u3002\n\n### OL\n\n$$p_5\\cdot\\frac{n-1-L}{n-2}$$\n\n\u89e3\u91ca\uff1a\n\n$a_L$ \u8981\u8dd1\u5230 $L$ \u53f3\u8fb9\u624d\u5f62\u6210\u9006\u5e8f\u5bf9\u3002\n\n### OO\n\n$$p_6\\cdot\\frac{1}{2}$$\n\n\u89e3\u91ca\uff1a\n\n\u76f8\u5f53\u4e8e\u5728 $O$ \u4f4d\u7f6e\u4e4b\u95f4\u53d6\u4e24\u4e2a\u4f4d\u7f6e $x,y(x\\ne y)$\uff0c$a_x<a_y$ \u7684\u6982\u7387\u3002\n\n\u7531\u4e8e\u4e0d\u5b58\u5728 $a_x=a_y$ \u7684\u60c5\u51b5\uff08\u9898\u9762\u8bf4\u6392\u5217\uff09\uff0c\u6613\u77e5 $a_x<a_y$ \u7684\u6982\u7387\u4e3a $\\frac{1}{2}$\u3002\n\n* * *\n\n\u8fd9\u4e9b\u67ff\u5b50\u53c8\u81ed\u53c8\u957f\uff1f\u628a\u5979\u4eec\u5199\u6210\u77e9\u9635\u7684\u5f62\u5f0f\u5427\uff01\n\n\u7531\u4e8e\u4e0a\u9762\u7684\u8d21\u732e\u5747\u53ef\u5199\u6210\uff08$c$ \u5747\u4e3a\u5e38\u6570\uff09\n\n$$p_*(c_0^*+c_1^*L+c_2^*R)$$\n\n\u7684\u5f62\u5f0f\uff0c\u6700\u540e $a_L,a_R$ \u4e4b\u95f4\u7684\u8d21\u732e\u53ef\u4ee5\u8868\u793a\u4e3a\n\n$$c_0+c_1L+c_2R$$\n\n\u6240\u4ee5\u6211\u4eec\n\n$$\nT\\begin{bmatrix}p_0\\\\p_1\\\\ \\vdots\\\\ p_6\\end{bmatrix}=\\begin{bmatrix}c_0\\\\c_1\\\\ c_2\\end{bmatrix}\n$$\n\n\u5176\u4e2d $T$ \u4e3a $3$ \u884c $7$ \u5217\u7684\u5e38\u6570\u77e9\u9635\uff08\u5176\u5b9e\u5df2\u7ecf\u6697\u542b\u5728\u4e0a\u9762\u5206\u7c7b\u4e2d\u7684\u8d21\u732e\u91cc\u4e86\uff09\u3002\n\n\u8be6\u89c1\u4ee3\u7801 `init()` \u548c `solve()` \u90e8\u5206\u3002 \n\n## \uff08\u4e09\uff09\u6811\u72b6\u6570\u7ec4\u7edf\u8ba1\u8d21\u732e\n\n~~\u4e66\u63a5\u4e0a\u56de~~\uff0c\u6211\u4eec\u5f97\u5230\u4e24\u4e2a\u4f4d\u7f6e\u4e4b\u95f4\u7684\u8d21\u732e\u53ef\u8868\u793a\u4e3a\u5e38\u6570\u3001\u4e24\u4e2a\u4e0b\u6807\u7684\u7ebf\u6027\u7ec4\u5408\u3002\n\n\u6240\u4ee5\u6211\u4eec\u901a\u8fc7\u6811\u72b6\u6570\u7ec4\u6c42\u51fa\u6bcf\u4e2a\u4f4d\u7f6e\u524d\u9762\u6bd4\u5979\u5927\u7684\u4e2a\u6570 \u548c \u4e0b\u6807\u548c\uff0c\u7136\u540e\u8ba1\u7b97\u7b54\u6848\u5373\u53ef\u3002\n\n## \uff08\u56db\uff09\u4ee3\u7801\n\n2KB ~~\u7b80\u77ed~~\u4ee3\u7801\u3002\n\n```cpp\n//We'll be counting stars.\n#include<bits/stdc++.h>\nusing namespace std;\n#define For(i,j,k) for(int i=(j),i##_=(k);i<=i##_;i++)\n#define Rof(i,j,k) for(int i=(j),i##_=(k);i>=i##_;i--)\n#define int long long\nconst int mod=1e9+7,iv2=(mod+1)/2;\ninline int pw(int x,int y){int r=1;while(y){if(y&1)r=r*x%mod;x=x*x%mod;y>>=1;}return r;}\n#define N 500005\nstruct ma{\n\tint a[7][7];\n\tvoid init(){For(i,0,6)For(j,0,6)a[i][j]=(i==j);}\n\tvoid clear(){For(i,0,6)For(j,0,6)a[i][j]=0;}\n\tma mul(ma x){\n\t\tma res;res.clear();\n\t\tFor(i,0,6)For(j,0,6)For(k,0,6)(res.a[i][j]+=a[i][k]*x.a[k][j])%=mod;\n\t\treturn res;\n\t}\n}M,R;\nint k,p[7];\nvoid kasumi(){\n\tR.init();\n\twhile(k){\n\t\tif(k&1) R=R.mul(M);\n\t\tk>>=1; M=M.mul(M);\n\t}\n\tFor(i,0,6) p[i]=R.a[i][0];\n}\nint n,a[N],c[N],cnt[N],pos[N],coe[3],m[3][7];\n#define low (x&-x)\nvoid add(int x,int y){\n\twhile(x<=n) c[x]+=y,x+=low;\n}\nint que(int x){\n\tint res=0;\n\twhile(x) res+=c[x],x-=low;\n\treturn res;\n}\nint ans=0;\nvoid solve(){\n\tFor(i,0,2){\n\t\tcoe[i]=0;\n\t\tFor(j,0,6) (coe[i]+=m[i][j]*p[j])%=mod;\n\t}\n\tFor(i,1,n) (ans+=cnt[i]*(coe[0]+i*coe[2]%mod)%mod+pos[i]%mod*coe[1]%mod)%=mod;\n}\nvoid reve(){\n\tFor(i,1,n) cnt[i]=i-1-cnt[i];\n\tFor(i,1,n) pos[i]=i*(i-1)/2-pos[i];\n\tFor(i,0,6) m[0][i]=(1-m[0][i]+mod)%mod;\n\tFor(j,1,2) For(i,0,6) m[j][i]=(-m[j][i]+mod)%mod;\n}\nvoid init(){\n\tint iv=pw(n-2,mod-2);\n\tm[0][1]=1,m[0][2]=n*iv%mod,m[0][3]=(mod-2)*iv%mod,m[0][4]=(mod-1)*iv%mod,m[0][5]=(n-1)*iv%mod,m[0][6]=iv2;\n\tm[1][4]=iv,m[1][5]=(mod-1)*iv%mod;\n\tm[2][2]=(mod-1)*iv%mod,m[2][3]=iv;\n}\nint32_t main(){\n\tios::sync_with_stdio(false);\n\tcin.tie(nullptr);\n\tcin>>n>>k;\n\tint A=n-2,B=n-3,C=((n-2)*(n-3)+mod)%mod*iv2%mod,D=(C+n-3+mod)%mod,E=(C+2*n-7+mod)%mod;\n\tM=(ma){{\n\t{C,1,1,0,1,0,0},\n\t{1,C,0,1,0,1,0},\n\t{A,0,D,1,0,1,1},\n\t{0,A,1,D,1,0,1},\n\t{A,0,0,1,D,1,1},\n\t{0,A,1,0,1,D,1},\n\t{0,0,B,B,B,B,E},\n\t}};\n\tkasumi();\n\tFor(i,1,n) cin>>a[i];\n\tFor(i,1,n) cnt[i]=que(a[i]),add(a[i],1);\n\tFor(i,1,n) c[i]=0;\n\tFor(i,1,n) pos[i]=que(a[i]),add(a[i],i);\n\tFor(i,1,n) c[i]=0;\n\tinit();solve();\n\treve();solve();\n\tcout<<ans<<endl;\nreturn 0;}\n```",
        "postTime": 1655452503,
        "uid": 101868,
        "name": "I_am_Accepted",
        "ccfLevel": 0,
        "title": "P4223 \u671f\u671b\u9006\u5e8f\u5bf9"
    },
    {
        "content": "P4223 \u671f\u671b\u9006\u5e8f\u5bf9\n\n\u9898\u610f\uff1a\u7ed9\u5b9a\u4e00\u4e2a\u957f\u5ea6\u4e3a $n$ \u7684\u6392\u5217\uff0c\u8fdb\u884c $k$ \u6b21\u64cd\u4f5c\uff0c\u6bcf\u6b21\u64cd\u4f5c\u968f\u673a\u4ece\u6392\u5217\u91cc\u9009\u4e24\u4e2a\u6570\u4ea4\u6362\u4f4d\u7f6e\uff0c\u6c42\u64cd\u4f5c\u540e\u9006\u5e8f\u5bf9\u4e2a\u6570\u7684\u671f\u671b\u4e58\u4e0a $\\binom n2^k$\uff0c\u5bf9 $10^9+7$ \u53d6\u6a21\uff0c\u6570\u636e\u8303\u56f4\uff1a$n\\leq 500000,k\\leq 10^9$ \n\n\u8003\u8651\u70b9\u5bf9 $(A,B)$ \u7684\u8d21\u732e\uff0c\u8bbe $k$ \u6b21\u64cd\u4f5c\u540e\uff0c\u5728 $(A,B)$ \u4f4d\u7f6e\u4e0a\u7684\u4e24\u4e2a\u6570\u88ab\u79fb\u52a8\u5230\u4e86 $(p,q)$\uff0c\u53d1\u73b0\u6574\u4e2a\u5b57\u7b26\u4e32\u5982\u679c\u53ea\u8003\u8651\u4ed6\u4fe9\uff0c\u90a3\u5c31\u53ea\u6709\u4e09\u4e2a\u90e8\u5206\u4e86\uff0c$CCCCCACCCCCBCCCCC$\uff0c\u79fb\u52a8\u540e\u90a3\u4fe9\u6570\u7684\u4f4d\u7f6e\u53ea\u6709 $(A,B),(B,A),(C,B),(B,C),(A,C),(C,A),(C,C)$ \u8fd9\u4e03\u79cd\u60c5\u51b5\uff0c\u53ef\u4ee5\u901a\u8fc7\u77e9\u9635\u5feb\u901f\u5e42\u5904\u7406\u51fa\u6240\u6709\u60c5\u51b5\u7684\u65b9\u6848\u6570\uff0c\u8f6c\u79fb\u77e9\u9635\u5982\u7b2c\u4e00\u7bc7\u9898\u89e3\n\n\u7136\u540e\u662f\u5904\u7406\u7b54\u6848\uff0c\u679a\u4e3e\u539f\u5e8f\u5217\u4e0a $B$ \u7684\u4f4d\u7f6e\uff0c\u7136\u540e\u7528\u6811\u72b6\u6570\u7ec4\u6765\u641e $A$\uff0c\u8bbe $a$ \u4e3a $B$ \u524d\u9762\u6bd4 $B$ \u8fd9\u4e2a\u4f4d\u7f6e\u4e0a\u6570\u5c0f\u7684\u6570\u7684\u4e2a\u6570\uff0c$fa$ \u8868\u793a $B$ \u524d\u9762\u6bd4 $B$ \u8fd9\u4e2a\u4f4d\u7f6e\u4e0a\u6570\u5c0f\u7684\u6570\u7684 $pos-1$ \u7684\u548c\uff0c$ga$ \u8868\u793a $B$ \u540e\u9762\u6bd4 $B$ \u8fd9\u4e2a\u4f4d\u7f6e\u4e0a\u6570\u5c0f\u7684 $pos-1$ \u7684\u548c\uff0c\u7136\u540e\u518d\u641e\u51fa\u6765\u6bd4 $B$ \u6570\u5927\u7684\u4e09\u4e2a\u503c\uff0c\u5c31\u53ef\u4ee5\u5904\u7406\u7b54\u6848\u4e86\n\n\u64cd\u4f5c\u5b8c\u4f4d\u7f6e\u662f $(A,B)$ \u7684\u60c5\u51b5\uff1a$B$ \u524d\u9762\u6bd4 $B$ \u6570\u5927\u7684\u6570\u90fd\u53ef\u4ee5\u8d21\u732e $1$ \n\n\u64cd\u4f5c\u5b8c\u4f4d\u7f6e\u662f $(B,A)$ \u7684\u60c5\u51b5\uff1a$B$ \u524d\u9762\u6bd4 $B$ \u6570\u5c0f\u7684\u6570\u90fd\u53ef\u4ee5\u8d21\u732e $1$ \n\n\u64cd\u4f5c\u5b8c\u4f4d\u7f6e\u662f $(C,B)$ \u7684\u60c5\u51b5\uff1a$B$ \u524d\u9762\u6bd4 $B$ \u6570\u5927\u7684\u6570\u5728 $B-2$ \u4e2a\u4f4d\u7f6e\u4e0a\u53ef\u4ee5\u5bf9\u7b54\u6848\u8d21\u732e $1$\uff0c\u6bd4 $B$ \u6570\u5c0f\u7684\u6570\u5728 $n-B$ \u4e2a\u4f4d\u7f6e\u4e0a\u53ef\u4ee5\u5bf9\u7b54\u6848\u8d21\u732e $1$ \n\n\u64cd\u4f5c\u5b8c\u4f4d\u7f6e\u662f $(B,C)$ \u7684\u60c5\u51b5\uff1a\u786e\u5b9a\u4e86 $B$ \u4e4b\u524d\u7684\u4e00\u4e2a\u5c0f\u4e8e\u5b83\u7684\u6570\u7684\u4f4d\u7f6e\uff0c$B$ \u7684\u4f4d\u7f6e\u53ef\u4ee5\u6709 $B-2$ \u79cd\uff0c\u786e\u5b9a\u4e86 $B$ \u4e4b\u524d\u7684\u4e00\u4e2a\u5927\u4e8e\u5b83\u7684\u6570\u7684\u4f4d\u7f6e\uff0c$B$ \u7684\u4f4d\u7f6e\u53ef\u4ee5\u6709 $n-B$ \u79cd\n\n\u64cd\u4f5c\u5b8c\u4f4d\u7f6e\u662f $(A,C)$ \u7684\u60c5\u51b5\uff1a\u82e5\u8fd9\u4e2a $A$ \u662f\u5c0f\u4e8e $B$ \u7684\uff0c\u90a3\u4e48 $B$ \u9700\u8981\u5728 $A$ \u524d\u9762\u624d\u80fd\u8d21\u732e $1$\uff0c\u4e5f\u5c31\u662f $pos-1$ \u4e2a\u4f4d\u7f6e\uff0c\u5c31\u662f $B$ \u524d\u9762\u5c0f\u4e8e\u5b83\u7684\u6570\u7684 $pos-1$ \u7684\u548c\uff0c\u82e5\u8fd9\u4e2a $A$ \u662f\u5927\u4e8e $B$ \u7684\uff0c\u90a3\u4e48 $B$ \u9700\u8981\u5728 $A$ \u540e\u9762\u624d\u80fd\u8d21\u732e $1$\uff0c\u4e5f\u5c31\u662f $n-pos-1$ \u4e2a\u4f4d\u7f6e\uff0c\u5c31\u662f $B$ \u524d\u9762\u5927\u4e8e\u5b83\u7684\u6570\u7684 $n-pos-1$ \u7684\u548c\n\n\u64cd\u4f5c\u5b8c\u4f4d\u7f6e\u662f $(C,A)$ \u7684\u60c5\u51b5\uff1a\u82e5\u8fd9\u4e2a $A$ \u662f\u5c0f\u4e8e $B$ \u7684\uff0c\u90a3\u4e48 $A$ \u9700\u8981\u5728 $B$ \u540e\u9762\u624d\u80fd\u8d21\u732e $1$\uff0c\u4e5f\u5c31\u662f $n-pos-1$ \u4e2a\u4f4d\u7f6e\uff0c\u5c31\u662f $B$ \u524d\u9762\u5c0f\u4e8e\u5b83\u7684\u6570\u7684 $n-pos-1$ \u7684\u548c\uff0c\u82e5\u8fd9\u4e2a $A$ \u662f\u5927\u4e8e $B$ \u7684\uff0c\u90a3\u4e48 $A$ \u9700\u8981\u5728 $B$ \u524d\u9762\u624d\u80fd\u8d21\u732e $1$\uff0c\u4e5f\u5c31\u662f $pos-1$ \u4e2a\u4f4d\u7f6e\uff0c\u5c31\u662f $B$ \u524d\u9762\u5927\u4e8e\u5b83\u7684\u6570\u7684 $pos-1$ \u7684\u548c\n\n\u64cd\u4f5c\u5b8c\u4f4d\u7f6e\u662f $(C,C)$ \u7684\u60c5\u51b5\uff1a\u8fd9\u4e2a\u5355\u72ec\u7b97\uff0c\u4ece\u5e8f\u5217\u91cc\u968f\u4fbf\u6311\u4e24\u4e2a\u6570\uff0c\u5b83\u4eec\u6709 $\\frac 12$ \u7684\u51e0\u7387\u6362\u6210\u9006\u5e8f\u5bf9\n\n\u7edf\u8ba1\u7b54\u6848\u5373\u53ef\n\n\u7801\uff1a\n\n```c++\n//\u5934\u6587\u4ef6\nconst int Mod=1e9+7;\n\nint fpow(int x,int y){\n    int res=1%Mod;x%=Mod;\n    for(;y;y>>=1,x=x*x%Mod) if(y&1) res=res*x%Mod;\n    return res%Mod;\n}\n\nint n,k,s[N],ans=0;\nint sumf=0,sumg=0;\nint inv1,inv2;\n\nstruct Matrix{\n    int n,m;\n    int a[10][10];\n\n    Matrix(int _n=0,int _m=0){\n        n=_n,m=_m;\n        memset(a,0,sizeof a);\n    }\n    \n    Matrix operator * (const Matrix &x)const{\n        Matrix res(n,x.m);\n        for(int i=1;i<=n;i++){\n            for(int j=1;j<=x.m;j++){\n                for(int k=1;k<=m;k++){\n                    (res.a[i][j]+=a[i][k]*x.a[k][j]%Mod)%=Mod;\n                }\n            }\n        }\n        return res;\n    }\n\n    void id(){\n        for(int i=1;i<=m;i++) a[i][i]=1;\n    }\n\n    Matrix fpow(int t){\n        Matrix res(n,n);\n        res.id();\n        Matrix op=*this;\n        for(;t;t>>=1,op=op*op) if(t&1) res=res*op;\n        return res;\n    }\n}goal,pro;\n\nint t[N][4];\n\nvoid add(int x,int y,int id){\n    while(x<=n+10){\n        (t[x][id]+=y)%=Mod;\n        x+=x&(-x);\n    }\n}\n\nint query(int x,int id){\n    int res=0;\n    while(x){\n        (res+=t[x][id])%=Mod;\n        x-=x&(-x);\n    }\n    return res;\n}\n\nvoid mat_init(){\n    pro.n=pro.m=7;goal.n=1,goal.m=7;\n    pro.a[1][2]=pro.a[2][1]=pro.a[3][1]=pro.a[3][4]=pro.a[3][6]=pro.a[4][2]=1;\n    pro.a[4][3]=pro.a[4][5]=pro.a[5][1]=pro.a[5][4]=pro.a[5][6]=pro.a[6][2]=1;\n    pro.a[6][3]=pro.a[6][5]=pro.a[7][3]=pro.a[7][4]=pro.a[7][5]=pro.a[7][6]=1;\n    pro.a[1][1]=pro.a[2][2]=((n-2)*(n-3)%Mod*inv2)%Mod;\n    pro.a[1][3]=pro.a[1][5]=pro.a[2][4]=pro.a[2][6]=n-2;\n    pro.a[3][7]=pro.a[4][7]=pro.a[5][7]=pro.a[6][7]=n-3;\n    pro.a[3][3]=pro.a[4][4]=pro.a[5][5]=pro.a[6][6]=((n-2)*(n-3)%Mod*inv2%Mod+n-3+Mod)%Mod;\n    pro.a[7][7]=((n-2)*(n-3)%Mod*inv2%Mod+n+n-7)%Mod;\n    goal.a[1][1]=1;\n}\n\nsigned main(){\n\n    read(n),read(k);\n    for(int i=1;i<=n;i++) read(s[i]);\n    inv1=fpow(n-2,Mod-2),inv2=fpow(2,Mod-2);\n\n    mat_init();\n\n    goal=goal*pro.fpow(k);\n\n    for(int i=1;i<=n;i++){\n        int a=query(s[i],1),b=i-a-1;\n        int fa=query(s[i],2),fb=sumf-fa;\n        int ga=query(s[i],3),gb=sumg-ga;\n        (ans+=(goal.a[1][1]*b%Mod))%=Mod;\n        (ans+=(goal.a[1][2]*a%Mod))%=Mod;\n        (ans+=(goal.a[1][3]*((b*(i-2)%Mod+a*(n-i)%Mod)*inv1%Mod)%Mod))%=Mod;\n        (ans+=(goal.a[1][4]*((a*(i-2)%Mod+b*(n-i)%Mod)*inv1%Mod)%Mod))%=Mod;\n        (ans+=(goal.a[1][5]*(fa+gb)%Mod*inv1%Mod))%=Mod;\n        (ans+=(goal.a[1][6]*(fb+ga)%Mod*inv1%Mod))%=Mod;\n        sumf+=(i-1);sumg+=(n-i-1);\n        add(s[i],1,1),add(s[i],i-1,2),add(s[i],n-i-1,3);\n    }\n\n    (ans+=(goal.a[1][7]%Mod*n%Mod*(n-1)%Mod*inv2%Mod*inv2%Mod))%=Mod;\n\n    printf(\"%lld\\n\",ans);\n\n    return 0;\n}\n```",
        "postTime": 1633679799,
        "uid": 81736,
        "name": "wsy_jim",
        "ccfLevel": 3,
        "title": "P4223 \u671f\u671b\u9006\u5e8f\u5bf9"
    }
]