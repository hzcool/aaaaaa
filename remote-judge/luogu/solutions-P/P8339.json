[
    {
        "content": "\u66b4\u529b\uff1a\u8d70 $u\\to v$ \u8def\u5f84\u65f6\uff0c\u9047\u5230\u4e00\u4e2a\u94a5\u5319\uff0c\u5c06\u5176\u538b\u5165\u5bf9\u5e94\u989c\u8272\u7684\u6808\uff0c\u9047\u5230\u4e00\u4e2a\u5b9d\u7bb1\uff0c\u5c06\u6808\u9876\u7684\u94a5\u5319\u548c\u5176\u5339\u914d\uff0c\u5f39\u51fa\u8fd9\u4e2a\u94a5\u5319\u3002\n\n\u7279\u6b8a\u6027\u8d28 A\uff1a\u8003\u8651\u4e00\u4e2a\u94a5\u5319 $x$ \u53ca\u5176\u5bf9\u5e94\u7684\u5b9d\u7bb1 $y$\uff0c\u4f1a\u5bf9\u6240\u6709\u5305\u542b $x\\to y$ \u7684\u8def\u5f84\uff08\u8fd9\u91cc\u7684\u5305\u542b\u8981\u6c42\u548c $x\\to y$ \u662f\u4e00\u4e2a\u65b9\u5411\uff09\uff0c\u90fd\u4f1a\u4ea7\u751f $1$ \u7684\u8d21\u732e\u3002\u90a3\u4e48\u8003\u8651\u5728 $dfn\\times dfn$ \u5e73\u9762\u4e0a\uff0c$(x,y)$ \u4ee3\u8868\u7684\u662f $x\\to y$ \u5bf9\u5e94\u7684\u7b54\u6848\uff0c\u6bcf\u4e00\u4e2a\u94a5\u5319\u53ca\u5176\u5b9d\u7bb1\u6240\u5bf9\u5e94\u7684\u8def\u5f84 $x\\to y$\uff0c\u6839\u636e $x,y$ \u662f\u5426\u4e3a\u7956\u5148\u5173\u7cfb\u7684\u4e0d\u540c\uff0c\u5305\u542b\u5176\u7684\u8def\u5f84\u662f\u5b50\u6811\u8865 $\\times$ \u5b50\u6811\u7684\u77e9\u5f62\uff0c\u6216\u8005\u5b50\u6811 $\\times$ \u5b50\u6811\u8865\u7684\u77e9\u5f62\uff0c\u6216\u8005\u5b50\u6811 $\\times$ \u5b50\u6811\u7684\u77e9\u5f62\u3002\u90a3\u4e48\u95ee\u9898\u5c31\u53d8\u6210\u4e86\u77e9\u5f62 $+1$\uff0c\u5355\u70b9\u6c42\u503c\u95ee\u9898\uff0c\u7528\u6811\u72b6\u6570\u7ec4\u626b\u63cf\u7ebf\u5373\u53ef\u3002\n\n\u6b63\u89e3\u8003\u8651\u501f\u9274\u4e0a\u9762\u4e24\u4e2a\u505a\u6cd5\u7684\u601d\u60f3\u3002\n\n\u8003\u8651\u4e00\u6b21\u66b4\u529b\u7684\u8d2a\u5fc3\u5339\u914d\u7684\u8fc7\u7a0b\uff0c\u4e00\u4e2a\u94a5\u5319\u548c\u54ea\u4e2a\u5b9d\u7bb1\u5339\u914d\uff0c\u548c\u8fd9\u4e2a\u94a5\u5319\u4e4b\u524d\u9047\u5230\u7684\u94a5\u5319\u4ee5\u53ca\u5b83\u4eec\u7684\u5339\u914d\u60c5\u51b5\u662f\u65e0\u5173\u7684\u3002\u6240\u4ee5\u5bf9\u6bcf\u4e2a\u94a5\u5319\u8003\u8651\uff0c\u5176\u8d2a\u5fc3\u5339\u914d\u8fc7\u7a0b\u4e2d\uff0c\u5f80\u5404\u4e2a\u65b9\u5411\u8d70\uff0c\u5339\u914d\u5230\u7684\u5b9d\u7bb1\u96c6\u5408\u662f\u4e00\u5b9a\u7684\u3002\n\n\u66b4\u529b\u627e\u51fa\u8fd9\u4e2a\u96c6\u5408\u7684\u8fc7\u7a0b\u5c31\u662f\uff0c\u4ee5\u8fd9\u4e2a\u94a5\u5319 $x$ \u4e3a\u6839 dfs\uff0c\u7ef4\u62a4\u4e00\u4e2a\u6808\uff0c\u53ea\u5b58\u4e0e\u6839\u989c\u8272\u76f8\u540c\u7684\u94a5\u5319\uff0c\u7136\u540e\u5339\u914d\u3002\u76f4\u5230\u6709\u5b9d\u7bb1 $y$ \u548c\u6839\u4ee3\u8868\u7684\u94a5\u5319\u5339\u914d\u6210\u529f\u4e86\uff0c\u90a3\u4e48 $x\\to y$ \u4f1a\u5bf9\u6240\u6709\u5305\u542b $x\\to y$ \u7684\u8def\u5f84\u4ea7\u751f\u4e00\u4e2a $1$ \u7684\u8d21\u732e\uff0c\u8fd9\u91cc\u7528\u7279\u6b8a\u6027\u8d28 A \u7684\u626b\u63cf\u7ebf\u89e3\u51b3\u5373\u53ef\u3002\n\n\u7531\u4e8e dfs \u7684\u8fc7\u7a0b\u4e2d\u53ea\u548c\u540c\u4e00\u989c\u8272\u6709\u5173\uff0c\u6240\u4ee5\u628a\u540c\u4e00\u989c\u8272\u7684\u62c9\u51fa\u6765\uff0c\u5728\u865a\u6811\u4e0a dfs \u627e\u5b9d\u7bb1\u5373\u53ef\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(n\\log n)$\uff0e\n\n```cpp\n#include<cstdio>\n#include<vector>\n#include<cstring>\n#include<iostream>\n#include<algorithm>\n#include<ctime>\n#define pb emplace_back\n#define mp std::make_pair\n#define fi first\n#define se second\n#define dbg(x) cerr<<\"In Line \"<< __LINE__<<\" the \"<<#x<<\" = \"<<x<<'\\n';\n#define dpi(x,y) cerr<<\"In Line \"<<__LINE__<<\" the \"<<#x<<\" = \"<<x<<\" ; \"<<\"the \"<<#y<<\" = \"<<y<<'\\n';\nusing namespace std;\ntypedef long long ll;\ntypedef unsigned long long ull;\ntypedef pair<int,int>pii;\ntypedef pair<ll,int>pli;\ntypedef pair<ll,ll>pll;\ntypedef vector<int>vi;\ntypedef vector<ll>vll;\ntypedef vector<pii>vpii;\ntemplate<typename T>T cmax(T &x, T y){return x=x>y?x:y;}\ntemplate<typename T>T cmin(T &x, T y){return x=x<y?x:y;}\n#define getchar()(p1==p2&&(p2=(p1=buf)+fread(buf,1,1<<21,stdin),p1==p2)?EOF:*p1++)\nchar buf[1<<21],*p1=buf,*p2=buf;\ntemplate<typename T>\nT &read(T &r){\n\tr=0;bool w=0;char ch=getchar();\n\twhile(ch<'0'||ch>'9')w=ch=='-'?1:0,ch=getchar();\n\twhile(ch>='0'&&ch<='9')r=r*10+(ch^48),ch=getchar();\n\treturn r=w?-r:r;\n}\ntemplate<typename T1,typename... T2>\nvoid read(T1 &x, T2& ...y){ read(x); read(y...); }\ninline int lowbit(int x){return x&(-x);}\nconst int N=1000010;\nint n,m,ct[N];\nint t[N],c[N];\nint ctc[N][3];\nint fa[N],dep[N];\nvi eg[N];\nnamespace ac{\n\tint dfn[N],ofn[N],fi[N],ed[N],oft,dft,dep[N],fa[N][21],lg[N],siz[N];\n\tint st[21][N],nowc;\n\tint top,stk[N];\n\tvi vec[N],et[N];\n\tvoid dfs1(int x,int f){\n\t\tfa[x][0]=f;dep[x]=dep[f]+1;siz[x]=1;\n\t\tdfn[x]=++dft;fi[x]=++oft;ofn[oft]=x;\n\t\tfor(int i=1;i<=20;i++)fa[x][i]=fa[fa[x][i-1]][i-1];\n\t\tfor(auto v:eg[x])if(v!=f){\n\t\t\tdfs1(v,x);\n\t\t\tsiz[x]+=siz[v];\n\t\t\ted[v]=++oft;\n\t\t\tofn[oft]=x;\n\t\t}\n\t}\n\tint LCA(int x,int y){\n\t\tx=fi[x];y=fi[y];\n\t\tint l=min(x,y),r=max(x,y);\n\t\tint k=lg[r-l+1];\n\t\treturn dep[st[k][l]]<dep[st[k][r-(1<<k)+1]] ? st[k][l] : st[k][r-(1<<k)+1];\n\t}\n\tvoid merge(int x,int y){\n\t\tet[x].pb(y);et[y].pb(x);\n\t}\n\tint Findsbt(int x,int y){\n\t\tfor(int i=20;~i;i--)\n\t\t\tif(dep[fa[y][i]]>dep[x])\n\t\t\t\ty=fa[y][i];\n\t\treturn y;\n\t}\n\tint lct;\n\tstruct Line{\n\t\tint l,r,h,v;\n\t}li[N*10];\n\tstruct Que{\n\t\tint x,y,i;\n\t}q[N];\n\tint ans[N];\n\tint tree[N];\n\tvoid modify(int x,int v){\n\t\tfor(;x<=n;x+=lowbit(x))tree[x]+=v;\n\t}\n\tvoid modify(int l,int r,int v){\n\t\tmodify(l,v);\n\t\tif(r<n)modify(r+1,-v);\n\t}\n\tint query(int x){\n\t\tint s=0;\n\t\tfor(;x;x-=lowbit(x))s+=tree[x];\n\t\treturn s;\n\t}\n\tvoid Push(int l1,int r1,int l2,int r2){\n\t\tif(l1>r1||l2>r2)return ;\n//\t\tcout << l1 << ' ' << r1 << ' ' << l2 << ' ' << r2 << '\\n';\n\t\tli[++lct]={l2,r2,l1,1};\n\t\tif(r1<n)li[++lct]={l2,r2,r1+1,-1};\n\t}\n\tvoid dfs2(int x,int f,int h,int aci){\n\t\tif(x!=aci&&c[x]==nowc){\n\t\t\tif(t[x]==1)++h;\n\t\t\telse{\n\t\t\t\tif(!h){\n\t\t\t\t\tif(fi[aci]<=fi[x]&&ed[x]<=ed[aci]){\n\t\t\t\t\t\tint y=Findsbt(aci,x);\n\t\t\t\t\t\tint l=dfn[x],r=dfn[x]+siz[x]-1;\n\t\t\t\t\t\tPush(1,dfn[y]-1,l,r);\n\t\t\t\t\t\tPush(dfn[y]+siz[y],n,l,r);\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\tif(fi[x]<=fi[aci]&&ed[aci]<=ed[x]){\n\t\t\t\t\t\t\tswap(x,aci);\n\t\t\t\t\t\t\tint y=Findsbt(aci,x);\n\t\t\t\t\t\t\tint l=dfn[x],r=dfn[x]+siz[x]-1;\n\t\t\t\t\t\t\tPush(l,r,1,dfn[y]-1);\n\t\t\t\t\t\t\tPush(l,r,dfn[y]+siz[y],n);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse{\n\t\t\t\t\t\t\tPush(dfn[aci],dfn[aci]+siz[aci]-1,dfn[x],dfn[x]+siz[x]-1);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn ;\n\t\t\t\t}\n\t\t\t\t--h;\n\t\t\t}\n\t\t}\n\t\tfor(auto v:et[x])if(v!=f){\n\t\t\tdfs2(v,x,h,aci);\n\t\t}\n\t}\n\tvoid init(){\n\t\tdfs1(1,0);\n\t\ted[1]=++oft;ofn[oft]=1;\n\t\tfor(int i=1;i<=oft;i++)st[0][i]=ofn[i];\n\t\tfor(int i=2;i<=oft;i++)lg[i]=lg[i>>1]+1;\n\t\tfor(int i=1;i<=20;i++)\n\t\t\tfor(int j=1;j+(1<<i)-1<=oft;j++)\n\t\t\t\tst[i][j]=dep[st[i-1][j]]<dep[st[i-1][j+(1<<(i-1))]] ? st[i-1][j] : st[i-1][j+(1<<(i-1))];\n\t\tfor(int i=1;i<=m;i++){\n\t\t\tint x,y;read(x,y);\n\t\t\tq[i]={dfn[x],dfn[y],i};\n\t\t}\n\t}\n\tvoid JiTangLaiLe(){\n\t\tfor(int i=1;i<=n;i++)vec[c[i]].pb(i);\n\t\tfor(int o=1;o<=n;o++){\n\t\t\tnowc=o;\n\t\t\tstk[top=1]=1;\n\t\t\tsort(vec[o].begin(),vec[o].end(),[](const int &x,const int &y){return dfn[x]<dfn[y];});\n\t\t\tvi po;\n\t\t\tfor(auto x:vec[o]){\n\t\t\t\tif(x==1)continue;\n\t\t\t\tint t=LCA(x,stk[top]);\n\t\t\t\twhile(top>1&&dep[t]<dep[stk[top-1]]){\n\t\t\t\t\tmerge(stk[top-1],stk[top]);\n\t\t\t\t\tpo.pb(stk[top]);--top;\n\t\t\t\t\tt=LCA(x,stk[top]);\n\t\t\t\t}\n\t\t\t\tif(dep[t]<dep[stk[top]]){\n\t\t\t\t\tmerge(t,stk[top]);\n\t\t\t\t\tpo.pb(stk[top]);--top;\n\t\t\t\t\tif(t!=stk[top])stk[++top]=t;\n\t\t\t\t\tstk[++top]=x;\n\t\t\t\t}\n\t\t\t\telse stk[++top]=x;\n\t\t\t}\n\t\t\twhile(top>1){\n\t\t\t\tmerge(stk[top],stk[top-1]);\n\t\t\t\tpo.pb(stk[top]);--top;\n\t\t\t}\n\t\t\tpo.pb(1);\n\t\t\tfor(auto x:vec[o]){\n\t\t\t\tif(t[x]==1){\n\t\t\t\t\tdfs2(x,0,0,x);\n\t\t\t\t}\n\t\t\t}\n\t\t\tfor(auto x:po){\n\t\t\t\tvi().swap(et[x]);\n\t\t\t}\n\t\t}\t\t\n\t}\n\tvoid Sao(){\n\t\tsort(li+1,li+lct+1,[](const Line &x,const Line &y){return x.h<y.h;});\n\t\tsort(q+1,q+m+1,[](const Que &x,const Que &y){return x.x<y.x;});\n\t\tint pos=1;\n\t\tfor(int i=1;i<=m;i++){\n\t\t\twhile(pos<=lct&&li[pos].h<=q[i].x){\n\t\t\t\tmodify(li[pos].l,li[pos].r,li[pos].v);\n\t\t\t\t++pos;\n\t\t\t}\n\t\t\tans[q[i].i]=query(q[i].y);\n\t\t}\n\t}\n\tvoid main(){\n\t\tinit();\n\t\tJiTangLaiLe();\n\t\tSao();\n\t\tfor(int i=1;i<=m;i++)cout << ans[i] << '\\n';\n\t}\n}\nsigned main(){\n\tread(n,m);\n\tfor(int i=1;i<=n;i++){\n\t\tread(t[i],c[i]);\n\t\tctc[c[i]][t[i]]++;\n\t}\n\tfor(int i=1;i<n;i++){\n\t\tint x,y;read(x,y);\n\t\teg[x].pb(y);eg[y].pb(x);\n\t}\n\tac::main();\n    #ifdef do_while_true\n\t\tcerr<<'\\n'<<\"Time:\"<<clock()<<\" ms\"<<'\\n';\n\t#endif\n\treturn 0;\n}\n```",
        "postTime": 1652268251,
        "uid": 223298,
        "name": "do_while_true",
        "ccfLevel": 8,
        "title": "\u300c\u9898\u89e3\u300d\u6d1b\u8c37 P8339 [AHOI2022] \u94a5\u5319"
    },
    {
        "content": "\u8fd9\u91cc\u79f0 $1$ \u662f\u94a5\u5319\uff0c$2$ \u662f\u5b9d\u7bb1\u3002\n\n\u8003\u8651\u5fc5\u987b\u7528\u5230\u6700\u591a $5$ \u4e2a $1$ \u8fd9\u4e2a\u4fe1\u606f\uff0c\u4e00\u4e2a\u5927\u6982\u6846\u67b6\u662f\uff0c\u4f60\u53ef\u4ee5\u9884\u5148\u5bf9\u4e8e\u6bcf\u4e2a $2$\uff0c\u679a\u4e3e\u6240\u6709\u53ef\u80fd\u7684 $1$\uff0c\u7136\u540e\u8003\u8651\u4f55\u79cd\u8def\u5f84\u53ef\u4ee5\u88ab\u8fd9\u5bf9\u8d21\u732e\u5230\u3002\n\n\u8003\u8651\u5bf9\u4e8e\u6bcf\u4e2a\u989c\u8272\u5355\u72ec\u8003\u8651\uff0c\u5047\u8bbe\u4e00\u6b21\u7ecf\u8fc7\u7684\u957f\u8fd9\u6837 $11222112$\u3002\u8003\u8651\u628a $+1$ \u7684\u8d21\u732e\u8bb0\u5728 $(1, 4)$ \uff08\u8868\u793a\u7b2c\u4e00\u4f4d\u548c\u7b2c\u56db\u4f4d\uff09\uff0c$(2, 3)\uff0c(7, 8)$\uff0c\u8fd9\u6837\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u53ef\u4ee5\u628a $1$ \u770b\u6210\u5de6\u62ec\u53f7\uff0c$2$ \u770b\u6210\u53f3\u62ec\u53f7\uff0c\u505a\u62ec\u53f7\u5339\u914d\u7684\u8fc7\u7a0b\u3002\n\n\u90a3\u8fd9\u6837\u8003\u8651\u679a\u4e3e\u8fd9\u6837\u7684 $1, 2$ \u70b9\u5bf9\uff0c\u4ed6\u80fd\u4ea7\u751f\u8d21\u732e\u7684\u5145\u8981\u6761\u4ef6\u662f\uff1a\n\n* \u5b83\u5728\u8be2\u95ee\u8def\u5f84\u4e0a\n* \u4e2d\u95f4\u90e8\u5206\u662f\u6b63\u597d\u62ec\u53f7\u5339\u914d\u7684\uff1a\uff08\u5c06 $1$ \u770b\u505a $1$\uff0c$2$ \u770b\u505a $-1$\uff0c\u524d\u7f00\u548c $\\ge 0$\uff0c\u5e76\u4e14\u548c $= 0$\uff09\n\n\u8fd9\u6837\u8bbe\u8ba1\u7684\u8d21\u732e\u662f\u597d\u7684\uff0c\u56e0\u4e3a\u5df2\u7ecf\u8ba9\u4e92\u76f8\u5339\u914d\u7684\u5c3d\u53ef\u80fd\u8fdb\uff0c\u800c\u4e14\u4e0d\u91cd\u4e0d\u6f0f\u3002\n\n\u5728\u8def\u5f84\u4e0a\u7684\u9650\u5236\u53ef\u4ee5\u901a\u8fc7\u662f\u5426\u662f\u7956\u5148\u5f62\u5f0f\u5206\u8ba8\u53d8\u4e3a\u8be2\u95ee $s, e$ \u8981\u5206\u522b\u5728 $dfn$ \u7684\u4e00\u4e2a\u533a\u95f4\u8fd9\u79cd\u5f62\u5f0f\uff0c\u5c31\u662f\u6240\u6709\u77e9\u5f62\u52a0\uff0c\u6700\u540e\u5355\u70b9\u67e5\uff0c\u90a3\u4e48\u79bb\u7ebf\u5dee\u5206\u4e0b\u6765\u6811\u72b6\u6570\u7ec4\u5c31\u597d\u4e86\u3002\n\n\u679a\u4e3e $1, 2$ \u70b9\u5bf9\u7684\u8fc7\u7a0b\u6bd4\u8f83\u597d\u7684\u5b9e\u73b0\u65b9\u5f0f\u662f\uff0c\u5efa\u865a\u6811\uff0c\u7136\u540e dfs\uff1f\uff08\u6211\u80fd\u60f3\u5230\u7684\uff1f\n\n$O(5 n \\log n + m\\log n)$\n\n```cpp\n// Skyqwq\n#include <bits/stdc++.h>\n\nusing namespace std;\n\n#define fi first\n#define se second\n#define pb push_back\n#define mp make_pair\n\ntypedef long long LL;\ntypedef pair<int, int> PII;\n\ntemplate <typename T> void inline read(T &x) {\n\tx = 0; char s = getchar(); int f = 1;\n\twhile (s < '0' || s > '9') { if (s == '-') { f = -1; } s = getchar(); }\n\twhile (s <= '9' && s >= '0') x = x * 10 + (s ^ 48), s = getchar();\n\tx *= f;\n}\n\ntemplate <typename T> bool inline chkMax(T &x, T y) { return y > x ? x = y, 1 : 0; }\ntemplate <typename T> bool inline chkMin(T &x, T y) { return y < x ? x = y, 1 : 0; }\n\nconst int N = 5e5 + 5, M = 1e6 + 5;\n\nint n, m, T[N], C[N], tp[N], dfn[N], dfncnt, sz[N], fa[N], son[N], d[N], pre[N];\n\nvector<int> g[N];\n\nvoid dfs1(int u) {\n\tsz[u] = 1;\n\tfor (int v: g[u]) {\n\t\tif (v == fa[u]) continue;\n\t\tfa[v] = u;\n\t\td[v] = d[u] + 1;\n\t\tdfs1(v);\n\t\tsz[u] += sz[v];\n\t\tif (sz[v] > sz[son[u]]) son[u] = v;\n\t}\n}\n\nvoid dfs2(int u, int top) {\n\ttp[u] = top, dfn[u] = ++dfncnt;\n\tpre[dfn[u]] = u;\n\tif (son[u]) dfs2(son[u], top);\n\tfor (int v: g[u]) {\n\t\tif (v == fa[u] || v == son[u]) continue;\n\t\tdfs2(v, v);\n\t}\n}\n\nint inline lca(int x, int y) {\n\twhile (tp[x] != tp[y]) {\n\t\tif (d[tp[x]] < d[tp[y]]) swap(x, y);\n\t\tx = fa[tp[x]];\n\t}\n\treturn d[x] < d[y] ? x : y;\n}\n\nvector<int> b[N];\n\nint inline cmp(int x, int y) {\n\treturn dfn[x] < dfn[y];\n}\n\nint s[N], top, ans[M];\n\nvector<int> e[N];\n\nvoid inline addE(int x, int y) {\n\t//cout << x << \" \" << y << \" bd?\\n\";\n\te[x].pb(y), e[y].pb(x);\n}\n\nvector<int> z;\n\nvoid inline ins(int x) {\n\tz.pb(x);\n\tif (!top)  { s[++top] = x; return; }\n\tint p = lca(s[top], x);\n\twhile (top > 1 && d[s[top - 1]] >= d[p]) {\n\t\taddE(s[top - 1], s[top]);\n\t\ttop--;\n\t}\n\tif (s[top] != p) {\n\t\taddE(s[top], p);\n\t\ts[top] = p;\n\t\tz.pb(p);\n\t}\n\ts[++top] = x;\n}\n\nint S, nc;\n\n// x is y ancestor?\n\nint inline isA(int x, int y) {\n\treturn dfn[x] <= dfn[y] && dfn[y] < dfn[x] + sz[x];\n}\n\n// x -> y subpath cont.\n\nint jp(int x, int y) {\n\tint la = 0;\n\twhile (tp[y] != tp[x])\n\t\tla = tp[x], x = fa[tp[x]];\n\tif (x == y) return la;\n\treturn pre[dfn[y] + 1];\n}\n\n// dfn[s] in [A, B], dfn[e] in [C, D]: +1\n\nvector<PII> t[N];\n\nvoid inline join(int A, int B, int C, int D) {\n\tif (A > B || C > D) return;\n\tt[A].pb(mp(C, 1));\n\tt[A].pb(mp(D + 1, -1));\n\tt[B + 1].pb(mp(C, -1));\n\tt[B + 1].pb(mp(D + 1, 1));\n}\n\nvoid inline insert(int x, int y) {\n\tif (isA(x, y)) {\n\t\tint z = jp(y, x);\n\t\tjoin(1, dfn[z] - 1, dfn[y], dfn[y] + sz[y] - 1);\n\t\tjoin(dfn[z] + sz[z], n, dfn[y], dfn[y] + sz[y] - 1);\n\t} else if (isA(y, x)) {\n\t\tint z = jp(x, y);\n\t\tjoin(dfn[x], dfn[x] + sz[x] - 1, 1, dfn[z] - 1);\n\t\tjoin(dfn[x], dfn[x] + sz[x] - 1, dfn[z] + sz[z], n);\n\t} else {\n\t\tjoin(dfn[x], dfn[x] + sz[x] - 1, dfn[y], dfn[y] + sz[y] - 1);\n\t}\n}\n\nvoid dfs(int u, int la, int w) {\n\tif (w < 0) return;\n\tfor (int v: e[u]) {\n\t\tif (v == la) continue;\n\t\tif (!w && C[v] == nc && T[v] == 2) {\n\t\t\tinsert(S, v);\n\t\t\tcontinue ;\n\t\t}\n\t\tint nv = 0;\n\t\tif (C[v] == nc) {\n\t\t\tif (T[v] == 2) nv--;\n\t\t\telse nv++;\n\t\t}\n\t\tdfs(v, u, w + nv);\n\t}\n}\n\nvector<PII> a[N];\n\nint c[N];\n\nvoid inline add(int x, int y) {\n\tfor (; x <= n; x += x & -x) c[x] += y;\n}\n\nint inline ask(int x) {\n\tint ret = 0;\n\tfor (; x; x -= x & -x) ret += c[x];\n\treturn ret;\n}\n\nint main() {\n//\tfreopen(\"keys.in\", \"r\", stdin);\n//\tfreopen(\"keys.out\", \"w\", stdout);\n\tread(n), read(m);\n\tfor (int i = 1; i <= n; i++) read(T[i]), read(C[i]), b[C[i]].pb(i);\n\tfor (int i = 1, u, v; i < n; i++) {\n\t\tread(u), read(v);\n\t\tg[u].pb(v), g[v].pb(u);\n\t}\t\n\tdfs1(1);\n\tdfs2(1, 1);\n\tfor (int i = 1; i <= n; i++) {\n\t\tif (!b[i].size()) continue;\n\t\tnc = i;\n\t\tsort(b[i].begin(), b[i].end(), cmp);\n\t\tfor (int v: b[i]) ins(v);\n\t\twhile (top > 1) addE(s[top - 1], s[top]), --top;\n\n\t\tfor (int v: b[i])\n\t\t\tif (C[v] == i && T[v] == 1)\n\t\t\t\tS = v, dfs(v, 0, 0);\n\n\t\tfor (int v: z) e[v].clear();\n\t\tz.clear();\n\t\ttop = 0;\n\t}\n\tfor (int i = 1; i <= m; i++) {\n\t\tint u, v; read(u), read(v);\n\t\ta[dfn[u]].pb(mp(dfn[v], i));\n\t}\n\tfor (int i = 1; i <= n; i++) {\n\t\tfor (PII o: t[i])\n\t\t\tadd(o.fi, o.se);\n\t\tfor (PII o: a[i])\n\t\t\tans[o.se] = ask(o.fi);\n\t}\n\tfor (int i = 1; i <= m; i++) printf(\"%d\\n\", ans[i]);\n}\n```\n",
        "postTime": 1652151749,
        "uid": 161687,
        "name": "Remake",
        "ccfLevel": 0,
        "title": "P8339 [AHOI2022] \u94a5\u5319"
    },
    {
        "content": "\u6821\u5185 pkusc \u6a21\u62df\u4e00\u4e2a\u5c0f\u65f6\u60f3\u5230\u4e86\u6b63\u89e3\uff0c\u4e24\u4e2a\u5c0f\u65f6\u6ca1\u8c03\u51fa\u6765\uff0c\u4e0b\u5348\u8c03\u51fa\u6765\u4e86\uff0c\u505a\u4e00\u4e9b\u53cd\u601d\u3002\n\n1. \u4e0a\u6b21\u5199\u865a\u6811\u5df2\u7ecf\u8fc7\u53bb\u5f88\u4e45\u4e86\uff0c\u5341\u5206\u751f\u758f\uff0c\u51fa\u4e86\u8bb8\u591a\u6bdb\u75c5\uff0c\u6240\u4ee5\u8981\u7ecf\u5e38\u7ec3\u4e60\u5e38\u7528\u7b97\u6cd5\uff1b\n2. \u60f3\u5230\u6b63\u89e3\u76f4\u63a5\u5199\uff0c\u9ad8\u4f30\u4e86\u81ea\u5df1\u7684\u7801\u529b\u548c\u5b9e\u529b\uff08\u4e00\u5e74\u524d\uff0c\u6211\u8fd8\u53ea\u4f1a\u57fa\u7840\u8bed\u8a00\uff09\uff1b\n3. \u6ca1\u6709\u5148\u5199\u66b4\u529b\uff0c\u65e0\u8bba\u662f\u4e3a\u4e86\u5f97\u5206\u8fd8\u662f\u5bf9\u62cd\uff0c\u90fd\u5e94\u5f53\u5199\u4e00\u4e2a\u66b4\u529b\uff0c\u8fd9\u5e76\u4e0d\u9700\u8981\u5f88\u591a\u65f6\u95f4\uff08\u4e0b\u5348\u5199\u66b4\u529b\u5bf9\u62cd\u53ea\u7528\u4e86\u5341\u5206\u949f\uff09\u3002\n\n**\u4ee5\u4e0b\u662f\u89e3\u9898\u65b9\u6cd5**\n\n\u8003\u8651\u4f7f\u7528\u5c31\u8fd1\u539f\u5219\u5c06\u94a5\u5319\u4e0e\u7bb1\u5b50\u914d\u5bf9\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u79cd\u989c\u8272\uff0c\u53ef\u4ee5\u5c06\u94a5\u5319\u548c\u7bb1\u5b50\u5efa\u865a\u6811\uff0c\u4ece\u6bcf\u4e2a\u94a5\u5319\u51fa\u53d1\u6df1\u641c\uff0c\u627e\u5230\u6240\u6709\u4e0e\u81ea\u5df1\u914d\u5bf9\u7684\u7bb1\u5b50\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log_2n+kn)$ \u6b64\u9898\u4e2d $k\\le5$\uff0c\u53ef\u4ee5\u63a5\u53d7\u3002\n\n\u4e8e\u662f\u4efb\u610f\u4e00\u6761\u8def\u5f84\u53ea\u8981\u8986\u76d6\u4e86\u4e00\u7ec4\u914d\u5bf9\u7684\u94a5\u5319\u548c\u7bb1\u5b50\uff0c\u5c31\u53ef\u4ee5\u5f97\u5230\u4e00\u4e2a\u91d1\u5e01\u3002\u95ee\u9898\u8f6c\u6362\u4e3a\u7ed9\u5b9a\u591a\u6761\u539f\u8def\u5f84\uff08\u4ece\u94a5\u5319\u5230\u7bb1\u5b50\uff09\uff0c\u4ee5\u53ca\u591a\u6b21\u8be2\u95ee\u4e00\u6761\u8def\u5f84\uff0c\u95ee\u8986\u76d6\u4e86\u591a\u5c11\u6761\u539f\u8def\u5f84\u3002\n\n\u5bf9\u4e8e\u539f\u8def\u5f84\u5206\u4e09\u79cd\u60c5\u51b5\u8ba8\u8bba\uff1a\n\n1. $lca=s$\uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/lqpbd0if.png)\n\n\u8fd9\u65f6\u5019\u7b49\u4ef7\u4e8e\u4e00\u6761\u8d77\u70b9\u4e0d\u5728 $S_x$ \u800c\u7ec8\u70b9\u5728 $S_e$ \u7684\u8def\u5f84\uff1b\n\n2. $lca=e$\uff1a\u4e0e\u4e0a\u7c7b\u4f3c\uff1b\n3. $lca\\ne s,lca\\ne e$\uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/vcbx43rh.png)\n\n\u8fd9\u65f6\u5019\u7b49\u4ef7\u4e8e\u4e00\u6761\u8d77\u70b9\u5728 $S_s$ \u4e14\u7ec8\u70b9\u5728 $S_e$ \u7684\u8def\u5f84\u3002\n\n\u662f\u5426\u5728\u5b50\u6811\u5185\u53ef\u4ee5\u7528 $dfn$ \u8f6c\u5316\u4e3a\u4e0d\u7b49\u5f0f\uff0c\u95ee\u9898\u8f6c\u5316\u6210\u4e86\u9759\u6001\u4e8c\u7ef4\u6570\u70b9\u3002\n\n$\\text{K-D Tree}$\uff1f\u4e0d\u6015\u70b8\u5c31\u8bd5\u8bd5\uff01$O(n\\sqrt{m})$ \u600e\u4e48\u53ef\u80fd\u901a\u8fc7\uff01\n\n\u4e0d\u8fc7\u7531\u4e8e\u662f\u9759\u6001\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u5b66\u4e60 $\\text{CDQ}$ \u5206\u6cbb\u89e3\u51b3\u4e09\u7ef4\u504f\u5e8f\u7684\u601d\u8def\uff0c\u6392\u5e8f\u540e\u79bb\u7ebf\u6389\u4e00\u7ef4\uff0c\u4e8e\u662f\u5c31\u5c06\u5176\u8f6c\u6362\u4e3a\u52a8\u6001\u4e00\u7ef4\u6570\u70b9\u4e86\uff0c\u4f7f\u7528\u6811\u72b6\u6570\u7ec4\u5373\u53ef\u89e3\u51b3\u3002\u603b\u65f6\u95f4\u590d\u6742\u5ea6 $O(kn+(n+m)\\log_2n)$\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nconst int N=2e6+6,M=998244353;\n#define ST static\n#define stl static inline\nstl char gc(){\n    ST char bf[N+5];\n    ST int it,ed;\n    return (it==ed&&(ed=(it=0)+fread(bf,1,N,stdin),it==ed))?EOF:bf[it++];\n}\ntemplate<typename _Tp>\nstl void read(_Tp &x){\n    char c,f=0;for(c=gc();c<48;c=gc())if(c=='-')f=!f;\n    for(x=0;c>47;x=x*10+(48^c),c=gc());if(f)x=-x;\n}\ntemplate<typename _Tp,typename..._tps>\nstl void read(_Tp &x,_tps&...y){\n    read(x),read(y...);\n}\nusing ll=long long;\nusing ul=unsigned long long;\nusing pr=pair<int,int>;\nint tp[N],cl[N],n,m,dfn[N],rev[N],dlt,f[N],ncl,nrt,qn[N];\nvector<int>lk[N],had[N],gt,bf,rg[N];\nvoid dfs(int x=1){\n    rev[dfn[x]=++dlt]=x;\n    for(int y:lk[x])\n        if(y!=f[x])f[y]=x,dfs(y);\n    rev[dfn[x+n]=++dlt]=x+n;\n    // printf(\"%d %d %d\\n\",x,dfn[x],dfn[x+n]);\n}\nstl bool cmpD(const int &x,const int &y){return dfn[x]<dfn[y];}\nstruct CG{int s,e,d;CG(){};CG(int a,int b,int c){\n    // cout<<a<<\" \"<<b<<\" \"<<c<<endl;\n    s=a,e=b,d=c;}\ninline bool operator<(const CG &z)\nconst{return s<z.s;}}q[N];\nstl bool cmpC(const int &x,const int &y){return q[x].s<q[y].s;}\nvector<CG>qc;\n#define qp qc.emplace_back\nnamespace lct{\n    int t[N][2],f[N];\n    #define Tp(x) (t[f[x]][1]==x)\n    #define In(x) (t[f[x]][Tp(x)]==x)\n    #define ls t[x][0]\n    #define rs t[x][1]\n    stl void rot(int x){\n        int y=f[x],k=Tp(x),w=t[x][!k];\n        f[t[y][k]=w]=t[x][!k]=y;if(In(y))t[f[y]][Tp(y)]=x;\n        f[x]=f[y],f[y]=x;\n    }\n    stl void splay(int x){\n        for(int y=f[x];In(x);rot(x),y=f[x])\n            if(In(y))rot(Tp(x)^Tp(y)?x:y);\n    }\n    stl int access(int x){\n        int y=0;while(x){\n            splay(x),rs=y,x=f[y=x];\n        }return y;\n    }\n    stl int lca(int x,int y){return access(x),access(y);}\n    stl int fmin(int x){splay(x);while(ls)x=ls;splay(x);return x;}\n    stl void solve(int s,int e){\n        int x,y,z=lca(s,e);\n        // cout<<\"solve:\"<<s<<\" \"<<e<<\" \"<<z<<endl;\n        if(z==s){\n            splay(s),t[s][1]=0,x=fmin(e);\n            // cout<<\"lead:\"<<x<<endl;\n            qp(dfn[x]-1,dfn[e+n],1),qp(dfn[x+n],dfn[e+n],-1),qp(dfn[n+1],dfn[e+n],1);\n            qp(dfn[x]-1,dfn[e]-1,-1),qp(dfn[x+n],dfn[e]-1,1),qp(dfn[n+1],dfn[e]-1,-1);\n        }else if(z==e){\n            splay(e),t[e][1]=0,x=fmin(s);\n            // cout<<\"lead:\"<<x<<endl;\n            qp(dfn[s+n],dfn[x]-1,1),qp(dfn[s+n],dfn[x+n],-1),qp(dfn[s+n],dfn[n+1],1);\n            qp(dfn[s]-1,dfn[x]-1,-1),qp(dfn[s]-1,dfn[x+n],1),qp(dfn[s]-1,dfn[n+1],-1);\n        }else{\n            qp(dfn[s+n],dfn[e+n],1),qp(dfn[s+n],dfn[e]-1,-1);\n            qp(dfn[s]-1,dfn[e+n],-1),qp(dfn[s]-1,dfn[e]-1,1);\n        }\n    }\n}\nusing lct::lca;\nvoid dfs2(int x,int pre,int nw){\n    // cout<<x<<\" pre \"<<pre<<\" \"<<nw<<endl;\n    if(tp[x]==1)nw+=(cl[x]==ncl);\n    else if(cl[x]==ncl)if(!--nw){lct::solve(nrt,x);return;}\n    for(int y:rg[x])if(y!=pre)dfs2(y,x,nw);\n}\nbitset<N>vs;\nint ct[N],n2;\nvoid cg(int x,int d){\n    // cout<<\"cg:\"<<x<<\" d:\"<<d<<endl;\n    for(;x>0;x-=x&-x)ct[x]+=d;\n}\nint qry(int x){\n    // cout<<\"qry:\"<<x<<endl;\n    int d=0;for(;x<=n2;x+=x&-x)d+=ct[x];\n    // cout<<\" res::\"<<d<<endl;\n    return d;\n}\nint main(){\n    freopen(\"keys.in\",\"r\",stdin);\n    freopen(\"keys.out\",\"w\",stdout);\n    read(n,m);int i,x,y,sz,p;n2=n<<1;\n    for(x=1;x<=n;read(tp[x],cl[x]),had[cl[x]].push_back(x),++x);\n    for(i=1;i<n;++i){\n        read(x,y);lk[x].push_back(y);\n        lk[y].push_back(x);\n    }\n    dfs();for(x=1;x<=n;++x)lct::f[x]=f[x];\n    for(i=1;i<=m;++i){\n        read(q[i].s,q[i].e);\n        qn[i]=i,q[i].s=dfn[q[i].s],q[i].e=dfn[q[i].e];\n    }\n    for(p=1;p<=n;++p)\n        if(sz=had[p].size()){\n            // printf(\"color:%d\\n\",p);\n            sort(had[p].begin(),had[p].end(),cmpD);\n            gt=had[p],bf.clear();\n            // for(int x:gt)printf(\"had:%d\\n\",x);\n            for(i=1;i<sz;++i)\n                gt.push_back(lca(had[p][i-1],had[p][i]));\n            for(int x:gt)bf.push_back(x);\n            for(int x:bf)gt.push_back(x+n);\n            sort(gt.begin(),gt.end(),cmpD),bf.clear();\n            unique(gt.begin(),gt.end());\n            for(int x:gt){if(x<=n)rg[x].clear();vs[x]=1;}\n            for(i=0,sz=gt.size();i<sz;++i){\n                if(!vs[x=gt[i]])continue;\n                else vs[x]=0;//printf(\"vt:%d\\n\",x);\n                if(x<=n)bf.push_back(x);\n                else{\n                    while(bf.size()&&dfn[y=bf.back()]>dfn[x-n]){\n                        rg[x-n].push_back(y),rg[y].push_back(x-n);\n                        // printf(\"link:%d %d\\n\",x-n,y);\n                        bf.pop_back();\n                    }\n                }\n            }ncl=p;for(int x:gt)vs[x]=1;\n            for(int x:gt)\n                if(vs[x]){\n                    vs[x]=0;\n                    if(x<=n&&cl[x]==p&&tp[x]==1)dfs2(nrt=x,0,0);\n                }\n                \n        }\n    int t1=1,t2=0;sort(qc.begin(),qc.end());\n    sort(qn+1,qn+m+1,cmpC);\n    for(p=0;p<=n2;++p){\n        while(t1<=m&&q[qn[t1]].s==p)\n            q[qn[t1]].d=qry(q[qn[t1]].e),++t1;\n        while(t2<qc.size()&&qc[t2].s==p)\n            cg(qc[t2].e,qc[t2].d),++t2;\n    }\n    for(x=1;x<=m;++x)\n        printf(\"%d\\n\",qry(q[x].e)-q[x].d);\n    return 0;\n}\n```",
        "postTime": 1652514028,
        "uid": 502410,
        "name": "EnofTaiPeople",
        "ccfLevel": 0,
        "title": "\u865a\u6811\uff0c\u9759\u6001\u4e8c\u7ef4\u6570\u70b9\u4ee5\u53ca\u4e00\u4e9b\u53cd\u601d"
    },
    {
        "content": "\u6458\u81ea\u6211\u7684\u535a\u5ba2\u6587\u7ae0\uff1a[\u94a5\u5319\u9898\u4e13\u9879\u8bad\u7ec3](https://www.luogu.com.cn/blog/666666new/keys-tm)\u3002\n\n\u8fd9\u4e2a\u5b89\u5fbd\u7684\u5e08\u5085\u4e9b\u51fa\u7684\u9898\u90a3\u662f\u76f8\u5f53\u7684\u89c4\u8303\uff01\u975e\u5e38\u73cd\u8d35\u7684\u65e2\u6709\u601d\u7ef4\u96be\u5ea6\u53c8\u6709\u4ee3\u7801\u96be\u5ea6\u7684\u9ad8\u8d28\u91cf\u597d\u9898\uff01\n\n### \u9898\u610f\n\n\u4e00\u4e2a\u76f8\u5f53\u7ecf\u5178\u7684\u94a5\u5319-\u9501\u6a21\u578b\uff1a\u7ed9\u5b9a\u4e00\u4e2a\u6811\u5f62\u7ed3\u6784\u7684\u8ff7\u5bab\uff0c\u6bcf\u4e2a\u8282\u70b9\u4e0a\u6709\u4e00\u4e32\u94a5\u5319\u6216\u8005\u4e00\u4e2a\u9501\u3002\u94a5\u5319\u548c\u9501\u6709\u989c\u8272\uff0c\u4e00\u79cd\u989c\u8272\u7684\u94a5\u5319\u5f00\u4e00\u79cd\u989c\u8272\u7684\u9501\u3002\u6709 $Q$ \u4e2a\u5e08\u5085\uff0c\u7b2c $i$ \u4e2a\u5e08\u5085\u8981\u5f00\u8f66\u6cbf\u6700\u77ed\u8def\u4ece $s_i$ \u5230 $t_i$\uff0c\u9047\u5230\u4e00\u4e32\u94a5\u5319\u5c31\u53ef\u4ee5\u628a\u5b83\u6487\u5728\u76ae\u5e26\u4e0a\u9762\uff0c\u9047\u5230\u4e00\u4e2a\u9501\u5c31\u53ef\u4ee5\u62ff\u76ae\u5e26\u4e0a\u6487\u8d77\u7684\u5bf9\u5e94\u989c\u8272\u7684\u94a5\u5319\u6765\u5f00\u9501\uff0c\u7136\u540e\u8fd9\u4e2a\u94a5\u5319\u4f1a\u88ab\u6302\u70c2\u3002\u95ee\u4f60\u6700\u591a\u80fd\u5f00\u597d\u591a\u4e2a\u9501\u3002\u4fdd\u8bc1\u540c\u79cd\u989c\u8272\u7684\u94a5\u5319\u6700\u591a\u53ea\u6709 $5$ \u4e32\u3002\n\n### \u9898\u89e3\n\n\u6bcf\u79cd\u989c\u8272\u7684\u8d21\u732e\u662f\u72ec\u7acb\u7684\uff0c\u90a3\u4e48\u5bf9\u6bcf\u79cd\u6709\u989c\u8272\u6211\u4eec\u628a\u8fd9\u4e9b\u94a5\u5319\u548c\u9501\u55f2\u51fa\u6765\u5efa\u4e00\u68f5\u865a\u6811\u3002\u5229\u7528\u6bcf\u79cd\u94a5\u5319\u7684\u94a5\u5319\u4e0d\u8d85\u8fc7 $5$ \u4e32\u7684\u6761\u4ef6\uff0c\u6211\u4eec\u679a\u4e3e\u94a5\u5319 $yo$ \u548c\u9501 $so$\uff0c\u770b\u770b\u54ea\u4e9b\u4f1a\u5bf9\u54ea\u4e9b\u8def\u5f84\u4ea7\u751f\u8d21\u732e\uff08\u5373\u83b7\u5f97 $yo$ \u5e76\u4f7f\u7528\u5b83\u6765\u5f00 $so$\uff09\uff1f\u53ef\u4ee5\u53d1\u73b0\u5145\u8981\u5c31\u662f\u4ece $yo$ \u5230 $so$ \u7684\u7b80\u5355\u8def\u5f84\u4e0a\u4efb\u4f55\u4e00\u4e2a\u524d\u7f00\u94a5\u5319\u90fd\u6bd4\u9501\u591a\uff08\u9664\u4e86 $so$\uff09\uff0c\u4e14\u94a5\u5319\u548c\u9501\u4e00\u6837\u591a\u3002\u4ece\u6bcf\u4e2a $yo$ \u5f00\u59cb DFS \u627e\u5230\u6240\u6709\u5408\u6cd5\u7684\u6570\u5bf9 $(yo,so)$\u3002\u8fd9\u4e9b\u53ef\u4ee5\u8d21\u732e\u5230\u6240\u6709\u5305\u542b $(yo,so)$ \u7684\u8def\u5f84\u4e0a\u3002\u8f6c\u5230 DFS \u5e8f\u4e0a\u505a\u4e8c\u7ef4\u6570\u70b9\uff0c\u5206\u4e09\u79cd\u60c5\u51b5\uff0c\u4e00\u79cd\u662f $yo$ \u662f $so$ \u7684\u7956\u5148\uff0c\u4e00\u79cd\u662f $so$ \u662f $yo$ \u7684\u7956\u5148\uff0c\u6216\u8005\u6ca1\u6709\u7956\u5b59\u5173\u7cfb\u3002\u5c31\u662f\u4e2a\u4e8c\u7ef4\u52a0\u77e9\u5f62\u52a0\u5355\u70b9\u67e5\uff0c\u79bb\u7ebf\u4e0b\u6765\u7528\u6811\u72b6\u6570\u7ec4\u505a\u5c31\u53ef\u4ee5\u4e86\u5f97\u54a9\u3002\n\n\u4ee3\u7801\uff1a\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\nint cnt,en,fa[1000010][20],dfn[1000010],tim=0,ord[1000010<<1],te=0,dep[1000010],n,siz[1000010],col[1000010],key[1000010],m,vis[1000010],inq[1000010],stk[1000010],top,ans[2000010],tree[1000010];\nstruct edge{int head,to,nxt;}ed[2000010];\nvoid addedge(int from,int to)\n {\n  ed[++en].to=to;ed[en].nxt=ed[from].head;ed[from].head=en;}\n  void dfs(int now,int f){\n      dfn[now]=++tim;ord[now]=++te;fa[now][0]=f;dep[now]=dep[f]+1;siz[now]=1;\n   for(int i=1;i<20;i++)fa[now][i]=fa[fa[now][i-1]][i-1];\n       for(int i=ed[now].head;i;i=ed[i].nxt){\n           int v=ed[i].to;\n    if(v==f)continue;dfs(v,now);siz[now]+=siz[v];}\n   ord[now+n]=++te;}\n  int LCA(int a,int b)\n {\nint u=a,v=b;if(dep[u]<dep[v])\nswap(u,v);int k=dep[u]-dep[v];\nfor(int i=0;i<20;i++)if((k>>i)&1)u=fa[u][i];if(u==v)return u;\n  for(int i=19;~i;--i)if(fa[u][i]!=fa[v][i])\n      {u=fa[u][i],v=fa[v][i];}return fa[u][0];}\n  int zu(int x,int k){\n      for(int i=0;i<20;i++)if((k>>i)&1)x=fa[x][i];return x;}\n vector<int>nxt[1000010],C[1000010],b;\nvoid dfs1(int now,int fa,int c,int cnt){\nif(col[now]==c&&key[now])cnt++;\n if(col[now]==c&&!key[now])\n     {\n  --cnt;\n   if(!cnt){b.push_back(now);return;}}\n    for(int i:nxt[now])\n   {if(i==fa)continue;dfs1(i,now,c,cnt);}return;\n }\n  struct ADD\n {int x,l,r;ADD()\n {}\n  ADD(int X,int L,int R):x(X),l(L),r(R){\n\n  }bool operator<(const ADD&b)\n const{return abs(x)<abs(b.x);}\n  bool operator>(const ADD&b)const\n  {\n return abs(x)>abs(b.x);}}add[20000010];\nstruct Query{int id,x,y;}q[2000010];\n bool cmp(Query a,Query b)\n {return a.x<b.x;}\n  bool cmp2(int a,int b){return dfn[a]<dfn[b];}\nbool cmp3(int a,int b){return ord[a]<ord[b];\n}\nvoid calc(int c){\n vector<int>S=C[c];\n  if(S.size()==1)return;\n sort(S.begin(),S.end(),cmp2);\n int p=S.size(),r=1;\n for(int i=0;i<p;i++)vis[S[i]]=inq[S[i]]=1,S.push_back(S[i]+n);\nfor(int i=1;i<p;i++)\n {int q=LCA(S[i],S[i-1]);if(vis[q])continue;\nvis[q]=1;S.push_back(q);S.push_back(n+q);}\n if(!vis[1])vis[1]=1,S.push_back(1),S.push_back(1+n);\n   sort(S.begin(),S.end(),cmp3);\n p=S.size();\n  top=0;\n for(int i=0;i<p;i++){\n     if(S[i]<=n) stk[++top]=S[i];\n     else\n       {int x=stk[top--];\n  int y=stk[top];\n   if(y){nxt[y].push_back(x);nxt[x].push_back(y);r=y;}}\n}\n  for(int i:S)\n       {if(i>n)\n      continue;\n   if(col[i]==c&&key[i]){\n       b.clear();dfs1(i,0,c,0);\n     for(int j:b)\n          {\n              int x=i,y=j,lca=LCA(i,j);\n     if(lca==x)\n    {\n     int q=zu(y,dep[y]-dep[x]-1);\n      if(dfn[q]!=1){\n          add[++cnt]=ADD(1,dfn[y],dfn[y]+siz[y]-1);\n           add[++cnt]=ADD(-dfn[q],dfn[y],dfn[y]+siz[y]-1);}\n      if(dfn[q]+siz[q]-1!=n)\n          add[++cnt]=ADD(dfn[q]+siz[q],dfn[y],dfn[y]+siz[y]-1);}\n        else if(lca==y){int q=zu(x,dep[x]-dep[y]-1);\n        if(dfn[q]!=1)\n      {add[++cnt]=ADD(dfn[x],1,dfn[q]-1);\n  if(dfn[x]+siz[x]-1!=n)add[++cnt]=ADD(-(dfn[x]+siz[x]),1,dfn[q]-1);\n}\n   if(dfn[q]+siz[q]-1!=n){\n         add[++cnt]=ADD(dfn[x],dfn[q]+siz[q],n);\n       if(dfn[x]+siz[x]-1!=n)\n           add[++cnt]=ADD(-(dfn[x]+siz[x]),dfn[q]+siz[q],n);}}\n        else\n       {add[++cnt]=ADD(dfn[x],dfn[y],dfn[y]+siz[y]-1);\n   if(dfn[x]+siz[x]-1!=n)add[++cnt]=ADD(-(dfn[x]+siz[x]),dfn[y],dfn[y]+siz[y]-1);}\n  }\n   }\n}\n   for(int i=0;i<p;i++)\n  {int x=S[i];\n if(x>n)x-=n;vis[x]=inq[x]=0;nxt[x].clear();}\n}\nvoid Add(int x,int y)\n{\n    for(int i=x;i<=n;i+=i&-i)tree[i]+=y;}\n int sum(int x)\n{int res=0;for(int i=x;i;i-=i&-i)res+=tree[i];\nreturn res;}\nint main()\n {\n     scanf(\"%d%d\",&n,&m);\n for(int i=1,t;i<=n;i++){\n     scanf(\"%d%d\",&t,&col[i]);\n      if(t==1)key[i]=1;else key[i]=0;\n C[col[i]].push_back(i);}\n for(int i=1,u,v;i<n;i++)\n     {\n     scanf(\"%d%d\",&u,&v);addedge(u,v);addedge(v,u);}dfs(1,0);\n for(int i=1;i<=n;i++)\n     if(C[i].size())calc(i);\n for(int i=1;i<=m;i++)\n{int x,y;\n scanf(\"%d%d\",&x,&y);q[i].x=dfn[x];q[i].y=dfn[y];q[i].id=i;\n}\n  sort(q+1,q+m+1,cmp);sort(add+1,add+cnt+1);\n int t=1;for(int i=1;i<=cnt;i++){\n     int x=add[i].x,y=1;if(abs(x)!=abs(add[i-1].x))\n  {while(t<=m&&q[t].x<abs(x))ans[q[t].id]=sum(q[t].y),++t;}\n   if(x<0)y=-1,x=-x;Add(add[i].l,y);\n if(add[i].r!=n)Add(add[i].r+1,-y);}while(t<=m)ans[q[t].id]=sum(q[t].y),\n ++t;\n   for(int i=1;i<=m;i++)\n  printf(\"%d\\n\",ans[i]);\n return 0;\n}\n```",
        "postTime": 1679963266,
        "uid": 337548,
        "name": "myyes",
        "ccfLevel": 0,
        "title": "P8339 [AHOI2022] \u94a5\u5319"
    },
    {
        "content": "\u63d0\u4f9b\u4e00\u4e2a\u7b80\u5355\u6811\u5256/\u5dee\u5206\u7684\u505a\u6cd5\u3002\n\n\u6211\u4eec\u5148\u8003\u8651 $A$ \u6027\u8d28\u600e\u4e48\u505a\uff0c\u4ee4\u6bcf\u79cd\u989c\u8272\u7684\u94a5\u5319\u548c\u7bb1\u5b50\u5206\u522b\u4e3a $(x,y)$\uff0c\u90a3\u4e48\u4f1a\u5bf9\u8d77\u70b9\u5728 $x$ \u4e00\u7aef\uff0c\u7ec8\u70b9\u5728 $y$ \u4e00\u7aef\u7684\u8be2\u95ee\u4ea7\u751f\u8d21\u732e\u3002\u6240\u4ee5\u6211\u4eec\u5bf9\u8be2\u95ee\u79bb\u7ebf\uff0c\u95ee\u9898\u8f6c\u5316\u4e3a\u77e9\u9635\u52a0\u5355\u70b9\u67e5\u8be2\uff0c\u76f4\u63a5\u626b\u63cf\u7ebf\u5373\u53ef\u3002\n\n\u6ca1\u6709\u7279\u6b8a\u6027\u8d28\uff0c\u4f46\u6211\u4eec\u5ef6\u7eed\u4e0a\u9762\u7684\u601d\u8def\uff0c\u8003\u8651\u5bf9\u540c\u989c\u8272\u7684\u94a5\u5319\u548c\u7bb1\u5b50 $(x,y)$ \u8ba1\u7b97\u8d21\u732e\u3002\u7531\u4e8e\u94a5\u5319 $\\le 5$\uff0c\u6240\u4ee5\u6240\u6709 $(x,y)$ \u6700\u591a\u662f $5n$\u3002\n\n\u6211\u4eec\u4f9d\u6b21\u8003\u8651\u6bcf\u79cd\u989c\u8272\u3002\u4f46\u5e76\u4e0d\u662f\u6240\u6709\u7684 $(x,y)$ \u90fd\u6ee1\u8db3\u6761\u4ef6\uff0c\u89c2\u5bdf\u4e00\u4e0b\u4e0d\u96be\u53d1\u73b0\uff0c\u5982\u679c\u6211\u4eec\u5c06\u94a5\u5319\u8bb0\u4e3a $+1$\uff0c\u7bb1\u5b50\u8bb0\u4e3a $-1$\uff0c\u5176\u4f59\u8bb0\u4e3a $0$\uff0c\u90a3\u4e48\u6811\u94fe $x\\to y$ \u7684\u548c\u4e3a $0$ \u662f\u4ea7\u751f\u8d21\u732e\u7684\u5fc5\u8981\u6761\u4ef6\u3002\n\n\u4f46\u662f\u8fd9\u6837\u8fde\u6837\u4f8b\u90fd\u8fc7\u4e0d\u53bb\uff0c\u7b54\u6848\u4f1a\u504f\u5927\uff0c\u663e\u7136\u6709\u8d21\u732e\u91cd\u590d\u7edf\u8ba1\u4e86\u3002\u6bd4\u5982 $1,-1,1,-1$\uff0c\u5176\u4e2d $(1,2)$ \u548c $(1,4)$ \u88ab\u8ba1\u7b97\u4e86\u4e24\u6b21\u3002 \n\n\u5982\u679c\u6570\u5bf9 $(x,y)$ \u5728\u8def\u5f84 $x\\to y$ \u4e0a\u6709 $z$ \u4f7f\u5f97 $(x,z)$ \u4ea7\u751f\u8d21\u732e\uff0c\u90a3\u4e48 $y$ \u5c31\u4e0d\u4ea7\u751f\u8d21\u732e\u3002\u90a3\u4e48\u6211\u4eec\u56fa\u5b9a $x$\uff0c\u5c06\u6240\u6709\u53ef\u80fd\u7684 $y$ \u6309\u5230 $x$ \u7684\u8ddd\u79bb\u6392\u5e8f\uff0c\u4f9d\u6b21\u8003\u8651\uff0c\u5982\u679c\u4ea7\u751f\u8d21\u732e\u5c31\u5728 $y$ \u5355\u70b9\u52a0\uff0c\u6bcf\u6b21\u7edf\u8ba1 $(x,y)$ \u65f6\u5148\u5224\u65ad\u4e00\u4e0b\u662f\u5426\u8def\u5f84\u548c\u4e3a $0$\u3002\n\n\u53ef\u4ee5\u76f4\u63a5\u7528\u4e24\u4e2a\u6811\u94fe\u5256\u5206\u7ef4\u62a4\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(5n\\log^2 n + m\\log m)$\uff0c\u7531\u4e8e\u6811\u5256\u548c\u6811\u72b6\u6570\u7ec4\u7684\u5e38\u6570\u90fd\u5f88\u5c0f\uff0c\u53ef\u4ee5\u65e0\u538b\u529b\u901a\u8fc7\u3002\n\n\u4e8b\u5b9e\u4e0a\uff0c\u6211\u4eec\u7ef4\u62a4\u7684\u662f\u5355\u70b9\u52a0\uff0c\u6811\u94fe\u67e5\u8be2\uff0c\u76f4\u63a5\u6811\u4e0a\u5dee\u5206\u6811\u72b6\u6570\u7ec4\u7ef4\u62a4\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}((n+m)\\log n)$\u3002\n\n\u6811\u5256\u5199\u7684\u4e60\u60ef\uff0c\u4e0b\u9762\u662f\u6811\u5256\u4ee3\u7801\u3002\n\n```cpp\n#define N 500005\nint n, m, c[N], d[N], dfn[N], fa[N], top[N], sz[N], son[N], mat[N], ds[N], idx, w[N];\ninline void add(int x,int y){for(; x <= n; x += x & -x)c[x] += y;}\ninline int ask(int x){int sum = 0; for(; x; x -= x & -x)sum += c[x]; return sum;}\ninline void Add(int x,int y){for(; x <= n; x += x & -x)w[x] += y;}\ninline int Ask(int x){int sum = 0; for(; x; x -= x & -x)sum += w[x]; return sum;}\ninline int get(int l,int r){return ask(r) - ask(l - 1);}\ninline int Get(int l,int r){return Ask(r) - Ask(l - 1);}\nvector<int>a[N], b[N], e[N]; vector<Pr> u[N], v[N];\nvoid dfs(int x,int f){\n\td[x] = d[fa[x] = f] + (sz[x] = 1);\n\tgo(y, e[x])if(y != f){\n\t\tdfs(y, x), sz[x] += sz[y];\n\t\tif(sz[y] > sz[son[x]])son[x] = y;\n\t}\n}\nvoid dfs2(int x,int tp){\n\ttop[x] = tp, mat[dfn[x] = ++idx] = x;\n\tif(!son[x])return;\n\tdfs2(son[x], tp);\n\tgo(y, e[x])if(y != fa[x] && y != son[x])dfs2(y, y);\n}\ninline int lca(int x,int y){\n\twhile(top[x] != top[y]){\n\t\tif(d[top[x]] < d[top[y]])swap(x, y);\n\t\tx = fa[top[x]];\n\t}\n\treturn d[x] < d[y] ? x : y;\n}\ninline int dis(int x,int y){return d[x] + d[y] - d[lca(x, y)] * 2;}\nint query(int x,int y){\n\tint sum = 0;\n\twhile(top[x] != top[y]){\n\t\tif(d[top[x]] < d[top[y]])swap(x, y);\n\t\tsum += get(dfn[top[x]], dfn[x]), x = fa[top[x]];\n\t}\n\tif(d[x] > d[y])swap(x, y);\n\tsum += get(dfn[x], dfn[y]);\n\treturn sum;\n}\nint Query(int x,int y){\n\tint sum = 0;\n\twhile(top[x] != top[y]){\n\t\tif(d[top[x]] < d[top[y]])swap(x, y);\n\t\tsum += Get(dfn[top[x]], dfn[x]), x = fa[top[x]];\n\t}\n\tif(d[x] > d[y])swap(x, y);\n\tsum += Get(dfn[x], dfn[y]);\n\treturn sum;\n}\nint calc(int x,int k){\n\twhile(d[top[x]] > k)x = fa[top[x]];\n\treturn mat[dfn[x] - d[x] + k];\n}\n#define ck(x, y) (dfn[x] <= dfn[y] && dfn[x] + sz[x] > dfn[y])\ninline void ins(int l,int r,int L,int R){\n\tif(l > r || L > R)return;\n\tu[l].pb(mp(L, R)), v[r + 1].pb(mp(L, R));\n}\nvoid ins(int x,int y){  //  x  to  y\n\tif(ck(x, y)){\n\t\tint z = calc(y, d[x] + 1);\n\t\tins(1, dfn[z] - 1, dfn[y], dfn[y] + sz[y] - 1);\n\t\tins(dfn[z] + sz[z], n, dfn[y], dfn[y] + sz[y] - 1);\n\t}\n\telse if(ck(y, x)){\n\t\tint z = calc(x, d[y] + 1);\n\t\tins(dfn[x], dfn[x] + sz[x] - 1, 1, dfn[z] - 1);\n\t\tins(dfn[x], dfn[x] + sz[x] - 1, dfn[z] + sz[z], n);\n\t}\n\telse ins(dfn[x], dfn[x] + sz[x] - 1, dfn[y], dfn[y] + sz[y] - 1);\n}\nstruct node{\n\tint l, r, id;\n\tbool operator<(const node o)const{return l < o.l;}\n}q[N << 1];\nint ed[N << 1];\nint main() {\n\tread(n, m);\n\trp(i, n){\n\t\tint x, y; read(x, y);\n\t\tif(1 == x)a[y].pb(i);\n\t\telse b[y].pb(i);\n\t}\n\trp(i, n - 1){\n\t\tint x, y;\n\t\tread(x, y);\n\t\te[x].pb(y), e[y].pb(x);\n\t}\n\tdfs(1, 0), dfs2(1, 1);\n\trp(i, n)if(si(a[i]) && si(b[i])){\n\t\tgo(x, a[i])add(dfn[x], 1);\n\t\tgo(x, b[i])add(dfn[x], -1);\n\t\tgo(x, a[i]){\n\t\t\tgo(y, b[i])ds[y] = dis(x, y);\n\t\t\tsort(b[i].begin(), b[i].end(), [&](int x,int y){return ds[x] < ds[y];});\n\t\t\tvector<int>dl;\n\t\t\tgo(y, b[i]){\n\t\t\t\tif(0 == query(x, y) && !Query(x, y)){\n\t\t\t\t\tAdd(dfn[y], 1), dl.pb(y), ins(x, y);\n\t\t\t\t}\n\t\t\t}\n\t\t\tgo(y, dl)Add(dfn[y], -1);\n\t\t}\n\t\tgo(x, a[i])add(dfn[x], -1);\n\t\tgo(x, b[i])add(dfn[x], 1);\n\t}\n\tmemset(c, 0, sizeof(c));\n\trp(i, m)read(q[i].l, q[i].r), q[i].id = i, q[i].l = dfn[q[i].l], q[i].r = dfn[q[i].r];\n\tsort(q + 1, q + m + 1);\n\tint j = 1;\n\trp(i, n){\n\t\tgo(x, u[i])add(x.fi, 1), add(x.se + 1, -1);\n\t\tgo(x, v[i])add(x.fi, -1), add(x.se + 1, 1);\n\t\twhile(j <= m && q[j].l == i)ed[q[j].id] = ask(q[j].r), j++;\n\t}\n\trp(i, m)printf(\"%d\\n\", ed[i]);\n\treturn 0;\n}\n```\n\n",
        "postTime": 1652179535,
        "uid": 119261,
        "name": "7KByte",
        "ccfLevel": 0,
        "title": "\u3010\u9898\u89e3\u3011[AHOI2022] \u94a5\u5319"
    },
    {
        "content": "\u5bf9\u6bcf\u4e2a\u989c\u8272\u6c42\u4e00\u4e0b\u865a\u6811\uff0c\u7136\u540e\u4ece\u6bcf\u4e2a\u94a5\u5319\u51fa\u53d1\u5bf9\u865a\u6811 DFS\uff0c\u8bbe\u5f53\u524d\u4ece $x$ \u5f00\u59cb DFS\u3002\n\n\u5728\u4f7f\u7528\u94a5\u5319\u65f6\u6211\u4eec\u9075\u5faa\u540e\u8fdb\u5148\u51fa\u539f\u5219\uff0c\u8bbe $dp(i)$ \u8868\u793a\u4ece $x$ \u8d70\u5230 $i$\uff0c\u624b\u4e0a\u8fd8\u5269\u51e0\u4e2a\u94a5\u5319\uff0c\u90a3\u4e48\u5982\u679c $i$ \u662f\u94a5\u5319\u5c31 $dp(i)=dp(fa)+1$\uff0c\u5982\u679c $i$ \u662f\u5b9d\u7bb1\u90a3\u4e48 $dp(i)=\\max(0,dp(fa)-1)$\u3002\u5982\u679c DFS \u5230\u67d0\u4e2a $i$ \u53d1\u73b0\u5b83\u662f\u5b9d\u7bb1\u800c\u4e14 $dp(i)=0$\uff0c\u5c31\u8bf4\u660e\u5f00\u5b83\u662f\u7528\u7684 $x$ \u90a3\u628a\u94a5\u5319\uff08\u56e0\u4e3a\u6211\u4eec\u540e\u8fdb\u5148\u51fa\uff0c\u5230\u8fd9\u91cc\u6808\u6b63\u597d\u7a7a\u4e86\uff09\uff0c\u4e5f\u5c31\u662f\u94a5\u5319 $x$ \u548c\u5b9d\u7bb1 $i$ \u5339\u914d\uff0c\u5982\u679c\u8def\u5f84 $a\\to b$ \u8986\u76d6\u4e86\u8def\u5f84 $x\\to i$\uff0c\u90a3\u4e48\u5176\u7b54\u6848\u5c31\u8981 +1\u3002\n\n\u7136\u540e\u5c31\u662f\u4e2a\u77e9\u5f62\u52a0\u5355\u70b9\u6c42\u503c\uff0c\u6811\u72b6\u6570\u7ec4\u89e3\u51b3\u3002\n\n\u590d\u6742\u5ea6\u4e3a $O((n+m)\\log n)$\u3002\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\nconst int MAXN=500010,MAXT=11000010;\nstruct P {\n\tint tim,l,r,typ;\n\tP (int a=0,int b=0,int c=0,int d=0) {tim=a,l=b,r=c,typ=d;}\n}p[MAXT];\nint n,m,x,y,tot,cnt,nc,hd,typ[MAXN],col[MAXN],dfn[MAXN],ed[MAXN],f[MAXN][22];\nint dt[MAXN],dep[MAXN],ans[MAXN*2],fw[MAXN],dp[MAXN],st[MAXN];\nvector <int> v[MAXN],w[MAXN],v2[MAXN];\nbool cmp (P a,P b) {return (a.tim==b.tim?a.typ<b.typ:a.tim<b.tim);}\nbool cmp2 (int x,int y) {return dfn[x]<dfn[y];}\nint read () {\n\tint res=0;\n\tchar c=getchar();\n\twhile (c<'0'||c>'9') {c=getchar();}\n\twhile (c>='0'&&c<='9') {\n\t\tres=res*10+c-'0';\n\t\tc=getchar();\n\t}\n\treturn res;\n}\nvoid write (int x) {\n\tif (x>9) {write(x/10);}\n\tputchar(x%10+'0');\n}\nvoid dfs (int x,int fa) {\n\tf[x][0]=fa,dep[x]=dep[fa]+1,dfn[x]=ed[x]=++tot;\n\tfor (int i=1;i<=20;i++) {f[x][i]=f[f[x][i-1]][i-1];}\n\tint len=v[x].size();\n\tfor (int i=0;i<len;i++) {\n\t\tif (v[x][i]==fa) {continue;}\n\t\tdfs(v[x][i],x);\n\t\ted[x]=ed[v[x][i]];\n\t}\n\treturn;\n}\nvoid modify (int x,int v) {\n\tfor (int i=x;i<=n;i+=(i&(-i))) {fw[i]+=v;}\n}\nint query (int x) {\n\tint res=0;\n\tfor (int i=x;i;i-=(i&(-i))) {res+=fw[i];}\n\treturn res;\n}\nint querylca (int x,int y) {\n\tif (dep[x]<dep[y]) {swap(x,y);}\n\tfor (int i=20;i>=0;i--) {\n\t\tif (dep[x]-(1<<i)>=dep[y]) {x=f[x][i];}\n\t}\n\tif (x==y) {return x;}\n\tfor (int i=20;i>=0;i--) {\n\t\tif (f[x][i]!=f[y][i]) {x=f[x][i],y=f[y][i];}\n\t}\n\treturn f[x][0];\n}\nint querylas (int x,int y) {\n\tfor (int i=20;i>=0;i--) {\n\t\tif (dep[x]-(1<<i)>dep[y]) {x=f[x][i];}\n\t}\n\treturn x;\n}\nint anc (int x,int y) {return (dfn[x]<=dfn[y]&&ed[y]<=ed[x]);}\nvoid add (int x,int y) {\n\tif (anc(x,y)) {\n\t\tint tmp=querylas(y,x);\n\t\tp[++cnt]=P(1,dfn[y],ed[y],0);\n\t\tp[++cnt]=P(dfn[tmp],dfn[y],ed[y],-1);\n\t\tp[++cnt]=P(ed[tmp]+1,dfn[y],ed[y],0);\n\t} else if (anc(y,x)) {\n\t\tint tmp=querylas(x,y);\n\t\tp[++cnt]=P(dfn[x],1,dfn[tmp]-1,0);\n\t\tp[++cnt]=P(dfn[x],ed[tmp]+1,n,0);\n\t\tp[++cnt]=P(ed[x]+1,1,dfn[tmp]-1,-1);\n\t\tp[++cnt]=P(ed[x]+1,ed[tmp]+1,n,-1);\n\t} else {\n\t\tp[++cnt]=P(dfn[x],dfn[y],ed[y],0);\n\t\tp[++cnt]=P(ed[x]+1,dfn[y],ed[y],-1);\n\t}\n\treturn;\n}\nvoid dfs2 (int x,int fa,int rt) {\n\tdp[x]=dp[fa]+(col[x]==nc?(typ[x]==1?1:-1):0);\n\tif (col[x]==nc&&typ[x]==2&&dp[x]==0) {add(rt,x);return;}\n\tint len=v2[x].size();\n\tfor (int i=0;i<len;i++) {\n\t\tif (v2[x][i]==fa) {continue;}\n\t\tdfs2(v2[x][i],x,rt);\n\t}\n\treturn;\n}\nvoid dfs3 (int x,int fa) {\n\tint len=v2[x].size();\n\tfor (int i=0;i<len;i++) {\n\t\tif (v2[x][i]==fa) {continue;}\n\t\tdfs3(v2[x][i],x);\n\t}\n\tv2[x].clear();\n\treturn;\n}\nvoid proc (int x) {\n\tnc=x;\n\tint len=w[x].size(),ncnt=0;\n\tfor (int i=0;i<len;i++) {dt[++ncnt]=w[x][i];}\n\tsort(dt+1,dt+ncnt+1,cmp2);\n\tst[hd=1]=1;\n\tfor (int i=(dt[1]==1?2:1);i<=ncnt;i++) {\n\t\twhile (hd>=2&&!anc(st[hd-1],dt[i])) {\n\t\t\tv2[st[hd]].push_back(st[hd-1]);\n\t\t\tv2[st[hd-1]].push_back(st[hd]);\n\t\t\thd--;\n\t\t}\n\t\tif (hd==1) {st[++hd]=dt[i];continue;}\n\t\tint tmp=querylca(dt[i],st[hd]);\n\t\tif (tmp==st[hd-1]) {\n\t\t\tv2[st[hd]].push_back(st[hd-1]);\n\t\t\tv2[st[hd-1]].push_back(st[hd]);\n\t\t\thd--;\n\t\t} else if (tmp!=st[hd]) {\n\t\t\tv2[st[hd]].push_back(tmp);\n\t\t\tv2[tmp].push_back(st[hd]);\n\t\t\thd--;\n\t\t\tst[++hd]=tmp;\n\t\t}\n\t\tst[++hd]=dt[i];\n\t}\n\twhile (hd>=2) {\n\t\tv2[st[hd]].push_back(st[hd-1]);\n\t\tv2[st[hd-1]].push_back(st[hd]);\n\t\thd--;\n\t}\n\tfor (int i=1;i<=ncnt;i++) {\n\t\tif (typ[dt[i]]==1) {dfs2(dt[i],0,dt[i]);}\n\t}\n\tdfs3(dt[1],0);\n\treturn;\n}\nint main () {\n\t//freopen(\"keys4.in\",\"r\",stdin);\n\t//freopen(\"keys.out\",\"w\",stdout);\n\tn=read(),m=read();\n\tfor (int i=1;i<=n;i++) {\n\t\tx=read(),y=read();\n\t\ttyp[i]=x,col[i]=y,w[y].push_back(i);\n\t}\n\tfor (int i=1;i<=n-1;i++) {\n\t\tx=read(),y=read();\n\t\tv[x].push_back(y),v[y].push_back(x);\n\t}\n\tdfs(1,0);\n\tfor (int i=1;i<=m;i++) {\n\t\tx=read(),y=read();\n\t\tp[++cnt]=P(dfn[x],dfn[y],0,i);\n\t}\n\tfor (int i=1;i<=n;i++) {\n\t\tif (w[i].empty()) {continue;}\n\t\tproc(i);\n\t}\n\tsort(p+1,p+cnt+1,cmp);\n\tfor (int i=1;i<=cnt;i++) {\n\t\tif (p[i].typ==0) {\n\t\t\tmodify(p[i].l,1);\n\t\t\tmodify(p[i].r+1,-1);\n\t\t} else if (p[i].typ==-1) {\n\t\t\tmodify(p[i].l,-1);\n\t\t\tmodify(p[i].r+1,1);\n\t\t} else {\n\t\t\tans[p[i].typ]=query(p[i].l);\n\t\t}\n\t}\n\tfor (int i=1;i<=m;i++) {\n\t\twrite(ans[i]);\n\t\tputchar('\\n');\n\t}\n\treturn 0;\n}\n```\n",
        "postTime": 1652175869,
        "uid": 113546,
        "name": "ix35",
        "ccfLevel": 10,
        "title": "AHOI 2022 T2"
    },
    {
        "content": "#### \u9898\u89e3\r\n\r\n\u8003\u8651\u5982\u4f55\u7edf\u8ba1\u7b54\u6848\uff0c\u4e0d\u96be\u60f3\u5230\u5bf9\u6bcf\u79cd\u989c\u8272\u8ba1\u7b97\u8d21\u732e\u3002\r\n\r\n\u8003\u8651\u989c\u8272 $k$\uff0c\u7528 `(` \u8868\u793a\u94a5\u5319\uff0c`)` \u8868\u793a\u5b9d\u7bb1\uff0c\u90a3\u4e48\u4e00\u6761\u8def\u5f84\u4e0a\u6700\u591a\u80fd\u5f00\u542f\u7684\u5b9d\u7bb1\u4e2a\u6570\u5373\u4e3a\u6700\u5927\u7684\u62ec\u53f7\u5339\u914d\u6570\u3002\u7528\u62ec\u53f7\u5339\u914d\u7684\u4f18\u52bf\u5728\u4e8e\uff0c\u5b83\u4fdd\u8bc1\u4e86\u94a5\u5319\u6ee1\u8db3\u5148\u8fdb\u540e\u51fa\u7684\u7ed3\u6784\uff0c\u8fd9\u6837\u603b\u662f\u4f1a\u4f18\u5148\u5339\u914d\u6700\u8fd1\u7684\u4e00\u5bf9\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u65e0\u8bba\u8def\u5f84\u5982\u4f55\uff0c\u914d\u5bf9\u7684\u94a5\u5319\u548c\u5b9d\u7bb1\u603b\u662f\u786e\u5b9a\u7684\u3002\u56e0\u6b64\u53ea\u9700\u8981\u9884\u5904\u7406\u51fa\u6240\u6709\u914d\u5bf9\u7684\u94a5\u5319\u548c\u5b9d\u7bb1\uff0c\u7136\u540e\u5c31\u8f6c\u5316\u4e3a\u4e86\u4e00\u4e2a\u8def\u5f84\u8986\u76d6\u95ee\u9898\u3002\u8def\u5f84\u8986\u76d6\u53ef\u4ee5\u8f6c\u5316\u5230 dfs \u5e8f\u4e0a\u7528\u4e8c\u7ef4\u6570\u70b9\u8ba1\u7b97\u3002\r\n\r\n\u8003\u8651\u5982\u4f55\u5904\u7406\u914d\u5bf9\uff0c\u9996\u5148\u5bf9\u6bcf\u79cd\u989c\u8272\u5efa\u51fa\u865a\u6811\u3002\u7531\u4e8e\u94a5\u5319\u53ea\u6709 $5$ \u4e2a\uff0c\u56e0\u6b64\u53ef\u4ee5\u4ece\u6bcf\u4e2a\u94a5\u5319\u5f00\u59cb dfs \u4e00\u6b21\uff0c\u8bb0\u5f55\u4e0b\u5f53\u524d\u5269\u4f59\u7684\u94a5\u5319\u4e2a\u6570\uff0c\u5f53\u521a\u597d\u914d\u5bf9\u5b8c\u6700\u540e\u4e00\u4e2a\u94a5\u5319\u65f6\u52a0\u5165\u8fd9\u4e00\u70b9\u5bf9\u7684\u8d21\u732e\u3002\u5bb9\u6613\u8bc1\u660e\uff0c\u540c\u4e00\u4e2a\u94a5\u5319\u80fd\u591f\u5339\u914d\u7684\u6240\u6709\u5b9d\u7bb1\u4e00\u5b9a\u4e0d\u4f1a\u8d21\u732e\u5230\u540c\u4e00\u6761\u8def\u5f84\u4e0a\u3002\r\n\r\n\u6548\u7387 $O(5n\\log n+q\\log n)$\u3002\r\n\r\n#### \u4ee3\u7801\r\n\r\n```cpp\r\n#include <bits/stdc++.h>\r\n#define Getchar() p1 == p2 and (p2 = (p1 = buf) + fread(buf, 1, 1 << 21, stdin), p1 == p2) ? EOF : *p1++\r\nchar buf[1 << 21], *p1, *p2;\r\ninline int read (void)\r\n{\r\n\tint x = 0; char c = Getchar();\r\n\twhile (c < '0' or c > '9') c = Getchar();\r\n\twhile (c >= '0' and c <= '9') x = x * 10 + c - 48, c = Getchar();\r\n\treturn x;\r\n}\r\nconst int maxn = 500000 + 10;\r\nint n, m, times, t[maxn], c[maxn], a[maxn], st[maxn], tp; bool vis[maxn];\r\nint dep[maxn], fa[maxn], siz[maxn], son[maxn], top[maxn], dfn[maxn], pos[maxn];\r\nstd::vector<int> e[maxn], g[maxn], E[maxn]; int tr[maxn], ans[1 << 20];\r\nstd::vector<std::array<int, 3>> A[maxn]; std::vector<std::pair<int, int>> Q[maxn];\r\ninline void dfs1 (int u, int fr)\r\n{\r\n\tdep[u] = dep[fa[u] = fr] + 1; siz[u] = 1;\r\n\tfor (int v: e[u]) if (v != fr)\r\n\t{\r\n\t\tdfs1(v, u); siz[u] += siz[v];\r\n\t\tif (siz[v] > siz[son[u]]) son[u] = v;\r\n\t}\r\n}\r\ninline void dfs2 (int u)\r\n{\r\n\tpos[dfn[u] = ++times] = u;\r\n\tif (son[u]) top[son[u]] = top[u], dfs2(son[u]);\r\n\tfor (int v: e[u]) if (v != fa[u] and v != son[u]) top[v] = v, dfs2(v);\r\n}\r\ninline int lca (int u, int v)\r\n{\r\n\twhile (top[u] != top[v]) dep[top[u]] < dep[top[v]] ? v = fa[top[v]] : u = fa[top[u]];\r\n\treturn dep[u] < dep[v] ? u : v;\r\n}\r\ninline bool subtree (int u, int v) {return dfn[u] <= dfn[v] and dfn[v] < dfn[u] + siz[u];}\r\ninline void add (int l, int r, int d, int u) {A[l].push_back({d, u, 1}); A[r + 1].push_back({d, u, -1});}\r\ninline int up (int x, int k)\r\n{\r\n\twhile (dep[x] - dep[top[x]] < k) k -= dep[x] - dep[fa[top[x]]], x = fa[top[x]];\r\n\treturn pos[dfn[x] - k];\r\n}\r\ninline void add (int x, int y)\r\n{\r\n\tint l = lca(x, y);\r\n\tif (l == x)\r\n\t{\r\n\t\tx = up(y, dep[y] - dep[x] - 1);\r\n\t\tif (dfn[x] > 1) add(1, dfn[x] - 1, dfn[y], dfn[y] + siz[y] - 1);\r\n\t\tif (dfn[x] + siz[x] - 1 < n) add(dfn[x] + siz[x], n, dfn[y], dfn[y] + siz[y] - 1);\r\n\t\treturn;\r\n\t}\r\n\tif (l == y)\r\n\t{\r\n\t\ty = up(x, dep[x] - dep[y] - 1);\r\n\t\tif (dfn[y] > 1) add(dfn[x], dfn[x] + siz[x] - 1, 1, dfn[y] - 1);\r\n\t\tif (dfn[y] + siz[y] - 1 < n) add(dfn[x], dfn[x] + siz[x] - 1, dfn[y] + siz[y], n);\r\n\t\treturn;\r\n\t}\r\n\tadd(dfn[x], dfn[x] + siz[x] - 1, dfn[y], dfn[y] + siz[y] - 1);\r\n}\r\ninline void dfs (int u, int fr, int w, int col, int r)\r\n{\r\n\tif (c[u] == col)\r\n\t{\r\n\t\tw += (t[u] == 1) ? 1 : -1;\r\n\t\tif (w == 0) {add(r, u); return;}\r\n\t}\r\n\tfor (int v: E[u]) if (v != fr) dfs(v, u, w, col, r);\r\n}\r\nsigned main ()\r\n{\r\n\tn = read(); m = read();\r\n\tfor (int i = 1; i <= n; i++) t[i] = read(), g[c[i] = read()].push_back(i);\r\n\tfor (int i = 1, u, v; i < n; i++) u = read(), v = read(), e[u].push_back(v), e[v].push_back(u);\r\n\tdfs1(1, 0); top[1] = 1; dfs2(1);\r\n\tfor (int i = 1; i <= n; i++)\r\n\t{\r\n\t\tint k1 = 0, k2 = 0;\r\n\t\tfor (int x: g[i]) vis[a[++k1] = x] = true;\r\n\t\tstd::sort(a + 1, a + k1 + 1, [&](const int &x, const int &y){return dfn[x] < dfn[y];}); k2 = k1;\r\n\t\tfor (int i = 2, l; i <= k1; i++) if (!vis[l = lca(a[i - 1], a[i])]) vis[a[++k2] = l] = true;\r\n\t\tif (!vis[1]) vis[a[++k2] = 1] = true;\r\n\t\tstd::sort(a + 1, a + k2 + 1, [&](const int &x, const int &y){return dfn[x] < dfn[y];}); st[tp = 1] = 1;\r\n\t\tfor (int i = 2; i <= k2; i++)\r\n\t\t{\r\n\t\t\twhile (!subtree(st[tp], a[i])) tp--;\r\n\t\t\tE[st[tp]].push_back(a[i]); E[a[i]].push_back(st[tp]); st[++tp] = a[i];\r\n\t\t}\r\n\t\tfor (int x: g[i]) if (t[x] == 1) dfs(x, 0, 0, i, x);\r\n\t\tfor (int i = 1; i <= k2; i++) vis[a[i]] = false, E[a[i]].clear();\r\n\t}\r\n\tfor (int i = 1, u, v; i <= m; i++) u = read(), v = read(), Q[dfn[u]].push_back({dfn[v], i});\r\n\tfor (int i = 1; i <= n; i++)\r\n\t{\r\n\t\tauto add = [&] (int x, int y) {for (int i = x; i <= n; i += i & (-i)) tr[i] += y;};\r\n\t\tauto ask = [&] (int x) {int res = 0; for (int i = x; i; i -= i & (-i)) res += tr[i]; return res;};\r\n\t\tfor (auto [l, r, w]: A[i]) add(l, w), add(r + 1, -w);\r\n\t\tfor (auto [p, id]: Q[i]) ans[id] = ask(p);\r\n\t}\r\n\tfor (int i = 1; i <= m; i++) printf(\"%d\\n\", ans[i]);\r\n\treturn 0;\r\n}\r\n```",
        "postTime": 1661749728,
        "uid": 46197,
        "name": "_RSY_",
        "ccfLevel": 10,
        "title": "\u3010\u9898\u89e3\u3011P8339"
    },
    {
        "content": "\u8fd9\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u70b9\u5206\u6cbb\u505a\u6cd5\u3002\n\n\u6811\u4e0a\u8def\u5f84\u95ee\u9898\u5f53\u7136\u60f3\u5230\u70b9\u5206\u6cbb\uff0c\u8fd9\u4e2a\u9898\u8be2\u95ee\u7684\u5176\u5b9e\u662f\u62ec\u53f7\u5339\u914d\u6570\uff0c\u6211\u4eec\u628a\u8be2\u95ee\u62c6\u6210\u4ece\u4e0b\u5230\u4e0a\u548c\u4ece\u4e0a\u5230\u4e0b\u4e24\u90e8\u5206\uff0c\u53ea\u9700\u8981\u5408\u5e76\u4e24\u90e8\u5206\u7684\u7b54\u6848\uff0c\u5408\u5e76\u65b9\u6cd5\u662f\uff0c\u4e24\u8fb9\u5df2\u7ecf\u5339\u914d\u7684\u6570\u91cf\u52a0\u4e0a\u5931\u914d\u62ec\u53f7\u7684\u5339\u914d\u6570\u3002\u7528 $a$ \u6570\u7ec4\u8868\u793a\u4ece\u4e0b\u5230\u4e0a\u67d0\u79cd\u989c\u8272\u7684\u5931\u914d\u6570\u91cf\uff0c$b$ \u6570\u7ec4\u8868\u793a\u4ece\u4e0a\u5230\u4e0b\u3002\u53ef\u4ee5\u4e00\u904d dfs \u6c42\u51fa\u6bcf\u6761\u8def\u5f84\u7684\u5339\u914d\u6570\u91cf\u548c\u8fd9\u4e24\u4e2a\u6570\u7ec4\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5feb\u901f\u67e5\u8be2 $\\min(a_i,b_i)$ \u4e4b\u548c\u3002\n\n\u8003\u8651\u626b\u63cf\u8def\u5f84\u7684\u7ed3\u675f\u70b9\uff0c\u52a8\u6001\u7ef4\u62a4\u6bcf\u4e2a\u5f00\u59cb\u70b9\u7684\u7b54\u6848\u3002\u7ed3\u675f\u70b9\u79fb\u52a8\u4e00\u6b65\u6700\u591a\u7ed9 $b$ \u6570\u7ec4\u7684\u67d0\u4e2a\u4f4d\u7f6e\u5e26\u6765\u4e00\u7684\u53d8\u5316\uff0c\u5047\u8bbe $b_i$ \u52a0\u4e00\uff0c\u90a3\u4e48\u6240\u6709 $a_i\\geq b_i$ \u7684\u7ed3\u70b9\u7b54\u6848\u4e5f\u8981\u52a0\u4e00\u3002\u56e0\u4e3a\u6bcf\u79cd\u94a5\u5319\u51fa\u73b0\u6b21\u6570\u4e0d\u8d85\u8fc75\u6b21\uff0c\u8fd9\u4e9b\u4f4d\u7f6e\u80af\u5b9a\u662f\u4e0d\u8d85\u8fc75\u68f5\u5b50\u6811\u3002\u7528\u6811\u72b6\u6570\u7ec4\u7ef4\u62a4\u5373\u53ef\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $O(5n\\log^2n+m\\log n)$\u3002\n\n``` cpp\nconst int mxn=5e5+3;\nVI g[mxn];int n,qn,ty[mxn],co[mxn],jg[mxn*2];\nstruct thr{int x,y,k;};\nvector<thr>xw;\n\nint sz[mxn],d1[mxn],d2[mxn],dn,vs[mxn],fa[mxn],ee[mxn*2],N,be[mxn];\nVI ad[mxn][6];bool sp[mxn];\nvector<thr>wh[mxn];\nvoid dfs0(int x,int f=0){sz[x]=1;for(int y:g[x])if(y!=f&&!vs[y])dfs0(y,x),sz[x]+=sz[y];}\nint zx(int x,int f,int S){for(int y:g[x])if(y!=f&&!vs[y]&&sz[y]*2>S)return zx(y,x,S);return x;}\nvoid dfs1(int x,int f=0){d1[x]=++dn,fa[x]=f,ee[++N]=x;for(int y:g[x])if(y!=f&&!vs[y])dfs1(y,x);d2[x]=dn;ee[++N]=-x;}\nstruct arrrrr{int a[mxn];void add(int x,int v){for(;x<=n;x+=x&-x)a[x]+=v;}void add(int l,int r,int v){add(l,v),add(r+1,-v);}int ask(int x){int r=0;for(;x;x&=x-1)r+=a[x];return r;}}ar;\nvoid dfs(int rt=1,vector<thr>ve=xw){\n    wh[rt].clear();if(!ve.size())return;\n    if(rt!=1)dfs0(rt),rt=zx(rt,0,sz[rt]);\n    dn=N=0;dfs1(rt);\n    static int c1[mxn],c2[mxn],vl[mxn];\n    static vector<pii>hd[mxn],dl;\n    vl[rt]=0;\n    for(int T=2;T<N;++T){\n        int x=ee[T];if(x>0){\n            int k=co[x];be[x]=fa[x]==rt?x:be[fa[x]];vl[x]=vl[fa[x]];\n            if(ty[x]==1){if(c2[k])--c2[k],++vl[x];else ad[k][++c1[k]].push_back(x),sp[x]=1,dl.emplace_back(k,c1[k]);}\n            else ++c2[k];\n            wh[x].clear();\n        }else{\n            x=-x;int k=co[x];if(ty[x]==2)--c2[k];else if(sp[x])sp[x]=0,--c1[k];else ++c2[k];\n        }\n    }\n    for(auto k:ve)if(k.x==rt||k.y==rt||be[k.x]!=be[k.y])hd[k.y].emplace_back(k.x,k.k);else wh[be[k.x]].push_back(k);\n    for(int T=1,v=0;T<=N;++T){\n        int x=ee[T];if(x>0){\n            int k=co[x];if(ty[x]==1)++c1[k];else if(c1[k])--c1[k],++v;else{\n                ++c2[k];if(c2[k]<=5)for(int x:ad[k][c2[k]])ar.add(d1[x],d2[x],1);sp[x]=1;\n            }\n            for(auto k:hd[x])jg[k.second]=v+ar.ask(d1[k.first])+vl[k.first];\n            hd[x].clear();\n        }else{\n            x=-x;int k=co[x];if(ty[x]==1)--c1[k];else if(!sp[x])++c1[k],--v;else{\n                sp[x]=0;if(c2[k]<=5)for(int x:ad[k][c2[k]])ar.add(d1[x],d2[x],-1);--c2[k];\n            }\n        }\n    }\n    for(auto k:dl)ad[k.first][k.second].clear();dl.clear();\n    vs[rt]=1;for(int y:g[rt])if(!vs[y])dfs(y,wh[y]);\n}\n\nint main(){\n    cin>>n>>qn;for(int i=1;i<=n;++i)scanf(\"%d%d\",ty+i,co+i);for(int i=1,x,y;i<n;++i)scanf(\"%d%d\",&x,&y),g[x].push_back(y),g[y].push_back(x);\n    for(int i=1,x,y;i<=qn;++i)scanf(\"%d%d\",&x,&y),xw.push_back({x,y,i});\n    dfs();for(int i=1;i<=qn;++i)printf(\"%d\\n\",jg[i]);\n    return 0;\n}\n\n```",
        "postTime": 1654514108,
        "uid": 335193,
        "name": "Rubyonly",
        "ccfLevel": 8,
        "title": "P8339"
    }
]