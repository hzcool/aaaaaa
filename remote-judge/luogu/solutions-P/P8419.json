[
    {
        "content": "\u505a\u7684\u65f6\u5019\u627e\u4e86\u534a\u5929\u90fd\u6ca1\u6709\u627e\u5230\u8be6\u7ec6\u7684\u9898\u89e3\uff0c\u53ea\u80fd\u81ea\u5df1\u5199\u4e00\u4e2a\u3002\n\n## \u9898\u610f\n\n> \u7ed9\u51fa\u6392\u5217 $a_1,a_2,\\cdots,a_n$\uff0c\u4f60\u9700\u8981\u7ef4\u62a4\u4e00\u4e2a\u521d\u59cb\u5168 $0$ \u7684\u5e8f\u5217 $b$\u3002$m$ \u6b21\u64cd\u4f5c\uff1a\n\n> `1 l r`\uff1a\u5bf9\u4e8e\u6bcf\u5bf9 $l\\le i\\le j\\le r$ \u4e14 $a_i\\le a_j$\uff0c$b_j\\gets b_j+1$\u3002\n\n> `2 x`\uff1a\u67e5\u8be2 $b_x$\u3002\n\n> $n,m\\le 2\\times 10^5$\u3002\n\n## \u9898\u89e3\n\n\u5bf9\u5e8f\u5217\u4ee5 $\\sqrt n$ \u4e3a\u5757\u957f\u5206\u5757\u3002\n\n\u5bf9\u4e8e\u4e00\u6b21\u4fee\u6539\u7684\u8d21\u732e\uff0c\u6211\u4eec\u62c6\u6210 $5$ \u4e2a\u90e8\u5206\uff1a\n\n1. \u5de6\u6563\u5757\u5bf9\u5de6\u6563\u5757\uff0c\u53f3\u6563\u5757\u5bf9\u53f3\u6563\u5757\uff0c\u6216\u8005 $l,r$ \u5728\u540c\u4e00\u5757\uff1b\n2. \u6574\u5757\u5bf9\u6574\u5757\uff08\u5305\u62ec\u540c\u4e00\u4e2a\u6574\u5757\u5185\u90e8\uff09\uff1b\n3. \u6574\u5757\u5bf9\u53f3\u6563\u5757\uff1b\n4. \u5de6\u6563\u5757\u5bf9\u53f3\u6563\u5757\uff1b\n5. \u5de6\u6563\u5757\u5bf9\u6574\u5757\u3002\n\n\u5176\u4e2d\uff0c\u201c`X` \u5bf9 `Y`\u201d\u8868\u793a $i$ \u5728 `X` \u4e2d\u3001$j$ \u5728 `Y` \u4e2d\u3002\n\n\u63a5\u4e0b\u6765\u5206\u522b\u8003\u8651\u3002\n\n#### \u4e00\u3001\u5de6\u6563\u5757\u5bf9\u5de6\u6563\u5757/\u53f3\u6563\u5757\u5bf9\u53f3\u6563\u5757/$l,r$ \u5728\u540c\u4e00\u5757\n\n\u9884\u5904\u7406 $pnum_{i,j,k}$ \u8868\u793a\u7b2c $i$ \u5757\u7684\u524d $k$ \u4e2a\u5143\u7d20\u4e2d\u5c0f\u4e8e\u7b49\u4e8e\u7b2c $i$ \u5757\u7b2c $j$ \u4e2a\u5143\u7d20\u7684\u6709\u591a\u5c11\u4e2a\u3002\u4fee\u6539\u65f6\u66b4\u529b\u5728\u7b54\u6848\u6570\u7ec4\u4e0a\u52a0\u3002\n\n#### \u4e8c\u3001\u6574\u5757\u5bf9\u6574\u5757\n\n\u9884\u5904\u7406 $num_{i,j}$ \u8868\u793a\u7b2c $i$ \u5757\u4e2d\u5c0f\u4e8e\u7b49\u4e8e $a_j$ \u7684\u6709\u591a\u5c11\u4e2a\u3002\n\n\u5bf9\u6bcf\u4e2a\u6574\u5757\uff0c\u6211\u4eec\u8bb0\u5f55\u524d\u9762\u6bcf\u4e00\u5757\u5bf9\u5b83\u6709\u591a\u5c11\u6b21\u8d21\u732e\u3002\n\n\u4fee\u6539\uff1a\u5bf9\u4e00\u6bb5\u533a\u95f4\u5185\u7684\u6bcf\u4e2a\u5757\uff0c\u5de6\u8fb9\u4e00\u6bb5\u533a\u95f4\u5185\u7684\u5757\u5bf9\u5b83\u8d21\u732e $+1$\u3002\n\n\u8be2\u95ee\uff1a\u626b\u63cf $x$ \u6240\u5728\u5757\u5de6\u8fb9\u7684\u5757\uff0c\u67e5\u8be2\u5b83\u4eec\u5bf9 $x$ \u6240\u5728\u7684\u5757\u8d21\u732e\u4e86\u591a\u5c11\u6b21\uff0c\u4e58\u4e0a\u300e\u8fd9\u4e2a\u5757\u91cc\u5c0f\u4e8e\u7b49\u4e8e $a_x$ \u7684\u6570\u91cf\u300f\u540e\u7d2f\u52a0\u5230\u7b54\u6848\u3002\n\n\u7ef4\u62a4\u8d21\u732e\u6b21\u6570\u7684\u5dee\u5206\u6570\u7ec4\u5373\u53ef\u3002\n\n\u6ce8\u610f\u540c\u4e00\u5757\u5185\u90e8\u7684\u8d21\u732e\u9700\u8981\u7279\u6b8a\u5904\u7406\u3002\n\n#### \u4e09\u3001\u6574\u5757\u5bf9\u53f3\u6563\u5757\n\n\u9884\u5904\u7406 $prenum_{i,j}$ \u8868\u793a\u524d $i$ \u5757\u4e2d\u5c0f\u4e8e\u7b49\u4e8e $a_j$ \u7684\u6709\u591a\u5c11\u4e2a\u3002\n\n\u4fee\u6539\u65f6\uff0c\u5bf9\u4e8e\u53f3\u6563\u5757\u7684\u6bcf\u4e2a\u5143\u7d20\u66b4\u529b\u66f4\u65b0\u7b54\u6848\u3002\n\n#### \u56db\u3001\u5de6\u6563\u5757\u5bf9\u53f3\u6563\u5757\n\n\u9884\u5904\u7406 $id_{i,j}$ \u8868\u793a\u7b2c $i$ \u5757\u7b2c $j$ \u5c0f\u7684\u6570\u5728\u54ea\u4e2a\u4f4d\u7f6e\u3002\n\n\u4f7f\u7528\u53cc\u6307\u9488\u66f4\u65b0\u7b54\u6848\uff0c\u5177\u4f53\u4e0d\u597d\u63cf\u8ff0\uff0c\u53ef\u6d4f\u89c8\u4ee3\u7801\u3002\n\n### \u4e94\u3001\u5de6\u6563\u5757\u5bf9\u6574\u5757\n\n\u6700\u590d\u6742\u7684\u90e8\u5206\u3002\n\n\u6211\u4eec\u5efa\u7acb\u4e00\u4e2a\u5e73\u9762\uff0c$x$ \u5750\u6807\u662f\u5757\u7f16\u53f7\uff0c$y$ \u5750\u6807\u662f $a$ \u503c\u3002\u5047\u8bbe $pos_i$ \u662f\u4e0b\u6807 $i$ \u6240\u5728\u7684\u5757\u3002\n\n- \u4fee\u6539 $(l,r)$\uff1a\u5bf9\u4e8e\u5de6\u6563\u5757\u6bcf\u4e2a\u70b9 $i$\uff0c\u5728 $(pos_l+1,a_i)$ \u4e0a $+1$\uff0c\u5728 $(pos_r,a_i)$ \u4e0a $-1$\u3002\n\n- \u67e5\u8be2 $i$\uff1a\u67e5\u8be2 $x$ \u5750\u6807 $\\le pos_i$\uff0c$y$ \u5750\u6807 $\\le a_i$ \u7684\u70b9\u6743\u503c\u548c\u3002\n\n\u8f6c\u5316\u6210 $O(n\\sqrt n)$ \u6b21\u5355\u70b9\u4fee\u6539\u548c $O(n)$ \u6b21\u4e8c\u7ef4\u6570\u70b9\u3002\n\n\u5148\u5c06 $x$ \u5750\u6807\u6309\u7167 $\\sqrt[4]n$ \u4e3a\u5757\u957f\u5206\u5757\u3002\u5bf9\u4e8e\u6bcf\u4e2a $x$ \u5750\u6807\u4e0a\u7684\u6574\u5757\u548c\u5355\u70b9\uff0c\u6211\u4eec\u9700\u8981\u652f\u6301\uff1a\n\n- \u4fee\u6539\uff1a$O(n)$ \u6b21\u8fde\u7eed\u5728 $O(\\sqrt n)$ \u4e2a\u4f4d\u7f6e\u5355\u70b9\u4fee\u6539\u3002\n\n- \u67e5\u8be2\uff1a$O(n\\sqrt[4]n)$ \u6b21\u67e5\u8be2\u524d\u7f00\u548c\u3002\n\n\u5728 $y$ \u5750\u6807\u4e0a\u7ee7\u7eed\u4ee5 $\\sqrt n$ \u4e3a\u5757\u957f\u5206\u5757\u3002\u628a\u524d\u7f00\u548c\u62c6\u6210\u6574\u5757\u548c\u7684\u524d\u7f00\u548c\u548c\u6563\u5757\u5757\u5185\u524d\u7f00\u548c\u3002\n\n\u5bf9\u4e8e\u6574\u5757\uff0c\u6211\u4eec\u7ef4\u62a4\u524d\u82e5\u5e72\u5757\u5185\u7684\u548c\u3002\u4fee\u6539\u65f6\u5148\u5dee\u5206\u51fa\u6bcf\u4e2a\u5757\u5185\u7684\u548c\uff0c\u7136\u540e\u66b4\u529b\u4fee\u6539\uff0c\u6700\u540e\u518d\u505a\u524d\u7f00\u548c\u3002\n\n\u800c\u5bf9\u4e8e\u6bcf\u4e2a\u6563\u5757\uff0c\u6211\u4eec\u8981\u505a\u7684\uff1a\n\n- \u4fee\u6539\uff1a$O(n\\sqrt n)$ \u6b21\u5355\u70b9\u4fee\u6539\u3002\n\n- \u67e5\u8be2\uff1a$O(n\\sqrt[4]n)$ \u6b21\u67e5\u8be2\u524d\u7f00\u548c\u3002\n\n\u8c8c\u4f3c\u6ca1\u533a\u522b\uff1f\u4f46\u662f\u5e8f\u5217\u957f\u5ea6\u53d8\u6210\u4e86 $O(\\sqrt n)$\u3002\n\n\u6240\u4ee5\u518d\u5957\u4e00\u4e2a\u4ee5 $O(\\sqrt[4]n)$ \u4e3a\u5757\u957f\u7684\u5206\u5757\uff0c\u652f\u6301 $O(1)$ \u5355\u70b9\u4fee\u6539\u548c $O(\\sqrt[4]n)$ \u524d\u7f00\u67e5\u8be2\u5373\u53ef\u3002\n\n\u603b\u590d\u6742\u5ea6 $O(n\\sqrt n)$\u3002\n\n## \u4ee3\u7801\n\n\u6bd4\u8f83\u4e11\u964b\uff0c\u89c1\u8c05\u3002\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nint read(){\n\tint x=0;char c=getchar();\n\twhile(c<'0'||c>'9')c=getchar();\n\twhile(c>='0'&&c<='9')x=x*10+(c^'0'),c=getchar();\n\treturn x;\n}\n#define ll long long\nint n,m;\nconst int B1=460,B2=23;\nint a[200005];\nint pos[200005],poss[465],L[465],R[465],L1[25],R1[25];\nint num[465][200005],prenum[465][200005];\nint pnum[465][465][465];\nint id[465][465];\nint times[465][465];\nll ans[200005];\nint xbyb[25][465],xpyb[465][465],xbypyb[25][465][25],xbypyp[25][465][465],xpypyb[465][465][25],xpypyp[465][465][465];\n//b \u8868\u793a block \u5757\uff0cp \u8868\u793a point \u5355\u70b9\nbool cmp(int x,int y){return a[x]<a[y];}\nint main(){\n\tn=read(),m=read();\n    for(int i=1;i<=n;i++){\n        a[i]=read();\n        pos[i]=(i-1)/B1+1;\n        if(!L[pos[i]])L[pos[i]]=i;\n        R[pos[i]]=i;\n    }\n    for(int i=1;i<=B1;i++){\n        poss[i]=(i-1)/B2+1;\n        if(!L1[poss[i]])L1[poss[i]]=i;\n        R1[poss[i]]=i;\n    }\n    for(int i=1;i<=pos[n];i++){//\u9884\u5904\u7406\n        for(int j=L[i];j<=R[i];j++)num[i][a[j]]++;\n        for(int j=1;j<=n;j++)num[i][j]+=num[i][j-1],prenum[i][j]=num[i][j]+prenum[i-1][j];\n        for(int j=L[i];j<=R[i];j++)id[i][j-L[i]+1]=j;\n        sort(id[i]+1,id[i]+R[i]-L[i]+1+1,cmp);\n        for(int j=1;j<=R[i]-L[i]+1;j++)\n            for(int k=1;k<=R[i]-L[i]+1;k++)pnum[i][j][k]=pnum[i][j][k-1]+(a[k+L[i]-1]<=a[j+L[i]-1]);\n    }\n    while(m--){\n        int opt=read();\n        if(opt==1){\n            int l=read(),r=read();\n            if(pos[l]==pos[r]){\n                // l,r \u5728\u540c\u4e00\u4e2a\u5757\n                for(int i=l;i<=r;i++)ans[i]+=pnum[pos[l]][i-L[pos[l]]+1][i-L[pos[l]]+1]-pnum[pos[l]][i-L[pos[l]]+1][l-L[pos[l]]];\n            }else{\n                // \u7b2c\u4e00\u90e8\u5206 \u5de6\u6563\u5757\u5bf9\u5de6\u6563\u5757/\u53f3\u6563\u5757\u5bf9\u53f3\u6563\u5757\n                for(int i=l;i<=R[pos[l]];i++)ans[i]+=pnum[pos[l]][i-L[pos[l]]+1][i-L[pos[l]]+1]-pnum[pos[l]][i-L[pos[l]]+1][l-L[pos[l]]];\n                for(int i=L[pos[r]];i<=r;i++)ans[i]+=pnum[pos[r]][i-L[pos[r]]+1][i-L[pos[r]]+1];\n                // \u7b2c\u4e8c\u90e8\u5206 \u6574\u5757\u5bf9\u6574\u5757\n                for(int i=pos[l]+1;i<pos[r];i++)times[pos[l]+1][i]++;\n                // \u7b2c\u4e09\u90e8\u5206 \u6574\u5757\u5bf9\u53f3\u6563\u5757\n                for(int i=L[pos[r]];i<=r;i++)ans[i]+=prenum[pos[r]-1][a[i]]-prenum[pos[l]][a[i]];\n                // \u7b2c\u56db\u90e8\u5206 \u5de6\u6563\u5757\u5bf9\u53f3\u6563\u5757\n                for(int i=1,j=0,cnt=0;i<=R[pos[r]]-L[pos[r]]+1;i++){\n                    while(i<=R[pos[r]]-L[pos[r]]+1&&id[pos[r]][i]>r)i++;\n                    if(i>R[pos[r]]-L[pos[r]]+1)continue;\n                    while(j<R[pos[l]]-L[pos[l]]+1&&a[id[pos[l]][j+1]]<=a[id[pos[r]][i]]){\n                        j++;\n                        if(id[pos[l]][j]>=l)cnt++;\n                    }\n                    ans[id[pos[r]][i]]+=cnt;\n                }\n                // \u7b2c\u4e94\u90e8\u5206 \u5de6\u6563\u5757\u5bf9\u6574\u5757\n                int x=pos[l]+1;\n                // y \u6574\u5757\u7684\u90e8\u5206\uff0c\u5dee\u5206->\u66b4\u529b\u4fee\u6539->\u524d\u7f00\u548c\n                for(int i=pos[n];i>=1;i--)xbyb[poss[x]][i]-=xbyb[poss[x]][i-1],xpyb[x][i]-=xpyb[x][i-1];\n                for(int i=l;i<=R[pos[l]];i++)xbyb[poss[x]][pos[a[i]]]++,xpyb[x][pos[a[i]]]++;\n                for(int i=1;i<=pos[n];i++)xbyb[poss[x]][i]+=xbyb[poss[x]][i-1],xpyb[x][i]+=xpyb[x][i-1];\n                // y \u6563\u5757\u7684\u90e8\u5206\uff0c\u5757\u5185\u518d\u5206\u5757\n                for(int i=l;i<=R[pos[l]];i++){\n                    int y=a[i];\n                    // x \u6574\u5757\n                    xbypyb[poss[x]][pos[y]][poss[y-L[pos[y]]+1]]++,xbypyp[poss[x]][pos[y]][y-L[pos[y]]+1]++;\n                    // x \u6563\u5757\n                    xpypyb[x][pos[y]][poss[y-L[pos[y]]+1]]++,xpypyp[x][pos[y]][y-L[pos[y]]+1]++;\n                }\n                // \u548c\u4e0a\u9762\u4e00\u6837\n                x=pos[r];\n                for(int i=pos[n];i>=1;i--)xbyb[poss[x]][i]-=xbyb[poss[x]][i-1],xpyb[x][i]-=xpyb[x][i-1];\n                for(int i=l;i<=R[pos[l]];i++)xbyb[poss[x]][pos[a[i]]]--,xpyb[x][pos[a[i]]]--;\n                for(int i=1;i<=pos[n];i++)xbyb[poss[x]][i]+=xbyb[poss[x]][i-1],xpyb[x][i]+=xpyb[x][i-1];\n                for(int i=l;i<=R[pos[l]];i++){\n                    int y=a[i];\n                    xbypyb[poss[x]][pos[y]][poss[y-L[pos[y]]+1]]--,xbypyp[poss[x]][pos[y]][y-L[pos[y]]+1]--;\n                    xpypyb[x][pos[y]][poss[y-L[pos[y]]+1]]--,xpypyp[x][pos[y]][y-L[pos[y]]+1]--;\n                }\n            }\n        }else{\n            int x=read(),y=a[x];\n            ll res=ans[x];// \u7b2c\u4e00\u3001\u4e09\u3001\u56db\u90e8\u5206 \u66b4\u529b\u8bb0\u5f55\u7b54\u6848\n            // \u7b2c\u4e8c\u90e8\u5206 \u6574\u5757\u5bf9\u6574\u5757\n            for(int i=1,s=0;i<=pos[x];i++){\n                s+=times[i][pos[x]];\n                if(i<pos[x])res+=1ll*s*num[i][a[x]];\n                else for(int j=L[i];j<=x;j++)if(a[j]<=a[x])res+=s;\n            }\n            // \u7b2c\u4e94\u90e8\u5206 \u5de6\u6563\u5757\u5bf9\u6574\u5757\n            // x \u6574\u5757\n            for(int i=1;i<poss[pos[x]];i++){\n                // y \u6574\u5757\n                res+=xbyb[i][pos[y]-1];\n                // y \u6563\u5757\u5185\u6574\u5757\n                for(int j=1;j<poss[y-L[pos[y]]+1];j++)res+=xbypyb[i][pos[y]][j];\n                // y \u6563\u5757\u5185\u5355\u70b9\n                for(int j=L1[poss[y-L[pos[y]]+1]];j<=y-L[pos[y]]+1;j++)res+=xbypyp[i][pos[y]][j];\n            }\n            // x \u6563\u5757\uff08\u548c\u4e0a\u9762\u4e00\u6837\uff09\n            for(int i=L1[poss[pos[x]]];i<=pos[x];i++){\n                res+=xpyb[i][pos[y]-1];\n                for(int j=1;j<poss[y-L[pos[y]]+1];j++)res+=xpypyb[i][pos[y]][j];\n                for(int j=L1[poss[y-L[pos[y]]+1]];j<=y-L[pos[y]]+1;j++)res+=xpypyp[i][pos[y]][j];\n\t\t\t}\n            printf(\"%lld\\n\",res);\n        }\n    }\n    return 0;\n}\n```",
        "postTime": 1665231938,
        "uid": 233462,
        "name": "Umbrella_Leaf",
        "ccfLevel": 8,
        "title": "\u9898\u89e3P8419 [THUPC2022 \u51b3\u8d5b] riapq"
    }
]