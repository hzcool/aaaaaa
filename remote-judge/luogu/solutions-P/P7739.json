[
    {
        "content": "\u6309\u7167\u516c\u5f0f\u8fdb\u884c\u8ba1\u7b97\uff0c\u5219 $x+\\frac zy=\\frac{xy+z}y$\uff0c\u6709 $\\gcd (xy+z,y)=\\gcd(z,y)$\uff0c\u5fc5\u5b9a\u4e0d\u4f1a\u88ab\u7ea6\u5206\uff0c\u6240\u4ee5\u53ea\u8981\u6b63\u5e38\u8ba1\u7b97\u662f\u4e0d\u7528\u7ba1\u5206\u5b50\u5206\u6bcd\u4e92\u8d28\u7684\u6761\u4ef6\u7684\uff0e\n\n\u672c\u9898\u8981\u6c42\u8f93\u51fa\u5206\u5b50\u548c\u5206\u6bcd\uff0c\u610f\u5473\u7740\u8fd9\u4e24\u90e8\u5206\u662f\u5206\u5f00\u7684\uff0c\u8003\u8651\u8bbe\u5411\u91cf $\\begin{pmatrix}x&y\\end{pmatrix}$ \u8868\u793a\u5206\u6570 $\\dfrac xy$\uff0c\u90a3\u4e48 $f(a_i,\\dfrac xy)=\\dfrac {a_iy+x}x$\uff0c\u56e0\u6b64\u4e0e $a_i$ \u8fd0\u7b97\u5bf9\u5e94\u4e00\u4e2a\u7ebf\u6027\u53d8\u6362\uff0c\u8be5\u7ebf\u6027\u53d8\u6362\u5bf9\u5e94**\u53f3**\u4e58 $\\begin{pmatrix}a_0&1\\\\1 \\end{pmatrix}$\uff0c\u800c\u6240\u6c42\u7684\u4fbf\u662f\u4ece\u53f3\u5f80\u5de6\u4f9d\u6b21\u53d8\u6362\u4e4b\u540e\u7684\u7ed3\u679c\uff0e\u5982\u679c\u7ed9\u5b9a $\\{a\\}$ \u5e76\u5355\u70b9\u4fee\u6539\uff0c\u53ef\u4ee5\u8f7b\u6613\u5b8c\u6210\u67e5\u8be2\uff0e\u521d\u59cb\u5411\u91cf\u4e3a $\\begin{pmatrix}1&0\\end{pmatrix}$\uff0e\n\n\u6ce8\u610f\uff1a\u5bf9\u5e94\u5230\u64cd\u4f5c\u5e8f\u5217\u4e0a\uff0c\u4e58\u6cd5\u987a\u5e8f\u4ece**\u53f3**\u5f80**\u5de6**\uff08\u5373\u4ece\u53f3\u5f80\u5de6\u8fed\u4ee3\uff09\uff0c\u4e14\u5747\u4e3a**\u53f3**\u4e58\uff0e\n\n\u8003\u8651 `W` \u64cd\u4f5c\uff0c\u5176\u5bf9\u5e94\u6700\u540e\u4e00\u4e2a\u6570\u5b57 $a_n\\gets a_n+1$\uff0c\u8003\u8651\u5230 $\\begin{pmatrix}1&k\\\\&1 \\end{pmatrix}\\begin{pmatrix}a_n&1\\\\1 \\end{pmatrix}=\\begin{pmatrix}a_n+k&1\\\\1 \\end{pmatrix}$\uff0c\u90a3\u53ea\u9700\u8981\u5728\u6700\u53f3\u52a0\u4e00\u4e2a $\\begin{pmatrix}1&1\\\\&1 \\end{pmatrix}$ \u5c31\u53ef\u4ee5\u4e86\uff0e\n\n\u8003\u8651 `E` \u64cd\u4f5c\uff0e\u6ce8\u610f\u5230\u82e5\u5012\u6570\u4e24\u9879\u4e3a $a,1$\uff0c\u6309\u7167\u9898\u610f\u64cd\u4f5c\u5c06\u53d8\u4e3a $a+1,1$\uff0c\u6309\u53e6\u4e00\u79cd\u65b9\u5f0f\u64cd\u4f5c\u53d8\u4e3a $a,0,1,1$\uff0e\u5bf9 $\\dfrac xy$ \u6267\u884c\u6b64\u53d8\u6362\uff0c\u5219\u7b2c\u4e00\u79cd\u60c5\u51b5 $\\dfrac{x}{y}\\to\\dfrac{x+y}{x}\\to \\dfrac{(a+2)x+(a+1)y}{x+y}$\uff0c\u7b2c\u4e8c\u79cd\u60c5\u51b5 $\\dfrac{x}{y}\\to \\dfrac{x+y}{x}\\to \\dfrac{2x+y}{x+y}\\to \\dfrac{x+y}{2x+y}\\to \\dfrac{(a+2)x+(a+1)y}{x+y}$\uff0c\n\n\u662f\u5b8c\u5168\u4e00\u81f4\u7684\uff0e\u6240\u4ee5\u76f4\u63a5\u8003\u8651\u7b2c\u4e8c\u79cd\u60c5\u51b5\uff0e\u7b2c\u4e8c\u79cd\u60c5\u51b5\u5373\u6dfb\u52a0\u77e9\u9635\n\n$\\begin{pmatrix}1&1\\\\1 \\end{pmatrix}\\begin{pmatrix}1&1\\\\1 \\end{pmatrix}\\begin{pmatrix}1&-1\\\\&1 \\end{pmatrix}=\\begin{pmatrix}2&-1\\\\1 \\end{pmatrix}$\uff0e\n\n\u56e0\u6b64\uff0c\u4e24\u79cd\u64cd\u4f5c\u5206\u522b\u5bf9\u5e94\u4e00\u4e2a\u77e9\u9635\uff0e\u518d\u8003\u8651\u9898\u76ee\u8981\u6c42\u7684\u4e09\u4e2a\u64cd\u4f5c\uff0c\u5206\u522b\u662f\u52a0\u5165\u3001flip \u548c reverse\uff0e\u8bbe $\\mathrm{A_n}$ flip \u540e\u4e3a $\\mathrm {B_n}$\uff0c\u8003\u8651\u7ef4\u62a4 $\\mathrm {A_n}\\mathrm {A_{n-1}\\cdots\\mathrm {A_1}}$\u3001$\\mathrm {A_1}\\mathrm {A_{2}\\cdots\\mathrm {A_n}}$\u3001$\\mathrm {B_n}\\mathrm {B_{n-1}\\cdots\\mathrm {B_1}}$\u3001$\\mathrm {B_1}\\mathrm {B_{2}\\cdots\\mathrm {B_n}}$\uff0c\u5373\u53ef\u7ef4\u62a4\u6240\u6709\u8fd0\u7b97\uff0e\u6ce8\u610f reverse \u65f6\u4e0d\u4ec5\u8981\u4ea4\u6362\u8fde\u4e58\u7ed3\u679c\uff0c\u4e5f\u8981\u4ea4\u6362\u5b50\u8282\u70b9\uff0e\n\n------------\n\n\u9898\u5916\u8bdd\uff1a\u8003\u5b8c\u6c34\u7fa4\u5168\u7a0b\u8de8\u670d\u804a\u5929\uff0c\u6709\u7ef4\u62a4 $6\\times 6$ \u77e9\u9635\u7684\uff0c\u6709\u8bf4 `E` \u8981\u5206\u5f00\u505a\u7684\uff0c\u6709\u8bf4\u7ef4\u62a4\u8fde\u7eed\u6bb5\u7684\uff0c\u5f88\u5947\u5999\u3002\n\n\n```cpp\ntemplate<int N> struct _splay\n{\n\tint c[N][2],f[N],siz[N];\n\tQ s[N][4],v[N][2];\n\tbool trsf[N],swp[N];\n\tint cnt,rt;\n\tvoid out(int x)\n\t{\n\t\tprintf(\"%d: c %d & %d f %d siz %d\\n\",x,c[x][0],c[x][1],f[x],siz[x]);\n\t\toutt(s[x][0]);//outt(s[x][1]);\n\t\toutt(v[x][0]);//outt(v[x][1]);\n\t\tif (c[x][0]) out(c[x][0]);\n\t\tif (c[x][1]) out(c[x][1]);\n\t\tif (x==rt) puts(\"-------------------\");\n\t}\n\tvoid init()\n\t{\n\t\tcnt=2;\n\t\tc[1][0]=c[1][1]=trsf[1]=swp[1]=f[1]=0;\n\t\tc[2][0]=c[2][1]=trsf[2]=swp[2]=f[2]=0;\n\t\tc[1][1]=2;f[2]=1;rt=1;siz[2]=1;siz[1]=2;\n\t\tfor (int j=0;j<3;j++) for (int i=0;i<4;i++) s[j][i]=dwz;\n\t\tfor (int j=0;j<3;j++) for (int i=0;i<2;i++) v[j][i]=dwz;\n\t}\n\tinline void pushup(register int x)\n\t{\n\t\tint lc=c[x][0],rc=c[x][1];\n\t\ts[x][0]=s[rc][0]*v[x][0]*s[lc][0];\n\t\ts[x][2]=s[rc][2]*v[x][1]*s[lc][2];\n\t\ts[x][1]=s[lc][1]*v[x][0]*s[rc][1];\n\t\ts[x][3]=s[lc][3]*v[x][1]*s[rc][3];\n\t\tsiz[x]=siz[lc]+siz[rc]+1;\n\t}\n\tinline void pushdown(register int x)\n\t{\n\t\tregister int lc=c[x][0],rc=c[x][1];\n\t\tif (trsf[x])\n\t\t{\n\t\t\tswap(s[lc][0],s[lc][2]);swap(s[lc][1],s[lc][3]);swap(v[lc][0],v[lc][1]);\n\t\t\ttrsf[lc]^=1;//c^=1;\n\t\t\tswap(s[rc][0],s[rc][2]);swap(s[rc][1],s[rc][3]);swap(v[rc][0],v[rc][1]);\n\t\t\ttrsf[rc]^=1;//c^=1;\n\t\t\ttrsf[x]=0;\n\t\t}\n\t\tif (swp[x])\n\t\t{\n\t\t\tswap(s[lc][0],s[lc][1]);swap(s[lc][2],s[lc][3]);\n\t\t\tswap(c[lc][0],c[lc][1]);\n\t\t\tswp[lc]^=1;//c^=1;\n\t\t\tswap(s[rc][0],s[rc][1]);swap(s[rc][2],s[rc][3]);\n\t\t\tswap(c[rc][0],c[rc][1]);\n\t\t\tswp[rc]^=1;//c^=1;\n\t\t\tswp[x]=0;\n\t\t}\n\t}\n\tinline void zigzag(register int x)\n\t{\n\t\tregister int y=f[x],z=f[y],typ=(c[y][0]==x);\n\t\tif (z) c[z][c[z][1]==y]=x;\n\t\tf[x]=z;f[y]=x;c[y][typ^1]=c[x][typ];\n\t\tif (c[x][typ]) f[c[x][typ]]=y;\n\t\tc[x][typ]=y;\n\t\tpushup(y);\n\t}\n\tinline void splay(register int x,register int tar)\n\t{\n\t\tif (!tar) rt=x;\n\t\tregister int y;\n\t\twhile ((y=f[x])!=tar)\n\t\t{\n\t\t\tif (f[y]!=tar) zigzag(c[f[y]][0]==y^c[y][0]==x?x:y);\n\t\t\tzigzag(x);\n\t\t}\n\t\tpushup(x);\n\t}\n\tinline void find(register int kth,register int tar)\n\t{\n\t\tregister int x=rt;\n\t\twhile (siz[c[x][0]]+1!=kth)\n\t\t{\n\t\t\tpushdown(x);\n\t\t\tif (siz[c[x][0]]>=kth) x=c[x][0]; else\n\t\t\t{\n\t\t\t\tkth-=siz[c[x][0]]+1;\n\t\t\t\tx=c[x][1];\n\t\t\t}\n\t\t}\n\t\tpushdown(x);\n\t\tsplay(x,tar);\n\t}\n\tinline void split(int x,int y)\n\t{\n\t\tfind(x,0);find(y+2,rt);\n\t}\n\tint npt()\n\t{\n\t\tint x=++cnt;\n\t\tc[x][0]=c[x][1]=siz[x]=f[x]=0;\n\t\ttrsf[x]=swp[x]=0;\n\t\treturn x;\n\t}\n\tint build(int l,int r)\n\t{\n\t\t//printf(\"bd [%d,%d]\\n\",l,r);\n\t\tif (l>r) return 0;\n\t\tint m=l+r>>1,x;\n\t\tx=npt();\n\t\tif (m<=n) {if (ss[m]=='W') v[x][0]=wbas,v[x][1]=ebas; else v[x][0]=ebas,v[x][1]=wbas;} else v[x][0]=v[x][1]=dwz;\n\t\t//printf(\"build %d %d %d\\n\",l,r,x);\n\t\tif (l==r)\n\t\t{\n\t\t\tsiz[x]=1;\n\t\t\ts[x][0]=s[x][1]=v[x][0];\n\t\t\ts[x][2]=s[x][3]=v[x][1];\n\t\t\treturn x;\n\t\t}\n\t\tc[x][0]=build(l,m-1);\n\t\tc[x][1]=build(m+1,r);\n\t\tif (c[x][0]) f[c[x][0]]=x;\n\t\tif (c[x][1]) f[c[x][1]]=x;\n\t\tpushup(x);\n\t\treturn x;\n\t}\n\tvoid mdf(int x,int typ)\n\t{\n\t\tfind(x+1,0);//puts(\"PP\");\n\t\tx=rt;//puts(\"PP\");\n\t\tif (typ) v[x][0]=ebas,v[x][1]=wbas; else v[x][0]=wbas,v[x][1]=ebas;//puts(\"PP\");\n\t\tpushup(x);\n\t}\n\tvoid mdf_flp(int x,int l,int r)\n\t{\n\t\tsplit(l,r);\n\t\tx=c[c[rt][1]][0];\n\t\ttrsf[x]^=1;\n\t\tswap(s[x][0],s[x][2]);swap(s[x][1],s[x][3]);\n\t\tswap(v[x][0],v[x][1]);\n\t\tpushup(f[x]);pushup(rt);\n\t}\n\tvoid mdf_rev(int x,int l,int r)\n\t{\n\t\tsplit(l,r);\n\t\tx=c[c[rt][1]][0];\n\t\tswp[x]^=1;\n\t\tswap(s[x][0],s[x][1]);swap(s[x][2],s[x][3]);swap(c[x][0],c[x][1]);\n\t\tpushup(f[x]);pushup(rt);\n\t}\n};\n_splay<N> s;\nint main()\n{\n\t//freopen(\"code.in\",\"r\",stdin);\n\t//freopen(\"code.out\",\"w\",stdout);\n\tios::sync_with_stdio(false);cin.tie(0);cout.tie(0);\n\tcin>>n>>m>>ss+1;\n\tdwz.a[0][0]=1;dwz.a[1][1]=1;\n\twbas.a[0][0]=1;wbas.a[0][1]=1;wbas.a[1][1]=1;\n\tebas.a[0][0]=2;ebas.a[0][1]=p-1;ebas.a[1][0]=1;\n\tbas=dwz;bas.a[0][1]=1;s.init();\n\ts.c[2][0]=s.build(1,n+m);s.f[s.c[2][0]]=2;\n\ts.pushup(2);s.pushup(1);//outt(1);\n\t//s.out(s.rt);\n\tls=s.s[s.rt][0]*bas;//outt(ls);\n\tans=ls.a[0][0];//inc(ans,ls.a[1][0]);\n\tla=ls.a[0][1];//inc(la,ls.a[1][1]);\n\t//cout<<\"ans=\";\n\tcout<<ans<<\" \"<<la;//m=0;\n\tif (m) cout<<\"\\n\";\n\twhile (m--)\n\t{\n\t\t//s.out(s.rt);\n\t\tcin>>ss;\n\t\tif (ss[0]=='A')\n\t\t{\n\t\t\tcin>>ss[0];\n\t\t\ts.mdf(++n,ss[0]=='E');\n\t\t}\n\t\telse if (ss[0]=='F')\n\t\t{\n\t\t\tcin>>z>>y;\n\t\t\ts.mdf_flp(1,z,y);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tcin>>z>>y;\n\t\t\ts.mdf_rev(1,z,y);\n\t\t}\n\t\t//if (m==0) outt(1);\n\t\tls=s.s[s.rt][0]*bas;//outt(1);\n\t\tans=ls.a[0][0];//inc(ans,ls.a[1][0]);\n\t\tla=ls.a[0][1];\n\t\t//cout<<\"ans=\";\n\t\tcout<<ans<<\" \"<<la;\n\t\tif (m) cout<<\"\\n\";\n\t}\n\tcout<<endl;\n}\n```",
        "postTime": 1627456843,
        "uid": 29826,
        "name": "SSerxhs",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P7739\u3010[NOI2021] \u5bc6\u7801\u7bb1\u3011"
    },
    {
        "content": "\u6587\u7ae0\u4e2d\u7684\u505a\u6cd5\u662f\u6211\u5728\u73b0\u573a\u60f3\u51fa\u6765\u7684\uff0c\u7136\u800c\u88ab\u5361\u6210 70\u3002\n\n\u9996\u5148\u5206\u5b50\u5206\u6bcd\u663e\u7136\u4e00\u5b9a\u4e92\u8d28\uff0c\u4e0d\u7528\u8003\u8651\u9664\u4e00\u4e2a $\\gcd$ \u7684\u4e8b\u60c5\uff08\u70b9\u540d\u6392\u6c34\u7cfb\u7edf\uff09\u3002\n\n## Part1\n\n\u8003\u8651\u8fd9\u4e48\u4e00\u4e2a\u8fde\u5206\u6570\uff1a\n\n$$ \\cfrac{1}{a_0+\\cfrac{1}{a_1+\\cfrac{1}{a_2+\\cdots}}} $$\n\n\uff08\u5b83\u662f $f(a_0,a_1,\\cdots,a_k)$ \u7684\u5012\u6570\uff09\n\n\u5982\u679c\u4ece $a_k$ \u5230 $a_0$\uff0c\u4ece\u4e0b\u5f80\u4e0a\u8fdb\u884c\u5408\u5e76\u65f6\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u5b9e\u9645\u4e0a\u662f\u4e00\u4e2a $\\dfrac{a'}{b'}=\\dfrac{1}{a_i+\\dfrac{a}{b}}$ \u7684\u5f62\u5f0f\n\n\u90a3\u4e48\u8003\u8651\u4e00\u4e2a $a_i$ \u5408\u5e76\u4e0a\u4e4b\u540e\u4f1a\u5bf9 $a,b$ \u9020\u6210\u4ec0\u4e48\u53d8\u5316\uff1a\n\n$$\\dfrac{a'}{b'}=\\dfrac{1}{a_i+\\dfrac{a}{b}}=\\dfrac{b}{a_i\\times b+a}$$\n\n\u4e5f\u5c31\u662f\uff1a$a'=b,b'=a_i\\times b+a$\n\n\u8fd9\u53ef\u4ee5\u7528\u77e9\u9635\u6765\u63cf\u8ff0\uff1a\n\n$$ \\begin{bmatrix} a' \\\\ b' \\end{bmatrix} = \\begin{bmatrix} 0 & 1 \\\\ 1 & a_i \\end{bmatrix} \\begin{bmatrix} a \\\\ b \\end{bmatrix} $$\n\n\u597d\u8036\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5f0f\u5b50\n\n$$ \\begin{bmatrix} 0 & 1 \\\\ 1 & a_0 \\end{bmatrix} \\begin{bmatrix} 0 & 1 \\\\ 1 & a_1 \\end{bmatrix} \\begin{bmatrix} 0 & 1 \\\\ 1 & a_2 \\end{bmatrix} \\cdots \\begin{bmatrix} 0 & 1 \\\\ 1 & a_k \\end{bmatrix} \\begin{bmatrix} 0\\\\ 1 \\end{bmatrix} $$\n\n\u6765\u6c42\u51fa\u6700\u540e\u7684\u5206\u6570\u4e86\uff0c~~\u7136\u800c\u8fd9\u4e5f\u662f\u4e00\u4e2a\u66b4\u529b~~\u3002\n\n## Part2\n\n\u597d\u4e86\u6211\u4eec\u6709\u4e86\u4e00\u4e2a\u77e9\u9635\u63cf\u8ff0\u8fde\u5206\u6570\u7684\u60f3\u6cd5\uff0c\u7531\u4e8e\u77e9\u9635\u4e58\u6cd5\u6709\u7ed3\u5408\u5f8b\uff0c\u53ef\u4ee5\u4efb\u610f\u53d8\u6362\u4e58\u6cd5\u7684\u5148\u540e\u987a\u5e8f\uff0c\u90a3\u4e48\u6211\u4eec\u80fd\u5426\u4f7f\u7528\u5e38\u77e9\u9635\u6765\u63cf\u8ff0 ```W``` \u548c ```E``` \u64cd\u4f5c\u5462\uff1f\n\n\u9996\u5148\u770b\u4e00\u4e0b ```W``` \u64cd\u4f5c\uff0c\u5b83\u8ba9 $a_k\\rightarrow a_k+1$\n\n\u8003\u8651\u77e9\u9635\u4ece $\\begin{bmatrix} 0 & 1 \\\\ 1 & a_k \\end{bmatrix}$ \u53d8\u6210\u4e86 $\\begin{bmatrix} 0 & 1 \\\\ 1 & a_k+1 \\end{bmatrix}$\u3002\n\n\u4e00\u5b9a\u662f\u6709\u4e00\u4e2a\u77e9\u9635 $\\begin{bmatrix} x & y \\\\ z & w \\end{bmatrix}$\uff0c\u4f7f\u5f97 $\\begin{bmatrix} 0 & 1 \\\\ 1 & a_k \\end{bmatrix}\\begin{bmatrix} x & y \\\\ z & w \\end{bmatrix}=\\begin{bmatrix} 0 & 1 \\\\ 1 & a_k+1 \\end{bmatrix}$\u3002\n\n\u901a\u8fc7\u6784\u9020\u53ef\u4ee5\u5f97\u5230 $\\begin{bmatrix} x & y \\\\ z & w \\end{bmatrix}=\\begin{bmatrix} 1 & 1 \\\\ 0 & 1 \\end{bmatrix}$\uff0c\u4e5f\u5c31\u662f\u5982\u679c\u51fa\u73b0\u4e86\u4e00\u4e2a ```W``` \u64cd\u4f5c\uff0c\u90a3\u53ef\u4ee5\u5728\u77e9\u9635\u8fde\u4e58\u79ef\u7684\u6700\u540e\u518d\u4e58\u4e0a\u4e00\u4e2a $\\begin{bmatrix} 1 & 1 \\\\ 0 & 1 \\end{bmatrix}$\uff0c\u4ece\u800c\u4e00\u4e2a ```W``` \u64cd\u4f5c\u53ef\u4ee5\u7528\u4e00\u4e2a\u5e38\u77e9\u9635\u6765\u63cf\u8ff0\u3002\n\n\u4e4b\u540e\u662f ```E``` \u64cd\u4f5c\uff0c\u8981\u5206 $a_k=1$ \u548c $a_k>1$ \u4e24\u79cd\u60c5\u51b5\uff0c\u9996\u5148\u6765\u770b\u4e00\u4e0b $a_k>1$ \u65f6\u7684\u60c5\u51b5\u3002\n\n- $a_k\\rightarrow a_k-1$\uff1b\n- \u6dfb\u52a0\u4e24\u4e2a $1$ \u5230\u6570\u5217\u672b\u5c3e\u3002\n\n\u7b2c\u4e00\u4e2a $a_k\\rightarrow a_k-1$\uff0c\u53ef\u4ee5\u4f9d\u7167\u4e0a\u9762\u7684\u601d\u60f3\uff0c\u6784\u9020 $\\begin{bmatrix} 0 & 1 \\\\ 1 & a_k \\end{bmatrix}\\begin{bmatrix} 1 & -1 \\\\ 0 & 1 \\end{bmatrix}=\\begin{bmatrix} 0 & 1 \\\\ 1 & a_k-1 \\end{bmatrix}$\u3002\n\n\u4e4b\u540e\u662f\u4e24\u4e2a\u6dfb\u52a0\u64cd\u4f5c\uff0c\u90a3\u4e48\u5c31\u76f4\u63a5\u5728\u77e9\u9635\u8fde\u4e58\u79ef\u7684\u672b\u5c3e\u518d\u4e58\u4e0a $\\begin{bmatrix} 0 & 1 \\\\ 1 & 1 \\end{bmatrix}\\begin{bmatrix} 0 & 1 \\\\ 1 & 1 \\end{bmatrix}$\u3002\n\n\uff08\u6ce8\u610f\u6240\u6709\u7684\u8fd9\u4e9b\u77e9\u9635\u4e58\u6cd5\u90fd\u53ef\u4ee5\u901a\u8fc7\u4f7f\u7528\u7ed3\u5408\u5f8b\u6539\u53d8\u4e58\u6cd5\u987a\u5e8f\u5f97\u5230\u5b9e\u9645\u610f\u4e49\uff09\n\n\u4e8e\u662f\u7b2c\u4e00\u79cd $a_k>1$ \u7684\u60c5\u51b5\u53ef\u4ee5\u5728\u8fde\u4e58\u79ef\u4e4b\u540e\u4e58\u4e0a $\\begin{bmatrix} 1 & -1 \\\\ 0 & 1 \\end{bmatrix}\\begin{bmatrix} 0 & 1 \\\\ 1 & 1 \\end{bmatrix}\\begin{bmatrix} 0 & 1 \\\\ 1 & 1 \\end{bmatrix}=\\begin{bmatrix} 0 & -1 \\\\ 1 & 2 \\end{bmatrix}$ \u6765\u63cf\u8ff0\u3002\n\n\u8fd8\u6709\u7b2c\u4e8c\u79cd $a_k=1$ \u7684\u60c5\u51b5\uff0c\u6b64\u65f6\u6709 $a_{k-1}\\rightarrow a_{k-1}+1$\uff0c\u8fd9\u4f3c\u4e4e\u6bd4\u8f83\u96be\u76f4\u63a5\u6784\u9020\u4e00\u4e2a\u77e9\u9635\u3002\n\n\u7136\u540e\u6211\u4eec\u7075\u673a\u4e00\u52a8\uff0c\u8fd9\u4e2a $a_k>1$ \u65f6\u6570\u5217\u7684\u53d8\u5316\u8fd9\u4e48\u9634\u95f4\uff0c\u4e00\u5b9a\u662f\u6709\u610f\u5f04\u6210\u8fd9\u6837\u6765\u8fbe\u5230\u67d0\u4e2a\u76ee\u7684\u7684\uff0c\u4e8e\u662f\u6211\u4eec\u5927\u80c6\u731c\u60f3 $a_k=1$ \u65f6\u7684\u77e9\u9635\u4e5f\u662f $\\begin{bmatrix} 0 & -1 \\\\ 1 & 2 \\end{bmatrix}$\uff0c\u53ef\u4ee5\u9a8c\u8bc1\u8fd9\u662f\u5bf9\u7684\uff1a\n\n\u5f53 $a_k=1$ \u65f6\uff0c$a_k$ \u5bf9\u5e94\u7684\u77e9\u9635\u5c31\u662f $\\begin{bmatrix} 0 & 1 \\\\ 1 & 1 \\end{bmatrix}$\uff0c\u6309\u6b63\u5e38\u7684\u987a\u5e8f\uff0c\u5e94\u5f53\u662f\uff08\u6700\u540e\u4e24\u9879\u4e3a\uff09$\\begin{bmatrix} 0 & 1 \\\\ 1 & a_{k-1} \\end{bmatrix}\\begin{bmatrix} 1 & 1 \\\\ 0 & 1 \\end{bmatrix}\\begin{bmatrix} 0 & 1 \\\\ 1 & 1 \\end{bmatrix}$\uff08\u4e2d\u95f4\u4e00\u9879\u662f\u4f7f $a_{k-1}+1$ \u7684\u77e9\u9635\uff0c\u6700\u540e\u4e00\u9879\u662f $a_k$ \u5bf9\u5e94\u7684\u77e9\u9635\uff0c\u6ce8\u610f\u7531\u4e8e\u7ed3\u5408\u5f8b\u6211\u6ca1\u6709\u5199\u4e0a\u62ec\u53f7\uff0c\u5728\u5b9e\u9645\u8ba1\u7b97\u4e2d\u53ef\u4ee5\u6309\u987a\u5e8f\u8fdb\u884c\u4e58\u6cd5\uff09\uff0c\u8fd9\u4e2a\u4e1c\u897f\u5316\u7b80\u51fa\u6765\u662f $\\begin{bmatrix} 0 & 1 \\\\ 1 & a_{k-1} \\end{bmatrix}\\begin{bmatrix} 1 & 2 \\\\ 1 & 1 \\end{bmatrix}$\u3002\n\n\u800c\u5982\u679c\u6211\u4eec\u76f4\u63a5\u5728\u6700\u540e\u4e58\u4e0a\u4e00\u4e2a $\\begin{bmatrix} 0 & -1 \\\\ 1 & 2 \\end{bmatrix}$\uff0c\u4f1a\u5f97\u5230 $\\begin{bmatrix} 0 & 1 \\\\ 1 & a_{k-1} \\end{bmatrix}\\begin{bmatrix} 0 & 1 \\\\ 1 & 1 \\end{bmatrix}\\begin{bmatrix} 0 & -1 \\\\ 1 & 2 \\end{bmatrix}$\uff0c\u8fd9\u4e2a\u5316\u7b80\u51fa\u6765\u662f $\\begin{bmatrix} 0 & 1 \\\\ 1 & a_{k-1} \\end{bmatrix}\\begin{bmatrix} 1 & 2 \\\\ 1 & 1 \\end{bmatrix}$\uff0c\u4e0e\u524d\u9762\u90a3\u4e2a\u521a\u597d\u76f8\u540c\uff01\u6240\u4ee5\u76f4\u63a5\u5728\u8fde\u4e58\u79ef\u4e4b\u540e\u4e58\u4e0a\u4e00\u4e2a $\\begin{bmatrix} 0 & -1 \\\\ 1 & 2 \\end{bmatrix}$ \u7684\u5927\u80c6\u60f3\u6cd5\u662f\u6b63\u786e\u7684\u3002\n\n\u6240\u4ee5\u6211\u4eec\u7528\u4e00\u4e2a $\\begin{bmatrix} 1 & 1 \\\\ 0 & 1 \\end{bmatrix}$ \u6765\u63cf\u8ff0 ```W``` \u64cd\u4f5c\uff0c\u4e00\u4e2a $\\begin{bmatrix} 0 & -1 \\\\ 1 & 2 \\end{bmatrix}$ \u6765\u63cf\u8ff0 ```E``` \u64cd\u4f5c\u3002\n\n## Part3\n\nds \u5e26\u5e08\u53ef\u4ee5\u7565\u8fc7\u8fd9\u4e00\u90e8\u5206\n\n\u4e4b\u540e ```W``` \u548c ```E``` \u64cd\u4f5c\u5c31\u5206\u522b\u5bf9\u5e94\u4e00\u79cd\u77e9\u9635\uff0c\u8981\u7528\u67d0\u79cd\u6570\u636e\u7ed3\u6784\u7ef4\u62a4\u77e9\u9635\u8fde\u4e58\u79ef\uff0c\u652f\u6301\u533a\u95f4\u53d6\u53cd\u548c\u533a\u95f4\u7ffb\u8f6c\u3002\n\n\u8981\u7ef4\u62a4\u7684\u4fe1\u606f\u662f\u533a\u95f4\u8fde\u4e58\u79ef\uff0c\u533a\u95f4\u53d6\u53cd\u8fde\u4e58\u79ef\uff0c\u533a\u95f4\u7ffb\u8f6c\u8fde\u4e58\u79ef\uff0c\u533a\u95f4\u53d6\u53cd\u7ffb\u8f6c\u8fde\u4e58\u79ef\uff0c\u548c\u4e24\u4e2a $\\rm tag$\uff1a\u662f\u5426\u53d6\u53cd\uff0c\u662f\u5426\u7ffb\u8f6c\u3002\n\n\u6709\u4e86\u533a\u95f4\u7ffb\u8f6c\u64cd\u4f5c\uff0c\u90a3\u5c31\u8981\u7528\u5e73\u8861\u6811\u800c\u975e\u7ebf\u6bb5\u6811\u6765\u7ef4\u62a4\u533a\u95f4\u4e86\uff0c\u9009\u7528\u4efb\u4f55\u4e00\u79cd\u53ef\u4ee5\u652f\u6301\u533a\u95f4\u7ffb\u8f6c\u7684\u5e73\u8861\u6811\u90fd\u53ef\u4ee5\u5b9e\u73b0\uff0c\u6211\u5728\u8003\u573a\u4e0a\u4f7f\u7528\u7684\u662f $\\rm fhq\\ treap$\uff08\u4eba\u50bb\u5e38\u6570\u5927\u7ed3\u679c\u88ab\u5361\u6210 70 \u5206\uff09\n\n## Part4\n\n\u5c0f\u5c0f\u7ec6\u8282\uff1a\n\n- \u5728\u6700\u5f00\u59cb\u6570\u5217\u4e2d\u6709 $a_0=0,a_1=1$\uff0c\u56e0\u6b64\u521d\u59cb\u7684\u77e9\u9635\u8fde\u4e58\u79ef\u662f $\\begin{bmatrix} 0 & 1 \\\\ 1 & 0 \\end{bmatrix}\\begin{bmatrix} 0 & 1 \\\\ 1 & 1 \\end{bmatrix}=\\begin{bmatrix} 1 & 1 \\\\ 0 & 1 \\end{bmatrix}$\u3002\n\n- \u62c6\u4e86\u7ed3\u6784\u4f53 $70 \\rightarrow 100$\uff08\u607c\uff09\u3002\n\n- ~~fhq treap \u771f\u7684\u6253\u4e0d\u8fc7 splay~~\u3002\n\ncode\uff1a\n\n```c++\nconst int mod=998244353;\nconst int N=2e5+500;\nstruct mat{ int a00,a01,a10,a11; } I,a,b,cur;\nint pri[N],siz[N],ls[N],rs[N],tagf[N],tagi[N];\nmat val[N],fil[N],inv[N],fnv[N],It[N],Itv[N];\nint n,q,l,r,rt,rt1,rt2,rt3,rt4,treesize;\nchar s[N],c[100];\nmat operator * (const mat& a, const mat& b){\n\tmat c;\n\tc.a00=(1ll*a.a00*b.a00+1ll*a.a01*b.a10)%mod;\n\tc.a01=(1ll*a.a00*b.a01+1ll*a.a01*b.a11)%mod;\n\tc.a10=(1ll*a.a10*b.a00+1ll*a.a11*b.a10)%mod;\n\tc.a11=(1ll*a.a10*b.a01+1ll*a.a11*b.a11)%mod;\n\treturn c;\n}\ninline int Newnode(int k){\n\tint now=++treesize;\n\tif (k==0){\n\t\tval[now]=a; inv[now]=b;\n\t\tfil[now]=a; fnv[now]=b;\n\t\tIt[now]=a; Itv[now]=b;\n\t} else {\n\t\tval[now]=b; inv[now]=a;\n\t\tfil[now]=b; fnv[now]=a;\n\t\tIt[now]=b; Itv[now]=a;\n\t}\n\tsiz[now]=1;\n\treturn now;\n}\ninline void pushup(int now){\n\tif (!now) return;\n\tsiz[now]=siz[ls[now]]+siz[rs[now]]+1;\n\t\n\tval[now]=(val[ls[now]]*It[now])*val[rs[now]];\n\tinv[now]=(inv[ls[now]]*Itv[now])*inv[rs[now]];\n\t\n\tfil[now]=(fil[rs[now]]*It[now])*fil[ls[now]];\n\tfnv[now]=(fnv[rs[now]]*Itv[now])*fnv[ls[now]];\n}\ninline void pushtagf(int now){\n\tif (!now) return;\n\tswap(val[now],fil[now]);\n\tswap(inv[now],fnv[now]);\n\tswap(ls[now],rs[now]);\n\ttagf[now]^=1;\n}\ninline void pushtagi(int now){\n\tif (!now) return;\n\tswap(val[now],inv[now]);\n\tswap(fil[now],fnv[now]);\n\tswap(It[now],Itv[now]);\n\ttagi[now]^=1;\n}\ninline void pushdown(int now){\n\tif (!now) return;\n\tif (tagf[now]) pushtagf(ls[now]),pushtagf(rs[now]),tagf[now]=0;\n\tif (tagi[now]) pushtagi(ls[now]),pushtagi(rs[now]),tagi[now]=0;\n}\nint Merge(int now, int las){\n\tif (!now || !las) return now|las;\n\tpushdown(now); pushdown(las);\n\tif (pri[now]<pri[las]){\n\t\trs[now]=Merge(rs[now],las);\n\t\tpushup(now); return now;\n\t} else {\n\t\tls[las]=Merge(now,ls[las]);\n\t\tpushup(las); return las;\n\t}\n}\nvoid Split(int now, int& r1, int& r2, int pos){\n\tif (!now){ r1=r2=0; return; }\n\tpushdown(now);\n\tif (siz[ls[now]]+1<=pos) r1=now,Split(rs[now],rs[r1],r2,pos-siz[ls[now]]-1);\n\telse r2=now,Split(ls[now],r1,ls[r2],pos);\n\tpushup(r1); pushup(r2);\n}\nint main(){\n\tfreopen(\"code.in\",\"r\",stdin);\n\tfreopen(\"code.out\",\"w\",stdout);\n\tscanf(\"%d%d\",&n,&q);\n\tscanf(\"%s\",s+1);\n\t\n\tsrand(19260817);\n\tfor (int i=1; i<=n+q; i++) pri[i]=i;\n\trandom_shuffle(pri+1,pri+1+n+q);\n\tI.a00=I.a11=1; I.a10=I.a01=0;\n\ta.a00=a.a01=a.a11=1; a.a10=0;\n\tb.a00=0,b.a01=mod-1,b.a10=1,b.a11=2;\n\t\n\tval[0]=fil[0]=inv[0]=fnv[0]=It[0]=Itv[0]=I;\n\t\n\tfor (int i=1; i<=n; i++) rt=Merge(rt,Newnode(s[i]=='W'?0:1));\n\t\n\tcur=a*val[rt];\n\tprintf(\"%d %d\\n\",cur.a11,cur.a01);\n\t\n\tfor (; q; q--){\n\t\tscanf(\"%s\",c+1);\n\t\tif (c[1]=='A'){\n\t\t\tscanf(\"%s\",c+1);\n\t\t\trt=Merge(rt,Newnode(c[1]=='W'?0:1));\n\t\t} else\n\t\tif (c[1]=='F'){\n\t\t\tscanf(\"%d%d\",&l,&r);\n\t\t\tSplit(rt,rt1,rt2,r);      // rt1:[1..r],rt2:[r+1..n]\n\t\t\tSplit(rt1,rt3,rt4,l-1);   // rt3:[1..l-1],rt4:[l..r]\n\t\t\tpushtagi(rt4);\n\t\t\trt=Merge(Merge(rt3,rt4),rt2);\n\t\t} else {\n\t\t\tscanf(\"%d%d\",&l,&r);\n\t\t\tSplit(rt,rt1,rt2,r);      // rt1:[1..r],rt2:[r+1..n]\n\t\t\tSplit(rt1,rt3,rt4,l-1);   // rt3:[1..l-1],rt4:[l..r]\n\t\t\tpushtagf(rt4);\n\t\t\trt=Merge(Merge(rt3,rt4),rt2);\n\t\t}\n\t\tcur=a*val[rt];\n\t\tprintf(\"%d %d\\n\",cur.a11,cur.a01);\n\t}\n\treturn 0;\n}\n/*\n2 3\nWE\nAPPEND E\nFLIP 1 2\nREVERSE 2 3\n*/\n```\n\n\u4ee3\u7801\u4ec5\u4f9b\u53c2\u8003\uff0c\u4e0d\u559c\u52ff\u55b7\u3002\n\n## Bonus\n\n\u63d0\u4f9b\u4e00\u4e2a\u53ea\u7528\u7ef4\u62a4\u8fde\u4e58\u79ef\u7684\u505a\u6cd5\uff0c\u4e0d\u9700\u8981\u7ef4\u62a4 $4$ \u4e2a\u4e58\u79ef\uff1a\n\n\u5bf9\u4e00\u4e2a\u77e9\u9635 $\\begin{bmatrix} a & b \\\\ c & d \\end{bmatrix}$\uff0c\u8003\u8651\u76f4\u63a5\u901a\u8fc7 $a,b,c,d$ \u7684\u7ebf\u6027\u7ec4\u5408\u51d1\u51fa ```Flip``` \u548c ```Reverse``` \u64cd\u4f5c\u5e8f\u5217\u4e4b\u540e\u7684\u77e9\u9635\u3002\n\n\u901a\u8fc7\u8fd9\u9898\u7684\u7279\u6b8a\u6027\uff08\u53ea\u6709\u4e24\u79cd\u5e38\u77e9\u9635\u7684\u4e58\u79ef\uff09~~\u548c\u4eba\u7c7b\u667a\u6167\uff08\u6307\u9ad8\u65af\u6d88\u5143\u89e3\u65b9\u7a0b\u7ec4\uff09~~\uff0c\u51d1\u51fa\u4e86\u4ee5\u4e0b\u77e9\u9635\u53d8\u6362\uff1a\n\n$$ \\operatorname{Flip}\\left(\\begin{bmatrix} a & b \\\\ c & d \\end{bmatrix}\\right)=\\begin{bmatrix} a-b & -b \\\\ -a+b-c+d & b+d \\end{bmatrix} $$\n\n$$ \\operatorname{Reverse}\\left(\\begin{bmatrix} a & b \\\\ c & d \\end{bmatrix}\\right)=\\begin{bmatrix} d-2c & -2a+b-4c+2d \\\\ c & a+2c \\end{bmatrix} $$\n\n\u8fd9\u4e24\u4e2a\u90fd\u53ef\u4ee5\u7528\u6570\u5b66\u5f52\u7eb3\u6cd5\u8bc1\u660e\u5bf9\u4efb\u610f\u64cd\u4f5c\u5e8f\u5217\u90fd\u662f\u5bf9\u7684\u3002\n\n\u90a3\u4e48\u5728 ```pushup``` \u7684\u65f6\u5019\u77e9\u9635\u4e58\u6cd5\u7684\u6b21\u6570\u5c31\u4f1a\u51cf\u5c11\u81f3\u539f\u6765\u7684 $\\dfrac{1}{4}$\uff0c\u5e38\u6570\u663e\u8457\u4f18\u5316 ~~\uff08\u8fd8\u662f\u6253\u4e0d\u8fc7 splay\uff09~~\u3002\n\n```c++\ninline void pushtagf(int now){\n\tif (!now) return;\n\t\n\tint A=val[now].a00,B=val[now].a01,C=val[now].a10,D=val[now].a11;\n\tval[now]=(mat){(D-2*C%mod+mod)%mod,((-2ll*A+B-4ll*C+2ll*D)%mod+mod)%mod,C,(A+2*C%mod)%mod};\n\t\n\tswap(ls[now],rs[now]);\n\ttagf[now]^=1;\n}\ninline void pushtagi(int now){\n\tif (!now) return;\n\tint A=val[now].a00,B=val[now].a01,C=val[now].a10,D=val[now].a11;\n\tval[now]=(mat){(A-B+mod)%mod,(mod-B)%mod,((D-A+B-C)%mod+mod)%mod,(B+D)%mod};\n\t\n\tA=It[now].a00,B=It[now].a01,C=It[now].a10,D=It[now].a11;\n\tIt[now]=(mat){(A-B+mod)%mod,(mod-B)%mod,((D-A+B-C)%mod+mod)%mod,(B+D)%mod};\n\ttagi[now]^=1;\n}\n```\n\n\u6700\u540e\u611f\u8c22\u7ba1\u7406\u5bf9\u683c\u5f0f\u95ee\u9898\u7684\u6307\u51fa\u548c\u7c89\u5154\u7684\u4fee\u6539\n\n\u6c42\u8d5e qwq",
        "postTime": 1627617982,
        "uid": 44599,
        "name": "wishapig",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P7739 [NOI2021] \u5bc6\u7801\u7bb1"
    },
    {
        "content": "\u9996\u5148\u6bd4\u8f83\u663e\u7136\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u6570\u5217\u4e2d\u7684\u6570\u4e24\u4e24\u53d8\u6210\u4e00\u7ec4\uff0c\u5bf9\u4e8e\u540c\u4e00\u7ec4\uff0c\u6211\u4eec\u601d\u8003\u5bf9\u4ed6\u8fdb\u884c\u7684\u64cd\u4f5c\u5e8f\u5217\u7684\u5f62\u5f0f\u5fc5\u7136\u662f$EE...EWW...WE$ \uff0c\u6211\u4eec\u8003\u8651\u5176\u6700\u540e\u7684\u6570\u503c\u4e0e\u64cd\u4f5c\u5e8f\u5217\u662f\u4ec0\u4e48\u6837\u7684\u3002\n\n\u6211\u4eec\u4e0d\u59a8\u8bbe $E$ \u7684\u4e2a\u6570\uff08\u9664\u53bb\u6700\u540e\u4e00\u4e2a $E$ \uff0c\u4ed6\u5c06\u4f5c\u4e3a\u4e0b\u4e00\u7ec4\u7684 $E$ \uff09\u662f $cnt_e$ \uff0c $W$ \u7684\u4e2a\u6570\u662f $cnt_w$ \uff0c\u90a3\u4e48\u4e00\u7ec4\u4e2d\u7684\u4e24\u4e2a\u6570\u5c31\u5206\u522b\u662f $cnt_e$ \u548c $cnt_w$ \u3002\u5f53\u7136\uff0c\u6700\u540e\u4e00\u7ec4\u7684 $cnt_w$ \u9700\u8981 $+1$ \u3002\u8fd9\u4e2a\u53ef\u4ee5\u81ea\u5df1\u624b\u6a21\u9a8c\u8bc1\u6b63\u786e\u6027\u3002\n\n\u6211\u4eec\u63a2\u8ba8\u4e00\u4e0b\u6700\u7ec8\u5f0f\u5b50\u4e0e $cnt_e$ \u548c $cnt_w$ \u7684\u5173\u7cfb\u3002\n\n\u6211\u4eec\u8bd5\u7740\u53ef\u4ee5\u5c06\u4e00\u4e2a\u957f\u5ea6\u4e3a $4$ \u7684\u5e8f\u5217\u7684\u7b54\u6848\u8868\u793a\u51fa\u6765\u3002\n\n$$\nans=\\frac{a_0a_1a_2a_3+a_0a_1+a_0a_3+a_2a_3+1}{a_1a_2a_3+a_1+a_3}\n$$\n\n\u5176\u4e2d $a_{2k+1}$ \u5bf9\u5e94\u7684\u662f $cnt_w$ \uff0c$a_{2k}$ \u5bf9\u5e94\u7684\u662f $cnt_e$ \u3002\n\n\u9996\u5148\u6613\u8bc1\u660e\u5f97\u7b54\u6848\u4e2d\u7684 $a$ \u548c $b$ \u4e00\u5b9a\u4e92\u8d28\u3002\n\n\u6211\u4eec\u4e0d\u59a8\u5206\u522b\u6c42\u51fa $a$ \u548c $b$ \uff0c\u4e24\u8005\u7684\u7ec4\u5408\u610f\u4e49\u6211\u4eec\u53ef\u4ee5\u6839\u636e\u5f0f\u5b50\u5f97\u51fa\u3002\n\n$a$ \u7684\u610f\u4e49\u5c31\u662f\u9009\u62e9\u4ee5 $E$ \u4e3a\u5f00\u5934\u4ee5 $W$ \u4e3a\u7ed3\u5c3e\u7684 $EW$ \u95f4\u9694\u51fa\u73b0\u7684\u5b50\u5e8f\u5217\u7684\u65b9\u6848\u4e2a\u6570 $+1$ \u3002\n\n$b$ \u7684\u610f\u4e49\u5c31\u662f\u9009\u62e9\u4ee5 $W$ \u4e3a\u5f00\u5934\u4ee5 $W$ \u4e3a\u7ed3\u5c3e\u7684 $EW$ \u95f4\u9694\u51fa\u73b0\u7684\u5b50\u5e8f\u5217\u7684\u65b9\u6848\u4e2a\u6570\u3002\n\n\u7136\u540e\u7ef4\u62a4\u8fd9\u4e2a\u4e1c\u897f\u914d\u5408\u4e0a\u540e\u9762\u7684\u4e24\u79cd\u64cd\u4f5c\uff0c\u53ef\u4ee5\u7528\u5e73\u8861\u6811\u6765\u7ef4\u62a4\u3002",
        "postTime": 1627456296,
        "uid": 72468,
        "name": "\u300c\u3000\u300d",
        "ccfLevel": 0,
        "title": "P7739 [NOI2021] \u5bc6\u7801\u7bb1"
    },
    {
        "content": "\u4eba\u751f\u9996\u9ed1\u8bf6\uff0c\u7eaa\u5ff5\u4e0b~\n\n\u9996\u5148\u6211\u4eec\u8003\u8651\u4e0b\u8fd9\u4e2a\u590d\u6742\u7684\u51fd\u6570\u5230\u5e95\u662f\u4e2a\u4ec0\u4e48\u4e1c\u897f\uff0c\u6211\u4eec\u8003\u8651\u9012\u63a8\uff0c\u8bbe\u539f\u6765\u7684\u5206\u6570\u4e3a $(x,y)$\uff0c\u8868\u793a $\\dfrac{y}{x}$\u3002\n\n\u5bb9\u6613\u53d1\u73b0\uff0c\u4e00\u6b21\u64cd\u4f5c\u7b49\u4ef7\u4e8e\uff1a\n\n$$\\dfrac{y}{x}\\to\\dfrac{x}{y}+a_k=\\dfrac{ya_k+x}{y}$$\n\n$$(x,y)\\to(y,ya_k+x)$$\n\n\u8003\u8651\u7528\u77e9\u9635\u5f62\u5f0f\u8f6c\u79fb\uff0c\u6784\u9020\u8f6c\u79fb\u77e9\u9635\u5f97\uff1a\n\n$$(x,y)\\begin{pmatrix}0&1\\\\1&a_k\\end{pmatrix}=(y,ya_k+x)$$\n\n\u81f3\u6b64\uff0c\u6211\u4eec\u7528\u77e9\u9635\u8868\u793a\u51fa\u4e86 $f$ \u51fd\u6570\uff0c\u7136\u9e45\uff0c\u8fd9\u8fd8\u662f\u66b4\u529b\uff0c**\u4f46\u662f\uff0c\u8fd9\u542f\u793a\u6211\u4eec\uff0c\u53ef\u4ee5\u7528\u77e9\u9635\u6765\u505a\u8fd9\u9053\u9898\uff01**\n\n\u8003\u8651\u7528\u77e9\u9635\u641e\u51fa\u8fd9\u4e2a `W` \u548c `E` \u64cd\u4f5c\u3002\n\n**`W` \u64cd\u4f5c**\n\n`W` \u64cd\u4f5c\u7b49\u4ef7\u4e8e\uff08\u77e9\u9635\u5f62\u5f0f\uff09\uff1a\n\n$$\\begin{pmatrix}0&1\\\\1&a_k\\end{pmatrix}\\begin{pmatrix}?&?\\\\?&?\\end{pmatrix}=\\begin{pmatrix}0&1\\\\1&a_k+1\\end{pmatrix}$$\n\n\u6613\u5f97\u8f6c\u79fb\u77e9\u9635\u4e3a\uff1a\n\n$$\\begin{pmatrix}1&1\\\\0&1\\end{pmatrix}$$\n\n**`E` \u64cd\u4f5c**\n\n\u8fd9\u4e2a\u6709\u70b9\u9ebb\u70e6\uff0c\u6211\u4eec\u5148\u6765\u770b\u672b\u5c3e\u4e0d\u4e3a $1$ \u65f6\u7684\u60c5\u51b5\uff1a\n\n\u7b49\u4ef7\u4e8e\n\n$$\\begin{pmatrix}0&1\\\\1&a_k\\end{pmatrix}\\begin{pmatrix}?&?\\\\?&?\\end{pmatrix}=\\begin{pmatrix}0&1\\\\1&a_k-1\\end{pmatrix}$$\n\n\u53d1\u73b0\u8fd9\u4e2a\u95ee\u53f7\u77e9\u9635\u5c31\u662f\n\n$$\\begin{pmatrix}1&-1\\\\0&1\\end{pmatrix}$$\n\n\u6211\u4eec\u628a\u540e\u9762\u7684\u4e24\u6b21\u52a0 $1$ \u64cd\u4f5c\u4e5f\u5f04\u4e0a\u53bb\uff0c\u5c31\u662f\uff1a\n\n$$\\begin{pmatrix}1&-1\\\\0&1\\end{pmatrix}\\begin{pmatrix}0&1\\\\1&1\\end{pmatrix}\\begin{pmatrix}0&1\\\\1&1\\end{pmatrix}=\\begin{pmatrix}0&-1\\\\1&2\\end{pmatrix}$$\n\n\u8fd9\u4e1c\u897f\u4e00\u770b\u5c31\u5f88\u96be\u770b\uff0c\u5927\u80c6\u731c\u4e00\u4e0b\u5728\u672b\u5c3e\u4e3a $1$ \u65f6\u8f6c\u79fb\u77e9\u9635\u4e5f\u662f\u4e00\u6837\u7684\uff0c\u6613\u5f97\u8fd9\u662f\u5bf9\u7684\u3002\n\n**DS**\n\n\u6709\u4e86\u524d\u9762\u7684\u63a8\u5bfc\uff0c\u663e\u7136\u53d1\u73b0\u53ef\u4ee5\u7528\u5e73\u8861\u6811\u7ef4\u62a4\uff0c\u7ef4\u62a4\u56db\u4e2a\u4e1c\u897f\uff1a\n\n- \u77e9\u9635\u79ef \n- \u77e9\u9635\u7ffb\u8f6c\u79ef\n- \u77e9\u9635 `Flip` \u79ef\n- \u77e9\u9635 `Flip` \u7ffb\u8f6c\u79ef\n\n\u8fd9\u6837\u5c31\u53ef\u4ee5\u4e86\u3002\n\n## \u91cd\u8981\uff1a\u5b9e\u73b0\u7ec6\u8282\u90e8\u5206\n\n- \u5982\u679c\u4f60\u5199\u7684\u662f `FHQ-Treap`\uff0c\u7531\u4e8e\u5b83\u5148\u5929\u7684\u5927\u5e38\u6570\uff0c\u518d\u52a0\u4e0a\u77e9\u9635\u4e58\u6cd5\u5e26\u6765\u7684 $4$ \u500d\u5e38\u6570\uff0c\u4f1a\u5f88\u5361\uff0c\u8fd9\u65f6\uff0c\u8bf7\u5c1d\u8bd5\u5faa\u73af\u5c55\u5f00\u77e9\u9635\u4e58\u6cd5\uff0c\u5982\u4e0b\uff1a\n\n```cpp\nMar operator*(const Mar &x)const{\n\tMar ans(n,x.m);\n\tmemset(ans.a,0,sizeof(ans.a));\n\n\tint res1,res2,res3,res4;\n\tres1=a[1][1]*x.a[1][1]+a[1][2]*x.a[2][1];\n\tres2=a[1][1]*x.a[1][2]+a[1][2]*x.a[2][2];\n\tres3=a[2][1]*x.a[1][1]+a[2][2]*x.a[2][1];\n\tres4=a[2][1]*x.a[1][2]+a[2][2]*x.a[2][2];\n\n\tans.a[1][1]=res1;ans.a[1][2]=res2;ans.a[2][1]=res3;ans.a[2][2]=res4;\n\n\treturn ans;\n}\n```\n\n\u5176\u4ed6\u6ca1\u5565\u597d\u8bf4\u7684\u4e86~",
        "postTime": 1672496954,
        "uid": 308854,
        "name": "tzl_Dedicatus545",
        "ccfLevel": 6,
        "title": "\u9898\u89e3P7739 [NOI2021] \u5bc6\u7801\u7bb1"
    },
    {
        "content": "\u4e0d\u8981\u5206\u7c7b\u8ba8\u8bba\uff01\uff08\n\n- \u6211\u4eec\u4ece\u540e\u5f80\u524d\u8003\u8651\u64cd\u4f5c\uff0c\u53d1\u73b0\u4e00\u6bb5\u8fde\u7eed\u7684 E \u7684\u672c\u8d28\u5c31\u662f\u5bf9\u5e8f\u5217\u5012\u6570\u7b2c\u4e8c\u4e2a\u6570\u7684\u52a0\u64cd\u4f5c\uff0cW \u7684\u672c\u8d28\u5c31\u662f\u5f53\u524d\u6700\u540e\u4e00\u4e2a\u6570\u7684\u52a0\u64cd\u4f5c\u3002\n- \u4e5f\u5c31\u662f\u8bf4\u6211\u4eec\u80fd\u591f\u5f88\u5feb\u7684\u901a\u8fc7\u8fde\u7eed\u7684 W \u548c E \u7b97\u51fa\u6bcf\u4e2a\u4f4d\u7f6e\u4e0a\u7684\u6570\u3002\n- \u8003\u8651\u77e5\u9053\u4e86\u8fd9\u4e9b\u6570\u5982\u4f55\u5408\u5e76\uff0c\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u6709\u4ea4\u6362\u5f8b\u7684\u4e1c\u897f\u624d\u80fd\u8fdb\u884c\u6811\u5f62\u5206\u6cbb\u7ed3\u6784\u7684\u4f18\u5316\u3002\u6211\u4eec\u8003\u8651\u5f53\u524d\u7684\u5206\u6570 $\\frac{a}{b}$ \u5f53\u524d\u540e\u5b57\u6bcd\u76f8\u540c\u65f6\uff0c\u6bcf\u6b21\u52a0\u4e00\u5176\u5b9e\u662f\u5206\u5b50\u52a0\u4e0a\u5206\u6bcd\u3002\u800c\u6bcf\u6b21\u5b57\u6bcd\u51fa\u73b0\u53d8\u6362\u65f6\uff0c\u5206\u5b50\u5206\u6bcd\u4f1a\u8fdb\u884c\u4e00\u6b21\u4e92\u6362\uff0c\u540c\u65f6\u5206\u5b50\u52a0\u4e0a\u5206\u6bcd\u3002\n- \u8fd9\u6837\u7684\u8fd0\u7b97\uff0c\u5728\u5b83\u4eec\u4e4b\u95f4\u4e92\u76f8\u8d21\u732e\uff0c\u53c8\u9700\u8981\u7ed3\u5408\u7387\uff0c\u6211\u4eec\u4e0d\u7531\u5f97\u60f3\u5230\u77e9\u9635\u4e58\u6cd5\u3002\u5e76\u4e14\u6211\u4eec\u8fd8\u53ef\u4ee5\u5206\u6790\u51fa W,E \u5355\u72ec\u6765\u770b\u662f\u7b49\u4ef7\u7684\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5728\u4e0d\u540c\u7684\u76f8\u90bb\u70b9\u64cd\u4f5c\u5373\u53ef\u3002\n- \u6bcf\u4e2a\u8282\u70b9\u6709\u4e00\u4e2a\u4ece\u5206\u6bcd\u5230\u5206\u5b50\u7684\u8d21\u732e\u7684\u77e9\u9635\u3002\u6bcf\u4e00\u5bf9\u4e0d\u540c\u7684\u76f8\u90bb\u8282\u70b9\u4e4b\u95f4\u6709\u4e00\u4e2a\u4ea4\u6362\u5206\u6bcd\u5206\u5b50\u7684\u77e9\u9635\uff0c\u8fd9\u6837\u8bbe\u521d\u59cb\u6761\u4ef6 $a=b=1$\uff0c\u77e9\u9635\u540e\u7f00\u79ef\u5c31\u662f\u7b54\u6848\uff0c\u6ce8\u610f\u6700\u5f00\u59cb\u8fd8\u6709\u4e2a\u96f6\uff0c\u5373\u8981\u4ea4\u6362\u5206\u6bcd\u5206\u5b50\u3002\n- \u8003\u8651\u9898\u76ee\u7ed9\u6211\u4eec\u7684\u4fee\u6539\u64cd\u4f5c\u3002\n\t- \u533a\u95f4\u53cd\u8f6c\uff1a\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u8fd9\u4e2a\u64cd\u4f5c\u53ea\u4f1a\u6539\u53d8\u6700\u591a\u4e24\u4e2a\u76f8\u90bb\u70b9\u5bf9\u7684\u5f02\u540c\u5173\u7cfb\uff0c\u76f4\u63a5\u7ef4\u62a4\u5373\u53ef\u3002\n\t- \u533a\u95f4\u7ffb\u8f6c\uff1a\u533a\u95f4\u7ffb\u8f6c\u80af\u5b9a\u6d89\u53ca\u6811\u5f62\u5206\u6cbb\u7ed3\u6784\u7684\u6539\u53d8\uff0c\u8003\u8651\u5e73\u8861\u6811\u8fdb\u884c\u7ef4\u62a4\uff0c\u6211\u4eec\u53d1\u73b0\u5728\u7ffb\u8f6c\u65f6\u4e0d\u597d\u76f4\u63a5\u901a\u8fc7\u5f53\u524d\u4fe1\u606f\u8ba1\u7b97\u51fa\u7ffb\u8f6c\u540e\u7684\u4fe1\u606f\uff0c\u7528\u63d0\u524d\u7ef4\u62a4\u7684\u601d\u60f3\uff0c\u5728\u7ef4\u62a4\u540e\u7f00\u79ef\u65f6\u76f4\u63a5\u7ef4\u62a4\u524d\u7f00\u79ef\uff0c\u533a\u95f4\u7ffb\u8f6c\u7684\u65f6\u5019\u76f4\u63a5\u4ea4\u6362\u5373\u53ef\u3002\n\n```\n//ayame\u4fdd\u4f51\uff0c\u5938\u54e5\u4fdd\u4f51\uff0c\u72d7\u5988\u4fdd\u4f51\uff0cMDR\u4fdd\u4f51\uff0c\u9509\u5200\u602a\u4fdd\u4f51\uff0cM99\u4fdd\u4f51\uff0c\u514b\u7239\u4fdd\u4f51\n#include<bits/stdc++.h>\nusing namespace std;\nint p1=1000000,p2=0;\nchar buf[1000005],wb[1000005];\nint gc() {\n\tif(p1>=1000000)fread(buf,1,1000000,stdin),p1=0;\n\treturn buf[p1++];\n}\n#define gc getchar\n#define Loli true\n#define Kon xor true\nlong long getint() {\n\tlong long ret=0,flag=1;\n\tchar c=gc();\n\twhile(c<'0'||c>'9') {\n\t\tif(c=='-')flag=-1;\n\t\tc=gc();\n\t}\n\twhile(c<='9'&&c>='0') {\n\t\tret=(ret<<3)+(ret<<1)+c-'0';\n\t\tc=gc();\n\t}\n\treturn ret*flag;\n}\nvoid pc(char x) {\n\tif(p2>=1000000)fwrite(wb,1,1000000,stdout),p2=0;\n\twb[p2++]=x;\n}\nvoid wrt(long long x) {\n\tif(x<0)pc('-'),x=-x;\n\tint c[24]= {0};\n\tif(!x)return pc('0'),void();\n\twhile(x)c[++c[0]]=x%10,x/=10;\n\twhile(c[0])pc(c[c[0]--]+'0');\n}\nconst int mod = 998244353;\nconst int MOD(int x){return x>=mod?x-mod:x;}\nint n,Q,rt;\nchar c[100005];\nlong long ksm(long long a,long long b){\n\tlong long ret=1;\n\twhile(b){\n\t\tif(b&1)ret=ret*a%mod;\n\t\ta=a*a%mod,b>>=1;\n\t}\n\treturn ret;\n}\nvoid calc(){\n\tlong long a=1,b=1;\n\tint numW=0,numE=0;\n\tfor(int i=n;i>=1;i--){\n\t\tif(c[i]!=c[i+1]){\n\t\t\tif(c[i]=='E')swap(a,b),b=MOD(numW*a%mod+b);\n\t\t\tif(c[i]=='W')swap(a,b),b=MOD(numE*a%mod+b);\n\t\t\tnumW=numE=0;\n\t\t}\n\t\tif(c[i]=='W')++numW;\n\t\tif(c[i]=='E')++numE;\n\t}\n\tif(c[1]=='E')swap(a,b),b=MOD(numE*a%mod+b);\n\tif(c[1]=='W')swap(a,b),b=MOD(numW*a%mod+b);\n\tcout<<a<<\" \"<<b<<\"\\n\";\n}\nstruct matrix {\n\tint f[2][2];//0A 1B\n\tmatrix(){f[0][0]=f[0][1]=f[1][0]=f[1][1]=0;}\n\tint* operator [](int x){return f[x];}\n\tmatrix friend operator *(matrix &A,matrix &B){\n\t\tmatrix ret=matrix();\n\t\tret[0][0]=MOD(1ll*A[0][0]*B[0][0]%mod+1ll*A[0][1]*B[1][0]%mod);\n\t\tret[0][1]=MOD(1ll*A[0][0]*B[0][1]%mod+1ll*A[0][1]*B[1][1]%mod);\n\t\tret[1][0]=MOD(1ll*A[1][0]*B[0][0]%mod+1ll*A[1][1]*B[1][0]%mod);\n\t\tret[1][1]=MOD(1ll*A[1][0]*B[0][1]%mod+1ll*A[1][1]*B[1][1]%mod);\n\t\treturn ret;\n\t}\n}C,E,R,S;\nnamespace T{\n\tint tot;\n\tstruct node{\n\t\tint ch[2],fa,sz,pre,suf,prec,sufc,c;\n\t\tbool rev,flp;\n\t\t\n\t\tmatrix sum,rsum;\n\t}v[200010];\n\tbool isroot(int x){\n\t\treturn v[v[x].fa].ch[0]!=x&&v[v[x].fa].ch[1]!=x;\n\t}\n\tvoid push_rev(int x){\n\t\tif(!x)return;\n\t\tv[x].rev^=1;\n\t\tswap(v[x].pre,v[x].suf);\n\t\tswap(v[x].sum,v[x].rsum);\n\t\tswap(v[x].prec,v[x].sufc);\n\t\tswap(v[x].ch[0],v[x].ch[1]);\n\t}\n\tvoid push_flp(int x){\n\t\tif(!x)return;\n\t\tv[x].flp^=1,v[x].c^=1,v[x].prec^=1,v[x].sufc^=1;\n\t}\n\tvoid push_down(int x){\n\t\tif(v[x].rev){\n\t\t\tpush_rev(v[x].ch[0]);\n\t\t\tpush_rev(v[x].ch[1]);\n\t\t\tv[x].rev=0;\n\t\t}\n\t\tif(v[x].flp){\n\t\t\tpush_flp(v[x].ch[0]);\n\t\t\tpush_flp(v[x].ch[1]);\n\t\t\tv[x].flp=0;\n\t\t}\n\t}\n\tvoid push_up(int rt){\n\t\tv[rt].sz=v[v[rt].ch[0]].sz+1+v[v[rt].ch[1]].sz-(rt>200005);\n\t\tv[rt].pre=v[rt].ch[0]?(v[rt].prec=v[v[rt].ch[0]].prec,v[v[rt].ch[0]].pre):(v[rt].prec=v[rt].c,rt);\n\t\tv[rt].suf=v[rt].ch[1]?(v[rt].sufc=v[v[rt].ch[1]].sufc,v[v[rt].ch[1]].suf):(v[rt].sufc=v[rt].c,rt);\n\t\t\n\t\tv[rt].sum=C;\n\t\tif(v[rt].ch[1])v[rt].sum=v[rt].sum*v[v[rt].ch[1]].sum;\n\t\tif(v[rt].ch[1]&&v[v[rt].ch[1]].prec^v[rt].c)v[rt].sum=v[rt].sum*R;\n\t\tv[rt].sum=v[rt].sum*(rt>200005?C:E);\n\t\tif(v[rt].ch[0]&&v[v[rt].ch[0]].sufc^v[rt].c)v[rt].sum=v[rt].sum*R;\n\t\tif(v[rt].ch[0])v[rt].sum=v[rt].sum*v[v[rt].ch[0]].sum;\n\t\t\n\t\tv[rt].rsum=C;\n\t\tif(v[rt].ch[0])v[rt].rsum=v[rt].rsum*v[v[rt].ch[0]].rsum;\n\t\tif(v[rt].ch[0]&&v[v[rt].ch[0]].sufc^v[rt].c)v[rt].rsum=v[rt].rsum*R;\n\t\tv[rt].rsum=v[rt].rsum*(rt>200005?C:E);\n\t\tif(v[rt].ch[1]&&v[v[rt].ch[1]].prec^v[rt].c)v[rt].rsum=v[rt].rsum*R;\n\t\tif(v[rt].ch[1])v[rt].rsum=v[rt].rsum*v[v[rt].ch[1]].rsum;\n\t}\n\tint build(int l,int r){\n\t\tint mid=(l+r)>>1,now=++tot;\n\t\tif(l<mid)v[v[now].ch[0]=build(l,mid-1)].fa=now;\n\t\tif(mid<r)v[v[now].ch[1]=build(mid+1,r)].fa=now;\n\t\tv[now].c=c[mid]=='E';\n\t\tif(l==mid&&l==1)v[now].ch[0]=200006,v[200006].fa=now,push_up(200006);\n\t\tif(mid==r&&r==n)v[now].ch[1]=200007,v[200007].fa=now,push_up(200007);\n\t\tpush_up(now);\n\t\treturn now;\n\t}\n\tvoid rot(int x){\n\t\tint p=v[x].fa,g=v[p].fa;\n\t\tbool d=v[p].ch[1]==x;\n\t\tif(!isroot(p))v[g].ch[v[g].ch[1]==p]=x;\n\t\tv[p].ch[d]=v[x].ch[d^1];\n\t\tv[v[x].ch[d^1]].fa=p;\n\t\tv[x].ch[d^1]=p;\n\t\tv[x].fa=g,v[p].fa=x;\n\t\tpush_up(p),push_up(x);\n\t}\n\tvoid pre_push_down(int x){\n\t\tif(!isroot(x))pre_push_down(v[x].fa);\n\t\tpush_down(x);\n\t}\n\tvoid splay(int x,int f=0){\n\t\tpre_push_down(x);\n\t\twhile(v[x].fa!=f){\n\t\t\tint p=v[x].fa,g=v[p].fa;\n\t\t\tif(v[p].fa!=f)rot(v[g].ch[0]==p^v[p].ch[0]==x?x:p);\n\t\t\trot(x);\n\t\t}\n\t\tif(!f)rt=x;\n\t}\n\tint fdrk(int x,int sz){\n\t\tpush_down(x);\n\t\tif(sz<=v[v[x].ch[0]].sz)return fdrk(v[x].ch[0],sz);\n\t\tif(x<=200005&&(sz-=v[v[x].ch[0]].sz)==1)return x;\n\t\treturn fdrk(v[x].ch[1],sz-(x<=200005));\n\t}\n\tvoid ADD(int val){\n\t\tsplay(v[rt].suf),splay(v[v[rt].ch[0]].suf);\n\t\tv[v[rt].ch[1]].ch[0]=++tot,v[tot].c=val,v[tot].fa=v[rt].ch[1],push_up(tot),push_up(v[rt].ch[1]),push_up(rt);\n\t}\n\tvoid FLIP(int l,int r){\n\t\tif(l==r)return l=fdrk(rt,l),splay(l),v[l].c^=1,push_up(l),void();\n\t\tl=fdrk(rt,l),splay(l),r=fdrk(rt,r),splay(r);\n\t\tsplay(l),splay(r,l),l=v[v[l].ch[0]].suf,r=v[v[r].ch[1]].pre;\n\t\tsplay(l),splay(r,l),push_flp(v[r].ch[0]),push_up(r),push_up(l);\n\t}\n\tvoid REVERSE(int l,int r){\n\t\tif(l==r)return;\n\t\tl=fdrk(rt,l),splay(l),r=fdrk(rt,r),splay(r);\n\t\tsplay(l),splay(r,l),l=v[v[l].ch[0]].suf,r=v[v[r].ch[1]].pre;\n\t\tsplay(l),splay(r,l),push_rev(v[r].ch[0]),push_up(r),push_up(l);\n\t}\n}\nint main() {\n//\tsystem(\"fc code.out code5.ans\");\n//\tfreopen(\"code.in\",\"r\",stdin);\n//\tfreopen(\"code.out\",\"w\",stdout);\n\tC[0][0]=C[1][1]=1;\n\tE[0][0]=E[1][1]=E[1][0]=1;\n\tS[0][0]=S[0][1]=1;\n\tR[0][1]=R[1][0]=1;\n\tn=getint(),Q=getint();\n\tscanf(\"%s\",c+1);\n\trt=T::build(1,n);\n\tcout<<(S*T::v[rt].sum)[0][1]<<\" \"<<(S*T::v[rt].sum)[0][0]<<'\\n';\n\tfor(int i=1;i<=Q;i++){\n\t\tscanf(\"%s\",c+1);\n\t\tif(c[1]=='A')scanf(\"%s\",c+1),T::ADD(c[1]=='E');\n\t\tif(c[1]=='F'){int l=getint(),r=getint();T::FLIP(l,r);}\n\t\tif(c[1]=='R'){int l=getint(),r=getint();T::REVERSE(l,r);}\n\t\tcout<<(S*T::v[rt].sum)[0][1]<<\" \"<<(S*T::v[rt].sum)[0][0]<<'\\n';\n\t}\n\tfwrite(wb,1,p2,stdout);\n\treturn Loli Kon;\n}\n```\n\n\u54e8\u5175\u6709\u70b9\u70e6\uff08\u607c\n\n~~\u8bf4\u5b9e\u8bdd\uff0c\u6211\u89c9\u5f97\u6bd4T1\u7b80\u5355~~",
        "postTime": 1627462794,
        "uid": 27338,
        "name": "jerry3128",
        "ccfLevel": 9,
        "title": "\u9898\u89e3\u3010P7739 [NOI2021] \u5bc6\u7801\u7bb1\u3011"
    },
    {
        "content": "### Part1 \u524d\u8a00\n\u636e\u8bf4\u8fd9\u9053\u9898\u6bd4 T1 \u8fd8\u8981\u7b80\u5355\uff1f\u53ef\u80fd\u53ea\u662f\u56e0\u4e3a\u5b83\u662f\u5957\u8def\u9898\u3002\n\n\u4f46\u662f\u5957\u8def\u9898\u4e0d\u4f1a\u505a\u5c31\u5b8c\u4e86\uff01\n\n\u8bb2\u7684\u662f\u666e\u901a\u77e9\u9635\u4e58\u6cd5\u7ef4\u62a4\u8fde\u5206\u6570\uff0c\u672c\u9898\u53ef\u4ee5\u901a\u8fc7\u7b80\u5355\u5f52\u7eb3\u5f97\u51fa\u603b\u662f\u4e0d\u7528\u7ea6\u5206\u7684\u7ed3\u8bba\u3002\n\n### Part2 \u5c06\u5e8f\u5217\u8f6c\u5316\u4e3a\u77e9\u4e58\n\n\u8003\u8651\u5e8f\u5217\u5f53\u524d\u6743\u503c\u4e3a $\\dfrac b a$\uff0c\u5c06\u5176\u62bd\u8c61\u4e3a\u4e00\u4e2a\u5411\u91cf $\\begin{bmatrix}a\\\\b\\end{bmatrix}$\uff0c\u6211\u4eec\u60f3\u8981\u5728\u5e8f\u5217**\u524d**\u52a0\u5165\u4e00\u4e2a\u6570 $x$\uff0c\u5c06\u6743\u503c\u53d8\u6210 $\\dfrac{ax+b}a$\uff0c\u5373\u5411\u91cf $\\begin{bmatrix}ax+b\\\\a\\end{bmatrix}$\uff0c\u6784\u9020\u77e9\u9635\u4e58\u6cd5\uff1a$\\begin{bmatrix}a\\\\b\\end{bmatrix}\\begin{bmatrix}x&1\\\\1&0\\end{bmatrix}=\\begin{bmatrix}ax+b\\\\a\\end{bmatrix}$\uff0c\u4e8e\u662f\u8fd9\u9053\u9898\u53ef\u4ee5\u770b\u4f5c\u5411\u91cf $\\begin{bmatrix}1\\\\0\\end{bmatrix}$ \u4ece\u53f3\u5f80\u5de6\u4f9d\u6b21**\u53f3\u4e58**\u77e9\u9635 $\\begin{bmatrix}a_i&1\\\\1&0\\end{bmatrix}$\uff0c\u4e8e\u662f\u5982\u679c\u53ea\u662f\u5e8f\u5217\u4e0a\u7684\u5355\u70b9\u4fee\u6539\uff0c\u6211\u4eec\u5df2\u7ecf\u5f97\u5230\u4e86\u7b54\u6848\uff0c\u7136\u800c\uff0c\u8fd9\u9053\u9898\u7684\u64cd\u4f5c\u4f3c\u4e4e\u4e0d\u5141\u8bb8\u6211\u4eec\u5c06\u5b9e\u9645\u4e0a\u7684\u5e8f\u5217\u7ef4\u62a4\u51fa\u6765\uff1f\n\n### Part3 \u5c06\u64cd\u4f5c\u8f6c\u5316\u4e3a\u77e9\u4e58\n\n\u9996\u5148\u662f\u64cd\u4f5c `W`\uff0c\u6211\u4eec\u9700\u8981\u5c06\u6700\u540e\u4e00\u4e2a\u77e9\u9635 $\\begin{bmatrix}x&1\\\\1&0\\end{bmatrix}$ \u53d8\u4e3a $\\begin{bmatrix}x+1&1\\\\1&0\\end{bmatrix}$\uff0c\u6784\u9020\u77e9\u9635\u4e58\u6cd5\uff1a$\\begin{bmatrix}1&1\\\\0&1\\end{bmatrix}\\begin{bmatrix}x&1\\\\1&0\\end{bmatrix}=\\begin{bmatrix}x+1&1\\\\1&0\\end{bmatrix}$ \u6ce8\u610f\u5230\u8fd9\u91cc\u6211\u4eec\u5fc5\u987b\u6784\u9020\u5de6\u4e58\uff0c\u56e0\u4e3a\u67e5\u8be2\u65f6\u662f\u4ece\u53f3\u5230\u5de6\u4f9d\u6b21\u53f3\u4e58\u7684\u3002\n\n\u5bf9\u4e8e\u64cd\u4f5c `E`\uff0c\u6211\u4eec\u53ef\u4ee5\u5148\u8003\u8651\u7b2c\u4e8c\u79cd\u60c5\u51b5\uff0c\u8fd9\u65f6\u6211\u4eec\u4f1a\u5728\u6700\u53f3\u4fa7\u65b0\u589e\u4e00\u4e2a\u77e9\u9635 $\\begin{bmatrix}1&-1\\\\0&1\\end{bmatrix}$\uff0c\u518d\u589e\u52a0\u4e24\u4e2a $1$ \u5373 $\\begin{bmatrix}1&1\\\\1&0\\end{bmatrix}$\uff0c\u6574\u4f53\u589e\u52a0\u4e86 $\\begin{bmatrix}1&1\\\\1&0\\end{bmatrix}\\begin{bmatrix}1&1\\\\1&0\\end{bmatrix}\\begin{bmatrix}1&-1\\\\0&1\\end{bmatrix}=\\begin{bmatrix}2&-1\\\\1&0\\end{bmatrix}$\uff0c\u8fd9\u65f6\uff0c\u6211\u4eec\u731c\u6d4b\u53e6\u4e00\u79cd\u60c5\u51b5\u4e5f\u4f1a\u5f97\u5230\u4e00\u6837\u7684\u77e9\u9635\u3002\n\n\u4e8b\u5b9e\u4e0a\uff0c\u8fd9\u65f6\u5bf9\u7684\uff0c\u6211\u4eec\u5b9e\u9645\u4e0a\u4f1a\u5c06\u77e9\u9635 $\\begin{bmatrix}1&1\\\\1&0\\end{bmatrix}$ \u53d8\u4e3a $\\begin{bmatrix}1&1\\\\1&0\\end{bmatrix}\\begin{bmatrix}1&1\\\\0&1\\end{bmatrix}=\\begin{bmatrix}1&2\\\\1&1\\end{bmatrix}$\uff0c\u5f53\u7136\u8fd9\u662f\u4ee5\u5de6\u4e58\u7684\u5f62\u5f0f\uff0c\u6211\u4eec\u53d1\u73b0\uff0c$\\begin{bmatrix}2&-1\\\\1&0\\end{bmatrix}\\begin{bmatrix}1&1\\\\1&0\\end{bmatrix}$ \u6070\u597d\u7b49\u4e8e $\\begin{bmatrix}1&2\\\\1&1\\end{bmatrix}$ \u4e8e\u662f\u5c31\u53ef\u4ee5\u7528\u77e9\u9635 $\\begin{bmatrix}2&-1\\\\1&0\\end{bmatrix}$ \u6765\u8868\u793a\u64cd\u4f5c `E`\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u53ea\u8981\u8003\u8651\u5982\u4f55\u7ef4\u62a4\u4e86\u3002\n\n### Part4 \u5e73\u8861\u6811\u7ef4\u62a4\u65b9\u5f0f\n\n\u4e4b\u6240\u4ee5\u8981\u4f7f\u7528\u5e73\u8861\u6811\uff0c\u662f\u56e0\u4e3a\u8fd9\u9053\u9898\u9700\u8981\u7ffb\u8f6c\u533a\u95f4\u3002\n\nFHQ \u4f46\u7136\u4e5f\u597d\uff0c\u4f46\u6211\u4e60\u60ef\u7528 Splay \u5199 LCT\uff0c\u4e8e\u662f\u5199 Splay \u4f1a\u66f4\u5feb\u4e14\u66f4\u5bb9\u6613\u8c03\u9519\u3002\n\n\u8003\u8651\u5728\u6bcf\u4e00\u4e2a\u8282\u70b9\u7ef4\u62a4\u662f\u5426\u7ffb\u8f6c\u3001\u53cd\u8f6c\u7684\u77e9\u9635\u4e58\u79ef\uff0c\u8fd9\u6837\u5728\u7ffb\u8f6c\u3001\u53cd\u8f6c\u7684\u65f6\u5019\u4ea4\u6362\u5c31\u53ef\u4ee5\u4e86\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $(n+q)\\log n$\u3002\n\n### Part5 \u540e\u8bb0\n\n\u6709\u4e00\u4e2a\u795e\u5947\u7684\u5730\u65b9\uff0c\u4e3a\u4ec0\u4e48\u65f6\u95f4\u590d\u6742\u5ea6\u4e2d\u6709 $n\\log n$\uff1f\n\n\u56e0\u4e3a Splay \u9700\u8981\u521d\u59cb\u52bf\u80fd\u5566\uff01\n\n\u7ed9\u4e2a\u4ee3\u7801\u5c31\u8d70\u5566\uff01\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nusing ll=long long;\nconst int N=4e5+5,M=998244353;\nstruct mtx{\n    int a[2][2];\n    mtx operator*(const mtx &z)const{\n        return{\n            (int)(((ll)a[0][0]*z.a[0][0]+(ll)a[0][1]*z.a[1][0])%M),\n            (int)(((ll)a[0][0]*z.a[0][1]+(ll)a[0][1]*z.a[1][1])%M),\n            (int)(((ll)a[1][0]*z.a[0][0]+(ll)a[1][1]*z.a[1][0])%M),\n            (int)(((ll)a[1][0]*z.a[0][1]+(ll)a[1][1]*z.a[1][1])%M)\n        };\n    }\n    void put()const{\n        printf(\"%d %d\\n%d %d\\n\",a[0][0],a[0][1],a[1][0],a[1][1]);\n    }\n}sm[N][2][2];//flip,reverse\nstruct vec{\n    int a[2];\n    vec operator*(const mtx &z)const{\n        return{\n            (int)(((ll)a[0]*z.a[0][0]+(ll)a[1]*z.a[1][0])%M),\n            (int)(((ll)a[0]*z.a[0][1]+(ll)a[1]*z.a[1][1])%M)\n        };\n    }\n    void put()const{\n        printf(\"%d %d\\n\",a[0],a[1]);\n    }\n};\nconst mtx WE[]={{1,1,0,1},{2,M-1,1,0}},A={1,1,0,1};\nconst vec B={1,0};\nint fp[N],rv[N],nw[N],rt,cnt;\nint n,q,t[N][2],f[N],sz[N];\n#define ls t[x][0]\n#define rs t[x][1]\n#define tp(x) (t[f[x]][1]==x)\n#define in(x) (t[f[x]][0]==x||tp(x))\nvoid pp(int x){\n    for(int i=0;i<2;++i)\n        for(int k=0;k<2;++k)\n            sm[x][i][k]=sm[t[x][k]][i][k]*WE[nw[x]^i]*sm[t[x][!k]][i][k];\n    sz[x]=sz[ls]+sz[rs]+1;\n}void Flip(int x){\n    nw[x]^=1,fp[x]^=1;\n    swap(sm[x][0][0],sm[x][1][0]);\n    swap(sm[x][0][1],sm[x][1][1]);\n}void Rev(int x){\n    rv[x]^=1,swap(ls,rs);\n    swap(sm[x][0][0],sm[x][0][1]);\n    swap(sm[x][1][0],sm[x][1][1]);\n}\nvoid rot(int x){\n    int y=f[x],k=tp(x),w=t[x][!k];\n    t[t[x][!k]=y][k]=w,f[w]=y;\n    if(in(y))t[f[y]][tp(y)]=x;\n    f[x]=f[y],f[y]=x,pp(y);\n}\nvoid pd(int x){\n    if(rv[x]){\n        if(ls)Rev(ls);\n        if(rs)Rev(rs);rv[x]=0;\n    }if(fp[x]){\n        if(ls)Flip(ls);\n        if(rs)Flip(rs);fp[x]=0;\n    }\n}\nvoid ppd(int x){\n    if(in(x))ppd(f[x]);pd(x);\n}\nvoid splay(int x){\n    ppd(x);\n    for(int y=f[x];in(x);rot(x),y=f[x])\n        if(in(y))rot(tp(x)^tp(y)?x:y);\n    pp(rt=x);\n}\nint fkth(int x,int k){\n    while(1){\n        pd(x);\n        if(k<=sz[ls])x=ls;\n        else if(k==sz[ls]+1)break;\n        else k-=sz[ls]+1,x=rs;\n    }splay(x);return x;\n}\nstring op;\nint main(){\n    sm[0][0][0]=sm[0][0][1]=sm[0][1][0]=sm[0][1][1]={1,0,0,1};\n    ios::sync_with_stdio(false);\n    cin>>n>>q>>op;\n    int i,j,k,l,r,x,y;\n    for(x=1;x<=n;++x){\n        nw[x]=(op[x-1]=='E');\n        if(x>1)ls=x-1;if(x<n)f[x]=x+1;\n        pp(x);\n    }rt=cnt=n;\n    (B*sm[rt][0][1]*A).put();\n    while(q--){\n        cin>>op;\n        if(op[0]=='A'){\n            cin>>op;\n            nw[x=++cnt]=(op[0]=='E');\n            f[ls=rt]=x,rt=x,pp(x);\n        }else{\n            cin>>l>>r;\n            x=fkth(rt,r),f[r=rs]=0,rs=0,pp(x);\n            x=fkth(x,l),f[l=ls]=0,ls=0,pp(x);\n            if(op[0]=='R'){\n                Rev(x),pd(x),f[rs=r]=x,pp(x);\n                x=fkth(x,1),f[ls=l]=x,pp(x);\n            }else{\n                Flip(x),pd(x),f[ls=l]=x,pp(x);\n                x=fkth(x,sz[x]);\n                f[rs=r]=x,pp(x);\n            }\n        }(B*sm[rt][0][1]*A).put();\n    }return 0;\n}\n```",
        "postTime": 1677149684,
        "uid": 502410,
        "name": "EnofTaiPeople",
        "ccfLevel": 0,
        "title": "\u5e73\u8861\u6811\u7ef4\u62a4\u77e9\u9635\u4e58\u6cd5"
    },
    {
        "content": "# P7739 [NOI2021] \u5bc6\u7801\u7bb1\n\n\u9898\u76ee\u94fe\u63a5\uff1a [Link](https://www.luogu.com.cn/problem/P7739)\n\n\u672c\u9898\u89e3\u4e3b\u8981\u601d\u8def\u6765\u6e90 @Rikka__(\u75af\u72c2 % )\u3002\n\n\u8003\u8651\u9898\u91cc\u9762\u7684\u8d21\u732e\u7684\u8ba1\u7b97\u5176\u5b9e\u662f\u4e00\u4e2a\u8fde\u5206\u6570\u7684\u5012\u6570\uff0c\u5373\uff1a\n$$\na_1+\\frac {1}{a_2+\\frac{1}{a_3 + ...}}\n$$\n\u82e5\u4ece $a_k$ \u5230 $a_1$ \u4ece\u4e0b\u5411\u4e0a\u5408\u5e76\u7684\u8bdd\u80fd\u591f\u53d1\u73b0\u5176\u5b9e\u662f\u4e00\u4e2a $ \\Large \\frac{a'}{b'} = \\frac {1}{a_i+\\frac{a}{b}}$ \u7684\u5f62\u5f0f\u3002\uff08\u9996\u5148\u6839\u636e\u8f97\u8f6c\u76f8\u9664\u6cd5\u7684\u90a3\u4e00\u5957\u7406\u8bba\u660e\u663e\u662f\u4e0d\u7528\u8003\u8651\u7ea6\u5206\uff09\n\n\u90a3\u4e48\u8003\u8651\u5c06 $a_i$ \u5408\u5e76\u4e0a\u540e\u5bf9\u7b54\u6848\u7684\u5f71\u54cd\uff1a\n$$\n\\frac {a'}{b'} = \\frac{1}{a_i+\\frac{a}{b}} =  \\frac {b}{a_i \\times b + a}\n$$\n\u90a3\u4e48\u4e5f\u5c31\u662f $a' = b ,b' = a_i \\times b + a$\n\n\u8f6c\u79fb\u662f\u56fa\u5b9a\u7684\u6545\u53ef\u4ee5\u8003\u8651\u4f7f\u7528\u77e9\u9635\u8fdb\u884c\u8f6c\u79fb\uff1a\n$$\n\\left[\n\\begin {array}{l}\na'\\\\\nb'\n\\end{array}\n\\right] \n=\n\\left[\n\\begin {array}{l}\n0 &1\\\\\n1&a_i\n\\end{array}\n\\right]\n\\left[\n\\begin {array}{l}\na\\\\\nb\n\\end{array}\n\\right]\n$$\n\u6545\u7b54\u6848\u5373\u4e3a\uff1a\n$$\n\\left[\n\\begin {array}{l}\n0&1\\\\\n1&a_1\n\\end{array}\n\\right]\n\\left[\n\\begin {array}{l}\n0&1\\\\\n1&a_2\n\\end{array}\n\\right]\n...\n\\left[\n\\begin {array}{l}\n0&1\\\\\n1&a_k\n\\end{array}\n\\right]\n\\left[\n\\begin {array}{l}\n0\\\\\n1\n\\end{array}\n\\right]\n$$\n\u7ee7\u7eed\u8003\u8651\u4f7f\u7528\u77e9\u9635\u8868\u8ff0\u64cd\u4f5c `W` \u548c `E`\uff1a\n\n`W`\uff1a\n\n$a_k \\rightarrow a_{k}+1$ \n\n\u53d1\u73b0\u77e9\u9635\u4ece $\\left[\\begin {array}{l}0&1\\\\1&a_k\\end{array}\\right]$ \u53d8\u6210 $\\left[\\begin{array}{l} 0&1\\\\1&a_{k}+1 \\end{array} \\right ]$ \u53ef\u4ee5\u53d1\u73b0\u8f6c\u79fb\u77e9\u9635\u5373\u4e3a\uff1a$\\left[\\begin{array}{l} 1&1\\\\0&1\\end{array}\\right]$ \uff08\u53f3\u4e58\uff09\n\n`E`\uff1a\n\n$a_k>1$ \n\n$a_k \\rightarrow  a_k - 1$ \u5e76\u6dfb\u52a0\u4e24\u4e2a $1$ \u5230\u672b\u5c3e\u3002\n\n\u6309\u7167\u4e0a\u9762\u7684\u601d\u8def\uff0c\u53d1\u73b0 $a_k \\rightarrow  a_k - 1$ \u8f6c\u79fb\u77e9\u9635\u5373\u4e3a $\\left[\\begin{array}{l} 1&-1\\\\0&1\\end{array}\\right]$  \n\n\u672b\u5c3e\u6dfb\u52a0\u4e24\u4e2a $1$ \u8f6c\u79fb\u77e9\u9635\u4e3a $\\left[\\begin{array}{l}0&1\\\\1&1\\end{array}\\right]\\left[\\begin{array}{l}0&1\\\\1&1\\end{array}\\right]$ \n\n\u6309\u987a\u5e8f\u6574\u5408\u4e00\u4e0b\u5373\u4e3a $\\left[\\begin{array}{l}0&-1\\\\1&2\\end{array}\\right]$\n\n$a_k = 1$ \n\n\u8fd9\u65f6 $a_k$ \u5bf9\u5e94\u7684\u77e9\u9635\u4e3a $\\left[\\begin{array}{l}0&1\\\\1&1\\end{array}\\right]$\u3002\n\n\u6309\u7167\u6b63\u5e38\u7684\u8fd0\u7b97\u5e94\u8be5\u4e3a $\\left[\\begin{array}{l}0&1\\\\1&a_{k-1}\\end{array}\\right]\\left[\\begin{array}{l}1&1\\\\0&1\\end{array}\\right]\\left[\\begin{array}{l}0&1\\\\1&1\\end{array}\\right]$ \u3002\n\n\u6309\u7167\u7ed3\u5408\u5f8b\u53ef\u53d8\u4e3a $\\left[\\begin{array}{l}0&1\\\\1&a_{k-1}\\end{array}\\right]\\left[\\begin{array}{l}1&2\\\\1&1\\end{array}\\right]$ \n\n\u6211\u4eec\u540c\u6837\u8bbe\u4e00\u4e2a\u77e9\u9635 $\\left[\\begin{array}{l}x&y\\\\z&k\\end{array}\\right]$\n\n\u6ee1\u8db3\uff1a\n$$\n\\left[\\begin{array}{l}0&1\\\\1&a_{k-1}\\end{array}\\right]\\left[\\begin{array}{l}0&1\\\\1&1\\end{array}\\right]\\left[\\begin{array}{l}x&y\\\\z&k\\end{array}\\right]\n=\n\\left[\\begin{array}{l}0&1\\\\1&a_{k-1}\\end{array}\\right]\\left[\\begin{array}{l}1&2\\\\1&1\\end{array}\\right]\n$$\n\u89e3\u5f97\u77e9\u9635 $\\left[\\begin{array}{l}0&-1\\\\1&2\\end{array}\\right]$\n\n\u6545\u5bf9\u4e8e `E` \u64cd\u4f5c\u53ea\u9700\u8981\u4e58\u4e0a $\\left[\\begin{array}{l}0&-1\\\\1&2\\end{array}\\right]$\n\n\u5269\u4f59\u90e8\u5206\u6bd4\u8f83\u7b80\u5355\uff0c\u53ea\u9700\u8981\u7528\u4e00\u9897\u652f\u6301\u5e8f\u5217\u7ffb\u8f6c\u3001\u53d6\u53cd\u64cd\u4f5c\u7684\u5e73\u8861\u6811\u5b9e\u73b0\u5373\u53ef\u3002\u5177\u4f53\u7ef4\u62a4 **\u533a\u95f4\u8fde\u4e58\u79ef**\uff0c**\u533a\u95f4\u53d6\u53cd\u8fde\u4e58\u79ef**\uff0c**\u533a\u95f4\u7ffb\u8f6c\u8fde\u4e58\u79ef**\uff0c**\u533a\u95f4\u53d6\u53cd\u7ffb\u8f6c\u8fde\u4e58\u79ef**\u3002\u540c\u65f6\u7ef4\u62a4**\u53d6\u53cd\u6807\u8bb0**\u548c**\u7ffb\u8f6c\u6807\u8bb0**\u5373\u53ef\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a$O(n\\log n)$\n\n\u4f18\u5316\uff1a\n\n\u5176\u5b9e\u6709\u65f6\u7a7a\u590d\u6742\u5ea6\u90fd\u66f4\u4f18\u7684\u5199\u6cd5\uff0c\u8003\u8651\u5bf9\u4e8e `REVERSE` \u548c `FLIP` \u64cd\u4f5c\u4e5f\u50cf `W` `E` \u90a3\u6837\u53bb\u901a\u8fc7\u77e9\u9635\u8fdb\u884c\u8f6c\u79fb\uff0c\u5177\u4f53\u7684\u901a\u8fc7\u77e9\u9635\u4e2d $4$ \u4e2a\u5143\u7d20\u7684\u7ebf\u6027\u7ec4\u5408\u53bb\u6784\u9020\u8f6c\u79fb\u77e9\u9635\u3002\n\n\u8bbe\u77e9\u9635 $A = \\left[\\begin{array}{l} a&b \\\\ c&d \\end{array}\\right]  $\u3002\n\n\u6709:\n$$\nFlip(A) = \\left[\\begin{array}{l} a-b&-b \\\\ -a+b-c+d&b+d \\end{array}\\right]\n$$\n$$\nReverse(A) = \\left[\\begin{array}{l} d-2c&-2a+b-4c+2d \\\\ c&a+2c \\end{array}\\right]\n$$\n\u8fd9\u6837\u5c31\u53ef\u4ee5\u4e0d\u53bb\u7ef4\u62a4 $4$ \u79cd\u4e58\u79ef\uff0c\u7a7a\u95f4\u548c\u65f6\u95f4\u5f97\u5230\u5de8\u5927\u4f18\u5316\u3002\u53ef\u4ee5\u901a\u8fc7\u89e3\u65b9\u7a0b\u6765\u8bc1\u660e\u3002\n\n```\n//editor : DRYAYST\n//Wo shi ge da SHA BI\n#include<bits/stdc++.h>\n#define g() getchar()\n#define il inline\n#define ull unsigned long long\n#define eps 1e-10\n#define ll long long\n#define pa pair<int, int>\n#define for_1(i, n) for(int i = 1; i <= (n); ++i)\n#define for_0(i, n) for(int i = 0; i < (n); ++i)\n#define for_xy(i, x, y) for(int i = (x); i <= (y); ++i)\n#define for_yx(i, y, x) for(int i = (y); i >= (x); --i)\n#define for_edge(i, x) for(int i = head[x]; i; i = nxt[i])\n#define int long long\n#define DB double\n#define ls tr[x].l\n#define rs tr[x].r\n#define m_p make_pair\n#define fi first\n#define se second\nusing namespace std;\nconst int N = 1e6 + 10, INF = 0x7f7f7f7f, mod = 998244353;\nil int qpow(int x, int k) {int ans = 1; while(k) {if(k & 1) ans = ans * x % mod; x = x * x % mod; k >>= 1; } return ans; }\nil int Add(int x, int y) {return (x += y) %= mod;}\nil int Del(int x, int y) {return (x = x - y + mod) % mod;}\nil int Mul(int x, int y) {return x * y % mod;}\nil int inv(int x) {return qpow(x, mod - 2); }\ninline int re() {\n    int x = 0, p = 1;\n    char ch = getchar();\n    while(ch > '9' || ch < '0') {if(ch == '-') p = -1; ch = getchar();}\n    while(ch <= '9' and ch >= '0') {x = (x << 3) + (x << 1) + (ch ^ 48); ch = getchar();}\n    return x * p;\n}\nmt19937 rd(20050426);\nint n, Q, rt, cnt ; \nchar s[N], op[100]; \nstruct Matrix {\n    int a[2][2];  Matrix() {memset(a, 0, sizeof(a)); }\n    il Matrix operator * (const Matrix &b) const {Matrix c;  for_0(k, 2) for_0(i, 2) for_0(j, 2) c.a[i][j] = (c.a[i][j] + a[i][k] * b.a[k][j] % mod) % mod;  return c;}\n    il Matrix Rev(Matrix A) {Matrix c;\n        c.a[0][0] = (A.a[1][1] - 2 * A.a[1][0] % mod + mod) % mod;  c.a[0][1] = ((-2 * A.a[0][0] + A.a[0][1] - 4 * A.a[1][0] + 2 * A.a[1][1]) % mod + mod) % mod; \n        c.a[1][0] = A.a[1][0];  c.a[1][1] = (A.a[0][0] + 2 * A.a[1][0] % mod) % mod;  return c; \n    }\n    il Matrix Flip(Matrix A) { Matrix c; \n        c.a[0][0] = (A.a[0][0] - A.a[0][1] + mod) % mod;  c.a[0][1] = (-A.a[0][1] + mod) % mod; \n        c.a[1][0] = ((-A.a[0][0] + A.a[0][1] - A.a[1][0] + A.a[1][1]) % mod + mod) % mod;   c.a[1][1] = (A.a[0][1] + A.a[1][1]) % mod; return c; \n    }\n}A, B, ans, use; //A\uff0cB\u5206\u522b\u4e3a\u4e24\u4e2a\u8f6c\u79fb\u77e9\u9635\nstruct Tree {int l, r; int val, siz, rtag, ftag; Matrix V, S; }tr[N]; \nil int Newed(int x) { int id = ++cnt; tr[id].V = (x==0?A:B); tr[id].S = tr[id].V;  tr[id].l = tr[id].r = 0; tr[id].siz = 1; tr[id].rtag = tr[id].ftag = 0; tr[id].val = rd(); return id; }\nil void push_up(int x) {if(!x) return; tr[x].siz = tr[ls].siz + tr[rs].siz + 1; tr[x].S = tr[ls].S * tr[x].V * tr[rs].S; return; }\nil void push_rdown(int x) { if(!x) return ;  tr[x].S = use.Rev(tr[x].S);  swap(tr[x].l, tr[x].r); tr[x].rtag ^= 1; }\nil void push_fdown(int x) { if(!x) return ; tr[x].S = use.Flip(tr[x].S), tr[x].V = use.Flip(tr[x].V); tr[x].ftag ^= 1;  }\nil void push_down(int x) { if(!x) return;  if(tr[x].rtag) push_rdown(tr[x].l), push_rdown(tr[x].r), tr[x].rtag = 0;  if(tr[x].ftag) push_fdown(tr[x].l), push_fdown(tr[x].r), tr[x].ftag = 0;  }\nil int Merge(int k1, int k2) {\n    if(!k1 || !k2) return k1 + k2; \n    if(tr[k1].val < tr[k2].val) {  push_down(k1); tr[k1].r = Merge(tr[k1].r, k2); push_up(k1); return k1; }\n    else {push_down(k2); tr[k2].l = Merge(k1, tr[k2].l); push_up(k2); return k2; }\n}\nint Build(int l, int r) { \n    if(l == r) {int now = Newed(s[l] != 'W'); return now;} int mid = (l + r) >> 1; \n    int k1 = Build(l, mid), k2 = Build(mid + 1, r); return Merge(k1, k2);\n}\nil int Insert(int rt, int fl) {return Merge(rt, Newed(fl)); }\nvoid Split(int rt, int x, int &k1, int &k2) { \n    if(!rt) {k1 = 0; k2 = 0; return ; } push_down(rt); \n    if(tr[tr[rt].l].siz < x) {k1 = rt; Split(tr[rt].r, x - tr[tr[rt].l].siz -1 , tr[k1].r, k2); push_up(k1); }\n    else {k2 = rt; Split(tr[rt].l, x, k1, tr[k2].l); push_up(k2);}\n}\nil int Flip(int rt, int l, int r) {  int k1, k2, k3; Split(rt, r, k1, k3); Split(k1, l - 1, k1, k2); push_fdown(k2); return Merge(k1, Merge(k2, k3));  }\nil int Reverse(int rt, int l, int r) { int k1, k2, k3; Split(rt, r, k1, k3); Split(k1, l-1, k1, k2); push_rdown(k2); return Merge(k1, Merge(k2, k3)); }\nsigned main() {\n    n = re(), Q = re(); scanf(\"%s\", s + 1); A.a[0][0] = 1; A.a[0][1] = 1; A.a[1][1] = 1; B.a[0][1] = mod - 1; B.a[1][0] = 1; B.a[1][1] = 2; \n    tr[0].V.a[0][0] = 1; tr[0].V.a[1][1] = 1; tr[0].S = tr[0].V; rt = Build(1, n);  ans = A * tr[rt].S; \n    printf(\"%lld %lld\\n\", ans.a[1][1], ans.a[0][1]); \n    while(Q--) {\n        scanf(\"%s\", op + 1); \n        if(op[1] == 'A') { scanf(\"%s\", op + 1); rt = Insert(rt, op[1] != 'W'); }\n        else if(op[1] == 'F') {int l = re(), r = re(); rt = Flip(rt, l, r); }\n        else {int l = re(), r = re(); rt = Reverse(rt, l, r); }\n        ans = A * tr[rt].S; printf(\"%lld %lld\\n\", ans.a[1][1], ans.a[0][1]); \n    }\n}\n```\n\n\u53ef\u80fd\u4ee3\u7801\u6709\u70b9\u4e0d\u80fd\u770b,\u5efa\u8bae loj \u683c\u5f0f\u5316\u540e\u89c2\u770b\u66f4\u6e05\u6670\u3002",
        "postTime": 1649233061,
        "uid": 333580,
        "name": "Zwaire",
        "ccfLevel": 6,
        "title": "P7739 [NOI2021] \u5bc6\u7801\u7bb1"
    },
    {
        "content": "\u8001\u5e08\u7559\u7684\u51e0\u9053\u9898\u91cc\u7b2c\u4e00\u4e2a\u505a\u4e86\u7684\uff0c\u5199\u7bc7\u9898\u89e3\u7eaa\u5ff5\u4e00\u4e0b\u3002\n\n\u8fd9\u9053\u9898\u4e3b\u8981\u60f3\u8981\u5199\u4e00\u4e0b\u6211\u505a\u9898\u7684\u601d\u8def\u3002\n\n[\u66f4\u597d\u7684\u9605\u8bfb\u4f53\u9a8c](https://www.cnblogs.com/Wuyanru/p/NOI2021-password_box.html)\n\n\u9898\u76ee\u94fe\u63a5\uff1a[luoguP7739](https://www.luogu.com.cn/problem/P7739) \u3002\n\n\u9996\u5148\u6211\u4eec\u53ef\u4ee5\u6ce8\u610f\u5230\u8fd9\u9053\u9898\u4e0d\u540c\u5bfb\u5e38\u7684\u5730\u65b9\uff1a\u522b\u7684\u9898\u76ee\u90fd\u662f\u8ba9\u6211\u4eec\u7ef4\u62a4\u5e8f\u5217\uff0c\u4f46\u662f\u8fd9\u9053\u9898\u5374\u8ba9\u6211\u4eec\u7ef4\u62a4\u64cd\u4f5c\u5e8f\u5217\u3002\n\n\u4f3c\u4e4e\u975e\u5e38\u9ebb\u70e6\u554a\u3002\n\n\u4f46\u662f\u4ec0\u4e48\u4e1c\u897f\u53ef\u4ee5\u7ef4\u62a4\u5462\uff1f\u77e9\u9635\uff01\n\n\u518d\u770b\u4e00\u4e0b\u9898\u76ee\u4e2d\u7684\u64cd\u4f5c\uff1a\u7ffb\u8f6c\u3001\u53cd\u8f6c\u3002\n\n\u4e00\u773c\u5c31\u53ef\u4ee5\u770b\u51fa\u6b63\u89e3\u662f\u5e73\u8861\u6811\u7ef4\u62a4\u77e9\u9635\u3002\n\n\u8fd9\u4e9b\u601d\u8def\u5927\u6982\u662f\u6211\u8bfb\u5b8c\u9898\u4e4b\u540e\u5c31\u77e5\u9053\u7684\uff0c\u6bd4\u8f83\u660e\u663e\u3002\n\n\u77e5\u9053\u4e86\u7b97\u6cd5\uff0c\u5176\u5b9e\u6211\u4eec\u53ea\u9700\u8981\u63a8\u51fa\u8fd9\u4e9b\u77e9\u9635\u5c31\u53ef\u4ee5\u4e86\uff0c\u8fd9\u624d\u662f\u8fd9\u9053\u9898\u7684\u91cd\u70b9\u3002\n\n\u6211\u4eec\u73b0\u5728\u518d\u6765\u60f3\u4e00\u4e2a\u95ee\u9898\uff1a\u5047\u5982\u6211\u4eec\u73b0\u5728\u901a\u8fc7\u77e9\u9635\uff0c\u7ef4\u62a4\u4e86\u67d0\u4e00\u4e2a\u5e8f\u5217\u7684\u7b54\u6848\u3002\n\n\u6211\u4eec\u73b0\u5728\u7ed9\u8fd9\u4e2a\u5e8f\u5217\u540e\u9762\u6dfb\u52a0\u4e00\u4e2a\u6570\u5b57\uff0c\u6211\u4eec\u53ef\u4ee5\u7b97\u51fa\u7b54\u6848\u5417\uff1f\n\n\u4f3c\u4e4e\u4e0d\u884c\uff0c\u6216\u8005\u8bf4\u8d77\u7801\u6ca1\u6709\u7279\u522b\u7b80\u5355\u7684\u65b9\u6cd5\u3002\n\n\u4f46\u662f\u5982\u679c\u8fd9\u4e2a\u6570\u5b57\u6dfb\u52a0\u5728\u4e86\u6574\u4e2a\u5e8f\u5217\u7684\u524d\u9762\uff0c\u6211\u4eec\u5374\u5f88\u597d\u7ef4\u62a4\u3002\n\n\u5047\u5982\u8bf4 $ f(a_0,a_1,\\dots,a_k) $ \u7684\u7b54\u6848\u4e3a $ \\dfrac{x}{y} $ \uff0c\u8fd9\u4e2a\u65f6\u5019\u5e8f\u5217\u53d8\u6210 $ (c,a_0,a_1,\\dots,a_k) $ \uff0c\u7b54\u6848\u663e\u7136\u4f1a\u53d8\u6210 $ c+\\dfrac{y}{x}=\\dfrac{cx+y}{x} $ \u3002\n\n\u90a3\u4e5f\u5c31\u662f\uff1a\n$$\n\\begin{bmatrix}\n x&y \n\\end{bmatrix}\n\\times \n\\begin{bmatrix}\n c&1 \\\\\n 1&0\n\\end{bmatrix}\n=\n\\begin{bmatrix}\n cx+y&x\n\\end{bmatrix}\n$$\n\u6240\u4ee5\u6211\u4eec\u5f97\u5230\u4e86\u4e00\u4e9b\u542f\u53d1\uff1a\u5e8f\u5217\u5012\u7740\u4f1a\u6bd4\u8f83\u597d\u7ef4\u62a4\u3002\n\n\u5176\u5b9e\u6b63\u7740\u53ef\u80fd\u4e5f\u5dee\u4e0d\u591a\uff0c\u4f46\u662f\u6211\u8fd8\u662f\u89c9\u5f97\u5012\u7740\u6bd4\u8f83\u65b9\u4fbf\u3002\n\n\u7136\u540e\u6211\u4eec\u518d\u6765\u770b\u9898\u76ee\u4e2d\u7ed9\u7684\u64cd\u4f5c\u3002\n\n\u9996\u5148\u6211\u4eec\u6765\u770b W \u64cd\u4f5c\u3002\n\n\u5c06\u5e8f\u5217\u4e2d\u6700\u540e\u4e00\u4e2a\u503c\u52a0\u4e00\uff0c\u56e0\u4e3a\u6211\u4eec\u5012\u7740\u7ef4\u62a4\u5e8f\u5217\uff0c\u6240\u4ee5\u5c31\u662f\u6574\u4e2a\u5e8f\u5217\u7b2c\u4e00\u4e2a\u4f4d\u7f6e\u52a0\u4e00\u3002\n\n\u5047\u8bbe\u8bf4\u8fd9\u4e2a\u5730\u65b9\u539f\u6765\u7684\u503c\u662f $ c $ \uff0c\u90a3\u4e48\u8fd9\u4e2a\u5730\u65b9\u5bf9\u5e94\u7684\u77e9\u9635\u5c31\u662f $ \\begin{bmatrix} c&1 \\\\ 1&0\\end{bmatrix} $ \u3002\n\n\u6211\u4eec\u73b0\u5728\u8981\u5c06\u8fd9\u4e2a\u5730\u65b9\u7684\u77e9\u9635\u8981\u53d8\u6210 $ \\begin{bmatrix} c+1&1 \\\\ 1&0\\end{bmatrix} $ \u3002\n\n\u56e0\u4e3a\u5bf9\u4e8e\u4efb\u4f55 $ c $ \uff0c\u8fd9\u4e2a\u53d8\u6362\u90fd\u8981\u6210\u7acb\uff0c\u6240\u4ee5\u7a0d\u5fae\u624b\u63a8\u4e00\u4e0b\uff0c\u5c31\u53ef\u4ee5\u53d1\u73b0\uff1a\n$$\n\\begin{bmatrix} 1&1 \\\\ 0&1\\end{bmatrix}\n\\times \n\\begin{bmatrix} c&1 \\\\ 1&0\\end{bmatrix}\n=\n\\begin{bmatrix} c+1&1 \\\\ 1&0\\end{bmatrix}\n$$\n\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u63a8 E\uff0c\u4f60\u4f1a\u53d1\u73b0\u4f3c\u4e4e\u6709\u70b9\u9ebb\u70e6\u3002\u4e0d\u614c\uff0c\u6211\u4eec\u76f4\u63a5\u63a8\u3002\n\n\u5bf9\u4e8e\u7b2c\u4e00\u4e2a\u6570\u5b57\u4e0d\u662f $ 1 $ \u7684\u60c5\u51b5\uff0c\u5c31\u662f\u5148\u628a\u8fd9\u4e2a\u6570\u5b57\u51cf\u4e00\uff0c\u7136\u540e\u5728\u5e8f\u5217\u524d\u9762\u6dfb\u4e0a\u4e24\u4e2a $ 1 $ \u3002\n\n\u6240\u4ee5\u6211\u4eec\u5148\u63a8\u4e00\u4e0b\u5982\u4f55\u7ed9\u4e00\u4e2a\u6570\u5b57\u51cf\u4e00\uff0c\u611f\u89c9\u548c\u4e0a\u9762\u5dee\u4e0d\u591a\u3002\n$$\n\\begin{bmatrix} 1&-1 \\\\ 0&1\\end{bmatrix}\n\\times \n\\begin{bmatrix} c&1 \\\\ 1&0\\end{bmatrix}\n=\n\\begin{bmatrix} c-1&1 \\\\ 1&0\\end{bmatrix}\n$$\n\u90a3\u4e48\u8fd9\u4e2a\u77e9\u9635\u63a8\u51fa\u6765\u5c31\u662f\uff1a\n$$\n\\begin{aligned}\n&\\begin{bmatrix} 1&1 \\\\ 1&0\\end{bmatrix}\n\\times\n\\begin{bmatrix} 1&1 \\\\ 1&0\\end{bmatrix}\n\\times\n\\begin{bmatrix} 1&-1 \\\\ 0&1\\end{bmatrix}\\\\\n=&\\begin{bmatrix} 2&1 \\\\ 1&1\\end{bmatrix}\n\\times\n\\begin{bmatrix} 1&-1 \\\\ 0&1\\end{bmatrix}\\\\\n=&\\begin{bmatrix} 2&-1 \\\\ 1&0\\end{bmatrix}\n\\end{aligned}\n$$\n \u7136\u540e\u518d\u6765\u63a8\u4e00\u4e0b\u7b2c\u4e00\u4e2a\u6570\u5b57\u662f $ 1 $ \u7684\u60c5\u51b5\u3002\u4e0d\u59a8\u5199\u4e00\u4e0b\u539f\u6765\u7684\u77e9\u9635\u548c\u53d8\u5316\u540e\u7684\u77e9\u9635\u3002\n\n\u5047\u8bbe\u539f\u6765\u7b2c\u4e8c\u4e2a\u6570\u662f $ c $ \uff08\u7b2c\u4e00\u4e2a\u6570\u662f $ 1 $ \uff09\u3002\n\n\u90a3\u4e48\u5f00\u5934\u7684\u4e24\u4e2a\u77e9\u9635\u957f\u8fd9\u4e2a\u6837\u5b50\uff1a\n$$\n\\begin{bmatrix} 1&1 \\\\ 1&0\\end{bmatrix}\n\\times\n\\begin{bmatrix} c&1 \\\\ 1&0\\end{bmatrix}\n$$\n\u6211\u4eec\u5c06\u7b2c\u4e8c\u4e2a\u6570\u5b57\u52a0\u4e0a\u4e00\uff1a\n$$\n\\begin{bmatrix} 1&1 \\\\ 1&0\\end{bmatrix}\n\\times\n\\begin{bmatrix} 1&1 \\\\ 0&1\\end{bmatrix}\n\\times\n\\begin{bmatrix} c&1 \\\\ 1&0\\end{bmatrix}\n$$\n\u524d\u4e24\u9879\u90fd\u662f\u5e38\u6570\u9879\uff0c\u6211\u4eec\u628a\u5b83\u4eec\u4e58\u8d77\u6765\u3002\n$$\n\\begin{bmatrix} 1&2 \\\\ 1&1\\end{bmatrix}\n\\times\n\\begin{bmatrix} c&1 \\\\ 1&0\\end{bmatrix}\n$$\n\u6211\u4eec\u80af\u5b9a\u5c3d\u91cf\u60f3\u5c06\u4ed6\u8868\u793a\u6210\u5bf9\u7b2c\u4e00\u4e2a\u6570\u5b57\u7684\u64cd\u4f5c\uff0c\u6240\u4ee5\u6211\u4eec\u628a\u7b2c\u4e00\u9879\u62c6\u5f00\uff1a\n$$\n\\begin{bmatrix} ?&? \\\\ ?&?\\end{bmatrix}\n\\times\n\\begin{bmatrix} 1&1 \\\\ 1&0\\end{bmatrix}\n\\times\n\\begin{bmatrix} c&1 \\\\ 1&0\\end{bmatrix}\n$$\n\u53ef\u4ee5\u5e26\u8fdb\u53bb\u7684\u6570\u5b57\u6709\u70b9\u591a\uff0c\u4e0d\u597d\u7b97\u3002\n\n\u5c31\u8fd9\u4e48\u5361\u4f4f\u4e86\u561b\uff1f\n\n\u770b\u770b\u4e0a\u9762\uff1f\n$$\n\\begin{bmatrix} 2&-1 \\\\ 1&0\\end{bmatrix}\n\\times\n\\begin{bmatrix} 1&1 \\\\ 1&0\\end{bmatrix}\n\\times\n\\begin{bmatrix} c&1 \\\\ 1&0\\end{bmatrix}\n$$\n\u6ca1\u9519\uff0cE \u64cd\u4f5c\u76f4\u63a5\u7528\u8fd9\u4e00\u4e2a\u77e9\u9635\u5c31\u53ef\u4ee5\u89e3\u51b3\u3002\n\n\u77e9\u9635\u5c31\u8fd9\u6837\u63a8\u5b8c\u4e86\u3002\n\n\u6211\u4eec\u518d\u6765\u770b\u9898\u76ee\u4e2d\u7684\u8fd9\u4e9b\u64cd\u4f5c\u3002\n\n\u64cd\u4f5c\u4e00\uff0c\u76f4\u63a5\u5728\u6240\u6709\u77e9\u9635\u524d\u6dfb\u52a0\u4e00\u4e2a\u6570\u5b57\u3002\n\n\u64cd\u4f5c\u4e09\uff0c\u76f4\u63a5\u6574\u4e2a\u533a\u95f4\u7ffb\u8f6c\u3002\n\n\u64cd\u4f5c\u4e8c\uff0c\u770b\u8d77\u6765\u4e0d\u597d\u641e\uff0c\u5b9e\u9645\u4e0a\u548c\u64cd\u4f5c\u4e09\u4e00\u6837\uff0c\u76f4\u63a5\u66b4\u529b\u7ef4\u62a4\u6ca1\u6709\u8f6c\u548c\u8f6c\u4e86\u4e4b\u540e\u8fd9\u4e2a\u533a\u95f4\u957f\u4ec0\u4e48\u6837\u5b50\u5c31\u884c\u3002\n\n$ 4 $ \u500d\u5e38\u6570\uff0c\u5efa\u8bae\u5b9e\u73b0\u7684\u65f6\u5019\u5c3d\u91cf\u5e38\u6570\u5199\u5c0f\u4e00\u70b9\u3002\n\n\u4ee3\u7801\uff1a\n\n```c++\n#include<algorithm>\n#include<cstring>\n#include<random>\n#include<cstdio>\n#include<ctime>\nusing namespace std;\nconst int mod=998244353;\nmt19937 _rand(time(0)^clock());\nusing ll=long long;\ninline int read()\n{\n\tint s=0,w=1;char ch;\n\twhile((ch=getchar())>'9'||ch<'0') if(ch=='-') w=-1;\n\twhile(ch>='0'&&ch<='9') s=s*10+ch-'0',ch=getchar();\n\treturn s*w;\n}\ntemplate<const int n,const int m>\nstruct mat\n{\n\tll a[n][m];\n\ttemplate<const int q>\n\tmat<n,q> operator * (mat<m,q>b)\n\t{\n\t\tmat<n,q>ans;\n\t\tmemset(ans.a,0,sizeof(ans.a));\n\t\tfor(int i=0;i<n;i++)\n\t\t\tfor(int k=0;k<m;k++)\n\t\t\t\tfor(int j=0;j<q;j++)\n\t\t\t\t\t(ans.a[i][j]+=a[i][k]*b.a[k][j])%=mod;\n\t\treturn ans;\n\t}\n\tinline void debug()\n\t{\n\t\tfor(int i=0;i<n;i++)\n\t\t{\n\t\t\tfor(int j=0;j<m;j++) printf(\"%lld \",a[i][j]);\n\t\t\tprintf(\"\\n\");\n\t\t}\n\t\tprintf(\"\\n\");\n\t}\n};\nmat<2,2>num0[200001];\nmat<2,2>num1[200001];\nmat<2,2>num2[200001];\nmat<2,2>num3[200001];\nmat<2,2>val0[200001];\nmat<2,2>val2[200001];\nbool rev[200001];\nbool fli[200001];\nint pri[200001];\nint siz[200001];\nint ls[200001];\nint rs[200001];\nchar in[100002];\nint root;\nint tot;\nint n,m;\nint Neww()\n{\n\ttot++;\n\tpri[tot]=_rand(),siz[tot]=1;\n\tnum0[tot].a[0][0]=num0[tot].a[0][1]=num0[tot].a[1][1]=1;\n\tnum2[tot].a[0][0]=2,num2[tot].a[0][1]=-1,num2[tot].a[1][0]=1;\n\tval0[tot]=num1[tot]=num0[tot],val2[tot]=num3[tot]=num2[tot];\n\treturn tot;\n}\nint Newe()\n{\n\ttot++;\n\tpri[tot]=_rand(),siz[tot]=1;\n\tnum0[tot].a[0][0]=2,num0[tot].a[0][1]=-1,num0[tot].a[1][0]=1;\n\tnum2[tot].a[0][0]=num2[tot].a[0][1]=num2[tot].a[1][1]=1;\n\tval0[tot]=num1[tot]=num0[tot],val2[tot]=num3[tot]=num2[tot];\n\treturn tot;\n}\ninline void push_down(int p)\n{\n\tif(rev[p])\n\t{\n\t\trev[p]^=1;\n\t\trev[ls[p]]^=1,rev[rs[p]]^=1;\n\t\tswap(ls[p],rs[p]);\n\t\tswap(num0[p],num1[p]),swap(num2[p],num3[p]);\n\t}\n\tif(fli[p])\n\t{\n\t\tfli[p]^=1;\n\t\tfli[ls[p]]^=1,fli[rs[p]]^=1;\n\t\tswap(num0[p],num2[p]),swap(num1[p],num3[p]),swap(val0[p],val2[p]);\n\t}\n}\ninline void push_up(int p)\n{\n\tif(ls[p]) push_down(ls[p]);\n\tif(rs[p]) push_down(rs[p]);\n\tnum0[p]=num0[ls[p]]*val0[p]*num0[rs[p]];\n\tnum2[p]=num2[ls[p]]*val2[p]*num2[rs[p]];\n\tnum1[p]=num1[rs[p]]*val0[p]*num1[ls[p]];\n\tnum3[p]=num3[rs[p]]*val2[p]*num3[ls[p]];\n\tsiz[p]=siz[ls[p]]+siz[rs[p]]+1;\n}\nint merge(int u,int v)\n{\n\t// printf(\"merge %d %d\\n\",u,v);\n\tif(!u||!v) return u|v;\n\tif(pri[u]>=pri[v])\n\t{\n\t\tpush_down(u);\n\t\trs[u]=merge(rs[u],v);\n\t\tpush_up(u);\n\t\treturn u;\n\t}\n\telse\n\t{\n\t\tpush_down(v);\n\t\tls[v]=merge(u,ls[v]);\n\t\tpush_up(v);\n\t\treturn v;\n\t}\n}\nvoid split(int p,int s,int &x,int &y)\n{\n\tif(!p){ x=y=0;return ;}\n\tpush_down(p);\n\tif(siz[ls[p]]>=s)\n\t{\n\t\ty=p;\n\t\tsplit(ls[p],s,x,ls[y]);\n\t\tpush_up(y);\n\t}\n\telse\n\t{\n\t\tx=p;\n\t\tsplit(rs[p],s-siz[ls[p]]-1,rs[x],y);\n\t\tpush_up(x);\n\t}\n}\nvoid print()\n{\n\tpush_down(root);\n\tprintf(\"%lld %lld\\n\",(num0[root].a[0][0]+mod)%mod,(num0[root].a[0][0]+num0[root].a[0][1]+2*mod)%mod);\n}\nvoid debug()\n{\n\t// printf(\"root=%d\\n\",root);\n\t// for(int i=1;i<=tot;i++)\n\t// {\n\t// \tprintf(\"%d : ls=%d rs=%d rev=%d fli=%d siz=%d \",i,ls[i],rs[i],rev[i],fli[i],siz[i]);\n\t// \tprintf(\"%2lld %2lld  %2lld %2lld  %2lld %2lld  %2lld %2lld  %2lld %2lld  %2lld %2lld\\n\",val0[i].a[0][0],val0[i].a[0][1],val2[i].a[0][0],val2[i].a[0][1],num0[i].a[0][0],num0[i].a[0][1],num1[i].a[0][0],num1[i].a[0][1],num2[i].a[0][0],num2[i].a[0][1],num3[i].a[0][0],num3[i].a[0][1]);\n\t// \tprintf(\"                                \");\n\t// \tprintf(\"%2lld %2lld  %2lld %2lld  %2lld %2lld  %2lld %2lld  %2lld %2lld  %2lld %2lld\\n\",val0[i].a[1][0],val0[i].a[1][1],val2[i].a[1][0],val2[i].a[1][1],num0[i].a[1][0],num0[i].a[1][1],num1[i].a[1][0],num1[i].a[1][1],num2[i].a[1][0],num2[i].a[1][1],num3[i].a[1][0],num3[i].a[1][1]);\n\t// }\n\t// printf(\"\\n\");\n}\nint main()\n{\n\tn=read(),m=read();scanf(\"%s\",in+1);\n\tnum0[0].a[0][0]=num0[0].a[1][1]=1;\n\tnum1[0]=num2[0]=num3[0]=num0[0];\n\tfor(int i=1;i<=n;i++)\n\t{\n\t\tif(in[i]=='W') root=merge(Neww(),root);\n\t\telse root=merge(Newe(),root);\n\t}\n\tprint();\n\tdebug();\n\tfor(int i=1;i<=m;i++)\n\t{\n\t\tscanf(\"%s\",in+1);\n\t\tif(in[1]=='A')\n\t\t{\n\t\t\tscanf(\"%s\",in+1);\n\t\t\tif(in[1]=='E') root=merge(Newe(),root);\n\t\t\telse root=merge(Neww(),root);\n\t\t\tn++;\n\t\t}\n\t\telse if(in[1]=='R')\n\t\t{\n\t\t\tint r=n-read()+1,l=n-read()+1;\n\t\t\tint x,y,z;\n\t\t\tsplit(root,r,y,z);\n\t\t\tsplit(y,l-1,x,y);\n\t\t\trev[y]^=1;\n\t\t\troot=merge(merge(x,y),z);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tint r=n-read()+1,l=n-read()+1;\n\t\t\tint x,y,z;\n\t\t\tsplit(root,r,y,z);\n\t\t\tsplit(y,l-1,x,y);\n\t\t\t// printf(\"l=%d r=%d x=%d y=%d z=%d\\n\",l,r,x,y,z);\n\t\t\tdebug();\n\t\t\tfli[y]^=1;\n\t\t\troot=merge(merge(x,y),z);\n\t\t}\n\t\tprint();\n\t\tdebug();\n\t}\n\treturn 0;\n}\n/*\n2 2\nWE\nAPPEND E\nFLIP 1 2\n*/\n```\n\n\u611f\u8c22\u89c2\u770b\uff01",
        "postTime": 1659361598,
        "uid": 400201,
        "name": "Wuyanru",
        "ccfLevel": 7,
        "title": "P7739 [NOI2021] \u5bc6\u7801\u7bb1"
    },
    {
        "content": "\u8fd9\u91cc\u662f\u8003\u573a\u4e0a\u60f3\u51fa\u6765\u7684\u51e1\u4eba\u505a\u6cd5\uff0c\u4f46\u597d\u50cf\u548c\u5176\u4ed6\u4eba\u7684\u505a\u6cd5\u6709\u4e9b\u51fa\u5165\uff1f\u8fd9\u91cc\u662f\u76f4\u63a5\u7ef4\u62a4\u7684 `a` \u6570\u7ec4\u7684\u8d21\u732e\u3002\n\n\u9996\u5148\u89c2\u5bdf\u5982\u4f55\u7528\u4e00\u4e32 `W` \u548c `E` \u6765\u5f97\u5230 `a` \u6570\u5217\uff0c\u53d1\u73b0\u5982\u679c\u662f\u5728\u4e2d\u95f4\u7684\u8fde\u7eed\u4e00\u6bb5\u7684 `EEE...EWWW...W` \u7684\u8bdd\uff0c`E` \u7684\u4e2a\u6570\u548c `W` \u7684\u4e2a\u6570\u521a\u597d\u786e\u5b9a\u8fde\u7eed\u7684\u4e24\u4e2a `a` \u7684\u503c\u3002\n\n\u518d\u8003\u8651\u8fb9\u754c\uff0c\u5982\u679c\u7b2c\u4e00\u4e2a\u5b57\u7b26\u662f `W`\uff0c\u90a3\u4e48\u6700\u524d\u9762\u4f1a\u591a\u51fa\u6765\u4e2a $a_0=0$\uff0c\u5982\u679c\u7b2c\u4e00\u4e2a\u5b57\u7b26\u662f `E` \u5219\u65e0\u5f71\u54cd\u3002\n\n\u5982\u679c\u6700\u540e\u4e00\u4e2a\u5b57\u7b26\u662f `W`\uff0c\u90a3\u4e48\u6700\u540e\u9762\u7684 $a_k+1\\to a_k$\uff0c\u56e0\u4e3a\u6ca1\u6709 `E` \u628a\u5b83\u51cf 1\uff0c\u5982\u679c\u6700\u540e\u4e00\u4e2a\u5b57\u7b26\u662f `E`\uff0c\u90a3\u4e48\u6700\u540e\u9762\u4f1a\u591a\u51fa\u6765\u4e2a $a_k=1$\u3002\n\n\u8fd9\u4e9b\u5728\u56de\u7b54\u8be2\u95ee\u65f6\u90fd\u53ef\u4ee5\u5904\u7406\u3002\n\n\u8003\u8651 `a` \u6570\u5217\u5bf9\u7b54\u6848\u7684\u8d21\u732e\uff1a\u6211\u4eec\u8003\u8651 $a_i+\\dfrac{1}{a_{i+1}+\\dfrac{1}{...+\\frac{1}{x}}}$\uff0c\u6211\u4eec\u5e0c\u671b\u9884\u5904\u7406\u540e\u5bf9\u4e8e\u4e00\u4e2a\u6709\u7406\u6570 $x$ \u5feb\u901f\u6c42\u51fa\u8fd9\u4e2a\u5f0f\u5b50\u7684\u503c\u3002\n\n\u8bbe $x=\\frac{q}{p}$\uff0c\u5f53\u524d\u5c42\u4e3a\u7684 `a` \u7684\u503c\u4e3a $a_k$\uff0c\u90a3\u4e48\u6bcf\u4ece $x$ \u5f80\u4e0a\u8d70\u4e00\u5c42\uff0c\u6709 $p+q\\cdot a_k\\to q'$\uff0c$q\\to p'$\u3002\n\n\u90a3\u4e48\u8bbe\u8d21\u732e\u4e3a $\\dfrac{c\\cdot p+d\\cdot q}{a\\cdot p+b\\cdot q}$ \uff0c\u8f6c\u79fb $a,b,c,d$ \u5373\u53ef\uff0c\u6b64\u90e8\u5206\u901a\u8fc7\u66b4\u529b\u9a8c\u8bc1\u662f\u6b63\u786e\u7684\u3002\n\n\u63a5\u4e0b\u6765\u7684\u4e8b\u60c5\u5c31\u7b80\u5355\u4e86\uff0c\u8003\u8651\u64cd\u4f5c\u5bf9 `a` \u6570\u5217\u5e26\u6765\u53d8\u5316\u3002\n\n1. `APPEND`\uff1a\u6539\u53d8\u6700\u540e\u4e00\u4e2a `a`\uff0c\u53ef\u80fd\u5728\u6700\u540e\u52a0\u5165 `a`\uff0c\u5e76\u53ef\u80fd\u6539\u53d8\u5c3e\u5b57\u7b26\u3002\n\n1. `FLIP`\uff1a\u53ef\u80fd\u628a\u67d0\u4e24\u4e2a `a` \u62c6\u5f00\uff0c\u5e76\u53ef\u80fd\u6539\u53d8\u9996\u5c3e\u7684\u5b57\u7b26\u3002\n\n1. `REVERSE`\uff1a\u53ef\u80fd\u628a\u67d0\u4e24\u4e2a `a` \u62c6\u5f00\uff0c\u5e76\u53ef\u80fd\u6539\u53d8\u9996\u5c3e\u7684\u5b57\u7b26\uff0c\u540c\u65f6\u4e2d\u95f4\u8d21\u732e\u7684\u8f6c\u79fb\u7ffb\u8f6c\u3002\n\n\u6539\u53d8\u67d0\u4e2a\u6216\u67d0\u4e24\u4e2a `a` \u7684\u64cd\u4f5c\u662f\u5e73\u51e1\u7684\uff0c\u53ea\u8981\u4f60\u80fd\u627e\u5230\u62c6\u5f00\u540e\u5de6\u53f3\u7684\u5927\u5c0f\uff0c\u6539\u53d8\u9996\u5c3e\u5b57\u7b26\u4e5f\u662f\u5e73\u51e1\u7684\uff0c\u4e0d\u518d\u8d58\u8ff0\u3002\n\n\u8003\u8651\u4e2d\u95f4\u7684\u8f6c\u79fb\u88ab\u7ffb\u8f6c\u600e\u4e48\u529e\uff0c\u663e\u7136\u6211\u4eec\u53ef\u4ee5\u628a\u6b63\u7740\u8f6c\u79fb\u7684\u8d21\u732e\u548c\u5012\u7740\u8f6c\u79fb\u7684\u8d21\u732e\u90fd\u7b97\u51fa\u6765\uff0c\u7ffb\u8f6c\u76f4\u63a5 swap \u4e24\u4e2a\u7684\u8d21\u732e\u5373\u53ef\u3002\n\n\u5982\u679c\u4f7f\u7528\u5757\u94fe\u6765\u7ef4\u62a4\u4e0a\u8ff0\u8fc7\u7a0b\u662f\u5341\u5206\u5951\u5408\u7684\uff0c\u6bcf\u6b21\u62c6\u5f00\u4e24\u4e2a `a` \u6216\u6539\u53d8\u4e00\u4e2a `a` \u65f6\u53ef\u4ee5\u76f4\u63a5\u62c6\u5757\u7136\u540e\u66b4\u529b\u91cd\u6784\u6574\u4e2a\u5757\uff0c\u590d\u6742\u5ea6\u662f $O(\\sqrt{n})$ \u7684\u3002\n\n\u7ffb\u8f6c\u8d21\u732e\u7684\u529e\u6cd5\u4e5f\u5df2\u7ecf\u8bf4\u8fc7\uff0c\u800c `a` \u6570\u7ec4\u672c\u8eab\u88ab\u7ffb\u8f6c\u7528\u5757\u94fe\u4e5f\u5f88\u597d\u5b9e\u73b0\uff0c\u8fd9\u6837\u7684\u8bdd\u627e\u4efb\u610f\u4e00\u4e2a\u4f4d\u7f6e\u90fd\u662f $O(\\sqrt{n})$ \u7684\u3002\n\n\u4e3a\u4ec0\u4e48\u6ca1\u5199\u51fa\u6765\uff1f\u4f60\u89c9\u5f97\u6211\u8003\u573a\u4e0a\u80fd\u5199\u5757\u94fe\uff1f\n\n\u4e0b\u6765\u540e\u53d1\u73b0\u5e73\u8861\u6811\u4e5f\u80fd\u8f7b\u6613\u7ef4\u62a4\u4e0a\u8ff0\u64cd\u4f5c\uff0c\u88c2\u5f00\u3002",
        "postTime": 1627475496,
        "uid": 158948,
        "name": "\u7ea6\u745f\u592b\u7528\u8111\u73a9",
        "ccfLevel": 0,
        "title": "P7739 [NOI2021] \u5bc6\u7801\u7bb1"
    },
    {
        "content": "# Description\n\n\u7ed9\u5b9a\u64cd\u4f5c\u5e8f\u5217 $S$\uff0c$S$ \u7684\u6bcf\u4e2a\u5b57\u7b26\u4e3a ```W``` \u6216 ```E```\u3002\n\n\u82e5\u5f53\u524d\u5b57\u7b26\u4e3a ```W```\uff0c\u5219\u5728\u6570\u5217 $\\{a_n\\}$ \u672b\u5c3e\u63d2\u5165 $1$\u3002\n\n\u5426\u5219\uff0c\u82e5\u6570\u5217 $\\{a_n\\}$ \u6700\u540e\u4e00\u9879\u4e3a $1$\uff0c\u5219\u7ed9\u5012\u6570\u7b2c\u4e8c\u9879\u52a0 $1$\uff1b\u5426\u5219\u5148\u7ed9\u6570\u5217\u6700\u540e\u4e00\u9879\u51cf $1$\uff0c\u63a5\u7740\u5728\u6570\u5217\u672b\u5c3e\u63d2\u5165\u4e24\u4e2a $1$\u3002\n\n\u5b9a\u4e49\u51fd\u6570 $f(\\{a_n\\})$ \u4e3a\uff1a\n\n$$f(a_0,\\dots,a_{n-1},a_n)=\\begin{cases}a_0, &n=0\\\\f(a_0,\\dots,a_{n-2},a_{n-1}+\\frac{1}{a_n}), & n \\ge 1\\end{cases}$$\n\n\u4f60\u9700\u8981\u652f\u6301\u5bf9\u64cd\u4f5c\u5e8f\u5217\u7684\u5143\u7d20\u63d2\u5165\u3001\u533a\u95f4\u53d6\u53cd\uff08\u5c06 ```W``` \u53d8\u4e3a ```E```\uff09\u3001\u533a\u95f4\u7ffb\u8f6c\uff0c\u6bcf\u6b21\u4fee\u6539\u540e\u56de\u7b54 $f(\\{a_n\\})$ \u7684\u503c\uff0c\u5bf9 $998244353$ \u53d6\u6a21\u3002\n\n$n,q \\le 10^5$\uff0c\u65f6\u9650 2s\u3002\n\n# Solution\n\n\u89c2\u5bdf\u51fd\u6570 $f$ \u7684\u6027\u8d28\uff0c\u53ef\u4ee5\u53d1\u73b0\u7b54\u6848\uff08\u7684\u5012\u6570\uff09\u662f\u8fd9\u6837\u7684\u5f62\u5f0f\n\n$$\\dfrac{1}{a_0 + \\dfrac{1}{a_1 + \\dfrac{1}{a_2+ \\cdots}}}$$\n\n\u8003\u8651\u5c06\u7b54\u6848\u4ece\u4e0b\u5230\u4e0a\u5408\u5e76\u6210\u6b63\u5e38\u5206\u6570\u7684\u5f62\u5f0f\uff0c\u5219\u6709\n\n$$\\dfrac{1}{a_i +\\dfrac{x}{y}} = \\dfrac{y}{a_iy+x}$$\n\n\u8fd9\u91cc\u53ef\u4ee5\u53d1\u73b0 $\\gcd(y,a_iy+x)=\\gcd(y,x)$\uff0c\u7531\u4e8e $\\dfrac{x}{y}$ \u5df2\u7ecf\u662f\u5408\u5e76\u8fc7\u7684\u6700\u7b80\u5206\u6570\uff0c\u56e0\u6b64\u5206\u6570\u4e0d\u4f1a\u88ab\u7ea6\u5206\uff0c\u6211\u4eec\u8ba1\u7b97\u65f6\u53ef\u4ee5\u653e\u5fc3\u53d6\u6a21\u3002\n\n\u4e0d\u59a8\u5c06\u5206\u6570 $\\dfrac{x}{y}$ \u5199\u6210\u77e9\u9635 $\\begin{bmatrix}x\\\\y\\end{bmatrix}$ \u7684\u5f62\u5f0f\uff0c\u4e0d\u96be\u53d1\u73b0\u4e0a\u8ff0\u8ba1\u7b97\u53ef\u4ee5\u770b\u4f5c\n\n\n$$\\begin{bmatrix} 0 &1\\\\1 &a_i\\end{bmatrix}\\begin{bmatrix}x\\\\y\\end{bmatrix}=\\begin{bmatrix}y\\\\a_i y +x\\end{bmatrix}$$\n\n\u4e8e\u662f\u6211\u4eec\u53ea\u9700\u8981\u7ef4\u62a4\u4e00\u8f66\u77e9\u9635\u7684\u8fde\u4e58\u79ef\u5c31\u53ef\u4ee5\u5f97\u51fa\u7b54\u6848\u3002\n\n\u63a5\u4e0b\u6765\u89c2\u5bdf ```W``` \u548c ```E``` \u64cd\u4f5c\u5bf9\u7b54\u6848\u7684\u5f71\u54cd\u3002\n\n```W``` \u64cd\u4f5c\u5176\u5b9e\u5c31\u662f\u5c06 $\\begin{bmatrix} 0 &1\\\\1 &a_n\\end{bmatrix}$ \u53d8\u4e3a $\\begin{bmatrix} 0 &1\\\\1 &a_n+1\\end{bmatrix}$\uff0c\u5f88\u5bb9\u6613\u6784\u9020\u51fa\u77e9\u9635 $\\begin{bmatrix} 1 &1\\\\0 &1\\end{bmatrix}$ \u6ee1\u8db3\u524d\u8005\u4e58\u4e0a\u5b83\u53d8\u4e3a\u540e\u8005\u3002\n\n\u5bf9\u4e8e ```E``` \u64cd\u4f5c\uff0c\u7531\u4e8e\u8981\u5206 $a_n=1$ \u548c $a_n>1$ \u4e24\u79cd\u60c5\u51b5\uff0c\u5219\u4f1a\u590d\u6742\u5f88\u591a\u3002\n\n\u5148\u770b $a_n=1$ \u7684\u60c5\u51b5\uff0c\u6b64\u65f6\u6709\n\n$$\\begin{bmatrix} 0 &1\\\\1 &a_{n-1}\\end{bmatrix} \\begin{bmatrix} 0 &1\\\\1 &a_n\\end{bmatrix}= \\begin{bmatrix} 0 &1\\\\1 &a_{n-1}\\end{bmatrix} \\begin{bmatrix} 0 &1\\\\1 &1\\end{bmatrix} \\rightarrow \\begin{bmatrix} 0 &1\\\\1 &a_{n-1}+1\\end{bmatrix} \\begin{bmatrix} 0 &1\\\\1 &1\\end{bmatrix}= \\begin{bmatrix} 0 &1\\\\1 &a_{n-1}\\end{bmatrix}\\begin{bmatrix} 1 &1\\\\0 &1\\end{bmatrix}\\begin{bmatrix} 0 &1\\\\1 &1\\end{bmatrix} = \\begin{bmatrix} 0 &1\\\\1 &a_{n-1}\\end{bmatrix} \\begin{bmatrix} 0 &1\\\\1 &1\\end{bmatrix} \\begin{bmatrix} 0 &-1\\\\1 &2\\end{bmatrix}$$\n\n\u6240\u4ee5\u6b64\u65f6\u7684\u64cd\u4f5c\u7b49\u4ef7\u4e8e\u4e58\u4e0a\u4e00\u4e2a $\\begin{bmatrix} 0 &-1\\\\1 &2\\end{bmatrix}$\u3002\n\n\u63a5\u7740\u6211\u4eec\u8003\u5bdf $a_n>1$ \u7684\u60c5\u51b5\uff0c\u53ef\u4ee5\u63a8\u5bfc\u51fa\u6b64\u65f6\u7684\u64cd\u4f5c\u4ecd\u7136\u7b49\u4ef7\u4e8e\u4e58\u4e0a $\\begin{bmatrix} 0 &-1\\\\1 &2\\end{bmatrix}$\uff0c\u5177\u4f53\u63a8\u5bfc\u8fc7\u7a0b\u7559\u4f5c\u8bfb\u8005\u7ec3\u4e60\u3002\n\n\u8fd9\u4e2a\u65f6\u5019\u9898\u76ee\u505a\u6cd5\u5df2\u7ecf\u53d8\u5f97\u975e\u5e38\u663e\u7136\uff0c\u6211\u4eec\u7528\u4e00\u4e2a\u652f\u6301\u533a\u95f4\u53d6\u53cd\u3001\u7ffb\u8f6c\u548c\u63d2\u5165\u65b0\u5143\u7d20\u7684\u6570\u636e\u7ed3\u6784\u7ef4\u62a4\u77e9\u9635\u8fde\u4e58\u79ef\u3002\u53ef\u4ee5\u60f3\u5230\u7528 Splay / \u975e\u65cb Treap \u6765\u7ef4\u62a4\u3002\n\n\u6bcf\u4e2a\u7ed3\u70b9\u8bb0\u5f55\u533a\u95f4\u8fde\u4e58\u79ef\u3001\u53d6\u53cd\u533a\u95f4\u8fde\u4e58\u79ef\u3001\u7ffb\u8f6c\u533a\u95f4\u8fde\u4e58\u79ef\u3001\u53d6\u53cd\u7ffb\u8f6c\u533a\u95f4\u8fde\u4e58\u79ef\u5373\u53ef\u548c\u5bf9\u5e94\u7684 lazy tag \u5373\u53ef\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal O(2^3 n \\log n)$\u3002\n\n# Code\n\n\u9898\u5916\u8bdd\uff1a\u636e\u6211\u6821\u53c2\u52a0 NOI2021 \u7684\u5b66\u957f\u56de\u5fc6\uff0c\u8003\u573a\u4e0a\u4f7f\u7528\u975e\u65cb Treap \u7684\u9009\u624b\u65e0\u4e00\u4e0d\u88ab\u5361\u6210\u4e86 70 \u5206\uff0c\u4f46\u662f\u6211\u5728\u8c03\u8bd5\u540e\u63d0\u4ea4\u8fd9\u9898\u5c31\u5f97\u5230\u4e86\u6ee1\u5206\uff0c\u8fd9\u5230\u5e95\u662f\u6211\u7684\u5e38\u6570\u592a\u5c0f\uff0c\u8fd8\u662f CCF \u7684\u673a\u5b50\u592a\u6162\uff1f\n\n```cpp\n#define int long long\n#define rd() rand()\nconst int N=2e5+5,mod=998244353;\nint n,q;\nchar s[N];\nstruct mat {\n\tint a[3][3];\n\tmat() {\n\t\tmemset(a,0,sizeof(a));\n\t}\n\tmat(int a1,int b1,int c1,int d1) {\n\t\ta[1][1]=a1,a[1][2]=b1,a[2][1]=c1,a[2][2]=d1;\n\t}\n\tvoid clr() {\n\t\tfor (int i=1;i<=2;i++) a[i][i]=1;\n\t}\n\tmat operator*(const mat &r) {\n\t\tmat o;\n\t\tfor (int i=1;i<=2;i++)\n\t\t\tfor (int j=1;j<=2;j++)\n\t\t\t\tfor (int k=1;k<=2;k++)\n\t\t\t\t\to.a[i][j]=(o.a[i][j]+a[i][k]*r.a[k][j]%mod)%mod;\n\t\treturn o;\n\t}\n}w(1,1,0,1),e(0,mod-1,1,2),sr(1,1,0,1),I(1,0,0,1);\nint tn;\nstruct node {\n\tint s,f,l,r,t1,t2;\n\tmat v1,v2,s1,s2,s3,s4;\n}h[N];\nint nd(int fl) {\n\ttn++;\n\tif (!fl) h[tn]=(node){1,rd(),0,0,0,0,w,e,w,e,w,e};\n\telse h[tn]=(node){1,rd(),0,0,0,0,e,w,e,w,e,w};\n\treturn tn;\n}\nvoid up(int x) {\n\th[x].s=h[h[x].l].s+h[h[x].r].s+1;\n\th[x].s1=h[h[x].l].s1*h[x].v1*h[h[x].r].s1;\n\th[x].s2=h[h[x].l].s2*h[x].v2*h[h[x].r].s2;\n\th[x].s3=h[h[x].r].s3*h[x].v1*h[h[x].l].s3;\n\th[x].s4=h[h[x].r].s4*h[x].v2*h[h[x].l].s4;\n}\nvoid chg1(int x) {\n\tswap(h[x].v1,h[x].v2);\n\tswap(h[x].s1,h[x].s2);\n\tswap(h[x].s3,h[x].s4);\n\th[x].t1^=1;\n}\nvoid chg2(int x) {\n\tswap(h[x].s1,h[x].s3);\n\tswap(h[x].s2,h[x].s4);\n\tswap(h[x].l,h[x].r);\n\th[x].t2^=1;\n}\nvoid dn(int x) {\n\tif (h[x].t1) chg1(h[x].l),chg1(h[x].r),h[x].t1=0;\n\tif (h[x].t2) chg2(h[x].l),chg2(h[x].r),h[x].t2=0;\n}\nvoid spt(int u,int k,int &x,int &y) {\n\tif (!u) {\n\t\tx=y=0;\n\t\treturn;\n\t}\n\tdn(u);\n\tif (h[h[u].l].s<k) x=u,spt(h[u].r,k-h[h[u].l].s-1,h[u].r,y);\n\telse y=u,spt(h[u].l,k,x,h[u].l);\n\tup(u);\n}\nint mrg(int x,int y) {\n\tif (!x || !y) return x|y;\n\tif (h[x].f<h[y].f) {\n\t\tdn(x),h[x].r=mrg(h[x].r,y),up(x);\n\t\treturn x;\n\t}\n\telse {\n\t\tdn(y),h[y].l=mrg(x,h[y].l),up(y);\n\t\treturn y;\n\t}\n}\nint rt,a,b,c,d;\nvoid rv(int l,int r,bool fl) {\n\tspt(rt,l-1,a,b);\n\tspt(b,r-l+1,b,c);\n\tif (!fl) chg1(b);\n\telse chg2(b);\n\trt=mrg(a,mrg(b,c));\n}\nsigned main() {\n\tscanf(\"%lld%lld%s\",&n,&q,s+1);\n\th[0]=(node){0,0,0,0,0,0,I,I,I,I,I,I};\n\tfor (int i=1;i<=n;i++) rt=mrg(rt,nd(s[i]=='W'?0:1));\n\tmat ans=sr*h[rt].s1;\n\tprintf(\"%lld %lld\\n\",ans.a[2][2],ans.a[1][2]);\n\twhile (q--) {\n\t\tchar op[10],dx[5];\n\t\tscanf(\"%s\",op);\n\t\tif (op[0]=='A') {\n\t\t\tscanf(\"%s\",dx);\n\t\t\trt=mrg(rt,nd(dx[0]=='W'?0:1));\n\t\t}\n\t\telse {\n\t\t\tint l,r;\n\t\t\tscanf(\"%lld%lld\",&l,&r);\n\t\t\tif (op[0]=='F') rv(l,r,0);\n\t\t\telse rv(l,r,1);\n\t\t}\n\t\tmat ans=sr*h[rt].s1;\n\t\tprintf(\"%lld %lld\\n\",ans.a[2][2],ans.a[1][2]);\n\t}\n\treturn 0;\n}\n```\n",
        "postTime": 1663220834,
        "uid": 283913,
        "name": "ZillionX",
        "ccfLevel": 6,
        "title": "\u3010\u89c2\u5bdf\uff0c\u77e9\u4e58\uff0c\u5e73\u8861\u6811\u3011P7739 [NOI2021] \u5bc6\u7801\u7bb1"
    },
    {
        "content": "\u9996\u5148\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u7c7b\u4f3c\u8f97\u8f6c\u76f8\u9664\u7684\u505a\u6cd5\u53d1\u73b0\u6574\u4e2a\u8fc7\u7a0b\u4e2d $f$ \u7684\u6700\u540e\u4e00\u4e2a\u6570\u5206\u5b50\u5206\u6bcd\u5fc5\u7136\u4e92\u8d28\uff0c\u4e0d\u9700\u8981\u7ea6\u5206\uff0c\u6240\u4ee5\u6211\u4eec\u5b8c\u5168\u53ef\u4ee5\u76f4\u63a5\u8ba1\u7b97\u548c\u53d6\u6a21\u3002\n\n\u6709\u533a\u95f4\u7ffb\u8f6c\uff0c\u5927\u6982\u7387\u5e73\u8861\u6811\u3002\n\n\u8003\u8651\u5c06 $a$ \u5e8f\u5217\u7684\u6700\u540e\u4e00\u4e2a\u5143\u7d20\u5355\u72ec\u62ff\u51fa\u6765\uff0c\u8bb0\u4f5c $x$\uff0c\u7136\u540e\u628a $f(a_0,a_1,\u2026,a_k)$ \u770b\u505a\u4e00\u4e2a\u548c $x$ \u6709\u5173\u7684\u51fd\u6570\uff0c\u5bb9\u6613\u5f52\u7eb3\u8bc1\u660e\u51fa $f(x)$ \u4e00\u5b9a\u662f $\\dfrac{ax+b}{cx+d}$ \u7684\u5f62\u5f0f\u3002\n\n\u663e\u7136 `W` \u64cd\u4f5c\u5c31\u662f\u4ee4\u4ee3\u5165\u51fd\u6570\u7684 $x$ \u52a0\u4e0a $1$\uff0c\u4f46 `E` \u64cd\u4f5c\u5206\u4e24\u79cd\u60c5\u51b5\u4e0d\u597d\u641e\uff0c\u6240\u4ee5\u6211\u4eec\u731c\u6d4b\u8fd9\u4e24\u79cd\u60c5\u51b5\u53ef\u4ee5\u88ab\u5f52\u4e3a\u4e00\u79cd\u3002\n\n\u5148\u8003\u8651\u6700\u540e\u4e00\u9879\u4e0d\u4e3a $1$ \u7684\u60c5\u51b5\uff0c\u624b\u52a8\u6a21\u62df\u4e00\u4e0b\u53ef\u4ee5\u53d1\u73b0\u6b64\u65f6 $f(x)=\\dfrac{(ax_0+b)x+(ax_0-a+b)}{(cx_0+d)x+(cx_0-c+d)}$\uff08$x_0$ \u4e3a\u539f\u672c\u4ee3\u5165\u7684 $x$ \u7684\u503c\uff0c$a,b,c,d$ \u4e3a\u539f\u6765 $f(x)$ \u4e2d\u7684\u5bf9\u5e94\u7684\u7cfb\u6570\uff09\uff0c\u540c\u65f6\u4ee4\u4ee3\u5165\u7684 $x=1$\u3002\n\n\u7136\u540e\u8f6c\u56de\u6765\u770b\u6700\u540e\u4e00\u9879\u4e3a $1$ \u7684\u60c5\u51b5\uff0c\u6211\u4eec\u8003\u8651\u4e5f\u4f7f\u7528\u7b2c\u4e8c\u79cd\u65b9\u5f0f\uff0c\u624b\u52a8\u6a21\u62df\u4e00\u4e0b\u4e5f\u53ef\u4ee5\u53d1\u73b0\u6b64\u65f6\u7ed3\u679c\u548c\u4ee3\u5165\u7b2c\u4e00\u79cd\u65b9\u5f0f\u5f97\u5230\u7684\u7ed3\u679c\u662f\u4e00\u6837\u7684\u3002\u4e5f\u5c31\u662f\u8bf4\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u4e0a\u9762\u5f97\u51fa\u7684\u7ed3\u8bba\u3002\n\n\u8003\u8651\u77e9\u9635\u7ef4\u62a4 $a,ax,b$\uff08\u53e6\u4e00\u90e8\u5206\u5f62\u5f0f\u7c7b\u4f3c\uff0c\u8fd9\u91cc\u4e0d\u518d\u91cd\u590d\uff09\uff0c\u5bf9\u4e8e splay \u7684\u6bcf\u4e2a\u8282\u70b9\u7ef4\u62a4\u5b50\u6811\u5185\u64cd\u4f5c\u7684\u53d8\u6362\u77e9\u9635\uff0c\u7531\u4e8e\u7ffb\u8f6c\u548c\u53cd\u8f6c\u540e\u7684\u53d8\u6362\u77e9\u9635\u7684\u7ed3\u679c\u5e76\u4e0d\u597d\u76f4\u63a5\u4ece\u4e2d\u770b\u51fa\uff0c\u6240\u4ee5\u628a \u7ffb\u8f6c/\u53cd\u8f6c/\u4e24\u8005\u90fd\u8fdb\u884c \u540e\u7684\u53d8\u6362\u77e9\u9635\u4e5f\u4e00\u8d77\u7ef4\u62a4\u51fa\u5373\u53ef\u3002\n\n\u4ee3\u7801\u592a\u4e11\u5c31\u4e0d\u8d34\u4e86\u3002",
        "postTime": 1627466873,
        "uid": 104581,
        "name": "kkk\u7684\u5c0f\u8214\u72d7",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P7739 \u3010[NOI2021] \u5bc6\u7801\u7bb1\u3011"
    }
]