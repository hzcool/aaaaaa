[
    {
        "content": "\u8003\u8651\u4e00\u6b21\u67e5\u8be2\uff0c\u6bd4\u5982\u67e5\u8be2 $[l,r]$ \u533a\u95f4\u3002\n\n\u9996\u5148\u627e\u51fa\u533a\u95f4\u5185\u6700\u5c0f\u503c\u7684\u4f4d\u7f6e\uff0c\u8bbe\u4e3a $pos$\u3002\n\n\u8003\u8651\u628a\u8be2\u95ee\u7684\u533a\u95f4\u7684\u5b50\u533a\u95f4\u5206\u6210\u4e09\u79cd\uff1a\n\n1. \u8de8\u8fc7\u4e86 $pos$\n2. \u5de6\u53f3\u7aef\u70b9\u90fd\u5728 $[l,pos-1]$\n3. \u5de6\u53f3\u7aef\u70b9\u90fd\u5728 $[pos+1,r]$\n\n\u8003\u8651\u5206\u522b\u5904\u7406\u3002\u5bf9\u4e8e\u7b2c\u4e00\u79cd\uff0c\u660e\u663e\u8d21\u732e\u662f $(pos-l+1)(r-pos+1)$ \u3002\n\n\u4e0b\u9762\u8bbe $[l,r][L,R]$ \u8868\u793a\u5de6\u7aef\u70b9\u5728 $[l,r]$ \u5185\uff0c\u53f3\u7aef\u70b9\u5728 $[L,R]$ \u5185\u7684\u6240\u6709\u533a\u95f4\u7684\u6700\u5c0f\u503c\u7684\u548c\u3002\n\n\u6211\u4eec\u8003\u8651\u600e\u4e48\u6c42 $[l,r][l,r]$ \u7684\u503c\u3002\u6211\u4eec\u628a\u8fd9\u4e2a\u62c6\u6210\uff1a\n$$\n[l,n][l,n] - [r + 1,n][r + 1,n] - [l,r][r + 1,n]\n$$\n\u4e5f\u5c31\u662f\u5de6\u53f3\u7aef\u70b9\u90fd\u5728 $[l,n]$ \u51cf\u53bb\u5de6\u53f3\u90fd\u5728 $[r+1,n]$ \u518d\u51cf\u53bb\u5de6\u7aef\u70b9\u5728 $[l,r]$ \u53f3\u7aef\u70b9\u5728 $[r+1,n]$ \u7684\u8d21\u732e\u3002\n\n\u600e\u4e48\u6c42 $[l,n][l,n]$ \u5462\uff0c\u8003\u8651\u9884\u5904\u7406\u51fa\u6765\u3002\u4e3a\u4e86\u65b9\u4fbf\u8bbe $f(i) = [i,n][i,n]$ \uff0c\u4e8e\u662f\u53ef\u4ee5\u53d1\u73b0\n$$\nf(i) = f(i + 1) + [i,i][i,n]\n$$\n\u518d\u8bbe $F(i) = [i,i][i,n]$ \u3002\u8003\u8651\u600e\u4e48\u9012\u63a8\u51fa $F$ \u3002\u5bf9\u4e8e\u6bcf\u4e2a\u4f4d\u7f6e $i$ \uff0c\u8bbe $r_i$ \u4e3a\u6ee1\u8db3 $a_{r_i} < a_i$ \u7684\u6700\u5c0f\u503c\uff0c\u4e5f\u5c31\u662f\u8bf4 $a_i$ \u5c0f\u4e8e $[i,r_i-1]$ \u7684\u6240\u6709\u503c\u3002\u4e8e\u662f\n$$\nF_i = F_{r_i} + a_i(r_i-i)\n$$\n\u4e8e\u662f\u9012\u63a8\u6c42\u51fa\u4e86 $F$ \u4e5f\u5c31\u6c42\u51fa\u4e86 $f$ \u3002\n\n\u56de\u5230\u539f\u6765\u7684\u95ee\u9898\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u6c42 $[l,r][r+1,n]$\u3002\u8fd9\u4e2a\u4e1c\u897f\u770b\u8d77\u6765\u6c42\u4e0d\u4e86\u3002\u4f46\u662f\uff0c\u5bf9\u4e8e\u7b2c\u4e8c\u79cd\u8be2\u95ee\uff0c\u6211\u4eec\u8981\u6c42\u7684\u662f \n$$\n[l,pos-1][pos,n]\n$$\n\u7531\u4e8e $a_{pos}$ \u662f $[l,r]$ \u7684\u6700\u5c0f\u503c\uff0c\u8fd9\u4e2a\u4e1c\u897f\u76f4\u63a5\u7b49\u4e8e $(pos-l)F_{pos}$\u3002\u56e0\u4e3a\u5de6\u7aef\u70b9\u7684\u9009\u62e9\u662f $[l,pos-1]$ \u4e2d\u4efb\u610f\u9009\u62e9\uff0c\u4e14\u6bcf\u4e2a\u533a\u95f4\u90fd\u4e00\u5b9a\u662f $pos$ \u540e\u9762\u66f4\u5c0f\uff0c\u6240\u4ee5\u5c31\u662f $F_{pos}$ \u7684 $pos-l$ \u500d\u4e86\u3002\n\n$[pos+1,r]$ \u5462\uff1f\u5012\u8fc7\u6765\uff08\u540e\u7f00\u53d8\u524d\u7f00\uff09\u4e00\u6837\u6574\u4e00\u904d\u5373\u53ef\u3002\n\n\u5b9e\u73b0\u4e0a\uff0c\u6c42 $l_i,r_i$ \u76f4\u63a5\u5355\u8c03\u6808\u5373\u53ef\u3002\u590d\u6742\u5ea6\u74f6\u9888\u5728 ST \u8868\u7684 $O(n\\log n) -O(1)$ \uff0c\u7528\u8f6c01 RMQ \u540e\u6574 \u7ebf\u6027\u7684 ST \u8868\u4e5f\u53ef\u4ee5\u505a\u5230 $O(n)-O(1)$\u3002\n\n\u4ee3\u7801\u5f88\u597d\u5199+\u597d\u8c03\u3002\u3002\u4ee3\u7801\u540e\u9762\u7559\u4e86\u4e2a gen\u3002\n\n```cpp\n#include \"iostream\"\n#include \"algorithm\"\n#include \"cstring\"\n#include \"cstdio\"\n#include \"cmath\"\n#include \"vector\"\n#include \"map\"\n#include \"set\"\n#include \"queue\"\nusing namespace std;\n#define MAXN 1000006\n//#define int long long\n#define rep(i, a, b) for (int i = (a), i##end = (b); i <= i##end; ++i)\n#define per(i, a, b) for (int i = (a), i##end = (b); i >= i##end; --i)\n#define pii pair<int,int>\n#define fi first\n#define se second\n#define mp make_pair\n#define pb push_back\n#define eb emplace_back\n#define vi vector<int>\n#define all(x) (x).begin() , (x).end()\n#define mem( a ) memset( a , 0 , sizeof a )\ntypedef long long ll;\nint n , q;\nint A[MAXN] , p[19][MAXN] , L[MAXN] , R[MAXN] , lg[MAXN];\nll f[MAXN] , F[MAXN] , g[MAXN] , G[MAXN];\nint stk[MAXN] , top;\n\nnamespace gen{\n\ttypedef unsigned long long ull;\n\tull s,a,b,c,lastans=0;\n\tvoid in( ) { cin >> s >> a >> b >> c; }\n\tull rand(){\n\t\treturn s^=(a+b*lastans)%c;\n\t}\n};\n\nvoid solve() {\n\tint typ; cin >> n >> q >> typ;\n\tlg[0] = -1;\n\trep( i , 1 , n ) scanf(\"%d\",&A[i]) , p[0][i] = i , lg[i] = lg[i >> 1] + 1;\n\trep( i , 1 , 18 ) for( int j = 1 ; j + ( 1 << i ) - 1 <= n ; ++ j ) \n\t\tp[i][j] = ( A[p[i - 1][j]] < A[p[i - 1][j + ( 1 << i - 1 )]] ? p[i - 1][j] : p[i - 1][j + ( 1 << i - 1 )] );\n\trep( i , 1 , n ) {\n\t\twhile( top && A[stk[top]] > A[i] ) R[stk[top]] = i , -- top;\n\t\tstk[++ top] = i;\n\t}\n\twhile( top ) R[stk[top]] = n + 1 , -- top;\n\tper( i , n , 1 ) {\n\t\twhile( top && A[stk[top]] > A[i] ) L[stk[top]] = i , -- top;\n\t\tstk[++ top] = i;\n\t}\n\twhile( top ) L[stk[top]] = 0 , -- top;\n\tper( i , n , 1 ) F[i] = F[R[i]] + A[i] * 1ll * ( R[i] - i ) , f[i] = f[i + 1] + F[i];\n\trep( i , 1 , n ) G[i] = G[L[i]] + A[i] * 1ll * ( i - L[i] ) , g[i] = g[i - 1] + G[i];\n\tint l , r , pos , len;\n\tunsigned long long re = 0 , res = 0;\n\tif( !typ ) {\n\t\twhile( q-- ) {\n\t\t\tscanf(\"%d%d\",&l,&r);\n\t\t\tlen = lg[r - l + 1];\n\t\t\tpos = ( A[p[len][l]] < A[p[len][r - ( 1 << len ) + 1]] ? p[len][l] : p[len][r - ( 1 << len ) + 1] );\n\t\t\tres = f[l] - f[pos] - ( pos - l ) * F[pos] + g[r] - g[pos] - ( r - pos ) * G[pos] + ( pos - l + 1 ) * 1ll * ( r - pos + 1 ) * A[pos];\n\t\t\tre ^= res;\n\t\t}\n\t} else {\n\t\tgen::in();\n\t\twhile( q-- ) {\n\t\t\tl = gen::rand() % n + 1 , r = gen::rand() % n + 1;\n\t\t\tif( l > r ) swap( l , r );\n\t\t\tlen = lg[r - l + 1];\n\t\t\tpos = ( A[p[len][l]] < A[p[len][r - ( 1 << len ) + 1]] ? p[len][l] : p[len][r - ( 1 << len ) + 1] );\n\t\t\tres = f[l] - f[pos] - ( pos - l ) * F[pos] + g[r] - g[pos] - ( r - pos ) * G[pos] + ( pos - l + 1 ) * 1ll * ( r - pos + 1 ) * A[pos];\n\t\t\tgen::lastans = res;\n\t\t\tre ^= res;\n\t\t}\n\t}\n\tcout << re << endl;\n}\n\nsigned main() {\n//    int T;cin >> T;while( T-- ) solve();\n    solve();\n}\n\n/*\nvoid solve() {\n\tsrand( (long long) new char );\n\tn = 10 , m = 10;\n\tcout << n << ' ' << m << endl;\n\trep( i , 1 , n ) printf(\"%d \",rand() % 2000000000 - 1000000000 + 1);\n\tputs(\"\");\n\trep( i , 1 , m ) {\n\t\tint l = rand() % n + 1 , r = rand() % n + 1;\n\t\tif( l > r ) swap( l , r );\n\t\tprintf(\"%d %d\\n\",l,r);\n\t}\n}\n*/\n```\n\n",
        "postTime": 1591669597,
        "uid": 63398,
        "name": "yijan",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P6604 \u3010[HNOI2016]\u5e8f\u5217 \u52a0\u5f3a\u7248\u3011"
    },
    {
        "content": "> #### *I. [P6604 [HNOI2016]\u5e8f\u5217 \u52a0\u5f3a\u7248](https://www.luogu.com.cn/problem/P6604)\n\n> \u6458\u81ea\u5b66\u4e60\u7b14\u8bb0 [\u7b80\u5355\u6811\u8bba](https://www.cnblogs.com/alex-wei/p/Tree_Tree_Tree_Tree_Tree_Tree_Tree_Tree_Tree_Tree_Tree_Tree_Tree_Tree_Tree.html) \u7b1b\u5361\u5c14\u6811\u90e8\u5206\u4f8b\u9898 I.\n\n\u548c [P6503](https://www.luogu.com.cn/problem/P6503) \u6bd4\u8f83\u7c7b\u4f3c\u3002\u6211\u4eec\u8bbe $f_i$ \u8868\u793a\u5168\u5c40\u4ee5 $i$ \u7ed3\u5c3e\u7684\u5b50\u533a\u95f4\u7684\u6700\u5c0f\u503c\u4e4b\u548c\uff0c\u4ee4 $p_i$ \u4e3a\u4e0b\u6807\u5728 $i$ \u4e4b\u524d\u7b2c\u4e00\u4e2a\u6bd4 $a_i$ \u5c0f\u7684\u4f4d\u7f6e\uff0c\u663e\u7136\u6709 $f_i=f_{p_i}+(i-p_i)a_i$\uff1a\u56e0\u4e3a $a_i$ \u5bf9 $p_i$ \u4ee5\u53ca $p_i$ \u4ee5\u524d\u7684\u6700\u5c0f\u503c\u6ca1\u6709\u5f71\u54cd\uff08\u5373 $[1,p_i]$ \u4e0e $[1,i]$\uff0c$[2,p_i]$ \u4e0e $[2,i]\\cdots$ $[p_i,p_i]$ \u4e0e $[p_i,i]$ \u7684\u6700\u5c0f\u503c\u76f8\u540c\uff09\uff0c\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u7531 $f_{p_i}$ \u8f6c\u79fb\u5f97\u6765\u3002\u800c\u6839\u636e $p_i$ \u7684\u5b9a\u4e49\uff0c\u540e\u9762 $i-p_i$ \u4e2a\u5b50\u5e8f\u5217\uff08\u5373 $[p_i+1,i],[p_i+2,i]\\cdots,[i,i]$\uff09\u7684\u6700\u5c0f\u503c\u4e3a $a_i$\u3002\n\n\u6ce8\u610f\u5230 $p_i$ \u5b9e\u9645\u76f8\u5f53\u4e8e $i$ \u5728\u7b1b\u5361\u5c14\u6811\u4e0a\u7b2c\u4e00\u4e2a\u5411\u5de6\u8d70\u7684\u7236\u4eb2\uff0c\u6c42 $p_i$ \u7684\u8fc7\u7a0b\u5341\u5206\u7c7b\u4f3c\u6784\u5efa\u7b1b\u5361\u5c14\u6811\uff1a**\u7b1b\u5361\u5c14\u6811\u4e0a\u6bcf\u4e2a\u8282\u70b9\u7684\u7956\u5148\u7531\u5de6\u53f3\u4e24\u4e2a\u5355\u8c03\u6808\u6784\u6210**\u3002\n\n\u8003\u8651\u5bf9\u4e00\u4e2a\u533a\u95f4\u6c42\u7b54\u6848\uff1a\u6c42\u51fa\u533a\u95f4\u6700\u5c0f\u503c\u7684\u4f4d\u7f6e $p$\uff0c\u90a3\u4e48\u5de6\u7aef\u5728 $p$ \u5de6\u8fb9\uff0c\u53f3\u7aef\u5728 $p$ \u53f3\u8fb9\u7684\u5b50\u533a\u95f4\u6700\u5c0f\u503c\u4e3a $a_p$\uff0c\u6545\u7b54\u6848\u52a0\u4e0a $a_p\\times (p-l+1)\\times (r-p+1)$\u3002\u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u9700\u6c42\u51fa $[l,p)$ \u4e0e $(p,r]$ \u7684\u7b54\u6848\uff1a\u8003\u8651 $(p,r]$ \u6bcf\u4e2a\u4f4d\u7f6e\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u90fd\u662f $f_r-f_p$\uff0c\u56e0\u4e3a $[i,p]$ \u4e0e $[i,r]\\ (1\\leq i\\leq p)$ \u7684\u6700\u5c0f\u503c\u76f8\u540c\u3002\u524d\u7f00\u548c\u4f18\u5316\u53ef\u4ee5\u505a\u5230 $\\mathcal{O}(1)$ \u56de\u7b54\u6bcf\u4e2a\u8be2\u95ee\u3002\u5bf9\u4e8e $[l,p)$ \u540c\u7406\uff0c\u6211\u4eec\u53ea\u9700\u9884\u5904\u7406\u51fa $g_i$ \u8868\u793a\u5168\u5c40\u4ee5 $i$ \u5f00\u5934\u7684\u5b50\u533a\u95f4\u7684\u6700\u5c0f\u503c\u4e4b\u548c\u5e76\u7c7b\u4f3c\u5904\u7406\u5373\u53ef\u3002\n\n\u590d\u6742\u5ea6\u74f6\u9888\u5728\u4e8e\u533a\u95f4 RMQ\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(n\\log n+q)$\u3002\n\n```cpp\nconst int N = 1e5 + 5;\nconst int K = 17;\n\nnamespace gen {\n\tull s, a, b, c, las = 0;\n\tull rand() {return s ^= (a + b * las) % c;}\n}\n\nint n, q, type, stc[N], *top = stc, a[N], lg[N], pre[N], suf[N];\nll mi[K][N], fp[N], gp[N], fs[N], gs[N]; ull res;\nint cmp(int x, int y) {return a[x] < a[y] ? x : y;}\nint RMQ(int l, int r) {int d = lg[r - l + 1]; return cmp(mi[d][l], mi[d][r - (1 << d) + 1]);}\n\nint main(){\n\tcin >> n >> q >> type;\n\tfor(int i = 1; i <= n; i++) a[i] = read(), mi[0][i] = i;\n\tfor(int i = 2; i <= n; i++) lg[i] = lg[i >> 1] + 1;\n\tfor(int i = 1; i <= lg[n]; i++)\n\t\tfor(int j = 1; j + (1 << i) - 1 <= n; j++)\n\t\t\tmi[i][j] = cmp(mi[i - 1][j], mi[i - 1][j + (1 << i - 1)]);\n\tfor(int i = 1; i <= n; i++) { \n\t\twhile(*top && a[*top] >= a[i]) suf[*top--] = i; // \u53ef\u4ee5\u7c7b\u6bd4\u6c42\u7b1b\u5361\u5c14\u6811\u7684\u8fc7\u7a0b: ls[i] = *top, \u56e0\u6b64 suf[*top] = i;\n\t\tpre[i] = *top, *++top = i; // \u540c\u7406, rs[*top] = i, \u6240\u4ee5 pre[i] = *top: \u7b1b\u5361\u5c14\u6811\u4e0a\u6bcf\u4e2a\u8282\u70b9\u7684\u7956\u5148\u662f\u7531\u4e24\u4e2a\u5355\u8c03\u6808\u6784\u6210\u7684!\n\t}\n\tfor(int i = 1; i <= n; i++)\n\t\tfp[i] = fp[pre[i]] + 1ll * a[i] * (i - pre[i]), gp[i] = gp[i - 1] + fp[i];\n\tfor(int i = n; i; i--)\n\t\tfs[i] = fs[suf[i]] + 1ll * a[i] * (suf[i] - i), gs[i] = gs[i + 1] + fs[i];\n\tif(type) gen :: s = read(), gen :: a = read(), gen :: b = read(), gen :: c = read();\n\tfor(int i = 1, l, r; i <= q; i++) {\n\t\tif(type == 0) l = read(), r = read();\n\t\telse {\n\t\t\tl = gen :: rand() % n + 1;\n\t\t\tr = gen :: rand() % n + 1;\n\t\t\tif(l > r) swap(l, r);\n\t\t}\n\t\tll p = RMQ(l, r), ans;\n\t\tans = a[p] * (r - p + 1) * (p - l + 1);\n\t\tans += gp[r] - gp[p] - fp[p] * (r - p);\n\t\tans += gs[l] - gs[p] - fs[p] * (p - l);\n\t\tres ^= gen :: las = ans;\n\t}\n\tcout << res << endl;\n    return flush(), 0;\n}\n```",
        "postTime": 1634461139,
        "uid": 123294,
        "name": "Alex_Wei",
        "ccfLevel": 10,
        "title": "P6604 [HNOI2016]\u5e8f\u5217 \u52a0\u5f3a\u7248"
    },
    {
        "content": "\u7b97\u662f\u4e00\u4e2a\u601d\u7ef4\u4e0a\u7684\u6f0f\u6d1e\u4e86\u3002~~\u800c\u4e14\u4e0d\u60f3\u6253 `\\operator` \u5c31\u7b97\u4e86\u5427~~\n\n\u4ee4 $st(l,r,L,R)$ \u4e3a\u5de6\u7aef\u70b9\u5728\u533a\u95f4 $[l,r]$\uff0c\u53f3\u7aef\u70b9\u5728\u533a\u95f4 $[L,R]$ \u7684\u7b54\u6848\u3002\u90a3\u4e48\u539f\u95ee\u9898\u7684\u5f62\u5f0f\u662f\u591a\u6b21\u8be2\u95ee $st(l,r,l,r)$\u3002\n\n\u8003\u8651\u5c06\u539f\u95ee\u9898\u7528\u53e6\u4e00\u79cd\u5f62\u5f0f\u8868\u793a\u3002\u671f\u671b\u7684\u505a\u6cd5\u662f\u5c06\u5176\u52fe\u7ed3\u5230\u4e00\u4e2a\u53ef\u4ee5\u9884\u5904\u7406\u7684\uff0c\u548c\u8fb9\u754c\u51d1\u8fb9\u7684\u5f62\u5f0f\u3002\n\n\u6709\u4e00\u4e2a\u6bd4\u8f83\u597d\u60f3\u5230\u7684\u6784\u9020\u65b9\u6cd5\u662f\uff0c$st(l,r,l,r) = st(1,r,1,r) - st(1,l-1,l,r) - st(1,l-1,1,l-1)$\u3002\u7406\u89e3\u65b9\u5f0f\u662f\u53bb\u6389\u542b\u6709\u5de6\u7aef\u70b9\u5728 $[1,l-1]$ \u5185\uff0c\u53f3\u7aef\u70b9\u5728 $[l,r]$ \u5185\u7684\u4e0e\u4e24\u7aef\u70b9\u5747\u5728 $[1,l-1]$ \u5185\u7684\u8d21\u732e\u5c31\u662f\u4e24\u7aef\u70b9\u5747\u5728 $[l,r]$ \u7684\u8d21\u732e\u3002\n\n\u6709\u51e0\u4e2a\u7279\u6b8a\u7684\u5f62\u5f0f\u6bd4\u8f83\u8ba9\u4eba\u5728\u610f\uff0c\u4e5f\u5c31\u662f\uff0c\u51fa\u73b0\u4e86\u4e24\u6b21 $st(1,x,1,x)$ \u7684\u5f62\u5f0f\uff08$x$ \u5206\u522b\u662f $l-1$ \u548c $r$\uff09\u3002\n\n\u90a3\u4e48\u4ee4 $F(x) = st(1,x,1,x)$\u3002\n\n\u53d1\u73b0\u8fd9\u4e2a\u4e1c\u897f\u4ecd\u7136\u662f\u4e00\u4e2a\u4e0d\u597d\u8ba1\u7b97\u7684\u5f62\u5f0f\uff0c\u5c06 $F(x)$ \u4e2d\u7684 $x$ \u62c6\u51fa\u6765\uff0c\u53ef\u5f97\uff1a\n\n$$\n\\begin{aligned}\nF(x) &= F(x-1) + st(x,x,x,x) + st(1,x-1,x,x) \\\\\n&=F(x-1) + st(1,x,x,x)\n\\end{aligned}\n$$\n\n\u53d1\u73b0\u8fd9\u662f\u4e00\u4e2a\u7c7b\u4f3c\u4e8e\u524d\u7f00\u548c\u7684\u5f62\u5f0f\uff0c\u9700\u8981\u8003\u8651 $st(1,x,x,x)$ \u8fd9\u4e2a\u770b\u8d77\u6765\u5c31\u5f88\u597d\u770b\u7684\u4e1c\u897f\u600e\u4e48\u8ba1\u7b97\u3002\u8bb0\u5176\u4e3a $f(x)$\uff0c\u90a3\u4e48 $F(x) = \\sum_{i=1}^x f(x)$\u3002\n\n\u6ce8\u610f\u5230\u8fd9\u662f\u4e00\u4e2a\u524d\u7f00\u548c\u7684\u5f62\u5f0f\uff0c\u4e0d\u96be\u60f3\u5230 $f(x)$ \u5e94\u7531\u4e4b\u524d\u7684\u67d0\u4e00\u4e2a\u72b6\u6001\u8f6c\u79fb\u3002\u90a3\u4e48\u76f4\u63a5\u8003\u8651 $a_x$ \u7684\u8d21\u732e\u3002\u5b9a\u4e49 $lst_x$ \u4e3a\uff0c\u5728 $x$ \u524d\u7684\u7b2c\u4e00\u4e2a\u6bd4 $a_x$ \u5c0f\u7684\u6570\u7684\u4f4d\u7f6e\uff08\u4e0d\u5b58\u5728\u5219\u4e3a $0$\uff09\u3002\u505a\u8fd9\u4e2a\u4e8b\u60c5\u7684\u662f\u8003\u8651\u4e86 $a_x$ \u7684\u4f5c\u7528\u8303\u56f4\u7684\u7ed3\u679c\u3002\u90a3\u4e48 $f(x) = f(lst_x) + a_x(x-lst_x)$\u3002\n\n\u4e8e\u662f\u5904\u7406\u51fa $f,F$\u3002\u7528\u540c\u6837\u7684\u65b9\u6cd5\u5904\u7406\u51fa $G(x) = st(x,n,x,n),g(x) = st(x,x,x,n)$\u3002\u9700\u8981\u6c42\u51fa\u53e6\u4e00\u4e2a\u8f85\u52a9\u6570\u7ec4 $nxt_x$ \u8868\u793a\u5728 $x$ \u540e\u7684\u7b2c\u4e00\u4e2a\u5c0f\u4e8e $a_x$ \u7684\u6570\u7684\u4f4d\u7f6e\u3002\n\n\u4e8e\u662f\u8981\u6c42 $lst_x$ \u548c $nxt_x$\u3002\u8fd9\u662f\u4e00\u4e2a\u7ecf\u5178\u95ee\u9898\uff0c\u76f4\u63a5\u7528\u5355\u8c03\u6808\u89e3\u51b3\u95ee\u9898\u3002\uff08\u5355\u8c03\u6808\u6a21\u677f\uff09\n\n\n\u9057\u6f0f\u4e86\u4e00\u4e2a\u4e1c\u897f $st(1,l-1,l,r)$\u3002\u8fd9\u4e2a\u4e1c\u897f\u6bd4\u8f83\u4e00\u822c\u6ca1\u6709\u597d\u7684\u65b9\u6cd5\u89e3\u51b3\uff0c\u653e\u5728\u4e0b\u9762\u8003\u8651\u3002\n\n\u53cd\u6b63\u8ba9\u6211\u60f3\u4e0d\u5230\u7684\u662f\uff0c\u8be2\u95ee $[l,r]$ \u7684\u7b54\u6848\uff0c\u4ee4 $pos = \\arg \\min_{i=l}^r$\uff0c\u8003\u8651\u7b97\u4e09\u4e2a\u4e1c\u897f\uff1a\n\n1. \u4e24\u4e2a\u7aef\u70b9\u90fd\u5728 $[l,pos-1]$ \u5185\u7684\u7b54\u6848\uff1b   \n2. \u4e24\u4e2a\u7aef\u70b9\u90fd\u5728 $[pos+1,r]$ \u5185\u7684\u7b54\u6848\uff1b   \n3. \u5305\u542b $pos$ \u7684\u533a\u95f4\u7684\u7b54\u6848\u3002\n\n\u6bd5\u7adf\u4e00\u822c\u6765\u8bf4\u8fd9\u6837\u505a\u7684\u8bdd\u90fd\u4f1a\u9012\u5f52\u4e0b\u53bb\u901a\u8fc7\u6570\u636e\u7ed3\u6784\u4f18\u5316\u5feb\u901f\u5904\u7406\u561b |=.=)\n\n\u4ece\u7b80\u5355\u7684\u5165\u624b\uff0c\u7b2c 3 \u90e8\u5206\u7684\u7b54\u6848\u663e\u7136\u662f $(pos-l+1)(r-pos+1)pos$\u3002\n\n\u7136\u540e\u8003\u8651\u524d\u4e24\u4e2a\u7684\u7b54\u6848\uff0c\u6ce8\u610f\u5230\u4e24\u90e8\u5206\u6765\u6e90\u548c\u5f62\u5f0f\u5927\u81f4\u76f8\u540c\uff0c\u6545\u53ea\u8003\u8651\u7b2c\u4e00\u4e2a\u3002\u56de\u5230\u4e0a\u9762\u7684\u5185\u5bb9\uff0c\u8fd9\u4e2a\u4e00\u822c\u5f62\u5f0f\u4e2d\u5269\u4e0b\u4e00\u4e2a $st(1,l-1,l,r)$\u3002\u9700\u8981\u53bb\u9664\u6389\u65e0\u7528\u7684\u4fe1\u606f\u3002\u56e0\u4e3a $a_{pos}$ \u662f $[l,r]$ \u5185\u7684\u6700\u5c0f\u503c\uff0c\u6545\u6700\u5c0f\u503c\u4e00\u5b9a\u4e0e $[l,pos-1]$ \u65e0\u5173\uff08\u8981\u53d6\u4e5f\u81f3\u5c11\u53d6\u5230 $a_{pos}$\uff09\uff0c\u6240\u4ee5\u5f97\u5230 $(pos-l)st(pos,pos)(pos,n) = st(l,pos-1)(pos,n)$\u3002\n\n\u6700\u540e\u8981\u5904\u7406\u7684\u662f $[l,r]$ \u5185\u6700\u5c0f\u503c\u7684\u4f4d\u7f6e\u3002\u53ef\u4ee5\u7528 $st$ \u8868\u89e3\u51b3\u95ee\u9898\uff0c\u4e5f\u53ef\u4ee5\u7528 $O(n) - O(1)$ rmq \u6765\u8e29\u4f17\u4ed9\u3002\u603b\u4e4b\u4e0b\u9762\u7684\u4ee3\u7801\u65f6\u95f4\u590d\u6742\u5ea6\u662f $O(n \\log n + q)$\u3002\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\ntypedef unsigned long long ull;\nchar buf[1<<21],*p1=buf,*p2=buf;\n#define getchar() (p1==p2 && (p2=(p1=buf)+fread(buf,1,1<<18,stdin),p1==p2)?EOF:*p1++)\nint read()\n{\n\tint x=0,f=1;\n\tchar c=getchar();\n\twhile(c<'0' || c>'9')\n\t{\n\t\tif(c=='-')\tf=-1;\n\t\tc=getchar();\n\t}\n\twhile(c>='0' && c<='9')\tx=(x<<1)+(x<<3)+(c^'0'),c=getchar();\n\treturn x*f;\n}\nstruct Generator{\n\tull s,a,b,c,lastans;\n\tGenerator(){lastans=0;}\n\tvoid getVal(){s=read(),a=read(),b=read(),c=read();}\n\tull rand(){return s^=(a+b*lastans)%c;}\n}gen;\nint Arg(int x,int y,int a,int b){return x<y?a:b;}\nint n,q,type,a[100005],stk[100005],top,lst[100005],nxt[100005],args[17][100005],lgs[100005];\null f[100005],g[100005],sumf[100005],sumg[100005];\nint query(int l,int r)\n{\n\tint d=lgs[r-l+1];\n\treturn Arg(a[args[d][l]],a[args[d][r-(1<<d)+1]],args[d][l],args[d][r-(1<<d)+1]);\n}\nint main(){\n\tn=read(),q=read(),type=read();\n\tfor(int i=1;i<=n;++i)\ta[i]=read(),nxt[i]=n+1;\n\tfor(int i=1;i<=n;++i)\n\t{\n\t\twhile(top && a[stk[top]]>a[i])\tnxt[stk[top--]]=i;\n\t\tstk[++top]=i;\n\t}\n\ttop=0;\n\tfor(int i=n;i;--i)\n\t{\n\t\twhile(top && a[stk[top]]>a[i])\tlst[stk[top--]]=i;\n\t\tstk[++top]=i;\n\t}\n\tfor(int i=1;i<=n;++i)\tf[i]=f[lst[i]]+ull(a[i])*ull(i-lst[i]);\n\tfor(int i=n;i;--i)\tg[i]=g[nxt[i]]+ull(a[i])*ull(nxt[i]-i);\n\tfor(int i=1;i<=n;++i)\tsumf[i]=sumf[i-1]+f[i];\n\tfor(int i=n;i;--i)\tsumg[i]=sumg[i+1]+g[i];\n\tfor(int i=2;i<=n;++i)\tlgs[i]=lgs[i>>1]+1;\n\tfor(int i=1;i<=n;++i)\targs[0][i]=i;\n\tfor(int j=1;j<=16;++j)\tfor(int i=1;i+(1<<j)-1<=n;++i)\targs[j][i]=Arg(a[args[j-1][i]],a[args[j-1][i+(1<<(j-1))]],args[j-1][i],args[j-1][i+(1<<(j-1))]);\n\tull ans=0;\n\tif(!type)\n\t{\n\t\twhile(q-->0)\n\t\t{\n\t\t\tint l=read(),r=read(),pos=query(l,r);\n//\t\t\tprintf(\"%d %d %d\\n\",l,r,pos);\n\t\t\tans^=(sumg[l]-sumg[pos]-ull(pos-l)*g[pos]+sumf[r]-sumf[pos]-ull(r-pos)*f[pos]+ull(pos-l+1)*ull(r-pos+1)*ull(a[pos]));\n\t\t}\n\t}\n\telse\n\t{\n\t\tgen.getVal();\n\t\twhile(q-->0)\n\t\t{\n\t\t\tint l,r,pos;\n\t\t\tl=gen.rand()%n+1;\n\t\t\tr=gen.rand()%n+1;\n\t\t\tif(l>r)\tswap(l,r);\n\t\t\tpos=query(l,r);\n\t\t\tans^=(gen.lastans=sumg[l]-sumg[pos]-ull(pos-l)*g[pos]+sumf[r]-sumf[pos]-ull(r-pos)*f[pos]+ull(pos-l+1)*ull(r-pos+1)*ull(a[pos]));\n\t\t}\n\t}\n\tprintf(\"%llu\",ans);\n\treturn 0;\n}\n```",
        "postTime": 1624888761,
        "uid": 184977,
        "name": "pomelo_nene",
        "ccfLevel": 9,
        "title": "\u95f2\u8bb02"
    },
    {
        "content": "\u6c34\u7bc7\u53cc\u500d\u7ecf\u9a8c\u9898\u89e3\u3002\n\n\u8fd9\u662f\u4e00\u4e2a $O(n\\log n)+O(1)+O(n\\log n)$ \u7684\u5728\u7ebf\u505a\u6cd5\u3002\n\n\u732b\u6811\uff0c\u5bf9\u4e8e\u67d0\u4e2a\u8282\u70b9\uff0c\u5148\u9884\u5904\u7406\u51fa\u4e00\u4e2a\u70b9\u5230\u4e2d\u70b9\u7684\u7b54\u6848\u3002\u8fd9\u53ef\u4ee5\u4f7f\u7528\u5355\u8c03\u6808\u6c42\u51fa\u3002\u90a3\u4e48\u6211\u4eec\u9700\u8981\u8ba1\u7b97\u8de8\u4e2d\u70b9\u7684\u8d21\u732e\u3002\n\n\u9884\u5904\u7406\u51fa\u6bcf\u4e2a\u70b9\u5230\u4e2d\u70b9\u7684\u6700\u5c0f\u503c\uff0c\u5e76\u5904\u7406\u51fa\u8fd9\u4e2a\u6700\u5c0f\u503c\u80fd\u5ef6\u4f38\u5230\u53f3\u8fb9\u54ea\u91cc\u3002\u8fd9\u53ef\u4ee5\u5bf9\u5de6\u53f3\u4e24\u4e2a\u533a\u95f4\u8fdb\u884c\u4e00\u6b21\u5f52\u5e76\u5f97\u5230\u3002\n\n\u8d21\u732e\u5206\u4e3a\u4e24\u79cd\uff1a\u6700\u5c0f\u503c\u5728\u5de6\u8fb9\u7684\uff0c\u6211\u4eec\u5728\u5de6\u7aef\u70b9\u5904\u8ba1\u7b97\u8d21\u732e\uff1b\u6700\u5c0f\u503c\u5728\u53f3\u8fb9\u7684\uff0c\u6211\u4eec\u5728\u53f3\u7aef\u70b9\u5904\u8ba1\u7b97\u8d21\u732e\u3002\n\n\u82e5\u67e5\u8be2\u5de6\u7aef\u70b9\u5230\u4e2d\u70b9\u7684\u6700\u5c0f\u503c\u4e0d\u80fd\u5ef6\u4f38\u5230\u53f3\u7aef\u70b9\uff0c\u5219\u5de6\u8fb9\u6240\u6709\u70b9\u90fd\u6709\u5230\u5176\u5ef6\u4f38\u7684\u53f3\u7aef\u70b9\u7684\u5b8c\u6574\u7684\u8d21\u732e\u3002\u5bf9\u4e8e\u53f3\u534a\u90e8\u5206\uff0c\u5de6\u7aef\u70b9\u5ef6\u4f38\u7684\u6700\u8fdc\u70b9\u5de6\u8fb9\u7684\u6240\u6709\u70b9\u90fd\u6709\u5b8c\u6574\u7684\u8d21\u732e\uff0c\u800c\u53f3\u8fb9\u5230\u53f3\u7aef\u70b9\u7684\u6240\u6709\u70b9\u90fd\u53ea\u6709\u5230\u5de6\u7aef\u70b9\u7684\u8d21\u732e\u3002\u8fd9\u4e9b\u4e1c\u897f\u90fd\u662f\u53ef\u4ee5\u62c6\u5f00\u7136\u540e\u9884\u5904\u7406\u51fa\u6765\u7684\u3002\n\n\u53e6\u4e00\u79cd\u60c5\u51b5\u7684\u8bdd\u540c\u7406\u53ef\u5f97\u3002\n\n\u4ee3\u7801\u5b9e\u73b0\u4e0a\uff0c\u8fd9\u4e2a\u5230\u4e2d\u70b9\u7684\u524d\u7f00\u548c\u5f88\u70e6\u4eba\uff0c\u6240\u4ee5\u6211\u5206\u522b\u4fdd\u5b58\u7684\u5de6\u8fb9\u7684\u7b54\u6848\u548c\u53f3\u8fb9\u7684\u7b54\u6848\u3002\n\n\u53e6\u5916\u8fd9\u4e2a\u505a\u6cd5\u5176\u5b9e\u662f\u548c\u90a3\u4e2a rmq \u7684\u505a\u6cd5\u672c\u8d28\u76f8\u540c\uff0c\u90a3\u4e2a\u505a\u6cd5\u57fa\u672c\u4e0a\u76f8\u5f53\u4e8e\u628a\u8fd9\u4e2a\u505a\u6cd5\u642c\u5230\u7b1b\u5361\u5c14\u6811\u4e0a\uff0c\u7136\u540e\u5c31\u5c11\u4e86\u4e00\u5806\u7279\u5224\u2026\u2026\n\n\u653e\u4e00\u4e0b std\uff1a\n```cpp\n#include<algorithm>\n#include<cctype>\n#include<cstdio>\nusing namespace std;\ninline int readint(){\n\tint x=0;\n\tbool f=0;\n\tchar c=getchar();\n\twhile(!isdigit(c)&&c!='-') c=getchar();\n\tif(c=='-'){\n\t\tf=1;\n\t\tc=getchar();\n\t}\n\twhile(isdigit(c)){\n\t\tx=x*10+c-'0';\n\t\tc=getchar();\n\t}\n\treturn f?-x:x;\n}\nconst int maxn=1e5+5;\nint n,q,a[maxn*2];\nbool type;\ntypedef long long ll;\nint pos[maxn*2];\nll s1[25][maxn*2],s2l[25][maxn*2],s2r[25][maxn*2];\nint mn[25][maxn*2],pp[25][maxn*2];\nll s3l[25][maxn*2],s3r[25][maxn*2];\nll s4l[25][maxn*2],s4r[25][maxn*2];\nint st[maxn],top;\nvoid build(int o,int l,int r,int d){\n\tif(l==r){\n\t\tpos[r]=o;\n\t\treturn;\n\t}\n\tint mid=l+(r-l)/2;\n\tbuild(o*2,l,mid,d+1);\n\tbuild(o*2+1,mid+1,r,d+1);\n\tll res=0;\n\tst[top=0]=mid+1;\n\tfor(int i=mid;i>=l;i--){\n\t\twhile(top&&a[i]<a[st[top]]){\n\t\t\tres-=1ll*a[st[top]]*(st[top-1]-st[top]);\n\t\t\ttop--;\n\t\t}\n\t\tst[++top]=i;\n\t\tres+=1ll*a[i]*(st[top-1]-i);\n\t\ts1[d][i]=i==mid?res:s1[d][i+1]+res;\n\t\tmn[d][i]=a[st[1]];\n\t}\n\tres=0;\n\tst[top=0]=mid;\n\tfor(int i=mid+1;i<=r;i++){\n\t\twhile(top&&a[i]<a[st[top]]){\n\t\t\tres-=1ll*a[st[top]]*(st[top]-st[top-1]);\n\t\t\ttop--;\n\t\t}\n\t\tst[++top]=i;\n\t\tres+=1ll*a[i]*(i-st[top-1]);\n\t\ts1[d][i]=i==mid+1?res:s1[d][i-1]+res;\n\t\tmn[d][i]=a[st[1]];\n\t}\n\tint cur=r;\n\tfor(int i=l;i<=mid;i++){\n\t\twhile(cur>mid&&mn[d][cur]<mn[d][i]) pp[d][cur--]=i;\n\t\tpp[d][i]=cur;\n\t}\n\tfor(int i=mid+1;i<=cur;i++) pp[d][i]=mid+1;\n\tfor(int i=mid;i>=l;i--){\n\t\ts2l[d][i]=s2l[d][i+1]+1ll*mn[d][i]*(pp[d][i]-mid);\n\t\ts3l[d][i]=s3l[d][i+1]+1ll*mn[d][i]*mid;\n\t\ts4l[d][i]=s4l[d][i+1]+mn[d][i];\n\t}\n\tfor(int i=mid+1;i<=r;i++){\n\t\ts2r[d][i]=s2r[d][i-1]+1ll*mn[d][i]*(mid+1-pp[d][i]);\n\t\ts3r[d][i]=s3r[d][i-1]+1ll*mn[d][i]*(mid+1);\n\t\ts4r[d][i]=s4r[d][i-1]+mn[d][i];\n\t}\n}\nint lg[maxn*4];\nnamespace gen{\n\ttypedef unsigned long long ull;\n\tull s,a,b,c,lastans=0;\n\tull rand(){\n\t\treturn s^=(a+b*lastans)%c;\n\t}\n};\nusing gen::ull;\nint main(){\n\t#ifdef LOCAL\n\tfreopen(\"in.txt\",\"r\",stdin);\n\tfreopen(\"out.txt\",\"w\",stdout);\n\t#endif\n\tn=readint();\n\tq=readint();\n\ttype=readint();\n\tfor(int i=1;i<=n;i++) a[i]=readint();\n\tint len=1;\n\twhile(len<n) len*=2;\n\tbuild(1,1,len,1);\n\tfor(int i=2;i<=n*4;i++) lg[i]=lg[i/2]+1;\n\tif(type){\n\t\tgen::s=readint();\n\t\tgen::a=readint();\n\t\tgen::b=readint();\n\t\tgen::c=readint();\n\t}\n\tull out=0;\n\twhile(q--){\n\t\tint l,r;\n\t\tif(type){\n\t\t\tl=gen::rand()%n+1;\n\t\t\tr=gen::rand()%n+1;\n\t\t\tif(l>r) std::swap(l,r);\n\t\t}\n\t\telse{\n\t\t\tl=readint();\n\t\t\tr=readint();\n\t\t}\n\t\tif(l==r){\n\t\t\tout^=gen::lastans=a[r];\n\t\t\tcontinue;\n\t\t}\n\t\tint k=lg[pos[r]]-lg[pos[l]^pos[r]];\n\t\tll ans=s1[k][l]+s1[k][r];\n\t\tif(pp[k][l]<r){\n\t\t\tans+=s2l[k][l]+s2r[k][pp[k][l]];\n\t\t\tans+=s3r[k][r]-s3r[k][pp[k][l]];\n\t\t\tans-=(s4r[k][r]-s4r[k][pp[k][l]])*l;\n\t\t}\n\t\telse{\n\t\t\tans+=s2r[k][r]+s2l[k][pp[k][r]];\n\t\t\tans-=s3l[k][l]-s3l[k][pp[k][r]];\n\t\t\tans+=(s4l[k][l]-s4l[k][pp[k][r]])*r;\n\t\t}\n\t\tout^=gen::lastans=ans;\n\t}\n\tprintf(\"%llu\\n\",out);\n\treturn 0;\n}\n```",
        "postTime": 1591685093,
        "uid": 174045,
        "name": "FZzzz",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P6604 \u3010[HNOI2016]\u5e8f\u5217 \u52a0\u5f3a\u7248\u3011"
    },
    {
        "content": "### Description.\n\u591a\u6b21\u8be2\u95ee $l$ \u548c $r$\uff0c\u6c42 $\\sum_{x=l}^r\\sum_{y=x}^r\\min_{i=x}^ya_i$\n### Solution\n\u6211\u4eec\u8bbe $[l,r][x,y]$ \u4ee3\u8868\u5de6\u7aef\u70b9\u5728 $[l,r]$ \u53f3\u7aef\u70b9\u5728 $[x,y]$ \u7684\u7b54\u6848\u3002  \n$$\\therefore[l,r][l,r]=[1,r][1,r]-[1,l-1][1,l-1]-[1,l-1][l,r]$$\n\u6211\u4eec\u8bbe $F(x)=[1,x][1,x]$\uff0c$f(x)=[1,x][x,x]$\uff0c$ls(x)$ \u8868\u793a\u4e0a\u4e00\u4e2a\u6bd4 $x$ \u5c0f\u7684\u6570\u3002  \n$$\\therefore F(x)=[1,x-1][1,x-1]+[1,x][x,x]=F(x-1)+f(x)$$\n$$\\therefore f(x)=f(ls(x))+(x-ls(x))\\times a_x$$\n\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5 $O(n)$ \u9884\u5904\u7406\u51fa $f(x)$ \u548c $F(x)$\u3002  \n\u4f46\u662f\u5bf9\u4e8e\u90a3\u4e2a $[1,l-1][l,r]$ \u5f88\u96be\u5904\u7406\u3002  \n\u6211\u4eec\u4e0d\u59a8\u8003\u8651\u7279\u6b8a\u60c5\u51b5\uff0c\u5047\u8bbe $[l,r]$ \u6ee1\u8db3 $a_l\\le a_x(x\\in[l,r])$  \n\u90a3\u4e48 $[1,l-1][l,r]=(r-l+1)\\times F(l-1)$  \n\u6211\u4eec\u8003\u8651\u5982\u4f55\u628a\u539f\u9898\u8f6c\u5316\u5230\u8fd9\u4e2a\u4e0a\u9762\u3002  \n\u5bf9\u4e8e\u8be2\u95ee\uff0c\u6211\u4eec\u5148\u8fdb\u884c\u4e00\u6b65\u8f6c\u5316\u3002\uff08\u8bbe $p=wh[l,r]$  \n$$[l,r][l,r]=[l,p][l,p]+[p,r][p,r]+[l,p-1][p+1,r]-[p,p][p,p]$$  \n$$\\because [l,p-1][p+1,r]=(p-l)\\times(r-p)\\times a_p$$  \n$$\\because [p,p][p,p]=a_p$$\n\u6211\u4eec\u5c31\u53ef\u4ee5\u628a\u5b83\u7528\u53cc\u500d\u5e38\u6570\u7684\u4ee3\u4ef7\u8f6c\u5316\u6210 $a_l\\le a_x(x\\in[l,r])$\u3002  \n\u7136\u540e\u518d\u9884\u5904\u7406\u4e00\u4e0b\uff0c\u5355\u8c03\u6808\u6c42\u4e00\u4e0b $ls(x)$\uff0cst \u8868\u7ef4\u62a4\u4e00\u4e0b $wh$ \u5c31\u597d\u4e86\u3002  \n\u6ce8\u610f\u6709\u4e9b\u65f6\u5019\u5de6\u7aef\u70b9\u662f\u6700\u5c0f\u503c\uff0c\u6709\u4e9b\u65f6\u5019\u53f3\u7aef\u70b9\u662f\u6700\u5c0f\u503c\uff0c\u6240\u4ee5\u9700\u8981\u505a\u4e24\u6b21\u3002  \n\u7136\u540e\u518d\u63a8\u4e0b\u53bb\u5c31\u548c@yijan \u7684\u505a\u6cd5\u6b8a\u9014\u540c\u5f52\u4e86 ![](//xn--9zr.tk/cy)\n### Coding.\n~~\u6682\u65e0\uff0c\u4e0d\u8d34\u3002\u56e0\u4e3a\u8fd8\u6ca1\u5199\uff0c\u5199\u5b8c\u53ef\u80fd\u4f1a\u8d34~~  \n~~upd\uff1a\u4ee3\u7801\u6765\u4e86\uff01~~  \n```cpp\n//\u613f\u4f60\u6709\u4e00\u5929\u80fd\u548c\u4f60\u91cd\u8981\u7684\u4eba\u91cd\u9022\u3002\n#include<bits/stdc++.h>\nusing namespace std;typedef long long ll;\ntemplate<typename T>inline void read(T &x)\n{\n\tx=0;char c=getchar(),f=0;\n\tfor(;c<'0'||c>'9';c=getchar()) if(c=='-') f=1;\n\tfor(;c>='0'&&c<='9';c=getchar()) x=(x<<1)+(x<<3)+(c^48);\n\tif(f) x=-x;\n}\n//\u8fd9\u91cc f \u548c F \u548c\u4e0a\u9762\u5b9a\u4e49\u7684\u4e00\u6837\uff0cg \u548c G \u662f\u53cd\u8fc7\u6765\u4e4b\u540e\u7684\u5b9a\u4e49\n//ls \u76f8\u5f53\u4e8e\u8fd9\u91cc\u7684 L\uff0crs \u76f8\u5f53\u4e8e\u8fd9\u91cc\u7684 R\u3002\ntypedef unsigned long long ull;const int N=100005;ull S,A,B,C,las=0,res=0;\nint n,q,a[N],L[N],R[N],st[N][20],lg[N],sa[N],tp;ll f[N],F[N],g[N],G[N];char tag;\ninline ull rnd() {return S^=(A+B*las)%C;}\ninline int gtmn(int x,int y) {return a[x]<a[y]?x:y;}\ninline int qry(int l,int r) {int g=lg[r-l+1];return gtmn(st[l][g],st[r-(1<<g)+1][g]);}\nint main()\n{\n\tread(n),read(q),read(tag),lg[0]=-1;for(int i=1;i<=n;i++) read(a[i]),st[i][0]=i,lg[i]=lg[i>>1]+1;\n\tfor(int i=1;i<20;i++) for(int j=1;j+(1<<(i-1))<=n;j++) st[j][i]=gtmn(st[j][i-1],st[j+(1<<(i-1))][i-1]);\n\tfor(int i=1;i<=n;i++) {while(tp&&a[sa[tp]]>a[i]) R[sa[tp--]]=i;sa[++tp]=i;}\n\twhile(tp) R[sa[tp--]]=n+1;\n\tfor(int i=n;i>=1;i--) {while(tp&&a[sa[tp]]>a[i]) L[sa[tp--]]=i;sa[++tp]=i;}\n\twhile(tp) L[sa[tp--]]=0;\n\tfor(int i=1;i<=n;i++) g[i]=g[L[i]]+1ll*a[i]*(i-L[i]),G[i]=G[i-1]+g[i];\n\tfor(int i=n;i>=1;i--) f[i]=f[R[i]]+1ll*a[i]*(R[i]-i),F[i]=F[i+1]+f[i];\n\ttag?read(S),read(A),read(B),read(C):void();for(int l,r,p;q--;)\n\t{\n\t\tif(tag) l=rnd()%n+1,r=rnd()%n+1,l>r?swap(l,r):void(),p=qry(l,r);else read(l),read(r),p=qry(l,r);\n\t\tres^=(las=F[l]-F[p]-(p-l)*f[p]+G[r]-G[p]-(r-p)*g[p]+1ll*(p-l+1)*(r-p+1)*a[p]);\n\t}\n\treturn printf(\"%llu\\n\",res),0;\n}\n```",
        "postTime": 1616400330,
        "uid": 44805,
        "name": "Leap_Frog",
        "ccfLevel": 7,
        "title": "P6604 [HNOI2016]\u5e8f\u5217 \u52a0\u5f3a\u7248\uff08\u9898\u89e3\uff09"
    },
    {
        "content": "[\u732b\u6811\u5b66\u4e60\u7b14\u8bb0](https://www.luogu.com.cn/blog/221955/mao-shu)\n\n\u4e0d\u9700\u8981\u5355\u8c03\u6808\uff0c\u7528\u53cc\u6307\u9488\u5c31\u884c\u3002\n\n\u5b58\u50a8\u7ed3\u70b9\u4fe1\u606f\u7684\u7ed3\u6784\u4f53\uff1a\n\n```cpp\nstruct T{ll la,ra,s,g;int m,l,r;}s[19][N];\n```\n\u5176\u4e2d $l,r$ \u5206\u522b\u8868\u793a\u6240\u5728\u533a\u95f4\u5de6\u53f3\u7aef\u70b9\uff1b\n\n$la,ra$ \u5206\u522b\u8868\u793a $[l,x]$ \u548c $[x,r]$ \u7684\u7b54\u6848\uff1b\n\n$m$ \u8868\u793a $x$ \u5230\u4e2d\u70b9\uff08\u8fd9\u91cc\u5bf9\u4e8e\u5de6\u533a\u95f4\u7684 $x$\uff0c\u4e2d\u70b9\u8868\u793a $mid$\uff0c\u5426\u5219\u8868\u793a $mid+1$\uff09\u7684 $a$ \u7684\u6700\u5c0f\u503c\uff1b\n\n$s$ \u8868\u793a $x$ \u5230\u4e2d\u70b9\u7684\u6240\u6709\u70b9\u7684 $m$ \u4e4b\u548c\u3002\n\n$g$ \u8868\u793a\u4e00\u4e2a\u7aef\u70b9\u4e3a $x$ \u5230\u4e2d\u70b9\u7684\u6240\u6709\u70b9\uff0c\u53e6\u4e00\u4e2a\u7aef\u70b9\u4e3a\u533a\u95f4\u53e6\u4e00\u4fa7\u7684\u6240\u6709\u70b9\uff0c\u6240\u6709\u8fd9\u6837\u7684\u5b50\u6bb5\u7684\u6700\u5c0f\u503c\u4e4b\u548c\u3002\n\n$l,r,m,s$ \u53ef\u4ee5\u76f4\u63a5\u6c42\u51fa\u3002\n\n\u5de6\u533a\u95f4\u7684 $la$ \u548c\u53f3\u533a\u95f4\u7684 $ra$ \u76f4\u63a5\u7ee7\u627f\u4e0b\u4e00\u5c42\u3002\n\n$g$ \u53ef\u4ee5\u53cc\u6307\u9488\u6c42\u51fa\uff0c\u5177\u4f53\u505a\u6cd5\uff1a\u5047\u8bbe\u5f53\u524d\u5728\u6c42\u5de6\u533a\u95f4\u7684\u70b9 $x$ \u7684 $g$\uff0c\u5c06\u53f3\u533a\u95f4\u5206\u4e3a\u4e24\u6bb5\uff0c\u4e00\u6bb5\u5927\u4e8e $m_x$\uff0c\u53e6\u4e00\u6bb5\u5c0f\u4e8e\u7b49\u4e8e $m_x$\u3002\u4e24\u6bb5\u5206\u522b\u6c42\u7b54\u6848\u3002\u4e24\u6bb5\u7684\u5206\u754c\u70b9\u7528\u53cc\u6307\u9488\u7ef4\u62a4\u3002\n\n\u5de6\u533a\u95f4\u7684 $ra$ \u548c\u53f3\u533a\u95f4\u7684 $la$ \u7528 $g$ \u548c\u4e0b\u4e00\u5c42\u7684 $la,ra$ \u6c42\u51fa\u3002\n\n\u6709\u4e86\u8fd9\u4e9b\u4fe1\u606f\u5c31\u53ef\u4ee5 $O(1)$ \u56de\u7b54\u8be2\u95ee\u3002\n\n\u5177\u4f53\u5b9e\u73b0\u89c1\u4ee3\u7801\u3002\n\n\u5b9a\u4f4d\u8be2\u95ee\u533a\u95f4\u7684\u90e8\u5206\u548c immortalCO \u7684\u535a\u5ba2\u7565\u6709\u4e0d\u540c\uff08\u6ca1\u6709\u8865\u5168 $2^k$\uff0c\u4f46\u9700\u8981\u989d\u5916\u8bb0\u5f55\u53f6\u5b50\u7ed3\u70b9\u7f16\u53f7\uff09\uff0c\u5177\u4f53\u89c1[\u732b\u6811\u5b66\u4e60\u7b14\u8bb0](https://www.luogu.com.cn/blog/221955/mao-shu)\n\u3002\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nusing ll=long long;\nconst int N=1e5+3;\nint a[N],p[N],lg[N*4];\nstruct T{ll la,ra,s,g;int m,l,r;}s[19][N];\nvoid wk(int d,int k,int l,int r){//d\u662f\u5f53\u524d\u6df1\u5ea6\uff0ck\u662f\u533a\u95f4\u7f16\u53f7\n\tT*f=s[d],*g=s[d+1];\n\tint m=l+r>>1,i,t;\n\tfor(i=l;i<=r;++i)f[i].l=l,f[i].r=r;\n\tif(l==r)return f[l].la=f[l].ra=a[l],void(p[l]=k);//\u8bb0\u5f55\u53f6\u5b50\u7ed3\u70b9\u533a\u95f4\u7f16\u53f7\n\tll w=0,u=0;\n\twk(d+1,k*2,l,m),wk(d+1,k*2+1,m+1,r);\n\tfor(g[m].m=g[m].s=a[m],i=m-1;f[i+1].la=g[i+1].la,i>=l;--i)g[i].s=g[i+1].s+(g[i].m=min(g[i+1].m,a[i]));\n\tfor(g[m+1].m=g[m+1].s=a[m+1],i=m+2;f[i-1].ra=g[i-1].ra,i<=r;++i)g[i].s=g[i-1].s+(g[i].m=min(g[i-1].m,a[i]));\n\tfor(i=r,t=m+1;i>m;--i)w+=g[i].m;\n\tfor(;i>=l;--i){//\u53cc\u6307\u9488\u90e8\u5206\n\t\twhile(t<=r&&a[i]<a[t])w-=g[t++].m;\n\t\tu=g[i].g=u+w+g[i].m*1ll*(t-m-1),f[i].ra=g[i].ra+g[r].la+u;\n\t}\n\tfor(i=l,t=m,u=w=0;i<=m;++i)w+=g[i].m;\n\tfor(;i<=r;++i){\n\t\twhile(t>=l&&a[i]<a[t])w-=g[t--].m;\n\t\tu=g[i].g=u+w+g[i].m*1ll*(m-t),f[i].la=g[i].la+g[l].ra+u;\n\t}\n}\nusing ull=unsigned long long;\null S,A,B,C,l;\null rd(){return S^=(A+B*l)%C;}\nint main(){\n\tint n,q,o,i,j,x,y;\n\tull w=0;\n\tT*g;\n\tfor(i=1;i<N*4;++i)lg[i]=lg[i>>1]+1;//\u9884\u5904\u7406lg\u8868\u793alog2(x)+1\u4e0b\u53d6\u6574\n\tfor(i=1,scanf(\"%d%d%d\",&n,&q,&o);i<=n;++i)scanf(\"%d\",a+i);\n\tif(o)cin>>S>>A>>B>>C;\n\tfor(wk(0,1,1,n);q--;){\n\t\tif(o){\n\t\t\tx=rd()%n+1,y=rd()%n+1;\n\t\t\tif(x>y)swap(x,y);\n\t\t}else scanf(\"%d%d\",&x,&y);\n\t\tif(x==y)w^=(l=(ull)a[x]);else{\n\t\t\tif(i=p[x],j=p[y],i<j)swap(i,j);\n\t\t\ti>>=lg[i]-lg[j],i=lg[i>>lg[i^j]],g=s[i];\n\t\t\tw^=(l=g[x].ra+g[y].la+(g[x].m<g[y].m?g[y].g-(y-g[x].r)*(g[g[x].l].s-g[x].s):g[x].g-(g[y].l-x)*(g[g[y].r].s-g[y].s)));\n\t\t}\n\t}\n\tcout<<w;\n\treturn 0;\n}\n```\n",
        "postTime": 1619353932,
        "uid": 221955,
        "name": "panyf",
        "ccfLevel": 10,
        "title": "P6604 [HNOI2016]\u5e8f\u5217 \u52a0\u5f3a\u7248\uff08\u732b\u6811\uff09"
    }
]