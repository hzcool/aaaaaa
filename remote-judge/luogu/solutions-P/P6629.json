[
    {
        "content": "\u9996\u5148\uff0c\u6839\u636eruns\u7684\u90a3\u5957\u7406\u8bba\uff0c\u4f4d\u7f6e\u4e0d\u540c\u7684\u672c\u539f\u5e73\u65b9\u4e32\uff08\u5373\u6700\u5c0f\u6574\u5468\u671f\u6070\u4e3a $len \\over 2$ \u7684\u4e32\uff09\u662f $O(n \\log n)$ \u7684\uff0c\u663e\u7136\u6240\u6709\u5e73\u65b9\u4e32\u90fd\u662f\u7531\u67d0\u4e00\u4e2a\u672c\u539f\u5e73\u65b9\u4e32\u590d\u5236\u82e5\u5e72\u904d\u5f97\u5230\u7684\uff0c\u7136\u540e\u6211\u4eec\u5148\u7528\u4f20\u7edf\u7684\u679a\u4e3e\u5468\u671fSA/\u4e8c\u5206hash\u7684\u65b9\u6cd5\u6c42\u51fa\u82e5\u5e72\u7684\u5468\u671f\u4e09\u5143\u7ec4 $(x,l,r)$ \uff0c\u4ee3\u8868\u5728\u533a\u95f4 $[l,r]$ \u4e2d\u4efb\u610f\u4e00\u4e2a\u957f\u4e3a $x$ \u7684\u500d\u6570\u7684\u5b50\u4e32\u6574\u5468\u671f\u5747\u4e3a $x$ \uff0c\u7136\u540e\u5982\u679c\u4e32 $[l,l+2x-1]$ \u662f\u5faa\u73af\u4e32\uff0c\u5219 $x$ \u4e0d\u4e3a\u6700\u5c0f\u6574\u5468\u671f\uff0c\u90a3\u4e48\u8fd9\u4e2a\u5468\u671f\u4e09\u5143\u7ec4\u53ef\u4ee5\u76f4\u63a5\u53bb\u6389\u3002\n\n\u7136\u540e\u6211\u4eec\u8003\u8651\u8fd9\u4e00\u4e2a\u5468\u671f\u4e09\u5143\u7ec4\u7684\u8d21\u732e\uff0c\u6211\u4eec\u8bb0\u8d21\u732e\u7ec4 $(x,y,v)$ \u8868\u793a\u5b83\u5bf9\u6ee1\u8db3 $[x,y] \\in [l',r']$ \u7684\u8be2\u95ee\u533a\u95f4 $[l',r']$ \u6709 $v$ \u7684\u8d21\u732e\u3002\u90a3\u4e48\u5bf9\u4e8e\u4e00\u4e2a\u5468\u671f\u4e09\u5143\u7ec4 $(x,l,r)$ \uff0c\u957f\u5ea6\u4e3a $2x$ \u7684\u5e73\u65b9\u4e32\u8d21\u732e\u5c31\u4e3a $(a,a+2x-1,1) , a \\in [l,r-2x+1]$ \u548c $(a,a+3x-1,-1) , a \\in [l,r-3x+1]$ \uff0c\u540c\u7406\uff0c\u957f\u5ea6\u4e3a $2kx$ \u7684\u5e73\u65b9\u4e32\u8d21\u732e\u4e3a $(a,a+2kx-1,1) , a \\in [l,r-2kx+1]$ \u548c $(a,a+(2k+1)x-1,-1) , a \\in [l,r-(2k+1)x+1]$ \uff0c\u6839\u636eruns\u90a3\u5957\u7406\u8bba\uff0c\u8fd9\u663e\u7136\u662f\u4e0d\u8d85\u8fc7 $O(n \\log n)$ \u7684\u3002\n\n\u8fd8\u6709\u4e00\u79cd\u60c5\u51b5\u5c31\u662f\u4e0d\u540c\u5468\u671f\u4e09\u5143\u7ec4\u4e4b\u95f4\u53ef\u80fd\u4ea7\u751f\u76f8\u540c\u7684\u5e73\u65b9\u4e32\uff0c\u8fd9\u79cd\u60c5\u51b5\u7684\u5904\u7406\u662f\u5bb9\u6613\u7684\uff1a\u9996\u5148\u4f60\u4ece\u524d\u5230\u540e\u8003\u8651\u6bcf\u4e2a\u5468\u671f\u4e09\u5143\u7ec4\uff0c\u7136\u540e\u5bf9\u6bcf\u4e2a\u5468\u671f\u4e09\u5143\u7ec4\u627e\u51fa\u5b83\u5305\u542b\u7684\u6240\u6709\u957f\u5ea6\u4e3a $2x$ \u500d\u6570\u7684\u5e73\u65b9\u4e32\uff08\u8fd9\u548c\u4f4d\u7f6e\u4e0d\u540c\u7684\u672c\u539f\u5e73\u65b9\u4e32\u6570\u91cf\u76f8\u7b49\uff09\uff0c\u7136\u540e\u627e\u51fa\u5b83\u5728\u8fd9\u4e4b\u524d\u6700\u540e\u51fa\u73b0\u5728\u54ea\u91cc\uff08\u5728\u5904\u7406\u524d\u9762\u7684\u65f6\u5019\u8bb0\u4e00\u4e0b\u5373\u53ef\uff09\u8fd8\u6709\u5728\u8fd9\u4e2a\u5468\u671f\u4e09\u5143\u7ec4\u7b2c\u4e00\u6b21\u51fa\u73b0\u5728\u54ea\u91cc\uff0c\u7136\u540e\u628a\u91cd\u590d\u7684\u8d21\u732e\u51cf\u6389\u5373\u53ef\u3002\n\n\u7136\u540e\u5bf9\u6bcf\u4e2a\u8be2\u95ee\u8ba1\u7b97\u8d21\u732e\u5c31\u662f\u4e00\u4e2a\u659c\u7ebf\u52a0\u77e9\u5f62\u6c42\u548c\u7684\u4e8c\u7ef4\u6570\u70b9\uff0c\u5bb9\u6613\u5b9e\u73b0\u3002\n\n\u590d\u6742\u5ea6 $O(n \\log^2 n)$ \u3002\n\n#### \u4ee3\u7801\uff08\u4e8c\u5206hash\u7248\u672c\uff09\n```cpp\n#include<bits/stdc++.h>\n#define re register\n#define ull unsigned long long\nchar ss[200100];\nconst ull base=61,inv=5745707170499696405llu;\null hs[200100],ex[200100],rex[200100];\nint n;\ninline ull get(re int l,re int r)\n{\n\treturn hs[r]-hs[l-1]*ex[r-l+1];\n}\ninline bool equ(re int a,re int b,re int len)\n{\n\treturn get(a,a+len-1)==get(b,b+len-1);\n}\nint LCP(re int a,re int b)\n{\n\tre int l=0,r=std::min(n-a+1,n-b+1);\n\tfor(re int mid=(l+r+1)/2;l<r;mid=(l+r+1)/2)\n\t{\n\t\tif(equ(a,b,mid))l=mid;\n\t\telse r=mid-1;\n\t}\n\treturn l;\n}\nint LCS(re int a,re int b)\n{\n\tre int l=0,r=std::min(a,b);\n\tfor(re int mid=(l+r+1)/2;l<r;mid=(l+r+1)/2)\n\t{\n\t\tif(equ(a-mid+1,b-mid+1,mid))l=mid;\n\t\telse r=mid-1;\n\t}\n\treturn l;\n}\nstd::vector<std::pair<int,int> >vc[200100],mc[200100];\nstd::vector<int>qry[400100];\nint cnt,l[200100],r[200100],f[200100];\nlong long ans[200100];\nstd::unordered_map<ull,int>mp;\nvoid add(re int x,re int ad)\n{\n\tfor(;x;x-=x&-x)f[x]+=ad;\n}\nstruct par\n{\n\tint x,y,v;\n}pc1[10001000],pc2[10001000];\ninline bool cmp(const par&A,const par&B){return A.x<B.x;}\nint cct1,cct2; \nint qr(re int x)\n{\n\tre int ans=0;\n\tfor(;x<=n;x+=x&-x)ans+=f[x];\n\treturn ans;\n}\nint ans1;\nvoid adp(re int x1,re int x2,re int y1,re int y2,re int v)\n{\n\tpc1[++cct1]={y1-x1,x1,v};\n\tpc1[++cct1]={y1-x1,x2+1,-v};\n\tpc2[++cct2]={y1-x1,y1,v};\n\tpc2[++cct2]={y1-x1,y2+1,-v};\n}\nint f1[200100],f2[200100];\nvoid add1(re int a,re int ad)\n{\n\tre int ad1=ad*a;\n\tfor(;a<=n;a+=(a&-a))f1[a]+=ad,f2[a]+=ad1;//printf(\"**ad**%d\\n\",n);\n}\nlong long sum(re int a)\n{\n\tre int ans=0;\n\tre int a1=a;\n\tfor(;a;a-=(a&-a))ans+=(a1+1)*f1[a]-f2[a];\n\treturn ans;\n}\nint main()\n{\n\tre int q,x,y;\n\tscanf(\"%d%d\",&n,&q);\n\tscanf(\"%s\",ss+1);\n\tex[0]=rex[0]=1;\n\tfor(re int i=1;i<=n;i++)hs[i]=hs[i-1]*base+(ss[i]-'a'+1),ex[i]=ex[i-1]*base,rex[i]=rex[i-1]*inv;\n\tfor(re int i=1;i<=n;i++)\n\t{\n\t\tfor(re int j=i;j+i<=n;j+=i)\n\t\t{\n\t\t\tre int ls=LCS(j,j+i),lp=LCP(j+1,j+i+1);\n\t\t\tif(ls==0||ls>i||ls+lp<i)continue;\n\t\t\tre int bg=j-ls+1,ed=j+i+lp;\n\t\t\tfor(auto x:vc[bg])if((!(i%x.first))&&x.second>=i){ls=0;break;}\n\t\t\tif(ls==0)continue;\n\t\t\tfor(re int i1=bg;i1+2*i-1<=ed;i1++)\n\t\t\t{\n\t\t\t\tvc[i1].push_back(std::make_pair(i,ed-i1+1));\n\t\t\t\tre ull nw=get(i1,i1+2*i-1);\n\t\t\t\tre int nv;\n\t\t\t\tif(!mp[nw])mp[nw]=++cnt;\n\t\t\t\tnv=mp[nw];\n\t\t\t\tre int len=(i1-bg)/i;\n\t\t\t\tif(!(len&1))\n\t\t\t\t{\n\t\t\t\t\tlen=len/2;\n\t\t\t\t\tif(mc[nv].size()>len)\n\t\t\t\t\t{\n\t\t\t\t\t\tadp(mc[nv][len].first,mc[nv][len].first,i1+2*i-1,i1+2*i-1,-1);\n\t\t\t\t\t\tmc[nv][len]=std::make_pair(i1,i1+2*i-1);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tfor(re int i1=ed-2*i+1;i1>=bg;i1--)\n\t\t\t{\n\t\t\t\tre ull nw=get(i1,i1+2*i-1);\n\t\t\t\tre int nv;\n\t\t\t\tif(!mp[nw])mp[nw]=++cnt;\n\t\t\t\tnv=mp[nw];\n\t\t\t\tre int len=(ed-2*i+1-i1)/i;\n\t\t\t\tif(!(len&1))\n\t\t\t\t{\n\t\t\t\t\tlen=len/2;\n\t\t\t\t\tif(mc[nv].size()>len)\n\t\t\t\t\t{\n\t\t\t\t\t\tmc[nv][len]=std::make_pair(i1,i1+2*i-1);\n\t\t\t\t\t}\n\t\t\t\t\telse mc[nv].push_back(std::make_pair(i1,i1+2*i-1));\n\t\t\t\t}\n\t\t\t}\n\t\t\tfor(re int i1=0,vv=1;bg+i1+2*i-1<=ed;i1+=i,vv=-vv)\n\t\t\t{\n\t\t\t\tadp(bg,ed-i1-2*i+1,bg+i1+2*i-1,ed,vv);\n\t\t\t}\n\t\t}\n\t}\n\tfor(re int i=1;i<=q;i++)\n\t{\n\t\tscanf(\"%d%d\",&l[i],&r[i]);\n\t\tqry[r[i]-l[i]].push_back(i);\n\t}\n\tstd::sort(pc1+1,pc1+cct1+1,cmp);\n\tstd::sort(pc2+1,pc2+cct2+1,cmp);\n\tre int ta=1;\n\tfor(re int i=0;i<=200000;i++)\n\t{\n\t\twhile(ta<=cct1&&pc1[ta].x==i)\n\t\t{\n\t\t//\tprintf(\"**a**%d %d %d\\n\",i,pc1[ta].y,pc1[ta].v);\n\t\t\tadd1(pc1[ta].y,pc1[ta].v);\n\t\t\tta++;\n\t\t}\n\t\tfor(auto x:qry[i])\n\t\t{\n\t\t\tans[x]-=sum(l[x]-1);\n\t\t}\n\t}\n\tta=1;\n\tmemset(f1,0,sizeof(f1));\n\tmemset(f2,0,sizeof(f2));\n\tfor(re int i=0;i<=200000;i++)\n\t{\n\t\twhile(ta<=cct2&&pc2[ta].x==i)\n\t\t{\n\t\t\tadd1(pc2[ta].y,pc2[ta].v);\n\t\t\tta++;\n\t\t}\n\t\tfor(auto x:qry[i])\n\t\t{\n\t\t\tans[x]+=sum(r[x]);\n\t\t}\n\t}\n\tfor(re int i=1;i<=q;i++)printf(\"%lld\\n\",ans[i]);\n}\n```\n",
        "postTime": 1593764039,
        "uid": 22751,
        "name": "Lagoon",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P6629 \u3010[ZJOI2020] \u5b57\u7b26\u4e32\u3011"
    },
    {
        "content": "**\u9898\u610f** \uff1a \u82e5\u5b58\u5728\u5b57\u7b26\u4e32 $t$ \u4f7f\u5f97 $s=tt$ \uff0c\u5219\u79f0 $s$ \u662f\u4f18\u7f8e\u7684\u3002\n\n\u7ed9\u51fa\u5b57\u7b26\u4e32 $s$ \uff0c$q$ \u6b21\u8be2\u95ee\u4e00\u4e2a\u5b50\u4e32 $s[l,r]$ \u7684**\u672c\u8d28\u4e0d\u540c**\u7684\u4f18\u7f8e\u5b50\u4e32\u4e2a\u6570\u3002\n\n$n,q\\leq 2\\times 10^5,\\ \\Sigma=\\{\\texttt{a},\\texttt{b}\\}$ \uff0c\u65f6\u9650 $\\texttt{3s}$\u3002\n\n------------\n\n\u914d\u5408 [Blog : Lyndon & Runs](https://www.luogu.com.cn/blogAdmin/article/new) \u98df\u7528\u3002\n\n- **\u5b9a\u7406** \uff1a\u4f4d\u7f6e\u4e0d\u540c\u7684\u672c\u539f\u5e73\u65b9\u4e32\u5171 $O(n\\log n)$ \u4e2a\u3002\n\n- **\u5b9a\u7406** \uff1a \u5bf9\u4e8e\u4e00\u4e2a ${\\rm run}\\ {\\bf r}=(l,r,p)$ \uff0c\u5bf9\u4e8e\u6240\u6709 $l\\leq i\\leq r-2p+1$ \uff0c$[i,i+2p-1]$ \u90fd\u662f\u4e00\u4e2a\u672c\u539f\u5e73\u65b9\u4e32\u3002\n\n\u6c42\u89e3 $\\rm Runs$ \u548c\u6240\u6709\u672c\u539f\u5e73\u65b9\u4e32\u7684\u7b97\u6cd5\u5728\u4e0a\u65b9\u535a\u6587\u4e2d\u6709\u4ecb\u7ecd\uff0c\u4e0d\u518d\u8d58\u8ff0\u3002\n\n\u6211\u4eec\u9009\u51fa $s$ \u7684\u6240\u6709**\u4f4d\u7f6e\u4e0d\u540c**\u7684\u5e73\u65b9\u4e32\u96c6\u5408 $Sq_0$ \uff0c\u672c\u8d28\u76f8\u540c\u7684\u4e32\u53ef\u80fd\u91cd\u590d\u51fa\u73b0\u3002\n\n\u4ee4 $c[l,r]=\\big[s[l,r]\\in Sq_0\\big]$\u3002\n\n\u82e5\u8be2\u95ee $s[L,R]$ \uff0c\u76f8\u5f53\u4e8e\u5bf9\u77e9\u5f62\u533a\u57df $\\begin{cases}L\\leq l\\\\r\\leq R\\end{cases}$ \u6c42\u548c\u3002\n\n\u63a5\u4e0b\u6765\u6d88\u53bb\u91cd\u590d\u8d21\u732e\uff0c\u5bf9\u4e8e\u672c\u8d28\u76f8\u540c\u7684\u5e73\u65b9\u4e32 $s[l_1,r_1],s[l_2,r_2],...,s[l_m,r_m]\\ (l_1<l_2<...<l_m)$ \uff0c\u4ee4 $c[l_1,r_2],c[l_2,r_3],...,c[l_{m-1},r_m]$ \u51cf\u53bb $1$\u3002\n\n\u5982\u56fe\uff0c\u7ea2\u8272\u70b9\u4ee3\u8868\u672c\u8d28\u76f8\u540c\u7684\u5e73\u65b9\u4e32\uff0c\u7070\u8272\u90e8\u5206\u662f\u8be2\u95ee\u533a\u57df\uff0c\u84dd\u8272\u70b9\u662f\u4fee\u6b63\u3002\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/enqiw7jo.png)\n\n\u4e0d\u96be\u53d1\u73b0\uff0c\u82e5\u6709 $n$ \u4e2a\u7ea2\u8272\u70b9\u5728\u8be2\u95ee\u533a\u57df\u5185\uff0c\u5219\u5fc5\u6709 $n-1$ \u4e2a\u84dd\u8272\u70b9\u4e5f\u5728\u8be2\u95ee\u533a\u57df\u5185\uff0c\u6240\u4ee5\u4e00\u4e2a\u672c\u8d28\u76f8\u540c\u7684\u5e73\u65b9\u4e32\u8d21\u732e\u603b\u662f $1$\u3002\n\n\u5148\u6765\u8003\u8651\u5982\u4f55\u7b80\u5355\u5730\u523b\u753b $Sq_0$\u3002\n\n\u67d0\u4e2a\u666e\u901a\u5e73\u65b9\u4e32\u4e00\u5b9a\u80fd\u8868\u793a\u6210\u4e00\u4e2a\u672c\u539f\u5e73\u65b9\u4e32\u91cd\u590d\u82e5\u5e72\u6b21\u7684\u5f62\u5f0f\u3002\n\n\u5177\u4f53\u5730\uff0c\u5bf9\u4e8e ${\\rm run}\\ {\\bf r}=(l,r,p)$ \uff0c\u679a\u4e3e $len=2kp,k\\in N^+,l\\leq i\\leq r-len+1$ \uff0c\u5219 $s[i,i+len-1]$ \u662f\u4e00\u4e2a\u666e\u901a\u5e73\u65b9\u4e32\u3002\n\n\u7531\u4e8e\u5468\u671f\u540c\u4e3a $p$ \u7684\u4e0d\u540c ${\\rm run}$ \u4ea4\u4e0d\u4f1a\u8fbe\u5230 $p$ \uff0c\u4e0a\u8ff0\u679a\u4e3e\u5728 $Sq_0$ \u4e2d\u6ca1\u6709\u91cd\u590d\u3002\n\n\u4e0d\u96be\u53d1\u73b0\uff0c$len$ \u76f8\u540c\u7684\u4e00\u7ec4\u666e\u901a\u5e73\u65b9\u4e32\u5728 $c$ \u4e2d\u662f\u6761\u659c\u7ebf\u3002\u4e3a $(l,l+len-1),(r-len+1,r)$\u3002\n\n\u63a5\u4e0b\u6765\u8003\u8651\u6263\u9664\u7684\u8d21\u732e\u3002\n\n\u540c\u4e2a $\\rm run$ \u4ea7\u751f\u7684\u4e24\u4e2a\u666e\u901a\u5e73\u65b9\u4e32\u76f8\u540c\u7684\u5145\u8981\u6761\u4ef6\u662f \uff1a $len$ \u76f8\u540c\uff0c\u4e14 $s[i,i+len-1],s[j,j+len-1]$ \u4e2d $p|i-j$\u3002\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/fsibwdpr.png)\n\n\u5982\u56fe\uff0c\u7ea2\u70b9\u662f\u4e00\u7ec4 $len$ \u76f8\u540c\u7684\u666e\u901a\u5e73\u65b9\u4e32\uff0c\u84dd\u70b9\u5219\u662f\u95f4\u9694\u4e3a $p$ \uff08 \u56fe\u4e2d $p=3$ \uff09\u7684\u4e24\u4e2a\u666e\u901a\u5e73\u65b9\u4e32\u4ea7\u751f\u7684\u91cd\u590d\u62b5\u6d88\u8d21\u732e\u3002\n\n\u4e0d\u96be\u53d1\u73b0\u8fd9\u4e5f\u662f\u4e00\u6761\u659c\u7ebf\uff0c\u4e14\u4e3a $(l,l+len+p-1),(r-len-p+1,r)$\u3002\n\n\u53ef\u80fd\u7684 $len$ \u7684\u6570\u76ee\u663e\u7136\u4e0d\u8d85\u8fc7\u6307\u6570 $e_{\\bf r}=\\dfrac{r-l+1}{p}$ \uff0c\u6839\u636e $\\text{The Runs Theorem}$ \uff0c\u8fd9\u90e8\u5206\u4ea7\u751f\u7684\u659c\u7ebf\u603b\u6570\u4e3a $O(n)$\u3002\n\n\u63a5\u4e0b\u6765\u8ba1\u7b97\u4e0d\u540c\u7684 $\\rm run$ \u4e4b\u95f4\u4ea7\u751f\u7684\u91cd\u590d\u3002\n\n\u7528\u54c8\u5e0c\u8868\u8bb0\u4e0b\u76ee\u524d\u679a\u4e3e\u51fa\u7684\u6240\u6709\u672c\u8d28\u4e0d\u540c\u7684\u5e73\u65b9\u4e32\u3002\u5177\u4f53\u5730\uff0c\u5bf9\u4e8e ${\\rm run}\\ {\\bf r}=(l,r,p)$ \uff0c\u679a\u4e3e $l\\leq i<l+p,len=2kp,k\\in N^+,i+len-1\\leq r)$ \uff0c\u5219 $s[i,i+len-1]$ \u662f\u4e00\u4e2a\u5728\u8be5 $\\rm run$ \u5185\u67d0\u7c7b\u672c\u8d28\u4e0d\u540c\u7684\u666e\u901a\u5e73\u65b9\u4e32\u7684\u6700\u9760\u5de6\u7684\u51fa\u73b0\u3002\n\n\u4e0d\u96be\u53d1\u73b0\u8fd9\u6837\u7684\u679a\u4e3e\u91cf\u4e0d\u8d85\u8fc7\u672c\u539f\u5e73\u65b9\u4e32\u7684\u603b\u4e2a\u6570 $r-l+2-2p$ \uff0c\u800c\u540e\u8005\u7684\u603b\u548c\u6839\u636e\u76f8\u5173\u7406\u8bba\u662f $O(n\\log n)$ \u7684\u3002\n\n\u6309\u7167 $l$ \u9012\u589e\u7684\u987a\u5e8f\u8003\u8651 $\\rm Runs$ \uff0c\u5f53\u679a\u4e3e\u5230\u67d0\u4e2a\u4e32\u53d1\u73b0 $\\rm Hash$ \u8868\u4e2d\u5df2\u7ecf\u6709\u4e86\uff0c\u5219\u5728\u4e0a\u4e00\u4e2a\u4e32\u7684\u6700\u53f3\u51fa\u73b0\u548c\u8fd9\u4e00\u4e2a\u4e32\u7684\u6700\u5de6\u51fa\u73b0\u4e4b\u95f4\u5efa\u7acb\u62b5\u6d88\u8d21\u732e\u70b9\uff08\u6df1\u84dd\u8272\uff09\uff0c\u5982\u56fe \uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/hvl5n18c.png)\n\n\u8fd9\u6700\u591a\u4ea7\u751f $O(n\\log n)$ \u4e2a\u989d\u5916\u7684\u70b9\u3002\n\n\u73b0\u5728\u6211\u4eec\u628a\u95ee\u9898\u8f6c\u5316\u6210\u4e86 : \u7ef4\u62a4\u4e00\u4e2a $n\\times n$ \u7684\u77e9\u9635 $c$ \uff0c\u652f\u6301\u659c\u7ebf\u52a0\u51cf\uff0c\u5355\u70b9\u52a0\u51cf\uff0c\u6700\u540e\u5b50\u77e9\u9635\u67e5\u8be2\u3002\n\n\u5355\u70b9\u7684\u4e8c\u7ef4\u504f\u5e8f\u662f\u7b80\u5355\u7684\uff0c\u4e0b\u9762\u6765\u770b\u659c\u7ebf\u7684\u4e8c\u7ef4\u504f\u5e8f\u3002\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/fgx0939j.png)\n\n\u628a\u659c\u7ebf\u6bb5\u62c6\u6210\u4e24\u6761\u659c\u5c04\u7ebf\u7684\u5dee\u3002\u6211\u4eec\u53ef\u4ee5\u65ad\u8a00\uff0c\u4e00\u6761\u659c\u5c04\u7ebf\u5fc5\u7136\u7a7f\u8fc7\u9650\u5236\u77e9\u5f62\u7684\u53f3\u4fa7(\u84dd\u8272)\u6216\u8005\u4e0a\u4fa7(\u7eff\u8272)\uff0c\u5982\u56fe\u3002\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/pasql4n5.png)\n\n\u5bf9\u4e8e\u7a7f\u8fc7\u53f3\u4fa7\u7684\u659c\u5c04\u7ebf\uff0c\u5176\u5728\u77e9\u5f62\u5185\u7684\u957f\u5ea6\u4e3a\u8d77\u59cb\u70b9 $x$ \u5750\u6807\u4e0e\u53f3\u8fb9\u754c $x$ \u5750\u6807\u7684\u5dee\u3002\n\n\u5bf9\u4e8e\u7a7f\u8fc7\u4e0a\u8fb9\u754c\u7684\uff0c\u5219\u548c $y$ \u5750\u6807\u6709\u5173\u3002\u8003\u8651\u5206\u522b\u7edf\u8ba1\u3002\n\n\u82e5\u77e9\u5f62\u53f3\u4e0a\u89d2\u4e3a $(x_L,y_L)$ \u76f4\u7ebf $y=x+b$ \u4e0e $x=x_L$ \u7684\u4ea4\u70b9\u4f1a\u662f $x_L+b$\u3002\n\n\u82e5 $x_L+b\\leq y_L\\Leftrightarrow b\\leq y_l-x_l$ \u5219\u4e0e\u53f3\u4fa7\u76f8\u4ea4\u3002\u533a\u95f4\u6c42\u548c\u5373\u53ef\u3002\u9700\u8981\u7ef4\u62a4 $x,$ \u5750\u6807\u548c\u4ee5\u53ca\u8d77\u59cb\u70b9\u4e2a\u6570\u3002\n\n\u5bf9\u4e8e\u4e0e\u4e0a\u4fa7\u76f8\u4ea4\u7684\u60c5\u51b5\uff0c\u7ffb\u8f6c\u5750\u6807\u7cfb\u5904\u7406\u5373\u53ef\u3002\n\n\u603b\u590d\u6742\u5ea6 $O(n\\log^2n)$\u3002\n\n```cpp\n#include<algorithm>\n#include<cstring>\n#include<cstdio>\n#include<map>\n#define Pr pair<int,int>\n#define mp make_pair\n#define MaxN 205000\n#define ll long long\nusing namespace std;\nstruct StrHash{\n  ll p[MaxN],h[MaxN];int mod,buf;\n  StrHash (int _buf,int _mod){buf=_buf;mod=_mod;}\n  void Init(char *s,int n)\n  {\n    p[0]=1;\n    for (int i=1;i<=n;i++){\n      p[i]=p[i-1]*buf%mod;\n      h[i]=(h[i-1]*buf+s[i]-'a'+1)%mod;\n    }\n  }\n  bool tl(int u,int v,int len)\n  {return (h[u]-h[v]+(h[v-len]-h[u-len])*p[len])%mod==0;}\n  bool tr(int u,int v,int len)\n  {return (h[u+len-1]-h[v+len-1]+(h[v-1]-h[u-1])*p[len])%mod==0;}\n  int get(int l,int r)\n  {return (h[r]+(mod-h[l-1])*p[r-l+1])%mod;}\n}h1(10,1000000007),h2(10,1000000009);\nint n;char s[MaxN];\nint extl(int u,int v)\n{\n  if (s[u]!=s[v])return 0;\n  int l=1,r=min(u,v),mid;\n  while(l<r){\n    mid=(l+r+1)>>1;\n    if (h1.tl(u,v,mid)&&h2.tl(u,v,mid))l=mid;\n    else r=mid-1;\n  }return l;\n}\nint extr(int u,int v)\n{\n  if (s[u]!=s[v])return 0;\n  int l=1,r=n-max(u,v)+1,mid;\n  while(l<r){\n    mid=(l+r+1)>>1;\n    if (h1.tr(u,v,mid)&&h2.tr(u,v,mid))l=mid;\n    else r=mid-1;\n  }return l;\n}\nstruct Runs{int l,r,p;}b[MaxN*20];\nbool cmpR(const Runs &A, const Runs &B)\n{return A.l==B.l ? (A.r==B.r  ? A.p<B.p : A.r<B.r) : A.l<B.l;}\nint tot;\nint chk(int u,int v)\n{\n  int tl=extl(u,v),tr=extr(u,v);\n  if (tl+tr>=v-u+1){\n    b[++tot]=(Runs){u-tl+1,v+tr-1,v-u};\n    return v+tr-1;\n  }return 0;\n}\nvoid getRuns()\n{\n  for (int p=1;p<=n;p++)\n    for (int k=p,mx=0;k+p<=n;k+=p)\n      if (mx<k)\n        mx=max(mx,chk(k,k+p)-p);\n  sort(b+1,b+tot+1,cmpR);\n  int m=0;\n  for (int i=1;i<=tot;i++)\n    if (b[i].l!=b[i-1].l||b[i].r!=b[i-1].r)\n      b[++m]=b[i];\n  tot=m;\n}\nint ans[MaxN];\nstruct Qry{int l,r,p;}q[MaxN];\nstruct Point{int x,y,c;}g[MaxN*20];\nint tn,m;\n#define lbit(x) ((x)&-(x))\nstruct SumDS\n{\n  ll t[MaxN<<1],sum;\n  void clr(){memset(t,0,sizeof(ll)*(n+n+1));sum=0;}\n  void add(int p,int c){\n    p+=n;sum+=c;\n    while(p<=n+n){t[p]+=c;p+=lbit(p);}\n  }\n  ll qry(int p){\n    ll ret=0;p+=n;\n    while(p){ret+=t[p];p^=lbit(p);}\n    return ret;\n  }\n}T,Tx;\nbool cmpQl(const Qry &A,const Qry &B){return A.l<B.l;}\nbool cmpQr(const Qry &A,const Qry &B){return A.r<B.r;}\nbool cmpP(const Point &A,const Point &B){return A.x<B.x;}\nvoid calc0()\n{\n  sort(q+1,q+m+1,cmpQl);\n  sort(g+1,g+tn+1,cmpP);\n  static int o[MaxN];\n  for (int i=1;i<=tn;i++)o[g[i].y]+=g[i].c;\n  for (int i=1;i<=n;i++)o[i]+=o[i-1];\n  for (int i=1,j=1;i<=m;i++){\n    for (;g[j].x<=q[i].l&&j<=tn;j++)T.add(g[j].y,g[j].c);\n    ans[q[i].p]+=o[q[i].r]-T.qry(q[i].r);\n  }\n}\nvoid calc1()\n{\n  sort(g+1,g+tn+1,cmpP);\n  T.clr();\n  for (int i=1,j=1;i<=m;i++){\n    for (;g[j].x<=q[i].l&&j<=tn;j++){\n      T.add(g[j].y-g[j].x,g[j].c);\n      Tx.add(g[j].y-g[j].x,g[j].c*g[j].x);\n    }ll cnt=T.qry(q[i].r-1-q[i].l),sx=Tx.qry(q[i].r-1-q[i].l);\n    ans[q[i].p]-=cnt*(q[i].l+1)-sx;\n  }\n  for (int i=1;i<=tn;i++)swap(g[i].x,g[i].y);\n  sort(g+1,g+tn+1,cmpP);\n  sort(q+1,q+m+1,cmpQr);\n  T.clr();Tx.clr();\n  for (int i=1,j=1;i<=m;i++){\n    for (;g[j].x<=q[i].r&&j<=tn;j++){\n      T.add(g[j].y-g[j].x,g[j].c);\n      Tx.add(g[j].y-g[j].x,g[j].c*g[j].x);\n    }ll cnt=T.sum-T.qry(q[i].l-q[i].r),sx=Tx.sum-Tx.qry(q[i].l-q[i].r);\n    ans[q[i].p]+=cnt*(q[i].r+1)-sx;\n  }\n}\nmap<Pr,int> ss;\nint main()\n{\n  scanf(\"%d%d%s\",&n,&m,s+1);n=strlen(s+1);\n  h1.Init(s,n);h2.Init(s,n);\n  getRuns();\n  for (int i=1;i<=m;i++){\n    scanf(\"%d%d\",&q[i].l,&q[i].r);\n    q[i].l--;q[i].p=i;\n  }\n   for (int t=1;t<=tot;t++){\n    int l=b[t].l,r=b[t].r,p=b[t].p;\n    for (int len=2*p;len<=r-l+1;len+=2*p){\n      for (int i=l;i+len-1<=r&&i<l+p;i++){\n        int j=i+len-1;\n        Pr now=mp(h1.get(i,j),h2.get(i,j));\n        if (ss.count(now))\n          g[++tn]=(Point){ss[now],j,-1};\n        ss[now]=(r-(i-1)%p)/p*p+(i-1)%p-len+1;\n      }\n    }\n  }calc0();tn=0;\n  for (int t=1;t<=tot;t++){\n    int l=b[t].l,r=b[t].r,p=b[t].p;\n    for (int len=2*p;len<=r-l+1;len+=2*p){\n      g[++tn]=(Point){l,l+len-1,1};\n      g[++tn]=(Point){r-len+2,r+1,-1};\n      if (l<=r-len-p+1){\n        g[++tn]=(Point){l,l+len+p-1,-1};\n        g[++tn]=(Point){r-len-p+2,r+1,1};\n      }\n    }\n  }calc1();\n  for (int i=1;i<=m;i++)\n    printf(\"%d\\n\",ans[i]);\n  return 0;\n}\n```\n\n\n\n\n\n\n\n\n\n\n\n\n",
        "postTime": 1610967926,
        "uid": 58705,
        "name": "command_block",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P6629 \u3010[ZJOI2020] \u5b57\u7b26\u4e32\u3011"
    },
    {
        "content": "\u63d0\u4f9b\u4e00\u4e2a\u597d\u5199\u7684\u4e0d\u7528\u4e8c\u7ef4\u6570\u70b9\u7684\u505a\u6cd5.\n\n\u6765\u81ea[\u795ewzy\u7684blog](https://blog.csdn.net/WAautomaton/article/details/107186568).\n\n**\u5f15\u74061:** \u6bcf\u4e2a\u4f4d\u7f6e\u7ed3\u5c3e\u7684\u672c\u539f\u5e73\u65b9\u4e32\u4e2a\u6570\u662f $O(\\log n)$ \u7684.\n\n**\u5f15\u74062:** \u672c\u8d28\u4e0d\u540c\u7684\u672c\u539f\u5e73\u65b9\u4e32\u4e2a\u6570\u4e0d\u8d85\u8fc7 $2n$.\n\n\u8bc1\u660e\u5927\u6982\u662f\u6bcf\u4e2a\u4f4d\u7f6e\u4ea7\u751f\u7684\u65b0\u7684\u672c\u539f\u5e73\u65b9\u4e32\u4e2a\u6570\u4e0d\u8d85\u8fc7 $2$.\n\n\u8003\u8651\u8d21\u732e\u7684\u6765\u6e90.\n\n\u6211\u4eec\u628a\u5bf9\u5f53\u524d\u8be2\u95ee\u80fd\u4ea7\u751f\u8d21\u732e\u7684\u5e73\u65b9\u4e32\u5206\u6210\u4e24\u7c7b\n1. \u6765\u81ea\u4e8e\u4e0d\u7ecf\u8fc7\u5f53\u524d\u53f3\u7aef\u70b9\u7684run\n2. \u6765\u81ea\u4e8e\u7ecf\u8fc7\u5f53\u524d\u53f3\u7aef\u70b9\u7684run\n\n\u5bf9\u4e8e\u7b2c\u4e00\u7c7b\u8d21\u732e,\u6211\u4eec\u7ef4\u62a4\u4e00\u4e2a\u6811\u72b6\u6570\u7ec4,\u5728\u5de6\u7aef\u70b9\u5904\u8ba1\u7b97\u8d21\u732e,\u8be2\u95ee\u65f6\u6c42\u533a\u95f4\u548c\u5373\u53ef.\n\n\u5bf9\u4e8e\u7b2c\u4e8c\u7c7b\u8d21\u732e,\u6211\u4eec\u679a\u4e3e\u4ee5\u5f53\u524d\u53f3\u7aef\u70b9\u7ed3\u5c3e\u7684\u6240\u6709\u672c\u539f\u5e73\u65b9\u4e32,\u8ba1\u7b97\u5176\u8d21\u732e.\u8bbe\u6709\u6548\u957f\u5ea6\u4e3a $l$,\u679a\u4e3e\u5e73\u65b9\u4e32\u7684\u7ed3\u5c3e\u79bb\u53f3\u7aef\u70b9\u7684\u8ddd\u79bb,\u90a3\u4e48\u957f\u4e3a $2p$ \u7684\u672c\u539f\u5e73\u65b9\u4e32\u7684\u8d21\u732e\u4e3a $\\sum_{i=0}^{p-1}\\lfloor\\frac{l-i}{2p}\\rfloor$.\u8fd9\u4e2a\u4e1c\u897f\u53ef\u4ee5 $O(1)$\u8ba1\u7b97.\n\n\u95ee\u9898\u662f\u8981\u6c42\u7684\u662f**\u672c\u8d28\u4e0d\u540c**\u7684\u5e73\u65b9\u4e32,\u800c\u7b2c\u4e00,\u4e8c\u7c7b\u8d21\u732e\u4e2d\u53ef\u80fd\u6709\u672c\u8d28\u76f8\u540c\u7684\u5b57\u7b26\u4e32.\u8003\u8651\u4ece\u6811\u72b6\u6570\u7ec4\u4e2d\u5220\u53bb\u672c\u8d28\u76f8\u540c\u7684\u5e73\u65b9\u4e32,\u6211\u4eec\u679a\u4e3e\u4ee5\u5f53\u524d\u53f3\u7aef\u70b9\u7ed3\u5c3e\u7684\u6240\u6709\u672c\u539f\u5e73\u65b9\u4e32,\u4ece\u6811\u72b6\u6570\u7ec4\u4e2d\u5220\u53bb\u5176**\u6781\u957f**\u5e73\u65b9\u4e32\u7684\u8d21\u732e.\u4e0d\u7528\u5220\u53bb\u6240\u6709\u5e73\u65b9\u4e32\u662f\u56e0\u4e3a\u5176\u4ed6\u4e32\u5df2\u7ecf\u5728\u4e4b\u524d\u88ab\u5220\u53bb\u4e86,\u8fd9\u6837\u5c31\u80fd\u4fdd\u8bc1\u590d\u6742\u5ea6,\u800c\u4e14\u4e0d\u4f1a\u591a\u5220.\u6240\u4ee5\u8fd8\u8981\u987a\u4fbf\u7ef4\u62a4\u4e00\u4e2ahash table\u8bb0\u5f55\u6bcf\u4e2a\u5e73\u65b9\u4e32\u7684\u6700\u540e\u4e00\u6b21\u51fa\u73b0\u4f4d\u7f6e.\n\n\u6700\u540e\u8fd8\u8981\u52a0\u5165\u6240\u6709\u53f3\u7aef\u70b9\u4e3a\u5f53\u524d\u53f3\u7aef\u70b9\u7684**run**\u7684\u8d21\u732e.\u679a\u4e3e\u5176\u5e73\u65b9\u4e32\u957f\u5ea6,\u5728\u6700\u540e\u4e00\u6b21\u51fa\u73b0\u5904\u52a0\u5165\u8d21\u732e\u5373\u53ef.\u8fd9\u91cc\u7684\u590d\u6742\u5ea6\u53ef\u4ee5\u89c6\u4e3a\u5bf9\u6bcf\u4e2a\u7ed3\u5c3e\u679a\u4e3e\u672c\u539f\u5e73\u65b9\u4e32,\u590d\u6742\u5ea6\u4e5f\u662f\u6b63\u786e\u7684.\n\n\u6574\u4f53\u7684\u590d\u6742\u5ea6\u662f $O(n\\log^2 n)$\n\n\u540e $50\\%$ \u7684\u6570\u636e\u597d\u50cf\u80fd\u5361\u6240\u6709\u7684\u5355\u6a21hash,\u4e0d\u77e5\u9053\u662f\u600e\u4e48\u5b9e\u73b0\u7684.\n\n```cpp\ntemplate<long long p>\nstruct Hash\n{\n\tlong long h[1000005],mul[1000005];\n\tHash(){}\n\tHash(char * c)\n\t{\n\t\tint n=strlen(c+1);\n\t\tmul[0]=1;\n\t\tfor(int i=1;i<=n;i++)mul[i]=mul[i-1]*131%p;\n\t\th[0]=0;\n\t\tfor(int i=1;i<=n;i++)h[i]=(h[i-1]*131+c[i]-'a'+1)%p;\n\t}\n\tlong long ask(int l,int r){return (h[r]-h[l-1]*mul[r-l+1]%p+p)%p;}\n};\ntemplate<long long p1,long long p2>\nstruct HS\n{\n\tHash<p1>a;\n\tHash<p2>b;\n\tHS(){}\n\tHS(char * c)\n\t{\n\t\ta=Hash<p1>(c);\n\t\tb=Hash<p2>(c);\n\t}\n\tpair<long long,long long>ask(int l,int r){return {a.ask(l,r),b.ask(l,r)};}\n};\nHS<998244353,1000000007> S;\nchar c[1000006];\ninline int lcp(int x,int y)\n{\n\tif(c[x]!=c[y])return 0;\n\tint l=1,r=n-max(x,y)+1;\n\twhile(l<r)\n\t{\n\t\tint mid=((l+r+1)>>1);\n\t\tif(S.ask(x,x+mid-1)==S.ask(y,y+mid-1))\n\t\t\tl=mid;\n\t\telse  r=mid-1;\n\t}\n\treturn l;\n}\ninline int lcs(int x,int y)\n{\n\tif(c[x]!=c[y])return 0;\n\tint l=1,r=min(x,y);\n\twhile(l<r)\n\t{\n\t\tint mid=((l+r+1)>>1);\n\t\tif(S.ask(x-mid+1,x)==S.ask(y-mid+1,y))\n\t\t\tl=mid;\n\t\telse  r=mid-1;\n\t}\n\treturn l;\n}\nbool cmp(int l1,int r1,int l2,int r2)//c[l1:r1]<c[l2,r2]\n{\n\tint l=lcp(l1,l2);\n\tif(l>min(r1-l1,r2-l2))return r1-l1<r2-l2;\n\treturn c[l1+l]<c[l2+l];\n}\nint run[1000006];\nstruct runs\n{\n\tint l,r,p;\n\tbool operator ==(runs b){return b.l==l&&b.r==r&&b.p==p;}\n\tbool operator <(runs b)\n\t{\n\t\tif(b.l==l)return r<b.r;\n\t\treturn l<b.l;\n\t}\n};\nint st[1000006];\nvoid lyndon()\n{\n\tint top=0;\n\tfor(int i=n;i>=1;i--)\n\t{\n\t\tst[++top]=i;\n\t\twhile(top>1&&cmp(i,st[top],st[top]+1,st[top-1]))\n\t\t\ttop--;\n\t\trun[i]=st[top];\n\t}\n}\nvector<runs>ans;\nvoid solve()\n{\n\tfor(int i=1;i<=n;i++)\n\t{\n\t\tint l1=i,r1=run[i];\n\t\tint l2=l1-lcs(l1-1,r1),r2=r1+lcp(l1,r1+1);\n\t\tif(r2-l2+1>=(r1-l1+1)*2)\n\t\t\tans.push_back((runs){l2,r2,r1-l1+1});\n\t}\n}\nvector<pair<int,int> >ask[1000005];\nint q;\nvector<runs>ed[1000006];\nvector<runs>vr[1000006];\nstruct BIT\n{\n\tint c[200005];\n\tinline int ask(int x){int re=0;for(;x;x-=(x&-x))re+=c[x];return re;}\n\tinline void add(int x,int y){for(;x<=200000;x+=(x&-x))c[x]+=y;}\n}B;\nint as[1000006];\nint main()\n{\n\tread(n,q);\n\tscanf(\"%s\",c+1);\n\tn=strlen(c+1);\n\tS=HS<998244353,1000000007>(c);\n\tlyndon();solve();\n\tfor(int i=1;i<=n;i++)\n\t\tc[i]='z'-(c[i]-'a');\n\tlyndon();solve();\n\tsort(ans.begin(),ans.end());\n\tans.erase(unique(ans.begin(),ans.end()),ans.end());\n\tfor(int i=1,l,r;i<=q;i++)\n\t\tread(l,r),\n\t\task[r].push_back({l,i});\n\tfor(runs i:ans)\n\t{\n\t\tvr[i.r].push_back(i);\n\t\tfor(int j=i.l;j+i.p*2-1<=i.r;j++)\n\t\t\ted[j+i.p*2-1].push_back(i);\n\t}\n\tmap<pair<long long,long long>,int>mp;\n\tfor(int i=1;i<=n;i++)\n\t{\n\t\tfor(runs r:ed[i])\n\t\t{\n\t\t\tint np=r.p*2,t=(i-r.l+1)/np,l=i-np*t+1;\n\t\t\tauto tp=S.ask(l,i);\n\t\t\tif(mp[tp])B.add(mp[tp],-1);\n\t\t\tmp[tp]=0;\n\t\t}\n\t\tint re=B.ask(i);\n\t\tfor(pair<int,int> q:ask[i])\n\t\t{\n\t\t\tas[q.second]=re-B.ask(q.first-1);\n\t\t\tfor (runs r:ed[i])\n\t\t\t{\n\t\t\t\tint l=i-max(r.l,q.first)+1,p=r.p;\n\t\t\t\tint t=l%(p*2),s=l/(p*2);\n\t\t\t\tif(s==0)continue;\n\t\t\t\tif(t>=p-1)as[q.second]+=s*p;\n\t\t\t\telse as[q.second]+=s*(t+1)+(s-1)*(p-t-1);\n\t\t\t}\n\t\t}\n\t\tfor(runs r:vr[i])\n\t\t{\n\t\t\tint np=r.p*2;\n\t\t\tfor(int j=r.l;j+np-1<=r.r;j++)\n\t\t\t{\n\t\t\t\tint t=(r.r-j+1)/np,k=j+t*np-1;\n\t\t\t\tif(r.r-k>=r.p)continue;\n\t\t\t\tauto tp=S.ask(j,k);\n\t\t\t\tmp[tp]=j;\n\t\t\t\tB.add(j,1);\n\t\t\t}\n\t\t}\n\t}\n\tfor(int i=1;i<=q;i++)printf(\"%lld\\n\",as[i]);\n\treturn 0;\n}\n\n\n```",
        "postTime": 1616123370,
        "uid": 114409,
        "name": "9AC8E2",
        "ccfLevel": 0,
        "title": "P6629 [ZJOI2020] \u5b57\u7b26\u4e32"
    }
]