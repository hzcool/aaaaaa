[
    {
        "content": "\u663e\u7136\u6211\u4eec\u5e76\u4e0d\u9700\u8981\u5177\u4f53\u662f\u54ea\u4e2a\u78c1\u6781\uff0c\u53ea\u9700\u8981\u53ea\u8981\u78c1\u6781\u662f\u5426\u76f8\u540c\u3002\n\n\u4ee4 $y$ \u4e3a\u6811\u7684\u6839\uff0c\u8bbe $f_{i,0/1}$ \u8868\u793a\u4ece $i$ \u8d70\u5230 $y$\uff0c\u78c1\u6781\u76f8\u540c/\u4e0d\u540c\u65f6\u7684\u671f\u671b\u6b65\u6570\u3002\n\n\u6709 $\\begin{cases}f_{i,0}=pf_{fa_i,1}+(1-p)(f_{i,0}+1)+1,f_{i,1}=(1-p)f_{fa_i,1}+p(f_{i,0}+1)+1&i\\text{\u662f\u53f6\u5b50\u8282\u70b9}\\\\f_{i,0}=pf_{fa_i,1}+(1-p)\\sum\\dfrac{f_{j,0}}{so_i}+1,f_{i,1}=(1-p)f_{fa_i,1}+p\\sum\\dfrac{f_{j,0}}{so_i}+1&i\\text{\u4e0d\u662f\u53f6\u5b50\u8282\u70b9}\\end{cases}$\uff0c\u5176\u4e2d $j$ \u662f $i$ \u7684\u513f\u5b50\uff0c$fa_i$ \u662f $i$ \u7684\u7236\u4eb2\uff0c$so_i$ \u662f $i$ \u7684\u513f\u5b50\u8282\u70b9\u4e2a\u6570\u3002\u7279\u522b\u7684\uff0c$f_{y,0}=f_{y,1}=0$\u3002\n\n### Subtask 1\n\n\u76f4\u63a5\u5199\u5f0f\u5b50\u7136\u540e\u9ad8\u65af\u6d88\u5143\u3002\n\n### Subtask 2&3\n\n\uff08\u6211\u611f\u89c9\u8fd9\u4e24\u90e8\u5206\u505a\u6cd5\u662f\u4e00\u6837\u7684\uff09\n\n~~\u8003\u8651\u4eba\u8111\u6d88\u5143\u3002~~\n\n\u5bf9\u53f6\u5b50\u8282\u70b9\u7684\u5f0f\u5b50\u53d8\u5f62\uff0c\u6709 $f_{i,0}=f_{fa_i,1}+\\dfrac{2-p}{p},f_{i,1}=f_{fa_i,1}+3$\u3002\n\n\u53d1\u73b0\u9012\u63a8\u5f0f\u4e2d\u53ea\u6d89\u53ca\u5230 $f_{fa_i,1}$ \u4ee5\u53ca\u5e38\u6570\u9879\uff0c\u8003\u8651\u5f52\u7eb3\u8bc1\u660e\u6bcf\u4e2a\u8282\u70b9\u7684\u9012\u63a8\u5f0f\u53ea\u4e0e\u5176\u7236\u4eb2\u6709\u5173\u3002\n\n\u5bf9\u4e8e\u975e\u53f6\u5b50\u8282\u70b9 $i$\uff0c\u5047\u8bbe\u5176\u540e\u4ee3\u8282\u70b9\u5747\u6ee1\u8db3\u6b64\u89c4\u5f8b\u3002\u8bbe $\\sum\\dfrac{f_{j,0}}{so_i}=k_1f_{i,1}+k_2$\u3002\n\n\u6709 $f_{i,0}=pf_{fa_i,1}+(1-p)(k_1f_{i,1}+k_2)+1,f_{i,1}=(1-p)f_{fa_i,1}+p(k_1f_{i,1}+k_2)+1$\u3002\n\n\u53d8\u5f62\uff0c\u5f97 $f_{i,0}=\\dfrac{p+k_1-2pk_1}{1-pk_1}f_{fa_i,1}+\\dfrac{k_1+k_2-2pk_1-pk_2+1}{1-pk_1},f_{i,1}=\\dfrac{1-p}{1-pk_1}f_{fa_i,1}+\\dfrac{1+pk_2}{1-pk_1}$\uff0c\u5f97\u8bc1\u3002\n\n\u56e0\u6b64\u6211\u4eec\u53ea\u9700\u8981\u5148\u8fdb\u884c\u4e00\u6b21\u6811\u5f62dp\u6c42\u51fa\u9012\u63a8\u5f0f\u7684\u7cfb\u6570\u548c\u5e38\u6570\uff0c\u7136\u540e\u518d\u9012\u63a8\u5f97\u51fa\u7ed3\u679c\u3002\n\nSubtask 2 \u76f4\u63a5\u4ee5\u6bcf\u4e2a\u70b9\u4e3a\u6839\u7684\u60c5\u51b5\u5404\u8fdb\u884c\u4e00\u6b21dp\uff0cSubtask 3 \u76f4\u63a5\u4ee5 $1$ \u4e3a\u6839\u8fdb\u884cdp\u5373\u53ef\u3002\n\n### Subtask 4\n\n\u5bb9\u6613\u53d1\u73b0\u6bcf\u4e2a\u70b9\u7684\u9012\u63a8\u5f0f\u5b9e\u9645\u4e0a\u53ea\u548c\u6839\u7684\u65b9\u5411\u6709\u5173\u3002\n\n\u6240\u4ee5\u53ef\u4ee5\u7528\u6362\u6839dp\u6c42\u51fa\u6240\u6709\u7684\u9012\u63a8\u5f0f\u518d\u5229\u7528\u4e00\u4e9b\u5947\u602a\u7684\u64cd\u4f5c\u6765\u56de\u7b54\u6bcf\u4e2a\u8be2\u95ee\u3002\n\n\u8fd9\u6837\u505a\u8fd8\u662f\u5f88\u9ebb\u70e6\uff0c\u6240\u4ee5\u6211\u4eec\u8003\u8651\u518d\u7b80\u5316\u9012\u63a8\u5f0f\u3002\n\n\u5b9e\u9645\u4e0a\u628a\u6bcf\u4e2a\u70b9\u7684\u9012\u63a8\u5f0f\u7684\u7cfb\u6570\u6253\u8868\u6253\u51fa\u6765\u4f1a\u53d1\u73b0\u90fd\u4e3a $1$\u3002\n\n\u540c\u6837\u8003\u8651\u5f52\u7eb3\u8bc1\u660e\u5bb9\u6613\u8bc1\u5f97\uff0c\u4e8e\u662f\u5f97\u5230 $k_1=1$\u3002\n\n\u4e8e\u662f\u6709\u9012\u63a8\u5f0f $f_{i,0}=f_{fa_i,1}+k_2+2,f_{i,1}=f_{fa_i,1}+\\dfrac{1+pk_2}{1-p}$\u3002\n\n\u4e8e\u662f\u8fd9\u9053\u9898\u5c31\u6210\u4e86\u4e00\u9053\u6362\u6839dp+\u6811\u4e0a\u94fe\u6c42\u548c\u7684\u677f\u9898\uff0c\u9884\u5904\u7406\u9006\u5143\u53ef\u4ee5\u505a\u5230 $O(n+q\\log n)$\u3002\n\n\u5f53\u7136\u5177\u4f53\u5b9e\u73b0\u8fd8\u6709\u5f88\u591a\u7ec6\u8282\uff08\u7279\u522b\u662f\u8981\u5206\u6e05 $f_{i,0}$ \u548c $f_{i,1}$\uff0c\u4ee5\u53ca\u6ce8\u610f\u94fe\u8df3\u7684\u65b9\u5411\uff09\u3002\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define mod 998244353\nint lw[1000005],bi[2000005][2],bs;\nint s[1000005],tf[1000005],f[1000005][2],ff[1000005][2],sf[1000005][2];\nint fa[1000005],so[1000005],si[1000005],de[1000005],to[1000005];\nint n,q,p,np,nfp,ny[1000005];\nint dr()\n{\n\tint xx=0;char ch=getchar();\n\twhile(ch<'0'||ch>'9')ch=getchar();\n\twhile(ch>='0'&&ch<='9')xx=(xx<<1)+(xx<<3)+ch-'0',ch=getchar();\n\treturn xx;\n}\nint P(int x,int y=mod-2)\n{\n\tint z=1;\n\tfor(;y;x=1ll*x*x%mod,y>>=1)if(y&1)z=1ll*z*x%mod;\n\treturn z;\n}\nvoid tj(int u,int v){++bs,bi[bs][0]=lw[u],bi[bs][1]=v,lw[u]=bs;}\nvoid dfs1(int w,int fath,int d)\n{\n\tfa[w]=fath,si[w]=1,de[w]=d;\n\tint x;\n\tfor(int o_o=lw[w];o_o;o_o=bi[o_o][0])\n\t{\n\t\tint v=bi[o_o][1];\n\t\tif(v!=fath)\n\t\t{\n\t\t\t++s[w],dfs1(v,w,d+1),tf[w]=(tf[w]+f[v][0])%mod,si[w]+=si[v];\n\t\t\tif(si[v]>si[so[w]])so[w]=v;\n\t\t}\n\t}\n\tif(s[w])x=1ll*tf[w]*ny[s[w]]%mod,f[w][0]=(2+x)%mod,f[w][1]=1ll*(1+1ll*p*x)%mod*nfp%mod;\n\telse f[w][0]=1ll*(2-p+mod)*np%mod,f[w][1]=3;\n}\nvoid dfs2(int w)\n{\n\tif(s[w]==0)return;\n\tint ns=ny[s[w]-(fa[w]?0:1)],tt=(tf[w]+ff[w][0])%mod,x;\n\tfor(int o_o=lw[w];o_o;o_o=bi[o_o][0])\n\t{\n\t\tint v=bi[o_o][1];\n\t\tif(v!=fa[w])\n\t\t{\n\t\t\tif(fa[w]||s[w]>1)x=1ll*(tt-f[v][0]+mod)*ns%mod,ff[v][0]=(2+x)%mod,ff[v][1]=1ll*(1+1ll*p*x)%mod*nfp%mod;\n\t\t\telse ff[v][0]=1ll*(2-p+mod)*np%mod,ff[v][1]=3;\n\t\t\tdfs2(v);\n\t\t}\n\t}\n}\nvoid dfs(int w,int t)\n{\n\tto[w]=t,sf[w][0]=(sf[fa[w]][0]+f[w][1])%mod,sf[w][1]=(sf[fa[w]][1]+ff[w][1])%mod;\n\tif(so[w])dfs(so[w],t);\n\tfor(int o_o=lw[w];o_o;o_o=bi[o_o][0])\n\t{\n\t\tint v=bi[o_o][1];\n\t\tif(v!=fa[w]&&v!=so[w])dfs(v,v);\n\t}\n}\nint lca(int x,int y)\n{\n\tint fx=to[x],fy=to[y];\n\twhile(fx!=fy)if(de[fx]>de[fy])x=fa[fx],fx=to[x];else y=fa[fy],fy=to[y];\n\treturn de[x]<de[y]?x:y;\n}\nint gs(int x,int y)\n{\n\tint fx=to[x],fy=to[y];\n\twhile(fx!=fy)\n\t{\n\t\tif(fa[fx]==y)return fx;\n\t\tx=fa[fx],fx=to[x];\n\t}\n\treturn so[y];\n}\nint main()\n{\n\tn=dr(),q=dr(),p=dr(),np=P(p),nfp=P(mod+1-p);\n\tny[1]=1;\n\tfor(int i=2;i<=n;i++)ny[i]=1ll*(mod-mod/i)*ny[mod%i]%mod;\n\tfor(int i=1;i<n;i++)\n\t{\n\t\tint u=dr(),v=dr();\n\t\ttj(u,v),tj(v,u);\n\t}\n\tdfs1(1,0,1),dfs2(1),dfs(1,1);\n\twhile(q--)\n\t{\n\t\tint x=dr(),y;char c1=getchar(),c2;\n\t\twhile(c1!='N'&&c1!='S')c1=getchar();\n\t\ty=dr(),c2=getchar();\n\t\twhile(c2!='N'&&c2!='S')c2=getchar();\n\t\tint a=lca(x,y),ans=((sf[x][0]-sf[a][0]+sf[y][1]-sf[a][1])%mod+mod)%mod;\n\t\tif(c1==c2)\n\t\t{\n\t\t\tif(x==a)\n\t\t\t{\n\t\t\t\tint b=gs(y,a);\n\t\t\t\tans=((ans-ff[b][1]+ff[b][0])%mod+mod)%mod;\n\t\t\t}\n\t\t\telse ans=((ans-f[x][1]+f[x][0])%mod+mod)%mod;\n\t\t}\n\t\tprintf(\"%d\\n\",ans);\n\t}\n}\n```\n\n\n------------\n\u5173\u4e8e\u4e3a\u4ec0\u4e48 $p\\geq 2$\uff1a\n\n\u5176\u5b9e\u5c31\u662f\u76f4\u63a5\u5e2e\u4f60\u4eec\u6392\u9664\u4e86 $p=0$ \u4ee5\u53ca $p=1$ \u7684\u60c5\u51b5\uff0c\u56e0\u4e3a\u4e0a\u9762\u6240\u6709\u7684\u5f0f\u5b50\u53d8\u5f62\u90fd\u57fa\u4e8e $p\\neq 0$ \u548c $p\\neq 1$\u3002",
        "postTime": 1612506318,
        "uid": 104581,
        "name": "kkk\u7684\u5c0f\u8214\u72d7",
        "ccfLevel": 8,
        "title": "\u78c1\u63a7\u6cd5\u5219 \u9898\u89e3"
    }
]