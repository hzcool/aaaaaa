[
    {
        "content": "## \u5b98\u65b9\u9898\u89e3\uff0c\u8bf7\u52ff\u76d7\u7528\n\n\u9996\u5148\u9700\u8981\u628a\u5f0f\u5b50\u5316\u6210\u8f83\u597d\u7ef4\u62a4\u7684\u5f62\u5f0f\u3002\u8bb0 $S_n = \\sum_{i = 1}^n a[i]$\u3002\u6211\u4eec\u5c06\u539f\u5f0f\u5c55\u5f00\uff0c\u5982\u4e0b\uff1a\n$$\\begin{aligned} \n\t& \\large\\prod_{i = 1}^{n} C_{\\sum_{j = 1}^{i}a[j]}^{a[i]} \n\\\\=\\ & \\prod_{i = 1}^{n} C_{S_i}^{a[i]} \n\\\\=\\ & \\prod_{i = 1}^{n} \\frac{S_i!}{a[i]! \\ (S[i] - a[i])!}\n\\\\=\\ & \\prod_{i = 1}^{n} \\frac{S_i!}{a[i]! \\ S_{i-1}!}\n\\\\=\\ & \\frac{S_1!}{a[1]!} \\times \\frac{S_2!}{a[2]! \\ S_{1}!} \\times \\cdots \\times \\frac{S_{n-1}!}{a[n-1]! \\ S_{n-2}!} \\times \\frac{S_{n}!}{a[n]! \\ S_{n-1}!} \n\\\\=\\ & \\frac{S_n!}{a[1]! \\times a[2]! \\times \\cdots \\times a[n]!}\n\\\\=\\ & \\frac{S_n!}{\\prod_{i = 1} ^ n a[i] !}\n\\end{aligned} $$\n\u4e8e\u662f\u6211\u4eec\u5c31\u53ea\u9700\u8981\u8003\u8651\u5982\u4f55\u7ef4\u62a4\u5206\u5b50\u5206\u6bcd\u7136\u540e\u6c42\u9006\u5143\u76f8\u4e58\u5373\u53ef\u3002\u5206\u5b50\u53ef\u4ee5\u901a\u8fc7\u9884\u5904\u7406\u9636\u4e58\u7684\u65b9\u5f0f\u8f6c\u5316\u4e3a\u7ef4\u62a4\u533a\u95f4\u548c\uff0c\u5206\u6bcd\u53ef\u4ee5\u901a\u8fc7\u9884\u5904\u7406\u9636\u4e58\u9006\u5143\u7684\u65b9\u5f0f\u8f6c\u5316\u4e3a\u7ef4\u62a4\u533a\u95f4\u79ef\u3002\n\n\u5206\u6790\u9898\u9762\u3002\u9898\u76ee\u8981\u6c42\u533a\u95f4\u5355\u503c\u4fee\u6539\uff0c\u8fd9\u662f\u666e\u901a\u6570\u636e\u7ed3\u6784\u6240\u65e0\u6cd5\u7ef4\u62a4\u7684\u3002\n\n\u6211\u4eec\u9700\u8981\u8003\u8651\u5982\u4f55\u5feb\u901f\u7edf\u8ba1\u4fe1\u606f\u3002\u8fd9\u542f\u53d1\u6211\u4eec\u901a\u8fc7\u4e3a\u5143\u7d20\u8bbe\u7f6e\u4ee3\u8868\u5143\u6765\u8fdb\u884c\u7edf\u8ba1\u3002\u5177\u4f53\u5730\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u7279\u5b9a\u7684\u503c $x$\uff0c\u6211\u4eec\u8bb0\u5f55\u4e0b\u5176\u9996\u6b21\u51fa\u73b0\u7684\u4f4d\u7f6e $i$\uff0c\u5e76\u4f7f\u540e\u9762\u7684\u503c $x$ \u5747\u6307\u5411 $i$\uff0c\u540c\u65f6\u5728 $i$ \u5904\u8bb0\u5f55\u5143\u7d20\u4e2a\u6570\u3002\u5176\u53ef\u4ee5\u7528\u5e76\u67e5\u96c6\u8fdb\u884c\u7ef4\u62a4\u3002\u5f53\u7136\uff0c\u6b64\u65b9\u6cd5\u5982\u679c\u5728\u6574\u4e2a\u5e8f\u5217\u4e0a\u8fdb\u884c\u5c31\u5931\u53bb\u4e86\u5176\u6548\u679c\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u5c06\u5e8f\u5217\u5206\u6bb5\uff0c\u5bf9\u4e8e\u6bcf\u6bb5\u5355\u72ec\u8fdb\u884c\u8bb0\u5f55\uff0c\u5728\u7edf\u8ba1\u7b54\u6848\u65f6\u904d\u5386\u8fd9\u4e9b\u6bb5\u5373\u53ef\u3002\u56e0\u6b64\u8003\u8651\u5206\u5757\u3002\n\n\u5177\u4f53\u5730\uff0c\u6211\u4eec\u8bb0\u5f55\u6bcf\u4e2a\u4f4d\u7f6e\u5bf9\u5e94\u503c $x$ \u5728\u67d0\u4e2a\u5757\u5185\u7b2c\u4e00\u6b21\u51fa\u73b0\u7684\u4f4d\u7f6e\u4f5c\u4e3a\u4ee3\u8868\u5143\uff08\u8bb0\u4f5c $\\operatorname{ancestor}_ x$\uff09\u4ee5\u53ca\u5176\u51fa\u73b0\u6b21\u6570\u3002\u8fd9\u4e2a\u53ef\u4ee5\u7528\u5e76\u67e5\u96c6\u4ee5\u53ca $O(n \\sqrt n)$ \u5927\u5c0f\u7684\u6570\u7ec4\u7ef4\u62a4\u3002\u5bf9\u4e8e\u4fee\u6539 $x \\rightarrow y$\uff0c\u5982\u679c  $\\operatorname{ancestor}_ y$ \u4e3a $0$\uff0c\u5c31\u5c06 $\\operatorname{ancestor}_ y$ \u4fee\u6539\u4e3a $\\operatorname{ancestor}_ x$\u3002\u5982\u679c\u5176\u4e0d\u4e3a $0$\uff0c\u76f4\u63a5\u5c06 $\\operatorname{ancestor}_ x$ \u7684\u7236\u4eb2\u8bbe\u4e3a $\\operatorname{ancestor}_ y$\u3002\u4e0e\u6b64\u540c\u65f6\u7ef4\u62a4\u51fa\u73b0\u6b21\u6570\u3002\u4e0e\u4e4b\u540c\u65f6\uff0c\u6211\u4eec\u9700\u8981\u7ef4\u62a4\u5757\u5185\u5143\u7d20\u548c\u4e0e\u5757\u5185\u9006\u5143\u79ef\uff0c\u8fd9\u4e2a\u90fd\u662f\u8f83\u597d\u7ef4\u62a4\u7684\u4fe1\u606f\u3002\n\n\u8ba8\u8bba\u6563\u5757\u4fee\u6539\u3002\u5bf9\u4e8e\u6563\u5757\uff0c\u6211\u4eec\u8ba9\u5176\u4e2d\u6bcf\u4e2a\u5143\u7d20\u7684\u503c\u8d4b\u4e3a\u5176\u4f4d\u7f6e\u4ee3\u8868\u5143\u6240\u5bf9\u5e94\u503c\uff0c\u904d\u5386\u4fee\u6539\u5373\u53ef\u3002\u4fee\u6539\u5b8c\u6bd5\u540e\uff0c\u518d\u91cd\u65b0\u521d\u59cb\u5316\u8fd9\u4e2a\u5757\u3002\n\n\u5bf9\u4e8e\u67e5\u8be2\uff0c\u6563\u5757\u76f4\u63a5\u67e5\u8be2\u4f4d\u7f6e\u4ee3\u8868\u5143\u5bf9\u5e94\u503c\uff0c\u6574\u5757\u76f4\u63a5\u7edf\u8ba1\u4fe1\u606f\u5373\u53ef\u3002\n\n\u601d\u8def\u8f83\u7b80\u5355\uff0c\u53ea\u662f\u7ec6\u8282\u4e0d\u5c11\u3002\u540c\u65f6\uff0c\u9700\u8981\u6ce8\u610f\u5f53\u4fee\u6539 $x \\rightarrow y$ \u4e14 $x = y$ \u65f6\u9700\u8981\u76f4\u63a5\u8df3\u8fc7\u3002\n\n\u4ee3\u7801\uff1a\n\n``` cpp\n// std\n#include <cstdio>\n#include <cstring>\n#include <cassert>\n#include <algorithm>\nusing namespace std;\n#define mod 998244353\n#define RGE 10000005\n#define N 100005\n#define siz 390\n#define rep(i,a,b) for ( register int (i) = (a); (i) <= (b); ++(i) )\n#define pre(i,a,b) for ( register int (i) = (a); (i) >= (b); --(i) )\nint n, q, a[N];\nint fac[RGE], inv[RGE];\nint bl[N], sz[N / siz + 5], st[N / siz + 5], ed[N / siz + 5], sum[N / siz + 5], prod[N / siz + 5], pw_fac[N][siz + 2], pw_inv[N][siz + 2];\n\ninline int qp(int a, int b) {\n\tint ret = 1;\n\twhile (b) {\n\t\tif (b & 1) ret = 1ll * ret * a % mod;\n\t\ta = 1ll * a * a % mod;\n\t\tb >>= 1;\n\t} return ret;\n}\n\nstruct block_id {\n\tint viv, cnt;\n}g[N / siz + 5][N];\n\nint fa[N], v[N];\ninline int get(int x) {\n\treturn x == fa[x] ? x : fa[x] = get(fa[x]);\n}\ninline void init(int id) {\n\tprod[id] = 1, sum[id] = 0;\n\trep(i, st[id], ed[id]) {\n\t\tif (g[id][a[i]].viv) fa[i] = g[id][a[i]].viv, g[id][a[i]].cnt++;\n\t\telse fa[i] = g[id][a[i]].viv = i, v[i] = a[i], g[id][a[i]].cnt = 1;\n\t\tsum[id] += a[i];\n\t\tprod[id] = 1ll * prod[id] * inv[a[i]] % mod;\n\t}\n}\ninline void ps_d(int id) {\n\trep(i, st[id], ed[id]) {\n\t\ta[i] = v[get(i)];\n\t\tg[id][a[i]].viv = g[id][a[i]].cnt = 0;\n\t} rep(i, st[id], ed[id]) fa[i] = 0;\n}\n\ninline void deal_side(int id, int l, int r, int from, int to) {\n\tps_d(id);\n\trep(i, l, r) if(a[i] == from) a[i] = to;\n\tinit(id);\n}\ninline void deal_whole(int id, int from, int to) {\n\tsum[id] += (to - from) * g[id][from].cnt;\n\tprod[id] = 1ll * prod[id] * pw_inv[to][g[id][from].cnt] % mod * pw_fac[from][g[id][from].cnt] % mod;\n\tg[id][to].cnt += g[id][from].cnt;\n\tif (g[id][to].viv == 0) g[id][to].viv = g[id][from].viv, v[g[id][to].viv] = to;\n\telse fa[g[id][from].viv] = g[id][to].viv;\n\tg[id][from].cnt = g[id][from].viv = 0;\n}\n\ninline void change(int l, int r, int from, int to) {\n\tif (bl[l] == bl[r]) {\n\t\tdeal_side(bl[l], l, r, from, to);\n\t} else {\n\t\tint lf, rt;\n\t\tif (st[bl[l]] != l) {\n\t\t\tdeal_side(bl[l], l, ed[bl[l]], from, to);\n\t\t\tlf = bl[l] + 1;\n\t\t} else {\n\t\t\tlf = bl[l];\n\t\t} if (ed[bl[r]] != r) {\n\t\t\tdeal_side(bl[r], st[bl[r]], r, from, to);\n\t\t\trt = bl[r] - 1;\n\t\t} else {\n\t\t\trt = bl[r];\n\t\t}\n\t\trep(i, lf, rt) deal_whole(i, from, to);\n\t}\n}\n\ninline int qry(int l, int r) {\n\tint tmpsum = 0, tmpprod = 1, tmp;\n\tif (bl[l] == bl[r]) {\n\t\trep(i,l,r) tmp = v[get(i)], tmpsum += tmp, tmpprod = 1ll * tmpprod * inv[tmp] % mod;\n\t} else {\n\t\tint lf, rt;\n\t\tif (st[bl[l]] != l) {\n\t\t\trep(i,l,ed[bl[l]]) tmp = v[get(i)], tmpsum += tmp, tmpprod = 1ll * tmpprod * inv[tmp] % mod;\n\t\t\tlf = bl[l] + 1;\n\t\t} else {\n\t\t\tlf = bl[l];\n\t\t} if (ed[bl[r]] != r) {\n\t\t\trep(i,st[bl[r]],r) tmp = v[get(i)], tmpsum += tmp, tmpprod = 1ll * tmpprod * inv[tmp] % mod;\n\t\t\trt = bl[r] - 1;\n\t\t} else {\n\t\t\trt = bl[r];\n\t\t} rep(i, lf, rt) tmpsum += sum[i], tmpprod = 1ll * tmpprod * prod[i] % mod;\n\t} return 1ll * fac[tmpsum] * tmpprod % mod;\n}\n\nsigned main() {\n\tregister int opr, l, r, x, y;\n\tcin >> n >> q;\n\t\n\tfac[1] = inv[1] = 1;\n\trep(i,2,RGE-5) fac[i] = 1ll * i * fac[i-1] % mod, inv[i] = 1ll * inv[mod % i] * (mod - mod / i) % mod;\n\trep(i,2,RGE-5) inv[i] = 1ll * inv[i] * inv[i-1] % mod;\n\trep(i,1,n) bl[i] = (i-1) / siz + 1;\n\trep(i,1,bl[n] - 1) sz[i] = siz;\n\tsz[bl[n]] = ((n % siz == 0) ? siz : n % siz);\n\tst[1] = 1;\n\trep(i,2,bl[n]) st[i] = st[i-1] + sz[i-1]; \n\trep(i,1,bl[n]-1) ed[i] = st[i+1] - 1;\n\ted[bl[n]] = n;\n\trep(i, 1, N-5) {\n\t\tpw_fac[i][0] = pw_inv[i][0] = 1;\n\t\trep(j, 1, siz + 1) {\n\t\t\tpw_fac[i][j] = 1ll * pw_fac[i][j-1] * fac[i] % mod;\n\t\t\tpw_inv[i][j] = 1ll * pw_inv[i][j-1] * inv[i] % mod;\n\t\t} \n\t} \n\n\trep(i,1,n) cin >> a[i];\n\trep(i,1,bl[n]) init(i);\n\trep(i,1,q) {\n\t\tcin >> opr >> l >> r;\n\t\tif (opr == 1) {\n\t\t\tcin >> x >> y;\n\t\t\tif (x == y) continue;\n\t\t\tchange(l, r, x, y);\n\t\t} else {\n\t\t\tcout << qry(l, r) << endl;\n\t\t} \n\t}\n}\n```",
        "postTime": 1665131735,
        "uid": 529722,
        "name": "Dream_Creator",
        "ccfLevel": 4,
        "title": "DTOI-2 \u661f\u4e4b\u754c \u5b98\u65b9\u9898\u89e3"
    },
    {
        "content": "\u8fd9\u9898\u548c [SNOI2022 \u519b\u961f](https://www.luogu.com.cn/problem/P8360) \u4e00\u6a21\u4e00\u6837\u7684\u554a\uff0c\u4e0d\u77e5\u9053\u4e3a\u4ec0\u4e48\u516c\u5f00\u8d5b\u51fa\u4e86\u8fd9\u6837\u4e00\u9053\u9898\uff08\u751a\u81f3\u6bd4\u90a3\u9898\u8981\u7b80\u5355\u4e9b\uff09~~\u8bf4\u8d77\u6765\u8fd9\u573a\u7684 t3 \u4e5f\u662f\u4e2a\u4e09\u7ef4\u504f\u5e8f\u677f\u5b50~~\n\n\u9996\u5148\u6709 $\\prod_{i=1}^n\\binom{a_i}{\\sum_{j=1}^ia_j}=\\frac{(\\sum a_i)!}{\\prod a_i!}$\uff0c\u56e0\u6b64\u53ea\u9700\u8981\u7ef4\u62a4\u533a\u95f4 $\\sum a_i$ \u4e0e $\\prod a_i!$\u3002\n\n\u8003\u8651\u5206\u5757\uff0c\u5bf9\u6bcf\u4e00\u79cd\u76f8\u540c\u503c\u7684\u5143\u7d20\uff0c\u6211\u4eec\u627e\u5230\u8fd9\u79cd\u5143\u7d20\u7b2c\u4e00\u6b21\u51fa\u73b0\u7684\u4f4d\u7f6e\uff0c\u5e76\u4ece\u540e\u9762\u6240\u6709\u6539\u5143\u7d20\u51fa\u73b0\u7684\u4f4d\u7f6e\u5411\u7b2c\u4e00\u6b21\u51fa\u73b0\u7684\u4f4d\u7f6e\u8fde\u8fb9\u3002\u90a3\u4e48\u6bcf\u79cd\u989c\u8272\u4f1a\u5f62\u6210\u4e00\u4e2a\u6811\u5f62\u7ed3\u6784\u3002\n\n\u540c\u65f6\uff0c\u6211\u4eec\u8bb0\u5f55 $f_{i,j}$\uff08$1\\le i\\le \\sqrt{n},1\\le j\\le 10^5$\uff09\u8868\u793a\u7b2c $i$ \u5757\u4e2d\u7b2c $j$ \u4e2d\u989c\u8272\u7684\u6811\u6839\u4f4d\u7f6e\u3002\u5bf9\u4e8e\u4fee\u6539 $x\\to y$\uff0c\u82e5 $y$ \u4e0d\u5b58\u5728\u90a3\u4e48\u76f4\u63a5\u5c06 $x$ \u6811\u6839\u4f4d\u7f6e\u7684\u989c\u8272\u4fee\u6539\u4e3a $y$ \u5373\u53ef\uff1b\u5426\u5219\u4ece $x$ \u7684\u6811\u6839\u5411 $y$ \u7684\u6811\u6839\u8fde\u8fb9\u3002\uff08\u6ce8\u610f\u540c\u65f6\u9700\u8981\u4fee\u6539 $f$ \u6570\u7ec4\uff09\n\n\u4fee\u6539\u65f6\u9700\u8981\u5904\u7406\u6563\u5757\u66b4\u529b\u91cd\u6784\u7684\u95ee\u9898\uff0c\u6b64\u65f6\u5927\u90e8\u5206\u9898\u89e3\u91c7\u7528\u4e86\u5e76\u67e5\u96c6\uff0c\u4f46\u8be5\u5e76\u67e5\u96c6\u4e0d\u53ef\u80fd\u6309\u79e9\u5408\u5e76\uff0c\u5bfc\u81f4\u65f6\u95f4\u590d\u6742\u5ea6\u81f3\u5c11\u4e3a $O(n\\sqrt{n}\\log n)$\uff08\u800c\u5927\u90e8\u5206\u9898\u89e3\u5e76\u672a\u63d0\u53ca\u8fd9\u4e00\u70b9\uff09\u3002\u5b9e\u9645\u4e0a\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5728\u8fd9\u4e00\u5757\u7684\u68ee\u6797\u4e0a\u81ea\u9876\u5411\u4e0b $\\text{DFS}$\uff0c\u5373\u53ef\u89c4\u907f\u5e76\u67e5\u96c6\u3002\n\n\u7531\u4e8e\u603b\u5171\u53ea\u4f1a\u6709 $O(n\\sqrt{n})$ \u6b21\u8fde\u8fb9\uff0c\u5e76\u4e14\u6bcf\u6b21\u91cd\u6784\u90fd\u4f1a\u5220\u9664\u4e0e\u8bbf\u95ee\u8fb9\u6570\u76f8\u540c\u7684\u8fb9\uff0c\u56e0\u6b64\u603b\u7684\u590d\u6742\u5ea6\u6070\u4e3a $O(n\\sqrt{n})$\u3002\u8fd9\u4e2a\u590d\u6742\u5ea6\u662f\u5747\u644a\u7684\uff0c\u5355\u6b21\u4fee\u6539\u7684\u590d\u6742\u5ea6\u53ef\u4ee5\u5f88\u9ad8\u3002\n\n\u8fd9\u6837\u505a\u7684\u65f6\u7a7a\u590d\u6742\u5ea6\u5747\u4e3a $O(n\\sqrt{n})$\uff0c\u4f46\u6211\u4eec\u6709\u529e\u6cd5\u5c06\u7a7a\u95f4\u590d\u6742\u5ea6\u4f18\u5316\u81f3 $O(n)$\u3002\u6ce8\u610f\u5230\u6bcf\u4e00\u5757\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u53ef\u4ee5\u7b80\u5355\u5408\u5e76\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u79bb\u7ebf\u4e0b\u6765\uff0c\u5355\u72ec\u5904\u7406\u6bcf\u4e00\u5757\u7684\u4fee\u6539\u4e0e\u8be2\u95ee\uff0c\u6700\u540e\u7edf\u4e00\u8f93\u51fa\u5373\u53ef\u3002\n",
        "postTime": 1671881362,
        "uid": 307453,
        "name": "\u4e91\u6d45\u77e5\u5904",
        "ccfLevel": 6,
        "title": "P8576"
    },
    {
        "content": "## Description\n\n\u7ed9\u4f60\u4e00\u4e2a\u957f\u5ea6\u4e3a $n$ \u7684\u5e8f\u5217\uff0c$q$ \u6b21\u64cd\u4f5c\uff0c\u64cd\u4f5c\u6709\u4ee5\u4e0b\u4e24\u79cd\uff1a\n\n- \u64cd\u4f5c\u4e00\uff1a`1 l r x y`\uff0c\u5c06 $[l,r]$ \u5185\u7684\u6240\u6709\u503c\u4e3a $x$ \u7684\u6570\u6539\u4e3a $y$\u3002\n\n- \u64cd\u4f5c\u4e8c\uff1a`2 l r`\uff0c\u8ba9\u4f60\u6c42\u51fa $\\prod\\limits_{i=l}^rC_{\\sum_{j=l}^ia_j}^{a_i}\\bmod 998244353$\u3002\n\n$1\\le n,q,a_i,x,y\\le 10^5$\u3002\u4efb\u610f\u65f6\u523b $\\sum a\\le 10^7$\u3002\n\n## Analysis\n\n\u4ee5\u4e0b\u5c0f\u5757\u6307\u5206\u5757\u4e2d\u4e0d\u5b8c\u6574\u7684\u5757\uff0c\u5927\u5757\u6307\u5206\u5757\u4e2d\u5b8c\u6574\u7684\u5757\u3002\n\n\u6309\u5757\u5927\u5c0f\u4e3a $\\sqrt n$ \u5bf9\u5e8f\u5217\u5206\u5757\uff0c\u6bcf\u4e2a\u5757\u5185\u5f00\u4e00\u4e2a\u6876\u7ef4\u62a4\u5143\u7d20\u3002\u7531\u4e8e\u503c\u57df\u4e0e $n$ \u540c\u9636\uff0c\u6545\u6876\u7684\u7a7a\u95f4\u662f $O(n\\sqrt n)$ \u7684\u3002\n\n\u5148\u6765\u5316\u7b80\u67ff\u5b50\uff0c\u4e0d\u96be\u5f97\u5230 $\\prod\\limits_{i=l}^rC_{\\sum_{j=l}^ia_j}^{a_i}=\\frac{(\\sum_{i=l}^ra_i)!}{\\prod_{i=l}^ra_i!}$\u3002\n\n\u8003\u8651\u5982\u4f55\u5408\u5e76\u4e24\u4e2a\u5757\u8be2\u95ee\u7684\u7b54\u6848\uff1a\u53ea\u9700\u8981\u5c06\u4e24\u4e2a\u5757\u7684\u7b54\u6848\u76f8\u4e58\uff0c\u7136\u540e\u8bbe\u4e24\u4e2a\u5757\u7684\u548c\u5206\u522b\u4e3a $x$ \u4e0e $y$\uff0c\u90a3\u4e48\u7b54\u6848\u518d\u4e58\u4e0a $\\frac{(x+y)!}{x!y!}$ \u5373\u53ef\u3002\n\n\u6545\u6bcf\u4e00\u5757\u53ea\u9700\u8981\u7ef4\u62a4\u4e24\u4e2a\u4fe1\u606f\uff1a\u533a\u95f4\u548c \u4e0e \u533a\u95f4\u6bcf\u4e2a\u6570\u9636\u4e58\u7684\u79ef\u3002\n\n\u8003\u8651\u4e00\u6b21\u4fee\u6539\u64cd\u4f5c\uff0c\u5c0f\u5757\u7684\u66b4\u529b\u4fee\u6539\u3002\u5927\u5757\u7684\u76f4\u63a5\u6539\u6876\u4fe1\u606f\u3002\u5047\u8bbe\u6709 $\\alpha$ \u4e2a $x$ \u8981\u6539\u4e3a $y$\uff0c\u90a3\u4e48\u533a\u95f4\u548c $+\\alpha(y-x)$\uff0c\u533a\u95f4\u7b54\u6848\u4e58 $(x!)^\\alpha$\uff0c\u9664 $(y!)^\\alpha$\uff0c\u518d\u9664\u53bb\u539f\u6765\u533a\u95f4\u548c\u7684\u9636\u4e58\uff0c\u4e58\u4e0a\u65b0\u7684\u533a\u95f4\u548c\u7684\u9636\u4e58\u5373\u53ef\u3002\u7531\u4e8e $\\alpha\\le\\sqrt n$\uff0c\u6545\u53ea\u8981\u4e0e\u9884\u5904\u7406\u51fa $10^5$ \u53ca\u4ee5\u5185\u6570\u7684\u9636\u4e58\u7684 $1$ \u5230 $\\sqrt n$ \u6b21\u5e42\u4e0e\u4ed6\u4eec\u7684\u9006\u5143\uff0c\u5c31\u80fd\u5728 $O(\\sqrt n)$ \u7684\u590d\u6742\u5ea6\u5185\u5b8c\u6210\u4e00\u6b21\u64cd\u4f5c\u3002\n\n\u6b64\u5904\u7528\u5230\u7684\u53e6\u4e00\u4e2a\u8f83\u4e3a\u5de7\u5999\u7684\u6280\u5de7\u662f\u4ee3\u8868\u5143\u3002\u53d1\u73b0\u5c0f\u5757\u66b4\u529b\u6c42\u89e3\u662f\u9700\u8981\u83b7\u53d6\u4ed6\u7684\u771f\u5b9e\u7684\u503c\u3002\u6211\u4eec\u53e6\u4e00\u4e2a\u5757\u4e2d\u4e00\u4e2a\u503c\u7684\u4ee3\u8868\u5143\u662f\u5757\u4e2d\u8fd9\u4e2a\u6570\u7b2c\u4e00\u4e2a\u51fa\u73b0\u7684\u4f4d\u7f6e\u3002\u6bcf\u6b21\u6574\u5757\u4fee\u6539\u65f6 $x\\to y$ \u53ea\u8981\u5c06 $x$ \u7684\u4ee3\u8868\u5143\u6307\u5411 $y$ \u7684\u4ee3\u8868\u5143\u5373\u53ef\uff0c\u82e5 $y$ \u6ca1\u6709\u4ee3\u8868\u5143\uff0c\u5219\u76f4\u63a5\u4fee\u6539 $x$ \u4ee3\u8868\u5143\u4f4d\u7f6e\u7684\u503c\u5373\u53ef\u3002\n\n\u63d0\u9192\uff1a\n\n- \u672c\u9898\u5361\u7a7a\u95f4\uff0c\u8bf7\u5408\u7406\u4f7f\u7528 `long long` \u7c7b\u578b\u53d8\u91cf\u3002\n\n- $x$ \u53ef\u4ee5\u7b49\u4e8e $y$\uff0c\u5728 $x=y$ \u65f6\u4e0d\u7528\u64cd\u4f5c\uff0c\u4e0d\u7136\u4f1a\u628a $x$ \u7684 $cnt$ \u53d8\u6210 $0$\uff01 \n\n## Code\n\n```cpp\nconst int M=10000010;\nconst int N=100010;\nconst int K=330;\ntemplate<int P>\nclass mod_int{\n  using Z=mod_int;\nprivate:\n  static int mo(int x){return x<0?x+P:x;}\npublic:\n  int x;\n  int val()const{return x;}\n  mod_int():x(0){}\n  template<class T>mod_int(const T&x_):x(x_>=0&&x_<P?static_cast<int>(x_):mo(static_cast<int>(x_%P))){}\n  bool operator==(const Z&rhs)const{return x==rhs.x;}\n  bool operator!=(const Z&rhs)const{return x!=rhs.x;}\n  Z operator-()const{return Z(x?P-x:0);}\n  Z pow(long long k)const{Z res=1,t=*this;while(k){if(k&1)res*=t;if(k>>=1)t*=t;}return res;}\n  Z&operator++(){x<P-1?++x:x=0;return *this;}\n  Z&operator--(){x?--x:x=P-1;return *this;}\n  Z operator++(int){Z ret=x;x<P-1?++x:x=0;return ret;}\n  Z operator--(int){Z ret=x;x?--x:x=P-1;return ret;}\n  Z inv()const{return pow(P-2);}\n  Z&operator+=(const Z&rhs){(x+=rhs.x)>=P&&(x-=P);return *this;}\n  Z&operator-=(const Z&rhs){(x-=rhs.x)<0&&(x+=P);return *this;}\n  Z&operator*=(const Z&rhs){x=1ULL*x*rhs.x%P;return *this;}\n  Z&operator/=(const Z&rhs){return *this*=rhs.inv();}\n#define setO(T,o) friend T operator o(const Z&lhs,const Z&rhs){Z res=lhs;return res o##=rhs;}\n  setO(Z,+)setO(Z,-)setO(Z,*)setO(Z,/)\n#undef setO\n};\nconst int P=998244353;\nusing Z=mod_int<P>;\nZ fac[M],ivf[M],facpw[N][K],ivfpw[N][K];\nvoid prework(){\n  fac[0]=1; rep(i,1,M-1) fac[i]=fac[i-1]*i;\n  ivf[M-1]=fac[M-1].inv(); per(i,M-1,1) ivf[i-1]=ivf[i]*i;\n  rep(i,0,N-1){\n    facpw[i][0]=1;\n    rep(j,1,K-1) facpw[i][j]=facpw[i][j-1]*fac[i];\n    ivfpw[i][0]=1;\n    rep(j,1,K-1) ivfpw[i][j]=ivfpw[i][j-1]*ivf[i];\n  }\n}\nint n,q,bs,a[N],L[K],R[K],sum[K],sz[K],id[N],tot,fa[N],val[N];\nZ pi[K];\nstruct data{\n  int head,cnt;\n}t[K][N];\nint find(int x){return fa[x]==x?x:fa[x]=find(fa[x]);}\nvoid init(int x){\n  pi[x]=1,sum[x]=0;\n  rep(i,L[x],R[x]){\n    if(t[x][a[i]].head) fa[i]=t[x][a[i]].head,t[x][a[i]].cnt++;\n    else fa[i]=i,t[x][a[i]].head=i,t[x][a[i]].cnt=1,val[i]=a[i];\n    sum[x]+=a[i],pi[x]*=ivf[a[i]];\n  }\n}\nvoid small(int x,int l,int r,int from,int to){\n  rep(i,L[x],R[x]) a[i]=val[find(i)],t[x][a[i]].head=t[x][a[i]].cnt=0;\n  rep(i,L[x],R[x]) fa[i]=0;\n  rep(i,l,r) if(a[i]==from) a[i]=to;\n  init(x);\n}\nvoid big(int x,int from,int to){\n  sum[x]+=t[x][from].cnt*(to-from),pi[x]*=facpw[from][t[x][from].cnt]*ivfpw[to][t[x][from].cnt];\n  t[x][to].cnt+=t[x][from].cnt;\n  if(t[x][to].head) fa[t[x][from].head]=t[x][to].head;\n  else t[x][to].head=t[x][from].head,val[t[x][from].head]=to;\n  t[x][from].head=t[x][from].cnt=0;\n}\nvoid upd(int l,int r,int x,int y){\n  if(id[l]==id[r]){\n    small(id[l],l,r,x,y);\n  }else{\n    int ll,rr;\n    if(L[id[l]]!=l) small(id[l],l,R[id[l]],x,y),ll=id[l]+1;\n    else ll=id[l];\n    if(R[id[r]]!=r) small(id[r],L[id[r]],r,x,y),rr=id[r]-1;\n    else rr=id[r];\n    rep(i,ll,rr) big(i,x,y);\n  }\n}\nZ qry(int l,int r){\n  int ressum=0; Z respi=1;\n  if(id[l]==id[r]){\n    rep(i,l,r){\n      int value=val[find(i)];\n      ressum+=value,respi*=ivf[value];\n    }\n  }else{\n    int ll,rr;\n    if(L[id[l]]!=l){\n      rep(i,l,R[id[l]]){\n        int value=val[find(i)];\n        ressum+=value,respi*=ivf[value];\n        ll=id[l]+1;\n      }\n    }else ll=id[l];\n    if(R[id[r]]!=r){\n      rep(i,L[id[r]],r){\n        int value=val[find(i)];\n        ressum+=value,respi*=ivf[value];\n        rr=id[r]-1;\n      }\n    }else rr=id[r];\n    rep(i,ll,rr) ressum+=sum[i],respi*=pi[i];\n  }\n  return fac[ressum]*respi;\n}\nsigned main(){IOS;\n  prework();\n  cin>>n>>q,bs=sqrt(n);\n  rep(i,1,n) id[i]=(i-1)/bs+1,sz[id[i]]++;\n  rep(i,1,n) R[id[i]]=i;\n  per(i,n,1) L[id[i]]=i;\n  tot=id[n];\n  rep(i,1,n) cin>>a[i];\n  rep(i,1,tot) init(i);\n  while(q--){\n    int op; cin>>op;\n    if(op==1){\n      int l,r,x,y; cin>>l>>r>>x>>y;\n      if(x==y) continue;\n      upd(l,r,x,y);\n    }else{\n      int l,r; cin>>l>>r;\n      cout<<qry(l,r).val()<<\"\\n\";\n    }\n  }\n}\n```",
        "postTime": 1665219339,
        "uid": 169574,
        "name": "Enucai",
        "ccfLevel": 7,
        "title": "P8576 \u300cDTOI-2\u300d\u661f\u4e4b\u754c"
    },
    {
        "content": "\u9996\u5148\uff0c\u539f\u5f0f\u53ef\u4ee5\u8f6c\u5316\u4e3a\n$$\\frac{(\\sum_{i=l}^r a_i)!}{\\prod_{i=l}^r (a_i!)}$$\n\u8fd9\u5c31\u5f88\u597d\u529e\u4e86\uff0c\u53ef\u4ee5\u62ff\u7ebf\u6bb5\u6811\u6765\u7ef4\u62a4\u3002  \n\n\u4f46\u662f\uff0c\u8fd8\u6709\u64cd\u4f5c\u4e00\uff0c\u4e00\u770b\u5c31\u662f\u8981\u5206\u5757\u3002  \n\u5757\u5185\u8981\u7ef4\u62a4\u4ee5\u4e0b\u4fe1\u606f\u3002  \n1. \u533a\u95f4\u548c\n1. \u533a\u95f4\u9636\u4e58\u9006\u5143\u79ef\n1. \u76f8\u540c\u7684\u6570\u7684\u4f4d\u7f6e\n\n\u5982\u679c\u662f\u5168\u5c40\u76f8\u540c\u7684\u6570\u7684\u4f4d\u7f6e\uff0c\u90a3\u4e48\u548c\u66b4\u529b\u5df2\u7ecf\u6ca1\u6709\u533a\u522b\u4e86\u3002  \n\u5206\u5757\u7684\u597d\u5904\u662f\u5757\u5185\u53ef\u4ee5\u76f4\u63a5\u5904\u7406\u3002  \n\u6240\u4ee5\u53ef\u4ee5\u5bf9\u4e8e\u6bcf\u4e2a\u5757\u7ef4\u62a4\u4e00\u4e2a\u94fe\u8868\uff0c\u5c06\u6240\u6709\u70b9\u5bf9\u5e94\u5730\u8fde\u5230\u67d0\u4e2a\u4e0a\u9762\u3002  \n\u4f46\u662f\u5982\u679c\u8981\u662f\u627e\u94fe\u5934\uff0c\u5219\u9700\u8981\u7c7b\u4f3c\u5e76\u67e5\u96c6\u7684\u64cd\u4f5c\u3002  \n\u6240\u4ee5\u76f4\u63a5\u5e76\u67e5\u96c6\u597d\u4e86\u3002  \n\n* \u5e76\u67e5\u96c6\u64c5\u957f\u52a8\u6001\u7ef4\u62a4\u8bb8\u591a\u5177\u6709\u4f20\u9012\u6027\u7684\u5173\u7cfb\u3002\n\n\u6240\u4ee5\u5e76\u67e5\u96c6\u6765\u8fde\u63a5\u94fe\u5934\u4ee5\u53ca\u5176\u4ed6\u662f\u8fd9\u4e2a\u503c\u7684\u70b9\uff0c\u627e\u94fe\u5934\u662f\u76f4\u63a5 `find()` \u5373\u53ef\u3002  \n\n\u67e5\u8be2\u7b54\u6848\u5c31\u6309\u5206\u5757\u7684\u65b9\u6cd5\u5199\u5c31\u884c\u3002  \n\n\u81f3\u4e8e\u4fee\u6539\uff0c\u5206\u7c7b\u8ba8\u8bba\u3002  \n\u5bf9\u4e8e\u4e00\u4e2a\u5757\u5185\u6216\u8005\u8fb9\u89d2\uff0c\u76f4\u63a5\u66b4\u529b\u91cd\u6784\u5757\u3002  \n\u6574\u5757\u5c31\u662f\u5c06\u4f4d\u7f6e\u4fee\u6539\uff0c\u627e\u5230\u94fe\u5934\uff0c\u76f4\u63a5\u8f6c\u5ac1\u8fc7\u53bb\u3002  \n\u5176\u4ed6\u7684\u5bf9\u4e8e\u533a\u95f4\u548c\u548c\u79ef\u7684\u4fee\u6539\u5c31\u5f88\u5e73\u51e1\u4e86\u3002\n\n\u590d\u6742\u5ea6\u5927\u81f4\u662f $O(n\\sqrt{n})$ \u7684\u3002  \n\n```cpp\n#include<cstdio>\n#define _for(i,a,b) for(register int i=(a);i<=(b);++i)\n#define __for(i,a,b) for(register int i=(a);i>=(b);--i)\n#define Re register int\n#define il inline\n#define pc putchar\nusing namespace std;\ntypedef long long ll;\nconst int N=1e5+10,M=998244353,inf=2147483647;\nil int re(){\n\tint x=0;\n\tbool f=0;\n\tchar ch=getchar();\n\twhile(ch<'0'||ch>'9')\n\t\tf|=ch=='-',ch=getchar();\n\twhile(ch>='0'&&ch<='9')\n\t\tx=(x<<1)+(x<<3)+(ch^48),ch=getchar();\n\treturn f?-x:x;\n}\nvoid pr(int x){\n\tif(x<0) x=-x,pc('-');\n\tif(x>9) pr(x/10);\n\tpc(x%10|48);\n}\n\nint n,a[N],v[N];\nconst int B=316,W=1e7+10,L=N/B+10;\nint fac[W],inv[N],powfac[N][B+10],powinv[N][B+10];\nstruct node{//\u94fe\u8868\uff0c\u53ea\u6709\u5934\u548c\u94fe\u957f\n\tint head,num;\n}e[L][N];\nint bl[L],br[L],pos[N];\nint sum[L],mul[L];//\u533a\u95f4\u548c\uff0c\u533a\u95f4\u9636\u4e58\u9006\u5143\u79ef\n\nint fa[N];//\u5e76\u67e5\u96c6\nil int find(int x){\n\twhile(x!=fa[x])\n\t\tx=fa[x]=fa[fa[x]];\n\treturn x;\n}\n\nil int pow(int a,int b){\n\tint c=1;\n\twhile(b){\n\t\tif(b&1) c=(ll)c*a%M;\n\t\ta=(ll)a*a%M;\n\t\tb>>=1;\n\t}\n\treturn c;\n}\n\nil void init(int x){//\u91cd\u6784\n\tsum[x]=0,mul[x]=1;\n\t_for(i,bl[x],br[x]){\n\t\tif(!e[x][a[i]].head){\n\t\t\te[x][a[i]].head=i;\n\t\t\te[x][a[i]].num=1;\n\t\t\tfa[i]=i;\n\t\t\tv[i]=a[i];\n\t\t}\n\t\telse{\n\t\t\t++e[x][a[i]].num;\n\t\t\tfa[i]=e[x][a[i]].head;\n\t\t}\n\t\tsum[x]+=a[i];\n\t\tmul[x]=(ll)mul[x]*inv[a[i]]%M;\n\t}\n}\nil void calc1(int now,int l,int r,int x,int y){//\u8fb9\u89d2\n\t_for(i,bl[now],br[now]){\n\t\ta[i]=v[find(i)];\n\t\te[now][a[i]].head=e[now][a[i]].num=0;\n\t}\n\t_for(i,bl[now],br[now]) fa[i]=0;\n\t_for(i,l,r)\n\t\tif(a[i]==x)\n\t\t\ta[i]=y;\n\tinit(now);\n}\nil void calc2(int now,int x,int y){//\u6574\u5757\n\tsum[now]+=(y-x)*e[now][x].num;\n\tmul[now]=(ll)mul[now]*powfac[x][e[now][x].num]%M*powinv[y][e[now][x].num]%M;\n\te[now][y].num+=e[now][x].num;\n\tif(!e[now][y].head){\n\t\te[now][y].head=e[now][x].head;\n\t\tv[e[now][y].head]=y;\n\t}\n\telse fa[e[now][x].head]=e[now][y].head;\n\te[now][x].head=e[now][x].num=0;\n}\n\nil void change(int l,int r,int x,int y){\n\tif(pos[l]==pos[r]){\n\t\tcalc1(pos[l],l,r,x,y);\n\t}\n\telse{\n\t\tint L,R;\n\t\tif(l!=bl[pos[l]]){\n\t\t\tcalc1(pos[l],l,br[pos[l]],x,y);\n\t\t\tL=pos[l]+1;\n\t\t}\n\t\telse L=pos[l];\n\t\tif(r!=br[pos[r]]){\n\t\t\tcalc1(pos[r],bl[pos[r]],r,x,y);\n\t\t\tR=pos[r]-1;\n\t\t}\n\t\telse R=pos[r];\n\t\t_for(i,L,R)\n\t\t\tcalc2(i,x,y);\n\t}\n}\n\nil int ask(int l,int r){\n\tint x=0,y=1;\n\tif(pos[l]==pos[r]){\n\t\t_for(i,l,r){\n\t\t\tint z=v[find(i)];\n\t\t\tx+=z;\n\t\t\ty=(ll)y*inv[z]%M;\n\t\t}\n\t}\n\telse{\n\t\tint L,R;\n\t\tif(bl[pos[l]]!=l){\n\t\t\t_for(i,l,br[pos[l]]){\n\t\t\t\tint z=v[find(i)];\n\t\t\t\tx+=z;\n\t\t\t\ty=(ll)y*inv[z]%M;\n\t\t\t}\n\t\t\tL=pos[l]+1;\n\t\t}\n\t\telse L=pos[l];\n\t\tif(br[pos[r]]!=r){\n\t\t\t_for(i,bl[pos[r]],r){\n\t\t\t\tint z=v[find(i)];\n\t\t\t\tx+=z;\n\t\t\t\ty=(ll)y*inv[z]%M;\n\t\t\t}\n\t\t\tR=pos[r]-1;\n\t\t}\n\t\telse R=pos[r];\n\t\t_for(i,L,R){\n\t\t\tx+=sum[i];\n\t\t\ty=(ll)y*mul[i]%M;\n\t\t}\n\t}\n\treturn (ll)fac[x]*y%M;\n}\n\nsigned main(){\n\tn=re();\n\tint q=re();\n\t_for(i,1,n){\n\t\ta[i]=re(),pos[i]=i/B+1;\n\t\tif(pos[i]!=pos[i-1])\n\t\t\tbl[pos[i]]=i,br[pos[i-1]]=i-1;\n\t}\n\tbr[pos[n]]=n;\n\t\n\t\n\tinv[0]=fac[0]=fac[1]=1;\n\t_for(i,2,10000000)\n\t\tfac[i]=(ll)fac[i-1]*i%M;\n\tinv[100000]=pow(fac[100000],M-2);\n\t__for(i,100000-1,1) inv[i]=(ll)inv[i+1]*(i+1)%M;\n\t_for(i,1,100000){\n\t\tpowfac[i][0]=powinv[i][0]=1;\n\t\t_for(j,1,B){\n\t\t\tpowfac[i][j]=(ll)powfac[i][j-1]*fac[i]%M;\n\t\t\tpowinv[i][j]=(ll)powinv[i][j-1]*inv[i]%M;\n\t\t}\n\t}\n\t_for(i,1,pos[n]) init(i);\n\t\n\twhile(q--){\n\t\tint op=re();\n\t\tif(op==1){\n\t\t\tint l=re(),r=re(),x=re(),y=re();\n\t\t\tif(x==y) continue ;\n\t\t\tchange(l,r,x,y);\n\t\t}\n\t\telse{\n\t\t\tint l=re(),r=re();\n\t\t\tpr(ask(l,r)),pc('\\n');\n\t\t}\n\t}\n\treturn 0;\n}\n```\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
        "postTime": 1671937490,
        "uid": 609626,
        "name": "St_john",
        "ccfLevel": 0,
        "title": "P8576 \u300cDTOI-2\u300d\u661f\u4e4b\u754c"
    },
    {
        "content": "\u8fd9\u9898\u5361\u4e86\u6211\u597d\u4e45\uff0c\u5206\u5757\u9898\u4e00\u822c\u6781\u5176\u96be\u8c03\uff0c\u7ec6\u8282\u5de8\u591a\u3002\n\n---\n\n\u9996\u5148\u8be2\u95ee\u7684\u5f0f\u5b50\u53ef\u4ee5\u5316\u7b80\uff1a\n\n$$\n\\prod_{i=l}^rC_{\\sum_{j=l}^ra_j}^{a_i}=\\frac{sum(l,r)!}{\\prod_{i=l}^r(a_i!)}\n$$\n\n\u9700\u8981\u7ef4\u62a4\u533a\u95f4\u6c42\u548c\uff0c\u533a\u95f4\u9636\u4e58\u4e4b\u79ef\uff0c\u7531\u4e8e $\\sum a_i\\leq 10^7$\uff0c\u53ef\u4ee5\u5148\u9884\u5904\u7406 $10^7$ \u4ee5\u5185\u7684\u9636\u4e58\u548c $10^5$ \u4ee5\u5185\u7684\u9636\u4e58\u7684\u9006\u5143\u3002\n\n\u8003\u8651\u5206\u5757\uff0c\u5982\u4f55\u652f\u6301\u533a\u95f4\u503c\u7684\u6539\u53d8\uff1f\u5bf9\u4e8e\u6bcf\u4e00\u5757\u5185\u503c\u76f8\u540c\u7684\u653e\u5728\u4e00\u4e2a\u96c6\u5408\u4e2d\u3002\u53ef\u4ee5\u53d1\u73b0\u7ecf\u8fc7\u4e00\u4e9b\u64cd\u4f5c\u4e4b\u540e\uff0c\u96c6\u5408\u7684\u4e2a\u6570\u4f1a\u8d8a\u6765\u8d8a\u591a\uff0c\u4e5f\u5c31\u662f\u6709\u521d\u59cb\u503c\u4e0d\u540c\u7684\u96c6\u5408\u5408\u5e76\u3002\n\n\u7528\u5e76\u67e5\u96c6\u7ef4\u62a4\u521d\u59cb\u503c\u76f8\u540c\u7684\u96c6\u5408\uff0c\u8bb0 $f_i$ \u8868\u793a\u4e0b\u6807\u4e3a $i$ \u7684\u5143\u7d20\u7684\u96c6\u5408\u7f16\u53f7\uff0c\u6211\u4eec\u53ef\u4ee5\u5efa\u7acb\u4e00\u4e2a\u865a\u70b9\u4f5c\u4e3a\u96c6\u5408\u7684\u4ee3\u8868\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5757\u5185\u7b2c\u4e00\u4e2a\u5143\u7d20\uff0c\u8fd9\u91cc\u4f7f\u7528\u7b2c\u4e8c\u79cd\uff0c\u8f83\u4e3a\u7b80\u4fbf\u3002\n\n\u5bf9\u4e8e\u4fee\u6539\u64cd\u4f5c\uff0c\u6563\u5757\u76f4\u63a5\u66f4\u65b0\u5757\u5185\u503c\uff0c\u7136\u540e\u7edf\u8ba1\u4fee\u6539\u91cd\u6784\u3002\u6574\u5757\u6211\u4eec\u8003\u8651\u5408\u5e76\uff08\u82e5\u5757\u5185\u6709 $x$\uff09\uff1a\u82e5\u5757\u5185\u65e0 $y$\uff0c\u5219\u76f4\u63a5\u5c06\u5757\u5185\u7b2c\u4e00\u4e2a\u5143\u7d20\u7684\u503c\u6539\u4e3a $y$\uff0c\u5e76\u628a\u201c\u5757\u5185\u7b2c\u4e00\u4e2a\u503c\u4e3a $y$ \u7684\u4e0b\u6807\u201d\u66f4\u65b0\u6210 $x$\uff08\u56e0\u4e3a\u6b64\u65f6\u5757\u5185\u503c\u4e3a $x$ \u7684\u5168\u5458\u53d8\u6210\u4e86 $y$\uff09\uff1b\u82e5\u5757\u5185\u6709 $y$\uff0c\u6211\u4eec\u9700\u8981\u628a\u4ee3\u8868 $x$ \u7684\u70b9\u7684\u7236\u4eb2\u8bbe\u4e3a\u7b2c\u4e00\u4e2a $y$\u3002\u6b64\u5916\uff0c\u8fd8\u9700\u8981\u5f00\u4e2a\u6876\u7ef4\u62a4\u5757\u5185\u5143\u7d20\u4e2a\u6570\uff0c\u7ef4\u62a4\u5757\u5185\u548c\uff0c\u5df2\u7ecf\u5757\u5185\u9636\u4e58\u4e4b\u79ef\u7684\u9006\u5143\u3002**\u6700\u540e\uff0c\u6e05\u7a7a\u6709\u5173 $x$ \u7684\u6876\u548c\u7b2c\u4e00\u4e2a $x$ \u51fa\u73b0\u7684\u4e0b\u6807\uff08\u6e05\u7a7a\u5757\u5185\u6709\u5173 $x$ \u7684\u6570\u636e\uff09**\u3002\n\n**\u8fd9\u7c7b\u9898\u5f88\u5bb9\u6613\u67d0\u4e9b\u4e1c\u897f\u5fd8\u8bb0\u66f4\u65b0\u6216\u5fd8\u8bb0\u6e05\u7a7a\uff0c\u4e00\u5b9a\u8981\u6ce8\u610f\u3002**\n\n\u5bf9\u4e8e\u8be2\u95ee\u64cd\u4f5c\uff0c\u6563\u5757\u66b4\u529b\u83b7\u53d6\u503c\u7edf\u8ba1\uff0c\u6574\u5757\u5229\u7528\u7ef4\u62a4\u7684\u503c\u8ba1\u7b97\u5373\u53ef\u3002\n\n\u6709\u70b9\u5361\u7a7a\u95f4\uff0c\u7528 `int`\uff0c\u4f46\u5982\u679c\u4e00\u76f4\u5361\u53ef\u80fd\u662f\u51fd\u6570\u51fa\u4e86\u95ee\u9898\uff08\u4f8b\u5982\u6ca1\u6e05\u7a7a\u5bfc\u81f4\u6808\u7a7a\u95f4\u7206\u6389\uff09\u3002\n\n\u4ee3\u7801\u5982\u4e0b\uff1a\n\n```cpp\n\n#include<bits/stdc++.h>\nusing namespace std;\n\ninline int read(){\n\tint x=0,f=1;\n\tchar c=getchar();\n\twhile(c<'0'||c>'9'){\n\t\tif(c=='-')f=-1;\n\t\tc=getchar();\n\t}\n\twhile(c<='9'&&c>='0'){\n\t\tx=(x<<1)+(x<<3)+(c^48);\n\t\tc=getchar();\n\t}\n\treturn x*f;\n}\n\nvoid print(int x){\n\tif(x<0)putchar('-'),x=-x;\n\tif(x>9)print(x/10);\n\tputchar(x%10^48);\n}\n\nconst int N=1e5+5,SUM=1e7+5,mod=998244353,S=330;\n\nint qpow(int a,int b){\n\tint ans=1;\n\twhile(b){\n\t\tif(b&1)ans=1ll*ans*a%mod;\n\t\ta=1ll*a*a%mod;\n\t\tb>>=1;\n\t}\n\treturn ans;\n}\n\nint n,q,a[N],f[N],bel[N];\nint fac[SUM],invfac[N];\nint mul_invfac[N/S+5],R[N/S+5],sum[N/S+5],invpow[N][S+5],facpow[N][S+5];\nint fir[N/S+5][N],t[N/S+5][N];\n\ninline int find(int x){\n\treturn (x==f[x])?x:f[x]=find(f[x]);\n}\n\ninline void init(int maxn){\n\tfac[0]=invfac[0]=1;\n\tfor(int i=1;i<=maxn;++i)fac[i]=1ll*fac[i-1]*i%mod;//1e7 \n\tinvfac[N-5]=qpow(fac[N-5],mod-2);\n\tfor(int i=N-6;i>=1;--i)invfac[i]=1ll*invfac[i+1]*(i+1)%mod;//1e5\u5373\u53ef \n\tfor(int i=0;i<=N-5;++i){//\u9884\u5904\u7406\uff0c\u53ef\u4ee5\u53bb\u6389log \n\t\tinvpow[i][0]=facpow[i][0]=1;\n\t\tfor(int j=1;j<=S;++j){\n\t\t\tinvpow[i][j]=1ll*invpow[i][j-1]*invfac[i]%mod;\n\t\t\tfacpow[i][j]=1ll*facpow[i][j-1]*fac[i]%mod;\n\t\t}\n\t}\n}\n\ninline void remake(int k){\n\tmul_invfac[k]=1,sum[k]=0;\n\tfor(int i=R[k-1]+1;i<=R[k];++i){\n\t\tt[k][a[i]]++;\n\t\tif(t[k][a[i]]==1)fir[k][a[i]]=i;\n\t\tf[i]=fir[k][a[i]];\n\t\tsum[k]+=a[i];\n\t\tmul_invfac[k]=1ll*mul_invfac[k]*invfac[a[i]]%mod;\n\t}\n}\n\nvoid update(int k){\n\tfor(int i=R[k-1]+1;i<=R[k];++i){\n\t\ta[i]=a[find(i)];\n\t\tfir[k][a[i]]=t[k][a[i]]=0;//\u6e05\u7a7a \n\t}\n}\n\ninline void modify(int l,int r,int x,int y){\n\tif(bel[l]==bel[r]){\n\t\tupdate(bel[l]);//\u5224\u65ad\u6563\u5757\u524d\u8981\u5148\u83b7\u53d6a[i]\u7684\u771f\u5b9e\u503c \n\t\tfor(int i=l;i<=r;++i)if(a[i]==x)a[i]=y;\n\t\tremake(bel[l]);//\u91cd\u6784\u6b64\u5757 \n\t\treturn;\n\t}\n\tif(l!=R[bel[l]-1]+1){\n\t\tupdate(bel[l]);\n\t\tfor(int i=l;i<=R[bel[l]];++i)if(a[i]==x)a[i]=y;\n\t\tremake(bel[l]);\n\t\tl=R[bel[l]]+1;\n\t}\n\tif(r!=R[bel[r]]){\n\t\tupdate(bel[r]);\n\t\tfor(int i=R[bel[r]-1]+1;i<=r;++i)if(a[i]==x)a[i]=y;\n\t\tremake(bel[r]);\n\t\tr=R[bel[r]-1];\n\t}\n\tfor(int i=bel[l];i<=bel[r];++i){\n\t\tif(fir[i][x]){\n\t\t\tif(fir[i][y])f[fir[i][x]]=fir[i][y];//\u5408\u5e76x\u548cy \n\t\t\telse fir[i][y]=fir[i][x],a[fir[i][x]]=y;//\u76f4\u63a5\u6539 \n\t\t\tsum[i]+=(y-x)*t[i][x];\n\t\t\tmul_invfac[i]=1ll*mul_invfac[i]*facpow[x][t[i][x]]%mod*invpow[y][t[i][x]]%mod;\n\t\t\t//\u8fd9\u91cc\u6ce8\u610f\u7531\u4e8e\u7ef4\u62a4\u7684\u662f\u9006\u5143\uff0c\u6240\u4ee5\u4e58x\u7684\u9636\u4e58\u548cy\u9636\u4e58\u7684\u9006\u5143 \n\t\t\tt[i][y]+=t[i][x];\n\t\t\tt[i][x]=fir[i][x]=0;//\u8fd9\u91cc\u4e00\u5b9a\u8981\u6ce8\u610f\u4e24\u4e2a\u90fd\u8981\u6e05\u7a7a \n\t\t}\n\t}\n}\n\ninline int qry(int l,int r){\n\tint Sum=0,invMul=1,tmp;\n\tif(bel[l]==bel[r]){\n\t\tfor(int i=l;i<=r;++i)a[i]=a[find(i)],Sum+=a[i],invMul=1ll*invMul*invfac[a[i]]%mod;\n\t\treturn 1ll*fac[Sum]*invMul%mod;\n\t}\n\tif(l!=R[bel[l]-1]+1){\n\t\tfor(int i=l;i<=R[bel[l]];++i)a[i]=a[find(i)],Sum+=a[i],invMul=1ll*invMul*invfac[a[i]]%mod;\n\t\tl=R[bel[l]]+1;\n\t}\n\tif(r!=R[bel[r]]){\n\t\tfor(int i=R[bel[r]-1]+1;i<=r;++i)a[i]=a[find(i)],Sum+=a[i],invMul=1ll*invMul*invfac[a[i]]%mod;\n\t\tr=R[bel[r]-1];\n\t}\n\tfor(int i=bel[l];i<=bel[r];++i){\n\t\tSum+=sum[i],invMul=1ll*invMul*mul_invfac[i]%mod;\n\t}\n\treturn 1ll*fac[Sum]*invMul%mod;\n}\n\nsigned main(){\n\tn=read(),q=read();\n\tinit(1e7);\n\tfor(int i=1;i<=n;++i)a[i]=read();\n\tfor(int i=1;i<=n;++i)bel[i]=(i+S-1)/S;\n\tfor(int i=1;i<=n/S;++i)R[i]=i*S;\n\tif(n%S)R[bel[n]]=n;\n\tfor(int i=1;i<=bel[n];++i)remake(i);\n\tint opt,l,r,x,y;\n\twhile(q--){\n\t\topt=read(),l=read(),r=read();\n\t\tif(opt==1){\n\t\t\tx=read(),y=read();\n\t\t\tif(x==y)continue;//\u7279\u5224\uff0c\u5426\u5219\u5728\u6574\u5757\u4fee\u6539\u65f6\u4f1a\u6e05\u7a7ax \n\t\t\tmodify(l,r,x,y);\n\t\t}else print(qry(l,r)),puts(\"\");\n\t}\n\treturn 0;\n}\n\n```\n\n\u5982\u679c\u89c9\u5f97\u6709\u5e2e\u52a9\u53ef\u4ee5\u70b9\u4e2a\u8d5e\uff0c\u8c22\u8c22\u3002",
        "postTime": 1671683714,
        "uid": 271736,
        "name": "Daidly",
        "ccfLevel": 6,
        "title": "P8576 \u300cDTOI-2\u300d\u661f\u4e4b\u754c \u9898\u89e3"
    }
]