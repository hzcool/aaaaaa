[
    {
        "content": "[\u9898\u76ee\u94fe\u63a5](https://www.luogu.com.cn/problem/P7357)\n\n\n~~\u6211\u4e0d\u4f1a\u544a\u8bc9\u4f60\u6211\u662f\u56e0\u4e3a\u9898\u76ee\u80cc\u666f\u7684\u5934\u50cf\u4e0e\u6211\u4eec\u73ed\u4e3b\u4efb\u4e00\u6bdb\u4e00\u6837\u624d\u6765\u5199\u9898\u89e3\u7684~~\n\n\u9898\u610f\uff1a  \n\u7ed9\u51fa\u4e00\u68f5\u6811\uff0c\u70b9\u6709\u70b9\u6743\uff0c\u6bcf\u6b21\u5c06\u4e00\u4e2a\u70b9\u7684\u70b9\u6743\u5f02\u6216 $1$ \uff0c  \n\u6216\u7ed9\u51fa\u4e24\u4e2a\u70b9 $u,v$ \uff0c\u8be2\u95ee\u80fd\u8986\u76d6 $u,v$ \u7684\u8def\u5f84\u6240\u5f62\u6210\u7684\u5e8f\u5217\u7684\u4e2d\u4f4d\u6570\u6700\u5927\u503c\u3002  \n\u4fdd\u8bc1\u8fd9 $u,v$ \u4e0d\u5728\u4e00\u6761\u94fe\u4e0a\uff0c\u8fd9\u91cc\u4e2d\u4f4d\u6570\u6307\u957f\u4e3a $n$ \u7684\u5e8f\u5217\u4e2d\u7b2c $\\left\\lfloor\\frac{n+1}{2}\\right\\rfloor$ \u5927\u7684\u6570\u3002\n\n## $\\text{Step 1}$\n\n\u5148\u770b\u4e00\u4e0b\u8fd9\u79cd\u5b9a\u4e49\u4e0b\u7684\u4e2d\u4f4d\u6570\u7684\u6027\u8d28\uff1a\n\n\u5bf9\u4e8e\u4e00\u4e2a\u5e8f\u5217 $S,n=\\left|S\\right|$\n\n\u8bbe $g_a=|\\{i|s_i\\geq a,1\\leq i\\leq n\\}|,l_a=|\\{i|s_i< a,1\\leq i\\leq n\\}|$\n\n\u5219 $S$ \u7684\u4e2d\u4f4d\u6570\u5c31\u662f\u539f\u5e8f\u5217\u4e2d\u6ee1\u8db3 $g_a\\leq l_a$ \u7684\u6700\u5927\u7684 $a$ \n\n\u5982\u679c\u628a $\\geq a$ \u7684\u6570\u8bbe\u4e3a $1$ \uff0c\u628a $<a$ \u7684\u6570\u8bbe\u4e3a $-1$ \uff0c$a$ \u662f\u4e2d\u4f4d\u6570\u65f6\u5fc5\u987b\u8fd9\u4e9b $1$ \u4e0e $-1$ \u7684\u548c $\\geq 0$ \uff0c\u4e14 $a$ \u6700\u5927\u3002\n\n\u7531\u4e8e\u8bbe\u6210 $1$ \u4e0e $-1$ \u7684\u64cd\u4f5c\u5728 $a$ \u9012\u589e\u65f6 $-1$ \u589e\u591a\uff0c\u53ef\u4ee5\u5efa\u51fa\u4e00\u9897\u4e3b\u5e2d\u6811\u6765\u7ef4\u62a4\u3002\n\n\u8fd9\u5957\u8def\u5728 [\u6b64\u9898](https://www.luogu.com.cn/problem/P2839) \u4e2d\u66fe\u51fa\u73b0\u8fc7\u3002\n\n## $\\text{Step 2}$\n\n\u5bf9\u4e8e\u9898\u76ee\u4e2d\u7684\u6ee1\u8db3\u8986\u76d6 $u,v$ \u7684\u8def\u5f84\u7684\u4e2d\u4f4d\u6570\u6700\u5927\u503c\uff0c\u662f\u6709\u5355\u8c03\u6027\u7684\uff0c\u8003\u8651\u4e8c\u5206\u3002\n\n\u5bf9\u4e8e\u4e00\u4e2a\u4e8c\u5206\u7684\u503c $mid$ \u6211\u4eec\u5e0c\u671b\u5f97\u77e5\uff1a\u628a\u6811\u4e0a\u6bcf\u4e2a\u70b9\u6743 $\\geq mid$ \u7684\u70b9\u7684 **\u952e\u503c** \u8bbe\u6210 $1$ \uff0c\u628a\u70b9\u6743 $<mid$  \u7684\u70b9\u7684**\u952e\u503c** \u8bbe\u6210 $-1$ \u540e\uff0c\u67e5\u770b\u80fd\u8986\u76d6 $u,v$ \u8def\u5f84\u4e2d **\u952e\u503c\u7684\u548c\u7684\u6700\u5927\u503c** \u80fd\u5426 $\\geq 0$ \u3002\n\n\u7531\u4e8e\u8981\u8986\u76d6 $u,v$ \u4e14 $u,v$ \u4e0d\u5728\u4e00\u6761\u8def\u5f84\u4e0a\uff0c\u8003\u8651\u6811\u4e0a\u5dee\u5206\u3002\n\n\u8bbe $f_x^a=\\text{a\u65f6x\u5230\u6839\u8def\u5f84\u952e\u503c\u4e4b\u548c}$\n\n\u6240\u4ee5\u4e8c\u5206\u65f6\u8981\u6c42\u7684\u952e\u503c\u7684\u548c\u7684\u6700\u5927\u503c\u5c31\u662f\uff1a  \n\n$\\max\\limits_{x\\in \\operatorname{subtree}(u)}f_x^{mid}+\\max\\limits_{y\\in \\operatorname{subtree}(v)}f_y^{mid}-2f_{\\operatorname{lca}(u,v)}^{mid}+w_{\\operatorname{lca}(u,v)}^{mid}$\n\n\u5176\u4e2d $w_x^{a}$ \u4ee3\u8868 $a$ \u65f6 $x$ \u7684\u952e\u503c\u3002\n\n\u4e8e\u662f\u5e0c\u671b\u5bf9\u6bcf\u4e2a $a$ \u7ef4\u62a4 $dfs$ \u5e8f\u6240\u4ee3\u8868\u7684\u70b9\u7684 $f_x^a$ \u503c\uff0c\u8fd9\u6837\u5c31\u5bb9\u6613\u67e5\u8be2\u5b50\u6811\u6700\u5927\u503c\u3002\n\n## $\\text{Step 3}$\n\n\u8003\u8651\u5982\u4f55\u7528\u4e3b\u5e2d\u6811\u7ef4\u62a4 $f_x^a$ \u503c\u3002\n\n\u5bf9\u4e8e $a=0$ \u65f6\uff0c$f_x^a=\\operatorname{dep}(x)$ \uff0c\u5373 $x$ \u7684\u6df1\u5ea6\uff0c\u56e0\u4e3a\u6240\u6709\u70b9\u7684\u70b9\u6743 $\\geq 0$ \u3002\n\n\u5f53 $a$ \u53d8\u5927\u65f6\u4f1a\u5bfc\u81f4\u4e00\u4e9b\u70b9\u7684\u952e\u503c\u4ece $1$ \u53d8\u6210 $-1$ \n\n\u90a3\u8fd9\u4e9b\u70b9\u7684\u5b50\u6811\u5185\u7684\u6240\u6709\u70b9\u7684 $f^a$ \u503c\u5c31\u4f1a $-2$ \u3002\n\n\u7531\u4e8e\u4e3b\u5e2d\u6811\u662f\u4ee5 $dfs$ \u5e8f\u4e3a\u4e0b\u6807\u5efa\u7684\uff0c\u8fd9\u76f8\u5f53\u4e8e\u533a\u95f4\u51cf\u5e76\u53ef\u6301\u4e45\u5316\u3002\n\n\u8fd9\u53ef\u4ee5\u7528 **\u6807\u8bb0\u6c38\u4e45\u5316** \u8f7b\u677e\u5b9e\u73b0\u3002\n\n## $\\text{Step 4}$\n\n\u73b0\u5728\u53ea\u5269\u4e0b\u6700\u540e\u4e00\u4e2a\u95ee\u9898\uff1a\u628a\u70b9\u6743\u5f02\u6216 $1$\n\n\u5f00\u59cb\u5efa\u4e3b\u5e2d\u6811\u65f6\u987a\u4fbf\u628a\u6bcf\u4e2a\u70b9\u7684\u70b9\u6743\u5f02\u6216 $1$ \u540e\u7684\u503c\u987a\u5e26\u7740\u79bb\u6563\u5316\u5e76\u5efa\u4e3b\u5e2d\u6811\u3002\n\n\u7531\u4e8e\u5f02\u6216 $1$ \u540e\u4e00\u4e2a\u70b9\u7684\u70b9\u6743\u8981\u4e48\u53d8\u5927\u4e00\uff0c\u8981\u4e48\u51cf\u5c0f\u4e00\u3002\n\n\u8bbe $t_x=2\\left\\lfloor\\frac{x}{2}\\right\\rfloor+1$ \uff0c\u5373\u4e0d\u6bd4 $x$ \u5c0f\u7684\u6700\u5c0f\u7684\u5947\u6570\u3002\n\n\u90a3\u4e48 $a>t_x$ \u7684\u7248\u672c\u65e0\u8bba\u5982\u4f55\u90fd\u4e0d\u53d1\u751f\u6539\u53d8\uff0c\u56e0\u4e3a$\\max(x,x\\operatorname{xor}1)\\leq t_x$\n\n\u800c $a\\leq t_x-1$ \u7684\u7248\u672c\u540c\u6837\u4e0d\u53d1\u751f\u53d8\u5316\uff0c\u56e0\u4e3a $\\min(x,x\\operatorname{xor}1)\\geq t_x-1$\n\n\u6240\u4ee5\u53d7\u6539\u52a8\u7684\u7248\u672c\u4ec5\u6709 $t_x$ \u4e00\u4e2a\u3002\n\n#### \u82e5 $x$ \u4e3a\u5947\u6570\uff0c $t_x=x$ , \u5f02\u6216\u540e\u53d8\u5c0f\u6210  $x-1$ \u3002\n\n\u90a3\u539f\u5148 $x$ \u7684\u7248\u672c\u4e2d\u8fd9\u4e2a\u70b9\u7684\u952e\u503c\u4e3a $1$ \uff0c\u6743\u503c\u53d8\u5c0f\u540e\u8981\u6210\u4e3a $-1$ \n\n\u6240\u4ee5\u5c06 $x$ \u7684\u7248\u672c\u4e2d\u8fd9\u4e2a\u70b9\u7684\u5b50\u6811\u5185\u6240\u6709\u70b9\u7684 $f$ \u503c  $-2$ \n\n#### \u82e5 $x$ \u4e3a\u5076\u6570\uff0c $t_x=x+1$ \uff0c\u5f02\u6216\u540e\u53d8\u5927\u6210 $x+1$\n\n\n\u90a3\u539f\u5148 $x+1$ \u7684\u7248\u672c\u4e2d\u8fd9\u4e2a\u70b9\u7684\u952e\u503c\u4e3a $-1$ \uff0c\u6743\u503c\u53d8\u5927\u540e\u8981\u6210\u4e3a $1$ \n\n\u6240\u4ee5\u5c06 $x+1$ \u7684\u7248\u672c\u4e2d\u8fd9\u4e2a\u70b9\u7684\u5b50\u6811\u5185\u6240\u6709\u70b9\u7684 $f$ \u503c  $+2$ \n\n\u8fd9\u540c\u6837\u53ef\u7528\u6807\u8bb0\u6c38\u4e45\u5316\u5b9e\u73b0\u3002\n\n## $\\text{Step 5}$\n\n\u9884\u5904\u7406\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n\\log n)$ \n\n\u66f4\u6539\u70b9\u6743\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u5355\u6b21\u4e3a $O(\\log n)$\n\n\u67e5\u8be2\u8981\u5957\u4e2a\u4e8c\u5206\uff0c\u5355\u6b21 $O(\\log^2 n)$\n\n### \u4ee3\u7801\uff1a\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nconst int N=2e5+10;\nint n,m,nn,x,y,opt,tot,tt,l,L,R,mid,cnt,qx,qy;\nint a[N],b[N],rt[N],ii[N];\nint dfn[N],rev[N],sz[N],dep[N],f[N][20];\nint to[N],nextn[N],h[N],edg;char ch;\ninline void add(int x,int y){to[++edg]=y,nextn[edg]=h[x],h[x]=edg;}\n#define id(x) lower_bound(b+1,b+nn+1,x)-b\nstruct tree{int l,r,tag,mx;}t[N<<5];\ninline void read(int &x){\n\tx=0;ch=getchar();while(ch<48||ch>57)ch=getchar();\n\twhile(ch>47&&ch<58)x=(x<<1)+(x<<3)+(ch^48),ch=getchar();\n}\nvoid write(int x){if(x>9)write(x/10);putchar(48+x%10);}\nvoid build(int &k,int l,int r){\n\tk=++tot;\n\tif(l^r){\n\t\tint mid=(l+r)>>1;\n\t\tbuild(t[k].l,l,mid);build(t[k].r,mid+1,r);\n\t\tt[k].mx=max(t[t[k].l].mx,t[t[k].r].mx);\n\t}\n\telse t[k].mx=dep[rev[l]];\n}\nvoid update(int &k,int kk,int l,int r,int x,int y,int v){\n\tk=++tot;t[k]=t[kk];\n\tif(x<=l&r<=y)t[k].tag+=v,t[k].mx+=v;\n\telse {\n\t\tint mid=(l+r)>>1;\n\t\tif(x<=mid)update(t[k].l,t[kk].l,l,mid,x,y,v);\n\t\tif(mid<y)update(t[k].r,t[kk].r,mid+1,r,x,y,v);\n\t\tt[k].mx=max(t[t[k].l].mx,t[t[k].r].mx)+t[k].tag;\n\t}\n}\nint inquiry(int k,int l,int r,int pos){\n\tif(l^r){\n\t\tint mid=(l+r)>>1;\n\t\tif(pos<=mid)return inquiry(t[k].l,l,mid,pos)+t[k].tag;\n\t\telse return inquiry(t[k].r,mid+1,r,pos)+t[k].tag;\n\t}\n\telse return t[k].mx;\n}\nint inquiry_mx(int k,int l,int r,int x,int y){\n\tif(x<=l&&r<=y)return t[k].mx;\n\tint mid=(l+r)>>1;\n\tif(x<=mid&&mid<y)\n\t\treturn max(inquiry_mx(t[k].l,l,mid,x,y),inquiry_mx(t[k].r,mid+1,r,x,y))+t[k].tag;\n\telse if(x<=mid)return inquiry_mx(t[k].l,l,mid,x,y)+t[k].tag;\n\telse return inquiry_mx(t[k].r,mid+1,r,x,y)+t[k].tag;\n}\nvoid init(int x,int anc){\n\tint i,y;rev[dfn[x]=++tt]=x;\n\tsz[x]=1;dep[x]=dep[anc]+1;f[x][0]=anc;\n\tfor(i=1;i^20;++i)f[x][i]=f[f[x][i-1]][i-1];\n\tfor(i=h[x];y=to[i],i;i=nextn[i])if(y^anc)init(y,x),sz[x]+=sz[y];\n\th[x]=0;\n}\nint lca(int x,int y){\n\tint i;if(dep[x]<dep[y])x^=y^=x^=y;\n\tfor(i=19;~i;--i)if(dep[f[x][i]]>=dep[y])x=f[x][i];\n\tif(x==y)return x;\n\tfor(i=19;~i;--i)if(f[x][i]^f[y][i])x=f[x][i],y=f[y][i];\n\treturn f[x][0];\n}\nmain(){\n\tread(n);read(m);register int i,j;\n\tfor(i=1;i<=n;++i){read(a[i]),b[++nn]=a[i];if(a[i]^1)b[++nn]=a[i]^1;}\n\tsort(b+1,b+nn+1);nn=unique(b+1,b+nn+1)-b-1;\n\tfor(i=1;i^n;++i)read(x),read(y),add(x,y),add(y,x);\n\tinit(1,0);edg=0;build(rt[0],1,n);\n\tfor(i=1;i<=n;++i)add(ii[i]=id(a[i]),i),ii[i]+=(a[i]&1)^1;\n\tfor(i=1;rt[i]=rt[i-1],i<=nn;++i)for(j=h[i-1];x=to[j],j;j=nextn[j])\n\t\tupdate(rt[i],rt[i],1,n,dfn[x],dfn[x]+sz[x]-1,-2);\n\twhile(m--){\n\t\tread(opt);read(x);\n\t\tif(opt==1){\n\t\t\ti=ii[x];\n\t\t\tif(a[x]&1)update(rt[i],rt[i],1,n,dfn[x],dfn[x]+sz[x]-1,-2);\n\t\t\telse update(rt[i],rt[i],1,n,dfn[x],dfn[x]+sz[x]-1,2);\n\t\t\ta[x]^=1;\n\t\t}\n\t\telse {\n\t\t\tread(y);l=lca(x,y);\n\t\t\tL=0;R=nn;\n\t\t\twhile(L<R){\n\t\t\t\tmid=L+R+1>>1;cnt=0;\n\t\t\t\tcnt+=inquiry_mx(rt[mid],1,n,dfn[x],dfn[x]+sz[x]-1);\n\t\t\t\tcnt+=inquiry_mx(rt[mid],1,n,dfn[y],dfn[y]+sz[y]-1);\n\t\t\t\tcnt-=(inquiry(rt[mid],1,n,dfn[l])<<1)+(a[l]>=b[mid]?-1:1);\n\t\t\t\tif(cnt>=0)L=mid;else R=mid-1;\n\t\t\t}\n\t\t\twrite(b[L]);putchar('\\n');\n\t\t}\n\t}\n}\n```",
        "postTime": 1633249215,
        "uid": 334380,
        "name": "Y_B_X",
        "ccfLevel": 7,
        "title": "\u9898\u89e3[P7357 \u4e2d\u4f4d\u6570]"
    }
]