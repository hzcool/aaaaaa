[
    {
        "content": "upd\uff1a\u6539\u6b63\u4e86\u4e00\u5904\u7b14\u8bef\uff08\u5c06 `l` \u6253\u6210\u4e86 `1`\uff09\n\n\u9a8c\u9898\u4eba\u53c8\u6765\u6c34\u9898\u89e3\u4e86\u3002\n\n```cpp\nfor(rgi i=1;i<=n;++i){\n\tfor(rgi j=1;j<=i;++j)dp[i]=max(dp[i],dp[j-1]+sum(j,i,ma[j][i]));\n}\n```\n\n\u8003\u8651\u8fd9\u4e2a $n^2$ \u7684 dp\uff0c\u5176\u4e2d $dp_i$ \u8868\u793a\u524d $i$ \u4e2a\u6570\u7684\u7b54\u6848\uff0c$\\textrm{sum}(l,r,x)$ \u8868\u793a\u201c\u5c06 $[l,r]$ \u90fd\u6539\u4e3a $x$ \u53d6\u5f97\u7684\u6536\u76ca\u201d\uff0c$ma_{l,r}$ \u8868\u793a $[l,r]$ \u7684 range_max\u3002\n\n\u770b\u4f3c\u4e0d\u5927\u80fd\u4f18\u5316\uff0c\u5176\u5b9e\u662f\u53ef\u4ee5\u7684\u3002\u8bb0 $s_{l,r}=\\textrm{sum}(l,r,ma_{l,r})$\uff0c\u4e5f\u5c31\u662f\u201c\u5728 $[l,r]$ \u4e3e\u884c\u4e00\u573a\u4f5c\u5f0a\u7684\u6536\u76ca\u201d\u3002\u4ee4 $t$ \u65f6\u523b\u7684 $S_i$ \u8868\u793a $s_{i,t}$\uff0c\u53ea\u8981\u6211\u4eec\u5728 dp \u7684\u8fc7\u7a0b\u4e2d\u80fd\u968f\u7740\u65f6\u95f4\u6709\u6548\u7ef4\u62a4 $S$ \u6570\u7ec4\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528\u7ebf\u6bb5\u6811\u4f18\u5316\u8fd9\u4e2a dp \u89e3\u51b3\u95ee\u9898\u3002\n\n\u8003\u8651\u5206\u5f00\u8ba1\u7b97\u6bcf\u4e2a\u4eba\u7684\u8d21\u732e\u3002\u5bf9\u4e8e\u4e00\u4e2a\u4eba $(a_x,l_x,r_x)$\uff0c\u5b83\u5bf9\u4e00\u4e2a\u533a\u95f4 $[L,R]$ \u4ea7\u751f\u8d21\u732e\u5f53\u4e14\u4ec5\u5f53 $ma_{L,R}\\in [l_x,r_x],x\\in [L,R]$\u3002\n\n\u628a\u5b83\u5199\u6210 $\\max(ma_{L,x},ma_{x,R})\\in [l_x,r_x]$\uff0c\u6362\u53e5\u8bdd\u8bf4\u4e5f\u5c31\u662f\uff1a$ma_{L,x},ma_{x,R}$ \u90fd\u8981 $\\leq r_x$\uff0c\u4e14\u5176\u4e2d\u81f3\u5c11\u4e00\u4e2a $\\geq l_x$\u3002\n\n\u6211\u4eec\u5206\u522b\u9884\u5904\u7406\u51fa $ma_{L,x},ma_{x,R}\\in [l_x,r_x]$ \u7684 $L,R$ \u7684\u8303\u56f4\uff0c\u8bb0\u4e3a $[Ll_x,Lr_x],[Rl_x,Rr_x]$\u3002\u6240\u4ee5\u5f53 $i\\in[x,Rl_x)$ \u65f6\uff0c$L$ \u7684\u8303\u56f4\u662f $[Ll_x,Lr_x]$\uff1b\u5f53 $i\\in[Rl_x,Rr_x]$ \u65f6\uff0c$L$ \u7684\u8303\u56f4\u662f $[Ll_x,x]$\uff1b\u5f53 $i>Rr_x$ \u65f6\uff0c\u6ca1\u6709\u8d21\u732e\u3002\n\n\u6211\u4eec\u5728 $i$ \u5230\u8fbe\u51e0\u4e2a\u4e34\u754c\u70b9\u7684\u65f6\u5019\uff0c\u901a\u8fc7\u7ebf\u6bb5\u6811\u7684\u533a\u95f4\u52a0\u64cd\u4f5c\u66f4\u65b0 $x$ \u7684\u8d21\u732e\u533a\u95f4\u5373\u53ef\u3002\n\n\u8fd9\u6837\u7684\u590d\u6742\u5ea6\u662f $O(n \\log n)$\uff0c\u53ef\u4ee5\u901a\u8fc7\u6b64\u9898\u3002\n\n\u6838\u5fc3\u4ee3\u7801\uff1a\n\n```cpp\nfor(rgi i=1;i<=n;++i){\n\tif(a[i][0]>r[i])continue;\n\tll[i]=lr[i]=rl[i]=rr[i]=i;\n\tfor(rgi w=LOG;~w;--w){\n\t\tchg(rl[i],w,l[i]-1,1),chg(rr[i],w,r[i],1);\n\t\tchg(lr[i],w,l[i]-1,-1),chg(ll[i],w,r[i],-1);\n\t}\n\tif(a[lr[i]][0]<l[i])--lr[i];\n\tif(a[rl[i]][0]<l[i])++rl[i];\n\tv[i].push_back(opt{ll[i],lr[i],1});\n\tv[rl[i]].push_back(opt{lr[i]+1,i,1});\n\tv[rr[i]+1].push_back(opt{ll[i],i,-1});\n}\nfor(rgi i=1;i<=n;++i){\n\tfor(opt o:v[i])upd(o);\n\tupd(opt{i+1,i+1,ans=qry(1,0,n,0,n)});\n}\n```\n\n\n",
        "postTime": 1617845489,
        "uid": 78372,
        "name": "M4_SOPMODII_JR",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P7503 \u300cHMOI R1\u300d\u6587\u5316\u8bfe"
    },
    {
        "content": "[\u9898\u4f20](https://www.luogu.com.cn/problem/P7503)\n\n\u5148\u60f3\u4e00\u4e2a\u5de8 shaber \u7684\u66b4\u529b DP\uff1a\u8bbe $f_{i}$ \u4e3a\u5bf9\u524d $i$ \u4e2a\u4eba\u5206\u6bb5\u7684\u6700\u4f18\u89e3\uff0c\u5219\uff1a\n\n$$f_{i}=\\max_{0\\le j<i}\\{f_{j}+\\operatorname{W}(j+1, i)\\}$$\n\n\u5176\u4e2d\uff1a\n\n$$\\operatorname{W}(x, y)=\\sum_{i=x}^y [l_i \\le \\max(x_j|j\\in [x, y]) \\le r_i]$$\n\n\u66b4\u529b\u505a\u663e\u7136\u662f $(n^2)$ \u7684\uff0c\u8003\u8651\u4f18\u5316\u3002\n\n\u5982\u679c\u8003\u8651\u5c06\u51b3\u7b56\u4e2d\u7684 $i$ \u53f3\u79fb\u4e00\u4f4d\uff0c\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4 $val_i(x)=f_{x-1}+\\operatorname{W}(x, i)$ \u7684\u8bdd\uff0c\u53d1\u73b0\u53f3\u79fb\u65f6\u65e0\u6cd5\u5feb\u901f\u4fee\u6539\u6709\u53d8\u5316\u7684\u4f4d\u7f6e\uff08\u7c7b\u4f3c $+1\\ 0\\ 0\\ +1\\dots$ \u72b6\u7269\uff0c\u4e0d\u597d\u7ef4\u62a4\uff09\u3002\n\n\u6b63\u96be\u5219\u53cd\uff0c\u8003\u8651\u67d0\u4e2a $j$ \u4f1a\u5bf9\u54ea\u4e9b\u51b3\u7b56\u4f4d\u7f6e $(x, i)$ \u6709\u8d21\u732e\u3002\n\n\u6211\u4eec\u5c06\u5224\u65ad\u6761\u4ef6 $\\max(x_p | p \\in [x, i])$ \u62c6\u6210\u4e24\u90e8\u5206\uff1a $\\max(x_p | p \\in [x, j])$ \u548c $\\max(x_p | p \\in [j, i])$\u3002\n\n\u4e0d\u96be\u753b\u51fa\u4e0b\u56fe\uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/0fis6r9e.png)\n\n\u5148\u8003\u8651 $i\\in [l2, r2]$\uff0c\u5bf9\u4e8e\u8fd9\u4e00\u6bb5\u4f4d\u7f6e\uff0c$i$ \u5df2\u7ecf\u6ee1\u8db3\u4e86 $l_j \\le \\max(x_p | p \\in [j, i]) \\le r_j$\uff0c\u90a3\u4e48 $x$ \u53ea\u8981\u5728 $[R_j, j]$ \u4e4b\u95f4\u5373\u53ef\u3002\n\n\u7136\u540e\u662f $i\\in [j, l2)$\uff0c\u6b64\u65f6 $x$ \u5c31\u5fc5\u987b\u6ee1\u8db3 $l_j \\le \\max(x_p | p \\in [x, j]) \\le r_j$\uff0c\u5373 $x \\in [r1, l1]$\u3002\n\n\u5bf9\u4e8e $i > r2$\uff0c\u663e\u7136 $j$ \u5df2\u7ecf\u8d21\u732e\u4e0d\u5230\u4e86\u3002\n\n\u7136\u540e\u4f60\u5c31\u53d1\u73b0\u6bcf\u4e2a $j$ \u8d21\u732e\u5230\u7684 $i$ \u662f\u8fde\u7eed\u7684\uff0c\u800c\u4e14\u5bf9\u4e8e\u6bcf\u4e2a\u88ab\u8d21\u732e\u5230\u7684 $i$\uff0c\u51fd\u6570 $\\operatorname{W}$ \u533a\u95f4\u5de6\u7aef\u70b9 $x$ \u4e5f\u662f\u8fde\u7eed\u7684\u3002\n\n\u6240\u4ee5\u6211\u4eec\u5728 $j$ \u5904\u585e\u4e00\u4e2a $[r1, l1]$ \u533a\u95f4 +1 \u7684\u64cd\u4f5c\uff0c\u5728 $l2$ \u5904\u585e\u4e00\u4e2a $(l1, j]$ \u533a\u95f4 +1 \u7684\u64cd\u4f5c\uff08$[r1, l1]$ \u5728\u524d\u9762\u5df2\u7ecf\u88ab\u52a0\u8fc7\u4e00\u6b21\u4e86\uff09\u3002\n\n\u7136\u540e\u5728 $r2+1$ \u7684\u4f4d\u7f6e\u585e\u4e00\u4e2a\u6d88\u9664\u8d21\u732e\u7684\u533a\u95f4 -1 \u64cd\u4f5c\u5373\u53ef\u3002\n\n\u64cd\u4f5c\u6570\u663e\u7136\u662f $O(n)$ \u7684\uff0c$l1, l2, r1, r2$ \u53ef\u4ee5\u5355\u8c03\u6808\u540e\u4e8c\u5206\u627e\u3002\n\n\u603b\u590d\u6742\u5ea6 $O(n\\log n)$\u3002\n\n\n### Code\n\n```cpp\n#include <stdio.h>\n#include <algorithm>\n#include <string.h>\n#include <cctype>\n#include <vector>\n#define st first\n#define nd second\nusing namespace std;\ntypedef long long ll;\ntypedef pair <int, int> Pii;\nconst int INF=0x3f3f3f3f;\nconst int mo=1e9+7;\ninline int read(){\n\tchar ch=getchar();int x=0, f=1;\n\twhile(!isdigit(ch)){if(ch=='-') f=-1; ch=getchar();}\n\twhile(isdigit(ch)){x=(x<<3)+(x<<1)+ch-'0';ch=getchar();}\n\treturn x*f;\n}\ninline void write(int x){\n    if(x<0) putchar('-'), x=-x;\n    if(x>9) write(x/10);\n    putchar(x%10+'0');\n}\ninline int ksm(int a, int b){\n\tint ret=1;\n\tfor(; b; b>>=1, a=1ll*a*a%mo)\n\t\tif(b&1) ret=1ll*ret*a%mo;\n\treturn ret;\n}\nconst int N=1e5+5;\nnamespace Segment{\n\t#define ls k<<1\n\t#define rs k<<1|1\n\t#define mid (l+r>>1)\n\tint Mx[N*4], tag[N*4];\n\tvoid build(){\n\t\tmemset(Mx, -9, sizeof(Mx));\n\t\tmemset(tag, 0, sizeof(tag));\n\t}\n\tvoid upd(int k, int v){Mx[k]+=v, tag[k]+=v;}\n\tvoid pushdown(int k){if(tag[k]) upd(ls, tag[k]), upd(rs, tag[k]), tag[k]=0;}\n\tvoid pushup(int k){Mx[k]=max(Mx[ls], Mx[rs]);}\n\tvoid change(int k, int l, int r, int x, int v){\n\t\tif(l==r) return (void)(Mx[k]=max(Mx[k], v));pushdown(k);\n\t\tif(x<=mid) change(ls, l, mid, x, v);\n\t\telse change(rs, mid+1, r, x, v);\n\t\tpushup(k);\n\t}\n\tvoid modify(int k, int l, int r, int x, int y, int v){\n\t\tif(x>y) return ;//if(k==1) printf(\"make %d %d %d\\n\", x, y, v);\n\t\tif(x<=l&&r<=y) return upd(k, v);pushdown(k);\n\t\tif(x<=mid) modify(ls, l, mid, x, y, v);\n\t\tif(mid<y) modify(rs, mid+1, r, x, y, v);\n\t\tpushup(k);\n\t}\n\t#undef ls\n\t#undef rs\n\t#undef mid\n}\nint n, a[N], la[N], ra[N], f[N];\nPii L[N], R[N];\nvector < pair<Pii, int> > op[N];\nint sta[N], top=0;\nint find(int x){\n\tint l=1, r=top, ans=0;\n\twhile(l<=r){\n\t\tint mid=l+r>>1;\n\t\tif(a[sta[mid]]>=x) l=mid+1, ans=mid;\n\t\telse r=mid-1;\n\t}\n\treturn sta[ans];\n}\nsigned main(){\n\tn=read();\n\tfor(int i=1; i<=n; ++i) a[i]=read();\n\tfor(int i=1; i<=n; ++i) la[i]=read(), ra[i]=read();\n\ttop=0;\n\tfor(int i=1; i<=n; ++i){\n\t\twhile(top&&a[sta[top]]<a[i]) --top;\n\t\tsta[++top]=i;L[i]=make_pair(find(la[i]), find(ra[i]+1)+1);\n\t}\n\tsta[top=0]=n+1;\n\tfor(int i=n; i>=1; --i){\n\t\twhile(top&&a[sta[top]]<a[i]) --top;\n\t\tsta[++top]=i;R[i]=make_pair(find(la[i]), find(ra[i]+1));\n\t\t// printf(\"(%d %d)\\n\", R[i].first, R[i].second-1);\n\t}\n\tfor(int i=1; i<=n; ++i)\n\t\tif(a[i]<=ra[i])\n\t\t\top[i].push_back(make_pair((Pii){L[i].nd, L[i].st}, 1)),\n\t\t\top[R[i].st].push_back(make_pair((Pii){L[i].st+1, i}, 1)),\n\t\t\top[R[i].nd].push_back(make_pair((Pii){L[i].nd, i}, -1));\n\tint ans=0;Segment :: build();\n\tfor(int i=1; i<=n; ++i){\n\t\t// printf(\"for %d\\n\", i);\n\t\tSegment :: change(1, 1, n, i, f[i-1]);\n\t\tfor(auto x : op[i])\n\t\t\tSegment :: modify(1, 1, n, x.st.st, x.st.nd, x.nd);\n\t\tf[i]=Segment :: Mx[1];\n\t\t// printf(\"find %d\\n\", f[i]);\n\t\tans=max(f[i], ans);\n\t}\n\tprintf(\"%d\\n\", ans);\n\treturn 0;\n}\n\n\n```",
        "postTime": 1664642494,
        "uid": 341102,
        "name": "ReKoJ",
        "ccfLevel": 0,
        "title": "P7503 \u300cHMOI R1\u300d\u6587\u5316\u8bfe"
    },
    {
        "content": "## 1.\u66b4\u529b\n\n\u601d\u8003\u4e00\u79cd\u66b4\u529b\u7684\u52a8\u6001\u89c4\u5212\uff1a\n\n\u8bbe $ f_i $ \u8868\u793a\u524d $ i $ \u4e2a\u6570\u7684\u7b54\u6848\uff0c\u53ef\u4ee5\u5f97\u51fa\u8f6c\u79fb\u65b9\u7a0b $ f_i = f_j + sum_{i,j}$\uff0c\u5176\u4e2d $ sum_{i,j} $ \u8868\u793a $ i $ \u5230 $ j $ \u8fdb\u884c\u4ea4\u6d41\u65f6\u8fd9\u4e2d\u95f4\u4f1a\u6709\u591a\u5c11\u4eba\u8fbe\u5230\u7b26\u5408\u8981\u6c42\u7684\u6210\u7ee9\u3002  \n\u663e\u7136\uff0c\u8fd9\u4e2a $ sum $ \u662f\u53ef\u4ee5\u9884\u5904\u7406\u51fa\u6765\u7684\uff0c\u8fd9\u4e2a\u66b4\u529b\u6253\u724c\u7684\u590d\u6742\u5ea6\u53d6\u51b3\u4e8e\u4f60\u9884\u5904\u7406\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u3002\n\n## 2.\u6b63\u89e3\n\n\u8003\u8651\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u4f4d\u7f6e\u53c2\u4e0e\u8d21\u732e\u7684\u533a\u95f4\u3002\n\n\u9996\u5148\uff0c\u9884\u5904\u7406\u51fa\u56db\u4e2a\u503c\uff0c\u5206\u522b\u8868\u793a\uff1a  \n\n\u7b2c $ i $ \u4e2a\u70b9\u5de6\u8fb9\u7b2c\u4e00\u4e2a\u5927\u4e8e\u7b49\u4e8e $ l_i $ \u7684\u503c\u7684\u4f4d\u7f6e\uff1b  \n\u5de6\u8fb9\u7b2c\u4e00\u4e2a\u5927\u4e8e $ r_i $ \u7684\u503c\u7684\u4f4d\u7f6e\uff1b  \n\u53f3\u8fb9\u7b2c\u4e00\u4e2a\u5927\u4e8e\u7b49\u4e8e $ l_i $ \u7684\u503c\u7684\u4f4d\u7f6e\uff1b  \n\u53f3\u8fb9\u7b2c\u4e00\u4e2a\u5927\u4e8e $ r_i $ \u7684\u503c\u7684\u4f4d\u7f6e\u3002\n\n\u9884\u5904\u7406\u53ef\u4ee5\u7528\u6811\u72b6\u6570\u7ec4\u6765\u7ef4\u62a4\u3002\n\n\u7136\u540e\u679a\u4e3e\u6bcf\u4e2a\u4eba\uff0c\u628a\u4ed6\u6210\u529f\u53ca\u683c\u7684\u6700\u5927\u533a\u95f4\u6bcf\u4e2a\u6570\u90fd\u52a0\u4e00\uff0c\u5f53\u679a\u4e3e\u5230\u4e86\u533a\u95f4\u7684\u6700\u53f3\u70b9\u65f6\uff0c\u5c31\u628a\u4ed6\u7684\u8d21\u732e\u7ed9\u5220\u53bb\u3002\u533a\u95f4\u4fee\u6539\u548c\u67e5\u8be2\u6700\u5927\u503c\u8fd9\u4e24\u4e2a\u64cd\u4f5c\uff0c\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\uff0c\u6700\u540e\u7b54\u6848\u5c31\u662f\u7ebf\u6bb5\u6811\u4e2d\u7684\u6700\u5927\u503c\u3002\n\n## 3.\u4ee3\u7801\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n#define INF 1145141919\nconst int BUFFER=1<<20;\nchar RB[BUFFER],*RP=RB,*RT=RB;\n#define getchar() RP==RT?(RT=RB+fread(RB,1,BUFFER,stdin),RP=RB,*RP++):*RP++\ninline int read()\n{\n\tint x=0,f=1;char ch=getchar();\n\twhile(ch<'0'||ch>'9')\t{if(ch=='-')f=-1;ch=getchar();}\n\twhile('0'<=ch&&ch<='9')\t{x=x*10+ch-48;ch=getchar();}\n\treturn x*f;\n}\nint n;\nconst int maxn=2e5+10;\nint a[maxn],l[maxn],r[maxn];\nint c[maxn];\nint mx[maxn<<2],tag[maxn<<2];\n#define ls rt<<1\n#define rs rt<<1|1\n#define mid ((l+r)>>1)\ninline int lowbit(int x)\t{return x&(-x);}\ninline void add(int x,int d)\t{for(;x;x-=lowbit(x))\tc[x]=max(c[x],d);}\ninline int getsum(int x)\t{int s=0;for(;x<=n;x+=lowbit(x))\ts=max(s,c[x]);return s;}\ninline void pushup(int rt)\t{mx[rt]=max(mx[ls],mx[rs])+tag[rt];}\nvoid update(int rt,int l,int r,int L,int R,int d)\n{\n\tif(L<=l&&r<=R)\n\t{\n\t\tmx[rt]+=d,tag[rt]+=d;\n\t\treturn ;\n\t}\n\tif(L<=mid)\tupdate(ls,l,mid,L,R,d);\n\tif(mid<R)\tupdate(rs,mid+1,r,L,R,d);\n\tpushup(rt);\n}\nint ll[maxn],lr[maxn],rl[maxn],rr[maxn];\nvector <int> u[maxn],v[maxn];\nsigned main(){\n\tn=read();\n\tfor(int i=1;i<=n;++i)\ta[i]=read();\n\tfor(int i=1;i<=n;++i)\tl[i]=read(),r[i]=read();\n\tfor(int i=1;i<=n;++i)\n\t{\n\t\tadd(a[i],i);\n\t\tll[i]=getsum(l[i]),lr[i]=getsum(r[i]+1);\n\t}\n\tmemset(c,0,sizeof(c));\n\tfor(int i=n;i;--i)\n\t{\n\t\tadd(a[i],n-i+1);\n\t\trl[i]=n-getsum(l[i])+1,rr[i]=n-getsum(r[i]+1)+1;\n\t\tu[rl[i]].push_back(i),v[rr[i]].push_back(i);\n\t}\n\tfor(int i=1;i<=n;++i)\n\t{\n\t\t// cerr << ll[i] << \" \" << lr[i] << endl;\n\t\tupdate(1,1,n,i,i,mx[1]);\n\t\tif(ll[i])\tupdate(1,1,n,1,ll[i],1);\n\t\tif(lr[i])\tupdate(1,1,n,1,lr[i],-1);\n\t\tfor(int j : u[i])\tif(ll[j]<j)\tupdate(1,1,n,ll[j]+1,j,1);\n\t\tfor(int j : v[i])\tif(lr[j]<j)\tupdate(1,1,n,lr[j]+1,j,-1);\n\t}\n\tcout << mx[1] << endl;\n\treturn 0;\n}\n```\n",
        "postTime": 1663921618,
        "uid": 187081,
        "name": "jockbutt",
        "ccfLevel": 6,
        "title": "\u9898\u89e3P7503\u3010\u300cHMOI R1\u300d\u6587\u5316\u8bfe\u3011"
    },
    {
        "content": "\u524d\u7f6e\u829d\u58eb\uff1a[ST \u8868](https://oi-wiki.org/ds/sparse-table/)\u3001[\u7ebf\u6bb5\u6811](https://oi-wiki.org/ds/seg/)\n\n\u9996\u5148\u6709\u4e00\u4e2a\u66b4\u529b dp\u3002\u8bbe $dp_i$ \u8868\u793a\u524d $i$ \u4e2a\u4eba\u4f5c\u5f0a\u6240\u5f97\u6700\u5927\u8d21\u732e\u3002\n\n\u521d\u503c\uff1a$dp_0 = 0$\u3002\n\n\u8f6c\u79fb\uff1a$dp_i = \\displaystyle\\max_{j = 1}^i (dp_{j - 1} + w_{j, i})$\u3002\n\n\u7b54\u6848\uff1a$dp_n$\u3002\n\n\u4e3a\u4e86\u4f18\u5316\u8fd9\u4e2a dp\uff0c\u8003\u8651\u52a8\u6001\u7ef4\u62a4 $dp_{j - 1} + w_{j, i}$ \u7684\u533a\u95f4 $\\max$\u3002\n\n\u8003\u8651\u4e00\u4e2a\u4f4d\u7f6e $i$ \u5bf9\u7b54\u6848\u4ea7\u751f\u8d21\u732e\u7684\u533a\u95f4 $[p, q]$\u3002\n\n\u5148\u5224\u6389 $a_i > r_i$ \u8fd9\u79cd\u4e0d\u53ef\u80fd\u4ea7\u751f\u8d21\u732e\u7684\u60c5\u51b5\u3002\n\n\u6839\u636e\u9898\u7ed9\u6761\u4ef6\uff0c$p \\leq i \\leq q, l_i \\leq \\displaystyle\\max_{j = p}^q a_j \\leq r_i$\u3002\n\n\u76f4\u63a5\u8003\u8651\u4e24\u4e2a\u7aef\u70b9\u662f\u4e0d\u65b9\u4fbf\u7684\uff0c\u8003\u8651\u53ea\u56fa\u5b9a $i$\uff0c\u5206\u5f00\u8ba8\u8bba $p, q$\u3002\n\n\u5bf9\u4e8e $p$\uff0c\u663e\u7136\u6709 $\\displaystyle\\max_{j = p}^i a_j \\leq r_i$\uff1b\u5bf9\u4e8e $q$\uff0c\u663e\u7136\u6709 $\\displaystyle\\max_{j = i}^q a_j \\leq r_i$\u3002\n\n\u636e\u6b64\u6211\u4eec\u53ef\u4ee5\u5b9a\u51fa\u4e00\u4e2a\u7c97\u7565\u7684 $p, q$ \u8303\u56f4 $l_1 \\leq p \\leq i \\leq q \\leq r_2$\u3002\n\n\u5bf9\u4e8e\u4e0b\u754c $l_i$ \u7684\u9650\u5236\uff0c\u53ea\u8981\u5de6\u53f3\u4e24\u8fb9\u4e4b\u4e00\u6ee1\u8db3\u5373\u53ef\u3002\u5bf9\u4e8e $p$\uff0c\u663e\u7136\u6709 $\\displaystyle\\max_{j = p}^i a_j \\leq l_i$\uff1b\u5bf9\u4e8e $q$\uff0c\u663e\u7136\u6709 $\\displaystyle\\max_{j = i}^q a_j \\leq l_i$\u3002\n\n$l_1, l_2, r_1, r_2$ \u5747\u53ef\u7528 ST \u8868 + \u4e8c\u5206\u6c42\u51fa\u3002\n\n\u6709\u4e86\u4e0a\u8ff0\u9650\u5236\uff0c\u6211\u4eec\u6765\u8fdb\u4e00\u6b65\u8ba8\u8bba\u8303\u56f4\u3002\n\n\u5047\u5b9a\u6211\u4eec\u73b0\u5728\u5728\u8ba1\u7b97 $dp_k$\u3002\n\n- $l_2 = 0, r_1 \\neq 0$\n\n1. $k < r_1$\n\n\u663e\u7136\u6ca1\u6709\u8d21\u732e\u3002\n\n2. $r_1 \\leq k \\leq r_2$\n\n\u6b64\u65f6\u6211\u4eec\u5df2\u7136\u9009\u62e9\u4e86 $r_1$ \u4ee5\u6ee1\u8db3\u4e0b\u754c\uff0c\u5219 $p = l_1, q = i$\u3002\n\n3. $k > r_2$\n\n\u663e\u7136\u6ca1\u6709\u8d21\u732e\u3002\n\n- $l_2 \\neq 0, r_1 = 0$\n\n1. $k < i$\n\n\u663e\u7136\u6ca1\u6709\u8d21\u732e\u3002\n\n2. $i \\leq k \\leq r_2$\n\n\u6b64\u65f6\u6211\u4eec\u53ea\u9700\u8981\u6ee1\u8db3\u4e0a\u754c\u5373\u53ef\uff0c\u5219 $p = l_1, q = l_2$\u3002\n\n3. $k > r_2$\n\n\u663e\u7136\u6ca1\u6709\u8d21\u732e\u3002\n\n- $l_2, r_1 \\neq 0$\n\n1. $k < i$\n\n\u663e\u7136\u6ca1\u6709\u8d21\u732e\u3002\n\n2. $i \\leq k < r_1$\n\n\u6b64\u65f6\u6211\u4eec\u5fc5\u987b\u9009\u62e9 $l_2$ \u624d\u80fd\u6ee1\u8db3\u4e0b\u754c\uff0c\u5219 $p = l_1, q = l_2$\u3002\n\n3. $r_1 \\leq k \\leq r_2$\n\n\u6b64\u65f6\u6211\u4eec\u53ea\u9700\u8981\u6ee1\u8db3\u4e0a\u754c\u5373\u53ef\uff0c\u5219 $p = l_1, q = i$\u3002\n\n4. $k > r_2$\n\n\u663e\u7136\u6ca1\u6709\u8d21\u732e\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n \\log n)$\u3002\n\n\u6ce8\u610f\u8981\u7279\u5224\u4e00\u4e0b $l_1 > l_2$ \u7684\u60c5\u51b5\u3002\n\n\u4ee3\u7801\uff1a\n```cpp\n#include <iostream>\n#include <vector>\n#include <cmath>\n\nusing namespace std;\n\ntypedef struct {\n\tint l;\n\tint r;\n\tint tag;\n\tint max;\n} Node;\n\ntypedef struct Modification_tag {\n\tint l;\n\tint r;\n\tint val;\n\tModification_tag(int l_, int r_, int val_){\n\t\tl = l_;\n\t\tr = r_;\n\t\tval = val_;\n\t}\n} Modification;\n\nint a[100007], st[100007][17], dp[100007];\nNode tree[400007];\nvector<Modification> v[100007];\n\ninline void init(int n){\n\tint m = log2(n);\n\tfor (register int i = 1; i <= n; i++){\n\t\tst[i][0] = a[i];\n\t}\n\tfor (register int i = 1; i <= m; i++){\n\t\tint id = i - 1, t1 = n - (1 << i) + 1, t2 = 1 << id;\n\t\tfor (register int j = 1; j <= t1; j++){\n\t\t\tst[j][i] = max(st[j][id], st[j + t2][id]);\n\t\t}\n\t}\n}\n\nvoid build(int x, int l, int r){\n\ttree[x].l = l;\n\ttree[x].r = r;\n\tif (l == r) return;\n\tint mid = (l + r) >> 1;\n\tbuild(x * 2, l, mid);\n\tbuild(x * 2 + 1, mid + 1, r);\n}\n\ninline int get_max1(int l, int r){\n\tint t = log2(r - l + 1);\n\treturn max(st[l][t], st[r - (1 << t) + 1][t]);\n}\n\ninline void pushdown(int x){\n\tint ls = x * 2, rs = x * 2 + 1;\n\ttree[ls].tag += tree[x].tag;\n\ttree[ls].max += tree[x].tag;\n\ttree[rs].tag += tree[x].tag;\n\ttree[rs].max += tree[x].tag;\n\ttree[x].tag = 0;\n}\n\ninline void update(int x){\n\ttree[x].max = max(tree[x * 2].max, tree[x * 2 + 1].max);\n}\n\nvoid add(int x, int l, int r, int k){\n\tif (l <= tree[x].l && tree[x].r <= r){\n\t\ttree[x].tag += k;\n\t\ttree[x].max += k;\n\t\treturn;\n\t}\n\tint mid = (tree[x].l + tree[x].r) >> 1;\n\tpushdown(x);\n\tif (l <= mid) add(x * 2, l, r, k);\n\tif (r > mid) add(x * 2 + 1, l, r, k);\n\tupdate(x);\n}\n\nint get_max2(int x, int pos){\n\tif (tree[x].r <= pos) return tree[x].max;\n\tint ans;\n\tpushdown(x);\n\tans = get_max2(x * 2, pos);\n\tif (pos > ((tree[x].l + tree[x].r) >> 1)) ans = max(ans, get_max2(x * 2 + 1, pos));\n\treturn ans;\n}\n\nvoid add(int x, int pos, int val){\n\tif (tree[x].l == tree[x].r){\n\t\ttree[x].max += val;\n\t\treturn;\n\t}\n\tpushdown(x);\n\tif (pos <= ((tree[x].l + tree[x].r) >> 1)){\n\t\tadd(x * 2, pos, val);\n\t} else {\n\t\tadd(x * 2 + 1, pos, val);\n\t}\n\tupdate(x);\n}\n\nint main(){\n\tint n;\n\tcin >> n;\n\tbuild(1, 1, n);\n\tfor (register int i = 1; i <= n; i++){\n\t\tcin >> a[i];\n\t}\n\tinit(n);\n\tfor (register int i = 1; i <= n; i++){\n\t\tint l, r;\n\t\tcin >> l >> r;\n\t\tif (a[i] > r) continue;\n\t\tint L = 1, R = i, l1 = 0, l2 = 0, r1 = 0, r2 = 0;\n\t\twhile (L <= R){\n\t\t\tint mid = (L + R) >> 1;\n\t\t\tif (get_max1(mid, i) <= r){\n\t\t\t\tR = mid - 1;\n\t\t\t\tl1 = mid;\n\t\t\t} else {\n\t\t\t\tL = mid + 1;\n\t\t\t}\n\t\t}\n\t\tL = 1;\n\t\tR = i;\n\t\twhile (L <= R){\n\t\t\tint mid = (L + R) >> 1;\n\t\t\tif (get_max1(mid, i) >= l){\n\t\t\t\tL = mid + 1;\n\t\t\t\tl2 = mid;\n\t\t\t} else {\n\t\t\t\tR = mid - 1;\n\t\t\t}\n\t\t}\n\t\tL = i;\n\t\tR = n;\n\t\twhile (L <= R){\n\t\t\tint mid = (L + R) >> 1;\n\t\t\tif (get_max1(i, mid) >= l){\n\t\t\t\tR = mid - 1;\n\t\t\t\tr1 = mid;\n\t\t\t} else {\n\t\t\t\tL = mid + 1;\n\t\t\t}\n\t\t}\n\t\tL = i;\n\t\tR = n;\n\t\twhile (L <= R){\n\t\t\tint mid = (L + R) >> 1;\n\t\t\tif (get_max1(i, mid) <= r){\n\t\t\t\tL = mid + 1;\n\t\t\t\tr2 = mid;\n\t\t\t} else {\n\t\t\t\tR = mid - 1;\n\t\t\t}\n\t\t}\n\t\tif (l2 == 0 && r1 != 0){\n\t\t\tv[r1].push_back(Modification(l1, i, 1));\n\t\t\tv[r2 + 1].push_back(Modification(l1, i, -1));\n\t\t} else if (l2 != 0 && r1 == 0){\n\t\t\tif (l1 <= l2){\n\t\t\t\tv[i].push_back(Modification(l1, l2, 1));\n\t\t\t\tv[r2 + 1].push_back(Modification(l1, l2, -1));\n\t\t\t}\n\t\t} else {\n\t\t\tv[r2 + 1].push_back(Modification(l1, i, -1));\n\t\t\tif (l1 <= l2) v[i].push_back(Modification(l1, l2, 1));\n\t\t\tif (l2 < i) v[r1].push_back(Modification(l2 + 1, i, 1));\n\t\t}\n\t}\n\tfor (register int i = 1; i <= n; i++){\n\t\tint size = v[i].size();\n\t\tfor (register int j = 0; j < size; j++){\n\t\t\tadd(1, v[i][j].l, v[i][j].r, v[i][j].val);\n\t\t}\n\t\tdp[i] = get_max2(1, i);\n\t\tif (i < n) add(1, i + 1, dp[i]);\n\t}\n\tcout << dp[n];\n\treturn 0;\n}\n```",
        "postTime": 1663853451,
        "uid": 201007,
        "name": "Leasier",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P7503 \u3010\u300cHMOI R1\u300d\u6587\u5316\u8bfe\u3011"
    }
]