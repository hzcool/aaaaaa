[
    {
        "content": "\n\u89c2\u5bdf\u5230\uff0c\u4e00\u4e2a\u8282\u70b9\u53ef\u4ee5\u5230\u8fbe\u7684\u8282\u70b9\u4e3a\u82e5\u5e72\u5b50\u6811\u5e76\u3002\u7279\u6b8a\u7684\u662f\uff0c**\u5bf9\u4e8e\u6240\u6709\u6761\u4ef6\u53ef\u884c\u5bf9\uff0c\u5982\u679c\u56fa\u5b9a\u9996\u4e8b\u4ef6\uff0c\u5219\u672b\u4e8b\u4ef6\u5f62\u6210\u82e5\u5e72\u989d\u5916\u8fb9\u672b\u4e8b\u4ef6\u7684\u5b50\u6811\u4e4b\u548c\uff08\u5f3a\u4e8e\u4e4b\u5e76\uff09**\u3002\u53ef\u4ee5\u901a\u8fc7\u5bf9\u6df1\u5ea6\u5927\u5f80\u5c0f\u5f52\u7eb3\u8bc1\u660e\u3002\n\n\u5bf9\u6bcf\u4e00\u4e2a\u8282\u70b9\u901a\u8fc7 bitset \u5904\u7406\u51fa\u6765\u8fd9\u4e9b\u5b50\u6811\u662f\u4ec0\u4e48\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal O(nm)$\uff0c\u7a7a\u95f4\u590d\u6742\u5ea6 $\\mathcal O(nm/w)$\u3002\u8003\u8651\u4efb\u610f\u4e00\u4e2a\u989d\u5916\u8fb9\u8ba1\u7b97\u5b83\u7684\u8d21\u732e\uff0c\u4e5f\u5c31\u662f\u5bf9\u6bcf\u4e00\u4e2a\u8be2\u95ee\u5b83\u5728\u591a\u5c11\u6761\u4ef6\u53ef\u884c\u5bf9\u91cc\u4e3a\u6700\u540e\u7ecf\u8fc7\u7684\u989d\u5916\u8fb9\u3002\n\n\u8003\u8651\u79bb\u7ebf\u5e76\u626b\u63cf\u7ebf\uff1a\u5bf9\u8be2\u95ee\u6309\u7167\u5de6\u7aef\u70b9\u6392\u5e8f\uff0c\u4ece\u5927\u5230\u5c0f\u626b\u63cf\u5de6\u7aef\u70b9\u3002\u8003\u8651 $L+1$ \u5f80 $L$ \u79fb\u52a8\u7684\u65f6\u5019\uff0c\u9700\u8981\u52a0 $L$ \u5bf9\u8fd9\u4e2a\u5b50\u6811\uff08\u989d\u5916\u8fb9\u672b\u4e8b\u4ef6\uff09\u7684\u8d21\u732e\u3002\u6211\u4eec\u5148\u5904\u7406\u51fa\u6765\u8fd9\u4e2a\u5b50\u6811\u7684\u6240\u6709\u8282\u70b9\uff0c**\u5bf9\u8fd9\u4e9b\u8282\u70b9\u548c\u4ec5\u5bf9\u8fd9\u4e9b\u8282\u70b9\u5efa\u7acb\u7ebf\u6bb5\u6811/\u6811\u72b6\u6570\u7ec4\u3002** \u8fd9\u91cc\u201c\u4ec5\u201d\u7684\u610f\u601d\u662f\u79bb\u6563\u5316\u5e76\u4e0d\u8003\u8651\u4efb\u4f55\u5b50\u6811\u5916\u7684\u8282\u70b9\u3002\n\n\u6211\u4eec\u4ec5\u9700\u8981\u5728 $L$ \u53ef\u4ee5\u8fbe\u5230\u989d\u5916\u8fb9**\u9996**\u4e8b\u4ef6\u65f6\u5019\u8fdb\u884c\u5bf9\u7ebf\u6bb5\u6811/\u6811\u72b6\u6570\u7ec4\u7684\u4fee\u6539\uff0c\u8fd9\u4e2a\u53ef\u4ee5\u76f4\u63a5\u67e5\u8be2 bitset\u3002\u8fd8\u9700\u8981\u6ce8\u610f\u4e0d\u8981\u5c06\u5b50\u6811\u91cd\u590d\u7edf\u8ba1\uff0c\u8fd9\u4e2a\u53ef\u4ee5\u901a\u8fc7\u6309\u7167 dfs \u5e8f\u5904\u7406\u672b\u4e8b\u4ef6\uff0c\u5224\u65ad\u4e00\u4e2a\u8282\u70b9\u5230\u8fbe\u7684\u4e0a\u4e00\u4e2a\u672b\u4e8b\u4ef6\u662f\u5426\u8986\u76d6\u8fd9\u4e2a\uff0c\u5982\u679c\u8986\u76d6\u5219\u8df3\u8fc7\u3002\n\n\u5982\u679c\u6700\u7ec8\u53d1\u73b0\u4e0d\u8df3\u8fc7\uff0c\u5c31\u5bf9\u5b50\u6811\u7684\u7ebf\u6bb5\u6811/\u6811\u72b6\u6570\u7ec4\u6240\u6709**\u6807\u53f7**\u5927\u4e8e $L$ \u7684\u5143\u7d20\u52a01\u3002\u5bf9\u4e8e\u6240\u6709 $L$ \u7b49\u4e8e\u5f53\u524d $L$ \u7684\u8be2\u95ee\u5c31\u52a0\u4e0a\u8d21\u732e\uff0c\u76f4\u63a5\u5728\u7ebf\u6bb5\u6811/\u6811\u72b6\u6570\u7ec4\u4e0a\u8ba1\u7b97 $[L,R]$ \u4e4b\u548c\u5373\u53ef\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal O((n+q)m\\log n)$\uff0c\u7a7a\u95f4\u590d\u6742\u5ea6 $\\mathcal O(nm/w+q)$\u3002\n\n**\u8d5b\u540e\u66f4\u65b0**\uff1a\u5b58\u5728\u4f18\u4e8e $\\mathcal O((n+q)m\\log n)$ \u7684 $\\mathcal O((n+q)m)$ \u505a\u6cd5\u3002\u6211\u4eec\u4e0d\u9700\u8981\u626b\u63cf\u7ebf\u89e3\u51b3\u7edf\u8ba1\u53ef\u8fbe\u987a\u5e8f\u5bf9\u3002\u672c\u8d28\u662f\u60f3\u89e3\u51b3\u5feb\u901f\u7edf\u8ba1\n\n$$\\sum_{l\\le i<j\\le r}[i\\Rightarrow E][E\\Rightarrow j]$$\n\n\u53ef\u4ee5\u901a\u8fc7\u524d\u7f00\u548c\u8ba1\u7b97\u3002",
        "postTime": 1620118268,
        "uid": 220037,
        "name": "w33z8kqrqk8zzzx33",
        "ccfLevel": 7,
        "title": "MCOI R5 E"
    },
    {
        "content": "**\u9898\u610f** \uff1a \u7ed9\u51fa\u4e00\u68f5 $n$ \u4e2a\u70b9\u7684\u5916\u5411\u6811 $T$\uff0c\u4ee5\u53ca $m$ \u6761\u989d\u5916\u7684\u8fb9\uff0c\u6ee1\u8db3\u52a0\u5165\u8fd9\u4e9b\u8fb9\u4e4b\u540e\u56fe $G$ \u662f DAG\u3002\n\n\u5bf9\u4e8e\u70b9\u5bf9 $u,v$ \uff0c\u82e5\u5728 $T$ \u4e2d $u$ \u4e0d\u80fd\u5230\u8fbe $v$ \uff0c\u4f46\u662f\u5728 $G$ \u4e2d $u$ \u53ef\u4ee5\u5230\u8fbe $v$ \uff0c\u5219\u79f0\u70b9\u5bf9 $(u,v)$ \u662f\u597d\u7684\u3002\n\n\u6bcf\u6b21\u8be2\u95ee\u7ed9\u51fa $l,r$ \uff0c\u6c42\u6709\u591a\u5c11\u5bf9\u597d\u7684 $(u,v)$ \u6ee1\u8db3 $l\\leq u<v\\leq r$ \u3002\n\n$n\\leq 7\\times 10^5,q\\leq 3\\times 10^5,m\\leq 100$ \uff0c\u65f6\u9650$\\texttt{5s}$\u3002\n\n------------\n\n> @newbiewzs \u9898\u89e3\u7684\u8be6\u7ec6\u7248\u3002\n\n\u5bf9\u4e8e\u989d\u5916\u8fb9 $u\\rightarrow v$ \uff0c\u5c06 $v$ \u6807\u8bb0\u4e3a\u201c**\u5173\u952e\u70b9**\u201d\u3002\u8bb0\u5173\u952e\u70b9\u96c6\u5408\u4e3a $E$ \u3002\n\n\u89c2\u5bdf\u597d\u5bf9\u5b50 $(a,b)$ \u7684\u5206\u5e03\u3002\n\n\u5728\u56fa\u5b9a $a$ \u65f6\uff0c\u82e5 $(a,b)$ \u662f\u597d\u7684\uff0c\u4e14 $T:b\\leadsto c$ \uff0c\u5219 $(a,c)$ \u662f\u597d\u7684\u3002\n\n\u8fd9\u8bf4\u660e $b$ \u7684\u5206\u5e03\u5fc5\u7136\u662f\u82e5\u5e72\u4e0d\u4ea4\u7684 $T$ \u7684\u5b50\u6811\uff08\u79f0\u4f5c**\u597d\u5b50\u6811**\uff09\u3002\u4e0d\u96be\u8fdb\u4e00\u6b65\u53d1\u73b0\uff0c\u8fd9\u4e9b\u5b50\u6811\u7684\u6839\u90fd\u662f\u5173\u952e\u70b9\u3002\n\n------------\n\n\u5bf9\u4e8e\u6bcf\u4e2a\u597d\u7684\u5bf9\u5b50 $(a,b)$ \uff0c\u5728\u6240\u6709\u53ef\u80fd\u7684\u8def\u5f84 $G:a\\leadsto b$ \u4e2d\uff0c\u90fd\u5fc5\u7136\u6709\u81f3\u5c11\u4e00\u4e2a\u5173\u952e\u70b9\u3002\u53d6\u67d0\u4e2a\u5173\u952e\u70b9\u4f5c\u4e3a\u201c\u7edf\u8ba1\u70b9\u201d\uff0c\u8fd9\u6837\u6211\u4eec\u624d\u80fd\u5bf9\u8d21\u732e\u8f6c\u7f6e\u3002\n\n\u6839\u636e\u5982\u4e0a\u89c2\u5bdf\uff0c\u6211\u4eec\u53d6 $b$ \u6240\u5728\u201c\u597d\u5b50\u6811\u201d\u7684\u6839\u4f5c\u4e3a**\u7edf\u8ba1\u70b9** $v$ \uff0c\u8fd9\u6837\u662f\u552f\u4e00\u7684\u3002\n\n\u8003\u8651\u5982\u4f55\u5224\u5b9a $(a,b)$ \u662f\u5426\u6ee1\u8db3\u201c\u662f\u597d\u7684\uff0c\u4e14\u7edf\u8ba1\u70b9\u4e3a $v$\u201d\u3002\n\n\u9996\u5148\u6709\u5fc5\u8981\u6761\u4ef6 $T:a\\not\\leadsto b$ \uff0c\u5426\u5219 $(a,b)$ \u4e0d\u662f\u597d\u7684\u3002\n\n\u7136\u540e\uff0c\u4e3a\u4e86\u4fdd\u8bc1\u7edf\u8ba1\u70b9\uff0c\u4e00\u4e2a\u663e\u7136\u7684\u5fc5\u8981\u6761\u4ef6\u662f\uff0c$G:a\\leadsto v$ \u4e14 $T:v\\leadsto b$ \u3002\u4f46\u8fd9\u4e0d\u5145\u5206\uff0c\u6211\u4eec\u79f0\u6ee1\u8db3\u8be5\u6761\u4ef6\u7684 $v$ \u4e3a $(a,b)$ \u7684**\u4e2d\u8f6c\u70b9**\u3002\n\n\u4e0d\u96be\u53d1\u73b0\uff0c\u4e2d\u8f6c\u70b9\u90fd\u662f $T$ \u4e2d $b$ \u7684\u7956\u5148\uff0c\u90a3\u4e48\u6df1\u5ea6\u6700\u5c0f\uff08\u662f\u5176\u4ed6\u4e2d\u8f6c\u70b9\u7684\u7956\u5148\uff09\u7684\u4e2d\u8f6c\u70b9\u5c31\u662f\u7edf\u8ba1\u70b9\u4e86\u3002\n\n\u5bf9\u5173\u952e\u70b9 $v$ \uff0c\u8bb0 $S_v=\\{u\\ \\big|\\ T:v\\leadsto u\\}$ \uff0c $T_v=\\{u\\ \\big|\\ G:u\\leadsto v,\\text{\u4e0d\u5b58\u5728}v'\\text{\u4f7f\u5f97}G:u\\leadsto v',T:v'\\leadsto v\\}$ \u3002\n\n\u90a3\u4e48 $a\\in T_v,b\\in S_v$ \u5c31\u662f\u201c\u7edf\u8ba1\u70b9\u4e3a $v$\u201d\u7684\u5145\u8981\u6761\u4ef6\u3002\n\n\u518d\u5c06 $T:a\\not\\leadsto b$ \u7eb3\u5165\u8003\u8651\uff0c\u6ce8\u610f\u5230 $T:v\\leadsto b,G:v\\not\\leadsto a$ \uff0c\u524d\u8005\u53ef\u4ee5\u7b49\u4ef7\u4e3a $T:a\\not\\leadsto v$ \u3002\n\n\u4e8e\u662f\u6539\u8bb0 $T_v=\\{u\\ \\big|\\ G:u\\leadsto v,T:u\\not\\leadsto v,\\text{\u4e0d\u5b58\u5728}v'\\text{\u4f7f\u5f97}G:u\\leadsto v',T:v'\\leadsto v\\}$ \u3002\n\n------------\n\n\u8003\u8651\u5982\u4f55\u6c42 $S,T$ \uff0c\u4f7f\u7528\u8f6c\u7f6e\u3002\n\n\u8bb0 $S'_u=\\{v\\in E\\ \\big|\\ T:v\\rightarrow u\\}$ \uff0c $T'_u=\\{v\\in E\\ \\big|\\ G:u\\leadsto v,T:u\\not\\leadsto v,\\text{\u4e0d\u5b58\u5728}v'\\text{\u4f7f\u5f97}G:u\\leadsto v',T:v'\\leadsto v\\}$ \u3002\n\n\u663e\u7136\uff0c$S',T'$ \u4e0e $S,T$ \u4e92\u4e3a\u8f6c\u7f6e\u3002\n\n$S'$ \u662f\u7b80\u5355\u7684\u4f20\u9012\u95ed\u5305\u3002\n\n\u5bf9\u4e8e $T'$ \uff0c\u5148\u7528\u4f20\u9012\u95ed\u5305\u5904\u7406 \u201c$u\\leadsto v$\u201d \uff0c\u7136\u540e\u7528 dfs \u5e8f\u548c\u6811\u5f62 DP \u5904\u7406 \u201c$T:u\\not\\leadsto v$\u201d \u548c \u201c$\\text{\u4e0d\u5b58\u5728}v'\\text{\u4f7f\u5f97}G:u\\leadsto v',T:v'\\leadsto v$\u201d\u3002\n\n\u4f7f\u7528 `bitset` \uff0c\u65f6\u95f4 $O(nm)$ \uff0c\u7a7a\u95f4 $O(nm/w)$ \u3002\n\n- \u5361\u5e38\u6280\u5de7\n\n  - \u4e0d\u8981\u7528 `[]` \u64cd\u4f5c `bitset` \uff0c\u800c\u8981\u4f7f\u7528 `set,reset,test` \u7b49\u51fd\u6570\uff0c\u5e38\u6570\u5c0f\u5f88\u591a\u3002\n  \n  - \u6811\u5f62 DP \u53ef\u4ee5\u8f6c\u4e3a dfs \u5e8f\u4e0a\u7684\u95ee\u9898\u3002\n\n------------\n\n\u63a5\u4e0b\u6765\u8003\u8651\u5982\u4f55\u56de\u7b54\u8be2\u95ee\u3002\n\n\u4e3a\u4e86\u65b9\u4fbf\u5904\u7406\uff0c\u5c06\u6761\u4ef6 $[l\\leq a<b\\leq r]$ \u62c6\u6210 $[l\\leq b\\leq r][a<b]-[l\\leq b\\leq r][a<l]$ \u3002\n\n$$\n\\begin{aligned}\n{\\rm Ans_1}&=\\sum\\limits_{v\\text{\u662f\u5173\u952e\u70b9}}\\sum\\limits_{(a,b)}[l\\leq b\\leq r][a<b][(a,b)\\text{\u662f\u597d\u7684,\u7edf\u8ba1\u70b9\u662f}v]\\\\\n&=\\sum\\limits_{v\\text{\u662f\u5173\u952e\u70b9}}\\sum\\limits_{(a,b)}[l\\leq b\\leq r][a<b][a\\in T_v][b\\in S_v]\\\\\n&=\\sum\\limits_{v\\text{\u662f\u5173\u952e\u70b9}}\\sum\\limits_{l\\leq b\\leq r}[b\\in S_v]\\sum\\limits_{a<b}[a\\in T_v]\\\\\n\\end{aligned}\n$$\n\n$$\n\\begin{aligned}\n{\\rm Ans_2}&=\\sum\\limits_{v\\text{\u662f\u5173\u952e\u70b9}}\\sum\\limits_{(a,b)}[l\\leq b\\leq r][a<l][(a,b)\\text{\u662f\u597d\u7684,\u7edf\u8ba1\u70b9\u662f}v]\\\\\n&=\\sum\\limits_{v\\text{\u662f\u5173\u952e\u70b9}}\\sum\\limits_{(a,b)}[l\\leq b\\leq r][a<l][a\\in T_v][b\\in S_v]\\\\\n&=\\sum\\limits_{v\\text{\u662f\u5173\u952e\u70b9}}\\Bigg(\\sum\\limits_{l\\leq b\\leq r}[b\\in S_v]\\Bigg)\\Bigg(\\sum\\limits_{a<l}[a\\in T_v]\\Bigg)\\\\\n\\end{aligned}\n$$\n\n\u5bf9\u4e8e\u6bcf\u4e2a $v$ \uff0c\u4e0a\u8ff0\u5f0f\u5b50\u90fd\u5bb9\u6613\u7528\u524d\u7f00\u548c\u641e\u5b9a\u3002\n\n\u603b\u65f6\u95f4\u590d\u6742\u5ea6 $O((n+q)m)$ \uff0c\u7a7a\u95f4\u590d\u6742\u5ea6\uff08\u82e5\u79bb\u7ebf\uff09 $O(nm/\\omega+q)$\u3002\n\n```cpp\n#include<algorithm>\n#include<cstdio>\n#include<vector>\n#include<bitset>\n#define ll long long\n#define pb push_back\n#define MaxN 700500\n#define MaxQ 300500\n#define MaxM 105\nusing namespace std;\nstruct Line{int t,nxt;}g[MaxN];\nint fir[MaxN],tl;\nvoid adl(int u,int v)\n{g[++tl]=(Line){v,fir[u]};fir[u]=tl;}\nint dfn[MaxN],out[MaxN],tp[MaxN],tim;\nvoid dfsT(int u)\n{\n  tp[dfn[u]=++tim]=u;\n  for (int i=fir[u];i;i=g[i].nxt)\n    dfsT(g[i].t);\n  out[u]=tim;\n}\nbitset<MaxM> T0[MaxN];\nint id[MaxN],st[MaxM],tn;\nbool vis[MaxN];\nvoid dfsG(int u)\n{\n  if (id[u])T0[u][id[u]]=1;\n  vis[u]=1;\n  for (int i=fir[u];i;i=g[i].nxt){\n    if (!vis[g[i].t])dfsG(g[i].t);\n    T0[u]|=T0[g[i].t];\n  }\n}\nint n,m,q,S[MaxN],T[MaxN],r[MaxM];\nll O[MaxN],ans[MaxQ];\nint ql[MaxQ],qr[MaxQ];\nint main()\n{\n  scanf(\"%d%d\",&n,&m);\n  for (int i=2,fa;i<=n;i++)\n    {scanf(\"%d\",&fa);adl(fa,i);}\n  dfsT(1);\n  for (int i=1,u,v;i<=m;i++){\n    scanf(\"%d%d\",&u,&v);\n    adl(u,v);id[v]=1;\n  }\n  for (int i=1;i<=n;i++)if (id[tp[i]])\n    {st[++tn]=tp[i];id[tp[i]]=tn;}\n  for (int i=1;i<=tn;i++){\n    r[i]=i;\n    while(r[i]<tn&&dfn[st[r[i]+1]]<=out[st[i]])r[i]++;\n  }\n  dfsG(1);\n  for (int u=1;u<=n;u++)\n    for (int k=1;k<=tn;k++)\n      if (T0[u].test(k)){\n        int lim=r[k];\n        while(k+1<=lim)T0[u].reset(++k);\n      }\n  scanf(\"%d\",&q);\n  for (int i=1;i<=q;i++)\n    scanf(\"%d%d\",&ql[i],&qr[i]);\n  for (int k=1;k<=tn;k++){\n    int v=st[k];\n    for (int u=1;u<=n;u++){\n      S[u]=(dfn[v]<=dfn[u]&&dfn[u]<=out[v]);\n      T[u]=T0[u].test(k)&&!(dfn[u]<=dfn[v]&&dfn[v]<=out[u]);\n      O[u]=O[u-1]+S[u]*T[u-1];\n      T[u]+=T[u-1];S[u]+=S[u-1];\n    }\n    for (int i=1;i<=q;i++){\n      int l=ql[i],r=qr[i];\n      ans[i]+=O[r]-O[l-1]-1ll*(S[r]-S[l-1])*T[l-1];\n    }\n  }\n  for (int i=1;i<=q;i++)\n    printf(\"%lld\\n\",ans[i]);\n  return 0;\n}\n```",
        "postTime": 1634784035,
        "uid": 58705,
        "name": "command_block",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 \u3010P7570 \u300cMCOI-05\u300d\u591a\u5b87\u3011"
    },
    {
        "content": "\u5b9a\u4e49\u6bcf\u6761\u65b0\u52a0\u7684\u8fb9 $(u,v)$ \u7684 $v$ \u4e3a\u5173\u952e\u70b9\uff0c\u53d1\u73b0\u6700\u540e\u6bcf\u4e2a\u6ee1\u8db3\u6761\u4ef6\u7684\u70b9\u5bf9 $(x,y)$ \u8def\u5f84\u4e0a\u90fd\u81f3\u5c11\u6709\u4e00\u4e2a\u5173\u952e\u70b9\uff0c\u4e14\u5b58\u5728\u81f3\u5c11\u4e00\u4e2a\u5173\u952e\u70b9\u4e3a $y$ \u5728\u539f\u6811\u4e0a\u7684\u7956\u5148\u4e14\u80fd\u88ab $x$ \u5230\u8fbe\u3002\n\n\u8003\u8651\u7ed9\u6bcf\u4e2a\u70b9\u5bf9\u4e00\u4e2a\u7edf\u8ba1\u70b9\uff0c\u4e0d\u59a8\u5bf9\u4e8e\u6bcf\u4e2a\u70b9\u5bf9 $(x,y)$ \u90fd\u5728 $y$ \u7684\u7956\u5148\uff0c\u80fd\u88ab $x$ \u5230\u8fbe\u4e14\u6df1\u5ea6\u6700\u6d45\u7684\u5173\u952e\u70b9\u5904\u7edf\u8ba1\uff0c\u5219\u53ef\u4ee5\u4fdd\u8bc1\u6bcf\u4e2a\u70b9\u5bf9\u90fd\u53ea\u4f1a\u88ab\u7edf\u8ba1\u4e00\u6b21\u3002\n\n\u73b0\u5728\u8003\u8651\u6c42\u51fa\u6bcf\u4e2a\u70b9 $x$ \u80fd\u5230\u8fbe\u7684\u5173\u952e\u70b9\u96c6\u5408\uff0c\u8fd9\u4e2a\u53ef\u4ee5\u7528 $bitset$ \u5728 $O(\\frac{nm}{w}) $ \u65f6\u95f4\u5b8c\u6210\uff0c\u53d1\u73b0\u5982\u679c $x$ \u80fd\u5230\u8fbe\u7684\u4e24\u4e2a\u5173\u952e\u70b9 $u,v$\uff0c\u6ee1\u8db3 $u$ \u662f $v$ \u5728\u539f\u6811\u4e0a\u7684\u7956\u5148\uff0c\u5219 $v$ \u4e00\u5b9a\u6ca1\u7528\uff0c\u56e0\u4e3a $u$ \u80fd\u591f\u7edf\u8ba1\u6240\u6709 $v$ \u80fd\u7edf\u8ba1\u7684\u4fe1\u606f\uff0c\u6240\u4ee5\u5c06 $v$ \u5728 $x$ \u80fd\u5230\u8fbe\u7684\u96c6\u5408\u4e2d\u5220\u53bb\uff0c\u4ee5\u514d\u7b97\u91cd\u3002\n\n\u73b0\u5728\u8003\u8651\u679a\u4e3e\u6bcf\u4e2a\u5173\u952e\u70b9 $z$ \uff0c \u518d\u5728\u4e0a\u9762\u679a\u4e3e\u6bcf\u4e2a\u8be2\u95ee $[L,R]$\uff0c\u53d1\u73b0\u6211\u4eec\u73b0\u5728\u5176\u5b9e\u5728\u8be2\u95ee\u80fd\u5230\u8fbe $z$ \u7684\u6240\u6709\u70b9 $x$ \u4e0e $z$ \u5b50\u6811\u5185\u7684\u6240\u6709\u70b9 $y$\uff0c\u4e14\u6ee1\u8db3 $x<y \\ \\ \\&\\&\\ \\ [x,y]\\subseteq[L,R]$ \uff0c\u5c06\u8be2\u95ee\u62c6\u6210 $\\sum_{L<=x<=R\\ ,\\ x<y} - \\sum_{L<=x<=R \\ ,\\ y>R}$\uff0c\u5bb9\u6613\u53d1\u73b0\u8fd9\u4e9b\u6211\u4eec\u90fd\u53ef\u4ee5\u5728\u6bcf\u4e2a\u5173\u952e\u70b9 $O(n)$ \u7684\u9884\u5904\u7406\u51fa\u524d\u7f00\u548c\u7136\u540e\u626b\u4e00\u904d\u8be2\u95ee $O(1)$ \u7684\u8ba1\u7b97\uff0c\u6240\u4ee5\u6700\u540e\u590d\u6742\u5ea6\u4e3a $O(\\frac{nm}{w}+nm)$\n\n$Code:$\n\n```cpp\nconst int N=7e5+55;\nconst int M=105;\nstruct Query{\n\tint l,r;\n}q[N];\nint n,m,s,st[N],top,dfn[N],ed[N],tot,pos[N],f[N],x[M],y[M],tmp[N],ans[N],s1[N],s2[N],s3[N],s4[N],ls[N],head1,rs[N],head2;\nbitset<M>b[N];\nbool vis[N],ban[N];\nvi v[N],g[N],h[M];\nint cmp(int x,int y){\n\treturn dfn[x]<dfn[y];\n}\nvoid dfs(int u){\n\tvis[u]=1;\t\n\tif(pos[u])b[u][pos[u]]=1;\n\tfor(unsigned int i=0;i<v[u].size();i++){\n\t\tif(!vis[v[u][i]]){\n\t\t\tdfs(v[u][i]);\n\t\t}\n\t\tb[u]|=b[v[u][i]];\n\t}\n\tfor(unsigned int i=0;i<g[u].size();i++){\n\t\tif(!vis[g[u][i]]){\n\t\t\tdfs(g[u][i]);\n\t\t}\n\t\tb[u]|=b[g[u][i]];\n\t}\n}\nvoid dfs1(int u){\n\tdfn[u]=++tot;\n\tfor(unsigned int i=0;i<v[u].size();i++){\n\t\tdfs1(v[u][i]);\n\t}\n\ted[u]=++tot;\n}\nsigned main(){\n\tn=read();m=read();\n\tfor(int i=2;i<=n;i++)f[i]=read(),v[f[i]].pb(i);\n\tdfs1(1);\n\tfor(int i=1;i<=m;i++)x[i]=read(),y[i]=read(),st[++top]=y[i],g[x[i]].pb(y[i]);\n\tsort(st+1,st+top+1,cmp);\n\tfor(int i=1;i<=top;i++)pos[st[i]]=i\n\tdfs(1);\n\tfor(int i=1;i<=top;i++){\n\t\tfor(int k=1;k<=top;k++){\t\t\t\n\t\t\tif(dfn[st[i]]<dfn[st[k]] and ed[st[i]]>ed[st[k]])h[i].pb(k);\n\t\t}\n\t}\n\tfor(int i=1;i<=n;i++){\n\t\tfor(int k=1;k<=top;k++){\n\t\t\tif(b[i][k]){\n\t\t\t\tfor(unsigned int j=0;j<h[k].size();j++)b[i][h[k][j]]=0;\n\t\t\t}\n\t\t}\n\t}\n\ts=read();\n\tfor(int i=1;i<=s;i++){\n\t\tq[i].l=read();q[i].r=read();\n\t}\n\tfor(int i=1;i<=top;i++){\n\t\tint u=st[i];\n\t\tint v=f[u];\n\t\thead1=head2=0;\n\t\twhile(v){\n\t\t\tban[v]=1;\n\t\t\tv=f[v];\n\t\t}\n\t\tfor(int k=1;k<=n;k++){\n\t\t\ts2[k]=s2[k-1];\n\t\t\tif(ban[k])continue;\n\t\t\tif(k!=u and b[k][i])s1[k]++;\n\t\t\tif(dfn[k]>=dfn[u] and ed[k]<=ed[u])s2[k]++;\n\t\t}\n\t\tfor(int k=1;k<=n;k++)s4[k]=s4[k-1]+s1[k]*(s2[n]-s2[k]);\n\t\tfor(int k=1;k<=n;k++)s1[k]+=s1[k-1];\n\t\tfor(int k=1;k<=s;k++){\n\t\t\tans[k]+=(s4[q[k].r]-s4[q[k].l-1]);\n\t\t\tans[k]-=(s1[q[k].r]-s1[q[k].l-1])*(s2[n]-s2[q[k].r]);\n\t\t}\n\t\tmemset(s1,0,sizeof(s1));\n\t\tmemset(s2,0,sizeof(s2));\n\t\tmemset(s4,0,sizeof(s4));\n\t\tv=u;\n\t\twhile(v){\n\t\t\tban[v]=0;\n\t\t\tv=f[v];\n\t\t}\n\t}\n\tfor(int i=1;i<=s;i++){\n\t\tprintf(\"%lld\\n\",ans[i]);\n\t}\n    return 0;\n}\n\n\n```",
        "postTime": 1625752086,
        "uid": 382470,
        "name": "newbiewzs",
        "ccfLevel": 9,
        "title": "P7570"
    }
]