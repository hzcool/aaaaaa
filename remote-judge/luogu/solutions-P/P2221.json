[
    {
        "content": "\u8fd9\u9053\u9898\u8ba9\u6211\u4eec\u6c42\u8fb9,\u56e0\u4e3a\u9898\u76ee\u662f\u4e00\u6761\u94fe,\u6240\u4ee5\u76f4\u63a5\u91c7\u7528\u628a\u8fb9\u7f16\u4e0a\u53f7.\u770b\u6210\u5e8f\u5217\u5373\u53ef.       \n$1$\u4e0e$2$\u53f7\u70b9\u7684\u8fb9\u8fde\u5f97\u662f. \u7f16\u53f7\u4e3a$1$\u7684\u70b9.\u67e5\u8be2\u7684\u65f6\u5019\u628a$r - 1$\u5c31\u597d\u4e86.    \n\u8fd9\u91cc\u7684\u671f\u671b\u663e\u7136\u5c31\u662f\u8def\u5f84\u7684\u5e73\u5747\u503c.    \n\u671f\u671b\u503c: $$\\dfrac{\\sum_{i=l}^r\\sum_{j=l}^{r}dis[i][j]}{C_{r-l+1}^2}$$    \n\u4e0b\u9762\u90e8\u5206\u53ef\u4ee5\u76f4\u63a5\u7b97\u51fa:    \n\u4e0a\u9762\u8fd9\u4e00\u90e8\u5206\u6bd4\u8f83\u96be\u7ef4\u62a4.    \n\u8003\u8651\u6bcf\u4e00\u6761\u8fb9\u4f1a\u88ab\u8d70\u8fc7\u591a\u5c11\u6b21.    \n$$ans = \\sum_{i=l}^ra[i]*(r-i+1)(i-l+1)$$    \n\u76f8\u5f53\u4e8e\u679a\u4e3e\u8fd9\u4e2a\u70b9\u5de6\u53f3\u4e24\u6761\u8def.    \n\u7136\u540e\u62c6\u5f00.    \n\u518d\u5316\u7b80\u4e00\u4e0b\u5f0f\u5b50.    \n\u5f62\u6210\u4e0b\u9762\u8fd9\u4e2a\u6a21\u6837.    \n$$ans = (r - l + 1 - r * l) * sum1 + (r + l) * sum2 - sum3$$    \n\u5176\u4e2d    \n$sum1 = \\sum_{i=l}^r a[i]$    \n$sum2 = \\sum_{i=l}^r a[i]*i$    \n$sum3 = \\sum_{i=l}^r a[i] * i * i$    \n\u7136\u540e\u6211\u4eec\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u4e00\u4e0b.    \n\u8003\u8651\u5408\u5e76.    \n$sum1 = lson_{sum1} + rson_{sum1}$    \n$sum2 = lson_{sum2} + rson_{sum2}$    \n$sum3 = lson_{sum3} + rson_{sum3}$    \n\u5408\u5e76\u662f\u6bd4\u8f83\u7b80\u5355\u4e86.    \n\u6dfb\u52a0\u503c\u5f97\u65f6\u5019\u5982\u4f55\u6dfb\u52a0?    \n\u8bbe\u6dfb\u52a0\u7684\u503c\u4e3a$k$    \n\u6b64\u65f6\u7684\u5f0f\u5b50\u5c31\u53d8\u6210\u4e86.    \n$sum1$\u6bd4\u8f83\u7b80\u5355,\u76f4\u63a5\u52a0\u4e0a\u533a\u95f4\u7684\u957f\u5ea6\u4e58\u4ee5$k$\u5373\u53ef.    \n$sum2$\u8981\u52a0\u4e0a$k*\\sum i$\u7136\u540e\u7ef4\u62a4\u4e00\u4e0b\u533a\u95f4$i$\u7684\u548c.\u6211\u4eec\u79f0\u5b83\u4e3a$sum5$,\u6216\u8005\u8003\u8651\u7b49\u5dee\u6570\u5217\u6c42\u548c\u7684\u65b9\u6cd5\u4e5f\u53ef\u4ee5.    \n$sum3$\u8981\u52a0\u4e0a$k * \\sum i ^2$\u6211\u4eec\u8fd9\u91cc\u5fc5\u987b\u8981\u7ef4\u62a4$sum4$,\u5b83\u4ee3\u8868$\\sum i^2$    \n$sum4$ \u548c $sum5$ \u662f\u4e00\u4e2a\u5b9a\u503c.\u5728\u5efa\u6811\u7684\u65f6\u5019\u66f4\u65b0\u5c31\u884c\u4e86.    \n\u7136\u540e\u8fd9\u4e2a\u9898\u5c31\u5b8c\u6210\u4e86.    \n\u7279\u522b\u6ce8\u610f\u7684\u662f.\u7531\u4e8e\u6211\u4eec**\u8bbe\u8fb9\u4e3a\u70b9**.\u6240\u4ee5\u8981$r -= 1$\n\u5982\u679c\u76f4\u63a5$r -=1$\u7684\u8bdd,\u4e0b\u9762\u7684\u5206\u6bcd\u8981\u6539\u6210.$C_{r-l + 2}^2$       \n## \u6700\u540e,\u6253\u4e2a\u5e7f\u544a:[My blog](https://www.cnblogs.com/tpgzy/)    \nCODE:    \n```cpp\n#include <iostream>\n#include <cstdio>\n#define lson now << 1\n#define rson now << 1 | 1\n#define ll long long\nconst ll maxN = 100000 + 7;\n\ninline ll read() {\n    ll x = 0,f = 1;char c = getchar();\n    while(c < '0' || c > '9') {if(c == '-')f = -1;c = getchar();}\n    while(c >= '0' && c <= '9') {x = x * 10 + c - '0';c = getchar();}\n    return x * f;\n}\n\nll gcd(ll a,ll b) {\n    return !b ? a : gcd(b,a % b);\n}\n\nstruct Node {\n    ll sum[6];\n    ll lazy;\n    ll l,r;\n}tree[maxN << 2];\nll sum1,sum2,sum3;\n\nvoid updata(ll now) {\n    tree[now].sum[1] = tree[lson].sum[1] + tree[rson].sum[1];\n    tree[now].sum[2] = tree[lson].sum[2] + tree[rson].sum[2];\n    tree[now].sum[3] = tree[lson].sum[3] + tree[rson].sum[3];\n    return ;\n}\n\nvoid build(ll l,ll r,ll now) {\n    tree[now].l = l;tree[now].r = r;\n    if(l == r) {\n        tree[now].sum[4] = l * l;\n        tree[now].sum[5] = l;\n        return ;\n    }\n    ll mid = (l + r) >> 1;\n    build(l,mid,lson);\n    build(mid + 1,r,rson);\n    tree[now].sum[4] = tree[lson].sum[4] + tree[rson].sum[4];\n    tree[now].sum[5] = tree[lson].sum[5] + tree[rson].sum[5];\n    return ;\n}\n\nvoid work(ll now,ll k) {\n    tree[now].sum[1] += (tree[now].r - tree[now].l + 1) * k;\n    tree[now].sum[2] += k * tree[now].sum[5];\n    tree[now].sum[3] += k * tree[now].sum[4];\n    tree[now].lazy += k;\n}\n\nvoid pushdown(ll now) {\n    work(lson,tree[now].lazy);\n    work(rson,tree[now].lazy);\n    tree[now].lazy = 0;\n    return ;\n}\n\nvoid modify(ll l,ll r,ll now,ll val) {\n    if(tree[now].l >= l && tree[now].r <= r) {\n        work(now,val);\n        return ;\n    }\n    if(tree[now].lazy) pushdown(now);\n    ll mid = (tree[now].l + tree[now].r) >> 1;\n    if(mid >= l) modify(l,r,lson,val);\n    if(mid < r) modify(l,r,rson,val);\n    updata(now);\n    return ;\n}\n\nvoid query(ll l,ll r,ll now) {\n    if(tree[now].l >= l && tree[now].r <= r)  {\n        sum1 += tree[now].sum[1];\n        sum2 += tree[now].sum[2];\n        sum3 += tree[now].sum[3];\n        return ;\n    }\n    if(tree[now].lazy) pushdown(now);\n    ll mid = (tree[now].l + tree[now].r) >> 1;\n    if(mid >= l) query(l,r,lson);\n    if(mid < r) query(l,r,rson);\n    return ;\n}\n\nint main()\n{   \n    ll n,m,l,r,v;\n    char s[3];\n    n = read();m = read();\n    build(1,n,1);\n    while(m --) {\n        scanf(\"%s\",&s);\n        l = read();r = read() - 1;\n        if(s[0] == 'C') {\n            v = read();\n            modify(l,r,1,v);\n        }\n        else {\n            ll a;\n            sum1 = sum2 = sum3 = 0;\n            query(l,r,1);\n            a = (r - l + 1 - r * l) * sum1 + (r + l) * sum2 - sum3;\n            ll b = ( r - l + 2 ) * (r - l + 1) / 2;\n            ll g = gcd(a,b);\n            printf(\"%lld/%lld\\n\", a / g,b / g);\n        }\n    }\n    return 0;\n}\n```",
        "postTime": 1538638443,
        "uid": 131899,
        "name": "sdgzy",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P2221 \u3010[HAOI2012]\u9ad8\u901f\u516c\u8def\u3011"
    },
    {
        "content": "\n[\u9898\u76ee\u94fe\u63a5](https://www.luogu.com.cn/problem/P2221)\n\n\u533a\u95f4\u52a0\uff0c\u533a\u95f4\u67e5\u8be2\uff0c\u5f88\u5bb9\u6613\u60f3\u5230\u7ebf\u6bb5\u6811\uff0c\u4e0d\u8fc7\u5148\u522b\u6025\uff0c\u6211\u4eec\u5148\u63a8\u5bfc\u4e00\u4e0b\u5728$\\,[l,r]\\,$\u6536\u8d39\u7ad9\u4e2d\u4efb\u610f\u9009\u4e24\u4e2a\u4e0d\u540c\u6536\u8d39\u6808\u671f\u671b\u82b1\u8d39\u7684\u8d39\u7528$\\,C(l,r)\\,$\uff1a\n\n\u4e0d\u59a8\u679a\u4e3e\u9898\u9762\u4e2d\u7684$\\,x,y\\,$\uff0c\u90a3\u4e48\u8d39\u7528\u5c31\u662f$\\,\\sum_{z=x}^{y-1}v_z\\,$\uff0c\u800c\u4e14\u663e\u7136\u6709$\\,(r-l+1)(r-l)/2\\,$\u79cd\u53ef\u80fd\uff0c\u6240\u4ee5\uff1a\n\n$$\nC(l,r)=\\dfrac{2}{(r-l+1)(r-l)}\\left(\\sum_{x=l}^{r}\\sum_{y=x+1}^{r}\\sum_{z=x}^{y-1}v_z\\right) \n$$\n\n\u524d\u9762\u90a3\u4e2a$\\,\\dfrac{2}{(r-l+1)(r-l)}\\,$\u592a\u9ebb\u70e6\u4e86\uff0c\u6211\u4eec\u7b80\u8bb0\u4e3a$\\,\\lambda\\,$\uff0c\u7136\u540e\u6211\u4eec\u5f00\u59cb\u63a8\u5bfc\u5427\uff1a\n\n$$\n\\begin{aligned}\nC(l,r)&=\\lambda\\left(\\sum_{x=l}^{r}\\sum_{y=x+1}^{r}\\sum_{z=x}^{y-1}v_z\\right)\\\\\n&=\\lambda\\left(\\sum_{x=l}^{r}\\sum_{y=x+1}^{r}\\left(\\sum_{z=l}^{y-1}v_z-\\sum_{z=l}^{x-1}v_z\\right)\\right)&\\texttt{\u5c06\u548c\u5f0f\u62c6\u5f00}\\\\\n&=\\lambda\\left(\\sum_{x=l}^{r}\\sum_{y=x+1}^{r}\\sum_{z=l}^{y-1}v_z-\\sum_{x=l}^{r}\\sum_{y=x+1}^{r}\\sum_{z=l}^{x-1}v_z\\right)&\\texttt{\u5c06\u548c\u5f0f\u62c6\u5f00}\\\\\n&=\\lambda\\left(\\sum_{x=l}^{r}\\sum_{y=l}^{r}[x+1\\leqslant y]\\sum_{z=l}^{r}[z\\leqslant y-1]v_z-\\sum_{x=l}^{r}\\sum_{y=l}^{r}[x+1\\leqslant y]\\sum_{z=l}^{r}[z\\leqslant x-1]v_z\\right)\\\\\n&\\!\\!\\!\\!\\!\\!\\!\\!\\!\\!\\!\\!//\\,\\texttt{\u5c06\u542b\u6709\u5faa\u73af\u53d8\u91cf\u7684\u4e0a\u4e0b\u754c\u8f6c\u4e3a\u771f\u503c\u8868\u8fbe\u5f0f\u4ee5\u53ca\u65e0\u5faa\u73af\u53d8\u91cf\u7684\u4e0a\u4e0b\u754c\uff0c\u65b9\u4fbf\u4ea4\u6362\u6c42\u548c\u7b26\u53f7}\\\\\n&=\\lambda\\left(\\sum_{z=l}^{r}v_z\\sum_{y=l}^{r}[z\\leqslant y-1]\\sum_{x=l}^{r}[x+1\\leqslant y]\\!\\!-\\!\\!\\sum_{z=l}^{r}v_z\\sum_{x=l}^{r}[z\\leqslant x-1]\\sum_{y=l}^{r}[x+1\\leqslant y]\\right)&\\texttt{\u4ea4\u6362\u6c42\u548c\u987a\u5e8f}\\\\\n&=\\lambda\\left(\\sum_{z=l}^{r}v_z\\sum_{y=l}^{r}[z\\leqslant y-1]\\sum_{x=l}^{y-1}1-\\!\\!\\sum_{z=l}^{r}v_z\\sum_{x=l}^{r}[z\\leqslant x-1]\\sum_{y=x+1}^{r}1\\right)&\\texttt{\u5c06\u771f\u503c\u8868\u8fbe\u5f0f\u8f6c\u56de\u4e0a\u4e0b\u754c}\\\\\n&=\\lambda\\left(\\sum_{z=l}^{r}v_z\\sum_{y=l}^{r}[z\\leqslant y-1](y-l)-\\sum_{z=l}^{r}v_z\\sum_{x=l}^{r}[z\\leqslant x-1](r-x)\\right)&\\texttt{\u8ba1\u7b97}\\\\\n&=\\lambda\\left(\\sum_{z=l}^{r}v_z\\sum_{x=l}^{r}[z\\leqslant x-1](x-l)-\\sum_{z=l}^{r}v_z\\sum_{x=l}^{r}[z\\leqslant x-1](r-x)\\right)&\\texttt{\u6362\u4e2a\u53d8\u91cf\u540d}\\\\\n&=\\lambda\\left(\\sum_{z=l}^{r}v_z\\sum_{x=l}^{r}[z\\leqslant x-1](2x-l-r)\\right)&\\texttt{\u4e58\u6cd5\u5206\u914d\u5f8b\u5408\u5e76}\\\\\n&=\\lambda\\left(\\sum_{z=l}^{r}v_z\\left(2\\sum_{x=l}^{r}[z+1\\leqslant x]x-(l+r)\\sum_{x=l}^{r}[z+1\\leqslant x]\\right)\\right)&\\texttt{\u4e58\u6cd5\u5206\u914d\u5f8b\u62c6\u5f00}\\\\\n&=\\lambda\\left(\\sum_{z=l}^{r}v_z\\left(2\\sum_{x=z+1}^{r}x-(l+r)\\sum_{x=z+1}^{r}1\\right)\\right)&\\texttt{\u53bb\u6389\u771f\u503c\u8868\u8fbe\u5f0f}\\\\\n&=\\lambda\\left(\\sum_{z=l}^{r}v_z((r+z+1)(r-z)-(l+r)(r-z))\\right)&\\texttt{\u7b49\u5dee\u6570\u5217\u6c42\u548c}\\\\\n&=\\lambda\\left(\\sum_{z=l}^{r}v_z\\left(-z^2+z(r+l-1)-r(l-1)\\right)\\right)&\\texttt{\u62c6\u5f00\u62ec\u53f7}\\\\\n&=\\lambda\\left(-\\sum_{z=l}^{r}z^2v_z+(r+l-1)\\sum_{z=l}^{r}zv_z-r(l-1)\\sum_{z=l}^{r}v_z\\right)&\\texttt{\u4e58\u6cd5\u5206\u914d\u5f8b\u62c6\u5f00}\\\\\n\n\\end{aligned} \n$$\n\n\u5176\u4e2d$\\,\\sum_{z=l}^{r}z^2v_z$\u3001$\\sum_{z=l}^{r}zv_z$\u3001$\\sum_{z=l}^{r}v_z\\,$\u90fd\u662f\u5177\u6709\u7ed3\u5408\u5f8b\u7684\uff0c\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\uff0c\u5269\u4e0b\u7684\u7cfb\u6570\u90fd\u53ea\u548c$\\,l,r\\,$\u6709\u5173\u3002\n\n\u8003\u8651\u4e00\u4e0b\u589e\u91cf$\\,v$\uff1a\n\n$$\n\\begin{aligned}\n\\sum_{z=l}^{r}z^2(v_z+v)&=\\sum_{z=l}^{r}z^2v+\\color{red}{\\sum_{z=l}^{r}z^2v_z}\\\\\n&=v\\sum_{z=l}^{r}z^2+\\color{red}{\\sum_{z=l}^{r}z^2v_z}\\\\\n&=v\\left(\\sum_{z=1}^{r}z^2-\\sum_{z=1}^{l-1}z^2\\right)+\\color{red}{\\sum_{z=l}^{r}z^2v_z}\\\\\n&=\\color{blue}v\\left(\\dfrac{1}{6}r(r+1)(2r+1)-\\dfrac{1}{6}(l-1)l(2l-1)\\right)\\color{black}+\\color{red}{\\sum_{z=l}^{r}z^2v_z}\n\\end{aligned}\n$$\n\n---\n$$\n\\begin{aligned}\n\\sum_{z=l}^{r}z(v_z+v)&=\\sum_{z=l}^{r}zv+\\color{red}{\\sum_{z=l}^{r}zv_z}\\\\\n&=v\\sum_{z=l}^{r}z+\\color{red}{\\sum_{z=l}^{r}zv_z}\\\\\n&=v\\left(\\sum_{z=1}^{r}z-\\sum_{z=1}^{l-1}z\\right)+\\color{red}{\\sum_{z=l}^{r}zv_z}\\\\\n&=\\color{blue}v\\left(\\dfrac{1}{2}r(r+1)-\\dfrac{1}{2}(l-1)l\\right)\\color{black}+\\color{red}{\\sum_{z=l}^{r}z^2v_z}\n\\end{aligned}\n$$\n\n---\n$$\n\\begin{aligned}\n\n\\sum_{z=l}^{r}(v_z+v)&=\\sum_{z=l}^{r}v+\\color{red}{\\sum_{z=l}^{r}v_z}\\\\\n&=v\\sum_{z=l}^{r}1+\\color{red}{\\sum_{z=l}^{r}zv_z}\\\\\n&=\\color{blue}v(r-l+1)\\color{black}+\\color{red}{\\sum_{z=l}^{r}zv_z}\n\\end{aligned}\n$$\n\n\u5176\u4e2d\u84dd\u8272\u7684\u90e8\u5206\u662f\u8fd9\u4e00\u4e2a\u90e8\u5206\u7684\u589e\u91cf\uff0c\u7ea2\u8272\u90e8\u5206\u662f\u539f\u6765\u7684\u7ed3\u679c\u3002\u6c42\u51fa\u4e4b\u540e\u4e4b\u95f4\u6309\u7167\u6211\u4eec\u4e4b\u524d\u7684\u8fd9\u4e2a\u5f0f\u5b50\u6765\u8ba1\u7b97\u7b54\u6848\uff1a\n\n$$\nC(l,r)=\\lambda\\left(-\\sum_{z=l}^{r}z^2v_z+(r+l-1)\\sum_{z=l}^{r}zv_z-r(l-1)\\sum_{z=l}^{r}v_z\\right)\n$$\n\n\u8bb0\u5f97\u7279\u5224$\\,l=r\\,$\u7684\u60c5\u51b5\uff0c\u6b64\u65f6\u5206\u5b50\u5206\u6bcd\u90fd\u4e3a$\\,0$\uff0c\u76f4\u63a5\u8f93\u51fa `0/1`\u3002\n\n---\n\u793a\u4f8b\u4ee3\u7801:\n\n```cpp\n#include <bits/stdc++.h>\nusing i64 = long long;\nusing i128 = __int128;\n\nconst int N = 100010;\nint n, m;\nstruct SegNode\n{\n\tint l, r;\n\ti128 sum, timsum, squsum;\n\ti64 plus;\n};\nSegNode a[N << 2];\n\ntemplate<typename types>\nvoid read(types &x)\n{\n\tx = 0; int f = 1; char ch = getchar();\n\twhile (!isdigit(ch)) {if (ch == '-') f = -1; ch = getchar();}\n\twhile (isdigit(ch)) x = x * 10 + ch - 48, ch = getchar();\n\tx *= f; return;\n}\ntemplate<typename types>\nvoid write(types x)\n{\n\tif (x < 0) putchar('-'), x = -x;\n\tif (x > 9) write(x / 10);\n\tputchar(x % 10 + '0'); return;\n}\ni128 GCD(i128 x, i128 y)\n{\n\treturn y ? GCD(y, x % y) : x;\n}\nvoid pushup(SegNode &x, const SegNode &y, const SegNode &z)\n{\n\tx.sum = y.sum + z.sum;\n\tx.timsum = y.timsum + z.timsum;\n\tx.squsum = y.squsum + z.squsum;\n\treturn;\n}\nvoid plusit(int p, i64 x)\n{\n    a[p].sum += x * (a[p].r - a[p].l + 1);\n\ta[p].timsum += x * (i128(a[p].l + a[p].r) * (a[p].r - a[p].l + 1) / 2);\n\ta[p].squsum += x * (i128(a[p].r) * (a[p].r + 1) * (2ll * a[p].r + 1) / 6 - i128(a[p].l - 1) * a[p].l * (2ll * a[p].l - 1) / 6);\n\ta[p].plus += x;\n    return;\n}\nvoid pushdown(int p)\n{\n\tif (!a[p].plus) return;\n\tplusit(p << 1, a[p].plus);\n\tplusit(p << 1 | 1, a[p].plus);\n\ta[p].plus = 0; return;\n}\nvoid build(int p, int inl, int inr)\n{\n\ta[p].l = inl, a[p].r = inr, a[p].plus = 0;\n\tif (inl == inr)\n\t{\n\t\ta[p].sum = a[p].squsum = a[p].timsum = 0;\n\t\treturn;\n\t}\n\tint mid = (inl + inr) >> 1;\n\tbuild(p << 1, inl, mid),\n\tbuild(p << 1 | 1, mid + 1, inr);\n\tpushup(a[p], a[p << 1], a[p << 1 | 1]); return;\n}\nvoid add(int p, int x, int y, int k)\n{\n\tif (x <= a[p].l && a[p].r <= y)\n\t{\n\t\tplusit(p, k); return;\n\t}\n\tpushdown(p);\n\tint mid = (a[p].l + a[p].r) >> 1;\n\tif (x <= mid) add(p << 1, x, y, k);\n\tif (y > mid) add(p << 1 | 1, x, y, k);\n\tpushup(a[p], a[p << 1], a[p << 1 | 1]); return;\n}\nSegNode ask(int p, int x, int y)\n{\n\tif (x <= a[p].l && a[p].r <= y)\n\t\treturn a[p];\n\tpushdown(p);\n\tint mid = (a[p].l + a[p].r) >> 1;\n\tif (x <= mid && y > mid)\n\t{\n\t\tSegNode res; pushup(res, ask(p << 1, x, y), ask(p << 1 | 1, x, y));\n\t\treturn res;\n\t}\n\telse if (x <= mid) return ask(p << 1, x, y);\n\telse if (y > mid) return ask(p << 1 | 1, x, y);\n\tpushup(a[p], a[p << 1], a[p << 1 | 1]);\n\tputs(\"ERROR\"); exit(0); SegNode res; return res;\n}\n\nint main(void)\n{\n\tread(n), read(m);\n\tbuild(1, 1, n);\n\tint inpl, inpr, inpk; char inpo[2];\n\tfor (int i = 1; i <= m; ++ i)\n\t{\n\t\tscanf(\"%s\", inpo);\n\t\tif (inpo[0] == 'C')\n\t\t{\n\t\t\tread(inpl), read(inpr), read(inpk);\n\t\t\tadd(1, inpl, inpr - 1, inpk);\n\t\t}\n\t\telse if (inpo[0] == 'Q')\n\t\t{\n\t\t\tread(inpl), read(inpr);\n\t\t\tint len = (inpr - inpl + 1);\n\t\t\tif (len == 1) {puts(\"0/1\"); continue;}\n\t\t\tSegNode ans = ask(1, inpl, inpr);\n\t\t\ti128 zi = i128(inpl + inpr - 1) * ans.timsum - i128(inpr) * (inpl - 1) * ans.sum - ans.squsum;\n\t\t\ti128 mu = i128(len) * (len - 1) / 2;\n\t\t\ti128 d = GCD(zi, mu);\n\t\t\tzi /= d, mu /= d;\n\t\t\twrite(zi), putchar('/'), write(mu), putchar('\\n');\n\t\t}\n\t}\n\treturn 0;\n}\n```\n",
        "postTime": 1664767361,
        "uid": 552165,
        "name": "ComplexPlanck",
        "ccfLevel": 0,
        "title": "P2221-Solution"
    },
    {
        "content": "\u8fd9\u9053\u9898\u8981\u6c42\u5bf9\u533a\u95f4\u505a\u4fee\u6539\uff0c\u67e5\u8be2\uff0c\u5e76\u4e14\u6570\u636e\u8303\u56f4\u662f1e5\u3002**\u731c\u6d4b\u89e3\u6cd5\uff1a\u7ebf\u6bb5\u6811**\n\nans=\u8be2\u95ee\u7684\u516c\u8def\u533a\u95f4\u7684\u6240\u6709\u5b50\u533a\u95f4\u6743\u503c\u548c/\u6709\u591a\u5c11\u5b50\u533a\u95f4\u3002\u5206\u6bcd\u53ef\u4ee5\u8fc5\u901f\u7b97\u51fa\uff0c\uff08\u5373\u8bbe\u533a\u95f4\u957f\u5ea6\u4e3aL,\u5206\u6bcd\u4e3a$C_L^2$\uff09\uff0c\u90a3\u4e48\u6211\u4eec\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u5206\u5b50\u5373\u53ef\u3002\n\n\u90a3\u4e48\uff0c\u4e3b\u8981\u77db\u76fe\u5c31\u662fpushup\u600e\u4e48\u5199\uff0c\u5373\u5982\u4f55\u901a\u8fc7\u5de6\u534a\u533a\u95f4$l$\u548c\u53f3\u534a\u533a\u95f4$r$\u7684\u7b54\u6848\u5f97\u5230\u5f53\u524d\u533a\u95f4\u7684\u7b54\u6848\u3002\n\n\u5927\u529b\u4e71\u63a8\u5f97\u5230\u6211\u4eec\u8981\u7ef4\u62a4\u7684\u4e1c\u897f\uff1a\u7b54\u6848$ans(x)$\uff0c\u533a\u95f4\u6743\u503c\u548c$sum(x)$\uff0c\u533a\u95f4\u957f\u5ea6$len(x)$\uff0c\u4ece\u6700\u5de6\u7aef\u5f00\u59cb\u7684\u8fde\u7eed\u5b50\u533a\u95f4\u6743\u503c\u548c\uff0c\u5373$ls(x)=\\sum_{r=1}^{len}\\sum_{i=1}^rv_i$\uff0c\u4ece\u6700\u53f3\u7aef\u5f00\u59cb\u7684\u8fde\u7eed\u5b50\u533a\u95f4\u548c\uff0c\u5373$rs(x)=\\sum_{l=1}^{len}\\sum_{i=l}^{len}v_i$\n\n\u90a3\u4e48:\n\n$sum(x)=sum(l)+sum(r)$\n\n$len(x)=len(l)+len(r)$\n\n$ls(x)=ls(l)+(ls(r)+sum(l)*len(r))$\n\n$rs(x)=rs(r)+(rs(l)+sum(r)*len(l))$\n\n$ans(x)=ans(l)+ans(r)+rs(l)*len(r)+ls(r)*len(l)$\n\n\u89e3\u91ca\u4e00\u4e0b\u6700\u540e\u4e00\u4e2a\u5f0f\u5b50\uff0c\u9996\u5148\u8003\u8651\u5168\u5728\u5de6\u534a\u533a\u95f4\u7684\u5b50\u533a\u95f4\uff0c\u518d\u8003\u8651\u5168\u5728\u53f3\u534a\u533a\u95f4\u7684\uff0c\u6700\u540e\u8003\u8651\u8de8\u8d8a\u7684\uff0c\u8fd9\u4e2a\u7528\u4e00\u79cd\u201c\u8d21\u732e\u201d\u7684\u601d\u60f3\u8003\u8651\uff0c\u6bcf\u4e2a\u4ece\u5de6\u534a\u533a\u95f4\u53f3\u8fb9\u5f00\u59cb\u7684\u5b50\u533a\u95f4\uff0c\u90fd\u4f1a\u4e0e\u53f3\u534a\u533a\u95f4\u4e00\u4e2a\u53f3\u7aef\u70b9\u7ed3\u5408\uff0c\u53f3\u534a\u533a\u95f4\u5de6\u8fb9\u5f00\u59cb\u7684\u5b50\u533a\u95f4\u540c\u7406\u3002\n\n\u7136\u540e\u5c31\u662f\u4fee\u6539\u64cd\u4f5c\u4e86\uff0c\u5047\u8bbe\u6211\u4eec\u8981\u5728$x$\u533a\u95f4\u4e0a\u5bf9\u6bcf\u4e2a\u6570\u52a0\u4e0a\u503c$c$\uff0c\u90a3\u4e48\uff1a\n\n$sum(x)+=len(x)*c$\n\n$ls(x)+=\\frac{len(x)(len(x)+1)}{2}*c$\n\n$rs(x)+=\\frac{len(x)(len(x)+1)}{2}*c$\n\n\u95ee\u9898\u6765\u4e86\uff0c$ans(x)$\u600e\u4e48\u529e\u5462\uff1f\u8003\u8651\u957f\u5ea6\u4e3ai\u7684\u5b50\u533a\u95f4\u6709\u591a\u5c11\u4e2a\n\n$ans(x)+=\\sum_{i=1}^{len(x)} i*(len(x)-i+1)*c$\n\n$ans(x)+=(len(x)*\\frac{(1+len(x))len(x)}{2}-\\sum_{i=1}^{len(x)}(i-1)i)*c$\n\n\u8bbe$s=\\sum_{i=1}^{len(x)}(i-1)$\n\n\u5219$s+\\frac{len(x)(len(x)-1)}{2}=\\sum_{i=1}i^2=\\frac{len(x)(len(x)+1)(2*len(x)+1)}{6}$\n\n\u6240\u4ee5$ans(x)+=(\\frac{(1+len(x))^2len(x)}{2}-\\frac{len(x)(len(x)+1)(2*len(x)+1)}{6})*c$\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nint read() {\n\tint q=0,w=1;char ch=' ';\n\twhile(ch!='-'&&(ch<'0'||ch>'9')) ch=getchar();\n\tif(ch=='-') w=-1,ch=getchar();\n\twhile(ch>='0'&&ch<='9') q=q*10+ch-'0',ch=getchar();\n\treturn q*w;\n}\n#define RI register int\ntypedef long long LL;\nconst int N=100005;\nint n,m;LL ls[N<<2],rs[N<<2],sum[N<<2],laz[N<<2],ans[N<<2];\n\nvoid pd(int s,int t,int i) {//pushdown\u51fd\u6570\n\tint mid=(s+t)>>1,l=i<<1,r=(i<<1)|1;\n\tLL lc=mid-s+1,rc=t-mid,v=laz[i];\n\tlaz[l]+=v,laz[r]+=v,sum[l]+=lc*v,sum[r]+=rc*v;\n\tls[l]+=lc*(lc+1)/2*v,rs[l]+=lc*(lc+1)/2*v;\n\tls[r]+=rc*(rc+1)/2*v,rs[r]+=rc*(rc+1)/2*v;\n\tans[l]+=((1+lc)*lc/2*(1+lc)-lc*(lc+1)*(2*lc+1)/6)*v;\n\tans[r]+=((1+rc)*rc/2*(1+rc)-rc*(rc+1)*(2*rc+1)/6)*v;\n\tlaz[i]=0;\n}\nvoid up(int s,int t,int i) {//pushup\u51fd\u6570\n\tint l=i<<1,r=(i<<1)|1,mid=(s+t)>>1;\n\tsum[i]=sum[l]+sum[r];\n\tls[i]=ls[l]+ls[r]+1LL*(t-mid)*sum[l];\n\trs[i]=rs[l]+rs[r]+1LL*(mid-s+1)*sum[r];\n\tans[i]=ans[l]+ans[r]+1LL*(mid-s+1)*ls[r]+1LL*(t-mid)*rs[l];\n}\nvoid chan(int l,int r,int s,int t,int i,LL v) {\n\tif(l==s&&t==r) {\n\t\tlaz[i]+=v,sum[i]+=1LL*(t-s+1)*v;LL len=t-s+1;\n\t\tls[i]+=len*(len+1)/2*v,rs[i]+=len*(len+1)/2*v;\n\t\tans[i]+=((1+len)*len/2*(1+len)-len*(len+1)*(2*len+1)/6)*v;\n\t\treturn;\n\t}\n\tint mid=(s+t)>>1;\n\tif(laz[i]) pd(s,t,i);\n\tif(r<=mid) chan(l,r,s,mid,i<<1,v);\n\telse if(mid+1<=l) chan(l,r,mid+1,t,(i<<1)|1,v);\n\telse chan(l,mid,s,mid,i<<1,v),chan(mid+1,r,mid+1,t,(i<<1)|1,v);\n\tup(s,t,i);\n}\nstruct node{LL sum,ls,rs,len,ans;};\nnode query(int l,int r,int s,int t,int i) {\n\tif(l==s&&t==r) return (node){sum[i],ls[i],rs[i],t-s+1,ans[i]};\n\tint mid=(s+t)>>1;\n\tif(laz[i]) pd(s,t,i);\n\tif(r<=mid) return query(l,r,s,mid,i<<1);\n\telse if(mid+1<=l) return query(l,r,mid+1,t,(i<<1)|1);\n\telse {\n\t\tnode k1=query(l,mid,s,mid,i<<1),k2=query(mid+1,r,mid+1,t,(i<<1)|1),re;\n\t\tre.sum=k1.sum+k2.sum;\n\t\tre.ls=k1.ls+k2.ls+k1.sum*k2.len;\n\t\tre.rs=k1.rs+k2.rs+k2.sum*k1.len;\n\t\tre.ans=k1.ans+k2.ans+k1.rs*k2.len+k1.len*k2.ls;\n\t\tre.len=k1.len+k2.len;\n\t\treturn re;\n\t}\n}\nLL gcd(LL a,LL b) {return !b?a:gcd(b,a%b);}\nint main()\n{\n\tchar ch[10];int x,y,z;\n\tn=read(),m=read();\n\twhile(m--) {\n\t\tscanf(\"%s\",ch),x=read(),y=read();\n\t\tif(ch[0]=='C') chan(x,y-1,1,n,1,read());\n\t\telse {\n\t\t\tnode QvQ=query(x,y-1,1,n,1);\n\t\t\tLL ans1=QvQ.ans,ans2=1LL*(y-x+1)*(y-x)/2,kl=gcd(ans2,ans1);\n\t\t\tprintf(\"%lld/%lld\\n\",ans1/kl,ans2/kl);\n\t\t}\n\t}\n    return 0;\n}\n```",
        "postTime": 1522315721,
        "uid": 20604,
        "name": "litble",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P2221 \u3010[HAOI2012]\u9ad8\u901f\u516c\u8def\u3011"
    },
    {
        "content": "# \u5199\u5728\u524d\u9762\n\n\u6700\u8fd1\u671f\u671b\u5b66\u7684\u5934\u5927\u3002\u597d\u4e45\u6ca1\u6709\u81ea\u5df1 AC \u7d2b\u9898\u4e86\uff0c\u78b0\u5de7\u8fd9\u9053\u9898\u8ba9\u6211\u5b9e\u73b0\u4e86\u3002AC \u540e\u6253\u5f00\u9898\u89e3\u53d1\u73b0 1k \u591a\u4eba\u63d0\u4ea4\u7adf\u7136\u8fd8\u6ca1\u6709\u5173\u95ed\u9898\u89e3\u901a\u9053\uff1f\u90a3\u8d76\u7d27\u6765\u5199\u4e00\u53d1\u3002\n\n## \u524d\u7f6e\u77e5\u8bc6\n\n- \u7ebf\u6bb5\u6811\n- \u671f\u671b\u3001\u6982\u7387\n- \u8f97\u8f6c\u76f8\u9664\u6cd5\n\n## \u9898\u76ee\u63cf\u8ff0\uff08\u6233\u8fd9\u91cc[\u67e5\u770b\u539f\u9898](https://www.luogu.com.cn/problem/P2221)\uff09\n\n- \u7ed9\u5b9a\u6570\u8f74\u4e0a $n$ \u4e2a\u70b9\uff0c$n - 1$ \u4e2a**\u76f8\u90bb\u70b9**\u7684\u7ebf\u6bb5\u3002$v_i$ \u8868\u793a\u7ebf\u6bb5 $[i, i+1]$ \u7684\u503c\u3002\u521d\u59cb\u65f6\u5bf9\u4e8e $\\forall i \\in [1, n-1]$\uff0c$ v_i = 0$\u3002\n\n- \u5b9a\u4e49\u5982\u4e0b\u4e24\u4e2a\u64cd\u4f5c\uff08\u603b\u5171 $m$ \u6b21\uff09\uff1a\n\n\t- **\u66f4\u6539**\uff1a\u7ed9\u5b9a $l$\u3001$r$\u3001$v$\uff0c\u5c06 $[l,r]$ \u4e2d\u6240\u6709\u7ebf\u6bb5\u7684\u503c\u589e\u52a0 $v$\u3002\n    - **\u8be2\u95ee**\uff1a\u7ed9\u5b9a $l$\u3001$r$\uff0c\u6c42\u5728 $[l,r]$ **\u7b49\u6982\u7387\u4efb\u610f**\u53d6**\u4e0d\u540c**\u4e24\u70b9 $a$\u3001$b$\uff0c\u6c42 $[a,b]$ **\u8986\u76d6\u7684\u7ebf\u6bb5\u7684\u503c\u7684\u671f\u671b**\u3002\n\n- \u5bf9\u4e8e\u8be2\u95ee\uff0c\u8f93\u51fa\u4e00\u4e2a**\u5206\u6570**\uff0c\u8981\u6c42**\u4e0d\u80fd\u518d\u7ea6\u5206**\u3002\n    \n- $1 \u2264 n, m \u2264 10^5$\uff0c\u4fdd\u8bc1 $0 \u2264 v_i \u2264 10^4$\u3002\n\n# \u6b63\u6587\n\n## \u786e\u5b9a\u65b9\u5411\n\n\u5bf9\u4e8e\u6c42\u671f\u671b\uff0c\u6211\u5927\u81f4\u603b\u7ed3\u4e86 3 \u79cd\u65b9\u6cd5\uff1a\n\n1. \u671f\u671b DP\uff08\u4e00\u822c\u662f\u9006\u63a8\uff09\n2. \u6839\u636e\u671f\u671b\u5b9a\u4e49\u63a8\u5f0f\u5b50\n3. \u7531\u671f\u671b\u7684\u7ebf\u6027\u6027\uff0c\u901a\u8fc7\u7ed3\u5408\u6982\u7387\u548c\u53d8\u91cf\u6c42\u89e3\n\n\u90a3\u4e48\u5bf9\u4e8e\u8fd9\u9053\u9898\uff0c\u7b2c\u4e00\u79cd\u65b9\u6cd5\u663e\u7136\u662f\u4e0d\u884c\u7684\uff0c\u53ea\u5e26 $\\log$ \u7684 DP \u6211\u505a\u8fd9\u4e48\u591a\u9898\u8fd8\u6ca1\u89c1\u8fc7\u3002\u56e0\u6b64\u6211\u4eec\u66f4\u591a\u4ece\u671f\u671b\u7684\u5b9a\u4e49\u4ee5\u53ca\u5176\u4e0e\u6982\u7387\u7684\u5173\u7cfb\u5165\u624b\u6b64\u9898\u3002\n\n## \u5206\u6790\n\n\u6839\u636e\u6b64\u9898\u4e2d\u671f\u671b\u7684\u5b9a\u4e49\uff0c\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u6c42\u51fa\u6240\u6709\u60c5\u51b5\u7684\u901a\u884c\u8d39\u7528\uff0c\u5e76\u5c06\u6bcf\u79cd\u60c5\u51b5\u4e58\u4ee5\u5176\u5bf9\u5e94\u7684\u6982\u7387\u5f97\u5230\u603b\u671f\u671b\u3002   \n\u53c8\u7531\u4e8e\u6240\u6709\u60c5\u51b5\u90fd\u662f\u7b49\u6982\u7387\uff0c\u6211\u4eec\u53ef\u4ee5\u7b97\u51fa\u6240\u6709\u60c5\u51b5\u8d39\u7528\u603b\u548c\uff0c\u4e58\u4ee5\u540c\u4e00\u6982\u7387\u3002\u5199\u51fa\u6765\u7684\u5f0f\u5b50\u5199\u51fa\u6765\u5927\u6982\u662f\uff1a\n\t\n  $E(l,r) = \\dfrac 1 {P(l,r)} \\times Sum_v $\n   \n\u5148\u6765\u6c42 ${P(l,r)}$\u3002\u8be2\u95ee\u533a\u95f4 $[l,r]$ \u7684\u957f\u5ea6 $len = r-l+1$\u3002\u70b9 $a$ \u5728\u533a\u95f4\u4e2d\u7b49\u6982\u7387\u9009\u62e9\uff0c$P(a) = \\dfrac1 {len}$\u3002$b$ \u5728\u5269\u4e0b\u7684 $len - 1$ \u4e2a\u70b9\u4e2d\u7b49\u6982\u7387\u9009\u62e9\uff0c$P(b) = \\dfrac1 {len-1}$\u3002\u56e0\u800c\uff1a\n\n$P(l,r) = P(a)\\times P(b) = \\dfrac 1 {len\\times (len-1)} = \\dfrac 1 {(r-l+1)\\times (r-l)}$\u3002\n\n\u56e0\u6b64\u5206\u6bcd\u90e8\u5206\u5c31\u662f\u6211\u4eec\u6c42\u51fa\u7b54\u6848\u7684**\u5206\u6bcd**\u3002\n\n\n------------\n\n\n\u518d\u6765\u8003\u8651\u5206\u5b50\uff0c\u4e5f\u5c31\u662f\u6240\u6709\u60c5\u51b5\u7684\u8d39\u7528\u548c\u3002\u6211\u4eec\u770b\u4e00\u770b\u6837\u4f8b\u7684\u6700\u540e\u4e00\u6b21\u8be2\u95ee\u3002\u8be2\u95ee $[1,4]$\u3002\u5bf9\u5e94 $P(1,4) = \\dfrac 1 {12}$\u3002\u5bf9\u5e94\u7684\u5206\u5b50\uff0c\u4e5f\u5c31\u662f\u6240\u6709\u60c5\u51b5\u7684\u603b\u8d39\u7528\uff0c\u6211\u4eec\u901a\u8fc7\u56fa\u5b9a\u8d77\u70b9\u627e\u7ec8\u70b9\uff0c\u603b\u548c\u4e3a $34$\uff08**\u6ce8\u610f\u6b63\u53cd\u5411**\uff09\u3002\u56e0\u6b64\u7b54\u6848 $E(1,4) = \\dfrac {34} {12} = \\dfrac {17} 6$\u3002\n\n\u5982\u4f55\u6c42\u5462\uff1f\u5728\u6211\u4eec\u624b\u52a8\u6a21\u62df\u65f6\u5b9a\u8d77\u70b9\u627e\u7ec8\u70b9\u5f88\u9ebb\u70e6\uff0c\u5bf9\u4e8e\u7a0b\u5e8f\u6765\u8bf4\u662f $O(n^2)$ \u7684\uff0c\u800c\u4e14\u6709\u8bb8\u591a\u4e0d\u540c\u7684\u533a\u95f4\u3002\u6211\u4eec\u4e0d\u59a8\u628a\u95ee\u9898\u62c6\u89e3\u6210**\u8ba1\u7b97\u6bcf\u4e00\u4e2a\u76f8\u90bb\u7ebf\u6bb5\u5bf9\u7b54\u6848\u7684\u8d21\u732e**\u3002\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/95diafbf.png)\n\n\u62ff\u7ebf\u6bb5 $[1,2]$ \u4e3e\u4f8b\u3002\u8d77\u70b9\u4e3a 1\uff0c\u8def\u7a0b\u8986\u76d6 $3$ \u6b21\uff08\u84dd\u8272\uff09\uff0c\u8d77\u70b9 2\u30013\u30014 \u5206\u522b\u8986\u76d6 $1$ \u6b21\uff08\u7eff\u8272\uff09\u3002\u6240\u4ee5\u5b83\u5bf9\u6700\u540e\u5f97\u5206\u5b50\u8d21\u732e\u4e86 $6$ \u6b21\u81ea\u5df1\u7684\u8d39\u7528\u3002\n\n\u7ee7\u7eed\u601d\u8003\u3002**\u5728\u8be2\u95ee\u533a\u95f4\u4e2d**\uff0c\u7ebf\u6bb5 $[1,2]$ \u5de6\u4fa7\u7684\u7aef\u70b9\u53ea\u6709 $1$ **\u8fd9\u4e00\u4e2a**\uff0c\u53f3\u4fa7\u603b\u5171\u6709**\u4e09\u4e2a\u70b9**\u3002\u6b63\u5411\u53cd\u5411\u603b\u5171 $2\\times(1\\times 3) = 6$\u3002\u4f3c\u4e4e\u4e00\u6761\u7ebf\u6bb5\u5bf9\u6700\u540e\u603b\u548c\u7684\u8d21\u732e\u53ea\u4e0e\u5b83\u5de6\u53f3\u6709\u591a\u5c11\u8d77\u7ec8\u70b9\u6709\u5173\uff1f\u7ec6\u60f3\u786e\u5b9e\u5408\u7406\u3002\u6211\u4eec\u8bbe\u7ebf\u6bb5\u5de6\u4fa7\u6709 $p$ \u4e2a\u53ef\u80fd\u7684\u8d77\u70b9\uff0c\u53f3\u4fa7\u6709 $q$ \u4e2a\u53ef\u80fd\u7684\u7ec8\u70b9\uff0c\u6839\u636e\u4e58\u6cd5\u539f\u7406\uff0c\u5305\u542b\u8be5\u7ebf\u6bb5\u7684\u8def\u5f84\u603b\u5171\u6709 $p\\times q$ \u4e2a\u3002\u8003\u8651\u6b63\u53cd\u5411\u518d\u4e58\u4ee5 $2$\u3002\u5e26\u5165\u7ebf\u6bb5 $[2,3]$ \u9a8c\u8bc1\u6210\u529f\u3002\uff08$8=2\\times(2 \\times 2)$\uff09\n\n\u6545\u5bf9\u4e8e\u8be2\u95ee\u533a\u95f4 $[l,r]$ \u7684\u4e00\u6761\u76f8\u90bb\u7ebf\u6bb5 $[i,i+1]$\uff0c\u6709\uff1a\n\n$p = i-l+1$\uff1b$q = r-(i+1)+1 = r-i$\u3002\uff08\u5c31\u662f\u533a\u95f4\u957f\u5ea6\uff09\n\n\u6240\u4ee5\u6211\u4eec\u7684\u5206\u5b50\u53ef\u4ee5\u8868\u793a\u6210\u6bcf\u4e2a\u76f8\u90bb\u70b9\u7ebf\u6bb5\u8d21\u732e\u7684\u6b21\u6570\u4e58\u4ee5\u5176\u8d39\u7528\uff08\u6ce8\u610f**\u53f3\u8fb9\u754c**\uff09\uff1a\n\n$$ \\displaystyle \\sum_{i = l}^{r-1} {(i-l+1)\\times(r-i)\\times v_i} $$\n\n\n## \u5b9e\u73b0\n\n\u5bf9\u4e8e\u4e0a\u8ff0\u5f0f\u5b50\uff0c\u4ee5\u53ca\u6570\u636e\u8303\u56f4\uff0c\u6211\u4eec\u77e5\u9053\u6700\u597d\u901a\u8fc7\u6570\u636e\u7ed3\u6784\u7ef4\u62a4\u3002\u53c8\u6709\u533a\u95f4\u52a0\u64cd\u4f5c\uff0c\u6211\u4eec\u8003\u8651\u7ebf\u6bb5\u6811\u3002\n\n\u7136\u800c\uff0c\u8fd9\u4e2a\u5f0f\u5b50\u91cc\u90fd\u662f\u4e58\u6cd5\uff0c\u600e\u4e48\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u533a\u95f4\u548c\u5462\uff1f\n\n\u6211\u89c9\u5f97\u5927\u5bb6\u521a\u5b66\u7ebf\u6bb5\u6811\u7684\u65f6\u5019\u5e94\u8be5\u90fd\u505a\u8fc7\u7c7b\u4f3c\u7ef4\u62a4\u9ad8\u6b21\u548c\u7684\u7ebf\u6bb5\u6811\u9898\uff0c\u8fd9\u9898\u6211\u4eec\u4e5f\u53ef\u4ee5\u8fd9\u4e48\u5c1d\u8bd5\uff0c\u6bd5\u7adf\u5bf9\u7ebf\u6bb5\u6811\u7684\u6697\u793a\u5df2\u7ecf\u5f88\u5f3a\u70c8\u4e86\uff0c\u5982\u679c\u4e0d\u5f80\u4e0b\u60f3\u60f3\u592a\u53ef\u60dc\u3002\n\n\u65e2\u7136\u6709\u4e58\u6cd5\uff0c\u6211\u4eec\u5c31**\u62c6\u4e58\u6cd5**\u3002\u5408\u5e76\u540c\u6b21\u9879\u770b\u770b\u80fd\u4e0d\u80fd\u6709\u4ec0\u4e48\u65b0\u53d1\u73b0\uff0c\u6709\uff1a\n\n$$\\begin{aligned}\n&\\displaystyle \\sum_{i = l}^{r-1} {(i-l+1)\\times(r-i)\\times v_i}  \\\\\n\n&=\\displaystyle \\sum {(i\\times r -i^2-l\\times r+i\\times l+r-i)\\times v_i} \\\\\n\n&=\\displaystyle \\sum {[(r-l\\times r)+(l+r-1)\\times i - i^2]\\times v_i}  \\\\\n\n&=\\displaystyle (r-l\\times r)\\times \\sum_{i = l}^{r-1}{v_i} + (l+r-1)\\times \\sum_{i = l}^{r-1}{i\\times v_i} - \\sum_{i = l}^{r-1}{i^2\\times v_i}\n\\end{aligned}\n$$\n\n\u8fd9\u6837\u6211\u4eec\u6210\u529f\u5c06\u539f\u5f0f\u5206\u79bb\u3002\u5bf9\u4e8e $v_i$\u3001$i\\times v_i$\u3001$i^2\\times v_i$\uff0c\u5c31\u53ef\u4ee5\u8003\u8651\u5982\u4f55\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u4e86\u3002\n\n\u5177\u4f53\u7684\uff0c\u6211\u4eec\u5c06\u8fd9\u4e09\u4e2a\u548c\u5206\u522b\u7ef4\u62a4\u3002\u5bf9\u4e8e\u533a\u95f4 $[l,r]$ \u589e\u52a0 $v$ \u7684\u64cd\u4f5c\uff1a\n\n- **$v_i$**\uff1a\u5bf9\u4e8e\u4e00\u4e2a\u8282\u70b9 $now$ \u6240\u7ef4\u62a4\u7684\u548c\u53ea\u9700\u8981\u589e\u52a0\u533a\u95f4\u957f\u5ea6\u4e58\u4ee5 $v$ \u5373\u53ef\uff0c\u5373\u7ef4\u62a4\u7684\u503c\u589e\u52a0 $len_{now}\\times v$\u3002\n\n- **$i\\times v_i$**\uff1a\u8fd9\u662f\u5c31\u4e0d\u662f\u7b80\u5355\u4e58\u4ee5\u533a\u95f4\u957f\u4e86\u3002\u6bcf\u4e2a\u70b9\u5b9e\u9645\u589e\u52a0\u7684\u503c\u662f**\u4e0d\u540c\u7684**\uff0c\u589e\u52a0\u7684\u503c\u53ef\u8868\u793a\u4e3a\uff1a$v\\times \\sum_{i=l}^{r}{i}$\u3002\u56e0\u6b64\u6211\u4eec\u8981\u8bb0\u5f55\u6bcf\u4e2a\u533a\u95f4\u7684 $\\sum_{i=l}^{r}{i}$\uff0c\u8fd9\u53ef\u4ee5\u5728\u5efa\u6811\u65f6\u6c42\u51fa\u3002\n\n- **$i^2\\times v_i$**\uff1a\u540c\u7406\uff0c\u8bf7\u8bfb\u8005\u601d\u8003\uff0c\u6700\u7ec8\u6211\u4eec\u5728\u5efa\u6811\u65f6\u8981\u6c42\u5f97 $\\sum_{i=l}^{r}{i^2}$\u3002\n\n\u8fd9\u6837\u6211\u4eec\u5c31\u5b8c\u5168\u641e\u901a\u8fd9\u9053\u9898\u5566\uff01\n\n## \u7ec6\u8282\u4e0e\u6ce8\u610f\n\n1. \u7ebf\u6bb5\u6811\u7ef4\u62a4\u7684\u662f $n-1$ \u4e2a\u7ebf\u6bb5\uff0c\u800c\u4e0d\u662f $n$ \u4e2a\u70b9\uff0c\u540c\u6837\u6839\u636e\u5b9a\u4e49\uff0c\u5728\u4fee\u6539\u548c\u67e5\u8be2\u65f6\u6211\u4eec\u4f7f\u7528\u7684\u533a\u95f4\u662f $[l,r-1]$\uff08\u6839\u636e\u8f93\u5165\u7684 $l$\u3001$r$\uff09\u3002\n\n2. \u6ce8\u610f\u8be2\u95ee\u7ed3\u679c\u8f93\u51fa\u6700\u7b80\u5206\u6570\uff0c\u5bf9\u4e8e\u6c42\u51fa\u7684\u5206\u5b50\u5206\u6bcd\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7**\u6b27\u51e0\u91cc\u5f97\u7b97\u6cd5**\u8ba1\u7b97\u516c\u56e0\u5b50\uff0c\u7136\u540e\u540c\u65f6\u9664\u6389\u5373\u53ef\u3002\n\n3. \u8003\u8651\u4e00\u4e0b\u662f\u5426\u4f1a\u7206 ```int```\u3002\u4e58\u79ef\u6700\u5927\u5e94\u5f53\u662f $(\\dfrac n 2) ^2 = 2.5\\times 10^9$\uff0c\u4e58\u4e0a\u6700\u5927\u8d21\u732e $1\\times 10^4$ \u4ee5\u53ca\u6700\u5927\u8be2\u95ee\u533a\u95f4\u5927\u6982 $5\\times 10^4$\uff0c\u5219\u6700\u540e\u5206\u5b50\u7684\u6570\u91cf\u7ea7\u53ef\u81f3 $1\\times 10^{18}$\u3002\u540c\u6837\u5206\u6bcd\u4e5f\u4f1a\u7206\u3002**\u9700\u8981 ```long long```**\u3002\uff08\u5177\u4f53\u4f55\u5904\u8981\u5f00\u4f55\u5904\u4e0d\u8981\uff0c\u8bf7\u4ed4\u7ec6\u601d\u8003\uff0c\u5acc\u9ebb\u70e6\u76f4\u63a5 ```define int long long;``` \u4e5f\u662f\u53ef\u4ee5\u7684\uff09\u3002\n\n\u6700\u7ec8\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u662f $O(n\\log n)$\u3002\n\n# \u4ee3\u7801\n\n\u53d8\u91cf\u540d\u89c1\u6ce8\u91ca\u3002\uff08\u5176\u5b9e\u8fd9\u7b97\u662f\u5f88\u597d\u8c03\u7684\u7ebf\u6bb5\u6811\u4e86\n\n\n```cpp\n#include <iostream>\n#include <algorithm>\n#include <cstring>\n\n#define ls (id << 1)\n#define rs (id << 1 | 1)\n#define mid ((l + r) >> 1)\n\nusing namespace std;\ntypedef long long ll;//\u4f18\u96c5\u4e00\u70b9\u4e0d\u5168\u7528long long\uff0c\u5c31\u662f\u8c03\u7684\u4e45\u4e00\u70b9\u0ca5_\u0ca5\nconst int maxn = 100005;\n\nstruct SegmentTree{\n    ll sum0, sum1, sum2;\n    /* \u6839\u636e\u4e58i\u7684\u6b21\u6570\u547d\u540d\u3002sum0\u5c31\u662fv[i]*i^0=v[i], sum1\u5c31\u662fv[i]*i,sum2\u5c31\u662fv[i]*i^2 */\n    ll len, tot1, tot2;\n    /* len\u662f\u533a\u95f4\u957f\uff0ctot1/2\u5c31\u662fsum{i}\u548csum{i^2} */\n    ll lazy;//\u61d2\u6807\u8bb0\n}tr[maxn << 2];\nint n, m;\nstruct Node{//\u7ebf\u6bb5\u6811\u8fd4\u56de\u503c\n    ll sum0, sum1, sum2;\n\n    Node operator + (const Node &b) const{//\u91cd\u8f7d\u8fd0\u7b97\u7b26\u65b9\u4fbf\u8fd4\u56de\n        Node res;\n        res.sum0 = sum0 + b.sum0;\n        res.sum1 = sum1 + b.sum1;\n        res.sum2 = sum2 + b.sum2;\n        return res;\n    }\n};\n\nvoid pushup(int id){//\u901a\u7528 pushup\n    tr[id].sum0 = tr[ls].sum0 + tr[rs].sum0;\n    tr[id].sum1 = tr[ls].sum1 + tr[rs].sum1;\n    tr[id].sum2 = tr[ls].sum2 + tr[rs].sum2;\n}\n\nvoid build(int id, int l, int r){\n    tr[id].len = r - l + 1;\n    tr[id].lazy = 0;\n    if (l == r){\n        tr[id].sum0 = tr[id].sum1 = tr[id].sum2 = 0;\n        tr[id].tot1 = l, tr[id].tot2 = (ll)l * r;/* \u6ce8\u610f\u7206int\u95ee\u9898 */\n        return;\n    }\n    build(ls, l, mid), build(rs, mid+1, r);\n    pushup(id);\n    /* \u989d\u5916 pushup \u522b\u5fd8\u4e86 */\n    tr[id].tot1 = tr[ls].tot1 + tr[rs].tot1;\n    tr[id].tot2 = tr[ls].tot2 + tr[rs].tot2;\n}\n\nvoid pushdown(int id){\n    if (tr[id].lazy){\n        ll temp = tr[id].lazy;\n        tr[id].lazy = 0;\n        tr[ls].lazy += temp, tr[rs].lazy += temp;\n        tr[ls].sum0 += tr[ls].len * temp,\n        tr[ls].sum1 += tr[ls].tot1 * temp,\n        tr[ls].sum2 += tr[ls].tot2 * temp;\n        tr[rs].sum0 += tr[rs].len * temp,\n        tr[rs].sum1 += tr[rs].tot1 * temp,\n        tr[rs].sum2 += tr[rs].tot2 * temp;\n    }\n}\n\nvoid update(int id, int l, int r, int a, int b, int v){\n    if (a <= l && r <= b){\n        tr[id].sum0 += tr[id].len * v,\n        tr[id].sum1 += tr[id].tot1 * v,\n        tr[id].sum2 += tr[id].tot2 * v;\n        tr[id].lazy += v;\n        return;\n    }\n    pushdown(id);\n    if (a <= mid) update(ls, l, mid, a, b, v);\n    if (b > mid) update(rs, mid+1, r, a, b, v);\n    pushup(id);\n}\n\nNode query(int id, int l, int r, int a, int b){\n    if (a <= l && r <= b){\n        return (Node){tr[id].sum0, tr[id].sum1, tr[id].sum2};\n    }\n    pushdown(id);\n    Node res = (Node){0, 0, 0};\n    if (a <= mid) res = res + query(ls, l, mid, a, b);\n    if (b > mid) res = res + query(rs, mid+1, r, a, b);\n    return res;\n}\n\nll gcd(ll a, ll b){\n    return b ? gcd(b, a % b) : a;\n}\n\nint main(){\n    ios::sync_with_stdio(false);\n    cin.tie(0), cout.tie(0);\n\n    cin >> n >> m;\n\n    build(1, 1, n);\n\n    char op;\n    int l, r, v;\n    while (m --){\n        cin >> op;\n        if (op == 'C'){\n            cin >> l >> r >> v;\n            update(1, 1, n, l, r-1, v);\n        }\n        else{\n            cin >> l >> r;\n            ll N, D;//numerator\u5206\u5b50, denominator\u5206\u6bcd\n            Node temp = query(1, 1, n, l, r-1);\n            N = (r - (ll)l * r) * temp.sum0 + (l + r - 1) * temp.sum1 - temp.sum2;\n            N <<= 1;\n            D = (ll)(r - l + 1) * (r - l);/* \u518d\u6b21\u6ce8\u610f\u7206int\u95ee\u9898 */\n            ll d = gcd(N, D);\n            cout << N/d << '/' << D/d << endl;\n        }\n    }\n\n    return 0;\n}\n```\n\n# \u603b\u7ed3\n\n\u4e3b\u8981\u662f\u5b66\u4e60\u4e00\u4e0b\u7ebf\u6bb5\u6811\u548c\u671f\u671b\u7684\u7ed3\u5408\u3002\u4e00\u5b9a\u8bb0\u4f4f\u671f\u671b\u4e0d\u53ea\u6709 DP \u4e00\u79cd\u5b9e\u73b0\u65b9\u6cd5\u3002\u518d\u9047\u5230\u590d\u6742\u5f0f\u5b50\u4e0d\u80fd\u76f4\u63a5\u4e0a\u7ebf\u6bb5\u6811\u65f6\u8981\u52c7\u4e8e\u62c6\u9879\u5408\u5e76\u540c\u7c7b\u9879\u3002\u77aa\u773c\u6cd5\u6ca1\u6709\u7528\uff0c\u53ea\u6709\u52c7\u4e8e\u5c1d\u8bd5\u591a\u79cd\u65b9\u6cd5\uff0cAC \u624d\u4f1a\u5230\u6765\u3002\n\n\u611f\u8c22\u89c2\u770b\uff01\n",
        "postTime": 1660383568,
        "uid": 528114,
        "name": "jjsnam",
        "ccfLevel": 6,
        "title": "P2221\u9898\u89e3"
    },
    {
        "content": "\u4e3b\u8981\u8bb2\u4e00\u4e0b\u4e00\u4e9b\u63a8\u5bfc\u4e0a\u53ef\u4ee5\u7b80\u5316\u7684\u5730\u65b9\u4ee5\u53ca\u5b9e\u73b0\u7ec6\u8282\uff0c\u5e76\u4e14\u8bb2\u4e00\u4e0b\u4e3a\u4ec0\u4e48\u7ebf\u6bb5\u6811\u9700\u8981\u7ef4\u62a4\u7684\u662f\u8fd9\u51e0\u4e2a\u4fe1\u606f\u3002\n\n### \u601d\u8def\n\u533a\u95f4\u4fee\u6539 $+$ \u533a\u95f4\u67e5\u8be2\u671f\u671b\uff0c\u521d\u6b65\u5224\u65ad\uff1a\u7ebf\u6bb5\u6811 $+$ \u6982\u7387\u671f\u671b\u5f0f\u5b50\u3002\n\n\u53d1\u73b0\u533a\u95f4\u4fee\u6539\u662f\u533a\u95f4\u52a0\uff0c\u4f7f\u7528\u7ebf\u6bb5\u6811\u5e94\u8be5\u8fd8\u662f\u6bd4\u8f83\u597d\u7ef4\u62a4\u7684\u3002\u201c\u7b49\u6982\u7387\u968f\u673a\u53d6\u51fa\u4e24\u4e2a\u4e0d\u540c\u7684\u6536\u8d39\u7ad9 $a$ \u548c $b$\u201d \u5176\u5b9e\u5c31\u662f\u9009\u62e9\u6240\u6709\u7ad9\u5bf9\u7684\u548c(\u6211\u4eec\u5f3a\u5236\u53ea\u7b97\u4ece\u5de6\u5230\u53f3\uff09\u6700\u540e\u9664\u4ee5 $n$ $\\times$ $(n-1)/2$\u3002\n\n### \u7ef4\u62a4\n\u77e5\u9053\u6536\u8d39\u7ad9\u4e2a\u6570\u5c31\u80fd\u6c42\u51fa\u201c\u7ad9\u5bf9\u201d\u7684\u6570\u91cf $n$ $\\times$ $(n-1)/2$\uff0c**\u6240\u4ee5\u7ef4\u62a4\u201c\u6240\u6709\u7ad9\u5bf9\u7684\u548c\u201d** \u5373\u53ef\u3002\n\n##### \u8003\u8651\u5408\u5e76\u4e24\u4e2a\u5b50\u6811\u7684\u4fe1\u606f\uff0c\u6709 $3$ \u79cd\u60c5\u51b5\uff1a\n\n$1.$ \u53ea\u9009\u5de6\u533a\u95f4\u7684\u7ad9\uff1a\u5de6\u513f\u5b50\u201c\u6240\u6709\u7ad9\u5bf9\u7684\u548c\u201d\u3002\n\n$2.$ \u53f3\u540c\u7406\u3002\n\n$3.$ \u8de8\u8fc7\u5de6\u53f3\u533a\u95f4\uff1a\n\n\u53d1\u73b0**\u9700\u8981\u518d\u591a\u7ef4\u62a4\u201c\u5f3a\u884c\u9009\u5de6/\u53f3\u7aef\u70b9\u7684\u8d39\u7528\u201d\u624d\u884c**\u3002\n    \n\u5982\u4f55\u7ef4\u62a4\u201c\u5f3a\u884c\u9009\u5de6/\u53f3\u7aef\u70b9\u7684\u8d39\u7528\u201d\uff1a\n    \n$1.$ \u5f3a\u884c\u9009\u5de6\u7684\u8d39\u7528\uff1a\n    \n**\u53d1\u73b0\u8fd8\u9700\u8981\u591a\u7ef4\u62a4\u533a\u95f4\u548c**\uff08\u8fd9\u4e2a\u80af\u5b9a\u597d\u7ef4\u62a4\uff09\u3002\n        \n\u5f3a\u884c\u9009\u5de6\u7684\u8d39\u7528 $=$ \u5de6\u513f\u5b50\u5f3a\u884c\u9009\u5de6\u7684\u8d39\u7528 $+$\uff08\u5de6\u513f\u5b50\u7684\u6743\u503c\u548c $\\times$ \u53f3\u513f\u5b50\u7684\u957f\u5ea6 $+$ \u53f3\u513f\u5b50\u5f3a\u884c\u9009\u5de6\u7684\u8d39\u7528\uff09\n        \n        \n$2.$ \u53f3\u540c\u7406\n        \n\u77e5\u9053\u4e86\u201c\u5f3a\u884c\u9009\u5de6/\u53f3\u7aef\u70b9\u7684\u8d39\u7528\u201d\uff0c\u5e76\u4e14**\u77e5\u9053\u5de6\u53f3\u4e24\u6bb5\u7684\u957f\u5ea6**\uff0c\u8fd9\u4e00\u7c7b\u60c5\u51b5\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u5c31\u662f\uff1a`ls.rans*rs.len+ls.len*rs.lans` \n    \n    \n##### \u61d2\u6807\u8bb0\u4e0b\u4f20\n\u61d2\u6807\u8bb0\u5c31\u4e00\u4e2a\u533a\u95f4\u52a0\uff0c\u4e0b\u653e\u7684\u65f6\u5019\u4fee\u6539\u81ea\u5df1\uff0c\u53ef\u4ee5\u5199\u4e2a $add$ \u51fd\u6570\u7b80\u5316\u4ee3\u7801\uff08\u89c1\u540e\u9762\u653e\u7684\u4ee3\u7801\u5427\uff09\u3002\n\n\u6dfb\u52a0\u4e00\u4e2a\u6570\u5bf9\u4e8e\u533a\u95f4\u548c\u7b49\u4fe1\u606f\u7684\u5f71\u54cd\u5f88\u597d\u7ef4\u62a4\uff0c\u96be\u70b9\u5728\u4e8e\u5bf9\u4e8e $ans$ \u7684\u5f71\u54cd(\u8bb0 $delta$ \u4e3a\u7b54\u6848\u7684\u589e\u91cf\uff09\u3002\n\u8ba1\u7b97\u6bcf\u4e2a\u7ad9\u4f5c\u4e3a\u8d77\u70b9\u7684\u8d21\u732e\uff0c\u53ef\u4ee5\u5199\u51fa\u5bf9\u4e8e\u6709 $k$ \u4e2a\u7ad9\u7684\u4e00\u6bb5\u6240\u6709\u7ad9\u8d21\u732e\u6b21\u6570\u603b\u548c\uff1a$ delta= \\sum_{i=1}^{n} i \\times (n-i+1) $ \uff0c\u8fd9\u662f\u4e2a $O(n)$ \u7684\u5f0f\u5b50\uff0c\u80af\u5b9a\u4e0d\u80fd\u5728 $pushdown$ \u91cc\u9762\u6c42\uff0c\u5f88\u591a\u9898\u89e3\u90fd\u91c7\u7528\u4e86\u63a8\u5f0f\u5b50\u5316\u7b80\uff0c\u5176\u5b9e\u8fd8\u53ef\u4ee5\u76f4\u63a5**\u65e0\u8111\u9884\u5904\u7406**\u3002\uff08 $cnt[i]$ \u8868\u793a\u957f\u5ea6\u4e3a $i$ \u7684\u4e00\u6bb5\u6240\u6709\u7ad9\u8d21\u732e\u6b21\u6570\u603b\u548c\uff09\u3002\n```cpp\nll now=0;\nfor(int i=1;i<=n;i++)\n{\n\tnow+=1ll*i*(i-1);\n\tcnt[i]=(1ll*i*i*(i+1)/2)-now;\n}\n```\n\n\n### \u5b8c\u6574 AC \u4ee3\u7801\uff1a\n``` cpp\n#include<bits/stdc++.h>\nusing namespace std;\ntypedef long long ll;\nconst int N=100010;\nint n,m;\nll cnt[N];\nll gcd(ll a,ll b) {return b?gcd(b,a%b):a;}\nstruct node\n{\n\tll sum,ans,lans,rans;\n\tint tag,len;\n}tr[N<<2];\nvoid build(int u,int l,int r)\n{\n\ttr[u].len=(r-l+1);\n\tif(l==r) return;\n\tint mid=(l+r)>>1;\n\tbuild(u<<1,l,mid); build(u<<1|1,mid+1,r);\n}\ninline void add(int u,int v)\n{\n\ttr[u].sum+=1ll*tr[u].len*v;\n\ttr[u].tag+=v;\n\ttr[u].lans+=1ll*(tr[u].len+1)*tr[u].len/2*v;\n\ttr[u].rans+=1ll*(tr[u].len+1)*tr[u].len/2*v;\n\ttr[u].ans+=cnt[tr[u].len]*v;\n}\ninline void pushdown(int u)\n{\n\tif(!tr[u].tag) return;\n\tadd(u<<1,tr[u].tag); add(u<<1|1,tr[u].tag);\n\ttr[u].tag=0;\n}\ninline void pushup(node &u,node ls,node rs)//sum,ans,lans,rans;\n{\n\tu.len=ls.len+rs.len;//\u56e0\u4e3aquery()\u4e5f\u4f1a\u7528\u5230\u8fd9\u4e2a\uff0c\u6240\u4ee5\u5fc5\u987b\u6bcf\u6b21\u66f4\u65b0len\n\tu.sum=ls.sum+rs.sum;\n\tu.ans=(ls.ans+rs.ans+ls.rans*rs.len+ls.len*rs.lans);\n\tu.lans=ls.lans+(ls.sum*rs.len+rs.lans);\n\tu.rans=rs.rans+(rs.sum*ls.len+ls.rans);\n}\nvoid modify(int u,int l,int r,int ml,int mr,int v)\n{\n\tif(ml<=l&&r<=mr) {add(u,v); return;}\n\tpushdown(u);\n\tint mid=(l+r)>>1;\n\tif(ml<=mid) modify(u<<1,l,mid,ml,mr,v);\n\tif(mr>mid) modify(u<<1|1,mid+1,r,ml,mr,v);\n\tpushup(tr[u],tr[u<<1],tr[u<<1|1]);\n}\nnode query(int u,int l,int r,int ql,int qr)\n{\n\tif(ql<=l&&r<=qr) return tr[u];\n\tpushdown(u);\n\tint mid=(l+r)>>1;\n\tif(ql<=mid&&qr>mid) \n\t{\n\t\tnode res={0,0,0,0,0,min(r,ql)-max(l,ql)+1};\n\t\tpushup(res,query(u<<1,l,mid,ql,qr),query(u<<1|1,mid+1,r,ql,qr));\n\t\treturn res;\n\t}\n\tif(ql<=mid) return query(u<<1,l,mid,ql,qr);\n\telse return query(u<<1|1,mid+1,r,ql,qr);\n}\nint main()\n{\n\tscanf(\"%d%d\",&n,&m);\n\tbuild(1,1,n);\n\tll now=0;\n\tfor(int i=1;i<=n;i++)\n\t{\n\t\tnow+=1ll*i*(i-1);\n\t\tcnt[i]=(1ll*i*i*(i+1)/2)-now;\n\t}\n\tchar ch[5]; int l,r,v;\n\twhile(m--)\n\t{\n\t\tscanf(\"%s%d%d\",ch,&l,&r);\n\t\tif(ch[0]=='C') scanf(\"%d\",&v),modify(1,1,n,l,r-1,v);\n\t\telse \n\t\t{\n\t\t\tll son=query(1,1,n,l,r-1).ans,mom=1ll*(r-l+1)*(r-l)/2;\n\t\t\tll d=gcd(son,mom);\n\t\t\tprintf(\"%lld/%lld\\n\",son/d,mom/d);\n\t\t}\n\t}\n\treturn 0;\n}\n```\n\n",
        "postTime": 1664766061,
        "uid": 546246,
        "name": "E_huan",
        "ccfLevel": 8,
        "title": "P2221 \u9898\u89e3"
    },
    {
        "content": "\u8fd9\u4e2a\u9898\u76ee\u771f\u7684\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u7ec3\u4e60\u81ea\u5df1\u6982\u7387\u671f\u671b\u7684\u9898\uff01\n\n\u770b\u5230\u4ec0\u4e48\u533a\u95f4\u52a0\u6cd5\uff0c\u4e00\u79d2\u7ebf\u6bb5\u6811\n\n\u7136\u540e\u5982\u4f55\u7ef4\u62a4\u8fb9\u4e4b\u95f4\u7684\u548c\u5462\uff1f\n\n\u6bd4\u5982\u8bf4\n\n```\n1\u53f7\u82b1\u8d392\u52302\u53f7\uff0c2\u53f7\u82b1\u8d394\u52303\u53f7\n```\n\n\u628a\u6bcf\u4e00\u6761\u8def\u7684\u82b1\u8d39\u4f5c\u4e3a\u7ec8\u70b9\u5904\u7684\u70b9\u7684\u6743\u503c\u5c31\u597d\u4e86\n\n\u6b64\u65f6\u6bcf\u4e00\u4e2a\u70b9\u7684\u6743\u503c\u5c31\u662f\n\n\n$$1\\rightarrow0,2\\rightarrow2,3\\rightarrow4$$\n\n\n\u8fd9\u6837\u5c31\u53ef\u4ee5\u4e86\u3002\u6c42 $l$ \u5230 $r$ \u7684\u82b1\u8d39\u5c31\u662f $[l+1,r]$ \u7684\u548c\n\n\u7528\u7ebf\u6bb5\u6811\u505a\u52a0\u6cd5\u4e5f\u540c\u7406\n\n\u6211\u4eec\u8bb0\u5f55\u4e00\u4e2a\u524d\u7f00\u548c\u6570\u7ec4 sum\uff0c\u7136\u540e\u53d1\u73b0 $l$ \u5230 $r$ \u7684\u82b1\u8d39\u5c31\u662f $\\text{sum}_r-\\text{sum}_l,$\u8fde$-1$\u4e5f\u6ca1\u6709\u4e86~~\u8d85\u8212\u670d~~\n\n\u6839\u636e\u671f\u671b\u7684\u5b9a\u4e49$($~~\u5176\u5b9e\u5c31\u662f\u5e73\u5747\u6570~~$)$\n\n\u7b54\u6848\u5c31\u662f\n\n$$\\frac {\\sum_{i=l}^r\\sum_{j=i}^r(sum[j]-sum[i])}{C_{r-l+1}^{2}}$$\n\n\u7136\u540e\u5462\uff1f\u4e0b\u9762\u8c01\u90fd\u4f1a\u6c42\u554a\uff0c\u6211\u4eec\u8003\u8651\u4e0a\u9762\n\n\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u8fd9\u4e2a\u5947\u602a\u7684\u4e1c\u897f\n\n\u6211\u4eec\u6839\u636e\u4e4b\u524d\u505a\u8fc7\u7684\u9898\u76ee\uff0c\u8003\u8651\u4e00\u4e2a\u5957\u8def\uff1a\n\n\u679a\u4e3e $[l,r]$ \u7684\u6bcf\u4e00\u4e2a\u4f4d\u7f6e\u51fa\u73b0\u4e86\uff08\u88ab\u5305\u542b\u4e86\uff09\u591a\u5c11\u6b21\n\n\u6bd4\u5982\u8bf4\u533a\u95f4 $[l,r]$\n\n$l$ \u80af\u5b9a\u88ab\u533a\u95f4 $[l,l],[l,l+1],...,[l,r]$ \u5305\u542b\n\n\u6240\u4ee5 $l$ \u51fa\u73b0\u4e86 $r-l+1$ \u6b21\n\n$l+1$ \u88ab $[l+1,l+1],...,[l+1,r]$ \u5305\u542b\n\n\u4e5f\u88ab $[l,l+1],...,[l,r]$ \u5305\u542b\n\n\u5171\u51fa\u73b0 $r-l+r-l=2(r-l)$\n\n\u540c\u7406\uff0c$l+i$ \u88ab $[l+i,...]$ \u5f00\u5934\u7684 $r-i+1$ \u4e2a\u533a\u95f4\u5305\u542b\n \n\u4e5f\u88ab\u5305\u542b$l+i-1$\u7684$r-i+1$\u4e2a\u533a\u95f4\u5305\u542b $([l+i-1,l+i],...,[l+i-1,r])$\n\n$......$\n\n\u4e5f\u88ab\u5305\u542b $l$ \u7684 $r-i+1$ \u4e2a\u533a\u95f4\u5305\u542b $([l,l+i],...,[l,l+r])$\n\n\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5f97\u77e5\u7b2c$i$\u4e2a\u6570\u88ab\u5305\u542b\u7684\u6b21\u6570\u4e3a $(r-i+1)\\cdot(i-l+1)$\n\n\u6240\u4ee5\u4e0a\u9762\u7684\u7b54\u6848\u8f6c\u5316\u6210\u4e86\n\n$$\\sum_{i=l}^ra_i\\cdot(r-i+1)\\cdot(i-l+1)$$\n\n\u8fd8\u662f\u4e0d\u80fd\u7ef4\u62a4\u554a\n\n\u90a3\u5c31\u62c6\u5f00\u5427\uff01\n\n$$=\\sum_{i=l}^ra_i\\cdot(r-i+1)\\cdot(i-l+1)$$\n\n$$=\\sum_{i=l}^ra_i\\cdot[-i^2+1-lr-l+r+i(l+r)]$$\n\n$$=\\sum_{i=l}^ra_i\\cdot[-i^2+(r-l-lr+1)+i(l+r)]$$\n\n\u5206\u79bb $\\sum$\n\n\u5c31 \n$$=-\\sum_{i=l}^ra_i\\cdot i^2+\\sum_{i=l}^ra_i(r-l+1-lr)+\\sum_{i=l}^ra_ii(l+r)$$\n \n$$=-\\sum_{i=l}^ra_i\\cdot i^2+(r-l+1-lr)\\sum_{i=l}^ra_i+(l+r)\\sum_{i=l}^ra_ii$$\n\n\u7136\u540e\u5c31\u597d\u50cf\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u4e86\n\n\u7ef4\u62a4 $a_i$ \u7684\u548c\uff0c\u8bbe\u4e3a sum1\n\n\u7ef4\u62a4 $i\\cdot a_i$ \u7684\u548c\uff0c\u8bbe\u4e3a sum2\n\n\u7ef4\u62a4 $i^2\\cdot a_i$ \u7684\u548c\uff0c\u8bbe\u4e3a sum3\n\n\u4e0a\u9762\u7684\u7b54\u6848\u5c31\u662f$-\\text{sum}_3+(l+r)\\cdot \\text{sum}_2+(1-l+r-lr)\\cdot \\text{sum}_1$\n\n\u4f46\u662f\u6709\u533a\u95f4\u52a0\u6cd5\uff0c\u600e\u4e48\u7ef4\u62a4\u8fd9\u4e9b\u7684\u548c\u5462\uff1f\n\n\u8bbe\u67d0\u7ebf\u6bb5\u6811\u8282\u70b9\u63a7\u5236\u7684\u533a\u57df\u4e3a $L,R,$ \u8fd9\u4e2a\u533a\u95f4\u6240\u6709 $a$ \u90fd$+=w$ \n\n\u6709\n\n$$\\text{sum}_1+=(R-L+1)\\cdot w$$\n\n$$\\text{sum}_2+=\\sum_{i=L}^R[i\\cdot (a_i+w)-i\\cdot a_i\\ ]$$\n\n\u5373\n\n$$+=w\\sum_{i=L}^Ri$$\n\n\u6bcf\u4e00\u4e2a\u7ebf\u6bb5\u6811\u8282\u70b9\u989d\u5916\u8bb0\u5f55\u4e00\u4e2a$\\sum_{i=L}^Ri$\u5c31\u53ef\u4ee5\u4e86\uff08\u8fd9\u4e2a\u53ef\u4ee5\u5728\u5efa\u6811\u7684\u65f6\u5019\u9884\u5904\u7406\u51fa\u6765\uff0c\u6211\u4eec\u8bbe\u4e3a sum4)\u3002\n\n$$\\text{sum}_3+=\\sum_{i=L}^R[i^2\\cdot (a_i+w)-i^2\\cdot a_i\\ ]$$\n\n\u5373\n$$+=w\\sum_{i=L}^Ri^2$$\n\n\u6bcf\u4e00\u4e2a\u7ebf\u6bb5\u6811\u8282\u70b9\u518d\u989d\u5916\u8bb0\u5f55\u4e00\u4e2a$\\sum_{i=L}^Ri^2$\u5c31\u53ef\u4ee5\u4e86\uff08\u8fd9\u4e2a\u53ef\u4ee5\u5728\u5efa\u6811\u7684\u65f6\u5019\u9884\u5904\u7406\u51fa\u6765\uff0c\u6211\u4eec\u8bbe\u4e3a sum5\uff09\u3002\n\n\u4e8e\u662f\u8fd9\u9898\u5c31\u505a\u5b8c\u5566\uff01\n\n\u6700\u540e\u6ce8\u610f\u8981\u7ea6\u5206\u554a\uff01\n\n\u5f88\u5bb9\u6613\u7206 long long \u6240\u4ee5\u5efa\u8bae\u591a\u5f00\u4e00\u4e9b long long\u3002\n\n```\n#include<bits/stdc++.h>\n#define ll long long\nusing namespace std;\ninline ll read(){\n    ll x=0,f=1;char ch=getchar();\n    while (!isdigit(ch)){if (ch=='-') f=-1;ch=getchar();};\n    while (isdigit(ch)){x=(x<<1)+(x<<3)+ch-48;ch=getchar();};\n    return x*f; \n}\nint n,m;\nstruct node{\n    ll sum1,sum2,sum3,sum4,sum5,lazy;//\u5982\u4e0a\u6587\u6240\u8ff0\n}g[1000001];\ninline void pushup(int rt){\n    g[rt].sum1=g[rt<<1].sum1+g[rt<<1|1].sum1;\n    g[rt].sum2=g[rt<<1].sum2+g[rt<<1|1].sum2;\n    g[rt].sum3=g[rt<<1].sum3+g[rt<<1|1].sum3;\n}\nvoid build(int rt,int lb,int rb){\n    if (lb==rb){g[rt].sum4=1LL*lb;g[rt].sum5=1LL*lb*lb;return;}//\u9884\u5904\u7406sum4\uff0csum5\n    int mid=lb+rb>>1;\n    build(rt<<1,lb,mid);build(rt<<1|1,mid+1,rb);\n    g[rt].sum4=g[rt<<1].sum4+g[rt<<1|1].sum4;\n    g[rt].sum5=g[rt<<1].sum5+g[rt<<1|1].sum5;\n}\ninline void pushdown(int rt,int lb,int rb){\n    if (g[rt].lazy){\n        int mid=lb+rb>>1,ls=rt<<1,w=g[rt].lazy,rs=rt<<1|1;\n        g[ls].lazy+=1LL*w;g[rs].lazy+=1LL*w;\n        g[ls].sum1+=1LL*(mid-lb+1)*w;g[rs].sum1+=1LL*(rb-mid)*w;\n        g[ls].sum2+=1LL*w*g[ls].sum4;g[rs].sum2+=1LL*w*g[rs].sum4;\n        g[ls].sum3+=1LL*w*g[ls].sum5;g[rs].sum3+=1LL*w*g[rs].sum5;\n        g[rt].lazy=0;\n    }\n}\nvoid update(int rt,int lb,int rb,int l,int r,ll w){\n    if (lb>r||rb<l) return;\n    if (lb>=l&&rb<=r){\n        g[rt].sum1+=1LL*(rb-lb+1)*w;g[rt].sum2+=1LL*w*g[rt].sum4;\n        g[rt].sum3+=1LL*w*g[rt].sum5;g[rt].lazy+=1LL*w;return;\n    }\n    pushdown(rt,lb,rb);\n    int mid=lb+rb>>1;\n    update(rt<<1,lb,mid,l,r,w);update(rt<<1|1,mid+1,rb,l,r,w);\n    pushup(rt);\n}\nvoid query(int rt,int lb,int rb,int l,int r,ll &sum1,ll &sum2,ll &sum3){//\u7531\u4e8e\u60f3\u51cf\u5c11\u4ee3\u7801\u91cf\u4ee5\u53ca\u5e38\u6570\u4e8e\u662f\u5c31\u5c1d\u8bd5\u7528void\u8bb0\u5f55\u7b54\u6848\n    if (lb>r||rb<l) return;\n    if (lb>=l&&rb<=r){sum1+=g[rt].sum1;sum2+=g[rt].sum2;sum3+=g[rt].sum3;return;}\n    pushdown(rt,lb,rb);\n    int mid=lb+rb>>1;\n    query(rt<<1,lb,mid,l,r,sum1,sum2,sum3);query(rt<<1|1,mid+1,rb,l,r,sum1,sum2,sum3);\n}\nint main(){\n    n=read(),m=read();\n    build(1,1,n);\n    while (m--){\n        char s[12];ll l,r;scanf(\"%s\",s);l=read(),r=read();\n        if (s[0]=='C'){\n            ll w=read();\n            if (l==r) continue;\n            update(1,1,n,l+1,r,w);\n        }else{\n            ll S1=0,S2=0,S3=0;\n            query(1,1,n,l+1,r,S1,S2,S3);\n            ll Up=-S3+(l+r+1)*S2+(r-(l+1)-(l+1)*r+1)*S1,Down=(r-l+1)*(r-l)/2;//Up\u662f\u5206\u5b50\uff0cDown\u662f\u5206\u6bcd\n            ll Gcd=__gcd(Up,Down);\n            printf(\"%lld/%lld\\n\",Up/Gcd,Down/Gcd);//\u7ea6\u5206\n        }\n    }\n}\n```",
        "postTime": 1547351642,
        "uid": 20309,
        "name": "Fading",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P2221 \u3010[HAOI2012]\u9ad8\u901f\u516c\u8def\u3011"
    },
    {
        "content": "[$\\texttt{myblog}$](https://www.cnblogs.com/Isaunoya/p/11859320.html)\n\n\u8bbe \n$A=\\sum_{i=l}^{r}\\sum_{j=i}^{r} dis_{i,j}$ , $B=  C_{r-l+1}^{2}$\n\n\u671f\u671b\u503c\u4e3a $\\frac{A}{B}$\n\n\u6211\u4eec\u53d1\u73b0\u8fd9\u662f\u4e00\u6761\u94fe\u6240\u4ee5\u7528\u4e00\u79cd\u5e38\u7528\u7684\u5957\u8def\uff1a\u8fb9\u6743\u5316\u70b9\u6743\n\n\u7136\u540e\u53d1\u73b0\u8fd9\u4e2a$dis_{i,j}$ \u5176\u5b9e\u662f $sum_j - sum_i$ \u7684\n($sum_x=\\sum_{i=1}^{x}a_i$)\n\n\u8003\u8651 $[L , R]$ \u533a\u95f4\u51fa\u73b0 $a_i$ \u7684\u4e2a\u6570\n\n\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u5176\u5b9e\u662f \n\n$$\\sum_{i=l}^{r} a_i * (r - i + 1) * (i - l + 1)$$\n\n$$= \\sum_{i=l}^{r}a_i*((r *i-r*l+r)-(i^2-i*l+i)+i-l+1)$$\n\n$$=-\\sum_{i=l}^{r}a_i*i^2+\n(r-l+1-l*r)\\sum_{i=l}^{r}a_i\n+(l+r)\\sum_{i=l}^{r}a_i*i$$\n\n\u8bbe\n\n$s1=\\sum_{i=l}^{r}a_i$,\n\n$s2=\\sum_{i=l}^{r}i*a_i$,\n\n$s3=\\sum_{i=l}^{r}i^2*a_i$\n\n\n\u90a3\u4e48 \n\n$ans =(l + r) * s2 + ((r - l) - l * r + 1) * s1 - s3$\n\n\u5bf9\u4e8e\u533a\u95f4\u4fee\u6539 \u61d2\u6807\u8bb0\u4ee5\u53ca\u4fee\u6539\u65b9\u6cd5\n\n\u6211\u4eec\u53d1\u73b0\u5bf9 $s1_{rt}$ \u7684\u5f71\u54cd\u662f \n$\\sum_{i=l}^{r} val$\n\n\u5bf9 $s2_{rt}$ \u7684\u5f71\u54cd\u662f \n$\\sum_{i=l}^{r}i*val$\n\n\u5bf9 $s3_{rt}$ \u7684\u5f71\u54cd\u662f \n$\\sum_{i=l}^{r}i^2*val$\n\n\n\u6240\u4ee5\u5c31\u7ef4\u62a4\u4e00\u4e2a\u9759\u6001\u7684 $s4_{rt} = \\sum_{i=l}^{r}i$\n\u4ee5\u53ca $s5_{rt} = \\sum_{i=l}^{r}i^2$\n\n\n($\\texttt{rt\u6307\u7684\u662f\u67d0\u4e00\u6bb5\u533a\u95f4\u2026\u5b66\u8fc7\u7ebf\u6bb5\u6811\u7684\u90fd\u4f1a(?)}$)\n\n\n\u653e\u4e0a\u4eba\u50bb\u5e38\u6570\u5927\u7684\u4ee3\u7801\n\n\n```cpp\n#include<bits/stdc++.h>\n#define int long long\nusing namespace std ;\ninline void read(int & x) {\n  register char c = x = 0 ; bool f = 0 ;\n  while(! isdigit(c)) { if(c == '-') f = 1 ; c = getchar() ; }\n  while(isdigit(c)) { x = (x << 1) + (x << 3) + (c & 15) ; c = getchar() ; }\n  if(f) x = -x ;\n}\nint n , m ;\nconst int N = 1e5 + 10 ;\nint s1[N << 2] , s2[N << 2] , s3[N << 2] , s4[N << 2] , s5[N << 2] , tag[N << 2] ;\ninline void pushup(int rt) { s1[rt] = s1[rt << 1] + s1[rt << 1 | 1] ;\n  s2[rt] = s2[rt << 1] + s2[rt << 1 | 1] ; s3[rt] = s3[rt << 1] + s3[rt << 1 | 1] ;\n}\ninline void build(int l , int r , int rt) {\n  if(l == r) { s4[rt] = l ; s5[rt] = l * l ; return ; }\n  int mid = l + r >> 1 ; build(l , mid , rt << 1) ; build(mid + 1 , r , rt << 1 | 1) ;\n  s4[rt] = s4[rt << 1] + s4[rt << 1 | 1] ; s5[rt] = s5[rt << 1] + s5[rt << 1 | 1] ;\n}\ninline void pushdown(int rt , int l , int r) {\n  if(! tag[rt]) return ; int mid = l + r >> 1 ;\n  tag[rt << 1] += tag[rt] ; tag[rt << 1 | 1] += tag[rt] ;\n  s1[rt << 1] += tag[rt] * (mid - l + 1) ; s1[rt << 1 | 1] += tag[rt] * (r - mid) ;\n  s2[rt << 1] += s4[rt << 1] * tag[rt] ; s2[rt << 1 | 1] += s4[rt << 1 | 1] * tag[rt] ;\n  s3[rt << 1] += s5[rt << 1] * tag[rt] ; s3[rt << 1 | 1] += s5[rt << 1 | 1] * tag[rt] ;\n  tag[rt] = 0 ;\n}\ninline void upd(int a , int b , int l , int r , int rt , int val) {\n  if(a <= l && r <= b) {\n    s1[rt] += val * (r - l + 1) ; s2[rt] += val * s4[rt] ;\n    s3[rt] += val * s5[rt] ; tag[rt] += val ;\n    return ;\n  } pushdown(rt , l , r) ;\n  int mid = l + r >> 1 ;\n  if(a <= mid) upd(a , b , l , mid , rt << 1 , val) ;\n  if(b > mid) upd(a , b , mid + 1 , r , rt << 1 | 1 , val) ;\n  pushup(rt) ;\n}\ninline void query(int a , int b , int l , int r , int rt , int & sum1 , int & sum2 , int & sum3) {\n  if(a <= l && r <= b) { sum1 += s1[rt] ; sum2 += s2[rt] ; sum3 += s3[rt] ; return ; }\n  pushdown(rt , l , r) ; int mid = l + r >> 1 ;\n  if(a <= mid) query(a , b , l , mid , rt << 1 , sum1 , sum2 , sum3) ;\n  if(b > mid) query(a , b , mid + 1 , r , rt << 1 | 1 , sum1 , sum2 , sum3) ;\n}\nsigned main() {\n#ifdef _WIN64\n  freopen(\"0.in\" , \"r\" , stdin) ;\n#endif\n  read(n) ; read(m) ;\n  build(1 , n , 1) ;\n  while(m --) {\n    char c = getchar() ;\n    while(isspace(c)) c = getchar() ;\n    if(c == 'C') {\n      int l , r , val ;\n      read(l) ; read(r) ; read(val) ;\n      upd(++ l , r , 1 , n , 1 , val) ;\n    } else {\n      int l , r ; read(l) ; read(r) ;\n      int sum1 , sum2 , sum3 ; sum1 = sum2 = sum3 = 0 ;\n      query(l + 1 , r , 1 , n , 1 , sum1 , sum2 , sum3) ;\n      int ans = (l + r + 1) * sum2 + ((r - l - 1) - (l + 1) * r + 1) * sum1 - sum3 ;\n      int down = (r - l + 1) * (r - l) >> 1 ;\n      int gcd = __gcd(ans , down) ;\n      cout << ans / gcd << '/' << down / gcd << '\\n' ;\n    }\n  }\n  return 0 ;\n}\n```",
        "postTime": 1573726373,
        "uid": 96580,
        "name": "SXNhdW5veWE",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P2221 \u3010[HAOI2012]\u9ad8\u901f\u516c\u8def\u3011"
    },
    {
        "content": "\u8fd9\u9898\u8fd8\u80fd\u7528\u6811\u72b6\u6570\u7ec4\u505a\uff01\n\n\u6211\u4eec\u53ef\u4ee5\u6c42\u51fa$ans=\\frac{\\sum_{i=l}^{r-1}(-i^2\\cdot dis_i+(l+r-1)\\cdot i\\cdot dis_i-r(l-1)\\cdot dis_i)}{\\binom{r-l+1}{2}}$\uff0c\u7136\u540e\u5c31\u662f\u8981\u641e\u51fa$-i^2\\cdot dis_i,i\\cdot dis_i,dis_i$\u7684\u533a\u95f4\u548c~~\uff08\u5176\u5b9e\u8fd8\u662f\u5f88\u5957\u8def\u7684\uff09~~\n\n\u6811\u72b6\u6570\u7ec4\u5f53\u7136\u4e0d\u80fd\u76f4\u63a5\u533a\u95f4\u52a0\uff0c\u6240\u4ee5\u6211\u4eec\u8003\u8651\u539f\u6570\u7ec4\u7684\u5dee\u5206\u6570\u7ec4$\\Delta dis_i$\u3002\u7136\u540e\u5462\uff1f\u8c8c\u4f3c\u53ea\u80fd\u505a\u51fa\u5355\u70b9\u7684\u503c\u3002\u4f46\u8fd9\u662f\u4e00\u4e2a\u6811\u72b6\u6570\u7ec4\uff08\u4e5f\u5c31\u662f\u5efa\u5f88\u591a\u4e2a\u6811\u72b6\u6570\u7ec4\u4e86\uff09\u3002\n\n\u8fd8\u662f\u8003\u8651\u8fd9\u4e09\u4e2a\u5f0f\u5b50\u7684\u524d\u7f00\u548c\uff1a\n\n$\\sum\\limits_{i=1}^ndis_i=\\sum\\limits_{i=1}^n\\sum\\limits_{j=1}^i \\Delta dis_i$\n\n$\\sum\\limits_{i=1}^ni\\cdot dis_i=\\sum\\limits_{i=1}^n( i\\sum\\limits_{j=1}^i\\Delta dis_i)$\n\n$\\sum\\limits_{i=1}^ni^2\\cdot dis_i=\\sum\\limits_{i=1}^n( i^2\\sum\\limits_{j=1}^i\\Delta dis_i)$\n\n\u7adf\u7136\u6709\u4e24\u91cd\u6c42\u548c\uff1f\u8981$O(n^2)$\uff1f\n\n\u5176\u5b9e\u6211\u4eec\u8003\u86511~n\u4e2d\u6bcf\u4e2a\u6570\u5bf9\u7b54\u6848\u7684\u8d21\u732e\uff0c\u4e8e\u662f\u6211\u4eec\u53d1\u73b0\uff1a\n\n$\\sum\\limits_{i=1}^ndis_i=\\sum\\limits_{i=1}^n\\sum\\limits_{j=1}^i \\Delta dis_i=\\sum\\limits_{i=1}^n(n+1-i)\\Delta dis_i=-\\sum\\limits_{i=1}^ni\\Delta dis_i+(n+1)\\sum\\limits_{i=1}^n\\Delta dis_i$\n\n$\\sum\\limits_{i=1}^ni\\cdot dis_i=\\sum\\limits_{i=1}^n( i\\sum\\limits_{j=1}^i\\Delta dis_i)=(1+2+\\cdots+n)\\Delta dis_1+(2+3+\\cdots+n)\\Delta dis_2+\\cdots+n\\Delta dis_n=\\sum\\limits_{i=1}^n(S_n-S_{i-1})\\Delta dis_i$\n\n$\\sum\\limits_{i=1}^ni^2\\cdot dis_i=\\sum\\limits_{i=1}^n( i^2\\sum\\limits_{j=1}^i\\Delta dis_i)=(1^2+2^2+\\cdots+n^2)\\Delta dis_1+(2^2+3^2+\\cdots+n^2)\\Delta dis_2+\\cdots+n^2\\Delta dis_n=\\sum\\limits_{i=1}^n(\\square_n-\\square_{i-1})\\Delta dis_i$\n\n$\\text{\u8fd9\u91cc\u6211\u4eec\u8bb0}S_n=1+2+\\cdots+n=\\frac{n(n+1)}{2},\\square_n=1^2+2^2+\\cdots+n^2=\\frac{n(n+1)(2n+1)}{6}$\n\n\u7136\u540e\u62c6\u5f00\u4e0b\u9762\u4e24\u4e2a\u5f0f\u5b50\uff1a\n\n$\\sum\\limits_{i=1}^ni\\cdot dis_i=\\sum\\limits_{i=1}^n(S_n-S_{i-1})\\Delta dis_i=\\sum\\limits_{i=1}^n(\\frac{n(n+1)}{2}-\\frac{i(i-1)}{2})\\Delta dis_i=-\\frac{1}{2}\\sum\\limits_{i=1}^ni^2\\cdot\\Delta dis_i+\\frac{1}{2}\\sum\\limits_{i=1}^ni\\cdot\\Delta dis_i+(\\frac{1}{2}n^2+\\frac{1}{2}n)\\sum\\limits_{i=1}^n\\Delta dis_i$\n\n$\\sum\\limits_{i=1}^ni^2\\cdot dis_i=\\sum\\limits_{i=1}^n(\\square_n-\\square_{i-1})\\Delta dis_i=\\sum\\limits_{i=1}^n(\\frac{n(n+1)(2n+1)}{6}-\\frac{i(i-1)(2i-1)}{6})\\Delta dis_i=-\\frac{1}{3}\\sum\\limits_{i=1}^ni^3\\cdot\\Delta dis_i+\\frac{1}{2}\\sum\\limits_{i=1}^ni^2\\cdot\\Delta dis_i-\\frac{1}{6}\\sum\\limits_{i=1}^ni\\cdot\\Delta dis_i+(\\frac{1}{3}n^3+\\frac{1}{2}n^2+\\frac{1}{6}n)\\sum\\limits_{i=1}^n\\Delta dis_i$\n\n\u4e0a\u9762\u8fd9\u4e09\u4e2a\u5f0f\u5b50\uff08\u522b\u5fd8\u4e86\u8fd8\u6709$\\sum_{i=1}^ndis_i$\uff09\u5316\u7b80\u540e\uff0c\u548c$i$\u6709\u5173\u7684\u5f0f\u5b50\u5c31\u53ea\u6709 $\\sum_{i=1}^n\\Delta dis_i$\uff0c$\\sum_{i=1}^ni\\cdot\\Delta dis_i$\uff0c$\\sum_{i=1}^ni^2\\cdot\\Delta dis_i$\uff0c$\\sum_{i=1}^ni^3\\cdot\\Delta dis_i$\u8fd9\u56db\u4e2a\uff0c\u800c\u4e14\u90fd\u662f\u524d\u7f00\u548c\u7684\u5f62\u5f0f\u3002\u8fd9\u6837\u7684\u8bdd\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5efa4\u4e2a\u6811\u72b6\u6570\u7ec4\uff0c\u5206\u522b\u7ef4\u62a4\u8fd9\u56db\u4e2a\u4fe1\u606f\uff0c\u7b97\u51fa\u524d\u7f00\u548c\uff0c\u8f6c\u5316\u4e3a\u533a\u95f4\u548c\uff0c\u518d\u4ece\u4e2d\u8ba1\u7b97\u51fa$ans$\u3002\n\n\u5199\u4ee3\u7801\uff1a\u6211\u4eec\u53d1\u73b0\u4e2d\u95f4\u8fc7\u7a0b\u70b8\u4e86long long\uff08\u5dee\u5206\u53ef\u4ee5\u662f\u8d1f\u6570\uff0cull\u4e5f\u4e0d\u884c\uff09\uff0c\u4e8e\u662f\u4e0d\u5f97\u4e0d\u7528\u4e86__int128\uff08\u8fd8\u597d\u53ea\u5361\u4e86\u4e00\u4e2a\u70b9\uff09\uff08\u8fd9\u4e1c\u897f\u53ea\u80fd\u5728Linux\u4e0b\u7528\uff0c\u6240\u4ee5\u8fd8\u662f\u5728IDE\u4e0a\u8c03\u8bd5\u5427\uff09\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nint n;\nvoid output(__int128 x)        //__int128\u4e0d\u80fd\u76f4\u63a5\u7528cin,cout\n{\n\tif (x >= 10) output(x / 10);\n\tputchar(x%10+'0');\n}\n__int128 c1[100001], c2[100001], c3[100001], c4[100001];\nvoid add(__int128 x, __int128 num) {\n\t__int128 x0 = x;\n\tfor (; x <= n; x += x & -x) {\n\t\tc1[x] += num;\n\t\tc2[x] += x0 * num;\n\t\tc3[x] += x0 * x0 * num;\n\t\tc4[x] += x0 * x0 * x0 * num;\n\t}\n}\n__int128 query1(__int128 x) {\n\t__int128 ans = 0;\n\tfor (; x; x -= x & -x) ans += c1[x];\n\treturn ans;\n}\n__int128 query2(__int128 x) {\n\t__int128 ans = 0;\n\tfor (; x; x -= x & -x) ans += c2[x];\n\treturn ans;\n}\n__int128 query3(__int128 x) {\n\t__int128 ans = 0;\n\tfor (; x; x -= x & -x) ans += c3[x];\n\treturn ans;\n}\n__int128 query4(__int128 x) {\n\t__int128 ans = 0;\n\tfor (; x; x -= x & -x) ans += c4[x];\n\treturn ans;\n}\n__int128 ask1(__int128 x) {return (x+1)*query1(x)-query2(x);}\n__int128 ask2(__int128 x) {return x*(x+1)/2*query1(x)-(query3(x)-query2(x))/2;}\n__int128 ask3(__int128 x) {return x*(x+1)*(2*x+1)/6*query1(x)-(2*query4(x)+query2(x)-3*query3(x))/6;}\n__int128 gcd(__int128 a, __int128 b) {\n\tif (a < b) swap(a, b);\n\tif (a % b == 0) return b;\n\treturn gcd(b, a % b);\n}\nvoid output(__int128 a, __int128 b) {\n\tif (a == 0) cout << \"0/1\" << endl;  //\u8c28\u9632a\u4e3a0\n\telse output(a/gcd(a,b)),putchar('/'),output(b/gcd(a,b)),putchar('\\n');\n}\nint main() {\n\tint m;\n\tcin >> n >> m;\n\tfor (int i = 1; i <= m; i++) {\n\t\tchar c = getchar();\n\t\twhile (!isalpha(c)) c = getchar();\n\t\tif (c == 'C') {\n\t\t\t__int128 l, r, v;\n\t\t\tcin >> l >> r >> v;\n\t\t\tadd(l, v);\n\t\t\tadd(r, -v);\n\t\t}\n\t\tif (c == 'Q') {\n\t\t\t__int128 l, r;\n\t\t\tcin >> l >> r;\n\t\t\toutput((l+r-1)*(ask2(r-1)-ask2(l-1))-(ask3(r-1)-ask3(l-1))-r*(l-1)*(ask1(r-1)-ask1(l-1)),(r-l+1)*(r-l)/2);\n\t\t}\n\t}\n}\n```",
        "postTime": 1556512004,
        "uid": 61068,
        "name": "01190220csl",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P2221 \u3010[HAOI2012]\u9ad8\u901f\u516c\u8def\u3011"
    },
    {
        "content": "## [\u9898\u610f](https://blog.csdn.net/BeNoble_/article/details/79817446)\n\n\u7ed9\u4f60\u4e00\u4e2a\u5e8f\u5217$,$\u8be2\u95ee\u4e00\u4e2a\u533a\u95f4\u6c42\u4ece\u4e2d\u4efb\u9009\u4e00\u4e2a\u5b50\u533a\u95f4\u7684\u6743\u503c\u548c\u7684\u671f\u671b$,$\u5e26\u4fee\u6539\n\n---\n\n## \u9898\u89e3\n\n\u8bbe$sum(L,R)=\\sum_{i=L}^Rw_i,$\u53ef\u4ee5\u60f3\u5230\n\n$$E=\\sum_{i=L}^R\\sum_{j=i}^R\\frac{sum(i,j)}{{R-L+1\\choose2}}$$\n\n\u5373\u6240\u6709\u60c5\u51b5\u7684\u548c\u9664\u4ee5\u6bcf\u79cd\u60c5\u51b5\u7684\u6982\u7387\n\n\u8003\u8651\u600e\u4e48\u6c42$\\sum_{i=L}^R\\sum_{j=i}^Rsum(i,j)$\n\n\u8003\u8651\u5230\u6bcf\u4e00\u4e2a$w_i$\u4f1a\u5b58\u5728\u4e8e$(i-L+1)\\times(R-i+1)$\u4e2a\u533a\u95f4\u4e2d$($\u5206\u522b\u679a\u4e3e\u5de6\u53f3\u7aef\u70b9$)$\n\n\u53ef\u4ee5\u5f97\u5230\n\n$$\\sum_{i=L}^R\\sum_{j=i}^Rsum(i,j)=\\sum_{i=L}^Rw_i(i-L+1)\\times(R-i+1)$$\n\n\u5316\u7b80\u5f97\n\n$$(R+1)(1-L)\\sum w_i+(L+R)\\sum w_ii-\\sum w_ii^2$$\n\n\u5176\u4e2d\u90a3\u4e09\u6837\u4e1c\u897f\u90fd\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\n\n\u7279\u6b8a\u7684$\\sum_{i=1}^ni^2=\\frac{(2n+1)n(n+1)}6$\n\n\u6ce8\u610f\u8fd9\u9898\u4e2d\u7684\u4e00\u4e9b\u7ec6\u8282\n\n\u628a\u8fb9\u6743\u5316\u4e3a\u70b9\u6743\u65f6\u5982\u679c\u76f4\u63a5$--R$\u7684\u8bdd\u90a3\u4e48\u5206\u6bcd\u5e94\u8be5\u662f${R-L+2\\choose2}$\n\n```\n#include<bits/stdc++.h>\n#define fp(i,a,b) for(register int i=a,I=b+1;i<I;++i)\n#define fd(i,a,b) for(register int i=a,I=b-1;i>I;--i)\n#define go(u) for(register int i=fi[u],v=e[i].to;i;v=e[i=e[i].nx].to)\n#define file(s) freopen(s\".in\",\"r\",stdin),freopen(s\".out\",\"w\",stdout)\ntemplate<class T>inline bool cmax(T&a,const T&b){return a<b?a=b,1:0;}\ntemplate<class T>inline bool cmin(T&a,const T&b){return a>b?a=b,1:0;}\nusing namespace std;\nchar ss[1<<17],*A=ss,*B=ss;\ninline char gc(){return A==B&&(B=(A=ss)+fread(ss,1,1<<17,stdin),A==B)?-1:*A++;}\ntemplate<class T>inline void sd(T&x){\n    char c;T y=1;while(c=gc(),(c<48||57<c)&&c!=-1)if(c==45)y=-1;x=c-48;\n    while(c=gc(),47<c&&c<58)x=x*10+c-48;x*=y;\n}\nchar sr[1<<21],z[20];int C=-1,Z;\ninline void Ot(){fwrite(sr,1,C+1,stdout),C=-1;}\ntemplate<class T>inline void we(T x){\n    if(C>1<<20)Ot();if(x<0)sr[++C]=45,x=-x;\n    while(z[++Z]=x%10+48,x/=10);\n    while(sr[++C]=z[Z],--Z);sr[++C]='\\n';\n}\nconst int N=1e5+5;\ntypedef int arr[N];\ntypedef long long ll;\nint n,m,tg[N<<2];ll tr[N<<2][3];\n#define lc p<<1\n#define rc p<<1|1\ninline ll calc(int x){return (ll)(x<<1|1)*x*(x+1)/6;}\ninline void Tag(int p,int L,int R,int w){\n\tint x=(R-L+1);tg[p]+=w;\n\ttr[p][0]+=(ll)w*x;\n\ttr[p][1]+=(ll)w*x*(L+R)>>1;\n\ttr[p][2]+=(calc(R)-calc(L-1))*w;\n}\ninline void down(int p,int L,int R){\n\tint mid=(L+R)>>1,w=tg[p];tg[p]=0;\n\tTag(lc,L,mid,w),Tag(rc,mid+1,R,w);\n}\ninline void up(int p){fp(i,0,2)tr[p][i]=tr[lc][i]+tr[rc][i];}\nvoid mdy(int p,int L,int R,int a,int b,int w){\n\tif(a<=L&&R<=b)return Tag(p,L,R,w);\n\tif(tg[p])down(p,L,R);int mid=(L+R)>>1;\n\tif(a<=mid)mdy(lc,L,mid,a,b,w);\n\tif(b>mid)mdy(rc,mid+1,R,a,b,w);up(p);\n}\nll qry(int p,int L,int R,int a,int b,int y){\n\tif(a<=L&&R<=b)return tr[p][y];\n\tif(tg[p])down(p,L,R);int mid=(L+R)>>1;\n\tif(b<=mid)return qry(lc,L,mid,a,b,y);\n\tif(a>mid)return qry(rc,mid+1,R,a,b,y);\n\treturn qry(lc,L,mid,a,b,y)+qry(rc,mid+1,R,a,b,y);\n}\nint main(){\n    #ifndef ONLINE_JUDGE\n        file(\"roadxw\");\n    #endif\n    sd(n),sd(m);--n;\n    int L,R;char c;ll x,y,g;\n    while(m--){\n    \twhile(c=gc(),c<32);sd(L),sd(R);--R;\n    \tif(c=='C')sd(x),mdy(1,1,n,L,R,x);\n    \telse{\n    \t\ty=(ll)(R-L+2)*(R-L+1)>>1;\n    \t\tx=qry(1,1,n,L,R,0)*(R+1)*(1-L)+qry(1,1,n,L,R,1)*(R+L)-qry(1,1,n,L,R,2);\n    \t\tg=__gcd(x,y);we(x/g),sr[C]='/',we(y/g);\n    \t}\n    }\nreturn Ot(),0;\n}\n```",
        "postTime": 1522825288,
        "uid": 20156,
        "name": "Kelin",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P2221 \u3010[HAOI2012]\u9ad8\u901f\u516c\u8def\u3011"
    },
    {
        "content": "\u975e\u5e38\u6076\u5fc3\u7684\u4e00\u9053\u7ebf\u6bb5\u6811\u9898\u3002\u4e3a\u4e86\u65b9\u4fbf\u8ba1\u7b97\uff0c\u8fd9\u91cc\u6bcf\u4e00\u6b21\u4fee\u6539\u548c\u8be2\u95ee\uff0c\u5148\u628ar\u7684\u503c\u51cf1\u3002\n\n\u9996\u5148\uff0c\u4e86\u89e3\u671f\u671b\u503c\u7684\u6982\u5ff5\uff0c\u671f\u671b\u503c=\u503c1\\*\u503c1\u51fa\u73b0\u7684\u6982\u7387+\u503c2\\*\u503c2\u51fa\u73b0\u7684\u6982\u7387+...+\u503ck\\*\u503ck\u51fa\u73b0\u7684\u6982\u7387\uff08\u4fdd\u8bc1\u503c1~k\u51fa\u73b0\u7684\u6982\u7387\u548c\u4e3a1\uff09\u3002\n\n\u90a3\u4e48\u5bf9\u4e8e\u8fd9\u9053\u9898\u91cc\u7684\u8be2\u95ee\u64cd\u4f5c\uff0c\u7531\u4e8e\u8be2\u95ee\u64cd\u4f5c\u91cc\u67d0\u4e2aa\u548cb\u51fa\u73b0\u7684\u6982\u7387\u662f\u76f8\u7b49\u7684\uff0c\u6240\u4ee5 \u8be2\u95ee\u7ed3\u679c=\u6240\u6709\u53ef\u80fd\u6536\u8d39\u7684\u603b\u548c/C(r-l+2, 2)\u3002\n\n\u800c\u91cd\u70b9\u5c31\u662f\u6c42\u6240\u6709\u53ef\u80fd\u6536\u8d39\u7684\u603b\u548c\u3002\u8fd9\u91cc\u8bbea[i]\u4e3a\u4ece\u7b2ci\u5230\u7b2ci+1\u4e2a\u6536\u8d39\u7ad9\u7684\u8d39\u7528\u3002\n\n\u90a3\u4e48\u6240\u6709\u53ef\u80fd\u6536\u8d39\u7684\u603b\u548c=(a[l]+(a[l]+a[l+1])+(a[l]+a[l+1]+a[l+2])+...+(a[l]+a[l+1]+...+a[r]))+(a[l+1]+(a[l+1]+a[l+2])+(a[l+1]+a[l+2]+a[l+3])+...+(a[l+1]+a[l+2]+...+a[r]))+...+(a[r-1]+(a[r-1]+a[r]))+a[r]=(r-l+1)\\*1\\*a[l]+(r-l)\\*2\\*a[l+1]+(r-l-1)\\*3\\*a[l+2]+...+1\\*(r-l+1)\\*a[r]\u3002\n\n\u800c\u8fd9\u91cc\u5c31\u9700\u8981\u7ef4\u62a4(r-l+1)\\*1\\*a[l]+(r-l)\\*2\\*a[l+1]+(r-l-1)\\*3\\*a[l+2]+...+1\\*(r-l+1)\\*a[r]\u7684\u503c\u3002\u8fd9\u91cc\u7684\u96be\u70b9\u5728\u4e8e\u5408\u5e76\u5de6\u53f3\u5b50\u533a\u95f4\u7684\u7b54\u6848\u3002\u4e3a\u4e86\u80fd\u591f\u5408\u5e76\u5de6\u53f3\u5b50\u533a\u95f4\u7684\u7b54\u6848\uff0c\u6211\u4eec\u53e6\u5916\u7ef4\u62a4\u4e09\u4e2a\u503c\uff1a\n\n1\u3001sum0\uff0c\u7ef4\u62a4a[l]+a[l+1]+a[l+2]+...+a[r]\u7684\u503c\u3002\n\n2\u3001sum1\uff0c\u7ef4\u62a41\\*a[l]+2\\*a[l+1]+3\\*a[l+2]+...+(r-l+1)\\*a[r]\u7684\u503c\u3002\n\n3\u3001sum2\uff0c\u7ef4\u62a4(r-l+1)\\*a[l]+(r-l)\\*a[l+1]+(r-l-1)\\*a[l+2]+...+2\\*a[r-1]+1\\*a[r]\u7684\u503c\u3002\n\n\u5230\u4e86\u8fd9\u91cc\uff0c\u5408\u5e76(r-l+1)\\*1\\*a[l]+(r-l)\\*2\\*a[l+1]+(r-l-1)\\*3\\*a[l+2]+...+1\\*(r-l+1)\\*a[r]\u7684\u503c\u7684\u5de6\u53f3\u5b50\u533a\u95f4\u7b54\u6848\u5c31\u53d8\u5f97\u7b80\u5355\u4e86\u3002\u5b9e\u73b0\u89c1\u4ee3\u7801\u3002\n\n\u6ce8\u610flong long\u548c\u6700\u7b80\u5206\u6570\u3002\n\n\u4ee3\u7801\uff1a\n\n```cpp\n#include <cmath>\n#include <cstdio>\n#include <cstring>\n#include <iostream>\n#include <algorithm>\n#define p2 p << 1\n#define p3 p << 1 | 1\nusing namespace std;\ntypedef long long ll;\ninline int read() {\n    int res = 0; bool bo = 0; char c;\n    while (((c = getchar()) < '0' || c > '9') && c != '-');\n    if (c == '-') bo = 1; else res = c - 48;\n    while ((c = getchar()) >= '0' && c <= '9')\n        res = (res << 3) + (res << 1) + (c - 48);\n    return bo ? ~res + 1 : res;\n}\ninline char get() {\n    char c; while ((c = getchar()) != 'C' && c != 'Q');\n    return c;\n}\nconst int N = 4e5 + 5;\nint n, m; ll sm0[N], S[N], S1[N], S2[N], T[N], add[N];\nvoid down(int p) {\n    add[p2] += add[p]; add[p3] += add[p];\n    add[p] = 0;\n}\nll sum1(int x) {\n    if (x == 0) return 1ll;\n    return (x & 1) ? 1ll * (x + 1 >> 1) * x\n        : 1ll * (x >> 1) * (x + 1);\n}\nll sum2(int x, int y) {\n    return sm0[x] + sum1(x) * (y - x);\n}\nvoid calc(int l, int r, int p) {\n    int mid = l + r >> 1;\n    ll v1, v2, v3, v4, v5, v6, v7, v8, c1, c2, c3;\n    c1 = sum1(mid - l + 1); c2 = sum1(r - mid);\n    c3 = sum1(r - l + 1);\n    v1 = S[p2] + add[p2] * (mid - l + 1);\n    v2 = S[p3] + add[p3] * (r - mid);\n    v3 = S1[p2] + add[p2] * c1; \n    v4 = S1[p3] + add[p3] * (c3 - c1) + S[p3] * (mid - l + 1);\n    v5 = S2[p2] + add[p2] * (c3 - c2) + S[p2] * (r - mid);\n    v6 = S2[p3] + add[p3] * c2;\n    v7 = T[p2] + add[p2] * sum2(mid - l + 1, r - l + 1)\n        + S1[p2] * (r - mid);\n    v8 = T[p3] + add[p3] * sum2(r - mid, r - l + 1)\n        + S2[p3] * (mid - l + 1);\n    S[p] = v1 + v2; S1[p] = v3 + v4;\n    S2[p] = v5 + v6; T[p] = v7 + v8;\n}\nvoid change(int l, int r, int s, int e, int v, int p) {\n    if (l == s && r == e) return (void) (add[p] += v);\n    int mid = l + r >> 1; down(p);\n    if (e <= mid) change(l, mid, s, e, v, p2);\n    else if (s >= mid + 1) change(mid + 1, r, s, e, v, p3);\n    else change(l, mid, s, mid, v, p2),\n        change(mid + 1, r, mid + 1, e, v, p3);\n    calc(l, r, p);\n}\nll ask(int l, int r, int s, int e, ll s1, ll s2,\nll s3, ll s4, int p) {\n    if (l == s && r == e) return (S[p] + add[p] * (r - l + 1))\n    * s1 + (S1[p] + add[p] * sum1(r - l + 1)) * s2 +\n    (S2[p] + add[p] * sum1(r - l + 1)) * s3 + (T[p]\n    + add[p] * sum2(r - l + 1, r - l + 1)) * s4;\n    int mid = l + r >> 1; down(p); ll res = 0;\n    if (e <= mid) res = ask(l, mid, s, e, s1, s2, s3, s4, p2);\n    else if (s >= mid + 1)\n        res = ask(mid + 1, r, s, e, s1, s2, s3, s4, p3);\n    else res = ask(l, mid, s, mid, s1 + s3 * (e - mid),\n    s2 + s4 * (e - mid), s3, s4, p2) + ask(mid + 1, r,\n    mid + 1, e, s1 + s2 * (mid - s + 1), s2, s3\n    + s4 * (mid - s + 1), s4, p3);\n    calc(l, r, p); return res;\n}\nll gcd(ll x, ll y) {\n    ll r = x % y;\n    while (r) x = y, y = r, r = x % y;\n    return y;\n}\nint main() {\n    int i, x, y, z; char op;\n    for (i = 1; i <= 4e4; i++) sm0[i] = sm0[i - 1] + i;\n    for (i = 1; i <= 4e4; i++) sm0[i] += sm0[i - 1];\n    n = read() - 1; m = read();\n    while (m--) {\n        op = get();\n        if (op == 'C') {\n            x = read(); y = read(); z = read();\n            change(1, n, x, y - 1, z, 1);\n        }\n        else {\n            x = read(); y = read();\n            ll res = ask(1, n, x, y - 1, 0, 0, 0, 1, 1),\n            u = sum1(y - x), v = gcd(res, u);\n            printf(\"%lld/%lld\\n\", res / v, u / v);\n        }\n    }\n    return 0;\n}\n```",
        "postTime": 1501061830,
        "uid": 29936,
        "name": "xyz32768",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P2221 \u3010[HAOI2012]\u9ad8\u901f\u516c\u8def\u3011"
    },
    {
        "content": "\u8fd9\u662f\u4e00\u9053\u975e\u5e38\u9002\u5408\u50cf\u849f\u84bb\u4e00\u6837\u60f3\u63d0\u5347\u7ebf\u6bb5\u6811\u6c34\u5e73\u7684\u9898\u76ee\u3002\n\n[\u535a\u5ba2\u98df\u7528\u66f4\u4f73\u54e6](https://www.cnblogs.com/windseekerblog/p/16543537.html)\n\n[\u9898\u76ee\u94fe\u63a5](https://www.luogu.com.cn/problem/P2221)\n\n### \u9898\u76ee\u5927\u610f\n\n\u9996\u5148\uff0c\u6211\u4eec\u8981\u641e\u6e05\u695a\u8ba9\u6211\u4eec\u6c42\u4ec0\u4e48\uff0c\u671f\u671b\u975e\u5e38\u9ad8\u5927\u4e0a\uff0c\u4f46\u662f\u5728\u8fd9\u91cc\u5176\u5b9e\u5c31\u662f\u6c42 $l$ \u5230 $r$ \u4efb\u610f\u9009\u53d6\u4e24\u4e2a\u70b9\u7684\u6240\u6709\u65b9\u6848\u7684\u4ee3\u4ef7\u76f8\u52a0\u540e\u9664\u4ee5\u603b\u65b9\u6848\u6570\uff0c\u53d6\u4e00\u4e2a\u5e73\u5747\u503c\u3002\n\n### \u63a8\u7406\u5f0f\u5b50\n\n\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u7ec6\u81f4\u8003\u8651\u5230\u6bcf\u4e00\u6761\u8fb9\u3002\n\n\u4f8b\u5982\u5bf9\u4e8e\u56fe\u4e2d\u7684 $i\\rightarrow i+1$ \u8fd9\u6761\u8fb9:\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/q2z7jgaq.png)\n\n\u7ecf\u8fc7\u601d\u8003\u4ee5\u540e\uff0c\u6211\u4eec\u53d1\u73b0\u5728 $l$ \u5230 $r$ \u8fd9\u6bb5\u533a\u95f4\u4e2d\uff0c\u5b83\u4f1a\u53c2\u4e0e\u4ee3\u4ef7\u7684\u60c5\u51b5\u662f\u4e24\u4e2a\u6536\u8d39\u7ad9\u4e00\u4e2a\u5728 $i$ \u4ee5\u53ca $i$ \u7684\u5de6\u8fb9\uff0c\u540c\u7406\uff0c\u53e6\u4e00\u4e2a\u5728 $i+1$ \u4ee5\u53ca $i+1$  \u7684\u53f3\u8fb9\u3002\n\n\u6240\u4ee5\u5b83\u7684\u8d21\u732e\u5c31\u662f $(i-l+1)\\times (r-i)\\times dis[i][i+1]$ \u3002\n\n\u6211\u4eec\u5728\u628a\u6bcf\u4e00\u6761\u8fb9\u7684\u8d21\u732e\u52a0\u8d77\u6765\uff0c\u5e76\u4ee5 $i$ \u7684\u964d\u5e42\u6392\u5e8f\u6709\u5173\u5c06\u5f0f\u5b50\u8f6c\u5316\u4e3a\u6211\u4eec\u8981\u7684\u5f0f\u5b50\u3002\n\n(\u7531\u4e8e $i$ \u662f\u6211\u4eec\u53d6\u7684\u8fb9\u7684\u5de6\u7aef\u70b9\uff0c\u6240\u4ee5 $i$ \u4ece $l$ \u904d\u5386\u5230 $r-1$)\n\n$$\\sum\\limits_{i=l}^{r-1}(i-l+1)\\times (r-i)\\times dis[i][i+1]$$\n$$\\Longrightarrow \\sum\\limits_{i=l}^{r-1}(-i^2+ri+li-i-lr+r)\\times dis[i][i+1]$$\n$$\\Longrightarrow -\\sum\\limits_{i=1}^{r-1}i^2\\times dis[i][i+1]+(r+l-1)\\sum\\limits_{i=1}^{r-1} i\\times dis[i][i+1]+r(1-l)\\sum\\limits_{i=1}^{r-1}dis[i][i+1]$$\n\n### \u7ebf\u6bb5\u6811\u7ef4\u62a4 \n\n\u6211\u4eec\u73b0\u5728\u5df2\u7ecf\u5f97\u5230\u4e86\u5f0f\u5b50\uff0c\u53c8\u56e0\u4e3a\u8fd9\u9053\u9898\u662f\u533a\u95f4\u4fee\u6539\uff0c\u533a\u95f4\u67e5\u8be2\uff0c\u6240\u4ee5\u6211\u4eec\u4f1a\u8054\u60f3\u5230\u7ebf\u6bb5\u6811\u3002\n\n- \u533a\u95f4\u4fee\u6539\n\n\u6211\u4eec\u8bbe $sum1,sum2,sum3$\u3002 \n\n$sum1=\\sum\\limits_{i=l}^{r-1}i^2\\times dis[i][i+1]$  \n$sum2=\\sum\\limits_{i=l}^{r-1}i\\times dis[i][i+1]$   \n$sum3=\\sum\\limits_{i=l}^{r-1}dis[i][i+1]$\n\n$sum3$ \u7684\u6539\u53d8\u53ea\u9700\u8981\u52a0\u4e0a\u957f\u5ea6\u4e58\u4ee5 $v$\u3002\n\n$sum2$ \u7684\u6539\u53d8\u5229\u7528\u7b49\u5dee\u6570\u5217\u6c42\u548c\u4e58\u4ee5 $v$\u3002\n\n$sum1$ \u7684\u6539\u53d8\u5229\u7528\u5e73\u65b9\u548c\u516c\u5f0f\u6c42\u548c\u4e58\u4ee5 $v$\u3002\n\n\u5177\u4f53\u89c1\u4ee3\u7801\u3002\n\n- \u533a\u95f4\u67e5\u8be2\n\n\u628a\u5bf9\u5e94\u533a\u95f4\u7684 $sum1,sum2,sum3$ \u6c42\u51fa\uff0c\u7136\u540e\u5957\u5f0f\u5b50\u6c42\u51fa\u4ee3\u4ef7\u548c\uff0c\u6c42\u5176\u4e0e\u65b9\u6848\u6570\u7684 $\\gcd$ \u8f93\u51fa\u7b54\u6848\u3002\n\n### code\n\n```cpp\n#include<bits/stdc++.h>\n#define int long long\n#define ls rt<<1\n#define rs rt<<1|1\n#define lson ls,l,mid\n#define rson rs,mid+1,r\nusing namespace std;\nconst int N=1e5+1e3;\n\nint read(){\n\tint res=0,f=1;char c;\n\tfor(;!isdigit(c);c=getchar()) if(c=='-') f=-1;\n\tfor(;isdigit(c);c=getchar()) res=(res<<1)+(res<<3)+(c^48);\n\treturn res*f;\n}\n\nint n,m;\nstruct TREE{\n\tint sum1,sum2,sum3;\n\tint lazy;\n}t[N<<2];\nchar op;\n\nint count1(int l,int r){return (l+r)*(r-l+1)/2;}//\u7b49\u5dee\u6570\u5217\u6c42\u548c\nint count2(int l,int r){return (r)*(r+1)*(2*r+1)/6-(l-1)*(l-1+1)*(2*(l-1)+1)/6;}//\u5e73\u65b9\u548c\u6c42\u548c\n\nvoid push_down(int rt,int l,int r){\n\tif(t[rt].lazy!=0){\n\t\tint mid=(l+r)>>1,v=t[rt].lazy;\n\t\tt[ls].lazy+=t[rt].lazy,t[rs].lazy+=t[rt].lazy;\n\t\tt[ls].sum1+=(mid-l+1)*v;t[rs].sum1+=(r-mid)*v;\n\t\tt[ls].sum2+=count1(l,mid)*v;t[rs].sum2+=count1(mid+1,r)*v;\n\t\tt[ls].sum3+=count2(l,mid)*v;t[rs].sum3+=count2(mid+1,r)*v;\n\t\tt[rt].lazy=0;\n\t}\n}\n\nvoid push_up(int rt){\n\tt[rt].sum1=t[ls].sum1+t[rs].sum1;\n\tt[rt].sum2=t[ls].sum2+t[rs].sum2;\n\tt[rt].sum3=t[ls].sum3+t[rs].sum3;\n}\n\nvoid update(int rt,int l,int r,int ul,int ur,int v){\n\tif(ul<=l&&r<=ur){\n\t\tt[rt].sum1+=(r-l+1)*v;\n\t\tt[rt].sum2+=count1(l,r)*v;\n\t\tt[rt].sum3+=count2(l,r)*v;\n\t\tt[rt].lazy+=v;\n\t\treturn;\n\t}\n\tpush_down(rt,l,r);\n\tint mid=(l+r)>>1;\n\tif(ul<=mid) update(lson,ul,ur,v);\n\tif(mid<ur) update(rson,ul,ur,v);\n\tpush_up(rt);\n}\n\nvoid query(int rt,int l,int r,int ql,int qr,int &sum1,int &sum2,int &sum3){\n\tif(ql<=l&&r<=qr){\n\t\tsum1+=t[rt].sum1,sum2+=t[rt].sum2,sum3+=t[rt].sum3;\n\t\treturn;\n\t}\n\tpush_down(rt,l,r);\n\tint mid=(l+r)>>1,res=0;\n\tif(ql<=mid) query(lson,ql,qr,sum1,sum2,sum3);\n\tif(mid<qr) query(rson,ql,qr,sum1,sum2,sum3);\n\treturn;\n}\n\nsigned main(){\n\tn=read(),m=read();\n\t//build(1,1,n);\u849f\u84bb\u4e0d\u592a\u60f3build\n\tfor(int i=1;i<=m;i++){\n\t\tcin>>op;\n\t\tif(op=='C'){\n\t\t\tint ul=read(),ur=read(),v=read();\n\t\t\tupdate(1,1,n,ul,ur-1,v);\n\t\t}\n\t\telse{\n\t\t\tint ql=read(),qr=read(),sum1=0,sum2=0,sum3=0;\n\t\t\tquery(1,1,n,ql,qr-1,sum1,sum2,sum3);\n\t\t\tint sum=(qr-ql+1)*(qr-ql)/2,val=-sum3+(qr+ql-1)*sum2-qr*(ql-1)*sum1;\n\t\t\tint gcd=__gcd(val,sum);\n\t\t\tprintf(\"%lld/%lld\\n\",val/gcd,sum/gcd);\n\t\t}\n\t}\n\treturn 0;\n}\n/*\n4 5\nC 1 4 2\nC 1 2 -1\nQ 1 2\nQ 2 4\nQ 1 4\n*/\n```\n\n",
        "postTime": 1659420247,
        "uid": 557385,
        "name": "cjlak1o1",
        "ccfLevel": 0,
        "title": "P2221 [HAOI2012]\u9ad8\u901f\u516c\u8def \u9898\u89e3"
    },
    {
        "content": "# \u9898\u89e3\n\u5b9a\u4e49\u6536\u8d39\u7ad9 $i$ \u548c $i+1$ \u4e4b\u95f4\u7684\u8def\u4e3a\u7b2c $i$ \u6761\u516c\u8def\u3002\u8003\u8651\u7b2c $i$ \u6761\u8def\u7684\u8d21\u732e\uff0c\u53ea\u9700\u5728 $i$ \u7684\u5de6\u8fb9\u548c $i+1$ \u7684\u53f3\u8fb9\u5206\u522b\u4efb\u9009\u4e00\u70b9\u5373\u53ef\uff0c\u6240\u4ee5\n$$ans=\\sum_{i=l}^ra_i(i-l+1)(r-i)$$\n\u5c55\u5f00\u53ef\u5f97\uff0c\n$$ans=\\sum_{i=1}^ra_i(ir-i^2-lr+il+r-i)$$\n\u6574\u7406\u53ef\u5f97\uff0c\n$$ans=(r-lr)\\sum_{i=l}^ra_i+(r+l-1)\\sum_{i=l}^ria_i-\\sum_{i=l}^ri^2a_i$$\n\u89c2\u5bdf\u4ee5\u4e0a\u5f0f\u5b50\uff0c\u53d1\u73b0\u53ea\u9700\u7ef4\u62a4 $\\sum\\limits_{i=l}^ra_i,\\sum\\limits_{i=l}^r ia_i$ \u548c $\\sum\\limits_{i=l}^r i^2a_i$\u3002\n\n---\n\n\u5bf9\u4e8e\u533a\u95f4\u52a0\u64cd\u4f5c\uff0c\n\n$$\\sum_{i=l}^r(a_i+v)=v(r-l+1)+\\sum_{i=l}^ra_i$$\n\n$$\\sum_{i=l}^ri(a_i+v)=v\\sum_{i=l}^ri+\\sum_{i=l}^r ia_i$$\n\n\u4e0a\u5f0f\u53ea\u9700\u5e94\u7528\u7b49\u5dee\u6570\u5217\u6c42\u548c\u516c\u5f0f\u3002\n\n$$\\sum_{i=l}^ri^2(a_i+v)=v\\sum_{i=l}^ri^2+\\sum_{i=l}^ri^2a_i$$\n\n\u4e0a\u5f0f\u53ea\u9700\u5e94\u7528\u5e73\u65b9\u548c\u516c\u5f0f\u3002\n\n---\n\n\u7531\u4e8e\u662f\u671f\u671b\uff0c\u5728\u7b97\u5b8c\u7b54\u6848\u540e\u9700\u8981\u9664\u4ee5\u65b9\u6848\u6570\uff0c\u5373\u5206\u6bcd\u4e3a $\\mathrm{C}_{r-l+1}^2$\u3002\n\n## Code\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define ll long long\n#define N 400005\nll n,m,u,v,w,ans,res,tmp;\nll a[N],b[N],c[N],p[N];\nchar op;\nll gcd(ll x,ll y)\n{\n\tll r;\n\twhile(y)\n\t{\n\t\tr=x%y;\n\t\tx=y;\n\t\ty=r;\n\t}\n\treturn x;\n}\nll sum(ll x)\n{\n\treturn x*(x+1)*(2*x+1)/6;\n}\ninline void pushup(ll k)\n{\n\ta[k]=a[k<<1]+a[k<<1|1];\n\tb[k]=b[k<<1]+b[k<<1|1];\n\tc[k]=c[k<<1]+c[k<<1|1];\n}\ninline void pushdown(ll l,ll r,ll k)\n{\n\tll mid=l+r>>1;\n\tif(p[k])\n\t{\n\t\tp[k<<1]+=p[k];\n\t\tp[k<<1|1]+=p[k];\n\t\ta[k<<1]+=(mid-l+1)*p[k];\n\t\ta[k<<1|1]+=(r-mid)*p[k];\n\t\tb[k<<1]+=(l+mid)*(mid-l+1)/2*p[k];\n\t\tb[k<<1|1]+=(mid+1+r)*(r-mid)/2*p[k];\n\t\tc[k<<1]+=((sum(mid)-sum(l-1)))*p[k];\n\t\tc[k<<1|1]+=((sum(r)-sum(mid)))*p[k];\n\t\tp[k]=0;\n\t}\n}\nvoid modify(ll x,ll y,ll z,ll l,ll r,ll k)\n{\n\tif(x<=l&&r<=y)\n\t{\n\t\ta[k]+=(r-l+1)*z;\n\t\tb[k]+=(l+r)*(r-l+1)/2*z;\n\t\tc[k]+=(sum(r)-sum(l-1))*z;\n\t\tp[k]+=z;\n\t\treturn;\n\t}\n\tpushdown(l,r,k);\n\tll mid=l+r>>1;\n\tif(x<=mid) modify(x,y,z,l,mid,k<<1);\n\tif(y>mid) modify(x,y,z,mid+1,r,k<<1|1);\n\tpushup(k);\n}\nll query_a(ll x,ll y,ll l,ll r,ll k)\n{\n\tif(x<=l&&r<=y)\n\t\treturn a[k];\n\tpushdown(l,r,k);\n\tll mid=l+r>>1,res=0;\n\tif(x<=mid) res+=query_a(x,y,l,mid,k<<1);\n\tif(y>mid) res+=query_a(x,y,mid+1,r,k<<1|1);\n\treturn res;\n}\nll query_b(ll x,ll y,ll l,ll r,ll k)\n{\n\tif(x<=l&&r<=y)\n\t\treturn b[k];\n\tpushdown(l,r,k);\n\tll mid=l+r>>1,res=0;\n\tif(x<=mid) res+=query_b(x,y,l,mid,k<<1);\n\tif(y>mid) res+=query_b(x,y,mid+1,r,k<<1|1);\n\treturn res;\n}\nll query_c(ll x,ll y,ll l,ll r,ll k)\n{\n\tif(x<=l&&r<=y)\n\t\treturn c[k];\n\tpushdown(l,r,k);\n\tll mid=l+r>>1,res=0;\n\tif(x<=mid) res+=query_c(x,y,l,mid,k<<1);\n\tif(y>mid) res+=query_c(x,y,mid+1,r,k<<1|1);\n\treturn res;\n}\nint main()\n{\n\tscanf(\"%lld%lld\",&n,&m);\n\twhile(m--)\n\t{\n\t\tscanf(\"\\n%c%lld%lld\",&op,&u,&v);\n\t\tif(op=='C')\n\t\t{\n\t\t\tscanf(\"%lld\",&w);\n\t\t\tmodify(u,v-1,w,1,n-1,1);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tans=(v-u*v)*query_a(u,v-1,1,n-1,1)+(u+v-1)*query_b(u,v-1,1,n-1,1)-query_c(u,v-1,1,n-1,1);\n\t\t\tres=(v-u+1)*(v-u)/2;\n\t\t\ttmp=gcd(ans,res);\n\t\t\tprintf(\"%lld/%lld\\n\",ans/tmp,res/tmp);\n\t\t}\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1658053191,
        "uid": 379058,
        "name": "Ginger_he",
        "ccfLevel": 0,
        "title": "\u6d1b\u8c37P2221\u9898\u89e3"
    },
    {
        "content": "# \u95f2\u626f\n\n~~define ll\u771f\u597d\u7528~~\n\n\u4e00\u9053\u6bd4\u8f83\u57fa\u7840\u7684\u7ebf\u6bb5\u6811\u9898\uff0c\u53ea\u662f\u524d\u671f\u63a8\u5f0f\u5b50\u8981\u6ce8\u610f\u3002\n\n# \u9898\u9762\n\n[P2221 [HAOI2012]\u9ad8\u901f\u516c\u8def](https://www.luogu.org/problem/P2221)\n\n# Solution\n\n\u6211\u4eec\u53ef\u4ee5\u5148\u5c06\u6bcf\u6761\u8fde\u63a5 $u,v(u<v)$ \u516c\u8def\u90fd\u5bf9\u5e94\u5230 $u$ \u4e0a\u3002\n\n\u56e0\u4e3a\u662f\u7b49\u6982\u7387\u9009\u62e9\uff0c\u6240\u4ee5\u6211\u4eec\u53ea\u9700\u8981\u6c42\u51fa\u6240\u6709\u60c5\u51b5\u4e0b\u8d39\u7528\u7684\u548c\uff0c\u518d\u9664\u4ee5\u60c5\u51b5\u6570\u5373\u53ef\u3002\n\n\u8003\u8651\u600e\u4e48\u8ba1\u7b97\u8d39\u7528\u3002\n\n\u8fd9\u91cc\u6709\u4e24\u79cd\u60f3\u6cd5\uff1a\n\n1. \u7edf\u8ba1\u6bcf\u4e00\u6761\u88ab\u8ba1\u7b97\u4e86\u51e0\u6b21\u3002\n2. \u76f4\u63a5\u8ba1\u7b97\u6240\u6709\u7684\u60c5\u51b5\u3002\n\n\u6839\u636e\u672c\u4eba\u7684\u6d4b\u8bd5\uff0c\u7b2c\u4e00\u79cd\u8981\u597d\u5199\u7684\u591a\u3002\u7b2c\u4e8c\u79cd\u662f\u7ef4\u62a4\u524d\u7f00\u548c\uff0c\u4f46\u662f\u6709\u533a\u95f4\u52a0\u7684\u64cd\u4f5c\uff0c\u8c8c\u4f3c\u4e0d\u597d\u7ef4\u62a4~~\u6216\u8005\u6839\u672c\u6ca1\u6cd5\u7ef4\u62a4~~\u3002\n\n\u63a8\u5f0f\u5b50\u3002\n\n\u56e0\u4e3a\u5bf9\u4e8e\u6bcf\u4e00\u6761\u516c\u8def\uff0c\u6211\u4eec\u90fd\u5c06\u5b83\u5bf9\u5e94\u5230\u4e86\u7f16\u53f7\u8f83\u5c0f\u7684\u70b9\u4e0a\uff0c\u6240\u4ee5\u6211\u4eec\u5b9e\u9645\u9700\u8981\u7edf\u8ba1\u7684\u53ea\u6709 $l\\sim r-1$ \u8fd9\u4e00\u6bb5\u7684\u7b54\u6848\u3002\n$$\nans=\\sum_{i=l}^{r-1}(i-l+1)\\cdot(r-i)\\cdot w_i\\\\\n=(r-r\\cdot l+r\\cdot i+l\\cdot i-i-i^2)\\cdot w_i\\\\\n=(r-r\\cdot l)\\cdot w_i+(r+l-1)\\cdot i\\cdot w_i-i^2\\cdot w_i\n$$\n![](https://cdn.luogu.com.cn/upload/image_hosting/zdc4a32p.png)\n\n\u6240\u4ee5\u6211\u4eec\u53ea\u9700\u8981\u7ef4\u62a4 $\\sum w_i,\\sum w_i\\cdot i,\\sum w_i\\cdot i^2$ \u8fd9\u4e09\u4e2a\u53d8\u91cf\u5373\u53ef\u3002\n\n\u5bf9\u4e8e\u7b2c\u4e00\u4e2a\uff0c\u6211\u4eec\u76f4\u63a5\u7ef4\u62a4\u5c31\u597d\u3002\n\n\u5bf9\u4e8e\u7b2c\u4e8c\u4e2a\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u51fa\u589e\u52a0\u91cf\u4e3a $\\frac{r\\cdot(r+1)}{2}\\cdot v-\\frac{l\\cdot(l-1)}{2}\\cdot v$ \u3002\n\n\u5bf9\u4e8e\u7b2c\u4e09\u4e2a\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u51fa\u589e\u52a0\u91cf\u4e3a $\\frac{r\\cdot(r+1)\\cdot(2\\cdot r+1)}{6}\\cdot v-\\frac{(l-1)\\cdot l\\cdot(2\\cdot l-1)}{6}\\cdot v$ \u3002\n\n\u7136\u540e\u4e0a\u7ebf\u6bb5\u6811\u5c31\u884c\u3002\n\n# Code\n\n```c++\n#include<bits/stdc++.h>\n#define del(a,i) memset(a,i,sizeof(a))\n#define ll long long\n#define inl inline\n#define il inl void\n#define it inl int\n#define ill inl ll\n#define re register\n#define ri re int\n#define rl re ll\n#define mid ((l+r)>>1)\n#define lowbit(x) (x&(-x))\n#define INF 0x3f3f3f3f\nusing namespace std;\ntemplate<class T>il read(T &x){\n\tint f=1;char k=getchar();x=0;\n\tfor(;k>'9'||k<'0';k=getchar()) if(k=='-') f=-1;\n\tfor(;k>='0'&&k<='9';k=getchar()) x=(x<<3)+(x<<1)+k-'0';\n\tx*=f;\n}\ntemplate<class T>il _print(T x){\n\tif(x/10) _print(x/10);\n\tputchar(x%10+'0');\n}\ntemplate<class T>il print(T x){\n\tif(x<0) putchar('-'),x=-x;\n\t_print(x);\n}\nll mul(ll a,ll b,ll mod){long double c=1.;return (a*b-(ll)(c*a*b/mod)*mod)%mod;}\nit qpow(int x,int m,int mod){\n\tint res=1,bas=x%mod;\n\twhile(m){\n\t\tif(m&1) res=(1ll*res*bas)%mod;\n\t\tbas=(1ll*bas*bas)%mod,m>>=1;\n\t}\n\treturn res%mod;\n}\nconst int MAXN = 1e5+5;\nint n,m,x,y,k;\nchar opt[2];\n#define lc (cur<<1)\n#define rc (cur<<1|1)\nstruct Seg_Tree{\n\tll sum[3],tag;\n}T[MAXN<<2];\nil pushup(int cur){\n\tT[cur].sum[0]=T[lc].sum[0]+T[rc].sum[0];\n\tT[cur].sum[1]=T[lc].sum[1]+T[rc].sum[1];\n\tT[cur].sum[2]=T[lc].sum[2]+T[rc].sum[2];\n}\nil change(int cur,int l,int r,int k){\n\tT[cur].tag+=k;\n\tT[cur].sum[0]+=1ll*(r-l+1)*k;\n\tT[cur].sum[1]+=1ll*(1ll*r*(r+1)/2-1ll*l*(l-1)/2)*k;\n\tT[cur].sum[2]+=1ll*(1ll*r*(r+1)*(2*r+1)/6-1ll*l*(l-1)*(2*l-1)/6)*k;\n}\nil pushdown(int cur,int l,int r){\n\tif(!T[cur].tag) return ;\n\tchange(lc,l,mid,T[cur].tag);\n\tchange(rc,mid+1,r,T[cur].tag);\n\tT[cur].tag=0;\n}\nil updata(int cur,int l,int r,int L,int R,int k){\n\tif(l>=L&&r<=R) return change(cur,l,r,k),void();\n\tpushdown(cur,l,r);\n\tif(mid>=L) updata(lc,l,mid,L,R,k);\n\tif(R>mid) updata(rc,mid+1,r,L,R,k);\n\tpushup(cur);\n}\nill query(int cur,int l,int r,int L,int R,int ty){\n\tif(l>=L&&r<=R) return T[cur].sum[ty];\n\tpushdown(cur,l,r);rl res=0;\n\tif(mid>=L) res+=query(lc,l,mid,L,R,ty);\n\tif(R>mid) res+=query(rc,mid+1,r,L,R,ty);\n\treturn res;\n}\nill gcd(ll x,ll y){return y==0?x:gcd(y,x%y);}\nil Query(int l,int r){\n\trl res=0,sum;\n\tres+=(r-1ll*r*l)*query(1,1,n-1,x,y-1,0);\n\tres+=(r+l-1)*query(1,1,n-1,x,y-1,1);\n\tres-=query(1,1,n-1,x,y-1,2);\n\tri len=r-l+1;\n\tsum=1ll*(len-1)*len/2;\n\trl d=gcd(sum,res);\n\tprint(res/d),putchar('/'),print(sum/d),puts(\"\");\n}\nint main(){\n//\tfreopen(\".in\",\"r\",stdin);\n//\tfreopen(\".out\",\"w\",stdout);\n\tread(n),read(m);\n\tfor(ri i=1;i<=m;++i){\n\t\tscanf(\"%s\",opt),read(x),read(y);\n\t\tif(opt[0]=='C') read(k),updata(1,1,n-1,x,y-1,k);\n\t\tif(opt[0]=='Q') Query(x,y);\n\t}\n\treturn 0;\n}\n```\n\n# \u603b\u7ed3\n\n\u5728\u505a\u4e58\u6cd5\u7684\u65f6\u5019\u4e00\u5b9a\u8981\u6ce8\u610f\u4f1a\u4e0d\u4f1a\u7206 $int$ \u3002",
        "postTime": 1571367557,
        "uid": 122273,
        "name": "TheShadow",
        "ccfLevel": 0,
        "title": "P2221 [HAOI2012]\u9ad8\u901f\u516c\u8def \u9898\u89e3"
    },
    {
        "content": "[\u66f4\u597d\u7684\u9605\u8bfb\u4f53\u9a8c](https://www.cnblogs.com/y2823774827y/p/10193345.html)\n\n$n-1$\u6761\u8fb9\uff0c\u67e5\u8be2\u70b9$(l,r)l<r$\u76f8\u5f53\u4e8e\u8fb9$(l,r-1)$\n\uff0c$dis_{i,j}$\u8868\u793a\u8fb9$i$~$j$\u6743\u4e4b\u548c\n\n\u6bcf\u6b21\u67e5\u8be2\u8fb9$(l,r)$\n\n$ans=\\dfrac{\\sum\\limits_{i=l}^r\\sum\\limits_{j=i}^rdis_{i,j}}{C_{r-l+1}^2}=\\dfrac{\\sum\\limits_{i=l}^ra_{i}(r-i+1)(i-l+1)}{((r+1)-l)((r+1)-l+1)}$\n\n\u6211\u4eec\u6765\u770b\u4e0a\u9762\u8fd9\u90e8\u5206\uff0c\u62c6\u5f00\u540e\n\n$\\sum\\limits_{i=l}^ra_{i}(ri-rl+r-i^2+il-i+i-l+1)$\n\n$\\sum\\limits_{i=l}^ra_{i}(ri-rl+r-i^2+il-l+1)$\n\n$\\sum\\limits_{i=l}^ra_{i}(-i^2+ri+il-rl+r-l+1)$\n\n$\\sum\\limits_{i=l}^ra_{i}((-i^2)+i(l+r)+(r+1-rl-l)$\n\n$\\sum\\limits_{i=l}^ra_{i}(r+1-rl-l)+\\sum\\limits_{i=l}^ra_{i}(i(l+r))+\\sum\\limits_{i=l}^ra_{i}((-i^2)$\n\n\n\u7ebf\u6bb5\u6811\u7ef4\u62a4$\\sum\\limits_{i=l}^ra_{i},\\sum\\limits_{i=l}^ra_{i}*i,\\sum\\limits_{i=l}^ra_{i}*i*i$\u4e09\u4e2a\u503c\u5c31\u884c\u4e86\n\n\n\u73b0\u5728\u8003\u8651\u533a\u95f4\u4fee\u6539\u65f6\u600e\u4e48\u62c6\u5f00\u4e0a\u9762\u7684\u5f0f\u5b50\uff0c\u5047\u8bbe$(l,r)$\u52a0\u4e0a$val$\n\n$sum1+=val(r-l+1)$\n\n$sum2+=val[(l+r)(r-l+1)/2]$\n\n\u7ef4\u62a4$sum3$\u8981\u7528\u5230\u4e00\u4e2a\u5e38\u7528\u516c\u5f0f\u4e86\uff0c\u4e0d\u4f1a\u81ea\u884c\u767e\u5ea6$\\sum\\limits_{i=1}^ni^2=\\dfrac {n(n+1)(2n+1)}{6}$\n\n$sum3+=val\\dfrac {r(r+1)(2r+1)-(l-1)[(l-1)+1][2(l-1)+1]}{6}$\n\n\u5176\u4ed6\u7684\u5c31\u662f\u7c7b\u4f3c\u6a21\u677f\u7684\u4e1c\u897f\u4e86\n\n```cpp\n#include<cstdio>\n#include<iostream>\n#include<cstring>\n#include<string>\n#include<algorithm>\nusing namespace std;\ntypedef long long LL;\nconst LL maxn=1e7+1;\ninline LL Read(){\n    LL x=0,f=1; char c=getchar();\n    while(c<'0'||c>'9'){\n        if(c=='-') f=-1; c=getchar();\n    }\n    while(c>='0'&&c<='9')\n        x=(x<<3)+(x<<1)+c-'0',c=getchar();\n    return x*f;\n}\nstruct node{\n    LL lazy;\n    LL sum1,sum2,sum3;\n    LL son[2];\n}tree[maxn];\nLL n,m,nod,root;\ninline void Update(LL now){\n    LL son0=tree[now].son[0]; LL son1=tree[now].son[1];\n    tree[now].sum1=tree[son0].sum1+tree[son1].sum1,\n    tree[now].sum2=tree[son0].sum2+tree[son1].sum2,\n    tree[now].sum3=tree[son0].sum3+tree[son1].sum3;\n}\ninline void Pushdown(LL now,LL l,LL r){\n    if(!tree[now].lazy)\n        return;\n    LL val=tree[now].lazy;\n    if(!tree[now].son[0]) tree[now].son[0]=++nod; LL son0=tree[now].son[0]; \n    if(!tree[now].son[1]) tree[now].son[1]=++nod; LL son1=tree[now].son[1]; \n    LL mid=(l+r)>>1; LL l1=l,r1=mid,l2=mid+1,r2=r;\n    tree[son0].lazy+=val,\n    tree[son0].sum1+=(r1-l1+1)*val,\n    tree[son0].sum2+=(l1+r1)*(r1-l1+1)/2*val,\n    tree[son0].sum3+=((r1*(r1+1)*(2*r1+1)-(l1-1)*((l1-1)+1)*(2*(l1-1)+1))/6)*val,\n    tree[son1].lazy+=val,\n    tree[son1].sum1+=(r2-l2+1)*val,\n    tree[son1].sum2+=(l2+r2)*(r2-l2+1)/2*val,\n    tree[son1].sum3+=((r2*(r2+1)*(2*r2+1)-(l2-1)*((l2-1)+1)*(2*(l2-1)+1))/6)*val,\n    tree[now].lazy=0;\n}\nvoid Add(LL &now,LL l,LL r,LL lt,LL rt,LL val){\n    if(!now)\n        now=++nod;\n    if(lt<=l&&rt>=r){\n        tree[now].lazy+=val,\n        tree[now].sum1+=(r-l+1)*val,\n        tree[now].sum2+=(l+r)*(r-l+1)/2*val,\n        tree[now].sum3+=((r*(r+1)*(2*r+1)-(l-1)*((l-1)+1)*(2*(l-1)+1))/6)*val;\n        return;\n    }\n    Pushdown(now,l,r);\n    LL mid=(l+r)>>1;\n    if(lt<=mid)\n        Add(tree[now].son[0],l,mid,lt,rt,val);\n    if(rt>mid)\n        Add(tree[now].son[1],mid+1,r,lt,rt,val);\n    Update(now);\n}\nLL Query(LL &now,LL l,LL r,LL lt,LL rt){\n    if(!now)\n        now=++nod;\n    if(lt<=l&&rt>=r)\n        return (rt-lt+1-lt*rt)*tree[now].sum1+(rt+lt)*tree[now].sum2-tree[now].sum3;\n    Pushdown(now,l,r);\n    LL mid=(l+r)>>1,sum=0;\n    if(lt<=mid)\n        sum+=Query(tree[now].son[0],l,mid,lt,rt);\n    if(rt>mid)\n        sum+=Query(tree[now].son[1],mid+1,r,lt,rt);\n    return sum;\n}\nLL Gcd(LL x,LL y){\n    if(!y)\n        return x;\n    return Gcd(y,x%y);\n}\nint main(){\n    n=Read()-1,m=Read();\n    while(m--){\n        char c; scanf(\" %c\",&c);\n        LL l=Read(),r=Read()-1;\n        if(c=='C'){\n            LL val=Read();\n            Add(root,1,n,l,r,val);\n        }else{\n            LL mu=Query(root,1,n,l,r),zi=((r+1)-l)*((r+1)-l+1)/2;\n            LL g=Gcd(mu,zi);\n            printf(\"%lld/%lld\\n\",mu/g,zi/g);\n        }\n    }\n    return 0;\n}/*\n*/\n```\n",
        "postTime": 1546009588,
        "uid": 88804,
        "name": "y2823774827y",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P2221 \u3010[HAOI2012]\u9ad8\u901f\u516c\u8def\u3011"
    },
    {
        "content": "\u671f\u671b\u503c= \u03a3 \u53ef\u80fd\u60c5\u51b5\\*\u51fa\u73b0\u6982\u7387\n\n\u56e0\u4e3a\u6240\u6709\u6982\u7387\u76f8\u7b49\uff0c\u6240\u4ee5\u672c\u9898\u53ef\u4ee5\u8f6c\u5316\u4e3a\u6c42 \u5b50\u96c6\u548c/\u5b50\u96c6\u4e2a\u6570\n\n\u6839\u636e\u7ec4\u5408\u6570\uff0c\u5b50\u96c6\u4e2a\u6570=C\uff08r-l+1,2\uff09= \uff08r-l+1\uff09\\*\uff08r-l\uff09/2\n\n\u5b50\u96c6\u548c\u5462\n\n\u63a8\u516c\u5f0f\n\n\u5b50\u96c6\u548c=\u03a3 (i-l+1)\\*(r-i+1)\\*cost[i]\n\n\u5176\u4e2d\uff0c(i-l+1)\\*(r-i+1) \u662f\u6bcf\u4e2a\u6570\u7528\u5230\u7684\u6b21\u6570\n\n\u62c6\u5f00\uff0c= (l+r)\\* \u03a3 i\\*cost[i] + (r-l+1-l\\*r) \\* \u03a3 cost[i] - \u03a3 i\\*i\\*cost[i]\n\n\u7ebf\u6bb5\u6811\u7ef4\u62a4  \u03a3cost[i] \uff0c\u03a3 i\\*cost[i]\uff0c\u03a3 i\\*i\\*cost[i]\n\n\u66f4\u65b0\uff0c\u4ee5+w\u4e3a\u4f8b\uff1a\n\n\u03a3cost[i] \u52a0\u4e86size \u4e2aw\uff0c\u6240\u4ee5 \u03a3cost[i] +=size\\*w\n\n\u03a3 i\\*cost[i] \u52a0\u4e86 szie \u4e2a\u03a3 i\uff0c\u6240\u4ee5 \u03a3 i\\*cost[i] += size\\*\u03a3 i\n\n\u03a3 i\\*i\\*cost[i] \u52a0\u4e86 size\u4e2a \u03a3 i\\*i\uff0c\u6240\u4ee5\u03a3 i\\*i\\*cost[i] += size \\*\u03a3 i\\*i\n\n\u6240\u4ee5\u7ebf\u6bb5\u6811\u9700\u8981\u53e6\u5916\u7ef4\u62a4 \u03a3i\uff0c\u03a3i\\*i\n\n\n\u4ee3\u7801\u8bf7\u8f6c\u81f3 http://www.cnblogs.com/TheRoadToTheGold/p/7306066.html\n",
        "postTime": 1502164014,
        "uid": 21351,
        "name": "xuxinyu",
        "ccfLevel": 4,
        "title": "\u9898\u89e3 P2221 \u3010[HAOI2012]\u9ad8\u901f\u516c\u8def\u3011"
    },
    {
        "content": "## \u9898\u610f\u7b80\u8ff0\n\n$v$ \u662f\u4e00\u4e2a\u957f\u4e3a $n-1$ \u7684\u5e8f\u5217\uff0c\u6240\u6709 $v_i$ \u7684\u521d\u503c\u4e3a $0$\u3002\n\n\u6709 $m$ \u4e2a\u64cd\u4f5c\uff1a\n\n1. \u4fee\u6539\uff1a$\\texttt C~~l~~r~~x$  \n\t\u5c06 $v_l\\sim v_{r-1}$ \u52a0\u4e0a $x$\u3002\n\n2. \u67e5\u8be2\uff1a$\\texttt Q~~l~~r$  \n\t\u968f\u673a\u53d6 $v_l\\sim v_{r-1}$ \u7684\u4e00\u4e2a\u5b50\u6bb5\uff0c\u6c42\u5b50\u6bb5\u548c\u7684\u671f\u671b\u3002\n\n\u8f93\u51fa\u6bcf\u6b21\u8be2\u95ee\u64cd\u4f5c\u7684\u7b54\u6848\u3002\uff08\u4ee5\u65e2\u7ea6\u5206\u6570\u7684\u5f62\u5f0f\u8f93\u51fa\uff09\n\n$1\\le n,m\\le 10^5.$    \n\u4fdd\u8bc1\u5728\u4efb\u4f55\u65f6\u523b\uff0c\u90fd\u6709 $0\\le v_i\\le 10^4.$\n\n## \u9898\u89e3\n\n\u8fd9\u91cc\u7ed9\u51fa\u4e00\u79cd\u6811\u72b6\u6570\u7ec4\u505a\u6cd5\u3002\n\n\u4fee\u6539\u64cd\u4f5c\u5c31\u662f\u5f88\u666e\u901a\u7684\u533a\u95f4\u52a0\uff0c\u7ef4\u62a4\u4e00\u4e0b\u5dee\u5206\u5c31\u597d\u4e86\u3002\n\n\u5bf9\u4e8e\u67e5\u8be2\u64cd\u4f5c\uff0c\u8003\u8651\u6bcf\u4e2a $v_i$ \u7684\u8d21\u732e\uff0c\u4e0d\u96be\u5199\u51fa\u5f0f\u5b50\uff1a \n\n$$ans=\\dfrac{\\sum\\limits_{i=l}^{r-1}v_i(r-i)(i-l+1)}{C_L^2}$$\n\n\u5176\u4e2d $L=r-l+1$\u3002\n\n\u6ce8\u610f\u6211\u4eec\u7ef4\u62a4\u7684\u662f\u5dee\u5206\u6570\u7ec4 $d_i=a_i-a_{i-1}$\uff0c\u56e0\u6b64\u8981\u6539\u5199\u4e00\u4e0b\u5f0f\u5b50\uff1a\n\n$$C_L^2ans=\\sum_{i=l}^{r-1}(r-i)(i-l+1)\\sum_{j=1}^id_j$$\n\n\u8003\u8651\u6bcf\u4e2a $d_j$ \u7684\u8d21\u732e\uff1a\n\n$$\\begin{aligned}\nC_L^2ans \n= & \\sum_{j=1}^ld_j\\sum_{i=l}^{r-1}(r-i)(i-l+1) \\\\\n& + \\sum_{j=l+1}^{r-1}d_j\\sum_{i=j}^{r-1}(r-i)(i-l+1)\n\\end{aligned}$$\n\n\u66b4\u529b\u5c55\u5f00\u7684\u8bdd\u611f\u89c9\u6709\u70b9\u5bc4\u3002\u5148\u505a\u4e2a\u7b80\u5316\u5904\u7406\uff1a\n\n$$\\begin{aligned}\n& \\sum_{i=l}^{r-1}(r-i)(i-l+1) \\\\\n= & (r-l)\\cdot 1+(r-l-1)\\cdot 2+\\cdots+1\\cdot(r-l) \\\\\n= & \\sum_{i=1}^Li(L-i)\n\\end{aligned}$$\n\n$$\\begin{aligned}\n& \\sum_{i=j}^{r-1}(r-i)(i-l+1) \\\\\n= & (r-j)\\cdot (j-l+1)+\\cdots+1\\cdot(r-l+1) \\\\\n= & \\sum_{i=1}^{r-j}i(L-i)\n\\end{aligned}$$\n\n\u8bb0 $F(L,t)=\\sum\\limits_{i=1}^ti(L-i)$\uff0c\u5219\u4e0a\u9762\u4e24\u4e2a\u5f0f\u5b50\u5206\u522b\u662f $F(L,L)$ \u548c $F(L,r-j)$\u3002\n\n$$\\begin{aligned}\nF(L,t)&= \\sum_{i=1}^ti(L-i)\\\\\n&= L\\sum_{i=1}^t i-\\sum_{i=1}^ti^2\\\\\n&= L\\cdot\\dfrac{t(t+1)}2-\\dfrac{t(t+1)(2t+1)}6\\\\\n&= \\dfrac{t(t+1)}2\\cdot\\left(L-\\dfrac{2t+1}3\\right)\\\\\n&= \\dfrac{t(t+1)(3L-2t-1)}6\n\\end{aligned}$$\n\n\u4ee3\u5165 $t=L$ \u548c $t=r-j$\u3002\n\n$$F(L,L)=\\dfrac{L(L+1)(L-1)}6$$\n\n$$F(L,r-j)=\\dfrac{(r-j)(r-j+1)(2j+r-3l+2)}6$$\n\n\u540e\u8005\u662f\u7528 $L=r-l+1$ \u6d88\u6389\u4e86 $L$\u3002\n\n\u7136\u540e\u6211\u4eec\u628a\u8fd9\u4e24\u4e2a\u4e1c\u897f\u4ee3\u56de $ans$ \u7684\u8868\u8fbe\u5f0f\uff1a\n\n$$\\begin{aligned}\n6C_L^2ans = & (L-1)L(L+1)\\sum_{j=1}^ld_j \\\\\n& +\\sum_{j=l+1}^{r-1}d_j(j-r)(j-r-1)(2j+r-3l+2)\n\\end{aligned}$$\n\n\u53ea\u9700\u5c55\u5f00 $(j-r)(j-r-1)(2j+r-3l+2)$\u3002\uff08\u4ee5 $j$ \u4e3a\u4e3b\u5143\uff09\n\n\u4e09\u6b21\u9879\u7cfb\u6570\uff1a$2$\u3002\n\n\u4e8c\u6b21\u9879\u7cfb\u6570\uff1a$-2r-2(r+1)+(r-3l+2)=-3(l+r)$\u3002\n\n\u4e00\u6b21\u9879\u7cfb\u6570\uff1a$2r(r+1)-r(r-3l+2)-(r+1)(r-3l+2)=6lr-3L+1$\u3002  \n\uff08\u8fd9\u91cc\u53c8\u6539\u7528 $L$ \u53ea\u662f\u4e3a\u4e86\u597d\u770b\uff09\n\n\u5e38\u6570\u9879\uff1a$r(r+1)(r-3l+2)$\u3002\n\n\u5230\u8fd9\u91cc\u57fa\u672c\u5c31\u7ed3\u675f\u4e86\u3002\n\n$$\\begin{aligned}\n6C_L^2 ans = & \\sum_{j=1}^ld_j\\times(L-1)L(L+1) \\\\\n& +\\sum_{i=l+1}^{r-1}j^3d_j\\times2 \\\\\n& -\\sum_{i=l+1}^{r-1}j^2d_j\\times3(l+r)\\\\\n& +\\sum_{i=l+1}^{r-1}jd_j\\times(6lr-3L+1)\\\\\n& +\\sum_{i=l+1}^{r-1}d_j\\times r(r+1)(r-3l+2)\n\\end{aligned}$$\n\n\u7528\u6811\u72b6\u6570\u7ec4\u7ef4\u62a4 $j^kd_j(k=0,1,2,3)$ \u7684\u524d\u7f00\u548c\u5373\u53ef\u3002\n\n\u5176\u5b9e\u8ba1\u7b97\u8fc7\u7a0b\u4e2d\u662f\u6709\u53ef\u80fd\u7206 long long \u7684\u3002  \n\u4f46\u76f4\u63a5\u6ea2\u51fa\u5565\u4e8b\u6ca1\u6709\uff0c\u53cd\u6b63\u5168\u90e8\u52a0\u8d77\u6765\u4e4b\u540e\u53c8\u56de\u5230 long long \u8303\u56f4\u5185\u4e86\u3002\n\n\u6c42 gcd \u7ea6\u5206\u4ec0\u4e48\u7684\u4e0d\u8bf4\u4e86\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(m\\log n)$\u3002\u53ea\u5e26 $4\\sim5$ \u500d\u5e38\u6570\uff0c\u975e\u5e38\u8212\u9002\uff08\n\n\u53e6\u5916\uff0c\u867d\u7136\u63a8\u5f0f\u5b50\u7684\u8fc7\u7a0b\u6bd4\u8f83\u7e41\u7410\uff0c\u4f46\u4ee3\u7801\u8fd8\u662f\u5f88\u597d\u5199\u7684\u3002\n\n## \u4ee3\u7801\u5b9e\u73b0\n\n```cpp\n#include<stdio.h>\ntypedef long long ll;\n\nconst int N=1e5+5;\n\nint n,m,l,r,L,x;\nll b[4][N];\n\nvoid Upd(int i,ll x) {\n    for (int k=0; k<4; ++k,x*=i)\n        for (int j=i; j<=n; j+=(j&-j))\n            b[k][j]+=x;\n}\n\nll qry(int k,int i) {\n    ll s=0;\n    while (i)\n        s+=b[k][i],\n        i&=i-1;\n    return s;\n}\n\nll Qry() {\n    ll ans=qry(0,l)*(L-1)*L*(L+1);\n    ans+=(qry(3,r-1)-qry(3,l))*2;\n    ans-=(qry(2,r-1)-qry(2,l))*3*(l+r);\n    ans+=(qry(1,r-1)-qry(1,l))*(6ll*l*r-3*L+1);\n    ans+=(qry(0,r-1)-qry(0,l))*r*(r+1)*(r-3*l+2);\n    return ans;\n}\n\nll gcd(ll x,ll y) { return y?gcd(y,x%y):x; }\n\nint main() {\n    scanf(\"%d%d\",&n,&m);\n    while (m--) {\n        char ch=getchar();\n        while (ch!='C'&&ch!='Q')\n            ch=getchar();\n        scanf(\"%d%d\",&l,&r);\n        if (ch=='C') { //\u4fee\u6539\n            scanf(\"%d\",&x);\n            Upd(l,x),\n            Upd(r,-x);\n        }\n        else { //\u67e5\u8be2\n            L=r-l+1;\n            ll x=Qry(); //\u5206\u5b50\n            ll y=3ll*L*(L-1); //\u5206\u6bcd\u53736*C(L,2)\n            ll g=gcd(x,y);\n            x/=g,y/=g;\n            printf(\"%lld/%lld\\n\",x,y);\n        }\n    }\n    return 0;\n}\n```",
        "postTime": 1658062479,
        "uid": 38785,
        "name": "icyM3tra",
        "ccfLevel": 0,
        "title": "\u3010\u9898\u89e3\u3011P2221 [HAOI2012]\u9ad8\u901f\u516c\u8def"
    },
    {
        "content": "[\u66f4\u597d\u7684\u9605\u8bfb\u4f53\u9a8c](https://www.cnblogs.com/Coros-Trusds/p/16255536.html)\n\n# \u9898\u76ee\u5927\u610f\n\n\u7ed9\u4f60\u4e00\u4e2a\u5e8f\u5217\uff0c\u8be2\u95ee\u4e00\u4e2a\u533a\u95f4\u6c42\u4ece\u4e2d\u4efb\u9009\u4e00\u4e2a\u5b50\u533a\u95f4\u7684\u6743\u503c\u548c\u7684\u671f\u671b\u3002**\u64cd\u4f5c\u5e26\u4fee\u3002**\n\n# \u9898\u76ee\u5206\u6790\n\n\u975e\u5e38\u5bb9\u6613\u60f3\u5230\u7ebf\u6bb5\u6811\u3002\n\n**\u5957\u8def\u4e00\uff1a\u6ce8\u610f\u5230\u8fb9\u6743\u4e0d\u5bb9\u6613\u8003\u8651\uff0c\u6211\u4eec\u8f6c\u8fb9\u6743\u4e3a\u70b9\u6743\u3002**\n\n\u5bf9\u4e8e\u8be2\u95ee $[l,r]$\uff0c\u6211\u4eec\u7684\u671f\u671b\u503c\u4e3a $\\sum\\limits_{i=l}^r\\sum\\limits_{j=i}^r\\dfrac{dist(i,j)}{{r-l+1}\\choose 2}$\u3002\u4e0b\u9762\u90a3\u4e2a\u53ef\u4ee5\u8f7b\u6613\u6c42\u51fa\uff0c\u6211\u4eec\u91cd\u70b9\u770b $\\sum\\limits_{i=l}^r\\sum\\limits_{j=i}^rdist(i,j)$\u3002\n\n\u8fd9\u4e2a\u5f0f\u5b50\u76f4\u63a5\u6c42\u662f $\\mathcal{O(n^3)}$ \u7684\uff0c\u6839\u636e\u6570\u636e\u8303\u56f4\u6211\u4eec\u9700\u8981\u628a\u5b83\u4f18\u5316\u5230 $\\mathcal{O(\\log n)}$\u3002\u6211\u4eec\u770b\u770b\u6709\u4ec0\u4e48\u5730\u65b9\u53ef\u4ee5\u4f18\u5316\u3002\n\n\u9996\u5148\u5c31\u662f $dist(i,j)$\uff0c\u53ef\u4ee5\u7528\u524d\u7f00\u548c\u4f18\u5316\uff0c$dist(i,j)$ \u548c $sum[j]-sum[i-1]$ \u662f\u7b49\u4ef7\u7684\uff0c\u5176\u4e2d $sum[i]=\\sum\\limits_{j=1}^iv_j$\u3002\u9884\u5904\u7406\u51fa $sum$\uff0c\u5355\u6b21\u8be2\u95ee $\\mathcal{O(n^2)}$\u3002\n\n\u8fd8\u662f\u4e0d\u591f\u3002\n\n**\u5957\u8def\u4e8c\uff1a\u76f4\u63a5\u7b97\u4e0d\u5bb9\u6613\uff0c\u6211\u4eec\u4e0d\u59a8\u8ba1\u7b97\u6bcf\u4e2a\u503c\u7684\u8d21\u732e\u3002**\n\n\u6362\u800c\u8a00\u4e4b\uff0c\u5957\u4e24\u4e2a $\\sum$ \u4e0d\u597d\u6c42\u90a3\u4e48\u6211\u4eec\u4e0d\u5982\u76f4\u63a5\u7b97\u6bcf\u4e2a $v_i$ \u4f1a\u88ab\u7b97\u51e0\u6b21\u3002\u4f1a\u88ab\u7b97\u51e0\u6b21\u5462\uff1f\u5bf9\u4e8e $v_i$\uff0c\u533a\u95f4\u603b\u6570\u662f $(r-i+1)\\times (i-l+1)$\u3002\u6bcf\u6b21\u90fd\u4f1a\u88ab\u7b97\u4e00\u6b21\uff0c\u6240\u4ee5 $v_i$ \u4f1a\u88ab\u7b97 $(r-i+1)\\times(i-l+1)$ \u6b21\u3002\n\n\u5f0f\u5b50\u8f6c\u5316\u4e3a $\\sum\\limits_{i=l}^rv_i\\times(r-i+1)\\times(i-l+1)$\uff0c\u5355\u6b21\u590d\u6742\u5ea6 $\\mathcal{O(n)}$\u3002\n\n\u63a5\u4e0b\u6765\u63a8\u63a8\u5f0f\u5b50\uff1a\n\n$$\\sum\\limits_{i=l}^rv_i\\times(r-i+1)\\times(i-l+1)$$\n\n$$=\\sum\\limits_{i=l}^rv_i\\times(r\\cdot i-l\\cdot r+r-i^2+l\\cdot i\\color{red}{-i+i}\\color{black}-l+1)$$\n\n\u7ea2\u8272\u90e8\u5206\u62b5\u6d88\u6389\uff1a\n\n$$=\\sum\\limits_{i=l}^rv_i\\times(r\\cdot i-l\\cdot r+r-i^2+l\\cdot i-l+1)$$\n\n$$=\\sum\\limits_{i=l}^rv_i\\times i\\times(l+r)+\\sum\\limits_{i=l}^rv_i\\times(r-l+1-l\\cdot r)-\\sum\\limits_{i=l}^rv_i\\times i^2$$\n\n\u4e09\u4e2a\u90e8\u5206\u90fd\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811\u6765\u7b97\u3002\n\n# \u4ee3\u7801\n\n\u7ebf\u6bb5\u6811\u4e2d\uff0c\u6211\u4eec\u7528 $s4,s5$ \u5206\u522b\u5b58\u50a8\u533a\u95f4\u548c\u548c\u533a\u95f4\u5e73\u65b9\u548c\uff0c\u5373 $\\sum\\limits_{i=l}^ri$ \u548c $\\sum\\limits_{i=l}^ri^2$\u3002\u7528 $s1,s2,s3$ \u5206\u522b\u5b58\u50a8 $\\sum\\limits_{i=l}^rv_i$\uff0c$\\sum\\limits_{i=l}^rv_i\\times i$ \u548c $\\sum\\limits_{i=l}^rv_i\\times i^2$\u3002\n\n```cpp\n//2022/5/10\n#define _CRT_SECURE_NO_WARNINGS\n#include <iostream>\n#include <cstdio>\n#include <climits>//need \"INT_MAX\",\"INT_MIN\"\n#include <cstring>//need \"memset\"\n#include <numeric>\n#include <algorithm>\n#define int long long\n#define enter putchar(10)\n#define debug(c,que) std::cerr << #c << \" = \" << c << que\n#define cek(c) puts(c)\n#define blow(arr,st,ed,w) for(register int i = (st);i <= (ed); ++ i) std::cout << arr[i] << w;\n#define speed_up() ios::sync_with_stdio(false),cin.tie(0),cout.tie(0)\n#define mst(a,k) memset(a,k,sizeof(a))\n#define Abs(x) ((x) > 0 ? (x) : (-x))\n#define stop return(0)\nconst int mod = 1e9 + 7;\ninline int MOD(int x) {\n\tif (x < 0) x += mod;\n\treturn x % mod;\n}\nnamespace Newstd {\n\tchar buf[1 << 21],*p1 = buf,*p2 = buf;\n\tinline int getc() {\n\t\treturn p1 == p2 && (p2 = (p1 = buf) + fread(buf,1,1 << 21,stdin),p1 == p2) ? EOF : *p1 ++;\n\t}\n\tinline int read() {\n\t\tint ret = 0,f = 0;char ch = getc();\n\t\twhile (!isdigit(ch)) {\n\t\t\tif(ch == '-') f = 1;\n\t\t\tch = getc();\n\t\t}\n\t\twhile (isdigit(ch)) {\n\t\t\tret = (ret << 3) + (ret << 1) + ch - 48;\n\t\t\tch = getc();\n\t\t}\n\t\treturn f ? -ret : ret;\n\t}\n\tinline void write(int x) {\n\t\tif (x < 0) {\n\t\t\tputchar('-');\n\t\t\tx = -x;\n\t\t}\n\t\tif (x > 9) write(x / 10);\n\t\tputchar(x % 10 + '0');\n\t}\n}\nusing namespace Newstd;\n\nconst int N = 2e5 + 5;\nint C[N][3];\nint n,m,sum1,sum2,sum3;\ninline int gcd(int a,int b) {\n\treturn b == 0 ? a : gcd(b,a % b);\n}\ninline void init() {\n\tC[0][0] = 1;\n\tfor (register int i = 1;i <= 1e5; ++ i) {\n\t\tC[i][0] = 1;\n\t\tfor (register int j = 1;j <= 2; ++ j) {\n\t\t\tC[i][j] = C[i - 1][j] + C[i - 1][j - 1];\n\t\t}\n\t}\n}\nstruct Segment_Tree {\n\tstruct Node {\n\t\tint l,r;\n\t\tint tag,s1,s2;\n\t\tint s3,s4,s5;\n\t} node[N << 2];\n\t#define lson (p << 1)\n\t#define rson (p << 1 | 1)\n\tinline void pushup(int p) {\n\t\tnode[p].s1 = node[lson].s1 + node[rson].s1;\n\t\tnode[p].s2 = node[lson].s2 + node[rson].s2;\n\t\tnode[p].s3 = node[lson].s3 + node[rson].s3;\n\t\tnode[p].s4 = node[lson].s4 + node[rson].s4;\n\t\tnode[p].s5 = node[lson].s5 + node[rson].s5;\n\t}\n\tinline void build(int p,int l,int r) {\n\t\tnode[p].l = l,node[p].r = r;\n\t\tif (l == r) {\n\t\t\tnode[p].s4 = l,node[p].s5 = l * l;\n\t\t\treturn;\n\t\t}\n\t\tint mid = l + r >> 1;\n\t\tbuild(lson,l,mid),build(rson,mid + 1,r);\n\t\tpushup(p);\n\t}\n\tinline void pushdown(int p) {\n\t\tif (node[p].tag) {\n\t\t\tnode[lson].tag += node[p].tag,node[rson].tag += node[p].tag;\n\t\t\tnode[lson].s1 += node[p].tag * (node[lson].r - node[lson].l + 1);\n\t\t\tnode[rson].s1 += node[p].tag * (node[rson].r - node[rson].l + 1);\n\t\t\tnode[lson].s2 += node[p].tag * node[lson].s4;\n\t\t\tnode[rson].s2 += node[p].tag * node[rson].s4;\n\t\t\tnode[lson].s3 += node[p].tag * node[lson].s5;\n\t\t\tnode[rson].s3 += node[p].tag * node[rson].s5;\n\t\t\tnode[p].tag = 0;\n\t\t}\n\t}\n\tinline void update(int x,int y,int p,int k) {\n\t\tpushdown(p);\n\t\tif (x <= node[p].l && node[p].r <= y) {\n\t\t\tnode[p].tag += k;\n\t\t\tnode[p].s1 += k * (node[p].r - node[p].l + 1);\n\t\t\tnode[p].s2 += k * node[p].s4,node[p].s3 += k * node[p].s5;\n\t\t\treturn;\n\t\t}\n\t\tint mid = node[p].l + node[p].r >> 1;\n\t\tif (x <= mid) update(x,y,lson,k);\n\t\tif (y > mid) update(x,y,rson,k);\n\t\tpushup(p);\n\t}\n\tinline void query(int x,int y,int p) {\n\t\tpushdown(p);\n\t\tif (x <= node[p].l && node[p].r <= y) {\n\t\t\tsum1 += node[p].s1,sum2 += node[p].s2,sum3 += node[p].s3;\n\t\t\treturn;\n\t\t}\n\t\tint mid = node[p].l + node[p].r >> 1;\n\t\tif (x <= mid) query(x,y,lson);\n\t\tif (y > mid) query(x,y,rson);\n\t}\n\t#undef lson\n\t#undef rson\n} seg;\n#undef int\nint main(void) {\n#ifndef ONLINE_JUDGE\n\tfreopen(\"in.txt\",\"r\",stdin);\n#endif\n\t#define int long long\n\tstd::cin.tie(0),std::cout.tie(0);\n\tstd::cin >> n >> m;\n\tinit();\n\tseg.build(1,1,n);\n\twhile (m --) {\n\t\tchar ch[2];\n\t\tint l,r;\n\t\tstd::cin >> ch >> l >> r;\n\t\tif (ch[0] == 'C') {\n\t\t\tint k;\n\t\t\tstd::cin >> k;\n\t\t\tseg.update(l + 1,r,1,k);\n\t\t} else {\n\t\t\tsum1 = sum2 = sum3 = 0;\n\t\t\tseg.query(l + 1,r,1);\n\t\t\tint up = (l + 1 + r) * sum2 + ((r - (l + 1)) + 1 - (l + 1) * r) * sum1 - sum3;\n\t\t\tint down = C[r - l + 1][2];\n\t\t\tint t = gcd(up,down);\n\t\t\tstd::cout << up / t << \"/\" << down / t << '\\n';\n\t\t}\n\t}\n\t\n\treturn 0;\n}\n```",
        "postTime": 1652190201,
        "uid": 430409,
        "name": "Coros_Trusds",
        "ccfLevel": 6,
        "title": "P2221 [HAOI2012]\u9ad8\u901f\u516c\u8def"
    },
    {
        "content": "# \u9ad8\u901f\u516c\u8def\u9898\u89e3\n\u6211\u4eec\u770b\u4e00\u770b\u9898\uff0c\u5c31\u77e5\u9053\u6982\u7387\u662f\u662f\u533a\u95f4\u5185\u6240\u6709\u7ebf\u6bb5\u7684\u6743\u503c\u548c/\u7ebf\u6bb5\u4e2a\u6570\u3002\n\n\u90a3\u4e48\uff0c\u6211\u4eec\u9700\u8981\u52a8\u6001\u7ef4\u62a4\u533a\u95f4\u7684\u6570\u636e\u7ed3\u6784\uff0c\n\n\u5f88\u5bb9\u6613\u60f3\u5230\u7ebf\u6bb5\u6811\uff0c\n\n\u8003\u8651\uff0c\u5982\u4f55\u5c06\u4e24\u4e2a\u533a\u95f4\u5408\u5e76\uff1a\n#### \u6ce8:\u4ee5\u4e0b\u7ebf\u6bb5\u6811\u4e0a\u7684\u6bcf\u4e2a\u70b9\u7684$sum$\u5728\u4ee3\u7801\u4e2d\u4e3a$sum2$\uff0c\u4ec5\u4e3a\u65b9\u4fbf\u7406\u89e3\u3002\n\u4e0d\u59a8\u8bbe\u6bcf\u4e2a\u533a\u95f4$[l,r]$\u5185\u7684\u6240\u6709\u7ebf\u6bb5\u6743\u503c\u548c\u4e3a$w$\uff0c\n\n$[l,r]$\u7684\u7ebf\u6bb5\u6743\u503c\u4e3a$sum$\uff0c\n\n\u5de6\u7aef\u70b9\u4e3a$l$\u7684\u6240\u6709\u7ebf\u6bb5\u6743\u503c\u548c\u4e3a$lw$\uff0c\n\n\u53f3\u7aef\u70b9\u4e3a$r$\u7684\u6240\u6709\u7ebf\u6bb5\u7684\u6743\u503c\u548c\u4e3a$rw$\uff0c\n\n\u61d2\u6807\u8bb0\u4e3a$lazy$\uff0c\u533a\u95f4\u957f\u5ea6\u4e3a$lenx=r-l+1$\n\n\u5047\u5982\u6b64\u533a\u95f4\u4e3a$x$,\u5de6\u533a\u95f4\u4e3a$lc$,\u53f3\u533a\u95f4\u4e3a$rc$:\n\n$x$\u7684$w$\u9664\u53bb\u7531$lc,rc$\u5404\u81ea\u533a\u95f4\u5185\u90e8\u7684$w$\u5916,\n\n\u8fd8\u7531\u7ecf\u8fc7\u5de6\u53f3\u4e24\u4e2a\u533a\u95f4\u7684\u7ebf\u6bb5\u6784\u6210,\n\n\u753b\u56fe\u7406\u89e3\u4e00\u4e0b\uff1a\n![](https://img2018.cnblogs.com/blog/1655789/201908/1655789-20190824173603843-1171305639.png)\n\n\u7136\u540e\u7b2c\u4e8c\u4e2a\u95ee\u9898\u6765\u4e86\uff0c\u5982\u4f55\u7ef4\u62a4$lw,rw$?\n![](https://img2018.cnblogs.com/blog/1655789/201908/1655789-20190824174505341-769792856.png)\n\u81f3\u4e8e$sum,lazy$\u8fd8\u7528\u8bf4\u5417\uff1f \u7ebf\u6bb5\u6811\u6a21\u677f\u554a\uff01\n```cpp\nxd pushup(xd u,xd v){\n   xd ans; int len=u.lenx+v.lenx;\n   ans.lw=u.lw+v.lw+v.lenx*u.sum2,ans.rw=u.rw+v.rw+u.lenx*v.sum2,ans.lazy=0;\n   ans.w=u.w+v.w+u.lenx*v.lw+v.lenx*u.rw,ans.sum2=u.sum2+v.sum2,ans.lenx=len;\n   return ans;\n}\n```\n\n\u518d\u60f3\u60f3\u4e0b\u4f20\u6807\u8bb0\uff1a\n\n\u5bf9\u4e8e\u6bcf\u4e2a$x$\u7684$w$\uff0c\u6240\u6709\u7ebf\u6bb5\u90fd\u52a0\u4e86\u7ebf\u6bb5\u957f\u5ea6$*lazy[x]$;\n\n\u8bbe$sum[len]$\u4e3a\u957f\u5ea6\u4e3a$len$\u7684\u533a\u95f4\u6240\u6709\u7ebf\u6bb5\u7684\u957f\u5ea6\u548c\u3002\n\n\u7531$l-1$\u6bcf\u589e\u52a0\u4e00\u4e2a\u957f\u5ea6\uff0c\u5219\u6bcf\u4e2a\u957f\u5ea6\u7684\u7ebf\u6bb5\u90fd\u6709\u4e00\u4e2a\uff0c\u5373\u4e3a:\n$\\sum_{i=1}^{l}=/frac{(l+1)*l}{2}$\n\u9012\u63a8\u5373\u53ef\u3002\n\n```cpp\nfor(ll i=1;i<=n;++i) sum[i]=sum[i-1]+i*(i+1)/2;\n```\n\u6240\u4ee5\uff1a\n```cpp\nt[lc].w+=sum[t[lc].lenx]*t[x].lazy,t[rc].w+=sum[t[rc].lenx]*t[x].lazy;\n```\n\u5bf9\u4e8e$lw$\u548c$rw$\uff1a\n\u533a\u95f4$[l,r]$\u957f\u5ea6\u5728[1,r-l+1]\u7684\u7ebf\u6bb5\u90fd\u6709\u4e00\u79cd\uff1a\n```cpp\nt[lc].lw+=(t[lc].lenx+1)*t[lc].lenx/2*t[x].lazy,t[lc].rw+=(t[lc].lenx+1)*t[lc].lenx/2*t[x].lazy;\nt[rc].lw+=(t[rc].lenx+1)*t[rc].lenx/2*t[x].lazy,t[rc].rw+=(t[rc].lenx+1)*t[rc].lenx/2*t[x].lazy;\n```\n$sum,lenx,lazy$\u7684\u4e0b\u4f20\u4e5f\u4e0d\u8bb2\u4e86\u3002\n```cpp\n#include<bits/stdc++.h>\n#define ll long long \n#define lc x<<1\n#define rc x<<1|1\nusing namespace std;\nconst int N=1e5+6;\nint n,m,t3;\nll sum[N],o,p,q,t1,t2;\nchar c[12];\nstruct xd{ll w,lazy,lw,rw,lenx,sum2;}t[N<<2];\ninline int read(){\n   int T=0,F=1; char ch=getchar();\n   while(ch<'0'||ch>'9'){if(ch=='-') F=-1; ch=getchar();}\n   while(ch>='0'&&ch<='9') T=(T<<3)+(T<<1)+(ch-48),ch=getchar();\n   return F*T;\n}\nll gcd(ll u,ll v){return u%v==0?v:gcd(v,u%v);}\nvoid pushdown(int x){\n     if(t[x].lazy){\n        t[lc].lazy+=t[x].lazy,t[rc].lazy+=t[x].lazy;\n        t[lc].w+=sum[t[lc].lenx]*t[x].lazy,t[rc].w+=sum[t[rc].lenx]*t[x].lazy;\n        t[lc].lw+=(t[lc].lenx+1)*t[lc].lenx/2*t[x].lazy,t[lc].rw+=(t[lc].lenx+1)*t[lc].lenx/2*t[x].lazy;\n        t[rc].lw+=(t[rc].lenx+1)*t[rc].lenx/2*t[x].lazy,t[rc].rw+=(t[rc].lenx+1)*t[rc].lenx/2*t[x].lazy;\n        t[lc].sum2+=t[lc].lenx*t[x].lazy,t[rc].sum2+=t[rc].lenx*t[x].lazy;\n        t[x].lazy=0;\n     }\n}\nxd pushup(xd u,xd v){\n   xd ans; int len=u.lenx+v.lenx;\n   ans.lw=u.lw+v.lw+v.lenx*u.sum2,ans.rw=u.rw+v.rw+u.lenx*v.sum2,ans.lazy=0;\n   ans.w=u.w+v.w+u.lenx*v.lw+v.lenx*u.rw,ans.sum2=u.sum2+v.sum2,ans.lenx=len;\n   return ans;\n}\nvoid build(int l,int r,int x){\n     t[x].lenx=r-l+1;\n     if(l==r) return;\n     int mid=l+r>>1;\n     build(l,mid,lc),build(mid+1,r,rc);\n} \nvoid update(ll l,ll r,int p,int q,int x,ll y){\n     if(p<=l&&r<=q){t[x].lazy+=y,t[x].w+=sum[r-l+1]*y,t[x].lw+=(r-l+1)*(r-l+2)/2*y,t[x].rw+=(r-l+1)*(r-l+2)/2*y,t[x].sum2+=(r-l+1)*y;  return;}\n     pushdown(x); int mid=l+r>>1;\n     if(p<=mid) update(l,mid,p,q,lc,y);\n     if(q>mid) update(mid+1,r,p,q,rc,y);\n     t[x]=pushup(t[lc],t[rc]);\n}\nxd query(int l,int r,int p,int q,int x){\n   if(p<=l&&r<=q){return t[x];}\n   pushdown(x); int mid=l+r>>1; xd ans;\n   if(q<=mid) ans=query(l,mid,p,q,lc);\n   else if(p>mid) ans=query(mid+1,r,p,q,rc);\n   else ans=pushup(query(l,mid,p,q,lc),query(mid+1,r,p,q,rc));\n   return ans;\n}\nint main(){\n    n=read(),m=read(),--n;\n    for(ll i=1;i<=n;++i) sum[i]=sum[i-1]+i*(i+1)/2;\n    build(1,n,1);\n    for(int i=1;i<=m;++i){\n        scanf(\"%s\",c); t1=read(),t2=read()-1;\n        if(c[0]=='C') t3=read(),update(1,n,t1,t2,1,t3);\n        else{\n            o=(t2-t1+1)*(t2-t1+2)/2,p=query(1,n,t1,t2,1).w;\n            if(p) q=gcd(o,p),o/=q,p/=q;\n            else o=1;\n            printf(\"%lld/%lld\\n\",p,o);\n        }\n    }\n    return 0;\n}  \n```",
        "postTime": 1566644547,
        "uid": 44180,
        "name": "ljk123",
        "ccfLevel": 0,
        "title": "\u9ad8\u901f\u516c\u8def\u9898\u89e3"
    },
    {
        "content": "## \u9898\u76ee\u5206\u6790\uff1a\n\n\u8fd9\u91cc\u7684\u671f\u671b\u5c31\u662f\u5e73\u5747\u503c\n\n\u6bcf\u6761\u8def\u5c31\u662f\u4e00\u4e2a\u70b9\n\n## \u5148\u5199\u4e2aO(nm)\u7684\u66b4\u529b\uff1a\n\n\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u533a\u95f4\uff0c\u6bcf\u4e00\u4e2a\u70b9\u51fa\u73b0\u7684\u6b21\u6570\u662f\u4ec0\u4e48\uff1f\n\n\u9996\u5148\uff0c\u5bf9\u4e8e\u4efb\u610f\u957f\u5ea6\u76f8\u540c\u7684\u533a\u95f4\uff0c\u5904\u4e8e\u540c\u4e00\u4e2a\u4f4d\u7f6e\u7684\u70b9\uff0c\u51fa\u73b0\u7684\u6b21\u6570\u76f8\u540c\n\n\u90a3\u4e48\u6bcf\u4e00\u4e2a\u70b9\u51fa\u73b0\u7684\u6b21\u6570\u662f\uff1f\n\n\u6253\u4e2a\u8868     \n\n|  \u6a2a\u5411\u4e3a\u533a\u95f4\u957f\u5ea6\uff0c\u7eb5\u5411\u4e3a\u6240\u5728\u533a\u95f4\u4f4d\u7f6e\uff08\u5c31\u662f\u533a\u95f4\u91cc\u7684\u7b2c\u51e0\u4e2a\u6570\uff09|  1|  2|  3|  4|  5|  6|\n| -----------: | -----------: | -----------: | -----------: | -----------: | -----------: | -----------: |\n|  1|  1|  |  |  |  |  |\n|  2|  2|  2|  |  |  |  |\n|  3|  3|  4|  3|  |  |  |\n|  4|  4|  6|  6|  4|  |  |\n|  5|  5|  8|  9|  8|  5|  |\n|  6|  6|  10|  12|  12|  10|  6|\n\n\u5f97\u5230\u5f0f\u5b50\uff1a$map[L][R]=L*(R-L+1)$,\u5176\u4e2d$R=r-l,L=i-l,l<=i<r$\n                                              \n\u4ee3\u7801\uff1a\n                                              \n```cpp\n#include<bits/stdc++.h>\n#include<iostream>\n#include<cstdio>\n#define ll long long\nusing namespace std;\n\nll n,m,a[100010];\n\ninline ll read(){\n    ll x=0,tmp=1;\n    char ch=getchar();\n    while(!isdigit(ch)){\n        if(ch=='-') tmp=-1;\n        ch=getchar();\n    }\n    while(isdigit(ch)){\n        x=(x<<3)+(x<<1)+ch-48;\n        ch=getchar();\n    }\n    return tmp*x;\n}\n\ninline void write(ll x){\n    if(x<0){\n        putchar('-');\n        x=-x;\n    }\n    ll y=10,len=1;\n    while(y<=x){\n        y=(y<<3)+(y<<1);\n        len++;\n    }\n    while(len--){\n        y/=10;\n        putchar(x/y+48);\n        x%=y;\n    }\n}\n\nll gcd(ll x,ll y){\n    return x%y==0?y:gcd(y,x%y);\n}\n\nint main(){\n    n=read(); m=read();\n    while(m--){\n        string op;\n        cin>>op;\n        if(op==\"C\"){\n            ll l=read(),r=read(),v=read();\n            for(ll i=l; i<r; i++) a[i]+=v;\n        }\n        if(op==\"Q\"){\n            ll l=read(),r=read(),ans=0,div=(r-l)*(r-l+1)/2;\n            for(ll i=l; i<r; i++){\n                ll L=i-l+1,R=r-l;\n                ans+=a[i]*L*(R-L+1);\n            }\n            ll gd=gcd(ans,div);\n            write(ans/gd); putchar('/');\n            write(div/gd); putchar('\\n');\n        }\n    }\n    return 0;\n}\n```\n                                             \n## \u8fd9\u6837\u53ef\u4ee5\u5f97\u523040\u5206\uff0c100\u5206\u7684\u505a\u6cd5\u662f\u4ec0\u4e48\uff1f\n\n\u8fd9\u4e00\u90e8\u5206\u6709\u53c2\u8003 https://www.cnblogs.com/a1b3c7d9/p/10850039.html\n\n\u6211\u4eec\u770b\u9898\u76ee\u8981\u6211\u4eec\u505a\u4ec0\u4e48\uff1a\n\n1.\u533a\u95f4\u4fee\u6539\n\n2.\u533a\u95f4\u67e5\u8be2\n\n\u4e0d\u7528\u60f3\u4e86\uff0c\u7ebf\u6bb5\u6811\n\n\u9996\u5148\uff0c\u539f\u6765\u7684\u6c42\u6cd5\u662f$\\frac{\\sum_{i=l}^{r} \\sum_{j=l}^{r} {d[i,j]}} {(r-l+1)(r-l)/2}$\n\n\u8f6c\u6362\u540e\u5f97\u5230$\\sum_{i=l}^{r}{a[i](r-i+1)(i-l+1)}$\n\n\u5176\u4e2d${l<=i<=r}$\n\n\u5373$(r-i+1-lr)sum[1]+(l+r)sum[2]-sum[3]$\n\n\u5176\u4e2d${sum[x]=\\sum_{i=l}^{r} {a[i]}*i^{x-1}}$\n\n\u90a3\u4e48\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u533a\u95f4\uff0c\u6211\u4eec\u8981\u7ef4\u62a4\u7684\u4e1c\u897f\u6709\uff1a\n\nl,r,lazymark\uff08\u5e38\u89c4\uff09\n\n$sum[1-3]$\n\n$\\sum_{i=l}^{r} {a[i]}*i^{x}$ \uff0c\u5176\u4e2dx=2\u62163",
        "postTime": 1558076491,
        "uid": 27924,
        "name": "xukuan",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P2221 \u3010[HAOI2012]\u9ad8\u901f\u516c\u8def\u3011"
    },
    {
        "content": "\u5bf9\u4e8e\u7ed9\u5b9a\u533a\u95f4[l,r]\uff0c\u8003\u8651\u8ba1\u7b97\u5b83\u7684\u671f\u671b\u8d39\u7528\uff0c\u5c31\u662f \u603b\u7684\u8d39\u7528/\u603b\u7684\u60c5\u51b5\u6570\n\n\u603b\u7684\u60c5\u51b5\u6570\u5f88\u597d\u786e\u5b9a\uff0c\u6211\u9009\u62e9\u89c4\u5b9a\u53ef\u4ee5\u7b2c\u4e00\u6b21\u9009\u7684\u6bd4\u7b2c\u4e8c\u6b21\u5927\uff0c\u6240\u4ee5\u8ba1\u7b97\u603b\u8d21\u732e\u540e\u8981\u4e582\u3002\n\n\u7136\u540e\u8003\u8651\u8ba1\u7b97\u603b\u7684\u8d39\u7528\u3002\n\n\u8003\u8651\u4e00\u4e2a\u70b9i\uff0c$i\\in [l,r]$\uff0c\u90a3\u4e48\u4ed6\u80fd\u4ea7\u751f\u7684\u8d21\u732e\u5c31\u662f\u5305\u542b\u8be5\u70b9\u7684\u533a\u95f4\u6570*\u8be5\u70b9\u8d39\u7528\uff0c\u603b\u7684\u8d39\u7528\u516c\u5f0f\u5c31\u662f\u4e0b\u9762\u8fd9\u4e2a\u5f0f\u5b50\uff1a\n\n$\\Sigma^{r}_{i=l}v_{i}*(r-i)*(i-l+1)$\uff0c\u7136\u540e\u628a\u62ec\u53f7\u6253\u5f00\uff0c\u5f97\u5230$\\Sigma^{r}_{i=l}v_{i}*(r*i-r*l+r-i*i+i*l-i)$\n\n\u6574\u7406\u4e00\u4e0b\uff1a\n$\\Sigma^{r}_{i=l}v_{i}*r*(1-l)+v_{i}*(r+l-1)*i-v_{i}*i*i$\n\n\n\u6240\u4ee5\u5f88\u660e\u663e\u4e86\uff0c\u7ebf\u6bb5\u6811\u7ef4\u62a4$v_{i},v_{i}*i,v_{i}*i^{2}$\u3002\n\n\u7136\u540e\u8003\u8651\u7ebf\u6bb5\u6811\u7684push_up\u548cpush_down\uff0c\u56e0\u4e3a\u6bcf\u4e00\u6b21\u4fee\u6539\u5982\u679c\u90fd\u4fee\u6539\u5230\u53f6\u5b50\u8282\u70b9\u7684\u8bdd\u65f6\u95f4\u590d\u6742\u5ea6\u592a\u9ad8\uff0c\u6240\u4ee5\u6bcf\u4e2a\u7ebf\u6bb5\u6811\u9664\u4e86\u8bb0\u5f55\u4e0a\u8ff03\u4e2a\u7684\u548c\uff0c\u7531\u4e8e\u6bcf\u6b21\u4fee\u6539\u7684\u662f$v_{i}$\uff0c\u6240\u4ee5\u8bb0\u5f55$i$\u548c$i\\times i$\u7684\u503c\uff0c\u6bcf\u6b21push_down\u7684\u65f6\u5019\u5de6\u533a\u95f4\u52a0\u4e0a\uff08\u5de6\u533a\u95f4\u76841\u6216$i$\u6216$i\\times i$\uff09 $\\times$ \u4fee\u6539\u503c\u5373\u53ef\u3002\n\n\u4ee3\u7801\u89c1\u4e0b\uff1a\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\ntypedef long long LL;\nconst LL MAXN=1e5+10;\n\nLL n,q;\nLL a[MAXN];\nstruct Tree{\n\tLL add;\n\tLL l,r,pre1,pre2;//pre1\u4e3ai\u7684\u548c\uff0cpre2\u4e3ai*i\u7684\u548c\n\tLL sum1,sum2,sum3;\n}tr[MAXN<<2];\nstruct data{\n\tLL ans1,ans2,ans3;\n\tdata(LL x=0,LL y=0,LL z=0){\n\t\tans1=x,ans2=y,ans3=z;\n\t}\n\tfriend inline data operator+(const data &a,const data &b){\n\t\treturn data(a.ans1+b.ans1,a.ans2+b.ans2,a.ans3+b.ans3);\n\t}\n\tvoid init(){\n\t\tans1=ans2=ans3=0;\n\t}\n}ans;//\u8bb0\u5f55\u4e09\u4e2a\u7b54\u6848\n\nLL Read(){\n\tLL i=0,f=1;\n\tchar c;\n\tfor(c=getchar();(c>'9'||c<'0')&&c!='-';c=getchar());\n\tif(c=='-')\n\t  f=-1,c=getchar();\n\tfor(;c>='0'&&c<='9';c=getchar())\n\t  i=(i<<3)+(i<<1)+c-'0';\n\treturn i*f;\n}\n\nvoid push_up(LL root){\n\ttr[root].sum1=tr[root<<1].sum1+tr[root<<1|1].sum1;\n\ttr[root].sum2=tr[root<<1].sum2+tr[root<<1|1].sum2;\n\ttr[root].sum3=tr[root<<1].sum3+tr[root<<1|1].sum3;\n}\n\nvoid push_now(LL root,LL v){\n\ttr[root].add+=v;\n\ttr[root].sum1+=v*(tr[root].r-tr[root].l+1);\n\ttr[root].sum2+=v*tr[root].pre1;\n\ttr[root].sum3+=v*tr[root].pre2;\n}\n\nvoid push_down(LL root){\n\tif(tr[root].add!=0){//\u6709\u53ef\u80fd\u4e3a\u8d1f\u6570\u6240\u4ee5\u5224\u975e0\n\t\tpush_now(root<<1,tr[root].add);\n\t\tpush_now(root<<1|1,tr[root].add);\n\t\ttr[root].add=0;\n\t}\n}\n\nvoid build(LL root,LL l,LL r){\n\ttr[root].l=l,tr[root].r=r;\n\tif(l==r){\n\t\ttr[root].pre1=l;\n\t\ttr[root].pre2=l*l;\n\t\treturn ;\n\t}\n\tLL mid=l+r>>1;\n\tbuild(root<<1,l,mid);\n\tbuild(root<<1|1,mid+1,r);\n\tpush_up(root);\n\ttr[root].pre1=tr[root<<1].pre1+tr[root<<1|1].pre1;\n\ttr[root].pre2=tr[root<<1].pre2+tr[root<<1|1].pre2;\n}\n\nvoid update(LL root,LL l,LL r,LL L,LL R,LL key){\n\tif(l>R||r<L)\n\t  return ;\n\tif(L<=l&&r<=R){\n\t\tpush_now(root,key);\n\t\treturn ;\n\t}\n\tpush_down(root);\n\tLL mid=l+r>>1;\n\tif(R<=mid)\n\t  update(root<<1,l,mid,L,R,key);\n\telse{\n\t\tif(L>mid)\n\t\t  update(root<<1|1,mid+1,r,L,R,key);\n\t\telse\n\t\t  update(root<<1,l,mid,L,mid,key),update(root<<1|1,mid+1,r,mid+1,R,key);\n\t}\n\tpush_up(root);\n}\n\nvoid query(LL root,LL l,LL r,LL L,LL R){\n\tif(l>R||r<L)\n\t  return ;\n\tif(L<=l&&r<=R){\n\t\tans=ans+data(tr[root].sum1,tr[root].sum2,tr[root].sum3);\n\t\treturn ;\n\t}\n\tpush_down(root);\n\tdata a;\n\tLL mid=l+r>>1;\n\tif(R<=mid){\n\t\tquery(root<<1,l,mid,L,R);\n\t\treturn ;\n\t}\n\telse{\n\t\tif(L>mid){\n\t\t  \tquery(root<<1|1,mid+1,r,L,R);\n\t\t  \treturn ;\n\t\t}\n\t\telse{\n\t\t    query(root<<1,l,mid,L,mid),query(root<<1|1,mid+1,r,mid+1,R);\n\t\t    return ;\n\t\t}\n\t}\n}\n\nLL gcd(LL x,LL y){\n\treturn x%y?gcd(y,x%y):y;\n}\n\nint main(){\n\tn=Read(),q=Read();\n\tbuild(1,1,n-1);\n\twhile(q--){\n\t\tchar cz[5];\n\t\tLL l,r;\n\t\tscanf(\"%s\",cz);\n\t\tl=Read(),r=Read();\n\t\tif(cz[0]=='C'){\n\t\t\tLL key=Read();\n\t\t\tupdate(1,1,n-1,l,r-1,key);\n\t\t}\n\t\telse{\n\t\t\tans.init();\n\t\t\tquery(1,1,n-1,l,r-1);\n\t\t\tLL fz=2*(-r*(l-1)*ans.ans1+(r+l-1)*ans.ans2-ans.ans3);//\u8ba1\u7b97\u7b54\u6848\n\t\t\tLL fm=(r-l+1)*(r-l);\n\t\t\tLL gc=gcd(fz,fm);\n\t\t\tcout<<fz/gc<<'/'<<fm/gc<<'\\n';//\u5316\u7b80\n\t\t}\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1544000763,
        "uid": 31639,
        "name": "Thosaka_Forest",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P2221 \u3010[HAOI2012]\u9ad8\u901f\u516c\u8def\u3011"
    }
]