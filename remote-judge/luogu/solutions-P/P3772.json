[
    {
        "content": "**\u524d\u7f6e\u77e5\u8bc6\uff1a\u8d1d\u53f6\u65af\u516c\u5f0f**\n\n\u8bbe $A,B$ \u662f\u4e24\u4e2a\u968f\u673a\u4e8b\u4ef6\u3002\u5b9a\u4e49 $P(A|B)$ \u4e3a\u5728 $B$ \u4e8b\u4ef6\u53d1\u751f\u7684\u60c5\u51b5\u4e0b $A$ \u53d1\u751f\u7684\u6982\u7387\u3002\u663e\u7136\u6709\n\n$P(A|B)=\\dfrac{P(AB)}{P(B)}$\n\n\u540c\u6837\n\n$P(B|A)=\\dfrac{P(AB)}{P(A)}$\n\n\u5219\n\n$P(A|B)=\\dfrac{P(B|A)\\times P(A)}{P(B)}$\n\n----------\n\n\u6839\u636e\u671f\u671b\u7684\u7ebf\u6027\u6027\uff0c\u6211\u4eec\u53ef\u4ee5\u5355\u72ec\u8ba1\u7b97\u6bcf\u4e2a\u672a\u77e5\u7684\u5c40\u9762\u7684\u83b7\u80dc\u6982\u7387\u3002\u8bbe $x$ \u662f\u4e00\u4e2a\u672a\u77e5\u5c40\u9762\uff0c\u663e\u7136 $x$ \u83b7\u80dc\u7684\u6982\u7387\u53ea\u4e0e $x$ \u5de6\u8fb9\u7684\u7b2c\u4e00\u4e2a\u5df2\u77e5\u5c40\u9762 $l$ \u548c\u53f3\u8fb9\u7684\u7b2c\u4e00\u4e2a\u5df2\u77e5\u5c40\u9762 $r$ \u6709\u5173\u3002\u8bb0\u4e8b\u4ef6 $X$ \u4e3a\u5c0f P \u5728\u7b2c $x$ \u5c40\u4e2d\u83b7\u80dc\uff0c\u4e8b\u4ef6 $L,R$ \u4e3a\u7b2c $l,r$ \u83b7\u80dc\u8005\u548c\u5df2\u77e5\u76f8\u7b26\u3002\u5219\u6b32\u6c42\u4e3a\n\n$P(X|L,R)=\\dfrac{P(L,R|X)\\times P(X)}{P(L,R)}$\n\n$=\\dfrac{P(L|X)P(R|X)P(X)}{P(L,R)}$\n\n$=\\dfrac{P(L|X)P(R|X)P(X)}{P(R|L)P(L)}$\n\n$=\\dfrac{P(X|L)P(R|X)}{P(R|L)}$\n\n\u6b64\u65f6\u5206\u6bcd\u662f\u4e00\u4e2a\u5b9a\u503c\uff0c\u5728\u6c42\u548c\u7684\u65f6\u5019\u53ef\u4ee5\u63d0\u51fa\u7ef4\u62a4\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c\n\n$\\sum_{l < x <r}\\dfrac{P(X|L)P(R|X)}{P(R|L)}=\\dfrac{\\sum_{l < x <r}P(X|L)P(R|X)}{P(R|L)}$\n\n\u5206\u6bcd\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u77e9\u9635\u4e58\u6cd5\u9884\u5904\u7406\u51fa\u2014\u2014\u5bf9\u4e8e\u6bcf\u4e2a\u70b9\u7ef4\u62a4\u4e00\u4e2a $2\\times 2$ \u77e9\u9635 $F_i$\uff0c$F(0,0)=1-q_i,F(0,1)=q_i,F(1,0)=1-p_i,F(1,1)=p_i$\u3002\u5bb9\u6613\u9a8c\u8bc1 \u8fd9\u6837\u4e58\u8d77\u6765\u7b26\u5408\u7ec4\u5408\u610f\u4e49\u3002\n\n\u81f3\u4e8e\u5206\u5b50\uff0c$P(X|L)P(R|X)$ \u53ef\u4ee5\u7406\u89e3\u4e3a\u4ece $l$ \u5230 $r$ \u8fdb\u884c\u77e9\u9635\u4e58\u6cd5\u65f6\uff0c\u5728 $x$ \u5904\u53ea\u4e58 $F_x$ \u4e2d\u7b2c\u4e8c\u7ef4\u4e3a $1$ \u7684\u5143\u7d20\u3002\u6362\u8a00\u4e4b\u6784\u9020\u53e6\u4e00\u4e2a\u77e9\u9635 $G_x$\uff0c$G(0,0)=G(1,0)=0$\uff0c\u8981\u6c42\u5219\u53d8\u6210 $\\sum_{x=l}^rF_l\\times F_{l+1}\\times \\cdots\\times F_{x-1}\\times G_x\\times \\cdots\\times F_r$\u3002\u8fd9\u4e2a\u4e5f\u53ef\u4ee5\u5728\u7ebf\u6bb5\u6811\u4e0a\u7ef4\u62a4\uff0c\u6bcf\u6b21\u7ef4\u62a4\u4e00\u4e2a\u533a\u95f4\u7684 $G$ \u77e9\u9635\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u8282\u70b9 $k$\uff0c\u6709\n\n$G_k=G_{l(k)}\\times F_{r(k)}+F_{l(k)}\\times F_{r(k)}$\n\n\uff08$l(k),r(k)$ \u5206\u522b\u4ee3\u8868 $k$ \u7684\u5de6\u53f3\u5b50\u8282\u70b9\uff09\n\n\u8fd9\u6837\u5c31\u5927\u81f4\u89e3\u51b3\u4e86\u8fd9\u9053\u9898\u3002\u5173\u4e8e\u5b9e\u73b0\u7ec6\u8282\uff0c\u53ef\u4ee5\u5f00\u4e00\u4e2a set \u7ef4\u62a4\u6240\u6709\u5df2\u77e5\u7684\u4f4d\u7f6e\u3002\n\n\u4ee3\u7801\uff1a\n```cpp\n#include<cstdio>\n#include<set>\n\nusing namespace std;\n\ndouble p[300000],q[300000];\n\nstruct mat\n{\n\tint r,c;double val[2][2];\n\tdouble* operator[](int x){return val[x];}\n\tconst double* operator[](int x)const{return val[x];}\n\tmat(int rr=2,int cc=2):r(rr),c(cc){for(int i=0;i<2;i++)for(int j=0;j<2;j++)val[i][j]=0;} \n};\nmat operator+(mat a,mat b){for(int i=0;i<a.r;i++)for(int j=0;j<a.c;j++)a[i][j]+=b[i][j];return a;}\nmat operator*(mat a,mat b)\n{\n\tmat c(a.r,b.c);\n\tfor(int i=0;i<a.r;i++)\n\t{\n\t\tfor(int j=0;j<b.c;j++)\n\t\t{\n\t\t\tfor(int k=0;k<a.c;k++)\n\t\t\t{\n\t\t\t\tc[i][j]+=a[i][k]*b[k][j];\n\t\t\t}\n\t\t}\n\t}\n\treturn c; \n}\n\nstruct dat\n{\n\tmat sum,pri;\n};\ndat operator*(const dat& a,const dat& b)\n{\n\tdat c;c.pri=a.pri*b.pri,c.sum=a.sum*b.pri+a.pri*b.sum;return c;\n}\nstruct SegmentTree\n{\n\tstruct nd\n\t{\n\t\tint l,r;dat x;\n\t}t[800000];\n\tvoid build(int l,int r,int k=1)\n\t{\n\t\tt[k].l=l,t[k].r=r;\n\t\tif(l==r)\n\t\t{\n\t\t\tt[k].x.pri[1][1]=p[l],t[k].x.pri[1][0]=1-p[l],\n\t\t\tt[k].x.pri[0][1]=q[l],t[k].x.pri[0][0]=1-q[l];\n\t\t\tt[k].x.sum[1][1]=p[l],t[k].x.sum[0][1]=q[l];\n\t\t\treturn;\n\t\t}\n\t\tint mid=(l+r)>>1;build(l,mid,k<<1),build(mid+1,r,k<<1|1);\n\t\tt[k].x=t[k<<1].x*t[k<<1|1].x;\n\t}\n\tdat query(int l,int r,int k=1)\n\t{\n\t\tif(l<=t[k].l&&t[k].r<=r)return t[k].x;\n\t\tint mid=(t[k].l+t[k].r)>>1;\n\t\tif(r<=mid)return query(l,r,k<<1);\n\t\tif(l>mid)return query(l,r,k<<1|1);\n\t\treturn query(l,r,k<<1)*query(l,r,k<<1|1);\n\t}\n\tvoid output(int k)\n\t{\n\t\tprintf(\"%d: %d %d\\n\",k,t[k].l,t[k].r);\n\t\tfor(int i=0;i<2;i++)for(int j=0;j<2;j++)printf(\"%.2lf \",t[k].x.pri[i][j]);puts(\"\");\n\t\tif(t[k].l==t[k].r)return;output(k<<1);output(k<<1|1);\n\t}\n}T;\n\nint a[300000];\n\ndouble calc(int l,int r)\n{\n\tdat x=T.query(l+1,r);return x.sum[a[l]][a[r]]/x.pri[a[l]][a[r]];\n}\n\nset<int> st;char op[10];\n\nint main()\n{\n\t//mat A,B;A[0][0]=1,A[1][1]=2,B[1][0]=B[1][1]=1;A=A*B;for(int i=0;i<2;i++)for(int j=0;j<2;j++)printf(\"%lf \",A[i][j]);puts(\"\");\n\tint n=0,m=0;scanf(\"%d%d%*s\",&n,&m);\n\tscanf(\"%lf\",&p[1]);for(int i=2;i<=n;i++)scanf(\"%lf%lf\",&p[i],&q[i]);\n\tp[0]=1,q[0]=1;a[0]=1,a[n+1]=0;st.insert(0),st.insert(n+1);\n\tT.build(0,n+1);//T.output(1);\n\tdouble ans=calc(0,n+1);//printf(\"%lf\\n\",ans);\n\twhile(m--)\n\t{\n\t\tscanf(\"%s\",op);\n\t\tif(op[0]=='a')\n\t\t{\n\t\t\tint pos=0;scanf(\"%d\",&pos);scanf(\"%d\",&a[pos]);\n\t\t\tset<int>::iterator it=st.lower_bound(pos);int r=*it;it--;int l=*it;\n\t\t\tans-=calc(l,r);ans+=calc(l,pos),ans+=calc(pos,r);\n\t\t\tst.insert(pos);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tint pos=0;scanf(\"%d\",&pos);st.erase(pos);\n\t\t\tset<int>::iterator it=st.lower_bound(pos);int r=*it;it--;int l=*it;\n\t\t\tans+=calc(l,r);ans-=calc(l,pos),ans-=calc(pos,r);\n\t\t}\n\t\tprintf(\"%.6lf\\n\",ans);\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1597397949,
        "uid": 112794,
        "name": "\u5468\u5b50\u8861",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P3772 \u3010[CTSC2017]\u6e38\u620f\u3011"
    },
    {
        "content": "\u8fd9\u9898\u8fd8\u6709\u4e00\u4e2a\u66f4\u52a0\u6734\u5b9e\u65e0\u534e\u7684\u7ef4\u62a4\u65b9\u6cd5\u3002\n\n\n\n------------\n\n\u5bf9\u4e8e\u6761\u4ef6\u671f\u671b\uff0c\u6211\u4eec\u6709\uff1a\n\n$$E(A|B)=\\dfrac{E(AB)}{P(B)}$$\n\n\uff08\u53ef\u4ee5\u8fd9\u6837\u7406\u89e3\uff1a$E(A|B)P(B)=E(AB)$\uff0c\u5373\u4e8b\u4ef6 $B$ \u53d1\u751f\u7684\u6982\u7387\u4e58\u5728 $B$ \u53d1\u751f\u524d\u63d0\u4e0b\u4e8b\u4ef6 $A$ \u7684\u671f\u671b\u5c31\u662f $A$ \u548c $B$ \u540c\u65f6\u53d1\u751f\u7684\u671f\u671b\u3002\uff09\n\n\n\n------------\n\n\n\u5bf9\u4e8e\u8fd9\u9053\u9898\uff0c\u6211\u4eec\u53d1\u73b0\u6839\u636e\u5df2\u786e\u5b9a\u8f93\u8d62\u7684\u4f4d\u7f6e\u5c06 $n$ \u5c40\u6e38\u620f\u5212\u6210\u82e5\u5e72\u533a\u95f4\uff0c\u8bbe\uff0c\u533a\u95f4 $[l,r]$ \u5185\u7684\u8f93\u8d62\u671f\u671b\u53ea\u548c $l$ \u548c $r$ \u7684\u8f93\u8d62\u60c5\u51b5\u6709\u5173\uff0c\u5176\u5b83\u7684\u4fee\u6539\u5f71\u54cd\u4e0d\u5230\u533a\u95f4 $[l,r]$\u3002\n\n\u90a3\u7ef4\u62a4\u533a\u95f4\u4fe1\u606f\u81ea\u7136\u60f3\u5230\u7ebf\u6bb5\u6811\uff0c\u8bbe $p(l,r,a,b)$ \u4e3a\u4f4d\u7f6e $l$ \u7684\u8f93\u8d62\u60c5\u51b5\u4e3a $a$ \u4e14\u4f4d\u7f6e $r$ \u7684\u8f93\u8d62\u60c5\u51b5\u4e3a $b$ \u7684\u6982\u7387\uff0c$e(l,r,a,b)$ \u4e3a\u5728\u4f4d\u7f6e $l$ \u7684\u8f93\u8d62\u60c5\u51b5\u4e3a $a$ \u4e14\u4f4d\u7f6e $r$ \u7684\u8f93\u8d62\u60c5\u51b5\u4e3a $b$ \u65f6\u533a\u95f4 $[l,r]$ \u8d62\u7684\u5c40\u6570\u7684\u671f\u671b\uff0c$tp[x][a][b]$ \u8868\u793a\u5728\u524d\u4e00\u4e2a\u4f4d\u7f6e\u7684\u8f93\u8d62\u60c5\u51b5\u4e3a $a$ \u65f6\u4f4d\u7f6e $x$ \u8f93\u8d62\u60c5\u51b5\u4e3a $b$ \u7684\u6982\u7387\uff08$tp$ \u53ef\u4ee5\u5728\u4e00\u5f00\u59cb\u6839\u636e $p_i$ \u548c $q_i$ \u9884\u5904\u7406\uff09\u3002\n\n\u4e0b\u9762\u6211\u4eec\u5c1d\u8bd5\u4ece $[l,mid]$ \u548c $[mid+1,r]$ \u8f6c\u79fb\u5230 $[l,r]$\u3002\n\n\u5bf9\u4e8e $p$ \uff0c\u6211\u4eec\u679a\u4e3e $mid$ \u548c $mid+1$ \u7684\u8f93\u8d62\u60c5\u51b5\uff1a\n\n$$p(l,r,a,b)=\\sum_{0\\leq c,d\\leq 1}p(l,mid,a,c)\\times tp(mid+1,c,d)\\times p(mid+1,r,d,b)$$\n\n\u5bf9\u4e8e $e$\uff0c\u6839\u636e\u4e0a\u9762\u6761\u4ef6\u671f\u671b\u7684\u516c\u5f0f\uff0c\u8bb0\u201c\u8d62\u201d\u4e3a\u4e8b\u4ef6 $A$\uff0c\u201c\u4f4d\u7f6e $l$ \u7684\u8f93\u8d62\u60c5\u51b5\u4e3a $a$ \u4e14\u4f4d\u7f6e $r$ \u7684\u8f93\u8d62\u60c5\u51b5\u4e3a $b$\u201d\u4e3a\u4e8b\u4ef6 $B$\uff0c\u5219\u6709\uff1a\n\n$$e(l,r,a,b)=\\dfrac{\\sum_{0\\leq c,d\\leq 1}p(l,mid,a,c)\\times tp(mid+1,c,d)\\times p(mid+1,r,d,b)\\times(e(l,mid,a,c)+e(mid+1,r,d,b))}{p(l,r,a,b)}$$\n\n\u4e8e\u662f\u5c31\u53ef\u4ee5\u5728\u5e38\u6570\u65f6\u95f4\u5185\u8f6c\u79fb\u3002\n\n\u7136\u540e\u6bcf\u6b21\u7528 `std::set` \u7ef4\u62a4\u5df2\u786e\u5b9a\u7684\u4f4d\u7f6e\uff0c\u63d2\u5165\u548c\u5220\u9664\u65f6\u52a0\u52a0\u51cf\u51cf\u5373\u53ef\u3002\uff08\u6709\u4e2a\u7ec6\u8282\uff0c\u5f53\u94a6\u5b9a\u4f4d\u7f6e $i$ \u8d62\u7684\u65f6\u5019\uff0c\u6211\u4eec\u4ee4 $ans\\gets ans+e(pre,i,c_{pre},c_i)+e(i,nex,c_i,c_{nex})-e(pre,nex,c_pre,c_nex)$ \u65f6\u5c06\u4f4d\u7f6e $i$ \u7684\u671f\u671b\u8ba1\u7b97\u4e86\u4e24\u6b21\uff0c\u5e94\u51cf\u53bb $1$\uff1b\u5220\u9664\u7684\u65f6\u5019\u540c\u7406\uff09\n\n\u7ebf\u6bb5\u6811\u90e8\u5206\u4ee3\u7801\uff08\u5b8c\u6574\u4ee3\u7801\u53bb\u63d0\u4ea4\u8bb0\u5f55\u627e\uff09\uff1a\n\n```cpp\ndouble p[200005],q[200005],tp[200005][2][2];\nstruct node{\n\tdouble p[2][2],e[2][2];\n\tint l,r;\n}t[200005<<2];\ninline void merge(node& cx,node cl,node cr){\n\tcx.l=cl.l,cx.r=cr.r;\n\tcx.p[0][0]=cx.p[0][1]=cx.p[1][0]=cx.p[1][1]=cx.e[0][0]=cx.e[0][1]=cx.e[1][0]=cx.e[1][1]=0;\n\tfor(rg int a=0;a<2;++a) for(rg int b=0;b<2;++b){\n\t\tfor(rg int c=0;c<2;++c) for(rg int d=0;d<2;++d) cx.p[a][b]+=cl.p[a][c]*cr.p[d][b]*tp[cr.l][c][d];\n\t\tfor(rg int c=0;c<2;++c) for(rg int d=0;d<2;++d) cx.e[a][b]+=cl.p[a][c]*cr.p[d][b]*tp[cr.l][c][d]*(cl.e[a][c]+cr.e[d][b]);\n        if(fabs(cx.p[a][b])<1e-6) cx.e[a][b]=0;\n\t\telse cx.e[a][b]/=cx.p[a][b];\n\t}\n}\nvoid build(int x,int l,int r){\n\tt[x].l=l,t[x].r=r;\n\tif(l==r) return t[x].p[0][0]=1,t[x].p[1][1]=1,t[x].e[0][0]=1.0,void();\n\tconst int mid=l+r>>1;\n\tbuild(x<<1,l,mid),build(x<<1|1,mid+1,r);\n\tmerge(t[x],t[x<<1],t[x<<1|1]);\n}\nnode query(int x,const int sl,const int sr){\n\tif(sl<=t[x].l&&sr>=t[x].r) return t[x];\n\tconst int mid=t[x].l+t[x].r>>1;\n\tif(sl>mid) return query(x<<1|1,sl,sr);\n\tif(sr<=mid) return query(x<<1,sl,sr);\n\tnode ret; merge(ret,query(x<<1,sl,sr),query(x<<1|1,sl,sr)); return ret;\n}\n```\n",
        "postTime": 1644380712,
        "uid": 241977,
        "name": "Legitimity",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P3772"
    },
    {
        "content": "\u4e0d\u77e5\u9053\u5927\u5bb6\u90fd\u5728\u63a8\u5565\uff0c\u800c\u4e14\u4e3a\u5565\u8fd8\u90fd\u7528\u4e86\u4e2a `set` \u7ef4\u62a4\uff0c\u8fd9\u91cc\u662f\u7528\u5e38\u6570\u6362\u8111\u5b50\u7684\u505a\u6cd5\u3002\n\n\u8bb0\u5c0f R \u83b7\u80dc\u5c40\u6570\u4e3a $c$\uff0c\u9700\u8981\u6ee1\u8db3\u7684\u9650\u5236\u4e3a $Q$\uff0c\u5219\u6211\u4eec\u8981\u6c42\u7684\u662f\uff1a\n$$\\begin{aligned}E(c\\mid Q)=&\\sum_iiP(c=i\\mid Q)\\\\=&\\frac{\\sum\\limits_iiP(c=i\\land Q)}{P(Q)}\\\\=&\\frac{E([Q]c)}{P(Q)}\\end{aligned}$$\n\n\u7136\u540e\u53d1\u73b0\u63d0\u793a\u91cc\u9762\u63d0\u5230\u4e86\u77e9\u9635\uff01\u6211\u4eec\u76f4\u63a5\u8003\u8651\u641e\u4e00\u4e2a\u77e9\u9635\u53ef\u4ee5\u7ef4\u62a4\u7684\u4e1c\u897f\u3002\u5bf9\u4e8e\u4e00\u4e2a\u524d\u7f00\uff0c\u8bb0 $R$ \u4e3a\u4e0a\u4e00\u5c40\u662f\u5c0f R \u8d62\uff0c$B$ \u4e3a\u4e0a\u4e00\u5c40\u662f\u5c0f B \u8d62\uff0c\u90a3\u4e48\u6211\u4eec\u7ef4\u62a4\uff1a\n$$\\begin{bmatrix}P(R\\land Q)&P(B\\land Q)&E([R\\land Q]c)&E([B\\land Q]c)\\end{bmatrix}$$\n\u5982\u679c\u7b2c $i$ \u4f4d\u6ca1\u6709\u9650\u5236\uff0c\u90a3\u4e48\u4ece $i-1$ \u8f6c\u79fb\u5230 $i$ \u5c31\u662f\u53f3\u4e58\u4e0a\u8fd9\u4e2a\u4e1c\u897f\uff1a\n$$\\begin{bmatrix}p_i&1-p_i&p_i&0\\\\q_i&1-q_i&q_i&0\\\\0&0&p_i&1-p_i\\\\0&0&q_i&1-q_i\\end{bmatrix}$$\n\u7b2c $i$ \u4f4d\u6709\u9650\u5236\u7684\u8bdd\u5f62\u5f0f\u4e5f\u5f88\u53cb\u597d\uff0c\u5c31\u662f\u628a\u8fd9\u4e2a\u77e9\u9635\u91cc\u7684\u67d0\u4e24\u5217\u53d8\u6210 $0$\u3002\n\n\u6700\u540e\u7684\u7b54\u6848\u5c31\u662f\n$$\\frac{E([R\\land Q]c)+E([B\\land Q]c)}{P(R\\land Q)+P(B\\land Q)}$$\n\u76f4\u63a5\u7ebf\u6bb5\u6811\u7ef4\u62a4\u5c31\u505a\u5b8c\u4e86\u3002\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log n)$\uff0c\u5e26\u4e2a\u53ef\u80fd $4^3$ \u7684\u5927\u5e38\u6570\u3002\n\n~~\u63d0\u4ea4\u540e\u8dd1\u5230\u4e86\u6700\u4f18\u89e3\u6700\u540e\u4e00\u540d\u3002~~\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nusing ll=long long;\ninline ll read(){\n\tll x=0;\n\tbool f=0;\n\tchar c=getchar();\n\twhile(!isdigit(c)){\n\t\tif(c=='-') f=1;\n\t\tc=getchar();\n\t}\n\twhile(isdigit(c)){\n\t\tx=x*10+c-'0';\n\t\tc=getchar();\n\t}\n\treturn f?-x:x;\n}\nconst int maxn=2e5+5;\nint n,m;\nusing ld=long double;\nld p[maxn],q[maxn];\nstruct matrix{\n\tld a[4][4];\n\tmatrix operator *(matrix B){\n\t\tmatrix C;\n\t\tfor(int i=0;i<4;i++) for(int j=0;j<4;j++){\n\t\t\tC.a[i][j]=0;\n\t\t\tfor(int k=0;k<4;k++) C.a[i][j]+=a[i][k]*B.a[k][j];\n\t\t}\n\t\treturn C;\n\t}\n};\nmatrix get(int x){\n\tmatrix A;\n\tA.a[0][0]=A.a[0][2]=A.a[2][2]=p[x];\n\tA.a[0][1]=A.a[2][3]=1-p[x];\n\tA.a[0][3]=A.a[1][3]=A.a[2][0]=A.a[2][1]=A.a[3][0]=A.a[3][1]=0;\n\tA.a[1][0]=A.a[1][2]=A.a[3][2]=q[x];\n\tA.a[1][1]=A.a[3][3]=1-q[x];\n\treturn A;\n}\nstruct node{\n\tint l,r;\n\tnode* ch[2];\n\tmatrix P;\n\tvoid pushup(){\n\t\tP=ch[0]->P*ch[1]->P;\n\t}\n\tnode(int l,int r):l(l),r(r){\n\t\tif(l==r){\n\t\t\tP=get(r);\n\t\t\treturn;\n\t\t}\n\t\tint mid=l+(r-l)/2;\n\t\tch[0]=new node(l,mid);\n\t\tch[1]=new node(mid+1,r);\n\t\tpushup();\n\t}\n\tvoid modify(int x,matrix A){\n\t\tif(l==r){\n\t\t\tP=A;\n\t\t\treturn;\n\t\t}\n\t\tif(x<=ch[0]->r) ch[0]->modify(x,A);\n\t\telse ch[1]->modify(x,A);\n\t\tpushup();\n\t}\n}*rt;\nint main(){\n#ifdef LOCAL\n\tfreopen(\"in.txt\",\"r\",stdin);\n\tfreopen(\"out.txt\",\"w\",stdout);\n#endif\n\tn=read();\n\tm=read();\n\tscanf(\"%*s%Lf\",&p[1]);\n\tfor(int i=2;i<=n;i++) scanf(\"%Lf%Lf\",&p[i],&q[i]);\n\trt=new node(1,n);\n\twhile(m--){\n\t\tchar opt[5];\n\t\tscanf(\"%s\",opt);\n\t\tif(opt[0]=='a'){\n\t\t\tint x=read();\n\t\t\tbool c=read();\n\t\t\tmatrix A=get(x);\n\t\t\tif(c) A.a[0][1]=A.a[1][1]=A.a[2][3]=A.a[3][3]=0;\n\t\t\telse A.a[0][0]=A.a[0][2]=A.a[1][0]=A.a[1][2]=A.a[2][2]=A.a[3][2]=0;\n\t\t\trt->modify(x,A);\n\t\t}\n\t\telse{\n\t\t\tint x=read();\n\t\t\trt->modify(x,get(x));\n\t\t}\n\t\tprintf(\"%.6Lf\\n\",(rt->P.a[0][2]+rt->P.a[0][3])/(rt->P.a[0][0]+rt->P.a[0][1]));\n\t}\n#ifdef LOCAL\n\tfprintf(stderr,\"%f\\n\",1.0*clock()/CLOCKS_PER_SEC);\n#endif\n\treturn 0;\n}\n```",
        "postTime": 1664248890,
        "uid": 174045,
        "name": "FZzzz",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3772 [CTSC2017]\u6e38\u620f"
    },
    {
        "content": "# \u524d\u8a00\n\u672c\u9898\u89e3\u6765\u81ea\uff1aStargazer_cykoi\n\n# \u76f4\u63a5\u4e0a\u601d\u8def\n\u9996\u5148\u663e\u7136\u8003\u8651\u6bcf\u4e2a\u4f4d\u7f6e\u8d62\u7684\u6982\u7387~~\u662f\u4eba\u90fd\u77e5\u9053\u5427~~\uff0c\u4f46\u662f\u6700\u91cd\u8981\u7684\u95ee\u9898\u5728\u4e8e\u4e00\u4e2a\u4f4d\u7f6e\u8f93\u8d62\u7684\u6982\u7387\u4e0d\u53ea\u8981\u8003\u8651\u524d\u9762\u7684\uff0c\u8fd8\u8981\u8003\u8651\u9020\u6210\u4e0b\u4e00\u4e2a\u80dc\u8d1f\u786e\u5b9a\u4f4d\u7f6e\u7684\u5f71\u54cd\u3002\n\n\u6613\u60f3\u5230\u8d1d\u53f6\u65af\u516c\u5f0f\u3002\n\n\u53c2\u8003\u7ed9\u51fa\u7684\u8d1d\u53f6\u65af\u516c\u5f0f\u3002\n\n$P(x_i=1|x_r,x_l)$\n\n$=\\frac{P(x_l,x_r|x_i)P(x_i)}{P(x_l,x_r)}$\n\n$=\\frac{P(x_l,x_r,x_i)}{P(x_l)P(x_r|x_l)}$\n\n$=\\frac{P(x_l,x_r,x_i)}{P(x_l)P(x_r|x_l)}$\n\n$=\\frac{P(x_i,x_r|x_l)}{P(x_r|x_l)}$ \n\n\u53ef\u4ee5\u53d1\u73b0\u4e0b\u9762\u5c31\u662f $x_l$ \u5bfc\u81f4 $x_r$ \u4e3a\u5f53\u524d\u786e\u8ba4\u60c5\u51b5\u7684\u6982\u7387\uff0c\u8fd9\u4e2a\u5c31\u662f\u6982\u7387\u77e9\u9635\u76f8\u4e58\u3002\n\n\u53ef\u4ee5\u53d1\u73b0\u8fd9\u65f6\u5019\n\u4e0a\u9762\u5219\u4e0d\u9700\u8981\u8003\u8651 $x_r$ \u7684\u5f71\u54cd\u4e86\uff0c\u4e0a\u9762\u6240\u6709 $i$ \u52a0\u8d77\u6765\u5c31\u662f\u8d62\u7684\u573a\u6570\u7684\u671f\u671b\uff0c\u53ea\u9700\u8981\u5728\u6982\u7387\u77e9\u9635\u76f8\u4e58\u7684\u65f6\u5019\u987a\u4fbf\u7b97\u4e00\u4e2a\u671f\u671b\u5373\u53ef\u3002\n\n\u7136\u540e\u5c31\u53ea\u9700\u8981\u5728\u52a0\u5165\u6216\u8005\u5220\u9664\u786e\u5b9a\u65f6\u95f4\u7684\u65f6\u5019\u627e\u4e00\u4e0b\u524d\u9a71\u540e\u7ee7\u52a0\u52a0\u51cf\u51cf\u5c31\u53ef\u4ee5\u4e86\u3002\n\n# code\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define cs const\n#define re register\n#define pii pair<int,int>\n#define fi first\n#define se second\n#define ll long long\n#define pb push_back\ncs int RLEN=1<<20|1;\ninline char gc(){\n\tstatic char ibuf[RLEN],*ib,*ob;\n\t(ib==ob)&&(ob=(ib=ibuf)+fread(ibuf,1,RLEN,stdin));\n\treturn (ib==ob)?EOF:*ib++;\n}\n#define gc getchar\ninline int read(){\n\tchar ch=gc();\n\tint res=0;bool f=1;\n\twhile(!isdigit(ch))f^=ch=='-',ch=gc();\n\twhile(isdigit(ch))res=(res+(res<<2)<<1)+(ch^48),ch=gc();\n\treturn f?res:-res;\n}\ntemplate<class tp>inline void chemx(tp &a,tp b){a<b?a=b:0;}\ntemplate<class tp>inline void chemn(tp &a,tp b){a>b?a=b:0;}\nint n,m;\ncs int N=200005;\nstruct mat{\n\tdouble a[2][2];\n\tmat(){a[0][0]=a[1][0]=a[0][1]=a[1][1]=0;}\n\tfriend inline mat operator +(cs mat &a,cs mat &b){\n\t\tmat c;\n\t\tfor(int i=0;i<2;i++)\n\t\tfor(int j=0;j<2;j++)\n\t\tc.a[i][j]=a.a[i][j]+b.a[i][j];\n\t\treturn c;\n\t}\n\tfriend inline mat operator *(cs mat &a,cs mat &b){\n\t\tmat c;\n\t\tfor(int i=0;i<2;i++)\n\t\tfor(int k=0;k<2;k++)\n\t\tfor(int j=0;j<2;j++)\n\t\tc.a[i][j]+=a.a[i][k]*b.a[k][j];\n\t\treturn c;\n\t}\n};\ndouble p[N],q[N];\nint sta[N];\nnamespace Seg{\n\t#define lc (u<<1)\n\t#define rc ((u<<1)|1)\n\t#define mid ((l+r)>>1)\n\tstruct data{\n\t\tmat a,b;\n\t\tinline void init(double p,double q){\n\t\t\ta.a[0][0]=1-q,a.a[0][1]=q,a.a[1][0]=1-p,a.a[1][1]=p;\n\t\t\tb.a[0][1]=q,b.a[1][1]=p;\n\t\t}\n\t\tfriend inline data operator *(cs data &a,cs data &b){\n\t\t\tdata c;\n\t\t\tc.a=a.a*b.a;\n\t\t\tc.b=a.a*b.b+a.b*b.a;\n\t\t\treturn c;\n\t\t}\n\t}s[N<<2];\n\tinline void pushup(int u){\n\t\ts[u]=s[lc]*s[rc];\n\t}\n\tvoid build(int u,int l,int r){\n\t\tif(l==r){\n\t\t\ts[u].init(p[l],q[l]);return;\n\t\t}\n\t\tbuild(lc,l,mid),build(rc,mid+1,r);\n\t\tpushup(u);\n\t}\n\tdata query(int u,int l,int r,int st,int des){\n\t\tif(st<=l&&r<=des)return s[u];\n\t\tif(des<=mid)return query(lc,l,mid,st,des);\n\t\tif(mid<st)return query(rc,mid+1,r,st,des);\n\t\treturn query(lc,l,mid,st,des)*query(rc,mid+1,r,st,des);\n\t}\n\tinline double getans(int l,int r){\n\t\tdata now=query(1,0,n+1,l+1,r);\n\t\treturn now.b.a[sta[l]][sta[r]]/now.a.a[sta[l]][sta[r]];\n\t}\n\t#undef lc\n\t#undef rc\n\t#undef mid\n}\nchar op[5];\nmap<int,int> vt;\n#define It map<int,int>::iterator\nint main(){\n\t#ifdef Stargazer\n\tfreopen(\"lx.in\",\"r\",stdin);\n\t#endif\n\tn=read(),m=read();scanf(\"%s\",op);\n\tscanf(\"%lf\",&p[1]);\n\tfor(int i=2;i<=n;i++)scanf(\"%lf%lf\",&p[i],&q[i]);\n\tp[0]=q[0]=1,p[n+1]=q[n+1]=0;\n\tSeg::build(1,0,n+1);\n\tvt[0]=1,vt[n+1]=0,sta[0]=1,sta[n+1]=0;\n\tdouble ans=Seg::getans(0,n+1);\n\twhile(m--){\n\t\tscanf(\"%s\",op);\n\t\tif(op[0]=='a'){\n\t\t\tint pos=read(),c=read();\n\t\t\tIt nxt=vt.lower_bound(pos),pre=nxt;pre--;\n\t\t\tvt[pos]=c,sta[pos]=c;\n\t\t\tans-=Seg::getans(pre->fi,nxt->fi);\n\t\t\tans+=Seg::getans(pre->fi,pos);\n\t\t\tans+=Seg::getans(pos,nxt->fi);\n\t\t}\n\t\telse{\n\t\t\tint pos=read();\n\t\t\tIt nxt=vt.upper_bound(pos),pre=nxt;pre--,pre--;\n\t\t\tans+=Seg::getans(pre->fi,nxt->fi);\n\t\t\tans-=Seg::getans(pre->fi,pos);\n\t\t\tans-=Seg::getans(pos,nxt->fi);\n\t\t\tsta[pos]=0;pre++,vt.erase(pre);\n\t\t}\n\t\tprintf(\"%.7lf\\n\",ans);\n\t}\n}\n\n```\n",
        "postTime": 1644230477,
        "uid": 464732,
        "name": "luqyou",
        "ccfLevel": 5,
        "title": "solution-p3772"
    }
]