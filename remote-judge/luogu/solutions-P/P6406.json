[
    {
        "content": "# **\u3010\u9898\u89e3\u3011Norma [COCI2014] [SP22343]**\n\n\n**\u4f20\u9001\u95e8\uff1a[$\\text{Norma [COCI2014] [P5899]}$](https://www.luogu.com.cn/problem/P5899) [$\\text{[SP22343]}$](https://www.luogu.com.cn/problem/SP22343)**\n\n## **\u3010\u9898\u76ee\u63cf\u8ff0\u3011**\n\n\u7ed9\u5b9a\u4e00\u4e2a\u6574\u6570 $n$ \u548c\u4e00\u4e2a\u957f\u5ea6\u4e3a $n$ \u7684\u5e8f\u5217 $a$\uff0c\u5b50\u5e8f\u5217\u662f\u6307\u539f\u5e8f\u5217\u4e2d\u4e00\u6bb5\u8fde\u7eed\u7684\u5e8f\u5217\u3002\u5b50\u5e8f\u5217\u7684\u4ef7\u503c\u5b9a\u4e49\u4e3a\u5b83\u4eec\u4e2d\u7684**\u6700\u5c0f\u503c**\u4e58\u4ee5**\u6700\u5927\u503c**\u518d\u4e58\u4ee5**\u8be5\u5b50\u5e8f\u5217\u957f\u5ea6** \u3002\u73b0\u8981\u8ba1\u7b97\u6240\u6709\u5b50\u5e8f\u5217\u7684\u4ef7\u503c\u4e4b\u548c\uff0c\u7b54\u6848\u5bf9 $1e9$ \u53d6\u6a21\u3002\n\n-------\n\n## **\u3010\u5206\u6790\u3011**\n\n\u8be2\u95ee\u8fc7\u4e8e\u5947\u8469\uff0c\u4e07\u80fd\u7684\u7ebf\u6bb5\u6811\u90fd\u6ca1\u6cd5\u641e\uff0c\u5355\u8c03\u961f\u5217\u4e5f\u8bb8\u53ef\u505a\uff0c\u4f46\u592a\u590d\u6742\u4e86\u3002\n\n\u53ef\u4ee5\u7528\u7c7b\u4f3c $\\text{CDQ}$ \u7684\u601d\u60f3\u9012\u5f52\u5206\u6cbb\uff1a\u5c06\u4e00\u6bb5\u533a\u95f4\u5206\u4e3a\u5de6\u53f3\u4e24\u534a\uff0c\u8ba1\u7b97\u5176\u4e2d\u4e00\u534a\u5bf9\u53e6\u4e00\u534a\u7684\u8d21\u732e\uff0c\u5f97\u5230\u53e6\u4e00\u534a\u7684\u7b54\u6848\u3002\n\n\u5bf9\u4e8e\u4e00\u4e2a\u533a\u95f4 $[L,R]$\uff0c\u6c42\u51fa\u5176\u4e2d\u7a7f\u8fc7\u4e86 $a[mid]$ \u7684\u6240\u6709\u5b50\u5e8f\u5217\u4ef7\u503c\u603b\u548c\uff0c\u7136\u540e\u518d\u9012\u5f52\u6c42\u89e3 $[L,mid]$ \u4ee5\u53ca $[mid\\!+\\!1,R]$\uff0c\u53ef\u4ee5\u4fdd\u8bc1\u5b50\u5e8f\u5217\u7684\u8ba1\u7b97\u4e00\u5b9a\u4e0d\u91cd\u4e0d\u6f0f\u3002\n\n\u8003\u8651\u5904\u7406\u4e00\u4e2a\u533a\u95f4 $[L,R]$ \uff0c\u5148\u679a\u4e3e $i \\in [L,mid]$ \u56fa\u5b9a\u5de6\u7aef\u70b9\uff0c\u6c42\u51fa\u4ee5\u6bcf\u4e2a $i$ \u4f5c\u4e3a\u5de6\u7aef\u70b9\u7684\u6240\u6709\u5b50\u5e8f\u5217\u8d21\u732e\u548c\u3002\n\n\u5bf9\u4e8e\u6bcf\u4e2a $i$\uff1a\n\n\u7528 $mi,mx$ \u5206\u522b\u8868\u793a $min \\{ a[i] \\cdots a[mid] \\}$ \u548c $max \\{ a[i] \\cdots a[mid] \\}$\n\n\u8bbe\u4e24\u4e2a\u6307\u9488 $j,k$\uff0c    \n$j$ \u8868\u793a\u6ee1\u8db3 $mi \\leqslant min \\{ a[mid\\!+\\!1] \\cdots a[j] \\}$ \u7684\u6700\u5927\u7684 $j$ \u7684\u4f4d\u7f6e\uff0c  \n$k$ \u8868\u793a\u6ee1\u8db3 $mx \\geqslant max \\{ a[mid\\!+\\!1] \\cdots a[k] \\}$ \u7684\u6700\u5927\u7684 $k$ \u7684\u4f4d\u7f6e\u3002\n\n\u8bbe $w_{1}=min\\{j,k\\},w_{2}=max\\{j,k\\}$\uff0c\u6b64\u65f6\u53f3\u534a\u90e8\u5206\u88ab\u5206\u6210\u4e86\u4e09\u4e2a\u90e8\u5206\uff0c\u5206\u522b\u5bf9\u5176\u6c42\u89e3\u3002\n\n$(1).$ **\u5b8c\u5168\u6ee1\u8db3** $mi,mx$ **\u7684\u90e8\u5206\uff1a** $[mid\\!+\\!1,w_{1}]$  \n\n\u53ef\u77e5\u8fd9\u4e00\u6574\u6bb5\u7684\u5143\u7d20\u6570\u503c\u8303\u56f4\u90fd\u5728 $[mi,mx]$ \u4ee5\u5185\uff0c\u56e0\u6b64\u53f3\u7aef\u70b9\u5728\u53d6 $[mid\\!+\\!1,w_{1}]$ \u4e2d\u7684\u4efb\u610f\u4e00\u4e2a\u4f4d\u7f6e\u65f6\uff0c\u5b50\u5e8f\u5217\u6700\u5c0f\u503c\u90fd\u59cb\u7ec8\u4e3a $mi$\uff0c\u6700\u5927\u503c\u4e5f\u59cb\u7ec8\u4e3a $mx$\uff0c\u81f3\u4e8e\u533a\u95f4\u957f\u5ea6\uff0c\u76f4\u63a5\u5957\u7b49\u5dee\u6570\u5217\u516c\u5f0f\u5c31\u597d\u4e86\uff0c\u5c0f\u5b66\u6570\u5b66\u4e0d\u518d\u8d58\u8ff0\uff08\u8fd9\u73a9\u610f\u513f\u6709\u4e2a\u5f88\u9ad8\u5927\u4e0a\u7684\u540d\u5b57\uff1a[\u9ad8\u65af\u6c42\u548c](https://baike.baidu.com/item/%E9%AB%98%E6%96%AF%E6%B1%82%E5%92%8C/7487795?fr=aladdin)\uff09\u3002\n\n**\u7b2c** $1$ **\u90e8\u5206\u5bf9\u5de6\u7aef\u70b9** $i$ **\u7684\u603b\u8d21\u732e\u53ef\u8868\u793a\u4e3a\uff1a** $ans_{1}[i]=mi*mx*\\frac{(((mid\\!+\\!1)\\!-i\\!+\\!1)+(w1\\!-\\!i\\!+\\!1))*(w1\\!-\\!(mid\\!+\\!1)\\!+\\!1)}{2}$ \u3002\n\n$(2).$ **\u6ee1\u8db3** $mi,mx$ **\u5176\u4e00\u7684\u90e8\u5206\uff1a** $[w_{1}\\!+\\!1,w_{2}]$\n\n\u8fd9\u90e8\u5206\u6bd4\u8f83\u96be\u60f3\uff0c\u5728\u8349\u7a3f\u7eb8\u4e0a\u6bd4\u5212\u4e86\u597d\u4e45\u624d\u641e\u51fa\u6765\uff0c\u800c\u4e14\u8fd8\u4e0d\u592a\u597d\u63cf\u8ff0\u3002\n\n\u5206\u4e3a $j<k$ $($ \u5373 $w_{1}\\!<\\!k\\!=\\!w_{2})$ \u548c $j>k$ $($ \u5373 $w_{1}\\!<\\!j\\!=\\!w_{2})$ \u4e24\u79cd\u60c5\u51b5\u8ba8\u8bba\u3002\n\n\u4ee5 $j<k$ \u4e3a\u4f8b\uff0c\u6b64\u65f6\u8981\u8ba1\u7b97\u53f3\u7aef\u70b9 $[w_{1}\\!+\\!1,w_{2}]$ \u5bf9 $i$ \u7684\u8d21\u732e\u53ef\u4ee5\u76f4\u63a5\u7528 $mx$\uff0c\u4f46 $mi$ \u4e0d\u884c\uff0c\u8981\u7528\u4e24\u4e2a\u524d\u7f00\u548c\u6570\u7ec4\u9884\u5904\u7406\u4e00\u4e0b\u8fd9\u4e2a\u4e1c\u897f\u3002\n\n\u7531\u4e8e\u5b50\u5e8f\u5217\u957f\u5ea6\u5728\u4e0d\u65ad\u7684\u53d8\u5316\uff0c\u4f46 $mid+1$ \u662f\u59cb\u7ec8\u4e0d\u53d8\u7684\uff0c\u53ef\u4ee5\u8f7b\u677e\u5904\u7406\u51fa\u5de6\u7aef\u70b9\u4e3a $mid+1$ \u7684\u5b50\u5e8f\u5217\u8d21\u732e\u548c\uff0c\u8bb0\u4e3a $S_{1}$ \u3002\u518d\u770b\u5de6\u8fb9\u90e8\u5206\u6ca1\u6709\u8ba1\u7b97\u7684\u90e8\u5206\u957f\u5ea6\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a $i$\uff0c\u5b83\u4e5f\u662f\u56fa\u5b9a\u7684 $(mid-i+1)$\uff0c\u4e8e\u662f\u8fd8\u8981\u7528\u4e00\u4e2a\u6570\u7ec4 $S\u2019_{1}$ \u8bb0\u5f55\u6bcf\u4e2a\u524d\u7f00\u6700\u5c0f\u503c\u7684\u524d\u7f00\u548c\u3002\n\n\u8fd9\u4e2a\u4e1c\u897f\u4e0d\u592a\u597d\u63cf\u8ff0\uff0c\u89c1\u4e0b\u9762\u7684\u5f0f\u5b50\uff1a\n\n$S_{1}[x]$ $(mid\\!+\\!1\\!\\leqslant\\!x\\!\\leqslant\\!R)$ $=$ $\\sum_{i=mid+1}^{x} ((i\\!-\\!(mid\\!+\\!1)\\!+\\!1)*max\\{a[mid\\!+\\!1] \\cdots a[i]\\})$ \n\n$S'_{1}[x]$ $(mid\\!+\\!1\\!\\leqslant\\!x\\!\\leqslant\\!R)$ $=$ $\\sum_{i=mid+1}^{x} max\\{a[mid\\!+\\!1] \\cdots a[i]\\}$ \n\n\u8be5\u505a\u6cd5\u7684\u6b63\u786e\u6027\u6765\u81ea\u4e8e\uff1a\u968f\u7740\u53f3\u7aef\u70b9\u7684\u9012\u589e\uff0c$mid\\!+\\!1$ \u5230**\u53f3\u7aef\u70b9**\u7684**\u524d\u7f00\u6700\u5927\u503c\u5355\u8c03\u4e0d\u4e0b\u964d**\uff0c**\u6700\u5c0f\u503c\u5355\u8c03\u4e0d\u4e0a\u5347**\uff0c\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u7528\u524d\u7f00\u548c\u6570\u7ec4\u4e2d\u7684\u4e24\u4e2a\u4f4d\u7f6e\u76f8\u51cf**\u5f97\u5230\u4e00\u6bb5\u7684\u8d21\u732e**\u3002\n\n$j>k$ \u7684\u60c5\u51b5\u540c\u7406\uff0c\u9884\u5904\u7406\u4e24\u4e2a\u6570\u7ec4 $S_{2},S'_{2}$\u5373\u53ef\u3002\n\n**\u7b2c** $2$ **\u90e8\u5206\u5bf9\u5de6\u7aef\u70b9** $i$ **\u7684\u603b\u8d21\u732e\u53ef\u8868\u793a\u4e3a\uff1a**  $ans_{2}[i]=\\begin{cases}\nmx*((S_{1}[k]\\!-\\!S_{1}[w1])+(mid\\!-\\!i\\!+\\!1)*(S'_{1}[k]\\!-\\!S'_{1}[w1]))&(j<k)\\\\\n mi*((S_{2}[j]\\!-\\!S_{2}[w1])+(mid\\!-\\!i\\!+\\!1)*(S'_{2}[j]\\!-\\!S'_{2}[w1]))&(k<j)\n \\end{cases}$ \u3002\n\n\n$(3).$ **\u5b8c\u5168\u4e0d\u6ee1\u8db3** $mi,mx$ **\u7684\u90e8\u5206\uff1a** $[w_{2}\\!+\\!1,R]$\n\n\u5176\u5b9e\u53ea\u8981 $(2)$ \u641e\u4e86\u51fa\u6765\uff0c$(3)$ \u5c31\u6ca1\u5565\u96be\u5ea6\u4e86\uff0c\u4e00\u6837\u7684\u5904\u7406\u65b9\u6cd5\uff0c\u7ef4\u62a4\u4e24\u4e2a\u524d\u7f00\u548c\u6570\u7ec4 $S_{3},S'_{3}$\u3002\n\n**\u7b2c** $3$ **\u90e8\u5206\u5bf9\u5de6\u7aef\u70b9** $i$ **\u7684\u603b\u8d21\u732e\u53ef\u8868\u793a\u4e3a\uff1a** $ans_{3}[i]=(S_{3}[R]\\!-\\!S_{3}[w2])+(mid\\!-\\!i\\!+\\!1)*(S'_{3}[R]\\!-\\!S'_{3}[w2])$ \u3002\n\n**\u6700\u540e\uff0c\u6ce8\u610f\u53d6\u819c\uff01\uff01\uff01\u5f00** $long$ $long$ **\u9632\u6b62\u4e2d\u95f4\u4e58\u7206\u3002**\n\n\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a\uff1a $O(nlogn)$ \u3002\n\n## **\u3010Code\u3011**\n\n```cpp\n#include<algorithm>\n#include<iostream>\n#include<cstring>\n#include<cstdlib>\n#include<cstdio>\n#define LL long long\n#define Re register LL\nusing namespace std;\nconst LL N=5e5+3,logN=19,P=1e9;\nLL n,ans,a[N],S1[N],S2[N],S3[N],S1_[N],S2_[N],S3_[N];\ninline void in(Re &x){\n    int f=0;x=0;char c=getchar();\n    while(c<'0'||c>'9')f|=c=='-',c=getchar();\n    while(c>='0'&&c<='9')x=(x<<1)+(x<<3)+(c^48),c=getchar();\n    x=f?-x:x;\n}\ninline void sakura(Re L,Re R){\n    if(L==R){(ans+=a[L]*a[L]%P)%=P;return;}//\u8fd9\u4e2a\u7279\u5224\u5fc5\u987b\u8981\u52a0\n    if(L+1==R){(ans+=(a[L]*a[L]%P+a[R]*a[R]%P+a[L]*a[R]%P*2%P)%P)%=P;return;}//\u8fd9\u91cc\u597d\u50cf\u4e0d\u7528\u7279\u5224\u4e5f\u53ef\u4ee5QAQ\n    Re mid=L+R>>1,mi=a[mid],mx=a[mid],i=mid,j=mid,k=mid;//\u6ce8\u610fj,k\u9884\u5904\u7406\u4e3amid\u800c\u4e0d\u662fmid+1\n    Re MI=a[mid+1],MX=a[mid+1];//\u8fd9\u91ccMI,MX\u548c\u4e0a\u9762\u7684mi,mx\u53d6inf,-inf\u4e5f\u53ef\u4ee5\n    S1[mid]=S2[mid]=S3[mid]=S1_[mid]=S2_[mid]=S3_[mid]=0;//\u91cd\u7f6e\u524d\u7f00\u548c\n    for(Re i=mid+1;i<=R;++i){\n        MI=min(MI,a[i]),MX=max(MX,a[i]);//\u66f4\u65b0\u524d\u7f00\u6700\u5927\u503c\n        (S1[i]=S1[i-1]+MI*(i-(mid+1)+1)%P)%=P,(S1_[i]=S1_[i-1]+MI)%=P;//\u9012\u63a8\u66f4\u65b0S1\n        (S2[i]=S2[i-1]+MX*(i-(mid+1)+1)%P)%=P,(S2_[i]=S2_[i-1]+MX)%=P;//\u9012\u63a8\u66f4\u65b0S2\n        (S3[i]=S3[i-1]+MI*MX%P*(i-(mid+1)+1)%P)%=P,(S3_[i]=S3_[i-1]+MI*MX%P)%=P;//\u9012\u63a8\u66f4\u65b0S3\n    }\n    while(i>=L){\n        mi=min(mi,a[i]),mx=max(mx,a[i]);\n        while(j<R&&a[j+1]>mi)++j;//\u79fb\u52a8MI\u6307\u9488j\n        while(k<R&&a[k+1]<mx)++k;//\u79fb\u52a8MX\u6307\u9488k\n        Re w1=min(j,k),w2=max(j,k);//\u83b7\u53d6\u4e09\u90e8\u5206\u7684\u4e24\u4e2a\u5206\u754c\u70b9\n        if(w1>mid)(ans+=mi*mx%P*((mid+1-i+1+w1-i+1)*(w1-(mid+1)+1)/2%P)%P)%=P;//\u5b8c\u5168\u6ee1\u8db3\u7684\u90e8\u5206\n        if(j>w1)//\u6ee1\u8db3mi\u4f46\u4e0d\u6ee1\u8db3mx\n            (ans+=mi*((S2[j]-S2[w1]+P)%P+(mid-i+1)*(S2_[j]-S2_[w1]+P)%P)%P)%=P;\n        if(k>w1)//\u6ee1\u8db3mx\u4f46\u4e0d\u6ee1\u8db3mi\n            (ans+=mx*((S1[k]-S1[w1]+P)%P+(mid-i+1)*(S1_[k]-S1_[w1]+P)%P)%P)%=P;\n        (ans+=((S3[R]-S3[w2]+P)%P+(mid-i+1)*(S3_[R]-S3_[w2]+P)%P)%P)%=P;//\u5b8c\u5168\u4e0d\u6ee1\u8db3\u7684\u90e8\u5206\n        --i;//\u79fb\u52a8\u5de6\u6307\u9488\n    }\n    sakura(L,mid),sakura(mid+1,R);//\u9012\u5f52\u641e\u4e0b\u9762\n}\nint main(){\n//  freopen(\"norma.in\",\"r\",stdin);\n//  freopen(\"norma.out\",\"w\",stdout);\n    in(n);\n    for(Re i=1;i<=n;++i)in(a[i]);\n    sakura(1,n);\n    printf(\"%lld\\n\",ans%P);\n//  fclose(stdin);\n//  fclose(stdout);\n    return 0;\n}\n```",
        "postTime": 1578656765,
        "uid": 110985,
        "name": "\u8fb0\u661f\u51cc",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P5899 \u3010[COCI 2015]Norma\u3011"
    },
    {
        "content": "\u6ce8\u91ca\uff1a\u535a\u5ba2\u7f16\u8f91\u9875\u548c\u7ba1\u7406\u5458\u9898\u89e3\u5ba1\u6838\u9875\u4f7f\u7528\u7684 $\\KaTeX$ \u7248\u672c\u8f83\u4f4e\uff0c\u4e0d\u652f\u6301 `\\def` \u6307\u4ee4\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u672c\u9898\u89e3\u4e2d\u7684\u90e8\u5206\u516c\u5f0f\u6e32\u67d3\u5f02\u5e38\uff0e\u800c\u5728\u9898\u76ee\u5bf9\u5e94\u7684\u9898\u89e3\u5c55\u793a\u9875\u9762\u548c\u4e2a\u4eba\u535a\u5ba2\u6e32\u67d3\u9875\u9762\u4f7f\u7528\u7684 $\\KaTeX$ \u4e3a\u9ad8\u7248\u672c\uff0c\u5219\u65e0\u6b64\u95ee\u9898\uff0e\n\n---\n\n\u4ecb\u7ecd\u4e00\u4e2a\u975e\u5e38\u65e0\u8111\u7684\u505a\u6cd5\uff0e\n\n\u8003\u8651\u5bf9\u5e8f\u5217\u5206\u6cbb\uff0e\u5047\u8bbe\u5f53\u524d\u5206\u6cbb\u533a\u95f4\u4e3a $[l,r]$\uff0c\u533a\u95f4\u4e2d\u70b9\u4e3a $\\mathit{mid}$\uff0c\u5df2\u7ecf\u5904\u7406\u4e86 $[l,\\mathit{mid}]$ \u548c $[\\mathit{mid}+1, r]$ \u7684\u6240\u6709\u533a\u95f4\uff0e\u6b64\u65f6\u6211\u4eec\u9700\u8981\u8ba1\u7b97\u7684\u662f\u6240\u6709\u5de6\u7aef\u70b9\u5728 $[l,\\mathit{mid}]$\uff0c\u53f3\u7aef\u70b9\u5728 $[\\mathit{mid}+1, r]$ \u7684\u5b50\u533a\u95f4\u7684\u8d21\u732e\uff0e\n\n\u679a\u4e3e\u539f\u5f0f\u4e2d\u7684 $\\min$ \u548c $\\max$ \u5728\u5de6\u534a\u8fb9\u8fd8\u662f\u53f3\u534a\u8fb9\u53d6\u5230\uff0c\u5171\u6709\u56db\u79cd\u60c5\u51b5\uff1a\n\n- A. $\\min$ \u53d6\u53f3\u534a\uff0c$\\max$ \u53d6\u5de6\u534a\uff0e\n- B. $\\min$ \u53d6\u5de6\u534a\uff0c$\\max$ \u53d6\u5de6\u534a\uff0e\n- C. $\\min$ \u53d6\u5de6\u534a\uff0c$\\max$ \u53d6\u53f3\u534a\uff0e\n- D. $\\min$ \u53d6\u53f3\u534a\uff0c$\\max$ \u53d6\u53f3\u534a\uff0e\n\n\u4e8b\u5b9e\u4e0a\uff0c\u82e5\u4ee5\u5b50\u533a\u95f4\u6240\u6709\u6570\u7684 $\\min$ \u4e3a $x$-\u8f74\uff0c\u5b50\u533a\u95f4\u6240\u6709\u6570\u7684 $\\max$ \u4e3a $y$-\u8f74\uff0c\u5219\u53ef\u4ee5\u628a\u6bcf\u4e2a\u5f62\u5982 $[i,\\mathit{mid}]$ \u6216 $[\\mathit{mid},j]$ \u7684\u534a\u533a\u95f4\u90fd\u770b\u4f5c\u4e8c\u7ef4\u5e73\u9762\u4e0a\u7684\u70b9\uff0e\u82e5\u4ee5\u4e00\u4e2a\u53f3\u534a\u533a\u95f4\u5bf9\u5e94\u7684\u70b9\u4f5c\u4e3a\u539f\u70b9\uff0c\u5219\u5728\u7b2c\u4e00\u3001\u4e8c\u3001\u4e09\u3001\u56db\u8c61\u9650\u4e2d\u7684\u5de6\u534a\u533a\u95f4\u5bf9\u5e94\u7684\u70b9\u7684\u7b26\u5408\u5bf9\u5e94\u4e0a\u8ff0\u7684 A\u3001B\u3001C\u3001D \u56db\u79cd\u60c5\u51b5\uff0e\n\n\u8003\u8651\u8ba1\u7b97\u6bcf\u79cd\u60c5\u51b5\u7684 $i$ \u5bf9\u53f3\u7aef\u70b9 $j$ \u7684\u8d21\u732e\uff0c\u4e0b\u9762\u8bbe $N_i,X_i$ \u5206\u522b\u8868\u793a $i$ \u6240\u5728\u7684\u534a\u533a\u95f4\u6240\u6709\u6570\u7684 $\\min$ \u6216 $\\max$ \u503c\uff1a\n\n$$\n\\def\\ans{\\mathit{ans}}\n\\def\\mid{\\mathit{mid}}\n\\def\\mn{\\mathit{N}}\n\\def\\mx{\\mathit{X}}\n\\begin{aligned}\n\\ans_A &= \\sum_i [\\mn_i \\le \\mn_j \\land \\mx_i > \\mx_j] (j-i+1) \\mx_i \\mn_j\\\\\n&={\\color{red}(\\sum_i[\\mn_i \\le \\mn_j \\land \\mx_i > \\mx_j] (\\mid-i+1) \\mx_i)} \\mn_j\\\\\n&\\quad {} + {\\color{blue}(\\sum_i[\\mn_i \\le \\mn_j \\land \\mx_i > \\mx_j] \\mx_i )} (r-\\mid) \\mn_j\\\\\n\\ans_B &= \\sum_i [\\mn_i > \\mn_j \\land \\mx_i > \\mx_j] (j-i+1) \\mx_i \\mn_i\\\\\n&={\\color{red}(\\sum_i[\\mn_i > \\mn_j \\land \\mx_i > \\mx_j] (\\mid-i+1) \\mx_i \\mn_i)}\\\\\n&\\quad {} + {\\color{blue}(\\sum_i[\\mn_i > \\mn_j \\land \\mx_i > \\mx_i] \\mx_i \\mn_i)}(r-\\mid)\\\\\n\\cdots&{}\n\\end{aligned}\n$$\n\n\u7c7b\u4f3c\u7684\uff0c$\\mathit{ans}_C$ \u548c $\\mathit{ans}_D$ \u4e5f\u53ef\u4ee5\u62c6\u6210\u7c7b\u4f3c\u7684\u4e1c\u897f\uff0e\u89c2\u5bdf\u5230\u5f0f\u5b50\u7684\u5f62\u5f0f\u90fd\u662f\u4e24\u4e2a\u4e8c\u7ef4\u77e9\u5f62\u5185\u6240\u5305\u542b\u70b9\u7684\u70b9\u6743\u548c\uff08\u5373\u4e0a\u8ff0\u516c\u5f0f\u4e2d\u7684\u7ea2\u3001\u84dd\u8272\u90e8\u5206\uff09\u518d\u4e58\u4ee5\u4e00\u4e9b\u5e38\u6570\uff0e\u4e0d\u96be\u60f3\u5230\u7528\u626b\u63cf\u7ebf + \u6811\u72b6\u6570\u7ec4\u7ef4\u62a4\u4e8c\u7ef4\u6570\u70b9\uff0e\n\n\u7531\u4e8e\u56db\u4e2a\u5f0f\u5b50\u4e2d\u7684\u6bcf\u4e2a\u90fd\u4f1a\u62c6\u51fa\u4e24\u4e2a\u4e92\u4e0d\u76f8\u540c\u7684\u77e9\u5f62\u548c\u7684\u5f62\u5f0f\uff0e\u6545\u9700\u8981\u516b\u4e2a\u6811\u72b6\u6570\u7ec4\uff0c\u5206\u522b\u7ef4\u62a4\u77e9\u5f62 $1$\u3001$\\mathit{len}$\u3001$N$\u3001$X$\u3001$\\mathit{len}\\cdot N$\u3001$\\mathit{len}\\cdot X$\u3001$N\\cdot X$\u3001$\\mathit{len}\\cdot N\\cdot X$ \u7684\u548c\u5373\u53ef\uff0e\n\n\u672c\u505a\u6cd5\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n(\\log n)^2)$\uff0c\u7a7a\u95f4\u590d\u6742\u5ea6\u4e3a $O(n)$\uff0c\u53ef\u4ee5\u901a\u8fc7\u6b64\u9898\uff0e\n\n```cpp\nstruct Bit {\n  // \u7701\u7565\u6811\u72b6\u6570\u7ec4\n} bit1, bitx, bitw, bitxw;\n\n\n/*\n    max\n  B  |  A\n-----O------> min\n  C  |  D\n*/\ninline void Divide(int l, int r) {\n  if (l == r) return ans += 1ll * vec[a[l] - 1] * vec[a[l] - 1] % mo, void();\n  int mid = (l + r) >> 1;\n  Divide(l, mid), Divide(mid + 1, r);\n  mx[mid] = mn[mid] = a[mid];\n  per (i, mid - 1, l) mn[i] = min(mn[i + 1], a[i]), mx[i] = max(mx[i + 1], a[i]);\n  mx[mid + 1] = mn[mid + 1] = a[mid + 1];\n  rep (i, mid + 2, r) mn[i] = min(mn[i - 1], a[i]), mx[i] = max(mx[i - 1], a[i]);\n  sort(rnk + l, rnk + r + 1, [](int x, int y) { return mn[x] < mn[y]; });\n  int sumx = 0, sumxw = 0;\n  rep (i, l, r)\n    if (rnk[i] <= mid) {\n      int tmp, mxv = vec[mx[rnk[i]] - 1], mnv = vec[mn[rnk[i]] - 1];\n      bit1.Add(mx[rnk[i]], mnv);\n      bitx.Add(mx[rnk[i]], tmp = 1ll * mxv * mnv % mo);\n      sumx += tmp, umod(sumx);\n      bitw.Add(mx[rnk[i]], 1ll * (mid - rnk[i] + 1) * mnv % mo);\n      bitxw.Add(mx[rnk[i]], tmp = 1ll * (mid - rnk[i] + 1) * mxv % mo * mnv % mo);\n      sumxw += tmp, umod(sumxw);\n    } else {\n      int res1 = bit1.Ask(mx[rnk[i]]), resx = bitx.Ask(mx[rnk[i]]), resw = bitw.Ask(mx[rnk[i]]),\n          resxw = bitxw.Ask(mx[rnk[i]]), mxv = vec[mx[rnk[i]] - 1];\n      // B: (w1+w2)*mx_i*mn_i\n      ans += (1ll * sumxw - resxw + mo) % mo, umod(ans);\n      ans += 1ll * (rnk[i] - mid) % mo * (sumx - resx + mo) % mo, umod(ans);\n      // C: (w1+w2)*mx_j*mn_i\n      ans += 1ll * resw * mxv % mo, umod(ans);\n      ans += 1ll * res1 * (rnk[i] - mid) % mo * mxv % mo, umod(ans);\n    }\n  rep (i, l, r)\n    if (rnk[i] <= mid) {\n      int mxv = vec[mx[rnk[i]] - 1], mnv = vec[mn[rnk[i]] - 1];\n      bit1.Add(mx[rnk[i]], mo - mnv);\n      bitx.Add(mx[rnk[i]], mo - 1ll * mxv * mnv % mo);\n      bitw.Add(mx[rnk[i]], mo - 1ll * (mid - rnk[i] + 1) * mnv % mo);\n      bitxw.Add(mx[rnk[i]], mo - 1ll * (mid - rnk[i] + 1) * mxv % mo * mnv % mo);\n    }\n  sumx = 0, sumxw = 0;\n  per (i, r, l)\n    if (rnk[i] <= mid) {\n      int tmp, mxv = vec[mx[rnk[i]] - 1];\n      bit1.Add(mx[rnk[i]], 1);\n      bitx.Add(mx[rnk[i]], tmp = mxv);\n      sumx += tmp, umod(sumx);\n      bitw.Add(mx[rnk[i]], 1ll * (mid - rnk[i] + 1) % mo);\n      bitxw.Add(mx[rnk[i]], tmp = 1ll * (mid - rnk[i] + 1) * mxv % mo);\n      sumxw += tmp, umod(sumxw);\n    } else {\n      int res1 = bit1.Ask(mx[rnk[i]]), resx = bitx.Ask(mx[rnk[i]]), resw = bitw.Ask(mx[rnk[i]]),\n          resxw = bitxw.Ask(mx[rnk[i]]), mxv = vec[mx[rnk[i]] - 1], mnv = vec[mn[rnk[i]] - 1];\n      // A: (w1+w2)*mx_i*mn_j\n      ans += (1ll * sumxw - resxw + mo) % mo * mnv % mo, umod(ans);\n      ans += 1ll * (rnk[i] - mid) % mo * (sumx - resx + mo) % mo * mnv % mo, umod(ans);\n      // D: (w1+w2)*mx_j*mn_j\n      ans += 1ll * resw * mxv % mo * mnv % mo, umod(ans);\n      ans += 1ll * res1 * (rnk[i] - mid) % mo * mxv % mo * mnv % mo, umod(ans);\n    }\n  rep (i, l, r)\n    if (rnk[i] <= mid) {\n      int mxv = vec[mx[rnk[i]] - 1];\n      bit1.Add(mx[rnk[i]], mo - 1);\n      bitx.Add(mx[rnk[i]], mo - mxv);\n      bitw.Add(mx[rnk[i]], mo - 1ll * (mid - rnk[i] + 1) % mo);\n      bitxw.Add(mx[rnk[i]], mo - 1ll * (mid - rnk[i] + 1) * mxv % mo);\n    }\n}\n```",
        "postTime": 1673528310,
        "uid": 207996,
        "name": "yzy1",
        "ccfLevel": 9,
        "title": "P6406 \u9898\u89e3"
    },
    {
        "content": "\u7531\u4e8e\u8fd9\u9898\u7684\u9898\u610f\u5341\u5206\u6e05\u6670\u6613\u61c2\uff0c\u6240\u4ee5\u5c31\u4e0d\u8fc7\u591a\u89e3\u91ca\u4e86\uff0c\u76f4\u63a5\u5f00\u59cb\u5206\u6790\u3002\n\n\u6211\u4eec\u8003\u8651\u5c06\u6bcf\u4e00\u4e2a\u533a\u95f4 $[l,r]$ \u5206\u6210\u4e24\u6bb5\uff0c\u5206\u522b\u662f $[l,mid]$ \u548c $[mid+1,r]$\uff0c\u7136\u540e\u6211\u4eec\u601d\u8003\u5982\u4f55\u6c42\u51fa $\\sum_{i=l}^r \\sum_{j=l}^r (j-i+1)\\max(a_i...a_j)\\min(a_i...a_j)$\u3002\u9996\u5148\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u7c7b\u4f3c\u5f52\u5e76\u6392\u5e8f\u7684\u9012\u5f52\u5206\u522b\u6c42\u51fa\u5728 $[l,mid]$ \u548c $[mid+1,r]$ \u5185\u90e8\u7684\u503c\uff0c\u7136\u540e\u6211\u4eec\u4e3b\u8981\u5c31\u662f\u8981\u6c42\u8de8\u4e86\u4e24\u4e2a\u533a\u95f4\u7684\u95ee\u9898\u3002\n\n\u6211\u4eec\u679a\u4e3e $[l,mid]$ \u4e2d\u6bcf\u4e00\u4e2a\u6570\uff0c\u6211\u4eec\u8003\u8651\u5c06 $[mid+1,r]$ \u5206\u4e3a\u4e09\u4e2a\u90e8\u5206\uff0c\u5206\u522b\u662f $\\min,\\max$ \u90fd\u662f\u7528\u5de6\u533a\u95f4\u7684\uff0c\u5176\u4e2d\u4e00\u4e2a\u7528\u5de6\u533a\u95f4\u7684\uff0c\u548c\u5168\u90fd\u7528\u53f3\u533a\u95f4\u7684\u3002\u5bf9\u4e8e\u8fd9\u4e09\u79cd\u60c5\u51b5\u6211\u4eec\u4f9d\u6b21\u8ba8\u8bba\u5e76\u7528\u524d\u7f00\u548c\u4f18\u5316\u6210 $O(1)$ \u5373\u53ef\u3002\n\n\u4e8e\u662f\u5bf9\u4e8e\u6bcf\u4e00\u4e2a $[l,r]$ \u90fd\u662f $O(r-l+1)$ \u7684\uff0c\u6240\u4ee5\u603b\u7684\u590d\u6742\u5ea6\u4e3a $O(n\\log n)$\u3002\n\n```\n#include<bits/stdc++.h>\n#define ll long long\nusing namespace std;\nconst int NR=1e6+10;\nconst long long mod=1e9;\nint n;\nint a[NR];\nint p[NR],q[NR];\nll sum[NR],num[NR];\nll sum1[NR],num1[NR];\nll sum2[NR],num2[NR];\nll ans;\n\nvoid solve(int l,int r)\n{\n\tif(l==r){ans=(ans+1ll*a[l]*a[l])%mod;return;}\n\tint mid=(l+r>>1);\n\tsolve(l,mid),solve(mid+1,r);\n\tp[mid]=0,q[mid]=0x3f3f3f3f;\n\tsum[mid]=sum1[mid]=sum2[mid]=0;\n\tnum[mid]=num1[mid]=num2[mid]=0;\n\tfor(int i=mid+1;i<=r;i++) p[i]=max(p[i-1],a[i]);\n\tfor(int i=mid+1;i<=r;i++) q[i]=min(q[i-1],a[i]);\n\tfor(int i=mid+1;i<=r;i++) sum[i]=(sum[i-1]+1ll*p[i]*q[i]%mod*(i-mid+1))%mod;\n\tfor(int i=mid+1;i<=r;i++) num[i]=(num[i-1]+1ll*p[i]*q[i])%mod;\t\n\tfor(int i=mid+1;i<=r;i++) sum1[i]=(sum1[i-1]+1ll*p[i]*(i-mid+1))%mod;\n\tfor(int i=mid+1;i<=r;i++) num1[i]=(num1[i-1]+p[i])%mod;\n\tfor(int i=mid+1;i<=r;i++) sum2[i]=(sum2[i-1]+1ll*q[i]*(i-mid+1))%mod;\n\tfor(int i=mid+1;i<=r;i++) num2[i]=(num2[i-1]+q[i])%mod;\n\tint minn=0x3f3f3f3f,maxn=0;\n\tint mins=mid+1,maxs=mid+1;\n\tfor(int i=mid;i>=l;i--)\n\t{\n\t\tminn=min(minn,a[i]),maxn=max(maxn,a[i]);\n\t\twhile(q[mins]>=minn&&mins<=r) mins++;\n\t\twhile(p[maxs]<=maxn&&maxs<=r) maxs++;\n\t\tif(mins<=maxs)\n\t\t{\n\t\t\t\n\t\t\tans=(0ll+ans+1ll*minn*maxn%mod*((1ll*(mid+1-i+1+mins-1-i+1)*(mins-1-(mid+1)+1)/2)%mod))%mod;\n\t\t\tans=(0ll+ans+1ll*maxn*((sum2[maxs-1]-sum2[mins-1]+1ll*(num2[maxs-1]-num2[mins-1])*(mid-i)%mod)%mod))%mod;\n\t\t\tans=(0ll+ans+sum[r]-sum[maxs-1]+1ll*(num[r]-num[maxs-1])*(mid-i)%mod)%mod;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tans=(0ll+ans+1ll*minn*maxn%mod*((1ll*(mid+1-i+1+maxs-1-i+1)*(maxs-1-(mid+1)+1)/2)%mod))%mod;\n\t\t\tans=(0ll+ans+1ll*minn*((sum1[mins-1]-sum1[maxs-1]+1ll*(num1[mins-1]-num1[maxs-1])*(mid-i)%mod)%mod))%mod;\n\t\t\tans=(0ll+ans+sum[r]-sum[mins-1]+1ll*(num[r]-num[mins-1])*(mid-i)%mod)%mod;\n\t\t}\n\t}\n}\nint read()\n{\n\tint x=0,f=1;char ch=getchar();\n\twhile(ch>'9'||ch<'0'){if(ch=='-')f=-1;ch=getchar();}\n\twhile(ch<='9'&&ch>='0'){x=(x<<3)+(x<<1)+(ch^48);ch=getchar();}\n\treturn x*f;\n}\nint main()\n{\n//\tfreopen(\"1.in\",\"r\",stdin);\n//\tfreopen(\"1.out\",\"w\",stdout);\n\tn=read();\n\tfor(int i=1;i<=n;i++) a[i]=read();\n\tsolve(1,n);\n\tprintf(\"%lld\",(ans%mod+mod)%mod);\n\treturn 0;\n}\n//\u73c2\u5b66\u4e07\u5c81\uff01\n//\u73c2\u6735\u8389\u6700\u53ef\u7231\uff01\n//\u6211\u6c38\u8fdc\u559c\u6b22\u73c2\u6735\u8389~\n```",
        "postTime": 1597710666,
        "uid": 97136,
        "name": "chenzida",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P6406 \u3010[COCI2014-2015#2] Norma\u3011"
    },
    {
        "content": "[\u535a\u5ba2](https://gzy-blog.pages.dev/solution-P6406/)\n\n\u63d0\u4f9b\u4e00\u79cd\u7ebf\u6bb5\u6811\u89e3\u6cd5\u3002\n\n\u8bbe $\\min(l,r)$ \u8868\u793a $a_l$ \u81f3 $a_r$ \u7684\u6700\u5c0f\u503c\uff0c$\\max(l,r)$ \u8868\u793a $a_l$ \u81f3 $a_r$ \u7684\u6700\u5927\u503c\u3002\n\n\u9898\u76ee\u8981\u6c42\uff1a\n$$\n\\sum_{l=1}^n \\sum_{r=l}^n (r-l+1)\\min(l,r)\\max(l,r)\n$$\n\n\n\u8003\u8651\u5c06\u5176\u5206\u6210\uff1a\n$$\n\\sum_{l=1}^n \\sum_{r=l}^n (r+1)\\times\\min(l,r)\\max(l,r)-l\\times\\min(l,r)\\max(l,r)\n$$\n\u5373\uff0c\u5bf9\u4e8e\u6bcf\u4e2a $r$ \u6c42\u51fa\uff1a\n$$\n(r+1)\\times\\sum _{l=1}^r \\min(l,r)\\max(l,r)\n$$\n\u5bf9\u4e8e\u6bcf\u4e2a $l$ \u6c42\u51fa\uff1a\n$$\nl\\times\\sum _{r=l}^n \\min(l,r)\\max(l,r)\n$$\n\u8fd9\u4e24\u4e2a\u6c42\u6cd5\u7c7b\u4f3c\uff0c\u4ee5 $r$ \u4e3a\u4f8b\uff1a\n\n\u5047\u8bbe\u73b0\u5728\u7684\u53f3\u7aef\u70b9\u4e3a $r$\uff0c\n\n\u8003\u8651\u7ef4\u62a4\u6570\u7ec4 $mn$ \u548c $mx$\uff0c$mn_i=\\min(i,r),mx_i=\\max(i,r)$\uff0c\n\n\u90a3\u4e48 $r$ \u4f5c\u4e3a\u53f3\u7aef\u70b9\u7684\u7b54\u6848\u5c31\u662f $\\sum_{i=1}^r mn_i\\times mx_i$\u3002\n\n\u8003\u8651\u5c06\u53f3\u7aef\u70b9\u5411\u540e\u79fb\u53d8\u4e3a $r+1$ \u7684\u7b54\u6848\uff0c\n\n\u53ef\u4ee5\u53d1\u73b0\u53ea\u6709\u90e8\u5206\u7684 $mn$ \u548c $mx$ \u53d1\u751f\u4e86\u53d8\u5316\uff0c\n\n\u5177\u4f53\u7684\uff0c\u8bbe $p$ \u4e3a $r+1$ \u5de6\u8fb9\u7b2c\u4e00\u4e2a\u6bd4 $a_{r+1}$ \u5c0f\u7684\u6570\uff0c\u8bbe $q$ \u4e3a $r+1$ \u5de6\u8fb9\u7b2c\u4e00\u4e2a\u6bd4 $a_{r+1}$ \u5927\u7684\u6570\u3002\n\n\uff08$p$ \u548c $q$ \u53ef\u4ee5\u7528\u5355\u8c03\u6808\u6c42\u51fa\uff09\u3002\n\n\u5bb9\u6613\u53d1\u73b0\uff0c$mn$ \u6570\u7ec4\u4ece $p+1$ \u5230 $r+1$ \u90fd\u5e94\u53d8\u4e3a $a_{r+1}$\uff0c$mx$ \u6570\u7ec4\u4ece $q+1$ \u5230 $r+1$ \u90fd\u5e94\u53d8\u4e3a $a_{r+1}$\u3002\n\n\u8003\u8651\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u8fd9\u4e00\u8fc7\u7a0b\uff0c\u5373\u9700\u8981\u652f\u6301\uff1a\n\n- \u533a\u95f4\u8986\u76d6 $mn$\n- \u533a\u95f4\u8986\u76d6 $mx$\n- \u533a\u95f4\u67e5\u8be2 $\\sum_{i=1}^r mn_i \\times mx_i$\n\n$l$ \u7684\u8d21\u732e\u540c\u7406\u3002\n\n\u63d0\u793a\uff1a\u8be5\u9898\u5361\u7a7a\u95f4\n\n\u4ee3\u7801\uff08\u90e8\u5206\u53d8\u91cf\u540d\u548c\u9898\u89e3\u4e0d\u540c\uff09\uff1a\n\n```cpp\n#include<bits/stdc++.h>\n#define ll long long\n#define mid ((l+r)>>1)\nusing namespace std;\nconst int N=5e5+3,p=1e9;\nstruct Val{\n    int sa,sb,sm;\n    Val(){sa=sb=sm=0;}\n};\nVal operator+(Val x,Val y){\n    Val z;\n    z.sa=(x.sa+y.sa)%p;\n    z.sb=(x.sb+y.sb)%p;\n    z.sm=(x.sm+y.sm)%p;\n    return z;\n}\nstruct node{\n    int tga=-1,tgb=-1;\n    Val v;\n    void val(int ta,int tb,int l,int r){\n        if(~ta){\n            tga=ta;\n            v.sa=(ta*1LL*(r-l+1))%p;\n            v.sm=(ta*1LL*v.sb)%p;\n        }\n        if(~tb){\n            tgb=tb;\n            v.sb=(tb*1LL*(r-l+1))%p;\n            v.sm=(tb*1LL*v.sa)%p;\n        }\n    }\n}tr[(N<<2)];\nvoid push_down(int x,int l,int r){\n    tr[x<<1].val(tr[x].tga,tr[x].tgb,l,mid);\n    tr[x<<1|1].val(tr[x].tga,tr[x].tgb,mid+1,r);\n    tr[x].tga=tr[x].tgb=-1;\n}\nvoid push_up(int x)\n    {tr[x].v=tr[x<<1].v+tr[x<<1|1].v;}\nvoid change(int x,int l,int r,int ql,int qr,int ta,int tb){\n    if(l>=ql&&r<=qr){tr[x].val(ta,tb,l,r);return;}\n    if(l>qr||r<ql) return;\n    push_down(x,l,r);\n    change(x<<1,l,mid,ql,qr,ta,tb),\n    change(x<<1|1,mid+1,r,ql,qr,ta,tb);\n    push_up(x);\n}\nVal ask(int x,int l,int r,int ql,int qr){\n    if(l>=ql&&r<=qr) return tr[x].v;\n    if(l>qr||r<ql) return Val();\n    push_down(x,l,r);\n    return ask(x<<1,l,mid,l,r)+ask(x<<1|1,mid+1,r,l,r);\n}\nint a[N],n;\nll ans=0;\nsigned main(){\n    ios::sync_with_stdio(false);\n    cin.tie(0);cout.tie(0);\n    cin>>n;\n    for(int i=1;i<=n;i++) cin>>a[i];\n    stack<int>mn,mx;\n    for(int i=1;i<=n;i++){\n        while(mx.size()&&a[mx.top()]<a[i]) mx.pop();\n        if(mx.size()) change(1,1,n,mx.top()+1,i,a[i],-1);\n        else change(1,1,n,1,i,a[i],-1);\n        mx.push(i);\n        while(mn.size()&&a[mn.top()]>a[i]) mn.pop();\n        if(mn.size()) change(1,1,n,mn.top()+1,i,-1,a[i]);\n        else change(1,1,n,1,i,-1,a[i]);\n        mn.push(i);\n        auto v=ask(1,1,n,1,i);\n        ans=(ans+(v.sm*1LL*(i+1))%p)%p;\n    }\n    while(mn.size()) mn.pop();\n    while(mx.size()) mx.pop();\n    change(1,1,n,1,n,0,0);\n    for(int i=n;i>=1;i--){\n        while(mx.size()&&a[mx.top()]<a[i]) mx.pop();\n        if(mx.size()) change(1,1,n,i,mx.top()-1,a[i],-1);\n        else change(1,1,n,i,n,a[i],-1);\n        mx.push(i);\n        while(mn.size()&&a[mn.top()]>a[i]) mn.pop();\n        if(mn.size()) change(1,1,n,i,mn.top()-1,-1,a[i]);\n        else change(1,1,n,i,n,-1,a[i]);\n        mn.push(i);\n        auto v=ask(1,1,n,i,n);\n        ans=(ans-(v.sm*1LL*i)%p)%p;\n    }\n    cout<<(ans%p+p)%p;\n\n}\n```\n\n",
        "postTime": 1668308196,
        "uid": 238310,
        "name": "2019gzy",
        "ccfLevel": 3,
        "title": "P6406"
    },
    {
        "content": "\u524d\u8bdd\uff1a\u6700\u8fd1\u8001\u5e08\u4fe1\u606f\u8bfe\u4e0a\u8bb2\u4e86\u8fd9\u9053\u9898\uff0c\u5982\u679c\u8001\u5e08\u4e0d\u8bb2\u6211\u80af\u5b9a\u4e0d\u4f1a\u505a\u2026\u2026\u80af\u5b9a\u662f\u5e94\u4e3a\u6211\u592a\u5f31\u4e86\u2026\u2026\u4f46\u786e\u5b9e\u633a\u96be\u60f3\u5230\u7684\u2026\u2026\n\n----\n\n\u8fd9\u9053\u9898\u7684\u6807\u7b7e\u662f\u5206\u6cbb\u4e0e\u9012\u5f52\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u60f3\u4e00\u60f3\u600e\u4e48\u53bb\u505a\u8fd9\u9053\u9898\u3002\u6b63\u5e38\u7684\u5206\u6cbb\u65b9\u6cd5\uff1a\u9012\u5f52\u5de6\u53f3\u533a\u95f4\u7edf\u8ba1\u7b54\u6848\uff0c\u518d\u52a0\u4e0a\u5de6\u533a\u95f4\u5bf9\u53f3\u533a\u95f4\u7684\u8d21\u732e\u3002\u53ef\u662f\u5728\u8fd9\u4e2a\u9898\u76ee\u4e2d\uff0c\u600e\u4e48\u6c42\u4e00\u6bb5\u5de6\u533a\u95f4\u5bf9\u4e8e\u53f3\u533a\u95f4\u7684\u8d21\u732e\u5462\uff1f\n\n\u5047\u8bbe\u6211\u4eec\u8981\u5904\u7406\u533a\u95f4 $[l, r]$\uff0c\u4e2d\u70b9\u4e3a $mid$ , \u8003\u8651\u8fd9\u4e48\u4e00\u4e2a\u4e8b\u60c5\uff1a\u8ba9 $i$ \u4ece $mid$ \u5f80 $l$ \u679a\u4e3e\uff0c\u6bcf\u6b21\u7edf\u8ba1 $i$ \u5bf9 $[mid + 1, r]$ \u7684\u8d21\u732e\u3002\u8bbe\u7f6e $p$ \u548c $q$ \uff0c\u5206\u522b\u8868\u793a $[i, mid]$ \u4e2d\u7684\u6700\u5c0f\u503c\u5927\u4e8e $a_p$ \u7684\u9996\u4e2a $p$ \uff0c$[i,mid]$ \u4e2d\u7684\u6700\u5927\u503c\u5c0f\u4e8e $a_q$ \u7684\u9996\u4e2a $q$ \u3002\n\n\u8fd9\u6837\u8bbe\u7acb\u6709\u4ec0\u4e48\u597d\u5904\u5462\uff1f\u6211\u4eec\u5c31\u53ef\u4ee5\u5206\u4e09\u6bb5\u7edf\u8ba1\u8d21\u732e\uff08\u4e0d\u59a8\u8bbe $p \\leq q$ \uff0c\u53cd\u4e4b\u4ea6\u7136\uff09\uff0c\u5206\u522b\u662f:\n\n1.$[mid, p-1]$ \n\n2.$[p, q - 1]$ \n\n3.$[q, mid]$ \u3002\n\n\u6211\u4eec\u8bbe $mn$ \u4e3a $[i,mid]$ \u4e2d\u7684\u6700\u5c0f\u503c\uff0c $mx$ \u4e3a $[i, mid]$ \u4e2d\u7684\u6700\u5927\u503c\uff0c$calc(l,r)$ \u4e3a $\\frac{(l + r) (r - l + 1)}{2}$ \uff08\u5c0f\u5b66\u7684\u9ad8\u65af\u6c42\u548c\uff0c\u8fd8\u8bb0\u5f97\u5417\uff09\n\n----\n\n\u5bf9\u4e8e\u60c5\u51b5 1 \u5c31\u5f88\u597d\u8ba8\u8bba\uff0c\u56e0\u4e3a $mn$ \u548c $mx$ \u90fd\u76f8\u7b49\uff0c\u6240\u4ee5\u8d21\u732e\u5c31\u4e3a\uff1a\n\n$mn \\times mx \\times calc(mid + 1,p - 1)$\n\n\u5bf9\u4e8e\u60c5\u51b5 2, 3 \u590d\u6742\u4e00\u70b9\uff0c$mn$ \u76f8\u7b49\uff0c$mx$ \u53ef\u4ee5\u7528\u524d\u7f00\u548c\u7ef4\u62a4\uff08\u53ef\u4ee5\u81ea\u884c\u7406\u89e3\uff1f\uff09\n\n------\n\n\u4f60\u4f1a\u4e86\u5417\uff01\n\n\u7531\u4e8e\u60c5\u51b5 2, 3 \u4e0d\u592a\u597d\u63cf\u8ff0\uff0c\u6211\u628a\u8fd9\u4e00\u5757\u7684\u524d\u7f00\u548c\u4ee3\u7801\u548c\u60c5\u51b5 2, 3 \u7684\u5173\u952e\u4ee3\u7801\u8d34\u5230\u8fd9\u91cc\u3002\n\n\u524d\u7f00\u548c\u7ef4\u62a4\uff1a\n\n~~~\nsum[i][0] = (sum[i - 1][0] + mn) % mod;\nsum[i][1] = (sum[i - 1][1] + mn * i) % mod;\nsum[i][2] = (sum[i - 1][2] + mx) % mod;\nsum[i][3] = (sum[i - 1][3] + mx * i) % mod;\nsum[i][4] = (sum[i - 1][4] + mn * mx) % mod;\nsum[i][5] = (sum[i - 1][5] + mn * mx % mod * i) % mod;\n~~~\n\n\u60c5\u51b52\uff1a\n\n~~~\nans = (ans + mx * (sum[q - 1][1] - sum[p - 1][1]) % mod) % mod;\nans = (ans - (i - 1) * (sum[q - 1][0] - sum[p - 1][0]) % mod * mx % mod + mod) % mod;\n~~~\n\n\u60c5\u51b53\uff1a\n\n~~~\nans = (ans + (sum[r][5] - sum[q - 1][5])) % mod;\nans = (ans - (sum[r][4] - sum[q - 1][4]) * (i - 1) % mod + mod) % mod;\n~~~\n\u4ee5\u4e0a\u4ee3\u7801\u5747\u5df2 $p \\leq q$ \u4e3a\u524d\u63d0\uff0c\u53cd\u4e4b\u4ea6\u7136\u3002\n\n\u4e0a\u9762\u7684\u4ee3\u7801\u8fd8\u662f\u5f88\u6709\u601d\u7ef4\u96be\u5ea6\u7684\uff0c\u5982\u679c\u6ca1\u6709\u5b8c\u5168\u7406\u89e3\u4e00\u5b9a\u8981\u591a\u770b\u51e0\u904d\uff0c\u786e\u4fdd\u7406\u89e3\u4e86\u8ba1\u7b97\u8d21\u732e\u7684\u8fc7\u7a0b\u3002\n\n\u8fd9\u9053\u9898\u8fd8\u6709\u5f88\u591a\u5c0f\u7ec6\u8282\u9700\u8981\u6ce8\u610f\uff0c\u4ec0\u4e48\u53d6\u6a21\u5566\uff0c\u9884\u5904\u7406\u554a\u4e4b\u7c7b\u7684\uff0c\u5343\u4e07\u4e0d\u8981\u5927\u610f\u3002\n\n\u8fd9\u91cc\u5c31\u628a\u4ee3\u7801\u8d34\u51fa\u6765\uff1a\n\n```\n#include<bits/stdc++.h>\n#define int long long\nusing namespace std;\n\nint n, ans, mod = 1e9, a[5000005];\nint sum[5000005][6];\nint calc(int l, int r) {\n\treturn (l + r) * (r - l + 1) / 2 % mod;\n}\nvoid solve(int l, int r) {\n\tif (l == r) {\n\t\tans = (ans + a[l] * a[l] % mod) % mod;\n\t\treturn ;\n\t}\n\tint mid = (l + r) >> 1;\n\tsolve(l, mid), solve(mid + 1, r);\n\tmemset(sum[mid], 0, sizeof sum[mid]);\n\tint mn, mx, p, q;\n\tmn = mx = a[mid + 1], p = q = mid + 1;\n\tfor (int i = mid + 1; i <= r; i++) {\n\t\tmn = min(mn, a[i]);\n\t\tmx = max(mx, a[i]);\n\t\tsum[i][0] = (sum[i - 1][0] + mn) % mod;\n\t\tsum[i][1] = (sum[i - 1][1] + mn * i) % mod;\n\t\tsum[i][2] = (sum[i - 1][2] + mx) % mod;\n\t\tsum[i][3] = (sum[i - 1][3] + mx * i) % mod;\n\t\tsum[i][4] = (sum[i - 1][4] + mn * mx) % mod;\n\t\tsum[i][5] = (sum[i - 1][5] + mn * mx % mod * i) % mod;\n\t}\n\tmn = mx = a[mid];\n\tfor (int i = mid; i >= l; i--) {\n\t\tmn = min(mn, a[i]);\n\t\tmx = max(mx, a[i]);\n\t\twhile (p <= r && a[p] > mn) p++;\n\t\twhile (q <= r && a[q] < mx) q++;\n\t\tif (p < q) {\n\t\t\tans = (ans + calc(mid + 1 - i + 1, p - 1 - i + 1) * mn % mod * mx) % mod;\n\t\t\tans = (ans + mx * (sum[q - 1][1] - sum[p - 1][1]) % mod) % mod;\n\t\t\tans = (ans - (i - 1) * (sum[q - 1][0] - sum[p - 1][0]) % mod * mx % mod + mod) % mod;\n\t\t\tans = (ans + (sum[r][5] - sum[q - 1][5])) % mod;\n\t\t\tans = (ans - (sum[r][4] - sum[q - 1][4]) * (i - 1) % mod + mod) % mod;\n\t\t}\n\t\telse {\n\t\t\tans = (ans + calc(mid + 1 - i + 1, q - 1 - i + 1) * mx % mod * mn) % mod;\n\t\t\tans = (ans + mn * (sum[p - 1][3] - sum[q - 1][3]) % mod) % mod;\n\t\t\tans = (ans - (i - 1) * (sum[p - 1][2] - sum[q - 1][2]) % mod * mn % mod + mod) % mod;\n\t\t\tans = (ans + (sum[r][5] - sum[p - 1][5])) % mod;\n\t\t\tans = (ans - (sum[r][4] - sum[p - 1][4]) * (i - 1) % mod + mod) % mod;\n\t\t}\n\t}\n}\n\nsigned main() {\n\tscanf(\"%lld\", &n);\n\tfor (int i = 1; i <= n; i++) {\n\t\tscanf(\"%lld\", &a[i]);\n\t}\n\tsolve(1, n);\n\tprintf(\"%lld\", ans); \n    return 0;\n}\n```\n\n\u6211\u592a\u5f31\u4e86\u2026\u2026",
        "postTime": 1653577626,
        "uid": 603435,
        "name": "rubbishZ",
        "ccfLevel": 0,
        "title": "\u4e00\u9053\u5f88\u6050\u6016\u7684\u5206\u6cbb\u9898"
    },
    {
        "content": "$$\\texttt{Preface}$$\n\n\u5b66\u6570\u636e\u7ed3\u6784\u5b66\u574f\u8111\u5b50\uff0c\u53ea\u4f1a\u65e0\u8111\u7ebf\u6bb5\u6811\u4e86\u3002\n\n$$\\texttt{Description}$$\n\n[P6406 [COCI2014-2015#2] Norma](https://www.luogu.com.cn/problem/P6406)\n\n$$\\texttt{Solution}$$\n\n\u8bbe $\\max(l, r) = \\max\\{a_l, a_{l+1},\\cdots, a_r\\},\\min(l,r)=\\min\\{a_l,a_{l+1},\\cdots,a_r\\}$\u3002\n\n\u770b\u5230\u8fd9\u79cd\u5bf9\u4e8e\u6240\u6709\u533a\u95f4\u6c42\u4e00\u4e2a\u5f0f\u5b50\u7684\u548c\uff0c\u6211\u4eec\u53ef\u4ee5\u5957\u8def\u5730\u8f6c\u6362\u6210\u679a\u4e3e $r$\uff0c\u6c42\u51fa\uff1a\n\n$$\\sum_{l = 1}^r \\max(l,r)\\times \\min(l,r) \\times(r-l+1)$$\n\n\u6211\u4eec\u53ef\u4ee5\u7528\u4e24\u4e2a\u5355\u8c03\u6808\uff0c\u8fd9\u6837\u6c42 $\\max(l,r)$ \u548c $\\min(l,r)$ \u5c31\u53d8\u6210\u4e86\u533a\u95f4\u52a0\u6216\u8005\u533a\u95f4\u8986\u76d6\u4e86\u3002\n\n\u7136\u540e\u8003\u8651 $(r-l+1)$\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u5b83\u62c6\u6210 $r+1$ \u548c $-l$\uff0c\u8fd9\u6837\u6211\u4eec\u53ea\u9700\u8981\u5206\u522b\u7ef4\u62a4\uff1a\n\n$$\\sum_{i = 1}^r \\max(i, r)\\times \\min(i,l)$$\n\n$$\\sum_{i = 1}^r \\max(i, r)\\times \\min(i,l) \\times i$$\n\n\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u5373\u53ef\uff0c\u540e\u9762\u90a3\u4e2a\u5f0f\u5b50\u4e0b\u4f20\u61d2\u6807\u8bb0\u65f6\u9700\u8981\u7528\u5230\u7b49\u5dee\u6570\u5217\u6c42\u548c\u516c\u5f0f\u3002\n\n$$\\texttt{Code}$$\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\nconstexpr int mod = 1e9;\nint n, a[500005], ans = 0;\nstruct node {\n\tint l, r, sa1, sb1, sa2, sb2, ans1, ans2;\n} tr[2000005];\nstruct tag {\n\tint a1, a2;\n} lazy[2000005];\n#define ls (p * 2)\n#define rs (p * 2 + 1)\nvoid pushup(int p) {\n\ttr[p].sa1 = (tr[ls].sa1 + tr[rs].sa1) % mod;\n\ttr[p].sb1 = (tr[ls].sb1 + tr[rs].sb1) % mod;\n\ttr[p].sa2 = (tr[ls].sa2 + tr[rs].sa2) % mod;\n\ttr[p].sb2 = (tr[ls].sb2 + tr[rs].sb2) % mod;\n\ttr[p].ans1 = (tr[ls].ans1 + tr[rs].ans1) % mod;\n\ttr[p].ans2 = (tr[ls].ans2 + tr[rs].ans2) % mod; \n}\nvoid build(int p, int l, int r) {\n\ttr[p].l = l, tr[p].r = r;\n\ttr[p].sa1 = tr[p].sb1 = tr[p].sa2 = tr[p].sb2 = 0;\n\ttr[p].ans1 = tr[p].ans2 = 0;\n\tif (l == r) return ;\n\tint mid = (l + r) / 2;\n\tbuild(ls, l, mid), build(rs, mid + 1, r);\n}\nvoid add(int &x, int y) {\n\tx += y;\n\tif (x >= mod) x -= mod;\n}\nvoid add_tag(int p, tag t) {\n\tif (t.a1) {\n\t\tadd(lazy[p].a1, t.a1);\n\t\tadd(tr[p].ans1, 1ll * tr[p].sb1 * t.a1 % mod);\n\t\tadd(tr[p].ans2, 1ll * tr[p].sb2 * t.a1 % mod);\n\t\tadd(tr[p].sa1, 1ll * (tr[p].r - tr[p].l + 1) * t.a1 % mod);\n\t\tadd(tr[p].sa2, 1ll * (tr[p].l + tr[p].r) * (tr[p].r - tr[p].l + 1) / 2 % mod * t.a1 % mod);\n\t}\n\tif (t.a2) {\n\t\tadd(lazy[p].a2, t.a2);\n\t\tadd(tr[p].ans1, 1ll * tr[p].sa1 * t.a2 % mod);\n\t\tadd(tr[p].ans2, 1ll * tr[p].sa2 * t.a2 % mod);\n\t\tadd(tr[p].sb1, 1ll * (tr[p].r - tr[p].l + 1) * t.a2 % mod);\n\t\tadd(tr[p].sb2, 1ll * (tr[p].l + tr[p].r) * (tr[p].r - tr[p].l + 1) / 2 % mod * t.a2 % mod);\n\t}\n}\nvoid pushdown(int p) {\n\tif (lazy[p].a1 or lazy[p].a2) {\n\t\tadd_tag(ls, lazy[p]);\n\t\tadd_tag(rs, lazy[p]);\n\t\tlazy[p] = (tag){0, 0};\n\t}\n}\nvoid update(int p, int x, int y, tag t) {\n\tif (tr[p].l >= x && tr[p].r <= y) {\n\t\treturn add_tag(p, t), void();\n\t}\n\tpushdown(p);\n\tint mid = (tr[p].l + tr[p].r) / 2;\n\tif (x <= mid) update(ls, x, y, t);\n\tif (mid < y) update(rs, x, y, t);\n\tpushup(p);\n}\n#undef ls\n#undef rs\nint main() {\n\tios :: sync_with_stdio(0), cin.tie(0);\n\tcin >> n;\n\tfor (int i = 1; i <= n; ++i) {\n\t\tcin >> a[i];\n\t}\n\tbuild(1, 1, n);\n\tstack <int> sta1, sta2;\n\tsta1.push(0), sta2.push(0);\n\tfor (int i = 1; i <= n; ++i) {\n\t\twhile (sta1.top() && a[ sta1.top() ] <= a[i]) {\n\t\t\tint x = sta1.top(), val = a[ sta1.top() ]; sta1.pop();\n\t\t\tupdate(1, sta1.top() + 1, x, (tag){a[i] - val, 0});\n\t\t}\n\t\tsta1.push(i), update(1, i, i, (tag){a[i], 0});\n\t\twhile (sta2.top() && a[ sta2.top() ] >= a[i]) {\n\t\t\tint x = sta2.top(), val = a[ sta2.top() ]; sta2.pop();\n\t\t\tupdate(1, sta2.top() + 1, x, (tag){0, a[i] - val + mod});\n\t\t}\n\t\tsta2.push(i), update(1, i, i, (tag){0, a[i]});\n\t\t(ans += (1ll * tr[1].ans1 * (i + 1) % mod - tr[1].ans2 + mod) % mod) %= mod;\n\t}\n\tcout << ans << '\\n';\n\treturn 0;\n}\n```\n\n$$\\texttt{Thanks for watching!}$$",
        "postTime": 1674009095,
        "uid": 355448,
        "name": "Fido_Puppy",
        "ccfLevel": 0,
        "title": "P6406 [COCI2014-2015#2] Norma"
    },
    {
        "content": "\u4e00\u773c\u4e01\u771f\uff1a\u9274\u5b9a\u4e3a\u7801\u91cf+\u63a8\u5f0f\u5b50\u9898\n## \u601d\u8def\n### 40pts\n\u9884\u5904\u7406\u4e00\u4e0b ST \u8868\uff0c $O(n^2)$ \u679a\u4e3e\u5de6\u53f3\u7aef\u70b9\uff0cST \u8868 $O(1)$ \u67e5\u4e00\u4e0b\u6700\u503c\uff0c\u603b\u7684\u590d\u6742\u5ea6\u662f $O(n^2)$ \u7684\u3002\n\n### 100pts\n\n\u8003\u8651\u66b4\u529b\u5206\u6cbb\u3002\n\n\u6bcf\u6b21\u5c06\u533a\u95f4 $[l,r]$ \u5206\u6210 $[l,mid]$ \u548c $[mid+1,r]$\uff0c\u9012\u5f52\u8ba1\u7b97\u8d21\u732e\u3002\n\n\u6240\u4ee5\u95ee\u9898\u8f6c\u5316\u6210\u4e3a\u4e86\u5982\u4f55\u6c42 $L \\in [l,mid]$ \u4e14 $R \\in [mid+1,r]$ \u7684\u533a\u95f4\u7684\u8d21\u732e\u3002\n\n\u6211\u4eec\u53d1\u73b0\uff0c\u5bf9\u4e8e\u56fa\u5b9a\u7684\u53f3\u7aef\u70b9\uff0c\u968f\u7740\u5de6\u7aef\u70b9\u7684\u53d8\u5c0f\uff0c\u533a\u95f4\u7684\u6700\u5c0f\u503c\u5355\u8c03\u4e0d\u589e\uff0c\u533a\u95f4\u7684\u6700\u5927\u503c\u5355\u8c03\u4e0d\u964d\u3002\n\n\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u679a\u4e3e\u53f3\u7aef\u70b9\u8ba1\u7b97\u8d21\u732e\u3002\n\n\u5047\u8bbe\u6211\u4eec\u5206\u6cbb\u5230 $[l,r]$ \uff0c\u76ee\u524d\u8981\u8ba1\u7b97\u8d21\u732e\u7684\u533a\u95f4\u662f $[L,R]$ \uff0c\u8fd9\u4e2a\u533a\u95f4\u7684\u6700\u5c0f\u503c\u548c\u6700\u5927\u503c\u7531\u4e24\u90e8\u5206\u7ec4\u6210\uff1a $[L,mid]$ \u548c $[mid+1,R]$\u3002\n\n\u6211\u4eec\u628a\u533a\u95f4\u5206\u4e3a\u4e09\u6bb5\n1. \u533a\u95f4\u6700\u5927\u503c\u548c\u6700\u5c0f\u503c\u90fd\u7531 $[mid+1,R]$ \u51b3\u5b9a\n1. \u533a\u95f4\u6700\u5927\u503c\u548c\u6700\u5c0f\u503c\u5176\u4e2d\u4e00\u4e2a\u7531 $[L,mid]$ \u51b3\u5b9a\n1. \u533a\u95f4\u6700\u5927\u503c\u548c\u6700\u5c0f\u503c\u90fd\u7531 $[L,mid]$ \u51b3\u5b9a\n\n\u56e0\u4e3a\u6700\u503c\u662f\u5355\u8c03\u7684\uff0c\u6240\u4ee5\u6bcf\u6bb5\u4e00\u5b9a\u662f\u8fde\u7eed\u7684\uff0c\u6240\u4ee5\u53ef\u4ee5\u5206\u5f00\u8ba1\u7b97\u8d21\u732e\u3002\n\n\u6211\u4eec\u5728\u679a\u4e3e\u53f3\u7aef\u70b9\u7684\u8fc7\u7a0b\u4e2d\u8bb0\u5f55 $[mid+1,R]$ \u7684\u6700\u5927\u503c $Max$ \u548c\u6700\u5c0f\u503c $Min$\u3002\n\n\u4ee4\uff1a\n\n$lmin_i$ \u8868\u793a $\\min_{j=i}^{mid}a_j$\n\n${lmax}_i$ \u8868\u793a $\\max_{j=i}^{mid}a_j$\n\n\u7b2c\u4e00\u7c7b\u7684\u8d21\u732e\u4e3a $\\sum_{i=p1}^{mid}(R-i+1)\\times Min \\times Max$\n\n\u7b2c\u4e8c\u7c7b\u7684\u8d21\u732e\u5206\u4e3a\u4e24\u79cd\uff1a\n\n$\\sum_{i=p2}^{p1}(R-i+1)\\times lmin_i \\times Max$\n\n$\\sum_{i=p2}^{p1-1}(R-i+1)\\times {lmax}_i \\times Min$\n\n\u7b2c\u4e09\u7c7b\u7684\u8d21\u732e\u4e3a $\\sum_{i=l}^{p2-1}(R-i+1)\\times lmin_i \\times {lmax}_i$\n\n\u5176\u4e2d $p1,p2$ \u5206\u522b\u4e3a\u7b2c\u4e00\u7c7b\u533a\u95f4\u548c\u7b2c\u4e8c\u7c7b\u533a\u95f4\u3001\u7b2c\u4e8c\u7c7b\u533a\u95f4\u548c\u7b2c\u4e09\u7c7b\u533a\u95f4\u7684\u5206\u754c\u70b9\u3002\n\n\u5bf9\u4e8e\u6bcf\u6b21 $R\\gets R+1$ \u65f6\uff0c\u7528\u7c7b\u4f3c\u53cc\u6307\u9488\u7684\u601d\u60f3\uff0c\u66b4\u529b\u79fb\u52a8 $p1,p2$\u3002\n\n\u4f46\u8fd9\u6837\u65e0\u6cd5\u505a\u5230\u8ba1\u7b97\u8d21\u732e\u65f6 $O(1)$\u3002\n\n\u6211\u4eec\u8003\u8651\u62c6\u5f00\u5f0f\u5b50\u7528\u524d\u7f00\u548c\u7ef4\u62a4\u3002\n\n\u5bf9\u4e8e\u7b2c\u4e00\u7c7b\n\n$Min\\times Max \\times((R+1)\\times(mid-p1+1)-\\sum_{i=p1}^{mid}i)$\n\n\u7ef4\u62a4 $i$ \u7684\u524d\u7f00\u548c\u5373\u53ef\u3002\n\n\u5bf9\u4e8e\u7b2c\u4e8c\u7c7b\n\n$Min \\times ((R+1)\\sum_{i=p2}^{p1-1}lmax_i-\\sum_{i=p2}^{p1-1}i\\times {lmax}_i)$\n\n\u7ef4\u62a4 ${lmax}_i$ \u548c $i\\times {lmax}_i$ \u7684\u524d\u7f00\u548c\u5373\u53ef\uff0c\u53e6\u4e00\u79cd\u540c\u7406\u3002\n\n\u5bf9\u4e8e\u7b2c\u4e09\u7c7b\n\n$(R+1)\\sum_{i=l}^{p2-1}lmin_i\\times {lmax}_i-\\sum_{i=l}^{p2-1}i\\times lmin_i \\times {lmax}_i$\n\n\u7ef4\u62a4 $lmin_i \\times {lmax}_i$ \u548c $i\\times lmin_i \\times {lmax}_i$ \u7684\u524d\u7f00\u548c\u5373\u53ef\u3002\n\n\u8fd9\u6837\u5c31\u505a\u5230\u4e86\u6bcf\u5c42\u590d\u6742\u5ea6 $O(n)$ \uff0c\u603b\u590d\u6742\u5ea6 $O(n\\log n)$ \u4e86\u3002\n\n## Code\n```cpp\n#include<bits/stdc++.h>\n#define int long long\nusing namespace std;\nconst int N=500005;\nconst int Mod=1e9;\nint n,ans;\nint a[N],s[N],lmin[N],slmin[N],lmax[N],slmax[N];\nint f[N];//l*Min\nint g[N];//l*Max\nint h[N];//l*Min*Max;\nint sx[N],sy[N];\nvoid solve(int l,int r){\n    if(l==r){\n        ans=(ans+a[l]*a[l]%Mod)%Mod;\n        return;\n    }\n    int mid=(l+r)>>1;\n    solve(l,mid);\n    solve(mid+1,r);\n    lmin[mid+2]=0x7f7f7f7f;\n    lmax[mid+2]=slmax[mid+2]=slmin[mid+2]=0; \n    f[l-1]=g[l-1]=h[l-1]=sx[l-1]=0;\n    for(int i=mid+1;i>=l;i--){\n        lmin[i]=min(lmin[i+1],a[i]);\n        lmax[i]=max(lmax[i+1],a[i]);\n        slmin[i]=(i!=mid+1?slmin[i+1]:0)+lmin[i];\n        slmax[i]=slmax[i+1]+lmax[i];\n    }\n    for(int i=l;i<=mid+1;i++){\n        f[i]=(f[i-1]+i*lmin[i]%Mod)%Mod;\n        g[i]=(g[i-1]+i*lmax[i]%Mod)%Mod;\n        h[i]=(h[i-1]+i*lmin[i]%Mod*lmax[i]%Mod)%Mod;\n        sx[i]=(sx[i-1]+lmin[i]*lmax[i]%Mod)%Mod;\n    }\n    int Min=a[mid+1],Max=a[mid+1];\n    int p1=mid;\n    while(lmin[p1]>=Min&&lmax[p1]<=Max&&p1>=l) p1--;\n    p1++;\n    int p2=p1-1;\n    while(!(lmin[p2]<Min&&lmax[p2]>Max)&&p2>=l) p2--;\n    p2++;\n\tfor(int R=mid+1;R<=r;R++){\n        Min=min(Min,a[R]);\n        Max=max(Max,a[R]);\n        if(R!=mid+1){\n            while(lmin[p1]>=Min&&lmax[p1]<=Max&&p1>=l) p1--;\n            p1++;\n            while(!(lmin[p2]<Min&&lmax[p2]>Max)&&p2>=l) p2--;\n            p2++;\n        }\n        if(p1!=mid+1) ans=(ans+((R+1)*(mid-p1+1)%Mod*Min%Mod*Max%Mod-((s[mid]-s[p1-1]+Mod)%Mod)*Min%Mod*Max%Mod+Mod)%Mod)%Mod;\n        if(lmin[p2]<Min) ans=(ans+((R+1)*((slmin[p2]-slmin[p1]+Mod)%Mod)%Mod-(f[p1-1]-f[p2-1]+Mod)%Mod+Mod)%Mod*Max%Mod)%Mod;\n        else if(lmax[p2]>Max) ans=(ans+((R+1)*((slmax[p2]-slmax[p1]+Mod)%Mod)%Mod-(g[p1-1]-g[p2-1]+Mod)%Mod+Mod)%Mod*Min%Mod)%Mod;\n        ans=(ans+((R+1)*((sx[p2-1]-sx[l-1]+Mod)%Mod)%Mod-(h[p2-1]-h[l-1]+Mod)%Mod+Mod)%Mod)%Mod;\n    }\n}\nsigned main(){\n    scanf(\"%lld\",&n);\n    for(int i=1;i<=n;i++){\n        scanf(\"%lld\",&a[i]);\n        s[i]=(s[i-1]+i)%Mod;\n    }\n    solve(1,n);\n    printf(\"%lld\\n\",ans);\n    return 0;\n}\n\n```\n",
        "postTime": 1677412312,
        "uid": 100690,
        "name": "kawaii__yuyu",
        "ccfLevel": 0,
        "title": "P6406 [COCI2014-2015#2] Norma \u9898\u89e3"
    }
]