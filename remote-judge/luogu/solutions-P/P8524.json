[
    {
        "content": "### Part1 \u9898\u610f\u7b80\u8ff0\uff1a\n\u4e09\u4e2a\u64cd\u4f5c\uff1a\u533a\u95f4\u6309\u4f4d\u53f3\u79fb\uff0c\u590d\u5236\uff0c\u6c42\u548c\u3002\n\n$n,m\\le3\\times10^6,C\\le10^9$\uff0c$C$ \u4e3a\u503c\u57df\uff0c\u4ee5\u4e0b\u5747\u540c\u3002\n\n### Part2 \u524d\u7f6e\u77e5\u8bc6\uff1a\n[\u53ef\u6301\u4e45\u5316 WBLT](/blog/cjxdesmall/good-merge-wblt)\uff1b[\u82b1\u795e\u6e38\u5386\u5404\u56fd](/problem/P4145)\u3002\n\n### Part3 \u6b63\u9898\uff1a\n\u5982\u679c\u6ca1\u6709\u590d\u5236\u64cd\u4f5c\uff0c\u5c31\u53ef\u4ee5\u66b4\u529b\u53f3\u79fb\u975e\u96f6\u6570\uff0c\u590d\u6742\u5ea6 $O(n\\log_2n\\log_2C)$\uff0c\u4f46\u6709\u590d\u5236\u64cd\u4f5c\uff0c\u5c31\u4f1a\u5f71\u54cd\u52bf\u80fd\uff0c\u65f6\u95f4\u9000\u5316\u6210 $O(nm)$\u3002\n\n\u4f7f\u7528\u53ef\u6301\u4e45\u5316\u5e73\u8861\u6811\u7ef4\u62a4\u590d\u5236\u64cd\u4f5c\uff0c\u4f9d\u65e7\u8003\u8651\u6bcf\u4e00\u4e2a\u6570\u6700\u591a\u53f3\u79fb $\\log_2C$ \u6b21\uff0c\u8fd9\u6837\u53ef\u4ee5\u6811\u4e0a\u6bcf\u4e00\u4e2a\u8282\u70b9\u5b58\u50a8\u53f3\u79fb $[0,\\log_2C]\\cap Z$ \u6b21\u7684\u7ed3\u679c\uff0c\u800c\u6bcf\u4e00\u6b21\u64cd\u4f5c\u4f1a\u591a\u51fa $O(\\log_2n)$ \u4e2a\u8282\u70b9\uff0c\u8fd9\u6837\u7a7a\u95f4\u590d\u6742\u5ea6\u662f $O(m\\log_2n\\log_2C)$ \u7684\uff0c\u4e0d\u80fd\u901a\u8fc7\u3002\n\n\u5982\u679c\u6bcf\u9694 $\\frac{m}{\\log_2n}$ \u6b21\u64cd\u4f5c\u5c31\u641c\u51fa\u6240\u6709\u8282\u70b9\uff0c\u7136\u540e\u91cd\u6784\uff0c\u5c31\u53ef\u4ee5\u505a\u5230\u7a7a\u95f4 $O(n\\log_2C)$\uff0c\u4f46\u662f\u65f6\u95f4\u6709 $O((n+m)\\log_2n\\log_2C)$\uff0c\u5230\u8fd9\u91cc\uff0c\u5982\u679c\u5b9e\u73b0\u5f97\u597d\u4e00\u4e9b\u5df2\u7ecf\u53ef\u4ee5\u901a\u8fc7\u4e86\u3002\n\n\u8fd9\u91cc\u6709\u4e00\u4e2a\u5c0f\u95ee\u9898\uff0c\u5c31\u662f\u672c\u9898\u7ed9\u7684\u65f6\u95f4\u548c\u7a7a\u95f4\u6781\u5ea6\u4e0d\u5e73\u8861\uff0c\u5149\u5efa\u7acb\u5e73\u8861\u6811\u5c31\u5fc5\u987b $n\\log_2C$ \u4e2a `long long`\uff0c\u800c\u8fd9\u6837\u7684\u7a7a\u95f4\u5df2\u7ecf\u8fbe\u5230\u4e86 $750MB$,\u663e\u7136\u5f00\u4e0d\u4e0b\u3002\n\n\u8003\u8651\u5728\u5efa\u6811\u65f6\u5e95\u5c42\u5206\u5757\uff0c\u5982\u679c\u533a\u95f4\u957f\u5ea6\u5c11\u4e8e $\\log_2C$\uff0c\u5c31\u5c06\u6574\u4e2a\u533a\u95f4\u5f53\u4f5c\u4e00\u4e2a\u8282\u70b9\uff0c\u8fd9\u6837\u4e00\u68f5\u5168\u65b0\u7684\u6811\u7a7a\u95f4\u662f $O(n)$ \u7684\u3002\n\n\u4e00\u68f5\u53ef\u7231\u7684 $\\text{WBLT}$\uff1a\n```cpp\nul sm[M][33],ans;\nD n,q,a[N],t[M][2];\n#define ls t[x][0]\n#define rs t[x][1]\nD g[M],cnt,F[M],ft;\nD sz[M],L[M],b[N],rt;\ninline void cp(D &x){\n    if(F[x]==ft)return;\n    F[++cnt]=ft;L[cnt]=L[x];\n    g[cnt]=g[x],sz[cnt]=sz[x];\n    t[cnt][0]=ls,t[cnt][1]=rs;\n    for(D i=0;i<=30;++i)\n        sm[cnt][i]=sm[x][i];\n    x=cnt;\n}inline void add(D &x,D ta){\n    cp(x),g[x]=min(g[x]+ta,30u);\n}\ninline void pp(D x){\n    sz[x]=sz[ls]+sz[rs];\n    L[x]=L[ls]+L[rs];\n    for(D i=0;i<=30;++i){\n        sm[x][i]=0;\n        if(i+g[ls]<=30)sm[x][i]+=sm[ls][i+g[ls]];\n        if(i+g[rs]<=30)sm[x][i]+=sm[rs][i+g[rs]];\n    }\n}inline void pd(D &x){\n    if(g[x]&&sz[x]>1){\n        cp(x),add(ls,g[x]);\n        add(rs,g[x]);\n        for(D i=30-g[x];~i;--i)\n            sm[x][i]=sm[x][i+g[x]];\n        for(D i=30-g[x]+1;i<=30;++i)\n            sm[x][i]=0;\n        g[x]=0;\n    }\n}\nD spt(D x,D l,D r){\n    if(!x||l>r)return 0;\n    if(l==1&&r==L[x])return x;\n    if(sz[x]==1){\n        g[++cnt]=g[x],L[cnt]=r-l+1,sz[cnt]=1;\n        t[cnt][0]=ls+l-1,t[cnt][1]=ls+r-1;\n        F[x=cnt]=ft;D i,j;\n        for(i=0;i<=30;++i)\n            for(sm[x][i]=0,j=ls;j<=rs;++j)\n                sm[x][i]+=a[j]>>i;\n        return x;\n    }else{\n        cp(x),pd(x);\n        if(r<=L[ls])return spt(ls,l,r);\n        else if(l>L[ls])return spt(rs,l-L[ls],r-L[ls]);\n        else{\n            rs=spt(rs,1,r-L[ls]),ls=spt(ls,l,L[ls]);\n            pp(x);return x;\n        }\n    }exit(100000);return 1e9;\n}\nD build(D l,D r){\n    D x=++cnt;F[x]=ft,g[x]=0,L[x]=r-l+1;\n    if(r-l<30){\n        ls=l,rs=r,sz[x]=1;D i,j;\n        for(i=0;i<=30;++i)\n            for(sm[x][i]=0,j=l;j<=r;++j)\n                sm[x][i]+=a[j]>>i;\n    }else{\n        D md=l+r>>1;ls=build(l,md);\n        rs=build(md+1,r);pp(x);\n    }return x;\n}\nvoid dfs(D x,D dat=0){\n    dat=min(dat+g[x],30u);\n    if(sz[x]>1){\n        dfs(ls,dat),dfs(rs,dat);\n    }else{\n        for(D i=ls;i<=rs;++i)\n            b[++n]=a[i]>>dat;\n    }\n}\nD mg(D L,D R){\n    if(!L||!R)return L|R;\n    D x=sz[L]>sz[R]?L:R,sm=sz[L]+sz[R];\n    if(sz[x]<ra*sm){\n        g[x=++cnt]=0,F[x]=ft;\n        ls=L,rs=R,pp(x);\n        return x;\n    }if(x==L){\n        cp(x),pd(x);\n        if(sz[ls]>af*sm){\n            rs=mg(rs,R),pp(x),g[x]=0;\n            return x;\n        }else{\n            D y=rs;cp(y),pd(y);\n            return mg(mg(ls,t[y][0]),mg(t[y][1],R));\n        }\n    }else{\n        cp(x),pd(x);\n        if(sz[rs]>af*sm){\n            ls=mg(L,ls),pp(x),g[x]=0;\n            return x;\n        }else{\n            D y=ls;cp(y),pd(y);\n            return mg(mg(L,t[y][0]),mg(t[y][1],rs));\n        }\n    }exit(1000000);return 1e9;\n}\n```\n\n### Part4 \u5173\u4e8e\u5e38\u6570\n\u663e\u7136\u5728\u6ca1\u4ec0\u4e48\u4eba\u63d0\u4ea4\u65f6\u6211\u4e00\u53d1\u5f97\u5230\u4e86\u6700\u4f18\u89e3 $(2022.9.29)$\uff0c\u65f6\u95f4\u6700\u5feb $1.70min$\uff0c\u7a7a\u95f4\u6700\u5c0f $160MB$\uff0c\u7531\u6b64\u53ef\u89c1\uff0c\u5e38\u6570\u4f18\u79c0\u7684 $\\text{WBLT}$ \u8ba9\u6211\u4eec\u4e0d\u518d\u9700\u8981\u5361\u5e38\u3002\u65f6\u9650\u592a\u53d8\u6001\u4e86\uff0c\u7f29\u5230 $30s$ \u600e\u4e48\u6837\uff1f\u6216\u8005\u628a\u7a7a\u95f4\u653e\u5230 $200MB$?\u4e0d\u7136\u8fd9\u5c31\u662f\u4e00\u4e2a\u5b8c\u5168\u4e0d\u5361\u5e38\u7684 $\\text{Ynoi}$ \u4e86\u3002\n\n### Part5 \u540e\u8bb0\n\u8fd9\u7bc7\u6587\u7ae0\u53ea\u662f\u629b\u7816\u5f15\u7389\uff0c\u4f5c\u8005\u542c\u8bf4\u6709\u7a7a\u95f4\u7ebf\u6027\u7684\u505a\u6cd5\uff0c\u4ee5\u53ca\u53ef\u4ee5\u5206\u88c2\u5408\u5e76\u7684 $\\text{AVL}$ \u6811\uff0c\u5e0c\u671b\u5927\u5bb6\u591a\u591a\u5206\u4eab\u3002",
        "postTime": 1664433105,
        "uid": 502410,
        "name": "EnofTaiPeople",
        "ccfLevel": 0,
        "title": "P8524[Ynoi2078]\uff08\u533a\u95f4\u53f3\u79fb\u590d\u5236\u6c42\u548c\uff09"
    }
]