[
    {
        "content": "[\u51fa\u9898\u4eba\u9898\u89e3](http://olddrivertree.blog.uoj.ac/blog/4656)\n\n~~\u4f17\u6240\u5468\u77e5lxl\u662f\u4e2a\u6bd2\u7624\uff0cYnoi\u9053\u9053\u90fd\u662f\u795e\u4ed9\u9898~~\n\n\u9996\u5148\u6211\u4eec\u77e5\u9053\uff0c\u5f52\u5e76\u6392\u5e8f\u53ef\u4ee5\u6c42\u9006\u5e8f\u5bf9\u3002\n\n\u5f52\u5e76\u6392\u5e8f\u662f\u600e\u4e48\u6c42\u9006\u5e8f\u5bf9\u7684\u5462\uff1f\n\n\u5148\u9012\u5f52\u5de6\u534a\u8fb9$[l,mid]$\uff0c\u518d\u9012\u5f52\u53f3\u534a\u8fb9$[mid+1,r]$\uff0c\u8ba1\u7b97\u4e24\u8fb9\u7684\u8d21\u732e\uff0c\u7136\u540e\u52a0\u4e0a\u6ee1\u8db3$i\\in[l,mid]$\uff0c$j\\in[mid+1,r]$\uff0c\u4e14$a_i>a_j$\u7684\u6570\u5bf9$i,j$\u7684\u4e2a\u6570\u3002\n\n\u56e0\u6b64\uff0c\u4e00\u4e2a\u533a\u95f4\u7684\u9006\u5e8f\u5bf9\u95ee\u9898\uff0c\u53ef\u4ee5\u5206\u6210\u591a\u4e2a\u533a\u95f4\u7684\u9006\u5e8f\u5bf9\u95ee\u9898\uff0c\u7136\u540e\u8ba1\u7b97\u4efb\u610f\u4e24\u4e2a\u4e0d\u540c\u533a\u95f4\u4ea7\u751f\u7684\u8d21\u732e\u3002\n\n\u5206\u5757\uff0c\u5bf9\u6bcf\u4e2a\u5757\u8fdb\u884c\u6392\u5e8f\u3002\n\n\u6211\u4eec\u9700\u8981\u9884\u5904\u7406\u7684\u4fe1\u606f\u6709\uff1a\n\n1. \u6bcf\u4e2a\u5143\u7d20\u5230\u5176\u6240\u5728\u5757\u5757\u9996\u8fd9\u6bb5\u533a\u95f4\u7684\u9006\u5e8f\u5bf9\u4e2a\u6570$pre_x$\u3002\n2. \u6bcf\u4e2a\u5143\u7d20\u5230\u5176\u6240\u5728\u5757\u5757\u5c3e\u8fd9\u6bb5\u533a\u95f4\u7684\u9006\u5e8f\u5bf9\u4e2a\u6570$suf_x$\u3002\n3. \u5757$i$\u5230$j$\u8fd9\u4e00\u6574\u6bb5\u533a\u95f4\u7684\u9006\u5e8f\u5bf9\u4e2a\u6570$F[i][j]$\u3002\n4. $cnt[i][j]$\uff0c\u8868\u793a\u524d$i$\u4e2a\u5757\u4e2d\uff0c**\u5c0f\u4e8e\u7b49\u4e8e**\uff08\u6216**\u5927\u4e8e\u7b49\u4e8e**\uff09$j$\u7684\u5143\u7d20\u4e2a\u6570\u3002\n\n\u8ba1\u7b97$pre,suf$\uff0c\u7528\u6811\u72b6\u6570\u7ec4\u5728\u6bcf\u5757\u5185\u626b\u4e00\u904d\u5373\u53ef\uff0c\u8ba1\u7b97\u4e00\u5757\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a$O(S\\log S)$\uff0c\u603b\u65f6\u95f4\u590d\u6742\u5ea6$O(n\\log S)$\uff08$S$\u4e3a\u5757\u5927\u5c0f\uff09\u3002\n\n\u8ba1\u7b97$F$\u7684\u8bdd\uff0c\u6709$F[i][j]=F[i][j-1]+F[i+1][j]-F[i+1][j-1]+(i\u6240\u5728\u5757\u548cj\u6240\u5728\u5757\u4ea7\u751f\u7684\u8d21\u732e)$\uff0c\u5373\u4e24\u8fb9\u52a0\u8d77\u6765\u51cf\u53bb\u91cd\u590d\uff0c\u7136\u540e\u8ba1\u7b97\u4e24\u8fb9\u591a\u51fa\u6765\u7684\u8d21\u732e\u3002\u65f6\u95f4\u590d\u6742\u5ea6$O(\\dfrac{n^2}S)$\u3002\n\n\u8ba1\u7b97$cnt$\uff0c\u5148\u524d\u7f00\u548c\uff0c\u7136\u540e\u5bf9\u6bcf\u4e2a\u5757\u5185\u518d\u524d\u7f00\u548c\u5373\u53ef\u3002\u65f6\u95f4\u590d\u6742\u5ea6$O(\\dfrac{n^2}{S})$\u3002\n\n\u8bbe$i$\u6240\u5728\u5757\u7684\u5757\u9996\u4e3a$b_i$\uff0c\u5757\u5c3e\u4e3a$e_i$\u3002\n\n\u7136\u540e\uff0c\u5bf9\u4e8e\u4e00\u6bb5\u533a\u95f4\u8be2\u95ee$[L,R]$\uff1a\n\n1. \u82e5$L$\u548c$R$\u5728\u540c\u4e00\u5757\u5185\uff0c\u5219\u62c6\u5206\u6210$[b_L,R]$\u548c$[b_L,L-1]$\u8fd9\u4e24\u4e2a\u533a\u95f4\u7684\u5dee\uff0c\u5185\u90e8\u8d21\u732e\u5c31\u662f\u6c42\u51fa\u7684$pre$\u7684\u503c\uff0c\u4e24\u5757\u7684\u8d21\u732e\u7528\u5f52\u5e76\u6c42\u3002\n2. \u82e5$L$\u548c$R$\u4e0d\u5728\u540c\u4e00\u5757\u5185\uff0c\u5219\u62c6\u5206\u6210$[L,e_L],[e_L+1,b_R-1],[b_R,R]$\u7684\u548c\uff0c\u4e09\u4e2a\u533a\u95f4\u5185\u90e8\u8d21\u732e\u90fd\u5df2\u7ecf\u9884\u5904\u7406$pre,x,suf$\uff0c\u7136\u540e\uff0c\u8fb9\u89d2\u4e0e\u4e2d\u95f4\u5757\u7684\u8d21\u732e\uff0c\u53ef\u4ee5\u679a\u4e3e\u6bcf\u4e2a\u8fb9\u89d2\u5143\u7d20\uff0c\u7136\u540e\u5229\u7528\u9884\u5904\u7406\u51fa\u7684$cnt$\u7684\u503c\u8ba1\u7b97\u8d21\u732e\u3002\u4e24\u4e2a\u8fb9\u89d2\u7684\u8d21\u732e\uff0c\u5219\u5f52\u5e76\u6c42\u5373\u53ef\u3002\n\n\u7528\u5f52\u5e76\u6c42\u9006\u5e8f\u5bf9\uff0c\u9700\u8981\u5f97\u5230\u4e24\u4e2a\u8fb9\u89d2\u7684\u6709\u5e8f\u6570\u5217\uff0c\u7136\u540e\u53ef\u4ee5\u7ebf\u6027\u5f97\u5230\u8d21\u732e\u3002\u7531\u4e8e\u5bf9\u6bcf\u5757\u90fd\u6392\u597d\u5e8f\uff0c\u5219\u53ea\u9700\u8981$O(S)$\u626b\u63cf\u8fb9\u89d2\u5757\u5185\u5143\u7d20\uff0c\u628a\u5728\u533a\u95f4\u5185\u7684\u6309\u987a\u5e8f\u52a0\u5165\u5373\u53ef\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6$O(\\dfrac{n^2}S+mS)$\u3002\n\n\u7136\u540e\u8fd9\u6837\u4f3c\u4e4e\u5e38\u6570\u5f88\u5927\u554a\uff0c\u88ab\u5361\u5e38\u7684\u8bf4\u3012\u25bd\u3012\n\n\u591a\u6b21\u8bd5\u9a8c\u5f97\u51fa\u7ed3\u679c\uff0c\u6211\u7684$S$\u53d6160\u5de6\u53f3\u8dd1\u7684\u6bd4\u8f83\u5feb\uff08\u7136\u800c\u6839\u636e\u590d\u6742\u5ea6\u770b\u5e94\u8be5\u53d6$\\sqrt n$\uff09\uff0c\u4f30\u8ba1\u662f\u8be2\u95ee\u5e38\u6570\u5927\u3002\n\n\u7136\u540e~~\u6109\u5feb\u5730~~\u52a0\u4e86IO\u4f18\u5316\uff0c\u7f16\u8bd1\u6307\u4ee4\uff0c\u786c\u5361\u8fc7\u53bb\u4e86\uff08\u4e0d\u4fdd\u8bc1\u4ee3\u7801\u6bcf\u6b21\u63d0\u4ea4\u90fd\u80fd\u8fc7\uff09\u3002\n\n\u54e6\u5bf9\u4e86\uff0c\u672c\u9898\u8981\u5f00```long long```\u3002\n\n## Code\uff1a\n```cpp\n// luogu-judger-enable-o2\n#pragma GCC optimize(\"Ofast\")\n#pragma GCC optimize(\"unroll-loops\")\n#pragma GCC target(\"sse,sse2,sse3,ssse3,sse4,popcnt,abm,mmx,avx,tune=native\")\n#include<cstdio>\n#include<cctype>\n#include<algorithm>\n#include<cstring>\n#include<ctime>\n#define N 100001\n#define siz 160\nclass istream{\n    char buf[13000003],*s;\n    public:\n        inline istream(){\n#ifndef ONLINE_JUDGE\n            freopen(\"input.txt\",\"r\",stdin);\n#endif\n            buf[fread(s=buf,1,13000001,stdin)]='\\n';\n        }\n        template<typename T>\n        inline void operator>>(T&rhs){\n            for(rhs=0;!isdigit(*s);++s);\n            while(isdigit(*s))rhs=rhs*10+(*s++&15);\n        }\n}in;\nstruct BiT{\n    int b[N];\n    inline void add(int i,int x){for(;i<N;i+=i&-i)b[i]+=x;}\n    inline int ask(int i){int ret=0;for(;i;i^=i&-i)ret+=b[i];return ret;}\n}t;\nint n,m,a[N],L[666],R[666],bel[N],blocks,pre[N],suf[N],cnt[666][N];\nlong long F[666][666],ans;\nint x[666],y[666],lx,ly;\nint c[N],d[N];\nstruct Pair{\n    int first,second;\n    inline bool operator<(const Pair&rhs)const{return first<rhs.first;}\n}b[N];\ninline int merge(int*a,int*b,int la,int lb){\n    int ia=1,ib=1,ret=0;\n    while(ia<=la&&ib<=lb)\n    if(a[ia]<b[ib])++ia;else ret+=la-ia+1,++ib;\n    return ret;\n}\nvoid init(){\n    blocks=(n-1)/siz+1;\n    for(int i=1;i<=blocks;++i)L[i]=R[i-1]+1,R[i]=i*siz;\n    R[blocks]=n;\n    for(int i=1;i<=n;++i)b[i]=(Pair){a[i],i};\n    for(int i=1;i<=blocks;++i){\n        memcpy(cnt[i],cnt[i-1],sizeof*cnt);\n        std::sort(b+L[i],b+R[i]+1);\n        for(int j=L[i];j<=R[i];++j)bel[j]=i,++cnt[i][a[j]],c[j]=b[j].first;\n        int x=0;\n        for(int j=L[i];j<=R[i];++j){\n            t.add(a[j],1);\n            x+=t.ask(n)-t.ask(a[j]);\n            pre[j]=x;\n        }\n        F[i][i]=x;\n        for(int j=L[i];j<=R[i];++j){\n            suf[j]=x;\n            t.add(a[j],-1);\n            x-=t.ask(a[j]-1);\n        }\n    }\n    for(int len=1;len<=blocks;++len){\n        for(int j=n-1;j;--j)cnt[len][j]+=cnt[len][j+1];\n        for(int i=1;i<=blocks;++i)\n        if(len+i>blocks)break;else{\n            const int j=i+len;\n            F[i][j]=F[i+1][j]+F[i][j-1]-F[i+1][j-1]+merge(c+L[i]-1,c+L[j]-1,R[i]-L[i]+1,R[j]-L[j]+1);\n        }\n    }\n}\nstruct ostream{\n    char buf[8000005],*s;\n    inline ostream(){s=buf;}\n    inline void operator<<(long long d){\n        if(!d){\n            *s++='0';\n        }else{\n            static long long w;\n            for(w=1;w<=d;w*=10);\n            for(;w/=10;d%=w)*s++=d/w^'0';\n        }\n        *s++='\\n';\n    }\n    inline ostream&operator<<(const char&c){*s++=c;return*this;}\n    inline~ostream(){fwrite(buf,1,s-buf,stdout);}\n}cout;\nint main(){\n    in>>n;in>>m;\n    for(int i=1;i<=n;++i)in>>a[i];\n    init();\n    while(m--){\n        long long ll,rr;in>>ll;in>>rr;\n        const int l=ll^ans,r=rr^ans,bL=bel[l],bR=bel[r];\n    //    const int l=ll,r=rr,bL=bel[l],bR=bel[r];\n        lx=ly=0;\n        if(bL==bR){\n            for(int i=L[bL];i<=R[bL];++i)\n            if(l<=b[i].second&&b[i].second<=r)y[++ly]=c[i];else\n            if(b[i].second<l)x[++lx]=c[i];\n            ans=pre[r]-((l==L[bL])?(0):(pre[l-1]))-merge(x,y,lx,ly);\n        }else{\n            ans=F[bL+1][bR-1]+pre[r]+suf[l];\n            const int*cR=cnt[bR-1],*cL=cnt[bL];\n            for(int i=L[bL];i<=R[bL];++i)\n            if(b[i].second>=l)ans+=cR[1]-cR[x[++lx]=c[i]]-cL[1]+cL[c[i]];\n            for(int i=L[bR];i<=R[bR];++i)\n            if(b[i].second<=r)ans+=cR[(y[++ly]=c[i])+1]-cL[c[i]+1];\n            ans+=merge(x,y,lx,ly);\n        }\n        cout<<ans;\n    }\n    return 0;\n}\n\n```\n\n---\n\n\u8bf4\u5230\u5e95\uff0c\u5757\u5927\u5c0f\u53d6$\\dfrac{\\sqrt n}2$\u624d\u80fd\u8fc7\u7684\u539f\u56e0\u8fd8\u662f\u5e38\u6570\u95ee\u9898\u3002\n\n\u5728\u672c\u673a\u4e0a\u968f\u673a\u6570\u636e\u5f00O2\u6d4b\uff0c\u5757\u5927\u5c0f\u53d6$\\sqrt n$\u65f6\uff0c\u9884\u5904\u7406\u8981\u8dd1$0.22\\rm s$\uff0c\u800c\u6574\u4e2a\u7a0b\u5e8f\u8fd0\u884c\u5b8c\u8981$1.2\\rm s$\uff0c\u5e38\u6570\u5dee\u4e86$4\\sim 5$\u500d\uff01\n\n~~\u6240\u4ee5\u5757\u5f00\u5c0f\u4e00\u534a\u5e73\u8861\u4e86\u5e38\u6570\u80fd\u5361\u8fc7\u597d\u50cf\u4e5f\u6709\u9053\u7406~~\n\n\u4ee5\u4e0b\u662f**shadowice1984**\u795e\u4ed9\u7684\u4f18\u79c0\u505a\u6cd5\uff0c\u7a33\u5b9a\u7684$O(n\\sqrt n)$\uff1a\n\n![](https://cdn.vijos.org/fs/82009c81006f93fd5809e58cd9b1aace54ad1edf)\n\n\u8bb2\u6e05\u695a\u70b9\uff0c\u5c31\u662f\uff1a\n\n$f[i][j]$\u8868\u793a$a_1\\sim a_i$\u80fd\u4e0e\u7b2c$j$\u5757\u4e2d\u7684\u6570\u5b57\u4ea7\u751f\u591a\u5c11\u9006\u5e8f\u5bf9\u3002\n\n\u8ba1\u7b97\u7684\u65b9\u6cd5\u7684\u8bdd\uff0c\u5c31\u662f\u5bf9\u4e8e\u6bcf\u4e2a\u5757\uff0c\u90fd\u548c\u6240\u6709\u6570\u8fdb\u884c\u4e00\u904d\u5f52\u5e76\uff0c\u8bb0\u5f55\u4e0b\u6bcf\u4e2a\u6570\u5bf9\u5757\u7684\u8d21\u732e\u3002\n\n\u7136\u540e\u518d\u505a\u4e00\u904d\u524d\u7f00\u548c\u5373\u53ef\u3002$O(n\\sqrt n)$\u3002\n\n\u6ce8\u610f\u4e0a\u8ff0\u9884\u5904\u7406\u8981\u8003\u8651$a_i$\u5728\u7b2c$j$\u4e2a\u5757\u7684\u524d\u9762\u8fd8\u662f\u540e\u9762\u3002\n\n\u4e4b\u540e\u7684\u8bdd\uff0c\u539f\u6765\u7684$cnt$\u6570\u7ec4\u5c31\u53ef\u4ee5\u6254\u6389\u4e86\uff0c\u5bf9\u4e8e\u8fb9\u89d2\u5bf9\u6574\u5757\u7684\u8d21\u732e\uff0c\u5c31\u53ef\u4ee5\u679a\u4e3e\u6bcf\u4e2a\u5757\uff0c\u7136\u540e\u7528\u8d21\u732e\u7684\u524d\u7f00\u548c\u8fdb\u884c\u8ba1\u7b97\u3002\u5355\u6b21$O(\\sqrt n)$\uff0c\u6bd4\u539f\u6765\u7528$cnt$\u6570\u7ec4\u5c11\u4e861\u500d\u5e38\u6570\u3002\n\n\u800c\u4e14\uff0c\u8ba1\u7b97$F$\u7684\u65f6\u5019\u53ef\u4ee5\u7701\u6389\u4e00\u4e2a$O(\\sqrt n)$\u7684\u5f52\u5e76\u3002\n\n\u7136\u540e\u5e38\u6570\u5c31\u975e\u5e38\u4f18\u79c0\u4e86\u3002\n\n\u73b0\u5728\u4e0d\u52a0\u4efb\u4f55\u7f16\u8bd1\u6307\u4ee4\uff0c\u5757\u5927\u5c0f\u4e3a$\\sqrt n$\u4e5f\u80fd\u4fdd\u8bc1\u6bcf\u6b21\u63d0\u4ea4\u57fa\u672c\u90fd\u8fc7\u4e86\uff08\u867d\u7136\u603b\u7528\u65f6\u6bd4\u539f\u6765\u591aQAQ\uff09\u3002\n\n## Code\uff1a\n```cpp\n#include<cstdio>\n#include<cctype>\n#include<algorithm>\n#include<cstring>\n#define N 100002\n#define siz 317\nclass istream{\n\tchar buf[15000003],*s;\n\tpublic:\n\t\tinline istream(){\n#ifndef ONLINE_JUDGE\n\t\t\tfreopen(\"input.txt\",\"r\",stdin);\n#endif\n\t\t\tbuf[fread(s=buf,1,15000001,stdin)]='\\n';\n\t\t}\n\t\ttemplate<typename T>\n\t\tinline void operator>>(T&rhs){\n\t\t\tfor(rhs=0;!isdigit(*s);++s);\n\t\t\twhile(isdigit(*s))rhs=rhs*10+(*s++&15);\n\t\t}\n}in;\nstruct BiT{\n\tint b[N];\n\tinline void add(int i,int x){for(;i<N;i+=i&-i)b[i]+=x;}\n\tinline int ask(int i){int ret=0;for(;i;i^=i&-i)ret+=b[i];return ret;}\n}t;\nint n,m,a[N],L[320],R[320],bel[N],blocks,pre[N],suf[N],f[320][N];\nlong long F[320][320],ans;\nint x[320],y[320],lx,ly;\nint c[N],d[N];\nstruct Pair{\n\tint first,second;\n\tinline bool operator<(const Pair&rhs)const{return first<rhs.first;}\n}b[N];\ninline int merge(int*a,int*b,int la,int lb){\n\tint ia=1,ib=1,ret=0;\n\twhile(ia<=la&&ib<=lb)\n\tif(a[ia]<b[ib])++ia;else ret+=la-ia+1,++ib;\n\treturn ret;\n}\nvoid init(){\n\tblocks=(n-1)/siz+1;\n\tfor(int i=1;i<=blocks;++i)L[i]=R[i-1]+1,R[i]=i*siz;\n\tR[blocks]=n;\n\tfor(int i=1;i<=n;++i)b[i]=(Pair){a[i],i};\n\tfor(int i=1;i<=blocks;++i){\n\t\tstd::sort(b+L[i],b+R[i]+1);\n\t\tfor(int j=L[i];j<=R[i];++j)bel[j]=i,c[j]=b[j].first,d[j]=b[j].second;\n\t\tint x=0;\n\t\tfor(int j=L[i];j<=R[i];++j){\n\t\t\tt.add(a[j],1);\n\t\t\tx+=t.ask(n)-t.ask(a[j]);\n\t\t\tpre[j]=x;\n\t\t}\n\t\tF[i][i]=x;\n\t\tfor(int j=L[i];j<=R[i];++j){\n\t\t\tsuf[j]=x;\n\t\t\tt.add(a[j],-1);\n\t\t\tx-=t.ask(a[j]-1);\n\t\t}\n\t}\n\tstd::sort(b+1,b+n+1);\n\tfor(int j=1;j<=blocks;++j){\n\t\tfor(int i=1,k=L[j];i<=n;++i){\n\t\t\tconst int id=b[i].second;\n\t\t\twhile(k<=R[j]&&b[i].first>c[k])++k;\n\t\t\tif(id<L[j])\n\t\t\tf[j][id]=k-L[j];else\n\t\t\tif(id>R[j])\n\t\t\tf[j][id]=R[j]-k-(k<=R[j]&&b[i].first==c[k])+1;\n\t\t}\n\t}\n\tfor(int i=1;i<=blocks;++i)\n\tfor(int j=2;j<=n;++j)f[i][j]+=f[i][j-1];\n\tfor(int len=1;len<=blocks;++len){\n\t\tfor(int i=1;i<=blocks;++i)\n\t\tif(len+i>blocks)break;else{\n\t\t\tconst int j=i+len;\n\t\t\tF[i][j]=F[i+1][j]+F[i][j-1]-F[i+1][j-1]+f[j][R[i]]-f[j][L[i]-1];\n\t\t}\n\t}\n}\nstruct ostream{\n\tchar buf[9000005],*s;\n\tinline ostream(){s=buf;}\n\tinline void operator<<(long long d){\n\t\tif(!d){\n\t\t\t*s++='0';\n\t\t}else{\n\t\t\tstatic long long w;\n\t\t\tfor(w=1;w<=d;w*=10);\n\t\t\tfor(;w/=10;d%=w)*s++=d/w^'0';\n\t\t}\n\t\t*s++='\\n';\n\t}\n\tinline ostream&operator<<(const char&c){*s++=c;return*this;}\n\tinline~ostream(){fwrite(buf,1,s-buf,stdout);}\n}cout;\nint main(){\n\tin>>n;in>>m;\n\tfor(int i=1;i<=n;++i)in>>a[i];\n\tinit();\n\twhile(m--){\n\t\tlong long ll,rr;in>>ll;in>>rr;\n\t\tconst int l=ll^ans,r=rr^ans,bL=bel[l],bR=bel[r];\n\t\tlx=ly=0;\n\t\tif(bL==bR){\n\t\t\tfor(int i=L[bL];i<=R[bL];++i)\n\t\t\tif(l<=d[i]&&d[i]<=r)y[++ly]=c[i];else\n\t\t\tif(d[i]<l)x[++lx]=c[i];\n\t\t\tans=pre[r]-((l==L[bL])?(0):(pre[l-1]))-merge(x,y,lx,ly);\n\t\t}else{\n\t\t\tans=F[bL+1][bR-1]+pre[r]+suf[l];\n\t\t\tfor(int i=bL+1;i<bR;++i)\n\t\t\tans+=(f[i][R[bL]]-f[i][l-1])+(f[i][r]-f[i][L[bR]-1]);\n\t\t\tfor(int i=L[bL];i<=R[bL];++i)\n\t\t\tif(d[i]>=l)x[++lx]=c[i];\n\t\t\tfor(int i=L[bR];i<=R[bR];++i)\n\t\t\tif(d[i]<=r)y[++ly]=c[i];\n\t\t\tans+=merge(x,y,lx,ly);\n\t\t}\n\t\tcout<<ans;\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1542881674,
        "uid": 6813,
        "name": "mrsrz",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P5046 \u3010[Ynoi2019\u6a21\u62df\u8d5b]Yuno loves sqrt technology I\u3011"
    },
    {
        "content": "\u7b97\u662f\u4e00\u9053\u975e\u5e38\u7b80\u5355\u7684\u9898\uff08\u6211\u90fd\u505a\u5f97\u51fa\u6765\u2026\u2026\uff09\uff0c\u5927\u6982\u7b97\u4e0d\u4e0a\u662f\u9ed1\u9898\n\n\u8003\u8651\u5206\u5757\uff0c\u8bbe\u5757\u6570\u4e3a $B$\u3002\u8003\u8651\u4e24\u79cd\u60c5\u51b5\uff1a$bel_l=bel_r$\uff0c\u4ee5\u53ca $bel_l<bel_r$\u3002\n\n\u7b2c\u4e00\u79cd\u60c5\u51b5\uff0c$l,r$ \u5728\u540c\u4e00\u5757\uff1a\uff08\u4ee4 $S=st_{bel_l},E=ed_{bel_l}$\uff09\n\n- \u8003\u8651\u9884\u5904\u7406 $g(i,j)$ \u8868\u793a $\\sum_{i<k\\le S+j}[a_k<a_i]$\n- \u5219\u7b54\u6848\u7b49\u4e8e $\\sum _{l\\le k\\le r} g(k,r-S)$\n- \u53ef\u4ee5\u5206\u5757\u9884\u5904\u7406 $g$\n- \u4ece\u53f3\u5f80\u5de6\u4e00\u5757\u4e00\u5757\u626b\uff0c\u6bcf\u6b21\u628a\u4e00\u4e2a\u5143\u7d20\u52a0\u5165\u4e00\u4e2a\u6570\u636e\u7ed3\u6784\u4e2d\uff0c\u7136\u540e\u5bf9\u4e8e$i$  \u5de6\u8fb9\u7684\u5143\u7d20 $j$ \u67e5\u8be2\u5c0f\u4e8e $a_j$ \u7684\u5143\u7d20\u4e2a\u6570 $x$\uff0c\u5219 $g(j,i-S-1)=ts_j-(E-i+1-x)$\uff0c$i$ \u53ef\u4ee5\u53d6\u5230 $E+1$\n\n\u8fd9\u6837\uff0c\u9884\u5904\u7406 $g$ \u7684\u65f6\u95f4\u590d\u6742\u5ea6\u662f $O(\\dfrac{n^2}{B})$\uff0c\u56de\u7b54\u8be2\u95ee\u7684\u590d\u6742\u5ea6\u662f $O(r-l)=O(\\dfrac{n}{B})$\u3002\n\n\u7b2c\u4e8c\u79cd\u60c5\u51b5\uff0c\u5206\u4e3a\u8fb9\u89d2\u5757\u5185\uff0c\u8fb9\u89d2\u5757\u95f4\uff0c\u5927\u5757\u5185\uff0c\u5927\u5757\u95f4\uff0c\u5927\u5757\u5230\u8fb9\u89d2\u5757\uff0c\u4e94\u79cd\u60c5\u51b5\u3002\n\n\u5757\u5185\u8d21\u732e\u76f4\u63a5\u7528\u6811\u72b6\u6570\u7ec4\u9884\u5904\u7406\u524d\u7f00\u540e\u7f00\u9006\u5e8f\u5bf9\u4e2a\u6570\uff08\u6216\u8005\u4e3a\u4e86\u7701\u4e8b\u6cbf\u7528\u4e0a\u9762\u90a3\u4e2a\u5206\u5757\uff09\uff0c\u518d $O(n\\log n)$ \u9884\u5904\u7406\u5757\u5185\u7684\u6392\u5e8f\u4ee5\u53ca\u5168\u4f53\u6392\u5e8f\u3002\u7136\u540e\u5c31\u53ea\u5269\u4e0b\u8fb9\u89d2\u5757\u95f4\uff0c\u5927\u5757\u5185\uff0c\u5927\u5757\u95f4\uff0c\u5927\u5757\u5230\u8fb9\u89d2\u5757\u56db\u79cd\u4e86\u3002\n\n- $f(i,x)$ \u7b2c $x$ \u5757\u4e2d\u6709\u51e0\u4e2a\u5c0f\u4e8e $a_i$ \u7684\u5143\u7d20\uff0c\u53ef\u4ee5 $O(nB)$ \u79bb\u7ebf\u9884\u5904\u7406\n- \u4e24\u8fb9\u96f6\u6563\u5143\u7d20\u4e4b\u95f4\u7684\u8d21\u732e\uff1a$O(\\dfrac{n}{B})$ \u5f52\u5e76\u7b97\n- \u8fd8\u5269\u4e0b $\\sum_{bel_i=bel_l}\\sum_{bel_l<j<bel_r} f_{i,j}$ \u4ee5\u53ca\u53e6\u5916\u4e00\u8fb9\uff0c\u53ef\u4ee5 $O(nB)$ \u524d\u7f00\u548c\u51fa $s(i,r)=\\sum_{l\\le r}f(i,l)$ \u7136\u540e $O(\\dfrac{n}{B})$ \u7b97\n- \u8fd8\u6709 $bel_l+1\\sim bel_r-1$ \u5757\u95f4\u8d21\u732e\uff0c\u5373 $\\sum_{bel_l<k<bel_r}\\sum_{bel_i=k}\\sum_{k<j<bel_r} f(i,j)$\uff0c$\\sum_{bel_l<k<bel_r}\\sum_{bel_i=k}s(i,bel_r-1)-s(i,k)$\uff0c\u4ee4 $t(k,j)=\\sum_{bel_i=k} s(i,j)$\uff0c\u5219\u7b54\u6848\u4e3a $\\sum_{bel_l<k<bel_r} t(k,bel_r-1)-t(k,k)$\n- \u8fd8\u6709 $bel_l+1\\sim bel_r-1$ \u5185\u8d21\u732e\uff0c\u7b49\u4e8e $\\sum_{bel_l<k<bel_r}suf_{st_k}$\n\n\u53d6 $B=\\sqrt n$\uff0c\u9884\u5904\u7406 $f,s,t$ \u90fd\u662f $O(n\\sqrt n)$ \u7684\uff0c\u6c42\u7b54\u6848\u4e5f\u662f $O(\\sqrt n)$ \u7684\uff0c\u56e0\u6b64\u662f $O(n\\sqrt n)$ \u7684\u3002\u5b9e\u73b0\u4e0a\u9700\u8981\u8c03\u51e0\u4e2a\u6570\u7ec4\u7684\u7ef4\u5ea6\u6765\u4fdd\u8bc1\u5185\u5b58\u8fde\u7eed\uff0c\u5176\u5b83\u57fa\u672c\u4e0a\u4e0d\u5361\u5e38\u3002\u53d6 $B=300$ \u4e0d\u52a0\u5feb\u8bfb\u53ef\u4ee5\u7a33\u5b9a\u8fc7\u3002\n\n\u4ee3\u7801\u5982\u4e0b\uff1a\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\ntypedef long long ll;\nint a[100005],n,m,pre[100005],suf[100005],ed[100005],st[100005],ts[100005],s[405][100005];\nint _a[100005],w[100005],w2[100005],pos[100005],g[405][100005],sum[100005],insum[100005],bel[100005];\nll t[405][405];\nconst int B=300;\nstruct Thing{\n\tint id,x;\n}b[100005];\nbool operator <(const Thing i,const Thing j){\n\treturn i.x<j.x;\n}\nvoid U(int x,int k){\n\tfor(int i=bel[x];i<=bel[n];i++)sum[i]+=k;\n\tfor(int i=x;i<=ed[bel[x]];i++)insum[i]+=k;\n}\nint Q(int x){\n\treturn sum[bel[x]-1]+insum[x];\n}\nvoid Prework(int id){\n\tint tmp=0;\n\tfor(int i=st[id];i<=ed[id];i++)w[++tmp]=a[i];\n\tsort(w+1,w+tmp+1);\n\tfor(int i=1,j=0;i<=n;i++){\n\t\twhile(j<tmp&&w[j+1]<b[i].x)j++;\n\t\ts[id][b[i].id]=j;\n\t}\n\tfor(int i=st[id];i<=ed[id];i++)_a[i]=w[i-st[id]+1];\n\tfor(int i=ed[id]+1;i>st[id];i--){\n\t\tif(i<=ed[id])U(a[i],1);\n\t\tfor(int j=st[id];j<i;j++)g[i-st[id]-1][j]=ts[j]-sum[bel[a[j]]-1]-insum[a[j]];\n\t}\n\tfor(int i=1,j;i<=bel[n];i++){\n\t\tsum[i]=0,j=ed[i];\n\t\twhile(insum[j])insum[j]=0,j--;\n\t}\n}\nll Query(int l,int r){\n\tll ret=0;\n\tif(bel[l]==bel[r]){\n\t\tfor(int i=l;i<=r;i++)ret+=g[r-st[bel[l]]][i];\n\t\treturn ret;\n\t}\n\tint t1=0,t2=0;\n\tfor(int i=st[bel[l]];i<=ed[bel[l]];i++)if(pos[_a[i]]>=l)w[++t1]=_a[i];\n\tfor(int i=st[bel[r]];i<=ed[bel[r]];i++)if(pos[_a[i]]<=r)w2[++t2]=_a[i];\n\tfor(int i=1,j=0;i<=t1;i++){\n\t\twhile(j<t2&&w2[j+1]<w[i])j++;\n\t\tret+=j;\n\t}//\u5de6\u53f3\u96f6\u6563\u7684\u8d21\u732e\n\tfor(int i=l;i<=ed[bel[l]];i++)ret+=s[bel[r]-1][i]-s[bel[l]][i];\n\tfor(int i=st[bel[r]];i<=r;i++)ret+=(st[bel[r]]-ed[bel[l]]-1)-(s[bel[r]-1][i]-s[bel[l]][i]);\n\tfor(int i=bel[l]+1;i<bel[r];i++)ret+=t[i][bel[r]-1]-t[i][i]+pre[ed[i]];\n\treturn ret+pre[r]+suf[l];\n}\nint main(){\n\tscanf(\"%d%d\",&n,&m);\n\tfor(int i=1;i<=n;i++)scanf(\"%d\",&a[i]),b[i]={i,a[i]},pos[a[i]]=i;\n\tsort(b+1,b+n+1);\n\tfor(int i=1;i<=n;i++)bel[i]=i/B+1,ed[bel[i]]=i;\n\tfor(int i=n;i>=1;i--)st[bel[i]]=i;\n\tfor(int i=1;i<=bel[n];i++){\n\t\tfor(int j=st[i];j<=ed[i];j++)pre[j]=(j==st[i]?0:pre[j-1])+(j-st[i])-Q(a[j]),U(a[j],1);\n\t\tfor(int j=st[i];j<=ed[i];j++)U(a[j],-1);\n\t\tfor(int j=ed[i];j>=st[i];j--)suf[j]=(j==ed[i]?0:suf[j+1])+(ts[j]=Q(a[j])),U(a[j],1);\n\t\tfor(int j=ed[i];j>=st[i];j--)U(a[j],-1);\n\t}\n\tfor(int i=1;i<=bel[n];i++)Prework(i);\n\tfor(int j=1;j<=bel[n];j++)for(int i=1;i<=n;i++)s[j][i]+=s[j-1][i],t[bel[i]][j]+=s[j][i];\n\tll la=0,l,r;\n\tfor(int i=1;i<=m;i++){\n\t\tscanf(\"%lld%lld\",&l,&r),l^=la,r^=la;\n\t\tprintf(\"%lld\\n\",la=Query(l,r));\n\t}\n}\n/*\n4 1\n4 3 2 1\n1 4\n*/\n```",
        "postTime": 1608341418,
        "uid": 42156,
        "name": "feecle6418",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P5046 \u3010[Ynoi2019\u6a21\u62df\u8d5b]Yuno loves sqrt technology I\u3011"
    },
    {
        "content": "\u5206\u4eab\u4e00\u4e2a\u601d\u8def\u8f83\u7b80\u5355\u4f46\u5bb9\u6613\u88ab\u5361\u7a7a\u95f4\u7684\u7b97\u6cd5\u3002\r\n\r\n\u9884\u5904\u7406\u4ee5\u4e0b\u51e0\u4e2a\u4e1c\u897f\uff1a\r\n\r\n1\u3001$ansL_{i,j}$\uff0c\u8868\u793a\u4ee5$j$\u4e3a\u5de6\u7aef\u70b9\uff0c\u7b2ci\u5757\u7684\u53f3\u7aef\u70b9\u4e3a\u53f3\u7aef\u70b9\u7684\u533a\u95f4\u4e2d\u7684\u9006\u5e8f\u5bf9\u6570\u3002\r\n\r\n2\u3001$ansR_{i,j}$\uff0c\u8868\u793a\u4ee5$j$\u4e3a\u53f3\u7aef\u70b9\uff0c\u7b2ci\u5757\u7684\u5de6\u7aef\u70b9\u4e3a\u5de6\u7aef\u70b9\u7684\u533a\u95f4\u4e2d\u7684\u9006\u5e8f\u5bf9\u6570\u3002\r\n\r\n3\u3001$ans_{l,r}$\uff0c\u8868\u793a\u4ee5\u7b2c$l$\u5757\u7684\u5de6\u7aef\u70b9\u4e3a\u5de6\u7aef\u70b9\uff0c\u7b2c$r$\u5757\u7684\u53f3\u7aef\u70b9\u4e3a\u53f3\u7aef\u70b9\u7684\u533a\u95f4\u4e2d\u7684\u9006\u5e8f\u5bf9\u6570\u3002\r\n\r\n\u90a3\u4e48\u5bf9\u4e8e\u6bcf\u6b21\u8be2\u95ee\u6211\u4eec\u53ea\u9700\u8981\u628a1+2-3\uff0c\u5c31\u53ef\u4ee5\u5f97\u5230\u7b54\u6848\u4e86\u3002\r\n\r\n\u2014\u2014\u597d\u50cf\u6f0f\u4e86\u5565\u3002\u5de6\u6563\u5757\u5bf9\u53f3\u6563\u5757\u7684\u8d21\u732e\u6ca1\u6709\u7edf\u8ba1\u3002\u5c06\u6240\u6709\u5757\u4e8b\u5148\u6392\u597d\u5e8f\uff0c\u67e5\u8be2\u65f6\u5f52\u5e76\u4e00\u4e0b\u5373\u53ef\u3002\r\n\r\n\u5982\u4f55\u9884\u5904\u7406\uff1f\r\n\r\n\u9884\u5904\u7406\u51fa$cnt_{i,j}$\u4e3a\u524d$i$\u5757\u5927\u4e8e/\u5c0f\u4e8e\u7b49\u4e8ej\u7684\u6570\u5b57\u4e2a\u6570\uff0c$pre_i$\u4e3a\u4f4d\u7f6e$i$\u5230$i$\u6240\u5728\u5757\u5de6\u7aef\u70b9\u4e2d\u5927\u4e8e/\u5c0f\u4e8e\u7b49\u4e8e$a_i$\u7684\u6570\u5b57\u4e2a\u6570\uff0c\u5373\u53ef\u505a\u5230$O(1)$\u79fb\u52a8\u7aef\u70b9\u3002\r\n\r\n\u5173\u4e8e\u7b2c\u4e09\u4e2a$ans_{l,r}$\uff0c\u4e0d\u96be\u53d1\u73b0\u5728\u5904\u7406\u524d\u4e24\u4e2a\u503c\u7684\u65f6\u5019\u5df2\u7ecf\u987a\u4fbf\u6c42\u51fa\u6765\u4e86\uff0c\u4e0d\u9700\u8981\u505a\u66f4\u591a\u5904\u7406\u3002\r\n\r\n\u67e5\u8be2\u65f6\u82e5l,r\u5728\u540c\u4e00\u4e2a\u5757\u4e2d\uff0c\u7b80\u5355\u5bb9\u65a5\u4e00\u4e0b\u5373\u53ef\u3002\u8fd9\u4e2a\u90e8\u5206\u5176\u4ed6\u9898\u89e3\u5df2\u7ecf\u8bf4\u660e\u5f97\u975e\u5e38\u6e05\u695a\u4e86\u4e0d\u518d\u8d58\u8ff0\u3002\r\n\r\n\u603b\u590d\u6742\u5ea6$O(n\\sqrt{n})$\u3002\r\n\r\n```cpp\r\n#include <bits/stdc++.h>\r\n#define bl(x) (((x)-1)/siz+1)\r\n#define L(x) (((x)-1)*siz+1)\r\n#define R(x) std::min(1ll*(x)*siz, 1ll*n)\r\nusing namespace std; typedef long long lint;\r\nconst int MAXN = 100050, MAXB = 205;\r\nnamespace fastIO {\r\n\tconst int buffer_size = 1024 * 1024 * 40;\r\n\tchar input[buffer_size], output[buffer_size];\r\n\tchar *fin, *fout;\r\n\tinline void init() {\r\n\t\tfread(input, 1, buffer_size, stdin);\r\n\t\tfin = input; fout = output;\r\n\t}\r\n\tinline void flush() {\r\n\t\tfwrite(output, 1, fout - output, stdout);\r\n\t\tfflush(stdout);\r\n\t}\r\n\tinline int read(int u = 0, char c = *fin++, bool f = false) {\r\n\t\tfor (;!isdigit(c); c = *fin++) f |= c == '-';\r\n\t\tfor (; isdigit(c); c = *fin++) u = u * 10 + c - '0';\r\n\t\treturn f ? -u : u;\r\n\t}\r\n\tinline void read(char *s, char c = *fin++) {\r\n\t\tfor (;!isspace(c); c = *fin++);\r\n\t\tfor (; isspace(c); c = *fin++) *s++ = c;\r\n\t\t*s = '\\0';\r\n\t}\r\n\tinline void print(lint u) {\r\n\t\tu < 0 ? \r\n\t\t\t*fout++ = '-', print(-u) :\r\n\t\t\tvoid(u > 9 ?\r\n\t\t\t\tprint(u / 10), *fout++ = u % 10 + '0' :\r\n\t\t\t\t*fout++ = u + '0');\r\n\t}\r\n\tinline void print(char *s) { while (*s) *fout++ = *s++; }\r\n\tinline void print(char c) { *fout++ = c; }\r\n}\r\nusing fastIO::read; using fastIO::print;\r\nint P[MAXN], cx, cy, x[MAXN], y[MAXN], c[MAXN], d[MAXN], n, m, a[MAXN], siz, cnt[MAXN], pre[MAXN], suf[MAXN], c1[MAXB][MAXN], c2[MAXB][MAXN]; \r\nstruct BT {int id, c;} b[MAXN]; lint ansR[MAXB][MAXN], ansL[MAXB][MAXN];\r\nint cmp(BT p, BT q) {return p.c < q.c;}\r\nstruct BITS1 {\r\n\tint t[MAXN];\r\n\tvoid update(int x, int k) {for(; x <= n; t[x] += k, x += x&-x);}\r\n\tint query(int x) {int res = 0; for(; x > 0; res += t[x], x -= x&-x); return res;}\r\n} T1;\r\nstruct BITS2 {\r\n\tint t[MAXN];\r\n\tvoid update(int x, int k) {for(; x > 0; t[x] += k, x -= x&-x);}\r\n\tint query(int x) {int res = 0; for(; x <= n; res += t[x], x += x&-x); return res;}\r\n} T2;\r\nint merg(int *p, int *q, int lp, int lq) {\r\n\tint i = 1, j = 1, res = 0;\r\n\twhile(i <= lp && j <= lq)\r\n    \tif(p[i] < q[j]) ++i; else res += lp - i + 1, ++j;\r\n    return res;\r\n}\r\nint main() {\r\n\tfastIO::init();\r\n\tn = read(); m = read(); siz = 500;\r\n\tfor(int i = 1; i <= n; ++i) a[i] = read(), b[i] = (BT) {i, a[i]};\r\n\tfor(int i = 1; i <= bl(n); ++i) {\r\n\t\tsort(b+L(i), b+R(i)+1, cmp);\r\n\t\tfor(int j = L(i); j <= R(i); ++j) d[j] = b[j].id, c[j] = b[j].c;\r\n\t\tfor(int j = L(i); j <= R(i); ++j) pre[j] = T2.query(a[j]), T2.update(a[j], 1);\r\n\t\tfor(int j = L(i); j <= R(i); ++j) T2.update(a[j], -1);\r\n\t\tfor(int j = R(i); j >= L(i); --j) suf[j] = T1.query(a[j]), T1.update(a[j], 1);\r\n\t\tfor(int j = R(i); j >= L(i); --j) T1.update(a[j], -1); P[L(i)] = pre[L(i)];\r\n\t\tfor(int j = L(i)+1; j <= R(i); ++j) P[j] = P[j-1] + pre[j];\r\n\t}\r\n\tfor(int k = 1, i = 1; i <= n; ++i) {\r\n\t\t++cnt[a[i]];\r\n\t\tif(i == R(k)) {\r\n\t\t\tfor(int j = 1; j <= n; ++j)\r\n\t\t\t\tc1[k][j] = c1[k][j-1] + cnt[j];\r\n\t\t\tfor(int j = n; j >= 1; --j)\r\n\t\t\t\tc2[k][j] = c2[k][j+1] + cnt[j];\r\n\t\t\t++k;\r\n\t\t}\r\n\t}\r\n\tfor(int i = 1; i <= bl(n); ++i)\r\n\t\tfor(int j = L(i); j <= n; ++j)\r\n\t\t\tansR[i][j] = ansR[i][j-1] + (c2[bl(j)-1][a[j]+1] - c2[i-1][a[j]+1]) + pre[j];\r\n\tfor(int i = 1; i <= bl(n); ++i)\r\n\t\tfor(int j = R(i); j >= 1;  --j)\r\n\t\t\tansL[i][j] = ansL[i][j+1] + (c1[i][a[j]-1] - c1[bl(j)][a[j]-1]) + suf[j];\r\n\tlint ans = 0;\r\n\tfor(int l, r; m--; ) {\r\n\t\tl = read(); r = read(); l ^= ans; r ^= ans;\r\n\t\tif(l > r) swap(l, r); ans = 0; cx = cy = 0;\r\n\t\tif(bl(l) == bl(r)) {\r\n\t\t\tfor(int i = L(bl(l)); i <= R(bl(l)); ++i)\r\n        \t\tif(l <= d[i] && d[i] <= r) y[++cy] = c[i];\r\n\t\t\t\telse if(d[i] < l) x[++cx] = c[i];\r\n            ans = P[r] - ((l == L(bl(l))) ? 0 : (P[l-1])) - merg(x, y, cx, cy);\r\n\t\t\tprint(ans); print('\\n');\r\n\t\t} else {\r\n\t\t\tans = ansL[bl(r)-1][l] + ansR[bl(l)+1][r] - ansL[bl(r)-1][L(bl(l)+1)];\r\n\t\t\tfor(int i = L(bl(l)); i <= R(bl(l)); ++i) if(d[i] >= l) x[++cx] = c[i];\r\n\t\t\tfor(int i = L(bl(r)); i <= R(bl(r)); ++i) if(d[i] <= r) y[++cy] = c[i];\r\n\t\t\tans += merg(x, y, cx, cy);\r\n\t\t\tprint(ans); print('\\n');\r\n\t\t}\r\n\t} fastIO::flush();\r\n}\r\n```",
        "postTime": 1572532449,
        "uid": 2491,
        "name": "\u8bd7\u4e43",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P5046 \u3010[Ynoi2019\u6a21\u62df\u8d5b]Yuno loves sqrt technology I\u3011"
    },
    {
        "content": "\u8bbe $m=\\Theta(n)$\u3002\n\n\u5bf9\u503c\u57df\u5206\u5757\uff0c\u8bbe\u5757\u6570\u4e3a $b$\u3002\n\n\u5bf9\u4e8e\u6bcf\u5757\u5185\u7684\u8d21\u732e\uff0c\u6211\u4eec\u53d1\u73b0\u8fd9\u91cc\u53ea\u6709 $O(\\dfrac {n^2} b)$ \u5bf9\u4e8c\u5143\u7ec4\uff0c\u6240\u4ee5\u505a\u4e00\u4e2a\u4e8c\u7ef4\u6570\u70b9\u5373\u53ef\u3002\u5bf9\u4e8e $b=n^e$\uff0c\u56e0\u4e3a\u5b58\u5728 $O(n^{eps})-O(1)$ \u7684\u5206\u5757\uff0c\u6211\u4eec\u603b\u662f\u80fd\u5c06\u8fd9\u90e8\u5206\u505a\u5230 $O(\\dfrac {n^2} b)$\u3002\n\n\u5bf9\u4e8e\u5757\u95f4\u7684\u8d21\u732e\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u539f\u5e8f\u5217\u79bb\u6563\u5316\u5904\u7406\u3002\u5bf9\u4e8e\u6bcf\u4e2a\u6570\uff0c\u5c06\u5176\u53d8\u4e3a\u5176\u5c5e\u4e8e\u7684\u5757\u3002\u90a3\u4e48\uff0c\u6211\u4eec\u5c06\u5e8f\u5217\u5206\u4e3a $b$ \u5757\u3002\u663e\u7136\uff0c\u548c\u6563\u5757\u76f8\u5173\u7684\u8d21\u732e\u90fd\u662f\u5e73\u51e1\u7684\u2014\u2014\u8fd9\u91cc\u548c\u4e0a\u9762\u7684\u4e8c\u7ef4\u6570\u70b9\u540c\u7406\u3002\n\n\u6211\u4eec\u53ea\u9700\u8981\u9884\u5904\u7406\u5757\u5230\u5757\u4e4b\u95f4\u7684\u8d21\u732e\u3002\u663e\u7136\uff0c\u5355\u5757\u5185\u7684\u8d21\u732e\u4e5f\u662f\u5e73\u51e1\u7684\u3002\u5bf9\u4e8e\u5757\u5230\u5757\u4e4b\u95f4\u7684\u8d21\u732e\uff0c\u6211\u4eec\u53d1\u73b0\u4e00\u4e2a\u60ca\u4eba\u7684\u4e8b\u5b9e\uff1a\u8bbe $a_{i,j}$ \u4e3a\u5757 $i$ \u4e2d $\\le j$ \u7684\u5143\u7d20\u6570\u91cf\uff0c$b_{j,i}$ \u4e3a\u5757 $i$ \u4e2d $j+1$ \u7684\u6570\u91cf\uff0c\u5757 $x$ \u548c\u5757 $y$ \u7684\u8d21\u732e\u5c31\u4e3a $\\sum_{i=1}^{b+1} a_{x,i}b_{i,y}$\u3002\n\n\u8fd9\u662f\u4e00\u4e2a\u77e9\u9635\u4e58\u6cd5\u7684\u5f62\u5f0f\u3002\u8fd9\u5c31\u610f\u5473\u7740\uff0c\u5982\u679c\u77e9\u9635\u4e58\u6cd5\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n^k)$\uff0c\u90a3\u4e48\u8fd9\u4e2a\u7b97\u6cd5\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u5c31\u662f $O(\\dfrac {n^2} b+b^k)$\uff0c\u663e\u7136\uff0c\u5f53 $b=n^{\\frac 2 {k+1}}$ \u65f6\uff0c\u7b97\u6cd5\u6709\u6700\u4f18\u65f6\u95f4\u590d\u6742\u5ea6 $O(n^{\\frac {2k} {k+1}})$\u3002\n\n\u53d6 $k=2.3728596$\uff0c\u8be5\u7b97\u6cd5\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n^{1.4070315})$\u3002\n\n\u5f88\u9057\u61be\uff0c\u8fd9\u7c7b\u505a\u6cd5\u5e76\u4e0d\u80fd\u505a\u5230 polylog \u65f6\u95f4\u590d\u6742\u5ea6\u533a\u95f4\u9006\u5e8f\u5bf9\u3002",
        "postTime": 1659269874,
        "uid": 203623,
        "name": "Ntokisq",
        "ccfLevel": 0,
        "title": "\u533a\u95f4\u9006\u5e8f\u5bf9\u505a\u5230 o(n^1.5) \u7684\u65b9\u6cd5"
    },
    {
        "content": "\u7b2c $n$ \u9053 Ynoi\u3002\u4e0d\u8fc7\u8fd9\u9053\u662f\u505a\u8fc7\u7684\u6700\u5361\u5e38\u7684\u4e86\u3002\n\n### \u9898\u76ee\u63cf\u8ff0\n\n\u7ed9\u5b9a\u4e00\u4e2a $n$ \u7684\u6392\u5217\uff0c\u6c42 $m$ \u7ec4\u533a\u95f4\u9006\u5e8f\u5bf9\uff0c\u5f3a\u5236\u5728\u7ebf\u3002\n\n$1 \\le n,m \\le 10^5$\u3002\n\n### \u7b97\u6cd5\u601d\u8def\n\n**\u6ce8\uff1a\u4e0b\u6587\u7684\u601d\u8def\u5efa\u7acb\u5728\u7ed9\u5b9a\u7684\u662f\u4e00\u4e2a\u957f\u5ea6\u4e3a $n$ \u7684\u6392\u5217\uff0c\u5373\u4e0d\u5b58\u5728\u76f8\u540c\u5143\u7d20\u7684\u57fa\u7840\u4e0a\u7684\u3002**\n\n\u6211\u4eec\u663e\u7136\u77e5\u9053\u5982\u679c\u6ca1\u6709\u591a\u7ec4\u8be2\u95ee\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5f52\u5e76\u6392\u5e8f\u89e3\u51b3\u3002\n\n\u7531\u4e8e\u6ca1\u6709\u4e00\u4e2a\u5408\u9002\u7684\u6570\u636e\u7ed3\u6784\u80fd\u591f\u4ee5 $\\log$ \u4e4b\u7c7b\u7684\u590d\u6742\u5ea6\u8ba1\u7b97\u533a\u95f4\u9006\u5e8f\u5bf9\uff0c\u8003\u8651\u4f7f\u7528\u5206\u5757\u3002\u8bbe\u5757\u957f\u4e3a $B$\u3002\n\n\u9996\u5148\u8003\u8651\u4e00\u4e2a\u533a\u95f4\u9006\u5e8f\u5bf9\u7684\u8d21\u732e\u6709\u54ea\u4e9b\u3002\n\n- \u9996\u5148\u8003\u8651\u8de8\u8fc7\u6574\u5757\u7684\u3002\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/jcfdd3pf.png)\n\n\u5bb9\u6613\u53d1\u73b0\uff0c\u8d21\u732e\u6709\u5982\u4e0b\u51e0\u79cd\uff1a\n\n1. \u5de6\u4fa7\u548c\u53f3\u4fa7\u6563\u5757\u5185\u90e8\u8d21\u732e\uff0c\u5373\u84dd\u8272\u533a\u57df\u3002\n\n2. \u5de6\u4fa7\u6563\u5757\u4e0e\u4e2d\u95f4\u6574\u5757\u4ee5\u53ca\u4e2d\u95f4\u6574\u5757\u4e0e\u53f3\u4fa7\u6563\u5757\u7684\u8d21\u732e\uff0c\u5373\u9ec4\u8272\u90e8\u5206\u3002\n\n3. \u5de6\u4fa7\u6563\u5757\u5bf9\u53f3\u4fa7\u6563\u5757\u7684\u8d21\u732e\uff0c\u5373\u7ea2\u8272\u6b63\u65b9\u5f62\u90e8\u5206\u3002\n\n4. \u4e2d\u95f4\u6563\u5757\u5185\u90e8\u8d21\u732e\uff0c\u5373\u7ea2\u8272\u4e09\u89d2\u5f62\u90e8\u5206\u3002\n\n\u5bf9\u4e8e\u7b2c $1$ \u7c7b\uff0c\u8003\u8651\u9884\u5904\u7406\u3002\n\n\u8003\u8651\u7ef4\u62a4\u4e24\u4e2a\u6570\u7ec4 $pre_{i,j}$ \u4e0e $suf_{i,j}$ \u5206\u522b\u8868\u793a\u7b2c $i\\times B+j$ \u5230\u7b2c $i$ \u5757\u5f00\u5934/\u672b\u5c3e\u7684\u9006\u5e8f\u5bf9\u6570\u3002\n\n\u8003\u8651\u4f7f\u7528\u6811\u72b6\u6570\u7ec4\u7ef4\u62a4\u5f53\u524d\u5757\u5185\u7684\u5143\u7d20\uff0c\u4ee5\u4fbf\u4e8e\u5feb\u901f\u67e5\u8be2\u5f53\u524d\u524d\u7f00/\u540e\u7f00\u4e2d $\\le x$ \u6216 $\\ge x$ \u7684\u6570\u7684\u4e2a\u6570\u3002\u9884\u5904\u7406\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(n \\log n)$\uff0c\u7a7a\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(\\frac{n}{B}\\times B)=\\mathcal{O}(n)$\u3002\n\n------\n\n\u5bf9\u4e8e\u7b2c $2$ \u7c7b\uff0c\u8003\u8651\u7ef4\u62a4\u51fa $l\\sim r$ \u6574\u5757\u5185 $\\le k$ \u7684\u6570\u7684\u4e2a\u6570\uff0c\u5bf9\u4e8e\u5de6\u4fa7\u6563\u5757\u7684\u6bcf\u4e2a\u6570\u503c $x$\uff0c\u7edf\u8ba1\u4e2d\u95f4\u6709\u591a\u5c11\u4e2a\u6570\u503c $\\le x$\uff1b\u5bf9\u4e8e\u53f3\u4fa7\u6563\u5757\u6bcf\u4e2a\u6570\u503c $x$\uff0c\u7edf\u8ba1\u4e2d\u95f4\u6709\u591a\u5c11\u4e2a\u6570\u503c $\\ge x$\u3002\n\n\u7531\u4e8e\u5b58\u50a8\u5757\u7684\u7aef\u70b9\u4f1a\u4f7f\u5f97\u7a7a\u95f4\u53d8\u4e3a $\\mathcal{O}(\\frac{n}{B}\\times \\frac{n}{B}\\times n)=\\mathcal{O}(\\frac{n^3}{B^2})$\uff0c\u6240\u4ee5\u4f7f\u7528\u524d\u7f00\u548c\u4f18\u5316\uff0c\u5373\u8bb0\u5f55 $1\\sim x$ \u5757\u5185 $\\le k$ \u7684\u6570\u7684\u4e2a\u6570\u3002\u8bb0\u5f55\u65f6\u4f7f\u7528 $cnt$ \u6570\u7ec4\u7ef4\u62a4\u5f53\u524d\u6240\u6709\u503c\u5e76\u5728\u5757\u672b\u7edf\u8ba1\u7b54\u6848\u505a\u524d\u7f00\u548c\u5373\u53ef\u3002\u9884\u5904\u7406\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(\\frac{n^2}{B})$\uff0c\u7a7a\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(\\frac{n^2}{B})$\u3002\n\n-----\n\n\u5bf9\u4e8e\u7b2c $3$ \u7c7b\uff0c\u6ca1\u6709\u5f88\u597d\u7684\u7ef4\u62a4\u65b9\u6cd5\u3002\u6211\u4eec\u65e0\u6cd5\u5728 $n \\sqrt n$ \u7684\u65f6\u95f4\u5185\u5b8c\u6210\u6709\u6548\u7684\u9884\u5904\u7406\uff0c\u4f46\u662f\u7531\u4e8e\u4e24\u8fb9\u70b9\u6570\u5747 $\\le B$ \u5e76\u4e14\u4e0d\u9700\u8981\u4fee\u6539\uff0c\u53ef\u4ee5\u8003\u8651\u7ef4\u62a4\u51fa\u6bcf\u4e2a\u5757\u5185\u6392\u5e8f\u540e\u7684\u6570\u7ec4\u5e76\u5f52\u5e76\u5904\u7406\u3002\n\n\u5177\u4f53\u7684\uff0c\u627e\u5230\u6bcf\u4e2a\u5de6\u4fa7\u6570\u503c\u5728\u5176\u5757\u5185\u7684\u4f4d\u7f6e\uff0c\u5e76\u7edf\u8ba1\u6709\u591a\u5c11\u4e2a\u53f3\u4fa7\u70b9\u6bd4\u4ed6\u5c0f\uff0c\u5355\u6b21\u8be2\u95ee\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(B)$\u3002\n\n------\n\n\u5bf9\u4e8e\u7b2c $4$ \u7c7b\uff0c\u8003\u8651\u76f4\u63a5\u9884\u5904\u7406\u51fa\u7b54\u6848\u3002\n\n\u5728\u7ef4\u62a4\u51fa\u4e0a\u9762\u7c7b\u522b\u540e\uff0c\u53ef\u4ee5\u8f7b\u677e\u4f7f\u7528\u5176\u7ed3\u679c\u6765\u7ef4\u62a4\u8fd9\u4e2a\u7b54\u6848\uff08\u5982\u4e0b\u56fe\uff09\u3002\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/idwnhlnh.png)\n\n\u9996\u5148\u679a\u4e3e\u5de6\u7aef\u5757\uff0c\u7136\u540e\u5411\u53f3\u79fb\u52a8\u6709\u7aef\u5757\uff0c\u8bbe\u5f53\u524d\u5de6\u53f3\u7aef\u5757\u4e3a $l,r$\u3002\u5219\u5728\u5f97\u51fa $ans_{l,r}$ \u524d\u5df2\u7ecf\u5f97\u5230\u4e86 $ans_{l,r-1}$ \u4e0e $ans_{r,r}$\uff08\u5373 $pre_{r,B}$\uff09\uff0c\u5219\u53ea\u9700\u8981\u8003\u8651\u524d\u9762\u7684\u5757\u4e0e\u5f53\u524d\u5757\u4e4b\u95f4\u7684\u8d21\u732e\u5373\u53ef\u3002\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u679a\u4e3e\u5f53\u524d\u5757\u7684\u6bcf\u4e2a\u6570 $x$\uff0c\u7136\u540e\u4f7f\u7528\u7b2c\u4e8c\u7c7b\u7ef4\u62a4\u7684\u4e1c\u897f\u6c42\u51fa\u524d\u9762\u82e5\u5e72\u5757\u5185 $\\ge x$ \u7684\u6570\u7684\u4e2a\u6570\u5373\u53ef\u3002\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(B^2\\times \\frac{n}{B})=\\mathcal{O}(n \\times B)$\uff0c\u7a7a\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(B^2)$\u3002\n\n- \u8003\u8651\u6ca1\u6709\u8de8\u8fc7\u6574\u5757\u7684\u3002\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/xdi6j4dl.png)\n\n\u76f4\u63a5\u8ba1\u7b97\u65f6\u95f4\u590d\u6742\u5ea6\u65e0\u6cd5\u63a5\u53d7\uff0c\u6211\u4eec\u5e0c\u671b\u80fd\u591f\u4f7f\u7528\u4e0a\u9762\u9884\u5904\u7406\u7684\u4fe1\u606f\u8fdb\u884c\u5feb\u901f\u8ba1\u7b97\u3002\n\n\u8003\u8651\u5728\u67e5\u8be2\u533a\u95f4\u5de6\u4fa7\u6216\u53f3\u4fa7\u8865\u5168\u5f53\u524d\u5757\u3002\u8fd9\u91cc\u4ee5\u5de6\u4fa7\u4e3a\u4f8b\uff08\u5982\u4e0a\u56fe\u7c89\u8272\u533a\u57df\uff09\u3002\n\n\u8bbe\u5f53\u524d\u67e5\u8be2\u533a\u95f4\u4e3a $L,R$\uff0c\u5f53\u524d\u5757\u5de6\u7aef\u70b9\u4e3a $BL$\u3002\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 $pre$ \u5f97\u5230\u7c89\u8272\u4e0e\u84dd\u8272\u6574\u4e2a\u90e8\u5206\u7684\u9006\u5e8f\u5bf9\u6570\uff0c\u73b0\u5728\u6211\u4eec\u5e0c\u671b\u51cf\u53bb\u7c89\u8272\u90e8\u5206\u7684\u8d21\u732e\u3002\n\n\u8003\u8651\u6574\u4e2a\u7684\u7b54\u6848\u7531\u4e09\u90e8\u5206\u7ec4\u6210\uff1a\n\n1. \u7c89\u8272\u5185\u90e8\u3002\n2. \u84dd\u8272\u5185\u90e8\u3002\n3. \u7c89\u8272\u5bf9\u84dd\u8272\u8d21\u732e\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5f97\u5230\u7c89\u8272\u5185\u90e8\u7684\u9006\u5e8f\u5bf9\u6570\u3002\u4f46\u662f\u5374\u65e0\u6cd5\u4f7f\u7528\u5df2\u6709\u4fe1\u606f\u5f97\u5230\u7c89\u8272\u5bf9\u84dd\u8272\u7684\u8d21\u732e\u3002\n\n\u4f46\u662f\u6211\u4eec\u4f9d\u7136\u53ef\u4ee5\u4f7f\u7528\u4e0a\u9762\u7b2c $3$ \u7c7b\u7684\u5f52\u5e76\u65b9\u5f0f\u76f4\u63a5\u8ba1\u7b97\u3002\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(B)$\u3002\n\n\u81f3\u6b64\uff0c\u5df2\u7ecf\u53ef\u4ee5\u89e3\u51b3\u672c\u9898\u3002\u5f53 $B=sqrt n$ \u65f6\u603b\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(n \\sqrt n)$\uff0c\u7a7a\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(n \\sqrt n)$\u3002\n\n### \u4ee3\u7801\u5c55\u793a\n```\n#define N 100005\n#define ll long long\n#define M 320\nint n,m,w[N],len;\nll lst;\nstruct node{\n\tint v,id;\n\tinline bool operator<(const node &b)const{\n\t\treturn v<b.v;\n\t}\n}st[N];\n\n#define L(BLOCK) (len*(BLOCK-1)+1)\n#define R(BLOCK) (BLOCK*len>=n?n:BLOCK*len)\nint bel[N];\nint pre[M][N]/*\u7b2c1\u5757~\u7b2ci\u5757<=j\u7684\u4e2a\u6570*/,suf[M][N]/*\u7b2ci\u5757~\u6700\u540e\u4e00\u5757<=j\u7684\u4e2a\u6570*/;\nll comp[M][M];//\u7b2ci\u5757\u5230\u7b2cj\u5757\u4e4b\u95f4\u9006\u5e8f\u5bf9\u6570\u91cf\nint preans[M][M],sufans[M][M]; /*\u7b2ci\u5757\u524d\u3001\u540ej\u4e2a\u6570\u4e2d\u9006\u5e8f\u5bf9\u6570*/\nint cnt[N]; \n\nstruct BIT{\n\tint c[N];\n\t#define lowbit(x) (x&-x)\n\tBIT(){memset(c,0,sizeof(c));}\n\tinline void add(int x,int v){\n\t\tfor(;x<=n;x+=lowbit(x)) c[x]+=v;\n\t}\n\tinline int query(int x){\n\t\tint res=0;\n\t\tfor(;x;x^=lowbit(x)) res+=c[x];\n\t\treturn res;\n\t}\n\t#undef lowbit\n}B;\n\ninline int querypre(int bl,int br,int k){//\u67e5\u8be2\u5757l~\u5757r\u5185\u5c0f\u4e8e\u7b49\u4e8ek\u7684\u6570\u91cf \n\treturn pre[br][k]-pre[bl-1][k];\n}\ninline int querysuf(int bl,int br,int k){//\u67e5\u8be2\u5757l~\u5757r\u5185\u5c0f\u4e8e\u7b49\u4e8ek\u7684\u6570\u91cf \n\treturn suf[bl][k]-suf[br+1][k];\n}\ninline int querynum(int bl,int br){\n\treturn R(br)-L(bl)+1;\n}\n\ninline void prework(){\n\tlen=sqrt(n)+1;\n\tfor(int i=1;i<=n;i++) bel[i]=(i-1)/len+1;\n\tfor(int i=1;i<=n;i++){//\u9884\u5904\u7406pre\n\t\tcnt[w[i]]++;\n\t\tif(i==R(bel[i]))\n\t\t\tfor(int j=1;j<=n;j++) pre[bel[i]][j]=pre[bel[i]][j-1]+cnt[j];\n\t}\n\tmemset(cnt,0,sizeof(cnt));\n\tfor(int i=n;i;i--){\n\t\tcnt[w[i]]++;\n\t\tif(i==L(bel[i]))\n\t\t\tfor(int j=1;j<=n;j++) suf[bel[i]][j]=suf[bel[i]][j-1]+cnt[j];\n\t}\n\tmemset(cnt,0,sizeof(cnt));\n\t\n\tfor(int i=1;i<=bel[n];i++){\n\t\tfor(int j=L(i);j<=R(i);j++)\n\t\t\tpreans[i][j-L(i)+1]=j-L(i)-B.query(w[j])+preans[i][j-L(i)],B.add(w[j],1);\n\t\tfor(int j=L(i);j<=R(i);j++) B.add(w[j],-1);\n\t}\n\tfor(int i=1;i<=bel[n];i++){\n\t\tfor(int j=R(i);j>=L(i);j--)\n\t\t\tsufans[i][j-L(i)+1]=B.query(w[j])+sufans[i][j-L(i)+2],B.add(w[j],1);\n\t\tfor(int j=L(i);j<=R(i);j++) B.add(w[j],-1);\n\t}\n\t\n\tfor(int i=1;i<=bel[n];i++)\n\t\tfor(int j=i;j<=bel[n];j++){\n\t\t\tcomp[i][j]=preans[j][R(j)-L(j)+1]+comp[i][j-1];\n\t\t\tfor(int t=L(j);t<=R(j);t++)\n\t\t\t\tcomp[i][j]+=querynum(i,j-1)-querypre(i,j-1,w[t]);\n\t\t}\n\t\n\tfor(int i=1;i<=bel[n];i++) sort(st+L(i),st+R(i)+1);\n}\nint t1[N],t2[N];\nbool p1[N],p2[N];\ninline ll query(int l,int r){\n\tif(l<1||r<1||l>r||l>n||r>n) return 0;\n\tint bl=bel[l],br=bel[r],I=0,J=0;\n\tll res=0;\n\tif(bl==br){\n\t\tres=preans[bl][r-L(bl)+1]-preans[bl][l-L(bl)];\n\t\tfor(int i=L(bl);i<l;i++) p1[w[i]]=1;\n\t\tfor(int i=l;i<=r;i++) p2[w[i]]=1;\n\t\tfor(int i=L(bl);i<=R(bl);i++)\n\t\t\tif(p1[st[i].v]) t1[++I]=st[i].v;\n\t\t\telse if(p2[st[i].v]) t2[++J]=st[i].v;\n\t\tfor(int i=L(bl);i<l;i++) p1[w[i]]=0;\n\t\tfor(int i=l;i<=r;i++) p2[w[i]]=0;\n\t\tfor(int i=1,j=1;i<=I;i++){\n\t\t\twhile(t1[i]>=t2[j]&&j<=J) j++;\n\t\t\tres-=j-1;\n\t\t}\n\t\treturn res;\n\t}\n\tres=comp[bl+1][br-1]+preans[br][r-L(br)+1]+sufans[bl][l-L(bl)+1];\n\tfor(int i=l;i<=R(bl);i++) res+=querypre(bl+1,br-1,w[i]),p1[w[i]]=1;\n\tfor(int i=L(br);i<=r;i++) res+=querynum(bl+1,br-1)-querysuf(bl+1,br-1,w[i]),p2[w[i]]=1;\n\tfor(int i=L(bl);i<=R(bl);i++) \n\t\tif(p1[st[i].v]) t1[++I]=st[i].v;\n\tfor(int i=L(br);i<=R(br);i++) \n\t\tif(p2[st[i].v]) t2[++J]=st[i].v;\n\tfor(int i=l;i<=R(bl);i++) p1[w[i]]=0;\n\tfor(int i=L(br);i<=r;i++) p2[w[i]]=0;\n\tfor(int i=1,j=1;i<=I;i++){\n\t\twhile(t1[i]>=t2[j]&&j<=J) j++;\n\t\tres+=j-1;\n\t}\n\treturn res;\n}\n\nint main(){\n\tread(n,m);\n\tfor(int i=1;i<=n;i++) read(w[i]),st[i].v=w[i],st[i].id=i;\n\tprework();\n\tfor(ll i=1,l,r;i<=m;i++) read(l,r),put('\\n',lst=query((int)(l^lst),(int)(r^lst)));\n\treturn 0;\n}\n```\n\n\u7136\u800c\uff0c\u8fd9\u662f\u4e00\u9053 Ynoi \u9898\u3002\u672c\u9898\u6781\u4e3a\u5361\u5e38\uff0c\u4ee5\u81f3\u4e8e\u4e0a\u9762\u7684\u4ee3\u7801\u4ec5\u6709 $\\text{40 pts}$ \u5e76\u4e14 TLE \u7684\u4e09\u4e2a\u70b9\u5747\u8d85\u8fc7 $\\text{950 ms}$\u3002\n\n\u8003\u8651\u4f18\u5316\uff0c\u5c06\u90e8\u5206\u5faa\u73af\u538b\u5165\u4e00\u4e2a\u5927\u5faa\u73af\u5185\u90e8\u5e76\u4f18\u5316\u5f52\u5e76\u65b9\u5f0f\uff0c\u53ef\u4ee5\u4f18\u5316\u81f3 $\\text{60 pts}\\sim \\text{80 pts}$\u3002\u8003\u8651\u5230\u9884\u5904\u7406\u53ca\u67e5\u8be2\u4e2d\u590d\u6742\u5ea6\u5305\u542b $B$ \u7684\u8f83\u591a\u5bfc\u81f4\u5e38\u6570\u8f83\u5927\uff0c\u8003\u8651\u5c06\u5757\u957f $B$ \u8c03\u6574\u4e3a $B=2\\times \\sqrt n$ \u5373\u53ef\u3002\n\n\u4e0b\u9762\u662f\u6700\u7ec8\u7684\u4ee3\u7801\u3002\uff08**\u4e0d\u4fdd\u8bc1\u968f\u65f6\u63d0\u4ea4\u5747\u53ef\u901a\u8fc7**\u3002\uff09\n\n```\n#include<bits/stdc++.h>\nusing namespace std; \nnamespace IN{\n    const int MAXINPUT = 1000000;\n    #define getc() (p1==p2&&(p2=(p1=buf)+inbuf->sgetn(buf,MAXINPUT),p1==p2)?EOF:*p1++)\n    char buf[MAXINPUT],*p1,*p2;\n    template<typename T>inline bool read(T &x) {\n        static std::streambuf *inbuf=cin.rdbuf();\n        x=0;\n        register int f=0,flag=false;\n        register char ch=getc();\n        while(!isdigit(ch)){\n            if (ch=='-') f=1;\n        \tch=getc();\n        }\n        if(isdigit(ch)) x=x*10+ch-'0',ch=getc(),flag=true;\n        while(isdigit(ch)) {\n            x=x*10+ch-48;\n            ch=getc();\n        }\n        x=f?-x:x;\n        return flag;\n    }\n    template<typename T,typename ...Args>inline bool read(T& a,Args& ...args) {\n       return read(a)&&read(args...);\n    }\n    #undef getc\n}\n\nnamespace OUT{\n    template<typename T>inline void put(T x){\n        static std::streambuf *outbuf=cout.rdbuf();\n        static char stack[21];\n        static int top=0;\n        if(x<0){\n            outbuf->sputc('-');\n            x=-x;\n        }\n        if(!x){\n            outbuf->sputc('0');\n            outbuf->sputc('\\n');\n            return;\n        }\n        while(x){\n            stack[++top]=x%10+'0';\n            x/=10;\n        }\n        while(top){\n            outbuf->sputc(stack[top]);\n            --top;\n        }\n        outbuf->sputc('\\n');\n    }\n    inline void putc(const char ch){\n        static std::streambuf *outbuf=cout.rdbuf();\n        outbuf->sputc(ch);\n    }\n    inline void putstr(string s){\n    \tfor(register int i=0;i<s.length();i++) putc(s[i]);\n\t}\n    template<typename T>inline void put(const char ch,T x){\n        static std::streambuf *outbuf=cout.rdbuf();\n        static char stack[21];\n        static int top = 0;\n        if(x<0){\n            outbuf->sputc('-');\n            x=-x;\n        }\n        if(!x){\n            outbuf->sputc('0');\n            outbuf->sputc(ch);\n            return;\n        }\n        while(x){\n            stack[++top]=x%10+'0';\n            x/=10;\n        }\n        while(top){\n            outbuf->sputc(stack[top]);\n            --top;\n        }\n        outbuf->sputc(ch);\n    }\n    template<typename T,typename ...Args> inline void put(T a,Args ...args){\n        put(a);put(args...);\n    }\n    template<typename T,typename ...Args> inline void put(const char ch,T a,Args ...args){\n        put(ch,a);put(ch,args...);\n    }\n}\nusing namespace IN;\nusing namespace OUT;\n#define N 100005\n#define ll long long\n#define M 1005\nint n,m,w[N],len;\nll lst;\nstruct node{\n\tint v,id;\n\tinline bool operator<(const node &b)const{\n\t\treturn v<b.v;\n\t}\n}st[N];\n\nint bel[N],L[M],R[M];\nint pre[M][N]/*\u7b2c1\u5757~\u7b2ci\u5757<=j\u7684\u4e2a\u6570*/;\nll comp[M][M];//\u7b2ci\u5757\u5230\u7b2cj\u5757\u4e4b\u95f4\u9006\u5e8f\u5bf9\u6570\u91cf\nint preans[M][M],sufans[M][M]; /*\u7b2ci\u5757\u524d\u3001\u540ej\u4e2a\u6570\u4e2d\u9006\u5e8f\u5bf9\u6570*/\nint cnt[N]; \n\nstruct BIT{\n\tint c[N];\n\t#define lowbit(x) (x&-x)\n\tinline void add(int x,int v){\n\t\tfor(;x<=n;x+=lowbit(x)) c[x]+=v;\n\t}\n\tinline int query(int x){\n\t\tint res=0;\n\t\tfor(;x;x^=lowbit(x)) res+=c[x];\n\t\treturn res;\n\t}\n\t#undef lowbit\n}B;\n\n#define querypre(bl,br,k) (pre[br][k]-pre[bl-1][k])\n#define querynum(bl,br) (R[br]-L[bl]+1)\nint t1[N],t2[N];\ninline ll query(int l,int r){\n\tif(l<1||r<1||l>r||l>n||r>n) return 0;\n\tint bl=bel[l],br=bel[r],I=0,J=0;\n\tll res=0;\n\tif(bl==br){\n\t\tres=preans[bl][r-L[bl]+1]-preans[bl][l-L[bl]];\n\t\tfor(int i=L[bl];i<=R[bl];i++)\n\t\t\tif(L[bl]<=st[i].id&&st[i].id<l) t1[++I]=st[i].v;\n\t\t\telse if(l<=st[i].id&&st[i].id<=r) t2[++J]=st[i].v;\n\t\tfor(int i=1,j=1;i<=I;i++){\n\t\t\twhile(t1[i]>=t2[j]&&j<=J) j++;\n\t\t\tres-=j-1;\n\t\t}\n\t\treturn res;\n\t}\n\tres=comp[bl+1][br-1]+preans[br][r-L[br]+1]+sufans[bl][l-L[bl]+1];\n\tfor(int i=l;i<=R[bl];i++) res+=querypre(bl+1,br-1,w[i]);\n\tfor(int i=L[br];i<=r;i++) res+=querynum(bl+1,br-1)-querypre(bl+1,br-1,w[i]);\n\tfor(int i=L[bl];i<=R[bl];i++) \n\t\tif(l<=st[i].id&&st[i].id<=R[bl]) t1[++I]=st[i].v;\n\tfor(int i=L[br];i<=R[br];i++) \n\t\tif(L[br]<=st[i].id&&st[i].id<=r) t2[++J]=st[i].v;\n\tfor(int i=1,j=1;i<=I;i++){\n\t\twhile(t1[i]>=t2[j]&&j<=J) j++;\n\t\tres+=j-1;\n\t}\n\treturn res;\n}\n\nint main(){\n\tread(n,m);\n\tfor(int i=1;i<=n;i++) read(w[i]),st[i].v=w[i],st[i].id=i;\n\tlen=(int)sqrt(n)/2+1;\n\tfor(int i=1;i<=n;i++) bel[i]=(i-1)/len+1;\n\tfor(int i=1;i<=bel[n];i++) L[i]=(i-1)*len+1,R[i]=min(n,i*len);\n\tfor(int i=1;i<=n;i++){//\u9884\u5904\u7406pre\n\t\tcnt[w[i]]++;\n\t\tif(i==R[bel[i]])\n\t\t\tfor(int j=1;j<=n;j++) pre[bel[i]][j]=pre[bel[i]][j-1]+cnt[j];\n\t}\n\tfor(int i=1;i<=bel[n];i++){\n\t\tfor(int j=L[i];j<=R[i];j++)\n\t\t\tpreans[i][j-L[i]+1]=j-L[i]-B.query(w[j])+preans[i][j-L[i]],B.add(w[j],1);\n\t\tfor(int j=L[i];j<=R[i];j++) B.add(w[j],-1);\n\t\tfor(int j=R[i];j>=L[i];j--)\n\t\t\tsufans[i][j-L[i]+1]=B.query(w[j])+sufans[i][j-L[i]+2],B.add(w[j],1);\n\t\tfor(int j=L[i];j<=R[i];j++) B.add(w[j],-1);\n\t\tsort(st+L[i],st+R[i]+1);\n\t}\n\tfor(int i=1;i<=bel[n];i++)\n\t\tfor(int j=i;j<=bel[n];j++){\n\t\t\tcomp[i][j]=preans[j][R[j]-L[j]+1]+comp[i][j-1];\n\t\t\tfor(int t=L[j];t<=R[j];t++)\n\t\t\t\tcomp[i][j]+=querynum(i,j-1)-querypre(i,j-1,w[t]);\n\t\t}\n\tfor(ll i=1,l,r;i<=m;i++) read(l,r),put('\\n',lst=query((int)(l^lst),(int)(r^lst)));\n\treturn 0;\n}\n\n```\n\n",
        "postTime": 1642489292,
        "uid": 172370,
        "name": "fzj2007",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P5046 [Ynoi2019 \u6a21\u62df\u8d5b] Yuno loves sqrt technology I"
    },
    {
        "content": "\n\n\u672c\u9898\u5c31\u662f\u5feb\u901f\u6c42\u4e00\u6bb5\u533a\u95f4\u9006\u5e8f\u5bf9\u3002 lxl \u8bf4\u6709  $n^{1.41}$  \u6b21\u505a\u6cd5\uff0c\u53ef\u5c0f\u849f\u84bb\u6839\u672c\u4e0d\u4f1a\u53ea\u80fd\u7528 $n \\sqrt n$   \u7684\u505a\u6cd5\n\n\u7531\u4e8e\u672c\u9898\u5f3a\u5236\u5728\u7ebf\u4e14\u6570\u636e\u4e0d\u4fee\u6539\uff0c\u56fa\u6211\u4eec\u5bf9\u6570\u636e\u8fdb\u884c\u9884\u5904\u7406\u3002\n\n\u8bbe $f[i][j]$  \u8868\u793a\u524d $j$ \u4e2a\u4f4d\u7f6e\u4e0e\u7b2c $i$  \u7684\u5757\u4ea7\u751f\u7684\u9006\u5e8f\u5bf9\u6570\u3002$dp[i][j]$  \u8868\u793a\u7b2c $i$ \u4e2a\u5757\u5230\u7b2c $j$  \u4e2a\u5757\u4ea7\u751f\u7684\u9006\u5e8f\u5bf9\u6570\u3002$L[i],R[i]$ \u5206\u522b\u8868\u793a\u4e00\u4e2a\u5757\u7684\u5de6\u53f3\u533a\u95f4\uff0c $id[i]$ \u8868\u793a\u4e00\u4e2a\u6570\u6240\u5c5e\u7684\u5757\u3002$p[i] , z[i]$ \u5206\u522b\u8868\u793a\u4e00\u4e2a\u503c     $i$  \u5176 $L[id[i]] \\to i$ \u200b \u7684\u9006\u5e8f\u5bf9\u6570\u4e0e $i \\to R[id[i]]$  \u7684\u9006\u5e8f\u5bf9\u6570\u3002\n\n\u5bf9\u4e8e$p[i],z[i]$ \u6211\u4eec\u7528\u6811\u72b6\u6570\u7ec4\u66b4\u529b\u7ef4\u62a4\u5373\u53ef\u65f6\u95f4\u590d\u6742\u5ea6 $n \\log n$\u200b \n\n\u5bf9\u4e8e $f[i][j]$\u200b\u200b \u5148\u5904\u7406 $j<L[i]$\u200b\u200b \u7684\u60c5\u51b5\u3002\u6b63\u5e8f\u5904\u7406\uff0c\u6bcf\u6b21\u628a\u8981\u626b\u5730\u5757\u6392\u5e8f\uff0c\u7136\u540e\u4e0e\u4e4b\u524d\u7684\u6570\u8fdb\u884c\u4e00\u6b21\u5f52\u5e76\u3002\u56e0\u4e3a\u4e24\u8fb9\u90fd\u662f\u6709\u5e8f\u7684\uff0c\u56fa\u53ea\u8981\u5bf9\u6bcf\u4e2a\u5757\u4e00\u6b21\u5373\u53ef\u3002\u590d\u6742\u5ea6 $n \\sqrt n$\u200b\u200b  \uff0c\u5bf9\u4e8e $j>R[i]$\u200b\u200b\u200b \u4e5f\u662f\u4e00\u6837\u7684\u3002\u7136\u540e\u5bf9 $f[i][j]$\u200b\u200b\u200b \u505a\u524d\u7f00\u548c\u5373\u53ef\u3002\n\n\u5bf9\u4e8e $dp[i][j]$\u200b\u200b \u6211\u4eec\u5217\u51fa\u533a\u95f4dp\u65b9\u7a0b: $dp[i][j]=dp[i][j-1]+dp[i-1][j]-dp[i-1][j-1]+w(i,j)$\u200b\u200b\u200b,\n\n\u5176\u4e2d $w(i,j)$\u200b \u4e3a $i,j$\u200b \u4e24\u5757\u9006\u5e8f\u5bf9\u4e2a\u6570\u3002$w(i,j)=f[i][j]-f[i][j]$\u200b\n\n\u6211\u4eec\u8fd8\u8981\u628a\u6bcf\u4e00\u5757\u6309\u5927\u5c0f\u6392\u5e8f\u65b9\u4fbf\u64cd\u4f5c\u3002\n\n\u8fd9\u6837\u9884\u5904\u7406\u5c31\u5b8c\u6210\u4e86\u3002\n\n\n------------\n\n\n\u5173\u4e8e\u8be2\u95ee\uff0c\u5bf9\u4e8e $l,r$\u200b\u200b\u200b \u5728\u540c\u4e00\u5757\u91cc\u7684\uff0c$L[id[l]] \\to l $\u200b\u200b\u200b\u200b \u7684\u653e\u5728\u5de6\u6570\u7ec4\u4e2d\uff0c $[l,r]$\u200b\u200b\u200b\u200b \u8fd9\u4e00\u6bb5\u653e\u5165\u53f3\u6570\u7ec4\u4e2d\uff0c\u5bf9\u5176\u8fdb\u884c\u4e00\u6b21\u5f52\u5e76\u6392\u5e8f\uff0c\u7b54\u6848\u8bb0\u4e3a $res$\u200b\u200b , $ans=p[r]-p[l-1]-res$\u200b ,\u6ce8\u610f\u5f53 $l==L[id]$ \u65f6\u4e0d\u80fd\u51cf\u53bb $p[l-1]$ \uff0c\u4e0d\u7136\u4f1a\u5bfc\u81f4\u9519\u8bef\uff0c\u6ce8\u610f\u7279\u5224\uff0c\u5c0f\u849f\u84bb\u56e0\u4e3a\u8fd9\u4e2a\u8d21\u732e\u4e86\u534a\u9762\u63d0\u4ea4\uff0c\u65f6\u95f4 $n \\sqrt n$ \u3002\n\n\u5bf9\u4e8e $l,r$ \u4e0d\u5728\u540c\u4e00\u5757\u7684\u60c5\u51b5\uff0c\u6211\u4eec\u5148\u5904\u7406\u96f6\u6563\u5757\u5185\u90e8\uff0c\u5176\u7b54\u6848\u5c31\u662f $z[l]+p[r]$ \u3002\u7136\u540e\u662f\u6563\u5757\u4e4b\u95f4\u7684\u8d21\u732e\uff0c\u6211\u4eec\u7528\u5f52\u5e76\u6392\u5e8f\uff0c\u5de6\u8fb9\u6563\u5757\u7684\u653e\u5165\u5de6\u6570\u7ec4\uff0c\u53f3\u8fb9\u6563\u5757\u653e\u5165\u53f3\u6570\u7ec4\uff0c\u56e0\u4e3a\u6709\u5e8f\uff0c\u53ea\u8981\u8fdb\u884c\u4e00\u6b21\u5c31\u591f\u4e86\uff0c\u8bb0\u4e3a $res$\u200b \u3002\n\n\u7136\u540e\u662f\u6574\u5757\u5bf9\u6563\u5757 \uff0c\u6563\u5757\u5bf9\u6574\u5757\uff0c\u6211\u4eec\u679a\u4e3e\u6bcf\u4e2a\u5757\uff0c\u6bcf\u6b21\u5bf9\u7b54\u6848\u52a0\u4e0a$f[j][L[id[l]+1]-1]-f[j][l-1]+f[j][r]-f[j][R[id[r]-1]]$\u200b\u200b  \u5373\u53ef\u3002\u200b\uff08$j$\u200b \u6307\u7b2c $j$\u200b\u200b\u200b \u5757\uff09\n\n\u6574\u5757\u4e4b\u95f4\u5f88\u7b80\u5355\u5df2\u7ecf\u9884\u5904\u7406\u51fa\u6765\u4e86\uff0c\u5c31\u662f $dp[id[l]+1][id[r]-1]$ \u3002\n\n\u7b54\u6848\u5c31\u662f\u4e0a\u8ff0\u52a0\u8d77\u6765\u3002   \n\n\n------------\n\u4ee3\u7801\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n//static char buf[1000000],*p1=buf,*p2=buf;\n//#define getchar() p1==p2&&(p2=(p1=buf)+fread(buf,1,1000000,stdin),p1==p2)?EOF:*p1++\n#define re register\n#define lowbit(x) (x&(-x))\nconst int maxn=1e5+5,B=345;\ninline int read()\n{\n\tchar ch=getchar();bool f=0;int x=0;\n\tfor(;!isdigit(ch);ch=getchar())if(ch=='-')f=1;\n\tfor(;isdigit(ch);ch=getchar())x=(x<<1)+(x<<3)+(ch^48);\n\tif(f==1)x=-x;return x;\n}\nvoid print(long long x)\n{\n    if(x<0) putchar('-'),x=-x;\n    if(x>9) print(x/10);\n    putchar(x%10+'0');\n}\nstruct node{int x,id;}a[maxn],d[maxn],w[maxn],b[maxn];\nint n,f[B][maxn],g,c[maxn],p[maxn],z[maxn],lx[maxn],ly[maxn],L[maxn],R[maxn],res,m,t,o[maxn],id[maxn];\nlong long ans,dp[B][B];\nvoid add(int x,int num){for(int i=x;i<=n;i+=lowbit(i))c[i]+=num;}\nint query(int x){int res=0;for(int i=x;i>0;i-=lowbit(i))res+=c[i];return res;} \nbool cmp(node a,node b){return a.x<b.x;}\nvoid msort1(int b1,int l,int r)\n{\n\tif(l==1)return;l--;int tot=0;res=0;\n\tint i=1,j=l+1;\n\tfor(;i<=l&&j<=r;)\n\t\tif(a[i].x>a[j].x)res++,b[++tot]=a[j++];\n\t\telse  f[b1][a[i].id]=res,b[++tot]=a[i++];\n\twhile(i<=l)f[b1][a[i].id]=res,b[++tot]=a[i++];\n\twhile(j<=r)b[++tot]=a[j++];\n\tfor(int i=1;i<=r;i++)a[i]=b[i];\n}\nvoid msort2(int b1,int l,int r)\n{\n\tif(r==n)return;int tot=0;res=0;\n\tint i=l,j=r+1;\n\tfor(;i<=r&&j<=n;)\n\t\tif(d[i].x>d[j].x)f[b1][d[j].id]=r-i+1,b[++tot]=d[j++];\n\t\telse  b[++tot]=d[i++];\n\twhile(i<=r)b[++tot]=d[i++];\n\twhile(j<=n)b[++tot]=d[j++];\n\tfor(int i=l;i<=n;i++)d[i]=b[i-l+1];\n}\nvoid msort3(int l,int r)\n{\n\tint tot=0;res=0;\n\tint i=1,j=1;\n\tfor(;i<=l&&j<=r;)\n\t\tif(lx[i]>ly[j])j++,res+=l-i+1;\n\t\telse  i++;\n}\nsigned main()\n{\n\t//freopen(\"t.in\",\"r\",stdin);\n\t//freopen(\".out\",\"w\",stdout);\n\tn=read();m=read();t=sqrt(n);g=(n-1)/t+1;\n\tfor(int i=1;i<=n;i++)a[i].x=read(),a[i].id=i,id[i]=(i-1)/t+1,d[i]=w[i]=a[i];\n\tfor(int i=1;i<=g;i++)\n\t{\n\t\tL[i]=(i-1)*t+1,R[i]=min(i*t,n);int l=L[i],r=R[i];\n\t\tfor(int j=l;j<=r;j++)\n\t\t\tadd(a[j].x,1),p[j]=f[i][j]=query(n)-query(a[j].x);\n\t\tfor(int j=l+1;j<=r;j++)p[j]=p[j-1]+p[j];\n\t\tfor(int j=l;j<=r;j++)add(a[j].x,-1);\n\t\tsort(a+l,a+r+1,cmp);sort(w+l,w+r+1,cmp);\n\t\tmsort1(i,l,r);\t\n\t}\n\tfor(int i=g;i>=1;i--)\n\t{\n\t\tint l=L[i],r=R[i];\n\t\tfor(int j=r;j>=l;j--)\n\t\t\tadd(d[j].x,1),z[j]=query(d[j].x-1);\n\t\tfor(int j=r-1;j>=l;j--)z[j]=z[j+1]+z[j];\n\t\tfor(int j=l;j<=r;j++)add(d[j].x,-1);sort(d+l,d+r+1,cmp);\n\t\tmsort2(i,l,r);\n\t\tfor(int j=1;j<=n;j++)f[i][j]=f[i][j]+f[i][j-1];\t\n\t}\n\tfor(int i=1;i<=g;i++)dp[i][i]=f[i][R[i]]-f[i][L[i]-1];\n\tfor(int i=g;i>=1;i--)\n\t\tfor(int j=i+1;j<=g;j++)\n\t\t\tdp[i][j]=dp[i][j-1]+dp[i+1][j]-dp[i+1][j-1]+f[j][R[i]]-f[j][L[i]-1];\n\tint l,r;\n\tfor(int i=1;i<=m;i++)\n\t{\n\t\tl=read(),r=read();long long x=l^ans,y=r=r^ans;\n\t\tans=0;res=0;\n\t\tif(x>y||x>n||y>n||x<=0||y<=0){puts(\"0\");ans=0;continue;}\n\t\tl=x,r=y;\n\t\tif(id[l]==id[r])\n\t\t{\n\t\t\tint s1=0,s2=0;\n\t\t\tfor(int j=L[id[l]];j<=R[id[l]];j++)\n\t\t\t{\n\t\t\t\tif(w[j].id<=r&&w[j].id>=l)ly[++s2]=w[j].x;\n\t\t\t\telse if(w[j].id<l)lx[++s1]=w[j].x;\n\t\t\t}\n\t\t\tmsort3(s1,s2);ans=p[r]-p[l-1]-res;\n\t\t\tprintf(\"%lld\\n\",ans);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tint s1=0,s2=0;\n\t\t\tfor(int j=L[id[l]];j<=R[id[l]];j++)\n\t\t\t\tif(w[j].id<=r&&w[j].id>=l)lx[++s1]=w[j].x;\n\t\t\tfor(int j=L[id[r]];j<=R[id[r]];j++)\n\t\t\t\tif(w[j].id<=r&&w[j].id>=l)ly[++s2]=w[j].x;\n\t\t\tmsort3(s1,s2);int num=0;\n\t\t\tfor(int j=id[l]+1;j<=id[r]-1;j++)\n\t\t\t\tnum=num+f[j][L[id[l]+1]-1]-f[j][l-1]+f[j][r]-f[j][R[id[r]-1]];\n\t\t\tans=res+dp[id[l]+1][id[r]-1]+z[l]+p[r]+num;\n\t\t\tprint(ans);puts(\"\");\n\t\t}\n\t}\n \treturn 0;\n}\n\n```\n\u5b8c\u7ed3\u6563\u82b1\n\n",
        "postTime": 1627023269,
        "uid": 343748,
        "name": "louhao088",
        "ccfLevel": 9,
        "title": "\u9898\u89e3P5046 Ynoi2019 \u6a21\u62df\u8d5bYuno loves sqrt technology I"
    },
    {
        "content": "\u5c0f\u6e05\u65b0\u5206\u5757\uff0c\u633a\u6709\u610f\u601d\u7684\u3002\n\n\u8ddf |x| \u6597\uff0c\u633a\u6709\u610f\u601d\u7684\uff08\n\nupd:\u6dfb\u52a0\u4e86\u6d4b\u8bd5\u70b9 6~12\u3002~~\u4e8e\u662f\u5de6\u53f3\u7aef\u70b9\u540c\u5757\u65f6\u5e26 $\\log$ \u7684\u505a\u6cd5\u88ab\u5361\u5230\u4e86 749ms\u3002~~\u8fdb\u884c\u4fee\u6539\u3002\n\n## \u5199\u7684\u70c2\u7684\u6839\u53f7\u53eb\u66b4\u529b\n\n\u5f04\u4e3b\u5e2d\u6811\u3002\n\n\u9884\u5904\u7406\u6574\u5757\u4e4b\u95f4\u9006\u5e8f\u5bf9\u3002\n\n\u4e3b\u5e2d\u7b97\u6563\u5757\u8d21\u732e\u3002\n\n## code\n\n\u6ca1\u5206\u3002\n\n```cpp\n#include<stdio.h>\n#define N 100001\n#define B 7\ninline char nc()\n{\n\tstatic char buf[99999],*l,*r;\n\treturn l==r&&(r=(l=buf)+fread(buf,1,99999,stdin),l==r)?EOF:*l++;\n}\ninline void read(int&x)\n{\n\tchar c=nc();for(;c<'0'||'9'<c;c=nc());\n\tfor(x=0;'0'<=c&&c<='9';x=(x<<3)+(x<<1)+(c^48),c=nc());\n}\ninline void read(long long&x)\n{\n\tchar c=nc();for(;c<'0'||'9'<c;c=nc());\n\tfor(x=0;'0'<=c&&c<='9';x=(x<<3)+(x<<1)+(c^48),c=nc());\n}\nstruct node{int cnt,l,r;}tre[N*18];\nint n,m,q,a[N],rt[N];long long b[(N>>B)+1][(N>>B)+1],ans;\ninline void upd(int&i,const int&l,const int&r,const int&x)\n{\n\t++m;if(i)tre[m]=tre[i];i=m;++tre[i].cnt;\n\tif(l^r)\n\t{\n\t\tint mid=l+r>>1;\n\t\tif(x<=mid)upd(tre[i].l,l,mid,x);\n\t\telse upd(tre[i].r,mid+1,r,x);\n\t}\n}\ninline int query(const int&i,const int&l,const int&r,const int&x)\n{\n\tif(!i||r<x)return 0;\n\tif(x<=l)return tre[i].cnt;\n\tint mid=l+r>>1;\n\treturn query(tre[i].l,l,mid,x)+query(tre[i].r,mid+1,r,x);\n}\nmain()\n{\n\tread(n);read(q);\n\tfor(int i=1;i<=n;++i)\n\t\tread(a[i]),upd(rt[i]=rt[i-1],1,n,a[i]);\n\tfor(int i=0;i<=n>>B;++i)for(int j=i<<B;j<=n;++j)\n\t{\n\t\tif(!(j&(1<<B)-1))b[i][j>>B]=b[i][j-1>>B];\n\t\tb[i][j>>B]+=query(rt[j-1],1,n,a[j])-(i?query(rt[(i<<B)-1],1,n,a[j]):0);\n\t}\n\tfor(long long l,r;q--;printf(\"%lld\\n\",ans))\n\t{\n\t\tread(l);read(r);l^=ans;r^=ans;ans=0;\n\t\tfor(;l<=r&&(l&(1<<B)-1);++l)\n\t\t\tans+=r-l-(query(rt[r],1,n,a[l])-query(rt[l],1,n,a[l]));\n\t\tif(l<=r)\n\t\t{\n\t\t\tfor(;~r&(1<<B)-1;--r)\n\t\t\t\tans+=query(rt[r-1],1,n,a[r])-query(rt[l-1],1,n,a[r]);\n\t\t\tif(l<=r)ans+=b[l>>B][r>>B];\n\t\t}\n\t}\n}\n```\n\n## \u4f18\u5316\n\n\u628a\u4e3b\u5e2d\u4ece\u9012\u5f52\u6539\u6210\u975e\u9012\u5f52\u7684\u3002\n\n\u4e3b\u5e2d\u6811\u592a\u62c9\u4e86\u3002\u6539\u7528 01trie\u3002\n\n## code\n\n\u4f9d\u7136\u6ca1\u5206\u3002\n\n```cpp\nint n,m,q,a[N],rt[N],cnt[N*18],tre[N*18][2];\nlong long b[(N>>B)+1][(N>>B)+1],ans;\ninline int newnode(const int&x)\n{\n\t++m;\n\tif(x)cnt[m]=cnt[x],tre[m][0]=tre[x][0],tre[m][1]=tre[x][1];\n\treturn m;\n}\ninline void upd(int*i,const int&x)\n{\n\t*i=newnode(*i);\n\tfor(int j=16;j>=0;--j)\n\t{\n\t\ti=&tre[*i][x>>j&1];\n\t\t*i=newnode(*i);\n\t\t++cnt[*i];\n\t}\n}\ninline int query(int i,const int&x)\n{\n\tint ans=0;\n\tfor(int j=16;j>=0&&i;--j)\n\t\tif(x>>j&1)i=tre[i][1];\n\t\telse ans+=cnt[tre[i][1]],i=tre[i][0];\n\treturn ans+cnt[i];\n}\n```\n\n## \u4f18\u5316\n\n\u6ce8\u610f\u5230\u6211\u4eec\u6709\u5f88\u591a\u5f62\u5982 `query(rt[i-1],a[i])` \u548c `query(rt[i],a[i])` \u7684\u4e1c\u897f\u3002\u628a\u4ed6\u62ff\u51fa\u6765\u9884\u5904\u7406\u3002\n\n\u5206\u522b\u53eb\u505a `lft` \u548c `rgt`\u3002\n\n## code\n\n\u8fc7\u4e00\u4e2a\u70b9\u4e86\u54c8\u54c8\u3002\n\n```cpp\nmain()\n{\n\tread(n);read(q);\n\tfor(int i=1;i<=n;++i)read(a[i]),upd(&(rt[i]=rt[i-1]),a[i]);\n\tfor(int i=1;i<=n;++i)lft[i]=query(rt[i-1],a[i]),rgt[i]=query(rt[i],a[i]);\n\tfor(int i=0;i<=n>>B;++i)for(int j=i<<B;j<=n;++j)\n\t{\n\t\tif(!(j&(1<<B)-1))b[i][j>>B]=b[i][j-1>>B];\n\t\tb[i][j>>B]+=lft[j]-(i?query(rt[(i<<B)-1],a[j]):0);\n\t}\n\tfor(long long l,r;q--;printf(\"%lld\\n\",ans))\n\t{\n\t\tread(l);read(r);l^=ans;r^=ans;ans=0;\n\t\tfor(;l<=r&&(l&(1<<B)-1);++l)\n\t\t\tans+=r-l-(query(rt[r],a[l])-rgt[l]);//\u8fd9\u91cc\u6709log\n\t\tif(l<=r)\n\t\t{\n\t\t\tfor(;~r&(1<<B)-1;--r)\n\t\t\t\tans+=lft[r]-query(rt[l-1],a[r]);//\u8fd9\u91cc\u6709log\n\t\t\tif(l<=r)ans+=b[l>>B][r>>B];\n\t\t}\n\t}\n}\n```\n\n## \u4f18\u5316\n\n\u6ce8\u610f\u5230 `query(rt[(i<<B)-1],a[j])` \u548c `query(rt[l-1],a[r])`\uff0c\u90fd\u4ee3\u8868\u7740\u67e5\u8be2\u524d\u7f00\u82e5\u5e72\u4e2a\u5757\u7684\u4e1c\u897f\u3002\n\n\u53d1\u73b0 01trie \u592a\u900a\u4e86\u3002\u5bf9\u4e8e\u6bcf\u524d\u7f00\u82e5\u5e72\u4e2a\u6574\u5757\uff0c\u642d\u4e00\u4e2a\u540e\u7f00\u548c $\\mathcal O(1)$ \u67e5\u8be2\u3002\n\n## code\n\n\u73b0\u5728\u80fd\u8fc7\u4e24\u4e2a\u70b9\u4e86\u54c8\u54c8\u54c8\uff08\u8981\u770b\u8bc4\u6d4b\u6ce2\u52a8\u54e6\uff09\u3002\u5176\u5b9e\u9884\u5904\u7406\u90e8\u5206\u5df2\u7ecf\u5b8c\u5168\u6ca1\u6709\u8001\u54e5\u4e86\u3002\u67e5\u8be2\u91cc\u9762\u8fd8\u6709\u534a\u4e2a\uff08\u76f8\u6bd4\u4e4b\u524d\u7684\u6765\u8bf4\u7b97\u534a\u4e2a\uff09\u3002\n\n```cpp\n\tfor(int i=0;i<=n>>B;++i)\n\t{\n\t\tfor(int j=i<<B;j<=n;++j)\n\t\t\tb[i][j>>B]+=lft[j]-(i?sfx[i-1][a[j]]:0);\n\t\tfor(int j=i+1;j<=n>>B;++j)b[i][j]+=b[i][j-1];\n\t}\n\tfor(long long l,r;q--;printf(\"%lld\\n\",ans))\n\t{\n\t\tread(l);read(r);l^=ans;r^=ans;ans=0;\n\t\tfor(;l<=r&&(l&(1<<B)-1);++l)\n\t\t\tans+=r-l-(query(rt[r],a[l])-rgt[l]);//\u8fd9\u91cc\u6709\u534a\u53ealog\n\t\tif(l<=r)\n\t\t{\n\t\t\tfor(;~r&(1<<B)-1;--r)\n\t\t\t\tans+=lft[r]-sfx[l-1>>B][a[r]];\n\t\t\tif(l<=r)ans+=b[l>>B][r>>B];\n\t\t}\n\t}\n```\n\n## \u4f18\u5316\n\n`query(rt[r],a[l])` \u662f\u5728\u5e72\u561b\uff1f\n\n\u6c42 $[1,r]$ \u4e2d $\\geq a[l]$ \u7684\u6570\u91cf\u3002\n\n\u8bb0 $rr$ \u4e3a\u6700\u540e\u4e00\u4e2a\u6574\u5757\u7684\u7f16\u53f7\u3002\n\n\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u5427 $[l,r]$ \u7684\u8be2\u95ee\u62c6\u6389\uff0c\u53d8\u6210\u4e00\u5768\u6574\u5757 $[1,rr\\times B]$\uff08\u7528\u4e0a\u9762\u7684\u65b9\u6cd5\uff09\u548c\u6563\u5757 $(rr\\times B,r]$\u3002\n\n\u6392\u4e2a\u5e8f\u5f52\u5e76\u4e00\u4e0b\u3002\n\n## code\n\n\u7a33\u7a33\u7684\u8fc7\u540e 45 \u4e2a\u70b9\uff0c\u6700\u6162\u70b9\u5c31 900ms\u3002\n\n```cpp\n#include<stdio.h>\n#include<algorithm>\n#define N 100001\n#define B 7\ninline char nc()\n{\n\tstatic char buf[99999],*l,*r;\n\treturn l==r&&(r=(l=buf)+fread(buf,1,99999,stdin),l==r)?EOF:*l++;\n}\ninline void read(int&x)\n{\n\tchar c=nc();for(;c<'0'||'9'<c;c=nc());\n\tfor(x=0;'0'<=c&&c<='9';x=(x<<3)+(x<<1)+(c^48),c=nc());\n}\ninline void read(long long&x)\n{\n\tchar c=nc();for(;c<'0'||'9'<c;c=nc());\n\tfor(x=0;'0'<=c&&c<='9';x=(x<<3)+(x<<1)+(c^48),c=nc());\n}\nint n,m,q,a[N],rt[N],cnt[N*18],tre[N*18][2],sfx[(N>>B)+1][N];\nlong long b[(N>>B)+1][(N>>B)+1],ans,lft[N],rgt[N];int c[N],szc,d[N],szd;\ninline int newnode(const int&x)\n{\n\t++m;\n\tif(x)cnt[m]=cnt[x],tre[m][0]=tre[x][0],tre[m][1]=tre[x][1];\n\treturn m;\n}\ninline void upd(int*i,const int&x)\n{\n\t*i=newnode(*i);\n\tfor(int j=16;j>=0;--j)i=&tre[*i][x>>j&1],*i=newnode(*i),++cnt[*i];\n}\ninline int noip(int i,const int&x)\n{\n\tint ans=0;\n\tfor(int j=16;j>=0&&i;--j)\n\t\tif(x>>j&1)i=tre[i][1];\n\t\telse ans+=cnt[tre[i][1]],i=tre[i][0];\n\treturn ans+cnt[i];\n}\nmain()\n{\n\tread(n);read(q);\n\tfor(int i=1;i<=n;++i)read(a[i]),upd(&(rt[i]=rt[i-1]),a[i]);\n\tfor(int i=1;i<=n;++i)lft[i]=noip(rt[i-1],a[i]),rgt[i]=noip(rt[i],a[i]);\n\tfor(int i=1;i<=n;++i)++sfx[i>>B][a[i]];\n\tfor(int i=1;i<=n>>B;++i)for(int j=1;j<=n;++j)sfx[i][j]+=sfx[i-1][j];\n\tfor(int i=0;i<=n>>B;++i)for(int j=n-1;j;--j)sfx[i][j]+=sfx[i][j+1];\n\tfor(int i=0;i<=n>>B;++i)\n\t{\n\t\tfor(int j=i<<B;j<=n;++j)\n\t\t\tb[i][j>>B]+=lft[j]-(i?sfx[i-1][a[j]]:0);\n\t\tfor(int j=i+1;j<=n>>B;++j)b[i][j]+=b[i][j-1];\n\t}\n\tfor(long long l,r,rr;q--;printf(\"%lld\\n\",ans))\n\t{\n\t\tread(l);read(r);l^=ans;r^=ans;ans=0;rr=(r+1>>B)-1;\n\t\tif(l>>B==r>>B)\n\t\t{\n\t\t\tfor(;l<=r;++l)ans+=r-l-(noip(rt[r],a[l])-rgt[l]);//\u8fd9\u91cc\u67091/4\u53ealog\n\t\t\tcontinue;\n\t\t}\n\t\tszc=szd=0;\n\t\tfor(;l&(1<<B)-1;++l)\n\t\t\tans+=r-l+rgt[l]-sfx[rr][a[l]],c[szc++]=a[l];\n\t\tstd::sort(c,c+szc);\n\t\tfor(;~r&(1<<B)-1;--r)ans+=lft[r]-sfx[l-1>>B][a[r]],d[szd++]=a[r];\n\t\tstd::sort(d,d+szd);\n\t\tint i=0,j=0;\n\t\tfor(;i<szc&&j<szd;)\n\t\t\tif(c[i]<d[j])++i;\n\t\t\telse ans-=i,++j;\n\t\tfor(;j<szd;ans-=i,++j);\n\t\tif(l<=r)ans+=b[l>>B][r>>B];\n\t}\n}\n```\n\n## \u4f18\u5316\n\n\u9e21\u6392\u3002\n\n## code\n\n\u7528\u4e0b\u9762\u8fd9\u4efd\u9e21\u6392\uff0c\u5757\u957f\u53d6 128\uff0c\u6700\u6162\u70b9 870ms \u5de6\u53f3\u3002\n\n```cpp\ninline void lxl(int*c,const int&sz)\n{\n\tstatic int a[32][1<<B],b[32][1<<B];\n\tfor(int i=0;i<sz;++i)\n\t\ta[c[i]&31][++a[c[i]&31][0]]=c[i];\n\tfor(int i=0,j;i<32;a[i++][0]=0)\n\t\tfor(j=1;j<=a[i][0];\n\t\t\tb[a[i][j]>>5&31][++b[a[i][j]>>5&31][0]]=a[i][j],++j);\n\tfor(int i=0,j;i<32;b[i++][0]=0)\n\t\tfor(j=1;j<=b[i][0];\n\t\t\ta[b[i][j]>>10&31][++a[b[i][j]>>10&31][0]]=b[i][j],++j);\n\tfor(int i=0,j;i<32;a[i++][0]=0)\n\t\tfor(j=1;j<=a[i][0];\n\t\t\tb[a[i][j]>>15][++b[a[i][j]>>15][0]]=a[i][j],++j);\n\tfor(int i=0,j,k=0;i<32;b[i++][0]=0)\n\t\tfor(j=1;j<=b[i][0];c[k++]=b[i][j++]);\n}\n```\n\n## \u4f18\u5316\n\n\u8be2\u95ee\u7684\u533a\u95f4\u5de6\u53f3\u7aef\u70b9\u5728\u540c\u4e00\u5757\u4e2d\u65f6\uff0c\u663e\u7136\u53ef\u4ee5\u9884\u5904\u7406\uff1a\n\n$e[i][j]$ \u8868\u793a $[i,i+j]$ \u4e2d\u6709\u591a\u5c11\u4e2a\u6bd4 $i$ \u5c0f\uff0c\u5176\u4e2d $j<B$\u3002\n\n\u518d\u659c\u7740\u505a\u4e00\u4e2a\u540e\u7f00\u548c\uff0c\u5c31\u80fd $\\mathcal O(1)$ \u4e86\u3002\n\n## code\n\n\u5e38\u6570\u66f4\u5927\u4e86\uff0c\u8dd1\u7684\u53cd\u800c\u6162\u7684\u79bb\u8c31\u3002\u3002\u3002\n\n```cpp\n\tfor(int i=n;i;--i)\n\t{\n\t\tfor(int j=1;j<1<<B&&i+j<=n;++j)\n\t\t\tf[i][j]=f[i][j-1]+(a[i]>a[i+j]);\n\t\tfor(int j=1;j<1<<B&&i+j<=n;++j)f[i][j]+=f[i+1][j-1];\n\t}\n```\n\n## \u4f18\u5316\n\n\u5f00\u59cb\u7384\u5b66\u5361\u5e38\u3002\n\n\u5faa\u73af\u5c55\u5f00\u3002\n\n\u9e21\u6392\u626c\u4e86\u3002\n\n\u9884\u5148\u6392\u597d\u5e8f\u3002\u7136\u540e\u5728\u6563\u5757\u4e2d\u6309\u987a\u5e8f\u63d0\u53d6\u51fa\u5728\u8be2\u95ee\u8303\u56f4\u5185\u7684\u70b9\u3002\n\n\u611f\u8c22 wmx \u544a\u8bc9\u6211\u8fd9\u4e2a\u4f18\u5316\u3002\n\n## code\n\n```cpp\n#include<stdio.h>\n#include<algorithm>\n#define N 100008\n#define B 7\nusing namespace std;\ninline char nc()\n{\n\tstatic char buf[99999],*l,*r;\n\treturn l==r&&(r=(l=buf)+fread(buf,1,99999,stdin),l==r)?EOF:*l++;\n}\ninline void read(int&x)\n{\n\tchar c=nc();for(;c<'0'||'9'<c;c=nc());\n\tfor(x=0;'0'<=c&&c<='9';x=(x<<3)+(x<<1)+(c^48),c=nc());\n}\ninline void read(long long&x)\n{\n\tchar c=nc();for(;c<'0'||'9'<c;c=nc());\n\tfor(x=0;'0'<=c&&c<='9';x=(x<<3)+(x<<1)+(c^48),c=nc());\n}\nint n,m,q,a[N],rt[N],cnt[N*18],tre[N*18][2],sfx[(N>>B)+1][N],e[N];\nlong long b[(N>>B)+1][(N>>B)+8],ans,lft[N],rgt[N];\nint c[N],szc,d[N],szd,f[N][1<<B];\ninline int newnode(const int&x)\n{\n\t++m;\n\tif(x)cnt[m]=cnt[x],tre[m][0]=tre[x][0],tre[m][1]=tre[x][1];\n\treturn m;\n}\ninline void upd(int*i,const int&x)\n{\n\t*i=newnode(*i);\n\tfor(int j=16;j>=0;--j)i=&tre[*i][x>>j&1],*i=newnode(*i),++cnt[*i];\n}\ninline int noip(int i,const int&x)\n{\n\tint ans=0;\n\tfor(int j=16;j>=0&&i;--j)\n\t\tif(x>>j&1)i=tre[i][1];\n\t\telse ans+=cnt[tre[i][1]],i=tre[i][0];\n\treturn ans+cnt[i];\n}\ninline bool cmp(const int&x,const int&y){return a[x]<a[y];}\nmain()\n{\n\tread(n);read(q);\n\tfor(int i=1;i<=n;++i)read(a[i]),upd(&(rt[i]=rt[i-1]),a[i]);\n\tfor(int i=1;i<=n;++i)lft[i]=noip(rt[i-1],a[i]),rgt[i]=noip(rt[i],a[i]);\n\tfor(int i=1;i<=n;++i)++sfx[i>>B][a[i]];\n\tfor(int i=1;i<=n>>B;++i)\n\t\tfor(int j=1;j<=n;j+=8)\n\t\t\tsfx[i][j]+=sfx[i-1][j],sfx[i][j+1]+=sfx[i-1][j+1],\n\t\t\tsfx[i][j+2]+=sfx[i-1][j+2],sfx[i][j+3]+=sfx[i-1][j+3],\n\t\t\tsfx[i][j+4]+=sfx[i-1][j+4],sfx[i][j+5]+=sfx[i-1][j+5],\n\t\t\tsfx[i][j+6]+=sfx[i-1][j+6],sfx[i][j+7]+=sfx[i-1][j+7];\n\tfor(int i=0;i<=n>>B;++i)\n\t\tfor(int j=n>>3<<3;j>=0;j-=8)\n\t\t\tsfx[i][j+7]+=sfx[i][j+8],sfx[i][j+6]+=sfx[i][j+7],\n\t\t\tsfx[i][j+5]+=sfx[i][j+6],sfx[i][j+4]+=sfx[i][j+5],\n\t\t\tsfx[i][j+3]+=sfx[i][j+4],sfx[i][j+2]+=sfx[i][j+3],\n\t\t\tsfx[i][j+1]+=sfx[i][j+2],sfx[i][j]+=sfx[i][j+1];\n\tfor(int i=0;i<=n>>B;++i)\n\t{\n\t\tfor(int j=i<<B;j<=n;j+=8)\n\t\t\tb[i][j>>B]+=lft[j]+lft[j+1]+lft[j+2]+lft[j+3]+lft[j+4]+lft[j+5]\n\t\t\t\t+lft[j+6]+lft[j+7]-(i?sfx[i-1][a[j]]+sfx[i-1][a[j+1]]+\n\t\t\t\tsfx[i-1][a[j+2]]+sfx[i-1][a[j+3]]+sfx[i-1][a[j+4]]+\n\t\t\t\tsfx[i-1][a[j+5]]+sfx[i-1][a[j+6]]+sfx[i-1][a[j+7]]:0);\n\t\tfor(int j=i+1;j<=n>>B;j+=8)\n\t\t\tb[i][j]+=b[i][j-1],b[i][j+1]+=b[i][j],\n\t\t\tb[i][j+2]+=b[i][j+1],b[i][j+3]+=b[i][j+2],\n\t\t\tb[i][j+4]+=b[i][j+3],b[i][j+5]+=b[i][j+4],\n\t\t\tb[i][j+6]+=b[i][j+5],b[i][j+7]+=b[i][j+6];\n\t}\n\tfor(int i=n;i;--i)\n\t{\n\t\tfor(int j=0,k=1<<B-3;k--&&i+j<=n;j+=8)\n\t\t\tj&&(f[i][j]=f[i][j-1]+(a[i]>a[i+j])),\n\t\t\ti+j+1<=n&&(f[i][j+1]=f[i][j]+(a[i]>a[i+j+1])),\n\t\t\ti+j+2<=n&&(f[i][j+2]=f[i][j+1]+(a[i]>a[i+j+2])),\n\t\t\ti+j+3<=n&&(f[i][j+3]=f[i][j+2]+(a[i]>a[i+j+3])),\n\t\t\ti+j+4<=n&&(f[i][j+4]=f[i][j+3]+(a[i]>a[i+j+4])),\n\t\t\ti+j+5<=n&&(f[i][j+5]=f[i][j+4]+(a[i]>a[i+j+5])),\n\t\t\ti+j+6<=n&&(f[i][j+6]=f[i][j+5]+(a[i]>a[i+j+6])),\n\t\t\ti+j+7<=n&&(f[i][j+7]=f[i][j+6]+(a[i]>a[i+j+7]));\n\t\tif(i==n)continue;\n\t\tfor(int j=0,k=1<<B-3;k--&&i+j<=n;j+=8)\n\t\t\tj&&(f[i][j]+=f[i+1][j-1]),\n\t\t\ti+j+1<=n&&(f[i][j+1]+=f[i+1][j]),\n\t\t\ti+j+2<=n&&(f[i][j+2]+=f[i+1][j+1]),\n\t\t\ti+j+3<=n&&(f[i][j+3]+=f[i+1][j+2]),\n\t\t\ti+j+4<=n&&(f[i][j+4]+=f[i+1][j+3]),\n\t\t\ti+j+5<=n&&(f[i][j+5]+=f[i+1][j+4]),\n\t\t\ti+j+6<=n&&(f[i][j+6]+=f[i+1][j+5]),\n\t\t\ti+j+7<=n&&(f[i][j+7]+=f[i+1][j+6]);\n\t}\n\tfor(int i=1;i<=n;e[i]=i,++i);\n\tfor(int i=0;i<=n>>B;++i)sort(e+(i<<B),e+min(i+1<<B,n+1),cmp);\n\tfor(long long l,r,rr;q--;printf(\"%lld\\n\",ans))\n\t{\n\t\tread(l);read(r);l^=ans;r^=ans;ans=0;rr=(r+1>>B)-1;\n\t\tif(r-l<1<<B)\n\t\t{\n\t\t\tans=f[l][r-l];\n\t\t\tcontinue;\n\t\t}\n\t\tszc=szd=0;\n\t\tif(l&(1<<B)-1)\n\t\t{\n\t\t\tfor(int i=l>>B<<B,j=1<<B-3;j--;i+=8)\n\t\t\t\te[i]>=l&&(c[szc++]=a[e[i]]),\n\t\t\t\te[i+1]>=l&&(c[szc++]=a[e[i+1]]),\n\t\t\t\te[i+2]>=l&&(c[szc++]=a[e[i+2]]),\n\t\t\t\te[i+3]>=l&&(c[szc++]=a[e[i+3]]),\n\t\t\t\te[i+4]>=l&&(c[szc++]=a[e[i+4]]),\n\t\t\t\te[i+5]>=l&&(c[szc++]=a[e[i+5]]),\n\t\t\t\te[i+6]>=l&&(c[szc++]=a[e[i+6]]),\n\t\t\t\te[i+7]>=l&&(c[szc++]=a[e[i+7]]);\n\t\t\tfor(;l&(1<<B)-1;++l)ans+=r-l+rgt[l]-sfx[rr][a[l]];\n\t\t}\n\t\tif(~r&(1<<B)-1)\n\t\t{\n\t\t\tfor(int i=r>>B<<B,j=1<<B-3;j--&&i<=n;i+=8)\n\t\t\t\te[i]<=r&&(d[szd++]=a[e[i]]),\n\t\t\t\ti+1<=n&&e[i+1]<=r&&(d[szd++]=a[e[i+1]]),\n\t\t\t\ti+1<=n&&e[i+2]<=r&&(d[szd++]=a[e[i+2]]),\n\t\t\t\ti+1<=n&&e[i+3]<=r&&(d[szd++]=a[e[i+3]]),\n\t\t\t\ti+1<=n&&e[i+4]<=r&&(d[szd++]=a[e[i+4]]),\n\t\t\t\ti+1<=n&&e[i+5]<=r&&(d[szd++]=a[e[i+5]]),\n\t\t\t\ti+1<=n&&e[i+6]<=r&&(d[szd++]=a[e[i+6]]),\n\t\t\t\ti+1<=n&&e[i+7]<=r&&(d[szd++]=a[e[i+7]]);\n\t\t\tfor(;~r&(1<<B)-1;--r)ans+=lft[r]-sfx[l-1>>B][a[r]];\n\t\t}\n\t\tint i=0,j=0;\n\t\tfor(;i<szc&&j<szd;)\n\t\t\tif(c[i]<d[j])++i;\n\t\t\telse ans-=i,++j;\n\t\tans-=szc*(szd-j);\n\t\tif(l<=r)ans+=b[l>>B][r>>B];\n\t}\n}\n```\n\n![](https://cdn.luogu.com.cn/upload/pic/44003.png)\n",
        "postTime": 1667224981,
        "uid": 90693,
        "name": "_\u2022\u0301\u3078\u2022\u0301\u256c_",
        "ccfLevel": 7,
        "title": "P5046 [Ynoi2019 \u6a21\u62df\u8d5b] Yuno loves sqrt technology I"
    },
    {
        "content": "[\u6d1b\u8c37\u9898\u9762\u4f20\u9001\u95e8](https://www.luogu.com.cn/problem/P5046)\n\n~~zszz\uff0clxl \u51fa\u7684 DS \u90fd\u662f\u5361\u5e38\u9898\uff08~~\n\n\u9996\u5148\u7531\u4e8e\u6b64\u9898\u5f3a\u5236\u5728\u7ebf\uff0c\u56e0\u6b64\u8003\u8651**\u5206\u5757**\uff0c\u6211\u4eec\u90a3\u4e48\u5f85\u67e5\u8be2\u533a\u95f4 $[l,r]$ \u53ef\u4ee5\u5f88\u81ea\u7136\u5730\u88ab\u5206\u4e3a\u4e09\u4e2a\u90e8\u5206\uff1a\n\n- \u5de6\u6563\u5757\n- \u4e2d\u95f4\u7684\u6574\u5757\n- \u53f3\u6563\u5757\n\n\u90a3\u4e48\u8fd9\u6837\u4e00\u6765\u533a\u95f4\u9006\u5e8f\u5bf9\u7684\u6765\u6e90\u53ef\u4ee5\u6709\u4ee5\u4e0b\u51e0\u79cd\uff1a\n\n- \u5de6\u6563\u5757\u5185\u90e8\u7684\u533a\u95f4\u9006\u5e8f\u5bf9\n- \u53f3\u6563\u5757\u5185\u90e8\u7684\u533a\u95f4\u9006\u5e8f\u5bf9\n- \u6bcf\u4e2a\u6574\u5757\u5185\u90e8\u7684\u533a\u95f4\u9006\u5e8f\u5bf9\n- \u5de6\u6563\u5757\u4e0e\u4e2d\u95f4\u6574\u5757\u4e4b\u95f4\u7684\u9006\u5e8f\u5bf9\n- \u53f3\u6563\u5757\u4e0e\u4e2d\u95f4\u6574\u5757\u4e4b\u95f4\u7684\u9006\u5e8f\u5bf9\n- \u4e2d\u95f4\u6574\u5757\u4e24\u4e24\u4e4b\u95f4\u7684\u9006\u5e8f\u5bf9\n- \u5de6\u6563\u5757\u4e0e\u53f3\u6563\u5757\u4e4b\u95f4\u7684\u9006\u5e8f\u5bf9\n\n\u5bf9\u4e8e\u524d\u4e09\u79cd\u60c5\u51b5\uff0c\u6211\u4eec\u53ef\u4ee5\u8bb0\u5f55\u8fd9\u6837\u4e24\u4e2a\u6570\u7ec4\uff1a\n\n- $pre_j$\uff1a$j$ \u6240\u5728\u6574\u5757\u5de6\u7aef\u70b9\u5230 $j$ \u8fd9\u6bb5\u533a\u95f4\u5185\u9006\u5e8f\u5bf9\u4e2a\u6570\n- $suf_j$\uff1a$j$ \u5230 $j$ \u6240\u5728\u6574\u5757\u53f3\u7aef\u70b9\u8fd9\u6bb5\u533a\u95f4\u5185\u9006\u5e8f\u5bf9\u4e2a\u6570\n\n\u5bf9\u4e8e\u7b2c\u56db\u3001\u4e94\u4e24\u79cd\u60c5\u51b5\uff0c\u663e\u7136\u662f\u8981\u6c42\u4e00\u4e2a\u533a\u95f4\u5185\u6bd4\u67d0\u4e2a\u6570\u5c0f/\u5927\u7684\u6570\u7684\u4e2a\u6570\uff0c\u8fd9\u4e2a\u53ef\u4ee5\u901a\u8fc7\u7ef4\u62a4\u4ee5\u4e0b\u6570\u7ec4\u6c42\u51fa\uff1a\n\n- $lft_{i,j}$\uff1a\u5728\u524d $j$ \u4e2a\u6574\u5757\u4e2d\u6709\u591a\u5c11\u4e2a\u6570 $>a_i$\n- $rit_{i,j}$\uff1a\u5728\u7b2c $j$ \u4e2a\u6574\u5757\u5230\u7b2c $cnt$ \u4e2a\u6574\u5757\u4e2d\u6709\u591a\u5c11\u4e2a\u6570 $<a_i$\n\n\u6c42\u51fa\u8fd9\u4e24\u4e1c\u4e1c\u4e4b\u540e\u7b2c\u56db\u3001\u4e94\u79cd\u60c5\u51b5\u4e00\u8fb9\u524d\u7f00\u548c\u5e26\u8d70\u5373\u53ef\u3002\n\n\u5bf9\u4e8e\u7b2c\u516d\u79cd\u60c5\u51b5\u6211\u4eec\u4e5f\u7c7b\u4f3c\u5730\u7ef4\u62a4\u4ee5\u4e0b\u6570\u7ec4\uff1a\n\n- $bl_{i,j}$\uff1a\u7b2c $i$ \u4e2a\u6574\u5757\u4e0e\u524d $j$ \u4e2a\u6574\u5757\u4e4b\u95f4\u6709\u591a\u5c11\u4e2a\u9006\u5e8f\u5bf9\n\n\u5bf9\u4e8e\u7b2c\u4e03\u79cd\u60c5\u51b5\u8c8c\u4f3c\u6ca1\u6709\u4ec0\u4e48\u65b9\u6cd5\u76f4\u63a5\u5904\u7406\uff0c\u4e0d\u8fc7\u8003\u8651\u4e00\u4e2a trick \u53eb\u5f52\u5e76\u6392\u5e8f\uff0c\u5bf9\u4e8e\u4e24\u4e2a\u6392\u597d\u5e8f\u7684\u6709\u5e8f\u6570\u7ec4\uff0c\u6211\u4eec\u662f\u53ef\u4ee5\u5728\u7ebf\u6027\u65f6\u95f4\u5185\u6c42\u51fa\u5b83\u4eec\u6392\u597d\u5e8f\u540e\u7684\u9006\u5e8f\u5bf9\u4e2a\u6570\u7684\u3002\u56e0\u6b64\u6211\u4eec\u7ef4\u62a4\u6bcf\u4e2a\u5757\u6392\u597d\u5e8f\u7684\u6570\u7ec4\uff0c\u90a3\u4e48\u6211\u4eec\u5728 $l$ \u6240\u5728\u7684\u5757\u4e0e $r$ \u6240\u5728\u7684\u5757\u4e2d\u8dd1\u4e00\u904d\u53cc\u9488\uff0c\u5373\u5728\u7b2c $l$ \u4e2a\u5757\u6392\u597d\u5e8f\u7684\u6570\u7ec4\u4e2d\u679a\u4e3e\u4e00\u4e2a $a_i$\uff0c\u90a3\u4e48\u663e\u7136\u5728\u7b2c $r$ \u4e2a\u5757\u6392\u597d\u5e8f\u7684\u6570\u7ec4\u4e2d\uff0c\u6ee1\u8db3 $a_j<a_i$ \u7684 $j$ \u663e\u7136\u7ec4\u6210\u4e00\u6bb5\u524d\u7f00\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u53cc\u9488\u627e\u51fa\u8fd9\u6bb5\u524d\u7f00\uff0c\u7136\u540e\u7edf\u8ba1\u4e00\u4e0b\u8fd9\u6bb5\u524d\u7f00\u4e2d\u6709\u591a\u5c11\u4e2a\u4f4d\u7f6e $\\le r$ \u5373\u53ef\u3002\n\n\u4e0a\u8ff0\u60c5\u51b5\u90fd\u662f\u9488\u5bf9 $l,r$ \u4e0d\u5728\u540c\u4e00\u4e2a\u6574\u5757\u4e2d\u7684\u60c5\u51b5\uff0c\u5bf9\u4e8e $l,r$ \u5728\u540c\u4e00\u4e2a\u6574\u5757\u4e2d\u7684\u60c5\u51b5\uff0c\u6211\u4eec\u8bbe $l,r$ \u6240\u5728\u7684\u6574\u5757\u4e3a $[L,R]$\uff0c\u90a3\u4e48\u533a\u95f4 $[l,r]$ \u7684\u9006\u5e8f\u5bf9\u4e2a\u6570\u5c31\u53ef\u4ee5\u7528 $[L,r]$ \u7684\u9006\u5e8f\u5bf9\u4e2a\u6570\u51cf\u53bb $[L,l-1]$ \u4e2d\u9006\u5e8f\u5bf9\u7684\u4e2a\u6570\uff0c\u518d\u51cf\u53bb $[L,l-1]$ \u4e0e $[l,r]$ \u4e4b\u95f4\u7684\u9006\u5e8f\u5bf9\u4e2a\u6570\uff0c\u524d\u4e24\u4e2a\u503c\u90fd\u53ef\u4ee5\u901a\u8fc7\u6211\u4eec\u4e4b\u524d\u7ef4\u62a4\u7684 $pre$ \u6570\u7ec4\u6c42\u51fa\uff0c\u81f3\u4e8e\u7b2c\u4e09\u4e2a\u2026\u2026\u76f8\u4fe1\u806a\u660e\u7684\u8bfb\u8005\u4eec\u5982\u679c\u660e\u767d\u4e86\u4e0a\u9762\u7684\u7b2c\u4e03\u79cd\u60c5\u51b5\uff0c\u4e5f\u80fd\u5f88\u5feb\u77e5\u9053\u8fd9\u4e2a\u600e\u4e48\u7ef4\u62a4\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $(n+m)\\sqrt{n}$\uff0c\u7136\u9e45\u7531\u4e8e\u5b9e\u73b0\u7684\u4e0d\u597d\uff0c\u5b83 TLE \u4e86\uff0c\u53ea\u8fc7\u4e86\u7b2c 5 \u4e2a\u6d4b\u8bd5\u70b9\u3002\n\n\u9644\uff1a20pts \u7684\u4ee3\u7801\uff1a\n\n```cpp\nconst int MAXN=1e5;\nconst int BLK=500;\nint n,qu,a[MAXN+5],pre[MAXN+5],suf[MAXN+5],buc[MAXN+5];\npii b[BLK+5][BLK+5];int sum[BLK+5][MAXN+5];\nint lft[MAXN+5][BLK+5],rit[MAXN+5][BLK+5];\nint bl[BLK+5][BLK+5];\nint blk_cnt=0,blk_sz=0,L[BLK+5],R[BLK+5],bel[MAXN+5];\nint t[MAXN+5];\nvoid add(int x,int v){for(int i=x;i<=n;i+=(i&(-i))) t[i]+=v;}\nint ask(int x){int ret=0;for(int i=x;i;i&=(i-1)) ret+=t[i];return ret;}\nll query(int l,int r){\n\tif(l<1||l>n||r<1||r>n||l>r) return 0;\n\tif(bel[l]==bel[r]){\n\t\tll sum=pre[r];\n\t\tif(l^L[bel[l]]) sum-=pre[l-1];\n\t\tfor(int i=1,c=0;i<=R[bel[l]]-L[bel[l]]+1;i++){\n\t\t\tif(b[bel[l]][i].se<l) sum-=c;\n\t\t\tc+=(l<=b[bel[l]][i].se&&b[bel[l]][i].se<=r);\n\t\t} return sum;\n\t} else {\n\t\tll sum=0;sum+=suf[l];sum+=pre[r];\n\t\tfor(int i=bel[l]+1;i<bel[r];i++) sum+=pre[R[i]];\n\t\tfor(int i=bel[l]+1;i<bel[r];i++) sum+=bl[i][i-1]-bl[i][bel[l]];\n\t\tfor(int i=l;i<=R[bel[l]];i++) sum+=rit[i][bel[l]+1]-rit[i][bel[r]];\n\t\tfor(int i=L[bel[r]];i<=r;i++) sum+=lft[i][bel[r]-1]-lft[i][bel[l]];\n\t\tfor(int i=1,j=1,c=0;i<=R[bel[l]]-L[bel[l]]+1;i++){\n\t\t\twhile(j<=R[bel[r]]-L[bel[r]]+1&&b[bel[r]][j].fi<b[bel[l]][i].fi){\n\t\t\t\tc+=(b[bel[r]][j].se<=r);j++;\n\t\t\t} if(b[bel[l]][i].se>=l) sum+=c;\n\t\t}\n\t\treturn sum;\n\t}\n}\nint main(){\n\tscanf(\"%d%d\",&n,&qu);\n\tblk_sz=400;blk_cnt=(n-1)/blk_sz+1;\n\tfor(int i=1;i<=n;i++) scanf(\"%d\",&a[i]);\n\tfor(int i=1;i<=blk_cnt;i++){\n\t\tL[i]=(i-1)*blk_sz+1;R[i]=min(i*blk_sz,n);\n\t\tfor(int j=L[i];j<=R[i];j++) bel[j]=i;\n\t}\n\tfor(int i=1;i<=n;i++) b[bel[i]][i-L[bel[i]]+1]=mp(a[i],i);\n\tfor(int i=1;i<=blk_cnt;i++) sort(b[i]+1,b[i]+R[i]-L[i]+2);\n\tfor(int i=1;i<=n;i++) sum[bel[i]][a[i]]++;\n\tfor(int i=1;i<=blk_cnt;i++) for(int j=1;j<=n;j++)\n\t\tsum[i][j]+=sum[i][j-1];\n\tfor(int i=1;i<=blk_cnt;i++){\n\t\tmemset(t,0,sizeof(t));ll sum=0;\n\t\tfor(int j=L[i];j<=R[i];j++){\n\t\t\tpre[j]=(sum+=j-L[i]-ask(a[j]));\n\t\t\tadd(a[j],1);\n\t\t} memset(t,0,sizeof(t));sum=0;\n\t\tfor(int j=R[i];j>=L[i];j--){\n\t\t\tsuf[j]=(sum+=ask(a[j]));\n\t\t\tadd(a[j],1);\n\t\t}\n\t}\n\tfor(int i=1;i<=blk_cnt;i++){\n\t\tfor(int j=1;j<=n;j++) buc[j]+=sum[i][j];\n\t\tfor(int j=R[i]+1;j<=n;j++) lft[j][i]=R[i]-buc[a[j]];\n\t} memset(buc,0,sizeof(buc));\n\tfor(int i=blk_cnt;i;i--){\n\t\tfor(int j=1;j<=n;j++) buc[j]+=sum[i][j];\n\t\tfor(int j=L[i]-1;j;j--) rit[j][i]=buc[a[j]-1];\n\t}\n\tfor(int i=1;i<=blk_cnt;i++) for(int j=1;j<i;j++) for(int k=L[i];k<=R[i];k++) bl[i][j]+=lft[k][j];\n\tll pre=0;\n\twhile(qu--){\n\t\tll l,r;scanf(\"%lld%lld\",&l,&r);l^=pre;r^=pre;\n\t\tprintf(\"%lld\\n\",pre=query(l,r));\n\t}\n\treturn 0;\n}\n```\n\n\u7136\u540e\u5c31\u5230\u4e86\u5947\u6deb\u7684\u5361\u5e38\u65f6\u95f4\u4e86\uff0c\u6211\u9996\u5148\u7384\u5b66\u822c\u5730\u4e09\u5206\u4e86\u4e0b\u5757\u957f\u5e76\u52a0\u4e86\u4e2a IO \u4f18\u5316\uff0c\u7136\u9e45\u5e76\u6ca1\u6709\u4ec0\u4e48\u5375\u7528\uff0c\u8be5 T \u7684\u8fd8\u662f T \u6389\u4e86\u3002\n\n\u5176\u6b21\u6211\u4eec\u6ce8\u610f\u5230\u518d\u6c42 $lft,rit$ \u7684\u8fc7\u7a0b\u7528\u5230\u4e86\u7ef4\u62a4\u7b2c $i$ \u4e2a\u5757 occurrence \u7684\u524d\u7f00\u548c\u6570\u7ec4 $sum_{i,j}$\uff0c\u4e8b\u5b9e\u4e0a\u8fd9\u4e1c\u897f\u5927\u53ef\u4e0d\u5fc5\u63d0\u524d\u9884\u5904\u7406\u51fa\u6765\uff0c\u8fd9\u6837\u8017\u65f6\u95f4\u53c8\u8017\u7a7a\u95f4\uff0c\u56e0\u6b64\u6211\u5c06\u5b83\u6539\u4e3a\uff0c\u7ef4\u62a4\u4e00\u4e2a\u4e34\u65f6\u6570\u7ec4 $c_j$\uff0c\u626b\u5230\u7b2c $i$ \u5757\u65f6\u518d\u6c42\u51fa\u8fd9\u4e00\u5757\u7684\u524d\u7f00\u548c\uff0c\u6211\u8fd8\u52a0\u4e86\u4e00\u4e2a\u5c0f\u5c0f\u7684\u526a\u679d\uff0c\u5c31\u662f\u6c42\u51fa\u8fd9\u4e00\u5757\u4e2d $a_i$ \u7684\u6700\u5c0f\u503c $mn$\uff0c\u6c42\u524d\u7f00\u548c\u65f6\u4ece $mn$ \u5f00\u59cb\u679a\u4e3e\uff0c\u6b63\u786e\u6027\u663e\u7136\uff0c\u4f46\u662f\u4f3c\u4e4e\u7528\u5904\u4e0d\u5927\u3002\n\n\u63a5\u4e0b\u6765\u6211\u53d1\u73b0\u8fd9\u4e2a $lft$ \u548c $rit$ \u6570\u7ec4\u5b9a\u4e49\u4e0e\u529f\u80fd\u7c7b\u4f3c\uff0c\u90fd\u53ef\u4ee5\u6c42\u67d0\u4e2a\u524d\u7f00\u5c0f\u4e8e\u67d0\u4e2a\u6570\u7684\u4e2a\u6570\uff0c\u4e8b\u5b9e\u4e0a\u5b83\u4eec\u5b8c\u5168\u53ef\u4ee5\u5408\u5e76\u6210\u4e00\u4e2a\u6570\u7ec4\uff0c\u56e0\u6b64\u6211\u5c31\u628a\u6c42 $rit$ \u90a3\u4e00\u90e8\u5206\u7684 $n\\sqrt{n}$ \u5220\u6389\uff0c\u7136\u540e\u51e0\u4e2a\u7ec6\u8282\u7a0d\u5fae\u6539\u4e86\u6539\uff0c\u5e38\u6570\u786e\u5b9e\u5c0f\u4e86\u4e0d\u5c11\uff0c\u7b2c\u4e94\u4e2a\u6d4b\u8bd5\u70b9\u53c8\u539f\u6765 546ms \u53d8\u6210\u4e86 371ms\uff0c\u7b2c\u56db\u4e2a\u70b9\u65f6\u800c A \u65f6\u800c T\uff0c\u5269\u4e0b\u4e09\u4e2a\u70b9\u4ecd\u7136 TLE\u3002\n\n\u9644\uff1a40pts \u7684\u4ee3\u7801\uff1a\n\n```cpp\nusing namespace fastio;\nconst int MAXN=1e5;\nconst int BLK=500;\nint n,qu,a[MAXN+5],pre[MAXN+5],suf[MAXN+5],buc[MAXN+5];\npii b[BLK+5][BLK+5];int c[MAXN+5];\nint lt[MAXN+5][BLK+5],bl[BLK+5][BLK+5];\nint blk_cnt=0,blk_sz=0,L[BLK+5],R[BLK+5],bel[MAXN+5];\nint t[MAXN+5];\nvoid add(int x,int v){for(int i=x;i<=n;i+=(i&(-i))) t[i]+=v;}\nint ask(int x){int ret=0;for(int i=x;i;i&=(i-1)) ret+=t[i];return ret;}\nll query(int l,int r){\n\tif(l<1||l>n||r<1||r>n||l>r) return 0;\n\tif(bel[l]==bel[r]){\n\t\tll sum=pre[r];\n\t\tif(l^L[bel[l]]) sum-=pre[l-1];\n\t\tfor(int i=1,c=0;i<=R[bel[l]]-L[bel[l]]+1;i++){\n\t\t\tif(b[bel[l]][i].se<l) sum-=c;\n\t\t\tc+=(l<=b[bel[l]][i].se&&b[bel[l]][i].se<=r);\n\t\t} return sum;\n\t} else {\n\t\tll sum=0;sum+=suf[l];sum+=pre[r];\n\t\tfor(int i=bel[l]+1;i<bel[r];i++) sum+=pre[R[i]]+bl[i][i-1]-bl[i][bel[l]];\n\t\tfor(int i=l;i<=R[bel[l]];i++) sum+=lt[i][bel[r]-1]-lt[i][bel[l]];\n\t\tfor(int i=L[bel[r]];i<=r;i++) sum+=(L[bel[r]]-R[bel[l]]-1)-(lt[i][bel[r]-1]-lt[i][bel[l]]);\n\t\tfor(int i=1,j=1,c=0;i<=R[bel[l]]-L[bel[l]]+1;i++){\n\t\t\twhile(j<=R[bel[r]]-L[bel[r]]+1&&b[bel[r]][j].fi<b[bel[l]][i].fi){\n\t\t\t\tc+=(b[bel[r]][j].se<=r);j++;\n\t\t\t} if(b[bel[l]][i].se>=l) sum+=c;\n\t\t}\n\t\treturn sum;\n\t}\n}\nint main(){\n\tread(n);read(qu);\n\tblk_sz=450;blk_cnt=(n-1)/blk_sz+1;\n\tfor(int i=1;i<=n;i++) read(a[i]);\n\tfor(int i=1;i<=blk_cnt;i++){\n\t\tL[i]=(i-1)*blk_sz+1;R[i]=min(i*blk_sz,n);\n\t\tfor(int j=L[i];j<=R[i];j++) bel[j]=i;\n\t}\n\tfor(int i=1;i<=n;i++) b[bel[i]][i-L[bel[i]]+1]=mp(a[i],i);\n\tfor(int i=1;i<=blk_cnt;i++) sort(b[i]+1,b[i]+R[i]-L[i]+2);\n\tfor(int i=1;i<=blk_cnt;i++){\n\t\tmemset(t,0,sizeof(t));ll sum=0;\n\t\tfor(int j=L[i];j<=R[i];j++){\n\t\t\tpre[j]=(sum+=j-L[i]-ask(a[j]));\n\t\t\tadd(a[j],1);\n\t\t} memset(t,0,sizeof(t));sum=0;\n\t\tfor(int j=R[i];j>=L[i];j--){\n\t\t\tsuf[j]=(sum+=ask(a[j]));\n\t\t\tadd(a[j],1);\n\t\t}\n\t}\n\tfor(int i=1;i<=blk_cnt;i++){\n\t\tint mn=n+1,s=0;\n\t\tfor(int j=L[i];j<=R[i];j++) c[a[j]]++,chkmin(mn,a[j]);\n\t\tfor(int j=mn;j<=n;j++) s+=c[j],buc[j]+=s;\n\t\tfor(int j=L[i];j<=R[i];j++) c[a[j]]--;\n\t\tfor(int j=1;j<=n;j++) lt[j][i]=buc[a[j]-1];\n\t}\n\tfor(int i=1;i<=blk_cnt;i++) for(int j=1;j<i;j++)\n\t\tfor(int k=L[i];k<=R[i];k++) bl[i][j]+=R[j]-lt[k][j];\n\tll pre=0;\n\twhile(qu--){\n\t\tll l,r;read(l);read(r);l^=pre;r^=pre;\n\t\tprint(pre=query(l,r),'\\n');\n\t} print_final();\n\treturn 0;\n}\n```\n\n\u7136\u540e\u5c31\u5230\u4e86\u6700\u5947\u602a\u7684\u90e8\u5206\u4e86\uff0c\u6211\u6ce8\u610f\u5230\u8be2\u95ee\u7684\u65f6\u5019\u5199\u4e86\u8fd9\u6837\u4e00\u53e5\u8bdd\uff1a\n\n```for(int i=l;i<=R[bel[l]];i++) sum+=lt[i][bel[r]-1]-lt[i][bel[l]];```\n\n\u7136\u540e\u6211\u5c31\u7075\u673a\u4e00\u52a8\uff0c\u5c1d\u8bd5**\u4ea4\u6362 $lt$ \u7684\u4e24\u7ef4**\uff0c\u5e76\u5bfb\u601d\u8fd9\u6837\u6548\u7387\u4f1a\u52a0\u5feb\u591a\u5c11\u3002\n\n\u7136\u9e45\u51fa\u4e4e\u610f\u6599\u7684\u662f\uff0c\u4f5c\u4e86\u8fd9\u6837\u4e00\u4e2a\u5c0f\u5c0f\u7684\u53d8\u52a8\u540e\uff0c\u5b83\u7adf\u7136 AC \u4e86\uff01\u800c\u4e14\u7adf\u7136\u8fd8\u62a2\u5230\u4e86\uff08\u76ee\u524d\uff0c\u622a\u81f3 2021.7.18\uff09\u7684\u6700\u4f18\u89e3\u3002\n\n\u4e3a\u4ec0\u4e48\u6211\u4f1a\u60f3\u5230\u4f5c\u8fd9\u6837\u4e00\u4e2a\u53d8\u52a8\uff1f\u6ce8\u610f\u5230\u5728\u4e0a\u9762\u7684\u8bed\u53e5\u4e2d\uff0c\u540e\u9762\u4e00\u7ef4\u7684\u503c\u4e0e\u679a\u4e3e\u53d8\u91cf $i$ \u65e0\u5173\uff0c\u56e0\u6b64\u5982\u679c\u4ea4\u6362\u8fd9\u4e24\u7ef4\uff0c\u540e\u9762\u4e00\u7ef4\u8bbf\u95ee\u7684\u4e0b\u6807\u5c31\u662f\u4e00\u6bb5\u8fde\u7eed\u7684\u533a\u95f4\uff0c\u8bbf\u95ee\u7684\u5730\u5740\u4e5f\u662f\u4e00\u6bb5\u5b8c\u6574\u7684\u533a\u95f4\uff0c\u8fd9\u6837\u5c31\u80fd\u5927\u5927\u63d0\u9ad8\u8bbf\u95ee\u901f\u5ea6\u3002\n\nAC \u4ee3\u7801\uff1a\n\n```cpp\nusing namespace fastio;\nconst int MAXN=1e5;\nconst int BLK=500;\nint n,qu,a[MAXN+5],pre[MAXN+5],suf[MAXN+5],buc[MAXN+5];\npii b[BLK+5][BLK+5];int c[MAXN+5];\nint lt[BLK+5][MAXN+5],bl[BLK+5][BLK+5];\nint blk_cnt=0,blk_sz=0,L[BLK+5],R[BLK+5],bel[MAXN+5];\nint t[MAXN+5];\nvoid add(int x,int v){for(int i=x;i<=n;i+=(i&(-i))) t[i]+=v;}\nint ask(int x){int ret=0;for(int i=x;i;i&=(i-1)) ret+=t[i];return ret;}\nll query(int l,int r){\n\tif(l<1||l>n||r<1||r>n||l>r) return 0;\n\tif(bel[l]==bel[r]){\n\t\tll sum=pre[r];\n\t\tif(l^L[bel[l]]) sum-=pre[l-1];\n\t\tfor(int i=1,c=0;i<=R[bel[l]]-L[bel[l]]+1;i++){\n\t\t\tif(b[bel[l]][i].se<l) sum-=c;\n\t\t\tc+=(l<=b[bel[l]][i].se&&b[bel[l]][i].se<=r);\n\t\t} return sum;\n\t} else {\n\t\tll sum=0;sum+=suf[l];sum+=pre[r];\n\t\tfor(int i=bel[l]+1;i<bel[r];i++) sum+=pre[R[i]]+bl[i][i-1]-bl[i][bel[l]];\n\t\tfor(int i=l;i<=R[bel[l]];i++) sum+=lt[bel[r]-1][i]-lt[bel[l]][i];\n\t\tfor(int i=L[bel[r]];i<=r;i++) sum+=(L[bel[r]]-R[bel[l]]-1)-(lt[bel[r]-1][i]-lt[bel[l]][i]);\n\t\tfor(int i=1,j=1,c=0;i<=R[bel[l]]-L[bel[l]]+1;i++){\n\t\t\twhile(j<=R[bel[r]]-L[bel[r]]+1&&b[bel[r]][j].fi<b[bel[l]][i].fi){\n\t\t\t\tc+=(b[bel[r]][j].se<=r);j++;\n\t\t\t} if(b[bel[l]][i].se>=l) sum+=c;\n\t\t}\n\t\treturn sum;\n\t}\n}\nint main(){\n\tread(n);read(qu);\n\tblk_sz=460;blk_cnt=(n-1)/blk_sz+1;\n\tfor(int i=1;i<=n;i++) read(a[i]);\n\tfor(int i=1;i<=blk_cnt;i++){\n\t\tL[i]=(i-1)*blk_sz+1;R[i]=min(i*blk_sz,n);\n\t\tfor(int j=L[i];j<=R[i];j++) bel[j]=i;\n\t}\n\tfor(int i=1;i<=n;i++) b[bel[i]][i-L[bel[i]]+1]=mp(a[i],i);\n\tfor(int i=1;i<=blk_cnt;i++) sort(b[i]+1,b[i]+R[i]-L[i]+2);\n\tfor(int i=1;i<=blk_cnt;i++){\n\t\tmemset(t,0,sizeof(t));ll sum=0;\n\t\tfor(int j=L[i];j<=R[i];j++){\n\t\t\tpre[j]=(sum+=j-L[i]-ask(a[j]));\n\t\t\tadd(a[j],1);\n\t\t} memset(t,0,sizeof(t));sum=0;\n\t\tfor(int j=R[i];j>=L[i];j--){\n\t\t\tsuf[j]=(sum+=ask(a[j]));\n\t\t\tadd(a[j],1);\n\t\t}\n\t}\n\tfor(int i=1;i<=blk_cnt;i++){\n\t\tint mn=n+1,s=0;\n\t\tfor(int j=L[i];j<=R[i];j++) c[a[j]]++,chkmin(mn,a[j]);\n\t\tfor(int j=mn;j<=n;j++) s+=c[j],buc[j]+=s;\n\t\tfor(int j=L[i];j<=R[i];j++) c[a[j]]--;\n\t\tfor(int j=1;j<=n;j++) lt[i][j]=buc[a[j]-1];\n\t}\n\tfor(int i=1;i<=blk_cnt;i++) for(int j=1;j<i;j++)\n\t\tfor(int k=L[i];k<=R[i];k++) bl[i][j]+=R[j]-lt[j][k];\n\tll pre=0;\n\twhile(qu--){\n\t\tll l,r;read(l);read(r);l^=pre;r^=pre;\n\t\tprint(pre=query(l,r),'\\n');\n\t} print_final();\n\treturn 0;\n}\n```\n\n",
        "postTime": 1626594992,
        "uid": 115194,
        "name": "lTgMFePRoeZ",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P5046 [Ynoi2019 \u6a21\u62df\u8d5b] Yuno loves sqrt technology I"
    },
    {
        "content": "\u7ec8\u4e8e\u7b2c\u4e00\u6b21\u81ea\u5df1\u505a\u51fa\u4e86 Ynoi\uff08\u53ef\u559c\u53ef\u8d3a\uff01\u4e3a\u4ee5\u540e\u9000\u5f79\u8bb0\u79ef\u7d2f\u7d20\u6750\uff09\u3002\n\n~~\u663e\u7136\u8981\u5206\u5757~~\uff0c\u8bbe\u5757\u5927\u5c0f\u4e3a $\\Theta(\\sqrt n)$\u3002\u5c06\u8d21\u732e\u5206\u4e3a\u5982\u4e0b\u51e0\u90e8\u5206\u8ba1\u7b97\uff08\u5047\u8bbe $l,r$ \u4e0d\u5728\u540c\u4e00\u5757\uff09\uff1a\n\n1. \u6574\u5757\u5185\n\n2. \u6563\u5757\u5bf9\u6574\u5757\n\n3. \u6563\u5757\u5bf9\u6563\u5757\n\n4. \u6563\u5757\u5185\n\n1 \u53ef\u4ee5\u76f4\u63a5\u9884\u5904\u7406\uff0c\u603b\u6570\u91cf\u662f $O(n)$ \u7ea7\u522b\u7684\u3002\u8bbe $f_{i,j}$ \u4e3a\u7b2c $i$ \u5757\u5230\u7b2c $j$ \u5757\u5185\u7684\u9006\u5e8f\u5bf9\u6570\uff0c\u90a3\u4e48 $f_{i,j}$ \u53ef\u4ee5\u901a\u8fc7 $f_{i,j-1}$ \u52a0\u4e0a\u7b2c $j$ \u5757\u5bf9\u7b2c $[i,j-1]$ \u5757\u7684\u8d21\u732e\u3002\u7b2c $j$ \u5757\u4e2d\u7684\u6570 $a_k$ \u7684\u8d21\u732e\u53ef\u4ee5\u5206\u4e3a\u7b2c $j$ \u5757\u4e2d\u524d $k-1$ \u4e2a\u6570\u4e2d\u5927\u4e8e $a_k$ \u7684\u6570\u7684\u4e2a\u6570\u52a0\u4e0a\u7b2c $[i,j-1]$ \u5757\u4e2d\u5927\u4e8e $a_k$ \u7684\u6570\u7684\u4e2a\u6570\u3002\u7b2c\u4e00\u90e8\u5206\u53ef\u4ee5\u76f4\u63a5 bit \u9884\u5904\u7406\uff0c\u7b2c\u4e8c\u90e8\u5206\u53ef\u4ee5\u901a\u8fc7\u9884\u5904\u7406\u4e8c\u7ef4\u524d\u7f00\u548c $sum_{i,j}$ \u8868\u793a\u524d $i$ \u5757\u4e2d\u5927\u4e8e $j$ \u7684\u6570\u7684\u4e2a\u6570\u5dee\u5206\u4e3a $sum_{j-1,a_k}-sum_{j-1},a_k$\u3002\n\n2 \u53ef\u4ee5\u5229\u7528 1 \u4e2d\u7684 sum \u7b80\u5355\u641e\u3002\n\n3 \u6211\u7528\u7684\u662f\u4e0d\u5927\u4f18\u7f8e\u7684\u65b9\u6cd5\uff0c\u6bcf\u5757\u5185\u6392\u5e8f\uff0c\u626b\u4e00\u4e2a\u5757\u7684\u8fc7\u7a0b\u4e2d\u7ef4\u62a4\u53e6\u4e00\u4e2a\u5355\u8c03\u6307\u9488\u626b\u53e6\u4e00\u4e2a\u5757\u3002\n\n4 \u53ef\u4ee5\u9884\u5904\u7406\uff0c\u8bbe $p_{i,j}$ \u4e3a $[i,i+j]$ \u7684\u9006\u5e8f\u5bf9\u6570\uff0c~~\u9274\u4e8e\u8be5\u95ee\u9898\u7684\u7279\u6b8a\u6027\u53ef\u4ee5\u76f4\u63a5\u4e0a\u83ab\u961f\u4e8c\u6b21\u79bb\u7ebf~~\u53ef\u4ee5\u7528\u83ab\u961f\u4e8c\u6b21\u79bb\u7ebf\u7684\u601d\u8def\uff0c\u6bcf\u4e2a\u5f62\u5982\u201c$[l,r]$ \u4e2d\u6709\u591a\u5c11\u5927\u4e8e $a_{r+1}$ \u7684\u6570\u201d\u53ef\u4ee5\u5dee\u5206\u4e3a $[1,r]-[1,l-1]$\u3002\u6240\u6709 $[1,r]$ \u90fd\u53ef\u4ee5\u9884\u5904\u7406\u3002\u4e00\u4e2a\u5757\u5185\u7684 $l$ \u662f\u56fa\u5b9a\u7684\uff0c\u6240\u4ee5\u53d8\u4e3a\u4e86 $O(n\\sqrt n)$ \u6b21\u67e5\u8be2 $O(n)$ \u6b21\u4fee\u6539\u3002\u4f7f\u7528 $O(\\sqrt n)$ \u4fee\u6539 $O(1)$ \u67e5\u8be2\u7684\u503c\u57df\u5206\u5757\u5373\u53ef\u3002\n\n\u4e00\u4e9b\u5361\u5e38\u65b9\u6cd5\uff08\u91cd\u8981\uff09\uff1a\n\n* \u4e00\u5b9a\u8981\u628a\u503c\u57df\u5361\u7d27\uff01\u4e0d\u80fd\u8ba4\u4e3a\u662f $n$\uff01\n\n* \u907f\u514d\u8d85\u5927\u4e8c\u7ef4\u6570\u7ec4 $sum$ \u7684\u53cd\u590d\u8c03\u7528\uff0c\u80fd\u7701\u5219\u7701\u3002\u5982\u9884\u5904\u7406 $f$ \u7684\u65f6\u5019\uff0c\u4f18\u5316\u6389\u4e00\u534a\u7684\u8c03\u7528\u6b21\u6570\u3002\n\n* \u5728\u5904\u7406 2 \u7684\u65f6\u5019\uff0c\u4f1a\u9020\u6210\u5927\u91cf\u7684 $sum$ \u6570\u7ec4\u8c03\u7528\u3002\u56e0\u6b64\u53ef\u4ee5\u9884\u5904\u7406\u6574\u5757\u5230\u8fde\u7eed\u6574\u5757\u7684\u7b54\u6848\uff0c\u5728\u5904\u7406\u6563\u5757\u7684\u65f6\u5019\uff0c\u5982\u679c\u8be5\u5757\u5185\u5176\u4ed6\u90e8\u5206\u5927\u5c0f\u5c0f\u4e8e\u6563\u5757\u5927\u5c0f\uff0c\u5219\u901a\u8fc7\u5bb9\u65a5\u8ba1\u7b97\uff0c\u6574\u5757\u8d21\u732e\u51cf\u53bb\u975e\u6563\u5757\u90e8\u5206\u8d21\u732e\u3002\n\n```cpp\n#include<bits/stdc++.h>\n#define ll long long\n#define lowbit(x) (x&-x)\nusing namespace std;\nconst int mxn=1e5;\nconst int b=160;\nchar ibuf[100<<20],*s,out[100<<20];\nint wz;\ninline int read()\n{\n    register int u=0;\n    while(*s<48) s++;\n    while(*s>32)\n        u=u*10+*s++-48;\n    return u;\n}\nvoid print(ll x)\n{\n    if(x>9) print(x/10);\n    out[wz++]=x%10+'0';\n}\nint a[mxn+5];\nint fl[mxn+5],fr[mxn+5];\nint bl[mxn+5];\nint h[mxn+5];\nll f[mxn/b+5][mxn/b+5];//fij\u8868\u793a\u5757i\u5230\u5757j\u7684\u9006\u5e8f\u5bf9\u6570 \nint bit[mxn+5];\nint sum[mxn/b+5][mxn+5];//sumij\u8868\u793a\u524di\u5757\u4e2d\u5c0f\u4e8ej\u7684\u6570\u7684\u4e2a\u6570 \nint presum[mxn+5];\nint blans[mxn+5][b+5];\npair<int,int> st[mxn+5];\nint allpre[mxn+5];\nint blpre[mxn+5];\nint inbl[mxn/b+5][mxn/b+5];//inblij \u524di\u5757\u4e2d\u4e0d\u5927\u4e8e\u7b2cj\u5757\u4e2d\u6240\u6709\u6570\u7684\u6570\u7684\u4e2a\u6570 \nstruct range_block\n{\n\tint st[mxn+5],ed[mxn+5];\n\tint bl[mxn+5];\n\tint t[mxn+5];\n\tint t2[mxn+5];\n\tint cnt,b;\n\tvoid build(int n)\n\t{\n\t\tint i,j;\n\t\tcnt=0;\n\t\tb=317;\n\t\tfor(i=1;i<=n;i+=b)\n\t\t\tst[++cnt]=i,ed[cnt]=min(n,i+b-1);\n\t\tfor(i=1;i<=cnt;i++)\n\t\t\tfor(j=st[i];j<=ed[i];j++)\n\t\t\t\tbl[j]=i;\n\t}\n\tvoid add(int x)\n\t{\n\t\tint f=bl[x],i;\n\t\tfor(i=f;i<=cnt;i++)\n\t\t\tt[i]++;\n\t\tfor(i=x;i<=ed[f];i++)\n\t\t\tt2[i]++;\n\t}\n\tint ask(int x)\n\t{\n\t\treturn t2[x]+t[bl[x]-1];\n\t} \n}block;\nvoid init(int n,int le)\n{\n\tint i,j,k,cnt=0,x;\n\tll ss;\n\tblock.build(le);\n\tfor(i=1;i<=n;i++)\n\t\tst[i]=make_pair(a[i],i);\n\tfor(i=1;i<=n;i+=b)\n\t\tfl[++cnt]=i,fr[cnt]=min(i+b-1,n);\n\tfor(i=1;i<=cnt;i++)\n\t{\n\t\tfor(j=fl[i];j<=fr[i];j++)\n\t\t{\n\t\t\tbl[j]=i;\n\t\t\tsum[i][a[j]]++;\n\t\t}\n\t\tsort(st+fl[i],st+fr[i]+1);\n\t}\t\n\tfor(i=1;i<=n;i++)\n\t{\n\t\tallpre[i]=i-1;\n\t\tfor(j=a[i];j;j-=lowbit(j))\n\t\t\tallpre[i]-=bit[j];\n\t\tfor(j=a[i];j<=n;j+=lowbit(j))\n\t\t\tbit[j]++;\n\t}\n\tmemset(bit,0,sizeof(bit));\n\tfor(i=1;i<=cnt;i++)\n\t\tfor(j=1;j<=le;j++)\n\t\t\tsum[i][j]+=sum[i-1][j]+sum[i][j-1]-sum[i-1][j-1];\t\t\t\t\t\n\tfor(i=1;i<=cnt;i++)\n\t{\n\t\tfor(j=fl[i];j<=fr[i];j++)\n\t\t{\n\t\t\tpresum[j]=j-fl[i];\n\t\t\tfor(k=a[j];k;k-=lowbit(k))\n\t\t\t\tpresum[j]-=bit[k];\n\t\t\tfor(k=a[j];k<=le;k+=lowbit(k))\n\t\t\t\tbit[k]++;\n\t\t\tblpre[i]+=presum[j];\n\t\t}\n\t\tfor(j=fl[i];j<=fr[i];j++)\n\t\t\tfor(k=a[j];k<=le;k+=lowbit(k))\n\t\t\t\tbit[k]--;\n\t}\n\tfor(i=1;i<=cnt;i++)\n\t{\n\t\tfor(j=i;j<=cnt;j++)\n\t\t{\n\t\t\tss=0;\n\t\t\tfor(k=fl[j];k<=fr[j];k++)\n\t\t\t\tss+=sum[i][a[k]];\n\t\t\tinbl[i][j]=ss;\n\t\t}\n\t}\n\tfor(i=1;i<=cnt;i++)\n\t\tfor(j=i;j<=cnt;j++)\n\t\t\tf[i][j]=f[i][j-1]+blpre[j]+(fr[j-1]-fl[i]+1ll)*(fr[j]-fl[j]+1)-inbl[j-1][j]+inbl[i-1][j];\t\n\tfor(i=1;i<=n;i++)\n\t{\n\t\tk=bl[i];\n\t\tfor(j=i+1;j<=fr[k];j++)\n\t\t\tblans[i][j-i]=blans[i][j-i-1]+allpre[j]-(i-1-block.ask(a[j]));\n\t\tblock.add(a[i]);\n\t}\n}\nll ask(int l,int r)\n{\n\tif(bl[l]==bl[r]) return blans[l][r-l];\n\tint kl=bl[l],kr=bl[r],i,j,all=fr[kr-1]-fl[kl+1]+1,cnt=0,pl=fr[kl],pr=fl[kr];\n\tll s=ask(l,fr[kl])+ask(fl[kr],r)+f[kl+1][kr-1];\n\tfor(i=l;i<=pl;i++)\n\t\ts+=sum[kr-1][a[i]-1]-sum[kl][a[i]-1];\n\tif(fr[kr]-r-1<r-pr)\n\t{\n\t\ts+=(r-pr+1ll)*all-(inbl[kr-1][kr]-inbl[kl][kr]);\n\t\tfor(i=r+1;i<=fr[kr];i++)\n\t\t\ts+=sum[kr-1][a[i]]-sum[kl][a[i]];\n\t}\n\telse\n\t\tfor(i=pr;i<=r;i++)\n\t\t\ts+=all-sum[kr-1][a[i]]+sum[kl][a[i]];\t\n\tj=pr;\n\tfor(i=fl[kl];i<=pl;i++)\n\t{\n\t\tfor(;j<=fr[kr]&&st[j].first<st[i].first;j++)\n\t\t\tcnt+=st[j].second<=r;\n\t\ts+=(st[i].second>=l)*cnt;\n\t}\n\treturn s;\n}\nint main()\n{\n\tfread(s=ibuf,1,900<<20,stdin);\n\tint n=read(),m=read(),i,le,l,r;\n\tll last=0;\n\tfor(i=1;i<=n;i++)\n\t\th[i]=a[i]=read();\n\tsort(h+1,h+1+n);\n\tle=unique(h+1,h+1+n)-h;\n\tfor(i=1;i<=n;i++)\n\t\ta[i]=lower_bound(h+1,h+le,a[i])-h;\n\tinit(n,le);\n\twhile(m--)\n\t{\n\t\tl=read(),r=read();\n\t\tl^=last,r^=last;\n\t\tprint(last=ask(l,r)),out[wz++]='\\n';\n\t}\n\tfwrite(out,1,wz,stdout);\n} \n```",
        "postTime": 1620381222,
        "uid": 203623,
        "name": "Ntokisq",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P5046 [Ynoi2019 \u6a21\u62df\u8d5b] Yuno loves sqrt technology I"
    },
    {
        "content": "[P5046 [Ynoi2019 \u6a21\u62df\u8d5b] Yuno loves sqrt technology I](https://www.luogu.com.cn/problem/P5046)\u89e3\u9898\u62a5\u544a\uff1a\n\n[\u66f4\u597d\u7684\u9605\u8bfb\u4f53\u9a8c](https://zybuluo.com/xiaoziyao/note/1776794)\n\n> \u6211\u4eec\u5df2\u7ecf\u6709\u4e86\u4f4e\u4e8e$n^{1.5}$\u7684\u5728\u7ebf\u7b97\u6cd5\u3002\u2014\u2014nzhtl1477\n\n## \u9898\u610f\n\u9898\u610f\uff1a\u7ed9\u5b9a\u4e00\u4e2a\u957f\u5ea6\u4e3a$n$\u7684\u6392\u5217\uff0c$q$\u6b21\u8be2\u95ee\uff0c\u6bcf\u6b21\u8be2\u95ee\u533a\u95f4\u7684\u9006\u5e8f\u5bf9\u6570\uff0c\u5f3a\u5236\u5728\u7ebf\u3002\uff08$1\\leqslant n,m\\leqslant 10^5$\uff09\n\n## \u5206\u6790\n\nBF\u53e3\u4e2d\u5e8f\u5217\u5206\u5757\u57fa\u7840\u9898\uff0c\u6211\u5e76\u4e0d\u4f1a/fad\u3002\n\n\u9996\u5148\u5bf9\u539f\u5e8f\u5217\u8fdb\u884c\u5206\u5757\uff08\u5927\u5c0f\u4e3a$S$\uff09\uff0c\u7b2c$k$\u4e2a\u5757\u7684\u4f4d\u7f6e\u4e3a$[l_k,r_k]$\uff0c\u7136\u540e\u8fdb\u884c\u4e0b\u5217\u9884\u5904\u7406\uff1a\n\n\u5bf9\u4e8e\u7b2c$k$\u4e2a\u5757\uff0c\u6211\u4eec\u5c06\u5b83\u8fdb\u884c\u6392\u5e8f\uff08\u5e76\u4e14\u5c06\u6bcf\u4e2a\u5757\u6392\u5e8f\u540e\u7684\u6570\u7ec4\u4fdd\u5b58\u5230$b$\u6570\u7ec4\u91cc\uff09\uff0c\u7136\u540e\u53ef\u4ee5\u628a\u539f\u5e8f\u5217\u4e0e\u8fd9\u4e2a\u5757\u5f52\u5e76\u4e00\u4e0b\uff08\u56e0\u4e3a\u539f\u5e8f\u5217\u662f\u6392\u5217\uff0c\u56e0\u6b64\u6211\u4eec\u8bb0$pos_i$\u4e3a$i$\u7684\u4f4d\u7f6e\uff09\uff0c\u8ba1\u7b97\u51fa\u5bf9\u4e8e\u4f4d\u7f6e$i$\uff0c\u7b2c$k$\u4e2a\u5757\u5185\u6709\u591a\u5c11\u4e2a\u6570\u5c0f\u4e8e\u5b83\uff0c\u6211\u4eec\u8bb0\u4e3a$atb'_{k,i}$\uff08$\\text{all to block}$\uff09\u3002\n\n\u7136\u540e\u8bbe$ib_i$\u8868\u793a$i$\u5728\u5f53\u524d\u5757\u4e2d\u5355\u72ec\u8d21\u732e\u7684\u9006\u5e8f\u5bf9\u6570\u91cf\uff0c$ibpre_i$\u4e0e$ibsuf_i$\u5206\u522b\u8868\u793a\u5f53\u524d\u5757\u5185$i$\u8868\u793a\u7684\u524d\u7f00/\u540e\u7f00\u8d21\u732e\u7684\u9006\u5e8f\u5bf9\u6570\u91cf\uff0c\u5f88\u5bb9\u6613\u9884\u5904\u7406\u51fa\u6765\u3002\n\n\u8bbe$ibsum_{i,j}$\u8868\u793a$i$\u8fd9\u4e2a\u4f4d\u7f6e\u5f80\u540e\u4e00\u76f4\u5230\u5757\u5185\u7b2c$j$\u4e2a\u4f4d\u7f6e\u8fd9\u4e2a\u533a\u95f4$i$\u8d21\u732e\u7684\u7684\u9006\u5e8f\u5bf9\u6570\u91cf\uff0c\u6211\u4eec\u4e0d\u96be\u53d1\u73b0\u53ef\u4ee5\u5dee\u5206\u4e00\u4e0b\uff0c\u5b83\u5c31\u7b49\u4e8e$ib_i$\u51cf\u53bb$j+1$\u5230\u5757\u672b\u6bd4$a_i$\u5c0f\u7684\u503c\u6570\u91cf\u3002\n\n\u6700\u540e\uff0c\u6211\u4eec\u8fd8\u9884\u5904\u7406\u4e24\u4e2a\u524d\u7f00\u548c\uff1a$atb_{k,i}$\u8868\u793a\u524d$k$\u4e2a\u5757\uff0c\u6709\u591a\u5c11\u4e2a\u6570\u5c0f\u4e8e$a_i$\uff08\u4e5f\u5c31\u662f\u5bf9\u4e0a\u9762\u7684$atb'$\u6c42\u4e00\u4e2a\u524d\u7f00\u548c\uff09\uff0c$btb_{k,i}$\u8868\u793a\u524d$k$\u4e2a\u5757\u6709\u591a\u5c11\u4e2a\u6570\u5927\u4e8e\u7b2c$i$\u4e2a\u5757\u5185\u6240\u6709\u7684\u6570\uff08$\\text{block to block}$\uff09\uff0c\u4e0d\u96be\u53d1\u73b0\n\n\u4e0d\u96be\u53d1\u73b0\u4e0a\u8ff0\u9884\u5904\u7406\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u662f$O(n+B^2)$\u3002\n\n```\nvoid build(int k){\n\tint tmps=0;\n\tfor(int i=l[k];i<=r[k];i++)\n\t\ttmp[++tmps]=a[i];\n\tsort(tmp+1,tmp+1+tmps);\n\tfor(int i=l[k];i<=r[k];i++)\n\t\tb[i]=tmp[i-l[k]+1];\n\tfor(int i=1,j=0;i<=n;i++){\n\t\tfor(;j<tmps&&tmp[j+1]<i;j++);\n\t\tatb[k][pos[i]]=j;\n\t}\n\tfor(int i=r[k];i>=l[k];i--){\n\t\tib[i]=qry(a[i]);\n\t\tibsuf[i]=(i==r[k]? 0:ibsuf[i+1])+ib[i];\n\t\tupd(a[i],1);\n\t}\n\tfor(int i=r[k];i>=l[k];i--)\n\t\tupd(a[i],-1);\n\tfor(int i=l[k];i<=r[k];i++){\n\t\tibpre[i]=(i==l[k]? 0:ibpre[i-1])+((i-l[k])-qry(a[i]));\n\t\tupd(a[i],1);\n\t}\n\tfor(int i=l[k];i<=r[k];i++)\n\t\tupd(a[i],-1);\n\tfor(int i=r[k];i>=l[k];i--){\n\t\tfor(int j=l[k];j<=i;j++)\n\t\t\tibsum[j][i-l[k]+1]=ib[j]-qry(a[j]);\n\t\tupd(a[i],1);\n\t}\n\tfor(int i=r[k];i>=l[k];i--)\n\t\tupd(a[i],-1);\n\tfor(int i=1;i<=n;i++)\n\t\tatb[k][i]+=atb[k-1][i],btb[k][bel[i]]+=atb[k][i];\n}\n```\n\n\u7136\u540e\uff0c\u6211\u4eec\u8003\u8651\u67e5\u8be2$[x,y]$\uff0c\u6211\u4eec\u8bbe$x$\u5728\u5757$p$\u4e2d\uff0c$y$\u5728\u5757$q$\u4e2d\u3002\n\n\u5982\u679c$p=q$\uff0c\u6211\u4eec\u53ef\u4ee5\u60f3\u5230\u4e4b\u524d\u9884\u5904\u7406\u7684$ibsum_{i,j}$\uff08\u8868\u793a$i$\u8fd9\u4e2a\u4f4d\u7f6e\u5f80\u540e\u4e00\u76f4\u5230\u5757\u5185\u7b2c$j$\u4e2a\u4f4d\u7f6e\u8fd9\u4e2a\u533a\u95f4$i$\u8d21\u732e\u7684\u7684\u9006\u5e8f\u5bf9\u6570\u91cf\uff0c\u4e0d\u96be\u53d1\u73b0\u6211\u4eec\u5bf9\u4e8e$i=[x,y]$\u7684$ibsum_{i,y-l_p+1}$\u6c42\u548c\u5c31\u597d\u4e86\uff09\uff0c\u590d\u6742\u5ea6\u662f$O(\\sqrt n)$\u3002\n\n\u5982\u679c$p\\ne q$\uff0c\u90a3\u4e48\u4e00\u4e2a\u4e2a\u90e8\u5206\u5206\u6790\uff1a\n\n- \u6563\u5bf9\u6563\uff1a\u4e24\u7aef\u7684\u6563\u5757\u4e4b\u95f4\u7684\u8d21\u732e\u53ef\u4ee5\u901a\u8fc7\u8fd9\u4e24\u4e2a\u6563\u5757\u7684\u5f52\u5e76\u5b9e\u73b0\uff08\u8fd8\u8bb0\u5f97\u6392\u5b8c\u5e8f\u7684\u6570\u7ec4\u4fdd\u5b58\u5728$b$\u5417\uff09\uff0c\u590d\u6742\u5ea6$O(B)$\u3002\n- \u6574\u5bf9\u6563\uff1a\u8003\u8651\u524d\u9762\u9884\u5904\u7406\u7684$atb_{i,j}$\uff08\u8868\u793a\u524d$i$\u4e2a\u5757\uff0c\u6709\u591a\u5c11\u4e2a\u6570\u5c0f\u4e8e$a_j$\uff09\uff0c\u6211\u4eec\u679a\u4e3e\u6563\u5757\u4e2d\u6bcf\u4e00\u4e2a\u6570\u52a0\u4e0a\u5c31\u597d\u4e86\uff0c\u590d\u6742\u5ea6$O(B)$\u3002\n- \u6563\u5757\u5185\u90e8\uff1a\u8003\u8651\u524d\u9762\u9884\u5904\u7406\u7684$ibpre_i$\u548c$ibsuf_i$\uff08\u5f53\u524d\u5757\u5185$i$\u8868\u793a\u7684\u524d\u7f00/\u540e\u7f00\u8d21\u732e\u7684\u9006\u5e8f\u5bf9\u6570\u91cf\uff09\uff0c\u7136\u540e\u76f4\u63a5\u52a0\u4e0a\u5c31\u597d\u4e86\uff0c\u590d\u6742\u5ea6$O(1)$\u3002\n- \u6574\u5757\u5185\u90e8\uff1a\u8003\u8651\u524d\u9762\u9884\u5904\u7406\u7684$btb_{i,j}$\uff08\u8868\u793a\u524d$i$\u4e2a\u5757\u6709\u591a\u5c11\u4e2a\u6570\u5927\u4e8e\u7b2c$j$\u4e2a\u5757\u5185\u6240\u6709\u7684\u6570\uff09\uff0c\u7136\u540e\u679a\u4e3e\u6bcf\u4e00\u4e2a\u6574\u5757\uff0c\u52a0\u4e0a\u5c31\u597d\u4e86\uff08\u8bb0\u5f97\u51cf\u53bb\u81ea\u5df1\uff09\uff0c\u590d\u6742\u5ea6$O(\\frac{n}{B})$\u3002\n\n\u56e0\u6b64\uff0c\u4e00\u6b21\u67e5\u8be2\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a$O(B+\\frac{n}{B})$\u3002\n\n```\nlong long query(int x,int y){\n\tif(x<1||y<1||x>n||y>n||x>y)//\u8c8c\u4f3c\u4e0d\u5224\u4e5f\u884c\n\t\treturn 0;\n\tint p=bel[x],q=bel[y];\n\tlong long res=0;\n\tif(p==q){\n\t\tfor(int i=x;i<=y;i++)\n\t\t\tres+=ibsum[i][y-l[p]+1];\n\t\treturn res;\n\t}\n\tint tmps=0,pmts=0;\n\tfor(int i=l[p];i<=r[p];i++)\n\t\tif(pos[b[i]]>=x)\n\t\t\ttmp[++tmps]=b[i];\n\tfor(int i=l[q];i<=r[q];i++)\n\t\tif(pos[b[i]]<=y)\n\t\t\tpmt[++pmts]=b[i];\n\tfor(int i=1,j=0;i<=tmps;i++){\n\t\tfor(;j<pmts&&pmt[j+1]<tmp[i];j++);\n\t\tres+=j;\n\t}\n\tfor(int i=x;i<=r[p];i++)\n\t\tres+=atb[q-1][i]-atb[p][i];\n\tfor(int i=p+1;i<=q-1;i++)\n\t\tres+=btb[q-1][i]-btb[i][i]+ibpre[r[i]];\n\tfor(int i=l[q];i<=y;i++)\n\t\tres+=(l[q]-r[p]-1)-(atb[q-1][i]-atb[p][i]);\n\treturn ibsuf[x]+res+ibpre[y];\n}\n```\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a$O(\\frac{n}{B}(n+B^2)+m(B+\\frac{n}{B}))$\uff0c\u56e0\u4e3a$n,m$\u540c\u9636\uff0c\u56e0\u6b64\u8bbe$B=\\sqrt n$\uff0c\u603b\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a$O(n\\sqrt n)$\u3002\n\n\u591a\u5f00\u4e86\u4e00\u4e2a\u6570\u7ec4\uff0c\u7ed3\u679c\u5361\u4e86\u534a\u5929\u5e38\u6570\u3002\u3002\u3002\n\n\u5b9e\u9645\u4e0a\u5982\u679c\u5b9e\u73b0\u7cbe\u7ec6\u4e00\u70b9\uff0c\u751a\u81f3\u4e0d\u9700\u8981\u5361\u4ec0\u4e48\u5e38\uff08\u52a0\u4e00\u4e2a\u5feb\u8bfb\u5c31\u591f\u4e86\uff0c\u8fde\u5757\u957f\u90fd\u4e0d\u9700\u8981\u8c03\uff09\n\n## \u4ee3\u7801\n\u8bb0\u5f97\u5f00$\\text{long long}$\u3002\n```\n#include<stdio.h>\n#include<algorithm>\n#include<math.h>\nusing namespace std;\nconst int maxn=100005,maxt=345;\nint n,m,t,S;\nint a[maxn],b[maxn],l[maxn],r[maxn],bel[maxn],Asum[maxt],Bsum[maxn],pos[maxn],tmp[maxn],pmt[maxn];//b[l,r]=sort(a[l],a[r])\nint ib[maxn]/*in block*/,atb[maxt][maxn]/*all to block*/,ibsum[maxn][maxt],ibpre[maxn],ibsuf[maxn];\nlong long lastans;\nlong long btb[maxt][maxt]/*block to block*/;\nvoid upd(int x,int v){\n\tfor(int i=bel[x]+1;i<=t;i++)\n\t\tAsum[i]+=v;\n\tfor(int i=x;i<=r[bel[x]];i++)\n\t\tBsum[i]+=v;\n}\nint qry(int x){\n\treturn Asum[bel[x]]+Bsum[x];\n}\nvoid build(int k){\n\tint tmps=0;\n\tfor(int i=l[k];i<=r[k];i++)\n\t\ttmp[++tmps]=a[i];\n\tsort(tmp+1,tmp+1+tmps);\n\tfor(int i=l[k];i<=r[k];i++)\n\t\tb[i]=tmp[i-l[k]+1];\n\tfor(int i=1,j=0;i<=n;i++){\n\t\tfor(;j<tmps&&tmp[j+1]<i;j++);\n\t\tatb[k][pos[i]]=j;\n\t}\n\tfor(int i=l[k];i<=r[k];i++){\n\t\tibpre[i]=(i==l[k]? 0:ibpre[i-1])+((i-l[k])-qry(a[i]));\n\t\tupd(a[i],1);\n\t}\n\tfor(int i=l[k];i<=r[k];i++)\n\t\tupd(a[i],-1);\n\tfor(int i=r[k];i>=l[k];i--){\n\t\tib[i]=qry(a[i]);\n\t\tibsuf[i]=(i==r[k]? 0:ibsuf[i+1])+ib[i];\n\t\tupd(a[i],1);\n\t}\n\tfor(int i=r[k];i>=l[k];i--)\n\t\tupd(a[i],-1);\n\tfor(int i=r[k];i>=l[k];i--){\n\t\tfor(int j=l[k];j<=i;j++)\n\t\t\tibsum[j][i-l[k]+1]=ib[j]-qry(a[j]);\n\t\tupd(a[i],1);\n\t}\n\tfor(int i=r[k];i>=l[k];i--)\n\t\tupd(a[i],-1);\n\tfor(int i=1;i<=n;i++)\n\t\tatb[k][i]+=atb[k-1][i],btb[k][bel[i]]+=atb[k][i];\n}\nvoid init(){\n\tS=sqrt(n),t=n/S;\n\tfor(int i=1;i<=t;i++)\n\t\tl[i]=r[i-1]+1,r[i]=i*S;\n\tif(r[t]<n)\n\t\tt++,l[t]=r[t-1]+1,r[t]=n;\n\tfor(int i=1;i<=t;i++)\n\t\tfor(int j=l[i];j<=r[i];j++)\n\t\t\tbel[j]=i;\n\tfor(int i=1;i<=t;i++)\n\t\tbuild(i);\n}\nlong long query(int x,int y){\n\tif(x<1||y<1||x>n||y>n||x>y)\n\t\treturn 0;\n\tint p=bel[x],q=bel[y];\n\tlong long res=0;\n\tif(p==q){\n\t\tfor(int i=x;i<=y;i++)\n\t\t\tres+=ibsum[i][y-l[p]+1];\n\t\treturn res;\n\t}\n\tint tmps=0,pmts=0;\n\tfor(int i=l[p];i<=r[p];i++)\n\t\tif(pos[b[i]]>=x)\n\t\t\ttmp[++tmps]=b[i];\n\tfor(int i=l[q];i<=r[q];i++)\n\t\tif(pos[b[i]]<=y)\n\t\t\tpmt[++pmts]=b[i];\n\tfor(int i=1,j=0;i<=tmps;i++){\n\t\tfor(;j<pmts&&pmt[j+1]<tmp[i];j++);\n\t\tres+=j;\n\t}\n\tfor(int i=x;i<=r[p];i++)\n\t\tres+=atb[q-1][i]-atb[p][i];\n\tfor(int i=p+1;i<=q-1;i++)\n\t\tres+=btb[q-1][i]-btb[i][i]+ibpre[r[i]];\n\tfor(int i=l[q];i<=y;i++)\n\t\tres+=(l[q]-r[p]-1)-(atb[q-1][i]-atb[p][i]);\n\treturn ibsuf[x]+res+ibpre[y];\n}\ninline void read(int &x){\n\tchar c=getchar();\n\tx=0;\n\tfor(;c<'0'||c>'9';c=getchar());\n\tfor(;c>='0'&&c<='9';c=getchar())\n\t\tx=x*10+c-48;\n}\nint main(){\n\tread(n),read(m);\n\tfor(int i=1;i<=n;i++)\n\t\tread(a[i]),pos[a[i]]=i;\n\tinit();\n\tfor(int i=1;i<=m;i++){\n\t\tlong long x,y;\n\t\tint l,r;\n\t\tread(l),read(r);\n\t\tx=l,y=r;\n\t\tx^=lastans,y^=lastans;\n\t\tprintf(\"%lld\\n\",lastans=query((int)x,(int)y));\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1613636251,
        "uid": 35754,
        "name": "Verdandi",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P5046 \u3010[Ynoi2019 \u6a21\u62df\u8d5b] Yuno loves sqrt technology I\u3011"
    },
    {
        "content": "~~\u6210\u529f\u4e3a\u6b64\u9898\u8d21\u732e\u4e864\u9875\u591a\u63d0\u4ea4~~\n\n\u8003\u8651\u5206\u5757\uff0c\u8bbe\u5757\u957f\u4e3a $w$\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u628a\u8be2\u95ee\u62c6\u6210\u51e0\u90e8\u5206\uff1a\u6574\u5757\u548c\u6574\u5757\u7684\u8d21\u732e\uff0c\u6563\u5757\u548c\u6574\u5757\u7684\u8d21\u732e\uff0c\u6563\u5757\u548c\u6563\u5757\u7684\u8d21\u732e\u3002\n\n\u9996\u5148\u6574\u5757\u548c\u6574\u5757\u7684\u8d21\u732e\u975e\u5e38\u597d\u89e3\u51b3\uff0c\u6211\u4eec\u7528 $sum_{l,r}$ \u8868\u793a\u4ece\u7b2c $l$ \u5757\u5230\u7b2c $r$ \u5757\u4e4b\u95f4\u7684\u8d21\u732e\u3002\n\n\u9884\u5904\u7406\u7684\u65f6\u5019\uff0c\u6211\u4eec\u7528 $pre_i$ \u8868\u793a $i$ \u5bf9 $[l_{bl_i},i-1]$ \u7684\u8d21\u732e\uff0c\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u7528 $O(\\dfrac{n^2}{w})$ \u7684\u65f6\u95f4\u8fdb\u884c\u9884\u5904\u7406\n\n\u5bf9\u4e8e $pre_i$ \u7684\u8ba1\u7b97\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u6811\u72b6\u6570\u7ec4\u5728 $O(n\\log n)$ \u7684\u65f6\u95f4\u6c42\u51fa\u3002\n\n\u6574\u5757\u548c\u6563\u5757\u7684\u8d21\u732e\uff0c\u6211\u4eec\u7528 $w1_{i,j}$ \u8868\u793a\u524d $i$ \u4e2a\u5757\uff0c\u6709\u591a\u5c11\u4e2a\u6570\u5927\u4e8e\u7b49\u4e8e $j$\uff0c$w2_{i,j}$ \u8868\u793a\u4ece\u7b2c $i$ \u5757\u5230\u6700\u540e\u4e00\u5757\u6709\u591a\u5c11\u4e2a\u6570\u5c0f\u4e8e\u7b49\u4e8e $j$\uff0c\u5229\u7528\u524d\u7f00\u548c\u7684\u65b9\u6cd5\uff0c\u6211\u4eec\u53ef\u4ee5\u505a\u5230 $O(\\dfrac{n^2}{w})$ \u9884\u5904\u7406\uff0c\u67e5\u8be2\u7684\u65f6\u5019\uff0c\u6211\u4eec\u53ea\u9700\u8981\u626b\u63cf\u6563\u5757\uff0c\u5c31\u53ef\u4ee5 $O(w)$ \u6c42\u51fa\u8fd9\u90e8\u5206\u7684\u8d21\u732e\u3002\n\n\u6563\u5757\u548c\u6563\u5757\u4e4b\u95f4\u7684\u8d21\u732e\uff0c\u6211\u4eec\u5148\u628a\u5757\u5185\u6392\u597d\u5e8f\uff0c\u7136\u540e\u7528\u7c7b\u4f3c\u5f52\u5e76\u6392\u5e8f\u7684\u53cc\u6307\u9488\u7684\u65b9\u6cd5\u6c42\u51fa\u5373\u53ef\uff0c\u590d\u6742\u5ea6\u4e5f\u662f $O(w)$\n\n\u603b\u590d\u6742\u5ea6\u662f $O(\\dfrac{n^2}{w}+nw)$\n\n\u5176\u5b9e\u8fd8\u6bd4\u8f83\u597d\u8c03\uff0c\u4f46\u662f\u5361\u5e38\u9700\u8981\u5f88\u957f\u65f6\u95f4\u3002\n\n\u6211\u4eec\u53d1\u73b0\u67e5\u8be2\u7684\u65f6\u5019\u65f6\u95f4\u592a\u957f\u4e86\uff0c\u8003\u8651\u4f18\u5316\u3002\n\n\u6211\u4eec\u7528 $sumL_{i,j}$ \u8868\u793a $[i,r_j]$ \u5185\u7684\u9006\u5e8f\u5bf9\u4e2a\u6570\uff0c$sumR_{i,j}$ \u8868\u793a $[l_j,i]$ \u5185\u7684\u9006\u5e8f\u5bf9\u4e2a\u6570\uff0c\u90a3\u4e48\u6211\u4eec\u67e5\u8be2\u7684\u65f6\u5019\u53ef\u4ee5\u7528 $sumL+sumR-sum$ \u5c31\u5f97\u5230\u4e86\u6574\u5757\u548c\u6574\u5757\u7684\u8d21\u732e\u548c\u6563\u5757\u548c\u6563\u5757\u7684\u8d21\u732e\uff0c\u53ea\u9700\u8981\u6700\u540e\u5f52\u5e76\u6392\u5e8f\u6c42\u4e00\u4e2a\u6563\u5757\u548c\u6563\u5757\u4e4b\u95f4\u7684\u8d21\u732e\u5c31\u53ef\u4ee5\u4e86\u3002\n\n\u7136\u540e\u52a0\u4e00\u4e9bIO\u4f18\u5316\u548c\u6307\u4ee4\u96c6\uff0c\u7136\u540e\u4e09\u5206\u8c03\u4e0b\u5757\u957f\u5c31\u53ef\u4ee5\u8fc7\u4e86\uff08\n\n\u6211\u4eec\u53d1\u73b0\u5f52\u5e76\u6392\u5e8f\u7684\u5e38\u6570\u5f88\u5c0f\uff0c\u800c\u9884\u5904\u7406\u7684\u5e38\u6570\u5f88\u5927\uff0c\u6240\u4ee5 $w$ \u5e94\u8be5\u7a0d\u5fae\u5927\u4e00\u70b9\uff0c\u5b9e\u9645\u53d6 $w=600$ \u7684\u65f6\u5019\u8dd1\u7684\u6bd4\u8f83\u5feb\u3002\n\n\u4ee3\u7801\uff08\u4e0d\u4fdd\u8bc1\u80fd\u8fc7\uff0c\u5efa\u8bae\u51cc\u6668 $3$ \u70b9\u63d0\u4ea4\uff09\uff1a\n\n```cpp\n# include <bits/stdc++.h>\nusing namespace std;\n\n# define Rep(i,a,b) for(register int i=a;i<=b;i++)\n# define _Rep(i,a,b) for(register int i=a;i>=b;i--)\n# define RepG(i,u) for(int i=head[u];~i;i=e[i].next)\n#pragma GCC optimize(\"Ofast\")\n#pragma GCC optimize(\"unroll-loops\")\n#pragma GCC target(\"sse,sse2,sse3,ssse3,sse4,popcnt,abm,mmx,avx,tune=native\")\n#pragma GCC optimize(\"Ofast,no-stack-protector,unroll-loops,fast-math\")\n#pragma GCC diagnostic error \"-std=c++11\"\n#pragma GCC optimize(\"-fdelete-null-pointer-checks,inline-functions-called-once,-funsafe-loop-optimizations,-fexpensive-optimizations,-foptimize-sibling-calls,-ftree-switch-conversion,-finline-small-functions,inline-small-functions,-frerun-cse-after-loop,-fhoist-adjacent-loads,-findirect-inlining,-freorder-functions,no-stack-protector,-fpartial-inlining,-fsched-interblock,-fcse-follow-jumps,-fcse-skip-blocks,-falign-functions,-fstrict-overflow,-fstrict-aliasing,-fschedule-insns2,-ftree-tail-merge,inline-functions,-fschedule-insns,-freorder-blocks,-fwhole-program,-funroll-loops,-fthread-jumps,-fcrossjumping,-fcaller-saves,-fdevirtualize,-falign-labels,-falign-loops,-falign-jumps,unroll-loops,-fsched-spec,-ffast-math,Ofast,inline,-fgcse,-fgcse-lm,-fipa-sra,-ftree-pre,-ftree-vrp,-fpeephole2\",3)\n#pragma GCC target(\"avx\",\"sse2\")\n\ntypedef long long ll;\n\nconst int N=1e5+5;\nconst int W=330;\n\ntemplate<typename T> void read(T &x){\n   x=0;int f=1;\n   char c=getchar();\n   for(;!isdigit(c);c=getchar())if(c=='-')f=-1;\n   for(;isdigit(c);c=getchar())x=(x<<1)+(x<<3)+c-'0';\n    x*=f;\n}\n\nint n,m,sq,bl;\nint a[N];\nint w1[W][N],w2[W][N],pre[N],suf[N];\nll sum[W][W];\nll sumL[W][N],sumR[W][N];\nint cnt1[N],cnt2[N];\nint l[N],r[N],pos[N];\nint bit[N];\nint x[N],lx,y[N],ly;\nll ans;\n\nclass istream{\n    char buf[13000003],*s;\n    public:\n        inline istream(){\n#ifndef ONLINE_JUDGE\n            freopen(\"input.txt\",\"r\",stdin);\n#endif\n            buf[fread(s=buf,1,13000001,stdin)]='\\n';\n        }\n        template<typename T>\n        inline void operator>>(T&rhs){\n            for(rhs=0;!isdigit(*s);++s);\n            while(isdigit(*s))rhs=rhs*10+(*s++&15);\n        }\n}in;\n\nstruct ostream{\n    char buf[8000005],*s;\n    inline ostream(){s=buf;}\n    inline void operator<<(long long d){\n        if(!d){\n            *s++='0';\n        }else{\n            static long long w;\n            for(w=1;w<=d;w*=10);\n            for(;w/=10;d%=w)*s++=d/w^'0';\n        }\n        *s++='\\n';\n    }\n    inline ostream&operator<<(const char&c){*s++=c;return*this;}\n    inline~ostream(){fwrite(buf,1,s-buf,stdout);}\n}out;\n\nstruct misaka{\n\tint val,id; \n\tbool operator < (const misaka &cmp)const{\n\t\treturn val>cmp.val;\t\n\t}\n}b[N];\n\nvoid add(int o,int x){\n\tfor(;o<=n;o+=o&-o)bit[o]+=x;\n}\n\nint ask(int o){\n\tint res=0;\n\tfor(;o;o-=o&-o)res+=bit[o];\n\treturn res;\t\n}\n\nvoid init(){\n\tsq=600;\n\tRep(i,1,n)pos[i]=(i-1)/sq+1;\n\tbl=pos[n];\n\tRep(i,1,bl)l[i]=(i-1)*sq+1,r[i]=i*sq;\n\tr[bl]=n;\n\tRep(i,1,n)b[i]=(misaka){a[i],i};\n\tRep(i,1,bl)sort(b+l[i],b+r[i]+1);\n\tRep(i,1,n){\n\t\tcnt1[a[i]]++;\n\t\tif(r[pos[i]]==i){\n\t\t\t_Rep(j,n,1)\n\t\t\t\tw1[pos[i]][j]=w1[pos[i]][j+1]+cnt1[j];\n\t\t}\n\t}\n\t_Rep(i,n,1){\n\t\tcnt2[a[i]]++;\n\t\tif(l[pos[i]]==i){\n\t\t\tRep(j,1,n)w2[pos[i]][j]=w2[pos[i]][j-1]+cnt2[j];\t\n\t\t}\n\t}\n\tRep(i,1,bl){\n\t\tRep(j,l[i],r[i]){\n\t\t\tpre[j]=ask(n)-ask(a[j]);\n\t\t\tadd(a[j],1);\t\n\t\t}\n\t\tRep(j,l[i],r[i])add(a[j],-1);\n\t\t_Rep(j,r[i],l[i]){\n\t\t\tsuf[j]=ask(a[j]);\n\t\t\tadd(a[j],1);\t\n\t\t}\n\t\tRep(j,l[i],r[i])add(a[j],-1); \n\t}\n\tRep(i,1,bl)\n\t\tRep(j,i,bl){\n\t\t\tsum[i][j]=sum[i][j-1];\n\t\t\tRep(k,l[j],r[j])\n\t\t\t\tsum[i][j]+=w1[j-1][a[k]]-w1[i-1][a[k]]+pre[k];\t\n\t\t}\n\tRep(i,1,bl)\n\t\t_Rep(j,r[i],1)\n\t\t\tsumL[i][j]=sumL[i][j+1]+w2[pos[j]+1][a[j]]-w2[i+1][a[j]]+suf[j];\n\tRep(i,1,bl)\n\t\tRep(j,l[i],n)\n\t\t\tsumR[i][j]=sumR[i][j-1]+w1[pos[j]-1][a[j]]-w1[i-1][a[j]]+pre[j];\n\tRep(i,1,bl){\n\t\tRep(j,l[i]+1,r[i])pre[j]+=pre[j-1];\n\t\t_Rep(j,r[i]-1,l[i])suf[j]+=suf[j+1];\t\n\t}\n}\n\nint mergesort(){\n\tint t=1;\n\tint res=0;\n\tRep(i,1,ly){\n\t\twhile(t<=lx&&x[t]>y[i])t++;\n\t\tres+=t-1;\n\t}\n\treturn res;\n}\n\nint main()\n{\n\tin>>n,in>>m; \n\tRep(i,1,n)in>>a[i];\n\tinit();\t\n\tRep(i,1,m){\n\t\tll ql,qr;\n\t\tin>>ql,in>>qr;\n\t\tql^=ans,qr^=ans;\n\t\tif(pos[ql]==pos[qr]){\n\t\t\tlx=ly=0;\n\t\t\tRep(i,l[pos[ql]],r[pos[ql]]){\n\t\t\t\tif(b[i].id>=ql&&b[i].id<=qr)y[++ly]=b[i].val;\n\t\t\t\telse if(b[i].id<ql)x[++lx]=b[i].val;\t\n\t\t\t}\n\t\t\tans=pre[qr]-((ql==l[pos[ql]])?0:pre[ql-1])-mergesort();\n\t\t}\n\t\telse{\n\t\t\tll res=sumL[pos[qr]-1][ql]+sumR[pos[ql]+1][qr]-sum[pos[ql]+1][pos[qr]-1];\n\t\t\tlx=ly=0;\n\t\t\tRep(i,l[pos[ql]],r[pos[ql]])if(b[i].id>=ql)x[++lx]=b[i].val;\n\t\t\tRep(i,l[pos[qr]],r[pos[qr]])if(b[i].id<=qr)y[++ly]=b[i].val;\n\t\t\tres+=mergesort();\n\t\t\tans=res;\n\t\t}\n\t\tout<<ans;\t\n\t}\n\treturn 0;\n}\n/*\n3 1\n3 2 1\n1 2\n\n*/\n```\n",
        "postTime": 1600319383,
        "uid": 97344,
        "name": "devout",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P5046 \u3010[Ynoi2019\u6a21\u62df\u8d5b]Yuno loves sqrt technology I\u3011"
    },
    {
        "content": "### \u5173\u4e8e\u672c\u9898\n\n>\u601d\u7ef4\u96be\u5ea6\uff1a\u4e2d\u7b49\u3002\n\n>\u4ee3\u7801\u96be\u5ea6\uff1a\u8f83\u9ad8\uff0c\u7531\u4e8e\u9700\u8981\u4e00\u5b9a\u7684\u5e38\u6570\u4f18\u5316\u6280\u5de7\u3002\n\n>\u7531\u4e8e\u672c\u9898\u601d\u7ef4\u3001\u4ee3\u7801\u96be\u5ea6\u4e0d\u5747\u8861\uff0c\u6545\u800c\u9664\u4e86\u8bb2\u8ff0\u672c\u9898\u57fa\u7840\u505a\u6cd5\u5916\uff0c\u91cd\u70b9\u8fd8\u5728\u4e8e\u4ecb\u7ecd\u672c\u9898\u5e38\u6570\u4f18\u5316\u7684\u4e00\u4e9b\u65b9\u6cd5\u3002\n\n### \u9898\u89e3\n\n\u9996\u5148\u8003\u8651\u731c\u6d4b\u672c\u9898\u590d\u6742\u5ea6\u3002\u4e0d\u96be\u53d1\u73b0\u672c\u9898\u5f88\u96be\u505a\u5230 polylog\uff0c\u52a0\u4e4b\u672c\u9898\u65f6\u9650\u8f83\u7d27\uff0c\u6b63\u89e3\u590d\u6742\u5ea6\u591a\u534a\u662f $O(n \\sqrt n)$\u3002\u7531\u4e8e\u672c\u9898\u5f3a\u5236\u5728\u7ebf\uff0c\u5f88\u5bb9\u6613\u60f3\u5230\u5229\u7528\u5206\u5757\u6765\u89e3\u51b3\u3002\n\n\u7531\u4e8e\u672c\u9898\u8981\u7ef4\u62a4\u6570\u5bf9\u6709\u5173\u4fe1\u606f\uff0c\u4e00\u4e2a\u6bd4\u8f83\u81ea\u7136\u7684\u60f3\u6cd5\u662f\u62c6\u6210\u6574\u5757\u5bf9\u6574\u5757\u3001\u6574\u5757\u5bf9\u6563\u5757\u3001\u6563\u5757\u5bf9\u6563\u5757\u4e09\u90e8\u5206\u3002\n\n\u4ee5\u4e0b\u4e0d\u59a8\u8bbe\u5757\u957f\u4e3a $\\sqrt n$\u3002\n\n- \u6574\u5757\u5bf9\u6574\u5757\n\n\u5bb9\u6613\u53d1\u73b0\u5bf9\u8be2\u95ee\u5982\u679c\u53ea\u8003\u8651\u6574\u5757\uff0c\u5b9e\u9645\u4e0a\u53ea\u6709 $O(n)$ \u79cd\u672c\u8d28\u4e0d\u540c\u7684\u60c5\u51b5\u3002\u4e0d\u59a8\u8003\u8651\u9884\u5904\u7406\u4e4b\u3002\n\n\u8fd9\u65f6\u5019\u6211\u4eec\u53ef\u80fd\u4f1a\u8054\u60f3\u5230 [P5048 [Ynoi2019 \u6a21\u62df\u8d5b] Yuno loves sqrt technology III](https://www.luogu.com.cn/problem/P5048) \u4e2d\u7684\u4e00\u4e2a\u5957\u8def\uff0c\u5373\u679a\u4e3e\u6700\u5de6\u9762\u7684\u6574\u5757\uff0c\u518d\u679a\u4e3e\u53f3\u7aef\u70b9\uff0c\u52a8\u6001\u8ba1\u7b97\u7b54\u6848\u3002\n\n\u5177\u4f53\u5728\u672c\u9898\u4e2d\uff0c\u7b54\u6848\u7684\u589e\u91cf\u5c31\u662f\u5f3a\u5236\u65b0\u63d2\u5165\u7684\u8282\u70b9\u653e\u5728\u53f3\u8fb9\uff0c\u4e0e\u5de6\u9762\u7684\u6570\u5f62\u6210\u9006\u5e8f\u5bf9\u7684\u6570\u91cf\u3002\n\n\u8003\u8651\u9006\u5e8f\u5bf9\uff08\u4e8c\u7ef4\u504f\u5e8f\uff09\u95ee\u9898\u57fa\u672c\u5957\u8def\uff1a\u626b\u63cf\u7ebf\u7ef4\u62a4\u7b2c\u4e00\u7ef4\u7684\u504f\u5e8f\u5173\u7cfb\uff0c\u4f7f\u7528\u6570\u636e\u7ed3\u6784\uff08\u5982\u6811\u72b6\u6570\u7ec4\uff09\u7ef4\u62a4\u7b2c\u4e8c\u7ef4\u7684\u504f\u5e8f\u5173\u7cfb\u3002\n\n\u5982\u679c\u76f4\u63a5\u8fd9\u6837\u7ef4\u62a4\uff0c\u63d2\u5165\u7684\u603b\u91cf\u662f $O(n \\sqrt n)$ \u7684\uff08\u7531\u4e8e\u6bcf\u4e2a\u70b9\u4f1a\u88ab\u63d2\u5165 $\\sqrt n$ \u6b21\uff09\uff0c\u800c\u67e5\u8be2\u7684\u603b\u91cf\u4e5f\u662f $O(n \\sqrt n)$ \u7684\uff08\u8003\u8651\u6bcf\u6b21\u63d2\u5165\u5fc5\u5b9a\u4f34\u968f\u4e00\u6b21\u67e5\u8be2\uff09\uff0c\u53ea\u80fd\u4f7f\u7528\u6811\u72b6\u6570\u7ec4\u6765\u7ef4\u62a4\u9006\u5e8f\u5bf9\uff0c\u590d\u6742\u5ea6\u4e3a $O(n \\sqrt n \\log n)$\uff0c\u663e\u7136\u65e0\u6cd5\u901a\u8fc7\u3002\n\n\u5b9e\u9645\u4e0a\uff0c\u4e0e\u4e0a\u9762\u7684\u9898\u76ee\u4e0d\u540c\u7684\u662f\uff0c\u672c\u9898\u8981\u7ef4\u62a4\u7684\u4fe1\u606f\u5177\u6709**\u5dee\u5206\u6027**\u3002\u8003\u8651\u4e00\u4e2a\u7c7b\u4f3c\u4e8c\u6b21\u79bb\u7ebf\u83ab\u961f\u7684\u65b9\u6cd5\uff0c\u5c06\u6240\u6709\u7684\u67e5\u8be2\u62c6\u6210\u524d\u7f00\u67e5\u8be2\uff0c\u518d\u79bb\u7ebf\u4e0b\u6765\u3002\u7136\u540e\u5c31\u4e0d\u96be\u7528\u626b\u63cf\u7ebf\u7ef4\u62a4\u4e86\u3002\u8fd9\u6837\u4fee\u6539\u7684\u4e2a\u6570\u662f $O(n)$ \u7684\uff08\u7531\u4e8e\u53ea\u987a\u5e8f\u626b\u4e00\u904d\uff09\uff0c\u67e5\u8be2\u7684\u4e2a\u6570\u4f9d\u65e7\u662f $O(n \\sqrt n)$ \u7684\u3002\u76f4\u63a5\u5957\u4e00\u4e2a $O(\\sqrt n)$ \u533a\u95f4\u4fee\u6539\uff0c$O(1)$ \u5355\u70b9\u67e5\u8be2\u7684\u503c\u57df\u5206\u5757\uff0c\u4e24\u90e8\u5206\u5c31\u90fd\u4e3a $O(n \\sqrt n)$ \u7684\u4e86\u3002\n\n- \u6563\u5757\u5bf9\u6574\u5757\n\n\u4e00\u4e2a\u6bd4\u76f4\u63a5\u7684\u60f3\u6cd5\u662f\u5bf9\u4e8e $O(n)$ \u79cd\u8fde\u7eed\u6574\u5757\u533a\u95f4\uff0c\u5404\u81ea\u7ef4\u62a4\u6876\u7684\u524d\u7f00\u548c\u6765\u5feb\u901f\u8ba1\u7b97\uff0c\u7136\u800c\u8fd9\u6837\u662f $O(n^2)$ \u7684\u3002\u4f9d\u65e7\u8003\u8651\u5dee\u5206\u3002\u7531\u4e8e\u524d\u7f00\u8fde\u7eed\u6574\u5757\u533a\u95f4\u53ea\u6709 $O(\\sqrt n)$ \u4e2a\uff0c\u5206\u522b\u7ef4\u62a4\u524d\u7f00\u548c\u5373\u53ef\u3002\n\n- \u6563\u5757\u5bf9\u6563\u5757\n\n\u8fd9\u90e8\u5206\u76f8\u5f53\u4e8e\u5bf9\u4e24\u4e2a\u6563\u5757\u7b97\u5408\u5e76\u540e\u7684\u8d21\u732e\u3002\u5bb9\u6613\u53d1\u73b0\u6563\u5757\u4e00\u5b9a\u662f\u67d0\u4e2a\u5757\u7684\u524d\u7f00\u6216\u540e\u7f00\uff0c\u6545\u6bcf\u4e2a\u6563\u5757\u5185\u90e8\u7684\u7b54\u6848\u53ef\u4ee5\u7528\u6811\u72b6\u6570\u7ec4\u52a0\u626b\u63cf\u7ebf\u9884\u5904\u7406\uff0c\u590d\u6742\u5ea6\u4e3a $O(n \\log n)$\u3002\u81f3\u4e8e\u4e24\u4e2a\u70b9\u5206\u522b\u843d\u5728\u4e24\u4e2a\u6563\u5757\u5185\u7684\u8d21\u732e\u6570\uff0c\u76f4\u63a5\u5f52\u5e76\u6392\u5e8f\u5373\u53ef\u3002\u81f3\u4e8e\u6563\u5757\u5185\u90e8\u6392\u5e8f\uff0c\u53ef\u4ee5\u8003\u8651\u9884\u5904\u7406\u65f6\u5bf9\u6bcf\u4e2a\u6574\u5757\u5185\u90e8**\u5404\u81ea**\u79bb\u6563\u5316\uff0c\u6876\u6392\u5e8f\u5373\u53ef\u3002\n\n\u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u4e0b\u9762\u7684\u5b9e\u73b0;\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\ntypedef long long ll;\ntypedef double db;\ninline ll read() {\n\tll f=1,x=0;char ch=getchar();\n\twhile(!isdigit(ch)) {if(ch=='-') f=-1;ch=getchar();}\n\twhile(isdigit(ch)) {x=x*10+ch-48;ch=getchar();}\n\treturn x*f;\n}\nconst ll MAXN=100005,MAXB=355;\nll n,m,cnt,cnt1,a[MAXN],a1[MAXN],a2[MAXN],endp[MAXN],bgn[MAXN],tmp[MAXB],tmp1[MAXB],L[MAXB],R[MAXB],t[MAXB],f[MAXB][MAXB],bk[MAXB][MAXB],nt[MAXN],pre[MAXN],suf[MAXN];\nint calc[MAXN][MAXB],calc1[MAXN][MAXB];\nint b;\nmap <int,int> mp;\nint getB(int x) {\n\treturn (x/b)+1;\n} \nstruct FK {\n\tll lz[MAXB],val[MAXN];\n\tvoid Add(int l,int r,int k) {\n\t\tint bl=getB(l),br=getB(r);\n\t    if(br-bl<=1) for(int i=l;i<=r;i++) val[i]+=k;\n\t    else {\n\t    \tfor(int i=bl+1;i<=br-1;i++) lz[i]+=k;\n\t    \tfor(int i=l;i<=R[bl];i++) val[i]+=k;\n\t    \tfor(int i=L[br];i<=r;i++) val[i]+=k;\n\t\t}\n\t}\n\tvoid add(int p,int k) {\n\t\tAdd(p,n,k);\n\t}\n\tll Query(int p) {\n\t\treturn lz[getB(p)]+val[p];\n\t}\n\tll query(int l,int r) {\n\t\tif(r<l) return 0;\n\t\treturn Query(r)-Query(l-1);\n\t}\n\tvoid clear() {\n\t\tfor(int i=1;i<=n;i++) val[i]=0;\n\t\tfor(int i=1;i<=getB(n);i++) lz[i]=0;\n\t}\n}bs;\nstruct BIT {\n\tll c[MAXN];\n\tint lowbit(int x) {\n\t\treturn x&(-x);\n\t}\n\tvoid add(int x,int k) {\n\t\tfor(int i=x;i<=n;i+=lowbit(i)) c[i]+=k;\n\t}\n\tll Query(int x) {\n\t\tint sum=0;\n\t\tfor(int i=x;i;i-=lowbit(i)) sum+=c[i];\n\t\treturn sum;\n\t}\n\tll query(int l,int r) {\n\t\tif(r<l) return 0;\n\t\treturn Query(r)-Query(l-1);\n\t}\n}bit;\nsigned main() {\n\tn=read(),m=read();\n\tb=sqrt(n);\n\tfor(int i=1;i<=n;i++) a[i]=a1[i]=a2[i]=read();\n\tfor(int i=n;i>=1;i--) L[getB(i)]=i;\n\tfor(int i=1;i<=n;i++) R[getB(i)]=i;\n\tfor(int i=1;i<=getB(n);i++) endp[R[i]]=i;\n\tfor(int i=1;i<=getB(n);i++) bgn[L[i]]=i;\n\tfor(int i=1;i<=getB(n);i++) {\n\t\tsort(a2+L[i],a2+R[i]+1);\n\t\tll num=0;\n\t\tfor(int j=L[i];j<=R[i];j++) mp[a2[j]]=++num,bk[i][num]=a2[j];\n\t\tfor(int j=L[i];j<=R[i];j++) a1[j]=mp[a1[j]];\n\t}\n\tfor(int i=1;i<=n;i++) {\n\t    bs.add(a[i],1);\n\t\tnt[i]=bs.query(a[i]+1,n);\n\t\tif(endp[i]) for(int j=i+1;j<=n;j++) calc[j][endp[i]]=bs.query(a[j]+1,n);\n\t}\n\tbs.clear();\n\tendp[0]=1;\n\tfor(int i=n;i>=1;i--) {\n\t    bs.add(a[i],1);\n\t\tif(bgn[i]) for(int j=i-1;j>=1;j--) calc1[j][bgn[i]]=bs.query(1,a[j]-1);\n    \t\n    }\n\tbs.clear();\n\tfor(int i=1;i<=getB(n);i++) {\n\t\tll sum=0;\n\t\tfor(int j=L[i];j<=n;j++) {\n\t\t\tsum+=(nt[j]-calc[j][i-1]);\n\t\t\tif(endp[j]) f[i][endp[j]]=sum;\n\t\t}\n\t}\n\tfor(int i=1;i<=getB(n);i++) {\n\t\tll sum=0;\n\t\tfor(int j=L[i];j<=R[i];j++) {\n\t\t\tsum+=bit.query(a[j]+1,n);\n\t\t\tpre[j]=sum;\n\t\t\tbit.add(a[j],1);\n\t\t}\n\t\tfor(int j=L[i];j<=R[i];j++) bit.add(a[j],-1);\n\t\tsum=0;\n\t\tfor(int j=R[i];j>=L[i];j--) {\n\t\t\tsum+=bit.query(1,a[j]-1);\n\t\t\tsuf[j]=sum;\n\t\t\tbit.add(a[j],1);\n\t\t}\n\t\tfor(int j=L[i];j<=R[i];j++) bit.add(a[j],-1);\n\t}\n\tll lans=0;\n\twhile(m--) {\n\t\tll l=(read()^lans),r=(read()^lans);\n\t\tif(l==r) {\n\t\t\tlans=0;\n\t\t\tcout<<0<<'\\n';\n\t\t\tcontinue;\n\t\t}\n\t\tint bl=getB(l),br=getB(r);\n\t\tif(bl==br) {\n\t\t\tif(l-1>=L[bl]) lans=pre[r]-pre[l-1];\n\t\t\telse lans=pre[r];\n\t\t\tcnt=cnt1=0;\n\t\t\tfor(int i=L[bl];i<=l-1;i++) t[a1[i]]++;\n\t\t\tfor(int i=1;i<=b;i++) if(t[i]) tmp[++cnt]=bk[bl][i];\n\t\t\tfor(int i=L[bl];i<=l-1;i++) t[a1[i]]--;\n\t\t\tfor(int i=l;i<=r;i++) t[a1[i]]++;\n\t\t\tfor(int i=1;i<=b;i++) if(t[i]) tmp1[++cnt1]=bk[br][i];\n\t\t\tfor(int i=l;i<=r;i++) t[a1[i]]--;\n\t\t\tll pr=0;\n\t\t\tfor(int i=1;i<=cnt;i++) {\n\t\t\t\twhile(pr+1<=cnt1&&tmp1[pr+1]<tmp[i]) pr++;\n\t\t\t\tlans-=pr;\n\t\t\t}\n\t\t\tcout<<lans<<'\\n';\n\t\t}\n\t\telse if(bl+1==br) {\n\t\t\tlans=suf[l]+pre[r];\n\t\t\tcnt=cnt1=0;\n\t\t\tfor(int i=l;i<=R[bl];i++) t[a1[i]]++;\n\t\t\tfor(int i=1;i<=b;i++) if(t[i]) tmp[++cnt]=bk[bl][i];\n\t\t\tfor(int i=l;i<=R[bl];i++) t[a1[i]]--;\n\t\t\tfor(int i=L[br];i<=r;i++) t[a1[i]]++;\n\t\t\tfor(int i=1;i<=b;i++) if(t[i]) tmp1[++cnt1]=bk[br][i];\n\t\t\tfor(int i=L[br];i<=r;i++) t[a1[i]]--;\n\t\t\tll pr=0;\n\t\t\tfor(int i=1;i<=cnt;i++) {\n\t\t\t\twhile(pr+1<=cnt1&&tmp1[pr+1]<tmp[i]) pr++;\n\t\t\t\tlans+=pr;\n\t\t\t}\n\t\t\tcout<<lans<<'\\n';\n\t\t}\n\t\telse {\n\t\t\t\n\t\t\tlans=f[bl+1][br-1]+suf[l]+pre[r];\n\t\t\tfor(int i=l;i<=R[bl];i++) lans+=(calc1[i][bl+1]-calc1[i][br]);\n\t\t\tfor(int i=L[br];i<=r;i++) lans+=(calc[i][br-1]-calc[i][bl]);\n\t\t\tcnt=cnt1=0;\n\t\t\tfor(int i=l;i<=R[bl];i++) t[a1[i]]++;\n\t\t\tfor(int i=1;i<=b;i++) if(t[i]) tmp[++cnt]=bk[bl][i];\n\t\t\tfor(int i=l;i<=R[bl];i++) t[a1[i]]--;\n\t\t\tfor(int i=L[br];i<=r;i++) t[a1[i]]++;\n\t\t\tfor(int i=1;i<=b;i++) if(t[i]) tmp1[++cnt1]=bk[br][i];\n\t\t\tfor(int i=L[br];i<=r;i++) t[a1[i]]--;\n\t\t\tll pr=0;\n\t\t\tfor(int i=1;i<=cnt;i++) {\n\t\t\t\twhile(pr+1<=cnt1&&tmp1[pr+1]<tmp[i]) pr++;\n\t\t\t\tlans+=pr;\n\t\t\t}\n\t\t\tcout<<lans<<'\\n';\n\t\t}\n\t}\n\treturn 0;\n}\n```\n\n\u7136\u800c\uff0c\u7531\u4e8e\u672c\u9898\u9ad8\u5ea6\u5361\u5e38\uff0c\u8be5\u4ee3\u7801\u53ea\u80fd\u83b7\u5f97 $68$ \u5206\u3002\n\n\u6709\u4e00\u4e2a\u6bd4\u8f83\u6709\u7528\u7684\u4f18\u5316\u662f\u5176\u5b9e\u6574\u5757\u5bf9\u6563\u5757\u662f\u53ef\u4ee5\u76f4\u63a5\u524d\u7f00\u548c\u7ef4\u62a4\u7684\uff0c\u518d\u5bf9\u4e00\u4e9b\u6bd4\u8f83\u57fa\u7840\u7684\u5e38\u6570\u8fdb\u884c\u4f18\u5316\uff08\u5982\u6563\u5757\u4fee\u6539\u957f\u5ea6\u8d85\u8fc7\u5757\u957f\u4e00\u534a\uff0c\u5c31\u5bf9\u6574\u5757\u6253\u6807\u8bb0\u540e\u4fee\u6539\u5176\u8865\u533a\u95f4\u3001\u8c03\u6574\u5757\u957f\u7b49\uff09\uff0c\u540c\u65f6\u4f7f\u7528\u5173\u95ed\u540c\u6b65\u6d41\u7684 ```cin```\u3001```cout```\uff0c\u518d\u52a0\u4e0a ```register``` \u7684\u6280\u5de7\uff0c\u53ef\u4ee5\u83b7\u5f97 $76$ \u5206\uff0c\u4ee3\u7801\u5982\u4e0b\uff1a\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\ntypedef long long ll;\ntypedef double db;\nconst ll MAXN=100005,MAXB=456;\nint n,m,cnt,cnt1,a[MAXN],a1[MAXN],a2[MAXN],base[MAXN],endp[MAXN],bgn[MAXN],tmp[MAXB],tmp1[MAXB],L[MAXN/MAXB+15],R[MAXN/MAXB+15],t[MAXB],bk[MAXN/MAXB+15][MAXB],nt[MAXN];\nll calc[MAXN][MAXN/MAXB+15],calc1[MAXN][MAXN/MAXB+15];\nll f[MAXN/MAXB+15][MAXN/MAXB+15],pre[MAXN],suf[MAXN];\nint b;\nmap <int,int> mp;\nint preB(int x) {\n\treturn (x/b)+1;\n}\nint getB(int x) {\n\treturn base[x];\n} \nstruct FK {\n\tint lz[MAXN/MAXB+15],val[MAXN];\n\tvoid Add(int l,int r,int k) {\n\t\tint bl=getB(l),br=getB(r);\n\t    if(bl==br) for(register int i=l;i<=r;i++) val[i]+=k;\n\t    else {\n\t    \tfor(register int i=bl+1;i<=br-1;i++) lz[i]+=k;\n\t    \tfor(register int i=l;i<=R[bl];i++) val[i]+=k;\n\t    \tfor(register int i=L[br];i<=r;i++) val[i]+=k;\n\t\t}\n\t}\n\tvoid add(int p,int k) {\n\t\tAdd(p,n,k);\n\t}\n\tint Query(int p) {\n\t\treturn lz[getB(p)]+val[p];\n\t}\n\tint query(int l,int r) {\n\t\tif(r<l) return 0;\n\t\treturn Query(r)-Query(l-1);\n\t}\n}bs;\nstruct BIT {\n\tll c[MAXN];\n\tint lowbit(int x) {\n\t\treturn x&(-x);\n\t}\n\tvoid add(int x,int k) {\n\t\tfor(register int i=x;i<=n;i+=lowbit(i)) c[i]+=k;\n\t}\n\tint Query(int x) {\n\t\tint sum=0;\n\t\tfor(register int i=x;i;i-=lowbit(i)) sum+=c[i];\n\t\treturn sum;\n\t}\n\tint query(int l,int r) {\n\t\tif(r<l) return 0;\n\t\treturn Query(r)-Query(l-1);\n\t}\n}bit;\nsigned main() {\n    ios::sync_with_stdio(false);\n    cin.tie(0);cout.tie(0);\n\tcin>>n>>m;\n\tb=MAXB-1;\n\tfor(register int i=1;i<=n;i++) {\n\t    cin>>a[i];\n\t    a1[i]=a2[i]=a[i],base[i]=preB(i);\n\t}\n\tfor(register int i=n;i>=1;i--) L[getB(i)]=i;\n\tfor(register int i=1;i<=n;i++) R[getB(i)]=i;\n\tfor(register int i=1;i<=getB(n);i++) endp[R[i]]=i;\n\tfor(register int i=1;i<=getB(n);i++) bgn[L[i]]=i;\n\tfor(register int i=1;i<=getB(n);i++) {\n\t\tsort(a2+L[i],a2+R[i]+1);\n\t\tint num=0;\n\t\tfor(register int j=L[i];j<=R[i];j++) mp[a2[j]]=++num,bk[i][num]=a2[j];\n\t\tfor(register int j=L[i];j<=R[i];j++) a1[j]=mp[a1[j]];\n\t}\n\tfor(register int i=1;i<=n;i++) {\n\t    bs.add(a[i],1);\n\t\tnt[i]=bs.query(a[i]+1,n);\n\t\tif(endp[i]) for(register int j=i+1;j<=n;j++) calc[j][endp[i]]=bs.query(a[j]+1,n);\n\t}bs.add(a[i],-1);\n\tfor(register int i=1;i<=n;i++) {\n\t\tif(bgn[i]) for(register int j=i-1;j>=1;j--) calc1[j][bgn[i]]=bs.query(1,a[j]-1);\n\t\tbs.add(a[i],-1);\n    }\n    for(register int i=1;i<=n;i++) {\n\t\tif(endp[i]) {\n\t\t\tfor(register int j=i+1;j<=n;j++) {\n\t\t\t\tcalc[j][endp[i]]=calc[j-1][endp[i]]+calc[j][endp[i]];\n\t\t\t}\n\t\t}\n\t\tif(bgn[i]) {\n\t\t\tfor(register int j=1;j<=i-1;j++) {\n\t\t\t\tcalc1[j][bgn[i]]=calc1[j-1][bgn[i]]+calc1[j][bgn[i]];\n\t\t\t}\n\t\t}\n\t}\n\tfor(register int i=1;i<=getB(n);i++) {\n\t\tll sum=0;\n\t\tfor(register int j=L[i];j<=n;j++) {\n\t\t\tsum+=(nt[j]);\n\t\t\tif(endp[j]) f[i][endp[j]]=sum-(calc[j][i-1]-calc[i-1][i-1]);\n\t\t}\n\t}\n\tfor(register int i=1;i<=getB(n);i++) {\n\t\tll sum=0;\n\t\tfor(register int j=L[i];j<=R[i];j++) {\n\t\t\tsum+=bit.query(a[j]+1,n);\n\t\t\tpre[j]=sum;\n\t\t\tbit.add(a[j],1);\n\t\t}\n\t\tfor(register int j=L[i];j<=R[i];j++) bit.add(a[j],-1);\n\t\tsum=0;\n\t\tfor(register int j=R[i];j>=L[i];j--) {\n\t\t\tsum+=bit.query(1,a[j]-1);\n\t\t\tsuf[j]=sum;\n\t\t\tbit.add(a[j],1);\n\t\t}\n\t\tfor(register int j=L[i];j<=R[i];j++) bit.add(a[j],-1);\n\t}\n\tll lans=0;\n\twhile(m--) {\n\t\tll l,r;\n\t\tcin>>l>>r;\n\t\tl^=lans,r^=lans;\n\t\tif(l==r) {\n\t\t\tlans=0;\n\t\t\tcout<<0<<'\\n';\n\t\t\tcontinue;\n\t\t}\n\t\tint bl=getB(l),br=getB(r);\n\t\tif(bl==br) {\n\t\t\tif(l-1>=L[bl]) lans=pre[r]-pre[l-1];\n\t\t\telse lans=pre[r];\n\t\t\tcnt=cnt1=0;\n\t\t\tint mx=0;\n\t\t\tfor(register int i=L[bl];i<=l-1;i++) {\n\t\t\t\tt[a1[i]]++;\n\t\t\t\tif(a1[i]>mx) mx=a1[i];\n\t\t\t}\n\t\t\tfor(register int i=1;i<=mx;i++) if(t[i]) tmp[++cnt]=bk[bl][i];\n\t\t\tfor(register int i=L[bl];i<=l-1;i++) t[a1[i]]--;\n\t\t\tmx=0;\n\t\t\tfor(register int i=l;i<=r;i++) {\n\t\t\t    t[a1[i]]++;\n\t\t\t\tif(a1[i]>mx) mx=a1[i];\n\t\t\t}\n\t\t\tint pl=cnt+1;\n\t\t\tfor(register int i=mx;i>=1;i--) {\n\t\t\t\tif(t[i]) {\n\t\t\t\t\ttmp1[++cnt1]=bk[br][i];\n\t\t\t\t\twhile(pl-1>0&&tmp[pl-1]>tmp1[cnt1]) pl--;\n\t\t\t\t\tlans-=(cnt-pl+1);\n\t\t\t\t}\n\t\t\t}\n\t\t\tfor(register int i=l;i<=r;i++) t[a1[i]]--;\n\t\t\tcout<<lans<<'\\n';\n\t\t}\n\t\telse {\n\t\t\tif(bl+1==br) lans=suf[l]+pre[r];\n\t\t\telse {\n\t\t\t\tlans=f[bl+1][br-1]+suf[l]+pre[r];\n\t\t\t\tlans+=(calc1[R[bl]][bl+1]-calc1[l-1][bl+1]);\n\t\t\t\tlans-=(calc1[R[bl]][br]-calc1[l-1][br]);\n//\t\t    \tfor(register int i=l;i<=R[bl];i++) lans+=(calc1[i][bl+1]-calc1[i][br]);\n                lans+=(calc[r][br-1]-calc[L[br]-1][br-1]);\n                lans-=(calc[r][bl]-calc[L[br]-1][bl]);\n//\t\t    \tfor(register int i=L[br];i<=r;i++) lans+=(calc[i][br-1]-calc[i][bl]);\n\t\t\t}\n\t\t\tcnt=cnt1=0;\n\t\t\tint mx=0;\n\t\t\tfor(register int i=l;i<=R[bl];i++) {\n\t\t\t    t[a1[i]]++;\n\t\t\t\tif(a1[i]>mx) mx=a1[i];\n\t\t\t}\n\t\t\tfor(register int i=1;i<=mx;i++) if(t[i]) tmp[++cnt]=bk[bl][i];\n\t\t\tfor(register int i=l;i<=R[bl];i++) t[a1[i]]--;\n\t\t\tmx=0;\n\t\t\tfor(register int i=L[br];i<=r;i++) {\n\t\t\t    t[a1[i]]++;\n\t\t\t\tif(a1[i]>mx) mx=a1[i];\n\t\t\t}\n\t\t\tint pl=cnt+1;\n\t\t\tfor(register int i=mx;i>=1;i--) {\n\t\t\t\tif(t[i]) {\n\t\t\t\t\ttmp1[++cnt1]=bk[br][i];\n\t\t\t\t\twhile(pl-1>0&&tmp[pl-1]>tmp1[cnt1]) pl--;\n\t\t\t\t\tlans+=(cnt-pl+1);\n\t\t\t\t}\n\t\t\t}\n\t\t\tfor(register int i=L[br];i<=r;i++) t[a1[i]]--;\n\t\t\tcout<<lans<<'\\n';\n\t\t}\n\t}\n\treturn 0;\n}\n```\n\n\u7136\u540e\u8fd8\u6709\u4e00\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u4f18\u5316\u5c31\u662f\u5c3d\u91cf\u4f7f\u5185\u5b58\u8fde\u7eed\u8bbf\u95ee\u3002\u5176\u5b9e\u5bf9\u4e8e\u6570\u7ec4 $calc_{i,j}$ \u4e0e $calc1_{i,j}$\uff0c\u6211\u4eec\u5176\u5b9e\u662f\u5bf9\u4e8e $i$ \u8fde\u7eed\u8bbf\u95ee\u7684\u3002\u90a3\u4e48\u5c31\u628a\u4e24\u7ef4\u4e92\u6362\u3002\u540c\u65f6\u5c06\u5757\u957f\u8c03\u6574\u81f3 $b=450$\uff0c\u4fbf\u53ef\u4ee5\u901a\u8fc7\u672c\u9898\u3002\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\ntypedef long long ll;\ntypedef double db;\nconst ll MAXN=100005,MAXB=451;\nint n,m,cnt,cnt1,a[MAXN],a1[MAXN],a2[MAXN],base[MAXN],endp[MAXN],bgn[MAXN],tmp[MAXB],tmp1[MAXB],L[MAXN/MAXB+15],R[MAXN/MAXB+15],t[MAXB],bk[MAXN/MAXB+15][MAXB],nt[MAXN];\nll calc[MAXN/MAXB+15][MAXN],calc1[MAXN/MAXB+15][MAXN],pr[MAXN];\nll f[MAXN/MAXB+15][MAXN/MAXB+15],pre[MAXN],suf[MAXN];\nint b;\nmap <int,int> mp;\nint preB(int x) {\n\treturn (x/b)+1;\n}\nint getB(int x) {\n\treturn base[x];\n} \nstruct FK {\n\tint lz[MAXN/MAXB+15],val[MAXN];\n\tvoid Add(int l,int r,int k) {\n\t\tint bl=getB(l),br=getB(r);\n\t    if(bl==br) for(register int i=l;i<=r;i++) val[i]+=k;\n\t    else {\n\t    \tfor(register int i=bl+1;i<=br-1;i++) lz[i]+=k;\n\t    \tfor(register int i=l;i<=R[bl];i++) val[i]+=k;\n\t    \tfor(register int i=L[br];i<=r;i++) val[i]+=k;\n\t\t}\n\t}\n\tvoid add(int p,int k) {\n\t\tAdd(p,n,k);\n\t}\n\tint Query(int p) {\n\t\treturn lz[getB(p)]+val[p];\n\t}\n\tint query(int l,int r) {\n\t\tif(r<l) return 0;\n\t\treturn Query(r)-Query(l-1);\n\t}\n}bs;\nstruct BIT {\n\tll c[MAXN];\n\tint lowbit(int x) {\n\t\treturn x&(-x);\n\t}\n\tvoid add(int x,int k) {\n\t\tfor(register int i=x;i<=n;i+=lowbit(i)) c[i]+=k;\n\t}\n\tint Query(int x) {\n\t\tint sum=0;\n\t\tfor(register int i=x;i;i-=lowbit(i)) sum+=c[i];\n\t\treturn sum;\n\t}\n\tint query(int l,int r) {\n\t\tif(r<l) return 0;\n\t\treturn Query(r)-Query(l-1);\n\t}\n}bit;\nsigned main() {\n    ios::sync_with_stdio(false);\n    cin.tie(0);cout.tie(0);\n\tcin>>n>>m;\n\tb=MAXB-1;\n\tfor(register int i=1;i<=n;i++) {\n\t    cin>>a[i];\n\t    a1[i]=a2[i]=a[i],base[i]=preB(i);\n\t}\n\tfor(register int i=n;i>=1;i--) L[getB(i)]=i;\n\tfor(register int i=1;i<=n;i++) R[getB(i)]=i;\n\tfor(register int i=1;i<=getB(n);i++) endp[R[i]]=i;\n\tfor(register int i=1;i<=getB(n);i++) bgn[L[i]]=i;\n\tfor(register int i=1;i<=getB(n);i++) {\n\t\tsort(a2+L[i],a2+R[i]+1);\n\t\tint num=0;\n\t\tfor(register int j=L[i];j<=R[i];j++) mp[a2[j]]=++num,bk[i][num]=a2[j];\n\t\tfor(register int j=L[i];j<=R[i];j++) a1[j]=mp[a1[j]];\n\t}\n\tfor(register int i=1;i<=n;i++) {\n\t    bs.add(a[i],1);\n\t\tnt[i]=bs.query(a[i]+1,n);\n\t\tpr[i]=pr[i-1]+nt[i];\n\t\tif(endp[i]) for(register int j=i+1;j<=n;j++) calc[endp[i]][j]=bs.query(a[j]+1,n);\n\t}\n\tfor(register int i=1;i<=n;i++) {\n\t\tif(bgn[i]) for(register int j=i-1;j>=1;j--) calc1[bgn[i]][j]=bs.query(1,a[j]-1);\n\t\tbs.add(a[i],-1);\n    }\n    for(register int i=1;i<=n;i++) {\n\t\tif(endp[i]) for(register int j=i+1;j<=n;j++) calc[endp[i]][j]=calc[endp[i]][j-1]+calc[endp[i]][j];\n\t\tif(bgn[i]) for(register int j=1;j<=i-1;j++) calc1[bgn[i]][j]=calc1[bgn[i]][j-1]+calc1[bgn[i]][j];\n\t}\n\tfor(register int i=1;i<=getB(n);i++) {\n\t\tfor(register int j=i;j<=getB(n);j++) {\n\t\t\tint nw=R[j];\n\t\t\tf[i][j]=pr[nw]-pr[L[i]-1]-(calc[i-1][nw]-calc[i-1][i-1]);\n\t\t}\n\t}\n\tfor(register int i=1;i<=getB(n);i++) {\n\t\tll sum=0;\n\t\tfor(register int j=L[i];j<=R[i];j++) {\n\t\t\tsum+=bit.query(a[j]+1,n);\n\t\t\tpre[j]=sum;\n\t\t\tbit.add(a[j],1);\n\t\t}\n\t\tfor(register int j=L[i];j<=R[i];j++) bit.add(a[j],-1);\n\t\tsum=0;\n\t\tfor(register int j=R[i];j>=L[i];j--) {\n\t\t\tsum+=bit.query(1,a[j]-1);\n\t\t\tsuf[j]=sum;\n\t\t\tbit.add(a[j],1);\n\t\t}\n\t\tfor(register int j=L[i];j<=R[i];j++) bit.add(a[j],-1);\n\t}\n\tll lans=0;\n\twhile(m--) {\n\t\tll l,r;\n\t\tcin>>l>>r;\n\t\tl^=lans,r^=lans;\n\t\tif(l==r) {\n\t\t\tlans=0;\n\t\t\tcout<<0<<'\\n';\n\t\t\tcontinue;\n\t\t}\n\t\tint bl=getB(l),br=getB(r);\n\t\tif(bl==br) {\n\t\t\tif(l-1>=L[bl]) lans=pre[r]-pre[l-1];\n\t\t\telse lans=pre[r];\n\t\t\tcnt=cnt1=0;\n\t\t\tint mx=0;\n\t\t\tfor(register int i=L[bl];i<=l-1;i++) {\n\t\t\t\tt[a1[i]]++;\n\t\t\t\tif(a1[i]>mx) mx=a1[i];\n\t\t\t}\n\t\t\tfor(register int i=1;i<=mx;i++) if(t[i]) tmp[++cnt]=bk[bl][i];\n\t\t\tfor(register int i=L[bl];i<=l-1;i++) t[a1[i]]--;\n\t\t\tmx=0;\n\t\t\tfor(register int i=l;i<=r;i++) {\n\t\t\t    t[a1[i]]++;\n\t\t\t\tif(a1[i]>mx) mx=a1[i];\n\t\t\t}\n\t\t\tint pl=cnt+1;\n\t\t\tfor(register int i=mx;i>=1;i--) {\n\t\t\t\tif(t[i]) {\n\t\t\t\t\ttmp1[++cnt1]=bk[br][i];\n\t\t\t\t\twhile(pl-1>0&&tmp[pl-1]>tmp1[cnt1]) pl--;\n\t\t\t\t\tlans-=(cnt-pl+1);\n\t\t\t\t}\n\t\t\t}\n\t\t\tfor(register int i=l;i<=r;i++) t[a1[i]]--;\n\t\t\tcout<<lans<<'\\n';\n\t\t}\n\t\telse {\n\t\t\tif(bl+1==br) lans=suf[l]+pre[r];\n\t\t\telse {\n\t\t\t\tlans=f[bl+1][br-1]+suf[l]+pre[r];\n\t\t\t\tlans+=(calc1[bl+1][R[bl]]-calc1[bl+1][l-1]);\n\t\t\t\tlans-=(calc1[br][R[bl]]-calc1[br][l-1]);\n                lans+=(calc[br-1][r]-calc[br-1][L[br]-1]);\n                lans-=(calc[bl][r]-calc[bl][L[br]-1]);\n\t\t\t}\n\t\t\tcnt=cnt1=0;\n\t\t\tint mx=0;\n\t\t\tfor(register int i=l;i<=R[bl];i++) {\n\t\t\t    t[a1[i]]++;\n\t\t\t\tif(a1[i]>mx) mx=a1[i];\n\t\t\t}\n\t\t\tfor(register int i=1;i<=mx;i++) if(t[i]) tmp[++cnt]=bk[bl][i];\n\t\t\tfor(register int i=l;i<=R[bl];i++) t[a1[i]]--;\n\t\t\tmx=0;\n\t\t\tfor(register int i=L[br];i<=r;i++) {\n\t\t\t    t[a1[i]]++;\n\t\t\t\tif(a1[i]>mx) mx=a1[i];\n\t\t\t}\n\t\t\tint pl=cnt+1;\n\t\t\tfor(register int i=mx;i>=1;i--) {\n\t\t\t\tif(t[i]) {\n\t\t\t\t\ttmp1[++cnt1]=bk[br][i];\n\t\t\t\t\twhile(pl-1>0&&tmp[pl-1]>tmp1[cnt1]) pl--;\n\t\t\t\t\tlans+=(cnt-pl+1);\n\t\t\t\t}\n\t\t\t}\n\t\t\tfor(register int i=L[br];i<=r;i++) t[a1[i]]--;\n\t\t\tcout<<lans<<'\\n';\n\t\t}\n\t}\n\treturn 0;\n}\n```\n",
        "postTime": 1681312623,
        "uid": 222104,
        "name": "_yjh",
        "ccfLevel": 0,
        "title": "P5046 [Ynoi2019 \u6a21\u62df\u8d5b] Yuno loves sqrt technology I \u9898\u89e3"
    },
    {
        "content": "## [Link](https://www.luogu.com.cn/problem/P5046)\n\n\u9898\u76ee\u5927\u610f\uff1a\n\n\u7ed9\u5b9a\u4e00\u4e2a\u957f\u5ea6\u4e3a $n$ \u7684\u6392\u5217\uff0c\u8fdb\u884c $m$ \u6b21\u8be2\u95ee\u3002\n\n\u6bcf\u6b21\u8be2\u95ee\u533a\u95f4 $[l,r]$ \u7684\u9006\u5e8f\u5bf9\u6570\uff0c\u5f3a\u5236\u5728\u7ebf\u3002\n\n\u6570\u636e\u4fdd\u8bc1 $1\\le n,m\\le 10^5$\u3002\n\n------------\n\n\u524d\u7f6e\u77e5\u8bc6\uff1a\u5e8f\u5217\u5206\u5757\uff0c\u6811\u72b6\u6570\u7ec4\uff0c\u7b80\u5355\u5bb9\u65a5\u3002\n\n\u521a\u770b\u5230\u8fd9\u9053\u9898\u5c31\u60f3\u5230\u4e86\u4e00\u4e2a\u5e38\u89c1\u7684\u5957\u8def\uff1a\u5206\u5757\uff0c\u8bbe\u5757\u957f\u4e3a $\\sqrt{n}$\u3002\u9884\u5904\u7406\u51fa\u5757 $i$ \u5230\u5757 $j$ \u7684\u9006\u5e8f\u5bf9\u6570 $ans_{i,j}$\u3002\u7136\u540e\u5bf9\u4e8e\u6bcf\u6b21\u67e5\u8be2\uff0c\u5c06\uff08\u6574\u5757\u548c\u6574\u5757\uff09\uff0c\uff08\u6574\u5757\u548c\u6563\u5757\uff09\u548c\uff08\u6563\u5757\u548c\u6563\u5757\uff09\u7684\u9006\u5e8f\u5bf9\u6570\u52a0\u8d77\u6765\u5373\u53ef\u3002\n\n\u4ee5\u4e0a\u505a\u6cd5\u7528\u5e26 $\\log$ \u6570\u636e\u7ed3\u6784\u7ef4\u62a4\u5bb9\u6613\u5b9e\u73b0\uff0c\u4f46\u65f6\u95f4\u590d\u6742\u5ea6\u81f3\u5c11\u5c31\u4f1a\u8fbe\u5230 $\\mathcal{O}((n+m)\\sqrt{n}\\log n)$\uff0c\u663e\u7136\u662f\u8fc7\u4e0d\u4e86\u7684\u3002\n\n\u6240\u4ee5\u6211\u4eec\u9700\u8981\u601d\u8003\u600e\u4e48\u4e0d\u7528\u5e26 $\\log$ \u7684\u6570\u636e\u7ed3\u6784\u7ef4\u62a4\u3002\n\n------------\n\n\u5148\u6765\u60f3\u60f3\u600e\u4e48\u9884\u5904\u7406\u51fa $ans_{i,j}$\u3002\n\n\u5355\u5757\u4e2d\u7684\u9006\u5e8f\u5bf9\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6811\u72b6\u6570\u7ec4 $\\mathcal{O}(n\\log n)$ \u6c42\u51fa\u3002\u8003\u8651\u5982\u4f55\u901a\u8fc7\u5355\u5757\u9006\u5e8f\u5bf9\u6570\u5f97\u5230\u591a\u5757\u7684\u9006\u5e8f\u5bf9\u6570\u3002\n\n\u5bb9\u6613\u53d1\u73b0 $ans_{i,j}=ans_{i+1,j}+ans_{i,j-1}-ans_{i+1,j-1}+calc(i,j)$\u3002\u5176\u4e2d $calc(i,j)$ \u8868\u793a\u7b2c $i$ \u5757\u4e0e\u7b2c $j$ \u5757\u7684\u8d21\u732e\u3002\u82e5\u6b64\u65f6\u518d\u7528\u6811\u72b6\u6570\u7ec4\u7ef4\u62a4\uff0c\u90a3\u4e48\u52a0\u4e0a\u5408\u5e76\u7684\u65f6\u95f4\u4ecd\u7136\u4f1a\u591a\u4e00\u4e2a $\\log$\u3002\n\n\u600e\u4e48 $\\mathcal{O}(\\sqrt{n})$ \u6c42\u51fa\u4e24\u5757\u4e4b\u95f4\u7684\u8d21\u732e\u5462?\n\n\u5206\u5757\uff0c\u7136\u540e\u8fdb\u884c\u5757\u5185\u5347\u5e8f\u6392\u5e8f\u3002\u6b64\u65f6\u5728\u5757\u5185\u626b\u63cf\uff0c\u56e0\u4e3a\u5355\u8c03\u9012\u589e\uff0c\u6240\u4ee5 $r$ \u6307\u9488\u4e0d\u51cf\u3002\u6b64\u65f6\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $\\mathcal{O}(\\sqrt{n})$\uff0c\u6c42\u51fa $ans$ \u7684\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $\\mathcal{O}(n\\sqrt{n})$\u3002\n\n------------\n\u63a5\u4e0b\u6765\u770b\u4e00\u4e0b\u600e\u4e48\u67e5\u8be2\u3002\n\n\u5bf9\u4e8e\u67e5\u8be2\u533a\u95f4 $[l,r]$\uff0c\u8bbe $l$ \u4f4d\u4e8e\u7b2c $p$ \u5757\uff0c$r$ \u4f4d\u4e8e\u7b2c $q$ \u5757\u3002\n\n\u82e5 $p=q$\uff0c\u76f4\u63a5\u6c42\u9006\u5e8f\u5bf9\u663e\u7136\u4e0d\u53ef\u53d6\u3002\n\n\u8003\u8651\u662f\u5426\u53ef\u4ee5\u7528\u5bb9\u65a5\u6c42\u51fa\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u9884\u5904\u7406\u51fa $pre$ \u548c $nxt$ \u4e24\u4e2a\u6570\u7ec4\u3002\u82e5\u4e0b\u6807\u4e3a $i$\uff0c\u5219\u5206\u522b\u8868\u793a\u7b2c $i$ \u4e2a\u6570\u5230\u5176\u6240\u5728\u7684\u5757\u7684\u5757\uff08\u9996$/$\u5c3e\uff09\u7684\u9006\u5e8f\u5bf9\u6570\u3002\u8fd9\u4e24\u4e2a\u6570\u7ec4\u53ef\u4ee5 $\\mathcal{O}(n\\log n)$ \u7528\u6811\u72b6\u6570\u7ec4\u6c42\u51fa\u3002\n\n\u5bb9\u6613\u53d1\u73b0\uff0c\u7b54\u6848\u4e3a $pre_r-pre_{l-1}$ \u518d\u51cf\u53bb $[L_p,l-1]$ \u4e0e $[l,r]$ \u4e4b\u95f4\u7684\u8d21\u732e\u3002\n\n\u6ce8\u610f\uff0c\u8fd9\u91cc\u9700\u8981\u7279\u5224\u4e00\u4e0b $l$ \u662f\u5426\u4e3a\u5757\u9996\u3002\n\n------------\n\u6700\u540e\u5728\u6765\u770b\u4e00\u4e0b $p\\neq q$ \u65f6\u600e\u4e48\u505a\u3002\n\n\u6574\u5757\u548c\u6574\u5757\u7684\u8d21\u732e\u53ef\u4ee5 $\\mathcal{O}(1)$ \u5f97\u51fa\u3002\n\n\u6563\u5757\u548c\u6563\u5757\u7684\u601d\u8def\u548c $calc$ \u4e00\u6837\uff0c\u4f46\u9700\u8981\u5224\u4e00\u4e0b\u626b\u8fc7\u53bb\u7684\u6570\u662f\u5426\u5728\u67e5\u8be2\u533a\u95f4\u4e2d\u3002\n\n\u6563\u5757\u548c\u6574\u5757\u7684\u8bdd\uff0c\u53ea\u9700\u8981\u6c42\u51fa\u7b2c $i$ \u5757\u5230\u7b2c $j$ \u5757\u4e2d\u503c\u5c0f\u4e8e\u7b49\u4e8e $k$ \u7684\u503c\u7684\u4e2a\u6570\uff0c\u7136\u540e\u52a0\u8d77\u6765\u5c31\u884c\u4e86\u3002\n\n\u8003\u8651\u5982\u4f55\u6c42\u51fa\u8fd9\u4e2a\u6570\u7ec4\u3002\n\n\u9996\u5148\uff0c\u5bb9\u6613\u5c06\u6c42\u7b2c $i$ \u5757\u5230\u7b2c $j$ \u5757\u4e2d\u503c\u5c0f\u4e8e\u7b49\u4e8e $k$ \u7684\u503c\u7684\u4e2a\u6570\u7b80\u5316\u4e3a\u6c42\u524d $i$ \u5757\u4e2d\u503c\u5c0f\u4e8e\u7b49\u4e8e $k$ \u7684\u4e2a\u6570\u3002\n\n\u7136\u540e\u8ba1\u7b97\u7684\u65f6\u5019\uff0c\u4e0d\u9700\u8981\u6bcf\u6b21\u628a\u6570\u7ec4\u5168\u90e8\u4fee\u6539\uff0c\u800c\u662f\u76f4\u63a5\u5148\u52a0\u8fdb\u53bb\uff0c\u7136\u540e\u7edf\u8ba1\u7684\u65f6\u5019\u518d\u6c42\u548c\u4e00\u4e0b\uff0c\u4f9d\u6b21\u5f80\u540e\u52a0\u3002\n\n\u53ef\u80fd\u5f88\u62bd\u8c61\uff0c\u4f46\u4ee3\u7801\u5f88\u7b80\u5355\u3002\n\n\u5355\u6b21\u67e5\u8be2\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(\\sqrt{n})$\u3002\n\n------------\n\n\u4e2a\u4eba\u611f\u89c9\u8fd9\u9898\u4e0d\u7b97\u5f88\u5361\u5e38\uff0c\u53ea\u9700\u8981\u628a\u5757\u957f\u6539\u4e3a $\\dfrac{\\sqrt{n}} {2}$ \u5f88\u5bb9\u6613\u5c31\u8fc7\u53bb\u4e86\u3002\n\n\u603b\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}((n+m)\\sqrt{n})$\u3002\n\n\u4ee3\u7801\u5982\u4e0b\uff1a\n\n```cpp\n#include<bits/stdc++.h>\n#define ll long long\nusing namespace std;\nchar buf[1<<20],*p1=buf,*p2=buf,obuf[1<<20],*o=obuf;\n#define g()(p1==p2&&(p2=(p1=buf)+fread(buf,1,1<<21,stdin),p1==p2)?EOF:*p1++)\ninline int read()\n{\n    int s=0;char c=g();\n    for(;!isdigit(c);c=g());\n    for(;isdigit(c);c=g())\n        s=s*10+c-'0';\n    return s;\n}\ninline void write(int x)\n{\n    static char buf[11];\n    static int len=-1;\n    do buf[++len]=x%10,x/=10;while(x);\n    while(len>=0)putchar(buf[len--]+'0');\n    putchar(' ');\n}\nint n,m,a[100005];\npair<int,int>b[100005];\nint len,block,L[700],R[700];\nint pos[100005],pre[100005],nxt[100005],cnt[700][100005];\nint sum[100005];\nll last,ans[700][700];\ninline void add(int x,int y)\n{\n\tfor(int i=x;i<=n;i+=i&(-i))\n\t\tsum[i]+=y;\n}\ninline int query_sum(int x)\n{\n\tint res=0;\n\tfor(int i=x;i;i-=i&(-i))\n\t\tres+=sum[i];\n\treturn res;\n}\nint calc(int x,int y,int l1,int r1,int l2,int r2)\n{\n\tint pos=L[y]-1,tot=0,res=0;\n\tfor(int i=L[x];i<=R[x];i++)\n\t{\n\t\tif(b[i].second<l1||r1<b[i].second)continue;\n\t\twhile(pos<R[y]&&b[i].first>b[pos+1].first)\n\t\t{\n\t\t\tpos++;\n\t\t\tif(l2<=b[pos].second&&b[pos].second<=r2)\n\t\t\t\ttot++;\n\t\t}\n\t\tres+=tot;\n\t}\n\treturn res;\n}\nvoid input()\n{\n\tn=read(),m=read();\n\tfor(int i=1;i<=n;i++)\n\t\ta[i]=b[i].first=read(),b[i].second=i;\n\tlen=sqrt(n)/2,block=n/len;\n\tfor(int i=1;i<=block;i++)\n\t\tL[i]=R[i-1]+1,R[i]=i*len;\n\tR[block]=n;\n\tfor(int i=1;i<=block;i++)\n\t{\n\t\tfor(int j=L[i];j<=R[i];j++)\n\t\t{\n\t\t\tpos[j]=i,cnt[i][a[j]]++;\n\t\t\tif(j!=L[i])\n\t\t\t\tpre[j]=pre[j-1]+query_sum(n)-query_sum(a[j]);\n\t\t\tadd(a[j],1);\n\t\t}\n\t\tfor(int j=L[i];j<=R[i];j++)\n\t\t\tadd(a[j],-1);\n\t\tfor(int j=R[i];j>=L[i];j--)\n\t\t{\n\t\t\tif(j!=R[i])\n\t\t\t\tnxt[j]=nxt[j+1]+query_sum(a[j]);\n\t\t\tadd(a[j],1);\n\t\t}\n\t\tfor(int j=L[i];j<=R[i];j++)\n\t\t\tadd(a[j],-1);\n\t\tint res=0;\n\t\tfor(int j=1;j<=n;j++)\n\t\t\tres+=cnt[i][j],cnt[i][j]=res+cnt[i-1][j];\n\t\tans[i][i]=pre[R[i]];\n\t\tsort(b+L[i],b+R[i]+1);\n\t}\n\tfor(int len=2;len<=block;len++)\n\t\tfor(int l=1;l+len-1<=block;l++)\n\t\t{\n\t\t\tint r=l+len-1;\n\t\t\tans[l][r]=ans[l+1][r]+ans[l][r-1]-ans[l+1][r-1]+calc(l,r,L[l],R[l],L[r],R[r]);\n\t\t}\n}\nll query(int l,int r)\n{\n\tint p=pos[l],q=pos[r];ll res=0;\n\tif(p==q)\n\t{\n\t\tif(l==L[p])return pre[r];\n\t\tres=pre[r]-pre[l-1]-calc(p,p,1,l-1,l,r);\n\t\treturn res;\n\t}\n\tres=nxt[l]+pre[r]+calc(p,q,l,R[p],L[q],r)+ans[p+1][q-1];\n\tfor(int i=l;i<=R[p];i++)\n\t\tres+=cnt[q-1][a[i]]-cnt[p][a[i]];\n\tfor(int i=L[q];i<=r;i++)\n\t\tres+=R[q-1]-L[p+1]+1-cnt[q-1][a[i]]+cnt[p][a[i]];\n\treturn res;\n}\nvoid solve()\n{\n\twhile(m--)\n\t{\n\t\tint l=read()^last,r=read()^last;\n\t\tprintf(\"%lld\\n\",last=query(l,r));\n\t}\n}\nint main()\n{\n\tinput();\n\tsolve();\n\treturn 0;\n}\n```\n\n\u8c22\u8c22\u89c2\u8d4f\u3002",
        "postTime": 1651284991,
        "uid": 306049,
        "name": "Utilokasteinn",
        "ccfLevel": 0,
        "title": "P5046 [Ynoi2019 \u6a21\u62df\u8d5b] Yuno loves sqrt technology I"
    },
    {
        "content": "[$\\text{Link}$](https://www.luogu.com.cn/problem/P5046)\n## \u9898\u610f\n\u7ed9\u4f60\u4e00\u4e2a\u957f\u5ea6\u4e3a $n$ \u7684\u6392\u5217 $a$\uff0c$q$ \u6b21\u8be2\u95ee\u533a\u95f4\u9006\u5e8f\u5bf9\u4e2a\u6570\uff0c**\u5f3a\u5236\u5728\u7ebf**\u3002\n\n**\u65f6\u95f4 750ms**\uff0c$1\\le n,q,a_i\\le 10^5$.\n## \u601d\u8def\n\u5176\u5b9e\u662f\u7b97\u6709\u8d21\u732e\u7684\u4e8c\u5143\u7ec4 $(i,j)(a_i>a_j,l\\le i\\le j\\le r)$ \u7684\u4e2a\u6570\u3002\n\n\u6392\u5217\u5176\u5b9e\u6ca1\u6709\u4ec0\u4e48\u6027\u8d28\uff0c\u53ea\u662f\u907f\u514d\u4e86\u76f8\u7b49\u60c5\u51b5\u7684\u8ba8\u8bba\u3002\n\n\u4e8e\u662f\u663e\u7136\u4f1a\u60f3\u5230\u5206\u7c7b\u8ba8\u8bba\uff1a\n\n\u8bbe\u5de6\u6563\u5757\u3001\u6574\u5757\u3001\u53f3\u6563\u5757\u5206\u522b\u4e3a $a,b,c$\uff0c\u8be2\u95ee\u5de6\u7aef\u4e3a\u5757 $bL$\uff0c\u53f3\u7aef\u4e3a\u5757 $bR$\uff0c$a$ \u7684\u53f3\u7aef\u70b9\u4e3a $L$\uff0c$c$ \u7684\u5de6\u7aef\u70b9\u4e3a $R$\u3002\n\n1. $i\\in a,j\\in a$\uff1a\u9884\u5904\u7406\u6bcf\u4e2a\u4f4d\u7f6e\u5230\u5757\u672b\u7684\u7b54\u6848 $s_i$ \u5373\u53ef\u3002\u7b54\u6848\u4e3a $s_l$\u3002\n2. $i\\in c,j\\in c$\uff1a\u9884\u5904\u7406\u6bcf\u4e2a\u4f4d\u7f6e\u5230\u5757\u9996\u7684\u7b54\u6848 $p_i$ \u5373\u53ef\u3002\u7b54\u6848\u4e3a $p_r$\u3002\n3. $i\\in b,j\\in b$\uff1a\u9884\u5904\u7406\u6bcf\u4e24\u4e2a\u5757\u95f4\u7684\u7b54\u6848 $g_{i,j}$ \u5373\u53ef\u3002\u7b54\u6848\u4e3a $g_{bL+1,bR-1}$\u3002\n4. $i\\in a,j\\in b$\uff1a\u9884\u5904\u7406\u524d $i$ \u5757\u4e2d\u5c0f\u4e8e $j$ \u7684\u6570 $f_{i,j}=\\sum_{k=1}^i\\sum_{t=bl_k}^{br_k}[a_t\\le j]$ \u5373\u53ef\u3002\u7b54\u6848\u4e3a $\\sum_{i\\in a}f_{bR-1,a_i}-f_{bL,a_i}$\u3002\n5. $i\\in b,j\\in c$\uff1a\u7528\u4e0a\u4e00\u7c7b\u7684\u4e1c\u897f\u5373\u53ef\u3002\u7b54\u6848\u4e3a $\\sum_{i\\in c}(R-L+1)-f_{bR-1,a_i}+f_{bL,a_i}$\u3002\n6. $i\\in a,j\\in c$\uff1a\u9884\u5904\u7406\u5757\u5185\u6392\u5e8f\u3002\u5c06\u4e24\u6563\u5757\u6392\u5e8f\u540e\u7684\u6570\u7ec4\u5f52\u5e76\u6bd4\u8ba1\u7b97\u5373\u53ef\u3002\n\n\u4f46\u6211\u4eec\u5ffd\u7565\u4e86\u4e00\u70b9\uff1a\u5f53 $l,r$ \u540c\u5757\u65f6\u6ca1\u6709\u5904\u7406\u3002\u4f46\u6211\u4eec\u9884\u5904\u7406\u51fa $h_{i,j}$\uff08$i,j$ \u540c\u5757\uff09\u5e76\u9002\u5f53\u538b\u7f29\u7a7a\u95f4\u5373\u53ef\u3002\n\n\u8fd9\u6837\u505a\u5230\u4e86\u603b\u65f6\u7a7a $O(n\\sqrt n)$\u3002\n****\n\u4f46\u662f\uff0c\u7531\u4e8e\u5e38\u6570\u8f83\u5927\uff0c\u6211\u4e0d\u7ecf\u4efb\u4f55\u5e38\u6570\u5904\u7406\u7684\u4ee3\u7801\u53ea\u80fd\u5f97\u5230 $40$ \u5206\u3002\n\n\u4e8e\u662f\u6211\u4eec\u9700\u8981\u4f18\u5316\uff1a\n\n1. \u8c03\u5757\u957f\uff1a\u559c\u95fb\u4e50\u89c1\u3002\u6839\u636e\u5e38\u6570\u8c03\u5230 $150\\sim170$\u3002\n2. \u9884\u5904\u7406\u524a\u5e38\u6570\uff1a$p$ \u548c $s$ \u7528 $h$ \u76f4\u63a5\u5f97\u5230\uff0c$f$ \u7528\u4e8c\u7ef4\u524d\u7f00\u548c\uff0c\u51cf\u5c11\u6811\u72b6\u6570\u7ec4\u6216\u8005\u503c\u57df\u5206\u5757\u7684\u4f7f\u7528\u3002\n3. **\u8be2\u95ee\u524a\u5e38\u6570**\uff1a\u5982\u679c $R-r-1<r-bl_{bR}$ \u90a3\u4e48\u6211\u4eec\u5c31\u7528\u5230 $R$ \u7684\u7b54\u6848\u5bb9\u65a5\u6389\u591a\u7b97\u7684\u90e8\u5206\u3002\u5de6\u6563\u5757\u540c\u7406\u3002\n\n\u5c45\u7136\u5c31\u80fd\u8fc7\u4e86\uff0c\u8fd9\u6bd4\u7b2c\u56db\u5206\u5757\u7684\u5361\u5e38\u7b80\u5355\u4e9b\u3002\n****\n\u4ee3\u7801\u597d\u5199\uff0c\u4ee5\u4e0b\u4ee3\u7801\u4ec5\u4f9b\u53c2\u8003\uff1a\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define ll long long\nnamespace IO{//by cyffff\n\t\n}\nconst int N=1e5+10,sq=170,nq=N/sq+10;\nint n,q,blk,a[N],pre[N],bl[nq],br[nq],bel[N];\nint pr[N],sf[N],f[nq][N],h[N][sq+10],se[nq][nq];\nll g[nq][nq],last;\nstruct Tem{\n\tint x,id;\n\tinline friend bool operator<(const Tem &a,const Tem &b){\n\t\treturn a.x<b.x;\n\t}\n}b[N];\ninline void init(int id,int l,int r){\n\tint p=l-1;\n\tfor(int i=l;i<=r;i++)\n\t\tf[id][a[i]]++;\n\tfor(int i=l;i<=r;i++)\n\t\tb[i].x=a[i],b[i].id=i;\n\tsort(b+l,b+r+1);\n\tfor(int j=l;j<=r;j++)\n\t\tfor(int i=j-1;i>=l;i--)\n\t\t\th[i][j-l]=h[i+1][j-l]+h[i][j-1-l]-h[i+1][j-1-l]+(a[i]>a[j]);\n\tfor(int i=l+1;i<=r;i++)\n\t\tpr[i]=h[l][i-l];\n\tfor(int i=r-1;i>=l;i--)\n\t\tsf[i]=h[i][r-l];\n}\nint s1[N],s2[N];\nint main(){\n\tn=read(),q=read();\n\tfor(int i=1;i<=n;i++)\n\t\ta[i]=read();\n\tfor(int i=1;i<=n;i+=sq){\n\t\tblk++;\n\t\tbl[blk]=i,br[blk]=min(i+sq-1,n);\n\t\tfor(int j=bl[blk];j<=br[blk];j++)\n\t\t\tbel[j]=blk;\n\t\tinit(blk,bl[blk],br[blk]);\n\t\tg[blk][blk]=pr[br[blk]];\n\t}\n\tfor(int i=1;i<=blk;i++)\n\t\tfor(int j=1;j<=n;j++)\n\t\t\tf[i][j]+=f[i-1][j]+f[i][j-1]-f[i-1][j-1];\n\tfor(int i=1;i<=blk;i++)\n\t\tfor(int j=i;j<=blk;j++){\n\t\t\tint tmp=0;\n\t\t\tfor(int k=bl[j];k<=br[j];k++)\n\t\t\t\ttmp+=f[i][a[k]];\n\t\t\tse[i][j]=tmp;\n\t\t}\n\tfor(int j=1;j<=blk;j++)\n\t\tfor(int i=j-1;i>=1;i--){\n\t\t\tll cnt=g[i][j-1]+g[i+1][j]-g[i+1][j-1];\n\t\t\tfor(int k=bl[i];k<=br[i];k++)\n\t\t\t\tcnt+=f[j][a[k]]-f[j-1][a[k]];\n\t\t\tg[i][j]=cnt;\n\t\t}\n\twhile(q--){\n\t\tint l=read()^last,r=read()^last;\n\t\tint bL=bel[l],bR=bel[r];\n\t\tif(bL==bR){\n\t\t\tlast=h[l][r-bl[bL]];\n\t\t}else{\n\t\t\tlast=sf[l]+pr[r]+g[bL+1][bR-1];\n\t\t\tint len=br[bR-1]-bl[bL+1]+1;\n\t\t\tfor(int i=l;i<=br[bL];i++)\n\t\t\t\tlast+=f[bR-1][a[i]]-f[bL][a[i]];\n\t\t\tint L=bl[bR],R=br[bR];\n\t\t\tif(R-r-1<r-L){\n\t\t\t\tlast+=(r-L+1ll)*len-(se[bR-1][bR]-se[bL][bR]);\n\t\t\t\tfor(int i=r+1;i<=R;i++)\n\t\t\t\t\tlast+=f[bR-1][a[i]]-f[bL][a[i]];\n\t\t\t}else{\n\t\t\t\tfor(int i=L;i<=r;i++)\n\t\t\t\t\tlast+=len-f[bR-1][a[i]]+f[bL][a[i]];\n\t\t\t}\n\t\t\tint top1=0,top2=0;\n\t\t\tfor(int i=bl[bL];i<=br[bL];i++)\n\t\t\t\tif(b[i].id>=l) s1[++top1]=b[i].x;\n\t\t\tfor(int i=bl[bR];i<=br[bR];i++)\n\t\t\t\tif(b[i].id<=r) s2[++top2]=b[i].x;\n\t\t\tint i=0,j=0,c=0;\n\t\t\tfor(;i<top1&&j<top2;)\n\t\t\t\tif(s1[i+1]<s2[j+1]) last+=c,i++;\n\t\t\t\telse c++,j++;\n\t\t\tlast+=1ll*c*(top1-i);\n\t\t}\n\t\twrite(last),putc('\\n');\n\t}\n\tflush();\n}\n```\n\u518d\u89c1 qwq~",
        "postTime": 1647235677,
        "uid": 365127,
        "name": "cyffff",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P5046\u3010[Ynoi2019 \u6a21\u62df\u8d5b] Yuno loves sqrt technology I\u3011"
    },
    {
        "content": "\u7b2c\u4e00\u6b21\u7ed9 ynoi \u5199\u9898\u89e3\uff0c\u597d\u6fc0\u52a8\u3002\n\n\u6574\u4e2a\u7b97\u6cd5\u7684\u6838\u5fc3\u5728\u4e8e\u5f52\u5e76\u4e24\u4e2a\u6709\u5e8f\u6570\u7ec4\uff0c$O(n)$ \u6c42\u9006\u5e8f\u5bf9\u3002\n\n\u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u9884\u5904\u7406\u7684\u6570\u7ec4\uff1a\n\n`pre[i]`\uff1a\u8868\u793a `i` \u5230\u6240\u5728\u5757\u5de6\u7aef\u70b9\u7684\u9006\u5e8f\u5bf9\u6570\u3002\u6811\u72b6\u6570\u7ec4\u8dd1\u4e00\u904d\u5373\u53ef\u3002\n\n`f[i][j]`\uff1a\u8868\u793a\u533a\u95f4 `[1,i]` \u5bf9\u7b2c `j` \u5757\u7684\u9006\u5e8f\u5bf9\u6570\u3002\uff08\u6ce8\uff1a\u56e0\u4e3a\u662f\u5f53\u524d\u7f00\u548c\u7528\uff0c\u6240\u4ee5\u4e0d\u7528\u7edf\u8ba1\u7b2c `j` \u5757\u4ed6\u81ea\u5df1\uff09\u3002\u5bf9\u8be5\u5757\u672c\u8eab\u4e0e\u6574\u4e2a\u6570\u7ec4\u505a\u5f52\u5e76\u518d\u505a\u524d\u7f00\u548c\u5373\u53ef\u3002\n\n`F[i][j]`\uff1a\u8868\u793a\u7b2c `i` \u5757\u4e0e\u7b2c `j` \u5757\u4e4b\u95f4\u7684\u9006\u5e8f\u5bf9\u6570\u3002\u5229\u7528\u5bb9\u65a5\u539f\u7406 $F_{i,j}=F_{i+1,j}+F_{i,j-1}-F_{i+1,j-1}+(i\\to j)$ \u5176\u4e2d $i\\to j$ \u8868\u793a\u7b2c `i` \u5757\u5bf9\u7b2c `j` \u5757\u7684\u9006\u5e8f\u5bf9\u6570\u3002\u7528 `f` \u6570\u7ec4\u8868\u793a\uff0c\u7b49\u4e8e `f[R[i]][j]-f[L[i]-1][j]`\u3002\n\n\u7136\u540e\uff0c\u8be2\u95ee\u3002\n\n\u82e5 $l,r$ \u5728\u540c\u4e00\u5757\uff0c$ans=pre_r-pre_{l-1}-([L,l-1]\\to[l,r])$\uff08\u5bb9\u65a5\uff09\uff0c$[L,l-1]\\to[l,r]$ \u8fd8\u662f\u5f52\u5e76\n\n\u82e5\u4e0d\u540c\u5757\uff0c\u8d21\u732e\u5206\u516d\u79cd\u3002\n\n1. \u5de6\u2192\u5de6 `suf`\uff1b\n2. \u4e2d\u2192\u4e2d `F`\uff1b\n3. \u53f3\u2192\u53f3 `pre`\uff1b\n4. \u5de6\u2192\u4e2d \u4f9d\u6b21\u679a\u4e3e\u6bcf\u4e00\u5757\uff0c\u7528 `f` \u7b97\uff1b\n5. \u4e2d\u2192\u53f3 \u540c\u4e0a\uff1b\n6. \u5de6\u2192\u53f3 \u5f52\u5e76\u3002\n\n\u7ed3\u675f\u3002\n\ncode:\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nvoid wr(long long ans){if(ans<0)putchar('-'),ans=-ans;if(ans>9)wr(ans/10);putchar((ans%10)^48);}\ntemplate<typename T>void qr(T &x){\n\tbool f=x=0;\n\tchar c=getchar();\n\twhile(!isdigit(c)) f|=c=='-',c=getchar();\n\twhile(isdigit(c)) x=(x<<3)+(x<<1)+(c^48),c=getchar();\n\tx=f?(x-1):x;\n}\nconst int MAXN=1e5+5,MAXB=320;\nstruct node{int v,id;}b[MAXN];\nint n,m,s,sum,bls=1,p,q,l1,l2,idx[MAXN],a[MAXN],L[MAXB],R[MAXB],bit[MAXN],f[MAXN][MAXB],pre[MAXN],suf[MAXN],c[MAXN],d[MAXN],a1[MAXN],a2[MAXN];\nlong long ans,F[MAXB][MAXB],l,r;\ninline void add(int x,int v){//bit\n\twhile(x<=n){\n\t\tbit[x]+=v;\n\t\tx+=x&-x;\n\t}\n}\ninline int clc(int x){\n\tint v=0;\n\twhile(x){\n\t\tv+=bit[x];\n\t\tx&=x-1;\n\t}\n\treturn v;\n}\ninline bool cmp(node&x,node&y){return x.v<y.v;}\ninline int merge(){//\u5f52\u5e76\n\tint p=1,q=1,ret=0;\n\twhile(p<=l1&&q<=l2){\n\t\tif(a1[p]<a2[q])++p;\n\t\telse ret+=l1-p+1,++q;\n\t}\n\treturn ret;\n}\ninline int min(int x,long long y){\n\treturn x<y?x:y;\n}\nint main(){\n\tqr(n),qr(m);\n\ts=sqrt(n);\n\tfor(l=1,r=s;l<=n;l+=s,r=min(n,r+s),++bls){\n\t\tL[bls]=l,R[bls]=r;\n\t\tfor(int i=l;i<=r;++i){\n\t\t\tqr(a[i]);\n\t\t\tidx[i]=bls;\n\t\t\tb[i].v=a[i];\n\t\t\tb[i].id=i;\n\t\t}\n\t\tsort(b+l,b+r+1,cmp);\n\t}--bls;\n\tfor(int i=1;i<=bls;++i){//F\u7684\u521d\u59cb\u503c,pre,suf\n\t\tfor(int j=L[i];j<=R[i];++j){\n\t\t\tc[j]=b[j].v;\n\t\t\td[j]=b[j].id;\n\t\t\tadd(a[j],1);\n\t\t\tsum+=j-L[i]+1-clc(a[j]);\n\t\t\tpre[j]=sum;\n\t\t}\n\t\tF[i][i]=sum;\n\t\tfor(int j=L[i];j<=R[i];++j){\n\t\t\tsuf[j]=sum;\n\t\t\tsum-=clc(a[j]-1);\n\t\t\tadd(a[j],-1);\n\t\t}\n\t}\n\tsort(b+1,b+n+1,cmp);\n\tfor(int j=1;j<=bls;++j){//\u5904\u7406f\n\t\tfor(int i=1,k=L[j];i<=n;++i){\n\t\t\twhile(k<=R[j]&&c[k]<b[i].v)++k;\n\t\t\tif(b[i].id<L[j]){\n\t\t\t\tf[b[i].id][j]=k-L[j];\n\t\t\t}\n\t\t\tif(b[i].id>R[j]){\n\t\t\t\tf[b[i].id][j]=R[j]-k+1;\n\t\t\t}\n\t\t}\n\t\tfor(int i=2;i<=n;++i){\n\t\t\tf[i][j]+=f[i-1][j];\n\t\t}\n\t}\n\tfor(int len=2;len<=bls;++len){//\u5904\u7406F\n\t\tfor(int i=1,j=len;j<=bls;++i,++j){\n\t\t\tF[i][j]=F[i+1][j]+F[i][j-1]-F[i+1][j-1]+f[R[i]][j]-f[L[i]-1][j];\n\t\t}\n\t}\n\twhile(m--){\n\t\tqr(l),qr(r);\n\t\tl^=ans,r^=ans;\n\t\tif(l>r)l=l+r-(r=l);\n\t\tconst int lb=idx[l],rb=idx[r];\n\t\tl1=l2=0;\n\t\tif(lb==rb){\n\t\t\tfor(int i=L[lb];i<=R[lb];++i){\n\t\t\t\tif(d[i]<l)a1[++l1]=c[i];\n\t\t\t\telse if(d[i]<=r)a2[++l2]=c[i];\n\t\t\t}\n\t\t\tans=pre[r]-(l!=L[lb])*(pre[l-1])-merge();\n            //\u8fd9\u91cc\u8981\u5224l!=L[lb]\u662f\u56e0\u4e3a\u4ed6\u53ef\u80fd\u7206\u5230\u4e0b\u4e00\u5757\n\t\t}\n\t\telse{\n\t\t\tfor(int i=L[lb];i<=R[lb];++i){\n\t\t\t\tif(d[i]>=l)a1[++l1]=c[i];\n\t\t\t}\n\t\t\tfor(int i=L[rb];i<=R[rb];++i){\n\t\t\t\tif(d[i]<=r)a2[++l2]=c[i];\n\t\t\t}\n\t\t\tans=F[lb+1][rb-1]+pre[r]+suf[l]+merge();//1,2,3,6\n\t\t\tfor(int i=idx[l]+1;i<idx[r];++i){\n\t\t\t\tans+=(f[R[lb]][i]-f[l-1][i])+(f[r][i]-f[L[rb]-1][i]);//4,5\n\t\t\t}\n\t\t}\n\t\twr(ans);\n\t\tputchar('\\n');\n\t}\n\treturn 0;\n}\n\n```",
        "postTime": 1643290532,
        "uid": 383785,
        "name": "Hagasei",
        "ccfLevel": 6,
        "title": "P5046 \u9898\u89e3"
    },
    {
        "content": "### P5046 Yuno loves sqrt technology I\n\n\u7ed9\u4f60\u4e00\u4e2a\u957f\u4e3a $n$ \u7684\u6392\u5217\uff0c$m$ \u6b21\u8be2\u95ee\uff0c\u6bcf\u6b21\u67e5\u8be2\u4e00\u4e2a\u533a\u95f4\u7684\u9006\u5e8f\u5bf9\u6570\uff0c\u5f3a\u5236\u5728\u7ebf\u3002\n\n$1 \\leq n,m\\leq 10^5$\uff0c\u65f6\u9650 $750\\text{ms}$\uff0c\u7a7a\u9650 $500\\text{MB}$\u3002\n\n#### sol\n\n\u9759\u6001\u67e5\u8be2\u9006\u5e8f\u5bf9\u6570\u3002\n\n\u6839\u636e\u8fd9\u9898\u6ca1\u6709\u4fee\u6539\uff0c\u5bb9\u6613\u60f3\u5230\u76f4\u63a5\u9884\u5904\u7406\uff0c$\\mathcal O(\\sqrt{n})$ \u5185\u56de\u7b54\u8be2\u95ee\u5373\u53ef\u3002\n\n\u8003\u8651\u5e8f\u5217\u5206\u5757\u3002\n\n**\u9884\u5904\u7406\u65b9\u6cd5\u4e00**\n\n\u7c7b\u4f3c\u4e8e\u5f52\u5e76\u6392\u5e8f\uff0c\u9700\u8981\u9884\u5904\u7406\u7684\u4fe1\u606f\u6709\uff1a\n\n1. \u6bcf\u4e2a\u5143\u7d20\u5230\u5176\u5757\u9996\u8fd9\u6bb5\u533a\u95f4\u7684\u9006\u5e8f\u5bf9\u6570\u3002\n2. \u6bcf\u4e2a\u5143\u7d20\u5230\u5176\u5757\u5c3e\u8fd9\u6bb5\u533a\u95f4\u7684\u9006\u5e8f\u5bf9\u6570\u3002\n3. \u5757 $i$ \u5230\u5757 $j$ \u8fd9\u6bb5\u533a\u95f4\u7684\u9006\u5e8f\u5bf9\u6570\u3002\n4. \u524d $i$ \u4e2a\u5757\u4e2d\uff0c\u5c0f\u4e8e\u7b49\u4e8e $j$ \u7684\u5143\u7d20\u4e2a\u6570\u3002\n\n\u5bf9\u4e8e $1,2$\uff0c\u7528\u6811\u72b6\u6570\u7ec4\u626b\u4e00\u904d\u5373\u53ef\uff0c\u5355\u5757\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $\\mathcal O(\\sqrt n \\log \\sqrt n)$\uff0c\u603b\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $\\mathcal O(n \\log \\sqrt n)$\uff0c\u53ef\u8fc7\u3002\n\n\u5bf9\u4e8e $3$\uff0c\u8bbe\u5176\u4e3a $f[i][j]$\uff0c\u5219\u6709\u9012\u63a8\u516c\u5f0f\uff1a\n$$\nf[i][j]=f[i][j-1]+f[i+1][j]-f[i+1][j-1]+(\\ i \\ \\text{\u6240\u5728\u5757\u548c}\\ j \\ \\text{\u6240\u5728\u5757\u4ea7\u751f\u7684\u8d21\u732e})\n$$\n\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $\\mathcal O(n \\sqrt n)$\uff0c\u53ef\u8fc7\u3002\n\n\u5bf9\u4e8e $4$\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a $j$\uff0c\u5148\u5728\u6bcf\u4e00\u4e2a\u5757\u5185\u626b\u4e00\u904d\uff0c\u518d\u8ba1\u7b97\u524d\u7f00\u548c\u5373\u53ef\uff0c\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $\\mathcal O(n \\sqrt n)$\uff0c\u53ef\u8fc7\u3002\n\n\u9884\u5904\u7406\u597d\u4e86\uff0c\u63a5\u4e0b\u6765\u8003\u8651\u600e\u4e48\u67e5\u8be2\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u8be2\u95ee $l,r$\uff1a\n\n* \u82e5 $l,r$ \u5728\u540c\u4e00\u5757\u5185\uff0c\u5219\u7b54\u6848\u4e3a\u5757\u9996\u5230 $r$ \u7684\u8d21\u732e\u548c\u5757\u9996\u5230 $l-1$ \u7684\u8d21\u732e\u4e4b\u5dee\uff0c\u5185\u90e8\u8d21\u732e\u7528 $1$ \u8ba1\u7b97\uff0c\u4e24\u5757\u8d21\u732e\u7528\u5f52\u5e76\u6c42\u5373\u53ef\u3002\n\n* \u82e5 $l,r$ \u4e0d\u5728\u540c\u4e00\u5757\u5185\uff0c\u5219\u5206\u6210\u4e24\u4e2a\u6563\u5757\u548c\u591a\u4e2a\u6574\u5757\uff0c\u5148\u7528 $3$ \u8ba1\u7b97\u597d\u6574\u5757\u7684\u5185\u90e8\u8d21\u732e\uff0c\u7136\u540e\u6839\u636e $4$ \u6c42\u6563\u5757\u4e0e\u6574\u5757\u7684\u8d21\u732e\uff0c\u518d\u5f52\u5e76\u6c42\u6563\u5757\u5bf9\u6563\u5757\u7684\u8d21\u732e\uff0c\u6700\u540e\u6563\u5757\u5185\u90e8\u8d21\u732e\u7528\u4e0a\u9762\u90a3\u79cd\u65b9\u6cd5\u8ba1\u7b97\u5373\u53ef\u3002\n\n\u603b\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $\\mathcal O((n+m)\\sqrt{n})$\uff0c\u603b\u7a7a\u95f4\u590d\u6742\u5ea6\u4e3a $\\mathcal O(n \\sqrt n)$\u3002\n\n\n**\u9884\u5904\u7406\u65b9\u6cd5\u4e8c**\n\n\u8bb0 $F[i][j]$ \u8868\u793a $[l,r]$ \u8fd9\u6bb5\u533a\u95f4\u4e0e\u7b2c $j$ \u5757\u4e2d\u7684\u6570\u4ea7\u751f\u7684\u9006\u5e8f\u5bf9\u6570\uff0c\u8bb0\u4e3a $5$\u3002\n\n\u518d\u628a\u6cd5\u4e00\u4e2d\u7684 $1,2,3$ \u7167\u642c\u8fc7\u6765\u3002\n\n\u8003\u8651\u8ba1\u7b97 $F$\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u5757\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u5757\uff0c\u5f52\u5e76\u8bb0\u5f55\u6bcf\u4e2a\u6570\u5bf9\u5757\u7684\u8d21\u732e\uff0c\u7136\u540e\u7b97\u4e00\u904d\u524d\u7f00\u548c\u5373\u53ef\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal O(n \\sqrt n)$\uff0c\u53ef\u8fc7\u3002\n\n\u8fd9\u6837\u8ba1\u7b97 $f$ \u7684\u65f6\u5019\u53ef\u4ee5\u7701\u6389\u4e00\u4e2a $\\mathcal O(\\sqrt n)$ \u7684\u5f52\u5e76\u3002\n\n\u5bf9\u4e8e\u8be2\u95ee $l,r$\uff1a\n\n* \u82e5 $l,r$ \u5728\u540c\u4e00\u5757\u5185\uff0c\u5219\u7b54\u6848\u4e3a\u5757\u9996\u5230 $r$ \u7684\u8d21\u732e\u548c\u5757\u9996\u5230 $l-1$ \u7684\u8d21\u732e\u4e4b\u5dee\uff0c\u5185\u90e8\u8d21\u732e\u7528 $1$ \u8ba1\u7b97\uff0c\u4e24\u5757\u8d21\u732e\u7528\u5f52\u5e76\u6c42\u5373\u53ef\u3002\n* \u82e5 $l,r$ \u4e0d\u5728\u540c\u4e00\u5757\u5185\uff0c\u5219\u5206\u6210\u4e24\u4e2a\u6563\u5757\u548c\u591a\u4e2a\u6574\u5757\uff0c\u5148\u7528 $3$ \u8ba1\u7b97\u597d\u6574\u5757\u7684\u5185\u90e8\u8d21\u732e\uff0c\u7136\u540e\u6839\u636e $5$ \u5dee\u5206\u6c42\u6563\u5757\u4e0e\u6574\u5757\u7684\u8d21\u732e\uff0c\u518d\u5f52\u5e76\u6c42\u6563\u5757\u5bf9\u6563\u5757\u7684\u8d21\u732e\uff0c\u6700\u540e\u6563\u5757\u5185\u90e8\u8d21\u732e\u7528\u4e0a\u9762\u90a3\u79cd\u65b9\u6cd5\u8ba1\u7b97\u5373\u53ef\u3002\n\n\u603b\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $\\mathcal O((n+m)\\sqrt{n})$\uff0c\u603b\u7a7a\u95f4\u590d\u6742\u5ea6\u4e3a $\\mathcal O(n \\sqrt n)$\uff0c\u4f46\u5e38\u6570\u8f83\u6cd5\u4e00\u66f4\u4e3a\u4f18\u79c0\u3002\n\n$\\text{01-31 / 21:29:13 / 2.91s /  132.38MB /  4.00KB C++98 O2}$\u3002\n\n```cpp\n#include <cstdio>\n#include <algorithm>\n\nnamespace Fread\n{\n    const int SIZE = 1 << 23;\n    char buf[SIZE], *S, *T;\n    inline char getchar()\n    {\n        if (S == T)\n        {\n            T = (S = buf) + fread(buf, 1, SIZE, stdin);\n            if (S == T)\n                return '\\n';\n        }\n        return *S++;\n    }\n}\nnamespace Fwrite\n{\n    const int SIZE = 1 << 23;\n    char buf[SIZE], *S = buf, *T = buf + SIZE;\n    inline void flush()\n    {\n        fwrite(buf, 1, S - buf, stdout);\n        S = buf;\n    }\n    inline void putchar(char c)\n    {\n        *S++ = c;\n        if (S == T)\n            flush();\n    }\n    struct NTR\n    {\n        ~NTR()\n        {\n            flush();\n        }\n    } ztr;\n}\n\n#ifdef ONLINE_JUDGE\n#define getchar Fread::getchar\n#define putchar Fwrite::putchar\n#endif\n\ninline int read()\n{\n\tint x = 0, f = 1;\n\tchar c = getchar();\n\twhile(c < '0' || c > '9')\n\t{\n\t\tif(c == '-') f = -1;\n\t\tc = getchar();\n\t}\n\twhile(c >= '0' && c <= '9')\n\t{\n\t\tx = x * 10 + c - '0';\n\t\tc = getchar();\n\t}\n\treturn x * f;\n}\n\ninline void write(long long x)\n{\n\tif(x < 0)\n\t{\n\t\tputchar('-');\n\t\tx = -x;\n\t}\n\tif(x > 9)\n\t\twrite(x / 10);\n\tputchar(x % 10 + '0');\n}\n\nconst int _ = 1e5 + 7, M = 320, siz = 317;\n\nint n, m, a[_], L[M], R[M], bel[_], blo, pre[_], suf[_], f[M][_];\n\nlong long F[M][M], ans;\n\nint x[M], y[M], lx, ly, c[_], d[_];\n\nstruct Pair\n{\n\tint fi, se;\n\tinline bool operator < (const Pair & tmp) const\n\t{\n\t\treturn fi < tmp.fi;\n\t}\n} b[_];\n\nstruct BIT\n{\n\tint b[_];\n\tinline void add(int x, int val)\n\t{\n\t\tfor(int i = x; i < _; i += i & -i) b[i] += val;\n\t}\n\tinline int ask(int x)\n\t{\n\t\tint res = 0;\n\t\tfor(int i = x; i; i -= i & -i) res += b[i];\n\t\treturn res;\n\t}\n} t;\n\ninline int merge(int *a, int *b, int la, int lb)\n{\n\tint ia = 1, ib = 1, res = 0;\n\twhile(ia <= la && ib <= lb)\n\t\tif(a[ia] < b[ib]) ++ia;\n\t\telse\n\t\t{\n\t\t\tres += la - ia + 1;\n\t\t\t++ib;\n\t\t}\n\treturn res;\n}\n\ninline void init()\n{\n\tblo = (n - 1) / siz + 1;\n\tfor(int i = 1; i <= blo; ++i)\n\t{\n\t\tL[i] = R[i - 1] + 1;\n\t\tR[i] = i * siz;\n\t}\n\tR[blo] = n;\n\tfor(int i = 1; i <= n; ++i)\n\t\tb[i] = (Pair)\n\t{\n\t\ta[i], i\n\t};\n\tfor(int i = 1; i <= blo; ++i)\n\t{\n\t\tstd::sort(b + L[i], b + R[i] + 1);\n\t\tfor(int j = L[i]; j <= R[i]; ++j)\n\t\t{\n\t\t\tbel[j] = i;\n\t\t\tc[j] = b[j].fi;\n\t\t\td[j] = b[j].se;\n\t\t}\n\t\tint x = 0;\n\t\tfor(int j = L[i]; j <= R[i]; ++j)\n\t\t{\n\t\t\tt.add(a[j], 1);\n\t\t\tx += t.ask(n) - t.ask(a[j]);\n\t\t\tpre[j] = x;\n\t\t}\n\t\tF[i][i] = x;\n\t\tfor(int j = L[i]; j <= R[i]; ++j)\n\t\t{\n\t\t\tsuf[j] = x;\n\t\t\tt.add(a[j], -1);\n\t\t\tx -= t.ask(a[j] - 1);\n\t\t}\n\t}\n\tstd::sort(b + 1, b + n + 1);\n\tfor(int j = 1; j <= blo; ++j)\n\t\tfor(int i = 1, k = L[j]; i <= n; ++i)\n\t\t{\n\t\t\tconst int id = b[i].se;\n\t\t\twhile(k <= R[j] && b[i].fi > c[k]) ++k;\n\t\t\tif(id < L[j]) f[j][id] = k - L[j];\n\t\t\telse if(id > R[j]) f[j][id] = R[j] - k - (k <= R[j] && b[i].fi == c[k]) + 1;\n\t\t}\n\tfor(int i = 1; i <= blo; ++i)\n\t\tfor(int j = 2; j <= n; ++j) f[i][j] += f[i][j - 1];\n\tfor(int len = 1; len <= blo; ++len)\n\t\tfor(int i = 1; i <= blo; ++i)\n\t\t{\n\t\t\tif(len + i > blo) break;\n\t\t\tconst int j = i + len;\n\t\t\tF[i][j] = F[i + 1][j] + F[i][j - 1] - F[i + 1][j - 1] + f[j][R[i]] - f[j][L[i] - 1];\n\t\t}\n}\n\nsigned main()\n{\n\tn = read(), m = read();\n\tfor(int i = 1; i <= n; ++i) a[i] = read();\n\tinit();\n\twhile(m--)\n\t{\n\t\tint l = read() ^ ans, r = read() ^ ans, bl = bel[l], br = bel[r];\n\t\tlx = ly = 0;\n\t\tif(bl == br)\n\t\t{\n\t\t\tfor(int i = L[bl]; i <= R[bl]; ++i)\n\t\t\t{\n\t\t\t\tif(l <= d[i] && d[i] <= r) y[++ly] = c[i];\n\t\t\t\telse if(d[i] < l) x[++lx] = c[i];\n\t\t\t\tans = pre[r] - ((l == L[bl]) ? 0 : pre[l - 1]) - merge(x, y, lx, ly);\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tans = F[bl + 1][br - 1] + pre[r] + suf[l];\n\t\t\tfor(int i = bl + 1; i <= br - 1; ++i)\n\t\t\t\tans += f[i][R[bl]] - f[i][l - 1] + f[i][r] - f[i][L[br] - 1];\n\t\t\tfor(int i = L[bl]; i <= R[bl]; ++i)\n\t\t\t\tif(d[i] >= l) x[++lx] = c[i];\n\t\t\tfor(int i = L[br]; i <= R[br]; ++i)\n\t\t\t\tif(d[i] <= r) y[++ly] = c[i];\n\t\t\tans += merge(x, y, lx, ly);\n\t\t}\n\t\twrite(ans), putchar('\\n');\n\t}\n}\n```",
        "postTime": 1643513243,
        "uid": 257146,
        "name": "orz_z",
        "ccfLevel": 0,
        "title": "P5046 Yuno loves sqrt technology I"
    },
    {
        "content": "\u9996\u5148\u770b\u89c1~~\u6807\u9898\u548c\u51fa\u9898\u4eba\u5f88\u81ea\u7136\u7684\u60f3\u5230\u5206\u5757\u3002~~\n\n\u9006\u5e8f\u5bf9\u65e0\u975e\u5c31\u662f\u6c42\u4e94\u4e2a\u8d21\u732e\uff1a**\u6563\u5757\u5185\uff0c\u6563\u5757\u5bf9\u6563\u5757\uff0c\u6574\u5757\u5185\uff0c\u6574\u5757\u5bf9\u6574\u5757\uff0c\u6563\u5757\u5bf9\u6574\u5757**\u3002\n\n\u9996\u5148\u662f**\u6563\u5757\u5185**\uff0c\u8fd9\u4e1c\u897f\u53ef\u4ee5\u9884\u5904\u7406\u4e24\u4e2a\u6570\u7ec4\uff1a\u4e00\u4e2a\u7ef4\u62a4\u5230\u5757\u5de6\u7aef\u70b9\u7684\u9006\u5e8f\u5bf9\uff0c\u4e00\u4e2a\u7ef4\u62a4\u5230\u5757\u53f3\u7aef\u70b9\u7684\u9006\u5e8f\u5bf9\uff0c$O(n\\sqrt n)$ \u76f4\u63a5\u66b4\u529b\u3002\n\n\u7136\u540e\u662f**\u6563\u5757\u5bf9\u6563\u5757**\uff0c\u8fd9\u662f\u4e24\u5768\u533a\u95f4\u7684\u9006\u5e8f\u5bf9\uff0c\u60f3\u60f3\u5f52\u5e76\u6392\u5e8f\u7684\u505a\u6cd5\uff0c\u5957\u8fc7\u6765\u5c31\u884c\u4e86\uff1a\u5148\u5bf9\u5757\u5185\u6392\u5e8f\uff0c\u7136\u540e\u67e5\u8be2\u65f6\u5728\u6709\u5e8f\u6570\u7ec4\u91cc\u627e\u5230\u5728\u6307\u5b9a\u533a\u95f4\u7684\u6570\uff0c\u8df3\u4e2a\u53cc\u6307\u9488\u5c31 over \u4e86\u3002\n\n\u7b2c\u4e09\u4e2a\u5c31\u662f**\u6574\u5757\u5185**\u7684\u8d21\u732e\uff0c\u53c2\u89c1\u4e0a\u4e0a\u4e2a\u70b9\uff0c\u5728\u641e\u6563\u5757\u65f6\u6302\u5230\u7aef\u70b9\u5904\u5373\u53ef\u3002\n\n\u7b2c\u56db\u4e2a\u662f**\u6574\u5757\u5bf9\u6574\u5757**\uff0c\u8fd9\u4e1c\u897f\u521a\u5f00\u59cb\u60f3\u6574\u4e00\u4e2a $f_{i,j}$ \u8868\u793a\u7b2c $i$ \u5230\u7b2c $j-1$ \u4e2a\u5757\u5bf9\u7b2c $j$ \u4e2a\u5757\u7684\u8d21\u732e\uff0c\u8fd9\u4e1c\u897f\u5728\u679a\u4e3e\u4e86 $i$ \u540e\u8981 $O(1)$ \u63a8\uff0c\u9898\u89e3\u91cc\u7684\u9884\u5904\u7406\u524d $i$ \u4e2a\u5757\u91cc\u5c0f\u4e8e $j$ \u7684\u6570 $cnt_{i,j}$\u7136\u540e\u63a8\u7684\u505a\u6cd5\u597d\u50cf\u5e38\u6570\u53c8\u5927\u4e86\uff0c\u6240\u4ee5\u8003\u8651\u5c06\u6574\u5757\u5bf9\u6574\u5757\u548c\u6574\u5757\u5185\u5408\u5e76\u4e3a\u4e00\u4e2a\u6570\u7ec4 $g_{i,j}$ \u8868\u793a\u7b2c $i$ \u5757\u5230\u7b2c $j$ \u5757\u7684\u8d21\u732e\uff0c\u7b2c\u4e00\u4e2a\u60f3\u6cd5\u662f\u7ed3\u5408\u4e0a\u9762\u7684 $cnt_{i,j}$ \u63a8\uff0c\u4f46\u662f\u5e38\u6570\u5de8\u5927\uff0c\u7136\u540e\u6211\u4eec\u53d1\u73b0\u8fd9\u4e1c\u897f\u50cf\u533a\u95f4 dp\uff0c\u4e8e\u662f\u4ea7\u751f\u4e86\u4e00\u4e2a\u5927\u80c6\u7684\u60f3\u6cd5\uff1a$g_{i,j}=g_{i+1,j}+g_{i,j-1}-g_{i+1,j-1}+h_{i,j}$ \u5176\u4e2d $h_{i,j}$ \u662f\u7b2c $i$ \u5757\u4e0e\u7b2c $j$ \u5757\u7684\u8d21\u732e\uff0c\u8fd9\u4e1c\u897f\u53ef\u4ee5\u8df3\u53cc\u6307\u9488\uff0c\u5f97\u5206\u770b\u5e38\u6570\u3002\n\n\u6700\u540e\u662f**\u6563\u5757\u5bf9\u6574\u5757**\uff0c\u6700\u7b80\u5355\u7684\u60f3\u6cd5\u5c31\u662f\u7528 $cnt_{i,j}$ \u679a\u4e3e\u4e00\u904d\u6563\u5757\uff0c\u4f46\u8fd9\u6837\u5e38\u6570\u5927\u4e86\uff08~~\u591c\u6df1\u4eba\u9759\u7684\u65f6\u5019\u5361\u5361\u5e38\u4e5f\u8bb8\u80fd\u8fc7~~\uff09\u3002\n\n\u8003\u8651\u4e00\u4e2a\u524d\u7f00\u548c\uff1a$p_{i,j}$ \u8868\u793a\u524d $i$ \u4e2a\u5757\u5bf9\u53f3\u7aef\u70b9\u4e3a $j$ \u7684\u6563\u5757\u7684\u8d21\u732e\u3002\u9884\u5904\u7406\u65f6\u4ece\u5de6\u5230\u53f3\u679a\u4e3e $i$ \u7136\u540e\u8fd8\u662f\u9700\u8981 $O(1)$ \u63a8\uff0c\u4f46\u8fd9\u91cc\u7684\u63d2\u5165\u662f $O(n)$ \u7684\uff0c\u4f46\u8be2\u95ee\u662f $O(n\\sqrt n)$\uff0c\u7528\u4e0a\u9762\u7684 $cnt_{i,j}$ \u663e\u7136\u53ef\u4ee5\uff0c\u4f46\u662f\u7ef4\u62a4\u4e00\u4e2a\u503c\u57df\u5206\u5757\u663e\u7136\u66f4\u597d\uff0c\u80fd\u5c11\u70b9\u7a7a\u95f4\uff0c\u8fd9\u6837\u76f4\u63a5\u67e5\u8be2\u5c31\u884c\u4e86\u3002\n\n\u7136\u540e\u5c31\u53d1\u73b0 $T$ \u98de\u4e86\u3002\u4e3b\u8981\u5e38\u6570\u5728\u6574\u5757\u5bf9\u6574\u5757\uff1a\u5982\u679c\u8df3\u53cc\u6307\u9488\uff0c\u90a3\u5e38\u6570\u5c31\u7a33\u7a33\u5730 $+2$\uff0c\u4f46\u662f\u5982\u679c\u9884\u5904\u7406\u4e2a $cnt_{i,j}$\uff0c\u5e38\u6570\u4e5f\u4e0d\u5c0f\uff08\u597d\u50cf\u4e5f\u662f $2$\uff09\uff0c\u518d\u60f3\u60f3\uff1a$p_{i,j}$ \u7684\u9884\u5904\u7406\u597d\u50cf\u548c\u679a\u4e3e\u6563\u5757\u518d\u7528 $cnt_{i,j}$ \u672c\u8d28\u76f8\u540c\u800c\u4e14\u6839\u53f7\u5e73\u8861\u540e\u53c8\u662f $2$ \u7684\u5e38\u6570\uff0c\u6240\u4ee5\u5f97\u5206\u53ea\u6709\u9760\u8bc4\u6d4b\u59ec\u7684\u7e41\u5fd9\u7a0b\u5ea6\u51b3\u5b9a\u3002\u6211\u4eec\u60f3\u60f3 $cnt_{i,j}$ \u548c $p_{i,j}$ \u7684\u5171\u540c\u70b9\uff1a\u90fd\u662f\u4ee5\u5757\u505a\u524d\u7f00\uff08\u867d\u7136\u5728\u5b9e\u73b0 $cnt_{i,j}$ \u65f6\u4e5f\u5728\u503c\u57df\u4e0a\u505a\u4e86\u4e00\u904d\u524d\u7f00\u5408\uff09\u3002\u800c\u4ee5\u5757\u505a\u524d\u7f00\u518d\u4e58\u4e0a $O(n)$ \u548c\u4ee5\u503c\u57df\u6216\u5e8f\u5217\u505a\u524d\u7f00\u518d\u4e58\u4e0a\u4e00\u4e2a $O(\\sqrt n)$ \u662f\u4e00\u6837\u7684\u65f6\u7a7a\uff0c\u6240\u4ee5\u60f3\u60f3\u540e\u8005\u4e5f\u8bb8\u5e38\u6570\u66f4\u4f18\u3002\u6211\u4eec\u6574\u4e00\u4e2a $q_{i,j}$ \u8868\u793a\u7b2c $i$ \u4e2a\u5757\u5bf9\u5e8f\u5217\u91cc\u524d $j$ \u4e2a\u5143\u7d20\u7684\u9006\u5e8f\u5bf9\uff0c\u4e0d\u5305\u62ec\u5757\u5185\u7684\u5143\u7d20\uff0c\u5728\u9884\u5904\u7406 $g_{i,j}$ \u65f6\u8df3\u53cc\u6307\u9488\u5c31\u6ca1\u6709\u5fc5\u8981\u4e86\u3002\u867d\u7136\u5728\u67e5\u8be2\u65f6\u679a\u4e3e\u6bcf\u4e2a\u5757\u8fd8\u662f $O(m\\sqrt n)$ \u4f46\u662f\u6bd4\u7528 $cnt_{i,j}$ \u5c11\u4e86\u4e2a $1$ \u7684\u5e38\u6570\uff0c\u5bf9\u7a0b\u5e8f\u7684\u4ef7\u503c\u8fd8\u6bd4 $p_{i,j}$ \u5927\uff08\u5b83\u628a\u4e00\u4e2a $O(n\\sqrt n)$ \u4f18\u5316\u6210\u4e86 $O(n)$\uff09\uff0c\u6240\u4ee5\u80af\u5b9a\u7528 $q_{i,j}$ \u6570\u7ec4\u3002\n\n\u7136\u540e\u5c31\u662f\u9884\u5904\u7406 $q_{i,j}$\uff0c\u6211\u4eec\u679a\u4e3e\u7b2c $i$ \u4e2a\u5757\uff0c\u7136\u540e\u5c06\u6574\u4e2a\u5e8f\u5217\u4ece\u5c0f\u5230\u5927\u63d2\u5165\uff0c\u5757\u5185\u7684\u5143\u7d20\u4e5f\u9700\u8981\u6709\u5e8f\uff0c\u5c31\u76f8\u5f53\u4e8e\u8df3\u53cc\u6307\u9488\uff0c\u5982\u679c\u5e8f\u5217\u91cc\u679a\u4e3e\u5230\u7684\u5143\u7d20\u5728\u7b2c $i$ \u5757\u5185\uff0c\u5219\u8df3\u8fc7\u5b83\uff1b\u5982\u679c\u5728\u5757\u53f3\u8fb9\uff0c\u5c31\u52a0\u4e0a\u5757\u5185\u679a\u4e3e\u5230\u7684\u5143\u7d20\u5230\u5757\u53f3\u7aef\u70b9\u7684\u5143\u7d20\u4e2a\u6570\uff08\u56e0\u4e3a\u5757\u5185\u662f\u6709\u5e8f\u7684\uff09\uff1b\u5176\u4ed6\u60c5\u51b5\u540c\u7406\u3002\n\n\u7efc\u4e0a\u6240\u8ff0\uff0c\u8fd9\u9898\u7684\u7406\u8bba\u505a\u6cd5\u6709\u4e86\uff0c\u5b9e\u73b0\u65b9\u6cd5\u6709\u4e86\uff0c\u4f46\u662f\u5f97\u5206\u8fd8\u662f\u770b\u5e38\u6570 qwq\uff0c\u5927\u529b\u63a8\u8350\u5728\u591c\u6df1\u4eba\u9759\u7684\u65f6\u5019\u4ea4\u3002\n\n\u5c31\u4e0d\u7ed9\u4ee3\u7801\u4e86 qwq\u3002",
        "postTime": 1643350945,
        "uid": 383791,
        "name": "Others",
        "ccfLevel": 7,
        "title": "P5046 \u9898\u89e3"
    },
    {
        "content": "**\u518d\u6b64\u58f0\u660e\uff0c\u7531\u4e8e\u672c\u4eba\u5361\u5e38\u6280\u827a\u4e0d\u591f\u7cbe\u6e5b\uff0c\u672c\u9898\u89e3\u590d\u6742\u5ea6\u6b63\u786e\u4f46\u4ee3\u7801\u65e0\u6cd5\u901a\u8fc7\uff0c\u4ec5\u4f9b\u53c2\u8003**\n\n\u5206\u5757\uff0c $O(n\\sqrt{n})$\n## \u9006\u5e8f\u5bf9\n### 1.\u540c\u5757\u67e5\u8be2\n\u540c\u5757\u67e5\u8be2\u53ea\u6709 $n\\sqrt{n}$ \u4e2a\uff0c\u53ef\u4ee5\u9884\u5904\u7406\u3002\n\n\u9884\u5904\u7406\uff1a\n\n\u5bf9\u4e8e\u4e00\u4e2a\u9006\u5e8f\u5bf9\uff0c\u8bbe\u6b64\u4e8c\u5143\u7ec4\u4e3a $(l_1,r_1)$ \u5b83\u4ea7\u751f\u7684\u8d21\u732e\u4e3a\u6240\u6709$\\{(l_2,r_2)|l_2<=l1,r2>=r1\\}$\uff0c\u6211\u4eec\u5bb9\u6613\u60f3\u5230\u4e8c\u7ef4\u524d\u7f00\u548c\uff0c\u628a\u6bcf\u4e2a\u5757\u91cc\u7684 l \u53cd\u8fc7\u6765\uff0c\u6bd4\u5982 1 2 3 \u6362\u62103 2 1 \uff0c\u6b64\u65f6\u8d21\u732e\u4e3a \n$\\{(l_2,r_2)|l_2>=l1,r2>=r1\\}$ \u6211\u4eec\u5c31\u53ef\u4ee5\u7528\u4e8c\u7ef4\u524d\u7f00\u548c\u8ba1\u7b97\u8d21\u732e\uff0c\u590d\u6742\u5ea6 $O(n\\sqrt{n})$\u3002\n### 2.\u5f02\u5757\u67e5\u8be2\n\u9006\u5e8f\u5bf9\u5305\u542b\u6574\u5757\u5230\u6574\u5757\u7684\u9006\u5e8f\u5bf9\uff0c\u6563\u5757\u5230\u6574\u5757\uff0c\u6574\u5757\u5230\u6563\u5757\uff0c\u6563\u5757\u5230\u6563\u5757\u56db\u79cd\u60c5\u51b5\u3002\uff08\u5230\u7684\u610f\u601d\u662f\u5de6\u53f3\u7aef\u70b9\u6240\u5728\u4f4d\u7f6e\uff09\n\n1.\u6574\u5757\u5185\n\n\u53ef\u4ee5\u9884\u5904\u7406\u3002\u6211\u4eec\u9996\u5148\u9700\u8981\u4e00\u4e2a\u4e8c\u7ef4\u524d\u7f00\u548c `cnt[i][j] ` \u8868\u793a\u7b2c `i` \u5757\uff0c\u6570\u503c\u4e3a `j` \u3002\u6211\u4eec\u5c31\u53ef\u4ee5\u6c42\u4e00\u4e2a\u6574\u5757\u533a\u95f4\u5185\u5c0f\u4e8e\u67d0\u6570\u7684\u4e2a\u6570\u3002\n\n\u8bbe `f[i][j]` \u4e3a\u7b2c `i` \u5757\u5230\u7b2c `j` \u5757\u7684\u9006\u5e8f\u5bf9\u6570\u91cf\uff0c\u53ef\u5f97\u9012\u63a8\u5f0f\u5b50\u4e3a\n\n$f[i][j]=f[i][j-1]+f[j][j]+\\sum\\limits_{k=st[j]}^{k<=ed[j]}cnt[j-1][a[k]]-cnt[i-1][a[k]]$\n\n\u5176\u542b\u4e49\u4e3a \u7b2c `i` \u5757\u5230\u7b2c `j-1` \u5757\u7684\u9006\u5e8f\u5bf9 + \u7b2cj\u5757\u5185\u7684\u9006\u5e8f\u5bf9 + \u5de6\u7aef\u70b9\u5728\u7b2c `i` \u5757\u5230\u7b2c `j-1` \u5757\uff0c\u53f3\u7aef\u70b9\u5728\u7b2c `j` \u5757\u7684\u9006\u5e8f\u5bf9\u3002\n\n\u67e5\u8be2\u590d\u6742\u5ea6\u4e3a $O(1)$\n___\n2.\u6563\u5757\u5185\n\n\u5c5e\u4e8e\u540c\u5757\u67e5\u8be2\uff0c\u5df2\u9884\u5904\u7406\uff0c\u53ef\u4ee5 $O(1)$ \u6c42\u5f97\n___\n3.\u6563\u5757\u5230\u6574\u5757\n\n\u6613\u5f97\u8d21\u732e\u4e3a\u6240\u6709\u5757\u4e2d\u5c0f\u4e8e\u6563\u5757\u7684\u5bf9\u6570\uff0c\u5373\n\n$\\sum\\limits_{i=l}^{i<=ed[bl[l]]}cnt[bl[r]-1][a[i]]-cnt[bl[l]][a[i]]$\n\n\u590d\u6742\u5ea6\u4e3a $O(\\sqrt{n})$ ,\u540e\u9762\u7ecf\u8fc7\u9884\u5904\u7406\u5361\u6210\u4e86 $O(1)$\n___\n4.\u6574\u5757\u5230\u6563\u5757\n\n\u540c\u4e0a\n___\n5.\u6563\u5757\u5230\u6563\u5757\n\n\u53ef\u4ee5\u9884\u5904\u7406\u51fa\u6bcf\u5757\u4e2d\u62cd\u5b8c\u5e8f\u7684\u7ed3\u679c\uff0c\u67e5\u8be2\u65f6\u626b\u4e00\u904d\uff0c\u5f97\u5230\u5728\u5de6\u7aef\u6563\u5757\u548c\u53f3\u7aef\u6563\u5757\u7684\u5355\u8c03\u961f\u5217\uff0c\u5c31\u53ef\u4ee5\u7528\u5e38\u89c4\u65b9\u6cd5\u6c42\u9006\u5e8f\u5bf9\u4e86\u3002\n___\n### \u5361\u5e38\n\u7531\u4e8e\u6211\u4eec\u9700\u8981\u591a\u6b21\u8c03\u7528 `cnt` \u6570\u7ec4\uff0c\u5e76\u4e14\u6bcf\u6b21\u90fd\u662f\u6c42\u5757\u4e2d\u524d\u7f00\u6216\u540e\u7f00\u5bf9\u4e8e\u67d0\u4e00\u5757\u7684\u548c\uff0c\u4e8e\u662f\u6211\u4eec\u9884\u5904\u7406\u51fa\u6bcf\u4e00\u5757\u4e2d\u5173\u4e8e\u540e\u7f00\u7684\u6bcf\u4e2a\u6570\u5173\u4e8e\u67d0\u4e2a\u5757\u4e2d\u5c0f\u4e8e\u6b64\u6570\u7684\u4e2a\u6570\uff0c\u8981\u67e5\u524d\u7f00\u5c31\u7528\u6574\u5757\u51cf\u53bb\u540e\u7f00\u3002\n\n\u7b80\u5355\u7684\u8bf4\u5c31\u662f\u4e00\u4e2a\u6570\u7ec4 `back[i][j]` \u8868\u793a\u524d `j` \u5757\u4e2d\u5c0f\u4e8e\u7b2c `i` \u4e2a\u6570\u5728\u5757\u4e2d\u7684\u540e\u7f00\u4e2d\u7684\u6bcf\u4e2a\u6570\u7684\u4e2a\u6570\uff0c\u5373\n\n$back[i][j]=\\sum\\limits_{k=i}^{k<=ed[bl[i]]}cnt[j][a[k]]=back[i+1][j]+cnt[j][a[i]]$\n\n\u4ee3\u7801\uff1a\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define N 100010\n#define siz 200\nint n,m,a[N],ord[N],st[N/siz+10],ed[N/siz+10],bl[N],cnt2,cnt[N/siz+10][N],q1[N/siz+10],q2[N/siz+10],back[N][N/siz+10],in[N][siz+10],len1,len2;\nlong long f[N/siz+10][N/siz+10],last,x,y;\n//f[i][j]:\u7b2ci\u5757\u5230\u7b2cj\u5757\u7684\u9006\u5e8f\u5bf9\u6570\n//cnt[i][j]:\u8ba1\u6570\u6570\u7ec4,i:\u7b2ci\u5757\uff0c\u4e8c\u7ef4\u524d\u7f00\u548c\n//in[i][j]:\u9884\u5904\u7406\u540c\u5757\u7b54\u6848\uff0ci:\u7b2cst[bl[i]]+ed[bl[i]]-i\u4e2a\u6570,j:\u5757\u4ece\u5934\u7b2cj\u4e2a\u6570\n//ord[i]:\u6bcf\u5757\u5185\u6392\u5e8f\ninline int read()\n{\n\tchar ch=getchar();\n\tint r=0,w=1;\n\twhile(ch<'0'||ch>'9') w=ch=='-'?-1:w,ch=getchar();\n\twhile(ch>='0'&&ch<='9') r=r*10+ch-'0',ch=getchar();\n\treturn r*w;\n}\nvoid write(long long x)\n{\n\tif(x>9)\n\twrite(x/10);\n\tputchar('0'+x%10);\n}\ninline bool cmp(int x,int y)\n{\n\treturn a[x]<a[y];\n}\ninline void build()\n{\n\tint len=200;\n\tfor(int i=1;i<=n;i+=len)\n\tst[++cnt2]=i,ed[cnt2]=min(i+len-1,n);\n\tfor(int i=1;i<=cnt2;i++)\n\t{\n\t\tfor(register int j=st[i];j<=ed[i];j++)\n\t\tbl[j]=i,ord[j]=j,cnt[i][a[j]]++;\n\t\tfor(register int j=st[i];j<=ed[i];j++)\n\t\tfor(register int k=j+1;k<=ed[i];k++)\n\t\tif(a[j]>a[k])\n\t\tin[st[i]+ed[i]-j][k-st[i]+1]++;\n\t\tfor(register int j=st[i]+1;j<=ed[i];j++)\n\t\tfor(register int k=st[i]+1;k<=ed[i];k++)\n\t\tin[j][k-st[i]+1]+=in[j-1][k-st[i]+1]+in[j][k-st[i]]-in[j-1][k-st[i]];//\u4e8c\u7ef4\u524d\u7f00\u548c\u7b97\u8d21\u732e\uff1a\u6240\u6709\u5de6\u7aef\u70b9>=j\u4e14\u53f3\u7aef\u70b9<=k\u7684\u9006\u5e8f\u5bf9 \n\t\tf[i][i]=in[ed[i]][ed[i]-st[i]+1];\n\t\tsort(ord+st[i],ord+ed[i]+1,cmp);\n\t}\n\tfor(register int i=1;i<=cnt2;i++)\n\tfor(register int j=1;j<=n;j++)\n\tcnt[i][j]+=cnt[i-1][j]+cnt[i][j-1]-cnt[i-1][j-1];//\u4e8c\u7ef4\u524d\u7f00\u548c\n\tfor(register int i=1;i<=cnt2;i++)\n\tfor(register int j=1;j<=cnt2;j++)\n\t{\n\t\tback[ed[i]][j]=cnt[j][a[ed[i]]];\n\t\tfor(register int k=ed[i]-1;k>=st[i];k--)\n\t\tback[k][j]=back[k+1][j]+cnt[j][a[k]];\n\t}\n\tfor(register int i=1;i<=cnt2;i++)\n\tfor(register int j=i+1;j<=cnt2;j++)\n\tf[i][j]=f[i][j-1]+f[j][j]+(ed[j-1]-st[i]+1)*(ed[j]-st[j]+1)-back[st[j]][j-1]+back[st[j]][i-1];//\u7b2ci\u5230j-1\u5757\u9006\u5e8f\u5bf9+\u7b2cj\u5757\u5185\u9006\u5e8f\u5bf9+\u5de6\u7aef\u70b9\u5728\u7b2ci\u5230j-1\u5757\uff0c\u53f3\u7aef\u70b9\u5728\u7b2cj\u5757\u7684\u9006\u5e8f\u5bf9+\u5de6\u7aef\u70b9\u5728\u7b2ci\u5230j-1\u5757\uff0c\u53f3\u7aef\u70b9\u5728\u7b2cj\u5757 \n}\ninline long long ask(int x,int y)\n{\n\tif(bl[x]==bl[y])\n\treturn in[st[bl[x]]+ed[bl[x]]-x][y-st[bl[y]]+1];\n\tlong long ans=in[st[bl[x]]+ed[bl[x]]-x][ed[bl[x]]-st[bl[x]]+1]+in[ed[bl[y]]][y-st[bl[y]]+1]+f[bl[x]+1][bl[y]-1];//\u6563\u5757\u5185+\u6574\u5757\u5230\u6574\u5757\n\tans+=back[x][bl[y]-1]-back[x][bl[x]];\n\tif(y<ed[bl[y]])\n\tans+=(y-st[bl[y]]+1)*(ed[bl[y]-1]-st[bl[x]+1]+1)-(back[st[bl[y]]][bl[y]-1]-back[y+1][bl[y]-1])+(back[st[bl[y]]][bl[x]]-back[y+1][bl[x]]);//\u6563\u5757\u5230\u6574\u5757+\u6574\u5757\u5230\u6563\u5757\n\telse\n\tans+=(y-st[bl[y]]+1)*(ed[bl[y]-1]-st[bl[x]+1]+1)-back[st[bl[y]]][bl[y]-1]+back[st[bl[y]]][bl[x]];\n\tlen1=len2=0;//\u6563\u5757\u5230\u6563\u5757 \n\tfor(register int i=st[bl[x]];i<=ed[bl[x]];i++)\n\tif(ord[i]>=x)\n\tq1[++len1]=a[ord[i]];\n\tfor(register int i=st[bl[y]];i<=ed[bl[y]];i++)\n\tif(ord[i]<=y)\n\tq2[++len2]=a[ord[i]];\n\tint top1=1,top2=1;\n\twhile(top1<=len1&&top2<=len2)\n\t{\n\t\tif(q1[top1]>q2[top2])\n\t\tans+=len1-top1+1,top2++;\n\t\telse\n\t\ttop1++;\n\t}\n\treturn ans;\n}\nint main()\n{\n\tn=read(),m=read();\n\tfor(register int i=1;i<=n;i++)\n\ta[i]=read();\n\tbuild();\n \tfor(register int i=1;i<=m;i++)\n \t{\n \t\tx=read()^last,y=read()^last;\n \t\twrite(last=ask(x,y)),putchar('\\n');\n \t}\n}\n```",
        "postTime": 1632477021,
        "uid": 363350,
        "name": "hxdts",
        "ccfLevel": 6,
        "title": "P5046 [Ynoi2019 \u6a21\u62df\u8d5b] Yuno loves sqrt technology I \u9898\u89e3"
    },
    {
        "content": "\u63d0\u4f9b\u4e00\u79cd\u7406\u8bba\u590d\u6742\u5ea6\u6b63\u786e($O(n\\sqrt n)$)\u7684\u505a\u6cd5\n\n\u6211\u4eec\u7ef4\u62a4\u4ee5\u4e0b\u51e0\u4e2a\u4e1c\u897f:\n\n`pre[i]`\uff1a$i$\u5230\u5b83\u7684\u5757\u9996\u8fd9\u6bb5\u5e8f\u5217\u7684\u9006\u5e8f\u5bf9\u6570\u91cf\n\n`suf[i]`\uff1a$i$\u5230\u5b83\u7684\u5757\u5c3e\u8fd9\u6bb5\u5e8f\u5217\u7684\u9006\u5e8f\u5bf9\u6570\u91cf\n\n`cnt[i][j]`\uff1a\u524d$i$\u4e2a\u5757\u4e2d\u5c0f\u4e8e$j$\u7684\u6570\u7684\u4e2a\u6570\n\n`f[i][j]`\uff1a\u7b2c$i$\u4e2a\u5757\u5230\u7b2c$j$\u5757\u7684\u9006\u5e8f\u5bf9\u4e2a\u6570\n\n`v[i]` \u7b2c$i$\u4e2a\u5757\u4e2d\u6570\u4ece\u5c0f\u5230\u5927\u6392\u5e8f\u7684\u7ed3\u679c\n\n`pre`\u548c`suf`\u53ef\u4ee5\u7528\u6811\u72b6\u6570\u7ec4\u5728$O(n \\log n)$\u65f6\u95f4\u5185\u6c42\u51fa\n\n`cnt`\u53ef\u4ee5\u7528\u4e24\u6b21\u524d\u7f00\u548c\u5728$O(n \\sqrt n)$\u65f6\u95f4\u5185\u6c42\u51fa\n\n`f`\u53ef\u4ee5\u7528\u4ee5\u4e0b\u65b9\u6cd5\u6c42\u51fa:\n$f_{i,j}=f_{i+1,j}+f_{i,j+1}-f_{i+1,j-1}+(i,j)$\u8fd9\u4e24\u5757\u4e4b\u95f4\u4ea7\u751f\u7684\u8d21\u732e\n\n\u7531\u4e8e\u6211\u4eec\u5df2\u7ecf\u7ef4\u62a4\u597d\u4e86`v`\uff0c\u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u7528\u5f52\u5e76\u6392\u5e8f\u5728$O(\\sqrt n)$\u65f6\u95f4\u5185\u6c42\u51fa$(i,j)$\u8fd9\u4e24\u5757\u4e4b\u95f4\u4ea7\u751f\u7684\u8d21\u732e,\u603b\u590d\u6742\u5ea6$O(n \\sqrt n)$\n\n\uff08\u4e0b\u9762\u7528$[l,r] \\times [L,R]$\u8868\u793a$[l,r]$\u4e0e$[L,R]$\u4ea7\u751f\u7684\u8d21\u732e\uff09\n\n\u63a5\u4e0b\u6765\u6211\u4eec\u8003\u8651\u8be2\u95ee\uff0c\u8bbe\u8be2\u95ee\u533a\u95f4\u4e3a$[l,r]$\uff0c\u6211\u4eec\u5206\u4e09\u79cd\u60c5\u51b5\u8003\u8651\uff1a\n\n1.$[l,r]$\u5728\u4e00\u4e2a\u5757\u5185\n\n\u8bbe$R$\u8868\u793a$l,r$\u5757\u7684\u5757\u5c3e\n\n\u7531\u4e8e\u6211\u4eec\u5df2\u7ecf\u7ef4\u62a4\u597d\u4e86`pre`\uff0c\u4e8e\u662f\u7b54\u6848\u53ef\u4ee5\u8868\u793a\u6210$pre[l]-pre[r+1]-[l,r] \\times [r+1,R]$\n\n2.$[l,r]$\u5728\u76f8\u90bb\u4e24\u4e2a\u5757\u5185\n\n\u8bbe$R$\u8868\u793a$l$\u5757\u7684\u5757\u5c3e,$L$\u8868\u793a$r$\u5757\u7684\u5757\u9996\n\n\u90a3\u4e48\u7b54\u6848\u53ef\u4ee5\u8868\u793a\u6210$pre[l] + suf[r] + [l,R] \\times [L, r]$\n\n3.$[l,r]$\u6a2a\u8de8\u81f3\u5c11$3$\u4e2a\u5757\n\n\u8bbe$R$\u8868\u793a$l$\u5757\u7684\u5757\u5c3e,$L$\u8868\u793a$r$\u5757\u7684\u5757\u9996\n\n\u90a3\u4e48[l,r]\u7684\u8d21\u732e\u53ef\u4ee5\u62c6\u5206\u6210$[l,R],[R+1,L-1],[L,r]$\u4e09\u4e2a\u5757\u4e24\u4e24\u4e4b\u95f4\u7684\u8d21\u732e\uff0c\u7531\u4e8e$[R+1,L-1]$\u662f\u6574\u5757\uff0c\u4e8e\u662f\u6211\u4eec\u7684\u8d21\u732e\u5c31\u975e\u5e38\u597d\u6c42\uff0c\u5b83\u7b49\u4e8e\n\n$$\npre[l]+suf[r]+f[id(R+1)][id(L-1)]+[l,R]\\times[R+1,L-1]+[R+1,L-1]\\times[L,r]+[l,R]\\times[L,r]\n$$\n\n\u5176\u4e2d$id(i)$\u8868\u793a$i$\u6240\u5c5e\u7684\u5757\u7f16\u53f7\n\n\u4e8e\u662f\u4e3b\u4f53\u90e8\u5206\u5c31\u5199\u5b8c\u4e86\uff0c\u6709\u6ca1\u4eba\u6559\u6559\u600e\u4e48\u5361\u5e38\u554a/kel\n\n``` cpp\n#include <bits/stdc++.h>\n#include<sys/mman.h>\n\n#define ll long long\n#define pair std::pair<int, int>\n#define mp(i, j) std::make_pair(i, j)\n#define getl(i) ((i - 1) * siz + 1)\n#define getr(i) (std::min(n, i * siz))\n#define id(x) (((x - 1) / siz) + 1)\n#define meow(cat...) fprintf(stderr, cat)\n\nconst int MaxB = 7e2 + 10;\nconst int MaxN = 1e5 + 10;\n\npair v[MaxB][MaxB];\nll ans, f[MaxB][MaxB];\nint len[MaxB], pre[MaxN], cnt[MaxB][MaxN], suf[MaxN];\nint n, m, siz, num, a[MaxN], Id[MaxN], bl[MaxN], br[MaxN];\n\nstruct BIT\n{\n    int c[MaxN];\n    int lowbit(int x)\n    {\n        return x & (-x);\n    }\n    void add(int x, int val)\n    {\n        while (x <= n)\n            c[x] += val, x += lowbit(x);\n    }\n    int query(int x)\n    {\n        int ret = 0;\n        while (x)\n            ret += c[x], x -= lowbit(x);\n        return ret;\n    }\n} T;\n\nconst int size = 1 << 22;\nchar out[size], *p3 = out - 1;\n#define pc(x) *++p3=x\nvoid print(ll x)\n{\n    if(x > 9)print(x / 10);\n    pc(x % 10 + 48);\n}\n\nchar *s;\ninline int read()\n{\n    register int u = 0;\n    while(*s < 48) s++;\n    while(*s > 32)\n        u = u * 10 + *s++ -48;\n    return u;\n}\n\nint ta[MaxB], tb[MaxB];\n\nll query(int l1, int r1, int l2, int r2)\n{\n    int lena = 0, lenb = 0;\n    int L = Id[l1], R = Id[l2];\n    for (int i = 1; i <= len[L]; i++)\n    {\n        pair x = v[L][i];\n        if (x.second >= l1 && x.second <= r1)\n            ta[++lena] = x.first;\n    }\n    for (int i = 1; i <= len[R]; i++)\n    {\n        pair x = v[R][i];\n        if (x.second >= l2 && x.second <= r2)\n            tb[++lenb] = x.first;\n    }\n    ll ans = 0;\n    int A = 1, B = 1;\n    while (A <= lena && B <= lenb)\n    {\n        if (A <= lena)\n        {\n            if (ta[A] < tb[B] || B > lenb)\n                ++A;\n            else\n                ++B, ans += lena - A + 1;\n        }\n        else\n            ++B;\n    }\n    return ans;\n};\n\nsigned main()\n{\n    // freopen(\"sqrt.in\", \"r\", stdin);\n    // freopen(\"sqrt.out\", \"w\", stdout);\n    s = (char*)mmap(0, 900 << 20, PROT_READ, MAP_PRIVATE, fileno(stdin), 0);\n    n = read(), m = read();\n    siz = 160, num = id(n);\n    for (int i = 1; i <= n; i++)\n        a[i] = read(), Id[i] = id(i);\n    for (int i = 1; i <= num; i++)\n    {\n        bl[i] = getl(i), br[i] = getr(i);\n        len[i] = br[i] - bl[i] + 1;\n    }\n    for (int i = 1; i <= n; i++)\n        v[Id[i]][i - bl[Id[i]] + 1] = mp(a[i], i);\n    for (int i = 1; i <= num; i++)\n        std::sort(v[i] + 1, v[i] + len[i] + 1);\n    for (int i = 1; i <= num; i++)\n    {\n        int l = bl[i], r = br[i];\n        for (int j = l; j <= r; ++j)\n            cnt[i][a[j]]++;\n        for (int j = 1; j <= n; ++j)\n            cnt[i][j] += cnt[i - 1][j];\n    }\n    for (int i = 1; i <= num; i++)\n        for (int j = 1; j <= n; ++j)\n            cnt[i][j] += cnt[i][j - 1];\n    for (int i = 1; i <= num; i++)\n    {\n        int l = bl[i], r = br[i], x = 0, y;\n        for (int j = l; j <= r; ++j)\n        {\n            y = T.query(n) - T.query(a[j]);\n            x += y, pre[j] = x, T.add(a[j], 1);\n        }\n        f[i][i] = x;\n        for (int j = l; j <= r; ++j)\n        {\n            y = T.query(a[j] - 1), suf[j] = x;\n            x -= y, T.add(a[j], -1);\n        }\n    }\n    // for(ll i = 1; i <= n; i++)\n    //     meow(\"%d %d %d\\n\", i, pre[i], suf[i]);\n    for (int len = 1; len < num; len++)\n    {\n        int x = num - len + 1;\n        for (int i = 1; i <= x; i++)\n        {\n            int j = i + len;\n            f[i][j] = f[i + 1][j] + f[i][j - 1];\n            if (i + 1 <= j - 1) f[i][j] -= f[i + 1][j - 1];\n            f[i][j] += query(bl[i], br[i], bl[j], br[j]);\n        }\n    }\n    // meow(\"xzakioi!\\n\");\n    for (int i = 1; i <= m; i++)\n    {\n        ll now = 0;\n        int l = read() ^ ans, r = read() ^ ans;\n        int L = Id[l], R = Id[r], Ll, rr, LL, RR;\n        if (L == R)\n        {\n            rr = br[R];\n            if (r == rr)\n                now = suf[l];\n            else\n            {\n                now = suf[l] - suf[r + 1];\n                now -= query(l, r, r + 1, rr);\n            }\n        }\n        else if (R == L + 1)\n        {\n            Ll = bl[R], rr = br[L];\n            now = suf[l] + pre[r];\n            now += query(l, rr, Ll, r);\n        }\n        else\n        {\n\n            LL = bl[R], RR = br[L], rr = br[R - 1];\n            now = suf[l] + f[L + 1][R - 1];\n            now += query(l, RR, LL, r) + pre[r];\n            for (int i = l; i <= RR; i++)\n                now += cnt[R - 1][a[i]] - cnt[L][a[i]];\n            for (int i = LL; i <= r; i++)\n            {\n                now += cnt[R - 1][n] - cnt[R - 1][a[i]];\n                now -= cnt[L][n] - cnt[L][a[i]];\n            }\n        }\n        ans = now, print(ans), pc('\\n');\n    }\n    meow(\"used %d ms\\n\", clock());\n    fwrite(out, 1, p3 - out + 1, stdout);\n    return 0;\n}\n```",
        "postTime": 1610611902,
        "uid": 61966,
        "name": "little_sun",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P5046 \u3010[Ynoi2019 \u6a21\u62df\u8d5b] Yuno loves sqrt technology I\u3011"
    },
    {
        "content": "## \u9898\u610f\u7b80\u8ff0\n\n\u65e0\u4fee\u6539\u533a\u95f4\u6c42\u9006\u5e8f\u5bf9\u3002\n\n## \u9898\u89e3\n\n\u9996\u5148\u6709\u4e00\u4e2a\u663e\u7136\u7684 $\\Theta(N\\sqrt{N}\\log_{2}N)$ \u505a\u6cd5\uff0c\u7531\u4e8e\u8fc7\u4e0d\u4e86\u6240\u4ee5\u6211\u5c31\u4e0d\u5e9f\u8bdd\u3002\n\n\u5176\u5b9e\u6709\u4e86 $\\Theta(N\\sqrt{N}\\log_{2}N)$ \u7684\u8fc7\u4e0d\u53bb\u505a\u6cd5\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u6839\u636e\u8fd9\u4e2a\u601d\u8def\u7136\u540e\u9884\u5904\u7406\u89e3\u51b3\u95ee\u9898\u3002\n\n\u6211\u4eec\u9700\u8981\u5904\u7406\u7684\u4fe1\u606f\u6709\uff1a\n\n1. \u6563\u5757\u7684\u9006\u5e8f\u5bf9\u6570\u91cf\n\n2. \u4ee5\u5757\u4e3a\u5355\u4f4d\u7684\u533a\u95f4\u9006\u5e8f\u5bf9\u6570\u91cf\n\n\u90a3\u4e48\u6211\u4eec\u9700\u8981\u5904\u7406\u7684\u6570\u7ec4\u5c31\u6709\u4ee5\u4e0b\u51e0\u4e2a\uff1a\n\n1. `previous[i]` \u8868\u793a $i$ \u5230 \u8be5\u5757\u5f00\u5934\u7684\u9006\u5e8f\u5bf9\u6570\u91cf\u3002\n\n2. `suffix[i]` \u540c\u7406\u3002\n\n3. `block[i][j]` \u8868\u793a\u524d $i$ \u4e2a\u5757\u4e2d $\\leq j$ \u5143\u7d20\u4e2a\u6570\u3002\n\n4. `intervals[i][j]` \u8868\u793a\u4ee5\u5757\u4e3a\u5355\u4f4d\u7684\u533a\u95f4 $[i,j]$ \u4e2d\u7684\u9006\u5e8f\u5bf9\u6570\u91cf\u3002\n\n\u8bb2\u8bb2\u9884\u5904\u7406\u65b9\u6cd5\u3002\n\n1. `previous[i]` \u548c `suffix[i]` \u7684\u5904\u7406\u65b9\u6cd5\u90fd\u5f88\u663e\u7136\uff0c\u53ef\u4ee5\u4e00\u76f4\u626b\u7740\u7136\u540eFWT\u626b\u5c31\u884c\u3002\n\n2. `block[i][j]` \u53ef\u4ee5\u9012\u63a8\uff0c\u9012\u63a8\u5f0f\u4e3a `block[i][j]=block[i+1][j]+block[i][j-1]-block[i+1][j-1]+cont(i,j)`\u3002\u5176\u4e2d `cont(i,j)` \u8868\u793a\u8ba1\u7b97\u5bf9\u5e94\u5757\u7684\u9006\u5e8f\u5bf9\u6570\u3002\n\n3. `intervals[i][j]` \u6bcf\u6b21\u5faa\u73af\u5230\u5757\u7684\u5f00\u5934\u7ee7\u627f\u4e0a\u4e00\u4e2a\u5757\u7684\u8d21\u732e\u5373\u53ef\u3002\n\n\u8ba1\u7b97\u8d21\u732e\u7684\u65b9\u6cd5\u5f88\u7b80\u5355\uff0c\u5f52\u5e76\u5373\u53ef\u3002mrsrz\u8bb2\u5f97\u4e5f\u633a\u6e05\u695a\u7684\uff0c\u6211\u8fd9\u91cc\u5c31\u4e0d\u518d\u8d58\u8ff0\uff0c\u4e3b\u8981\u8bb2\u8bb2\u600e\u4e48\u5361\u5e38\u3002\n\n\u9996\u5148\u6211\u4eec\u53ef\u4ee5\u628a\u4e3b\u51fd\u6570\u91cc\u7684\u6240\u6709\u5faa\u73af\u5168\u90e8\u5c55\u5f00\uff0c\u7ecf\u8fc7\u5b9e\u8df5\u53c2\u6570\u4f208\u7684\u65f6\u5019\u8dd1\u5f97\u6bd4\u8f83\u5feb\u3002\n\n\u7136\u540e\u516b\u805a\u6c27\u5148\u52a0\u4e0a\uff0cluogu O2\u4e5f\u5f00\u7740\u3002\n\n\u518d\u5176\u6b21\u5feb\u8bfbfread\u5feb\u8f93fwrite\uff0c\u8fd9\u4e9b\u90fd\u662f\u5361\u5e38\u7684\u6807\u914d\u3002\n\n\u7136\u540e\u5c31\u628a\u80fd\u62ff\u51fa\u6765\u7684\u7ed3\u6784\u4f53\u62ff\u51fa\u6765\uff0c\u5b9e\u5728\u4e0d\u80fd\u5c31\u4e0d\u7ba1\u4e86\u3002\n\n\u7136\u540e\u53bbSTL\uff0cpair vector\u80fd\u53bb\u5c31\u53bb\u3002\n\n\u7136\u540elong long\u5f00\u5728\u6b63\u786e\u7684\u5730\u65b9\uff0c\u4e0d\u8981\u65e0\u8111replace\u3002\n\n\u51fd\u6570inline\uff0c\u5faa\u73afregister\u3002\u867d\u7136\u53ef\u80fd\u4f5c\u7528\u4e0d\u5927\u4f46\u662f\u53ef\u4ee5\u5148\u52a0\u4e0a\u3002\n\n\u7136\u540e\u8c03\u5757\u957f\uff0c\u7ecf\u8fc7\u65e0\u6570\u6b21\u5b9e\u8df5\u53d1\u73b0\u53d6150~170\u8f83\u4e3a\u4f18\u79c0\u3002\n\n\u7136\u540e\u52a0\u4e86\u8fc7\u540e\u53d1\u73b0\u5c31\u7b97rp\u518d\u597d\u4e5f\u53ea\u670960pts\u3002\n\n\u7136\u540e\u8c37\u6b4c\u641c\u7d22\u786b\u9178\u7684\u5316\u5b66\u5f0fH\u2082SO\u2084\uff0c\u7ed9\u8bc4\u6d4b\u673a\u5582\u786b\u9178\uff08idea\u6765\u81eaSyadouHayami\uff09\u3002\n\n\u7136\u540e\u672c\u6765\u4ea4\u4e865\u9875\u90fd\u8fc7\u4e0d\u4e86\uff0c\u8fd9\u4e0b\u518d\u4ea4\u4e24\u6b21\u5c31\u8fc7\u4e86\u3002\n\n```cpp\n// \u7701\u7565\u516b\u805a\u6c27\n#include <cstdio>\n#include <iostream>\n#include <algorithm>\n#include <cstring>\n\nusing namespace std;\n\nconst int Maxn = 1e5 + 5;\nconst int Maxm = 650;\nconst int each = 160;\nint n, m, blocks, Lp[Maxn], Rp[Maxn], isa[Maxn], head[Maxn], tail[Maxn], sorted[Maxn], belong[Maxn], previous[Maxn], suffix[Maxn], block[Maxm][Maxn];\nlong long intervals[Maxm][Maxn];\nstruct Holy_Pair\n{\n\tint first, second;\n\n\tbool operator < (const Holy_Pair& rhs) const\n\t{\n\t\treturn first < rhs.first;\n\t}\n} current[Maxn];\nstruct Fenwick_Tree\n{\n\tint fwt[Maxn];\n\t\n\tinline void Modify(int x, int v)\n\t{\n\t\tfor (; x + 5 <= Maxn; x += x & -x)\tfwt[x] += v;\n\t}\n\n\tinline int Query(int x)\n\t{\n\t\tint ret = 0;\n\t\tfor (; x; x ^= x & -x)\tret += fwt[x];\n\t\treturn ret;\n\t}\n} FWT;\n\n#define io_e '\\0'\n#define io_s ' '\n#define io_l '\\n'\nnamespace Fast_IO\n{\n... // \u7701\u7565\u5feb\u8bfb\n}  // namespace Fast_IO\n\nusing Fast_IO::read;\nusing Fast_IO::write;\n\ninline Holy_Pair make_pair(int first, int second)\n{\n\tHoly_Pair ret;\n\tret.first = first;\n\tret.second = second;\n\treturn ret;\n}\n\ninline int Merge_Vct(int rhs[], int shr[], int szl, int szr)\n{\n\tint itl = 1, itr = 1;\n\tint ret = 0, ctr = 1;\n\twhile (itl <= szl && itr <= szr)\n\t{\n\t\tif (rhs[itl] < shr[itr]) \t++itl, ++ctr;\n\t\telse\n\t\t{\n\t\t\tret += szl - ctr + 1;\n\t\t\t++itr;\n\t\t}\n\t}\n\treturn ret + szr - szr;\n}\n\ninline int Merge_Idx(int st1, int st2, int sz1, int sz2)\n{\n\tint ret = 0, id1 = st1 + 1, id2 = st2 + 1;\n\tsz1 += st1, sz2 += st2;\n\twhile (id1 <= sz1 && id2 <= sz2)\n\t{\n\t\tif (sorted[id1] < sorted[id2])\t\t++id1;\n\t\telse\n\t\t{\n\t\t\tret += sz1 - id1 + 1;\n\t\t\t++id2;\n\t\t}\n\t}\n\treturn ret;\n}\n\ninline void Behavior(int l, int r, long long &ans)\n{\n\tint itl = 0, itr = 0;\n\tif (belong[l] == belong[r])\n\t{\n\t\tfor (int i = head[belong[l]]; i <= tail[belong[r]]; ++i)\n\t\t{\n\t\t\tif (current[i].second >= l && current[i].second <= r)\tRp[++itr] = sorted[i];\n\t\t\telse if (current[i].second < l)\t\tLp[++itl] = sorted[i];\n\t\t}\n\t\tif (l == head[belong[l]])\tans = previous[r] - Merge_Vct(Lp, Rp, itl, itr);\n\t\telse \tans = previous[r] - previous[l - 1] - Merge_Vct(Lp, Rp, itl, itr);\n\t}\n\telse\n\t{\n\t\tans = intervals[belong[l] + 1][belong[r] - 1] + previous[r] + suffix[l];\n\t\tfor (int i = head[belong[l]]; i <= tail[belong[l]]; ++i)\n\t\t{\n\t\t\tif (current[i].second >= l)\n\t\t\t{\n\t\t\t\tLp[++itl] = sorted[i];\n\t\t\t\tans += block[belong[r] - 1][1] - block[belong[r] - 1][sorted[i]] - block[belong[l]][1] + block[belong[l]][sorted[i]];\n\t\t\t}\n\t\t}\n\t\tfor (int i = head[belong[r]]; i <= tail[belong[r]]; ++i)\n\t\t{\n\t\t\tif (current[i].second <= r)\n\t\t\t{\n\t\t\t\tRp[++itr] = sorted[i];\n\t\t\t\tans += block[belong[r] - 1][sorted[i] + 1] - block[belong[l]][sorted[i] + 1];\n\t\t\t}\n\t\t}\n\t\tans += Merge_Vct(Lp, Rp, itl, itr);\n\t}\n\twrite(io_l, ans);\n}\n\nsigned main()\n{\n\tread(n, m), blocks = (n - 1) / each + 1;\n\tif (n <= 8)\n\t{\n\t\tfor (int i = 1; i <= n; ++i)\n\t\t{\n\t\t\tread(isa[i]);\n\t\t\tcurrent[i] = make_pair(isa[i], i);\n\t\t}\n\t}\n\telse\n\t{\n\t\t#pragma unroll 8\n\t\tfor (int i = 1; i <= n; ++i)\n\t\t{\n\t\t\tread(isa[i]);\n\t\t\tcurrent[i] = make_pair(isa[i], i);\n\t\t}\n\t}\n\tif (blocks <= 8)\n\t{\n\t\tfor (int i = 1; i <= blocks; ++i)\n\t\t{\n\t\t\thead[i] = tail[i - 1] + 1;\n\t\t\ttail[i] = tail[i - 1] + each;\n\t\t\tif (i == blocks) \ttail[i] = n;\n\t\t}\n\t}\n\telse\n\t{\n\t\t#pragma unroll 8\n\t\tfor (int i = 1; i <= blocks; ++i)\n\t\t{\n\t\t\thead[i] = tail[i - 1] + 1;\n\t\t\ttail[i] = tail[i - 1] + each;\n\t\t\tif (i == blocks) \ttail[i] = n;\n\t\t}\n\t}\n\tif (blocks <= 8)\n\t{\n\t\tfor (int i = 1; i <= blocks; ++i)\n\t\t{\n\t\t\tmemcpy(block[i], block[i - 1], sizeof(block[0]));\n\t\t\tsort(current + head[i], current + 1 + tail[i]);\n\t\t\tfor (int j = head[i]; j <= tail[i]; ++j)\n\t\t\t{\n\t\t\t\t++block[i][isa[j]];\n\t\t\t\tbelong[j] = i;\n\t\t\t\tsorted[j] = current[j].first;\n\t\t\t}\n\t\t\tint satisfy = 0;\n\t\t\tfor (int j = head[i]; j <= tail[i]; ++j)\n\t\t\t{\n\t\t\t\tFWT.Modify(isa[j], 1);\n\t\t\t\tsatisfy += FWT.Query(n) - FWT.Query(isa[j]);\n\t\t\t\tprevious[j] = satisfy;\n\t\t\t}\n\t\t\tintervals[i][i] = satisfy;\n\t\t\tfor (int j = head[i]; j <= tail[i]; ++j)\n\t\t\t{\n\t\t\t\tsuffix[j] = satisfy;\n\t\t\t\tFWT.Modify(isa[j], -1);\n\t\t\t\tsatisfy -= FWT.Query(isa[j] - 1);\n\t\t\t}\n\t\t}\n\t}\n\telse\n\t{\n\t\t#pragma unroll 8\n\t\tfor (int i = 1; i <= blocks; ++i)\n\t\t{\n\t\t\tmemcpy(block[i], block[i - 1], sizeof(block[0]));\n\t\t\tsort(current + head[i], current + 1 + tail[i]);\n\t\t\tfor (int j = head[i]; j <= tail[i]; ++j)\n\t\t\t{\n\t\t\t\t++block[i][isa[j]];\n\t\t\t\tbelong[j] = i;\n\t\t\t\tsorted[j] = current[j].first;\n\t\t\t}\n\t\t\tint satisfy = 0;\n\t\t\tfor (int j = head[i]; j <= tail[i]; ++j)\n\t\t\t{\n\t\t\t\tFWT.Modify(isa[j], 1);\n\t\t\t\tsatisfy += FWT.Query(n) - FWT.Query(isa[j]);\n\t\t\t\tprevious[j] = satisfy;\n\t\t\t}\n\t\t\tintervals[i][i] = satisfy;\n\t\t\tfor (int j = head[i]; j <= tail[i]; ++j)\n\t\t\t{\n\t\t\t\tsuffix[j] = satisfy;\n\t\t\t\tFWT.Modify(isa[j], -1);\n\t\t\t\tsatisfy -= FWT.Query(isa[j] - 1);\n\t\t\t}\n\t\t}\n\t}\n\tif (blocks <= 8)\n\t{\n\t\tfor (int dis = 1; dis <= blocks; ++dis)\n\t\t{\n\t\t\tfor (int i = n - 1; i; --i)\t\tblock[dis][i] += block[dis][i + 1];\n\t\t\tfor (int l = 1, r = dis + 1; r <= blocks + 1; ++l, ++r)\n\t\t\t\tintervals[l][r] = intervals[l + 1][r] + intervals[l][r - 1] - intervals[l + 1][r - 1] +\n\t\t\t\t\t\t\t\t\tMerge_Idx(head[l] - 1, head[r] - 1, tail[l] - head[l] + 1, tail[r] - head[r] + 1);\n\t\t}\n\t}\n\telse\n\t{\n\t\t#pragma unroll 8\n\t\tfor (int dis = 1; dis <= blocks; ++dis)\n\t\t{\n\t\t\tfor (int i = n - 1; i; --i)\t\tblock[dis][i] += block[dis][i + 1];\n\t\t\tfor (int l = 1, r = dis + 1; r <= blocks + 1; ++l, ++r)\n\t\t\t\tintervals[l][r] = intervals[l + 1][r] + intervals[l][r - 1] - intervals[l + 1][r - 1] +\n\t\t\t\t\t\t\t\t\tMerge_Idx(head[l] - 1, head[r] - 1, tail[l] - head[l] + 1, tail[r] - head[r] + 1);\n\t\t}\n\t}\n\n\tif (m <= 8)\n\t{\n\t\tlong long lastans = 0;\n\t\tfor (int i = 0; i < m; ++i)\n\t\t{\n\t\t\tlong long l, r;\n\t\t\tread(l, r);\n\t\t\tl ^= lastans;\n\t\t\tr ^= lastans;\n\t\t\tBehavior(l, r, lastans);\n\t\t}\n\t}\n\telse\n\t{\n\t\tlong long lastans = 0;\n\t\t#pragma unroll 8\n\t\tfor (int i = 0; i < m; ++i)\n\t\t{\n\t\t\tlong long l, r;\n\t\t\tread(l, r);\n\t\t\tl ^= lastans;\n\t\t\tr ^= lastans;\n\t\t\tBehavior(l, r, lastans);\n\t\t}\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1595157250,
        "uid": 161849,
        "name": "cirnovsky",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 P5046 \u3010[Ynoi2019\u6a21\u62df\u8d5b]Yuno loves sqrt technology I\u3011"
    }
]