[
    {
        "content": "# \u3010\u9898\u610f\u7b80\u8ff0\u3011\n\n\u7ed9\u4f60\u4e00\u68f5\u6709 $N$ \u4e2a\u70b9\uff0c\u6839\u4e3a $E$ \u7684\u6811\uff0c\u6807\u8bb0\u6811\u4e0a\u5171 $S$ \u4e2a\u8282\u70b9\u3002\n\n\u5904\u7406 $Q$ \u7ec4\u8be2\u95ee $(I,R)$\uff1a\u5f53\u8fb9 $I$ \u88ab\u5220\u53bb\u65f6\uff0c\u5224\u65ad\u70b9 $R$ \u5c5e\u4e8e\u4ee5\u4e0b\u54ea\u4e00\u79cd\u60c5\u51b5\n\n1. \u6709\u4e00\u6761\u5230\u6839\u7684\u8def\u5f84\uff0c\u8f93\u51fa `\"escaped\"`\n\n2. \u6ca1\u6709\u5230\u6839\u7684\u8def\u5f84\uff0c\u4f46\u80fd\u5230\u8fbe\u88ab\u6807\u8bb0\u7684\u70b9\uff0c\u8f93\u51fa\u5230**\u6700\u8fd1\u7684**\u6709\u6807\u8bb0\u7684\u70b9\u7684\u8ddd\u79bb\n\n3. \u65e2\u6ca1\u6709\u5230\u6839\u7684\u8def\u5f84\uff0c\u4e5f\u6ca1\u6709\u5230\u4efb\u610f\u4e00\u4e2a\u6709\u6807\u8bb0\u7684\u70b9\u7684\u8def\u5f84\uff0c\u8f93\u51fa `\"oo\"`\n\n# \u3010\u89e3\u9898\u601d\u8def\u3011\n\n\u8bbe\u88ab\u5220\u6389\u7684\u8fb9 $I$ \u7684\u4e24\u4e2a\u8282\u70b9\u4e3a $u,v$\uff0c\u4e0d\u59a8\u8bbe $fa[v]=u$\n\n\u8fb9I\u88ab\u5220\u6389\uff0c\u5bf9\u6574\u68f5\u6811\u7684\u5f71\u54cd\u662f $v$ \u7684\u5b50\u6811\u4ece\u539f\u6765\u7684\u6811\u4e0a\u88ab\u5206\u79bb\u51fa\u6765\n\n### \u7b2c1\u95ee\n\n$R$ \u4e0e\u6839\u8fde\u901a\uff0c\u5f53\u4e14\u4ec5\u5f53 $R$ \u4e0d\u5728 $v$ \u7684\u5b50\u6811\u91cc\u3002\n\n\u5229\u7528\u5df2\u6709\u7684\u64cd\u4f5c\u6765\u8868\u8fbe\uff0c\u5c31\u662f\n\n$$LCA(v,R)\\not=v$$\n\n### \u7b2c3\u95ee\n\n$R$ \u65e2\u6ca1\u6709\u5230\u6839\u7684\u8def\u5f84\uff0c\u4e5f\u6ca1\u6709\u5230\u4efb\u610f\u4e00\u4e2a\u88ab\u6807\u8bb0\u7684\u70b9\u7684\u8def\u5f84\uff0c\u5f53\u4e14\u4ec5\u5f53 $v$ \u7684\u5b50\u6811\u91cc\u6ca1\u6709\u70b9\u88ab\u6807\u8bb0\uff0c\u4e14 $R$ \u5728 $v$ \u7684\u5b50\u6811\u91cc\n\n\u5728dfs\u5efa\u7acb\u8d77\u6709\u6839\u6811\u7ed3\u6784\u7684\u65f6\u5019\uff0c\u9884\u5904\u7406\u51fa\u6bcf\u4e2a\u70b9\u7684\u5b50\u6811\u91cc\u7684\u6807\u8bb0\u4e2a\u6570\u3002\u8bbe $v$ \u7684\u5b50\u6811\u5185\u6807\u8bb0\u4e2a\u6570\u4e3a $shop[v]$\u3002\u8fd9\u4e00\u95ee\u7684\u5224\u65ad\u5f0f\u5c31\u662f\n\n$$LCA(v,R)=v,\\text{\u4e14} shop[v]=0$$\n\n### \u7b2c2\u95ee\n\n\u6392\u9664\u7b2c1\u95ee\u548c\u7b2c3\u95ee\u4e4b\u540e\uff0c$R$ \u4e00\u5b9a\u5728 $v$ \u7684\u5b50\u6811\u5185\u3002\n\n\u8bbe\u70b9 $u$ \u5230\u5b50\u6811\u4e0a\u6700\u8fd1\u7684\u88ab\u6807\u8bb0\u7684\u8282\u70b9\u7684\u8ddd\u79bb\u4e3a $f[u]$\uff0c\u6709\n\n$$f[u]= \\begin{cases}\n0 && u\\text{\u6709\u6807\u8bb0}\\\\\n\\min\\{f[v]+weig[e]\\mid v\\in son(u)\\} && u\\text{\u65e0\u6807\u8bb0}\n\\end{cases}$$\n\n\u663e\u7136\uff0c\u79bb $R$ \u6700\u8fd1\u7684\u6709\u6807\u8bb0\u70b9\u7684\u8ddd\u79bb\uff0c\u53ea\u4f1a\u51fa\u73b0\u5728 $min\\{f[u]\\mid u\\in path(v,R)\\}$ \u91cc\n\n\u5047\u8bbe\u6211\u4eec\u8981\u6c42\u7684\u76ee\u6807\u70b9\u4e3a $x$ \u3002\u8bbe $dis[i]$ \u4e3a $i$ \u5230\u6839\u7684\u8ddd\u79bb\uff0c\u5219\n\n$$\\begin{aligned}\nAns&=dis[x]+dis[R]-2\\times dis[LCA(x,R)]\\\\\n&=(dis[x]-dis[LCA(x,R)])-dis[LCA(x,R)]+dis[R]\\\\\n&=f[lca(x,R)]-dis[lca(x,R)]+dis[R]\\\\\n&=min\\{f[i]-dis[i]\\mid i\\in path(v,R)\\}+dis[R]\n\\end{aligned}$$\n\n\u8bbe\n\n$$val[i]=f[i]-dis[i];$$\n\n\u6211\u4eec\u53ea\u9700\u8981\u9884\u5904\u7406\u51fa\u6bcf\u4e2a\u8282\u70b9 $i$ \u7684 $val[i]$\uff0c\u5e76\u4e14\u6811\u94fe\u5256\u5206\u7ef4\u62a4\u6700\u5c0f\u503c\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u8be2\u95ee\uff0c\u67e5\u8be2\n\n$$min\\{val[i]\\mid i\\in path(v,R)\\}$$\n\n\u5c31\u53ef\u4ee5\u5f97\u5230\u7b54\u6848\n\n$$min\\{val[i]\\mid i\\in path(v,R)\\}+dis[R]$$\n\n# \u3010\u4ee3\u7801\u3011\n\n```cpp\n#include <iostream>\n#include <cstdio>\n#include <algorithm>\nusing namespace std;\n\nconst int MAXV= 100005;\nconst long long INF= 1234567890123456ll;\n\t\nint N,S,Q,E,orig[MAXV<<1],targ[MAXV<<1],nex[MAXV<<1],head[MAXV],cur;\nlong long weig[MAXV<<1];\n\nint fa[MAXV],dep[MAXV],siz[MAXV],shop[MAXV];\nint wson[MAXV],topfa[MAXV],dfn[MAXV],dfsclk=0;\nlong long Segtree[MAXV<<2],f[MAXV],dis[MAXV];\n\nlong long Query(int a,int b,int k,int l,int r){\n\tif(a<=l && r<=b) return Segtree[k];\n\tif(b<l || r<a) return INF;\n\tint mid= (l+r)>>1;\n\tlong long v1= Query(a,b,k<<1,l,mid);\n\tlong long v2= Query(a,b,k<<1|1,mid+1,r);\n\treturn min(v1,v2);\n}\n\nvoid Update(int a,long long c,int k,int l,int r){\n\tif(a<l || r<a) return;\n\tif(l==r){\n\t\tSegtree[k]= c;\n\t\treturn;\n\t}\n\tint mid= (l+r)>>1;\n\tUpdate(a,c,k<<1,l,mid);\n\tUpdate(a,c,k<<1|1,mid+1,r);\n\tSegtree[k]= min(Segtree[k<<1],Segtree[k<<1|1]);\n\treturn;\n}\n\nlong long TQuery(int a,int b){\n\tlong long res= INF;\n\twhile(topfa[a]!=topfa[b]){\n\t\tif(dep[topfa[a]]>dep[topfa[b]]) swap(a,b);\n\t\tres= min(res,Query(dfn[topfa[b]],dfn[b],1,1,N));\n\t\tb= fa[topfa[b]];\n\t}\n\tif(dfn[a]>dfn[b]) swap(a,b);\n\tres= min(res,Query(dfn[a],dfn[b],1,1,N));\n\treturn res;\t\n}\n\nint lca(int a,int b){\n\twhile(topfa[a]!=topfa[b]){\n\t\tif(dep[topfa[a]]>dep[topfa[b]])\n\t\t\tswap(a,b);\n\t\tb=fa[topfa[b]];\n\t}\n\treturn (dep[a]<dep[b])?a:b;\n}\n\nvoid subdivtree(int u){\n\tdfn[u]= ++dfsclk;\n\tif(wson[u]) topfa[wson[u]]=topfa[u],subdivtree(wson[u]);\n\tfor(int e=head[u];e;e=nex[e]){\n\t\tint v=targ[e];\n\t\tif(fa[u]==v || v==wson[u]) continue;\n\t\ttopfa[v]= v;subdivtree(v);\n\t}\n\treturn;\n}\n\nvoid buildtree(int u){\n\tif(shop[u]) f[u]= 0;\n\tsiz[u]= 1;\n\tfor(int e=head[u];e;e=nex[e]){\n\t\tint v= targ[e];\n\t\tif(v==fa[u]) continue;\n\t\tfa[v]= u;\n\t\tdep[v]= dep[u]+1;\n\t\tdis[v]= dis[u]+weig[e];\n\t\tbuildtree(v);\n\t\tshop[u]+= shop[v];\n\t\tsiz[u]+= siz[v];\n\t\tf[u]= min(f[u],f[v]+weig[e]);\n\t\tif(siz[wson[u]]<siz[v]) wson[u]=v;\n\t}\n\treturn;\n}\n\nvoid AddEdge(int u,int v,int w){\n\tnex[++cur]= head[u];\n\thead[u]= cur;\n\torig[cur]= u;\n\ttarg[cur]= v;\n\tweig[cur]= w;\n\treturn;\n}\n\nvoid Input(){\n\tscanf(\"%d%d%d%d\",&N,&S,&Q,&E);\n\tint x,y,c;long long z;\n\tfor(int i=1;i<=N-1;++i){\n\t\tscanf(\"%d%d%lld\",&x,&y,&z);\n\t\tAddEdge(x,y,z);\n\t\tAddEdge(y,x,z);\n\t}\n\tfor(int i=1;i<=S;++i){\n\t\tscanf(\"%d\",&c);\n\t\tshop[c]= 1;\n\t}\n\treturn;\n}\n\nint main(){\n\tInput();\n\tfor(int i=1;i<=N;++i)\n\t\tf[i]=INF;\n\tbuildtree(E);\n\ttopfa[E]= E;\n\tsubdivtree(E);\n\tfor(int i=1;i<=N;++i) Update(dfn[i],f[i]-dis[i],1,1,N);\n\twhile(Q--){\n\t\tint I,R;\n\t\tscanf(\"%d%d\",&I,&R);\n\t\tint u= orig[I<<1],\n\t\t\tv= targ[I<<1];\n\t\tif(fa[u]==v) swap(u,v);\n\t\tif(lca(v,R)!=v) puts(\"escaped\");\n\t\telse if(!shop[v]) puts(\"oo\");\n\t\telse printf(\"%lld\\n\",TQuery(R,v)+dis[R]);\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1602065005,
        "uid": 102091,
        "name": "NashChen",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P6227 \u300cBalticOI 2019 Day 1\u300d\u5c71\u8c37"
    },
    {
        "content": "### \u9898\u76ee\u5927\u610f\n\n\u7ed9\u5b9a\u4e00\u68f5 $n$ \u4e2a\u7ed3\u70b9\u7684\u6811\u548c\u4e00\u4e2a\u7ed3\u70b9 $e$ \uff0c\u5176\u4e2d\u6709 $s$ \u4e2a\u7ed3\u70b9\u6709\u5546\u5e97\uff0c $q$ \u6b21\u8be2\u95ee\uff0c\u6bcf\u6b21\u8be2\u95ee\u7ed9\u51fa\u4e00\u4e2a\u7f16\u53f7 $I$ \u548c\u7ed3\u70b9 $R$ \uff0c\u5207\u65ad\u7f16\u53f7\u4e3a $I$ \u7684\u8fb9\u540e\uff0c\u82e5 $R$ \u4e0e $e$ \u8fde\u901a\uff0c\u8f93\u51fa `escaped` \uff1b\u82e5\u4e0d\u8fde\u901a\uff0c\u8f93\u51fa $R$ \u4e0e\u6700\u8fd1\u7684\u6709\u5546\u5e97\u7ed3\u70b9\u7684\u8ddd\u79bb\uff0c\u82e5\u6ca1\u6709\u8fd9\u6837\u7684\u7ed3\u70b9\uff0c\u8f93\u51fa `oo` \u3002\n\n$1\\le n,q\\le 10^5$ \n\n### \u89e3\u9898\u601d\u8def\n\n\u4ee5 $e$ \u4e3a\u6839\u5efa\u6811\u3002\u5148\u5224\u65ad\u5207\u65ad $I$ \u540e $R$ \u4e0e $e$ \u662f\u5426\u8fde\u901a\u3002\u8bbe $I=(u,v)$ \uff0c\u82e5 $u,v$ \u540c\u65f6\u662f $R$ \u5728\u6811\u4e0a\u7684\u7956\u5148\uff0c\u5219\u5207\u65ad\u540e $R$ \u4e0e $e$ \u4e0d\u8fde\u901a\uff0c\u5426\u5219\u4e00\u5b9a\u8fde\u901a\u3002\u5224\u65ad\u4e00\u4e2a\u7ed3\u70b9 $u$ \u662f\u5426\u4e3a $R$ \u7684\u7956\u5148\uff0c\u53ef\u4ee5\u6c42 $LCA(u,R)$ \uff0c\u82e5\u7b49\u4e8e $u$ \u5219 $u$ \u4e3a $R$ \u7684\u7956\u5148\u3002\n\n\u82e5\u4e0d\u8fde\u901a\uff0c\u5219\u8be2\u95ee\u7684\u5c31\u662f $R$ \u4e0e **\u4ee5 $u,v$ \u4e2d\u7684\u513f\u5b50\u4e3a\u6839\u7684\u5b50\u6811** \u4e2d\u6700\u8fd1\u7684\u6709\u5546\u5e97\u7ed3\u70b9\u7684\u8ddd\u79bb\uff0c\u4e0d\u59a8\u8bbe $u,v$ \u4e2d\u7684\u513f\u5b50\u4e3a $p$ \u3002\n\n\u6211\u4eec\u9884\u5904\u7406\u51fa\u5bf9\u4e8e\u4ee5\u6bcf\u4e2a\u7ed3\u70b9 $x$ \u4e3a\u6839\u7684\u5b50\u6811\u4e2d\uff0c\u79bb $x$ \u6700\u8fd1\u7684\u5546\u5e97\u7ed3\u70b9\u7684\u8ddd\u79bb $v_x$ \u3002\u5bf9\u4e8e\u6bcf\u6b21\u8be2\u95ee\uff0c\u6211\u4eec\u8981\u6c42\u7684\u7b54\u6848\u5c31\u662f $\\min\\{v_x+dist(R,x)\\}$ \uff0c\u5176\u610f\u4e49\u4e3a \u201c\u4ece $R$ \u51fa\u53d1\u7684\u8def\u5f84\uff0c\u7ecf\u8fc7\u6df1\u5ea6\u6700\u6d45\u7684\u70b9\u5c31\u662f $x$ \uff0c\u53ef\u4ee5\u5230\u8fbe\u7684\u6700\u8fd1\u7684\u5546\u5e97\u7684\u8ddd\u79bb\uff0c\u5176\u4e2d $x$ \u53d6\u904d\u6811\u4e0a $R,p$ \u4e24\u70b9\u4e4b\u95f4\u8def\u5f84\u4e0a\u7684\u70b9\u201d\u3002\n\n\u7ef4\u62a4\u6811\u94fe\u4fe1\u606f\uff0c\u53ef\u4ee5\u4f7f\u7528\u6811\u94fe\u5256\u5206\u3002\u4f46\u662f\uff0c\u672c\u9898\u9700\u8981\u7ef4\u62a4\u7684\u4fe1\u606f\u4e0e\u8be2\u95ee\u70b9 $R$ \u5230\u6811\u94fe\u4e0a\u4e00\u70b9\u7684\u8ddd\u79bb\u6709\u5173\uff0c\u800c\u8fd9\u4e2a\u8be2\u95ee\u70b9\u662f\u4e0d\u56fa\u5b9a\u7684\u3002\u600e\u4e48\u529e\u5462\uff1f\u89c2\u5bdf\u5230 $p$ \u5fc5\u662f $R$ \u7684\u7956\u5148\uff0c\u94fe\u4e0a\u4efb\u610f\u4e24\u70b9\u90fd\u6709\u7956\u5148\u540e\u4ee3\u5173\u7cfb\u3002\u8bbe\u7ed3\u70b9 $x$ \u6240\u5728\u91cd\u94fe\u6df1\u5ea6\u6700\u6df1\u7684\u7ed3\u70b9\u4e3a $low(x)$ \u3002\u6211\u4eec\u5728\u7ebf\u6bb5\u6811\u4e0a\u7ef4\u62a4\u7684\u503c\u662f $v_x+dist(x,low(x))$ \u3002\u8bbe\u4e00\u6761\u91cd\u94fe\u4e0a **\u67e5\u8be2\u7684** \u6df1\u5ea6\u6700\u6d45\u7684\u70b9\u4e3a $x$ \uff0c\u6df1\u5ea6\u6700\u6df1\u7684\u70b9\u4e3a $y$ \uff0c $t$ \u4e3a\u4efb\u610f\u7ed3\u70b9\uff0c\u5219\u56e0\u4e3a $low(t)=low(y)$ \uff0c\u6240\u4ee5\u6709\n\n$v_t+dist(t,low(t))-dist(y,low(y))+dist(R,y)=v_t+dist(R,t)$ \n\n\u67e5\u8be2\u65f6\uff0c\u53ea\u9700\u67e5\u8be2\u533a\u95f4 $[x,y]$ \u7684\u6700\u5c0f\u503c\uff0c\u51cf\u53bb $dist(y,low(y))$ \uff0c\u52a0\u4e0a $dist(R,y)$ \uff0c\u5c31\u662f\u8fd9\u6761\u91cd\u94fe\u7684\u6700\u5c0f\u7b54\u6848\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n\\log n)$ \u3002\n\n### \u53c2\u8003\u4ee3\u7801\n\n```cpp\n#include<cstdio>\n#include<cstring>\n#include<algorithm>\nusing namespace std;\n#define int long long\nconst int maxn=200010;\nconst int inf=2e18;\nint n,s,q,e,cur,h[maxn],nxt[maxn],p[maxn],w[maxn],ans,bann;\nint lg[maxn],fa[maxn][20],dep[maxn],dist[maxn],c[maxn],I,r;\nint siz[maxn],son[maxn],cnt,dfn[maxn],rnk[maxn],top[maxn],v[maxn];\nint low[maxn],val[maxn],minn[maxn*4];\nstruct Edge{int a,b,w;}edge[maxn];\nbool tf[maxn];\nvoid add_edge(int x,int y,int z)\n{\n\tcur++;\n\tnxt[cur]=h[x];\n\th[x]=cur;\n\tp[cur]=y;\n\tw[cur]=z;\n}\nvoid dfs(int x,int f)\n{\n\tsiz[x]=1;\n\tfor(int j=h[x];j;j=nxt[j])if(p[j]!=f)\n\t{\n\t\tfa[p[j]][0]=x;dep[p[j]]=dep[x]+1;dist[p[j]]=dist[x]+w[j];\n\t\tdfs(p[j],x);\n\t\tsiz[x]+=siz[p[j]];if(!son[x]||siz[son[x]]<siz[p[j]])son[x]=p[j]; \n\t}\n}\nvoid dfs3(int x,int t)\n{\n\tdfn[x]=++cnt;rnk[cnt]=x;top[x]=t;\n\tif(son[x])dfs3(son[x],t);\n\tfor(int j=h[x];j;j=nxt[j])if(p[j]!=fa[x][0]&&p[j]!=son[x])dfs3(p[j],p[j]);\n} \nint LCA(int x,int y)\n{\n\tif(dep[x]<dep[y])swap(x,y);\n\tint k=dep[x]-dep[y];for(int j=lg[k];j>=0;j--)if(k&(1<<j))x=fa[x][j];\n\tif(x==y){return x;}\n\tk=dep[x];\n\tfor(int j=lg[k];j>=0;j--)if(fa[x][j]!=fa[y][j])x=fa[x][j],y=fa[y][j];\n\treturn fa[x][0];\n}\nint dis(int x,int y){int t=LCA(x,y);return dist[x]+dist[y]-dist[t]*2;}\nvoid dfs2(int x,int fa,int d)\n{\n\tif(tf[x])ans=min(ans,d);\n\tfor(int j=h[x];j;j=nxt[j])if(p[j]!=fa&&p[j]!=bann)dfs2(p[j],x,d+w[j]);\n}\nvoid pre(int x,int fa)\n{\n\tif(tf[x])v[x]=0;else v[x]=inf;\n\tfor(int j=h[x];j;j=nxt[j])if(p[j]!=fa)\n\t{\n\t\tpre(p[j],x);\n\t\tv[x]=min(v[x],v[p[j]]+w[j]);\n\t}\n}\n#define lc (o<<1)\n#define rc (o<<1|1)\nvoid build(int o,int l,int r)\n{\n\tif(l==r){minn[o]=val[l];return;}\n\tint mid=(l+r)>>1;\n\tbuild(lc,l,mid);build(rc,mid+1,r);\n\tminn[o]=min(minn[lc],minn[rc]);\n}\nint query(int o,int l,int r,int ql,int qr)\n{\n\tif(l>qr||r<ql)return inf;\n\tif(ql<=l&&r<=qr)return minn[o];\n\tint mid=(l+r)>>1;\n\treturn min(query(lc,l,mid,ql,qr),query(rc,mid+1,r,ql,qr));\n}\nmain()\n{\n\tscanf(\"%lld%lld%lld%lld\",&n,&s,&q,&e);\n\tfor(int i=1;i<n;i++)scanf(\"%lld%lld%lld\",&edge[i].a,&edge[i].b,&edge[i].w),\n\tadd_edge(edge[i].a,edge[i].b,edge[i].w),add_edge(edge[i].b,edge[i].a,edge[i].w);\n\tfor(int i=1;i<=s;i++)scanf(\"%lld\",c+i),tf[c[i]]=true;\n\tfor(int i=2;i<=n;i++)lg[i]=lg[i/2]+1;\n\tdep[e]=1;dfs(e,-1);dfs3(e,e);\n\tfor(int i=1;i<=lg[n];i++)for(int j=1;j<=n;j++)fa[j][i]=fa[fa[j][i-1]][i-1];\n\tpre(e,-1);\n\tint lst=1;\n\tfor(int i=2;i<=n+1;i++)\n\t{\n\t\tif(top[rnk[i]]!=top[rnk[i-1]])\n\t\t{\n\t\t\tfor(int j=lst;j<=i-1;j++)low[rnk[j]]=rnk[i-1],val[j]=v[rnk[j]]+dis(rnk[j],rnk[i-1]);\n\t\t\tlst=i;\n\t\t}\n\t}\n\tbuild(1,1,n);\n\twhile(q--)\n\t{\n\t\tscanf(\"%lld%lld\",&I,&r);\n\t\tif(LCA(edge[I].a,r)==edge[I].a&&LCA(edge[I].b,r)==edge[I].b)\n\t\t{\n\t\t\tint x=LCA(edge[I].a,edge[I].b);if(x==edge[I].a)x=edge[I].b;else x=edge[I].a;int y=r;\n\t\t\tint ret=inf,fx=top[x],fy=top[y];\n\t\t\twhile(fx!=fy)\n\t    \t{\n\t    \t\tret=min(ret,query(1,1,n,dfn[fy],dfn[y])-dis(low[y],y)+dis(r,y));y=fa[fy][0];\n\t\t    \tfx=top[x];fy=top[y];\n\t\t    }\n\t\t    ret=min(ret,query(1,1,n,dfn[x],dfn[y])-dis(low[y],y)+dis(r,y));\n\t\t    if(ret>=1e18)printf(\"oo\\n\");\n\t\t    else printf(\"%lld\\n\",ret);\n\t\t}\n\t\telse printf(\"escaped\\n\");\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1584798883,
        "uid": 43486,
        "name": "hsfzLZH1",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P6227 \u3010[BalticOI 2019 Day1]\u5c71\u8c37\u3011"
    },
    {
        "content": "\u8003\u8651\u9898\u76ee\u7684\u4e24\u95ee\uff0c\u7b2c\u4e00\u95ee\u662f\u5220\u9664\u4e00\u6761\u8fb9\u540e\u67d0\u4e2a\u70b9\u662f\u5426\u4e0e\u4e00\u4e2a\u5b9a\u70b9\u8054\u901a\uff0c\u7b2c\u4e8c\u95ee\u662f\u5220\u9664\u4e00\u6761\u8fb9\u540e\u8ddd\u79bb\u67d0\u4e00\u70b9\u6700\u8fd1\u7684\u201c\u6807\u8bb0\u70b9\u201d\uff0c\u7b2c\u4e00\u95ee\u663e\u7136\u53ef\u4ee5\u8ba9\u5b9a\u70b9\u4e3a\u6839\uff0c\u6c42\u51fa\u5168\u6811 $\\text{dfs}$ \u5e8f\uff0c\u5982\u679c\u67e5\u8be2\u70b9\u5728\u5220\u9664\u7684\u8fb9\u4e2d\u8f83\u6df1\u7684\u70b9\u7684\u5b50\u6811\u4e2d\uff0c\u90a3\u4e48\u4e00\u5b9a\u662f\u4e0d\u8054\u901a\u7684\u3002\n\n\u7b2c\u4e8c\u95ee\u8003\u8651\u4e00\u4e2a $\\text{dp}$\uff0c\u5373\u4e00\u4e2a\u70b9\u5230\u5176\u5b50\u6811\u4e2d\u6700\u8fd1\u6807\u8bb0\u70b9\u7684\u8ddd\u79bb\uff0c\u5982\u679c\u5b50\u6811\u4e2d\u6ca1\u6709\u6807\u8bb0\u70b9\u5219\u4e3a $\\inf$\uff0c\u5bb9\u6613\u5f97\u5230 $f_u=\\min\\limits_{v\\in son_u} (f_v+dis_{u,v})$\uff0c\u67e5\u8be2\u53ea\u9700\u8981\u67e5\u8be2\u5f53\u524d\u70b9\u5230\u5220\u9664\u8fb9\u8f83\u6df1\u70b9\u4e0a\u6700\u5c0f\u7684 $f$\uff0c\u8fd9\u4e2a\u53ef\u4ee5\u7528\u500d\u589e\u5728 $O(nlogn)$ \u7684\u65f6\u95f4\u590d\u6742\u5ea6\u5185\u7ef4\u62a4\u3002\n\n\u603b\u590d\u6742\u5ea6 $O(nlogn+qlogn)$\n\n```cpp\n/*  Never Island  */\n/*deco loves Chino*/\n#include <bits/stdc++.h>\nusing namespace std;\n#define int long long\nstruct edge\n{\n\tint next,to,dis;\n}e[200010];\nint cnt,head[100010],n,q,s,ee,fa[100010][20],st[100010][20];\nint in[100010],out[100010],val[100010],dep[100010];\nint tx[100010],ty[100010],tot;\nvoid add(int u,int v,int d)\n{\n\te[++cnt].to=v;\n\te[cnt].next=head[u];\n\te[cnt].dis=d;\n\thead[u]=cnt;\n}\nvoid dfs(int u)\n{\n\tin[u]=++tot;\n\tfor(int i=head[u];i;i=e[i].next)\n\t{\n\t\tint v=e[i].to;\n\t\tif(v==fa[u][0])\n\t\t{\n\t\t\tcontinue;\n\t\t}\n\t\tfa[v][0]=u;\n\t\tdep[v]=dep[u]+e[i].dis;\n\t\tdfs(v);\n\t\tval[u]=min(val[u],val[v]+e[i].dis);\n\t}\n\tout[u]=tot;\n}\nsigned main()\n{\n\tcin>>n>>s>>q>>ee;\n\tfor(int i=1;i<n;i++)\n\t{\n\t\tint x,y,z;\n\t\tscanf(\"%lld%lld%lld\",&tx[i],&ty[i],&z);\n\t\tadd(tx[i],ty[i],z);\n\t\tadd(ty[i],tx[i],z);\n\t}\n\tfor(int i=1;i<=n;i++)\n\t{\n\t\tval[i]=1ll<<60;\n\t}\n\tfor(int i=1;i<=s;i++)\n\t{\n\t\tint x;\n\t\tscanf(\"%lld\",&x);\n\t\tval[x]=0;\n\t}\n\tdfs(ee);\n\tfor(int i=1;i<=n;i++)\n\t{\n\t\tst[i][0]=val[i]-dep[i];\n\t\tif(i<n)\n\t\t{\n\t\t\tif(dep[tx[i]]<dep[ty[i]])\n\t\t\t{\n\t\t\t\tswap(tx[i],ty[i]);\n\t\t\t}\n\t\t}\n\t}\n\tfor(int j=1;j<=18;j++)\n\t{\n\t\tfor(int i=1;i<=n;i++)\n\t\t{\n\t\t\tfa[i][j]=fa[fa[i][j-1]][j-1];\n\t\t\tst[i][j]=min(st[i][j-1],st[fa[i][j-1]][j-1]);\n\t\t}\n\t}\n\tfor(int i=1;i<=q;i++)\n\t{\n\t\tint x,y;\n\t\tscanf(\"%lld%lld\",&x,&y);\n\t\tif(in[tx[x]]<=in[y]&&in[y]<=out[tx[x]])\n\t\t{\n\t\t\tint ans=1ll<<60,qaq=y;\n\t\t\tfor(int i=18;i>=0;i--)\n\t\t\t{\n\t\t\t\tif(dep[fa[qaq][i]]>=dep[tx[x]])\n\t\t\t\t{\n\t\t\t\t\tans=min(ans,st[qaq][i]+dep[y]);\n\t\t\t\t\tqaq=fa[qaq][i];\n\t\t\t\t}\n\t\t\t}\n\t\t\tans=min(ans,st[tx[x]][0]+dep[y]);\n\t\t\tif(ans==1ll<<60)\n\t\t\t{\n\t\t\t\tcout<<\"oo\\n\";\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tcout<<ans<<\"\\n\";\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tcout<<\"escaped\\n\";\n\t\t}\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1590408190,
        "uid": 48265,
        "name": "decoqwq",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P6227 \u3010[BalticOI 2019 Day1]\u5c71\u8c37\u3011"
    },
    {
        "content": "\u5148\u8003\u8651\u80fd\u5426\u9003\u51fa\u3002\n\n\u6211\u4eec\u4e0d\u59a8\u8bbe\u5220\u53bb\u7684\u8fb9\u7684\u4e24\u70b9\u7f16\u53f7\u4e3a $u,v$\uff0c\u5176\u4e2d $u$ \u662f $v$ \u7684\u7236\u4eb2\u3002\n\n\u5bb9\u6613\u53d1\u73b0\u5f53\u4e14\u4ec5\u5f53 $R$ \u5728 $v$ \u7684\u5b50\u6811\u4e2d\u65f6\u65e0\u6cd5\u9003\u51fa\uff0c\u5373 $R$ \u548c $v$ \u7684 LCA \u4e3a $v$\u3002\u53ef\u4ee5\u901a\u8fc7\u6811\u5256\u7b49\u5904\u7406\u3002\n\n\u6211\u4eec\u5047\u8bbe\u4e0d\u80fd\u9003\u51fa\uff0c\u90a3\u4e48\u9700\u8981\u8003\u8651\u80fd\u5426\u5230\u5546\u5e97\u3002\u56e0\u4e3a\u5df2\u7ecf\u65e0\u6cd5\u9003\u51fa\uff0c\u90a3\u4e48 $R$ \u53ef\u4ee5\u8d70\u5230 $v$ \u7684\u5b50\u6811\u4e2d\u7684\u4efb\u610f\u4e00\u4e2a\u70b9\u3002\u56e0\u6b64\u53ea\u9700\u8981\u5904\u7406 $c_u$ \u8868\u793a\u4ee5 $u$ \u4e3a\u6839\u7684\u5b50\u6811\u4e2d\u5546\u5e97\u4e2a\u6570\uff0c\u90a3\u4e48\u53ea\u9700\u8981\u5224\u65ad $c_v$ \u662f\u5426\u662f\u6b63\u6570\u5373\u53ef\u3002 \n\n\u5047\u8bbe $c_v > 0$\uff0c\u90a3\u4e48\u6211\u4eec\u9700\u8981\u6c42\u5230\u6700\u8fd1\u5546\u5e97\u7684\u8ddd\u79bb\u3002\u6211\u4eec\u8bbe $f_u$ \u8868\u793a $u$ \u5230\u5176\u5b50\u6811\u4e2d\u67d0\u4e2a\u5546\u5e97\u7684\u6700\u8fd1\u8ddd\u79bb\uff0c\u82e5\u6ca1\u6709\u5546\u5e97\uff0c\u5219 $f_u = \\inf$\u3002\u5bb9\u6613\u901a\u8fc7\u6734\u7d20\u7684 DP \u6c42\u51fa\uff0c\u5373 $f_u = \\min \\limits_{j \\in son_u} (f_j + w(u, j))$\uff0c$w$ \u662f\u8fb9\u6743\u3002\n\n\u8003\u8651 $R$ \u80fd\u5230\u7684\u5546\u5e97\uff0c\u5206\u4e3a\u4e24\u90e8\u5206\uff0c\u4e00\u90e8\u5206\u662f\u5728 $R$ \u5b50\u6811\u5185\u7684\uff0c\u663e\u7136\u76f4\u63a5\u6c42 $f_R$ \u5373\u53ef\u3002\u53e6\u4e00\u90e8\u5206\u662f\u5728 $v$ \u5b50\u6811\u5185\uff0c$R$ \u5b50\u6811\u5916\u7684\u3002\u6211\u4eec\u8bbe $k$ \u4e3a $v \\sim R$ \u8def\u5f84\u4e0a\u7684\u4e00\u4e2a\u70b9\uff0c\u90a3\u4e48 $k$ \u5bf9\u7b54\u6848\u7684\u8d21\u732e\u662f $f_k + dis(k, R)$\uff0c$dis$ \u662f\u4e24\u70b9\u4e4b\u95f4\u8fb9\u6743\u548c\u3002\n\n\u4e0d\u59a8\u8bbe $d_u$ \u8868\u793a $u$ \u5230\u6839\u8282\u70b9\u7684\u8fb9\u6743\u548c\uff0c\u7531\u4e8e $k$ \u662f $R$ \u7684\u7956\u5148\uff0c\u6240\u4ee5 $dis(k, R) = d_R - d_k$\u3002\u8d21\u732e\u53ef\u8f6c\u5316\u4e3a $f_k - d_k + d_R$\u3002\u5bb9\u6613\u53d1\u73b0 $d_R$ \u4e0d\u53d8\u3002\u4e8e\u662f\u53ea\u9700\u8981\u6c42 $f_k - d_k$ \u6700\u5c0f\u503c\u5373\u53ef\u3002\u6811\u5256\u7ef4\u62a4\uff0c\u4f7f\u7528 ST \u8868\u53ef\u4ee5\u505a\u5230 $O(n \\log n)$\u3002\u6211\u7684\u5b9e\u73b0\u662f $O(n \\log^2 n)$ \u7684\u7ebf\u6bb5\u6811\u3002\n\n\u9664\u6b64\u4e4b\u5916\uff0c\u4e5f\u53ef\u4ee5\u7528\u7ebf\u6027 RMQ \u548c\u7ebf\u6027 LCA \u7684\u9ed1\u79d1\u6280\u4f18\u5316\u5230 $O(n)$\u3002\n\n```cpp\n#include <iostream>\n#include <cstdio>\n#include <algorithm>\n#include <cmath>\n#include <cstring>\n#include <vector>\n#include <climits>\nusing namespace std;\n\n#define int long long\n\nconst int N = 1e5 + 5, INF = 1e15;\n\nvector<pair<int, int> > G[N];\n\nint n, s, q, e;\nlong long cnt[N], f[N], sum[N];\nbool p[N];\nlong long val[N];\nint U[N], V[N];\n\nvoid dfs(int u, int fa, int v)\n{\n\tsum[u] = sum[fa] + 1LL * v;\n\tcnt[u] = p[u];\n\tif (p[u])\n\t{\n\t\tf[u] = 0;\n\t}\n\tfor (auto j : G[u])\n\t{\n\t\tif (j.first != fa)\n\t\t{\n\t\t\tdfs(j.first, u, j.second);\n\t\t\tcnt[u] += cnt[j.first];\n\t\t\tf[u] = min(f[u], f[j.first] + j.second);\n\t\t}\n\t}\n}\n\nclass SegmentTree\n{\npublic:\n\tstruct Node\n\t{\n\t\tint l, r;\n\t\tlong long minn;\n\t}tr[N << 2];\n\tvoid pushup(int u)\n\t{\n\t\ttr[u].minn = min(tr[u << 1].minn, tr[u << 1 | 1].minn);\n\t}\n\tvoid build(int u, int l, int r, long long* a)\n\t{\n\t\ttr[u] = { l, r, a[l] };\n\t\tif (l == r) return;\n\t\tint mid = l + r >> 1;\n\t\tbuild(u << 1, l, mid, a);\n\t\tbuild(u << 1 | 1, mid + 1, r, a);\n\t\tpushup(u);\n\t}\n\tlong long query(int u, int l, int r)\n\t{\n\t\tif (tr[u].l >= l and tr[u].r <= r) return tr[u].minn;\n\t\tint mid = tr[u].l + tr[u].r >> 1;\n\t\tlong long res = 1e18;\n\t\tif (l <= mid) res = query(u << 1, l, r);\n\t\tif (r > mid) res = min(res, query(u << 1 | 1, l, r));\n\t\treturn res;\n\t}\n};\n\nclass TreeCut\n{\npublic:\n\tSegmentTree sgt;\n\tint id[N], sz[N], dep[N], fa[N], son[N], top[N], idx;\n\tlong long na[N];\n\tvoid dfs1(int u, int f)\n\t{\n\t\tfa[u] = f;\n\t\tsz[u] = 1;\n\t\tdep[u] = dep[f] + 1;\n\t\tfor (auto j : G[u])\n\t\t{\n\t\t\tif (j.first != f)\n\t\t\t{\n\t\t\t\tdfs1(j.first, u);\n\t\t\t\tsz[u] += sz[j.first];\n\t\t\t\tif (sz[son[u]] < sz[j.first]) son[u] = j.first;\n\t\t\t}\n\t\t}\n\t}\n\tvoid dfs2(int u, int tf)\n\t{\n\t\ttop[u] = tf;\n\t\tid[u] = ++idx;\n\t\tna[idx] = val[u];\n\t\tif (!son[u]) return;\n\t\tdfs2(son[u], tf);\n\t\tfor (auto j : G[u])\n\t\t{\n\t\t\tif (j.first != fa[u] && j.first != son[u]) dfs2(j.first, j.first);\n\t\t}\n\t}\n\tvoid Init()\n\t{\n\t\tdfs1(e, 0);\n\t\tdfs2(e, e);\n\t\tsgt.build(1, 1, n, na);\n\t}\n\tint LCA(int u, int v)\n\t{\n\t\twhile (top[u] ^ top[v])\n\t\t{\n\t\t\tif (dep[top[u]] < dep[top[v]]) swap(u, v);\n\t\t\tu = fa[top[u]];\n\t\t}\n\t\treturn (dep[u] < dep[v] ? u : v);\n\t}\n\tlong long query(int u, int v)\n\t{\n\t\tlong long res = 1e18;\n\t\twhile (top[u] ^ top[v])\n\t\t{\n\t\t\tif (dep[top[u]] < dep[top[v]]) swap(u, v);\n\t\t\tres = min(res, sgt.query(1, id[top[u]], id[u]));\n\t\t\tu = fa[top[u]];\n\t\t}\n\t\tif (dep[u] < dep[v]) swap(u, v);\n\t\tres = min(res, sgt.query(1, id[v], id[u]));\n\t\treturn res;\n\t}\n}tc;\n\nsigned main()\n{\n\tscanf(\"%lld%lld%lld%lld\", &n, &s, &q, &e);\n\tf[n] = INF;\n\tfor (int i = 1; i < n; i++)\n\t{\n\t\tf[i] = INF;\n\t\tint u, v, w;\n\t\tscanf(\"%lld%lld%lld\", &u, &v, &w);\n\t\tG[u].emplace_back(make_pair(v, w));\n\t\tG[v].emplace_back(make_pair(u, w));\n\t\tU[i] = u, V[i] = v;\n\t}\n\tfor (int i = 1; i <= s; i++)\n\t{\n\t\tint u;\n\t\tscanf(\"%lld\", &u);\n\t\tp[u] = 1;\n\t}\n\tdfs(e, 0, 0);\n\tfor (int i = 1; i <= n; i++)\n\t{\n\t\tval[i] = f[i] - sum[i];\n\t}\n\ttc.Init();\n\twhile (q--)\n\t{\n\t\tint I, R;\n\t\tscanf(\"%lld%lld\", &I, &R);\n\t\tint u = U[I], v = V[I];\n\t\tif (tc.fa[u] == v) swap(u, v);\n\t\tint lca = tc.LCA(R, v);\n\t\tif (lca != v)\n\t\t{\n\t\t\tprintf(\"escaped\\n\");\n\t\t}\n\t\telse if (cnt[v] > 0)\n\t\t{\n\t\t\tlong long va = tc.query(v, R);\n\t\t\tprintf(\"%lld\\n\", va + sum[R]);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tprintf(\"oo\\n\");\n\t\t}\n\t}\n\treturn 0;\n}\n```\n",
        "postTime": 1681123578,
        "uid": 332914,
        "name": "happybob",
        "ccfLevel": 6,
        "title": "P6227 [BalticOI 2019 Day1]\u5c71\u8c37"
    }
]