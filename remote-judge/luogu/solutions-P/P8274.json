[
    {
        "content": "[\u6216\u8bb8\u4f1a\u66f4\u597d\u7684\u9605\u8bfb\u4f53\u9a8c](https://yaoxi-std.github.io/2022/03/27/sol-p8274/)\n\n### \u9898\u9762\n\n[\u9898\u76ee\u94fe\u63a5](https://www.luogu.com.cn/problem/P8274)\n\n### \u89e3\u6cd5\n\n~~\u540c\u5c4a\u7684\u5de8\u4f6c\u4eec\u5df2\u7ecf\u90fd\u901a\u5173\u4e86 USACO\uff0c\u53ea\u6709\u6211\u8fd8\u5728\u505a Gold \u7ec4\u7684\u84dd\u9898~~\n\n\u53ef\u4ee5\u53d1\u73b0\u786e\u5b9a\u4e86 $s_1$ \u7684\u503c\u4ee5\u540e\u5c31\u77e5\u9053\u4e86\u5176\u4ed6\u7684\u6240\u6709 $s$\uff0c\u6784\u9020\u65b9\u6cd5\u5982\u4e0b\uff1a\n\n$$\ns_i = \n\\begin{cases}\nr_i ,& r_i < s_1 \\\\\ns_1 ,& l_i \\le s_1 \\le r_i \\\\\nl_i ,& s_1 < l_i \\\\\n\\end{cases}\n$$\n\n\u8ba9\u6240\u6709 $s_i$ \u90fd\u5c3d\u91cf\u9760\u8fd1 $s_1$ \u663e\u7136\u4f7f\u5f97 $Ans$ \u6700\u5c0f\u3002\n\n\u800c\u6b64\u65f6\u7684 $Ans$ \u4e5f\u5f88\u5bb9\u6613\u4e00\u904d $dfs$ \u8fdb\u884c $O(n)$ \u7684\u8ba1\u7b97\uff0c\u4f46\u662f\u590d\u6742\u5ea6 $n \\times (r_1 - l_1)$\u3002\n\n\u601d\u8003 $s_1$ \u5bf9\u7b54\u6848\u7684\u8d21\u732e\uff0c\u663e\u7136\u5c31\u662f $\\max(0, \\max(l_i) - s_1, s_1 - \\min(r_i))$\uff0c\u53ef\u4ee5\u9884\u5904\u7406\u51fa $l_i$ \u548c $r_i$ \u7684\u6700\u5927\u503c $O(1)$ \u8ba1\u7b97\u3002\n\n\u4f46\u662f\u8fd9\u4e0d\u662f\u6700\u7ec8\u7684\u7b54\u6848\uff0c\u6709\u53ef\u80fd\u6709 $v$ \u7684\u7956\u5148 $u$ \u4f7f\u5f97 $r_u < s_1 < l_v$\uff08\u53cd\u4e4b\u540c\u7406\uff0c\u5373 $r_v < s_1 < l_u$\uff09\u3002\u800c\u6b64\u65f6\uff0c\u7531\u4e8e\u8981\u8ba9\u6240\u6709 $s_i$ \u9760\u8fd1 $s_1$\uff0c\u5219 $s_u$ \u7684\u53d6\u503c\u4e00\u5b9a\u4e3a $r_u$\uff0c$s_v$ \u7684\u53d6\u503c\u4e00\u5b9a\u4e3a $l_v$\uff0c\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u5c31\u6210\u4e86 $l_v - r_u$\u3002\n\n\u800c\u5982\u679c $s_u$ \u548c $s_v$ \u5728 $s_1$ \u7684\u540c\u4fa7\uff0c\u90a3\u4e48 $|s_u - s_v|$ \u7684\u8d21\u732e\u5c31\u4e00\u5b9a\u5c0f\u4e8e $s_1$ \u5bf9\u7b54\u6848\u7684\u8d21\u732e\uff0c\u8fd9\u90e8\u5206\u53ef\u4ee5\u4e0d\u7528\u8003\u8651\u3002\u4e8e\u662f\u5f97\u51fa\u91cd\u8981\u7ed3\u8bba\uff1a**\u975e\u6839\u8282\u70b9\u548c\u5176\u975e\u6839\u8282\u70b9\u7684\u7956\u5148\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u662f\u56fa\u5b9a\u7684**\u3002\n\n\u56e0\u6b64\uff0c\u4e0d\u96be\u60f3\u5230\u53ef\u4ee5\u4e00\u904d $dfs$ \u5c31\u5904\u7406\u51fa $max(l_v - r_u)$\uff0c\u5728\u679a\u4e3e $s_1$ \u7684\u65f6\u5019\u53ef\u4ee5 $O(1)$ \u52a0\u5165\u8d21\u732e\u3002\u4e8e\u662f\u590d\u6742\u5ea6\u53d8\u4e3a $O(r_1 - l_1)$\u3002\u867d\u7136\u8fd8\u662f\u65e0\u6cd5\u901a\u8fc7\uff0c\u4f46\u662f\u6709\u4e86\u4e0d\u5c11\u7684\u4f18\u5316\u7a7a\u95f4\u3002\n\n\u7531\u4e8e\u4e00\u90e8\u5206\u7b54\u6848\u7684\u8d21\u732e\u662f\u56fa\u5b9a\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ea\u8003\u8651\u53e6\u4e00\u90e8\u5206 $\\max(0, \\max(l_i) - s_1, s_1 - \\min(r_i))$\u3002\u90a3\u4e48\u663e\u7136 $s_1 = \\frac{\\max(l_i) - \\min(r_i)}{2}$ \u662f\u6700\u4f18\u7684\u3002\n\n\u4e8e\u662f\u8fd9\u9898\u5c31\u7ed3\u675f\u4e86\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $O(n)$\uff0c\u4e3a\u4e00\u904d $dfs$ \u7684\u590d\u6742\u5ea6\u3002\n\n### AC\u4ee3\u7801\n\n```cpp\n/**\n * @file:           T3.cpp\n * @author:         yaoxi-std\n * @url:            \n*/\n// #pragma GCC optimize (\"O2\")\n// #pragma GCC optimize (\"Ofast\", \"inline\", \"-ffast-math\")\n// #pragma GCC target (\"avx,sse2,sse3,sse4,mmx\")\n#include <bits/stdc++.h>\nusing namespace std;\n#define resetIO(x) \\\n    freopen(#x \".in\", \"r\", stdin), freopen(#x \".out\", \"w\", stdout)\n#define debug(fmt, ...) \\\n    fprintf(stderr, \"[%s:%d] \" fmt \"\\n\", __FILE__, __LINE__, ##__VA_ARGS__)\ntemplate <class _Tp>\ninline _Tp& read(_Tp& x) {\n    bool sign = false; char ch = getchar();\n    for (; !isdigit(ch); ch = getchar()) sign |= (ch == '-');\n    for (x = 0; isdigit(ch); ch = getchar()) x = x * 10 + (ch ^ 48);\n    return sign ? (x = -x) : x;\n}\ntemplate <class _Tp>\ninline void write(_Tp x) {\n    if (x < 0) putchar('-'), x = -x;\n    if (x > 9) write(x / 10);\n    putchar((x % 10) ^ 48);\n}\nbool m_be;\nusing ll = long long;\nconst int MAXN = 1e5 + 10;\nconst int INF = 0x3f3f3f3f;\nint n, m, tp, fa[MAXN], lp[MAXN], rp[MAXN], ans[MAXN];\nvector<int> g[MAXN];\ninline void chkmin(int& x, int y) { (x > y) && (x = y); }\ninline void chkmax(int& x, int y) { (x < y) && (x = y); }\nint dfs(int u, int mxl, int mnr) {\n    int ret = max({0, lp[u] - mnr, mxl - rp[u]});\n    chkmax(mxl, lp[u]), chkmin(mnr, rp[u]);\n    for (auto v : g[u]) chkmax(ret, dfs(v, mxl, mnr));\n    return ret;\n}\nbool m_ed;\nsigned main() {\n    // debug(\"Mem %.5lfMB.\", fabs(&m_ed - &m_be) / 1048576);\n    int cas; read(cas), read(tp);\n    while (cas--) {\n        read(n), m = 0;\n        for (int i = 1; i <= n; ++i) g[i].clear();\n        for (int i = 2; i <= n; ++i) read(fa[i]), g[fa[i]].push_back(i);\n        for (int i = 1; i <= n; ++i) read(lp[i]), read(rp[i]);\n        int mxl = 0, mnr = INF;\n        for (int i = 1; i <= n; ++i)\n            chkmax(mxl, lp[i]), chkmin(mnr, rp[i]);\n        int mn = dfs(1, 0, INF), ansp = 0, answ = INF;\n        for (int i = (mxl + mnr) / 2; i <= (mxl + mnr + 1) / 2; ++i) {\n            int curw = mn;\n            if (i < mxl) chkmax(curw, mxl - i);\n            if (i > mnr) chkmax(curw, i - mnr);\n            if (curw < answ) answ = curw, ansp = i;\n        }\n        write(answ), putchar('\\n');\n        if (tp) {\n            for (int i = 1; i <= n; ++i) {\n                if (lp[i] <= ansp && ansp <= rp[i])\n                    ans[i] = ansp;\n                else if (ansp < lp[i])\n                    ans[i] = lp[i];\n                else if (rp[i] < ansp)\n                    ans[i] = rp[i];\n                write(ans[i]), putchar(\" \\n\"[i == n]);\n            }\n        }\n    }\n    return 0;\n}\n```",
        "postTime": 1649143954,
        "uid": 141573,
        "name": "yaoxi",
        "ccfLevel": 8,
        "title": "P8274 [USACO22OPEN] Balancing a Tree G"
    },
    {
        "content": "[Balancing a Tree G](https://www.luogu.com.cn/problem/P8274)\n\n> \u6bcf\u4e2a\u70b9\u6709\u6743\u503c\u8303\u56f4\uff0c\u8981\u6c42\u4f60\u94a6\u5b9a\u6bcf\u4e2a\u70b9\u7684\u6743\u503c\u3002\n>\n> \u6ee1\u8db3\uff0c\u5168\u5c40\u7684 $(i,j)$\uff08\u5176\u4e2d $i$ \u662f $j$ \u7684\u7956\u5148\uff09\u7684 $|a_i-a_j|$ \u7684\u6700\u5927\u503c\u6700\u5c0f\u3002\n\n\u5b98\u65b9\u9898\u89e3\u7684\u505a\u6cd5\u5f88\u5999\u5999\uff0c\u518d\u770b\u8fd9\u4e2a\u89e3\u6cd5\u611f\u89c9\u66b4\u529b\u591a\u4e86\u3002\n\n\u5148\u4e00\u624b\u4e8c\u5206\u7b54\u6848\uff0c\u8bbe\u4e3a $\\lim$\u3002\n\n\u7136\u540e\u60f3\u4e00\u4e2a naive \u7684\u8d2a\u5fc3\uff0c\u8003\u8651\u76f4\u63a5\u81ea\u5e95\u5411\u4e0a\u63a8\uff0c\u6bcf\u6b21\u5411\u4e0a\u9650\u5236\u8303\u56f4 $|l-\\lim,r+\\lim|$\uff0c\u6bcf\u6b21\u6c42\u4ea4\uff0c\u540e\u518d\u5411\u4e0a\u63a8\u3002\n\n\u4f46\u662f\uff0c\u6709\u53ef\u80fd\u5f53\u524d\u503c\u662f\u7531\u67d0\u4e00\u6b21\u7684 $l-\\lim$ \u6269\u5c55\u6765\u7684\uff0c\u6b64\u65f6\u518d\u6b21 $-\\lim$ \u6269\u5c55\u5c31\u51fa\u73b0\u4e86\u503c\u57df\u88ab\u9519\u8bef\u7684\u6269\u5927\u7684\u95ee\u9898\u3002\n\n\u8003\u8651\u8fd9\u79cd\u60c5\u51b5\u51fa\u73b0\u7684\u539f\u56e0\uff0c\u662f\u56e0\u4e3a\u67d0\u4e2a\u7956\u5148\u548c\u5b50\u5b59\u7684\u503c\u57df\u76f8\u5dee\u8d85\u8fc7 $\\lim$\u3002\n\n\u76ee\u7684\u5f88\u660e\u786e\uff0c\u53ef\u4ee5\u76f4\u63a5\u5148\u4ece\u4e0a\u5f80\u4e0b\u6536\u7f29\u4e00\u6b21\uff0c\u628a\u503c\u57df\u63a7\u5236\u5728\u8f83\u5c0f\u7684\u5dee\u4e2d\uff0c\u518d\u4ece\u4e0b\u5f80\u4e0a\u6536\u7f29\u4e00\u6b21\u5373\u53ef\u3002\n\n\u8f93\u51fa\u65b9\u6848\u4e5f\u662f\u7c7b\u4f3c\u7684\uff0c\u5728\u53ef\u9009\u8303\u56f4\u5185\u4efb\u610f\u94a6\u5b9a\u5373\u53ef\u3002\n\n\u5b9e\u73b0\u8d77\u6765\u6709\u4e00\u4e9b\u7ec6\u8282\u3002\n\n```cpp\nconst int N = 1e5 + 10;\nconst int inf = 1e9;\nint n, opt, lv[N], rv[N];\nint cnt, head[N];\nstruct Edge {int nxt, v;} e[N];\n\nvoid clear() {\n\tcnt = 0;\n\trep(i, 1, n) head[i] = 0;\n}\n\nbool flag;\nint lc[N], rc[N], lim;\n\nvoid dfs1(int u, int L, int R) {\n\tif(L > R) {flag = false; return;}\n\tif(L > rc[u] || R < lc[u]) {flag = false; return;}\n\tlc[u] = max(L, lc[u]);\n\trc[u] = min(R, rc[u]);\n\tEde(i, u) {\n\t\tint v = e[i].v;\n\t\tdfs1(v, max(lc[u] - lim, L), min(rc[u] + lim, R));\n\t\tif(! flag) return;\n\t}\n}\n\nbool res[N];\n\nvoid dfs2(int u) {\n\tint lt = 0;\n\tint rt = inf;\n\tEde(i, u) {\n\t\tint v = e[i].v;\n\t\tdfs2(v);\n\t\tif(! flag) return;\n\t\tint ln = lc[v];\n\t\tint rn = rc[v];\n\t\tif(ln > rt || rn < lt) {flag = false; return;}\n\t\tlt = max(lt, ln);\n\t\trt = min(rt, rn);\n\t}\n\tif(lt > rt) {flag = false; return;}\n\tlc[u] = max(lc[u] - lim, lt);\n\trc[u] = min(rc[u] + lim, rt);\n\tif(lc[u] > rc[u]) {flag = false; return;}\n}\n\nint ans[N];\n\nvoid dfs3(int u, int L, int R) {\n\tans[u] = max(lc[u], L);\n\tint nxtl = max(L, ans[u] - lim);\n\tint nxtr = min(R, ans[u] + lim);\n\tEde(i, u)\n\t\tdfs3(e[i].v, nxtl, nxtr);\n}\n\nbool check(int lim_) {\n\tlim = lim_, flag = true;\n\trep(i, 1, n) lc[i] = lv[i], rc[i] = rv[i];\n\tdfs1(1, 0, inf);\n\tif(! flag) return false;\n\tdfs2(1);\n\treturn flag;\n}\n\nvoid work() {\n\tn = read(), clear();\n\trep(v, 2, n) {\n\t\tint u = read();\n\t\te[++ cnt] = (Edge) {head[u], v}, head[u] = cnt;\n\t}\n\trep(i, 1, n) lv[i] = read(), rv[i] = read();\n\n\tint l = 0, r = inf;\n\twhile(l < r) {\n\t\tint mid = (l + r) >> 1;\n\t\tif(check(mid)) r = mid; else l = mid + 1;\n\t}\n\tprintf(\"%d\\n\", l);\n\n\tif(opt) {\n\t\tcheck(l); assert(flag);\n\t\trep(i, 1, n)\n\t\t\tlc[i] = max(lc[i], lv[i]), \n\t\t\trc[i] = min(rc[i], rv[i]);\n\n\t\tans[1] = lc[1];\n\t\tdfs3(1, ans[1] - lim, ans[1] + lim);\n\t\trep(i, 1, n) printf(\"%d \", ans[i]);\n\t\tputs(\"\");\n\t}\n}\n\nint main() {int t = read(); opt = read(); while(t --) work(); return 0;}\n```",
        "postTime": 1649306306,
        "uid": 117941,
        "name": "_LPF_",
        "ccfLevel": 9,
        "title": "P8274 [USACO22OPEN] Balancing a Tree G"
    },
    {
        "content": "\u795e\u4ed9\u9898\u3002\n\n\u6211\u4eec\u63a2\u7a76\u4e00\u4e0b $ans$ \u7684\u4e0b\u754c\u3002\u5f53\u7136\u6709\u4e2a\u524d\u63d0 $ans\\ge 0$\u3002\n\n- **\u5982\u679c\u8282\u70b9 $x$ \u662f $y$ \u7684\u7956\u5148\uff0c\u90a3\u4e48\u663e\u7136 $ans\\ge l_x-r_y$\uff0c$ans\\ge l_y-r_x$\u3002**\n\n\u5982\u679c\u662f\u94fe\u5c31\u5df2\u7ecf\u505a\u5b8c\u4e86\uff0c$ans$ \u7684\u4e0b\u754c\u662f\u80fd\u53d6\u5230\u7684\uff0c\u8ba9\u6bcf\u4e2a\u70b9\u90fd\u5728 $[r_{min},l_{max}]$ \u5c31\u884c\u4e86\u3002\n\n\u4f46\u662f\u6811\u7684\u7b54\u6848\u662f\u9519\u7684\u3002\u4ed4\u7ec6\u60f3\u60f3\uff0c\u540c\u4e00\u4e2a\u70b9\u4e0d\u80fd\u6709\u591a\u79cd\u53d6\u503c\uff0c\u56e0\u6b64\u6ca1\u6709\u7956\u5148\u5173\u7cfb\u7684\u70b9\u4e4b\u95f4\u4e5f\u6709\u9650\u5236\uff1a\n\n- **\u5bf9\u4e8e\u4efb\u610f $x,y$\uff0c\u6ee1\u8db3 $ans\\ge \\frac{l_x-r_y}{2}$\u3002\u8003\u8651 $x\\to 1\\to y$ \u7684\u8def\u5f84\u5c31\u884c\u4e86\uff0c\u5f53 $1$ \u7684\u53d6\u503c\u5728 $l_x$ \u548c $r_y$ \u7684\u6b63\u4e2d\u95f4\u53d6\u5230\u7b49\u53f7\u3002**\n\n\u8fd9\u4e2a\u65f6\u5019\u770b\u8d77\u6765 $ans$ \u6bd4\u8f83\u6b63\u786e\u4e86\uff0c\u4ea4\u4e00\u4e0b $B=0$ \u53d1\u73b0\u5b83\u8fc7\u4e86\u3002\u56e0\u6b64 $ans$ \u7684\u4e0b\u754c\u6211\u4eec\u627e\u5230\u4e86\uff0c\u53ea\u8981\u80fd\u6784\u9020\u65b9\u6848\u53ef\u4ee5\u8bf4\u660e $ans$ \u662f\u6700\u5c0f\u503c\u4e86\u3002\n\n\u5b98\u65b9\u9898\u89e3\u7ed9\u51fa\u7684\u6784\u9020\u65b9\u6848\uff1a\u4ee4 $mid=\\lfloor\\dfrac{r_{min}+l_{max}}{2}\\rfloor$\uff0c\u90a3\u4e48\u6bcf\u4e2a\u70b9\u7684\u7b54\u6848 $s_i=\\max(\\min(mid,r_i),l_i)$\uff0c\u76f4\u767d\u7684\u8bf4\u5c31\u662f\u5982\u679c $mid$ \u5728 $[l_i,r_i]$ \u5185\u5c31\u53d6 $mid$\uff0c\u5426\u5219\u53d6\u63a5\u8fd1 $mid$ \u7684\u7aef\u70b9\u3002\n\n\u8bc1\u660e\u8fd9\u4e2a\u65b9\u6848\u7684\u5408\u6cd5\u6027\u3002\u8003\u8651\u6bcf\u4e00\u5bf9\u5b58\u5728\u7956\u5148\u5173\u7cfb\u7684\u70b9\u5bf9 $(x,y)$\uff1a\n\n- \u82e5 $s_x\\le mid,s_y\\le mid$\uff0c\u90a3\u4e48 $|s_x-s_y|\\le mid-r_{min}\\le \\lceil\\dfrac{l_{max}-r_{min}}{2}\\rceil\\le ans$\u3002\n- \u82e5 $s_x\\ge mid,s_y\\ge mid$\uff0c\u540c\u7406\u3002\n- \u82e5 $s_x\\le mid,s_y\\ge mid$\uff0c\u8bf4\u660e $s_x=r_x,s_y=l_y$\uff0c\u6240\u4ee5 $|s_x-s_y|=l_y-r_x\\le ans$\u3002\n\n\u6240\u4ee5\u8fd9\u4e2a\u6784\u9020\u7684\u65b9\u6848\u662f\u6b63\u786e\u7684\u3002\u56e0\u6b64\u6211\u4eec\u627e\u5230\u4e86 $ans$ \u7684\u6700\u5c0f\u503c\u3002\n\n\u4ee3\u7801\u96be\u5ea6\u8fdc\u4f4e\u4e8e\u601d\u7ef4\u96be\u5ea6\u3002\n\n```cpp\nvoid work()\n{\n\tn=read();\n\tfor (int i=2;i<=n;i++) fa[i]=read();\n\tint minr=inf,maxl=0,ans=0;\n\tfor (int i=1;i<=n;i++)\n\t{\n\t\tL[i]=read(),R[i]=read();\n\t\tminr=min(R[i],minr);\n\t\tmaxl=max(L[i],maxl);\n\t\tif (fa[i]!=0)\n\t\t{\n\t\t\ta[i][0]=max(a[fa[i]][0],L[i]);\n\t\t\ta[i][1]=min(a[fa[i]][1],R[i]);\n\t\t}\n\t\telse\n\t\t{\n\t\t\ta[i][0]=L[i],a[i][1]=R[i];\n\t\t}\n\t\tans=max(ans,a[i][0]-a[i][1]);\n\t}\n\tans=max(ans,(maxl-minr+1)/2);\n\tprintf(\"%d\\n\",ans);\n\tif (B==0) return;\n\tif (maxl<=minr)\n\t{\n\t\tfor (int i=1;i<=n;i++) printf(\"%d \",maxl);\n\t\treturn;\n\t}\n\tint mid=(maxl+minr)/2;\n\tfor (int i=1;i<=n;i++) printf(\"%d \",max(min(mid,R[i]),L[i]));\n\tcout << endl;\n}\n```\n",
        "postTime": 1649049250,
        "uid": 151475,
        "name": "Little09",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P8274 [USACO22OPEN] Balancing a Tree G"
    },
    {
        "content": "\u4e00\u4e2a\u4e0d\u9700\u8981\u8111\u5b50\u7684\u505a\u6cd5\u3002\n\n\u9996\u5148\u4e8c\u5206\u8fd9\u4e2a\u4e0d\u5e73\u8861\u5ea6 $m$\u3002\u8003\u8651\u81ea\u5e95\u5411\u4e0a\u6c42\u51fa\u6bcf\u4e2a\u70b9 $u$ \u7684\u53d6\u503c\u8303\u56f4 $[p_u,q_u]$\uff0c\u4f7f\u5f97\u5f53 $s_u \\in [p_u,q_u]$ \u65f6\uff0c$u$ \u5b50\u6811\u5185\u5b58\u5728\u4e00\u79cd\u4e0d\u5e73\u8861\u5ea6 $\\leq m$ \u7684\u65b9\u6848\u3002\n\n\u6ce8\u610f\u5230\uff0c\u5f53\u6211\u4eec\u8ba1\u7b97 $u$ \u7684\u53d6\u503c\u8303\u56f4\u65f6\uff0c\u5176\u5b50\u6811\u5185\u6240\u6709\u70b9 $v$ \u7684\u53d6\u503c\u8303\u56f4\u90fd\u5df2\u7ecf\u7b97\u51fa\u6765\u4e86\uff0c\u800c\u5bf9\u4e8e $s_v \\in [p_v,q_v]$\uff0c\u5b58\u5728 $s_v$ \u4f7f\u5f97 $|s_u - s_v| \\leq m$ \u7684\u5145\u8981\u6761\u4ef6\u662f $s_u \\in [p_v - m, q_v + m]$\u3002\u4e5f\u5c31\u662f\u8bf4\u5b50\u6811\u5185\u6bcf\u4e2a\u70b9 $v$ \u5bf9\u5e94\u4e00\u4e2a\u5bf9 $s_u$ \u7684\u9650\u5236\uff0c\u628a\u8fd9\u4e9b\u9650\u5236\u6c42\u4ea4\uff0c\u5f97\u5230\u7684\u7ed3\u679c\u518d\u548c $[l_u,r_u]$ \u6c42\u4ea4\u5c31\u662f $[p_u,q_u]$\u3002\u7ef4\u62a4\u5b50\u6811\u5185\u6240\u6709\u9650\u5236\u7684\u4ea4 $[c_u,d_u]$ \u5373\u53ef\u3002\n\n\u6784\u9020\u4e5f\u662f\u5bb9\u6613\u7684\uff0c\u8003\u8651\u81ea\u9876\u5411\u4e0b\u586b\uff0c\u786e\u5b9a $s_v$ \u7684\u503c\u65f6 $v$ \u7684\u6240\u6709\u7956\u5148 $s_u$ \u7684\u503c\u90fd\u5df2\u7ecf\u786e\u5b9a\u4e86\uff0c\u6bcf\u4e2a $u$ \u5bf9\u5e94\u4e00\u4e2a\u5bf9 $s_v$ \u7684\u9650\u5236\u3002\u628a\u8fd9\u4e9b\u9650\u5236\u6c42\u4ea4\uff0c\u5f97\u5230\u7684\u7ed3\u679c\u518d\u548c $[p_v,q_v]$ \u6c42\u4ea4\u5c31\u80fd\u5f97\u5230\u5f53\u524d\u60c5\u51b5\u4e0b $s_v$ \u7684\u53d6\u503c\u8303\u56f4 $[p_v',q_v']$\uff0c\u5728\u91cc\u9762\u968f\u4fbf\u94a6\u5b9a\u4e00\u4e2a\u5c31\u884c\u4e86\u3002\u7ef4\u62a4\u6240\u6709\u7956\u5148\u9650\u5236\u7684\u4ea4 $[c'_u,d'_u]$ \u5373\u53ef\u3002\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(n \\log V)$\u3002\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\ntypedef pair <int, int> pi;\nconst int N = 1e5 + 5;\nint n, B, a[N], l[N], r[N], p[N], q[N], c[N], d[N], m;\nvector <int> e[N];\nint min(int x, int y) {\n    return x < y ? x : y;\n}\npi in(int a, int b, int c, int d) {\n    if (a > c) {\n        swap(a, c), swap(b, d);\n    }\n    if (b >= d) {\n        return make_pair(c, d);\n    } else if (b >= c) {\n        return make_pair(c, b);\n    } else {\n        return make_pair(-1, -1);\n    }\n}\nvoid dfs(int u, int ff) {\n    p[u] = l[u];\n    q[u] = r[u];\n    for (auto v : e[u]) {\n        if (v == ff) {\n            continue;\n        }\n        dfs(v, u);\n        tie(p[u], q[u]) = in(p[u], q[u], c[v], d[v]);\n    }\n    c[u] = max(p[u] - m, 0);\n    d[u] = min(q[u] + m, 1e9);\n    for (auto v : e[u]) {\n        if (v == ff) {\n            continue;\n        }\n        tie(c[u], d[u]) = in(c[u], d[u], c[v], d[v]);\n    }\n}\nvoid fill(int u, int ff) {\n    if (u == 1) {\n        a[u] = p[u];\n        c[u] = max(a[u] - m, 0);\n        d[u] = min(a[u] + m, 1e9);\n    }\n    for (auto v : e[u]) {\n        if (v == ff) {\n            continue;\n        }\n        int L, R;\n        tie(L, R) = in(c[u], d[u], p[v], q[v]);\n        a[v] = L;\n        tie(c[v], d[v]) = in(max(L - m, 0), min(L + m, 1e9), c[u], d[u]);\n        fill(v, u);\n    }\n}\nbool chk(int m) {\n    dfs(1, 0);\n    bool ok = true;\n    for (int i = 1; i <= n; i++) {\n        if (p[i] == -1) {\n            ok = false;\n        }\n    }\n    return ok;\n}\nvoid solve() {\n    cin >> n;\n    for (int i = 1; i <= n; i++) {\n        e[i].clear();\n    }\n    for (int i = 2, f; i <= n; i++) {\n        cin >> f;\n        e[f].push_back(i);\n        e[i].push_back(f);\n    }\n    for (int i = 1; i <= n; i++) {\n        cin >> l[i] >> r[i];\n    }\n    int L = 0, R = 1e9, mi = 1e9;\n    while (L <= R) {\n        m = (L + R) / 2;\n        if (chk(m) == true) {\n            R = m - 1, mi = m;\n        } else {\n            L = m + 1;\n        }\n    }\n    cout << mi << \"\\n\";\n    if (B == 1) {\n        m = mi, dfs(1, 0);\n        fill(1, 0);\n        for (int i = 1; i <= n; i++) {\n            cout << a[i] << \" \";\n        }\n        cout << \"\\n\";\n    }\n}\nint main() {\n    ios :: sync_with_stdio(false);\n    cin.tie(nullptr);\n    int t; \n    cin >> t >> B;\n    while (t--) {\n        solve();\n    }\n    return 0;\n}\n```\n",
        "postTime": 1677060206,
        "uid": 246019,
        "name": "_came11ia_",
        "ccfLevel": 7,
        "title": "P8274 [USACO22OPEN] Balancing a Tree G"
    }
]