[
    {
        "content": "\u9898\u89e3\u600e\u4e48\u90fd\u662f $O(n^2)$ \u7684\u2026\u2026\uff1f\u5176\u5b9e\u8fd9\u4e2a\u9898\u53ef\u4ee5 $O(n \\log n)$ \u7684\u65f6\u95f4\u590d\u6742\u5ea6\u5185\u5b8c\u6210\u3002\u4e00\u4e2a\u7c7b\u4f3c\u7684\u9898\u76ee\u662f [CF526F](https://www.luogu.com.cn/problem/CF526F)\u3002\n\n\u672c\u9898\u7684\u9898\u610f\u662f\uff1a\u7edf\u8ba1\u6709\u591a\u5c11\u4e2a\u533a\u95f4 $[l,r]$\uff0c\u8ba1\u533a\u95f4\u6700\u5927\u503c\u4e3a $\\max$\uff0c\u533a\u95f4\u6700\u5c0f\u503c\u4e3a $\\min$\uff0c\u533a\u95f4\u957f\u5ea6\u4e3a $\\mathrm{len}=r-l$\uff0c\u6ee1\u8db3\u5173\u7cfb\u5f0f $\\mathrm{max}-\\mathrm{min}=\\mathrm{len}$\u3002\n\n\u8fdb\u884c\u5bf9\u539f\u5173\u7cfb\u5f0f\u7684\u79fb\u9879\uff0c\u6709 $\\mathrm{max}-\\mathrm{min}+l=r$\u3002\u5177\u4f53\u800c\u8a00\uff0c\u8003\u8651\u5957\u8def\u5730\u679a\u4e3e\u533a\u95f4\u53f3\u7aef\u70b9 $r$ \u8fdb\u884c\u626b\u63cf\u7ebf\uff0c\u6c42\u51fa\u4ee5 $r$ \u4e3a\u7ed3\u5c3e\u7684\u7b26\u5408\u8981\u6c42\u7684\u533a\u95f4\u4e2a\u6570\uff0c\u7136\u540e\u518d\u6c42\u548c\u3002\u800c\u4e3a\u4e86\u6ee1\u8db3\u8fd9\u4e00\u8981\u6c42\uff0c\u6211\u4eec\u9700\u8981\u4f7f\u7528\u5355\u8c03\u6808+\u7ebf\u6bb5\u6811\u7ef4\u62a4\u3002\u8003\u8651\u5230  $\\mathrm{max}-\\mathrm{min} \\geq r-l$\uff0c\u53ef\u4ee5\u4f7f\u7528\u5355\u8c03\u6808\u7ef4\u62a4\u6bcf\u4e2a\u540e\u7f00\u7684 $\\mathrm{max}$ \u548c $\\mathrm{min}$\uff0c\u518d\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4 $\\mathrm{max}-\\mathrm{min}-len$ \u7684\u6700\u5c0f\u503c\u4ee5\u53ca\u5176\u51fa\u73b0\u6b21\u6570\uff0c\u8fd9\u4e2a\u7ef4\u62a4\u5c31\u6bd4\u8f83\u7b80\u5355\u3002\u65f6\u95f4\u590d\u6742\u5ea6 $O(n \\log n)$\u3002\n\n\u672c\u9898\u4e5f\u53ef\u4ee5\u4f7f\u7528\u6790\u5408\u6811\u5b8c\u6210\u3002\u6790\u5408\u6811\u7684\u5b66\u4e60\u8d44\u6599\u8bf7\u53c2\u8003 [OI-wiki](https://oi-wiki.org//ds/divide-combine/)\u3002\n\n```cpp\n#include <iostream>\n#include <cstdio>\n#include <cstring>\n#include <algorithm>\n#include <cmath>\n#include <cctype>\n#include <queue>\n#include <vector>\n\nusing namespace std;\n\ninline int read()\n{\n\tint x=0,f=1;char ch=getchar();\n\twhile (!isdigit(ch)){if (ch=='-') f=-1;ch=getchar();}\n\twhile (isdigit(ch)){x=x*10+ch-48;ch=getchar();}\n\treturn x*f;\n}\n\nint n,a[300050];\n\nstruct Seg_Tree\n{\n\tint l,r;\n\tint tag,val,minv;\n}t[1200050];\n\ninline void Push_Up(int id)\n{\n\tt[id].minv=min(t[id<<1].minv,t[id<<1|1].minv);\n\tt[id].val=(t[id].minv==t[id<<1].minv?t[id<<1].val:0)+(t[id].minv==t[id<<1|1].minv?t[id<<1|1].val:0);\n}\n\ninline void Build(int id,int l,int r)\n{\n\tt[id].l=l;\n\tt[id].r=r;\n\tif (l==r)\n\t{\n\t\tt[id].minv=l;\n\t\tt[id].val=1;\n\t\treturn;\n\t}\n\tint mid=(l+r)>>1;\n\tBuild(id<<1,l,mid);\n\tBuild(id<<1|1,mid+1,r);\n\tPush_Up(id);\n}\n\ninline void Push_Down(int id)\n{\n\tif (t[id].tag)\n\t{\n\t\tt[id<<1].tag+=t[id].tag;\n\t\tt[id<<1|1].tag+=t[id].tag;\n\t\tt[id<<1].minv+=t[id].tag;\n\t\tt[id<<1|1].minv+=t[id].tag;\n\t\tt[id].tag=0;\n\t}\n}\n\ninline void Change(int id,int l,int r,int val)\n{\n\tif (l<=t[id].l && t[id].r<=r)\n\t{\n\t\tt[id].tag+=val;\n\t\tt[id].minv+=val;\n\t\treturn;\n\t}\n\tPush_Down(id);\n\tint mid=(t[id].l+t[id].r)>>1;\n\tif (r<=mid)\n\t\tChange(id<<1,l,r,val);\n\telse if (l>mid)\n\t\tChange(id<<1|1,l,r,val);\n\telse\n\t{\n\t\tChange(id<<1,l,mid,val);\n\t\tChange(id<<1|1,mid+1,r,val);\n\t}\n\tPush_Up(id);\n}\n\nint st1[300050],st2[300050],top1,top2;\n\nlong long ans;\n\nint main()\n{\n\tn=read();\n\tfor (int i=1;i<=n;i++)\n\t\ta[i]=read();\n\tBuild(1,1,n);\n\tfor (int i=1;i<=n;i++)\n\t{\n\t\tint p=i;\n\t\twhile (top1 && a[i]<a[st1[top1]])\n\t\t{\n\t\t\tChange(1,st1[top1-1]+1,p-1,a[st1[top1]]-a[i]);\n\t\t\tp=st1[top1];\n\t\t\ttop1--;\n\t\t}\n\t\tp=i;\n\t\twhile (top2 && a[i]>a[st2[top2]])\n\t\t{\n\t\t\tChange(1,st2[top2-1]+1,p-1,-a[st2[top2]]+a[i]);\n\t\t\tp=st2[top2];\n\t\t\ttop2--;\n\t\t}\n\t\tst1[++top1]=st2[++top2]=i;\n\t\tans+=t[1].val;\n\t}\n\tcout << ans << endl;\n\treturn 0;\n}\n```",
        "postTime": 1666936496,
        "uid": 8457,
        "name": "chen_zhe",
        "ccfLevel": 6,
        "title": "P8600 \u9898\u89e3"
    },
    {
        "content": "**\u6790\u5408\u6811**\u662f\u4e00\u79cd**\u8fde\u7eed\u6bb5**\u6570\u636e\u7ed3\u6784\u3002\n\n\u5f15\u5165\uff1a\n>\u7ed9\u5b9a**\u6392\u5217** $\\{P_n\\}$\uff0c\u6c42\u503c\u57df\u8fde\u7eed\u7684\u6bb5\u7684\u4e2a\u6570\u3002\n\n# \u6982\u5ff5\n**\u6392\u5217** \u662f\u6392\u5217\u3002\n\n**\u8fde\u7eed\u6bb5** \u662f\u503c\u57df\u8fde\u7eed\u7684\u6bb5\uff0c\u6ee1\u8db3\u96c6\u5408\u8fd0\u7b97\u3002\n\n**\u503c\u57df\u533a\u95f4** \u662f\u8fde\u7eed\u6bb5\u503c\u57df\u7684\u533a\u95f4\u3002\n\n**\u672c\u539f\u6bb5** \u662f\u4e0d\u4e0e\u5176\u4ed6\u8fde\u7eed\u6bb5**\u90e8\u5206\u76f8\u4ea4**\u7684\u8fde\u7eed\u6bb5\u3002\n\n**\u8fde\u7eed\u6bb5\u96c6** $I_p$\uff0c**\u672c\u539f\u6bb5\u96c6** $M_p$\u3002\n\n\u5f62\u5f0f\u5316\u7684\uff0c\n\n\u5b9a\u4e49\u5e8f\u5217 $P$ \u662f $n$ \u9636**\u6392\u5217** $\\Leftrightarrow|P|=n$ \u4e14 $\\forall i\\in[1,n],i\\in P$\u3002\n\n\u5b9a\u4e49 $(P,[l,r])$ \u662f**\u8fde\u7eed\u6bb5** $\\Leftrightarrow\\nexists x,z\\in[l,r],y\\notin[l,r],P_x<P_y<P_z$\u3002\n\n\u8fde\u7eed\u6bb5 $(P,[l,r])$ \u6ee1\u8db3 $[l,r]$ \u4e0a\u7684\u96c6\u5408\u8fd0\u7b97\u3002\n\n\u5b9a\u4e49 $(P,[l,r])$ \u7684**\u503c\u57df\u533a\u95f4**\u4e3a $[\\min\\limits_{i=l}^rP_i,\\max\\limits_{i=l}^rP_i]$\u3002\n\n\u5b9a\u4e49**\u8fde\u7eed\u6bb5\u96c6** $I_p=\\{A|A\\ \\text{\u662f\u8fde\u7eed\u6bb5}\\}$\u3002\n\n\u5b9a\u4e49\u8fde\u7eed\u6bb5 $X$ \u662f**\u672c\u539f\u6bb5** $\\Leftrightarrow\\forall A\\in I_p,X\\cap A=(P,\\varnothing)$ \u6216 $X\\subseteq A$ \u6216 $A\\subseteq X$\u3002\n\n\u5b9a\u4e49**\u672c\u539f\u6bb5\u96c6** $M_p=\\{A|A\\ \\text{\u662f\u672c\u539f\u6bb5}\\}$\u3002\n\n# \u6790\u70b9\u4e0e\u5408\u70b9\n\u6790\u5408\u6811\u7684\u70b9\u96c6\u662f $M_p$\u3002\n\n### \u6982\u5ff5\n\u8282\u70b9 $u$ \u7684 **\u503c\u57df\u533a\u95f4** \u4e3a $[u_l,u_r]$\u3002\n\n\u8282\u70b9 $u$ \u7684 **\u5b50\u8282\u70b9\u5e8f\u5217** $S_u$ \u662f $u$ \u7684**\u6781\u957f**\u771f\u5b50\u8fde\u7eed\u6bb5\u5e8f\u5217\u3002\n\n\u8282\u70b9 $u$ \u7684 **\u5b50\u8282\u70b9\u6392\u5217** $P_u$ \u662f $S_u$ **\u6309\u503c\u57df\u533a\u95f4\u5de6\u7aef\u70b9**\u79bb\u6563\u5316\u7684\u7ed3\u679c\u3002\n\n\u8282\u70b9 $u$ \u662f **\u5408\u70b9** \u5f53\u4e14\u4ec5\u5f53 $P_u$ \u6709\u5e8f\u3002\n\n\u8282\u70b9 $u$ \u662f **\u6790\u70b9** \u5f53\u4e14\u4ec5\u5f53 $u$ \u4e0d\u662f\u5408\u70b9\u3002\n\n\u5f62\u5f0f\u5316\u7684\uff0c\n\n\u5b9a\u4e49\u8282\u70b9 $u$ \u7684**\u503c\u57df\u533a\u95f4**\u4e3a $[u_l,u_r]$\u3002\n\n\u5b9a\u4e49\u8282\u70b9 $u$ \u7684**\u5b50\u8282\u70b9\u5e8f\u5217** $S_u=\\{v|v\\subsetneqq u,\\nexists \nw\\subsetneqq u,v\\subsetneqq w\\}$\uff0c\u4e14\u6309 $v$ \u7684**\u5de6\u7aef\u70b9**\u6392\u5e8f\u3002\n\n\u6ce8\u610f\uff0c$v$ \u7684**\u5de6\u7aef\u70b9**\u4e0d\u662f $v$ \u7684**\u503c\u57df\u533a\u95f4\u5de6\u7aef\u70b9**\u3002\n\n\u5b9a\u4e49\u8282\u70b9 $u$ \u7684**\u5b50\u8282\u70b9\u6392\u5217** $P_{u,i}=|\\{v_l\\le{S_{u,i}}_l|v\\in S_u\\}|$\u3002\n\n\u5b9a\u4e49\u8282\u70b9 $u$ \u662f**\u5408\u70b9** $\\Leftrightarrow\\forall i\\in[1,|S_u|],P_{u,i}=i$ \u6216 $\\forall i\\in[1,|S_u|],P_{u,i}=|S_u|-i+1$\u3002\n\n\u5b9a\u4e49\u8282\u70b9 $u$ \u662f**\u6790\u70b9** $\\Leftrightarrow u$ \u4e0d\u662f\u5408\u70b9\u3002\n\n### \u6027\u8d28\n$u$ \u7684\u5b50\u8282\u70b9\u7684\u5e76\u662f $u$\u3002\u663e\u7136\u3002\n\n$u$ \u662f\u5408\u70b9\u5f53\u4e14\u4ec5\u5f53 $S_u$ \u7684\u5b50\u6bb5\u6784\u6210\u8fde\u7eed\u6bb5\u3002\u663e\u7136\u3002\n\n$u$ \u662f\u6790\u70b9\u5f53\u4e14\u4ec5\u5f53 $S_u$ \u7684\u591a\u5143\u7d20**\u771f**\u5b50\u6bb5\u4e0d\u6784\u6210\u8fde\u7eed\u6bb5\u3002\n\n\u8bc1\u660e\uff1a\u82e5\u547d\u9898\u4e0d\u6210\u7acb\uff0c\u5219 $S_u$ \u4e0a\u6784\u6210\u8fde\u7eed\u6bb5\u7684\u6781\u957f**\u771f**\u5b50\u6bb5\u6784\u6210\u672c\u539f\u6bb5\uff0c\u800c\u6b64\u672c\u539f\u6bb5\u672a\u5728\u6790\u5408\u6811\u4e2d\u51fa\u73b0\u3002\n\n\u5f62\u5f0f\u5316\u7684\uff0c\n\n$\\bigcup\\limits_{v\\in S_u}v=u$\u3002\n\n$u$ \u662f\u5408\u70b9 $\\Leftrightarrow\\forall [l,r]\\subseteq[1,|S_u|],\\bigcup\\limits_{i=l}^rS_{u,i}\\in I_p$\u3002\n\n$u$ \u662f\u6790\u70b9 $\\Leftrightarrow\\forall [l,r]\\subseteq[1,|S_u|],l<r,\\bigcup\\limits_{i=l}^rS_{u,i}\\notin I_p$\u3002\n\n# \u5efa\u6811\n\u53ef\u4ee5\u7528 **\u589e\u91cf\u6cd5** $O(n\\log n)$ \u5efa\u6790\u5408\u6811\u3002\n\n\u5c06 $P_i$ \u4f9d\u6b21\u52a0\u5165\u6790\u5408\u6811\uff0c\u7528\u4e00\u4e2a\u6808\u7ef4\u62a4 $P_j|j\\in[1,i)$ \u5f62\u6210\u7684\u6790\u5408\u68ee\u6797\u3002\n### \u7b56\u7565\n\u7ef4\u62a4\u5f53\u524d\u8282\u70b9 $u$\uff08\u521d\u503c\u4e3a $(P,[i,i])$\uff09\uff0c\u8003\u8651 $u$ \u4e0e\u6808\u5185\u8282\u70b9\u7684\u5408\u5e76\u60c5\u51b5\u3002\n\n1. $u$ \u80fd\u6210\u4e3a\u6808\u9876\u8282\u70b9\u7684\u5b50\u8282\u70b9 $\\Leftrightarrow$ \u6808\u9876\u8282\u70b9\u662f\u5408\u70b9\u4e14 $u$ \u4e0e\u6808\u9876\u8282\u70b9\u7684**\u6700\u53f3**\u5b50\u8282\u70b9\u80fd\u5408\u5e76\u6210\u8fde\u7eed\u6bb5\uff0c\u4ee4 $u$ \u6210\u4e3a\u6808\u9876\u8282\u70b9\u7684\u5b50\u8282\u70b9\uff0c\u7136\u540e\u4ee4 $u\\gets$ \u6808\u9876\u8282\u70b9\u3002\n2. $u$ \u4e0d\u80fd\u6210\u4e3a\u6808\u9876\u8282\u70b9\u7684\u5b50\u8282\u70b9\uff0c\u4ee4 $u$ \u4e0e\u6808\u9876\u82e5\u5e72\u8282\u70b9\u5408\u5e76\u6210\u8fde\u7eed\u6bb5 $v$ \u4e14 $|S_v|$ \u6700\u5c0f\u3002\u8003\u8651 $v$ \u7684\u7c7b\u578b\uff0c\u5bb9\u6613\u53d1\u73b0\u6b64\u65f6 $v$ \u662f\u5408\u70b9 $\\Leftrightarrow |S_v|=2$\u3002\u4ee4 $u\\gets v$\u3002\n3. \u91cd\u590d\u4e0a\u8ff0\u65b9\u6848\u76f4\u5230\u4e0d\u80fd\u8fdb\u884c\uff08\u5373\u627e\u4e0d\u5230 2. \u4e2d\u5408\u6cd5\u7684 $v$\uff09\uff0c\u5c06 $u$ \u5165\u6808\u3002\n\n![](https://codeforces.com/predownloaded/95/91/9591a2bbbeec8cc63ceb752d1cb5f111339e9385.png)\n\n\uff08\u6765\u81ea CF\uff0c\u5bf9 $\\{9,1,10,3,2,5,7,6,8,4\\}$ \u5efa\u6790\u5408\u6811\uff09\n\n\u6839\u636e\u4e0a\u8ff0\u7b56\u7565\uff0c\u6211\u4eec\u9700\u8981\u5feb\u901f\u5224\u65ad $u$ \u4e0e\u4e00\u4e9b\u70b9\u80fd\u5426\u5408\u5e76\u6210\u8fde\u7eed\u6bb5\uff0c\u5373\u5224\u65ad\u4efb\u610f\u540e\u7f00 $[j,i]|j\\in[1,i)$ \u662f\u5426\u8fde\u7eed\u6bb5\u3002\n### \u5b50\u95ee\u9898\n\u8003\u8651\u5982\u4f55\u5feb\u901f\u5224\u65ad $[j,i]|j\\in[1,i)$ \u662f\u5426\u8fde\u7eed\u6bb5\u3002\n\n$P$ \u662f\u6392\u5217\uff0c\u6240\u4ee5 $[j,i]$ \u662f\u8fde\u7eed\u6bb5\u5f53\u4e14\u4ec5\u5f53 $\\max\\limits_{j\\le k\\le i}-\\min\\limits_{j\\le k\\le i}=i-j$\u3002\n\n\u7ef4\u62a4 $Q_j=\\max\\limits_{j\\le k\\le i}-\\min\\limits_{j\\le k\\le i}-i+j|j\\in[1,i)$\uff0c\u5219 $[j,i]$ \u662f\u8fde\u7eed\u6bb5\u5f53\u4e14\u4ec5\u5f53 $Q_j=0$\u3002\n\n\u8003\u8651\u66f4\u65b0 $i$ \u65f6\u5982\u4f55\u5feb\u901f\u66f4\u65b0 $Q$\u3002\n\n\u5728 $\\max\\limits_{j\\le k\\le i}-\\min\\limits_{j\\le k\\le i}-i+j$ \u4e2d\uff0c$j$ \u662f\u4e0d\u53d8\u7684\uff0c\u6bcf\u6b21\u66f4\u65b0 $i$ \u5bf9 $Q_j$ \u7684\u8d21\u732e\u51cf\u4e00\uff0c\u6700\u503c\u7684\u8d21\u732e\u4e0d\u597d\u7ef4\u62a4\u3002\n\n\u8bbe $P_i$ \u66f4\u65b0\u4e86 $B_i$ \u4e2a\u540e\u7f00\u6700\u503c\u7684**\u4f4d\u7f6e**\uff0c\u6ce8\u610f\u5230 $\\sum\\limits_{i=1}^nB_i=O(n)$\uff08\u5355\u8c03\u6808\u7ed3\u8bba\uff09\u3002\n\n\u7528\u5355\u8c03\u6808\u7ef4\u62a4\u540e\u7f00\u6700\u503c\u7684\u4f4d\u7f6e\uff0c\u4ee5\u540e\u7f00\u6700\u5c0f\u503c\u4e3a\u4f8b\u3002\n\n\u7ef4\u62a4\u5355\u8c03\u9012\u589e\u7684\u6808 $x$\u3002\u4e0d\u96be\u53d1\u73b0 $P_{x_i}$ \u662f\u540e\u7f00 $[j,i]|j\\in(x_{i-1},x_i]$ \u7684\u6700\u5c0f\u503c\u3002\n\n$x_i$ \u51fa\u6808\u65f6\u5931\u53bb\u5bf9 $Q_j|j\\in(x_{i-1},x_i]$ \u7684\u8d21\u732e\uff0c\u6240\u4ee5 $Q_j|j\\in(x_{i-1},x_i]\\gets Q_j+P_{x_i}$\u3002\n\n$i$ \u5165\u6808\u65f6\u83b7\u5f97\u5bf9 $Q_j|j\\in(x_{top},i]$ \u7684\u8d21\u732e\uff0c\u6240\u4ee5 $Q_j|j\\in(x_{top},i]\\gets Q_j-P_i$\u3002\n\n\u540e\u7f00\u6700\u5927\u503c\u540c\u7406\u3002\n\n# \u5173\u4e8e\u672c\u9898\n\u8003\u8651\u6790\u5408\u6811\u5185\u6bcf\u4e2a\u70b9\u7684\u8d21\u732e\u3002\n\n\u7531\u5408\u70b9\u7684\u6027\u8d28\uff0c\u82e5 $u$ \u662f\u5408\u70b9\uff0c\u5219 $S_u$ \u7684\u4efb\u610f\u5b50\u6bb5\u6784\u6210\u8fde\u7eed\u6bb5\uff0c\u5373 $u$ \u7684\u8d21\u732e\u4e3a $|S_u|\\choose2$\u3002\n\n\u7531\u6790\u70b9\u7684\u6027\u8d28\uff0c\u82e5 $u$ \u662f\u6790\u70b9\uff0c\u5219 $S_u$ \u7684\u4efb\u610f\u591a\u5143\u7d20\u5b50\u6bb5\u4e0d\u6784\u6210\u8fde\u7eed\u6bb5\uff0c\u5373 $u$ \u7684\u8d21\u732e\u4e3a $1$\u3002\n\n\u6ce8\u610f\u5230 $|M_p|=O(n)$\uff0c\u6240\u4ee5\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log n)$\u3002\n\n```cpp\n#include <cstdio>\n#include <vector>\n#define A(u, v) u->c.push_back(v)\nusing namespace std;\nint n, L, X, Y, a[50050], x[50050], y[50050];\nlong long q;\nstruct S\n{\n\tint l, r;\n\tbool b;\n\tvector<S *> c;\n} * u, *f, *s[50050];\nstruct T\n{\n\tT *l, *r;\n\tint s, t, v, x;\n\tT(int p, int q) : s(p), t(q), v(0), x(0) {}\n\tvoid f(int p)\n\t{\n\t\tv += p;\n\t\tx += p;\n\t}\n\tvoid u() { v = min(l->v, r->v); }\n\tvoid d()\n\t{\n\t\tl->f(x);\n\t\tr->f(x);\n\t\tx = 0;\n\t}\n} * r;\nvoid D(S *p)\n{\n\tq += p->b ? 1ll * p->c.size() * (p->c.size() - 1) >> 1 : 1;\n\tfor (auto c : p->c)\n\t\tD(c);\n}\nvoid B(int s, int t, T *&p)\n{\n\tp = new T(s, t);\n\tif (s != t)\n\t{\n\t\tint m = p->s + p->t >> 1;\n\t\tB(s, m, p->l);\n\t\tB(m + 1, t, p->r);\n\t\tp->u();\n\t}\n}\nvoid M(int l, int r, int x, T *p)\n{\n\tif (l <= p->s && p->t <= r)\n\t\treturn p->f(x);\n\tp->d();\n\tint m = p->s + p->t >> 1;\n\tif (l <= m)\n\t\tM(l, r, x, p->l);\n\tif (r > m)\n\t\tM(l, r, x, p->r);\n\tp->u();\n}\nbool Q(int l, T *p)\n{\n\tif (p->s == p->t)\n\t\treturn !p->v;\n\tp->d();\n\tint m = p->s + p->t >> 1;\n\treturn l <= m ? Q(l, p->l) : Q(l, p->r);\n}\nint Z(T *p)\n{\n\tif (p->s == p->t)\n\t\treturn p->s;\n\tp->d();\n\tint m = p->s + p->t >> 1;\n\treturn p->l->v ? Z(p->r) : Z(p->l);\n}\nint main()\n{\n\tscanf(\"%d\", &n);\n\tB(1, n, r);\n\tfor (int i = 1; i <= n; ++i)\n\t\tscanf(\"%d\", a + i);\n\tfor (int i = 1, p, o; i <= n; ++i)\n\t{\n\t\twhile (X && a[i] <= a[x[X]])\n\t\t\tM(x[X - 1] + 1, x[X], a[x[X]], r), --X;\n\t\twhile (Y && a[i] >= a[y[Y]])\n\t\t\tM(y[Y - 1] + 1, y[Y], -a[y[Y]], r), --Y;\n\t\tM(x[X] + 1, i, -a[i], r);\n\t\tM(y[Y] + 1, i, a[i], r);\n\t\tx[++X] = y[++Y] = i;\n\t\tu = new S{i, i, 0};\n\t\tp = Z(r);\n\t\twhile (L && s[L]->l >= p)\n\t\t\tif (s[L]->b && Q(s[L]->c.back()->l, r))\n\t\t\t\ts[L]->r = i, A(s[L], u), u = s[L--];\n\t\t\telse\n\t\t\t{\n\t\t\t\tf = new S{0, i, Q(s[o = L]->l, r)};\n\t\t\t\twhile (!Q(s[L]->l, r))\n\t\t\t\t\t--L;\n\t\t\t\tfor (int j = L; j <= o; ++j)\n\t\t\t\t\tA(f, s[j]);\n\t\t\t\tf->l = s[L--]->l;\n\t\t\t\tA(f, u);\n\t\t\t\tu = f;\n\t\t\t}\n\t\ts[++L] = u;\n\t\tM(1, i, -1, r);\n\t}\n\treturn D(s[1]), printf(\"%lld\", q), 0;\n}\n```\n",
        "postTime": 1668854098,
        "uid": 388651,
        "name": "5k_sync_closer",
        "ccfLevel": 7,
        "title": "P8600 [\u84dd\u6865\u676f 2013 \u7701 B] \u8fde\u53f7\u533a\u95f4\u6570 \u9898\u89e3"
    },
    {
        "content": "## \u5206\u6cbb\n\n\u65b0\u7248\u9898\u4e2d\u8fd8\u6ca1\u6709\u5206\u6cbb\u9898\u89e3\uff0c\u800c\u4e14\u65e7\u7248\u9898\u91cc\u9762\u5206\u6cbb\u4e5f\u8c8c\u4f3c\u662f\u5c0f\u4f17\u505a\u6cd5\uff0c\u90a3\u6211\u6765\u6c34\u4e00\u53d1\u5427\u3002\n\n\u4e0d\u9700\u8981\u590d\u6742\u7684\u6570\u636e\u7ed3\u6784\uff0c\u4f60\u53ea\u9700\u8981\u4f1a\u4e00\u4e2a\u6876\u548c\u57fa\u672c\u5206\u6cbb\u5957\u8def\u3002\n\n\u56e0\u4e3a  $P$  \u662f\u4e00\u4e2a\u6392\u5217\uff0c\u6240\u4ee5\u8fde\u53f7\u533a\u95f4\u7b49\u4ef7\u4e8e  $\\max_{i=l}^rP_i-\\min_{i=l}^{r}P_i=r-l$\u3002\n\n\u5728\u89e3\u51b3\u8fd9\u79cd\u9650\u5236\u6761\u4ef6\u4e2d\u542b\u6709\u533a\u95f4\u6781\u503c\u7684\u5168\u5c40\u533a\u95f4\u8ba1\u6570\u95ee\u9898\u65f6\uff0c\u5206\u6cbb\u975e\u5e38\u6709\u7528\u3002\n\n\u8003\u8651\u5f53\u524d\u5206\u6cbb\u533a\u95f4  $[L,R]$,\u8bbe  $mid$  \u4e3a\u533a\u95f4\u4e2d\u70b9\uff0c\u628a\u5b8c\u5168\u5305\u542b\u5728  $[L,mid]$,\u548c  $(mid,R]$  \u7684\u533a\u95f4\u6254\u5230\u4e0b\u4e00\u5c42\u5206\u6cbb\u53bb\u8ba1\u7b97\u3002\u6b64\u65f6\u5c31\u53ea\u9700\u8981\u8003\u8651\u5de6\u7aef\u70b9\u5728  $[L,mid]$,\u53f3\u7aef\u70b9\u5728  $(mid,R]$  \u7684\u533a\u95f4\u4e86\u3002\n\n\u8bbe\u4e00\u4e2a\u9700\u8981\u8003\u8651\u7684\u533a\u95f4\u4e3a  $[l,r]$\uff0c\u8bbe  $m=\\max_{i=l}^r P_i$\u3002\n\n### \u7b2c\u4e00\u79cd\u60c5\u51b5\uff1a\n\n$l,m\\in[L,mid];r\\in(mid,R]$\u3002\n\n\u8f6c\u5316\u7b49\u5f0f\uff0c\u6709  $\\max_{i=l}^{r}P_i+l=\\min_{i=l}^rP_i+r$\u3002\n\n\u8003\u8651\u5bf9\u6bcf\u4e00\u4e2a  $l$  \u627e\u51fa\u4e00\u4e2a\u6700\u5927\u7684  $r$  \u6ee1\u8db3  $\\max_{i=mid+1}^r P_i < \\max_{i=l}^{mid} P_i$\u3002\n\n\u8fd9\u4e2a\u65f6\u5019\u5c31\u53ea\u9700\u8981\u8003\u8651\u6709\u591a\u5c11\u4e2a  $r'\\in(mid,r]$   \u6ee1\u8db3$\\min_{i=mid+1}^{r'}P_i+r=m+l$\uff0c\u5f00\u4e2a\u6876\u8bb0\u5f55\u4e00\u4e0b\u5c31\u884c\uff0c\u540c\u65f6\u8981\u6ce8\u610f\u53bb\u6389  $\\{r''|\\min_{i=l}^{mid}P_i<\\min_{i=mid+1}^{r''}P_i\\}$  \u7684\u8d21\u732e\u5e76\u5224\u4e00\u4e0b\u5bf9\u5e94\u7684  $r'''=\\max_{i=l}^{mid}P_i+l-\\min_{i=l}^{mid}P_i$  \u662f\u5426\u5728\u8303\u56f4\u5185\u3002\n\n### \u7b2c\u4e8c\u79cd\u60c5\u51b5\uff1a\n\n$l\\in[L,mid];r,m\\in(mid,R]$\u3002\n\n\u53ef\u4ee5\u53d1\u73b0\u8fd9\u4e24\u79cd\u60c5\u51b5\u52a0\u4e0a\u5206\u6cbb\u4e0b\u53bb\u5904\u7406\u7684\u533a\u95f4\u8986\u76d6\u4e86\u6240\u6709\u533a\u95f4\u3002\n\n\u8f6c\u5316\u7b49\u5f0f\uff0c\u6709  $\\max_{i=l}^{r}P_i-r=\\min_{i=l}^rP_i-l$\u3002\n\n\u5904\u7406\u65b9\u6cd5\u8ddf\u4e0a\u9762\u7c7b\u4f3c\uff0c\u8fd9\u91cc\u4e0d\u518d\u8d58\u8ff0\u3002\n\ncode:\n\n```\n#include<bits/stdc++.h>\n#define rep(a,b,c) for(int c(a);c<=(b);++c)\n#define drep(a,b,c) for(int c(a);c>=(b);--c)\nusing namespace std;\ninline int read()\n{\n\tint res=0;char ch=getchar();while(ch<'0'||ch>'9')ch=getchar();\n\twhile(ch<='9'&&ch>='0')res=res*10+(ch^48),ch=getchar();return res;\n}\ntypedef long long ll;\nconst int N=5e4+10,M=1e5+5;\nint a[N],n,mn[N],mx[N],cnt[N<<2];ll ans;\ninline void Solve(int l,int r)\n{\n\tif(l==r){++ans;return;} int mid=(l+r)>>1;\n\tmn[mid+1]=a[mid+1];mx[mid+1]=a[mid+1];\n\trep(mid+2,r,i)mn[i]=min(mn[i-1],a[i]),mx[i]=max(mx[i-1],a[i]);\n\tmn[mid]=a[mid];mx[mid]=a[mid];\n\tdrep(mid-1,l,i)mn[i]=min(mn[i+1],a[i]),mx[i]=max(mx[i+1],a[i]);\n\tint pr=mid+1,ppr=mid+1;drep(mid,l,pl)\n\t{\n\t\twhile(pr<=r&&mx[pr]<mx[pl]){++cnt[mn[pr]+pr+M];++pr;}\n\t\twhile(ppr<pr&&mn[ppr]>mn[pl]){--cnt[mn[ppr]+ppr+M];++ppr;}\n\t\tans+=cnt[mx[pl]+pl+M];int tr=mx[pl]+pl-mn[pl];\n\t\tif(mid<tr&&tr<ppr)++ans;\n\t}\n\tfor(int i=ppr;i<pr;++i)cnt[mn[i]+i+M]=0;\n\tint pl=mid,ppl=mid;rep(mid+1,r,pr)\n\t{\n\t\twhile(pl>=l&&mx[pl]<mx[pr]){++cnt[mn[pl]-pl+M];--pl;}\n\t\twhile(ppl>pl&&mn[ppl]>mn[pr]){--cnt[mn[ppl]-ppl+M];--ppl;}\n\t\tans+=cnt[mx[pr]-pr+M];int tl=mn[pr]-mx[pr]+pr;\n\t\tif(ppl<tl&&tl<=mid)++ans;\n\t}\n\tfor(int i=ppl;i>pl;--i)cnt[mn[i]-i+M]=0;\n\tSolve(l,mid);Solve(mid+1,r);\n}\nint main()\n{\n\tn=read();rep(1,n,i)a[i]=read();\n\tSolve(1,n);printf(\"%lld\\n\",ans);\n}\n```\n\n\u65f6\u95f4\u590d\u6742\u5ea6  $O(n\\log n)$\u3002",
        "postTime": 1666939595,
        "uid": 191281,
        "name": "Jr_Zlw",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 P8600 \u8fde\u53f7\u533a\u95f4\u6570"
    },
    {
        "content": "## \u95ee\u9898\u7b80\u8ff0\n\n> - \u7ed9\u5b9a\u6392\u5217 $p$\u3002\u6c42\u6709\u591a\u5c11 $[l,r]$ \u4f7f\u5f97 $p[l,r]$ \u6392\u5e8f\u540e\u8fde\u7eed\u3002\n> - $n\\leq 5\\times 10^4$\u3002\n\n## \u89e3\u9898\u601d\u8def\n\n\u6211\u4eec\u628a\u201c$p[l,r]$ \u6392\u5e8f\u540e\u8fde\u7eed\u201d\u6539\u5199\u4e3a\uff1a\n$$\n\\max_{l\\leq i\\leq r} p_i-\\min_{l\\leq i\\leq r} p_i=r-l\n$$\n\u679a\u4e3e $r$ \u6211\u4eec\u53ea\u9700\u8981\n$$\n\\max_{l\\leq i\\leq r} p_i-\\min_{l\\leq i\\leq r} p_i+l=r\n$$\n\u5e76\u4e14\u4e0d\u96be\u53d1\u73b0\u6709\u4e0d\u7b49\u5f0f\uff1a\n$$\n\\max_{l\\leq i\\leq r} p_i-\\min_{l\\leq i\\leq r} p_i+l\\geq r\n$$\n\u4e8e\u662f\u6211\u4eec\u53ea\u9700\u8981\u8bb0\u5f55\u6700\u5c0f\u503c\u7684\u4e2a\u6570\u5373\u53ef\u3002\n\n\u6211\u4eec\u4f1a\u53d1\u73b0\u5f53 $r$ \u53f3\u79fb\u7684\u65f6\u5019\uff0c\u5bf9\u4e8e $l$ \u7684 $\\max p,\\min p$ \u90fd\u4f1a\u6709\u53d8\u5316\uff0c\u4e0d\u96be\u53d1\u73b0\u6bcf\u6b21\u52a0\u5165 $p_r$ \u90fd\u662f\u628a $\\max p,\\min p$ \u7684\u4e00\u6b21\u533a\u95f4\u63a8\u5e73\u64cd\u4f5c\u3002\u63a8\u5e73+\u6700\u5c0f\u503c\u4e2a\u6570\u663e\u7136\u96be\u641e\uff0c\u4f46\u662f\u4e0d\u96be\u53d1\u73b0\u63a8\u5e73\u5fc5\u7136\u662f\u4e00\u6bb5\u4e00\u6bb5\u7684\uff0c\u4ee5 $\\min$ \u6570\u7ec4\u4e3a\u4f8b\uff0c\u5982\u4e0b\u56fe\u6240\u793a\uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/bf6pno3c.png)\n\n\u5176\u5b9e\u539f\u6765\u7684 $\\min$ \u6570\u7ec4\u5df2\u7ecf\u662f\u4e00\u6bb5\u4e00\u6bb5\u7684\u4e86\uff0c\u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u628a\u63a8\u5e73\u8f6c\u4e3a\u6bcf\u6bb5\u533a\u95f4\u52a0\u3002\u4e0d\u96be\u53d1\u73b0\u8fd9\u6837\u7684\u533a\u95f4\u52a0\u5e76\u4e0d\u591a\uff0c\u672c\u8d28\u4e0a\u5c31\u662f\u5355\u8c03\u6808\uff0c\u4e0d\u4f1a\u8d85\u8fc7 $n$ \u6b21\u8c03\u7528\u3002$\\max$ \u540c\u7406\u3002\n\n\u4e8e\u662f\u6211\u4eec\u4f7f\u7528\u4e86\u7ef4\u62a4\u533a\u95f4\u52a0\uff0c\u5168\u57df\u6700\u5c0f\u503c\u4e2a\u6570\u7684\u7ebf\u6bb5\u6811\u5b8c\u6210\u4e86\u672c\u9898\u3002\n\n## \u53c2\u8003\u4ee3\u7801\n\n```cpp\n#include<iostream>\nusing namespace std;\nconst int MAXN=5e4+5;\nint n;\nint p[MAXN];\nstruct sug{\n\tint laz,minn,cnt; \n}a[MAXN<<2];\nint st1[MAXN],cnt1;// \u5927\u6839\u5806 \nint st2[MAXN],cnt2;\nvoid pushup(int id){\n\ta[id].minn=min(a[id<<1].minn,a[id<<1|1].minn);\n\ta[id].cnt=(a[id].minn==a[id<<1].minn?a[id<<1].cnt:0)+\n\t\t(a[id].minn==a[id<<1|1].minn?a[id<<1|1].cnt:0);\n}\nvoid pushdown(int id){\n\ta[id<<1].minn+=a[id].laz,a[id<<1].laz+=a[id].laz;\n\ta[id<<1|1].minn+=a[id].laz,a[id<<1|1].laz+=a[id].laz;\n\ta[id].laz=0;\n}\nvoid build(int id,int l,int r){\n\tif(l==r){a[id].minn=l,a[id].cnt=1;return;}\n\tint mid=l+r>>1;\n\tbuild(id<<1,l,mid);\n\tbuild(id<<1|1,mid+1,r);\n\tpushup(id);\n}\nvoid add(int id,int l,int r,int L,int R,int x){\n\tif(L<=l&&r<=R){a[id].minn+=x,a[id].laz+=x;return;}\n\tint mid=l+r>>1;\n\tpushdown(id);\n\tif(L<=mid) add(id<<1,l,mid,L,R,x);\n\tif(mid<R) add(id<<1|1,mid+1,r,L,R,x);\n\tpushup(id);\n\treturn;\n}\nint main(){\n\tcin>>n;\n\tfor(int i=1;i<=n;i++)\n\t\tcin>>p[i];\n\tbuild(1,1,n);\n\tlong long ans=0;\n\tfor(int i=1;i<=n;i++){\n\t\tint q=i;\n\t\twhile(cnt1&&p[i]>p[st1[cnt1]]){\n\t\t\tadd(1,1,n,st1[cnt1-1]+1,q-1,p[i]-p[st1[cnt1]]);\n\t\t\tq=st1[cnt1--];\n\t\t}\n\t\tq=i;\n\t\twhile(cnt2&&p[i]<p[st2[cnt2]]){\n\t\t\tadd(1,1,n,st2[cnt2-1]+1,q-1,-p[i]+p[st2[cnt2]]);\n\t\t\tq=st2[cnt2--];\n\t\t}\n\t\tst1[++cnt1]=st2[++cnt2]=i;\n\t\tans+=a[1].cnt;\n\t} \n\tcout<<ans;\n\treturn 0;\n}\n```\n",
        "postTime": 1672849611,
        "uid": 248400,
        "name": "Inaba_Meguru",
        "ccfLevel": 7,
        "title": "P8600 [\u84dd\u6865\u676f 2013 \u7701 B] \u8fde\u53f7\u533a\u95f4\u6570 \u9898\u89e3"
    }
]