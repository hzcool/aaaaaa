[
    {
        "content": "\u53d1\u73b0\u8fd9\u4e2a\u9898\u8fd8\u6ca1\u9898\u89e3\u5c31\u81ea\u5df1\u8865\u4e86\u5427\u2026\u2026\n\n\u5176\u5b9e\u8fd9\u4e2a\u9898\u6700\u521d\u7684idea\u662f\u6211\u7684\uff0c\u7136\u540e\u6700\u521d\u6211\u662f\u6309\u7167\u6211\u53bb\u5e74\u7684\u4e00\u4e2a\u9898P3924 \u5eb7\u5a1c\u7684\u7ebf\u6bb5\u6811\u52a0\u5f3a\u7684\uff0c\u552f\u4e00\u7684\u4e0d\u540c\u5176\u5b9e\u5c31\u662f\u628a\u7b49\u6982\u7387\u8fdb\u5165\u6539\u6210\u4e86\u6309\u6743\u91cd\u8fdb\u5165\u3002\n\n\u66fe\u7ecf\u6211\u60f3\u8fc7\u8fd9\u4e2a\u95ee\u9898\uff0c\u7136\u540e\u8fd8\u6ca1\u6765\u5f97\u53ca\u60f3\u6e05\u695a\u6211\u5c31\u5f88\u83dc\u7684\u9000\u5f79\u4e86\uff0c\u6240\u4ee5\u8fd9\u4e2a\u9898\u7b49\u5230\u73b0\u5728\u624d\u51fa\u51fa\u6765\u2026\u2026\n\n\u4e00\u5f00\u59cb\u6211\u611f\u89c9\u533a\u95f4\u52a0\u5bf9\u4e8e\u671f\u671b\u7684\u8d21\u732e\u662f\u4e0d\u592a\u597d\u7b97\u7684\uff0c\u5c31\u6253\u7b97\u51fa\u6210\u533a\u95f4\u4e58\uff08\u8fd9\u6837\u5c31\u662f\u4e2a\u5f88\u50bb\u903c\u7684\u9898\u4e86\uff09\u3002\u7136\u540e\u6709\u4e00\u5929\uff08\u5728\u6587\u5316\u8bfe\u4e0a\uff09\u95f2\u6765\u65e0\u4e8b\u60f3\u5230\u8fd9\u4e2a\u9898\u753b\u4e86\u4e00\u4e2a\u56fe\uff0c\u731b\u7136\u53d1\u73b0\u5206\u5b50\u662f\u90fd\u53ef\u4ee5\u88ab\u7ea6\u5206\u6389\u7684\uff0c\u4e8e\u662f\u8fd9\u4e2a\u9898\u5c31\u53d8\u6210\u4e86\u7ef4\u62a4\u4e00\u4e2a\u533a\u95f4\u7684\u5e73\u65b9\u548c\uff0c\u8003\u8651\u5982\u4f55\u5408\u5e76\uff1a$(a+b)^2=a^2+b^2+2ab$\uff0c\u5bf9\u8fd9\u4e09\u9879\u5206\u5f00\u6765\u7ef4\u62a4\u5c31\u597d\u4e86\u3002\n\n\u5f53\u7136\u6211\u6700\u521d\u5c31\u662f\u8fd9\u4e48\u5199\u7684\uff0c\u8f9b\u8f9b\u82e6\u82e6\u7ef4\u62a4\u5b8c\u4e4b\u540e\uff0c\u4e00\u4e2a\u53eb\u505a\u53f8\u673a\uff08mcfx\uff09\u7684\u6bd2\u7624\u53d1\u73b0\u4e86\u8fd9\u4e2a\u9898\u5176\u5b9e\u53ef\u4ee5\u5728\u53d6\u6a21\u4e4b\u524d\u7206\u6389long long\uff0c\u7136\u540e\u53e6\u4e00\u4e2a\u53eb\u505aComeIntoPower\u7684\u6bd2\u7624\u5c31\u987a\u624b\u6539\u4e86\u6570\u636e\u628a\u6211\u5361\u4e86\u3002\n\n\u6240\u4ee5\u628a\u4e0b\u9762\u7684\u4ee3\u7801\u6539\u6210__uint128\u5c31\u80fd\u8fc7\u4e86\u3002\u7136\u800cyfz\u5728\u9020\u6570\u636e\u7684\u65f6\u5019\u4f3c\u4e4e\u6ca1\u5361\u6389int128\n\n\u6240\u4ee5\u53f8\u673a\u548c\u5c0f\u5706\u5f3a\u65e0\u654c\uff01\n\n```cpp\n#include<bits/stdc++.h>\n#define lson (o<<1)\n#define rson (o<<1|1)\n#define fi first\n#define sc second\n#define dbg(x) cout<<#x<<\" = \"<<(x)<<endl;\ntypedef long long ll;\ntypedef unsigned int uint;\ntypedef unsigned long long ull;\ntypedef  __uint128_t ulll;\nusing namespace std;\nconst double pi=acos(-1);\nconst double eps=1e-6;\ninline int lowbit(int x){return x&(-x);}\ninline int read(){\n    int f=1,x=0;char ch;\n    do{ch=getchar();if(ch=='-')f=-1;}while(ch<'0'||ch>'9');\n    do{x=x*10+ch-'0';ch=getchar();}while(ch>='0'&&ch<='9');\n    return f*x;\n}\ntemplate<typename T> inline T max(T x,T y,T z){return max(max(x,y),z);}\ntemplate<typename T> inline T min(T x,T y,T z){return min(min(x,y),z);}\ntemplate<typename T> inline T sqr(T x){return x*x;}\ntemplate<typename T> inline void checkmax(T &x,T y){x=max(x,y);}\ntemplate<typename T> inline void checkmin(T &x,T y){x=min(x,y);}\ntemplate<typename T> inline void read(T &x){\nx=0;T f=1;char ch;do{ch=getchar();if(ch=='-')f=-1;}while(ch<'0'||ch>'9');\ndo x=x*10+ch-'0',ch=getchar();while(ch<='9'&&ch>='0');x*=f;\n}\ntemplate<typename A,typename B,typename C> inline A fpow(A x,B p,C yql){\n    A ans=1;\n    for(;p;p>>=1,x=1LL*x*x%yql)if(p&1)ans=1LL*x*ans%yql;\n    return ans;\n}\nstruct FastIO{\n    static const int S=1310720;\n    int wpos;char wbuf[S];\n    FastIO():wpos(0) {}\n    inline int xchar(){\n        static char buf[S];\n        static int len=0,pos=0;\n        if(pos==len)pos=0,len=fread(buf,1,S,stdin);\n        if(pos==len)return -1;\n        return buf[pos++];\n    }\n    inline int read(){\n        int c=xchar(),x=0;\n        while(c<=32&&~c)c=xchar();\n        if(c==-1)return -1;\n        for(;'0'<=c&&c<='9';c=xchar())x=x*10+c-'0';\n        return x;\n    }\n}io;\n//#define read io.read\nconst int N=100100;\nconst int yql=998244353;\ninline int orzyql(int x){return x>=yql?x-yql:x;}\nulll ax[N<<2],ab[N<<2],bx[N<<2],addv[N<<2],size[N<<2],sumv[N<<2];\nint n,m,a[N];\ninline void merge(int o,int l,int r){\n    ax[o]=orzyql(ax[lson]+ax[rson]);\n    bx[o]=orzyql(bx[lson]+bx[rson]);\n    ab[o]=orzyql(ab[lson]+ab[rson]);\n    ax[o]=(ax[o]+1LL*(r-l+1)*(r-l+1))%yql;\n    bx[o]=(bx[o]+1LL*sumv[o]*sumv[o])%yql;\n    ab[o]=(ab[o]+2LL*(r-l+1)*sumv[o])%yql;\n}\ninline void pushup(int o,int l,int r){\n    sumv[o]=orzyql(sumv[lson]+sumv[rson]);\n    merge(o,l,r);\n}\ninline void pushdown(int o,int l,int r){\n    if(!addv[o])return;\n    int mid=(l+r)>>1;\n    sumv[lson]=(sumv[lson]+1LL*(mid-l+1)*addv[o]%yql)%yql;\n    sumv[rson]=(sumv[rson]+1LL*(r-mid)*addv[o]%yql)%yql;\n    addv[lson]=orzyql(addv[lson]+addv[o]);\n    addv[rson]=orzyql(addv[rson]+addv[o]);\n    bx[lson]=(1LL*addv[o]*addv[o]%yql*ax[lson]+1LL*addv[o]*ab[lson]%yql+bx[lson])%yql;\n    bx[rson]=(1LL*addv[o]*addv[o]%yql*ax[rson]+1LL*addv[o]*ab[rson]%yql+bx[rson])%yql;\n    ab[lson]=(2LL*addv[o]*ax[lson]%yql+ab[lson])%yql;\n    ab[rson]=(2LL*addv[o]*ax[rson]%yql+ab[rson])%yql;\n    addv[o]=0;\n}\ninline void build(int o,int l,int r){\n    if(l==r){\n        sumv[o]=a[l];\n        ax[o]=1;bx[o]=1LL*a[l]*a[l]%yql;\n        ab[o]=2LL*a[l]%yql;\n        return;\n    }\n    int mid=(l+r)>>1;\n    build(lson,l,mid);\n    build(rson,mid+1,r);\n    pushup(o,l,r);\n}\ninline void optadd(int o,int l,int r,int ql,int qr,int v){\n    if(ql<=l&&r<=qr){\n        sumv[o]=(sumv[o]+1ll*(r-l+1)*v)%yql;\n        addv[o]=orzyql(addv[o]+v);\n        bx[o]=(1LL*v*v%yql*ax[o]+1LL*v*ab[o]%yql+bx[o])%yql;\n        ab[o]=(2LL*v*ax[o]%yql+ab[o])%yql;\n        return;\n    }\n    int mid=(l+r)>>1;\n    pushdown(o,l,r);\n    if(ql<=mid)optadd(lson,l,mid,ql,qr,v);\n    if(qr>mid)optadd(rson,mid+1,r,ql,qr,v);\n    pushup(o,l,r);\n}\nint main(){\n    n=read();m=read();\n    for(int i=1;i<=n;i++)a[i]=read();\n    build(1,1,n);\n    while(m--){\n        int opt=read();\n        if(opt==2)printf(\"%lld\\n\",1LL*bx[1]*fpow(sumv[1],yql-2,yql)%yql);\n        else{\n            int l=read(),r=read(),v=read();\n            optadd(1,1,n,l,r,v);\n        }\n    }\n}\n```",
        "postTime": 1539006614,
        "uid": 2978,
        "name": "zcysky",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P4927 \u3010[1007]\u68a6\u7f8e\u4e0e\u7ebf\u6bb5\u6811\u3011"
    },
    {
        "content": "# \u7ebf\u6bb5\u6811\u7ef4\u62a4\u61d2\u6807\u8bb0\n\u5bf9\uff0c\u5c31\u548c\u9898\u9762\u4e2d\u5199\u7684\u4e00\u6837\n\n\u7ecf\u8fc7\u6253\u8868\u3001\u627e\u89c4\u5f8b\u6216\u8005\u63a8\u5f0f\u5b50\u53ef\u4ee5\u53d1\u73b0\uff0c\u9898\u76ee\u8981\u6c42\u6211\u4eec\u52a8\u6001\u7ef4\u62a4$$\\frac{\\sum_{i=1}^{tot}val[i]^2}{totval}$$\n\u5176\u4e2dtot\u8868\u793a\u7ebf\u6bb5\u6811\u7ed3\u70b9\u603b\u6570\uff0cval\u8868\u793a\u7ebf\u6bb5\u6811\u7ed3\u70b9\u7684\u6743\u503c\uff0ctotval\u8868\u793a\u5e8f\u5217\u7684\u603b\u548c\n\n\u8fd8\u662f\u8003\u8651\u61d2\u6807\u8bb0\n\n\u5bf9\u4e8e\u6bcf\u4e2a\u70b9\u7ef4\u62a4\u56db\u4e2a\u4e1c\u897f\uff0c$l,val,tag,v$\uff0c\u5206\u522b\u8868\u793a\u8be5\u70b9\u5b50\u6811\u5185$\\sum len^2$\u3001\u5b50\u6811\u5185$\\sum lenv$\uff0c\u52a0\u6807\u8bb0\uff0c\u6743\u503c\u3002\u5176\u4e2dlen\u8868\u793a\u8be5\u70b9\u6240\u7edf\u7ba1\u7684\u53f6\u5b50\u7ed3\u70b9\u4e2a\u6570\u3002pushup\u5f88\u597d\u505a\uff0c\u6ce8\u610fpushup\u8981\u66f4\u65b0\u7b54\u6848\n\n\u7ef4\u62a4\u4e00\u4e2a\u5168\u5c40\u7b54\u6848\uff0c\u8003\u8651\u6bcf\u6b21\u7ed9\u533a\u95f4\u52a0\u4e00\u4e2a\u503c\uff0c\u6709\u4e24\u4e2a\u64cd\u4f5c\u9700\u8981\u8003\u8651\n\n## upd_ans\n\u539f$val^2$\uff0c\u73b0$val^2+2vallenk+len^2k^2$\uff0c\u4e8e\u662f\u52a0$lk^2+2valk$\u5373\u53ef\n\n\u8fd9\u6837\u53ef\u4ee5\u628a\u6574\u4e2a\u5b50\u6811\u7684\u7b54\u6848\u90fd\u7edf\u8ba1\u4e0a\n\n## put_tag\nl\u4e0d\u53d8\uff0c$v+=len\u00d7k$\uff0c$tag+=k$\uff0c$val=\\sum len_i(v_i+len_ik)=val_{old}+lk$\n\n\u4e8e\u662f\u5c31\u5f88\u597d\u7ef4\u62a4\u4e86~~\u4e0d\u660e\u767d\u4e3a\u4ec0\u4e48\u8fd9\u9898\u4e0a\u4e86\u9ed1~~\n\n\u5148\u770b\u770b\u4ee3\u7801\n\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<cstdlib>\n#include<algorithm>\n#define lc now<<1\n#define rc now<<1|1\n#define int __int128\nusing namespace std;\nint read()\n{\n    char ch=getchar();int h=0,t=1;\n    while((ch>'9'||ch<'0')&&ch!='-') ch=getchar();\n    if(ch=='-') t=-1,ch=getchar();\n    while(ch>='0'&&ch<='9') h=h*10+ch-'0',ch=getchar();\n    return h*t;\n}\nconst int N=1e5+100,mod=998244353;\nstruct Que{int op,l,r,k;}A[N];\nint n,m,P[N];\nint ksm(int x,int k)\n{\n    int s=1;for(;k;k>>=1,x=x*x%mod)\n                if(k&1) s=s*x%mod;return s;\n}\nvoid print(int x) {if(x>9) print(x/10);putchar(x%10+'0');}\nstruct Seg {int l,val,tag,v;}t[N<<2];\nint tot,ans;\nint f(int x) {return x*x;}\nvoid pushup(int now,int l,int r)\n{\n\tans-=f(t[now].v);\n\tt[now].v=t[lc].v+t[rc].v;\n\tans+=f(t[now].v);\n\tt[now].l=t[lc].l+t[rc].l+f(r-l+1);\n\tt[now].val=t[lc].val+t[rc].val+(r-l+1)*t[now].v;\n}\nvoid build(int now,int l,int r)\n{\n\tif(l==r)\n\t{\n\t\tt[now]=(Seg){1,P[l],0,P[l]};\n\t\ttot+=P[l];ans+=f(P[l]);return;\n\t}\n\tint mid=(l+r)>>1;\n\tbuild(lc,l,mid);\n\tbuild(rc,mid+1,r);\n\tpushup(now,l,r);\n}\nvoid put(int now,int l,int r,int k,int op)\n{\n\tif(op)\n\t{\n\t\tans+=2*k*t[now].val;\n\t\tans+=k*k*t[now].l;\n\t}\n\tt[now].tag+=k;\n\tt[now].v+=k*(r-l+1);\n\tt[now].val+=t[now].l*k;\n}\nvoid pushdown(int now,int l,int mid,int r)\n{\n\tint &s=t[now].tag;if(!s) return;\n\tput(lc,l,mid,s,0);put(rc,mid+1,r,s,0);s=0;\n}\nvoid Add(int now,int l,int r,int gl,int gr,int k)\n{\n\tif(l>=gl&&r<=gr) {put(now,l,r,k,1);return;}\n\tint mid=(l+r)>>1;\n\tpushdown(now,l,mid,r);\n\tif(gl<=mid) Add(now<<1,l,mid,gl,gr,k);\n\tif(gr>mid) Add(now<<1|1,mid+1,r,gl,gr,k);\n\tpushup(now,l,r);\n}\nsigned main()\n{\n    n=read();m=read();\n    for(int i=1;i<=n;i++) P[i]=read();\n    for(int i=1;i<=m;i++)\n    {\n        int op=read(),l=0,r=0,k=0;\n        if(op==1) l=read(),r=read(),k=read();\n        A[i]=(Que){op,l,r,k};\n    }\n\tbuild(1,1,n);\n\tfor(int i=1;i<=m;i++)\n\t\tif(A[i].op==2)\n\t\t{\n\t\t\tint fz=ans/__gcd(ans,tot);\n\t\t\tint fm=tot/__gcd(ans,tot);\n\t\t\tprint(fz%mod*ksm(fm,mod-2)%mod),puts(\"\");\n\t\t}\n\t\telse tot+=(A[i].r-A[i].l+1)*A[i].k,Add(1,1,n,A[i].l,A[i].r,A[i].k);\n}\n```\n\u7136\u540e\u6211\u4eec\u53d1\u73b0\u51fa\u9898\u4eba\u8bbe\u7f6e\u4e86\u4e00\u4e2a\u9677\u9631\uff08\u4e8e\u662f\u628a\u6211\u6bd4\u8d5b\u65f6\u5361\u6210\u4e8690\u5206\uff09\n\n\u4fdd\u8bc1\u7b54\u6848\u7ea6\u5206\u540e\u5206\u6bcd\u4e0d\u662fmod\u7684\u500d\u6570\u3001\n\n\u4e8e\u662f\u7b54\u6848\u53ef\u80fd\u662f$\\frac{2mod}{mod}=2$\uff0c\u4e8e\u662f\u4f60\u8fb9\u505a\u8fb9\u53d6\u6a21\u4f1a\u53d1\u73b0\u5206\u6bcd\u53d8\u6210\u4e860\n\n\u7b54\u6848\u4e0d\u5927\uff08$10^{32}$\u5de6\u53f3\uff09\uff0c\u53ef\u4ee5\u7528std=c++11\u8fd1\u4e4e\u4f5c\u5f0a\u7684\u65b9\u6cd5\u4f7f\u7528__int128\uff0c\u7136\u540e\u4e2d\u95f4\u8ba1\u7b97\u4e0d\u518d\u53d6\u6a21\uff0c\u5c31\u53ef\u4ee5\u5f88\u597d\u5730\u5b8c\u6210\u8fd9\u9898\u4e86\n\n\u6700\u540e\u5b89\u5229\u4e00\u9053\u540c\u6837\u662f\u7ebf\u6bb5\u6811\u7684\u6a21\u677f\u9898\uff1ahttps://www.luogu.org/problemnew/show/P4247\n\n\u53ef\u4ee5\u6765\u535a\u5ba2\u73a9\u73a9\uff1ahttps://www.cnblogs.com/xzyxzy",
        "postTime": 1538997552,
        "uid": 43628,
        "name": "xzyxzy",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P4927 \u3010[1007]\u68a6\u7f8e\u4e0e\u7ebf\u6bb5\u6811\u3011"
    },
    {
        "content": "\u6211\u6211\u6211\u6211\u6211\u6211\u6211\u7ec8\u4e8eAAAAAAAA\u4e86\uff01\uff01\uff01\n\n\u6211\u4eec\u6765\u8003\u8651\u6982\u7387\u671f\u671b\u539f\u6765\u7684\u5b9a\u4e49\uff0c\u662f\u603b\u6536\u76ca\u9664\u4ee5\u603b\u60c5\u51b5\u6570\n\n\u7136\u540e\u56e0\u4e3a\u6bcf\u4e00\u4e2a\u8282\u70b9\u7684\u6743\u503c\u90fd\u662f\u5de6\u53f3\u513f\u5b50\u6743\u503c\u4e4b\u548c\uff0c\u800c\u8d70\u7684\u6982\u7387\u4e5f\u4e0e\u6743\u503c\u6709\u5173\n\n\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u770b\u505a\u662f\u4ece\u6839\u8282\u70b9\u51fa\u53d1\u8d70$sum[1]$\u6b21\uff08$sum[1]$\u4e3a\u6839\u8282\u70b9\u7684\u6743\u503c\uff09\uff0c\u90a3\u4e48\u8d70\u5230\u6bcf\u4e00\u4e2a\u8282\u70b9\u7684\u6b21\u6570\u5c31\u662f\u8fd9\u4e00\u4e2a\u8282\u70b9\u7684\u6743\u503c\n\n\u90a3\u4e48\u603b\u6536\u76ca\u5c31\u662f\u6bcf\u4e00\u4e2a\u8282\u70b9\u88ab\u8d70\u5230\u7684\u6b21\u6570\u4e58\u4e0a\u8282\u70b9\u7684\u6743\u503c\uff0c\u5c31\u662f\u6bcf\u4e00\u4e2a\u8282\u70b9\u6743\u503c\u7684\u5e73\u65b9\u548c\u3002\u800c\u603b\u5171\u8d70\u4e86$sum[1]$\u6b21\n\n\u90a3\u4e48\u7b54\u6848\u5c31\u662f\u6574\u68f5\u5b50\u6811\u7684\u6743\u503c\u7684\u5e73\u65b9\u548c\u4e58\u4e0a$sum[1]$\u7684\u9006\u5143\n\n\u95ee\u9898\u6765\u4e86\uff0c\u56e0\u4e3a\u8fd9\u662f\u533a\u95f4\u52a0\u548c\uff0c\u6211\u4eec\u5f97\u6253\u61d2\u6807\u8bb0\uff0c\u6240\u4ee5\u8981$O(1)$\u5728\u6253\u61d2\u6807\u8bb0\u65f6\u7edf\u8ba1\u51fa\u5b50\u6811\u91cc\u7684\u6743\u503c\u5e73\u65b9\u548c\n\n\u53ea\u6709\u5bf9\u4e8e\u9700\u8981\u88ab\u6253\u61d2\u6807\u8bb0\u7684\u8282\u70b9\uff08\u4e5f\u5c31\u662f\u533a\u95f4\u88ab\u5b8c\u5168\u5305\u542b\u7684\u8282\u70b9\uff09\u6211\u4eec\u9700\u8981\u7edf\u8ba1\u7b54\u6848\uff0c\u5176\u4ed6\u60c5\u51b5\u4e0b\u76f4\u63a5pushup\u5373\u53ef\u7ef4\u62a4\n\n\u6211\u4eec\u8003\u8651\u4e00\u4e0b\uff0c\u8bbe\u4e00\u4e2a\u8282\u70b9\u4ee3\u8868\u7684\u533a\u95f4\u957f\u5ea6\u4e3a$l$\uff0c\u533a\u95f4\u52a0\u548c\u7684\u503c\u4e3a$t$\uff0c\u539f\u8282\u70b9\u7684\u503c\u4e3a$sum$\uff0c\u90a3\u4e48\u8fd9\u4e2a\u8282\u70b9\u7684\u6743\u503c\u5c06\u53d8\u4e3a$sum+l*t$\n\n\u90a3\u4e48\u5e73\u65b9\u548c\u7684\u589e\u52a0\u91cf\u4e3a$(sum+l*t)^2-sum^2=2*sum*l*t-l^2*t^2$\n\n\u9996\u5148\uff0c$l^2$\u662f\u5f88\u597d\u7ef4\u62a4\u7684\uff0c\u53ea\u8981\u8bb0\u5f55\u4e00\u4e0b\u5b50\u6811\u91cc\u6240\u6709\u533a\u95f4\u957f\u5ea6\u7684\u5e73\u65b9\u548c\u5373\u53ef\uff0c\u8fd9\u4e2a\u662f\u4e0d\u53d8\u7684\uff0c\u5efa\u6811\u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u5f04\u51fa\u6765\u4e86\n\n\u4e8e\u662f\u8003\u8651\u600e\u4e48\u7ef4\u62a4$sum*l$\n\n\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u8282\u70b9\u6765\u8bf4\uff0c\u533a\u95f4\u52a0\u548c\u4e4b\u540e\uff0c\u5b83\u7684$sum$\u53d8\u6210$sum+l*t$\uff0c\u90a3\u4e48$sum*l$\u53d8\u4e3a$(sum+l*t)*l$\n\n\u90a3\u4e48\u589e\u52a0\u91cf\u5c31\u662f$l^2*t$\uff0c\u800c\u4e14$l^2$\u6211\u4eec\u5df2\u7ecf\u7ef4\u62a4\u597d\u4e86\n\n\u6240\u4ee5\u6bcf\u4e00\u6b21\u6253\u5b8c\u61d2\u6807\u8bb0\uff0c\u6211\u4eec\u90fd\u53ef\u4ee5$O(1)$\u7ef4\u62a4\u7b54\u6848\u4e86\uff01\n\n\u7136\u540e\u6700\u5751\u7684\u4e00\u70b9\u662f\u2026\u2026\u51fa\u9898\u4eba\u6700\u540e\u4e00\u4e2a\u70b9\u8981\u7528\u9ad8\u7cbe\u6216__int128\u2026\u2026\u7136\u540e\u5bfc\u81f4\u65e0\u6570\u4e2a90\u5206\u2026\u2026\u8c03\u6b7b\u6389\u2026\u2026\n\n\u7136\u800c\u5c34\u5c2c\u7684\u662f\u6211\u6bd4\u8d5b\u7684\u65f6\u5019\u5f0f\u5b50\u5c11\u63a8\u4e86\u4e00\u6b65\u7ed3\u679c\u53ea\u670920\u5206233333\n\nps:__int128\u7f16\u8bd1\u5668\u4e0a\u8fc7\u4e0d\u4e86\u7684\uff0c\u5efa\u8bae\u7528\u6d1b\u8c37IDE\u8c03\uff0c\u6216\u8005\u5148\u5199\u597d\u8c03\u523090\u5206\u518d\u6539\u6210__int128\n```\n//minamoto\n#include<bits/stdc++.h>\n#define ll long long\n#define add(x,y) ((x)+(y))\n#define dec(x,y) ((x)-(y)<0?(x)-(y)+P:(x)-(y))\n#define mul(x,y) ((I)*(x)*(y))\n#define ls (p<<1)\n#define rs (p<<1|1)\nusing namespace std;\n#define getc() (p1==p2&&(p2=(p1=buf)+fread(buf,1,1<<21,stdin),p1==p2)?EOF:*p1++)\nchar buf[1<<21],*p1=buf,*p2=buf;\ninline ll read(){\n    #define num ch-'0'\n    char ch;bool flag=0;ll res;\n    while(!isdigit(ch=getc()))\n    (ch=='-')&&(flag=true);\n    for(res=num;isdigit(ch=getc());res=res*10+num);\n    (flag)&&(res=-res);\n    #undef num\n    return res;\n}\nconst int N=500005,P=998244353;const __int128 I=1;\ninline ll ksm(ll a,ll b){\n    ll res=1;\n    while(b){\n        if(b&1) res=mul(res,a)%P;\n        a=mul(a,a)%P,b>>=1;\n    }\n    return res;\n}\n__int128 sum[N<<2],len[N<<2],len_2[N<<2],ans[N<<2],tag[N<<2],xl[N<<2],a[N],n,m;\n//sz\u5b50\u6811\u8282\u70b9\u4e2a\u6570\uff0csum\u8282\u70b9\uff0cans\u5f53\u524d\u5b50\u6811\u7b54\u6848 ,s\u5b50\u6811\u603b\u548c \ninline void upd(int p,int l,int r){\n    sum[p]=add(sum[ls],sum[rs]),ans[p]=add(add(ans[ls],ans[rs]),mul(sum[p],sum[p]));\n    xl[p]=add(add(xl[ls],xl[rs]),mul((r-l+1),sum[p]));\n}\nvoid pushdown(int p,int l,int r){\n    if(tag[p]){\n    \tint mid=(l+r)>>1;\n        tag[ls]=add(tag[ls],tag[p]),tag[rs]=add(tag[rs],tag[p]);\n        \n        ans[ls]=add(ans[ls],mul(mul(xl[ls],2),tag[p]));\n        ans[ls]=add(ans[ls],mul(mul(tag[p],tag[p]),len_2[ls]));\n        \n        ans[rs]=add(ans[rs],mul(mul(xl[rs],2),tag[p]));\n        ans[rs]=add(ans[rs],mul(mul(tag[p],tag[p]),len_2[rs]));\n        \n        xl[ls]=add(xl[ls],mul(len_2[ls],tag[p]));\n        xl[rs]=add(xl[rs],mul(len_2[rs],tag[p]));\n        \n        sum[ls]=add(sum[ls],mul(tag[p],(mid-l+1)));\n        sum[rs]=add(sum[rs],mul(tag[p],(r-mid)));\n        \n        tag[p]=0;\n    }\n}\nvoid build(int p,int l,int r){\n    if(l==r){\n        sum[p]=a[l],len[p]=1,len_2[p]=1,ans[p]=mul(sum[p],sum[p]),tag[p]=0,xl[p]=sum[p];\n        return;\n    }\n    int mid=(l+r)>>1;\n    build(ls,l,mid),build(rs,mid+1,r);\n    len[p]=add(add(len[ls],len[rs]),(r-l+1));\n    len_2[p]=add(add(len_2[ls],len_2[rs]),mul((r-l+1),(r-l+1)));\n    upd(p,l,r);\n}\nvoid update(int p,int l,int r,int ql,int qr,ll val){\n    if(ql<=l&&qr>=r){\n        tag[p]=add(tag[p],val);\n        \n        ans[p]=add(ans[p],mul(mul(xl[p],2),val));\n        ans[p]=add(ans[p],mul(len_2[p],mul(val,val)));\n        \n        xl[p]=add(xl[p],mul(len_2[p],val));\n        \n        sum[p]=add(sum[p],mul((r-l+1),val));\n        \n        return;\n    }\n    pushdown(p,l,r);\n    int mid=(l+r)>>1;\n    if(ql<=mid) update(ls,l,mid,ql,qr,val);\n    if(qr>mid) update(rs,mid+1,r,ql,qr,val);\n    upd(p,l,r);\n}\nll calc(){\n    __int128 x=ans[1],y=sum[1];\n    while(y%P==0) y/=P,x/=P;\n    x%=P,y%=P;\n    return x*ksm(y,P-2)%P;\n}\nint main(){\n//\tfreopen(\"testdata.in\",\"r\",stdin);\n    n=read(),m=read();\n    for(int i=1;i<=n;++i) a[i]=read();\n    build(1,1,n);\n    while(m--){\n        int op=read();\n        if(op==2) printf(\"%lld\\n\",calc());\n        else{\n            int l=read(),r=read();ll v=read();\n            update(1,1,n,l,r,v);\n        }\n    }\n    return 0;\n}\n```",
        "postTime": 1539092210,
        "uid": 41781,
        "name": "bztMinamoto",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P4927 \u3010[1007]\u68a6\u7f8e\u4e0e\u7ebf\u6bb5\u6811\u3011"
    },
    {
        "content": "\u30d7\u30e9\u30cd\u30bf\u30ea\u30a6\u30e0\u306f\u3044\u304b\u304c\u3067\u3057\u3087\u3046\uff1f\n\n\u3069\u3093\u306a\u65f6\u3082\u51b3\u3057\u3066\u6d88\u3048\u308b\u3053\u3068\u306e\u306a\u3044\u3001\u7f8e\u3057\u3044\u65e0\u7a77\u306e\u304d\u3089\u3081\u304d\u3002\n\n\u6e80\u5929\u306e\u661f\u3005\u304c\u307f\u306a\u3055\u307e\u3092\u304a\u5f85\u3061\u3057\u3066\u3044\u307e\u3059\u3002\n\n\n\n------------\n### \u9898\u610f\n\n\u6709\u4e00\u9897\u7ef4\u62a4\u533a\u95f4\u548c\u7684\u7ebf\u6bb5\u6811\uff0c\u6bcf\u6b21\u6309\u6743\u503c\u5360\u6bd4\u6982\u7387\u8fdb\u5165\u5b50\u6811\uff0c\u6c42\u6743\u503c\u548c\u671f\u671b\u3002\n\n### \u601d\u8def\n\n\u8ba1\u7b97\u6bcf\u4e2a\u53f6\u5b50\u7ed3\u70b9\u7684\u671f\u671b\u6743\u503c\uff0c\u90a3\u4e48\u7b2c $i$ \u4e2a\u70b9\u7684\u671f\u671b\u4e3a $\\frac{sum_i^2}{\\sum{sum}}$,\u5176\u4e2d $\\sum{sum}$ \u4ee3\u8868\u6240\u6709\u8282\u70b9\u7684\u6743\u503c\u4e4b\u548c\u3002\n\n\u73b0\u5728\u52a0\u4e0a\u533a\u95f4\u4fee\u6539\u64cd\u4f5c\uff0c\u53ea\u9700\u8981\u533a\u95f4\u7ef4\u62a4 ${sum^2}$ \u5c31\u53ef\u4ee5\u4e86\u3002\n\n\u5047\u8bbe\u67d0\u4e2a\u64cd\u4f5c\u8ba9\u533a\u95f4 $l \\sim r$ \u589e\u52a0\u4e86 $k$\u3002\n\n\u90a3\u4e48 $\\Delta{sum^2}= \\sum_{l}^r{sum} \\times 2k \\times (r-l) + (r-l)^2 \\times k^2$\t\n\n\u53d1\u73b0\u5728\u533a\u95f4\u52a0\u7684\u65f6\u5019\uff0c\u603b\u671f\u671b\u7684\u53d8\u5316\u53ea\u548c $\\sum_{l}^r{(sum \\times (r-l))}$ \u4e0e $\\sum_{l}^r{(r-l)^2}$ \u6709\u5173\uff0c\u540e\u8005\u53ea\u9700\u8981\u9884\u5904\u7406\u5373\u53ef\u3002\u524d\u8005\u5219\u53ef\u4ee5\u5229\u7528\u540e\u8005\u7ef4\u62a4:\n\n$(\\sum_{l}^r{sum}+k \\times (r-l)) \\times (r-l)=\\sum_{l}^r{(sum \\times (r-l))}+k(r-l)^2$\n\n\u7528\u5e26 lazy tag \u7684\u7ebf\u6bb5\u6811\u7ef4\u62a4\u5373\u53ef\u3002",
        "postTime": 1684563463,
        "uid": 127139,
        "name": "wangkeli",
        "ccfLevel": 6,
        "title": "1"
    },
    {
        "content": "[my blogs](https://www.cnblogs.com/SkyRainWind/p/17171162.html)\n\n\u9898\u89e3\uff1a\n\n~~\u300a\u661f\u4e4b\u68a6\u300b\u771f\u7684\u4e0d\u9519\uff0ckey\u9876\u5c16\u77ed\u7bc7\u4e4b\u4e00\uff0c\u63a8\u8350\u3002~~\n\n\u9996\u5148\u770b\u4e00\u4e0b\u671f\u671b\u662f\u4ec0\u4e48\uff1a\n\n\u4ece\u671f\u671b\u7684\u5b9a\u4e49\u51fa\u53d1\uff0c\u6bd4\u5982\u5148\u5728\u6839\u8282\u70b9\u5c1d\u8bd5 $sum[1..n]$ \u6b21\uff0c\u90a3\u4e48\u6839\u636e\u6982\u7387\u5f97\u6709 $sum[1..mid]$ \u4e2a\u60c5\u51b5\u8dd1\u5230\u5de6\u5b50\u6811\u4e2d\uff0c$sum[mid+1..n]$ \u8dd1\u5230\u53f3\u5b50\u6811\u4e2d\uff0c\u4e5f\u5c31\u662f\u8bf4\u8fd9\u4e00\u6b21\u5bf9\u4e8e\u671f\u671b\u7684\u8d21\u732e\u5c31\u662f $\\frac{sum[1..mid]^2+sum[mid+1..n]^2}{sum[1..n]}$\uff08\u5e73\u65b9\u662f\u56e0\u4e3a\u5c1d\u8bd5\u4e86\u8fd9\u4e48\u591a\u6b21\uff0c\u5e76\u4e14\u8fd9\u4e00\u6b21\u7684\u6743\u503c\u4e5f\u662f\u8fd9\u4e2a\u503c\u3002\uff09\n\n\u9012\u5f52\u4e0b\u53bb\u6211\u4eec\u5c31\u53d1\u73b0\u6700\u540e\u7684\u671f\u671b\u503c\u5c31\u662f $\\frac{A}{sum[1..n]}$\uff0c\u5176\u4e2d $A$ \u5c31\u662f\u5bf9\u4e8e\u7ebf\u6bb5\u6811\u4e0a\u6bcf\u4e00\u4e2a\u70b9 $i$\uff0c\u8fd9\u4e2a\u70b9\u4ee3\u8868\u7684\u533a\u95f4 $[l..r]$ \u7684\u6743\u503c\u548c $A_i$\uff0c\u6c42\u8fd9\u4e2a\u548c\u7684\u5e73\u65b9\u518d\u5bf9\u6240\u6709\u70b9\u6c42\u548c\u5f97\u5230\uff08$A=\\sum A_i^2$\uff09\n\n\u73b0\u5728\u8981\u5e26\u4fee\u6539\uff0c\u8003\u8651\u600e\u4e48\u533a\u95f4\u4fee\u6539\u7684\u540c\u65f6\u7ef4\u62a4 $A$\u3002\n\n\u8003\u8651\u5bf9\u4e8e\u7ebf\u6bb5\u6811\u4e00\u4e2a\u70b9 $i$ \uff0c\u5982\u679c\u8fd9\u4e2a\u70b9\u5bf9\u5e94\u7684\u533a\u95f4 $[l..r]$ \u4e2d\u6240\u6709\u6570\u90fd $+v$\uff0c\u90a3\u4e48 $A$ \u5982\u4f55\u53d8\u5316\uff08\u8003\u8651\u8fd9\u4e2a\u662f\u56e0\u4e3a\u6211\u4eec\u8981\u6253\u61d2\u6807\u8bb0\uff0c\u56e0\u6b64\u5fc5\u987b\u9884\u5148\u77e5\u9053\u8fd9\u4e2a\u533a\u95f4\u7684\u53d8\u5316\uff09\uff1f\n\n$\\Delta A_i=(sum[l..r]+len\\times v)^2-sum[l..r]^2=2\\times sum[l..r]$ $\\times v \\times len +\\ len^2\\times v^2 $\n\n\u56e0\u6b64\u53ea\u9700\u8981\u7ef4\u62a4 $\\sum sum[l..r]\\times len$ \u548c $\\sum len^2$ \u5373\u53ef\uff0c\u5176\u4e2d\u540e\u8005\u662f\u4e2a\u5e38\u91cf\uff0c\u53ef\u4ee5\u5728\u5efa\u6811\u7684\u65f6\u5019\u5904\u7406\u51fa\u6765\u3002\n\n\u8003\u8651\u524d\u8005\u8be5\u5982\u4f55\u7ef4\u62a4\uff0c$(sum[l..r]+v\\times len)\\times len = sum[l..r]\\times len+len^2\\times v$ \uff0c\u56e0\u6b64\u53ea\u9700\u8981\u501f\u52a9 $\\sum len^2$ \u5373\u53ef\uff08\u6ce8\u610f\u8fd9\u91cc\u53ea\u662f\u5bf9 $i$ \u7ed3\u70b9\u6765\u8bf4\u7684\uff0c\u4f46\u662f\u6211\u4eec\u9700\u8981\u7684\u662f\u8fd9\u4e2a\u70b9\u53ca\u5b50\u6811\u7684\u548c\uff0c\u56e0\u6b64\u6211\u4eec\u9700\u8981 $\\sum len^2$\uff09\n\npushup \u4e5f\u5f88\u597d\u5199\uff0c\u6309\u5b9a\u4e49\u7ef4\u62a4\u53d8\u91cf\u5373\u53ef\u3002\n\n**\u7ebf\u6bb5\u6811\u533a\u95f4\u4fee\u6539\u61d2\u6807\u8bb0\u7684\u672c\u8d28\u5c31\u662f\u80fd\u5bf9\u4e00\u4e2a\u5927\u533a\u95f4\u6574\u4f53\u64cd\u4f5c\uff0c\u800c\u4e0d\u9700\u8981\u501f\u52a9\u5c0f\u533a\u95f4\u9012\u63a8\u4e0a\u6765\uff08\u5982\u533a\u95f4\u52a0\u548c\uff0c\u53ef\u4ee5 $sum[l..r]+len\\times v$ \u800c\u4e0d\u5fc5\u501f\u52a9\u5b50\u6811\uff09\uff0c\u5728\u672c\u9898\u4e2d\u4e5f\u662f\u4e00\u6837\uff0c\u501f\u52a9 $\\sum len^2$ \u548c $\\sum sum[l..r]\\times len$\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5b9e\u73b0\u5bf9\u533a\u95f4\u7684\u6574\u4f53\u64cd\u4f5c\uff0c\u5176\u5b9e\u8fd9\u4e5f\u662f pushdown \u80fd\u8fdb\u884c\u7684\u57fa\u7840**\n\n\u4ee3\u7801\uff0c\u6ce8\u91ca\u5f88\u8be6\u7ec6\u4e86\uff1a\n```cpp\n// by SkyRainWind\n#include <bits/stdc++.h>\n#define mpr make_pair\n#define debug() cerr<<\"Yoshino\\n\"\n#define pii pair<int,int>\n#define pb push_back\n\nusing namespace std;\n\ntypedef long long ll;\ntypedef long long LL;\n#define int __int128\n\nconst int inf = 1e9, INF = 0x3f3f3f3f, maxn = 2e5+5, mod = 998244353;\n\nint n,m,a[maxn];\nstruct segm{\n\tint l;\t// l = \\sum len^2\n\tint len;\t// \u5f53\u524d\u533a\u95f4\u957f\u5ea6 \n\tint sum,val,lazy;\t// sum \u533a\u95f4\u548c , val \\sum sum[l..r]*len \u5bf9\u5b50\u6811\u7684\u70b9\u6c42\u548c \n\tint res;\t// \u5f53\u524d\u70b9\u5b50\u6811\u4e2d\u7684\u70b9\u5bf9\u5e94\u7684\u533a\u95f4\u548c\u7684\u5e73\u65b9\u7684\u548c\uff08\u671f\u671b\u7684\u5206\u5b50\uff09 \n}se[maxn << 2];\n// S^2 -> (S+len*v)^2-S^2 = 2*S*len*v + len^2*v^2\uff0c\u5176\u4e2d S \u4e3a\u533a\u95f4\u548c \n// \u7ef4\u62a4 \\sum len^2 (\u5e38\u91cf) \\sum S*len \n\nint pw(int x,int y){\n\tif(!y)return 1;if(y==1)return x;\n\tint mid=pw(x,y>>1);\n\tif(y&1)return 1ll*mid*mid%mod*x%mod;\n\treturn 1ll*mid*mid%mod;\n}\n\nint read(){\n    char ch=getchar();int h=0,t=1;\n    while((ch>'9'||ch<'0')&&ch!='-') ch=getchar();\n    if(ch=='-') t=-1,ch=getchar();\n    while(ch>='0'&&ch<='9') h=h*10+ch-'0',ch=getchar();\n    return h*t;\n}\nvoid print(int x){if(x>9)print(x/10);putchar(x%10+'0');}\nint sq(int x){return 1ll*x*x;}\nvoid pushup(int num,int l,int r){\n\tse[num].l = se[num<<1].l + se[num<<1|1].l + sq(r-l+1);\n\tse[num].sum = se[num << 1].sum + se[num << 1|1].sum;\n\tse[num].val = se[num << 1].val + se[num << 1|1].val + (r-l+1) * se[num].sum;\n\tse[num].res = se[num << 1].res + se[num << 1|1].res + sq(se[num].sum);\n}\n\nvoid build(int x,int y,int num){\n\tse[num].len = y-x+1;\n\tif(x == y){\n\t\tse[num].l = 1;\n\t\tse[num].sum = se[num].val = a[x];\n\t\tse[num].res = sq(a[x]);\n\t\treturn ;\n\t}\n\tint mid = x+y>>1;\n\tbuild(x,mid,num <<1);build(mid+1,y,num<<1|1);\n\tpushup(num,x,y);\n}\n\nvoid add(int num,int v){\t// \u5bf9\u533a\u95f4\u80fd\u8fdb\u884c\u6574\u4f53\u64cd\u4f5c \n\tse[num].lazy += v;\n\tse[num].res += 2*se[num].val*v + se[num].l*v*v;\n\tse[num].sum += se[num].len * v;\n\tse[num].val += se[num].l * v;\n}\n\nvoid pushdown(int num,int l,int r){\n\tif(!se[num].lazy)return ;\n\tadd(num<<1,se[num].lazy);\n\tadd(num<<1|1,se[num].lazy);\n\t\n\tse[num].lazy = 0;\n}\n\nvoid upd(int x,int y,int v,int l,int r,int num){\n\tif(x<=l && r<=y){\n\t\tadd(num, v);\n\t\treturn ;\n\t}\n\tpushdown(num,l,r);\n\tint mid=l+r>>1;\n\tif(y<=mid)upd(x,y,v,l,mid,num<<1);\n\telse if(x>mid)upd(x,y,v,mid+1,r,num<<1|1);\n\telse upd(x,y,v,l,mid,num<<1), upd(x,y,v,mid+1,r,num<<1|1);\n\tpushup(num,l,r);\n}\n\nsigned main(){\n\tn=read(),m=read();\n\tfor(int i=1;i<=n;i++)a[i]=read();\n\tbuild(1,n,1);\n\twhile(m --){\n\t\tint op=read(),l,r,v;\n\t\tif(op == 2){\n\t\t\tint fz = se[1].res / __gcd(se[1].res,se[1].sum);\n\t\t\tint fm = se[1].sum / __gcd(se[1].res,se[1].sum);\n\t\t\tprint(fz%mod*pw(fm,mod-2)%mod);puts(\"\");\n\t\t}else{\n\t\t\tl=read(),r=read(),v=read();\n\t\t\tupd(l,r,v,1,n,1);\n\t\t}\n\t}\n\n\treturn 0;\n}\n```",
        "postTime": 1677727258,
        "uid": 84042,
        "name": "SkyRainWind",
        "ccfLevel": 7,
        "title": "P4927  \u9898\u89e3"
    },
    {
        "content": "# \u68a6\u7f8e\u7684\u7ebf\u6bb5\u6811 \u9898\u89e3\n\n---\n\n\u9898\u76ee\u94fe\u63a5[\u70b9\u8fd9](https://www.luogu.org/problemnew/show/P4927)\n\n\u8fd9\u9898\u6709\u70b9\u6bd2\u7624\u554a\uff0c`__int128`\u624d\u80fd\u8fc7\uff0c\u5efa\u8bae\u98df\u7528\u6d1b\u8c37ide\n\n\u4ecb\u4e8e\u524d\u9762\u4e09\u7bc7\u7684\u90fd\u6bd4\u8f83\u7384\u5b66\uff08~~\u4ee3\u7801\u90fd\u6bd4\u8f83\u4e11~~\uff09,\u6253\u7b97\u81ea\u5df1\u5199\u4e00\u53d1\n\n\u81ea\u5df1\u5199\u7684\u7ebf\u6bb5\u6811\u5e38\u6570\u5e94\u8be5\u6bd4\u5176\u4ed6\u51e0\u7bc7\u5927\u4e00\u70b9\uff0c\u4e3a\u4e86\u65b9\u4fbf\u7406\u89e3\u5427\n\n\u9996\u5148\u6570\u5b66\u671f\u671b\n\n$$E = \\sum P_i * sum_i = \u4e00\u901a\u64cd\u4f5c =  \\frac{\\sum sum_i^2}{sum_{rt}} $$\n\n![image.png-9.9kB][1]\n\n\n\u8fd9\u4e00\u6b65\u5e94\u8be5\u6bd4\u8f83\u597d\u8ba1\u7b97\uff0c\u540c\u65f6\u76f8\u4fe1\u5927\u90e8\u5206\u4eba\u90fd\u6b7b\u5728\u4e86\u8fd9\u91cc~~\u6bd4\u5982\u6211~~\n\n\u7136\u540e\u60f3\u5230\u8fd9\u9898\u4e0d\u662f\u7ebf\u6bb5\u6811\u7ef4\u62a4\u671f\u671b\uff0c\u800c\u662f\u7ef4\u62a4\u533a\u95f4\u5e73\u65b9\u548c\n\n\u5bf9\u4e8e\u4e00\u4e2a\u8282\u70b9\n\n```c++\nstruct node{\n    int sum, tag; // \u5e38\u89c4\u90fd\u533a\u95f4\u548c & \u6807\u8bb0\n    int len; \u4e5f\u5f88\u597d\u7406\u89e3\n    \n    // \u7136\u540e\u5c31\u6709\u4e9b\u5947\u602a\u90fd\u4e1c\u897f\u4e86\n    int len_2, len_sum, con;\n};\n```\n\n`con`: contribution, \u5373\u4e3a\u8be5\u8282\u70b9\u5bf9\u7b54\u6848\u5206\u5b50\u7684\u8d21\u732e\uff0c$con_rt = \\sum sum_i^2$\n\n\u56e0\u4e3acon\u6bd4\u8f83\u96be\u4ee5\u4e00\u6b65\u8ba1\u7b97\u51fa\u6765\uff0c\u6240\u4ee5\u8003\u8651\u4e00\u4e2a\u6bd4\u8f83\u5bb9\u6613\u60f3\u5230(~~\u653e\u5c41~~)\u7684\u533a\u95f4\u5e73\u65b9\u548c\n\n$sum^2$\u66f4\u65b0\u65f6\uff0c$sum_{new}^2 = (sum_{old} + tag * len)^2 = sum_{old}^2 + 2*len * tag * sum_{old} + len^2 * tag^2$\n\n\u5373 `sum +=` $2*len*tag*sum_{old} + len^2*tag^2$\n\n\u5305\u542b\u4e0a\u5b50\u8282\u70b9\u7684\u8bdd\u5c31\u662f\uff0c$\\sum sum^2$\uff0c\u4e5f\u5c31\u662f `con` \u4e86\n\n$$\\begin{align*}  \n  con & += \\sum (2*tag*(len*sum)) + \\sum (len^2 * tag^2) \\\\  \n &+= 2*tag* \\sum ((len*sum)) + tag^2 * \\sum (len^2 )  \\\\  \n\\end{align*}  $$\n\n![image.png-22.4kB][2]\n\n\n\u5bf9\u4e8e\u96be\u4ee5\u7edf\u8ba1\u7684 $\\sum ((len*sum))$ \u548c $\\sum (len^2 )$ \u8fd9\u91cc\u53d8\u53ef\u4ee5\u5355\u72ec\u7ef4\u62a4\uff0c\u8fd9\u91cc\u4fbf\u662f`Node`\u7ed3\u6784\u4f53\u91cc\u5947\u602a\u7684`len_sum, len_2`\uff0c\u6ce8\u91ca\u91cc\u6807\u6ce8\u4e86`include child nodes`\uff0c\u90fd\u662f\u5305\u542b\u5176\u5b50\u8282\u70b9\u7684\u3002\n\n\u90a3\u4e48\u8003\u8651\u8fd9\u4e24\u4e2a\u5947\u602a\u7684\u4e1c\u897f\uff0c\n\n- $\\sum (len_i^2 )$\u7b80\u5355\uff0c\u5efa\u6811\u7684\u65f6\u5019\u76f4\u63a5\u6784\u9020\u5c31\u597d\u4e86\n- \u5bf9\u4e8e$\\sum (len_i*sum_i)$\n- $ \\begin{align*}\n\\sum (len_i*sum_i)_{new} & = \\sum(len_i * (sum_i + len_i*tag)) \\\\ \n&= \\sum(len_i * sum_i + len_i^2*tag) \\\\\n&= \\sum(len_i*sum_i)_{old} + tag * \\sum len_i^2\n\\end{align*} $\n\n![image.png-27.7kB][3]\n\n\u53c8\u56de\u5230\u4e86`len_2`\n\n\u6240\u4ee5\u8fd9\u91cc\u4ee3\u7801\u91cc\u5bf9\u5e94\u7684\uff1a\n\n- `len_2`: $\\sum len_i^2$\n- `len_sum`: $\\sum(len_i*sum_i)$\n- `con`: $\\sum sum^2$,\u7b54\u6848\u7684\u5206\u5b50\u5728`con[root]`\u91cc\n\n\u8fd9\u4e48\u4e00\u6765\uff0c\u7ebf\u6bb5\u6811\u90e8\u5206\u5c31\u5f88\u6e05\u6670\u4e86\uff0c\u81ea\u8ba4\u4e3a\u81ea\u5df1\u7684\u6570\u5b66\u529f\u5e95\u5f88\u5dee\uff0c\u6240\u4ee5\u63a8\u516c\u5f0f\u7684\u65f6\u5019\u6162\u6162\u63a8\uff0c\u8ba9\u50cf\u6211\u4e00\u6837\u7684\u5f31\u667a\u90fd\u80fd\u770b\u5f97\u61c2\n\n\u672c\u6765\u60f3\u4ea4\u4e00\u53d1 `long long`\u5148\u6765\u4e2a90\u5206\u7684\uff0c\u7136\u540e\u53d1\u73b0\uff0c\u524d90\u5206\u4e5f\u8981`__int128`\uff0c\u8fd9\u4fbf\u662f\u8fd9\u9898\u6bd2\u7624\u7684\u5730\u65b9\u4e86\u3002\u4ee3\u7801\u91cf\u5230\u8fd9\u91cc\u5df2\u7ecf\u53ef\u4ee5\u4e86\uff0c\u4f55\u5fc5\u518d\u7206`long long`,\u6570\u636e\u7ed3\u6784\u914d\u9ad8\u7cbe\u6709\u610f\u601d\u5417\uff1f\u6709\u610f\u601d\u5417\uff1f\u6709\u610f\u601d\u5417\uff1f\u636e\u89c2\u5bdf\u5927\u5bb6\u90fd\u7528\u7684`__int128`\u8fc7\u7684\u3002\n\n\u4e0d\u8fc7\u542c\u90ed\u9ed1\u5eb7\u8bf4\u6700\u540e\u4e00\u4e2a\u70b9q\u662fMOD\u7684\u500d\u6570\uff08\u9898\u76ee\u4e0d\u662f\u4fdd\u8bc1\u4e0d\u662f\u500d\u6570\u7684\u5417\uff1f\uff1f\uff1f\uff09\uff0c\u6ca1\u9047\u5230\u8fd9\u4e2a\u5751\uff0c\u4e5f\u4e0d\u77e5\u9053\u662f\u4e0d\u662f\u6211\u5199\u6cd5\u7684\u539f\u56e0\uff0c`int128`\u4e4b\u540e`CE`\u4e86\u51e0\u53d1\u5c31\u8fc7\u4e86\n\n\u6700\u540e\u8f93\u51fa\u7b54\u6848\u7684\u65f6\u5019\uff0c`gcd`,`power`\u5565\u7684\uff0c\u5c31\u4e0d\u8bf4\u4e86\uff0c\u8001\u751f\u5e38\u8c08\u4e86\n\n\n```c++\n#include <bits/stdc++.h>\nusing namespace std;\ntypedef __int128 LL;\nconst int N = (1e5 + 7) << 2;\nconst LL MOD = 998244353;\n\nLL sqr(LL x){return x*x;}\nLL gcd(LL x, LL y){\n\tif (y) while((x %= y) && (y %= x));\n\treturn x + y;\n}\nLL power(LL a, LL x){\n    LL ans = 1;\n    for (; x; x >>= 1){\n        if (x & 1) ans = (ans * a) % MOD;\n        a = (a * a) % MOD;\n    }\n    return ans % MOD;\n}\n//------------head & math-------------\n\nint arr[N];\n\nstruct SegTree{\n    #define lc (rt << 1)\n    #define rc (rt << 1 | 1)\n    #define lson rt<<1, l, mid\n    #define rson rt<<1|1, mid+1, r\n\n    int n;\n    // for one Node\n    LL sum[N], len[N], tag[N];\n    LL len_2[N], len_sum[N];  // include child nodes\n    LL con[N]; // contribution, also include child nodes\n\n    // commonly pushUp\n    void pushUp(const LL &rt) {\n        sum[rt] = sum[lc] + sum[rc];\n        len_sum[rt] = len[rt]*sum[rt] + len_sum[lc] + len_sum[rc];\n        con[rt] = sqr(sum[rt]) + con[lc] + con[rc];\n    }\n\n    void Tag(const LL &rt, const LL &l, const LL &r, const LL &v){\n        sum[rt] += v * (r-l+1);\n        tag[rt] += v;\n        con[rt] += 2*v*len_sum[rt] + sqr(v)*len_2[rt];\n        len_sum[rt] += v * len_2[rt];\n    }\n\n    void pushDown(const LL &rt, const LL &l, const LL &r){\n        if (!tag[rt]) return;\n        LL mid = (l+r) >> 1;\n        Tag(lson, tag[rt]);\n        Tag(rson, tag[rt]);\n        tag[rt] = 0;\n    }\n\n    void build(const LL &rt, const LL &l, const LL &r) {\n        if (l == r) {\n            sum[rt] = len_sum[rt] = (LL)arr[l];\n            len[rt] = len_2[rt] = 1;\n            tag[rt] = 0;\n            con[rt] = sqr(sum[rt]);\n            return;\n        }\n        LL mid = (l + r) >> 1;\n        build(lson);\n        build(rson);\n        len[rt] = len[lc] + len[rc];\n        len_2[rt] = sqr(len[rt]) + len_2[lc] + len_2[rc];\n        tag[rt] = 0;\n        pushUp(rt);\n    }\n\n    void update(const LL &rt, const LL &l, const LL &r, const LL &L, const LL &R, const LL &v) {\n        if (L <= l && r <= R) {\n            Tag(rt, l, r, v);\n            return;\n        }\n        LL mid = (l + r) >> 1;\n        pushDown(rt, l, r);\n        if (L <= mid) update(lson, L, R, v);\n        if (mid <  R) update(rson, L, R, v);\n        pushUp(rt);\n    }\n\n    void query(){ // print ans;\n        LL p = con[1], q = sum[1], gd = gcd(p, q);\n        p /= gd, q /= gd;\n        //printf(\"%d, %d: \", p, q);\n        LL ans = ((p%MOD) * power(q, MOD-2)) % MOD;\n        printf(\"%lld\\n\", ans);\n    }\n\n    void print(LL rt, LL l, LL r){ // prLL tree, debug\n        printf(\"%d: [%d, %d], len = %d, len_2 = %d, sum = %d, len_sum = %d, tag = %d, con = %d\\n\", \n            rt, l, r, len[rt], len_2[rt], sum[rt], len_sum[rt], tag[rt], con[rt]);\n        if (l == r) return;\n        LL mid = (l + r) >> 1;\n        print(rt<<1, l, mid);\n        print(rt<<1|1, mid+1, r);\n    }\n} T;\n\n\nint main(){\n    //freopen(\"in.txt\", \"r\", stdin);\n    int n, m;\n    scanf(\"%d%d\", &n, &m);\n    for (LL i = 1; i <= n; i++){\n        scanf(\"%d\", &arr[i]);\n    }\n    T.build(1, 1, n);\n    //T.print(1, 1, n);\n\n    for (int op, l, r, v; m--;){\n        scanf(\"%d\", &op);\n        if (op==2) T.query();\n        else{ // update\n            scanf(\"%d%d%d\", &l, &r, &v);\n            T.update(1, 1, n, l, r, v);\n        }\n    }\n    return 0;\n}\n\n```\n\n\n\u6700\u540e\u518d\u626f\u70b9\u5565\u5462\uff0c\u81ea\u5df1\u5199\u7ed3\u6784\u4f53\u90fd\u662f\u628a\u7ed3\u6784\u4f53\u5f53\u6210`class`\u6765\u7528\u7684\uff0c\u5c31\u5f53\u662f\u5168\u662f`public`\u7684`class`\u5427\n\n`define lson, rson`\u4e5f\u662f\u4e00\u4e2a\u4ee4\u4eba\u6109\u60a6\u7684\u70b9\uff0c\u8ddf**kuangbing**\u5b66\u7684\n\n\u8fd8\u6709\u54ea\u91cc\u770b\u4e0d\u61c2\u6b22\u8fce\u79c1\u6233\u6211\u63d0\u95ee\u6216\u8005`cww970329@qq.com`\n\n\n\u6700\u540e\u6253\u4e2a\u5e7f\u544a\uff0c[csdn](https://blog.csdn.net/cww97), [github](https://github.com/cww97)\n\n\u672c\u7a3f\u5b50\u672c\u6765\u5728\u4f5c\u4e1a\u90e8\u843d\u7f16\u8f91\u7684\uff0c\u8d34\u8fc7\u6765\u540e\u53d1\u73b0latex\u6709\u4e9b\u70b8\u4e86\uff0c[\u539f\u6765\u7684\u7a3f\u5b50](https://www.zybuluo.com/cww97/note/1323775)\n\n\u9644\u4ef6\uff1a\n- \u53ef\u80fd\u70b8\u7684\u516c\u5f0f1 ![image.png-9.9kB][1]\n- \u53ef\u80fd\u70b8\u7684\u516c\u5f0f1 ![image.png-22.4kB][2]\n- \u53ef\u80fd\u70b8\u7684\u516c\u5f0f2 ![image.png-27.7kB][3]\n\n  [1]: http://static.zybuluo.com/cww97/sbubtgp27owr2xlmphc0r37e/image.png\n  [2]: http://static.zybuluo.com/cww97/lk3ty4r505gp98cym0nf46gw/image.png\n  [3]: http://static.zybuluo.com/cww97/2ejzkm8yjie22jmhyvzc6idm/image.png\n",
        "postTime": 1540576622,
        "uid": 4741,
        "name": "cww970329",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 P4927 \u3010[1007]\u68a6\u7f8e\u4e0e\u7ebf\u6bb5\u6811\u3011"
    },
    {
        "content": "#### \u63a8\u5f0f\u5b50,\u7ef4\u62a4\u6807\u8bb0\u3002\n\n\u9996\u5148\u77e5\u9053\u7ea6\u5b8c\u5206\u4ee5\u540e,\u7b54\u6848\u5c31\u662f   \n ----------------------$(\u2211sum^2)/Allsum$    \n $Allsum$\u5f88\u597d\u7ef4\u62a4,\u8003\u8651\u600e\u4e48\u7ef4\u62a4\u88ab\u533a\u95f4\u52a0\u7684$\u2211sum^2.$   \n \u8bbe\u52a0\u7684\u6570\u662f$v $  \n \u589e\u91cf  \n ----------------------=$\u2211(sum+len*v)^2-\u2211sum^2$     \n ----------------------=$\u2211(2*len*sum*v+len^2v^2)$\n\n\u6240\u4ee5\u6211\u4eec\u8981\u6709\u7684\u662f$\u2211len^2,\u2211len*sum$  (\u524d\u8005\u662f\u5e38\u91cf,\u540e\u8005\u9700\u8981\u7ef4\u62a4\u53d8\u5316)   \n\u5728\u6211\u7684\u4ee3\u7801\u4e2d,  \n$sum$\u8868\u793a\"\u771f_\u8be5\u533a\u95f4\u503c\",\n$vsum$\u662f$(\u2211sum^2)$,      \n$sumxl$\u662f$\u2211sum*len$, \n$vlen$\u662f$\u2211len^2$    \n\u5728\u4e0b\u53d1\u6807\u8bb0or modify\u65f6\u2193, $\u2211len*sum+=\u2211len^2*v$\n\n```\nvoid add(int u,int v){\n\t(t[u].lazy+=v);\n\t(t[u].vsum+=2*(t[u].sumxl)*v+(t[u].vlen)*mul(v));\n\t(t[u].sumxl+=t[u].vlen*v);\n\t(t[u].sum+=1ll*v*(t[u].len));\n}\n```\n\n----\n\n\u5b8c\u6574\u4ee3\u7801\u2193\u7528\u4e86__ int128,\u5982\u679c\u6709\u53ef\u4ee5\u4e0d\u7528\u7684\u7ae5\u978b\u8bf7\u544a\u8bc9\u6211\u60a8\u600e\u4e48\u641e\u7684\n\n----------\n```cpp\n#include<bits/stdc++.h>\n#define re(x) scanf(\"%d\",&x)\n#define ll long long\n#define int __int128\n#define mid ((l+r)>>1)\n#define lson (u<<1)\n#define rson (u<<1|1)\nusing namespace std;\nconst int N = 1e5 + 10,mod= 998244353 ;\nstruct tr{\n\tint sum,vsum,sumxl,vlen,lazy,len;\n}t[N<<2];\nint n,m;\nint mul(int a){return 1ll*a*a;}\nvoid print(int x){if(x>9)print(x/10);putchar(x%10+'0');}\nint read(){\n    char ch=getchar();int h=0,t=1;\n    while((ch>'9'||ch<'0')&&ch!='-') ch=getchar();\n    if(ch=='-') t=-1,ch=getchar();\n    while(ch>='0'&&ch<='9') h=h*10+ch-'0',ch=getchar();\n    return h*t;\n}\nint ksm(int a,int b){\n\ta%=mod;int r=1;\n\tfor(;b;b>>=1,a=a*a%mod)if(b&1)r*=a,r%=mod;\n\treturn r;\t\n}\nvoid uptag(int u){\n\tt[u].sum=t[lson].sum+t[rson].sum;\n\tt[u].vsum=(t[lson].vsum+t[rson].vsum)+mul(t[u].sum);\t\n\tt[u].sumxl=(t[lson].sumxl+t[rson].sumxl+1ll*t[u].sum*(t[u].len));\n}\nvoid add(int u,int v){\n\t(t[u].lazy+=v);\n\t(t[u].vsum+=2*(t[u].sumxl)*v+(t[u].vlen)*mul(v));\n\t(t[u].sumxl+=t[u].vlen*v);\n\t(t[u].sum+=1ll*v*(t[u].len));\n}\nvoid pushtag(int u){\n\tif(!t[u].lazy)return;\n\tint v=t[u].lazy;t[u].lazy=0;\n\tadd(lson,v);add(rson,v);\n}\nvoid build(int u,int l,int r){\n\tif(l==r){\n\t\tt[u].sum=read();\n\t\tt[u].vsum=mul(t[u].sum);\n\t\tt[u].lazy=0;\n\t\tt[u].sumxl=t[u].sum;\n\t\tt[u].vlen=t[u].len=1;\n\t\treturn;\n\t}\n\tbuild(lson,l,mid);\n\tbuild(rson,mid+1,r);\n\tt[u].vlen=(t[lson].vlen+t[rson].vlen+(r-l+1)*(r-l+1));\n\tt[u].len=r-l+1;\n\tuptag(u);\n}\nvoid modify(int u,int l,int r,int L,int R,int v){\n\tif(l>=L&&r<=R){\n\t\tadd(u,v);\n\t\treturn;\n\t}\n\tpushtag(u);\n\tif(L<=mid)modify(lson,l,mid,L,R,v);\n\tif(R>mid)modify(rson,mid+1,r,L,R,v);\n\tuptag(u);\n}\nsigned main(){\n\tn=read();m=read();\n\tbuild(1,1,n);\n\twhile(m--){\n\t\tint op=read(),l,r,v;\n\t\tif(op&1){\n\t\t\tl=read();r=read();v=read();\n\t\t\tmodify(1,1,n,l,r,v);\n\t\t}\n\t\telse{\n\t\t\tint fz=t[1].vsum/__gcd(t[1].vsum,t[1].sum);\n\t\t\tint fm=t[1].sum/__gcd(t[1].vsum,t[1].sum);\n\t\t\tprint(fz%mod*ksm(fm,mod-2)%mod);puts(\"\");\n\t\t}\n\t}\n\treturn 0;\n}\n\n```",
        "postTime": 1540364146,
        "uid": 69935,
        "name": "GUO\u5927\u4fa0",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P4927 \u3010[1007]\u68a6\u7f8e\u4e0e\u7ebf\u6bb5\u6811\u3011"
    }
]