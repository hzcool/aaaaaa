[
    {
        "content": "## [\u9898\u610f](https://blog.csdn.net/BeNoble_/article/details/79770456)\n\n\u7ed9\u4f60\u4e00\u68f5\u6811,\u6bcf\u4e2a\u70b9\u6709\u4e2a\u989c\u8272\n\n\u6bcf\u6b21\u8be2\u95ee\u4f60\u4e00\u6761\u8def\u5f84\u6c42$\\sum_{c}val_c\\sum_{i=1}^{cnt_c}worth_i$\n\n>$val$\u8868\u793a\u8be5\u989c\u8272\u7684\u4ef7\u503c,$cnt$\u8868\u793a\u5176\u51fa\u73b0\u7684\u6b21\u6570,$woeth_i$\u8868\u793a\u7b2c$i$\u6b21\u51fa\u73b0\u7684\u4ef7\u503c\n\n\u5e26\u4fee\u6539\n\n---\n\n## \u9898\u89e3\n\n\u5148\u6c42\u51fa$dfs$\u5e8f\u628a\u6811\u53d8\u6210\u5e8f\u5217\n\n\u8003\u8651\u5411\u53f3\u6269\u5c55\u4e00\u4e2a\u70b9,\u8fd9\u4e2a\u8d21\u732e\u6211\u4eec\u662f\u53ef\u4ee5$O(1)$\u7b97\u51fa\u6765\u7684\n\n>\u5047\u8bbe\u6269\u5c55\u51fa\u7684\u70b9\u662f\u7684\u989c\u8272\u662f$c,$\u90a3\u4e48$\\Delta=val_c\\times worth_{cnt_{c+1}}$\n\n\u6240\u4ee5\u53ef\u4ee5\u8003\u8651\u7528\u5e26\u4fee\u6539~~\u6811\u4e0a~~\u83ab\u961f\u6765\u6c42\n\n\u4f46\u662f\u76f4\u63a5\u7528$dfs$\u5e8f\u53bb\u6269\u5c55\u7684\u8bdd\u663e\u7136\u4f1a\u51fa\u95ee\u9898\n\n\u56e0\u4e3a\u4ed6\u4f1a\u5148\u53bb\u626b\u5b8c\u8d77\u70b9\u7684\u5b50\u6811,\u4ea7\u751f\u591a\u4f59\u7684\u8d21\u732e\n\n\u8003\u8651\u600e\u4e48\u53bb\u6389\u591a\u4f59\u7684\u8d21\u732e,\u628a\u6811\u53d8\u6210\u4e00\u4e2a\u957f$2n$\u62ec\u53f7\u5e8f\u5217\n\n\u8fd9\u6837\u7684\u8bdd\u626b\u7684\u8fc7\u7a0b\u4e2d\u8d77\u70b9\u7684\u5b50\u6811\u91cc\u7684\u70b9\u80af\u5b9a\u4f1a\u88ab\u626b\u4e24\u6b21(\u4e00\u8fdb\u4e00\u51fa)\n\n\u8fde\u7eed\u505a\u4e24\u6b21\u4e4b\u540e\u8d21\u732e\u4e3a$0$,\u6211\u4eec\u53ef\u4ee5\u60f3\u5230\u5f02\u6216\n\n>\u5373\u5f00\u4e00\u4e2a$vis$\u6570\u7ec4,\u6bcf\u6b21\u8bbf\u95ee\u5c31\u4e00\u4e2a\u70b9$u$,\u5c31$vis_u$^$=1$\n\n\u4f46\u662f\u6ce8\u610f\u5230\u51e0\u4e2a\u95ee\u9898\n\n$1.$\u5982\u679c$lca$\u4e0d\u662f\u8def\u5f84\u7aef\u70b9\u662f\u4e0d\u4f1a\u88ab\u8ba1\u7b97\u7684\n\n>\u8003\u8651\u6837\u4f8b\u7684\u62ec\u53f7\u5e8f\u5217$12443321$\n\n>\u8be2\u95ee$4\\to3$,\u90a3\u4e48\u6211\u4eec\u5f97\u5230\u7684\u533a\u95f4\u662f$[3,5]$\n\n>\u53d1\u73b0$2$\u6ca1\u6709\u88ab\u7b97\u8fdb\u6765,\u8fd9\u4e2a\u8981\u7279\u5224\n\n>\u5f53\u7136\u5982\u679c\u8d77\u70b9\u5c31\u662f$lca$\u5c31\u4e0d\u9700\u8981\u7ba1\u4e86\n\n$2.$\u5982\u679c\u8d77\u70b9\u4e0d\u662f$lca$,\u90a3\u4e48\u4ed6\u7684\u8d21\u732e\u662f\u4e0d\u4f1a\u88ab\u8ba1\u7b97\u7684\n\n>\u540c\u6837\u662f\u4e0a\u9762\u90a3\u4e2a\u4f8b\u5b50\n\n>\u6211\u4eec\u53ef\u4ee5\u770b\u5230$4$\u7684\u8d21\u732e\u88ab\u7b97\u4e24\u6b21\u62b5\u6d88\u6389\u4e86\n\n>\u6240\u4ee5\u8fd9\u79cd\u60c5\u51b5\u4e5f\u8981\u7279\u5224\n\n\u4fee\u6539\u548c\u666e\u901a\u5e26\u4fee\u6539\u83ab\u961f\u4e00\u6837,\u53ea\u8981\u52a0\u4e00\u7ef4\u65f6\u95f4\u5373\u53ef\n\n```\n#include<bits/stdc++.h>\n#define fp(i,a,b) for(register int i=a,I=b+1;i<I;++i)\n#define fd(i,a,b) for(register int i=a,I=b-1;i>I;--i)\n#define go(u) for(register int i=fi[u],v=e[i].to;i;v=e[i=e[i].nx].to)\n#define file(s) freopen(s\".in\",\"r\",stdin),freopen(s\".out\",\"w\",stdout)\ntemplate<class T>inline bool cmax(T&a,const T&b){return a<b?a=b,1:0;}\ntemplate<class T>inline bool cmin(T&a,const T&b){return a>b?a=b,1:0;}\nusing namespace std;\nchar ss[1<<17],*A=ss,*B=ss;\ninline char gc(){return A==B&&(B=(A=ss)+fread(ss,1,1<<17,stdin),A==B)?-1:*A++;}\ntemplate<class T>inline void sd(T&x){\n    char c;T y=1;while(c=gc(),(c<48||57<c)&&c!=-1)if(c==45)y=-1;x=c-48;\n    while(c=gc(),47<c&&c<58)x=x*10+c-48;x*=y;\n}\nchar sr[1<<21],z[20];int C=-1,Z;\ninline void Ot(){fwrite(sr,1,C+1,stdout),C=-1;}\ntemplate<class T>inline void we(T x){\n    if(C>1<<20)Ot();if(x<0)sr[++C]=45,x=-x;\n    while(z[++Z]=x%10+48,x/=10);\n    while(sr[++C]=z[Z],--Z);sr[++C]='\\n';\n}\nconst int N=2e5+5;\ntypedef int arr[N];\ntypedef long long ll;\nstruct Q{\n    int l,r,x,y,z,id;\n    inline bool operator<(const Q b)const{\n        if(x^b.x)return x<b.x;\n        if(y^b.y)return x&1?y<b.y:y>b.y;\n        return (x^y)&1?z<b.z:z>b.z;\n    }\n}q[N];\nstruct T{int x,c;}t[N];\nstruct eg{int nx,to;}e[N];\nint n,m,ce,dft,Sz,Sq,St,L,R,G;arr fa,fi,sz,val,wor,pos,lis,dep,son,top,col,vis,cnt;ll Now,ans[N];\nvoid dfs(int u){\n    dep[u]=dep[fa[u]]+(sz[u]=1);\n    go(u)if(v^fa[u]){\n        fa[v]=u;dfs(v),sz[u]+=sz[v];\n        if(sz[v]>sz[son[u]])son[u]=v;\n    }\n}\nvoid dfs(int u,int t){\n    top[u]=t;lis[pos[u]=++dft]=u;\n    if(son[u])dfs(son[u],t);\n    go(u)if(v^fa[u]&&v^son[u])dfs(v,v);\n    lis[++dft]=u;\n}\ninline int lca(int u,int v){\n    for(;top[u]^top[v];dep[top[u]]>dep[top[v]]?u=fa[top[u]]:v=fa[top[v]]);\n    return dep[u]<dep[v]?u:v;\n}\ninline void add(int u,int v){e[++ce]={fi[u],v},fi[u]=ce;}\ninline void sol(int x){int c=col[x];\n    (vis[x]^=1)?Now+=(ll)wor[++cnt[c]]*val[c]:Now-=(ll)wor[cnt[c]--]*val[c];\n}\ninline void mdy(int i){\n    int u=t[i].x,x=t[i].c,y=col[u];\n    vis[u]?Now+=(ll)wor[++cnt[x]]*val[x]-(ll)wor[cnt[y]--]*val[y]:0;\n    t[i].c=y,col[u]=x;\n}\nint main(){\n    #ifndef ONLINE_JUDGE\n        file(\"s\");\n    #endif\n    sd(n),sd(m);int x,y,u,v,g=0;sd(x);\n    fp(i,1,m)sd(val[i]);\n    fp(i,1,n)sd(wor[i]);m=x;\n    fp(i,2,n)sd(u),sd(v),add(u,v),add(v,u);\n    fp(i,1,n)sd(col[i]);\n    dfs(1),dfs(1,1);\n    while(m--){\n        sd(x);\n        if(x){\n            sd(x),sd(y);if(pos[x]>pos[y])swap(x,y);\n            q[++Sq]={x,y,pos[x],pos[y],St,Sq};\n        }else sd(x),sd(y),t[++St]={x,y};\n    }Sz=pow(n,St?2.0/3:1.0/2);\n    fp(i,1,Sq)q[i].x/=Sz,q[i].y/=Sz;\n    sort(q+1,q+Sq+1);L=pos[q[1].l],R=L-1;\n    fp(i,1,Sq){\n        x=pos[u=q[i].l],y=pos[v=q[i].r],g=q[i].z;\n        while(L>x)sol(lis[--L]);\n        while(R<y)sol(lis[++R]);\n        while(L<x)sol(lis[L++]);\n        while(R>y)sol(lis[R--]);\n        while(G<g)mdy(++G);\n        while(G>g)mdy(G--);\n        int p=lca(u,v);\n        if(u^p){sol(u);if(v^p)sol(p);}\n        ans[q[i].id]=Now;\n        if(u^p){sol(u);if(v^p)sol(p);}\n    }\n    fp(i,1,Sq)we(ans[i]);\nreturn Ot(),0;\n}\n```",
        "postTime": 1522484285,
        "uid": 20156,
        "name": "Kelin",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P4074 \u3010[WC2013]\u7cd6\u679c\u516c\u56ed\u3011"
    },
    {
        "content": "# \u9898\u89e3\n\n------------\n\u5148\u634b\u4e00\u4e0b[\u9898\u610f](https://www.luogu.com.cn/problem/P4074)\u3002\n\n\u7ed9\u5b9a\u4e00\u68f5\u6811\uff0c\u6bcf\u6b21\u8be2\u95ee\u4efb\u610f\u4e24\u70b9\u95f4\u7684\u4e00\u6761\u94fe\u4e0a\u7684\u76f8\u5173\u4fe1\u606f\uff0c\u6216\u4fee\u6539\u4efb\u610f\u4e00\u4e2a\u70b9\u3002\n\n------------\n\n\u6ca1\u9519\uff0c\u8fd9\u9053\u9898\u53ef\u4ee5\u7528\u6811\u4e0a\u83ab\u961f\uff08\u5e26\u4fee\u6539\uff09\u6765\u505a\u3002\n\n\u5982\u679c\u4f60\u8fd8\u4e0d\u4e86\u89e3\u83ab\u961f\u7b97\u6cd5\uff0c\u8bf7\u770b\u4e0b\u5217\u4f8b\u9898\u3002\n\n [P3901 \u6570\u5217\u627e\u4e0d\u540c](https://www.luogu.com.cn/problem/P3901)\n\n [P1903 \u6570\u989c\u8272](https://www.luogu.com.cn/problem/P1903)\n\n\u7b2c\u4e8c\u9898\u7684\u83ab\u961f\u5e26\u4fee\u6539\uff0c\u5c31\u662f\u672c\u9898\u7684\u6838\u5fc3\u3002\n\n------------\n\u83ab\u961f\u7ef4\u62a4\u533a\u95f4\uff0c\u6240\u4ee5\u5148\u7528\u6b27\u62c9\u5e8f\u5c06\u6811\u8f6c\u5316\u4e3a\u5e8f\u5217\u3002\n\n\u4f60\u4f1a\u53d1\u73b0\u4e24\u70b9\u95f4\u7684\u8def\u5f84\u4fbf\u662f\u6b64\u5e8f\u5217\u7684\u8fd9\u4e24\u70b9\u5728\u6b27\u62c9\u5e8f\u5bf9\u5e94\u4f4d\u7f6e\u7684\u533a\u95f4\u3002\n\n\u4f46\u6b64\u533a\u95f4\u6709\u4e9b\u8282\u70b9\u53ef\u80fd\u4f1a\u51fa\u73b0\u4e24\u6b21\uff0c\u8fd9\u6837\u7684\u70b9\u4e0d\u7b97\u5728\u533a\u95f4\u5185\u3002\n\n\u4ee5\u4e0a\u60c5\u51b5\u662f\u5176\u4e2d\u4e00\u70b9\u662f\u53e6\u4e00\u70b9\u7684\u7236\u4eb2\u6216\u7236\u4eb2\u7684\u7236\u4eb2\u6216\u7236\u4eb2\u7684\u7236\u4eb2\u7684\u7236\u4eb2...\uff08\u5176\u5b9e\u5c31\u662f\u7956\u5148\uff09\u3002\n\n\u800c\u5982\u679c\u4ed6\u4eec\u6709\u516c\u5171\u7956\u5148\uff0c\u90a3\u4e48\u8fd9\u4e2a\u516c\u5171\u7956\u5148\u9700\u8981\u989d\u5916\u8ba1\u7b97\uff0c\u6240\u4ee5\u8981\u7528\u5230 lca \u6765\u6c42\u3002\n\n [P3379 \u6700\u8fd1\u516c\u5171\u7956\u5148\uff08LCA\uff09](https://www.luogu.com.cn/problem/P3379)\n\n\u5176\u4ed6\u7684\u5c31\u662f\u6b63\u5e38\u7684\u83ab\u961f\u548c\u4fee\u6539\u5566\u3002\n\n \u4ee5\u4e0b\u5c31\u662f\u672c  \u849f\u84bb  \u7684\u4ee3\u7801\u3002\n\n```cpp\n#include<bits/stdc++.h>\n#define ll long long\nusing namespace std;\nconst int maxn=1e5+5;\nint n,m,q,uu,vv,c[maxn],opt,l=0,r=0,tt=0;\nll v[maxn],w[maxn],ans[maxn],sum;\nstruct node{\n\tint to,next;\n}e[maxn*2];\nint tot,head[maxn*2];\nvoid add(int u,int v)\n{\n\te[++tot].to=v;\n\te[tot].next=head[u];\n\thead[u]=tot;\n}\nint in[maxn],out[maxn],kk;\nint back[maxn*2],deep[maxn],f[maxn];\nint fa[maxn][21],vis[maxn];\nvoid dfs(int u,int ff)\n{\n\tf[u]=ff;\n\tin[u]=++kk;back[kk]=u;\n\tfor(int i=head[u];i;i=e[i].next)\n\t{\n\t\tint v=e[i].to;\n\t\tif(v==ff) continue;\n\t\tdfs(v,u);\n\t}\n\tout[u]=++kk;back[kk]=u;\n}\nvoid dfslca(int u)\n{\n\tvis[u]=1;\n\tfor(int i=1;(1<<i)<=deep[u];i++)\n\t{\n\t\tfa[u][i]=fa[fa[u][i-1]][i-1];\n\t}\n\tfor(int i=head[u];i;i=e[i].next)\n\t{\n\t\tint v=e[i].to;\n\t\tif(vis[v]) continue;\n\t\tdeep[v]=deep[u]+1;\n\t\tdfslca(v);\n\t}\n}\nint bl,t[maxn],flag[maxn],qq,rr;\nstruct ques{\n\tint u,v,lca,l,r,id,t;\n}qu[maxn];\nstruct point{\n\tint pos,candy;\n}re[maxn];\nbool cmp(ques a,ques b)\n{\n\tif(a.l/bl==b.l/bl)\n\t{\n\t\tif(a.r/bl==b.r/bl) return a.t<b.t;\n\t\treturn a.r<b.r;\n\t}\n\treturn a.l/bl<b.l/bl;\n}\nint LCA(int x,int y)\n{\n\tif(deep[x]<deep[y])\n\tswap(x,y);\n\tint h=deep[x]-deep[y];\n\tfor(int i=0;(1<<i)<=h;i++)\n\t{\n\t\tif((1<<i)&h) x=fa[x][i];\n\t}\n\tif(x==y) return x;\n\tfor(int i=20;i>=0;i--)\n\t{\n\t\tif(fa[x][i]!=fa[y][i])\n\t\t{\n\t\t\tx=fa[x][i];\n\t\t\ty=fa[y][i];\n\t\t}\n\t}\n\treturn fa[x][0];\n}\nvoid change(int x)\n{\n\tif(flag[re[x].pos]==1)\n\t{\n\t\tt[c[re[x].pos]]--;\n\t\tsum-=w[t[c[re[x].pos]]+1]*v[c[re[x].pos]];\n\t\tt[re[x].candy]++;\n\t\tsum+=w[t[re[x].candy]]*v[re[x].candy];\n\t}\n\tswap(re[x].candy,c[re[x].pos]);\n}\n\nint main()\n{\n\tscanf(\"%d%d%d\",&n,&m,&q);\n\tfor(int i=1;i<=m;i++) scanf(\"%lld\",&v[i]);\n\tfor(int i=1;i<=n;i++) scanf(\"%lld\",&w[i]);\n\tfor(int i=1;i<=n-1;i++)\n\t{\n\t\tscanf(\"%d%d\",&uu,&vv);\n\t\tadd(uu,vv);\n\t\tadd(vv,uu);\n\t}\n\tfor(int i=1;i<=n;i++) scanf(\"%d\",&c[i]);\n\tdfs(1,1);//\u6b27\u62c9\u5e8f\n\tfor(int i=1;i<=n;i++) fa[i][0]=f[i];\n\tdfslca(1);\n\tbl=sqrt(2*n);\n\tfor(int i=1;i<=q;i++)\n\t{\n\t\tscanf(\"%d\",&opt);\n\t\tscanf(\"%d%d\",&uu,&vv);\n\t\tif(opt==0)//\u5355\u70b9\u4fee\u6539 \n\t\t{\n\t\t\tre[++rr].pos=uu;\n\t\t\tre[rr].candy=vv;\n\t\t}\n\t\tif(opt==1)//\u94fe\u67e5\u8be2 \n\t\t{\n\t\t\tqu[++qq].lca=LCA(uu,vv);\n\t\t\tqu[qq].id=qq;\n\t\t\tqu[qq].t=rr;\n\t\t\tqu[qq].u=uu;qu[qq].v=vv;\n\t\t\tif(in[qu[qq].u]>in[qu[qq].v])\n\t\t\tswap(qu[qq].u,qu[qq].v);//\u6b27\u62c9\u5e8fu\u5728\u524d\n\t\t\tif(qu[qq].lca==qu[qq].u)\n\t\t\t{\n\t\t\t\tqu[qq].l=in[qu[qq].u];\n\t\t\t\tqu[qq].r=in[qu[qq].v];\n\t\t\t\tqu[qq].lca=0;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tqu[qq].l=out[qu[qq].u];\n\t\t\t\tqu[qq].r=in[qu[qq].v];\n\t\t\t}\n\t\t}\n\t}\n\tsort(qu+1,qu+qq+1,cmp);\n\tfor(int i=1;i<=qq;i++)\n\t{\n\t\twhile(l<qu[i].l)\n\t\t{\n\t\t\tflag[back[l]]--;\n\t\t\tif(flag[back[l]]==1) t[c[back[l]]]++;\n\t\t\tif(flag[back[l]]==0) t[c[back[l]]]--;\n\t\t\tif(flag[back[l]]==0)\n\t\t\tsum-=w[t[c[back[l]]]+1]*v[c[back[l]]];\n\t\t\tif(flag[back[l]]==1)\n\t\t\tsum+=w[t[c[back[l]]]]*v[c[back[l]]];\n\t\t\tl++;\n\t\t}\n\t\twhile(l>qu[i].l)\n\t\t{\n\t\t\tflag[back[--l]]++;\n\t\t\tif(flag[back[l]]==1) t[c[back[l]]]++;\n\t\t\tif(flag[back[l]]==2) t[c[back[l]]]--;\n\t\t\tif(flag[back[l]]==2)\n\t\t\tsum-=w[t[c[back[l]]]+1]*v[c[back[l]]];\n\t\t\tif(flag[back[l]]==1)\n\t\t\tsum+=w[t[c[back[l]]]]*v[c[back[l]]];\n\t\t}\n\t\twhile(r<qu[i].r)\n\t\t{\n\t\t\tflag[back[++r]]++;\n\t\t\tif(flag[back[r]]==1) t[c[back[r]]]++;\n\t\t\tif(flag[back[r]]==2) t[c[back[r]]]--;\n\t\t\tif(flag[back[r]]==2)\n\t\t\tsum-=w[t[c[back[r]]]+1]*v[c[back[r]]];\n\t\t\tif(flag[back[r]]==1)\n\t\t\tsum+=w[t[c[back[r]]]]*v[c[back[r]]];\n\t\t}\n\t\twhile(r>qu[i].r)\n\t\t{\n\t\t\tflag[back[r]]--;\n\t\t\tif(flag[back[r]]==1) t[c[back[r]]]++;\n\t\t\tif(flag[back[r]]==0) t[c[back[r]]]--;\n\t\t\tif(flag[back[r]]==0)\n\t\t\tsum-=w[t[c[back[r]]]+1]*v[c[back[r]]];\n\t\t\tif(flag[back[r]]==1)\n\t\t\tsum+=w[t[c[back[r]]]]*v[c[back[r]]];\n\t\t\tr--;\n\t\t}\n\t\twhile(tt<qu[i].t) change(++tt);\n\t\twhile(tt>qu[i].t) change(tt--);\n\t\tif(qu[i].lca)\n\t\t{\n\t\t\tt[c[qu[i].lca]]++;\n\t\t\tsum+=w[t[c[qu[i].lca]]]*v[c[qu[i].lca]];\n\t\t}\n\t\tans[qu[i].id]=sum;\n\t\tif(qu[i].lca)\n\t\t{\n\t\t\tt[c[qu[i].lca]]--;\n\t\t\tsum-=w[t[c[qu[i].lca]]+1]*v[c[qu[i].lca]];\n\t\t}\n\t}\n\tfor(int i=1;i<=qq;i++)\n\tprintf(\"%lld\\n\",ans[i]);\n\treturn 0;\n}\n```\n\u90fd\u770b\u5230\u8fd9\u91cc\u4e86\uff0c\u80fd\u70b9\u4e2a\u8d5e\u5417\uff1f\u8c22\u8c22\u8d44\u74f7\u3002",
        "postTime": 1595771124,
        "uid": 238813,
        "name": "\u68ee\u68ee",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P4074 \u3010[WC2013]\u7cd6\u679c\u516c\u56ed\u3011"
    },
    {
        "content": "\u6765\u4e00\u53d1\u76f4\u63a5\u5728\u6811\u4e0a\u66b4\u529b\u5206\u5757\u7684\u9898\u89e3\uff01  \n\n\n\u770b\u5230\u9898\u89e3\u91cc\u5404\u4f4d\u5927\u4f6c\u5199\u7684\u4ec0\u4e48\u62ec\u53f7\u5e8f\u5217\uff0c\u53ef\u662f\u849f\u84bb\u8868\u793a\u6839\u672c\u4e0d\u4f1a\u554a QAQ  \n\u4e8e\u662f\u6211\u5199\u4e86\u4e00\u7bc7\u5728\u6811\u4e0a\u5206\u5757\u7684\u9898\u89e3\n\n\u8fd8\u8bb0\u5f97\u5f53\u65f6\u662f\u600e\u4e48\u8ba9\u83ab\u961f\u4f18\u5316\u533a\u95f4\u4fee\u6539+\u67e5\u8be2\u95ee\u9898\u7684\u5417\uff1f\u5c31\u662f\u5206\u5757+\u6392\u5e8f\u3002\u73b0\u5728\u95ee\u9898\u8dd1\u5230\u4e86\u6811\u4e0a\uff0c\u600e\u4e48\u5206\u5757\u5462\uff1f  \n\n\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u8fd9\u6837\u6765\u5206\u5757\uff1a  \n\u4ece\u4efb\u610f\u8282\u70b9\u4f5c\u4e3a\u6839\uff0c\u5f00\u59cb $\\text{dfs}$\uff0c\u6bcf\u7ecf\u8fc7\u4e00\u4e2a\u70b9\u5c31\u628a\u5b83\u538b\u8fdb\u6808\u91cc\u3002  \n\n\u5f53\u4e00\u4e2a\u8282\u70b9\u5230\u6808\u9876\u7684\u957f\u5ea6\u5927\u4e8e\u5206\u5757\u5927\u5c0f\u65f6\uff0c\u5c31\u628a\u7684\u8fd9\u90e8\u5206\u7684\u70b9\u5168\u90e8\u5f39\u51fa\uff0c\u5e76\u5206\u4e3a\u4e00\u5757\u3002  \n\u5bf9\u4e8e\u6700\u540e\u5269\u4e0b\u6765\u7684\u70b9\uff0c\u5355\u72ec\u518d\u5206\u4e00\u5757\u3002  \n\n\u5177\u4f53\u662f\u4ec0\u4e48\u6837\u7684\u5462\uff1f\u8fd9\u91cc\u501f\u7528\u4e86\u4e00\u5f20\u56fe\u6765\u89e3\u91ca\uff1a    \n![](https://cdn.luogu.com.cn/upload/pic/47657.png)  \n\n\u6b64\u5904\u5757\u7684\u5927\u5c0f\u4e3a$3$\uff0c\u6309\u7167\u6211\u4eec\u521a\u624d\u8bf4\u7684\u65b9\u6cd5\uff0c\u4ee5\u9876\u7aef\u90a3\u4e2a\u8282\u70b9\u4e3a\u6839\uff0c\u5c31\u5206\u6210\u4e86\u8fd9\u6837\u3002 \u00a0\n\n\u5177\u4f53\u4ee3\u7801\u5b9e\u73b0\u5982\u4e0b\uff1a  \n```cpp\nvoid dfs(int u,int fa){\n    int bottom = top; //top\u662f\u4e00\u4e2a\u5168\u5c40\u53d8\u91cf,\u521d\u59cb\u4e3a0\n    stack[++top] = u; //\u5f53\u524d\u8282\u70b9\u5165\u6808\n    int v,l = adj[u].size();\n    for(int i=0;i<l;++i){\n        v = adj[u][i];\n        if(v==fa) continue;\n        dfs(v,u);\n        if(top-bottom>block){//\u6808\u9876\u5230\u5f53\u524d\u8282\u70b9\u7684\u957f\u5ea6\u5927\u4e8e\u5206\u5757\u5927\u5c0f\n            ++idx;\n            while(top!=bottom) be[stack[top--]] = idx; //\u5f39\u51fa\u8fd9\u90e8\u5206\u5143\u7d20,\u5206\u4e3a\u4e00\u5757(be[i]\u8868\u793ai\u8282\u70b9\u5c5e\u4e8e\u54ea\u4e00\u5757)\n        }\n    }\n}\n```  \n\u5206\u5757\u7684\u95ee\u9898\u89e3\u51b3\u4e86\uff0c\u6392\u5e8f\u53c8\u8be5\u600e\u4e48\u529e\uff1f \n\n\u8ddf\u666e\u901a\u5e8f\u5217\u4e0a\u7684\u83ab\u961f\u65b9\u6cd5\u5dee\u4e0d\u591a\uff1a  \n\u4ee5\u4e24\u7aef\u8282\u70b9 **\u6240\u5c5e\u7684\u5757** \u4e3a\u7b2c\u4e00\u3001\u4e8c\u5173\u952e\u5b57\uff0c\u4ee5\u65f6\u95f4\u4e3a\u7b2c\u4e09\u5173\u952e\u5b57\u6392\u5e8f\u3002  \n```cpp\nbool cmp(query a,query b){\n\t//u,v\u662f\u8be2\u95ee\u8def\u5f84\u7684\u4e24\u7aef\u8282\u70b9\n    if(be[a.u]==be[b.u]){\n        if(be[a.v]==be[b.v]) return a.t<b.t;\n        return be[a.v]<be[b.v];\n    }\n    return be[a.u]<be[b.u];\n}\n```  \n\u6700\u540e\uff0c\u4e5f\u662f\u6700\u96be\u641e\u7684\u95ee\u9898\uff1a\u533a\u95f4\u79fb\u52a8\u3002   \n\u4e4d\u4e00\u770b\u597d\u50cf\u6ca1\u4ec0\u4e48\u96be\u7684\uff0c~~\u5b9e\u9645\u4e0a\u4e5f\u6ca1\u4ec0\u4e48\u96be\u7684\u3002~~  \n\n\u4e00\u4e2a\u8282\u70b9\u8981\u4ece $u$ \u79fb\u5230 $v$ \u7684\u8bdd\uff0c\u8ba9\u5b83\u4eec\u4e0d\u65ad\u5730\u5411\u4e0a\u8df3\uff0c\u76f4\u5230\u8df3\u5230\u4e00\u8d77\u3002\u8fd9\u6837\u505a\u7b49\u4ef7\u4e8e\u4e00\u4e2a\u70b9\u79fb\u5230\u53e6\u4e00\u4e2a\u70b9\u3002  \n\n\u8df3\u7684\u8fc7\u7a0b\u4e2d\uff0c\u7528\u4e00\u4e2a\u6570\u7ec4 $\\text{vis}$ \u8868\u793a\u8be5\u8282\u70b9\u5728\u4e0d\u5728\u67e5\u8be2\u7684\u8def\u5f84\u4e0a\u3002    \n\u6bcf\u5230\u4e00\u4e2a\u70b9\uff0c\u5982\u679c\u4ee5\u524d\u5728\u8def\u5f84\u4e0a\uff0c\u90a3\u73b0\u5728\u80af\u5b9a\u5c31\u4e0d\u5728\u4e86\uff1b\u53cd\u4e4b\u4ea6\u7136\u3002  \n\u968f\u7740\u8fd9\u6837\u4e0d\u65ad\u5730\u66f4\u65b0\u7ecf\u8fc7\u7684\u8282\u70b9\u5c31\u5b8c\u6210\u4e86\u533a\u95f4\u79fb\u52a8\u3002  \n\n\u7ed3\u679c\u4f60\u53d1\u73b0\uff0c\u5982\u679c\u79fb\u52a8\u8282\u70b9\u65f6\uff0c\u8981\u8de8\u8fc7 $\\text{lca}(u,v)$ \u7684\u8bdd\uff0c\u8fd8\u662f\u4f1a\u6709\u95ee\u9898\uff0c\u5982\u4e0b\u56fe\uff1a  \n\n![](https://cdn.luogu.com.cn/upload/pic/47666.png)\n\n\u5f53\u6211\u4eec\u6309\u4e0a\u8ff0\u6b65\u9aa4\u628a $u$ \u79fb\u5230 $u'$\uff0c$v$ \u79fb\u5230 $v'$\u65f6\uff0c\u6211\u4eec\u53d1\u73b0\uff1a  \n$\\text{lca}(u,v)$ \u548c $\\text{lca}(u',v')$\uff0c\u4e5f\u5c31\u662f\u88ab\u5708\u7ea2\u7684\u90a3\u4e24\u4e2a\u70b9\u90fd\u88ab\u6807\u8bb0\u4e86\u4e24\u6b21\uff0c\u4e5f\u5c31\u662f\u8bf4\u6807\u8bb0\u72b6\u6001\u6ca1\u6709\u6539\u53d8\u3002  \n\n\u90a3\u8fd9\u597d\u529e\uff0c\u6700\u540e\u518d\u66f4\u65b0\u4e00\u4e0b\u8fd9\u4e24\u4e2a\u8282\u70b9\uff0c\u8f7b\u677e\u89e3\u51b3\u95ee\u9898\u3002 \n\n\u5bf9\u4e8e\u66f4\u65b0\u64cd\u4f5c\uff0c\u53ef\u4ee5\u7ef4\u62a4\u4e00\u4e2a\u6570\u7ec4 $\\text{num}$\uff0c\u8bb0\u5f55\u8def\u5f84\u4e0a\u5404\u79cd\u7cd6\u679c\u6709\u591a\u5c11\u4e2a\u3002\u5f53\u8def\u5f84\u4e0a\u589e/\u51cf\u7b2c $i$\n\u79cd\u7cd6\u679c\u65f6\uff0c\u5bf9\u7ed3\u679c\u7684\u8d21\u732e\u662f $\\text{w}[\\text{num}[i]]\\times\\text{v}[i]$\uff0c\u968f\u4fbf\u63a8\u4e00\u4e0b\u5c31\u51fa\u6765\u4e86\u3002\n\n\u6700\u540e\uff0c\u786e\u5b9a\u5206\u5757\u7684 $\\text{dfs}$ \u53ef\u4ee5\u548c\u6c42 $\\text{lca}$ \u7684\u9884\u5904\u7406\u5199\u5728\u4e00\u8d77\uff0c\u51cf\u5c11\u7801\u91cf\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\text O (n^\\frac53)$\n\n\u4ee3\u7801\u5982\u4e0b\uff1a  \n```cpp\n#include<cstdio>\n#include<iostream>\n#include<algorithm>\n#include<cstring>\n#include<cmath>\n#include<queue>\n#include<vector>\n#define N 100003\n#define reg register\n#define ll long long\nusing namespace std;\n\nstruct query{\n    int u,v,t,id;\n    query(int u=0,int v=0,int t=0,int id=0):u(u),v(v),t(t),id(id){}\n};\n\nstruct change{\n    int u,last,next;\n    change(int u=0,int last=0,int next=0):u(u),last(last),next(next){}\n};\n\nquery q[N];\nchange c[N];\nint val[N],w[N],fa[N],depth[N],son[N],stack[N];\nint sub[N],top[N],be[N],clr[N],sum[N];\nbool vis[N];\nint n,m,T,tp,block,idx;\nll res;\nll ans[N];\nvector<int> adj[N];\n\ninline void swap(int &aa,int &bb){\n\taa ^= bb;\n\tbb ^= aa;\n\taa ^= bb;\n}\n\ninline void read(int &x){\n    x = 0;\n    char c = getchar();\n    while(c<'0'||c>'9') c = getchar();\n    while(c>='0'&&c<='9'){\n        x = (x<<3)+(x<<1)+(c^48);\n        c = getchar();\n    }\n}\n\nvoid print(ll x){\n    if(x>9) print(x/10);\n    putchar(x%10+'0');\n}\n\nvoid dfs1(int u,int f){\n    int bt = tp;\n    stack[++tp] = u;\n    fa[u] = f;\n    depth[u] = depth[f]+1;\n    sub[u] = 1;\n    int v,t = -1,l = adj[u].size();\n    for(int i=0;i<l;++i){\n        v = adj[u][i];\n        if(v==f) continue;\n        dfs1(v,u);\n        if(tp-bt>block){\n            ++idx;\n            while(tp!=bt) be[stack[tp--]] = idx;\n        }\n        sub[u] += sub[v];\n        if(sub[v]>t){\n            t = sub[v];\n            son[u] = v;\n        }\n    }\n}\n\nvoid dfs2(int u,int f){\n    top[u] = f;\n    if(son[u]==0) return;\n    dfs2(son[u],f);\n    int v,l = adj[u].size();\n    for(int i=0;i<l;++i){\n        v = adj[u][i];\n        if(v==fa[u]||v==son[u]) continue;\n        dfs2(v,v);\n    }\n}\n\ninline int lca(int u,int v){\n    while(top[u]!=top[v]){\n        if(depth[top[u]]<depth[top[v]])\n            swap(u,v);\n        u = fa[top[u]];    \n    }\n    if(depth[u]<depth[v]) return u;\n    return v;\n}\n\ninline bool cmp(query a,query b){\n    if(be[a.u]==be[b.u]){\n        if(be[a.v]==be[b.v]) return a.t<b.t;\n        return be[a.v]<be[b.v];\n    }\n    return be[a.u]<be[b.u];\n}\n\ninline void add(int u){\n    ++sum[u];\n    res += (ll)w[sum[u]]*val[u];\n}\n\ninline void del(int u){\n    res -= (ll)w[sum[u]]*val[u];\n    --sum[u];\n}\n\ninline void update(int u){\n    if(vis[u]) del(clr[u]),vis[u] = false;\n    else add(clr[u]),vis[u] = true;\n}\n\ninline void modify(int u,int t){\n    if(vis[u]){\n        del(clr[u]);\n        add(t);\n    }\n    clr[u] = t;\n}\n\nvoid move(int u,int v){\n    if(depth[u]<depth[v]) swap(u,v);\n    while(depth[u]>depth[v]){\n        update(u);\n        u = fa[u];\n    }\n    while(u!=v){\n        update(u),update(v);\n        u = fa[u],v = fa[v];\n    }\n}\n\nint main(){\n    int op,t,qc,u,v;\n    read(n),read(m),read(T);\n    block = pow(n,2.0/3);\n    for(reg int i=1;i<=m;++i) read(val[i]);\n    for(reg int i=1;i<=n;++i) read(w[i]);\n    for(reg int i=1;i<n;++i){\n        read(u),read(v);\n        adj[u].push_back(v);\n        adj[v].push_back(u);\n    }\n    for(reg int i=1;i<=n;++i){\n        read(clr[i]);\n        stack[i] = clr[i];\n    }\n    t = qc = 0;\n    for(reg int i=1;i<=T;++i){\n        read(op),read(u),read(v);\n        if(op==0){\n            c[++t] = change(u,stack[u],v);\n            stack[u] = v;\n        }else{\n            ++qc;\n            q[qc] = query(u,v,t,qc);\n        }\n    }\n    memset(stack,0,sizeof(stack));\n    dfs1(1,0);\n    dfs2(1,1);\n    while(tp>0) be[stack[tp--]] = idx;\n    sort(q+1,q+1+qc,cmp);\n    t = 0; \n    u = v = 1;\n    update(1);\n    for(int i=1;i<=qc;++i){\n        while(t<q[i].t) modify(c[t+1].u,c[t+1].next),++t;\n        while(t>q[i].t) modify(c[t].u,c[t].last),--t;\n        update(lca(u,v));\n        if(u!=q[i].u) move(u,q[i].u),u = q[i].u;\n        if(v!=q[i].v) move(v,q[i].v),v = q[i].v;\n        update(lca(u,v));\n        ans[q[i].id] = res;\n    }\n    for(int i=1;i<=qc;++i){\n        print(ans[i]);\n        putchar('\\n');\n    }\n    return 0;\n}\n```",
        "postTime": 1546266792,
        "uid": 115864,
        "name": "NaCly_Fish",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 P4074 \u3010[WC2013]\u7cd6\u679c\u516c\u56ed\u3011"
    },
    {
        "content": "## [WC2013]\u7cd6\u679c\u516c\u56ed(\u6811\u4e0a\u5f85\u4fee\u83ab\u961f)\n\n\u53ef\u8c13\u83ab\u961f\u9898\u4e4b\u96c6\u5927\u6210\u8005\u3002\u57fa\u672c\u4e0a\u6240\u6709\u7684\u96be\u70b9\u90fd\u56ca\u62ec\u4e86\u3002\n\n\u83ab\u961f\u548c\u5e26\u4fee\u83ab\u961f\u90fd\u6ca1\u4ec0\u4e48\u610f\u601d\uff0c\u91cd\u70b9\u8bb2\u4e00\u4e0b\u6811\u4e0a\u83ab\u961f\u3002\n\n### \u5f15\u5165:[SCOI2005]\u738b\u5ba4\u8054\u90a6\n\n\u8fd9\u9053\u9898\u76ee\u6ca1\u4ec0\u4e48\u610f\u601d\uff0c\u4e00\u987f\u4e71\u641c\u90fd\u53ef\u4ee5\u8fc7\u53bb\u3002\u91cd\u70b9\u662f\u6309\u8fd9\u9053\u9898\u76ee\u7684\u65b9\u6cd5\uff0c\u53ef\u4ee5\u5c06\u6811\u5206\u5f97\u5341\u5206\u5747\u5300\u3002\u8fd9\u6837\u5c31\u53ef\u4ee5\u5f15\u5165\u5206\u5757\u4e86\u3002\u5982\u679c$B=\\sqrt n$\uff0c\u90a3\u4e48\u5757\u7684\u5206\u5e03\u5c06\u4f1a\u5341\u5206\u5747\u5300\u3002\u4e0b\u9762\u7ed9\u51fa\u4e00\u79cd\u5206\u5757\u65b9\u6cd5\u3002\n\n```cpp\nstatic int sta[MAXN],tp,blk_cnt,bel[MAXN],pr[MAXN];\n//\u8f85\u52a9\u7528\u7684\u6808,\u6808\u5143\u7d20\u4e2a\u6570\uff0c\u5206\u5757\u6570\uff0c\u6bcf\u4e2a\u70b9\u6240\u5c5e\u5757\u7f16\u53f7\uff0c\u6bcf\u4e2a\u5757\u7684\u7701\u4f1a(\u4ec5\u672c\u9898\u6709\u7528)\nvoid dfs(int u,int fa=0)\n{\n    int sz=tp;\n    for(auto v:p[u])if(v^fa)\n    {\n        dfs(v,u);\n        if(tp-sz>=B)//\u4e00\u822c=sqrt(n)\n        {\n            pr[++blk_cnt]=u;\n            while(tp>sz)bel[sta[tp--]]=blk_cnt;\n        }\n    }\n    sta[++tp]=u;\n}\n```\n\n### \u6b63\u6587\n\n\u5229\u7528\u5f15\u5165\u4e2d\u7684\u5206\u5757\u65b9\u6cd5\uff0c\u53ef\u4ee5\u5c06\u70b9\u5747\u5300\u5206\u6210$\\sqrt n$\u5757\u3002\u4e4b\u540e\u5c31\u548c\u6b63\u5e38\u83ab\u961f\u533a\u522b\u4e0d\u5927\u4e86\u3002\u7b2c\u4e00\u7ef4\u6309\u7167\u6240\u5c5e\u5757\u6392\u5e8f\uff0c\u7b2c\u4e8c\u7ef4\u6309\u7167dfn\u6392\u5e8f\u3002\u7136\u540e\u5c31\u66b4\u529b\u4fee\u6539\u5373\u53ef\u3002\n\u8bb0\u5f97\u5e26\u4fee\u83ab\u961f\u4e3a\u4e86\u5c06\u65f6\u95f4\u590d\u6742\u5ea6\u644a\u5300\u5206\u7684\u5757\u5927\u5c0f\u53d8\u4e3a$n^\\frac{2}{3}$\uff0c\u8fd9\u6837\u624d\u80fd\u4fdd\u8bc1\u590d\u6742\u5ea6\u6b63\u786e\u3002\u603b\u65f6\u95f4\u590d\u6742\u5ea6$O(n^\\frac{5}{3})$\u3002\n\n\u4ee3\u7801:\n\n```cpp\n#include<bits/stdc++.h>\n#define For(i,a,b) for(i=(a);i<=(b);++i)\n#define Forward(i,a,b) for(i=(a);i>=(b);--i)\n#define Rep(i,a,b) for(register int i=(a);i<=(b);++i)\n#define Repe(i,a,b) for(register int i=(a);i>=(b);--i)\nusing namespace std;\ntemplate<typename T>inline void read(T &x)\n{\n    T s=0,f=1;char k=getchar();\n    while(!isdigit(k)&&(k^'-'))k=getchar();\n    if(!isdigit(k)){f=-1;k=getchar();}\n    while(isdigit(k)){s=s*10+(k^48);k=getchar();}\n    x=s*f;\n}\n\nconst int MAXN=1e5+7;\n\nstatic int n,m,Q,B,V[MAXN],W[MAXN],C[MAXN],fa[MAXN],dep[MAXN];\n\nstatic vector<int>p[MAXN];\n\nstatic int sta[MAXN],tp,blk_cnt,bel[MAXN],dfn[MAXN],e;\nvoid dfs(int u)\n{\n\tint sz=tp;\n\tdep[u]=dep[fa[u]]+1;dfn[u]=++e;\n\tfor(auto v:p[u])if(v^fa[u])\n\t{\n\t\tfa[v]=u;dfs(v);\n\t\tif(tp-sz>=B)\n\t\t{\n\t\t\t++blk_cnt;\n\t\t\twhile(tp>sz)bel[sta[tp--]]=blk_cnt;\n\t\t}\n\t}\n\tsta[++tp]=u;\n}\n\nstatic struct quer\n{\n\tint u,v,tm,id;\n\tfriend bool operator<(quer a,quer b)\n\t{return bel[a.u]^bel[b.u]?bel[a.u]<bel[b.u]:dfn[a.v]<dfn[b.v];}\n}q[MAXN];\n\nstatic int t;\n\nstatic int modi[MAXN][3];\n\ninline void init()\n{\n\tread(n);read(m);read(Q);B=pow(n,0.666666);\n\tRep(i,1,m)read(V[i]);\n\tRep(i,1,n)read(W[i]);\n\tstatic int u,v;\n\tRep(i,1,n-1)read(u),read(v),p[u].push_back(v),p[v].push_back(u);\n\tdfs(1);e=0;\n\twhile(tp)bel[sta[tp--]]=blk_cnt;\n\t\n\tRep(i,1,n)read(C[i]);\n\t\n\tstatic int opt;\n\tRep(i,1,Q)\n\t{\n\t\tread(opt);read(u);read(v);\n\t\tif(!opt)modi[++e][0]=u,modi[e][1]=v,modi[e][2]=C[u],C[u]=v;\n\t\telse\n\t\t{\n\t\t\tif(dfn[u]<dfn[v])swap(u,v);\n\t\t\tq[++t].u=u;q[t].v=v;q[t].tm=e,q[t].id=t;\n\t\t}\n\t}\n\tsort(q+1,q+t+1);\n}\n\nstatic int cnt;\n\nstatic int bar[MAXN],st[MAXN];\n\nstatic long long ans[MAXN],as;\n\ninline void insert(int pos)\n{\n\tst[pos]^=1;\n\tif(st[pos])as+=(long long)W[++bar[C[pos]]]*V[C[pos]];\n\telse as-=(long long)W[bar[C[pos]]--]*V[C[pos]];\n}\n\nstatic int cross;\n\ninline void goup(int&u)\n{\n\tif(!cross)\n\t{\n\t\tif(st[u]&&!st[fa[u]])cross=u;\n\t\telse if(!st[u]&&st[fa[u]])cross=fa[u];\n\t}\n\tinsert(u);u=fa[u];\n}\n\ninline void modiroad(int u,int v)\n{\n\tif(u==v)return;\n\tcross=0;\n\tif(st[v])cross=v;\n\tif(dep[u]<dep[v])swap(u,v);\n\twhile(dep[u]>dep[v])goup(u);\n\twhile(u^v)goup(u),goup(v);\n\tinsert(u);if(cross)insert(cross);\n}\n\ninline void solve()\n{\n\tstatic int u,v;\n\tu=q[1].u;v=q[1].v;cnt=e;\n\twhile(cnt>q[1].tm)C[modi[cnt][0]]=modi[cnt][2],--cnt;\n\tmodiroad(u,v);ans[q[1].id]=as;\n\tRep(i,2,t)\n\t{\n\t\tbool flag;\n\t\twhile(cnt>q[i].tm)\n\t\t{\n\t\t\tflag=false;\n\t\t\tif(st[modi[cnt][0]])insert(modi[cnt][0]),flag=true;\n\t\t\tC[modi[cnt][0]]=modi[cnt][2];\n\t\t\tif(flag)insert(modi[cnt][0]);\n\t\t\t--cnt;\n\t\t}\n\t\twhile(cnt<q[i].tm)\n\t\t{\n\t\t\t++cnt;\n\t\t\tflag=false;\n\t\t\tif(st[modi[cnt][0]])insert(modi[cnt][0]),flag=true;\n\t\t\tC[modi[cnt][0]]=modi[cnt][1];\n\t\t\tif(flag)insert(modi[cnt][0]);\n\t\t}\n\t\tmodiroad(u,q[i].u);modiroad(v,q[i].v);u=q[i].u,v=q[i].v;\n\t\tans[q[i].id]=as;\n\t}\n\tRep(i,1,t)printf(\"%lld\\n\",ans[i]);\n}\n\nint main()\n{\n\tinit();\n\tsolve();\n\treturn 0;\n}\n```\n\n\u4ee3\u7801\u91cf\u76f8\u5bf9\u8f83\u5927\uff0c\u63a8\u8350\u4e2a\u4e2a\u90e8\u5206\u5199\u6210\u51fd\u6570\u578b\uff0c\u65b9\u4fbf\u8c03\u7528\u548c$debug$\u3002\u6700\u597d\u5199\u51e0\u4e2a$namespace$\u533a\u5206\u4e00\u4e0b(\u5077\u61d2\u6ca1\u5199\u7ed3\u679c\u8c03\u8bd5\u534a\u5929)\u3002",
        "postTime": 1525518055,
        "uid": 7035,
        "name": "Great_Influence",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P4074 \u3010[WC2013]\u7cd6\u679c\u516c\u56ed\u3011"
    },
    {
        "content": "## Question\n\n[P4074 [WC2013] \u7cd6\u679c\u516c\u56ed](https://www.luogu.com.cn/problem/P4074)\n\n## Solution\n\n\u6811\u4e0a\u5e26\u4fee\u83ab\u961f\u3002\n\n[\u83ab\u961f\u7b97\u6cd5\u2014\u2014\u4ece\u5165\u95e8\u5230\u9ed1\u9898](https://www.cnblogs.com/WAMonster/p/10118934.html)\n\n\u8fd9\u7bc7\u535a\u5ba2\u91cc\u5199\u7684\u8fd8\u662f\u5f88\u6e05\u695a\u7684\u3002\n\nLCA \u4e0d\u4f1a\u7684\u770b\u8fd9\u91cc\uff1a\n\n- [\u500d\u589e\u6c42 LCA](https://www.cnblogs.com/lbssxz/p/11114819.html)\n\n- [\u6811\u5256\u6c42 LCA](https://www.cnblogs.com/cangT-Tlan/p/8846408.html)\n\n## Notice\n\n\u6211\u4eec\u5148\u6765\u89c2\u5bdf\u4e00\u4e0b\u6570\u636e\u8303\u56f4\u3002\n\n\u5c31\u4f1a\u53d1\u73b0\u4e00\u4e2a\u771f\u8c1b\uff1a**\u5341\u5e74 OI \u4e00\u573a\u7a7a\uff0c\u4e0d\u5f00 long long \u89c1\u7956\u5b97\u3002**\n\n\u63a5\u7740\uff0c\u6211\u4eec\u518d\u8ba1\u7b97\u4e00\u4e0b\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a$O(N^{\\frac{5}{3}})$\u3002\n\n${10^5}^{\\frac{5}{3}}=10^{\\frac{25}{3}}=10^{\\frac{1}{3}}\\times10^8\\approx2\\times10^8$\n\n\u800c\u65f6\u9650\u662f 6 \u79d2\uff0c\u770b\u8d77\u6765\u8fd9\u4e0d\u4f1a TLE\u3002\n\n\u4f46\u662f\u5f88\u591a OIer \u5374\u5728\u7b2c 7 \u4e2a\u70b9 TLE \u4e86\u3002\n\n**???**\n\n\u8fd9\u662f\u4e00\u4e2a\u7ec6\u8282\u6027\u7684\u95ee\u9898\u3002\n\n\u8bbe\u6c42\u51fa\u6765\u7684\u6b27\u62c9\u5e8f\u7684\u957f\u5ea6\u4e3a ncnt\uff0c\u5757\u7684\u5927\u5c0f\u4e3a siz\u3002\n\n\u5219 ```siz=sqrt(ncnt);```\n\n\u800c\u4e0d\u662f ```siz=sqrt(n);```\n\n```for(int i=1;i<=ncnt;i++) belong[i]=(i-1)/siz+1;```\n\n\u800c\u4e0d\u662f ```for(int i=1;i<=n;i++) belong[i]=(i-1)/siz+1;```\n\n\u6211\u5927\u6982\u5728\u8fd9\u91cc\u5361\u4e86 2 \u4e2a\u591a\u5c0f\u65f6\uff08\u545c\u545c\uff09\u3002\n\n## Code\n\n```cpp\n#pragma GCC target(\"sse,sse2,sse3,ssse3,sse4,popcnt,abm,mmx,avx,avx2,tune=native\")\n#include\"cstdio\"\n#include\"algorithm\"\n#include\"cmath\"\nusing namespace std;\n#define N (int)(1e5+10)\n#define isdigit(x) ((x)>='0'&&(x)<='9')\n\nstruct Q {\n\tint l,r,id,lca,time;\n}q[N];\nstruct C {\n\tint x,y;\n}c[N];\nint dep[N],first[N],last[N],ord[N<<1];\nint v[N],w[N],cnt[N],belong[N<<1],a[N],vis[N];\nint n,t,m,Qnum=0,Cnum=0,siz,L=1,R=0,ncnt=0,nowtime=0,tot=0;\nint father[N],top[N],Siz[N],hson[N];\nlong long now,ans[N];\nint head[N];\nstruct node {\n\tint to,next;\n}edge[N<<1];\n\ninline void add(int x,int y) {\n\tedge[++tot].to=y;\n\tedge[tot].next=head[x];\n\thead[x]=tot;\n}\n\nstatic char buf[100000],*p1=buf,*p2=buf;\n#define gc p1==p2&&(p2=(p1=buf)+fread(buf,1,100000,stdin),p1==p2)?EOF:*p1++;\ninline int read() {\n\tint res=0;\n\tchar c=gc;\n\twhile (!isdigit(c)) c=gc;\n\twhile (isdigit(c)) res=(res<<1)+(res<<3)+(c^48),c=gc;\n\treturn res;\n}\nvoid write(long long x) {\n\tstatic int sta[50],top=0;\n\tif (x<0) putchar('-'),x=-x;\n\tdo {\n\t\tsta[top++]=x%10,x/=10;\n\t}while (x);\n\twhile (top) putchar(sta[--top]+48);\n\tputchar('\\n');\n}\n\ninline void dfs1(int u,int fa) {\n\tdep[u]=dep[fa]+1; ord[++ncnt]=u; first[u]=ncnt; father[u]=fa; Siz[u]=1;\n\tfor(int i=head[u];i;i=edge[i].next) {\n\t\tint v=edge[i].to;\n\t\tif (v!=fa) {\n\t\t\tdfs1(v,u);\n\t\t\tSiz[u]+=Siz[v];\n\t\t\tif (Siz[v]>Siz[hson[u]]) hson[u]=v;\n\t\t}\n\t}\n\tord[++ncnt]=u; last[u]=ncnt;\n}\n\ninline void dfs2(int u,int fa) {\n\tif (hson[u]) {\n\t\ttop[hson[u]]=top[u];\n\t\tdfs2(hson[u],u);\n\t\tfor(int i=head[u];i;i=edge[i].next) {\n\t\t\tint v=edge[i].to;\n\t\t\tif (v!=fa&&v!=hson[u]) {\n\t\t\t\ttop[v]=v;\n\t\t\t\tdfs2(v,u);\n\t\t\t}\n\t\t}\n\t}\n}\n\ninline int LCA(int x,int y) {\n\twhile (top[x]^top[y]) dep[top[x]]>dep[top[y]]? x=father[top[x]]:y=father[top[y]];\n\treturn (dep[x]<dep[y]? x:y);\n}\n\ninline bool cmp(Q a,Q b) {\n\treturn (belong[a.l]^belong[b.l])? belong[a.l]<belong[b.l]:((belong[a.r]^belong[b.r])? belong[a.r]<belong[b.r]:a.time<b.time);\n}\n\ninline void work(int pos) {\n\tif (vis[pos]) now-=1ll*v[a[pos]]*w[cnt[a[pos]]--];else now+=1ll*v[a[pos]]*w[++cnt[a[pos]]];\n\tvis[pos]^=1;\n}\n\ninline void modify(int pos) {\n\tif (vis[c[pos].x]) {\n\t\twork(c[pos].x);\n\t\tswap(c[pos].y,a[c[pos].x]);\n\t\twork(c[pos].x);\n\t}\n\telse swap(c[pos].y,a[c[pos].x]);\n}\n\nsigned main() {\n\tn=read(); t=read(); m=read();\n\tfor(int i=1;i<=t;i++) v[i]=read();\n\tfor(int i=1;i<=n;i++) w[i]=read();\n\tfor(int i=1;i<n;i++) {\n\t\tint x,y;\n\t\tx=read(); y=read();\n\t\tadd(x,y); add(y,x);\n\t}\n\tdep[0]=0; dfs1(1,0); top[1]=1; dfs2(1,0);\n\tfor(int i=1;i<=n;i++) a[i]=read();\n\tfor(int i=1;i<=m;i++) {\n\t\tint x,y,type;\n\t\ttype=read(); x=read(); y=read();\n\t\tif (type==1) {\n\t\t\tif (first[x]>first[y]) swap(x,y);\n\t\t\tint lca=LCA(x,y);\n\t\t\tif (x==lca) {\n\t\t\t\tq[++Qnum].l=first[x]; q[Qnum].r=first[y];\n\t\t\t}\n\t\t\telse {\n\t\t\t\tq[++Qnum].l=last[x]; q[Qnum].r=first[y]; q[Qnum].lca=lca;\n\t\t\t}\n\t\t\tq[Qnum].time=Cnum; q[Qnum].id=Qnum;\n\t\t}\n\t\telse {\n\t\t\tc[++Cnum].x=x; c[Cnum].y=y;\n\t\t}\n\t}\n\tsiz=pow(ncnt,2.0/3.0); for(int i=1;i<=ncnt;i++) belong[i]=(i-1)/siz+1;\n\tsort(q+1,q+Qnum+1,cmp);\n\tfor(int i=1;i<=Qnum;i++) {\n\t\twhile (L<q[i].l) work(ord[L++]);\n\t\twhile (L>q[i].l) work(ord[--L]);\n\t\twhile (R<q[i].r) work(ord[++R]);\n\t\twhile (R>q[i].r) work(ord[R--]);\n\t\twhile (nowtime<q[i].time) modify(++nowtime);\n\t\twhile (nowtime>q[i].time) modify(nowtime--);\n\t\tif (q[i].lca) work(q[i].lca);\n\t\tans[q[i].id]=now;\n\t\tif (q[i].lca) work(q[i].lca);\n\t}\n\tfor(int i=1;i<=Qnum;i++) write(ans[i]);\n\treturn 0;\n}\n```\n\n\u5b8c\u7ed3\u6492\u82b1\uff01 **^.^**",
        "postTime": 1621591766,
        "uid": 355448,
        "name": "Fido_Puppy",
        "ccfLevel": 0,
        "title": "[WC2013] \u7cd6\u679c\u516c\u56ed"
    },
    {
        "content": "# \u6811\u4e0a\u5e26\u4fee\u83ab\u961f\n\n## \u6811\u4e0a\u83ab\u961f\n\n\u4ee5\u4e0b\u90fd\u662f\u9488\u5bf9\u4e00\u6761\u94fe\u4e0a\u7684\u8be2\u95ee\u3002\n\n\u5229\u7528\u62ec\u53f7\u5e8f\u6216\u8005\u6b27\u62c9\u5e8f\u628a\u6811\u4e0a\u83ab\u961f\u8f6c\u5316\u4e3a\u666e\u901a\u83ab\u961f\u3002\n\n\u53ea\u5448\u73b0\u4e86\u8f6c\u5316\u8be2\u95ee\u7684\u90e8\u5206\uff0c\u7701\u7565\u4e86\u83ab\u961f\u7684\u90e8\u5206\u3002\n\n### \u6b27\u62c9\u5e8f\u5b9e\u73b0\n\n\u4ec0\u4e48\u662f\u6b27\u62c9\u5e8f\uff0c\u5c31\u662f\u8fd9\u6837\u3002\n\n``` cpp\nvoid dfs(int u,int fa) {\n\tdfn[++lead]=u;\n\t++all[u];\n    for(int i=head[u];i;i=e[i].nxt){\n\t\tint v=e[i].v;\n        if(v==fa)continue;\n    \tdfs(v,u);\n    \tdfn[++lead]=u;\n    \t++all[u];\n    }\n    if(all[u]==1)dfn[++lead]=u,++all[u];\n}\n```\n\n\u6ce8\u610f\u5230 $lead$ \u6700\u7ec8\u5927\u5c0f\u4e3a\u70b9\u6570+\u8fb9\u6570+\u53f6\u5b50\u8282\u70b9\u6570\uff0c\u6240\u4ee5 $lead<3n$ \u3002\n\n\u5b83\u7684\u610f\u4e49\u76f8\u5f53\u4e8e\u7ed5\u7740\u6811\u7684\u8f6e\u5ed3\u8d70\u4e86\u4e00\u5708\u3002\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/fynvmwr0.png)\n\n\u6211\u4eec\u628a $u$ \u6700\u9760\u524d\u7684\u6b27\u62c9\u5e8f\u8bb0\u4f5c $in_u$ \uff0c\u6700\u9760\u540e\u7684\u8bb0\u4f5c $out_u$ \uff0c$in_u$~$out_u$ \u8fd9\u6bb5\u533a\u95f4\u79f0\u4f5c $u$ \u7684\u6709\u5173\u533a\u95f4 $rang_u$\u3002 \n\n\u5bf9\u4e8e $x$ \u5230 $y$ \uff08$in_x<in_y$\uff09\u7684\u8be2\u95ee\u6211\u4eec\u5206\u4e09\u79cd\u60c5\u51b5\u8ba8\u8bba\uff0c\n\n+ $rang_x$ \u4e0e $rang_y$ \u76f8\u79bb\uff0c\u8be2\u95ee\u533a\u95f4\u4e3a $out_x$~$in_y$ \u3002\n+ \u76f8\u4ea4\uff0c\u8be2\u95ee\u533a\u95f4\u4e3a [$in_y$\uff0c$out_x$] \u3002\n+ \u5305\u542b\uff0c\u8be2\u95ee\u533a\u95f4\u4e3a [$in_x$\uff0c$in_y$] \u6216\u8005 [$out_y$\uff0c$out_x$] \u3002\n\n\u5982\u679c\u4e00\u4e2a\u70b9 $u$ \u88ab\u533a\u95f4\u5305\u542b\u4e86 $all_u$ \u6b21\uff0c\u90a3\u5c31\u628a\u5b83\u7684\u8d21\u732e\u5220\u9664\u3002\n\n\u5177\u4f53\u539f\u56e0\u8003\u8651\u89c2\u5bdf\u6b27\u62c9\u5e8f\u56fe\uff08\uff1f\uff09\uff0c\u4e00\u6b21 $u$ \u5230 $v$ \u7684\u8be2\u95ee\u76f8\u5f53\u4e8e\u6cbf\u7740\u4e0a\u56fe\u9ec4\u8272\u7684\u8fb9\u4ece $u$ \u8d70\u5230 $v$ \uff0c\u5176\u4e2d\u88ab\u9ec4\u8fb9\u5b8c\u5168\u5305\u542b\u7684\u70b9\uff08\u7b49\u4ef7\u4e8e\u88ab\u8be2\u95ee\u533a\u95f4\u5305\u542b\u4e86 $all_u$ \u6b21\uff09\u6ca1\u6709\u8d21\u732e\u7b54\u6848\uff0c\u8d21\u732e\u7b54\u6848\u7684\u662f\u88ab\u534a\u5305\u542b\u7684\u70b9\u3002\n\n## \u62ec\u53f7\u5e8f\u5b9e\u73b0\n\n\u4ec0\u4e48\u662f\u62ec\u53f7\u5e8f\uff0c\u5c31\u662f\u8fd9\u6837\u3002\n\n```cpp\nvoid dfs(int u,int fa) {\n    dfn[++lead]=u;\n\tfor(int head[u];i;i=e[i].nxt) {\n\t\tint v=e[i].v;\n        if(v==fa)continue;\n\t\tdfs(v,u);\n    }\n    dfn[++lead]=u;\n}\n```\n\n$lead$ \u6700\u7ec8\u5927\u5c0f\u4e3a $2n$\uff0c\u8fd9\u79cd\u505a\u6cd5\u6bd4\u6b27\u62c9\u5e8f\u505a\u6cd5\u7684\u5e38\u6570\u5c0f\u4e00\u70b9\u3002\n\n\u6211\u4eec\u628a $u$ \u9760\u524d\u7684\u62ec\u53f7\u5e8f\u8bb0\u4f5c $in_u$ \uff0c\u9760\u540e\u7684\u8bb0\u4f5c $out_u$ \u3002\n\n\u5bf9\u4e8e\u8be2\u95ee $x$ \u5230 $y$\uff08$in_x<in_y$\uff09\uff0c\u5206\u4e24\u79cd\u60c5\u51b5\u8003\u8651\uff0c\n\n+ $lca=x$\uff0c\u8be2\u95ee\u8f6c\u5316\u4e3a [$in_x$\uff0c$in_y$]\u3002\n+ $lca\\ne x$\uff0c\u8be2\u95ee\u8f6c\u5316\u4e3a[$out_x$\uff0c$in_y$]\u52a0\u4e0a $lca$ \u3002\n\n\u5982\u679c\u4e00\u4e2a\u70b9\u88ab\u533a\u95f4\u88ab\u5305\u542b\u7684\u4e24\u6b21\uff0c\u5c31\u5220\u9664\u5b83\u7684\u8d21\u732e\u3002\n\n\u8bc1\u660e\u5982\u4e0b\uff0c\n\n\u5bf9\u4e8e\u7b2c\u4e00\u79cd\u60c5\u51b5\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/743it6s1.png)\n\n\u82e5\u6211\u4eec\u8be2\u95ee\u7eff\u8272\u7684\u90a3\u6761\u94fe\uff0c\u7eff\u8272\u7684\u90a3\u5768\u6bcf\u4e2a\u70b9\u53ea\u88ab\u7b97\u4e86\u4e00\u6b21\uff08\u53ea\u7b97\u4e86in\u7684\uff09\uff0c\u9ec4\u8272\u7684\u90a3\u5768\u88ab\u7b97\u4e86\u4e24\u6b21\uff0c\u7ea2\u8272\u7684\u90a3\u5768\u88ab\u7b97\u4e86\u96f6\u6b21\u3002\u6240\u4ee5\u53ea\u6709\u7eff\u8272\u7684\u5bf9\u7b54\u6848\u6709\u8d21\u732e\u3002\n\n\u7b2c\u4e8c\u79cd\u60c5\u51b5\uff0c\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/rt0so7y3.png)\n\n\u6211\u4eec\u8be2\u95ee5\u52307\uff08\u7c89\u8272\uff09\uff0c\u82e5\u6211\u4eec\u7684\u8be2\u95ee\u4e3a[$out_x$\uff0c$in_y$]\uff0c\u90a3\u4e48\u7eff\u8272\u7684\u88ab\u7b97\u4e86\u4e00\u6b21\uff08\u53ea\u7b97\u4e86out\uff09\uff0c\u84dd\u8272\u90e8\u5206\u4e5f\u88ab\u7b97\u4e86\u4e00\u6b21\uff08\u53ea\u7b97\u4e86in\uff09\uff0c\u7ea2\u8272\u7684\u6ca1\u7b97\uff0c\u9ec4\u8272\u7684\u7b97\u4e86\u4e24\u6b21\u3002\u56e0\u4e3a$lca$(\u70b91) \u7684\u8d21\u732e\u6ca1\u7b97\uff0c\u6240\u4ee5\u518d\u52a0\u4e0a\u4ed6\u7684\u8d21\u732e\u5c31\u884c\u4e86\u3002\n\n## \u5e26\u4fee\u83ab\u961f\u200b\n\n\u666e\u901a\u83ab\u961f\u662f\u4e24\u4e2a\u5173\u952e\u5b57\uff0c\u5e26\u4fee\u83ab\u961f\u518d\u52a0\u4e00\u65f6\u95f4\u5173\u952e\u5b57\uff0c\u8dd1\u666e\u901a\u83ab\u961f\u5373\u53ef\u3002\n\n\u8981\u6c42\u5355\u6b21\u4fee\u6539\u53ef\u4ee5\u5feb\u901f\u6267\u884c\u3002\n\n\u590d\u6742\u5ea6\u5206\u6790\uff08\u53ef\u80fd\u4e0d\u4e25\u8c28\uff09\uff0c\u8bbe\u5757\u7684\u5927\u5c0f\u4e3a $S$ \uff0c\u5e8f\u5217\u957f\u5ea6\u4e3a $n$ \uff0c\u8be2\u95ee\u4e3a $q$ \uff0c \u4fee\u6539\u6b21\u6570\u4e3a $c$ \uff0c\u89c2\u5bdf\u4e00\u4e0bcmp\u51fd\u6570\uff08\u6392\u5e8f\u7684\u90a3\u4e2a\u51fd\u6570\uff09\uff0c\n\n```cpp\nbool cmp(Query p,Query q){\t\n\tif(bel[p.l]==bel[q.l]) {\n\t\tif(bel[p.r]==bel[q.r])return p.t<q.t;\n\t\telse return p.r<q.r;\n\t}\n\telse return p.l<q.l;\n}\n```\n\n\u5bf9\u4e8e $t$\uff08\u65f6\u95f4\uff09\u6307\u9488\uff0c\u8003\u8651  $l$  \u5728\u540c\u4e00\u4e2a\u5757\u91cc\u79fb\u52a8 $r$ \u4e5f\u5728\u540c\u4e00\u4e2a\u5757\u91cc\u79fb\u52a8\u65f6\u79fb\u52a8\u7684\u6b21\u6570\uff0c\u6bcf\u4e2a\u5757\uff08$l$\uff0c$r$ \u90fd\u4e0d\u6362\u5757\uff09\u6700\u574f\u79fb\u52a8 $c$ \u6b21\uff08\u5728\u540c\u4e00\u4e2a\u5757\u65f6\u5355\u8c03\u79fb\u52a8\u7684\uff09\uff0c\u5171 $\\frac{n^2}{S^2}$ \u4e2a\u5757\uff0c\u603b\u8ba1\u79fb\u52a8  $\\frac{n^2c}{S^2}$ \u6b21\u3002\n\n\u5bf9\u4e8e $l$ \u6307\u9488\uff0c\u6362\u5757\u65f6\u5355\u8c03\u79fb\u52a8\uff0c\u5728\u540c\u4e00\u4e2a\u5757\u91cc\u65f6\u5355\u6b21\u6700\u5feb $S$ \u6b21\u79fb\u52a8\uff0c\u5171 $q$ \u6b21\uff0c\u603b\u8ba1 $qS$\u3002\n\n\u5bf9\u4e8e $r$ \u6307\u9488\uff0c$l$ \u5728\u540c\u4e00\u4e2a\u5757\u65f6\u5355\u8c03\u79fb\u52a8\uff0c\u6bcf\u4e2a\u5757\u6700\u574f\u79fb\u52a8 $n$ \u6b21\uff0c\u5171 $\\frac{n}{S}$ \u4e2a\u5757\uff0c\u603b\u8ba1$\\frac{n^2}{S}$ \u6b21\u3002\n\n\u5982\u679c $c,n$ \u540c\u9636\uff0c$S=n^{\\frac{2}{3}}$ \u65f6\u590d\u6742\u5ea6\u8f83\u597d\uff0c\u4e3a $O(n^{\\frac{5}{3}})$ \u3002\n\n## \u6811\u4e0a\u5e26\u4fee\u83ab\u961f\n\n> I have a pen. I have an apple. Apple-pen!\n\n**\u4f8b\u9898\uff1aP4074 [WC2013] \u7cd6\u679c\u516c\u56ed**\n\n\u4fe1\u606f\u7528\u83ab\u961f\u5f88\u597d\u7ef4\u62a4\uff0c\u4e3b\u8981\u662f\u8981\u4f1a\u6811\u4e0a\u83ab\u961f\u548c\u5e26\u4fee\u83ab\u961f\u3002\n\n``` cpp\n//\u62ec\u53f7\u5e8f\u5b9e\u73b0\u7684\n#include<stdio.h>\n#include<algorithm>\n#include<cmath>\n#define LL long long\nusing namespace std;\nconst int N=2e5+5;\nint read() {\n\tint x=0,f=1;char c=getchar();\n\twhile(c>'9'||c<'0'){if(c=='-')f=-1;c=getchar();}\n\twhile(c>='0'&&c<='9'){x=x*10+c-'0';c=getchar();}\n\treturn x*f;\n}\nvoid swap(int &x,int &y){int t=x;x=y;y=t;}\nstruct Edge {\n\tint v,nxt;\n}e[N];\nint head[N],size;\nvoid link(int u,int v) {\n\te[++size].v=v;\n\te[size].nxt=head[u];\n\thead[u]=size;\n}\nint n,m,q,V[N],col[N],W[N];\n\nint lead,in[N],out[N],ref[N<<1],sze[N],son[N],top[N],dep[N],fa[N];\nvoid dfs1(int u,int fa) {\n\tsze[u]=1;\n\tdep[u]=dep[fa]+1;\n\tfor(int i=head[u];i;i=e[i].nxt) {\n\t\tint v=e[i].v;\n\t\tif(v==fa)continue;\n\t\tdfs1(v,u);\n\t\tsze[u]+=sze[v];\n\t\tif(sze[v]>sze[son[u]])son[u]=v;\n\t}\n}\nvoid dfs2(int u) {\n\tin[u]=++lead;\n\tref[lead]=u;\n\tif(son[u]) {\n\t\tint v=son[u];\n\t\tfa[v]=u;\n\t\ttop[v]=top[u];\n\t\tdfs2(v);\n\t}\n\tfor(int i=head[u];i;i=e[i].nxt) {\n\t\tint v=e[i].v;\n\t\tif(!top[v]) {\n\t\t\tfa[v]=u;\n\t\t\ttop[v]=v;\n\t\t\tdfs2(v);\n\t\t}\n\t}\n\tout[u]=++lead;\n\tref[lead]=u;\n}\nint _lca(int x,int y) {\n\tint fx=top[x],fy=top[y];\n\twhile(fx!=fy) {\n\t\tif(dep[fx]<dep[fy])swap(x,y),swap(fx,fy);\n\t\tx=fa[fx];fx=top[x];\n\t}\n\treturn dep[x]<dep[y]?x:y;\n}\n\nstruct Query{\n\tint l,r,t,lca,i;\n}Q[N];\nint bel[N],block=3000;\nLL ans[N],now;\nbool cmp(Query p,Query q){\n\tif(bel[p.l]==bel[q.l]) {\n\t\tif(bel[p.r]==bel[q.r])return p.t<q.t;\n\t\telse return p.r<q.r;\n\t}\n\telse return p.l<q.l;\n}\nint pos[N],pre[N],then[N],cc[N],tot,ci[N],cnt[N];\nvoid add(int x){\n\tif(ci[x]==1) {\n\t\tnow-=1ll*W[cnt[col[x]]]*V[col[x]];\n\t\t--cnt[col[x]];\n\t}\n\telse {\n\t\t++cnt[col[x]];\n\t\tnow+=1ll*W[cnt[col[x]]]*V[col[x]];\n\t}\n\t++ci[x];\n}\nvoid del(int x) {\n\tif(ci[x]==2) {\n\t\t++cnt[col[x]];\n\t\tnow+=1ll*W[cnt[col[x]]]*V[col[x]];\n\t}\n\telse {\n\t\tnow-=1ll*W[cnt[col[x]]]*V[col[x]];\n\t\t--cnt[col[x]];\n\t}\n\t--ci[x];\n}\nint main() {\n\tn=read();m=read();q=read();\n\tfor(int i=1;i<=m;++i)V[i]=read();//\u6bcf\u79cd\u989c\u8272\u7684\u4ef7\u503c \n\tfor(int i=1;i<=n;++i)W[i]=read();//\u817b\u503c \n\tfor(int i=1;i<n;++i) {\n\t\tint u=read(),v=read();\n\t\tlink(u,v);\n\t\tlink(v,u);\n\t}\n\tdfs1(1,0);\n\ttop[1]=1;dfs2(1);\n\tfor(int i=1;i<=n;++i)cc[i]=col[i]=read();\n\tint T=0;\n\tfor(int i=1;i<=q;++i) {\n\t\tint Type=read(),x=read(),y=read();\n\t\tif(Type==1) {\n\t\t\tint lca=_lca(x,y);\n\t\t\tQ[++tot].t=T;\n\t\t\tQ[tot].i=tot; \n\t\t\tif(in[x]>in[y])swap(x,y);//x\u5728\u4e0a \n\t\t\tif(lca==x) {\n\t\t\t\tQ[tot].l=in[x];\n\t\t\t\tQ[tot].r=in[y];\n\t\t\t}\n\t\t\telse {\n\t\t\t\tQ[tot].l=out[x];\n\t\t\t\tQ[tot].r=in[y];\n\t\t\t\tQ[tot].lca=lca;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\t++T;\n\t\t\tpos[T]=x;\n\t\t\tpre[T]=cc[x];\n\t\t\tcc[x]=then[T]=y;\n\t\t}\n\t}\n\tfor(int i=1;i<=2*n;++i)bel[i]=(i-1)/block+1;\n\tsort(Q+1,Q+tot+1,cmp);\n\tint l=1,r=0,t=0;\n\tfor(int i=1;i<=tot;++i){\n\t\tint ql=Q[i].l,qr=Q[i].r,qt=Q[i].t;\n\t\twhile(t>qt) {\n\t\t\tif(ci[pos[t]]&1) {//\u8981\u4fee\u6539\u7684\u4f4d\u7f6e\u53ea\u88ab\u8ba1\u7b97\u4e86\u4e00\u6b21\uff0c\u4fee\u6539\u624d\u4f1a\u5bf9\u7b54\u6848\u4ea7\u751f\u5f71\u54cd\u3002\n\t\t\t\tdel(pos[t]);\n\t\t\t\tcol[pos[t]]=pre[t];\n\t\t\t\tadd(pos[t]);\n\t\t\t}\n\t\t\telse col[pos[t]]=pre[t];\n\t\t\t--t;\n\t\t}\n\t\twhile(t<qt) {\n\t\t\t++t;\n\t\t\tif(ci[pos[t]]&1){\n\t\t\t\tdel(pos[t]);\n\t\t\t\tcol[pos[t]]=then[t];\n\t\t\t\tadd(pos[t]);\n\t\t\t}\n\t\t\telse col[pos[t]]=then[t];\n\t\t}\t\t\n\t\twhile(l>ql)add(ref[--l]);\n\t\twhile(r<qr)add(ref[++r]);\n\t\twhile(l<ql)del(ref[l++]);\n\t\twhile(r>qr)del(ref[r--]);\n\t\tans[Q[i].i]=now;\n\t\tif(Q[i].lca)//\u628alca\u7684\u8d21\u732e\u52a0\u8fdb\u53bb \n\t\t\tans[Q[i].i]+=1ll*W[cnt[col[Q[i].lca]]+1]*V[col[Q[i].lca]];\n\t}\n\tfor(int i=1;i<=tot;++i)printf(\"%lld\\n\",ans[i]);\n\treturn 0;\n}\n```\n\n",
        "postTime": 1610961778,
        "uid": 79065,
        "name": "A1443356159",
        "ccfLevel": 0,
        "title": "\u6811\u4e0a\u5e26\u4fee\u83ab\u961f"
    },
    {
        "content": "[\u5404\u7c7b\u83ab\u961f\u7684\u8bb2\u89e3](https://cnyali-lk.com/Mo-s-Algorithm/)\n\n``` C++\n/*\nAuthor: CNYALI_LK\nLANG: C++\nPROG: luogu4074.cpp\nMail: cnyalilk@vip.qq.com\n*/\n#include<bits/stdc++.h>\n#define debug(...) fprintf(stderr,__VA_ARGS__)\n#define DEBUG printf(\"Passing [%s] in LINE %lld\\n\",__FUNCTION__,__LINE__)\n#define Debug debug(\"Passing [%s] in LINE %lld\\n\",__FUNCTION__,__LINE__)\n#define all(x) x.begin(),x.end()\nusing namespace std;\nconst double eps=1e-8;\nconst double pi=acos(-1.0);\ntypedef long long ll;\ntypedef pair<ll,ll> pii;\ntemplate<class T>ll chkmin(T &a,T b){return a>b?a=b,1:0;}\ntemplate<class T>ll chkmax(T &a,T b){return a<b?a=b,1:0;}\ntemplate<class T>T sqr(T a){return a*a;}\ntemplate<class T>T mmin(T a,T b){return a<b?a:b;}\ntemplate<class T>T mmax(T a,T b){return a>b?a:b;}\ntemplate<class T>T aabs(T a){return a<0?-a:a;}\n#define min mmin\n#define max mmax\n#define abs aabs\nll read(){\n    ll s=0,base=1;\n    char c;\n    while(!isdigit(c=getchar()))if(c=='-')base=-base;\n    while(isdigit(c)){s=s*10+(c^48);c=getchar();}\n    return s*base;\n}\nchar WritellBuffer[1024];\ntemplate<class T>void write(T a,char end){\n    ll cnt=0,fu=1;\n    if(a<0){putchar('-');fu=-1;}\n    do{WritellBuffer[++cnt]=fu*(a%10)+'0';a/=10;}while(a);\n    while(cnt){putchar(WritellBuffer[cnt]);--cnt;}\n    putchar(end);\n}\nll in[102424],out[102424],is[204848],t,dep[102424];\nll to[233333],lst[204847],beg[102423],e;\nll fa[102424][20];\nvoid dfs(ll x,ll f){\n    fa[x][0]=f;\n    dep[x]=dep[f]+1;\n    for(ll i=1;i<20;++i)fa[x][i]=fa[fa[x][i-1]][i-1];\n    is[in[x]=++t]=x;\n    for(ll i=beg[x];i;i=lst[i])if(to[i]!=f){\n        dfs(to[i],x);        \n    }\n    is[out[x]=++t]=x;\n}\nvoid add(ll u,ll v){\n    to[++e]=v;\n    lst[e]=beg[u];\n    beg[u]=e;\n/*------------------------*/\n    to[++e]=u;\n    lst[e]=beg[v];\n    beg[v]=e;\n}\nll block;\nstruct _ask{\n    ll l,r,id,lb,_add,T,rb;\n};\n_ask ask[102424];\nll lca(ll u,ll v){\n    if(dep[u]<dep[v])swap(u,v);\n    for(ll i=19;~i;--i)if(dep[u]-(1<<i)>=dep[v]){\n        u=fa[u][i];\n    }\n    for(ll i=19;~i;--i)if(fa[u][i]!=fa[v][i]){u=fa[u][i];v=fa[v][i];}\n    if(u!=v){\n        u=fa[u][0];v=fa[v][0];\n    }\n    return u;\n}\nll cmp(_ask a,_ask b){return a.lb<b.lb||a.lb==b.lb&&a.rb<b.rb||a.lb==b.lb&&a.rb==b.rb&&a.T<b.T;}\nll _is[102424],cnt[102424],tot,ans[102424];\nll V[102424],w[102424],c[102424];\nvoid ds(ll x){\n    if(_is[x]){\n        tot-=w[cnt[c[x]]]*V[c[x]];\n        --cnt[c[x]];\n    }\n    else{\n        tot+=w[++cnt[c[x]]]*V[c[x]];\n    }\n    _is[x]^=1;\n}\nll cTo[102424],cFr[102424],pt[102424];\nvoid rem(ll x){\n    if(_is[pt[x]]){\n        ds(pt[x]);\n        c[pt[x]]=cFr[x];\n        ds(pt[x]);\n    }\n    else\n    c[pt[x]]=cFr[x];\n}\nvoid add(ll x){\n    if(_is[pt[x]]){\n        ds(pt[x]);\n        c[pt[x]]=cTo[x];\n        ds(pt[x]);\n    }\n    else\n    c[pt[x]]=cTo[x];\n}\nint main(){\n#ifdef cnyali_lk\n    freopen(\"luogu4074.in\",\"r\",stdin);\n    freopen(\"luogu4074.out\",\"w\",stdout);\n#endif\n    ll n=read(),m=read(),q=0,u,v,_q=read();\n    for(ll i=1;i<=m;++i)V[i]=read();\n    for(ll i=1;i<=n;++i)w[i]=read();\n    for(ll i=1;i<n;++i){\n        add(read(),read());\n    }\n    dfs(1,0);\n// \tfor(ll i=1;i<=t;++i)printf(\"%lld%c\",is[i],i==t?'\\n':',');\n    block=(ll)ceil(pow(t,2./3));\n    for(ll i=1;i<=n;++i)c[i]=read();\n    ll T=0;\n    for(ll i=1;i<=_q;++i){\n        if(!read()){\n            pt[++T]=read();\n            cFr[T]=c[pt[T]];\n            cTo[T]=read();\n            c[pt[T]]=cTo[T];\n        }\n        else{\n            ask[++q].id=q;\n            ask[q].T=T;\n            u=read();v=read();\n            if(u==v){\n                ask[q].lb=ask[q].rb=(ask[q].l=ask[q].r=in[u])/block;\n                ask[q]._add=0;\n            }\n            else\n            if(in[u]<in[v]&&out[v]<out[u]){\n                ask[q].lb=(ask[q].l=in[u])/block;\n                ask[q].rb=(ask[q].r=in[v])/block;\n                ask[q]._add=0;\n            }\n            else if(in[u]>in[v]&&out[v]>out[u]){\n                ask[q].lb=(ask[q].l=in[v])/block;\n                ask[q].rb=(ask[q].r=in[u])/block;\n                ask[q]._add=0;\n            }\n            else{\n                if(out[u]>in[v]){\n                    swap(u,v);\n                }\n                ask[q].lb=(ask[q].l=out[u])/block;\n                ask[q].rb=(ask[q].r=in[v])/block;\n                ask[q]._add=lca(u,v);\n            }\n        }\n    }\n//\tfor(ll i=1;i<=q;++i)printf(\"%lld %lld %lld %lld\\n\",ask[i].l,ask[i].r,ask[i].T,ask[i]._add);\n    sort(ask+1,ask+q+1,cmp);\n    ll l=1,r=t;\n    for(ll i=1;i<=q;++i){\n        while(T>ask[i].T){\trem(T);--T;\t}\n        while(T<ask[i].T){\tadd(++T);\t}\n        while(l<ask[i].l){\n            ds(is[l]);\n            ++l;\n        }\n        while(l>ask[i].l){\n            ds(is[--l]);\n        }\n        while(r>ask[i].r){\n            ds(is[r]);\n            --r;\n        }\n        while(r<ask[i].r){\n            ds(is[++r]);\n        }\n        if(ask[i]._add)ds(ask[i]._add);\n        ans[ask[i].id]=tot;\n        if(ask[i]._add)ds(ask[i]._add);\n    }\n    for(ll i=1;i<=q;++i)printf(\"%lld\\n\",ans[i]);\n    return 0;\n}\n```\n\n",
        "postTime": 1523190275,
        "uid": 8943,
        "name": "\u8001K",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P4074 \u3010[WC2013]\u7cd6\u679c\u516c\u56ed\u3011"
    },
    {
        "content": "### \u5e7f\u544a\n\n[\u849f\u84bb\u7684\u535a\u5ba2-\u83ab\u961f\u7b97\u6cd5](http://www.cnblogs.com/dedicatus545/p/8503863.html)\n\n\u6db5\u76d6\u5404\u79cd\u83ab\u961f\uff5e\u6b22\u8fce\u5404\u4f4d\u83ca\u82e3\u524d\u6765\u6279\u5224\u4e00\u756a\n\n### \u5907\u6ce8\n\n\u8fd9\u7bc7\u9898\u89e3\u63d0\u4f9b\u4e86\u4e00\u79cd\u6bd4\u8f83\u76f4\u89c2\u7684\u83ab\u961f\u8f6c\u79fb\uff0c\u4e0d\u9700\u8981\u65b0\u5efa\u6811\u4e4b\u7c7b\u7684\uff5e\n\n### \u6b63\u6587\n\n\u6811\u4e0a\uff1f\uff1f\uff1f\uff1f\uff1f\n\n\u522b\u626f\u4e86\uff0c\u6811\u53c8\u4e0d\u662f\u5e8f\u5217.....\n\n\u8fd9\u662f\u6211\u770b\u5230\u6811\u4e0a\u83ab\u961f\u7684\u7b2c\u4e00\u60f3\u6cd5\n\n \n\n\u4f46\u662f\uff0c\u6211\u4eec\u8003\u8651\u5728\u6811\u4e0a\u8be2\u95ee\u4e0d\u540c\u989c\u8272\u7684\u4e2a\u6570\u7684\u95ee\u9898\uff0c\u53d1\u73b0\u8fd9\u4e48\u591a\u8be2\u95ee\u4e0b\u6765\uff0c\u91cd\u590d\u7684\u4f9d\u7136\u5f88\u591a\uff0c\u83ab\u961f\u7684\u201c\u6d88\u9664\u91cd\u590d\u201d\u601d\u60f3\u4f9d\u7136\u53ef\u4ee5\u5b9e\u73b0\n\n\u800c\u4e14\u8c01\u8bf4\u6811\u4e0a\u4e0d\u80fd\u5e8f\u5217\u5316\u4e86\uff1fdfs\u5e8f\u542c\u4e86\u8fd9\u8bdd\u60f3\u6253\u4eba......\n\n \n\n\u5148\u8003\u8651\u5bf9\u5b50\u6811\u7684\u8be2\u95ee\uff1a\u4e00\u68f5\u6811\uff0c \u6bcf\u4e2a\u8282\u70b9\u90fd\u6709\u989c\u8272\uff0c \u6bcf\u6b21\u95ee\u4f60\u4e00\u4e2a\u5b50\u6811\u4e2d\u6709\u591a\u5c11\u4e0d\u540c\u7684\u989c\u8272\n\n\u6211\u4eec\u53d1\u73b0\u4e00\u68f5\u5b50\u6811\u5728dfs\u5e8f\u4e0a\u4e00\u5b9a\u662f\u8fde\u7eed\u7684\n\n\u90a3\u6211\u4eec\u628adfs\u5e8f\u6c42\u51fa\u6765\uff0c\u518d\u505a\u6807\u51c6\u83ab\u961f\u7684\u8fc7\u7a0b\u5c31\u6ca1\u95ee\u9898\u4e86 \uff0c\u751a\u81f3\u53ef\u4ee5\u5e26\u4e0a\u4fee\u6539\n\n \n\n\u4f46\u662f\uff0c\u6811\u4e0a\u63d0\u95ee\u53ef\u4e0d\u6b62\u5b50\u6811\u8be2\u95ee\uff0c\u6211\u4eec\u9047\u5230\u7684\u66f4\u591a\u662f\u6811\u4e0a\u4e24\u70b9\u4e4b\u95f4\u7684\u8def\u5f84\u7684\u8be2\u95ee\n\n\u4f46\u662f\u8fd9\u79cd\u65f6\u5019\u4e00\u6761\u8def\u5f84\u5728dfs\u5e8f\u4e0a\u53ef\u5c31\u4e0d\u662f\u8fde\u7eed\u7684\u4e86\n\n\u96be\u9053\u6211\u4eec\u6811\u5256\uff1f\u5e38\u6570\u5361\u6b7b\u4eba......\n\n\u4e0d\u6025\uff0c\u6211\u4eec\u6765\u63a8\u5bfc\u4e00\u4e0b\u600e\u4e48\u8f6c\u79fb\u5427\n\n\u6211\u4eec\u8003\u8651\u8fd9\u6837\u4e00\u4e2a\u6811\uff0c\u56fe\u793a\u662f\u6811\u7684\u4e00\u90e8\u5206\uff08\u4e5f\u5c31\u662f\u8fd9\u4e24\u4e2a\u8be2\u95ee\u6d89\u53ca\u7684\u90e8\u5206\uff09\n\n![\u5947\u602a\u7684\u6811\u7684\u4e00\u90e8\u5206](https://cdn.luogu.com.cn/upload/pic/15786.png )\n\n\u6211\u4eec\u5f53\u524d\u5904\u7406\u51fa\u6765\u7684\u662f\u8be2\u95ee(1,6)\u7684\u7b54\u6848\uff0c\u4e5f\u5c31\u662f\u8fd9\u6761\u9ec4\u8272\u8def\u5f84\n\n\u6211\u4eec\u4e0b\u4e00\u4e2a\u8981\u6c42\u7684\u662f\u84dd\u8272\u8def\u5f84(2,4)\u7684\u7b54\u6848\n\n\u8fd9\u79cd\u60c5\u51b5\u4e0b\u6211\u4eec\u53d1\u73b0\uff0c\u5176\u5b9e\u6bcf\u6b21\u589e\u52a0\u7684\u5c31\u662flca(1,2)\u52302\uff0c\u4ee5\u53calca(4,6)\u52304\u7684\u90a3\u4e9b\u8282\u70b9\n\n\u540c\u65f6lca(1,2)\u52301\uff0c\u4ee5\u53calca(4,6)\u52306\u7684\u8def\u5f84\u4e0a\u7684\u8282\u70b9\u8981\u53bb\u6389\n\n\u8bf6\uff1f\n\n\u90a3\u5c82\u4e0d\u662f\u53ef\u4ee5\u6c42\u51fa\u4e24\u4e2alca\uff0c\u7136\u540e\u628a\u8fd9\u4e24\u5bf9\u70b9\u8def\u5f84\u4e0a\u9664\u4e86lca\u7684\u70b9\u7684\u72b6\u6001\u90fd\u53cd\u8fc7\u6765\u5c31\u53ef\u4ee5\u4e86\uff1f\n\n \n\n\u522b\u6025\u8fd9\u53ea\u662f\u4e00\u79cd\u60c5\u51b5\uff0c\u4f46\u662f\u8fd9\u4e2a\u7ed3\u8bba\uff0c\u5b9e\u9645\u4e0a\u662f\u5bf9\u7684\n\n\u6211\u4eec\u8bf4\u7684\u591a\u79cd\u60c5\u51b5\uff0c\u65e0\u975e\u5c31\u662f\u4e24\u4e2alca\u5728\u6811\u4e0a\u7684\u4f4d\u7f6e\u5173\u7cfb\n\n\u800c\u8fd9\u4e00\u4f4d\u7f6e\u5173\u7cfb\uff0c\u5b9e\u9645\u4e0a\u53d6\u51b3\u4e8e\u4e24\u4e2a\u8be2\u95ee\u7684\u4e24\u7aef\u8282\u70b9\u7684lca\u7684\u4f4d\u7f6e\u5173\u7cfb\uff08\u6709\u70b9\u7ed5\uff0c\u4e00\u5b9a\u8981\u770b\u6e05\u695a\uff09\n\n\u800c\u8fd9\u4e2a\u5173\u7cfb\u8981\u4e48\u5c31\u662f\u7236\u4eb2-\u513f\u5b50\uff0c\u8981\u4e48\u5c31\u662f\u6beb\u4e0d\u76f8\u5e72\n\n\u4e0a\u9762\u90a3\u79cd\u60c5\u51b5\u5c31\u662f\u7236\u4eb2-\u513f\u5b50\uff0c\u6b64\u65f6lca(1,2) and lca(4,6)\u4e2d\u95f4\u7684\u90a3\u4e9b\u8282\u70b9\u4e0d\u4f1a\u53d7\u5230\u5f71\u54cd\n\n\u800c\u4e24\u4e2a\u539flca\u5982\u679c\u76f8\u79bb\u7684\u8bdd\uff0c\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u4e2d\u95f4\u7684\u90a3\u6bb5\u8282\u70b9\u88ab\u5904\u7406\u4e86\u4e24\u6b21\uff0c\u4e5f\u5c31\u662f\u53cd\u8f6c\u518d\u53cd\u8f6c\uff0c\u5b9e\u9645\u4e0a\u6ca1\u6709\u52a8\n\n\u56e0\u6b64\u8fd9\u4e2a\u8f6c\u79fb\u65b9\u5f0f\u662f\u5408\u6cd5\u7684\n\n \n\n\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\uff1a\u4e24\u6761\u8def\u5f84\u4e0a\u7684lca\u662f\u5426\u6536\u5230\u5f71\u54cd\u5462\uff1f\n\n\u5173\u4e8e\u8fd9\u4e00\u70b9\uff0c\u6211\u4eec\u53d1\u73b0\uff0clca(1,2)\u4e0elca(4.6)\uff0c\u5728\u4efb\u4f55\u60c5\u51b5\u4e0b\u90fd\u4e0d\u5e94\u8be5\u88ab\u78b0\u5230\uff0c\u56e0\u6b64\u6211\u4eec\u4e0d\u80fd\u6539\u53d8\u5b83\u4eec\u7684\u72b6\u6001\n\n\u4f46\u662f\u6709\u4e00\u4e2a\u70b9\u662f\u9700\u8981\u6ce8\u610f\u7684\uff1a\u5c31\u662f\u65b0\u7684\u8be2\u95ee\u4e24\u7aef\u7684lca\n\n\u8fd9\u4e2a\u70b9\u5728\u524d\u9762\u7684\u8f6c\u79fb\u4e2d\u4f1a\u88ab\u53cd\u8f6c\u6389\uff0c\u56e0\u6b64\u6211\u4eec\u9700\u8981\u628a\u5b83\u53cd\u8f6c\uff0c\u7edf\u8ba1\u7b54\u6848\uff0c\u518d\u8f6c\u56de\u53bb\u4ee5\u514d\u5f71\u54cd\u4e0b\u4e00\u4e2a\u8be2\u95ee\n\n \n\n\u540c\u6837\uff0c\u8fd9\u6837\u505a\u7684\u65f6\u95f4\u6548\u7387\uff0c\u5728\u6bcf\u4e00\u5757\u5206sqrt(n)\u65f6\uff0c\u662f\u5728O(nsqrt(n))\u5de6\u53f3\uff0c\u5e26\u4e86\u4fee\u6539\u4e5f\u662fO(n^(5/3))\n\n\u8fd9\u9053\u9898\u5c31\u662f\u4e00\u4e2a\u5e26\u4fee\u6539\u7684\u6811\u4e0a\u83ab\u961f\u6a21\u677f\u54af\n\n\u653e\u4e00\u4e0b\u4ee3\u7801\uff1a\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<cstring>\n#include<algorithm>\n#include<cmath>\n#define ll long long\nusing namespace std;\ninline ll read(){\n    ll re=0,flag=1;char ch=getchar();\n    while(ch>'9'||ch<'0'){\n        if(ch=='-') flag=-1;\n        ch=getchar();\n    }\n    while(ch>='0'&&ch<='9') re=(re<<1)+(re<<3)+ch-'0',ch=getchar();\n    return re*flag;\n}\nstruct edge{\n    ll to,next;\n}a[200010];\nll n,m,Q,first[100010],cntt,clk,block;\nll fa[100010],dep[100010],st[100010][20],dfn[100010];\nll v[100010],w[100010],x[100010];\ninline void add(ll u,ll v){\n    a[++cntt]=(edge){v,first[u]};first[u]=cntt;\n    a[++cntt]=(edge){u,first[v]};first[v]=cntt;\n}\nvoid dfs(ll u,ll f){//dfs\u9884\u5904\u7406dfn\u5e8f\n    ll i,v;\n    fa[u]=st[u][0]=f;dep[u]=dep[f]+1;dfn[u]=++clk;\n    for(i=first[u];~i;i=a[i].next){\n        v=a[i].to;\n        if(v==f) continue;\n        dfs(v,u);\n    }\n}\nvoid init(){\n    for(ll i=1;i<=18;i++){\n        for(ll j=1;j<=n;j++){\n            st[j][i]=st[st[j][i-1]][i-1];\n        }\n    }\n}\nvoid _swap(ll &l,ll &r){l^=r;r^=l;l^=r;}\nll LCA(ll l,ll r){\n    if(dep[l]>dep[r]) _swap(l,r);\n    ll i;\n    for(i=18;i>=0;i--) if(dep[st[r][i]]>=dep[l]) r=st[r][i];\n    if(l==r) return l;\n    for(i=18;i>=0;i--){\n        if(st[l][i]!=st[r][i]){\n            l=st[l][i];r=st[r][i];\n        }\n    }\n    return fa[l];\n}\nll curl,curr,curc,cntq,cntc,cnt[1000010];bool vis[100010];\nll ans[100010],tot;\nstruct query{//l,r\u5c31\u662f\u8be2\u95ee\u7684\u5de6\u53f3\u7aef\u70b9\uff0cc\u5c31\u662f\u5728\u7b2c\u51e0\u6b21\u4fee\u6539\u4e4b\u540e\uff0ci\u662f\u5b83\u672c\u6765\u662f\u7b2c\u51e0\u4e2a\u8be2\u95ee\uff08\u8f93\u51fa\u7528\u7684\uff09\n    ll l,r,c,i;\n}q[100010];\nbool cmp(query l,query r){//\u81ea\u5b9a\u4e49\u7684\u6392\u5e8f\n    if(dfn[l.l]/block!=dfn[r.l]/block) return dfn[l.l]/block<dfn[r.l]/block;\n    else{\n        if(dfn[l.r]/block!=dfn[r.r]/block) \n            return dfn[l.r]/block<dfn[r.r]/block;\n        else return l.c<r.c;\n    }\n}\nstruct change{\n    ll pos,to;\n}c[100010];\nvoid rev(ll i){//\u53cd\u8f6c\u8282\u70b9\u72b6\u6001\n    if(vis[i]) vis[i]=0,tot-=v[x[i]]*w[cnt[x[i]]],cnt[x[i]]--;\n    else vis[i]=1,cnt[x[i]]++,tot+=v[x[i]]*w[cnt[x[i]]];\n}\nvoid change(ll i){\n    if(!vis[c[i].pos]) _swap(c[i].to,x[c[i].pos]);\n    else{\n        rev(c[i].pos);\n        _swap(c[i].to,x[c[i].pos]);\n        rev(c[i].pos);\n    }\n}\nint main(){\n    memset(first,-1,sizeof(first));\n    ll i,t1,t2,t3;\n    n=read();m=read();Q=read();block=(ll)pow(n,0.60);\n    for(i=1;i<=m;i++) v[i]=read(); \n    for(i=1;i<=n;i++) w[i]=read();\n    for(i=1;i<n;i++){\n        t1=read();t2=read();add(t1,t2);\n    }\n    for(i=1;i<=n;i++) x[i]=read();\n    dfs(1,0);init();\n    for(i=1;i<=Q;i++){\n        t1=read();t2=read();t3=read();\n        if(t1) q[++cntq].l=t2,q[cntq].r=t3,q[cntq].c=cntc,q[cntq].i=cntq;\n        else c[++cntc].pos=t2,c[cntc].to=t3;\n    }\n    sort(q+1,q+cntq+1,cmp);\n    \n    //\u50cf\u5e38\u89c4\u83ab\u961f\u4e00\u6837\u5148\u628a\u7b2c\u4e00\u4e2a\u8282\u70b9\u5904\u7406\u4e86\n    if(dfn[q[1].l]>dfn[q[1].r]) _swap(q[1].l,q[1].r);\n    ll lca=LCA(q[1].l,q[1].r),l,r;curl=q[1].l;curr=q[1].r;\n    l=curl;r=curr;\n    while(l!=lca) rev(l),l=fa[l];\n    while(r!=lca) rev(r),r=fa[r];\n    while(curc<q[1].c) change(++curc);\n    rev(lca);ans[q[1].i]=tot;rev(lca);\n    \n    for(i=2;i<=cntq;i++){\n        if(dfn[q[i].l]>dfn[q[i].r]) _swap(q[i].l,q[i].r);\n        lca=LCA(curr,q[i].r);l=curr;r=q[i].r;\n        while(l!=lca) rev(l),l=fa[l];\n        while(r!=lca) rev(r),r=fa[r];\n        lca=LCA(curl,q[i].l);l=curl;r=q[i].l;\n        while(l!=lca) rev(l),l=fa[l];\n        while(r!=lca) rev(r),r=fa[r];\n        while(curc>q[i].c) change(curc--);\n        while(curc<q[i].c) change(++curc);\n        lca=LCA(q[i].l,q[i].r);\n        rev(lca);ans[q[i].i]=tot;rev(lca);//\u7279\u6b8a\u5904\u7406lca\n        curl=q[i].l;curr=q[i].r;\n    }\n    for(i=1;i<=cntq;i++) printf(\"%lld\\n\",ans[i]);\n}\n```",
        "postTime": 1521363063,
        "uid": 27753,
        "name": "Orion545",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P4074 \u3010[WC2013]\u7cd6\u679c\u516c\u56ed\u3011"
    },
    {
        "content": "\u8bfb\u5b8c\u9898\u9762 \u5c31\u53d1\u73b0\u662f\u4e00\u9053\u83ab\u961f\u9898\n\n### \u8981\u4e0a\u6811 \u5e26\u4fee\u6539\n\n \u90a3\u4e48\u8fd9\u5c31\u662f\u4e00\u9053\u6811\u4e0a\u5f85\u4fee\u83ab\u961f\u7684~~\u6a21\u677f~~\u9898\u4e86\u3002\u53ef\u4ee5\u8bf4\u8fd9\u662f\u83ab\u961f\u7684\u4e00\u9053\u6bd5\u4e1a\u9898\uff0c\u63c9\u548c\u4e86\u51e0\u4e4e\u83ab\u961f\u7684\u6240\u6709\u6269\u5c55\u7b97\u6cd5\n \n \n   \n   ~~\u56de\u6eda\u83ab\u961f\uff1a\u6211\u4e0d\u914d\u62e5\u6709\u540d\u5b57~~\n   \n   ~~lxl \u7684\u5404\u7c7b\u6bd2\u7624\u83ab\u961f\u9664\u5916~~\n   \n \n \u4e3a\u4e86\u5728\u6811\u4e0a\u80fd\u591fO(1)\u8f6c\u79fb\u72b6\u6001\uff08\u4f7f\u7528\u83ab\u961f\uff0c\u6211\u4eec\u9700\u8981\u4e00\u4e2a\u65b9\u6cd5\u628a\u6811\u4e0a\u8282\u70b9\u8f6c\u79fb\u6210\u4e00\u4e2a\u5e8f\u5217\n \n \u6811\u8f6c\u5e8f\u5217\uff0c\u7b2c\u4e00\u65f6\u95f4\u6211\u4eec\u5c31\u60f3\u5230\u4e86dfs\u5e8f,\u6211\u4eec\u8bb0\u5f55\u4e0bDfs\u904d\u5386\u5230\u7684\u70b9\u7b2c\u4e00\u6b21\u548c\u7b2c\u4e8c\u6b21\u7684\u4f4d\u7f6e\u548c\u65f6\u95f4\uff0c\u56e0\u4e3a\u8bb0\u5f55\u65b9\u5f0f\u8ddf\u62ec\u53f7\u5e8f\u5217\u6709\u7740\u76f8\u4f3c\u7684\u5730\u65b9\uff0c\u8fd9\u6837\u6709\u4e24\u6b21\u51fa\u73b0\u7684\u70b9\u4f1a\u62b5\u6d88\u6389\u3002\u8fd9\u6837\u7684\u4f7f\u5f97\u533a\u95f4\u904d\u5386\u53d8\u5f97\u53ef\u884c\u3002\n \n \u5728\u6700\u521dDfs\u65f6\u5c31\u53ef\u4ee5\u5904\u7406\u6389\u4e86\n \n ```cpp\ninline void Dfs(Rint x){\n    order[++cnt] = x; //dfs\u5e8f \n    first[x] = cnt;\t//\u7b2c\u4e00\u6b21\u51fa\u73b0\u7684\u65f6\u95f4 \n    for(Rint i = head[x]; i + 1; i = nex[i]){  //\u90bb\u63a5\u8868\u904d\u5386\u5b50\u6811\n        Rint y = to[i];\n        if(y == fath[x][0])\n            continue;\n        fath[y][0] = x; // \u8bb0\u5f55\u7236\u4eb2\u8282\u70b9 \n        dep[y] = dep[x]\t+ 1; // \u66f4\u65b0\u5b50\u8282\u70b9\u6df1\u5ea6 \n        for(Rint j = 1; (1 << j) <= dep[y]; j++) // \u500d\u589e\u9884\u5904\u7406 \n            fath[y][j] = fath[fath[y][j-1]][j-1];\n        Dfs(y);\t\n    }\n    order[++cnt] = x;  \n    last[x] = cnt;\t//\u7b2c\u4e8c\u6b21\u51fa\u73b0\u7684\u65f6\u95f4 \n}\n```\n\n\u6839\u636e\u62ec\u53f7\u5e8f\u5217\u5e8f\u7684\u6027\u8d28\uff0c\u5bf9\u4e8eu\u548cv\u4e24\u4e2a\u70b9\uff0c\u6211\u4eec\u9700\u8981\u8003\u8651\u4e24\u79cd\u60c5\u51b5\uff0c\u5176\u4e2d\u5f53lca(u,v)!=u\u4e14lca(u,v)!=v\u65f6\uff0c\u8fd9\u65f6\u5176\u5b9e\u5728\u5e8f\u5217\u4e2d\u6211\u4eec\u662f\u627e\u4e0d\u5230lca\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u5c31\u9700\u8981\u7279\u522b\u7684\u5c06lca\u8fdb\u884c\u52a0\u5165\u5904\u7406\uff0c\u5de6\u8fb9\u7684\u8bbf\u95ee\u8fb9\u754c\u4e5f\u5e94\u8be5\u662f\u70b9\u7b2c\u4e8c\u6b21\u51fa\u73b0\u7684\u4f4d\u7f6e(\u5b9e\u5728\u65e0\u6cd5\u7406\u89c1\u4e0b)\uff0c\u4e0d\u7136\u4f1a\u62b5\u6d88\u6389\uff1b\u800c\u53e6\u4e00\u79cd\u60c5\u51b5\u5219\u662fu,v\u4e24\u70b9\u4e2d\u6709\u4e00\u70b9\u4e3a\u53e6\u4e00\u70b9\u7684\u7956\u5148\u65f6\uff0c\u76f4\u63a5\u5904\u7406\u5373\u53ef\u3002\n\n![](https://i.loli.net/2019/07/17/5d2f0df54da1127718.png)\n\n\u6211\u4eec\u8981\u6c42\u7684\u533a\u95f4\u4e3a[2,3]\u4f46\u5b9e\u9645\u4e0a\u5728dfs\u5e8f\u4e2d2~3\u4e2d\u5e76\u4e0d\u5305\u62ec\u5b83\u4eec\u7684lca\u8282\u70b91\n\n\u53e6\u5916\uff0c\u56e0\u4e3a\u9898\u76ee\u662f\u5e26\u4fee\u7684\uff0c\u6240\u4ee5\u8981\u52a0\u4e0a\u65f6\u95f4\u8fd9\u4e00\u7ef4\u5ea6\uff0c\u5176\u4f59\u7684\u5957\u6a21\u677f\u5c31\u884c\u5566\uff01\n\n\u7ec6\u8282\u89c1\u5168\u4ee3\u7801\uff1a\n\n```cpp\n#include <bits/stdc++.h>\n\n#define scf scanf\n#define ptf printf\n\n#define ll long long \n#define ull unsigned long long\n#define Rint register int \n\n#define max(a,b) ((a) > (b) ? (a) : (b))\n#define min(a,b) ((a) > (b) ? (b) : (a))\n\nusing namespace std;\nconst int N = 1e6+101;\nint w_[N], v_[N];\nint vis[N], pla[N], chg[N], cdy[N], num[N];\nint cnt = 0, tot = 0, len;\nint now_0 = 0, now_1 = 0;\nll ans[N], ans_ = 0;\nint belong[N];\nint fath[N][30], dep[N], first[N], last[N], order[N];\nint head[N], to[N], nex[N];\nstruct Q{\n    int l,r;\n    int id;\n    int lca,t;\n}qt[N];\ninline int read(){\n    int x=0,f = 1;\n    char ch = getchar();\n    while(!isdigit(ch)){\n        if(ch == '-')\n            f = -1;\n        ch = getchar();\t\n    }\n    while(isdigit(ch)){\n        x = (x << 1) + (x << 3) + (ch ^ 48);\n        ch = getchar();\n    }\n    return x*f;\n}\ninline int cmp(Q x, Q y){ // \u6392\u5e8f \n    return (belong[x.l] ^ belong[y.l]) ? belong[x.l] < belong[y.l] :((belong[x.r] ^ belong[y.r]) ? belong[x.r] < belong[y.r] : x.t < y.t);\n}\ninline void add_e(Rint u, Rint v){ //\u5efa\u8fb9 \n    to[++tot] = v;\n    nex[tot] = head[u];\n    head[u] = tot;\n}\ninline void Dfs(Rint x){ // dfs\u5904\u7406dfs\u5e8f\u7b49 \n    order[++cnt] = x; \n    first[x] = cnt;\t\n    for(Rint i = head[x]; i + 1; i = nex[i]){  \n        Rint y = to[i];\n        if(y == fath[x][0])\n            continue;\n        fath[y][0] = x; \n        dep[y] = dep[x]\t+ 1;\n        for(Rint j = 1; (1 << j) <= dep[y]; j++)\n            fath[y][j] = fath[fath[y][j-1]][j-1];\n        Dfs(y);\t\n    }\n    order[++cnt] = x;  \n    last[x] = cnt;\t \n}\ninline int Lca(Rint x, Rint y){ // \u500d\u589e\u6c42lca \n    if(dep[x] < dep[y])\n        swap(x,y);\n    for(Rint i = 20; i >= 0; i--){\n    \tif(dep[x] - (1 << i) >= dep[y])\n            x = fath[x][i];\n    \tif(x == y)\n        \treturn x;\n    }   \n    for(Rint i = 20; i >= 0; i--)\n        if(fath[x][i] != fath[y][i])\n            x = fath[x][i], y = fath[y][i];\n    return fath[x][0];\t\t\t\t\t\t\n}\ninline void add(Rint x){\n    ans_ += (ll)v_[cdy[x]] * w_[++num[cdy[x]]];\n}\ninline void del(Rint x){\n    ans_ -= (ll)v_[cdy[x]] * w_[num[cdy[x]]--];\n}\ninline void move(Rint x){ //\t\u8fdb\u884c\u52a0/\u5220\u70b9\u64cd\u4f5c \n    vis[x] ? del(x) : add(x);\n    vis[x] ^= 1; //\u6807\u8bb0\u662f\u5426\u6765\u5230\u8fc7\u5f53\u524d\u70b9 \u5982\u679c\u6765\u8fc7\uff0c\u90a3\u4e48\u8fd9\u6b21\u8bbf\u95ee\u64cd\u4f5c\u4e00\u5b9a\u662f\u79bb\u5f00\uff0c \u53cd\u4e4b\u4ea6\u7136 \n}\ninline void change(Rint x){ //\u5e26\u4fee \u56de\u5230\u65f6\u95f4\u4e3atim\u8fd9\u4e2a\u72b6\u6001 \n    if(vis[pla[x]]){\n        move(pla[x]);\n        swap(cdy[pla[x]], chg[x]);\n        move(pla[x]);\n    }\n    else\n        swap(cdy[pla[x]], chg[x]); \n}\nint main(){\n    memset(head, -1, sizeof head);\n    memset(dep, 0, sizeof dep);\n    memset(vis, 0, sizeof vis);\n    int n = read(), m = read(), q_num = read();\n    for(Rint i = 1; i <= m; i++)\n        v_[i] = read();\n    for(Rint i = 1; i <= n; i++)\n        w_[i] = read();\n    for(Rint i = 1; i < n; i++){\n        int u = read(), v = read();\n        add_e(u, v), add_e(v, u);\n    }\n    for(Rint i = 1; i <= n ; i++)\n        cdy[i] = read();\n    dep[1] = 1;\n    Dfs(1);\t\n    len = pow(cnt, 2.0 / 3.0); // \u5e26\u4fee\u83ab\u961f\u5206\u5757\u5927\u5c0f \n    int part = ceil((double) cnt / len);\n    for(Rint i = 1; i <= part; i++)\n        for(Rint j = len * (i - 1) + 1; j <= i * len; j++) //\u5904\u7406\u533a\u95f4\u67e5\u8be2\u7684\u5de6\u53f3\u8fb9\u754c\u5728\u5757\u7684\u4f4d\u7f6e \n            belong[j] = i;\n    for(Rint i = 1; i <= q_num; i++){\n        int type = read();\n        if(type == 0){\n            ++now_1;\n            pla[now_1] = read();\n            chg[now_1] = read(); \t\n        }\n        else if(type == 1){\n            int l = read(), r = read(), lca = Lca(l, r);\n            ++now_0;\n            qt[now_0].id = now_0,qt[now_0].t = now_1;\n            if(dep[l] > dep[r]) //\u4fdd\u8bc1 l\u7684\u6df1\u5ea6\u66f4\u6d45 \n                swap(l, r);\n            if(l == lca)\n                qt[now_0].l = first[l], qt[now_0].r = first[r]; // \u60c5\u51b5 2 \n            else\n                qt[now_0].l = last[l], qt[now_0].r = first[r], qt[now_0].lca = lca; //\u60c5\u51b5 1 \n        }\n    }\t\n    sort(qt + 1,qt + now_0 + 1,cmp);\n    int l = 1, r = 0, momt = 0;\n    for(Rint i = 1; i <= now_0; i++){ // \u83ab\u961f\u6b63\u5e38 \n        int L = qt[i].l, R = qt[i].r, tim = qt[i].t, lca = qt[i].lca;\n        while(l < L)\n            move(order[l++]);\n        while(l > L) \n            move(order[--l]);\n        while(r < R)\n            move(order[++r]);\n        while(r > R)\n            move(order[r--]);\n        while(momt < tim) //\u5e26\u4fee \n            change(++momt);\n        while(momt > tim) //\u540c\u4e0a \n            change(momt--);\n        if(lca)\t\t\n            move(lca);\n        ans[qt[i].id] = ans_; //\u8bb0\u5f55\u7b54\u6848 \n        if(lca)\n            move(lca);\n    }\n    for(Rint i = 1; i <= now_0; i++)\n        ptf(\"%lld\\n\", ans[i]);\n    return 0;    \n}\n```\n\n",
        "postTime": 1563365048,
        "uid": 116460,
        "name": "\u6faalane",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P4074 \u3010[WC2013]\u7cd6\u679c\u516c\u56ed\u3011"
    },
    {
        "content": "## \u6811\u4e0a\u5e26\u4fee\u83ab\u961f\n~~\u542c\u7740\u5c31\u5f88\u9ad8\u5927\u4e0a\u5bf9\u4e0d\u5bf9~~\n\n\u9996\u5148 \u6811\u4e0a\u5e26\u4fee\u83ab\u961f=\u6811\u4e0a\u83ab\u961f+\u5e26\u4fee\u83ab\u961f ~~\u5e9f\u8bdd~~\n\n#### \u6811\u4e0a\u5206\u5757\u8be6\u89c1 [SCOI2005]\u738b\u5ba4\u8054\u90a6\n#### \u5e26\u4fee\u83ab\u961f\u89c1 P1903 [\u56fd\u5bb6\u96c6\u8bad\u961f]\u6570\u989c\u8272 / \u7ef4\u62a4\u961f\u5217\nso \u5f53\u4f60AC\u4e86\u8fd9\u4e24\u9053\u9898,\u5c31\u53ef\u4ee5\u6bd4\u8f83\u8f7b\u677e\u5730\u505a\u8fd9\u9053\u4e86\n\n### \u7b80\u5355\u8bb2\u4e00\u4e0b\u6811\u4e0a\u83ab\u961f\u601d\u60f3\n\u5047\u8bbe\u8981\u4ecev1v2\u8f6c\u6362\u5230u1u2,\u5219lca(v1,u1)\u5230lca(v2,u2)\u8fd9\u4e00\u6bb5\u662f\u4e0d\u7528\u6539\u7684 ~~\u5e94\u8be5\u5f88\u597d\u60f3\u5427~~\n\n\u6240\u4ee5\u628av1,u1\u5230lca(v1,u1)\u548cv2,u2\u5230lca(v2,u2)\u4fee\u6539\u5c31\u597d\u4e86\n\n\u7136\u540e\u662f\u4ee3\u7801\u7684\u5b9e\u73b0:\n```cpp\n\n    void qxg(long long x,long long y)//\u5982\u4e0a\u6587\n    {\n        if(d[x]<d[y])\n        swap(x,y);\n        while(d[x]>d[y])\n        {\n            qf(x);\n            x=f[0][x];\n        }\n        while(x!=y)\n        {\n            qf(x);\n            qf(y);\n            x=f[0][x];\n            y=f[0][y];\n        }\n    }\n\n\n    for(i=0;i<cq;i++)\n    {\n        qxg(u,mq[i].u);\n        qxg(v1,mq[i].v);\n        u=mq[i].u;\n        v1=mq[i].v;\n        while(now<mq[i].t)//\u5e26\u4fee\u83ab\u961f\u7684\u6a21\u7248\n        xg(++now);\n        while(now>mq[i].t)\n        xg(now--);\n        l=lca(u,v1);\n        qf(l);\n        ans[mq[i].id]=an;\n        qf(l);\n    }\n```\n\n\u7136\u540e\u73b0\u5728\u4ee5\u53d6\u5230\u7684\u70b9\u7528\u4e00\u4e2av\u6570\u7ec4\u8bb0\u5f55\u7136\u540e\u6bcf\u6b21\u53d6\u53cd\u5c31\u53ef\u4ee5\u4e86\n```cpp\n\n    void qf(long long x)\n    {\n        if(bj[x])\n        an-=v[g[x]]*w[num[g[x]]--];//\u7528num\u8bb0\u5f55\u5df2\u5403\u5230\u8be5\u7cd6\u679c\u51e0\u6b21\n        else \n        an+=v[g[x]]*w[++num[g[x]]];\n        bj[x]^=1;\n    }\n```\n\n\n### code:\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<cstring>\n#include<algorithm>\n#include<cmath>\nusing namespace std;\nlong long n,m,z[100005],k,b[100005],s,c[100005],h[100005],cnt,B,q,v[100005],w[100005],d[100005],f[25][100005],cc,cq,now,an,ans[100005],bj[100005],num[100005],g[100005];\nstruct ll\n{\n    long long nx;\n    long long to;\n}a[200005];\nstruct mdc\n{\n    long long p;\n    long long x;\n}mc[100005];\nstruct mdq\n{\n    long long u;\n    long long v;\n    long long t;\n    long long id;\n    bool operator<(mdq& y)\n    {\n    return b[u]==b[y.u]?(b[v]==b[y.v]?t<y.t:b[v]<b[y.v]):b[u]<b[y.u];\n    }\n}mq[100005];\nvoid ad(long long x,long long y)\n{\n    a[++cnt].to=y;\n    a[cnt].nx=h[x];\n    h[x]=cnt;\n}\nvoid dfs(int u)\n{\n    int t=k;\n    for (int i=h[u];i;i=a[i].nx)\n    {\n        int v=a[i].to;\n        if (v!=f[0][u])\n        {\n            f[0][v]=u;\n            d[v]=d[u]+1;\n            dfs(v);\n            if (k-t>=B)\n            {\n                ++s;\n                while (k>t)\n                b[z[k--]]=s;\n            }\n        }\n    }\n    z[++k]=u;\n}\nvoid qf(long long x)\n{\n    if(bj[x])\n    an-=v[g[x]]*w[num[g[x]]--];\n    else \n    an+=v[g[x]]*w[++num[g[x]]];\n    bj[x]^=1;\n}\nvoid xg(long long x)\n{\n    if(bj[mc[x].p])\n    {\n        qf(mc[x].p);\n        swap(g[mc[x].p],mc[x].x);\n        qf(mc[x].p);\n    }\n    else swap(g[mc[x].p],mc[x].x);\n}\nlong long lca(long long x,long long y)//lca\u5c31\u4e0d\u591a\u8bf4\u4e86\n{\n    long long i;\n    if(d[x]<d[y])\n    swap(x,y);\n    for(i=0;i<=16;++i)\n    if((d[x]-d[y])&(1<<i))\n    x=f[i][x];\n    if(x==y)\n    return x;\n    for(i=16;i>=0;--i)\n    if(f[i][x]!=f[i][y])\n    {\n        x=f[i][x];\n        y=f[i][y];\n    }\n    return f[0][x];\n}\nvoid qxg(long long x,long long y)\n{\n    if(d[x]<d[y])\n    swap(x,y);\n    while(d[x]>d[y])\n    {\n        qf(x);\n        x=f[0][x];\n    }\n    while(x!=y)\n    {\n        qf(x);\n        qf(y);\n        x=f[0][x];\n        y=f[0][y];\n    }\n}\nint main()\n{\n    long long i,j,x,y,o,u=1,v1=1,l;\n    scanf(\"%lld%lld%lld\",&n,&m,&q);\n    B=pow(n,0.666);\n    for(i=1;i<=m;i++)\n    scanf(\"%lld\",&v[i]);\n    for(i=1;i<=n;i++)\n    scanf(\"%lld\",&w[i]);\n    for(i=1;i<n;i++)\n    {\n        scanf(\"%lld%lld\",&x,&y);\n        ad(x,y);\n        ad(y,x);\n    }\n    dfs(1);\n    while(k)\n    b[z[k--]]=s;\n    for(i=1;i<=16;i++)\n    for(j=1;j<=n;j++)\n    f[i][j]=f[i-1][f[i-1][j]];\n    for(i=1;i<=n;i++)\n    scanf(\"%lld\",&g[i]);\n    for(i=1;i<=q;i++)//\u5e26\u4fee\u83ab\u961f\u6a21\u7248\n    {\n        scanf(\"%lld\",&o);\n        if(!o)\n        {\n            cc++;\n            scanf(\"%lld%lld\",&mc[cc].p,&mc[cc].x);\n        }\n        else \n        {\n            scanf(\"%lld%lld\",&mq[cq].u,&mq[cq].v);\n            mq[cq].t=cc;\n            mq[cq].id=cq;\n            cq++;\n        }\n    }\n    sort(mq,mq+cq);\n    for(i=0;i<cq;i++)\n    {\n        qxg(u,mq[i].u);\n        qxg(v1,mq[i].v);\n        u=mq[i].u;\n        v1=mq[i].v;\n        while(now<mq[i].t)\n        xg(++now);\n        while(now>mq[i].t)\n        xg(now--);\n        l=lca(u,v1);\n        qf(l);\n        ans[mq[i].id]=an;\n        qf(l);\n    }\n    for(i=0;i<cq;i++)\n    printf(\"%lld\\n\",ans[i]);\n    return 0;\n}\n```\n~~\u7801\u98ce\u5f88\u4e11\u8fd8\u8bf7\u89c1\u8c05~~\n",
        "postTime": 1555848678,
        "uid": 110857,
        "name": "\u4e9a\u7531\u4e9a\u7531",
        "ccfLevel": 0,
        "title": "P4074 [WC2013]\u7cd6\u679c\u516c\u56ed"
    },
    {
        "content": "\u6811\u4e0a\u83ab\u961f\u548c\u666e\u901a\u7684\u5e8f\u5217\u83ab\u961f\u5f88\u50cf\uff0c\u6211\u4eec\u628a\u6811\u8fdb\u884cdfs\uff0c\u7136\u540e\u5b58\u4e00\u4e2a\u957f\u5ea6\u4e3a2n\u7684\u62ec\u53f7\u5e8f\u5217\uff0c\u5c31\u662f\u4e00\u4e2a\u70b9\u8fdb\u53bb\u5f53\u4f5c\u5de6\u62ec\u53f7\uff0c\u51fa\u6765\u5f53\u4f5c\u53f3\u62ec\u53f7\uff0c\u7136\u540e\u5982\u679c\u8bbf\u95ee\u4eceu\u5230v\u8def\u5f84\uff0c\u6211\u4eec\u53ef\u4ee5\u8f6c\u5316\u6210\u62ec\u53f7\u5e8f\u5217\u7684\u533a\u95f4\uff0c\u8bb0\u5f55x\u8fdb\u53bb\u7684\u65f6\u5019\u7f16\u53f7\u4e3af[x],\u51fa\u6765\u65f6\u4e3ag[x]\uff0c\u7136\u540e\u5206\u7c7b\u8ba8\u8bba\u4e00\u4e0b(f[u]<f[v])\uff0c\u5982\u679cu\u548cv\u7684lca\u4e0d\u662fu\uff0c\u90a3\u4e48\u5c31\u662f\u4eceg[u]\u5230f[v]\uff0c\u5426\u5219\u5c31\u662flca\u7684f\u5230\u53e6\u4e00\u4e2a\u70b9\u7684f\uff0c\uff08\u53ef\u4ee5\u81ea\u5df1\u8bd5\u4e00\u4e0b\uff0c\u4e2d\u95f4\u8fc7\u7a0b\u6ca1\u6709\u7528\u7684\u70b9\u6b63\u597d\u5c31\u62b5\u6d88\u6389\u4e86\uff09\u8fd9\u91cc\u8981\u6ce8\u610f\u4e00\u4e0b\uff0c\u4eceg[u]\u5230f[v]\u7684\u65f6\u5019\u6211\u4eec\u4f1a\u5c11\u6389lca\u8fd9\u4e2a\u70b9\uff0c\u7279\u6b8a\u5904\u7406\u4e00\u4e0b\u5373\u53ef\uff0c\u7136\u540e\u6309\u7167\u666e\u901a\u83ab\u961f\u6392\u4e00\u4e0b\u5e8f\uff0c\u66b4\u529b\u5c31\u884c\u4e86\u3002\n\n\u5b89\u5229blog\uff1ahttp://www.cnblogs.com/nbwzyzngyl/p/8343541.html\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nconst int M=1e5+5;\ntypedef long long ll;\nll ans[M],sum,W[M],N[M],V[M];\nint fa[M][19],pre[M],d[M],bel[M],col[M],s[M],head[M],dfn[M],size[M];\nint cnt,num,B,idx,top,n,m,q;\nbool v[M];\nstruct node{\n    int to,nex;\n}e[M<<1];\nvoid add(int x,int y)\n{\n    e[++cnt].nex=head[x];e[cnt].to=y;head[x]=cnt;\n}\nstruct quer{\n    int x,y,id,t;\n    bool operator<(const quer &b)const{\n        if(bel[x]==bel[b.x]&&bel[y]==bel[b.y])return t<b.t;\n        if(bel[x]==bel[b.x])return bel[y]<bel[b.y];\n        return bel[x]<bel[b.x];\n    }\n}b[M],c[M];\nvoid dfs(int x)\n{\n    dfn[x]=++idx;s[++top]=x;\n    for(int i=1;i<=16;++i)\n    fa[x][i]=fa[fa[x][i-1]][i-1];\n    for(int i=head[x];i;i=e[i].nex)\n    {\n        int y=e[i].to;\n        if(y==fa[x][0])continue;\n        fa[y][0]=x;d[y]=d[x]+1;\n        dfs(y);\n        size[x]+=size[y];\n        if(size[x]>=B)\n        {\n            num++;\n            for(int k=1;k<=size[x];++k)\n            bel[s[top--]]=num;\n            size[x]=0;\n        }\n    }\n    size[x]++;\n}\nint lca(int x,int y)\n{\n    if(d[x]<d[y])swap(x,y);\n    int tmp=d[x]-d[y];\n    for(int i=0;i<=16;++i)\n    if(tmp&(1<<i))x=fa[x][i];\n    for(int i=16;i>=0;--i)\n    {\n        if(fa[x][i]!=fa[y][i])\n        {\n            x=fa[x][i];\n            y=fa[y][i];\n        }\n    }\n    return x==y?x:fa[x][0];\n}\nvoid reverse(int x)\n{\n    if(!v[x]){v[x]=1;N[col[x]]++;sum+=W[N[col[x]]]*V[col[x]];}\n    else {v[x]=0;sum-=W[N[col[x]]]*V[col[x]];N[col[x]]--;}\n    return;\n}\nvoid change(int x,int y)\n{\n    if(v[x])\n    {\n        reverse(x);col[x]=y;reverse(x);\n    }\n    else col[x]=y;\n}\nvoid solve(int x,int y)\n{\n    while(x!=y)\n    {    \n        if(d[x]<d[y])swap(x,y);\n        reverse(x);x=fa[x][0];\n    }\n    return;\n}\nint main()\n{\n    scanf(\"%d%d%d\",&n,&m,&q);\n    B=pow(n,2.0/3)*0.5;int x,y,f;\n    for(int i=1;i<=m;++i)scanf(\"%lld\",&V[i]);\n    for(int i=1;i<=n;++i)scanf(\"%lld\",&W[i]);\n    for(int i=1;i<n;++i)\n    {\n        scanf(\"%d%d\",&x,&y);\n        add(x,y),add(y,x);\n    }\n    for(int i=1;i<=n;++i)scanf(\"%d\",&col[i]),pre[i]=col[i];\n    dfs(1);num++;int c1=0,c2=0;\n    while(top)bel[s[top--]]=num;\n    for(int i=1;i<=q;++i)\n    {\n        scanf(\"%d%d%d\",&f,&x,&y);\n        if(f)\n        {\n            if(dfn[x]>dfn[y])swap(x,y);\n            b[++c2].x=x;b[c2].t=c1;b[c2].y=y;b[c2].id=c2;\n        }\n        else\n        {\n            c[++c1].x=x;c[c1].y=y;c[c1].t=pre[x];pre[x]=y;\n        }\n    }\n    sort(b+1,b+1+c2);\n    for(int i=1;i<=b[1].t;++i)\n    change(c[i].x,c[i].y); \n    int z=lca(b[1].x,b[1].y);\n    solve(b[1].x,b[1].y);\n    reverse(z);\n    ans[b[1].id]=sum;\n    reverse(z);\n    for(int i=2;i<=c2;++i)\n    {\n        for(int j=b[i-1].t+1;j<=b[i].t;++j)\n        change(c[j].x,c[j].y);\n        for(int j=b[i-1].t;j>b[i].t;--j)\n        change(c[j].x,c[j].t);\n        int z=lca(b[i].x,b[i].y);\n        solve(b[i-1].x,b[i].x);\n        solve(b[i-1].y,b[i].y);\n        reverse(z);\n        ans[b[i].id]=sum;\n        reverse(z);\n    }\n    for(int i=1;i<=c2;++i)\n    printf(\"%lld\\n\",ans[i]);\n    return 0;\n}\n```",
        "postTime": 1516873730,
        "uid": 25438,
        "name": "\u5927\u5955\u54e5",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P4074 \u3010[WC2013]\u7cd6\u679c\u516c\u56ed\u3011"
    },
    {
        "content": "\u8fd9\u9898\u849f\u84bb\u8c03\u4e86\u6574\u6574\u4e00\u5929\u534a\uff0c\u5b9e\u5728\u662f\u6076\u5fc3\uff0c\u4f46\u662f\u505a\u5b8c\u611f\u89c9\u81ea\u5df1\u5bf9\u6811\u4e0a\u83ab\u961f\u7684\u7406\u89e3\u52a0\u6df1\u4e86\u8bb8\u591a\uff08\u6211\u662f\u7528\u624b\u91cd\u65b0\u6253\u7684\uff09\u3002\n# \u9898\u76ee\u5927\u610f\n\u8fd9\u9898\u7ed9\u7684\u662f\u4e00\u9897\u633a\u660e\u663e\u7684\u6811\uff08$n$ \u4e2a\u8282\u70b9\uff0c$n-1$ \u6761\u8fb9\uff09\uff0c\u7136\u540e\u8981\u6c42\u8def\u5f84\u4e0a\u7684\u4e00\u4e9b\u6570\u636e\uff08\u8def\u5f84\u4e0a\u7684\u7cd6\u679c\u7c7b\u578b\u7684\u51fa\u73b0\u6b21\u6570\u5bf9\u5e94\u7684 $w$ \u503c $*$ \u7cd6\u679c\u5bf9\u5e94\u7684\u5feb\u4e50\u503c\u7684\u548c\uff09\uff0c\u8fd8\u5e26\u4fee\u6539\u3002\n\n# \u601d\u8def\n\u8fd9\u9898\u662f\u68f5\u6811\uff0c\u8981\u6c42\u8def\u5f84\uff0c\u652f\u6301\u4fee\u6539\uff0c\u53ef\u4ee5\u79bb\u7ebf\uff0c\u7b54\u6848\u662f\u53ef\u4ee5\u5728\u7edf\u8ba1\u8fc7\u7a0b\u4e2d\u8ba1\u7b97\u7684\uff08\u4e5f\u53ea\u6709\u5728\u7edf\u8ba1\u8fc7\u7a0b\u4e2d\u8ba1\u7b97\uff09\uff0c\u8fd9\u4e0d\u660e\u663e\u7684\u83ab\u961f\u5417\uff1f\u8fd8\u662f\u5e26\u4fee\u7684\u6811\u4e0a\u83ab\u961f\uff0c\u677f\u677f\u5728\u624b\uff0c\u5929\u4e0b\u6211\u6709\uff0c\u8fd9\u91cc\u8bb2\u89e3\u4e00\u4e0b\u600e\u4e48\u5b9e\u73b0\u3002\n\n\u56e0\u4e3a\u662f\u8def\u5f84\uff0c\u6240\u4ee5 dfs \u5e8f\u663e\u7136\u6ca1\u7528\u4e86\uff0c\u8fd9\u91cc\u9700\u8981\u7528\u5230\u6b27\u62c9\u5e8f\u548c LCA\u3002\u6b27\u62c9\u5e8f\u5c31\u662f\u5728 dfs \u4e2d\u6bcf\u6b21\u8fdb\u5165\u548c\u79bb\u5f00 dfs \u65f6\u90fd\u52a0\u5165\u5e8f\u5217\uff0c\u8fd9\u5e8f\u5217\u7684\u65b9\u4fbf\u4e4b\u5904\u5c31\u5728\u4e8e\u5c06\u4e24\u4e2a\u70b9\u4e4b\u95f4\u91cd\u590d\u7684\u8282\u70b9\u62b9\u53bb\uff0c\u5269\u4e0b\u7684\u5c31\u662f\u8def\u5f84\u4e86\uff0c\u5f53\u7136\uff0c\u5982\u679c\u8981\u7ed5\u8fc7\u4ed6\u4eec\u7684 LCA\uff0c\u7684\u8bdd\u5c31\u9700\u8981\u5355\u72ec\u5904\u7406\u4e00\u4e0b\uff08\u4e5f\u53ea\u9700\u8981\u5355\u72ec\u5904\u7406 LCA\uff09\u3002\u6c42 LCA \u65f6\u5c31\u53ef\u4ee5\u521d\u59cb\u5316\u6b27\u62c9\u5e8f\u3002\u6700\u540e\u5c31\u662f\u83ab\u961f\u4e86\uff0c\u8bb0\u5f97\u8981\u5904\u7406\u91cd\u590d\u7684\u8282\u70b9\uff08\u5f00\u4e00\u4e2a\u6570\u7ec4\uff0c\u6bcf\u6b21\u5f02\u6216 1\uff09\u3002\n\n\u5e26\u4fee\u83ab\u961f\u52a0\u8fdb\u53bb\u5176\u5b9e\u5f71\u54cd\u4e0d\u5927\uff0c\u751a\u81f3\u90fd\u4e0d\u9700\u8981\u4f60\u53bb\u6539\u6811\u4e0a\u83ab\u961f\u7684\u677f\u5b50\uff08\u4f46\u6211\u8fd8\u662f\u91cd\u65b0\u6253\u4e86\u4e00\u904d...\uff09\uff0c\u5c31\u662f\u8fd9\u91cc\u7684\u5bf9\u5e94\u5173\u7cfb\u5341\u5206\u590d\u6742\uff0c\u63a8\u8350\u753b\u4e00\u4e0b\u56fe\u7136\u540e\u8fdb\u884c\u8bb0\u5f55\uff0c\u4e0d\u7136\u5c31\u4f1a~~\u50cf\u6211\u4e00\u6837~~\u50bb\u770b\u7740\u4ee3\u7801\u641e\u4e00\u5929\u4e0d\u6653\u5f97\u90a3\u91cc\u9519\u4e86...\n\n\u8bb2\u5b8c\u4e86\uff0c\u4e0a\u4ee3\u7801\n```cpp\n#include <bits/stdc++.h>\n#define int long long\nusing namespace std;\nconst int MAXN=100005;\ninline void qr(register int &ret){//\u624b\u6253\u5feb\u8bfb \n\tregister int x=0,f=0;\n\tregister char ch=getchar();\n\twhile(ch<'0'||ch>'9') f|=ch=='-',ch=getchar();\n\twhile(ch>='0'&&ch<='9')x=(x<<3)+(x<<1)+(ch^48),ch=getchar();\n\tret=f?-x:x;\n} \nint n,m,q,w[MAXN],v[MAXN],c[MAXN],ttt,fr,op,x,y,LCA;//\u5355\u7eaf\u7684\u6742\u9879\uff08\u5565\u90fd\u6709\uff09 \nint fa[MAXN],ord[MAXN<<1],fir[MAXN],las[MAXN],son[MAXN],sze[MAXN],head[MAXN],nxt[MAXN<<1],to[MAXN<<1],dep[MAXN],top[MAXN],ccnt,nord;//LCA \u76f8\u5173 \nint cntr,cntp,idx[MAXN<<1],s,l,r,t,tot,cnt[MAXN],vis[MAXN],L,R,T,ans[MAXN];//\u83ab\u961f\u76f8\u5173 \nstruct node1{//\u67e5\u8be2 \n\tint l,r,id,ti,lca;\n\tbool operator<(const node1 x)const{//\u5947\u602a\u7684\u53cc\u91cd\u5947\u5076\u6392\u5e8f \n\t\treturn idx[l]==idx[x.l]?(idx[l]&1?(idx[r]==idx[x.r]?(idx[r]&1?ti<x.ti:ti>x.ti):idx[r]<idx[x.r]):(idx[r]==idx[x.r]?(idx[r]&1?ti<x.ti:ti>x.ti):r>x.r)):l<x.l;\n\t}\n}p[MAXN];\nstruct node2{//\u4fee\u6539 \n\tint i,from,to;\n}ch[MAXN];\nvoid add(int x){\n\t++cnt[x];\n\ttot+=v[x]*w[cnt[x]];\n}\nvoid del(int x){//\u8fd9\u91cc\u7684\u5bf9\u5e94\u5173\u7cfb\u7528\u4eba\u8111\u538b\u4e0d\u4e0b\uff01\uff01 \n\ttot-=v[x]*w[cnt[x]];\n\t--cnt[x];\n}\nvoid work(int x){//\u8fd9\u91cc\u662f\u6811\u4e0a\u83ab\u961f\u7684\u5904\u7406\uff08\u6ca1\u5b66\u8fc7\u7684\u7406\u89e3\u4e00\u4e0b\uff09 \n\tvis[x]?del(c[x]):add(c[x]);\n\tvis[x]^=1;\n}\nvoid dealadd(int x){//\u65f6\u95f4\u7684\u4fee\u6539 1 \n\tif(vis[ch[x].i]) add(ch[x].to),del(ch[x].from);//\u5982\u679c\u4fee\u6539\u7684\u8282\u70b9\u5bf9\u7b54\u6848\u6709\u5f71\u54cd\uff0c\u5c31\u987a\u624b\u5904\u7406\u4e00\u624b\u5f71\u54cd \n\tc[ch[x].i]=ch[x].to;                           \n}\nvoid dealdel(int x){//\u65f6\u95f4\u7684\u4fee\u6539 2\n\tif(vis[ch[x].i]) del(ch[x].to),add(ch[x].from);//\u540c\u4e0a \n\tc[ch[x].i]=ch[x].from;//\u4fee\u6539\u539f\u6570\u7ec4 \n}\nvoid adde(int fr,int To){//\u52a0\u8fb9 \n\tnxt[++ccnt]=head[fr],head[fr]=ccnt,to[ccnt]=To;\n}\nvoid dfs1(int i){//\u8fd9\u91cc\u6211\u7528\u7684\u662f\u6811\u5256\u6c42 LCA \u770b\u4e0d\u61c2\u7684\u540c\u5b66\u53ef\u4ee5\u53bb\u5eb7\u5eb7\u5176\u4ed6\u7684 \n\t\t\t\t //\u6811\u5256\u7684\u521d\u59cb\u5316 1 \n\tdep[i]=dep[fa[i]]+1;\n\tsze[i]=1;\n\tord[++nord]=i;\n\tfir[i]=nord;\n\tfor(int j=head[i];j;j=nxt[j]){\n\t\tif(to[j]==fa[i]) continue;\n\t\tfa[to[j]]=i;\n\t\tdfs1(to[j]);\n\t\tsze[i]+=sze[to[j]];\n\t\tif(son[i]==1||sze[to[j]]>sze[son[i]]) son[i]=to[j];\n\t}\n\tord[++nord]=i;\n\tlas[i]=nord;\n\treturn;\n}\nvoid dfs2(int i,int Top){//\u6811\u5256\u7684\u521d\u59cb\u5316 2\n\ttop[i]=Top;\n\tif(son[i]) dfs2(son[i],Top);\n\tfor(int j=head[i];j;j=nxt[j]){\n\t\tif(to[j]==fa[i]||to[j]==son[i]) continue;\n\t\tdfs2(to[j],to[j]);\n\t}\n\treturn;\n}\nint getlca(int x,int y){//\u8df3\u7956\u5148 \n\twhile(top[x]^top[y]){\n\t\tif(dep[top[x]]>=dep[top[y]]) x=fa[top[x]];\n\t\telse y=fa[top[y]];\n\t}\n\treturn dep[x]>dep[y]?y:x;\n}\nsigned main() {\n\tqr(n),qr(m),qr(q);\n\tfor(int i=1;i<=m;++i) qr(v[i]);\n\tfor(int i=1;i<=n;++i) qr(w[i]);\n\tfor(int i=1;i<n;++i){\n\t\tqr(fr),qr(ttt);\n\t\tadde(fr,ttt),adde(ttt,fr);\n\t}\n\tfa[1]=1;\n\tdfs1(1),dfs2(1,1);//\u521d\u59cb\u5316 \n\tfor(int i=1;i<=n;++i) qr(c[i]);\n\ts=pow(nord,2.0/3);//\u5904\u7406\u5206\u5757 1\uff08\u8fd9\u91cc\u662f 2/3 \u6b21\u65b9\uff01\uff01\uff01\uff09 \n\tfor(int i=1;i<=nord;++i) idx[i]=(i+s-1)/s;//\u5904\u7406\u5206\u5757 2\n\tfor(int i=1;i<=q;++i){\n\t\tqr(op),qr(x),qr(y);\n\t\tif(op){\n\t\t\t++cntp;\n\t\t\tif(fir[x]>fir[y]) swap(x,y);\n\t\t\tLCA=getlca(x,y);\n\t\t\tif(LCA==x){//\u5982\u679c\u4e24\u70b9\u5728\u4e00\u6761\u94fe\u4e0a \n\t\t\t\tp[cntp].l=fir[x],p[cntp].r=fir[y];\n\t\t\t\tp[cntp].id=cntp,p[cntp].ti=cntr;\n\t\t\t}else{//\u4e0d\u5728\u4e00\u6761\u94fe\u4e0a \n\t\t\t\tp[cntp].l=las[x],p[cntp].r=fir[y];\n\t\t\t\tp[cntp].id=cntp,p[cntp].ti=cntr;\n\t\t\t\tp[cntp].lca=LCA;\n\t\t\t}\n\t\t}else{\n\t\t\t++cntr;\n\t\t\tch[cntr].i=x,ch[cntr].from=c[x],ch[cntr].to=c[x]=y;//\u8bb0\u5f97\u4fee\u6539\u539f\u6570\u7ec4 \n\t\t}\n\t}\n\tfor(int i=cntr;i>=1;--i) c[ch[i].i]=ch[i].from;//\u8bb0\u5f97\u8fd8\u539f \n\tsort(p+1,p+cntp+1);//\u6392\u5e8f \n\tl=1,r=t=0;\n\tfor(int i=1;i<=cntp;++i){//\u83ab\u961f\u677f\u677f(\u5982\u679c\u8fd9\u90fd\u4e0d\u4f1a\uff0c\u4f60\u8fd8\u6765\u505a\u8fd9\u9898\uff1f) \n\t\tL=p[i].l,R=p[i].r,T=p[i].ti;\n\t\twhile(t>T) dealdel(t--);\n\t\twhile(t<T) dealadd(++t);\n\t\twhile(l>L) work(ord[--l]);//\u8fd9\u91cc\u662f ord[(l \u6216 r)]\uff01\uff01\uff01\u8c03\u4e86\u534a\u5929\u7684\u6211\u5c31\u662f\u56e0\u4e3a\u8fd9\u91cc...\n\t\twhile(r<R) work(ord[++r]);\n\t\twhile(l<L) work(ord[l++]);\n\t\twhile(r>R) work(ord[r--]);\n\t\tif(p[i].lca) work(p[i].lca);//\u5982\u679c\u4e0d\u5728\u4e00\u6761\u94fe\u4e0a\uff0c\u5c31\u5904\u7406\u4e00\u4e0b LCA \n\t\tans[p[i].id]=tot;\n\t\tif(p[i].lca) work(p[i].lca);\n\t}\n\tfor(int i=1;i<=cntp;++i) printf(\"%lld\\n\",ans[i]);\n\treturn 0;\n}\n```",
        "postTime": 1627533455,
        "uid": 383791,
        "name": "Others",
        "ccfLevel": 7,
        "title": "P4074\u9898\u89e3"
    },
    {
        "content": "# \u6811\u4e0a\u83ab\u961f+\u5e26\u4fee\u83ab\u961f\u7684\u597d\u9898\uff01\n\n\u849f\u84bb\u8fc7\u7684\u7b2c\u4e8c\u9053\u9ed1\u9898/kel\n\n\u6811\u4e0a\u83ab\u961f\u90e8\u5206\u8ddf\u666e\u901a\u6811\u4e0a\u83ab\u961f\u4e00\u6837\uff0c\u62ec\u53f7\u5e8f\u548c `lca` \u849f\u84bb\u6211\u662f\u7528\u6811\u5256\u6c42\u7684\uff0c\u8fd9\u91cc\u4e0d\u7ec6\u8bb2\u3002\n\n## \u6211\u4eec\u91cd\u70b9\u6765\u8bb2\u4e00\u4e0b\u5e26\u4fee\u90e8\u5206\n\n\u5bf9\u4e8e\u4fee\u6539\u65f6\u95f4\u8f74\u90e8\u5206\uff0c\u6211\u4eec\u8be5\u600e\u6837\u6539\u5462\uff1f\u6211\u4eec\u6765\u770b\u56fe\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/d9bzd7y0.png)\n\n\u5176\u4e2d\u7684\u62ec\u53f7\u5e8f\u5e94\u8be5\u662f `1 3 8 8 7 7 3 5 5 2 4 6 6 4 2 1`\n\n\u5047\u8bbe\u6211\u4eec\u8981\u67e5\u8be2 $2$ \u5230 $8$ \u7684\u8def\u5f84\uff08\u8bb0\u4e00\u4e2a\u7ed3\u70b9 $i$ \u7b2c\u4e00\u6b21\u88ab\u904d\u5386\u5230\u65f6\u7684\u5e8f\u53f7\u662f $st_i$ \uff0c\u56de\u6eaf\u65f6\u7684\u5e8f\u53f7\u662f $ed_i$ \uff09\uff0c\u90a3\u6211\u4eec\u8981\u904d\u5386\u7684\u62ec\u53f7\u5e8f\u662f $(ed_2,st_8)$ \u518d\u52a0\u4e0a\u5b83\u4eec\u7684 `lca` \u3002\n\n- \u5982\u679c\u6211\u4eec\u8981\u4fee\u6539\u7684\u662f $7$ \u53f7\u7ed3\u70b9\u7684\u4f4d\u7f6e\uff0c\u4e0d\u96be\u53d1\u73b0\u5b83\u5df2\u7ecf\u88ab\u8bb0\u5f55\u4e24\u6b21\u2014\u2014\u8d21\u732e\u88ab\u62b5\u6d88\uff08\u7531\u6811\u4e0a\u83ab\u961f\u64cd\u4f5c\u53ef\u77e5\uff09\uff0c\u90a3\u6211\u4eec\u5373\u4f7f\u4fee\u6539\u4e86\uff0c\u4fee\u6539\u540e\u7684\u8d21\u732e\u4e5f\u662f\u88ab\u62b5\u6d88\u6389\uff0c\u56e0\u6b64\u53ea\u9700\u4ea4\u6362\u5373\u53ef\u3002\n\n- \u5982\u679c\u6211\u4eec\u8981\u4fee\u6539\u7684\u662f $3$ \u53f7\u7ed3\u70b9\u7684\u4f4d\u7f6e\uff0c\u4e0d\u96be\u53d1\u73b0\u5b83\u53ea\u88ab\u8bb0\u5f55\u4e86\u4e00\u6b21\u2014\u2014\u8d21\u732e\u8fd8\u5728\uff0c\u90a3\u6211\u4eec\u628a\u5b83\u7684\u8d21\u732e\u53bb\u6389\uff0c\u52a0\u4e0a\u4fee\u6539\u540e\u7684\u8d21\u732e\u518d\u4ea4\u6362\u5373\u53ef\u3002\n\n## $like \\ this:$\n\n```cpp\ninline void change(int now){\n\tif(used[c[now].pos]){//\u8981\u4fee\u6539\u7684\u4f4d\u7f6e\u53ea\u88ab\u8bb0\u5f55\u4e00\u6b21\n\t\tdel(a[c[now].pos]);//\u53bb\u6389\u539f\u6765\u7684\u8d21\u732e\n\t\tadd(c[now].to);//\u52a0\u4e0a\u4fee\u6539\u540e\u7684\u8d21\u732e\n\t}\n\tswap(a[c[now].pos],c[now].to);\n}\n```\n\n\u5bf9\u4e8e\u53d6\u5757\u957f\uff0c\u6709\u4fee\u6539\u64cd\u4f5c\u5219\u6309\u5e26\u4fee\u83ab\u961f\u7684\u5757\u957f $n^{\\frac{2}{3}}$\uff0c\u53cd\u4e4b\u7528\u666e\u901a\u83ab\u961f\u7684\u5757\u957f $\\sqrt{n}$ \u5373\u53ef\u3002\n\n# $Code:$\n\n```cpp\n#include<cstdio>\n#include<algorithm>\n#include<vector>\n#include<cmath>\nusing namespace std;\n#define int long long\n#define N (int)(2e5+10)\n#define swap(a,b) a^=b^=a^=b\n#define getchar()(p1==p2&&(p2=(p1=buf)+fread(buf,1,1<<21,stdin),p1==p2)?EOF:*p1++)\nchar buf[1<<21],*p1=buf,*p2=buf;\ntemplate <typename T>\ninline void read(T& r) {\n\tr=0;bool w=0; char ch=getchar();\n\twhile(ch<'0'||ch>'9') w=ch=='-'?1:0,ch=getchar();\n\twhile(ch>='0'&&ch<='9') r=(r<<3)+(r<<1)+(ch^48), ch=getchar();\n\tr=w?-r:r;\n}\nvoid write(int x){\n\tif(x<0)putchar('-'),write(-x);\n\telse {\n\t\tif(x>9)write(x/10);\n\t\tputchar(x%10+'0');\n\t}\n}\n\nint n,m,k,bl,be[N],v[N],w[N],a[N],cs=0,qs=0,cnt[N],ans[N],sum;\nint fa[N],son[N],dep[N],size[N],top[N],st[N],ed[N],rnk[N],tot;\nbool used[N];\nvector<int>e[N];\nstruct query{int l,r,t,id,lca;}q[N];\nstruct candy{int to,pos;}c[N];\ninline bool cmp(query a,query b) {\n    return be[a.l]^be[b.l]?a.l<b.l:(be[a.r]^be[b.r]?a.r<b.r:a.t<b.t);\n}\n\nvoid dfs1(int u){\n\tsize[u]=1;\n\tst[u]=++tot;rnk[tot]=u;\n\tfor(int i=0;i<e[u].size();++i){\n\t\tint v=e[u][i];\n\t\tif(v^fa[u]){\n\t\t\tfa[v]=u;dep[v]=dep[u]+1;\n\t\t\tdfs1(v);\n\t\t\tsize[u]+=size[v];\n\t\t\tif(size[son[u]]<size[v])son[u]=v;\n\t\t}\t\n\t}\n\ted[u]=++tot;rnk[tot]=u;\n}\nvoid dfs2(int u,int t){\n\ttop[u]=t;\n\tif(!son[u])return;\n\tdfs2(son[u],t);\n\tfor(int i=0;i<e[u].size();++i){\n\t\tint v=e[u][i];\n\t\tif(v^son[u]&&v^fa[u])dfs2(v,v);\n\t}\n}\nint LCA(int u,int v){\n\twhile(top[u]^top[v]){\n\t\tif(dep[top[u]]<dep[top[v]])swap(u,v);\n\t\tu=fa[top[u]];\n\t}\n\treturn dep[u]<dep[v]?u:v;\n}\n\ninline void add(int x){\n\t++cnt[x];\n\tsum+=v[x]*w[cnt[x]];\n}\ninline void del(int x){\n\tsum-=v[x]*w[cnt[x]];\n\t--cnt[x];\n}\ninline void get(int x){\n\tif(!used[x])add(a[x]);\n\telse del(a[x]);\n\tused[x]^=1;\n}\ninline void change(int now){\n\tif(used[c[now].pos]){\n\t\tdel(a[c[now].pos]);\n\t\tadd(c[now].to);\n\t}\n\tswap(a[c[now].pos],c[now].to);\n}\n\nsigned main(){\n\tread(n);read(m);read(k);\n\tfor(int i=1;i<=m;++i)read(v[i]);\n\tfor(int i=1;i<=n;++i)read(w[i]);\n\tfor(int i=1,x,y;i<n;++i){\n\t\tread(x);read(y);\n\t\te[x].push_back(y);\n\t\te[y].push_back(x);\n\t}\n\tdep[1]=1;dfs1(1);dfs2(1,1);\n\tfor(int i=1;i<=n;++i)read(a[i]);\n\tfor(int i=1;i<=k;++i){\n\t\tint type,x,y;\n\t\tread(type);read(x);read(y);\n\t\tif(!type){\n\t\t\t++cs;\n\t\t\tc[cs].pos=x;c[cs].to=y;\n\t\t}else {\n\t\t\t++qs;\n\t\t\tif(st[x]>st[y])swap(x,y);\n\t\t\tq[qs].id=qs;q[qs].t=cs;\n\t\t\tq[qs].lca=LCA(x,y);\n\t\t\tif(q[qs].lca==x){\n\t\t\t\tq[qs].l=st[x];q[qs].r=st[y];\n\t\t\t\tq[qs].lca=0;\n\t\t\t}else q[qs].l=ed[x],q[qs].r=st[y];\t\n\t\t}\n\t}\n\tbl=pow(n<<1,cs?2.0/3.0:1.0/2.0);//\u6ce8\u610f\u62ec\u53f7\u5e8f\u957f\u5ea6\u4e3a\u53cc\u500d \n\tfor(int i=1;i<=n<<1;++i)be[i]=(i-1)/bl+1;\n\tsort(q+1,q+qs+1,cmp);\n\tfor(int i=1,l=q[1].l,r=q[1].l-1,now=0;i<=qs;++i){\n\t\twhile(l>q[i].l)get(rnk[--l]);\n        \twhile(r<q[i].r)get(rnk[++r]);\n        \twhile(l<q[i].l)get(rnk[l++]);\n        \twhile(r>q[i].r)get(rnk[r--]);\n        \twhile(now<q[i].t)change(++now);\n        \twhile(now>q[i].t)change(now--);\n        \tif(q[i].lca)get(q[i].lca);\n        \tans[q[i].id]=sum;\n        \tif(q[i].lca)get(q[i].lca);\n\t}\n\tfor(int i=1;i<=qs;++i)write(ans[i]),puts(\"\");\n\treturn 0;\n}\n```\n",
        "postTime": 1614413808,
        "uid": 339846,
        "name": "RuntimeErr",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 P4074 [WC2013] \u7cd6\u679c\u516c\u56ed"
    },
    {
        "content": "\u5ba3\u4f20\u535a\u5ba2->[link](https://blog.csdn.net/BWzhuzehao/article/details/110880390)\n\n\u8fd9\u9053\u9898\u53ef\u4ee5\u8bf4\u662f\u4e00\u9053\u6811\u4e0a\u5e26\u4fee\u83ab\u961f\u7684\u677f\u5b50\u9898\u3002\u867d\u7136\u8bc4\u7ea7\u662f\u9ed1\u7684\uff0c\u4f46\u662f\u6811\u4e0a\u5e26\u4fee\u83ab\u961f\u672c\u8eab\u8fd8\u662f\u6bd4\u8f83\u597d\u60f3\u7684\u3002~~\u5c31\u662f\u4ee3\u7801\u5f88\u96be\u8c03\u3002~~\n\n### \u6811\u4e0a\u83ab\u961f\uff1a\n\n\u6811\u4e0a\u83ab\u961f\u7684\u672c\u8d28\u5c31\u662f\u5229\u7528\u6b27\u62c9\u5e8f\u5c06\u6811\u4e0a\u83ab\u961f\u95ee\u9898\u53d8\u6210\u5e8f\u5217\u83ab\u961f\u95ee\u9898\u3002\n\n\u6211\u4eec\u8bbe $\\{eular\\}$ \u8868\u793a\u6b27\u62c9\u5e8f\u5e8f\u5217\uff0c $fir_i,las_i$ \u8868\u793a\u8282\u70b9 $i$ \u5728\u6b27\u62c9\u5e8f\u4e2d\u7b2c\u4e00\u6b21\u51fa\u73b0\u4e0e\u7b2c\u4e8c\u6b21\u51fa\u73b0\u7684\u4f4d\u7f6e\u3002\u90a3\u4e48\u5f53\u8be2\u95ee\u4e3a $x,y$ \u65f6\uff08\u6b64\u5904\u6211\u4eec\u89c4\u5b9a $x$ \u7684\u6df1\u5ea6\u5c0f\u4e8e $y$\uff09\uff0c\u5982\u679c $lca(x,y)=x$ \uff0c\u90a3\u4e48\u7528 $fir_x,fir_y$ \u7684\u533a\u95f4\uff0c\u5426\u5219\u7528 $las_x,fir_y$ \u7684\u533a\u95f4\u540c\u65f6\u5e26\u4e0a $lca(x,y)$ \u7684\u8d21\u732e\u3002\u4e3a\u4ec0\u4e48\u4e0d\u662f $fir_x$ \uff1f\u56e0\u4e3a\u4e2d\u95f4\u51fa\u73b0\u4e8c\u6b21\u7684\u8282\u70b9\u6211\u4eec\u662f\u4e0d\u8003\u8651\u7684\uff0c\u56e0\u6b64\u7528 $fir_x$ \u76f8\u5f53\u4e8e\u6d6a\u8d39\u65f6\u95f4 ~~\uff08\u7528\u65f6\u95f4\u6362\u7a7a\u95f4\u7684\u5f53\u6211\u6ca1\u8bf4\uff09~~ \u3002\u8fd9\u91cc\u5343\u4e07\u6ce8\u610f\uff1a\u5e8f\u5217\u957f\u5ea6\u662f $2n$ \u800c\u4e0d\u662f $n$ \uff0c\u5343\u4e07\u4e0d\u8981\u5728\u8fd9\u91cc TLE \u4e86\uff01\n\n### \u5e26\u4fee\u83ab\u961f\uff1a\n\n\u5e26\u4fee\u83ab\u961f\u7684\u672c\u8d28\u5c31\u662f\u52a0\u4e00\u4e2a\u65f6\u95f4\u8f74\uff0c\u8ba9\u6307\u9488\u9664\u4e86\u5728 $l,r$ \u4e0a\u52a8\u8fd8\u53ef\u4ee5\u5728 $time$ \u4e0a\u52a8\uff0c\u5c06\u8be2\u95ee\u4e0e\u4fee\u6539\u5206\u5f00\u50a8\u5b58\uff0c\u5c31\u53ef\u4ee5\u5b8c\u6210\u4e86\u3002\n\n### \u6811\u4e0a\u5e26\u4fee\u83ab\u961f\uff1a\n\n\u5b9e\u9645\u4e0a\u5c31\u662f\u524d\u9762\u4e24\u4e2a\u7684\u7ed3\u5408\u4f53\uff0c\u5148\u8dd1\u4e00\u904d\u6b27\u62c9\u5e8f\uff0c\u7136\u540e\u518d\u8dd1\u4e00\u904d\u5e26\u4fee\u83ab\u961f\u5373\u53ef\u3002\n\n\u4e09\u4e2a\u6ce8\u610f\u70b9\uff1a\n\n1. \u5728\u8dd1\u83ab\u961f\u7684\u65f6\u5019\uff0c\u5982\u679c\u8981\u8ba1\u7b97 $lca(x,y)$ \u7684\u8d21\u732e\uff08\u8fd9\u91cc\u6211\u4eec\u89c4\u5b9a $lca(x,y)$ \u4e0d\u5728\u8be2\u95ee\u7684\u533a\u95f4\u5185\uff0c\u5982\u679c\u5728\u53ef\u4ee5\u524d\u9762\u76f4\u63a5\u5148\u7279\u5224\u4e00\u4e0b\uff09\uff0c**\u7b97\u5b8c\u4e4b\u540e\u4e00\u5b9a\u4e0d\u8981\u5fd8\u8bb0\u8fd8\u539f**\uff01\n2. **\u518d\u6b21\u63d0\u9192\uff1a\u6570\u5217\u957f\u5ea6\u662f $2n$ \uff0c\u5343\u4e07\u4e0d\u80fd\u5728\u8fd9\u91cc TLE \u4e86\uff01**\n3. \u8fd9\u91cc\u5757\u957f\u53d6 $eular^{\\frac{2}{3}}$ \uff0c\u6bd4 $\\sqrt{eular}$ \u8981\u597d\u4e00\u70b9\uff0c\u5176\u4e2d $eular$ \u8868\u793a\u6b27\u62c9\u5e8f\u7684\u957f\u5ea6\n\n\u51e0\u4e2a\u5c0f\u4f18\u5316\uff1a\n\n1. \u5982\u679c\u53ef\u4ee5\uff0c\u4f7f\u7528\u6811\u94fe\u5256\u5206\u6c42 $lca$\u3002\n2. ~~\u5438\u6c27~~\u3002\uff08\u7ecf\u8fc7\u5b9e\u6d4b\uff0c\u6211\u4e00\u5f00\u59cb\u8c03\u7684\u5757\u957f\u662f $n^{\\frac{2}{3}}$\uff0c\u8c03\u9519\u4e86\uff0c\u4f46\u662f\u5438\u6c27\u4e4b\u540e $30pts$ $->$ $70pts$\uff09\n\n\u4ee3\u7801\uff1a\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n\nconst int MAXN=1e6+5;\nint n,m,que,v[MAXN],w[MAXN],c[MAXN],fir[MAXN],las[MAXN],ys[MAXN],block,fa[MAXN][21],eular[MAXN<<1],dep[MAXN],cntq,cntc,vis[MAXN];\ntypedef long long LL;\nLL ans[MAXN],total,cnt[MAXN];\nvector<int>Next[MAXN];\nstruct query\n{\n\tint l,r,id,lca,Time;\n}q[MAXN];\nstruct change\n{\n\tint pos,val;\n}cha[MAXN];\n\nint read()\n{\n\tint sum=0;char ch=getchar();\n\twhile(ch<'0'||ch>'9') ch=getchar();\n\twhile(ch>='0'&&ch<='9') {sum=(sum<<3)+(sum<<1)+(ch^48);ch=getchar();}\n\treturn sum;\n}\n\nvoid dfs(int x)\n{\n\teular[++eular[0]]=x;\n\tfir[x]=eular[0];\n\tfor(int i=0;i<Next[x].size();i++)\n\t{\n\t\tint u=Next[x][i];\n\t\tif(dep[u]) continue;\n\t\tdep[u]=dep[x]+1;\n\t\tfa[u][0]=x;\n\t\tdfs(u);\n\t}\n\teular[++eular[0]]=x;\n\tlas[x]=eular[0];\n}\n\nvoid st()\n{\n\tfor(int i=1;i<=20;i++)\n\t\tfor(int j=1;j<=n;j++)\n\t\t\tfa[j][i]=fa[fa[j][i-1]][i-1];\n}\n\nint getlca(int x,int y)\n{\n\tif(dep[x]<dep[y]) swap(x,y);\n\tint d=dep[x]-dep[y],tmp=-1;\n\twhile(d)\n\t{\n\t\ttmp++;int p=d&1;d>>=1;\n\t\tif(p) x=fa[x][tmp];\n\t}\n\tif(x==y) return x;\n\tfor(int i=20;i>=0;i--)\n\t\tif(fa[x][i]!=fa[y][i]) x=fa[x][i],y=fa[y][i];\n\treturn fa[x][0];\n}\n\nbool cmp(const query &fir,const query &sec)\n{\n\tif(ys[fir.l]^ys[sec.l]) return ys[fir.l]<ys[sec.l];\n\tif(ys[fir.r]^ys[sec.r]) return ys[fir.r]<ys[sec.r];\n\treturn fir.Time<sec.Time;\n}\n\nvoid add(int x)\n{\n\ttotal+=1ll*v[c[x]]*w[++cnt[c[x]]];\n}\nvoid del(int x)\n{\n\ttotal-=1ll*v[c[x]]*w[cnt[c[x]]--];\n}\n\nvoid work(int x)\n{\n\tvis[x]?del(x):add(x);\n\tvis[x]^=1;\n}\n\nvoid deal(int t)\n{\n\tif(vis[cha[t].pos])\n\t{\n\t\twork(cha[t].pos);\n\t\tswap(c[cha[t].pos],cha[t].val);\n\t\twork(cha[t].pos);\n\t}\n\telse swap(c[cha[t].pos],cha[t].val);\n}\n\nint main()\n{\n\tn=read();m=read();que=read();\n\tfor(int i=1;i<=m;i++) v[i]=read();\n\tfor(int i=1;i<=n;i++) w[i]=read();\n\tfor(int i=1;i<n;i++)\n\t{\n\t\tint x=read(),y=read();\n\t\tNext[x].push_back(y);\n\t\tNext[y].push_back(x);\n\t}\n\tfor(int i=1;i<=n;i++) c[i]=read();\n\tfa[1][0]=1;dep[1]=1;dfs(1);st();block=ceil(pow(eular[0],2.0/3.0));\n\tfor(int i=1;i<=(n<<1);i++) ys[i]=(i-1)/block+1;\n\tfor(int i=1;i<=que;i++)\n\t{\n\t\tint opt=read(),zzh1=read(),zzh2=read();\n\t\tif(opt)\n\t\t{\n\t\t\tq[++cntq].id=cntq;\n\t\t\tq[cntq].Time=cntc;\n\t\t\tif(fir[zzh1]>fir[zzh2]) swap(zzh1,zzh2);\n\t\t\tint qlca=getlca(zzh1,zzh2);\n\t\t\tif(zzh1==qlca) q[cntq].l=fir[zzh1],q[cntq].r=fir[zzh2];\n\t\t\telse q[cntq].l=las[zzh1],q[cntq].r=fir[zzh2],q[cntq].lca=qlca;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tcha[++cntc].pos=zzh1;\n\t\t\tcha[cntc].val=zzh2;\n\t\t}\n\t}\n\tsort(q+1,q+cntq+1,cmp);\n\tint l=1,r=0,t=0;\n\tfor(int i=1;i<=cntq;i++)\n\t{\n\t\twhile(l<q[i].l) work(eular[l++]);\n\t\twhile(l>q[i].l) work(eular[--l]);\n\t\twhile(r<q[i].r) work(eular[++r]);\n\t\twhile(r>q[i].r) work(eular[r--]);\n\t\twhile(t<q[i].Time) deal(++t);\n\t\twhile(t>q[i].Time) deal(t--);\n\t\tif(q[i].lca) work(q[i].lca);\n\t\tans[q[i].id]=total;\n\t\tif(q[i].lca) work(q[i].lca);\n\t}\n\tfor(int i=1;i<=cntq;i++) printf(\"%lld\\n\",ans[i]);\n\treturn 0;\n}\n```",
        "postTime": 1607428657,
        "uid": 134000,
        "name": "Plozia",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P4074 \u3010[WC2013]\u7cd6\u679c\u516c\u56ed\u3011"
    },
    {
        "content": "## P4074 [WC2013]\u7cd6\u679c\u516c\u56ed\n\n*Tag\uff1a\u6811\u4e0a\u5e26\u4fee\u83ab\u961f*\n\n\u9898\u610f\uff1a\u6811\u4e0a\u6bcf\u4e2a\u70b9\u6709\u4e00\u79cd\u7cd6\u679c\uff0c\u6c42$\\sum_c\\sum_{i=1}^{cnt_c}v_c*w_i$\n\n\u5176\u4e2dc\u4e3a\u7cd6\u679c\u79cd\u7c7b\uff0c$cnt_c$\u5176\u4e3a\u51fa\u73b0\u6b21\u6570\u3002\n\n### \u601d\u8def\n\n\u79bb\u7ebf\u6811\u4e0a\u5e26\u4fee\u83ab\u961f\u3002\n\n\u5148\u8fdb\u884c\u6811\u4e0a\u5206\u5757\u3002\u5206\u5757\u5185\u7684\u8be2\u95ee\u6309\u7167\u51fa\u53d1\u70b9\u3001\u7ec8\u6b62\u70b9\u3001\u8be2\u95eeid\u4f18\u5148\u7ea7\u4f9d\u6b21\u9012\u51cf\u6392\u5e8f\u3002\n\n\u5bf9\u4e8e\u6811\u4e0a\u83ab\u961f\uff0c\u5176\u5b9e\u5c31\u662f\u5728\u6b27\u62c9\u5e8f\u4e0a\u83ab\u961f\u3002\u56e0\u4e3a\u6b27\u62c9\u5e8f\u7684\u6027\u8d28\uff0c\u5373\u6bcf\u4e2a\u8282\u70b9\u5b50\u6811\u5185\u7684\u8282\u70b9\u4e00\u5b9a\u4f1a\u7ecf\u8fc7\u4e24\u6b21\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u7528\u4e00\u4e2a\u62ec\u53f7\u5e8f\u5217\u7684\u65b9\u5f0f\u5728\u83ab\u961f\u65f6\u6d88\u9664\u5b50\u6811\u5185\u65e0\u7528\u8282\u70b9\u7684\u5f71\u54cd\u3002\n\n\u5177\u4f53\u6765\u8bf4\uff0c\u5e8f\u5217\u957f\u5ea6\u4e3a2*n\uff0c\u6bcf\u4e00\u4e2a\u8282\u70b9\u51fa\u5165\u961f\u65f6\u6211\u4eec\u5f02\u6216\u5b83\u662f\u5426\u5728\u961f\u4e2d\u5373\u53ef\u3002\u4e5f\u5c31\u662f\u8bb0\u5f55\u6bcf\u4e2a\u70b9\u51fa\u961f\u548c\u5165\u961f\u7684\u65f6\u95f4\u6233\uff0c\u7136\u540e\u5728\u5e8f\u5217\u4e0a\u4fee\u6539\u3002\n\n\u6ce8\u610f\uff0c\u5bf9\u4e8eLCA\u5176\u5b9e\u5728\u6b27\u62c9\u5e8f\u65f6\u662f\u6ca1\u6709\u5305\u62ec\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5355\u72ec\u6c42\u4e00\u4e0bLCA\u7684\u5f71\u54cd\u3002\u4f46\u662f\u5982\u679c\u4e00\u4e2a\u7aef\u70b9\u672c\u8eab\u5c31\u662fLCA\u5c31\u4e0d\u7528\u5566\u3002\n\n\u4f46\u662f\uff01\u7528\u6307\u9488\u5b9e\u73b0\u4e5f\u592alow\u4e86\uff0c\u6211\u4eec\u76f4\u63a5\u5229\u7528\u5b83\u7684\u6811\u5f62\u7ed3\u6784\u83ab\u961f\u5c31\u884c\uff08\u5b9e\u9645\u4e0a\u5c31\u662f\u6211\u770b\u9519\u4e86\u9898\u89e3\uff09\n\n### \u4ee3\u7801\n\n#### \u5206\u5757\u548c\u6392\u5e8f\n\n```cpp\n\tint dfs(int x,int f){//\u6bd2\u7624\u7684\u6811\u5206\u5757\u800c\u975e\u5e8f\u5217\u5206\u5757\n\t\tint siz=0;\n\t\tfa[x][0]=f;dep[x]=dep[f]+1;\n\t\tdfn[x]=++tim;\n\t\tfor(int i=0;i<=20;i++)fa[x][i+1]=fa[fa[x][i]][i];\n\t\tfor(int i=head[x];i;i=nxt[i]){\n\t\t\tint u=to[i];\n\t\t\tif(u==f)continue;\n\t\t\tsiz+=dfs(u,x);\n\t\t\tif(siz>=_nsiz){\n\t\t\t\t_n++;\n\t\t\t\twhile(siz)belong[st[top--]]=_n,siz--;\n\t\t\t}\n\t\t}\n\t\tst[++top]=x;\n\t\treturn siz+1;\n\t}\n//----------------\n\t++_n;\n\twhile(top)belong[st[top--]]=_n;\n```\n\n```cpp\ninline bool operator < (const query&zp)const {return belong[u]<belong[zp.u] or (belong[u]==belong[zp.u] and (belong[v]<belong[zp.v] or (belong[v]==belong[zp.v] and id<zp.id)));}//\u8fd0\u7b97\u7b26\u7248\n```\n\n#### \u83ab\u961f\n\n```cpp\n\tinline void reverse(const int& x,ll &ans){//\u5c06\u8fdb\u961f\u7684\u51fa\u961f\uff0c\u51fa\u961f\u7684\u8fdb\u961f\u3002\n\t\tif(vis[x])ans-=1ll*w[num[color[x]]]*v[color[x]],num[color[x]]--;\n\t\telse num[color[x]]++,ans+=1ll*w[num[color[x]]]*v[color[x]];\n\t\tvis[x]^=1;\n\t}\n\tinline void solve(int x,int y,ll &ans){//\u76f4\u63a5\u5229\u7528\u6811\u5f62\u7ed3\u6784\u8df3father\uff0c\u66f4\u65b0\u7b54\u6848\uff0c\u53cd\u6b63\u62ec\u53f7\u5e8f\u5217\u4e5f\u5c31\u662f\u7ffb\u8f6c\u3002\n\t\twhile(x!=y){\n\t\t\tif(dep[x]>dep[y])reverse(x,ans),x=fa[x][0];\n\t\t\telse reverse(y,ans),y=fa[y][0];\n\t\t}\n\t}\n```\n\n```cpp\n\t\tfor(int i=1;i<=cntq;i++){\n\t\t\twhile(now<cntm and mo[now+1].id<=q[i].id){//\u5904\u7406\u65f6\u95f4\u95ee\u9898\uff0c\u53ea\u80fd\u66b4\u529b\u6d88\u9664\u5f71\u54cd\u3002\n\t\t\t\tnow++;\n\t\t\t\tif(vis[mo[now].pos])ans-=w[num[color[mo[now].pos]]]*v[color[mo[now].pos]],num[color[mo[now].pos]]--;\n\t\t\t\tcolor[mo[now].pos]=mo[now].aft;\n\t\t\t\tif(vis[mo[now].pos])num[color[mo[now].pos]]++,ans+=1LL*w[num[color[mo[now].pos]]]*v[color[mo[now].pos]];\n\t\t\t}\n\t\t\twhile(now>=1 and mo[now].id>=q[i].id){\n\t\t\t\tif(vis[mo[now].pos])ans-=w[num[color[mo[now].pos]]]*v[color[mo[now].pos]],num[color[mo[now].pos]]--;\n\t\t\t\tcolor[mo[now].pos]=mo[now].bef;//\u6ce8\u610f\u53d8\u6210\u4e86\u4ec0\u4e48\uff08\u6211\u5c31\u662f\u50bb\n\t\t\t\tif(vis[mo[now].pos])num[color[mo[now].pos]]++,ans+=1LL*w[num[color[mo[now].pos]]]*v[color[mo[now].pos]];\n\t\t\t\tnow--;\n\t\t\t}\n\t\t\tif(i==1)solve(q[i].u,q[i].v,ans);\n\t\t\telse solve(q[i].u,q[i-1].u,ans),solve(q[i].v,q[i-1].v,ans);//\u4fdd\u8bc1\u7ee7\u627f\u7b54\u6848\u8fde\u7eed\n\t\t\tint lca=LCA(q[i].u,q[i].v);\n\t\t\treverse(lca,ans);\n\t\t\tq[i].ans=ans;\n\t\t\treverse(lca,ans);//\u5355\u72ec\u8ba1\u7b97\uff0c\u6700\u540e\u8981\u6d88\u9664\u5f71\u54cd\u3002\u4e0d\u8981\u88ab\u7ee7\u627f\u3002\n\t\t}\n```\n\n\u4e8b\u5b9e\u8bc1\u660e\uff0c\u8fd9\u79cd\u5199\u6cd5\u662f\u771f~~\u6bd2\u7624~~\uff0c\u5f00\u4e86O2\u624d\u52c9\u5f3a\u80fd\u8fc7\u3002\n\n#### \u5168\u4ee3\u7801\n\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<algorithm>\n#include<cstring>\n#include<cctype>\n#include<cmath>\nusing namespace std;\ninline int read(){\n\tint w=0,x=0;char c=getchar();\n\twhile(!isdigit(c))w|=c=='-',c=getchar();\n\twhile(isdigit(c))x=(x<<3)+(x<<1)+(c^48),c=getchar();\n\treturn w?-x:x;\n}\nnamespace star\n{\n\tconst int maxn=1e5+10;\n\ttypedef long long ll;\n\tint n,m,Q,_n,fa[maxn][23],_nsiz,dfn[maxn],dep[maxn],c[maxn],color[maxn];\n\tll v[maxn],w[maxn];\n\tint ecnt,tim,st[maxn<<1],belong[maxn],top,head[maxn],to[maxn<<1],nxt[maxn<<1];\n\tstruct query{\n\t\tint u,v,id;\n\t\tll ans;\n\t\tinline bool operator < (const query&zp)const {return belong[u]<belong[zp.u] or (belong[u]==belong[zp.u] and (belong[v]<belong[zp.v] or (belong[v]==belong[zp.v] and id<zp.id)));}\n\t}q[maxn];\n\tinline bool cmp(query a,query b){return a.id<b.id;}\n\tstruct modify{\n\t\tint pos,bef,aft,id;\n\t}mo[maxn<<1];\n\tinline void addedge(int a,int b){\n\t\tto[++ecnt]=b,nxt[ecnt]=head[a],head[a]=ecnt;\n\t\tto[++ecnt]=a,nxt[ecnt]=head[b],head[b]=ecnt;\n\t}\n\tint dfs(int x,int f){\n\t\tint siz=0;\n\t\tfa[x][0]=f;dep[x]=dep[f]+1;\n\t\tdfn[x]=++tim;\n\t\tfor(int i=0;i<=20;i++)fa[x][i+1]=fa[fa[x][i]][i];\n\t\tfor(int i=head[x];i;i=nxt[i]){\n\t\t\tint u=to[i];\n\t\t\tif(u==f)continue;\n\t\t\tsiz+=dfs(u,x);\n\t\t\tif(siz>=_nsiz){\n\t\t\t\t_n++;\n\t\t\t\twhile(siz)belong[st[top--]]=_n,siz--;\n\t\t\t}\n\t\t}\n\t\tst[++top]=x;\n\t\treturn siz+1;\n\t}\n\tinline int LCA(int x,int y){\n\t\tif(dep[x]<dep[y])swap(x,y);\n\t\tfor(int i=20;i+1;i--)if(dep[fa[x][i]]>=dep[y])x=fa[x][i];\n\t\tif(x==y)return x;\n\t\tfor(int i=20;i+1;i--)if(fa[x][i]!=fa[y][i])x=fa[x][i],y=fa[y][i];\n\t\treturn fa[x][0];\n\t}\n\tbool vis[maxn];\n\tint num[maxn];\n\tinline void reverse(const int& x,ll &ans){\n\t\tif(vis[x])ans-=1ll*w[num[color[x]]]*v[color[x]],num[color[x]]--;\n\t\telse num[color[x]]++,ans+=1ll*w[num[color[x]]]*v[color[x]];\n\t\tvis[x]^=1;\n\t}\n\tinline void solve(int x,int y,ll &ans){\n\t\twhile(x!=y){\n\t\t\tif(dep[x]>dep[y])reverse(x,ans),x=fa[x][0];\n\t\t\telse reverse(y,ans),y=fa[y][0];\n\t\t}\n\t}\n\tinline void work(){\n\t\tn=read(),m=read(),Q=read();\n\t\t_nsiz=pow(n,0.666666666);\n\t\tfor(int i=1;i<=m;i++)v[i]=read();\n\t\tfor(int i=1;i<=n;i++)w[i]=read();\n\t\tfor(int i=1;i<n;i++)addedge(read(),read());\n\t\tfor(int i=1;i<=n;i++)c[i]=color[i]=read();\n\t\tint cntq=0,cntm=0,x;\n\t\tfor(int i=1;i<=Q;i++){\n\t\t\tif(read())q[++cntq].id=i,q[cntq].u=read(),q[cntq].v=read();\n\t\t\telse mo[++cntm].id=i,mo[cntm].bef=c[(x=read())],mo[cntm].pos=x,mo[cntm].aft=c[x]=read();\n\t\t}\n\t\tdfs(1,0);\n\t\tfor(int i=1;i<=cntq;i++)if(dfn[q[i].v]<dfn[q[i].u])swap(q[i].u,q[i].v);//\u5bf9\u4e8e\u8fd9\u79cd\u5199\u6cd5\u8fd9\u53e5\u5176\u5b9e\u53ef\u6709\u4e5f\u53ef\u65e0\u4e86\u3002\u8fd9\u79cd\u5199\u6cd5\u7684\u4e00\u4e2a\u597d\u5904\u5c31\u662f\u4e0d\u4ea4\u6362\u4e0d\u5f71\u54cd\u6b63\u786e\u6027\u3002\n\t\t++_n;\n\t\twhile(top)belong[st[top--]]=_n;\n\t\tsort(q+1,q+1+cntq);\n\t\tint now=0;\n\t\tlong long ans=0;\n\t\tfor(int i=1;i<=cntq;i++){\n\t\t\twhile(now<cntm and mo[now+1].id<=q[i].id){\n\t\t\t\tnow++;\n\t\t\t\tif(vis[mo[now].pos])ans-=w[num[color[mo[now].pos]]]*v[color[mo[now].pos]],num[color[mo[now].pos]]--;\n\t\t\t\tcolor[mo[now].pos]=mo[now].aft;\n\t\t\t\tif(vis[mo[now].pos])num[color[mo[now].pos]]++,ans+=1LL*w[num[color[mo[now].pos]]]*v[color[mo[now].pos]];\n\t\t\t}\n\t\t\twhile(now>=1 and mo[now].id>=q[i].id){\n\t\t\t\tif(vis[mo[now].pos])ans-=w[num[color[mo[now].pos]]]*v[color[mo[now].pos]],num[color[mo[now].pos]]--;\n\t\t\t\tcolor[mo[now].pos]=mo[now].bef;\n\t\t\t\tif(vis[mo[now].pos])num[color[mo[now].pos]]++,ans+=1LL*w[num[color[mo[now].pos]]]*v[color[mo[now].pos]];\n\t\t\t\tnow--;\n\t\t\t}\n\t\t\tif(i==1)solve(q[i].u,q[i].v,ans);\n\t\t\telse solve(q[i].u,q[i-1].u,ans),solve(q[i].v,q[i-1].v,ans);\n\t\t\tint lca=LCA(q[i].u,q[i].v);\n\t\t\treverse(lca,ans);\n\t\t\tq[i].ans=ans;\n\t\t\treverse(lca,ans);\n\t\t}\n\t\tsort(q+1,q+1+cntq,cmp);\n\t\tfor(int i=1;i<=cntq;i++)printf(\"%lld\\n\",q[i].ans);\n\t}\n}\nsigned main(){\n\tstar::work();\n\treturn 0;\n}\n```\n\n### \u603b\u7ed3\n\n\u5199\u4e86\u4e2a\u5047\u7684\uff08gxy\u79f0\u4e4b\u4e3a\u975e\u4e3b\u6d41\uff09\u6811\u4e0a\u83ab\u961f\u3002\u51c6\u5907\u518d\u5199\u4e00\u9053\u514d\u5f97\u8111\u5b50\u91cc\u88c5\u7740\u5947\u602a\u7684\u4e1c\u897f\u3002\n\n\u56e0\u4e3a\u5199\u6cd5\u6bd2\u7624\u6240\u4ee5#define int long long\u4f1aT\u98de\u3002\n\n~~\u5927\u5bb6\u5343\u4e07\u4e0d\u8981\u5b66\u975e\u4e3b\u6d41~~\n\n~~\u6240\u4ee5\u8fd9\u4e2a\u9898\u89e3\u5982\u679c\u80fd\u901a\u8fc7\u7684\u8bdd\u5927\u5bb6\u5f53\u7740\u975e\u4e3b\u6d41\u770b\u770b\u5c31\u597d\u4e86\u3002\u8bf7\u968f\u4fbf\u9a82\u6211~~",
        "postTime": 1600698605,
        "uid": 280015,
        "name": "Star_Cried",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P4074 \u3010[WC2013]\u7cd6\u679c\u516c\u56ed\u3011"
    },
    {
        "content": "### Preface  \n\u8fd9\u9898\u662f\u6811\u4e0a\u8f6c\u5e8f\u5217\u7684\u7ecf\u5178\u83ab\u961f\u4f8b\u9898\uff0c\u9700\u8981\u5927\u5bb6\u591a\u52a0\u7406\u89e3\u3002  \n\uff08\u672c\u6587\u9898\u76ee\u7b80\u8ff0\u548c\u90e8\u5206\u4ee3\u7801\u501f\u9274\u4e86 OI Wiki\u3002\uff09\n### Problem  \n\u7ed9\u4f60\u4e00\u68f5\u6811\uff0c\u6811\u4e0a\u7b2c $i$ \u4e2a\u70b9\u989c\u8272\u662f $c_i$\uff0c\u6bcf\u6b21\u8be2\u95ee\u4e00\u6761\u8def\u5f84 $u_i,v_i$\uff0c\u6c42\u8fd9\u6761\u8def\u5f84\u4e0a\u7684\uff1a  \n\n$\\sum_c val_c \\sum _{i=1}^{cntc}w_i$  \n\n\u5176\u4e2d\uff1a$val$ \u8868\u793a\u8be5\u989c\u8272\u7684\u4ef7\u503c\uff0c$cnt$ \u8868\u793a\u989c\u8272\u51fa\u73b0\u7684\u6b21\u6570\uff0c$w$ \u8868\u793a\u8be5\u989c\u8272\u51fa\u73b0 $i$ \u6b21\u540e\u7684\u4ef7\u503c\u3002  \n\n### Solution  \n\u8fd9\u9898\u8bf4\u662f\u6811\u4e0a\u83ab\u961f\uff0c\u4f46\u5176\u5b9e\u4e0d\u7b97\u4e25\u683c\u7684\u6811\u4e0a\u83ab\u961f\uff0c\u56e0\u4e3a\u8981\u5148\u628a\u6811\u7ed9\u8f6c\u4e3a\u5e8f\u5217\u518d\u5728\u5e8f\u5217\u4e0a\u8fdb\u884c\u83ab\u961f\u3002  \n\u600e\u4e48\u8f6c\u5e8f\u5217\u5462\uff1f\u8fd9\u91cc\u8981\u7528\u5230\u4e00\u4e2a\u5c0f trick\uff0c\u628a\u6811\u6309 dfs \u5e8f\u8f6c\u4e3a\u62ec\u53f7\u5e8f\u5217\uff0c\u5373\uff1a  \n\u5728\u9012\u5f52\u5230 $x$ \u70b9\u65f6\uff0c\u5f80\u5e8f\u5217\u91cc\u52a0\u5165 $x$ \u4ee3\u8868\u5de6\u62ec\u53f7\uff0c\u5728\u9012\u5f52\u5b8c\u5176\u6240\u6709\u5b50\u8282\u70b9\u65f6\uff0c\u518d\u6b21\u5c06\u5176\u52a0\u5165\uff0c\u4ee3\u8868\u53f3\u62ec\u53f7\uff0c\u4e0d\u96be\u53d1\u73b0\u4e00\u5bf9\u62ec\u53f7\u4ee3\u8868\u4e00\u68f5\u5b50\u6811\u3002    \n\n\u7136\u540e\uff0c\u5728\u8fdb\u884c\u83ab\u961f\u7684\u65f6\u5019\uff0c\u5982\u679c\u627e\u5230\u4e00\u4e2a\u5e8f\u5217\u4e0a\u7684\u70b9\u8981\u52a0\u5165\uff0c\u5176\u4ee3\u8868\u7684\u6811\u4e0a\u70b9\u5728\u4e4b\u524d\u5df2\u7ecf\u8ba1\u7b97\u8fc7\u4e86\uff0c\u90a3\u4e48\u8fd9\u6b21\u8981\u5c06\u5176\u51cf\u6389\u3002\u8981\u5f39\u51fa\u7684\u65f6\u5019\u5219\u53cd\u4e4b\u3002  \n\u8fd9\u6837\uff0c\u4efb\u4f55\u4e00\u6761\u4ece\u4e0a\u5230\u4e0b\u7684\u8def\u5f84\u90fd\u53ef\u4ee5\u88ab\u8fd9\u4e2a\u5e8f\u5217\u7684\u4e00\u4e2a\u5b50\u6bb5\u8868\u793a\u4e86\uff0c\u5404\u4f4d\u7406\u89e3\u4e00\u4e0b\u3002    \n\n\u5728\u4e0a\u65b9\u7684\u90a3\u4e2a\u70b9\u6240\u5728\u5e8f\u5217\u4e2d\u7684\u5de6\u62ec\u53f7\u5f00\u59cb\u5230\u5176\u53f3\u62ec\u53f7\u90fd\u662f\u8fd9\u4e2a\u5b50\u6811\u5185\uff0c\u4ece\u4e0a\u65b9\u70b9\u7684\u5de6\u62ec\u53f7\u76f4\u5230\u4e0b\u65b9\u90a3\u4e2a\u70b9\u7684\u5de6\u62ec\u53f7\u6240\u5f62\u6210\u7684\u5b50\u6bb5\u5c31\u662f\u6211\u4eec\u8981\u7684\u5b50\u6bb5\uff0c\u6240\u6709\u4e0e\u8fd9\u6761\u8def\u5f84\u65e0\u5173\u7684\u70b9\u5e94\u8be5\u88ab\u5305\u542b\u5728\u4e0e\u8fd9\u6761\u94fe\u76f8\u90bb\u7684\u5b50\u6811\u5185\uff0c\u4f1a\u5728\u83ab\u961f\u65f6\u88ab\u5237\u65b0\u4e3a 0 \u8d21\u732e\u3002\u6362\u4e2a\u89d2\u5ea6\u8bf4\uff0c\u4e0e\u8fd9\u4e2a\u8def\u5f84\u6709\u5173\u7684\u70b9\u56e0\u4e3a\u4e0d\u4f1a\u56de\u6eaf\uff0c\u6240\u4ee5\u53ea\u6709\u5de6\u62ec\u53f7\uff1a  \n![](https://cdn.luogu.com.cn/upload/image_hosting/8ihxik5j.png)  \n\n\u73b0\u5728\u95ee\u9898\u6765\u4e86\uff1a\u4ece\u4e0a\u5230\u4e0b\u7684\u94fe\u6211\u4eec\u4f1a\u505a\u4e86\uff0c\u4f46\u662f...  \n**\u4e0d\u662f\u8fd9\u6837\u7684\u94fe\u600e\u4e48\u505a\u554a\uff1f**  \n\u66f4\u6807\u51c6\u7684\u8bf4\u6cd5\uff1a\u4e24\u4e2a\u70b9\u7684 LCA \u4e0d\u662f\u4efb\u4f55\u4e00\u4e2a\u70b9\u7684\u94fe\u600e\u4e48\u505a\u554a\u3002  \n\u62c6\u6210\u4e24\u4e2a\u94fe\uff1f\u5f88\u62b1\u6b49\uff0c\u8fd9\u73a9\u610f\u4e0d\u5177\u5907\u53ef\u52a0\u6027\u3002  \n\u4ed4\u7ec6\u4e00\u770b\uff0c\u597d\u50cf\u8fd8\u662f\u6709\u529e\u6cd5\u7684\u3002  \n\u5982\u679c\u4ece\u7b2c\u4e00\u4e2a\u8282\u70b9\u7684\u53f3\u62ec\u53f7\u5f00\u59cb\uff0c\u5230\u7b2c\u4e8c\u4e2a\u8282\u70b9\u7684\u5de6\u62ec\u53f7\u3002  \n\u8fd9\u6837\uff0c\u4ece\u7b2c\u4e00\u4e2a\u8282\u70b9\u5230 LCA \u6709\u7528\u7684\u73a9\u610f\u90fd\u5229\u7528\u56de\u6eaf\u88ab\u8f6c\u5316\u4e3a\u53f3\u62ec\u53f7\u4e86\uff0c\u7b2c\u4e8c\u4e2a\u53cd\u4e4b\uff0c\u6309\u7167\u4ece\u4e0a\u5230\u4e0b\u7684\u539f\u7406\uff0c\u662f\u5de6\u62ec\u53f7\u3002  \n\u4f46\u662f\u8fd9\u6837\u7684\u8bdd LCA \u672c\u8eab\u6ca1\u6709\u88ab\u52a0\u5165\uff0c\u56e0\u4e3a\u5b83\u5b50\u6811\u4ee3\u8868\u7684\u62ec\u53f7\u5305\u542b\u4e86\u4e24\u4e2a\u8282\u70b9\u3002  \n\u8fd9\u4e2a\u7b80\u5355\uff0c\u8bb0\u5f55\u7b54\u6848\u7684\u65f6\u5019\u52a0\u5165\u4e00\u4e0b LCA \u5c31\u884c\u4e86\u3002     \n\u6ce8\u610f\u5230\u6709\u4e00\u4e2a\u4fee\u6539\u64cd\u4f5c\uff0c\u4e8e\u662f\u6211\u4eec\u6392\u5e8f\u52a0\u4e00\u4e2a\u65f6\u95f4\u7ef4\u5ea6\uff0c$l,r$ \u6309\u5757\u6392\u5e8f\uff0c$t$ \u4ece\u5c0f\u5230\u5927\u6392\u5e8f\uff0c\u53d8\u4e3a\u5e26\u4fee\u83ab\u961f\uff0c\u5757\u957f\u4e3a $n^\\frac{2}{3}$\uff0c\u603b\u590d\u6742\u5ea6\u4e3a $O(n^\\frac{5}{3})$\u3002  \n\u8bc1\u660e\uff1a  \n1.\u9996\u5148\u5bf9\u4e8e $l$ \u6307\u9488\uff1a  \n\u82e5\u5728\u540c\u4e00\u5757\u5185\uff0c$l$ \u7684\u79fb\u52a8\u662f $O(n^\\frac{2}{3})$ \u7684\uff0c\u4e58\u4e0a $m$ \u4e2a\u8be2\u95ee\u603b\u590d\u6742\u5ea6\u662f $O(m n^\\frac{2}{3})$ \u7684\uff0c\u7531\u4e8e $m$ \u4e0e $n$ \u540c\u9636\uff0c\u6240\u4ee5\u8fd9\u90e8\u5206\u7684\u590d\u6742\u5ea6\u4e3a $O(n^\\frac{5}{3})$\u3002  \n\u4e0d\u5728\u540c\u4e00\u5757\u5185\uff0c$l$ \u79fb\u5230\u4e0b\u4e00\u5757\u7684\u79fb\u52a8\u590d\u6742\u5ea6\u4e3a $O(n^\\frac{2}{3})$\uff0c\u5757\u6570\u4e3a$n^\\frac{1}{3}$\uff0c\u603b\u590d\u6742\u5ea6\u4e3a $O(n)$\u3002  \n2.\u5bf9\u4e8e $r$ \u6307\u9488\uff1a  \n\u82e5 $l$ \u4e0e $r$ \u6b64\u65f6\u90fd\u5728\u540c\u4e00\u4e2a\u5757\u5185\u79fb\u52a8\uff0c\u90a3\u4e48\u5355\u6b21\u79fb\u52a8\u7684\u590d\u6742\u5ea6 $O(n^\\frac{2}{3})$\uff0c\u4e00\u5171\u6709 $(n^\\frac{1}{3})^2$ \u6b21\u673a\u4f1a\uff0c\u603b\u590d\u6742\u5ea6\u4e3a $O(n^\\frac{4}{3})$ \u7684\u3002  \n\u82e5 $l$ \u5757\u4e0d\u53d8\uff0c$r$ \u5757\u79fb\u52a8\uff0c\u90a3\u4e48\u79fb\u5230\u4e0b\u4e00\u4e2a\u5757\u7684\u590d\u6742\u5ea6\u4e3a $O(n^\\frac{2}{3})$\uff0c$r$ \u4e00\u5171\u6709 $n^\\frac{1}{3}$ \u4e2a\u8fd9\u6837\u7684\u5757\uff0c$l$ \u76f8\u540c\uff0c\u5168\u90e8\u76f8\u4e58\u540e\u8fd9\u90e8\u5206\u590d\u6742\u5ea6\u4e3a $O(n^\\frac{4}{3})$ \u7684\u3002  \n\u82e5 $l$ \u5757\u53d8\u5316\u4e86\uff0c\u90a3\u4e48\u5355\u6b21\u590d\u6742\u5ea6\u4e3a $O(n)$ \u7684\uff0c$l$ \u4e00\u5171\u6709 $n^\\frac{1}{3}$ \u4e2a\u8fd9\u6837\u7684\u5757\uff0c\u603b\u590d\u6742\u5ea6\u4e3a $O(n^\\frac{4}{3})$ \u7684\u3002  \n3,\u5bf9\u4e8e $t$ \u6307\u9488\uff1a  \n\u82e5 $l,r$ \u90fd\u5728\u5757\u5185\u79fb\u52a8\uff0c\u90a3\u4e48\u5176\u5355\u8c03\u4e0d\u51cf\uff0c\u5355\u6b21\u590d\u6742\u5ea6 $O(n)$ \uff0c$r$ \u4e00\u5171\u6709 $n^\\frac{1}{3}$ \u4e2a\u8fd9\u6837\u7684\u5757\uff0c$l$ \u76f8\u540c\uff0c\u4e58\u8d77\u6765\u590d\u6742\u5ea6\u4e3a $O(n^\\frac{5}{3})$ \u7684\u3002  \n\u82e5 $l$ \u5757\u76f8\u540c\uff0c$r$ \u5757\u79fb\u52a8\uff0c\u590d\u6742\u5ea6\u540c\u4e0a\u3002  \n\u82e5 $l$ \u5757\u79fb\u52a8\uff0c\u603b\u590d\u6742\u5ea6\u4e3a $O(n^\\frac{4}{3})$ \u7684\u3002  \n\u6240\u4ee5\u7b97\u6cd5\u603b\u590d\u6742\u5ea6\u4e3a $O(n^\\frac{5}{3})$\u3002\n  \n\u5e26\u4fee\u83ab\u961f\u5177\u4f53\u7684\u4ecb\u7ecd\u5728[\u8fd9\u91cc](https://www.luogu.com.cn/problem/P1903)\u3002  \ncode\uff1a  \n```cpp\n#include <bits/stdc++.h>\n#define ll long long\nusing namespace std;\nconst int N=2e5+10;\nint n,m,q,x,y;\nvector <int> edge[N];\nint v[N];int w[N];int c[N];\nint opt;int cnt;int seq[N];ll ans[N];\nint bucket[N];ll res;int a[N],b[N];\nint st[N][21];int deep[N];\nvoid build(int u,int fa){\n\tst[u][0]=fa;deep[u]=deep[fa]+1;\n\tfor(int i=1;i<=20;i++)st[u][i]=st[st[u][i-1]][i-1];\n\tseq[a[u]=++cnt]=u;\n\tfor(int i=0;i<edge[u].size();i++){\n\t\tint to=edge[u][i];\n\t\tif(to==fa)continue;\n\t\tbuild(to,u);\n\t}\n\tseq[b[u]=++cnt]=u;\n}\nint LCA(int x,int y){\n\tif(deep[x]<deep[y])swap(x,y);\n\tfor(int i=20;i>=0;i--){\n\t\tif(deep[st[x][i]]>=deep[y])x=st[x][i];\n\t}\n\tif(x==y)return x;\n\tfor(int i=20;i>=0;i--){\n\t\tif(st[x][i]!=st[y][i])\n\t\t\tx=st[x][i],y=st[y][i];\n\t}\n\treturn st[x][0];\n}\nint l,r,block,tot1,tot2,p[N],last[N];bool vis[N];\nstruct Qry{int l,r,t,id;}Q[N];Qry up[N];\nbool cmp(Qry a,Qry b){\n\tif(p[a.l]!=p[b.l])return a.l<b.l;\n\telse{\n\t\tif(p[a.r]!=p[b.r])return a.r<b.r;\n\t\telse return a.t<b.t;\n\t}\n}\nvoid add(int x){\n\tif(!vis[x])res+=(ll)w[++bucket[c[x]]]*v[c[x]];\n\telse res-=(ll)w[bucket[c[x]]--]*v[c[x]];\n\tvis[x]^=1;\n}\nvoid modify(int x,int y){\n\tif(vis[x]){add(x);c[x]=y;add(x);}\n\telse c[x]=y;\n}\nint main(){\n\tscanf(\"%d%d%d\",&n,&m,&q);\n\tfor(int i=1;i<=m;i++)scanf(\"%d\",&v[i]);\n\tfor(int i=1;i<=n;i++)scanf(\"%d\",&w[i]);\n\tfor(int i=1;i<n;i++){\n\t\tscanf(\"%d%d\",&x,&y);\n\t\tedge[x].push_back(y);\n\t\tedge[y].push_back(x);\n\t}\n\tfor(int i=1;i<=n;i++)\n\t\tscanf(\"%d\",&c[i]),last[i]=c[i];\n\tbuild(1,0);block=pow(2*n,2.0/3.0);\n\tfor(int i=1;i<=2*n;i++){\n\t\tif(i%block!=0)p[i]=(i/block)+1;\n\t\telse p[i]=i/block;\n\t}\n\tfor(int i=1;i<=q;i++){\n\t\tscanf(\"%d%d%d\",&opt,&x,&y);\n\t\tif(opt==0){\n\t\t\tup[++tot2].l=x;\n\t\t\tup[tot2].r=last[x];\n\t\t\tlast[x]=up[tot2].t=y;\n\t\t}else{\n\t\t\tif(a[x]>a[y])swap(x,y);\n\t\t\tQ[++tot1]=(Qry){LCA(x,y)==x?a[x]:b[x],a[y],tot2,tot1};\n\t\t}\n\t}\n\tsort(Q+1,Q+1+tot1,cmp);\n\tint l=1;int r=0;int T=1;\n\tfor(int i=1;i<=tot1;i++){\n\t\twhile(T<=Q[i].t){modify(up[T].l,up[T].t);T++;}\n\t\twhile(T>Q[i].t){modify(up[T].l,up[T].r);T--;}\n\t\twhile(l>Q[i].l){l--;add(seq[l]);}\n\t\twhile(l<Q[i].l){add(seq[l]);l++;}\n\t\twhile(r>Q[i].r){add(seq[r]);r--;}\n\t\twhile(r<Q[i].r){r++;add(seq[r]);}\n\t\tint x=seq[l];int y=seq[r];int lca=LCA(x,y);\n\t\tif(x!=lca&&y!=lca){add(lca);ans[Q[i].id]=res;add(lca);}\n\t\telse ans[Q[i].id]=res;\n\t}\n\tfor(int i=1;i<=tot1;i++)printf(\"%lld\\n\",ans[i]);\n\treturn 0;\n}\n```\n",
        "postTime": 1651906096,
        "uid": 213173,
        "name": "\u5c0f\u6728\u866b",
        "ccfLevel": 4,
        "title": "\u3010lxl\u72c2\u559c\u3011WC2013 \u7cd6\u679c\u516c\u56ed"
    },
    {
        "content": "\u6811\u4e0a\u5e26\u4fee\u83ab\u961f\u7684\u6a21\u677f\u9898\n\u5148\u5b89\u5229\u4e00\u4e2a\u5c06\u83ab\u961f\u6bd4\u8f83\u597d\u7684\u535a\u5ba2  [\u6233\u6211](https://www.cnblogs.com/WAMonster/p/10118934.html)\n\n\u9996\u5148\u770b\u8fd9\u9898\uff0c\u51e0\u4e2a\u64cd\u4f5c\n\n1. \u67e5\u8be2\u4e00\u6761\u94fe\u7684\u6109\u60a6\u6307\u6570\n\n2. \u4fee\u6539\u4e00\u4e2a\u70b9\u7684\u503c\n\n\u4e00\u822c\u9047\u5230\u8fd9\u79cd\u5355\u70b9\u4fee\u6539\u533a\u95f4\u67e5\u8be2\u7684\u9898\u83ab\u961f\u90fd\u53ef\u4ee5\u505a\uff0c\u9996\u5148\u8003\u8651\u600e\u4e48\u5904\u7406\u8fd9\u4e00\u6761\u94fe\uff0c\u6211\u4eec\u53ef\u4ee5\u7528[\u6b27\u62c9\u5e8f](https://blog.csdn.net/m0_37809890/article/details/82856158?utm_source=blogxgwz6)\u628a\u8fd9\u4e00\u68f5\u6811\u8f6c\u6362\u4e3a\u4e00\u4e2a\u5e8f\u5217\uff0c\u8fd9\u6837\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5728\u8fd9\u4e2a\u5e8f\u5217\u4e0a\u8fdb\u884c\u6109\u5feb\u7684\u83ab\u961f\u4e86\u3002\n\n\u6211\u4eec\u628a\u4e00\u70b9\u94fe\u8f6c\u6362\u6210\u4e86\u4e00\u4e2a\u533a\u95f4\u4ee5\u540e\u4fee\u6539\u5462\uff1f\u5bf9\u4e8e\u6bcf\u4e00\u6b21\u67e5\u8be2\uff0c\u6211\u4eec\u8bb0\u5f55\u5b83\u7684\u65f6\u95f4\u6233\uff0c\u4e5f\u5c31\u662f\u5b83\u662f\u5728\u7b2c\u51e0\u6b21\u4fee\u6539\u4e4b\u540e\u67e5\u8be2\u7684\uff0c\u6211\u4eec\u5728\u8bb0\u5f55\u5f53\u524d\u7684\u65f6\u95f4\uff0c\u7136\u540e\u66b4\u529b\u7684\u53bb\u4fee\u6539\u3002\n\n\u4ee3\u7801\n\n```\n#include<cstdio>\n#include<cmath>\n#include<algorithm>\n#define ll long long\nusing namespace std;\nstruct llk\n{\n\tint id,l,r,z,t1;\n}q[200100];\nstruct llk2\n{\n\tint to,next;\n}e[200100];\nstruct llk3\n{\n\tint p,c;\n}cg[200100];\nint lxwy=0,head[100010];\nvoid adde(int u,int v)\n{\n\te[++lxwy].to=v;\n\te[lxwy].next=head[u];\n\thead[u]=lxwy;\n}\nconst int maxn=200010;\nint n,m,a[200010],k,t[200010],qu;\nint in[200010],st[200010],en[200010],cnt,w[200010];\nint deep[200010],bo[200010];\nint t1,t2,v[200010];\nlong long sum,ans[200010];\nint f[maxn],size[maxn],son[maxn],d[maxn],top[maxn];\nbool cmp(llk x,llk y)\n{\n\tif(x.l/k!=y.l/k) return x.l/k<y.l/k; \n\treturn x.r<y.r; \n}\nvoid dfs(int u,int fa)\n{\n\tin[++cnt]=u; \n\tst[u]=cnt; \n\tfor(int i=head[u];i;i=e[i].next)\n\t{\n\t\tint v=e[i].to;\n\t\tif(v==fa) continue; \n\t\tdfs(v,u);\n\t}\n\tin[++cnt]=u;\n\ten[u]=cnt;\n}\nvoid dfs1(int x,int fa)\n{\n\tf[x]=fa;\n\tsize[x]=1;\n\tfor (int i=head[x];i;i=e[i].next)\n\t{\n\t\tint y=e[i].to;\n\t\tif (y==fa)continue;\n\t\td[y]=d[x]+1;\n\t\tdfs1(y,x);\n\t\tsize[x]+=size[y];\n\t\tif (size[y]>size[son[x]])son[x]=y;\n\t}\n}\nvoid dfs2(int x,int tp)\n{\n\ttop[x]=tp;\n\tif (son[x])dfs2(son[x],tp);\n\tfor (int i=head[x];i;i=e[i].next)\n\t{\n\t\tint y=e[i].to;\n\t\tif (y==f[x]||y==son[x])continue;\n\t\tdfs2(y,y);\n\t}\n}\nint lca(int x,int y)\n{\n\twhile (top[x]!=top[y])\n\t{\n\t\tif (d[top[x]]<d[top[y]])swap(x,y);\n\t\tx=f[top[x]];\n\t}\n\treturn d[x]<d[y]?x:y;\n}\nvoid change(int x)\n{\n\tif(bo[cg[x].p]==1)\n\t{\n\t\tt[cg[x].c]++;\n\t\tsum+=(long long)v[cg[x].c]*w[t[cg[x].c]];\n\t\tt[a[cg[x].p]]--;\n\t\tsum-=(long long)v[a[cg[x].p]]*w[t[a[cg[x].p]]+1];\n\t}\n\tswap(a[cg[x].p],cg[x].c);\n}\nvoid update(int x)\n{\n\tif (x==0)return ;\n\tif (bo[x]==0)\n\t{\n\t\tt[a[x]]++;\n\t\tsum+=(ll)w[t[a[x]]]*v[a[x]];\n\t}\n\telse\n\t{\n\t\tsum-=(ll)w[t[a[x]]]*v[a[x]];\n\t\tt[a[x]]--;\n\t}\n\tbo[x]^=1;\n}\nint main()\n{\n\tscanf(\"%d%d%d\",&n,&m,&qu);\n\tk=pow(n,2.0/3); \n\tfor(int i=1;i<=m;i++) scanf(\"%d\",&v[i]);\n\tfor(int i=1;i<=n;i++) scanf(\"%d\",&w[i]);\n\tfor(int i=1;i<n;i++)\n\t{\n\t\tint x,y;\n\t\tscanf(\"%d%d\",&x,&y);\n\t\tadde(x,y); adde(y,x);\n\t}\n\tfor(int i=1;i<=n;i++)scanf(\"%d\",&a[i]);\n\tdfs(1,1);\n\tdfs1(1,1);\n\tdfs2(1,1);\n\tfor(int i=1;i<=qu;i++)\n\t{\n\t\tint op,x,y;\n\t\tscanf(\"%d%d%d\",&op,&x,&y);\n\t\tif(op==0)\n\t\t{\n\t\t\tt1++;\n\t\t\tcg[t1].p=x;\n\t\t\tcg[t1].c=y;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tt2++;\n\t\t\tq[t2].id=t2;\n\t\t\tq[t2].t1=t1;\n\t\t\tint p=lca(x,y);\n\t\t\tif(x==p||y==p)\n\t\t\t{\n\t\t\t\tif(st[x]>st[y]) swap(x,y); \n\t\t\t\tq[t2].l=st[x],q[t2].r=st[y]; \n\t\t\t} \n\t\t\telse\n\t\t\t{\n\t\t\t\tif(en[y]<st[x]) swap(x,y); \n\t\t\t\tq[t2].l=en[x],q[t2].r=st[y];\n\t\t\t\tq[t2].z=p;\n\t\t\t}\n\t\t}\n\t}\n\tsort(q+1,q+t2+1,cmp);\n\tint l=1,r=0,now=0;\n\tfor(int i=1;i<=t2;i++)\n\t{\n\t\tllk s=q[i];\n\t\twhile(l<s.l)update(in[l++]);\n\t\twhile(l>s.l)update(in[--l]);\n\t\twhile(r<s.r)update(in[++r]);\n\t\twhile(r>s.r)update(in[r--]);\n\t\twhile(now<s.t1)change(++now);\n\t\twhile(now>s.t1)change(now--);\n\t\tif (s.z)update(s.z);\n\t\tans[s.id]=sum;\n\t\tif (s.z)update(s.z);\n\t}\n\tfor(int i=1;i<=t2;i++) printf(\"%lld\\n\",ans[i]);\n}\n```\n\n\n\n",
        "postTime": 1601126490,
        "uid": 227436,
        "name": "\u5e74\u534e\u5929\u5730",
        "ccfLevel": 4,
        "title": "\u9898\u89e3 P4074 \u3010[WC2013]\u7cd6\u679c\u516c\u56ed\u3011"
    },
    {
        "content": "# \u9898\u610f\n\u7ed9\u5b9a\u4e00\u68f5\u6811\uff0c\u6811\u4e0a\u6709$m$\u79cd\u7cd6\u679c,\u7f8e\u5473\u6307\u6570\u4e3a$V_i$\uff0c\u5171\u6709$q$\u6b21\u64cd\u4f5c\uff0c\u6bcf\u6b21\u8be2\u95ee\u6811\u4e0a\u7684\u4e00\u6761\u8def\u5f84$u->v$\uff0c\u7b2c$i$\u6b21\u54c1\u5c1d$j$\u79cd\u7cd6\u679c\u7684\u65b0\u5947\u6307\u6570\u4e3a$W_i$\uff0c\u5e76\u4e14\u6109\u60a6\u6307\u6570$H$\u589e\u52a0$V_j \\times W_i$\uff0c\u6c42\u6700\u7ec8\u7684\u6109\u60a6\u6307\u6570\u6216\u628a\u70b9$x$\u7684\u7cd6\u679c\u7c7b\u578b\u6539\u4e3a$y$\u3002\n# \u9898\u89e3\n\u6811\u4e0a\u5e26\u4fee\u6539\u83ab\u961f\u3002\n- \u8003\u8651\u628a\u6811\u7528\u6b27\u62c9\u5e8f\u53d8\u6210\u5e8f\u5217,\u5bf9\u4e8e\u6bcf\u4e00\u6761\u8be2\u95ee\u7684\u8def\u5f84\uff0c\u53ef\u4ee5\u8f6c\u5316\u4e3a\u5728\u5e8f\u5217\u4e0a\u7684\u8be2\u95ee\u3002\u5982\u679c\u4e24\u4e2a\u70b9\u7684LCA\u4e0d\u7b49\u4e8e\u5176\u4e2d\u4e4b\u4e00\uff0c\u5e8f\u5217\u4e0a\u7684\u533a\u95f4\u5e94\u8be5\u4e3a\u4e24\u4e2a\u70b9\u5728\u6b27\u62c9\u5e8f\u4e0a\u7b2c\u4e00\u6b21\u7684\u4f4d\u7f6e\u4e4b\u95f4\u7684\u533a\u95f4\u222aLCA\uff0c\u5426\u5219\uff0c\u5e8f\u5217\u4e0a\u7684\u533a\u95f4\u5e94\u4e3a\u7b2c\u4e00\u4e2a\u70b9\u540e\u51fa\u73b0\u7684\u4f4d\u7f6e\u5230\u7b2c\u4e8c\u4e2a\u70b9\u7b2c\u4e00\u6b21\u51fa\u73b0\u7684\u4f4d\u7f6e\u3002\u5728\u533a\u95f4\u5185\uff0c\u53ea\u6709\u51fa\u73b0\u4e00\u6b21\u7684\u70b9\u624d\u4f1a\u88ab\u8bb0\u5165\u7b54\u6848\u3002\n\n- \u7ef4\u62a4\u5f53\u524d\u533a\u95f4\u5185\u5404\u79cd\u989c\u8272\u51fa\u73b0\u7684\u6b21\u6570\u3002\u5f53\u533a\u95f4\u5185\u7684\u67d0\u4e2a\u70b9\u7684\u4e2a\u6570\u53d8\u4e3a1\u65f6\uff0c\u6109\u60a6\u6307\u6570\u589e\u52a0(\u8be5\u70b9\u7684\u989c\u8272\u51fa\u73b0\u6b21\u6570+1)$\\times$\u8be5\u70b9\u989c\u8272\u7684\u7f8e\u5473\u6307\u6570\uff0c\u540c\u65f6\uff0c\u8be5\u989c\u8272\u51fa\u73b0\u6b21\u6570+1.\n\n- \u5bf9\u4e8e\u4fee\u6539\u64cd\u4f5c\uff0c\u53ef\u4ee5\u4eff\u7167\u666e\u901a\u5e26\u4fee\u6539\u83ab\u961f\uff0c\u589e\u52a0\u4e00\u7ef4\u65f6\u95f4\u6233\uff0c\u8bb0\u5f55\u6bcf\u6b21\u67e5\u8be2\u64cd\u4f5c\u5728\u7b2c\u51e0\u6b21\u4fee\u6539\u64cd\u4f5c\u4e4b\u540e\u4ee5\u53ca\u5f53\u524d\u5e8f\u5217\u662f\u7b2c\u51e0\u6b21\u4fee\u6539\u64cd\u4f5c\u4e4b\u540e\u7684\u3002\u5f53\u5e8f\u5217\u7684\u65f6\u95f4\u6233i\u5c0f\u4e8e\u8be2\u95ee\u7684\u65f6\u95f4\u6233j\u65f6\uff0c\u6267\u884cj\u5230i\u7684\u4fee\u6539\u64cd\u4f5c\uff0c\u53cd\u4e4b\uff0c\u8fd8\u539fi\u5230j\u7684\u4fee\u6539\u64cd\u4f5c\u3002\u5982\u679c\u4fee\u6539\u7684\u8282\u70b9\u5728\u8be2\u95ee\u7684\u8282\u70b9\u4e4b\u4e2d\uff0c\u7ef4\u62a4\u76f8\u5e94\u7684\u4fe1\u606f\u3002\n\n# \u4ee3\u7801\n```cpp\n#include<cmath>\n#include<cstdio>\n#include<algorithm>\nusing namespace std;\nconst int maxn=1e6+10;\nint n,m,q,k,cnt,t1,t2,l=1,r,now,block;\nint v[maxn],w[maxn],a[maxn];\nlong long num,ans[maxn];\nstruct node{\n    int to,next;\n}edge[maxn];\nstruct query{\n    int l,r,lca,id,t;\n}que[maxn];\nstruct Change{\n    int pos,color;\n}c[maxn];\nint head[maxn];\nint first[maxn],last[maxn],euler[maxn];\nint fa[maxn],son[maxn],top[maxn],size[maxn],deep[maxn];\nint book[maxn],flag[maxn];\nint read()\n{\n    int x=0;\n    char ch=getchar();\n    while(ch<'0'||ch>'9')\n    ch=getchar();\n    while(ch<='9'&&ch>='0')\n    x=x*10+ch-48,\n    ch=getchar();\n    return x;\n}\nbool cmp(query a,query b)\n{\n    if(a.l/block==b.l/block)\n    return a.r<b.r;\n    else \n    return a.l/block<b.l/block;\n}\nvoid add(int u,int v)\n{\n    edge[++k].to=v;\n    edge[k].next=head[u];\n    head[u]=k;\n}\nvoid dfs1(int u,int f)\n{\n    first[u]=++cnt;\n    euler[cnt]=u;\n    size[u]=1;\n    for(int i=head[u];i;i=edge[i].next)\n    {\n        int v=edge[i].to;\n        if(v!=f)\n        {\n            deep[v]=deep[u]+1;\n            dfs1(v,u);\n            fa[v]=u;\n            size[u]+=size[v];\n            if(size[son[u]]<size[v])\n            son[u]=v; \n        }\n    }\n    last[u]=++cnt;\n    euler[cnt]=u;\n}\nvoid dfs2(int u,int tp)\n{\n    top[u]=tp;\n    if(son[u])\n    dfs2(son[u],tp);\n    for(int i=head[u];i;i=edge[i].next)\n    {\n        int v=edge[i].to;\n        if(v!=fa[u]&&v!=son[u])\n        dfs2(v,v);\n    }\n}\nint lca(int u,int v)\n{\n    while(top[u]!=top[v])\n    {\n        if(deep[top[u]]<deep[top[v]])\n        swap(u,v);\n        u=fa[top[u]];\n    }\n    return deep[u]<deep[v]?u:v;\n}\nvoid update(int pos)\n{\n    if(flag[pos]==0){\n        book[a[pos]]++;\n        num+=(long long)v[a[pos]]*w[book[a[pos]]];\n    }else{\n        book[a[pos]]--;\n        num-=(long long)v[a[pos]]*w[book[a[pos]]+1];\n    }\n    flag[pos]^=1;\n}\nvoid change(int tme)\n{\n    if(flag[c[tme].pos]==1)\n    {\n        book[c[tme].color]++;\n        num+=(long long)v[c[tme].color]*w[book[c[tme].color]];\n        book[a[c[tme].pos]]--;\n        num-=(long long)v[a[c[tme].pos]]*w[book[a[c[tme].pos]]+1];\n    }\n    swap(c[tme].color,a[c[tme].pos]);\n}\nint main(){\n    n=read();m=read();q=read();\n    for(int i=1;i<=m;i++)\n    v[i]=read();\n    for(int i=1;i<=n;i++)\n    w[i]=read();\n    for(int i=1;i<n;i++)\n    {\n        int u=read(),v=read();\n        add(u,v);\n        add(v,u);\n    }\n    for(int i=1;i<=n;i++)\n    a[i]=read();\n    dfs1(1,1);\n    dfs2(1,1);\n    for(int i=1;i<=q;i++)\n    {\n        int opt=read(),x=read(),y=read();\n        if(opt==0){\n            t1++;\n            c[t1].pos=x;\n            c[t1].color=y;\n        }else{\n            t2++;\n            que[t2].t=t1;\n            que[t2].id=t2;\n            que[t2].lca=lca(x,y);\n            if(first[x]>first[y])\n            swap(x,y);\n            if(que[t2].lca==x){\n                que[t2].l=first[x];\n                que[t2].r=first[y];\n                que[t2].lca=0;\n            }else{\n                que[t2].l=last[x];\n                que[t2].r=first[y];\n            }\n        }\n    }\n    block=pow(n,2.0/3);\n    sort(que+1,que+t2+1,cmp);\n    for(int i=1;i<=t2;i++)\n    {\n        while(l<que[i].l)update(euler[l++]);\n        while(l>que[i].l)update(euler[--l]);\n        while(r<que[i].r)update(euler[++r]);\n        while(r>que[i].r)update(euler[r--]);\n        while(now<que[i].t)change(++now);\n        while(now>que[i].t)change(now--);\n        if(que[i].lca)update(que[i].lca);\n        ans[que[i].id]=num;\n        if(que[i].lca)update(que[i].lca);\n    }\n    for(int i=1;i<=t2;i++)\n    printf(\"%lld\\n\",ans[i]);\n    return 0;\n}\n```\n",
        "postTime": 1598328632,
        "uid": 231120,
        "name": "YinyuDream",
        "ccfLevel": 4,
        "title": "\u9898\u89e3 P4074 \u3010[WC2013]\u7cd6\u679c\u516c\u56ed\u3011"
    }
]