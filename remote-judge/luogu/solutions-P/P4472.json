[
    {
        "content": "## \u9898\u76ee\u5927\u610f\n\n\u7ed9\u4e00\u4e2a\u7531 $n\\times m$ \u7684\u5b57\u7b26\u77e9\u9635\u65e0\u9650\u590d\u5236\u5f97\u5230\u7684\u77e9\u9635\u3002\u7b49\u6982\u7387\u968f\u673a\u9009\u62e9\u4e00\u4e2a\u8d77\u70b9\uff0c\u5e76\u7b49\u6982\u7387\u968f\u673a\u9009\u62e9\u4e00\u4e2a\u65b9\u5411\uff08\u4e0a\u3001\u4e0b\u3001\u5de6\u3001\u53f3\u3001\u5de6\u4e0a\u3001\u5de6\u4e0b\u3001\u53f3\u4e0a\u3001\u53f3\u4e0b\uff09\uff0c\u5c06\u8fd9\u4e2a\u65b9\u5411\u4e0a $k$ \u4e2a\u5b57\u7b26\u7ec4\u6210\u4e00\u4e2a\u5b57\u7b26\u4e32\u3002\u8be2\u95ee\u8fd9\u6837\u9009\u51fa\u6765\u7684\u4e24\u4e2a\u5b57\u7b26\u4e32\u76f8\u540c\u7684\u6982\u7387\u3002\n\n$n,m\\le 500; k\\le 10^9$ \u3002\n\n## \u9898\u89e3\n\n\u6211\u4eec\u8bbe $S_{i,j}$ \u8868\u793a\u7b2c $i+1$ \u884c\u7b2c $j+1$ \u5217\u7684\u5b57\u7b26\u3002\u7531\u65e0\u9650\u590d\u5236\u7684\u5b9a\u4e49\u53ef\u4ee5\u5f97\u5230\uff0c $S_{i,j}=S_{i\\bmod n,j\\bmod m}$ \u3002\n\n\u8003\u8651\u8ba1\u7b97\u51fa\u6bcf\u4e2a\u8d77\u70b9\u3001\u6bcf\u4e2a\u65b9\u5411\u4e0a\u7ec4\u6210\u7684\u5b57\u7b26\u4e32\u7684\u54c8\u5e0c\u503c\u3002\u8fd9\u91cc\u6211\u4eec\u91c7\u7528\u5982\u4e0b\u54c8\u5e0c\u65b9\u5f0f\uff1a\n\n$$H(X)=\\sum_{i=0}^{len} X_iP^{len-i-1} \\pmod{2^{64}}$$\n\n\u5176\u4e2d $X$ \u662f\u4e00\u4e2a\u957f\u5ea6\u4e3a $len$ \uff0c\u4e0b\u6807\u8303\u56f4\u662f $[0,len)$ \u7684\u5b57\u7b26\u4e32\u3002\n\n\u5982\u679c\u76f4\u63a5\u66b4\u529b\u8ba1\u7b97\u6240\u6709\u7684\u5b57\u7b26\u4e32\uff0c\u8fd9\u6837\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u662f $\\mathcal O(nmk)$ \uff0c\u663e\u7136\u662f\u4e0d\u884c\u7684\u3002\u4f46\u4e8b\u5b9e\u4e0a\uff0c\u6211\u4eec\u53ef\u4ee5\u627e\u5230 $X$ \u7684\u5faa\u73af\u8282\u3002\u53ef\u4ee5\u8bc1\u660e\uff0c $X$ \u7684\u5faa\u73af\u8282\u957f\u5ea6\u4e0d\u4f1a\u8d85\u8fc7 $nm$ \uff08\u8003\u8651 $X$ \u7684\u4e0b\u6807\u7684\u6a21\u610f\u4e49\uff09\u3002\n\n\u5047\u5b9a\u6709\u4e00\u4e2a\u5faa\u73af\u8282\u662f $\\verb!\"aab\"!$ \u7684\u5b57\u7b26\u4e32\uff0c\u5b83\u7684\u957f\u5ea6\u4e3a $11$ \u3002\n\n$$X=\\verb![(aab)(aab)(aab)aa]!$$\n\n\u6211\u4eec\u53ef\u4ee5\u8ba1\u7b97\u51fa\u5b83\u5faa\u73af\u8282\u7684\u54c8\u5e0c\u503c\uff08\u8bbe\u4e3a $H_0$ \uff0c\u5b83\u7684\u957f\u5ea6\u4e3a $L_0$ \uff09\uff0c\u90a3\u4e48\u5b8c\u6574\u7684\u5faa\u73af\u90e8\u5206\u7684\u54c8\u5e0c\u503c\u5e94\u8be5\u4e3a\uff1a\n\n$$\\begin{aligned}H(\\verb!aabaabaab!)&=H_0\\times \\left(P^3\\right)^2+H_0\\times \\left(P^3\\right)^1+H_0\\times \\left(P^3\\right)^0\\cr\n&=H_0\\left(\\left(P^3\\right)^2+\\left(P^3\\right)^1+\\left(P^3\\right)^0\\right)\n\\end{aligned}$$\n\n\u663e\u7136\uff0c\u62ec\u53f7\u91cc\u7684\u662f\u4e00\u4e2a\u9996\u9879\u4e3a $1$ \uff0c\u516c\u6bd4\u4e3a $P^3$ \u7684\u7b49\u6bd4\u6570\u5217\u3002\u5bf9\u4e8e\u4e00\u4e2a\u7b49\u6bd4\u6570\u5217\uff0c\u6211\u4eec\u6709\u5982\u4e0b\u516c\u5f0f\uff1a\n\n$$q^0+q^1+\\cdots +q^{n-1}=\\frac{q^n-1}{q-1}$$\n\n\u4f46\u662f\u7531\u4e8e\u6a21\u6570\u662f $2^{64}$ \uff0c\u800c $q-1=P^{L_0}-1$ \u662f\u4e0d\u5b58\u5728\u4e58\u6cd5\u9006\u5143\u7684\u3002\u8003\u8651\u4f7f\u7528\u5206\u6cbb\u6cd5\u3002\n\n\u5047\u8bbe\u6211\u4eec\u8981\u8ba1\u7b97 $F(q,n)=q^0+q^1+\\cdots +q^{n-1}$ \uff0c\u90a3\u4e48\u6709\uff1a\n\n$$F(q,n)=\\begin{cases}\n0 & n=0 \\cr\n1 & n=1 \\cr\n(1+q)\\times F(q^2,\\lfloor n\\div2\\rfloor) & n\\equiv 0\\pmod 2 \\cr\n(1+q)\\times F(q^2,\\lfloor n\\div2\\rfloor)\\times q+1 & n\\equiv 1\\pmod 2 \\cr\n\\end{cases}$$\n\n\u8fd9\u4e48\u505a\u7684\u590d\u6742\u5ea6\u662f $\\mathcal O(\\log k)$ \u3002\n\n\u5bf9\u4e8e $H(X)$ \u7684\u540e\u534a\u90e8\u5206\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u66b4\u529b\u3002\u8fd9\u6837\u7684\u590d\u6742\u5ea6\u4e0d\u8d85\u8fc7 $\\mathcal O(L_0)$ \u3002\u4f46\u7531\u4e8e $L_0$ \u53ef\u80fd\u8fbe\u5230 $n\\times m$ \uff0c\u4e8e\u662f\u603b\u590d\u6742\u5ea6\u4e3a $\\mathcal O(n^2m^2)$ \u3002\u663e\u7136\uff0c\u6211\u4eec\u8fd8\u8981\u8fdb\u4e00\u6b65\u4f18\u5316\u3002\n\n\u4e0d\u59a8\u4ee5\u6837\u4f8b\u4e8c\u4e3a\u4f8b\uff1a\n\n$$\\begin{bmatrix}\n\\tt\\color{grey}\\textcolor{black}{b\\ a\\ n}\\ b\\ a\\ n\\ b\\ a\\ n\\ b\\ a\\ n \\cr\n\\tt\\color{grey}\\textcolor{black}{a}\\ \\underlinesegment{\\textcolor{black}{n\\ a}\\ a\\ n\\ a\\ a\\ n\\ a\\ a\\ n}\\ a \\cr\n\\tt\\color{grey}n\\ a\\ b\\ n\\ a\\ b\\ n\\ a\\ b\\ b\\ a\\ n \\cr\n\\tt\\color{grey}b\\ a\\ n\\ b\\ a\\ n\\ b\\ a\\ n\\ a\\ n\\ a \\cr \n\\tt\\color{grey}a\\ n\\ a\\ a\\ n\\ a\\ a\\ n\\ a\\ b\\ a\\ n \\cr\n\\tt\\color{grey}n\\ a\\ b\\ n\\ a\\ b\\ n\\ a\\ b\\ a\\ n\\ a \\cr\n\\end{bmatrix}$$\n\n\u5047\u5982\u6211\u4eec\u5df2\u7ecf\u8ba1\u7b97\u51fa\u4e86 $X_0=\\verb![naanaanaan]!$ \u8fd9\u4e00\u6bb5\u7684\u54c8\u5e0c\u503c\uff0c\u73b0\u5728\u8981\u8ba1\u7b97\u5b83\u53f3\u8fb9\u7684\u4e00\u4e2a\u5b57\u7b26\u4e32 $X_1=\\verb![aanaanaana]!$ \u3002\u6211\u4eec\u80fd\u591f\u53d1\u73b0\uff0c\u5b83\u4eec\u5171\u7528\u4e00\u4e2a\u5faa\u73af\u8282\u3002\u5b83\u7684\u54c8\u5e0c\u503c\u5c31\u662f\u628a $H(X_0)$ \u4e58\u4e0a $P$ \u3001\u51cf\u53bb\u6700\u5de6\u4fa7\u7684\u5b57\u6bcd $\\verb!n!$ \u7684\u8d21\u732e\u3001\u518d\u52a0\u4e0a\u6700\u53f3\u4fa7 $\\verb!a!$ \u7684\u8d21\u732e\u3002\n\n\u4e5f\u5c31\u662f\u8bf4\uff0c\u53ea\u8981\u6211\u4eec\u8ba1\u7b97\u51fa\u4efb\u610f\u4e00\u4e2a\u957f\u5ea6\u4e3a $k$ \u7684\u5b57\u7b26\u4e32\u7684\u54c8\u5e0c\u503c\uff0c\u5c31\u80fd $\\mathcal O(\\log k)$ \u8f6c\u79fb\u5230\u5c06\u5b83\u5411\u53f3\u79fb\u52a8\u4e00\u4f4d\u7684\u5b57\u7b26\u4e32\u7684\u54c8\u5e0c\u503c\u3002\u4f46\u4e8b\u5b9e\u4e0a\uff0c\u6211\u4eec\u53ef\u4ee5\u9884\u5904\u7406 $P^k$ \uff0c\u90a3\u4e48\u5355\u6b21\u8f6c\u79fb\u7684\u590d\u6742\u5ea6\u5c31\u964d\u4e3a\u4e86 $\\mathcal O(1)$ \u3002\n\n\u8ba1\u7b97\u4e00\u4e2a\u957f\u5ea6\u4e3a $k$ \u7684\u5b57\u7b26\u4e32\u7684\u54c8\u5e0c\u503c\u7684\u590d\u6742\u5ea6\u662f $\\mathcal O(L_0\\log  k)$ \uff0c\u6211\u4eec\u518d\u82b1\u8d39 $\\mathcal O(L_0)$ \u7684\u590d\u6742\u5ea6\u5c06\u5171\u7528\u8fd9\u4e2a\u5faa\u73af\u8282\u7684\u5176\u4ed6\u7684\u957f\u5ea6\u4e3a $k$ \u7684\u5b57\u7b26\u4e32\u7684\u54c8\u5e0c\u503c\u6c42\u51fa\u6765\u3002\u4e8e\u662f\u5e73\u5747\u6bcf\u4e2a\u5b57\u7b26\u4e32\u7684\u590d\u6742\u5ea6\u662f $\\mathcal O(\\log k)$ \u3002\u53c8\u56e0\u4e3a\u4e00\u5171\u53ea\u6709 $n\\times m\\times 8$ \u4e2a\u9700\u8981\u8ba1\u7b97\u7684\u5b57\u7b26\u4e32\uff0c\u4e8e\u662f\u603b\u590d\u6742\u5ea6\u4e3a $\\mathcal O(nm\\log k)$ \uff0c\u53ef\u4ee5\u901a\u8fc7\u672c\u9898\u3002\n\n\u53e6\u5916\uff0c\u6211\u4eec\u9700\u8981\u5f00\u4e00\u4e2a\u54c8\u5e0c\u8868\u5c06\u54c8\u5e0c\u503c\u76f8\u540c\u7684\u5b57\u7b26\u4e32\u63d2\u5165\u8fdb\u53bb\uff0c\u7136\u540e\u7edf\u8ba1\u76f8\u540c\u54c8\u5e0c\u503c\u7684\u5b57\u7b26\u4e32\u6709\u591a\u5c11\u4e2a\uff0c\u8ba1\u7b97\u51fa\u5171\u6709\u591a\u5c11\u79cd\u9009\u6cd5\u4f7f\u5f97\u4e24\u4e2a\u5b57\u7b26\u4e32\u54c8\u5e0c\u503c\u76f8\u540c\u3002\u9664\u4ee5\u603b\u65b9\u6848\u6570 $n\\times m\\times 8$ \u5c31\u884c\u4e86\u3002\n\n\u5b9e\u6d4b\u8dd1\u7684\u98de\u8d77\uff08\n\n## \u53c2\u8003\u4ee3\u7801\n\n```cpp\n#include<bits/stdc++.h>\n#define up(l,r,i) for(int i=l,END##i=r;i<=END##i;++i)\n#define dn(r,l,i) for(int i=r,END##i=l;i>=END##i;--i)\nusing namespace std;\ntypedef long long i64;\ntypedef unsigned int       u32;\ntypedef unsigned long long u64;\nconst int INF =2147483647;\nint qread(){\n    int w=1,c,ret;\n    while((c=getchar())> '9'||c< '0') w=(c=='-'?-1:1); ret=c-'0';\n    while((c=getchar())>='0'&&c<='9') ret=ret*10+c-'0';\n    return ret*w;\n}\nconst int MAXN=500+3,P=13331;\nchar S[MAXN][MAXN],T[MAXN*MAXN]; u64 h;\nbool vis[MAXN][MAXN]; int n,m,p,s,t; i64 ans1,ans2;\nconst int dir[8][2]={{1,0},{0,1},{-1,0},{0,-1},{1,1},{1,-1},{-1,1},{-1,-1}};\nu64 pwr(u64 a,u64 b){\n    u64 r=1; while(b){if(b&1) r=r*a; a=a*a,b>>=1;} return r;\n}\nconst int SIZ =999997,MAXM=MAXN*MAXN*8;\nint head[SIZ],val[MAXM],nxt[MAXM],tot; u64 ver[MAXM];\nvoid add(int u,u64 v){\n    ver[++tot]=v,nxt[tot]=head[u],val[tot]=1,head[u]=tot;\n}\nvoid inc(u64 h){\n    for(int p=head[h%SIZ];p;p=nxt[p])\n    if(ver[p]==h){ans1+=2ll*val[p]+1,++val[p];return;}\n    add(h%SIZ,h),++ans1;\n}\nu64 calc(u64 a,u64 b){  //calc a^0+a^1+a^2+...+a^(b-1)\n    if(b==0) return 0; if(b==1) return 1;\n    if(b&1) return (1ull+a)*calc(a*a,b>>1)*a+1;\n    else    return (1ull+a)*calc(a*a,b>>1);\n}\nint main(){\n    n=qread(),m=qread(),p=qread(); u64 q=pwr(P,p);\n    up(0,n-1,i) scanf(\"%s\",S[i]);\n    up(0,7,d){\n        up(0,n-1,i) up(0,m-1,j) if(!vis[i][j]){\n            int a=i,b=j; h=0; while(!vis[a][b]){\n                h=h*P+S[a][b],T[t++]=S[a][b],vis[a][b]=true;\n                a=(n+a+dir[d][0])%n,b=(m+b+dir[d][1])%m;\n            }\n            int x=p%t; h*=calc(pwr(P,t),p/t);\n            up(0,x-1,k) h=h*P+T[k];\n            up(0,t-1,k) inc(h),h=h*P+T[(x+k)%t]-T[k]*q;\n            t=0;\n        }\n        up(0,n-1,i) up(0,m-1,j) vis[i][j]=0;\n    }\n    ans2=1ll*n*m*8*(1ll*n*m*8); i64 d=__gcd(ans1,ans2);\n    printf(\"%lld/%lld\\n\",ans1/d,ans2/d);\n    return 0;\n}\n```",
        "postTime": 1611463208,
        "uid": 330759,
        "name": "\u56e7\u4ed9",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P4472 \u3010[BJWC2018]\u516b\u7ef4\u3011"
    }
]