[
    {
        "content": "~~\u7b2c\u4e03\u5206\u5757\u592a\u96be\u4e86\u5c31\u5148\u6765\u5199\u4e00\u4e0b\u8fd9\u4e2a\u3002~~\n\n~~\u7ed3\u679c\u4ea4\u4e86 59 \u53d1\u624d\u8fc7\u2026\u2026~~\n\n\u6709\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684\u505a\u6cd5\uff0c\u5c06\u503c\u57df\u79bb\u6563\u5316\u4e4b\u540e\u5bf9\u503c\u57df\u8fdb\u884c\u83ab\u961f\uff0c\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u6700\u5927\u5b50\u6bb5\u548c\u3002\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n\\sqrt m\\log n)$\u3002\n\n\u8003\u8651\u66f4\u4f18\u7684\u505a\u6cd5\u3002\u5982\u679c\u6211\u4eec\u6709\u4e00\u79cd\u65f6\u95f4\u590d\u6742\u5ea6 $O(n^2)$ \u7684\u505a\u6cd5\u6c42\u51fa\u4e00\u4e2a\u957f\u5ea6\u4e3a $n$ \u7684\u5e8f\u5217\u7684**\u6240\u6709**\u4e0d\u540c\u503c\u57df\u9650\u5236\u4e0b\u7684**\u5168\u5c40**\u6700\u5927\u5b50\u6bb5\u548c\uff0c\u90a3\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u5206\u5757\u5c06\u8fd9\u4e2a\u590d\u6742\u5ea6\u964d\u4e3a $O(n\\sqrt n)$\u3002\n\n\u5173\u4e8e\u6700\u5927\u5b50\u6bb5\u548c\u7684\u95ee\u9898\uff0c\u5206\u6cbb\u662f\u4e00\u4e2a\u5e38\u89c1\u7684\u601d\u8def\u3002\u7531\u4e8e\u957f\u5ea6\u4e3a $n$ \u7684\u5e8f\u5217\uff0c\u53ea\u6709 $O(n^2)$ \u4e2a\u672c\u8d28\u4e0d\u540c\u7684\u503c\u57df\u9650\u5236\uff0c\u6240\u4ee5\u6211\u4eec\u5e0c\u671b\u6bcf\u5c42\u90fd\u80fd $O(n^2)$ \u5408\u5e76\u4fe1\u606f\u3002\u8fd9\u6837\u5206\u6cbb\u7684\u590d\u6742\u5ea6\u4e3a $T(n)=2T(\\frac n 2)+O(n^2)$\u3002\u6839\u636e**\u4e3b\u5b9a\u7406**\u5373\u53ef\u5f97\u5230 $T(n)=O(n^2)$\u3002\n\n\u6211\u4eec\u8003\u8651\u5df2\u77e5\u4e24\u4e2a\u5b50\u533a\u95f4\u7684\u672c\u8d28\u4e0d\u540c\u7684\u503c\u4ee5\u53ca\u9650\u5236\uff0c\u5982\u4f55\u5408\u5e76\u4e3a\u8fd9\u4e00\u5c42\u7684\u7b54\u6848\u3002\u5bf9\u4e8e\u5408\u5e76\u4e0a\u6765\u7684 $[L,R]$\uff0c\u6211\u4eec\u9700\u8981\u5728\u5de6\u3001\u53f3\u5206\u522b\u627e\u5230\u533a\u95f4 $[L_1,R_1]$ \u548c $[L_2,R_2]$\uff0c\u5176\u4e2d $[L_1,R_1]$ \u548c $[L_2,R_2]$ \u90fd\u662f\u88ab $[L,R]$ \u5305\u542b\u7684\u6700\u5927\u533a\u95f4\u3002\u90a3\u4e48\u8fd9\u4e24\u4e2a\u533a\u95f4\u7684\u6700\u5927\u5b50\u6bb5\u548c\u4fe1\u606f\u8fdb\u884c\u5408\u5e76\uff0c\u5373\u53ef\u5f97\u5230 $[L,R]$ \u7684\u6700\u5927\u5b50\u6bb5\u548c\u4fe1\u606f\u3002\n\n\u6211\u4eec\u8003\u8651\u9884\u5904\u7406\u5bf9\u6bcf\u4e2a $L$\uff0c\u5de6\u3001\u53f3\u533a\u95f4\u7b2c\u4e00\u4e2a\u5927\u4e8e\u7b49\u4e8e $L$ \u7684\u503c\u3002\u540c\u6837\uff0c\u5bf9\u4e8e $R$\uff0c\u9884\u5904\u7406\u5de6\u3001\u53f3\u533a\u95f4\u7b2c\u4e00\u4e2a\u5c0f\u4e8e\u7b49\u4e8e $R$ \u7684\u503c\u3002\u7531\u4e8e\u6211\u4eec\u662f\u8981\u9009\u6700\u5927\u7684\u4e24\u4e2a\u533a\u95f4\u5408\u5e76\uff0c\u90a3\u4e48\u4e24\u4e2a\u7aef\u70b9\u548c $L,R$ \u6700\u63a5\u8fd1\u7684\u4e00\u5b9a\u662f\u6700\u5927\u7684\u3002\u8fd9\u6837\u5c31\u53ef\u4ee5\u76f4\u63a5 $O(n^2)$ \u679a\u4e3e $L,R$\uff0c\u7136\u540e $O(1)$ \u627e\u5230\u4e24\u4e2a\u9700\u8981\u5408\u5e76\u7684\u533a\u95f4\uff0c\u8fdb\u884c\u5408\u5e76\u3002\n\n\u5206\u6cbb\u7684\u65f6\u7a7a\u590d\u6742\u5ea6\u5747\u4e3a $O(n^2)$\uff0c\u8003\u8651\u5bf9\u5e8f\u5217\u5206\u5757\uff0c\u6bcf\u4e2a\u5757\u7684\u5927\u5c0f\u4e3a $O(\\sqrt n)$\uff0c\u5219\u5bf9\u6bcf\u4e2a\u5757\u8fdb\u884c\u5206\u6cbb\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n)$\u3002\u5206\u6cbb\u82b1\u8d39\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n\\sqrt n)$\u3002\n\n\u5bf9\u4e8e\u4e00\u4e2a\u8be2\u95ee\uff0c\u62c6\u6210\u6574\u5757\u7684\u548c\u8fb9\u89d2\u7684\u3002\u5bf9\u4e8e\u8fb9\u754c\u7684\u663e\u7136\u53ef\u4ee5 $O(\\sqrt n)$ \u89e3\u51b3\u3002\u5bf9\u4e8e\u6574\u5757\u7684\uff0c\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\u6240\u6709\u672c\u8d28\u4e0d\u540c\u7684\u503c\u57df\u9650\u5236\u7684\u7b54\u6848\uff0c\u90a3\u4e48\u5bf9\u4e8e\u503c\u57df\u9650\u5236\u4e3a $[L,R]$ \u7684\u8be2\u95ee\uff0c\u6211\u4eec\u8981\u627e\u5230\u88ab\u5b83\u5305\u542b\u7684\u6700\u5927\u7684\u533a\u95f4\u7684\u4fe1\u606f\u3002\u90a3\u4e48\u548c\u4e0a\u9762\u7684\u5904\u7406\u65b9\u5f0f\u76f8\u540c\uff0c\u5bf9\u6bcf\u4e2a $L$ \u548c $R$ \u5206\u522b\u627e\u5230\u6700\u9760\u8fd1\u7684\u7aef\u70b9\u5373\u53ef\u3002\u8fd9\u91cc\u4e3a\u4e86\u4fdd\u8bc1\u590d\u6742\u5ea6\uff0c\u5fc5\u987b\u7528\u53cc\u6307\u9488\u5904\u7406\uff0c\u5426\u5219\u65f6\u95f4\u590d\u6742\u5ea6\u5c06\u9000\u5316\u4e3a $O(m\\sqrt n\\log n)$\u3002\n\n\u7531\u4e8e\u76f4\u63a5\u5b58\u50a8\u6240\u6709\u5757\u7684\u4fe1\u606f\u9700\u8981 $O(n\\sqrt n)$ \u7684\u7a7a\u95f4\uff0c\u65e0\u6cd5\u63a5\u53d7\u3002\u6240\u4ee5\u6211\u4eec\u5bf9\u8be2\u95ee\u79bb\u7ebf\uff0c\u5728\u4e00\u4e2a\u5757\u7684\u4fe1\u606f\u5904\u7406\u5b8c\u540e\uff0c\u76f4\u63a5\u628a\u8fd9\u4e2a\u5757\u5bf9\u6240\u6709\u8be2\u95ee\u7684\u8d21\u732e\u90fd\u66f4\u65b0\u6389\u3002\u8fd9\u6837\u7a7a\u95f4\u590d\u6742\u5ea6\u4e3a $O(n)$\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O((n+m)\\sqrt n)$\u3002\n\n\u6ce8\u610f\u5b9e\u73b0\u65f6\u7684\u5e38\u6570\u3002",
        "postTime": 1582166862,
        "uid": 6813,
        "name": "mrsrz",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P5611 \u3010[Ynoi2013]D2T2\u3011"
    },
    {
        "content": "\u8fd9\u9053\u9898\u672c\u8eab\u5f88\u597d\uff0c\u4f46\u662f\u4e0d\u5efa\u8bae\u5199\u3002\u5361\u5e38\u771f\u7684\u5f88\u6d6a\u8d39\u751f\u547d\u2014\u2014\u6211\u82b1\u4e86 5h+ \u7684\u65f6\u95f4\u5728\u5361\u5e38\u4e0a\u3002\n\n~~\u4ea4\u4e86\u6574\u6574 $99$ \u53d1\u624d\u5361\u8fc7\u7684\u5c51\u3002~~\n\n------------\n\n\u5f53 $l = 1, r = n$\uff08\u5373\u6bcf\u6b21\u5747\u4e3a\u5168\u5c40\u8be2\u95ee\uff09\uff0c\u8003\u8651\u4e00\u4e2a\u66b4\u529b\u7684\u60f3\u6cd5\uff1a\u6211\u4eec\u901a\u8fc7\u67d0\u79cd\u65b9\u5f0f\u9884\u5904\u7406\u51fa $L \\leq R$ \u7684\u7b54\u6848\uff08\u5176\u4e2d $L, R$ \u5728 $a$ \u4e2d\u51fa\u73b0\u8fc7\uff09\uff0c\u8be2\u95ee\u65f6\u4e8c\u5206\u51fa\u79bb\u6563\u5316\u6570\u7ec4\u4e2d\u5408\u9002\u7684 $L, R$ \u5e76\u8f93\u51fa\u7b54\u6848\u5373\u53ef\u3002\n\n\u8003\u8651\u5982\u4f55\u6267\u884c\u8fd9\u4e2a\u9884\u5904\u7406\u7684\u64cd\u4f5c\u3002\u6ce8\u610f\u5230\u6700\u5927\u5b50\u6bb5\u548c\u662f\u53ef\u5408\u5e76\u7684\uff0c\u8003\u8651\u5206\u6cbb\u3002\n\n\u8bbe\u6211\u4eec\u6b63\u5728\u5904\u7406\u5f53\u524d\u5206\u6cbb\u533a\u95f4\u7684 $[L, R]$ \u7684\u7b54\u6848\uff0c\u6211\u4eec\u4ece\u5de6\u53f3\u533a\u95f4\u5206\u522b\u627e\u51fa\u6781\u5927\u4e14\u5305\u542b\u4e8e $[L, R]$ \u7684\u4e24\u4e2a\u533a\u95f4\uff08\u6ca1\u6709\u5c31\u4e3a\u7a7a\uff09\uff0c\u5c06\u8fd9\u4e24\u4e2a\u533a\u95f4\u8fdb\u884c\u5408\u5e76\u3002\n\n\u53cc\u6307\u9488\u5373\u53ef\u3002\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $T(n) = T(\\frac{n}{2}) + O(n^2)$\uff0c\u89e3\u5f97 $T(n) = O(n^2)$\u3002\n\n\u6ce8\u610f\u5230\u5f53\u5206\u6cbb\u533a\u95f4\u8f83\u5c0f\u65f6\u65f6\u95f4\u590d\u6742\u5ea6\u53ef\u4ee5\u63a5\u53d7\uff0c\u8003\u8651\u5206\u5757\uff0c\u8bbe\u5757\u957f\u4e3a $S$\u3002\u6211\u4eec\u5bf9\u6bcf\u4e2a\u5757\u8fdb\u884c\u4e0a\u8ff0\u5206\u6cbb\u9884\u5904\u7406\uff0c\u56de\u7b54\u8be2\u95ee\u65f6\u5bf9\u8fb9\u89d2\u5757\u66b4\u529b\u3001\u5bf9\u6574\u5757\u5408\u5e76\uff08\u6ce8\u610f\u8fd9\u91cc\u8981\u53cc\u6307\u9488\u6c42\u79bb\u6563\u5316\u7aef\u70b9\uff0c\u8981\u4e0d\u7136\u4f1a\u591a\u4e2a $\\log$\uff09\u5373\u53ef\u3002\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(\\frac{n^2}{S} + m(S + \\frac{n}{S}))$\uff0c\u5f53 $S = \\sqrt{n}$ \u53d6\u6700\u4f18\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O((n + m) \\sqrt{n})$\u3002\n\n\u9700\u8981\u9010\u5757\u5904\u7406\u548c~~\u4e00\u4e9b~~\u5927\u91cf\u5e38\u6570\u4f18\u5316\u3002\n\n\u4ee3\u7801\uff1a\n```cpp\n#include <algorithm>\n#include <cstdio>\n\nnamespace Fread {\n\tconst int BUFFER_SIZE = 1 << 23;\n\tchar buffer[BUFFER_SIZE + 7];\n\tchar *pstart = buffer, *pend = buffer;\n\t\n\tinline char getchar(){\n\t\tif (pstart < pend) return *pstart++;\n\t\tpstart = buffer;\n\t\tpend = buffer + fread(buffer, 1, BUFFER_SIZE, stdin);\n\t\treturn pstart == pend ? EOF : *pstart++;\n\t}\n\t\n\tinline int read(){\n\t\tint sign = 1, ans = 0;\n\t\tchar ch = getchar();\n\t\twhile (ch < '0' || ch > '9'){\n\t\t\tif (ch == '-') sign = -sign;\n\t\t\tch = getchar();\n\t\t}\n\t\twhile (ch >= '0' && ch <= '9'){\n\t\t\tans = ans * 10 + (ch ^ 48);\n\t\t\tch = getchar();\n\t\t}\n\t\treturn sign * ans;\n\t}\n}\n\ntypedef long long ll;\n\nnamespace Fwrite {\n\tconst int BUFFER_SIZE = 1 << 22, N = 15 + 7;\n\tchar buffer[BUFFER_SIZE + 7], temp[N];\n\tchar *p = buffer;\n\t\n\tinline void flush(){\n\t\tfwrite(buffer, p - buffer, 1, stdout);\n\t\tp = buffer;\n\t}\n\t\n\tinline void putchar(char ch){\n\t\tif (p - buffer >= BUFFER_SIZE) flush();\n\t\t*p++ = ch;\n\t}\n\t\n\tinline void write(ll x){\n\t\tint top = 0;\n\t\tdo {\n\t\t\ttemp[top++] = x % 10 + '0';\n\t\t\tx /= 10;\n\t\t} while (x > 0);\n\t\twhile (top-- > 0) putchar(temp[top]);\n\t}\n}\n\nusing namespace std;\n\ntypedef struct Info_tag {\n\tll sum;\n\tll lmax;\n\tll rmax;\n\tll max;\n\t\n\tInfo_tag(){}\n\t\n\tInfo_tag(ll sum_, ll lmax_, ll rmax_, ll max_){\n\t\tsum = sum_;\n\t\tlmax = lmax_;\n\t\trmax = rmax_;\n\t\tmax = max_;\n\t}\n\t\n\tinline void clear(){\n\t\tsum = lmax = rmax = max = 0;\n\t}\n} Info;\n\nconst int block = 246;\nint belong[100007], lft[417], rt[417], a[100007], l[100007], r[100007], L[100007], R[100007], l_[100007], r_[100007], p1[100007], p2[100007], save[257], orderl[257], orderr[257], geq1[257], geq2[257], leq1[257], leq2[257], geq3[200007], leq3[200007], temp1[207];\nInfo a_[100007], info[257][257], temp2[257][257], ans[100007];\n\ninline void operator +=(Info &a, const Info b){\n\ta.max = max(a.max, max(a.rmax + b.lmax, b.max));\n\ta.lmax = max(a.lmax, a.sum + b.lmax);\n\ta.rmax = max(b.rmax, b.sum + a.rmax);\n\ta.sum += b.sum;\n}\n\nbool cmp1(const int a, const int b){\n\treturn L[a] < L[b];\n}\n\nbool cmp2(const int a, const int b){\n\treturn R[a] > R[b];\n}\n\ninline bool check(int x, int l, int r){\n\treturn l < x && x < r;\n}\n\ninline Info get_info(int l, int r, int L, int R){\n\tInfo ans;\n\tans.clear();\n\tfor (register int i = l; i <= r; i++){\n\t\tif (L <= a[i] && a[i] <= R){\n\t\t\tans.sum += a[i];\n\t\t\tif (ans.lmax < ans.sum) ans.lmax = ans.sum;\n\t\t\tans.rmax += a[i];\n\t\t\tif (ans.rmax < 0){\n\t\t\t\tans.rmax = 0;\n\t\t\t} else if (ans.max < ans.rmax){\n\t\t\t\tans.max = ans.rmax;\n\t\t\t}\n\t\t}\n\t}\n\treturn ans;\n}\n\nvoid solve(int x, int l, int r){\n\tif (l == r) return;\n\tint mid = (l + r) >> 1;\n\tregister int i = l, j = mid + 1, k = l;\n\tsolve(x * 2, l, mid);\n\tsolve(x * 2 + 1, mid + 1, r);\n\tfor (; i <= mid && j <= r; k++){\n\t\tif (save[i] < save[j]){\n\t\t\ttemp1[k] = save[i];\n\t\t\torderl[i++] = k;\n\t\t} else {\n\t\t\ttemp1[k] = save[j];\n\t\t\torderr[j++] = k;\n\t\t}\n\t}\n\twhile (i <= mid){\n\t\ttemp1[k] = save[i];\n\t\torderl[i] = k;\n\t\ti++;\n\t\tk++;\n\t}\n\twhile (j <= r){\n\t\ttemp1[k] = save[j];\n\t\torderr[j] = k;\n\t\tj++;\n\t\tk++;\n\t}\n\tfor (i = l; i <= r; i++){\n\t\tsave[i] = temp1[i];\n\t}\n\tfor (i = l, j = l, k = mid + 1; i <= r; i++){\n\t\twhile (j < mid && orderl[j] < i) j++;\n\t\twhile (k < r && orderr[k] < i) k++;\n\t\tgeq1[i] = j;\n\t\tgeq2[i] = k;\n\t\tif (orderl[j] <= i || j == l){\n\t\t\tleq1[i] = j;\n\t\t} else {\n\t\t\tleq1[i] = j - 1;\n\t\t}\n\t\tif (orderr[k] <= i || k == mid + 1){\n\t\t\tleq2[i] = k;\n\t\t} else {\n\t\t\tleq2[i] = k - 1;\n\t\t}\n\t}\n\tfor (i = l; i <= r; i++){\n\t\tfor (j = i; j <= r; j++){\n\t\t\tif (orderl[geq1[i]] < i || orderl[leq1[j]] > j){\n\t\t\t\ttemp2[i][j].clear();\n\t\t\t} else {\n\t\t\t\ttemp2[i][j] = info[geq1[i]][leq1[j]];\n\t\t\t}\n\t\t\tif (orderr[geq2[i]] >= i && orderr[leq2[j]] <= j) temp2[i][j] += info[geq2[i]][leq2[j]];\n\t\t}\n\t}\n\tfor (i = l; i <= r; i++){\n\t\tfor (j = i; j <= r; j++){\n\t\t\tinfo[i][j] = temp2[i][j];\n\t\t}\n\t}\n}\n\nint main(){\n\tint n = Fread::read(), m = Fread::read(), k = (n - 1) / block + 1;\n\tfor (register int i = 1; i <= n; i++){\n\t\tbelong[i] = (i - 1) / block + 1;\n\t}\n\tbelong[n + 1] = 0x7fffffff;\n\tfor (register int i = 1; i <= k; i++){\n\t\tlft[i] = block * (i - 1) + 1;\n\t\trt[i] = min(i * block, n);\n\t}\n\tfor (register int i = 1; i <= n; i++){\n\t\tint t;\n\t\ta[i] = Fread::read();\n\t\tt = max(a[i], 0);\n\t\ta_[i] = Info(a[i], t, t, t);\n\t}\n\tfor (register int i = 1; i <= m; i++){\n\t\tl[i] = Fread::read();\n\t\tr[i] = Fread::read();\n\t\tL[i] = Fread::read();\n\t\tR[i] = Fread::read();\n\t\tl_[i] = belong[l[i] - 1];\n\t\tr_[i] = belong[r[i] + 1];\n\t\tp1[i] = p2[i] = i;\n\t}\n\tsort(p1 + 1, p1 + m + 1, cmp1);\n\tsort(p2 + 1, p2 + m + 1, cmp2);\n\tfor (register int i = 1; i <= m; i++){\n\t\tif (!check(belong[l[i]], l_[i], r_[i])){\n\t\t\tif (belong[l[i]] == belong[r[i]]){\n\t\t\t\tans[i] = get_info(l[i], r[i], L[i], R[i]);\n\t\t\t} else {\n\t\t\t\tans[i] = get_info(l[i], rt[belong[l[i]]], L[i], R[i]);\n\t\t\t}\n\t\t}\n\t}\n\tfor (register int i = 1; i <= k; i++){\n\t\tint len = rt[i] - lft[i] + 1;\n\t\tfor (register int j = 1; j <= len; j++){\n\t\t\tint t = j + lft[i] - 1;\n\t\t\tsave[j] = a[t];\n\t\t\tinfo[j][j] = a_[t];\n\t\t}\n\t\tsolve(1, 1, len);\n\t\tsave[0] = 0x80000000;\n\t\tsave[len + 1] = 0x7fffffff;\n\t\tfor (register int j = 1, k = 1; j <= m; j++){\n\t\t\tint x = p1[j];\n\t\t\twhile (save[k] < L[x]) k++;\n\t\t\tgeq3[x] = k;\n\t\t}\n\t\tfor (register int j = 1, k = len; j <= m; j++){\n\t\t\tint x = p2[j];\n\t\t\twhile (save[k] > R[x]) k--;\n\t\t\tleq3[x] = k;\n\t\t}\n\t\tfor (register int j = 1; j <= m; j++){\n\t\t\tif (check(i, l_[j], r_[j]) && geq3[j] <= leq3[j]) ans[j] += info[geq3[j]][leq3[j]];\n\t\t}\n\t}\n\tfor (register int i = 1; i <= m; i++){\n\t\tif (belong[l[i]] != belong[r[i]] && !check(belong[r[i]], l_[i], r_[i])) ans[i] += get_info(lft[belong[r[i]]], r[i], L[i], R[i]);\n\t\tFwrite::write(ans[i].max);\n\t\tFwrite::putchar('\\n');\n\t}\n\tFwrite::flush();\n\treturn 0;\n}\n```",
        "postTime": 1675784574,
        "uid": 201007,
        "name": "Leasier",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P5611 \u3010[Ynoi2013] D2T2\u3011"
    },
    {
        "content": "[[Ynoi2013] D2T2](/problem/P5611) \u662f\u6211\u7684\u7b2c\u4e8c\u9053\u9ed1 Ynoi\uff0c\u4ece\u5361\u7a7a\u95f4\u53d8\u6210\u4e86\u5361\u65f6\u95f4\u3002\n\n\u5e8f\u5217\u4e0a\u76f4\u63a5\u505a\u600e\u4e48\u4e5f\u60f3\u4e0d\u5230\u65b9\u6cd5\uff0c\u5bf9\u503c\u57df\u83ab\u961f\u53ef\u4ee5\u505a\u5230 $O(n\\sqrt{q}\\log_2n)$\uff0c\u663e\u7136\u8fc7\u4e0d\u53bb\u3002\n\n\u5bf9\u4e8e\u4e00\u4e2a\u957f\u5ea6\u4e3a $n$ \u7684\u533a\u95f4\u672c\u8d28\u4e0d\u540c\u503c\u57df\u4e2a\u6570\u53ea\u6709\u4e0d\u5230 $n^2$ \u4e2a\uff0c\u5c06\u5b83\u4eec\u5168\u90e8\u5904\u7406\u51fa\u6765\uff0c\u53ef\u4ee5\u4f7f\u7528\u5206\u6cbb\uff0c\u5148\u6c42\u51fa\u5de6\u534a\u548c\u53f3\u534a\u7684\u5404 $\\frac{n^2}{4}$ \u4e2a\u7b54\u6848\uff0c\u518d\u5c06\u7b54\u6848\u5408\u5e76\uff0c\u53cc\u6307\u9488\u5c31\u53ef\u4ee5 $O(n^2)$ \u89e3\u51b3\uff0c\u65f6\u7a7a\u590d\u6742\u5ea6 $T(n)=O(n^2)+2T(\\frac{n}{2})=O(n^2)$\u3002\n\n\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u8be2\u95ee\u53cc\u6307\u9488\u5c31\u53ef\u4ee5 $O(n+q)$ \u5f97\u5230\u6bcf\u4e00\u4e2a\u8be2\u95ee\u7684\u7b54\u6848\uff0c\u4f46\u662f $O(n^2+n+q)$ \u80af\u5b9a\u8fc7\u4e0d\u4e86\u3002\n\n\u53d1\u73b0 $n^2$ \u4e0e $n+q$ \u5e76\u4e0d\u5e73\u8861\uff0c\u6211\u4eec\u9700\u8981\u901a\u8fc7\u5206\u5757\u6765\u8ba9\u5b83\u4eec\u5e73\u8861\uff0c\u5177\u4f53\u6765\u8bf4\uff0c\u5c06\u539f\u5e8f\u5217\u5206\u6210 $\\sqrt n\\times\\sqrt n$ \u7684\u533a\u95f4\uff0c\u6bcf\u4e00\u4e2a\u533a\u95f4\u5355\u72ec\u5206\u6cbb\uff0c\u590d\u6742\u5ea6\u4e3a $O(n)$\uff0c\u8fd9\u6837\u5355\u5757\u590d\u6742\u5ea6\u4e3a $O(n+\\sqrt n+q)$\uff0c\u6563\u5757\u66b4\u529b\u590d\u6742\u5ea6\u662f $O(q\\sqrt n)$\uff0c\u603b\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(\\sqrt n(n+\\sqrt n+q)+q\\sqrt n)=O((n+q)\\sqrt n)$\uff0c\u7a7a\u95f4 $O(n+q)$\uff0c\u4ee3\u7801\u5f88\u597d\u5199\uff1a\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nusing ll=long long;\nconst int N=105005;\nnamespace fast_io{\n    char bf[N+5],ob[N+38];\n    int it,ed,x,f,c,ot,t,stk[38];\n#define gc (it==ed&&(ed=(it=0)+fread(bf,1,N,stdin),it==ed))?EOF:bf[it++]\n    inline int read(){\n        for(c=gc,f=0;c<48;c=gc)if(c=='-')f=!f;\n        for(x=0;c>47;x=x*10+(48^c),c=gc);if(f)x=-x;\n        return x;\n    }inline void fls(){\n        fwrite(ob,1,ot,stdout),ot=0;\n    }\n    void wt(ll x){\n        if(x>9)wt(x/10);\n        ob[ot++]=48^(x%10);\n    }\n    inline void write(ll x){\n        if(x>9)wt(x/10);ob[ot++]=48^(x%10);\n        ob[ot++]='\\n';if(ot>N)fls();\n    }\n}using fast_io::read;\nusing fast_io::write;\nint a[N],n,m,mp[N<<1],mt,ff[719];\nstruct Q{int l,r,L,R,id;}q[N];\nstruct anstp{\n    ll l,m,r,sm;\n    inline void operator+=(const anstp &z){\n        m=max({m,z.m,r+z.l});\n        l=max(l,sm+z.l),r=max(r+z.sm,z.r);\n        sm=sm+z.sm;\n    }inline void operator|=(const int &p){\n        l=m=r=p>0?p:0;sm=p;\n    }\n}ans[N];\nusing V=vector<anstp>;\nvector<V>f[719];\nvector<int>d[719];\nint b[N],sz,l_[N<<1],r_[N<<1];\ninline int solve(int x,int l,int r){\n    if(l==r){\n        d[x][0]=a[l],f[x][0][0]|=a[l];\n        return 1;\n    }int i,md=l+r>>1,ls=x<<1,rs=ls|1,t;\n    int lz=solve(ls,l,md),rz=solve(rs,md+1,r);\n    merge(&d[ls][0],&d[ls][lz],&d[rs][0],&d[rs][rz],b);\n    sz=unique(b,b+lz+rz)-b;\n    for(i=t=0;i<sz;++i){\n        while(t<lz&&d[ls][t]<b[i])++t;\n        l_[i]=t;\n    }for(i=sz-1,t=lz-1;~i;--i){\n        while(t>=0&&d[ls][t]>b[i])--t;\n        r_[i]=t;\n    }for(l=0;l<sz;++l)\n        for(r=l;r<sz;++r)\n            if(l_[l]<lz&&r_[r]>-1)f[x][l][r]=f[ls][l_[l]][r_[r]];\n            else f[x][l][r]={0};\n    for(i=t=0;i<sz;++i){\n        while(t<rz&&d[rs][t]<b[i])++t;\n        l_[i]=t;\n    }for(i=sz-1,t=rz-1;~i;--i){\n        while(t>=0&&d[rs][t]>b[i])--t;\n        r_[i]=t;\n    }for(l=0;l<sz;++l)\n        for(r=l;r<sz;++r)\n            if(l_[l]<rz&&r_[r]>-1)\n                f[x][l][r]+=f[rs][l_[l]][r_[r]];\n    for(i=0;i<sz;++i)d[x][i]=b[i];return sz;\n}\nint main(){\n    int i,l,r,t,sz,_l,_r,j;\n    for(l=2,ff[1]=256;l<=511;++l)ff[l]=ff[l>>1]>>1;\n    for(l=1;l<=511;++l){\n        d[l].resize(ff[l]),f[l].resize(ff[l]);\n        for(i=0;i<ff[l];++i)f[l][i].resize(ff[l]);\n    }\n    for(i=1,n=read(),m=read();i<=n;++i)a[i]=read();\n    for(i=1;i<=m;++i){\n        q[i]={read(),read(),read(),read(),i};\n        mp[++mt]=q[i].L,mp[++mt]=q[i].R;\n    }sort(mp+1,mp+mt+1),mt=unique(mp+1,mp+mt+1)-mp-1;\n    for(i=1;i<=m;++i){\n        q[i].L=lower_bound(mp+1,mp+mt+1,q[i].L)-mp;\n        q[i].R=lower_bound(mp+1,mp+mt+1,q[i].R)-mp;\n    }\n    int i1,i2,i3,i4,i5,i6,i7,i8;\n    for(l=1;l<=n;l=r+1){\n        r=l+255,sz=solve(1,l,r);\n        for(i=1,t=0;i<=mt;++i){\n            while(t<sz&&d[1][t]<mp[i])++t;\n            l_[i]=t;\n        }for(i=mt,t=sz-1;i;--i){\n            while(t>=0&&d[1][t]>mp[i])--t;\n            r_[i]=t;\n        }for(i=1;i<=m;i=i8+1){\n            i1=i,i2=i1+1,i3=i2+1,i4=i3+1;\n            i5=i4+1,i6=i5+1,i7=i6+1,i8=i7+1;\n            if(q[i1].l<=l&&q[i1].r>=r){\n                if(l_[q[i1].L]<sz&&r_[q[i1].R]>-1)\n                    ans[i1]+=f[1][l_[q[i1].L]][r_[q[i1].R]];  \n            }else if(q[i1].l<=r&&q[i1].r>=l){\n                _l=max(q[i1].l,l),_r=min(q[i1].r,r);\n                for(j=_l;j<=_r;++j)\n                    if(a[j]>=mp[q[i1].L]&&a[j]<=mp[q[i1].R])\n                        ans[0]|=a[j],ans[i1]+=ans[0];\n            }\n            if(q[i2].l<=l&&q[i2].r>=r){\n                if(l_[q[i2].L]<sz&&r_[q[i2].R]>-1)\n                    ans[i2]+=f[1][l_[q[i2].L]][r_[q[i2].R]];  \n            }else if(q[i2].l<=r&&q[i2].r>=l){\n                _l=max(q[i2].l,l),_r=min(q[i2].r,r);\n                for(j=_l;j<=_r;++j)\n                    if(a[j]>=mp[q[i2].L]&&a[j]<=mp[q[i2].R])\n                        ans[0]|=a[j],ans[i2]+=ans[0];\n            }\n            if(q[i3].l<=l&&q[i3].r>=r){\n                if(l_[q[i3].L]<sz&&r_[q[i3].R]>-1)\n                    ans[i3]+=f[1][l_[q[i3].L]][r_[q[i3].R]];  \n            }else if(q[i3].l<=r&&q[i3].r>=l){\n                _l=max(q[i3].l,l),_r=min(q[i3].r,r);\n                for(j=_l;j<=_r;++j)\n                    if(a[j]>=mp[q[i3].L]&&a[j]<=mp[q[i3].R])\n                        ans[0]|=a[j],ans[i3]+=ans[0];\n            }\n            if(q[i4].l<=l&&q[i4].r>=r){\n                if(l_[q[i4].L]<sz&&r_[q[i4].R]>-1)\n                    ans[i4]+=f[1][l_[q[i4].L]][r_[q[i4].R]];  \n            }else if(q[i4].l<=r&&q[i4].r>=l){\n                _l=max(q[i4].l,l),_r=min(q[i4].r,r);\n                for(j=_l;j<=_r;++j)\n                    if(a[j]>=mp[q[i4].L]&&a[j]<=mp[q[i4].R])\n                        ans[0]|=a[j],ans[i4]+=ans[0];\n            }\n            if(q[i5].l<=l&&q[i5].r>=r){\n                if(l_[q[i5].L]<sz&&r_[q[i5].R]>-1)\n                    ans[i5]+=f[1][l_[q[i5].L]][r_[q[i5].R]];  \n            }else if(q[i5].l<=r&&q[i5].r>=l){\n                _l=max(q[i5].l,l),_r=min(q[i5].r,r);\n                for(j=_l;j<=_r;++j)\n                    if(a[j]>=mp[q[i5].L]&&a[j]<=mp[q[i5].R])\n                        ans[0]|=a[j],ans[i5]+=ans[0];\n            }\n            if(q[i6].l<=l&&q[i6].r>=r){\n                if(l_[q[i6].L]<sz&&r_[q[i6].R]>-1)\n                    ans[i6]+=f[1][l_[q[i6].L]][r_[q[i6].R]];  \n            }else if(q[i6].l<=r&&q[i6].r>=l){\n                _l=max(q[i6].l,l),_r=min(q[i6].r,r);\n                for(j=_l;j<=_r;++j)\n                    if(a[j]>=mp[q[i6].L]&&a[j]<=mp[q[i6].R])\n                        ans[0]|=a[j],ans[i6]+=ans[0];\n            }\n            if(q[i7].l<=l&&q[i7].r>=r){\n                if(l_[q[i7].L]<sz&&r_[q[i7].R]>-1)\n                    ans[i7]+=f[1][l_[q[i7].L]][r_[q[i7].R]];  \n            }else if(q[i7].l<=r&&q[i7].r>=l){\n                _l=max(q[i7].l,l),_r=min(q[i7].r,r);\n                for(j=_l;j<=_r;++j)\n                    if(a[j]>=mp[q[i7].L]&&a[j]<=mp[q[i7].R])\n                        ans[0]|=a[j],ans[i7]+=ans[0];\n            }\n            if(q[i8].l<=l&&q[i8].r>=r){\n                if(l_[q[i8].L]<sz&&r_[q[i8].R]>-1)\n                    ans[i8]+=f[1][l_[q[i8].L]][r_[q[i8].R]];  \n            }else if(q[i8].l<=r&&q[i8].r>=l){\n                _l=max(q[i8].l,l),_r=min(q[i8].r,r);\n                for(j=_l;j<=_r;++j)\n                    if(a[j]>=mp[q[i8].L]&&a[j]<=mp[q[i8].R])\n                        ans[0]|=a[j],ans[i8]+=ans[0];\n            }\n        }\n    }for(i=1;i<=m;++i)write(ans[i].m);\n    fast_io::fls();return 0;\n}\n```\n\u8fd9\u4e2a\u5199\u6cd5\u592a\u4e11\u4e86\uff0c\u5361\u4e86\u4e00\u7248\uff0c\u6bcf\u4e00\u6b21\u603b\u6709\u51e0\u4e2a\u6d4b\u8bd5\u70b9\u6709 $\\text{760ms}$\uff0c\u8fd9\u65f6\uff0c\u5e38\u6570\u7684\u4f18\u5316\u81f3\u5173\u91cd\u8981\u3002\n\n\u5728\u5c06\u5757\u5408\u5e76\u65f6\uff0c\u5bf9\u8fb9\u754c\u7684\u7279\u5224\u6d6a\u8d39\u4e86\u5f88\u591a\u65f6\u95f4\uff0c\u53ef\u4ee5\u901a\u8fc7\u5728\u6bcf\u4e00\u4e2a\u79bb\u6563\u5316\u6570\u7ec4\u7684\u672b\u5c3e\u6dfb\u52a0\u4e00\u4e2a $2e9$ \u6765\u907f\u514d\u3002\n\n\u5c06\u95ed\u533a\u95f4\u6539\u4e3a\u534a\u95ed\u534a\u5f00\u533a\u95f4\uff0c\u8fd9\u6837\u5c31\u53ea\u9700\u8981\u5904\u7406 $\\ge l$ \u548c $\\ge r$ \u7684\u7b2c\u4e00\u4e2a\u6570\uff0c\u5c31\u53ef\u4ee5\u5f97\u5230\u5305\u542b\u7684\u6700\u5927\u533a\u95f4\u4e86\uff0c\u5e38\u6570\u51cf\u5c0f\u4e86\u4e00\u534a\uff0c\u53ef\u4ee5\u901a\u8fc7\uff1a\n```cpp\ninline int solve(int x,int l,int r){\n    if(l==r){\n        d[x][0]=a[l],d[x][1]=2e9;\n        f[x][0][1]|=a[l];\n        f[x][0][0]=f[x][1][1]={0};\n        return 2;\n    }int i,md=l+r>>1,ls=x<<1,rs=ls|1,tl,tr;\n    int lz=solve(ls,l,md),rz=solve(rs,md+1,r);\n    merge(&d[ls][0],&d[ls][lz],&d[rs][0],&d[rs][rz],b);\n    sz=unique(b,b+lz+rz)-b;\n    for(i=tl=tr=0;i<sz;++i){\n        while(d[ls][tl]<b[i])++tl;l_[i]=tl;\n        while(d[rs][tr]<b[i])++tr;r_[i]=tr;\n    }\n    for(l=0;l<sz;++l)\n        for(r=l;r<sz;++r)\n            f[x][l][r]=f[ls][l_[l]][l_[r]]+f[rs][r_[l]][r_[r]];\n    for(i=0;i<sz;++i)d[x][i]=b[i];return sz;\n}\n```",
        "postTime": 1664090841,
        "uid": 502410,
        "name": "EnofTaiPeople",
        "ccfLevel": 0,
        "title": "\u5206\u5757\u5206\u6cbb\u5361\u5e38"
    }
]