[
    {
        "content": "\u8003\u8651\u5728 $u$ \u8282\u70b9\u5355\u70b9\u4fee\u6539\uff0c\u5bf9\u4e8e\u7b54\u6848\u6570\u7ec4 $a_l$ \u5904\u7684\u8d21\u732e\uff0c\u5373\u8be5\u8282\u70b9\u6709\u591a\u5c11\u6761\u957f\u5ea6\u4e3a $x$ \u7684\u8def\u5f84\u7a7f\u8fc7\u5b83\u3002\u53ef\u4ee5\u8003\u8651\u8fd9\u4e00\u6761\u8def\u5f84\u7684\u6700\u5de6\u7aef\u70b9\u4f4d\u7f6e\u53d6\u503c\u8303\u56f4\u3002\n\n\u6700\u5de6\u53ef\u4ee5\u53d6\u5230 $\\max(1,u-x+1)$ \uff0c\u800c\u6700\u53f3\u53ef\u4ee5\u53d6\u5230 $\\min(u,n-x+1)$ \uff0c\u6545\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u662f $\\min(u, n - x + 1)$ - $\\max(1, u - x + 1) + 1$ \u3002\n\n\u8fd9\u4e2a\u4e1c\u897f\u753b\u51fa\u5173\u4e8e $l$ \u7684\u51fd\u6570\u56fe\u50cf\u5e94\u8be5\u662f\u4e00\u4e2a\u4e09\u6bb5\u51fd\u6570\uff08\u901a\u5e38\uff09\uff0c\u4e24\u4e2a\u62d0\u70b9\u663e\u7136\u5728 $\\min$ \u4e2d\u4e24\u9879\u76f8\u7b49\u6216 $\\max$ \u4e2d\u4e24\u9879\u76f8\u7b49\u65f6\u5019\u53d6\u5f97\u3002\n\n\u4e0d\u8fc7\u76f4\u63a5\u5206\u6790\u4e5f\u53ef\u4ee5\u6c42\u51fa\u6765\u4e0a\u9762\u8fd9\u4e2a\u5f0f\u5b50\u5bf9\u5e94\u7684\u5dee\u5206\uff0c\u5176\u5b9e\u662f\u5728\u7b54\u6848\u6570\u7ec4\u4e0a\u5f71\u54cd\u4e86\u5176\u4e8c\u9636\u5dee\u5206\uff0c\u5373 $\\Delta_2 a_1=1$ \uff0c $\\Delta_2 a_{u+1} = -1$ \uff0c $\\Delta_2 a_{n-u+2} = -1$ \u3002\n\n\u90a3\u4e48\u5bf9\u4e8e\u4e00\u6b21\u5355\u70b9\u4fee\u6539\uff0c\u6211\u4eec\u53ef\u4ee5 $\\Theta(1)$ \u66f4\u65b0\u5dee\u5206\u6570\u7ec4\uff0c\u7136\u540e $\\Theta(n)$ \u91cd\u6784\u7b54\u6848\u6570\u7ec4\u987a\u4fbf\u518d\u626b\u4e00\u904d\u524d\u7f00\u548c\u3002\u5bf9\u4e8e\u533a\u95f4\u4fee\u6539\uff0c\u5c31\u5148\u7edf\u4e00\u66f4\u65b0\uff0c\u518d\u91cd\u65b0\u91cd\u6784\u5c31\u53ef\u4ee5\u505a\u5230\u5355\u6b21\u4fee\u6539 $\\Theta(n)$ \u5b8c\u6210\u800c\u5355\u6b21\u67e5\u8be2 $\\Theta(1)$ \u5b8c\u6210\u3002\u8fd9\u4e2a\u505a\u6cd5\u6309\u7167\u5206\u70b9\u62ff\u5230\u4e86 50 \u5206\u3002\n\n\u800c\u4e3a\u4e86\u901a\u8fc7\u6b64\u9898\uff0c\u6ce8\u610f\u5230\u533a\u95f4\u4fee\u6539\u7684\u672c\u8d28\u662f\u589e\u8fdb\u4e86\u4e00\u4e2a\u7ef4\u5ea6\uff0c\u7ed3\u5408\u524d\u7f00\u548c\u6211\u4eec\u5b9e\u9645\u9700\u8981\u5728\u4e00\u4e2a\u56db\u9636\u5dee\u5206\u4e0a\u505a\u5355\u70b9\u4fee\u6539\u3002\n\n\u5176\u5b9e\u66fe\u7ecf\u7814\u7a76\u7684\u6811\u72b6\u6570\u7ec4\u8fdb\u884c\u533a\u95f4\u4fee\u6539\u533a\u95f4\u67e5\u8be2\uff0c\u5c31\u662f\u5728\u4e8c\u9636\u524d\u7f00\u548c\u4e0a\u7684\u63a2\u7d22\u3002\u6ce8\u610f\u5230\u524d\u7f00\u548c\u6216\u5dee\u5206\u5177\u6709\u53ef\u7d2f\u52a0\u6027\uff0c\u4e0d\u59a8\u76f4\u63a5\u8ba8\u8bba\u5bf9\u4e8e\u4e00\u4e2a\u6570\u5217 $a_1=1$ \uff0c $i>2,a_i=0$ \u7684\u6570\u5217\u7684 k \u9636\u524d\u7f00\u548c $\\sigma_{k,n}=\\sum_{i=1}^n\\sigma_{k-1,i}$ \u7684\u8868\u793a\u3002\n\n\u5bb9\u6613\u6ce8\u610f\u5230 $\\sigma_{1,n}=1,\\sigma_{2,n}=n$ \uff0c\u800c\u7ed3\u5408\u5c0f\u5b66\u77e5\u8bc6\u6211\u4eec\u8fdb\u4e00\u6b65\u77e5\u9053 $\\sigma_{3,n}=\\frac{n(n+1)}2$ \u4ee5\u53ca $\\sigma_{4,n}=\\frac{n(n+1)(n+2)}6$ \u3002\n\n\u6211\u4eec\u53ea\u9700\u8981\u7528\u6811\u72b6\u6570\u7ec4\u7d2f\u52a0\u5730\u7ef4\u62a4\u4e00\u4e2a $k-1$ \u9636\u591a\u9879\u5f0f\uff0c\u90a3\u4e48\u591a\u9879\u5f0f\u5e73\u79fb\u65f6\u9884\u5904\u7406\u9700\u8981 $\\Theta(nk^2)$ \uff0c\u800c\u5355\u6b21\u4fee\u6539\u548c\u67e5\u8be2\u90fd\u662f $\\Theta(k\\log n)$ \u7684\u3002\n\n\u5b9e\u6d4b\u8dd1\u7684\u6bd4 std \u4ee5\u53ca\u5927\u90e8\u5206\u4e0d\u52a0\u4f18\u5316\u7684\u6807\u51c6\u601d\u8def\u5feb\u5f88\u591a\u3002\n\n\u4ee3\u7801:\n\n```cpp\n#include <cstdio>\n#include <cstring>\n\n#include <algorithm>\n\n#define LOG(FMT...) // fprintf(stderr, \"[LOG] \"FMT)\n\nusing namespace std;\n\ntypedef long long ll;\n\nconst int K = 4;\n\nstruct Poly {\n\tint a[K];\n\t\n\tPoly() { memset(a, 0, sizeof(a)); }\n\t\n\tPoly(const Poly& x) { memcpy(a, x.a, sizeof(a)); }\n\t\n\tint val(int x) const;\n\t\n\tPoly operator+(const Poly& rhs) const;\n\tPoly operator*(int k) const;\n\t\n\tPoly operator+=(const Poly& rhs);\n\tPoly operator*=(int k);\n};\n\nconst int N = 200010, R24 = 41666667;\nconst int P = 1000000007;\n\nint n, m;\nint comb[K][K];\nPoly unit[N];\nPoly fw[N];\n\nint lowBit(int k);\nvoid change(int k, const Poly& x);\nPoly query(int k);\nvoid init();\nvoid change(int k, int x);\nvoid change(int l, int r, int a);\nvoid exGcd(int a, int b, int& x, int& y); \nint rev(int a);\n\nint main() {\n\tscanf(\"%d%d\", &n, &m);\n\tinit();\n\tfor (int i = 1; i <= n; ++i) {\n\t\tint a;\n\t\tscanf(\"%d\", &a);\n\t\tchange(i, i, a);\n\t}\n\twhile (m--) {\n\t\tint opt, l, r;\n\t\tscanf(\"%d%d%d\", &opt, &l, &r);\n\t\tif (l > r)\n\t\t\tswap(l, r);\n\t\tif (opt == 1) {\n\t\t\tint a;\n\t\t\tscanf(\"%d\", &a);\n\t\t\tchange(l, r, a);\n\t\t} else {\n\t\t\tprintf(\"%d\\n\", (query(r).val(r) - query(l - 1).val(l - 1) + P) % P);\n\t\t}\n\t}\n\treturn 0;\n}\n\nvoid change(int l, int r, int a) {\n\tchange(1, a * (ll)(r - l + 1) % P);\n\tchange(2, a * (ll)(r - l + 1) % P * (P - 1) % P);\n\tchange(l + 1, a * (ll)(P - 1) % P);\n\tchange(r + 2, a);\n\tchange(n - r + 2, a * (ll)(P - 1) % P);\n\tchange(n - l + 3, a);\n}\n\nint rev(int a) {\n\tint x, y;\n\texGcd(a, P, x, y);\n\tif (x < 0)\n\t\tx += P;\n\treturn x;\n}\n\nvoid exGcd(int a, int b, int& x, int& y) {\n\tif (b == 0) {\n\t\tx = 1;\n\t\ty = 0;\n\t\treturn;\n\t}\n\texGcd(b, a % b, y, x);\n\ty -= a / b * x;\n}\n\nvoid change(int k, int x) {\n\tchange(k, unit[k - 1] * x);\n}\n\nvoid init() {\n\tfor (int i = 0; i < K; ++i) {\n\t\tcomb[i][0] = 1;\n\t\tfor (int j = 1; j <= i; ++j)\n\t\t\tcomb[i][j] = comb[i - 1][j] + comb[i - 1][j - 1];\n\t}\n\tunit[0].a[1] = rev(3);\n\tunit[0].a[2] = rev(2);\n\tunit[0].a[3] = rev(6);\n\tfor (int i = 1; i <= n; ++i)\n\t\tfor (int j = 0; j < K; ++j) {\n\t\t\tint ix = unit[0].a[j];\n\t\t\tfor (int k = j; k >= 0; --k) {\n\t\t\t\tunit[i].a[k] += ix * (ll)comb[j][k] % P;\n\t\t\t\tif (unit[i].a[k] >= P)\n\t\t\t\t\tunit[i].a[k] -= P; \n\t\t\t\tix = ix * (ll)(P - i) % P;\n\t\t\t}\n\t\t}\n\tLOG(\"%d\\n\", unit[0].val(2)); \n}\n\nint Poly::val(int x) const {\n\tint ret = 0, xxp = 1;\n\tfor (int i = 0; i < K; ++i) {\n\t\tret = (ret + a[i] * (ll)xxp) % P;\n\t\txxp = xxp * (ll)x % P;\n\t}\n\treturn ret;\n}\n\nPoly Poly::operator+(const Poly& rhs) const {\n\tPoly ret(*this);\n\treturn ret += rhs;\n}\n\nPoly Poly::operator*(int k) const {\n\tPoly ret(*this);\n\treturn ret *= k;\n}\n\nPoly Poly::operator+=(const Poly& rhs) {\n\tfor (int i = 0; i < K; ++i) {\n\t\ta[i] += rhs.a[i];\n\t\tif (a[i] >= P)\n\t\t\ta[i] -= P;\n\t}\n\treturn *this;\n}\n\nPoly Poly::operator*=(int k) {\n\tfor (int i = 0; i < K; ++i)\n\t\ta[i] = a[i] * (ll)k % P;\n\treturn *this;\n}\n\nint lowBit(int k) {\n\treturn k & -k;\n}\n\nvoid change(int k, const Poly& x) {\n\tfor (; k <= n; k += lowBit(k))\n\t\tfw[k] += x;\n}\n\nPoly query(int k) {\n\tPoly ret = Poly();\n\tfor (; k; k -= lowBit(k))\n\t\tret += fw[k];\n\treturn ret;\n}\n```",
        "postTime": 1526217953,
        "uid": 21423,
        "name": "Elegia",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P4458 \u3010[BJOI2018]\u94fe\u4e0a\u4e8c\u6b21\u6c42\u548c\u3011"
    },
    {
        "content": "\u8fd9\u9053\u9898\u539f\u6765\u662f\u4e2a \u516c\u5f0f\u5316\u7b80\u9898\u554a \uff0c\u8bdd\u8bf4\u6d1b\u5495\u5f00 O2 \u90fd\u8dd1\u4e0d\u8fc7 loj \u662f\u4ec0\u4e48\u9b3c\uff08\u8bdd\u8bf4 luogu \u51fa\u7ed3\u679c\u5012\u662f\u6bd4 loj \u5feb\u5f88\u591a\uff0c\u5fc5\u7136\u7684\u561b...\uff09\n\n\u6253\u4e86\u597d\u4e45\u7684\u66b4\u529b...\u611f\u53d7\u4e86\u4e00\u4e0b\u81ea\u5df1\u505a\u7684\u8bdd $40$ \u5206\u5df2\u7ecf\u662f\u4e0a\u9650\u4e86\n\n\u6211\u4eec\u5148\u4ee4 S \u6570\u7ec4\u8bb0\u5f55 a \u6570\u7ec4\u7684\u524d\u7f00\u548c\uff0c\u7136\u540e\u518d\u8ba9 SS \u4f5c\u4e3a a \u7684\u524d\u7f00\u548c\n\n\u7136\u540e\u518d\u770b\u770b\u6211\u4eec\u8981\u6c42\u7684 $ANS$\uff0c\u5b83\u7684\u8868\u8fbe\u5f0f\u5982\u4e0b\uff1a\n\n$$ANS=\\sum_{i=l}^r \\sum_{j=i}^{n} S_j-S_{j-i}$$\n\n\u610f\u601d\u5c31\u662f\u5148\u679a\u4e3e\u957f\u5ea6 i \u7136\u540e\u679a\u4e3e\u5de6\u8fb9\u754c\uff0c\u524d\u7f00\u548c\u76f8\u51cf\u5f97\u5230\u6570\u503c\u7136\u540e\u5168\u90e8\u76f8\u52a0\n\n\u4f46\u662f\u590d\u6742\u5ea6\u4f60\u770b\u5230\u4e86\u5457...\uff08\u4fee\u6539\u53cd\u5012\u8fd8\u6bd4\u8be2\u95ee\u5feb\u4e9b\u5462\uff09\n\n\u90a3\u4e48\u6211\u4eec\u7528\u4e4b\u524d\u7684 $SS$ \u6765\u4f18\u5316\u8fd9\u4e2a\u8868\u8fbe\u5f0f\uff1a\n\n$$ANS=\\sum_{i=l}^r SS_n-SS_{i-1}-SS_{n-i}$$\n\n\u600e\u4e48\u53d8\u8fc7\u6765\u7684\uff1f\u8fd8\u662f\u8003\u8651\u524d\u7f00\u548c\u76f8\u51cf\u5427...\u770b\u4e2a\u4e24\u4e09\u904d\u5c31\u770b\u61c2\u4e86\n\n\u4f46\u662f\u6211\u4eec\u53d1\u73b0\u8fd9\u6837\u53ea\u662f\u5c06\u8be2\u95ee\u7684\u590d\u6742\u5ea6\u964d\u6210 $O(n)$ \u4e86\uff0c\u5e76\u6ca1\u6709\u4ec0\u4e48\u8f6f\u7528\n\n\u4f46\u662f\u8fd9\u5df2\u7ecf\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u4e86\u554a\uff0c\u7136\u540e\u8be2\u95ee\u76f4\u63a5\u53d8 $O(log\\ n)$\n\n\u4f46\u662f\u4fee\u6539\u5462...\n\n\u90a3\u4e48\u6211\u4eec\u5c31\u8981\u8003\u8651\u7ed9\u4e00\u4e2a\u533a\u95f4\u52a0\u4e0a d \u65f6\uff0cd \u5bf9\u6bcf\u4e2a\u6570\u7684\u8d21\u732e\u4e86\n\n\u7ecf\u8fc7\u4e00\u7cfb\u5217\u7684\u63a8\u5bfc\uff08\u6570\u5b66\u5f52\u7eb3\u6cd5\uff09\u53ef\u4ee5\u5f97\u5230\uff1a\u4e00\u4e2a\u533a\u95f4\u6574\u4f53\u52a0\u4e0a d \u540e\uff0c SS \u6570\u7ec4\u53d8\u5316\u5982\u4e0b\uff1a\n\n> \u4ee4 G(i) \u8868\u793a $\\dfrac{n(n+1)}{2}$\n\n> $\\text{\u5bf9\u4e8e\u4efb\u610f\u7684}\\ SS_i \u2208 [l,r]\\ ,\\ SS_i\\ \\text{\u589e\u52a0}\\ \\ d * G(i-l+1) $\n\n> $\\text{\u5bf9\u4e8e\u4efb\u610f\u7684}\\ SS_i \u2208 (r,n]\\ ,\\ SS_i\\ \\text{\u589e\u52a0}\\ \\ d * G(r-l+1) + v * (i-r)(r-l+1) $\n\n\u4f9d\u65e7\u662f\u8003\u8651\u8d21\u732e\uff08\u9274\u4e8e\u8bfb\u8005\u975e\u5e38\u806a\u660e~~\u4e14\u672c\u4eba\u592a\u61d2~~\u5c31\u4e0d\u5217\u51fa\u63a8\u5bfc\u8fc7\u7a0b\u4e86\uff09\n\n\u518d\u8003\u8651\u4e00\u4e0b\u533a\u95f4\u8d21\u732e\uff0c\u4ee3\u7801\u5c31\u51fa\u6765\u4e86\uff08\u8fd9\u4e2a\u6807\u7b97\u53ef\u4e0d\u4f1a\u88ab\u66b4\u529b\u78be...\uff09\n\n\u7136\u540e\u6211\u4eec\u5f00\u5f00\u5fc3\u5fc3\u5730\u5728\u7ebf\u6bb5\u6811\u4e0a\u7ef4\u62a4\u8fd9\u4e9b\u4e1c\u897f\u54af\uff1f\n\n\u522b\u6025\uff0c\u8fd8\u6709\u4e00\u4e2a\u5751\u70b9\u5462...\u85cf\u5f97\u53ef\u6df1\u4e86\n\n\u76f8\u4fe1\u5927\u5bb6\u770b\u5b8c\u9898\u76ee\u90fd\u4f1a\u60f3\u8fd9\u9053\u9898\u4e0d\u5c31\u662f\u5bf9\u6570\u5217\u8fdb\u884c\u64cd\u4f5c\u4e48\uff0c\u4e3a\u4ec0\u4e48\u9898\u76ee\u8981\u8bf4\u6210\u662f\u94fe\u554a\uff1f\uff08\u5f53\u7136\u662f\u4e3a\u4e86\u5751\u4f60\u554a\uff01\uff09\n\n\u6211\u4eec\u770b\u5230 u v \u662f\u94fe\u4e0a\u7684\u4e24\u4e2a\u70b9\uff0c\u6240\u4ee5 v \u53ef\u4ee5\u5728 u \u524d\u9762\uff0c\u4e14\u6570\u636e\u8303\u56f4\u5e76\u6ca1\u6709\u5199 u<=v \uff0c\u6240\u4ee5...\u624d\u8bf4\u85cf\u5f97\u5f88\u6df1\u561b\n\n\u5982\u679c\u6ca1\u770b\u51fa\u8fd9\u70b9\u7684\u8bdd\uff0c\u6700\u591a 25 \u5206\n\n```\n//by Judge\n#include<bits/stdc++.h>\n#define ll long long\nconst int M=2e5+3,mod=1e9+7;\nconst int inv6=166666668;\nconst int inv2=5e8+4;\nusing namespace std;\n#ifndef Judge\n#define getchar() (p1==p2&&(p2=(p1=buf)+fread(buf,1,1<<21,stdin),p1==p2)?EOF:*p1++)\n#endif\nchar buf[1<<21],*p1,*p2;\n#define swap(x,y) (x)^=(y)^=(x)^=(y)\ntemplate<class T>inline void ADD(T& a,T b){a+=a+b>=mod?b-mod:b;}\ninline int read(){ int x=0,f=1; char c=getchar();\n    for(;!isdigit(c);c=getchar()) if(c=='-') f=-1;\n    for(;isdigit(c);c=getchar()) x=x*10+c-'0'; return x*f;\n} char sr[1<<21],z[21]; int Z,C=-1;\ninline void Ot(){fwrite(sr,1,C+1,stdout),C=-1;}\ninline void print(ll x,char ch='\\n'){\n    if(C>1<<20) Ot(); if(x<0) sr[++C]='-',x=-x;\n    for(;z[++Z]=x%10+48,x/=10;);\n    for(;sr[++C]=z[Z],--Z;); sr[++C]=ch;\n} int n,m; ll a[M<<2],b[M<<2],c[M<<2],t[M<<2],ss[M];\ninline ll s1(ll n){return n>0?n*(n+1)%mod*inv2%mod:0;}\ninline ll s2(ll n){return n>0?n*(n+1)%mod*(n<<1|1)%mod*inv6%mod:0;}\n#define ls k<<1\n#define rs k<<1|1\n#define mid (l+r>>1)\n#define lson ls,l,mid\n#define rson rs,mid+1,r\ninline void ad(int k,int l,int r,ll da,ll db,ll dc){\n\t(a[k]+=da)%=mod,(b[k]+=db)%=mod,(c[k]+=dc)%=mod;\n\t(t[k]+=(s2(r)-s2(l-1))*da%mod+(s1(r)-s1(l-1))*db%mod+(r-l+1)*dc%mod)%=mod;\n}\ninline void pushdown(int k,int l,int r){\n\tif(a[k]|b[k]|c[k]) ad(lson,a[k],b[k],c[k]),\n\t\tad(rson,a[k],b[k],c[k]),a[k]=b[k]=c[k]=0;\n}\nvoid build(int k,int l,int r){\n\tif(l==r) return t[k]=ss[l],void();\n\tbuild(lson),build(rson),t[k]=(t[ls]+t[rs])%mod;\n}\nvoid update(int k,int l,int r,int L,int R,ll a,ll b,ll c){\n\tif(L>r||l>R) return ; if(L<=l&&r<=R) return ad(k,l,r,a,b,c);pushdown(k,l,r);\n\tupdate(lson,L,R,a,b,c),update(rson,L,R,a,b,c),t[k]=(t[ls]+t[rs])%mod;\n}\nll query(int k,int l,int r,int L,int R){\n\tif(L>r||l>R) return 0; if(L<=l&&r<=R) return t[k];\n\treturn pushdown(k,l,r),(query(lson,L,R)+query(rson,L,R))%mod;\n}\ninline void update(ll l,ll r,ll v){ ll len=r-l+1;\n\tupdate(1,0,n,l,r,inv2*v%mod,(3-2*l)*inv2%mod*v%mod,(l*l-3*l+2)%mod*inv2%mod*v%mod);\n\tif(r<n) update(1,0,n,r+1,n,0,len*v%mod,((len+1)*inv2%mod-r)*len%mod*v%mod);\n}\ninline int query(ll l,ll r){\n\treturn (((r-l+1)*query(1,0,n,n,n)%mod-query(1,0,n,l-1,r-1)\n\t\t-query(1,0,n,n-r,n-l))%mod+mod)%mod;\n}\nint main(){ n=read(),m=read();\n\tfor(int i=1;i<=n;++i) ss[i]=read(),ADD(ss[i],ss[i-1]);\n\tfor(int i=1;i<=n;++i) ADD(ss[i],ss[i-1]); build(1,0,n); \n\tfor(int op,l,r,d;m;--m){\n\t\top=read(),l=read(),r=read();\n\t\tif(l>r) swap(l,r);\n\t\tif(op&1) d=read(),update(l,r,d);\n\t\telse print(query(l,r));\n\t} return Ot(),0;\n}\n\n\n```",
        "postTime": 1551857294,
        "uid": 38576,
        "name": "J\u03bcdge",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P4458 \u3010[BJOI2018]\u94fe\u4e0a\u4e8c\u6b21\u6c42\u548c\u3011"
    },
    {
        "content": "### **\u524d\u8a00\uff1a**\n\n\u672c\u521d\u4e8c\u849f\u84bb\u5bf9\u6570\u8bba\u4e00\u7a8d\u4e0d\u901a\uff0c\u672c\u9898\u89e3\u63a8\u5bfc\u8fc7\u7a0b\u90fd\u662f\u65e0\u8111\u6570\u5b66\u5f0f\uff0c**\u4f3c\u4e4e\u6bd4\u522b\u7684\u9898\u89e3\u957f\u5f97\u591a**\u3002\n\n\u8fd9\u662f\u672c\u849f\u84bb AC \u7684\u7b2c\u4e00\u9053\u9ed1\u9898\uff0c\u4e5f\u662f\u672c\u849f\u84bb\u7684\u7b2c\u4e00\u7bc7\u9898\u89e3\uff0c\u5e0c\u671b\u5927\u5bb6\u5bf9\u6587\u4e2d\u7684\u4e0d\u8db3\u63d0\u51fa\u5efa\u8bae\u5427\u3002\n\n~~\uff08\u8bdd\u8bf4\u6211\u600e\u4e48\u7b2c\u4e00\u7bc7\u9898\u89e3\u5c31\u8981\u5199\u8fa3\u4e48\u591a\u6570\u5b66\u67ff\u5b50\u5440\uff09~~\n\n### **\u9898\u76ee\u5927\u610f\uff1a**\n\u7ed9\u4e00\u6761\u957f\u5ea6\u4e3a $n$ \u7684\u94fe\uff0c\u4ece $1$ \u5230 $n$ \u4f9d\u6b21\u8fde\u63a5\u800c\u6210\u3002\u6bcf\u4e2a\u7ed3\u70b9\u6709\u4e00\u4e2a\u70b9\u6743\u3002\u8981\u6c42\u5b9e\u73b0\u4e24\u79cd\u64cd\u4f5c\uff1a\n1. \u5c06\u7ed3\u70b9 $u$ \u5230 $v$ \u4e4b\u95f4\u7684\u6240\u6709\u7ed3\u70b9\uff08\u5305\u62ec $u$ \u548c $v$\uff09\u7684\u70b9\u6743\u90fd $+d$\u3002\n1. \u6c42\u51fa\u6240\u6709\u957f\u5ea6\u5728 $[l,r]$ \u8303\u56f4\u5185\u7684\u94fe\u7684\u4e8c\u6b21\u6c42\u548c\u3002\u4ece $u$ \u5230 $v$ \u548c\u4ece $v$ \u5230 $u$ \u88ab\u89c6\u4f5c\u540c\u4e00\u6761\u94fe\u3002\n\n\u6570\u636e\u8303\u56f4\uff1a$n\\le2\\times10^5$\uff0c$m\\le5\\times10^5$\uff0c$m'\\le1\\times10^5$\uff0c$l \\le r$\u3002\n($m$ \u8868\u793a\u4e24\u79cd\u64cd\u4f5c\u7684\u603b\u6b21\u6570\uff0c$m'$ \u8868\u793a\u64cd\u4f5c $1$ \u7684\u6b21\u6570\uff09\n\n## **\u9898\u89e3\uff1a**\n\n### 1. **\u5199\u5728\u6700\u524d\u9762\uff1a\u4e00\u5b9a\u8981\u6ce8\u610f\uff01**\n\n\u8bfb\u5b8c\u8fd9\u9053\u9898\u76ee\uff0c\u5927\u5bb6\u53ef\u80fd\u4f1a\u76f4\u547c\uff1a\u8fd9\u4e0d\u5c31\u662f\u4e2a\u5e8f\u5217\u5417\uff01\u4e3a\u4ec0\u4e48\u51fa\u9898\u4eba\u975e\u8981\u8bf4\u6210\u94fe\u5462\uff1f\n\n\u56e0\u4e3a\u4ed6\u8981\u57cb\u4f0f\u9677\u5bb3\u4f60\u554a\uff01\n\n\u5982\u679c\u4ed4\u7ec6\u770b\u4e00\u4e0b\u5197\u957f\u7684\u6570\u636e\u8303\u56f4\uff0c\u4f60\u4f1a\u53d1\u73b0\uff0c\u597d\u50cf\u53ea\u8bf4\u4e86 $l \\le r$\uff0c\u5e76\u6ca1\u6709\u8bf4 $u \\le v$\uff1f\n\n$l$ \u548c $r$ \u662f\u64cd\u4f5c $2$ \u7684\u53c2\u6570\uff0c$u$ \u548c $v$ \u662f\u64cd\u4f5c $1$ \u7684\u53c2\u6570\uff0c\u8bf4\u660e\u4ec0\u4e48\uff1f\n\n**\u5728\u4fee\u6539\u7684\u65f6\u5019\uff0c\u53ef\u80fd\u5b58\u5728 $u>v$\uff01\u8fd9\u65f6\u9700\u8981\u4ea4\u6362 $u$ \u548c $v$\uff01**\n\n\u636e\u672c\u4eba\u5b9e\u6d4b\uff0c\u5982\u679c\u6ca1\u6709\u8003\u8651 $u>v$\uff0c$100$ \u5206\u964d\u5230 $25$ \u5206\uff01\u6240\u4ee5\u8bf4\uff0c**\u4ee3\u7801\u5199\u9519\u975e\u5b9e\u5f31\uff0c\u7ec6\u8282\u60f3\u5047\u6bc1\u4e00\u751f\u3002**\n\n### 2. \u524d\u7f6e\u829d\u58eb\uff1a**\u7ebf\u6bb5\u6811**\n\n~~\uff08\u8bdd\u8bf4\u4e0d\u4f1a\u7ebf\u6bb5\u6811\u7684\u5c31\u5148\u522b\u5f00\u9ed1\u9898\u4e86\u5427\uff09~~\n\n\u5148\u9884\u544a\u4e00\u4e0b\u672c\u9898\u9700\u8981\u7ef4\u62a4\u7684\u4e1c\u897f\uff1a\n\n\u4e09\u68f5\u7ebf\u6bb5\u6811\uff1a\n\n$sp[0]$ \u8bb0\u5f55\uff1a$\\sum\\limits_{}a_i$\uff0c\n\n$sp[1]$ \u8bb0\u5f55\uff1a$\\sum\\limits_{}a_i \\times i$\uff0c\n\n$sp[2]$ \u8bb0\u5f55\uff1a$\\sum\\limits_{}a_i \\times i^2$\u3002\n\n\u5176\u4e2d $a_i$ \u8868\u793a\u539f\u5e8f\u5217\u4e2d\u7684\u6bcf\u4e00\u4e2a\u6570\u3002\n\n\u4ee4\uff1a\n\n$$\\operatorname{sum(0,i)}=i$$\n\n$$\\operatorname{sum(1,i)}=\\sum\\limits_{j=1}^ij$$\n\n$$\\operatorname{sum(2,i)}=\\sum\\limits_{j=1}^ij^2$$\n\n$sum$ \u6570\u7ec4\u7684\u9884\u5904\u7406\u957f\u8fd9\u6837\uff1a\n```cpp\nfor(LL i = 1; i <= n; i++) {\n\tsum[0][i] = (sum[0][i - 1] + 1) % mod;\n\tsum[1][i] = (sum[1][i - 1] + i) % mod;\n\tsum[2][i] = (sum[2][i - 1] + i * i) % mod;\n}\n```\n\u6ce8\uff1a$mod$ \u8868\u793a\u672c\u9898\u6a21\u6570\uff0c$mod=10^9+7$\u3002\n\n\u7ebf\u6bb5\u6811\u7684\u677f\u5b50\u4e0d\u5570\u55e6\u4e86\uff0c\u653e\u4e0a\u6211\u5de8\u4e11\u7684\u4ee3\u7801\uff1a\n\n\u4e00\u4e9b\u53d8\u91cf\u7684\u5b9a\u4e49\uff1a\n```cpp\n#define MAXN 200010\n#define mod 1000000007\n#define LL long long\nLL sp[3][MAXN << 2], lazy[MAXN << 2], sum[3][MAXN];\nLL n, m;\n```\n$up$ \u51fd\u6570\u53ca\u5efa\u6811\uff1a\n\n```cpp\ninline void up(LL p) {\n\tfor(LL i = 0; i < 3; i++)\n\t\tsp[i][p] = (sp[i][p << 1] + sp[i][p << 1 | 1]) % mod;\n}\ninline void build(LL p, LL l, LL r) {\n\tif(l == r) {\n\t\tscanf(\"%lld\", &sp[0][p]);\n\t\tsp[1][p] = sp[0][p] * l % mod;\n\t\tsp[2][p] = sp[0][p] * l % mod * l % mod;\n\t\treturn;\n\t}\n\tLL m = (l + r) >> 1;\n\tbuild(p << 1, l, m);\n\tbuild(p << 1 | 1, m + 1, r);\n\tup(p);\n}\n```\n\u4e0b\u4f20\u61d2\u60f0\u6807\u8bb0\uff1a\n\n```cpp\ninline void down(LL p, LL l, LL r) {\n\tif(lazy[p]) {\n\t\tlazy[p << 1] = (lazy[p << 1] + lazy[p]) % mod;\n\t\tlazy[p << 1 | 1] = (lazy[p << 1 | 1] + lazy[p]) % mod;\n\t\tLL m = (l + r) >> 1;\n\t\tfor(LL i = 0; i < 3; i++) {\n\t\t\tsp[i][p << 1] = (sp[i][p << 1] + (sum[i][m] - sum[i][l - 1] + mod) % mod * lazy[p] % mod) % mod;\n\t\t\tsp[i][p << 1 | 1] = (sp[i][p << 1 | 1] + (sum[i][r] - sum[i][m] + mod) % mod * lazy[p] % mod) % mod;\n\t\t}\n\t\tlazy[p] = 0;\n\t}\n}\n```\n$update$ \u51fd\u6570\uff1a\n```cpp\ninline void update(LL p, LL l, LL r, LL x, LL y, LL d) {\n\tif(x <= l && r <= y) {\n\t\tlazy[p] = (lazy[p] + d) % mod;\n\t\tfor(LL i = 0; i < 3; i++)\n\t\t\tsp[i][p] = (sp[i][p] + (sum[i][r] - sum[i][l - 1] + mod) % mod * d % mod) % mod;\n\t\treturn;\n\t}\n\tdown(p, l, r);\n\tLL m = (l + r) >> 1;\n\tif(x <= m) update(p << 1, l, m, x, y, d);\n\tif(y > m) update(p << 1 | 1, m + 1, r, x, y, d);\n\tup(p);\n}\n```\n$query$ \u51fd\u6570\uff1a\n```cpp\ninline LL query(LL id, LL p, LL l, LL r, LL ql, LL qr) { //id\u8868\u793a\u8be2\u95ee\u7684\u7ebf\u6bb5\u6811\u7684\u7f16\u53f7\u3002\n\tif(ql <= l && r <= qr) return sp[id][p];\n\tdown(p, l, r);\n\tLL m = (l + r) >> 1, ret = 0;\n\tif(ql <= m) ret = (ret + query(id, p << 1, l, m, ql, qr)) % mod;\n\tif(qr > m) ret = (ret + query(id, p << 1 | 1, m + 1, r, ql, qr)) % mod;\n\treturn ret;\n}\n```\n\uff08\u7ebf\u6bb5\u6811\u677f\u5b50\u90e8\u5206\u81ea\u884c\u7406\u89e3\u5427\uff0c\u90a3\u4e0d\u662f\u6700\u4e3b\u8981\u7684\u90e8\u5206\uff09\n\n### 3.\u91cd\u70b9\u90e8\u5206\uff1a\u63a8\u5f0f\u5b50\n\n\u5148\u7ed9\u4e00\u9053\u6211\u4ee5\u524d\u505a\u8fc7\u7684\u9898\u76ee\uff1a\n[P2221 [HAOI2012]\u9ad8\u901f\u516c\u8def](https://www.luogu.com.cn/problem/P2221)\n\n\u6211\u4ece\u8fd9\u9053\u9898\u76ee\u4e2d\u5f97\u51fa\u4e86\u4e00\u4e9b\u5b9d\u8d35\u7684\u7ecf\u9a8c\uff1a**\u7c7b\u4f3c\u4e8e\u8fd9\u79cd\u7c7b\u578b\u7684\u4e8c\u6b21\u6c42\u548c\u9898\uff0c\u4e00\u822c\u4ece\u6bcf\u4e00\u4e2a\u70b9\u5bf9\u6700\u7ec8\u7b54\u6848\u7684\u8d21\u732e\u6765\u8003\u8651\u3002**\n\n~~\u6240\u4ee5\u6211\u5c31\u575a\u5b9a\u4e0d\u79fb\u5730\u6cbf\u7740\u8fd9\u4e2a\u601d\u8def\u75af\u72c2\u5730\u65e0\u8111\u63a8\u5f0f\u5b50\uff0c\u6240\u4ee5\u8fd9\u7bc7\u9898\u89e3\u7279\u522b\u957f QwQ\u3002~~\n\n\u9996\u5148\u7b80\u5316\u4e00\u4e0b\u9700\u8981\u6c42\u7684\u7b54\u6848\uff1a\n\u8bbe $\\operatorname{solve(x)}$ \u8868\u793a\u6240\u6709\u957f\u5ea6\u5728 $[1,x]$ \u8303\u56f4\u5185\u7684\u94fe\u7684\u4e8c\u6b21\u6c42\u548c\u3002\n\n\u5bf9\u4e8e\u8be2\u95ee $[l,r]$\uff0c$Ans=\\operatorname{solve(r)}-\\operatorname{solve(l-1)}$\u3002\n\n\u5982\u679c\u6ca1\u6709\u8fd9\u4e00\u6b65\uff0c\u6050\u6015\u4e0b\u9762\u5c31\u6ca1\u529e\u6cd5\u505a\u4e86\u3002\n\n\u4f46\u662f\u7531\u4e8e\u6211\u4eec\u4f1a\u5728 $\\operatorname{solve}$ \u51fd\u6570\u4e2d\u628a\u7b54\u6848\u53d6\u6a21\uff0c\u6240\u4ee5\u5199\u4ee3\u7801\u7684\u65f6\u5019\u5e94\u8be5\u8fd9\u6837\u5199\uff1a\n```cpp\nprintf(\"%lld\\n\", (solve(r) - solve(l - 1) + mod) % mod);\n```\n\u7531\u4e8e\u9898\u76ee\u4fdd\u8bc1\u4e86 $l \\le r$\uff0c\u6240\u4ee5\u4e0d\u7528\u7279\u5224 $l>r$ \u7684\u60c5\u51b5\u4e86\u3002\n\n\u63a5\u4e0b\u6765\u5c31\u662f\u5bf9 $\\operatorname{solve(x)}$ \u6c42\u89e3\u3002\n\n\u4e3a\u4e86\u907f\u514d\u8003\u8651\u4e00\u4e9b\u5947\u5947\u602a\u602a\u7684\u8fb9\u754c\u60c5\u51b5\u5077\u4e2a\u5c0f\u61d2\uff0c\u6211\u5c31\u76f4\u63a5\u7279\u5224 $x=0$ \u7684\u65f6\u5019\u8fd4\u56de\u503c\u4e3a $0$ \u4e86\u3002\n\n\u8bbe $C_i$ \u8868\u793a $a_i$ \u5bf9\u6700\u7ec8\u7b54\u6848\u7684\u8d21\u732e\u6b21\u6570\uff0c\u610f\u601d\u5c31\u662f$a_i$\u5728\u6240\u6709\u7b26\u5408\u6761\u4ef6\u7684\u94fe\u4e2d\u7684\u51fa\u73b0\u6b21\u6570\u3002\u5219\u6709\uff1a\n\n$$C_i=\\sum\\limits_{j=\\max(i-x+1,1)}^i \\min(j+x-1,n)-i+1$$\n\n\u8fd9\u4e2a\u67ff\u5b50\u662f\u4ec0\u4e48\u610f\u601d\u5462\uff1f\n\n$j$ \u679a\u4e3e\u7b26\u5408\u6761\u4ef6\u7684\u94fe\u7684\u5de6\u7aef\u70b9\uff0c\u663e\u7136\u53ea\u6709\u5f53 $j \\ge i-x+1$ \u65f6\uff0c\u53f3\u7aef\u70b9\u624d\u80fd\u591f\u8fbe\u5230 $i$\u3002\u540c\u6837\u663e\u7136\u7684\u662f $j \\ge 1$\u3002\n\n$j+x-1$ \u8868\u793a\u6b64\u65f6\u53f3\u7aef\u70b9\u6700\u591a\u80fd\u5230\u8fbe\u54ea\u91cc\uff0c\u4f46\u662f\u53f3\u7aef\u70b9\u663e\u7136\u4e0d\u80fd\u8d85\u8fc7 $n$\uff0c\u6240\u4ee5\u548c $n$ \u53d6\u4e00\u4e2a $\\min$\u3002\n\n$\\min(j+x-1,n)-i+1$ \u8868\u793a\u7684\u5c31\u662f\uff1a\u4ee5 $j$ \u4e3a\u5de6\u7aef\u70b9\u65f6\uff0c$a_i$ \u5bf9\u7b54\u6848\u7684\u8d21\u732e\u6b21\u6570\u3002\n\n\u663e\u7136\uff0c$\\max$ \u548c $\\min$ \u7684\u5b58\u5728\u4e25\u91cd\u963b\u788d\u4e86\u6211\u4eec\u5316\u7b80\u5f0f\u5b50\uff0c\u6240\u4ee5\u63a5\u4e0b\u6765\u9700\u8981\u8fdb\u884c\u590d\u6742\u7684\u5206\u7c7b\u8ba8\u8bba\uff1a\n\n## \u4e00. \u5f53 $x \\le n - x + 1$ \u65f6\uff1a\n### 1. $j \\in [1,x]$\n\u5219\u6709\uff1a\n$$j-x+1 \\le 1$$\n\n$$\\therefore C_i=\\sum\\limits_{j=1}^i \\min(j+x-1,n)-i+1$$\n\n$\\because j \\le x$\n\n$\\therefore j+x-1 \\le 2x-1$\n\n$\\because x \\le n - x + 1$\n\n$\\therefore 2x-1 \\le n$\n\n$\\therefore j+x-1 \\le n$\n\n$\\therefore $\n$$\\therefore C_i=\\sum\\limits_{j=1}^i j+x-i$$\n\n\uff08\u73b0\u5728\u5e94\u8be5\u77e5\u9053\u4e3a\u4ec0\u4e48\u524d\u9762\u8981\u5206\u7c7b $x \\le n-x+1$ \u4e86\u5427\uff09\n\n\u624b\u63a8\u4e00\u4e0b\uff0c\u5f97\uff1a\n$$C_i=\\frac{1}{2}i(2x-i+1)$$\n\n\u8fd9\u4e00\u6bb5\u5bf9\u7b54\u6848\u7684\u8d21\u732e\uff08\u4e3a\u4e86\u8282\u7701\u7bc7\u5e45\uff0c\u8fc7\u7a0b\u7565\uff09\uff1a\n$$\\sum\\limits_{j=1}^x C_ia_i$$\n$$=\\frac{1}{2}\\sum\\limits_{i=1}^x[(2x+1)ia_i-i^2a_i]$$\n\n\u4e8e\u662f\u53ef\u4ee5\u5728 $sp[1]$ \u4e2d\u67e5\u8be2$\\sum\\limits_{i=1}^xia_i$\uff0c\u5728 $sp[2]$ \u4e2d\u67e5\u8be2 $\\sum\\limits_{i=1}^xi^2a_i$\u3002\n\n\u8fd9\u4e00\u90e8\u5206\u7684\u4ee3\u7801\uff1a\n```cpp\nLL s1 = query(1, 1, 1, n, 1, x);\nLL s2 = query(2, 1, 1, n, 1, x);\nret = (ret + ((x << 1 | 1) * s1 % mod - s2 + mod) % mod * P % mod) % mod;\n```\n$P$ \u7684\u542b\u4e49\u5c06\u4f1a\u5728\u540e\u6587\u63d0\u53ca\u3002\n\n\u4e07\u4e8b\u5f00\u5934\u96be\uff0c\u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u63a8\u5bfc\u51fa\u4e86\u7b2c\u4e00\u6bb5\uff0c\u4ee5\u4e0b\u5c31\u5982\u6cd5\u70ae\u5236\u4e86\u3002**\u4e3a\u8282\u7701\u7bc7\u5e45\uff0c\u4ee5\u4e0b\u4f1a\u7701\u7565\u5927\u91cf\u7b80\u5355\u8fc7\u7a0b\uff0c\u5efa\u8bae\u81ea\u884c\u624b\u63a8\u4e00\u4e0b\u52a0\u6df1\u5370\u8c61\u3002**\n\n### 2. $i \\in [x+1,n-x+1]$\n\u5219\u6709\uff1a\n$$C_i=\\sum\\limits_{j=i-x+1}^i \\min(j+x-1,n)-i+1$$\n\n\u663e\u7136\uff0c$j+x-1 \\le i+x-1 \\le n-x+1+x-1=n$\n\n\u6240\u4ee5\u6109\u5feb\u5730\u62c6\u6389 $\\min$ \u5566\uff1a\n$$C_i=\\sum\\limits_{j=i-x+1}^i j+x-i$$\n\n$$C_i=\\frac{1}{2}x(x+1)$$\n\n\u8fd9\u4e00\u6bb5\u5bf9\u7b54\u6848\u7684\u8d21\u732e\uff1a\n\n$$\\sum\\limits_{i=x+1}^{n-x+1}C_ia_i$$\n$$=\\frac{1}{2}\\sum\\limits_{i=x+1}^{n-x+1}a_ix(x+1)$$\n\n\u8c03\u7528 $sp[0]$ \u67e5\u4e00\u4e0b\n$$\\sum\\limits_{i=x+1}^{n-x+1}a_i$$\n\u5c31\u641e\u5b9a\u5566\u3002\n\n\u8fd9\u4e00\u90e8\u5206\u7684\u4ee3\u7801\uff1a\n```cpp\nif(x < n - x + 1) ret = (ret + query(0, 1, 1, n, x + 1, n - x + 1) * x % mod * (x + 1) % mod * P % mod) % mod;\n```\n\u6ce8\u610f\u5148\u7279\u5224\u4e00\u4e0b $x<n-x+1$\u3002\n\n### 3. $i \\in [n-x+2,n]$\n\u5219\u6709\uff1a\n$$C_i=\\sum\\limits_{j=i-x+1}^i \\min(j+x-1,n)-i+1$$\n\n\u8fd9\u4e2a\u5c31\u6bd4\u8f83\u9ebb\u70e6\u4e86\uff0c\u8981\u8fdb\u4e00\u6b65\u5206\u7c7b\u8ba8\u8bba\u3002\n\n(1) $j+x-1 \\le n$\n\n$\\because i-x+1 \\le j \\le n-x+1$\n\n$\\therefore$\n$$C_i=\\sum\\limits_{j=i-x+1}^{n-x+1}j+x-i$$\n$$C_i=\\frac{1}{2}(n-i+1)(n-i+2)$$\n\u4ee4\uff1a$X=n+1$\uff0c$Y=n+2$\uff0c\n\n\u5219\uff1a$C_i=XY-(X+Y)i+i^2$\u3002\n\n\u8fd9\u4e00\u6bb5\u5bf9\u7b54\u6848\u7684\u8d21\u732e\uff1a\n$$\\sum\\limits_{i=n-x+2}^nC_ia_i$$\n$$=\\frac{1}{2}\\sum\\limits_{i=n-x+2}^nXYa_i-(X+Y)ia_i+i^2a_i$$\n\n(2) $j+x-1>n$\n$$C_i=\\sum\\limits_{n-x+2}^in-i+1$$\n$$C_i=(n-i+1)(i-n+x-1)$$\n\u4ee4\uff1a$E=n+1$\uff0c$F=x-n-1$\uff0c\u5219\uff1a\n$$C_i=EF+(E-F)i-i^2$$\n\n\u8fd9\u4e00\u6bb5\u5bf9\u7b54\u6848\u7684\u8d21\u732e\uff1a\n$$\\sum\\limits_{i=n-x+2}^nC_ia_i$$\n$$=\\sum\\limits_{i=n-x+2}^nEFa_i+(E-F)ia_i-i^2a_i$$\n\n\u653e\u4e00\u4e0b\u6574\u4e2a $3.$ \u7684\u4ee3\u7801\uff1a\n```cpp\nif(n - x + 2 <= n) {\n\tLL X = n + 1, Y = n + 2;\n\tLL s0 = query(0, 1, 1, n, n - x + 2, n);\n\tLL s1 = query(1, 1, 1, n, n - x + 2, n);\n\tLL s2 = query(2, 1, 1, n, n - x + 2, n);\n\tret = (ret + (X * Y % mod * s0 % mod - (X + Y) * s1 % mod + s2 + mod) % mod * P % mod) % mod;\n\tLL E = n + 1, F = x - n - 1;\n\tret = (ret + (E * F % mod * s0 % mod + (E - F) * s1 % mod - s2 + mod * 2) % mod) % mod; //\u8fd9\u91cc\u5fc5\u987b\u8981+mod*2\uff0c\u56e0\u4e3aF=x-n-1\u662f\u8d1f\u6570\uff0c\u5bfc\u81f4\u524d\u9762E*F%mod\u4e5f\u4f1a\u4ea7\u751f\u4e00\u4e2a\u8d1f\u6570\uff0c\u6240\u4ee5\u8981+mod*2\u6273\u56de\u6765\u3002\u5982\u679c+mod\uff0c\u5c31\u53ea\u526925\u5206\u4e86\uff01\n}\n```\n\u8bdd\u8bf4\u6211\u4eec\u7ec8\u4e8e\u628a $x \\le n-x+1$ \u63a8\u5b8c\u4e86 QAQ\u3002\n\n## \u4e8c. $x>n-x+1$\n### 1. $i \\in [1,n-x+1]$\n\n$\\because x>n-x+1$\n\n$\\therefore i<x$\n\n$\\therefore$\n$$C_i=\\sum\\limits_{j=1}^i min(j+x-1,n)-i+1$$\n\n$\\because i<n-x+1$\n\n$\\therefore i+x-1 \\le n$\n\n$\\therefore j+x-1 \\le n$\n\n$\\therefore$\n\n$$C_i=\\sum\\limits_{j=1}^i j+x-i$$\n\n$$C_i=\\frac{1}{2}(2xi-i^2+i)$$\n\n\u8fd9\u4e00\u6bb5\u5bf9\u7b54\u6848\u7684\u8d21\u732e\uff1a\n$$\\sum\\limits_{i=1}^{n-x+1}C_ia_i$$\n$$=\\frac{1}{2}\\sum\\limits_{i=1}^{n-x+1}[(2x+1)ia_i-i^2a_i]$$\n\n\u8fd9\u4e00\u6bb5\u7684\u4ee3\u7801\u653e\u4e00\u4e0b\uff1a\n```cpp\nLL s1 = query(1, 1, 1, n, 1, n - x + 1);\nLL s2 = query(2, 1, 1, n, 1, n - x + 1);\nret = (ret + ((x << 1 | 1) * s1 % mod - s2 + mod) % mod * P % mod) % mod;\n```\n### 2. $i \\in [n-x+2,x]$\n\n\u5219\u6709\uff1a\n$$C_i=\\sum\\limits_{j=1}^i min(j+x-1,n)-i+1$$\n\n(1) $j+x-1 \\le n$\n\n\u5219\u6709\uff1a\n$$C_i=\\sum\\limits_{j=1}^{n-x+1}j+x-i$$\n$$C_i=\\frac{1}{2}(n-x+1)(n+x-2i+2)$$\n\n\u4ee4\uff1a$A=n-x+1$\uff0c$B=n+x+2$\uff0c\u5219\uff1a\n$$C_i=\\frac{1}{2}A(B-2i)$$\n\n\u8fd9\u4e00\u6bb5\u5bf9\u7b54\u6848\u7684\u8d21\u732e\uff1a\n$$\\sum\\limits_{i=n-x+2}^xC_ia_i$$\n$$=\\frac{1}{2}\\sum\\limits_{i=n-x+2}^xABa_i-2Aia_i$$\n\n(2) $j>n-x+1$\n\n\u5219\u6709\uff1a\n$$C_i=\\sum\\limits_{j=n-x+2}^i n-i+1$$\n$$C_i=(n-i+1)(i-n+x-1)$$\n\n\u4ee4\uff1a$S=n+1$\uff0c$T=x-n-1$\u3002\n\n~~\uff08\u8bdd\u8bf4\u6211\u4ee4\u7684\u90fd\u662f\u4e9b\u5565\u5b57\u6bcd\uff09~~\n\n\u5219\u6709\uff1a\n$$C_i=ST-(S-T)i+i^2$$\n\n\u8fd9\u4e00\u6bb5\u5bf9\u7b54\u6848\u7684\u8d21\u732e\uff1a\n$$\\sum\\limits_{i=n-x+2}^xC_ia_i$$\n$$=\\sum\\limits_{i=n-x+2}^xSTa_i+(S-T)ia_i-i^2a_i$$\n\n\u6574\u4e2a $2.$ \u7684\u4ee3\u7801\u653e\u4e0a\u6765\uff1a\n```cpp\nLL A = n - x + 1, B = n + x + 2;\nLL s0 = query(0, 1, 1, n, n - x + 2, x);\nLL s1 = query(1, 1, 1, n, n - x + 2, x);\nLL s2 = query(2, 1, 1, n, n - x + 2, x);\nret = (ret + (A * B % mod * s0 % mod - 2 * A * s1 % mod + mod) % mod * P % mod) % mod;\nLL S = n + 1, T = x - n - 1;\nret = (ret + (S * T % mod * s0 % mod + (S - T) * s1 % mod - s2 + mod * 2) % mod) % mod; //\u540c\u6837\u6ce8\u610f+mod*2\u3002\n```\n### 3. $i \\in [x+1,n]$\n\u5219\u6709\uff1a\n$$C_i=\\sum\\limits_{j=i-x+1}^imin(j+x-1,n)-i+1$$\n\u7ee7\u7eed\u5206\u7c7b\u8ba8\u8bba\uff1a\n\n(1) $j+x-1 \\le n$\n\n\u5219\u6709\uff1a\n$$C_i=\\sum\\limits_{j=i-x+1}^{n-x+1}j+x-i$$\n$$C_i=\\frac{1}{2}(n-i+1)(n-i+2)$$\n\n\u4ee4\uff1a$M=n+1$\uff0c$N=n+2$\u3002\u5219\u6709\uff1a\n$$C_i=\\frac{1}{2}[MN-(M+N)i+i^2]$$\n\n\u8fd9\u4e00\u90e8\u5206\u5bf9\u7b54\u6848\u7684\u8d21\u732e\uff1a\n$$\\sum\\limits_{i=x+1}^nC_ia_i$$\n$$=\\frac{1}{2}\\sum\\limits_{i=x+1}^nMNa_i-(M+N)ia_i+i^2a_i$$\n\n(2) $j>n-x+1$\uff0c\u5219\u6709\uff1a\n$$C_i=\\sum\\limits_{j=n-x+2}^in-i+1$$\n$$C_i=(i-n+x-1)(n-i+1)$$\n\u4ee4\uff1a$G=x-n-1$\uff0c$H=N+1$\uff0c\u5219\u6709\uff1a\n$$C_i=GH+(H-G)i-i^i$$\n\n\u8fd9\u4e00\u6bb5\u5bf9\u7b54\u6848\u7684\u8d21\u732e\uff1a\n$$\\sum\\limits_{i=x+1}^nC_ia_i$$\n$$=\\sum\\limits_{i=x+1}^nGHa_i+(H-G)ia_i-i^2a_i$$\n\n\u628a\u6574\u4e2a $3.$ \u7684\u4ee3\u7801\u653e\u4e00\u4e0b\uff1a\n```cpp\nif(x < n) {\n\tLL M = n + 1, N = n + 2;\n\tLL s0 = query(0, 1, 1, n, x + 1, n);\n\tLL s1 = query(1, 1, 1, n, x + 1, n);\n\tLL s2 = query(2, 1, 1, n, x + 1, n);\n\tret = (ret + (M * N % mod * s0 % mod - (M + N) * s1 % mod + s2 + mod) % mod * P % mod) % mod;\n\tLL G = x - n - 1, H = n + 1;\n\tret = (ret + (G * H % mod * s0 % mod + (H - G) * s1 % mod - s2 + mod * 2) % mod) % mod; //\u53c8\u662f\u6076\u5fc3\u7684+mod*2\u3002\n}\n```\n### **\u7ec8\u4e8e\u63a8\u5b8c\u5f0f\u5b50\u4e86\uff01**\n\n\u7b80\u5355\u8bb2\u4e00\u4e0b\u4ee3\u7801\u4e2d $P$ \u7684\u542b\u4e49\uff1a\n\n\u7531\u4e8e\u7b54\u6848\u8981\u5bf9 $p=10^9+7$ \uff08**\u8fd9\u662f\u4e2a\u8d28\u6570**\uff09\u53d6\u6a21\uff0c\u53c8\u56e0\u4e3a\u5f0f\u5b50\u4e2d\u542b\u6709\u5927\u91cf\u7684 $\\dfrac{1}{2}$\uff0c\u6240\u4ee5\u6211\u4eec\u8981\u8ba1\u7b97 $P=\\dfrac{1}{2} \\bmod p$\u7684\u503c\u3002\u663e\u7136\u53ef\u4ee5\u5957\u4e00\u4e0b[\u8d39\u9a6c\u5c0f\u5b9a\u7406](https://baike.so.com/doc/5743090-5955843.html)\u6765\u89e3\u51b3\u3002\n$$P=\\dfrac{1}{2} \\bmod p=2^{-1} \\bmod p=2^{p-2} \\bmod p$$\n\u5199\u4e2a\u5feb\u901f\u5e42\u5c31\u884c\u4e86\u3002\n\n\u4e8e\u662f\u4ee3\u7801\u5c31\u51fa\u6765\u4e86\uff1a\n```cpp\n#include <cstdio>\nusing namespace std;\n#define MAXN 200010\n#define mod 1000000007\n#define LL long long\nLL sp[3][MAXN << 2], lazy[MAXN << 2], sum[3][MAXN];\nLL n, m, P;\ninline LL pow(LL x, LL y) {\n\tLL ret = 1;\n\twhile(y) {\n\t\tif(y & 1) ret = ret * x % mod;\n\t\tx = x * x % mod;\n\t\ty >>= 1;\n\t}\n\treturn ret;\n}\ninline void swap(LL &x, LL &y) {\n\tx ^= y ^= x ^= y;\n}\ninline void up(LL p) {\n\tfor(LL i = 0; i < 3; i++)\n\t\tsp[i][p] = (sp[i][p << 1] + sp[i][p << 1 | 1]) % mod;\n}\ninline void build(LL p, LL l, LL r) {\n\tif(l == r) {\n\t\tscanf(\"%lld\", &sp[0][p]);\n\t\tsp[1][p] = sp[0][p] * l % mod;\n\t\tsp[2][p] = sp[0][p] * l % mod * l % mod;\n\t\treturn;\n\t}\n\tLL m = (l + r) >> 1;\n\tbuild(p << 1, l, m);\n\tbuild(p << 1 | 1, m + 1, r);\n\tup(p);\n}\ninline void down(LL p, LL l, LL r) {\n\tif(lazy[p]) {\n\t\tlazy[p << 1] = (lazy[p << 1] + lazy[p]) % mod;\n\t\tlazy[p << 1 | 1] = (lazy[p << 1 | 1] + lazy[p]) % mod;\n\t\tLL m = (l + r) >> 1;\n\t\tfor(LL i = 0; i < 3; i++) {\n\t\t\tsp[i][p << 1] = (sp[i][p << 1] + (sum[i][m] - sum[i][l - 1] + mod) % mod * lazy[p] % mod) % mod;\n\t\t\tsp[i][p << 1 | 1] = (sp[i][p << 1 | 1] + (sum[i][r] - sum[i][m] + mod) % mod * lazy[p] % mod) % mod;\n\t\t}\n\t\tlazy[p] = 0;\n\t}\n}\ninline void update(LL p, LL l, LL r, LL x, LL y, LL d) {\n\tif(x <= l && r <= y) {\n\t\tlazy[p] = (lazy[p] + d) % mod;\n\t\tfor(LL i = 0; i < 3; i++)\n\t\t\tsp[i][p] = (sp[i][p] + (sum[i][r] - sum[i][l - 1] + mod) % mod * d % mod) % mod;\n\t\treturn;\n\t}\n\tdown(p, l, r);\n\tLL m = (l + r) >> 1;\n\tif(x <= m) update(p << 1, l, m, x, y, d);\n\tif(y > m) update(p << 1 | 1, m + 1, r, x, y, d);\n\tup(p);\n}\ninline LL query(LL id, LL p, LL l, LL r, LL ql, LL qr) {\n\tif(ql <= l && r <= qr) return sp[id][p];\n\tdown(p, l, r);\n\tLL m = (l + r) >> 1, ret = 0;\n\tif(ql <= m) ret = (ret + query(id, p << 1, l, m, ql, qr)) % mod;\n\tif(qr > m) ret = (ret + query(id, p << 1 | 1, m + 1, r, ql, qr)) % mod;\n\treturn ret;\n}\ninline LL solve(LL x) {\n\tif(x == 0) return 0;\n\tLL ret = 0;\n\tif(x <= n - x + 1) {\n\t\tLL s1 = query(1, 1, 1, n, 1, x);\n\t\tLL s2 = query(2, 1, 1, n, 1, x);\n\t\tret = (ret + ((x << 1 | 1) * s1 % mod - s2 + mod) % mod * P % mod) % mod;\n\t\tif(x < n - x + 1) ret = (ret + query(0, 1, 1, n, x + 1, n - x + 1) * x % mod * (x + 1) % mod * P % mod) % mod;\n\t\tif(n - x + 2 <= n) {\n\t\t\tLL X = n + 1, Y = n + 2;\n\t\t\tLL s0 = query(0, 1, 1, n, n - x + 2, n);\n\t\t\tLL s1 = query(1, 1, 1, n, n - x + 2, n);\n\t\t\tLL s2 = query(2, 1, 1, n, n - x + 2, n);\n\t\t\tret = (ret + (X * Y % mod * s0 % mod - (X + Y) * s1 % mod + s2 + mod) % mod * P % mod) % mod;\n\t\t\tLL E = n + 1, F = x - n - 1;\n\t\t\tret = (ret + (E * F % mod * s0 % mod + (E - F) * s1 % mod - s2 + mod * 2) % mod) % mod;\n\t\t}\n\t}\n\telse {\n\t\tLL s1 = query(1, 1, 1, n, 1, n - x + 1);\n\t\tLL s2 = query(2, 1, 1, n, 1, n - x + 1);\n\t\tret = (ret + ((x << 1 | 1) * s1 % mod - s2 + mod) % mod * P % mod) % mod;\n\t\tLL A = n - x + 1, B = n + x + 2;\n\t\tLL s0 = query(0, 1, 1, n, n - x + 2, x);\n\t\ts1 = query(1, 1, 1, n, n - x + 2, x);\n\t\ts2 = query(2, 1, 1, n, n - x + 2, x);\n\t\tret = (ret + (A * B % mod * s0 % mod - 2 * A * s1 % mod + mod) % mod * P % mod) % mod;\n\t\tLL S = n + 1, T = x - n - 1;\n\t\tret = (ret + (S * T % mod * s0 % mod + (S - T) * s1 % mod - s2 + mod * 2) % mod) % mod;\n\t\tif(x < n) {\n\t\t\tLL M = n + 1, N = n + 2;\n\t\t\tLL s0 = query(0, 1, 1, n, x + 1, n);\n\t\t\tLL s1 = query(1, 1, 1, n, x + 1, n);\n\t\t\tLL s2 = query(2, 1, 1, n, x + 1, n);\n\t\t\tret = (ret + (M * N % mod * s0 % mod - (M + N) * s1 % mod + s2 + mod) % mod * P % mod) % mod;\n\t\t\tLL G = x - n - 1, H = n + 1;\n\t\t\tret = (ret + (G * H % mod * s0 % mod + (H - G) * s1 % mod - s2 + mod * 2) % mod) % mod;\n\t\t}\n\t}\n\treturn ret;\n}\nint main() {\n\tP = pow(2, mod - 2);\n\tscanf(\"%lld %lld\", &n, &m);\n\tfor(LL i = 1; i <= n; i++) {\n\t\tsum[0][i] = (sum[0][i - 1] + 1) % mod;\n\t\tsum[1][i] = (sum[1][i - 1] + i) % mod;\n\t\tsum[2][i] = (sum[2][i - 1] + i * i) % mod;\n\t}\n\tbuild(1, 1, n);\n\twhile(m--) {\n\t\tLL opt, l, r, x;\n\t\tscanf(\"%lld\", &opt);\n\t\tif(opt == 1) {\n\t\t\tscanf(\"%lld %lld %lld\", &l, &r, &x);\n\t\t\tif(l > r) swap(l, r);\n\t\t\tupdate(1, 1, n, l, r, x);\n\t\t}\n\t\telse {\n\t\t\tscanf(\"%lld %lld\", &l, &r);\n\t\t\tprintf(\"%lld\\n\", (solve(r) - solve(l - 1) + mod) % mod);\n\t\t}\n\t}\n\treturn 0;\n}\n```\n\u522b Ctrl+C/V \u554a\uff01\u8fd9\u4e2a\u662f $60$ \u5206\u7684\uff01TLE\uff01\n\n\u95ee\u9898\u51fa\u5728\u54ea\u91cc\u4e86\u5462\uff1f\n\n\u4e00\u65b9\u9762\uff0c\u5bf9\u540c\u4e00\u533a\u95f4\u5728\u4e09\u68f5\u7ebf\u6bb5\u6811\u4e2d\u5206\u522b\u6c42\u548c\uff0c\u5f88\u6d6a\u8d39\u65f6\u95f4\uff1b\u53e6\u4e00\u65b9\u9762\uff0c\u867d\u7136\u53e4\u8bdd\u8bf4**\u4e0d\u53d6\u6a21\u89c1\u7956\u5b97**\uff0c\u4f46\u662f\u8fd9\u6837\u75af\u72c2\u53d6\u6a21\u672a\u514d\u8fc7\u5206\u4e86\u70b9\uff1f\n\n\u6bd4\u5982\u8bf4\uff0c\u4ee5\u4e0b\u662f\u4ece $down$ \u51fd\u6570\u91cc\u9762\u6284\u6765\u7684\u4e00\u6761\u8bed\u53e5\uff1a\n```cpp\nsp[i][p << 1] = (sp[i][p << 1] + (sum[i][m] - sum[i][l - 1] + mod) % mod * lazy[p] % mod) % mod;\n```\n\u53ef\u4ee5\u6539\u6210\uff1a\n```cpp\nsp[i][p << 1] = (sp[i][p << 1] + (sum[i][m] - sum[i][l - 1] + mod) * lazy[p]) % mod;\n```\n\u4e00\u4e0b\u5b50\u5e72\u6389\u4e86 $2$ \u4e2a\u53d6\u6a21\uff01\n\n\u5bf9\u4e8e\u95ee\u9898 $1$\uff0c\u5176\u5b9e\u5f88\u597d\u89e3\u51b3\uff1a\u53ef\u4ee5\u8be2\u95ee\u4e00\u6b21\uff0c\u7528\u7ed3\u6784\u4f53\u8fd4\u56de $3$ \u4e2a\u548c\uff0c\u8fd9\u6837\u53ef\u4ee5\u5927\u5e45\u5ea6\u63d0\u901f\u3002\n\n\u4fee\u6539\u540e\u7684\u4ee3\u7801\u5982\u4e0b\uff08AC\uff0c\u6700\u5927\u6d4b\u8bd5\u70b9\u7ea6 $3.5s$\uff09\uff1a\n```cpp\n#include <cstdio>\nusing namespace std;\n#define MAXN 200010\n#define mod 1000000007\n#define LL long long\nstruct ans {\n\tLL s0, s1, s2;\n};\nLL sp[3][MAXN << 2], lazy[MAXN << 2], sum[3][MAXN];\nLL n, m, P;\ninline LL pow(LL x, LL y) {\n\tLL ret = 1;\n\twhile(y) {\n\t\tif(y & 1) ret = ret * x % mod;\n\t\tx = x * x % mod;\n\t\ty >>= 1;\n\t}\n\treturn ret;\n}\ninline void swap(LL &x, LL &y) {\n\tx ^= y ^= x ^= y;\n}\ninline void up(LL p) {\n\tfor(LL i = 0; i < 3; i++)\n\t\tsp[i][p] = (sp[i][p << 1] + sp[i][p << 1 | 1]) % mod;\n}\ninline void build(LL p, LL l, LL r) {\n\tif(l == r) {\n\t\tscanf(\"%lld\", &sp[0][p]);\n\t\tsp[1][p] = sp[0][p] * l % mod;\n\t\tsp[2][p] = sp[0][p] * l % mod * l % mod;\n\t\treturn;\n\t}\n\tLL m = (l + r) >> 1;\n\tbuild(p << 1, l, m);\n\tbuild(p << 1 | 1, m + 1, r);\n\tup(p);\n}\ninline void down(LL p, LL l, LL r) {\n\tif(lazy[p]) {\n\t\tlazy[p << 1] = (lazy[p << 1] + lazy[p]) % mod;\n\t\tlazy[p << 1 | 1] = (lazy[p << 1 | 1] + lazy[p]) % mod;\n\t\tLL m = (l + r) >> 1;\n\t\tfor(LL i = 0; i < 3; i++) {\n\t\t\tsp[i][p << 1] = (sp[i][p << 1] + (sum[i][m] - sum[i][l - 1] + mod) * lazy[p]) % mod;\n\t\t\tsp[i][p << 1 | 1] = (sp[i][p << 1 | 1] + (sum[i][r] - sum[i][m] + mod) * lazy[p]) % mod;\n\t\t}\n\t\tlazy[p] = 0;\n\t}\n}\ninline void update(LL p, LL l, LL r, LL x, LL y, LL d) {\n\tif(x <= l && r <= y) {\n\t\tlazy[p] = (lazy[p] + d) % mod;\n\t\tfor(LL i = 0; i < 3; i++)\n\t\t\tsp[i][p] = (sp[i][p] + (sum[i][r] - sum[i][l - 1] + mod) * d) % mod;\n\t\treturn;\n\t}\n\tdown(p, l, r);\n\tLL m = (l + r) >> 1;\n\tif(x <= m) update(p << 1, l, m, x, y, d);\n\tif(y > m) update(p << 1 | 1, m + 1, r, x, y, d);\n\tup(p);\n}\ninline ans query(LL p, LL l, LL r, LL ql, LL qr) {\n\tif(ql <= l && r <= qr) return (ans){sp[0][p], sp[1][p], sp[2][p]};\n\tdown(p, l, r);\n\tLL m = (l + r) >> 1, s0 = 0, s1 = 0, s2 = 0;\n\tif(ql <= m) {\n\t\tans now = query(p << 1, l, m, ql, qr);\n\t\ts0 += now.s0;\n\t\ts1 += now.s1;\n\t\ts2 += now.s2;\n\t}\n\tif(qr > m) {\n\t\tans now = query(p << 1 | 1, m + 1, r, ql, qr);\n\t\ts0 += now.s0;\n\t\ts1 += now.s1;\n\t\ts2 += now.s2;\n\t}\n\treturn (ans){s0 % mod, s1 % mod, s2 % mod};\n}\ninline LL solve(LL x) {\n\tif(x == 0) return 0;\n\tLL ret = 0;\n\tif(x <= n - x + 1) {\n\t\tans t1 = query(1, 1, n, 1, x);\n\t\tLL s1 = t1.s1, s2 = t1.s2;\n\t\tret = (ret + ((x << 1 | 1) * s1 % mod - s2 + mod) * P) % mod;\n\t\tif(x < n - x + 1) {\n\t\t\tans t2 = query(1, 1, n, x + 1, n - x + 1);\n\t\t\tret = (ret + t2.s0 * x % mod * (x + 1) % mod * P) % mod;\n\t\t}\n\t\tif(n - x + 2 <= n) {\n\t\t\tLL X = n + 1, Y = n + 2;\n\t\t\tans t3 = query(1, 1, n, n - x + 2, n);\n\t\t\tLL s0 = t3.s0, s1 = t3.s1, s2 = t3.s2;\n\t\t\tret = (ret + (X * Y % mod * s0 % mod - (X + Y) * s1 % mod + s2 + mod) % mod * P) % mod;\n\t\t\tLL E = n + 1, F = x - n - 1;\n\t\t\tret = (ret + E * F % mod * s0 % mod + (E - F) * s1 % mod - s2 + mod * 2) % mod;\n\t\t}\n\t}\n\telse {\n\t\tans t4 = query(1, 1, n, 1, n - x + 1);\n\t\tLL s1 = t4.s1, s2 = t4.s2;\n\t\tret = (ret + ((x << 1 | 1) * s1 % mod - s2 + mod) % mod * P) % mod;\n\t\tLL A = n - x + 1, B = n + x + 2;\n\t\tans t5 = query(1, 1, n, n - x + 2, x);\n\t\tLL s0 = t5.s0;\n\t\ts1 = t5.s1; s2 = t5.s2;\n\t\tret = (ret + (A * B % mod * s0 % mod - 2 * A * s1 % mod + mod) % mod * P) % mod;\n\t\tLL S = n + 1, T = x - n - 1;\n\t\tret = (ret + S * T % mod * s0 % mod + (S - T) * s1 % mod - s2 + mod * 2) % mod;\n\t\tif(x < n) {\n\t\t\tLL M = n + 1, N = n + 2;\n\t\t\tans t6 = query(1, 1, n, x + 1, n);\n\t\t\tLL s0 = t6.s0, s1 = t6.s1, s2 = t6.s2;\n\t\t\tret = (ret + (M * N % mod * s0 % mod - (M + N) * s1 % mod + s2 + mod) % mod * P) % mod;\n\t\t\tLL G = x - n - 1, H = n + 1;\n\t\t\tret = (ret + G * H % mod * s0 % mod + (H - G) * s1 % mod - s2 + mod * 2) % mod;\n\t\t}\n\t}\n\treturn ret;\n}\nint main() {\n\tP = pow(2, mod - 2);\n\tscanf(\"%lld %lld\", &n, &m);\n\tfor(LL i = 1; i <= n; i++) {\n\t\tsum[0][i] = (sum[0][i - 1] + 1) % mod;\n\t\tsum[1][i] = (sum[1][i - 1] + i) % mod;\n\t\tsum[2][i] = (sum[2][i - 1] + i * i) % mod;\n\t}\n\tbuild(1, 1, n);\n\twhile(m--) {\n\t\tLL opt, l, r, x;\n\t\tscanf(\"%lld\", &opt);\n\t\tif(opt == 1) {\n\t\t\tscanf(\"%lld %lld %lld\", &l, &r, &x);\n\t\t\tif(l > r) swap(l, r);\n\t\t\tupdate(1, 1, n, l, r, x);\n\t\t}\n\t\telse {\n\t\t\tscanf(\"%lld %lld\", &l, &r);\n\t\t\tprintf(\"%lld\\n\", (solve(r) - solve(l - 1) + mod) % mod);\n\t\t}\n\t}\n\treturn 0;\n}\n```\n\n~~\u8fd9\u4e0b\u53ef\u4ee5\u653e\u5fc3 Ctrl+C/V \u4e86\u3002~~\n\n\u590d\u5236\u7c98\u8d34\u6709\u610f\u601d\u5417\uff1f\n\n## \u603b\u7ed3\uff1a\n\n1. \u5bf9\u4e8e\u8fd9\u6837\u7684\u4e8c\u6b21\u6c42\u548c\u9898\uff0c\u4e00\u822c\u4ece**\u6bcf\u4e2a\u6570\u5bf9\u6700\u540e\u7b54\u6848\u7684\u8d21\u732e**\u8003\u8651\u3002\n1. \u5982\u679c\u9700\u8981\u5bf9\u540c\u4e00\u4e2a\u533a\u95f4\u8be2\u95ee\u591a\u6b21\uff0c\u53ef\u4ee5\u4eff\u7167\u6b64\u9898\uff0c**\u7528\u4e00\u4e2a\u7ed3\u6784\u4f53\u628a\u82e5\u5e72\u4e2a\u7b54\u6848\u4e00\u6b21\u7b97\u51fa\u6765**\u3002\n1. \u867d\u8bf4\u4e0d\u53d6\u6a21\u89c1\u7956\u5b97\uff0c\u4f46\u662f**\u8fdb\u884c\u65e0\u610f\u4e49\u7684\u53d6\u6a21\u4e5f\u4f1a\u62d6\u6162\u4ee3\u7801\u6548\u7387**\uff01\n1. \u5982\u679c\u6ca1\u6709\u8003\u8651 $u>v$ \u4f1a\u53ea\u5269\u4e0b $25$ \u5206\uff0c\u5982\u679c\u6ca1\u6709 $+mod \\times 2$ \u4e5f\u4f1a\u53ea\u5269\u4e0b $25$ \u5206\uff0c~~\u90fd\u6ca1\u8003\u8651\u5230\u8fd8\u5269\u591a\u5c11\u5206\uff1f~~\n\n**\u6700\u91cd\u8981\u7684\u4e00\u53e5\u8bdd\uff1a\u4ee3\u7801\u5199\u9519\u975e\u5b9e\u5f31\uff0c\u7ec6\u8282\u60f3\u5047\u6bc1\u4e00\u751f\uff01**\n\n### \u540e\u8bb0\uff1a\n\u672c\u849f\u84bb\u82b1\u4e86 $1.5days$ \u89e3\u51b3\u8fd9\u9053\u9898\u76ee\uff0c\u53c8\u82b1\u4e86 $1.5days$ \u5199\u8fd9\u7bc7\u9898\u89e3\uff0c\u5e0c\u671b\u5927\u5bb6\u80fd\u591f\u5927\u529b\u652f\u6301\uff0c\u4e5f\u6b22\u8fce\u5404\u4f4d\u63d0\u51fa\u5b9d\u8d35\u7684\u610f\u89c1\u548c\u5efa\u8bae\u3002\n\n~~\uff08\u8bdd\u8bf4\u4e3a\u4e86\u4e00\u9053\u9ed1\u9898\u63a8\u8fd9\u4e48\u591a\u5f0f\u5b50\u4e0d\u4e3a\u8fc7\u5427\uff09~~",
        "postTime": 1584446747,
        "uid": 95625,
        "name": "\u66b4\u529b\u51fa\u5947\u8ff9",
        "ccfLevel": 0,
        "title": "P4458 [BZOJ2018]\u94fe\u4e0a\u4e8c\u6b21\u6c42\u548c \u9898\u89e3"
    },
    {
        "content": "## P4458 \u94fe\u4e0a\u4e8c\u6b21\u6c42\u548c\n\n### \u524d\u8a00\n\n\u5c3d\u91cf\u505a\u5230\u4e00\u6c14\u5475\u6210\uff0c\u4f1a sigma \u7684\u5c0f\u5b66\u751f\u90fd\u80fd\u770b\u61c2\uff0c\u56e0\u4e3a\u771f\u7684\u5c31\u662f\u7ebf\u6bb5\u6811\u548c\u63a8\u5f0f\u5b50\u3002\n\n### \u89e3\u9898\u601d\u8def\n\n\u8bb0\u539f\u94fe\u8868\u4e3a $a$\uff0c\u4e00\u6b21\u524d\u7f00\u548c $S_a$ \u8bb0\u4e3a $S$\uff0c\u4e8c\u6b21\u524d\u7f00\u548c $S_{S_a}$ \u8bb0\u4e3a $SS$\u3002\n\n$\\begin{aligned}\n&\\sum\\limits_{k=l}^{r}\\sum\\limits_{i=k}^{n}\\sum\\limits_{j=i-k+1}^{i}a_j\n\\\\&=\\sum\\limits_{k=l}^{r}\\sum\\limits_{i=k}^{n}S_i-S_{i-k}\n\\\\&=\\sum\\limits_{k=l}^{r}(\\sum\\limits_{i=k}^{n}S_i-\\sum\\limits_{j=0}^{n-k}S_j)\n\\\\&=\\sum\\limits_{k=l}^{r}(SS_n-SS_{k-1}-SS_{n-k})\n\\\\&=(r-l+1)SS_n-\\sum\\limits_{k=l-1}^{r-1}SS_k-\\sum\\limits_{k=n-r}^{n-l}SS_k\n\\end{aligned}$\n\n\u6211\u4eec\u8981\u7ef4\u62a4 $\\sum\\limits_{k=l}^{r}SS_k$\uff0c\u652f\u6301\u533a\u95f4\u4fee\u6539\u3002\n\n\u5f53\u5bf9 $l\\sim r$ \u52a0\u4e0a $\\Delta$ \u65f6\uff0c\n\n\u5bf9\u4e8e $l\\le i\\le r$ \u7684 $i$\uff0c$SS_i$ \u52a0\u4e0a $\\frac{(i-l+1)(i-l+2)}{2}\\times\\Delta$\u3002\n\n\u5bf9\u4e8e $r< i\\le n$ \u7684 $i$\uff0c$SS_i$ \u52a0\u4e0a $\\frac{(r-l+1)(r-l+2)}{2}\\times\\Delta+(i-r)(r-l+1)\\times\\Delta$\u3002\n\n\u6700\u540e\u4e00\u70b9\uff0c```lazy``` \u6570\u7ec4\u53ef\u4ee5\u7528\u4e09\u4e2a\u6570 ```la,lb,lc``` \u4e09\u4e2a\u6570\u8868\u793a\uff0c\u4ee3\u8868 ```val[id]``` \u9700\u8981\u52a0\u4e0a $\\sum\\limits_ {i=l}^r{la\\times i^2+lb\\times i+lc}$\u3002\n\n\u76f8\u4fe1\u6ca1\u6709\u4ec0\u4e48\u7591\u95ee\u4e86\u5427\u3002\n\n### \u7ec6\u8282\n\n1. \u53ef\u80fd\u51fa\u73b0 $l>r$\u3002\n\n2. \u9664\u4ee5 $2$ \u548c $6$ \u5c31\u7b97\u51fa $2$ \u548c $6$ \u5728 $\\pmod{1000000007}$ \u4e0b\u7684\u9006\u5143\u5c31\u884c\u3002\n\n3. \u6ce8\u610f\u8d1f\u6570\u548c\u5404\u79cd\u5947\u602a\u7684\u6ea2\u51fa\u3002\n\n4. \u4e0d\u8981\u5199\u7740\u5199\u7740\u5fd8\u4e86\u5f0f\u5b50\uff0c\u575a\u5b9a\u4fe1\u5ff5\uff0c\u4e5f\u5c31\u4e00\u767e\u591a\u884c\u3002\n\n### \u4ee3\u7801\u90e8\u5206\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\nvoid file(string str){\n\tfreopen((str+\".in\").c_str(),\"r\",stdin);\n\tfreopen((str+\".out\").c_str(),\"w\",stdout);\n}\nconst int MAXN=200010;\nconst int mod=1e9+7,inv2=5e8+4,inv6=inv2/3;\nint n,m,init[MAXN],s[MAXN],ss[MAXN];\nint val[MAXN<<2],laa[MAXN<<2],lab[MAXN<<2],lac[MAXN<<2];\ninline int ad(int a,int b){return (a+b)%mod;}\ninline int add(int a,int b,int c=0,int d=0){return ad(ad(a,b),ad(c,d));}\ninline int mu(int a,int b){return 1ll*a*b%mod;}\ninline int mul(int a,int b,int c=1,int d=1){return mu(mu(a,b),mu(c,d));}\nint p1sum(int a){return mul(a,a+1,inv2);}\nint p2sum(int a){return mul(a,a+1,2*a+1,inv6);}\nint p1sum(int a,int b){return p1sum(b)-p1sum(a-1);}\nint p2sum(int a,int b){return p2sum(b)-p2sum(a-1);}\nvoid ___(int &a){a%=mod;if(a<0)a+=mod;}\nvoid pushup(int id){val[id]=add(val[id<<1],val[id<<1|1]);}\nvoid tag(int id,int l,int r,int la,int lb,int lc){\n\tval[id]=add(val[id],mul(la,p2sum(l,r)),mul(lb,p1sum(l,r)),mul(lc,r-l+1));\n\t___(val[id]);laa[id]=add(laa[id],la);lab[id]=add(lab[id],lb);lac[id]=add(lac[id],lc);\n}\nvoid pushdown(int id,int l,int r){\n\tif(laa[id]||lab[id]||lac[id]){\n\t\tint mid=(l+r)>>1;\n\t\ttag(id<<1,l,mid,laa[id],lab[id],lac[id]);\n\t\ttag(id<<1|1,mid+1,r,laa[id],lab[id],lac[id]);\n\t\tlaa[id]=lab[id]=lac[id]=0;\n\t}\n}\nvoid update(int id,int l,int r,int ql,int qr,int la,int lb,int lc){\n\tif(r<ql||l>qr)return;\n\tif(l>=ql&&r<=qr){tag(id,l,r,la,lb,lc);return;}\n\tint mid=(l+r)>>1;pushdown(id,l,r);\n\tupdate(id<<1,l,mid,ql,qr,la,lb,lc);\n\tupdate(id<<1|1,mid+1,r,ql,qr,la,lb,lc);\n\tpushup(id);\n}\nint query(int id,int l,int r,int ql,int qr){\n\tif(r<ql||l>qr)return 0;\n\tif(l>=ql&&r<=qr)return val[id];\n\tint mid=(l+r)>>1;pushdown(id,l,r);\n\treturn add(query(id<<1,l,mid,ql,qr),query(id<<1|1,mid+1,r,ql,qr));\n}\nvoid build(int id,int l,int r){\n\tif(l==r){val[id]=ss[l];return;}\n\tint mid=(l+r)>>1;\n\tbuild(id<<1,l,mid);build(id<<1|1,mid+1,r);pushup(id);\n}\nvoid UPDATE(int l,int r,int d){\n\tint inv2_d=mul(inv2,d);\n\tupdate(1,1,n,l,r,inv2_d,mul((mod+3-2*l),inv2_d),mul(l-1,l-2,inv2_d));\n\tint tmp1=mul(p1sum(r-l+1),d),tmp2=mul(r-l+1,d);\n\tif(r<n)update(1,1,n,r+1,n,0,tmp2,tmp1-mul(tmp2,r));\n}\nint QUERY(int l,int r){\n\tint res=mul(r-l+1,query(1,1,n,n,n));\n\tres-=query(1,1,n,l-1,r-1);res-=query(1,1,n,n-r,n-l);\n\t___(res);return res;\n}\nvoid initt(){\n\tscanf(\"%d%d\",&n,&m);\n\tfor(int i=1;i<=n;i++){\n\t\tscanf(\"%d\",&init[i]);\n\t\ts[i]=add(s[i-1],init[i]);ss[i]=add(ss[i-1],s[i]);\n\t}\n\tbuild(1,1,n);\n}\nint main(){\n\tinitt();\n\tfor(int i=1;i<=m;i++){\n\t\tint op,a,b,c;\n\t\tscanf(\"%d%d%d\",&op,&a,&b);\n\t\tif(op==1){scanf(\"%d\",&c);if(a>b)swap(a,b);UPDATE(a,b,c);}\n\t\telse printf(\"%d\\n\",QUERY(a,b));\n\t}\n\treturn 0;\n}\n\n```",
        "postTime": 1649644942,
        "uid": 225192,
        "name": "Raymondzll",
        "ccfLevel": 6,
        "title": "P4458\u9898\u89e3"
    },
    {
        "content": "\u8bdd\u8bf4\u51cc\u6668\u7ec8\u4e8e\u5361\u5b8c\u8fd9\u9053\u9898\u7684\u5e38\u6570\u7684\u65f6\u5019\u771f\u7684\u6709\u4e00\u80a1\u677e\u7237\u9644\u4f53\u7684\u611f\u89c9\u2026\u2026\n\n\u7b2c\u4e00\u6b21\u611f\u89c9\u5230\u4e86\u4fe1\u4ef0\u7684\u529b\u91cf\u2026\u2026\n\n\u53e6\u5916\u8fd9\u9053\u9898\u8bf4\u7684\u662f\u94fe\u52a0\uff0c\u5176\u5b9e\u5c31\u662f\u533a\u95f4\u52a0\uff0c\u4f46\u662f\u8981\u6ce8\u610f\u7684\u4e00\u70b9\u662f\u56e0\u4e3a\u662f\u552f\u4e00\u8def\u5f84\uff0c\u6240\u4ee5l\uff0cr\u53ef\u4ee5\u662f\u53cd\u7684\u2026\u2026\u5982\u679c\u4e00\u76f4\u5728WA\u53ef\u4ee5\u6ce8\u610f\u4e00\u4e0b\u2026\u2026\n_________________________\n\n# \u8fd9\u9053\u9898\u53ef\u4ee5\u4f7f\u7528\u6839\u53f7\u7b97\u6cd5\u901a\u8fc7\n\n## \u672c\u9898\u9898\u89e3\n\n\u8fd9\u9053\u9898\u4e4d\u4e00\u770b\u662f\u4e2a\u7ebf\u6bb5\u6811\u9898\u2026\u2026\uff0c\u56e0\u4e3a\u533a\u95f4\u52a0\u4ec0\u4e48\u7684\u672c\u6765\u5c31\u6709\u975e\u5e38\u597d\u7684\u6027\u8d28\u53ef\u4ee5\u8ba9\u6211\u4eec\u4f7f\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u5b83\uff0c\u4f46\u662f\u7531\u4e8e\u8be2\u95ee\u5341\u5206\u9b3c\u755c(\u6240\u6709\u957f\u5ea6\u5728l,r\u7684\u8fde\u7eed\u5b50\u6bb5\u548c\u7684\u548c)\uff0c\u56e0\u6b64\u6211\u4eec\u53d1\u73b0\u7ebf\u6bb5\u6811\u5e76\u4e0d\u662f\u975e\u5e38\u7684\u597d\u5904\u7406\u4fee\u6539\u548c\u8be2\u95ee\u7684\u5173\u7cfb\u2026\u2026\n\n\u4f46\u662f\u6ce8\u610f\u5230\u8be2\u95ee\u7684\u65f6\u5019\u603b\u662f\u8be2\u95ee\u4e86\u4e00\u6bb5\u8fde\u7eed\u7684\u957f\u5ea6\u533a\u95f4\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u628a\u6240\u6709\u7b54\u6848\u53d8\u6210\u4e00\u4e2a\u5e8f\u5217$\\{a\\}$,\u5176\u4e2d$a_{i}$\u8868\u793a\u957f\u5ea6\u6070\u597d\u4e3ai\u7684\u8fde\u7eed\u5b50\u6bb5\u548c\u7684\u548c\uff0c\u90a3\u4e48\u6211\u4eec\u7684\u8be2\u95ee\u64cd\u4f5c\u5c31\u53d8\u6210\u4e86\u8be2\u95eea\u5e8f\u5217\u7684\u533a\u95f4\u548c\uff0c\u6b64\u65f6\u6211\u4eec\u53d1\u73b0\u5728\u539f\u5e8f\u5217\u4e0a\u7684\u533a\u95f4\u52a0\u5c06\u4f1a\u5f15\u8d77a\u6570\u7ec4\u4e00\u7cfb\u5217\u590d\u6742\u7684\u53d8\u5316\u2026\u2026\uff0c\u8fd9\u6837\u7ebf\u6bb5\u6811\u5176\u5b9e\u5c31\u4e0d\u662f\u975e\u5e38\u7684\u597d\u505a\u4e86\n\n(\u60c5\u51b5\u5f00\u59cb\u53d8\u5f97\u8fa3\u624b)\n\n\u90a3\u4e48\u6b64\u65f6\u8ba9\u6211\u4eec\u6765\u60f3\u4e24\u4e2a\u5177\u6709\u542f\u53d1\u610f\u4e49\u7684$O(n^2)$\u66b4\u529b\n\n### \u66b4\u529b1\n\n\u5982\u679c\u6240\u6709\u8be2\u95ee\u5728\u4fee\u6539\u4e4b\u540e\u5462\uff1f\n\n\u901a\u8fc7\u5c06\u539f\u6570\u7ec4\u5dee\u5206\uff0c\u6211\u4eec\u53ef\u4ee5$O(1)$\u7684\u8bb0\u5f55\u4e0b\u6bcf\u4e2a\u4fee\u6539\n\n\u7136\u540e\u5728\u6240\u6709\u4fee\u6539\u7ed3\u675f\u4e4b\u540e\u6211\u4eec\u53ef\u4ee5$O(n)$\u7684\u5bf9\u5dee\u5206\u6570\u7ec4\u505a\u4e00\u904d\u524d\u7f00\u548c\u4ece\u800c\u8fd8\u539f\u51fa\u539f\u5e8f\u5217\uff0c\u6b64\u65f6\u6211\u4eec\u5e0c\u671b\u53ef\u4ee5\u5feb\u901f\u7684\u5904\u7406\u51fa\u7b54\u6848\u5e8f\u5217$a$\u8fd9\u6837\u7684\u8bdd\u6211\u4eec\u5c31\u53ef\u4ee5\u5bf9a\u6570\u7ec4\u505a\u4e00\u904d\u524d\u7f00\u548c\uff0c\u4ece\u800c$O(1)$\u7684\u56de\u7b54\u6bcf\u4e2a\u533a\u95f4\u8be2\u95ee\u4e86\n\n\u90a3\u4e48\u6211\u4eec\u66b4\u529b\u7684\u679a\u4e3e\u5de6\u7aef\u70b9\u6765\u6c42$a_{i}$\u5e94\u8be5\u53ef\u4ee5\u5f97\u5230\u8fd9\u6837\u4e00\u4e2a\u5f0f\u5b50,\u5176\u4e2dsum_{i}\u8868\u793a\u539f\u6570\u7ec4\u7684\u524d\u7f00\u548c\u6570\u7ec4\n\n## $a_{i}=\\sum_{j=0}^{n-i}sum_{j+i}-sum{j}$\n\n\u62c6\u5f00\u03a3\u53ef\u4ee5\u5f97\u5230\n\n## $a_{i}=\\sum_{j=i}^{n}sum_{j}-\\sum_{j=0}^{n-i}sum{j}$\n\n\u53d1\u73b0\u6211\u4eec\u5bf9\u524d\u7f00\u548c\u6570\u7ec4\u518d\u505a\u4e00\u904d\u524d\u7f00\u548c\u5c31\u53ef\u4ee5$O(1)$\u7684\u8ba1\u7b97\u51fa$a_{i}$\n\n\u6b64\u65f6\u6211\u4eec$O(n)$\u7684\u8ba1\u7b97\u51fa\u6240\u6709\u7684$a_{i}$\u5c31\u53ef\u4ee5$O(n)$\u7684\u8ba1\u7b97\u51fa$a_{i}$\u7684\u524d\u7f00\u548c\n\n\u7136\u540e\u6b64\u65f6\u6211\u4eec\u5c31\u53ef\u4ee5O(n)\u7684\u8ba1\u7b97\u51fa\u524d\u7f00\u548c\u4e86\uff0c\u7136\u540e$O(1)$\u56de\u7b54\u6bcf\u4e2a\u8be2\u95ee\u5373\u53ef\n\n\u5bf9\u4e8e\u6bcf\u4e2a\u4fee\u6539\u6211\u4eec\u90fd\u91cd\u590d\u4e00\u904d\u521a\u624d\u7684\u6d41\u7a0b\uff0c\u7b97\u6cd5\u590d\u6742\u5ea6$O(n^2)$\u663e\u7136\u4f1aT\u98de\n\n### \u66b4\u529b2\n\n\u5982\u679c\u4fee\u6539\u5f88\u5c11\u5462\uff1f\u5f53\u7136\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u521a\u624d\u7684\u7b97\u6cd5\uff0c\u4f46\u662f\u6211\u4eec\u6ce8\u610f\u5230\u8fd9\u91cc\u8fd8\u6709\u53e6\u5916\u4e00\u4e2a\u66b4\u529b\uff0c\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u6bcf\u4e00\u4e2a\u4fee\u6539\u5bf9\u5f53\u524d\u7684\u8d21\u732e\uff0c\u8fd9\u6837\u7684\u8bdd\u6211\u4eec\u5904\u7406\u4fee\u6539\u7684\u65f6\u5019\u66b4\u529b\u7684\u626b\u4e00\u904d\u4e4b\u524d\u7684\u6240\u6709\u7684\u4fee\u6539\uff0c\u7d2f\u52a0\u6240\u6709\u7684\u8d21\u732e\u5c31\u662f\u7b54\u6848\u4e86\n\n\u6211\u4eec\u5047\u8bbe\u5728\u539f\u6570\u7ec4\u7684\u67d0\u4e2a\u70b9i\u52a01\uff0c\u90a3\u4e48\u6211\u4eec\u89c2\u5bdf\u7b54\u6848\u6570\u7ec4a\u7684\u4e00\u4f4dj\u4f1a\u53d8\u5316\u591a\u5c11\n\n\u6211\u4eec\u4ee4$C_{i,j}$\u8868\u793a\u70b9i\u52a01\u7684\u65f6\u5019\u7b54\u6848\u6570\u7ec4\u7684\u7b2cj\u4f4d\u7684\u53d8\u5316\u91cf\n\n\u90a3\u4e48\u6211\u4eec\u628aC\u8fd9\u4e2a\u65b9\u9635\u6253\u51fa\u6765\u4e4b\u540e\u5927\u6982\u957f\u8fd9\u6837\n\n\n1 1 1 1 1 1 1\n\n1 2 2 2 2 2 1\n\n1 2 3 3 3 2 1\n\n1 2 3 4 4 3 1\n\n1 2 3 4 4 3 1\n\n1 2 3 3 3 3 1\n\n1 2 2 2 2 2 1\n\n1 1 1 1 1 1 1\n\n\u5927\u6982\u5c31\u662f\u6700\u5916\u8fb9\u4e00\u5708\u662f\u4e00\u57081\uff0c\u91cc\u9762\u662f\u4e00\u57082\uff0c\u518d\u91cc\u9762\u662f\u4e00\u57083\u2026\u2026\u8fd9\u6837\u7684\u89c4\u5f8b\n\n\u90a3\u4e48\u6211\u4eec\u8003\u8651\u6211\u4eec\u4e00\u4e2a\u4fee\u6539(l1,r1,delta)\u5bf9\u8be2\u95ee(l2,r2)\u7684\u8d21\u732e\u7684\u65f6\u5019\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u8fd9\u5176\u5b9e\u5c31\u662f\u6211\u4eec\u8fd9\u4e2aC\u77e9\u9635\u5728(l1,l2)(r1,r2)\u8fd9\u4e2a\u5b50\u77e9\u9635\u7684\u6743\u503c\u548c\u518d\u53bb\u4e58\u4e0a\u4e00\u4e2adelta\n\n\u611f\u6027\u7406\u89e3\u4ee5\u4e0b\u5c31\u662f\u6211\u4eec\u628a\u8fd9\u4e2a\u533a\u95f4\u52a0\u64cd\u4f5c\u770b\u6210\u5355\u70b9\u52a0\u7684\u96c6\u5408\uff0c\u7136\u540e\u8003\u8651\u6bcf\u4e00\u4e2a\u5355\u70b9\u52a0\u5bf9\u8fd9\u4e2a\u8be2\u95ee\u533a\u95f4\u7684\u8d21\u732e\uff0c\u7136\u540e\u53d1\u73b0\u8fd9\u5c31\u662f\u8fd9\u4e2a\u8d21\u732e\u77e9\u9635\u7684\u5b50\u77e9\u9635\u4e4b\u548c\u4e58\u4e0a\u4fee\u6539\u7684\u6743\u503cdelta\u4e86\n\n\u6240\u4ee5\u6211\u4eec\u4f1a\u81ea\u7136\u7684\u60f3\u5230\u8fd9\u6837\u4e00\u4e2a\u66b4\u529b\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u8be2\u95ee\uff0c\u6211\u4eec\u66b4\u529b\u7684\u8003\u8651\u5728\u5b83\u4e4b\u524d\u7684\u8be2\u95ee\u5bf9\u4ed6\u7684\u8d21\u732e\uff0c\u5bf9\u4e8e\u6700\u5f00\u59cb\u7684\u5e8f\u5217\uff0c\u6211\u4eec\u76f4\u63a5\u5904\u7406\u51fa\u9759\u6001\u7684\u89e3\n\n\u95ee\u9898\u6765\u4e86\uff0c\u6211\u4eec\u5982\u4f55$O(1)$\u7684\u6c42\u51fa\u8fd9\u4e2a\u7cfb\u6570\u77e9\u9635\u7684\u548c\u5462\uff1f\n\n\u6211\u4eec\u9996\u5148\u53d1\u73b0\u8fd9\u4e2a\u77e9\u9635\u662f\u4e2d\u5fc3\u5bf9\u79f0\u7684\uff0c\u56e0\u6b64\u53ef\u4ee5\u628a\u8fd9\u4e2a\u5b50\u77e9\u9635\u77e9\u9635\u5207\u62104\u5757\uff0c\u6bcf\u5757\u6309\u7167\u53f3\u4e0a\u89d2\u7684\u65b9\u9635\u7684\u5f62\u5f0f\u6765\u7b97\n\n\u90a3\u4e48\u95ee\u9898\u6765\u4e86\uff0c\u5982\u4f55\u5feb\u901f\u6c42\u51fa\u53f3\u4e0a\u89d2\u7684\u4e00\u4e2a\u5b50\u77e9\u9635\u7684\u548c\u5462\uff1f\n\n\u6211\u4eec\u53d1\u73b0\u8fd9\u4e2a\u5b50\u77e9\u9635\u7684\u548c\u5e76\u4e0d\u662f\u975e\u5e38\u7684\u597d\u7b97\uff0c\u56e0\u6b64\u6211\u4eec\u8003\u8651\u53ef\u4e0d\u53ef\u4ee5\u5feb\u901f\u7684\u6c42\u51fa\u8fd9\u4e2a1/4\u65b9\u9635\u7684\u4e8c\u7ef4\u524d\u7f00\u548c\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u5feb\u901f\u8ba1\u7b97\u51fa\u8fd9\u4e2a\u77e9\u9635\u7684\u5b50\u77e9\u9635\u548c\u4e86\n\n\u90a3\u4e48\u6211\u4eec\u4e0d\u59a8\u8bbe\u8fd9\u4e2a1/4\u65b9\u9635\u7684\u7b2cN\u884c\u7b2cM\u5217\u7684\u4e8c\u7ef4\u524d\u7f00\u548c\u4e3a$F_{N,M}$\uff0c\u65e2\u7136\u8981\u6c42\u4e8c\u4f4d\u524d\u7f00\u548c\u6211\u4eec\u5c31\u9700\u8981\u4e86\u89e3\u4e00\u4e0b\u7b2ci\u884c\u7b2cj\u5217\u7684\u5143\u7d20\u662f\u4ec0\u4e48\uff0c\u901a\u8fc7\u5927\u80c6\u63a8\u7ed3\u8bba\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u8fd9\u4e2a\u5143\u7d20\u5c31\u662fmin(i,j)\n\n\u6240\u4ee5\u6211\u4eec\u53d1\u73b0$F_{N,M}$\u5c31\u662f\n\n## $\\sum_{i=1}^{N}\\sum_{j=1}^{M}min(i,j)$\n\n\u6211\u4eec\u4e0d\u59a8\u8bbeM<N\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u628a\u5f0f\u5b50\u62c6\u6210\u8fd9\u4e2a\u6837\u5b50\n\n## $\\sum_{i=1}^{M}\\sum_{j=1}^{M}min(i,j)+\\sum_{i=M+1}^{N}\\sum_{j=1}^{M}min(i,j)$\n\n\u7136\u540e\u56e0\u4e3amin\u8fd0\u7b97\u5177\u6709\u7ed3\u5408\u5f8b\uff0c\u6211\u4eec\u53ef\u4ee5\u91c7\u53d6\u4e00\u4e2a\u975e\u5e38\u4f20\u7edf\u7684\u64cd\u4f5c\uff0c\u5c06\u7c7b\u4f3c\u4e8e\u65b9\u9635\u7684\u03a3\u5f62\u5f0f\u53ea\u7b97\u4e00\u4e2a\u4e09\u89d2\u90e8\u5206\u7136\u540e\u4e582\uff0c\u6700\u540e\u51cf\u53bb\u5bf9\u89d2\u7ebf\u90e8\u5206\uff0c\u8fd9\u6837\u6211\u4eec\u7684\u5f0f\u5b50\u5c31\u53d8\u6210\u4e86\u8fd9\u6837\n\n\n### $2\\sum_{i=1}^{M}\\sum_{j=1}^{i}min(i,j)-\\sum_{i=1}^{M}min(i,i)+\\sum_{i=M+1}^{N}\\sum_{j=1}^{M}min(i,j)$\n\n\u7136\u540e\u53d1\u73b03\u4e2a\u03a3\u5f53\u4e2d\u7684j\u5747\u5c0f\u4e8ei\uff0c\u6240\u4ee5min\u8fd0\u7b97\u5c31\u88ab\u6d88\u6389\u4e86\n\n## $2\\sum_{i=1}^{M}\\sum_{j=1}^{i}j-\\sum_{i=1}^{M}i+(N-M)\\sum_{j=1}^{M}j$\n\n\u7136\u540e\u6211\u4eec\u4ee4$F_{1}(i)=\\sum_{j=1}^{i}j$,$F_{2}(i)=\\sum_{j=1}^{i}F_{1}(j)$\n\u663e\u7136\u8fd9\u4e24\u4e2a\u51fd\u6570\u90fd\u662f\u975e\u5e38\u597d\u9884\u5904\u7406\u6216\u8005\u76f4\u63a5\u5229\u7528\u6570\u5b66\u516c\u5f0f\u8ba1\u7b97\u7684\n\n\u90a3\u4e48\u6211\u4eec\u53d1\u73b0\u6700\u540e$F(N,M)$\u662f\u8fd9\u6837\u7684\n\n## $F_(N,M)=2F_{2}(M)+(N-M-1)F_{1}(M)$\n\n\u81f3\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5$O(1)$\u7684\u8ba1\u7b97\u524d\u7f00\u548c\u4e86\uff0c\u56e0\u6b64\u6211\u4eec\u5c31\u53ef\u4ee5\u5728\u5e38\u6570\u4e8b\u4ef6\u5185\u5b8c\u6210\u8fd9\u4e2a\u6c42\u5b50\u77e9\u9635\u548c\u7684\u5de5\u4f5c\n\n\u4f46\u662f\u5230\u73b0\u5728\u4e3a\u6b62\uff0c\u6211\u4eec\u53ea\u662f\u6709\u4e24\u4e2a\u770b\u4f3c\u5e76\u65e0\u5375\u7528\u7684$O(n^2)$\u66b4\u529b\uff0c\u6240\u4ee5\u6211\u4eec\u63a5\u4e0b\u6765\u8981\u5982\u4f55\u4f18\u5316\u8fd9\u4e9b\u57fa\u672c\u5df2\u7ecf\u6ca1\u6709\u4f18\u5316\u7a7a\u95f4\u7684\u66b4\u529b\uff0c\u4ece\u800c\u8ba9\u6211\u4eec\u8fc7\u6389\u8fd9\u4e2a$N=2\u00d710^5,m'<10^5,m<5\u00d710^5$\u7684\u9b3c\u755c\u6570\u636e\u5462\uff1f\n\n## \u5b9a\u671f\u91cd\u6784\n\n\u5bf9\uff0c\u6211\u4eec\u76f4\u63a5\u7528\u66b4\u529b\u6765\u4f18\u5316\u66b4\u529b\uff0c\u5f53\u4e00\u9053\u9898\u6709\u4e24\u4e2a\u4e0d\u540c\u7684$O(n^2)$\u66b4\u529b\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5c06\u8fd9\u4e24\u4e2a\u66b4\u529b\u7ed3\u5408\u5230\u4e00\u8d77\u6765\u521b\u9020\u4e00\u4e2a\u4f18\u79c0\u7684$O(n\\sqrt{n})$\u7684\u66b4\u529b\u7b97\u6cd5\n\n\u6211\u4eec\u53d1\u73b0\u8fd9\u9053\u9898\u7684\u4fee\u6539\u64cd\u4f5c\u5e76\u4e0d\u662f\u975e\u5e38\u7684\u591a\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u5dee\u5206\u6570\u7ec4$O(1)$\u7684\u8bb0\u5f55\u4e0b\u6bcf\u4e00\u4e2a\u4fee\u6539\uff0c\u540c\u65f6\u5c06\u5b83\u4eec\u60f0\u6027\u7684push\u5230\u4e00\u4e2a\u6808\u5f53\u4e2d\uff0c\u6bcf\u6b21\u8be2\u95ee\u7684\u65f6\u5019\u5148\u4f7f\u7528\u7b54\u6848\u6570\u7ec4\u5f97\u5230\u4e00\u4e2a\u9759\u6001\u7684\u89e3\uff0c\u7136\u540e\u66b4\u529b\u7684\u626b\u4e00\u904d\u8fd9\u4e2a\u6808\uff0c\u67e5\u8be2\u6bcf\u4e2a\u4fee\u6539\u5bf9\u8be2\u95ee\u7684\u8d21\u732e\uff0c\u5982\u679c\u5728\u4e00\u6b21\u8be2\u95ee\u5f00\u59cb\u524d\uff0c\u53d1\u73b0\u6211\u4eec\u5df2\u7ecf\u505a\u4e86\u8d85\u8fc7275\u6b21\u64cd\u4f5c\uff0c\u90a3\u4e48\u6e05\u7a7a\u6574\u4e2a\u6808\uff0c\u76f4\u63a5\u66b4\u529b\u91cd\u6784\u8fd9\u4e2a\u6570\u7ec4\n\n\u542c\u8d77\u6765\u8fd9\u4e2a\u4e1c\u897f\u975e\u5e38\u7684\u66b4\u529b\uff0c\u6211\u4eec\u51b7\u9759\u5206\u6790\u4e00\u6ce2\u590d\u6742\u5ea6\uff0c\u4f1a\u53d1\u73b0\u8fd9\u4e2a\u7b97\u6cd5\u7684\u590d\u6742\u5ea6\u5927\u6982\u662f $O(363n+275(m-m')+m')$\u7684\uff0c\u7136\u540e\u5206\u6790\u5230\u8fd9\u91cc\u6211\u4eec\u4e5f\u4e0d\u4f1a\u89c9\u5f97\u8fd9\u4e2a\u7b97\u6cd5\u53ef\u4ee5\u901a\u8fc7\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u7b97\u6cd5\u5b9e\u5728\u662f\u592a\u50cf\u4e00\u4e2a\u9ad8\u5206\u66b4\u529b\u4e86\uff0c\u7136\u800c\u5176\u5b9e\u5b83\u5c31\u662f\u4e00\u4e2a\u9ad8\u5206\u66b4\u529b\uff0c\u4f46\u662f\u95ee\u9898\u662f\u8fd9\u9053\u9898\u7684\u6b63\u89e3\u7684\u5e38\u6570\u4e5f\u4e0d\u5c0f\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u5e38\u6570\u8fd9\u70b9\u6765\u6210\u529f\u7684\u5361\u8fc7\u53bb\n\n\u6240\u4ee5\u4e0b\u9762\u8981\u4ecb\u7ecd\u7684\u90e8\u5206\u624d\u662f\u8fd9\u7bc7\u4e71\u641eAC\u9898\u89e3\u7684\u91cd\u70b9\uff0c\u5361\u5e38\u6570\uff01\n\n## \u5361\u5e38\u6570\n\n\u5148\u89e3\u91ca\u4e00\u4e0b\u4e3a\u4ec0\u4e48\u4e0d\u662f\u6bcf\u6839\u53f7m'(\u5373316)\u6b21\u91cd\u6784\u4e00\u6b21\uff0c\u800c\u662f\u91c7\u7528\u4e86275\u8fd9\u4e2a\u504f\u5c0f\u7684\u6570\uff0c\u53e6\u5916200\u4e5f\u53ef\u4ee5\uff0c\u4f46\u662f\u5341\u5206\u7384\u5b66\u7684250\u5e76\u4e0d\u884c\n\n\u56e0\u4e3a\u6211\u4eec\u4ed4\u7ec6\u89c2\u5bdf\u4e00\u4e0b\u6211\u4eec\u8003\u8651\u8be2\u95ee\u5bf9\u4fee\u6539\u7684\u8d21\u732e\u8fd9\u4e2a\u5730\u65b9\u7684\u5e38\u6570\uff0c\u4f1a\u53d1\u73b0\u662f\u5927\u4e8e\u6211\u4eec\u91cd\u6784\u7684\u590d\u6742\u5ea6\u7684\uff0c\u56e0\u6b64\u6211\u4eec\u53ea\u80fd\u5c3d\u91cf\u591a\u7684\u91cd\u6784\uff0c\u5177\u4f53\u6765\u8bb2\u5c31\u662f\u503e\u659c\u4e00\u4e0b\u6211\u4eec\u7684\u91cd\u6784\u5e38\u6570\uff0c\u4f7f\u5f97\u7b97\u6cd5\u5411\u591a\u91cd\u6784\u8fd9\u4e2a\u65b9\u5411\u503e\u659c\n\n\u7136\u540e\u6211\u4eec\u52a0\u4e0a\u4e86\u8fd9\u4e2a\u4f2a\u4f18\u5316\uff0c\u53d1\u73b0\u8fd8\u662ft\uff0c\u4e8b\u5b9e\u4e0a\u8fd9\u4e2a\u65f6\u5019\u4e00\u822c\u4f1a\u6709\u4e00\u4e2a\u975e\u5e38\u5927\u7684\u5e38\u6570\u51fa\u5728\u53d6\u819c\u8fd0\u7b97\u4e0a\uff0c\u56e0\u6b64\u6211\u4eec\u53bb\u6389\u4e86\u91cd\u6784\u51fd\u6570\u4e2d\u7b2c\u4e00\u6b21\u8ba1\u7b97ans\u503c\u7684\u53d6\u819c\u8fd0\u7b97\n\n\u4ee5\u53ca\u67e5\u8be2\u5b50\u77e9\u9635\u51fd\u6570\u7684\u53d6\u819c\u8fd0\u7b97\u4ec5\u505a\u4e00\u6b21\uff0c\u53e6\u5916\u6211\u4eec\u8ba1\u7b97\u4e8c\u7ef4\u524d\u7f00\u548c\u7684\u65f6\u5019\u4ec5\u4ec5\u5728\u4f7f\u7528\u51cf\u6cd5\u7684\u65f6\u5019\u624d\u8fdb\u884c\u53d6\u819c\u64cd\u4f5c\uff0c\u8fd9\u6837\u7684\u8bdd\u4e00\u6b21\u8be2\u95ee\u6700\u591a\u8fdb\u884c9\u6b21\u53d6\u6a21\u64cd\u4f5c\uff0c\u800c\u539f\u6765\u662f21\u6b21\uff0c\u8fd9\u4e2a\u65f6\u5019\u6211\u4eec\u7684\u5e38\u6570\u5c31\u4e0d\u662f\u975e\u5e38\u5927\u4e86\uff0c\u53ef\u4ee5\u57283600ms\u5de6\u53f3\u7684\u65f6\u95f4\u901a\u8fc7\u672c\u9898\n\n\u5f53\u7136\u4e86\u8fd9\u4e2a\u5199\u6cd5\u6709\u4e00\u4e2a\u597d\u5904\u5c31\u662f\u4ee3\u7801\u590d\u6742\u5ea6\u6781\u4f4e\uff0c\u5168\u7a0b\u4e0d\u9700\u8981\u4efb\u4f55\u6570\u636e\u7ed3\u6784\u505a\u652f\u6301\uff0c\u53ea\u9700\u8981\u51e0\u4e2a\u7b80\u5355\u7684\u51fd\u6570\u5c31\u53ef\u4ee5\u5b8c\u6210\u5b9e\u73b0\u4e86\n\n\u4e0a\u4ee3\u7801~\n\n```C\n#include<cstdio>\n#include<algorithm>\n#include<cmath>\nusing namespace std;const int N=2*1e5+10;typedef unsigned long long ll;\nconst ll mod=1e9+7;const int M=200;ll del[N];ll sum[N];ll ans[N];int n;int m;//\u8fd9\u91cc\u7684M\u91c7\u7528\u4e86200\nint ml[N];int mr[N];ll val[N];ll f1[N];ll f2[N];int tp;int mid;\ninline void rebuild()//\u91cd\u6784\u51fd\u6570\uff0c\u5bf9\u5dee\u5206\u6570\u7ec4\u505a3\u904d\u524d\u7f00\u548c\uff0c\u6784\u9020ans\n{\n    for(int i=1;i<=n;i++)sum[i]=(sum[i-1]+del[i])%mod;\n    for(int i=1;i<=n;i++)(sum[i]+=sum[i-1])%=mod;\n    for(int i=1;i<=n;i++)(sum[i]+=sum[i-1])%=mod;//\u7701\u4e86\u4e00\u4e2a\u53d6\u819c\n    for(int i=1;i<=n;i++)ans[i]=sum[n]+mod-sum[i-1]+mod-sum[n-i];\n    for(int i=1;i<=n;i++)(ans[i]+=ans[i-1])%=mod;\n}\ninline ll sqrs(int a,int b)//\u67e5\u8be2\u4e8c\u7ef4\u524d\u7f00\u548c\n{if(a<b)swap(a,b);return (a==b)?2*f2[b]+mod-f1[b]:2*f2[b]+(a-b-1)*f1[b];}\ninline ll subquery(int xl,int xr,int dl,int dr)//1/4\u77e9\u9635\u67e5\u8be2\uff0c\u4f18\u5316\u4e24\u4e2a\u53d6\u819c\n{return sqrs(xl,dl)+sqrs(xr,dr)+mod-sqrs(xr,dl)%mod+mod-sqrs(xl,dr)%mod;}\ninline ll query(int xl,int xr,int dl,int dr)//\u77e9\u9635\u67e5\u8be2\uff0c\u5207\u62104\u4efd\n{\n\t//\u51cf\u5c11\u4e864\u6b21\u53d6\u819c\u8fd0\u7b97\n    ll ret=0;int cxl=n-max(xl,mid);int cxr=min(xr,mid);\n    int cdl=n-max(dl,mid);int cdr=min(dr,mid);\n    if(xl<=mid&&dl<=mid)ret+=subquery(xl,cxr,dl,cdr);\n    if(xl<=mid&&mid<dr)ret+=subquery(xl,cxr,n-dr,cdl);\n    if(mid<xr&&dl<=mid)ret+=subquery(n-xr,cxl,dl,cdr);\n    if(mid<xr&&mid<dr)ret+=subquery(n-xr,cxl,n-dr,cdl);\n    return ret%mod;\n}\nint main()\n{\n    scanf(\"%d%d\",&n,&m);\n    for(int i=1;i<=n;i++)f1[i]=(f1[i-1]+i)%mod;//\u9884\u5904\u7406f\u6570\u7ec4\u51cf\u5c11\u5e38\u6570\n    for(int i=1;i<=n;i++)f2[i]=(f2[i-1]+f1[i])%mod;\n    for(int i=1;i<=n;i++)scanf(\"%lld\",&del[i]);\n    for(int i=n;i>=1;i--)(del[i]+=mod-del[i-1])%mod;\n    rebuild();mid=n/2;\n    for(int i=1,t,l,r;i<=m;i++)\n    {\n        scanf(\"%d\",&t);\n        if(t==1)//\u60f0\u6027\u7684\u52a0\u5165\u5230\u6808\u4e2d\n        {\n            ++tp;scanf(\"%d%d%lld\",&ml[tp],&mr[tp],&val[tp]);\n            if(ml[tp]>mr[tp]){swap(ml[tp],mr[tp]);}//\u6ce8\u610f\u5224\u6389\u8fd9\u79cd\u60c5\u51b5\n            (del[ml[tp]]+=val[tp])%=mod;(del[mr[tp]+1]+=mod-val[tp])%=mod;//\u4f7f\u7528\u5dee\u5206\u6570\u7ec4\u8bb0\u5f55\u4fee\u6539\n        }\n        else\n        {\n            int l;int r;ll ret=0;scanf(\"%d%d\",&l,&r);//\u5148\u5904\u7406\u51fa\u9759\u6001\u7684\u89e3\n            if(tp>=M){tp=0;rebuild();}ret=(ans[r]+mod-ans[l-1])%mod;\n            for(int i=1;i<=tp;i++)(ret+=val[i]*query(ml[i]-1,mr[i],l-1,r))%=mod;//\u66b4\u529b\u8003\u8651\u4fee\u6539\u5bf9\u8be2\u95ee\u7684\u8d21\u732e\n            printf(\"%lld\\n\",ret);\n        }\n    }return 0;//\u62dc\u62dc\u7a0b\u5e8f~\n}\n\n```\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
        "postTime": 1525916979,
        "uid": 56384,
        "name": "shadowice1984",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P4458 \u3010[BJOI2018]\u94fe\u4e0a\u4e8c\u6b21\u6c42\u548c\u3011"
    },
    {
        "content": "\u4e00\u9053\u633a\u597d\u7684\u6570\u636e\u7ed3\u6784\u9898\u3002  \n\u5148\u7528\u6570\u5b66\u5f0f\u5b50\u628a\u9898\u76ee\u91cc\u8981\u6c42\u7684\u7b54\u6848\u8868\u793a\u51fa\u6765\uff0c\u8bbe$S_i=\\sum_{j=1}^{i}a_j$\uff1a\n$$\\text{ans}=\\sum_{i=l}^{r}\\sum_{j=i}^{n}S_j-S_{j-i}$$\n$$\\text{ans=}\\sum_{j=l}^{r}(\\sum_{j=i}^{n}S_j-\\sum_{j=0}^{n-i}S_j)$$\n\u7136\u540e\u8bbe$SS_i=\\sum_{j=1}^{i}S_i$  \n\u4e8e\u662f\n$$\\text{ans}=\\sum_{j=l}^{r}(SS_n-SS_{i-1}-SS_{n-i})$$\n$$\\text{ans}=(r-l+1)SS_{n}-\\sum_{i=l-1}^{r-1}SS_i-\\sum_{i=n-r}^{n-l}SS_i$$\n\u8fd9\u4e2a\u4e1c\u897f\u53ef\u4ee5\u76f4\u63a5\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\uff0c\u590d\u6742\u5ea6\u4e00\u4e2a$\\text{log}$\uff0c\u63a5\u7740\u8003\u8651\u4fee\u6539\u3002  \n\u5982\u679c\u4fee\u6539\u7684\u533a\u95f4\u662f$[l,r,d]$\u7684\u8bdd\uff0c\u90a3\u4e48\u5b83\u5bf9$SS_i(i\\in [1,n])$\u7684\u5f71\u54cd\u5c31\u662f\uff1a   \n$1:i\\in[1,l)$\uff0c\u65e0\u5f71\u54cd\u3002  \n$2:i\\in[l,r]$\uff0c\u56e0\u4e3a$a_i(i\\in[l,r])$\u589e\u52a0\u4e86$\\text{d}$\uff0c\u6240\u4ee5$S_i(i\\in[l,r])$\u76f8\u5f53\u4e8e\u589e\u52a0\u4e86$i-l+1$\u4e2a$\\text{d}$\uff0c\u6240\u4ee5$SS_i$\u5c31\u589e\u52a0\u4e86$\\sum_{j=1}^{i}d*(j-l+1)$  \n$3:i \\in(r,n]$\uff0c\u6211\u4eec\u53ef\u4ee5\u60f3\u8c61\u4e00\u4e0b\uff0c\u5728$>d$\u4e4b\u540e$SS_i$\u7684\u589e\u52a0\u5c31\u56fa\u5b9a\u4e86\uff0c\u6240\u4ee5\u518d\u52a0\u4e0a\u524d\u9762\u7684\u8d21\u732e\u5c31\u662f$\\sum_{j=l}^{r}d*(j-l+1)+(i-r)*d*(r-l+1)$  \n\u7136\u540e\u53ef\u4ee5\u628a\u8fd9\u4e24\u4e2a\u5f0f\u5b50\u5316\u6210\u4e00\u4e2a\u5173\u4e8e$i$\u7684\u4e8c\u6b21\u51fd\u6570\u5f62\u5f0f\uff08\u8fd9\u4e00\u6b65\u4e0a\u4e86\u5c0f\u5b66\u7684\u4eba\u5e94\u8be5\u90fd\u4f1a\uff0c\u8fd9\u91cc\u5c31\u7565\u53bb\u4e86\uff09\uff0c\u53ef\u4ee5\u5728\u7ebf\u6bb5\u6811\u4e0a\u7ef4\u62a4\u8fd9\u4e2a\u4e8c\u6b21\u51fd\u6570\u7684$\\text{a,b,c}$\u503c\uff0c\u8fd9\u9053\u9898\u5c31\u505a\u5b8c\u4e86\u3002   \n\u6240\u4ee5\u9664\u4e86\u4ee3\u7801\u7ec6\u8282\u591a\u591a\u591a\u591a\u591a\u591a\u591a\u591a\u4e4b\u5916\u4e5f\u6ca1\u6709\u4ec0\u4e48\u7279\u522b\u6076\u5fc3\u7684\u5730\u65b9\u3002\uff08\u987a\u4fbf\u63d0\u4e2a\u9192\uff0c\u8fd9\u9898\u7684\u5c51\u6570\u636e\u8fd8\u4f1a\u51fa\u73b0$l>r$\uff0c\u8981\u5224\u6389\uff09\u3002  \n### My Code\n```cpp\n#include <bits/stdc++.h> \n\ntypedef long long ll;\nconst int mod = 1e9 + 7;\nconst int inv2 = 5e8 + 4;\nconst int N = 2e5 + 10;\nint n, m, i, j, k;  \nint s[N], ss[N], sum[N << 2], a[N];\nint sa[N << 2], sb[N << 2], sc[N << 2];\ninline int add(int a, int b) { ll c = a + b; if (c < 0) c += mod; return c >= mod ? c - mod : c; }\nstruct tag {\n  int a, b, c; \n  tag() { a = b = c = 0; } \n  tag(int _a, int _b, int _c) { a = _a, b = _b, c = _c; }\n  inline void init() {\n    a = add(a, 0);\n    b = add(b, 0);\n    c = add(c, 0);\n  }\n} laz[N << 2], mdy;\ninline void down(int u, tag t) { \n  int a = t.a, b = t.b, c = t.c;\n  sum[u] = add(add(add(sum[u], 1ll * a * sa[u] % mod), 1ll * b * sb[u] % mod), 1ll * sc[u] * c % mod);  \n  laz[u].a = add(laz[u].a, a); \n  laz[u].b = add(laz[u].b, b);\n  laz[u].c = add(laz[u].c, c);  \n}\ninline void push_down(int u) {\n  if (laz[u].a || laz[u].b || laz[u].c) {\n    down(u << 1, laz[u]);\n    down(u << 1 | 1, laz[u]);\n    laz[u] = tag(0, 0, 0);\n  }\n}\nvoid build(int l, int r, int u) {\n  if (l == r) {\n    sum[u] = ss[l], sc[u] = 1, sb[u] = l, sa[u] = 1ll * l * l % mod;\n    return;\n  }\n  int mid = (l + r) >> 1;\n  build(l, mid, u << 1);\n  build(mid + 1, r, u << 1 | 1);\n  sum[u] = add(sum[u << 1], sum[u << 1 | 1]);\n  sa[u] = add(sa[u << 1], sa[u << 1 | 1]);\n  sb[u] = add(sb[u << 1], sb[u << 1 | 1]);\n  sc[u] = add(sc[u << 1], sc[u << 1 | 1]);\n  return;\n}\nvoid modify(int ml, int mr, int l, int r, int u) {\n  if (ml <= l && r <= mr) { down(u, mdy); return; }\n  int mid = (l + r) >> 1;\n  push_down(u);    \n  if (ml <= mid) modify(ml, mr, l, mid, u << 1);\n  if (mid < mr)  modify(ml, mr, mid + 1, r, u << 1 | 1);\n  sum[u] = add(sum[u << 1], sum[u << 1 | 1]); \n}\nint query(int ql, int qr, int l, int r, int u) {    \n  if (ql > qr) return 0; if (ql > r || qr < l) return 0;  \n  if (ql <= l && r <= qr) return sum[u];\n  push_down(u);\n  int mid = (l + r) >> 1, res = 0;\n  if (ql <= mid) res = add(res, query(ql, qr, l, mid, u << 1));\n  if (mid < qr)  res = add(res, query(ql, qr, mid + 1, r, u << 1 | 1));\n  return res;\n}\n\nint main() {\n scanf(\"%d %d\", &n, &m);\n  for (int i = 1; i <= n; i++) scanf(\"%d\", a + i), s[i] = add(s[i - 1], a[i]), ss[i] = add(ss[i - 1], s[i]);\n  build(1, n, 1);\n  for (int i = 1, opt, l, r, z; i <= m; i++) {\n    scanf(\"%d %d %d\", &opt, &l, &r);\n    if (l > r) std::swap(l, r);  \n    if (opt == 1) {\n      scanf(\"%d\", &z); int len = r - l + 1, a = (ll)z * inv2 % mod;\n      mdy = tag(a, (ll)a * (3 - 2 * l + mod) % mod,((ll)l * l - 3 * l + 2) % mod * a % mod);\n      modify(l, r, 1, n, 1);   \n      if (r == n) continue;\n      mdy = tag(0, (ll)len * z % mod, ((ll)len * (len + 1) / 2 % mod * z % mod - (ll)len * r % mod * z % mod + mod) % mod);\n      modify(r + 1, n, 1, n, 1);      \n    } else {\n      int len = r - l + 1;\n      ll ans = ((ll)len * query(n, n, 1, n, 1) % mod - query(std::max(l - 1, 1), r - 1, 1, n, 1) + mod - query(std::max(n - r, 1), n - l, 1, n, 1) + mod) % mod;\n      printf(\"%lld\\n\", ans);      \n    }\n  }\n  return 0;\n}\n```\n",
        "postTime": 1578796144,
        "uid": 114320,
        "name": "\u843d\u6c50",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P4458 \u3010[BJOI2018]\u94fe\u4e0a\u4e8c\u6b21\u6c42\u548c\u3011"
    },
    {
        "content": "[\u539f\u9898\u94fe\u63a5](https://www.luogu.com.cn/problem/P4458)\n\n>\u9898\u610f\uff1a  \n\u7ef4\u62a4\u4e00\u4e2a\u5e8f\u5217\uff0c\u652f\u6301\u533a\u95f4\u52a0\uff0c  \n\u4ee5\u53ca\u67e5\u8be2\u6240\u6709\u957f\u5ea6\u5728 $[l,r]$ \u8303\u56f4\u5185\u7684\u5b50\u533a\u95f4\u6743\u503c\u548c \u4e4b\u548c\u3002\n\n\u7531\u4e8e\u662f\u533a\u95f4\u52a0\uff0c\u5bb9\u6613\u60f3\u5230\u5dee\u5206\uff0c\u8bbe $\\displaystyle a_i=\\sum\\limits_{j=1}^it_j$\u3002\n\n\u518d\u8bbe $\\displaystyle A_1(m)=\\sum\\limits_{i=1}^ma_i\\ ,A2(m)=\\sum\\limits_{i=1}^mA1(i)\\ ,A3(m)=\\sum\\limits_{i=1}^mA2(i)$\u3002\n\n\u628a\u67e5\u8be2\u7684\u4e1c\u897f\u5199\u51fa\u6765\uff0c\u679a\u4e3e\u957f\u5ea6\uff0c\u8d77\u59cb\u4f4d\u7f6e\uff1a\n\n$$\\sum\\limits_{k=l}^r\\ \\sum\\limits_{i=1}^{n-k+1}\\ \\sum\\limits_{j=i}^{i+k-1}a_j=\\sum\\limits_{k=l}^r\\ \\sum\\limits_{i=1}^{n-k+1}A_1(i+k-1)-A_1(i-1)$$\n$$=\\sum\\limits_{k=l}^r\\ \\sum\\limits_{i=k}^nA_1(i)-\\sum\\limits_{k=l}^r\\sum\\limits_{i=0}^{n-k}A_1(i)=\\sum\\limits_{k=l}^rA_2(n)-A_2(k-1)-A_2(n-k)$$\n$$=(r-l+1)A_2(n)-A_3(r-1)+A_3(l-2)-A_3(n-l)+A_3(n-r-1)$$\n\n\u8fd9\u5c31\u662f\u8bf4\uff0c\u53ea\u9700\u8981\u80fd\u5b9e\u65f6\u6c42\u51fa $A_3(i)$ \u4e0e $A_2(i)$\uff0c\u95ee\u9898\u5c31\u80fd\u8f7b\u677e\u89e3\u51b3\u3002\n\n\u4f46\u7531\u4e8e\u7ef4\u62a4\u7684\u53ea\u662f\u4e2a\u5dee\u5206\u6570\u7ec4\uff0c\u7ef4\u62a4 $A_2(i)$ \u4e0e $A_3(i)$ \u5c31\u76f8\u5f53\u4e8e\u7ef4\u62a4 $3$ \u9636\u524d\u7f00\u548c\u4ee5\u53ca $4$ \u9636\u524d\u7f00\u548c\u3002\n\n\u7136\u540e\u53ef\u4ee5\u624b\u63a8\u4e00\u4e0b\u5f0f\u5b50\uff08\u53ea\u9700\u4ea4\u6362\u4e00\u4e0b\u6c42\u548c\u987a\u5e8f\uff0c\u7136\u540e\u5927\u91cf\u7684\u8fd0\u7b97\uff09\uff1a\n\n\u8bbe $\\displaystyle S_x(m)=\\sum\\limits_{i=1}^mi^xt_i$\n\n$$\\sum\\limits_{i=1}^{m}\\sum\\limits_{j=1}^{i}\\sum\\limits_{k=1}^{j}t_k=\\dfrac{1}{2}\\Big((m+1)(m+2)S_{0}(m)-(2m+3)S_1(m)+S_2(m)\\Big)$$\n\n$$\\sum\\limits_{i=1}^{m}\\sum\\limits_{j=1}^{i}\\sum\\limits_{k=1}^{j}\\sum\\limits_{r=1}^{k}t_r=\\dfrac{1}{6}\\Big((m+1)(m+2)(m+3)S_0(m)-(3m^2+12m+11)S_1(m)+(3m+6)S_2(m)-S_3(m)\\Big)$$\n\n\u800c\u5173\u4e8e $S_x(m)$ \u7684\u7ef4\u62a4\uff0c\u6811\u72b6\u6570\u7ec4\u662f\u5341\u5206\u4fbf\u6377\u7684\u3002\n\n\u7136\u540e\u5c31\u53ef\u4ee5\u8fc7\u4e86\u8fd9\u9898\uff1a[\u4ee3\u7801](https://www.luogu.com.cn/paste/1bfv6e19)\u3002\n\n\u4f46\u4e0d\u5e94\u4ec5\u4ec5\u6b62\u6b65\u4e8e\u6b64\uff0c\u4e0a\u9762\u7684 $3$ \u9636\u524d\u7f00\u548c\u4e0e $4$ \u9636\u524d\u7f00\u548c\u90fd\u6709\u4e00\u4e2a\u89c4\u5f8b\uff1a\n\n+ \u6700\u521d\u62ec\u53f7\u5916\u7684\u7cfb\u6570\u662f\u9636\u4e58\u5f62\u5f0f\u3002\n+ $S0(m)$ \u7684\u7cfb\u6570\u90fd\u662f $m+1$ \u7684\u4e00\u4e2a\u4e0a\u5347\u5e42\uff0c\u7b26\u53f7\u4e3a\u6b63\u3002\n+ $S1(m)$ \u7684\u7cfb\u6570\u90fd\u662f $S0(m)$ \u7684\u7cfb\u6570\u4e0d\u770b\u4e00\u9879\u6c42\u548c\u5f97\u5230\uff0c\u7b26\u53f7\u4e3a\u8d1f\u3002\n+ $S2(m)$ \u7684\u7cfb\u6570\u90fd\u662f $S0(m)$ \u7684\u7cfb\u6570\u4e0d\u770b\u4e24\u9879\u6c42\u548c\u5f97\u5230\uff0c\u7b26\u53f7\u4e3a\u6b63\u3002\n\n$\\dots$\n\n\u4e8e\u662f\u5c1d\u8bd5\u8bc1\u660e\u4e00\u4e2a\u5173\u4e8e $k+1$ \u9636\u524d\u7f00\u548c\u7684\u5f0f\u5b50\uff1a\n\n$$\\sum\\limits_{i_1=0}^n\\sum_{i_2=0}^{i_1}\\dots\\sum_{i_{k+1}=0}^{i_k}t_{i_{k+1}}=\\dfrac{1}{k!}\\sum\\limits_{j=0}^{k}(-1)^jS_j(n)\\dfrac{\\mathrm{d}^j (n+1)^{\\overline{k}}}{\\mathrm{d}^j n}\\dfrac{1}{j!}$$\n\n\u540e\u9762\u90a3\u4e2a $\\displaystyle \\dfrac{\\mathrm{d}^j(n+1)^{\\overline{k}}}{\\mathrm{d}^jn}\\dfrac{1}{j!}$ \u5c31\u76f8\u5f53\u4e8e $(n+1)^{\\overline{k}}$ \u4e0d\u770b $j$ \u9879\u540e\u6c42\u548c\u3002\n\n$\\text{Prove:}$\n\n$$\\dfrac{1}{k!}\\sum\\limits_{j=0}^{k}(-1)^jS_j(n)\\dfrac{\\mathrm{d}^j (n+1)^{\\overline{k}}}{\\mathrm{d}^j n}\\dfrac{1}{j!}$$\n$$=\\dfrac{1}{k!}\\sum\\limits_{j=0}^{k}\\dfrac{(-1)^j}{j!}\\sum\\limits_{r=0}^{n}r^jt_r\\sum\n\\limits_{s}\\left[\\begin{matrix}k\\\\s\\end{matrix}\\right]\\dfrac{\\mathrm{d}^j(n+1)^s}{\\mathrm{d}^jn}$$\n$$=\\dfrac{1}{k!}\\sum_{j=0}^{k}\\dfrac{(-1)^j}{j!}\\sum\\limits_{r=0}^{n}r^jt_r\\sum\\limits_{s}\\left[\\begin{matrix}k\\\\s\\end{matrix}\\right]s^{\\underline{j}}(n+1)^{s-j}$$\n$$=\\dfrac{1}{k!}\\sum\\limits_{r=0}^{n}t_r\\sum\\limits_{s}\\left[\\begin{matrix}k\\\\s\\end{matrix}\\right](n+1)^{s}\\sum\\limits_{j=0}^{k}\\binom{s}{j}(-r)^j(n+1)^{-j}$$\n$$=\\dfrac{1}{k!}\\sum\\limits_{r=0}^{n}t_r\\sum\\limits_{s}\\left[\\begin{matrix}k\\\\s\\end{matrix}\\right](n+1-r)^s$$\n$$=\\dfrac{1}{k!}\\sum_{r=0}^nt_r(n+1-r)^{\\overline{k}}$$\n$$=\\sum\\limits_{r=0}^{n}\\binom{n+k-r}{k}t_r$$\n\n\u8bbe $\\ \\displaystyle\\sum_{n\\geq 0}t_nx^n=T(x)$\uff0c\u5219\u6709\uff1a\n$$\\sum\\limits_{n\\geq 0}x^n\\sum\\limits_{r=0}^n\\binom{n+k-r}{k}t_r=T(x)\\sum\\limits_{n\\geq 0}\\binom{n+k}{k}x^n=\\dfrac{1}{(1-x)^{k+1}}T(x)$$\n\u6700\u540e\u7684\u5f0f\u5b50\u5c31\u662f $T(x)$ \u7684 $k+1$ \u9636\u524d\u7f00\u548c\u3002\n\n\u4e8e\u662f\u5bf9\u4e8e $k$ \u9636\u52a8\u6001\u7684\u524d\u7f00\u548c\uff0c\u7ef4\u62a4 $k$ \u4e2a\u6811\u72b6\u6570\u7ec4\u5c31\u80fd\u5728 $O(k\\log n)$ \u7684\u65f6\u95f4\u5185\u5355\u6b21\u5904\u7406\u8be2\u95ee\u4e0e\u4fee\u6539\uff0c\u590d\u6742\u5ea6\u4f18\u5f02\u3002",
        "postTime": 1637732666,
        "uid": 334380,
        "name": "Y_B_X",
        "ccfLevel": 7,
        "title": "\u9898\u89e3[P4458 \u94fe\u4e0a\u4e8c\u6b21\u6c42\u548c]"
    },
    {
        "content": "\u8fd9\u9898\u786e\u5b9e\u662f\u9053\u597d\u9898\uff08~~\u6211\u60f3\u4e86\u4e09\u4e2a\u665a\u4e0a~~\uff09\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u5199\u51fa\u4e00\u4e2a\u7cfb\u6570\u77e9\u9635\uff0c\u5176\u4e2d\u7b2ci\u884c\u7b2cj\u5217\u4e3a\u7b2cj\u4e2a\u7ed3\u70b9\u5bf9\u957f\u5ea6\u4e3ai\u7684\u94fe\u7684\u8d21\u732e\u3002\n\nn==5\u65f6\u77e9\u9635\u5982\u4e0b\uff1a\n\n||||||\n|:--:||:--:||:--:||:--:||:--:|\n| 1 | 1 | 1 | 1 | 1 |\n| 1 |2 |2 | 2 | 1 |\n| 1 | 2 | 3 | 2 | 1 |\n| 1 | 2 | 2 | 2 | 1 |\n| 1 | 1 | 1 | 1 | 1 |\n\n\u7136\u540e\u6211\u5c31\u8054\u60f3\u5230\u4e86\u70b9\u5230\u77e9\u9635\u4e2d\u5fc3\u7684\u5207\u6bd4\u96ea\u592b\u8ddd\u79bb\uff08\u5176\u5b9e\u548c\u5b83\u5e76\u6ca1\u6709\u4ec0\u4e48\u5173\u7cfb\uff09\uff0c~~\u53c8\u8054\u60f3\u5230\u4e86\u8f6c\u4e3a\u66fc\u54c8\u987f\u8ddd\u79bb~~\u3002\n\n**\u505a\u6cd51**\uff1a\u6211\u4eec\u53ef\u4ee5O(1)\u8ba1\u7b97\u7cfb\u6570\u77e9\u9635\u7684\u5b50\u77e9\u9635\u548c\u7136\u540eO((m-m')(m'+n))\u8ba1\u7b97\u6bcf\u4e2a\u4fee\u6539\u5bf9\u67e5\u8be2\u7684\u8d21\u732e\uff1b\n\n**\u505a\u6cd52**\uff1a\u4f7f\u7528\u4e8c\u7ef4\u7ebf\u6bb5\u6811\u7ef4\u62a4\uff08\u4f1a\u7206\u7a7a\u95f4\uff09\uff1b\n\n**\u505a\u6cd53**\uff1a\u4f7f\u7528vector\u5b58\u50a8lazy\u6807\u8bb0\uff0c\u53ef\u53c2\u8003[R6883986 \u8bc4\u6d4b\u8be6\u60c5](https://www.luogu.org/record/show?rid=6883986)\uff0c\u6700\u540e\u56e0\u4e3athrow std::bad_alloc\u800cRE;\n\n**\u6211\u7684AC\u505a\u6cd5\uff08\u975e\u6b63\u89e3\uff09**\uff1a\n\n\u9996\u5148\uff0c\u6211\u4eec\u53d1\u73b0\u8fd9\u4e2a\u77e9\u9635\u662f**\u4e2d\u5fc3\u5bf9\u79f0**\u7684\u3002\u6240\u4ee5\u53ef\u4ee5\u628a\u5b83\u5207\u6210\u56db\u4e2a\u5b50\u77e9\u9635\uff0c\u5e76\u628a\u6bcf\u4e2a\u77e9\u9635\u76841\u65cb\u8f6c\u5230\u5de6\u4e0a\u89d2\uff0c\u8fd9\u6837\u53ea\u8981\u5bf9\u4e8e\u6bcf\u4e2a\u77e9\u9635\u8fdb\u884c\u76f8\u540c\u7684\u64cd\u4f5c\u5373\u53ef\u3002\n\n\u6211\u4eec\u76f4\u63a5\u7ef4\u62a4\u6240\u6709\u957f\u5ea6\u4e3ai\u7684\u94fe\u7684\u6743\u503c\u548c\u4e4b\u548c\uff0cquery\u4e0e\u666e\u901a\u7ebf\u6bb5\u6811\u76f8\u540c\u3002\n\n\u4e0b\u8868\u662f\u4e00\u4e2a\u5206\u5272\u540e\u7684\u77e9\u9635\uff0c\u5176\u6743\u503c\u4ece\u5de6\u4e0a\u5230\u53f3\u4e0b\u9012\u589e\uff1a\n\n||||||\n|:--:||:--:||:--:||:--:||:--:|\n| 1 | 1 | 1 | 1 | 1 |\n| 1 |2 |2 | 2 | 2 |\n| 1 | 2 | 3 | 3 | 3 |\n| 1 | 2 | 3 | 4 | 4 |\n| 1 | 2 | 3 | 4 | 5 |\n\n\u4fee\u6539l~r\u610f\u5473\u7740\u5c06\u7b2cl\u5217\u81f3\u7b2cr\u5217\u7684\u6240\u6709\u6570+d***\u6bcf\u4e2a\u4f4d\u7f6e\u7684\u7cfb\u6570**\n\n\u4e3a\u4e86\u7b80\u4fbf\uff0c\u53ef\u628a$[l,r]+=d$\u8f6c\u6362\u4e3a$[1,l-1]-=d,[1,r]+=d$\n\n\u8003\u8651\u77e9\u9635\u6240\u6709\u884c\u524d$x$\u5217\u7cfb\u6570\u548c\u4e4b\u5dee\uff0c\u53ef\u4ee5\u53d1\u73b0\u5bf9\u4e8e\u524di\u884c\uff0c\u7cfb\u6570\u548c\u4e4b\u5dee\u6bcf\u589e\u52a0\u4e00\u884c\u5c31\u4f1a\u51cf\u5c111\uff0c\u4e4b\u540e\u6bcf\u884c\u7684\u7cfb\u6570\u548c\u76f8\u7b49\u3002\n\n\u636e\u6b64\u53ef\u4ee5\u63a8\u51fa\u7b2c$n$\u884c\u524d$x$\u5217\u7cfb\u6570\u548c\uff1a\n\n$c[n]=\\sum_{i=1}^{min(n,x)}x+1-i$\n\n\u5c55\u5f00\u540e\u5f97\n\n$c[n]=\\begin{cases}n(x+\\frac{1}{2})-\\frac{1}{2}n^2,\\quad n\\leq x\\\\x(x+1), \\quad n>x\\end{cases}$\n\n\u5bf9\u4e8e\u5e38\u6570\u9879\uff0c\u4e00\u6b21\u9879\uff0c\u4e8c\u6b21\u9879\uff0c\u90fd\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u5373\u53ef\u3002\n\n\u6700\u540e\u9644\u4e0a\u5e38\u6570\u8d85\u5927\u7684\u4ee3\u7801\uff0828900ms,\u4f30\u8ba1\u662f\u521d\u59cb\u5316\u65f6\u4f7f\u7528modify\u4ee3\u66ffbuild\u7684\u7f18\u6545\uff09\n\n```cpp\n#include <cstdio>\n#include <algorithm>\n#include <cstring>\nint read(){\n    int res=0,c;\n    do c=getchar();\n    while(c<'0'||c>'9');\n    while('0'<=c&&c<='9'){\n        res=res*10+c-'0';\n        c=getchar();\n    }\n    return res;\n}\nconst int size=100005,mod=1000000007;\nconst long long inv2=500000004;\nstruct Block{\n    int bx,ex,by,ey,siz;\n    int sum[size<<2],lazy[size<<2][3],weight1[size<<2],weight2[size<<2];\n    Block(){\n        memset(sum,0,sizeof(sum));\n        memset(lazy,0,sizeof(lazy));\n    }\n    #define ls l,m,id<<1\n    #define rs m+1,r,id<<1|1\n    void pre(int l,int r,int id){\n    \tif(l==r){\n    \t\tweight1[id]=l;\n    \t\tweight2[id]=static_cast<long long>(l)*l%mod;\n    \t}\n    \telse{\n    \t\tint m=(l+r)>>1;\n    \t\tpre(ls);\n    \t\tpre(rs);\n    \t\tweight1[id]=(weight1[id<<1]+weight1[id<<1|1])%mod;\n    \t\tweight2[id]=(weight2[id<<1]+weight2[id<<1|1])%mod;\n    \t}\n    }\n    void color0(int l,int r,int id,int val){\n    \tsum[id]=(sum[id]+static_cast<long long>(r-l+1)*val)%mod;\n        lazy[id][0]=(lazy[id][0]+val)%mod;\n    }\n    void color1(int l,int r,int id,int val){\n    \tsum[id]=(sum[id]+static_cast<long long>(weight1[id])*val)%mod;\n        lazy[id][1]=(lazy[id][1]+val)%mod;\n    }\n    void color2(int l,int r,int id,int val){\n        sum[id]=(sum[id]+static_cast<long long>(weight2[id])*val)%mod;\n        lazy[id][2]=(lazy[id][2]+val)%mod;\n    }\n    void push(int l,int r,int m,int id){\n        if(lazy[id][0]){\n            color0(ls,lazy[id][0]);\n            color0(rs,lazy[id][0]);\n            lazy[id][0]=0;\n        }\n        if(lazy[id][1]){\n            color1(ls,lazy[id][1]);\n            color1(rs,lazy[id][1]);\n            lazy[id][1]=0;\n        }\n        if(lazy[id][2]){\n            color2(ls,lazy[id][2]);\n            color2(rs,lazy[id][2]);\n            lazy[id][2]=0;\n        }\n    }\n    int query(int l,int r,int id,int nl,int nr){\n        if(nl<=l && r<=nr)return sum[id];\n        else{\n            int m=(l+r)>>1;\n            push(l,r,m,id);\n            int res=0;\n            if(nl<=m)res+=query(ls,nl,nr);\n            if(m<nr)res+=query(rs,nl,nr);\n            return res%mod;\n        }\n    }\n    void modify0(int l,int r,int id,int p,int val){\n    \tif(p<=l)color0(l,r,id,val);\n        else{\n            int m=(l+r)>>1;\n            push(l,r,m,id);\n            if(p<=m)modify0(ls,p,val);\n            modify0(rs,p,val);\n            sum[id]=(sum[id<<1]+sum[id<<1|1])%mod;\n        }\n    }\n    void modify1(int l,int r,int id,int p,int val){\n    \tif(r<=p)color1(l,r,id,val);\n        else{\n            int m=(l+r)>>1;\n            push(l,r,m,id);\n            modify1(ls,p,val);\n            if(m<p)modify1(rs,p,val);\n            sum[id]=(sum[id<<1]+sum[id<<1|1])%mod;\n        }\n    }\n    void modify2(int l,int r,int id,int p,int val){\n        if(r<=p)color2(l,r,id,val);\n        else{\n            int m=(l+r)>>1;\n            push(l,r,m,id);\n            modify2(ls,p,val);\n            if(m<p)modify2(rs,p,val);\n            sum[id]=(sum[id<<1]+sum[id<<1|1])%mod;\n        }\n    }\n    void doModifyImpl(int p,int val){\n    \tmodify1(1,siz,1,p,val*(p+1-inv2)%mod);\n    \tmodify2(1,siz,1,p,-val*inv2%mod);\n    \tif(p+1<=ey-by+1)modify0(1,siz,1,p+1,(static_cast<long long>(p)*(p+1)>>1)%mod*val%mod);\n    }\n    void doModify(int l,int r,int val){\n        doModifyImpl(r,val);\n    \tif(l-1)doModifyImpl(l-1,-val);\n    }\n    int doQuery(int l,int r){\n        return query(1,siz,1,l,r);\n    }\n} T[2][2];\nvoid doModify(int n,int l,int r,int val){\n    for(int i=0;i<2;++i){\n        for(int j=0;j<2;++j){\n            int ibx=std::max(l,T[i][j].bx);\n            int iex=std::min(r,T[i][j].ex);\n            if(ibx<=iex)\n                T[i][j].doModify(i?n-iex+1:ibx,i?n-ibx+1:iex,val);\n        }\n    }\n}\nint doQuery(int n,int l,int r){\n    int res=0;\n    for(int i=0;i<2;++i){\n        for(int j=0;j<2;++j){\n            int iby=std::max(l,T[i][j].by);\n            int iey=std::min(r,T[i][j].ey);\n            if(iby<=iey)\n                res=(res+T[i][j].doQuery(j?n-iey+1:iby,j?n-iby+1:iey))%mod;\n        }\n    }\n    return (res+mod)%mod;\n}\nint main(){\n    int n=read();\n    int mid=(n+1)>>1;\n    for(int i=0;i<2;++i)\n        for(int j=0;j<2;++j){\n            T[i][j].bx=(i?mid+1:1);\n            T[i][j].ex=(i?n:mid);\n            T[i][j].by=(j?mid+1:1);\n            T[i][j].ey=(j?n:mid);\n            T[i][j].siz=T[i][j].ey-T[i][j].by+1;\n            T[i][j].pre(1,T[i][j].siz,1);\n        }\n    int m=read();\n    for(int i=1;i<=n;++i)\n        doModify(n,i,i,read());\n    for(int i=0;i<m;++i){\n        int op=read();\n        int l=read();\n        int r=read();\n        if(op==1){\n            if(l>r)std::swap(l,r);\n            int d=read();\n            doModify(n,l,r,d);\n        }\n        else printf(\"%d\\n\",doQuery(n,l,r));\t\n    }\n    return 0;\n}\n\n```\n",
        "postTime": 1524227782,
        "uid": 25170,
        "name": "dtcxzyw",
        "ccfLevel": 0,
        "title": "P4458 [BJOI2018]\u94fe\u4e0a\u4e8c\u6b21\u6c42\u548c \u9898\u89e3"
    },
    {
        "content": "- \u611f\u8c22[\u5946\u4f6c](https://www.luogu.com.cn/user/371852)\uff0c[\u5946\u4f6c](https://www.luogu.com.cn/user/58705)\uff0c[\u5946\u4f6c](https://www.luogu.com.cn/user/283913)\u7684\u63d0\u9192\uff0c\u795d\u613f\u5176\u4fe1\u606f\u5b66\u4e4b\u8def\u5149\u8292\u7480\u74a8\u3002\n- \u6709\u540c\u5fd7\u89c9\u5f97\u8fd9\u6837\u505a\u5e76\u6ca1\u6709\u5fc5\u8981\uff0c\u4e0d\u8fc7\u6211\u5176\u5b9e\u53ea\u662f\u60f3\u589e\u52a0\u5bf9\u5dee\u5206\u4e0e\u524d\u7f00\u548c\u7684\u4e86\u89e3\u800c\u5df2\uff0c\u611a\u8822\u7684\u4e8b\u60c5\uff0c\u6211\u65e9\u5df2\u505a\u8fc7\u5f88\u591a\uff0c\u4e0d\u5fc5\u6015\u591a\u8fd9\u4e00\u3002\n\n**qwq 1**\n- \u6811\u72b6\u6570\u7ec4\u7ef4\u62a4\u5355\u70b9\u4fee\u6539\uff0c\u6c42 $k$ \u9636\u524d\u7f00\u548c\u3002\n- \u8bbe $f(n)$ \u7684 $k$ \u9636\u524d\u7f00\u548c\u4e3a $\\sigma^kf(n)$\u3002\n$$\\sigma^kf(n)=\\sum_{i=0}C(k+i-1,k-1)f(n-i)$$\n- \u5bb9\u6613\u6839\u636e\u7ec4\u5408\u610f\u4e49\uff08\u6216\u63a8\u5f0f\u5b50\uff09\u5f52\u7eb3\u8bc1\u660e\uff0c\u4f60\u4f1a\u53d1\u73b0 $C(k+i-1,k-1)$ \u662f\u4e00\u4e2a\u5173\u4e8e $i$ \u7684 $k$ \u6b21\u591a\u9879\u5f0f\uff0c\u76f4\u63a5\u4ee3\u5165\u6362\u6210 $C(k-(n-i)+n-1,k-1)$\uff0c\u7136\u540e\u4f60\u53d1\u73b0\u5b83\u4e5f\u662f\u4e00\u4e2a\u5173\u4e8e $n-i$ \u7684\u591a\u9879\u5f0f\uff0c\u4e14\u5bf9\u4e8e\u5355\u72ec\u7684 $n$\uff0c\u5404\u9879\u7cfb\u6570\u56fa\u5b9a\uff0c\u4e14\u6211\u4eec\u53ef\u4ee5\u4e00\u5f00\u59cb $O(nk^2)$ \u9884\u5904\u7406\u5404\u9879\u7cfb\u6570\u3002\n- \u90a3\u4e48\u73b0\u5728\u6211\u4eec\u7684\u4efb\u52a1\u53ea\u5269\u4e0b\u5206\u522b\u7ef4\u62a4 $n^if(n)$ \u7684\u524d\u7f00\u548c\u4e86\u5bf9\u5427\uff0c\u5f3a\u884c\u6811\u72b6\u6570\u7ec4\u5206\u522b\u7ef4\u62a4\u5373\u53ef\uff0c\u603b\u7684\u590d\u6742\u5ea6\u5e94\u8be5\u662f $O(nk^2+qk\\log n)$\uff0c[\u4ee3\u7801\u5b9e\u73b0](https://www.luogu.com.cn/paste/lva6iyhq)\u3002~~\u4e0d\u5982\u6839\u53f7~~\u3002\n\n**qwq 2**\n- \u7ef4\u62a4\u5355\u70b9\u4fee\u6539\uff0c\u6c42 $k$ \u9636\u5dee\u5206\u3002\n- \u8bbe $f(n)$ \u7684 $k$ \u9636\u5dee\u5206\u4e3a $\\delta^kf(n)$\u3002\n$$\\delta^kf(n)=\\sum_{i=0}C(k,i)(-1)^{k-i}f(n+i)$$\n- \u8fd9\u73a9\u610f\u4f60\u8981\u6811\u72b6\u6570\u7ec4\uff1f\u76f4\u63a5\u66b4\u529b\u66f4\u65b0\u590d\u6742\u5ea6\u5c31\u6709 $O(nk+qk)$\uff0c\u76f4\u63a5\u7565\u53bb\u3002\n\n**qwq 3**\n- \u7528\u591a\u9879\u5f0f\u4f3c\u4e4e\u53ef\u4ee5\u5feb\u901f\u6c42\u51fa\u4e00\u4e2a\u6570\u7ec4\u7684 $k$ \u9636\u5dee\u5206\u6216\u524d\u7f00\u548c\uff08\u5728 $k$ \u5f88\u5927\u65f6\uff09\uff0c~~\u539f\u56e0\u5df2\u7ecf\u88ab\u4f60\u770b\u5230\u4e86~~\u3002\n\n**[\u6c34\u9898](https://www.luogu.com.cn/problem/P4458)**\n- \u4e0d\u77e5\u9053\u600e\u4e48\u53d8\u9ed1\u7684\uff0c\u505a\u5b8c\u4e86\u5c31\u628a\u5b83\u964d\u7d2b\u3002\n- \u5047\u8bbe\u6211\u4eec\u533a\u95f4\u52a0\u76f4\u63a5\u5bf9\u6570\u7ec4 $f$ \u8fdb\u884c\u7ef4\u62a4\uff0c\u90a3\u4e48\u6211\u4eec\u76f8\u5f53\u4e8e\u67e5\u8be2\uff1a\n$$\\sum_{i=l}^r\\sum_{j=1}^{n-i+1}\\sum_{k=j}^{j+i-1}f(k)$$\n- \u5229\u7528[\u8fd9\u9898](https://www.luogu.com.cn/blog/luo1gu1zui1bang1/lgjoid1t2-li-shi)\u7684\u505a\u6cd5\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u95ee\u9898\u5316\u4e3a\uff1a\n$$\\sum_{i=l}^r\\sum_{j=1}^{n-i+1}\\sigma f(j+i-1)-\\sigma f(j-1)$$\n$$\\sum_{i=l}^r\\sigma^2 f(n)-\\sigma^2 f(i-1)-\\sigma^2 f(n-i)$$\n$$(r-l+1)\\sigma^2 f(n)-\\sigma^3 f(r-1)+\\sigma^3 f(l-2)-\\sigma^3 f(n-l)+\\sigma^3f(n-r-1)$$\n- \u5f3a\u884c\u8bbe\u5dee\u5206\u6570\u7ec4 $g(n)=f(n)-f(n-1)$\uff0c\u6211\u4eec\u8981\u6c42\u7684\uff1a\n$$(r-l+1)\\sigma^3 g(n)-\\sigma^4 g(r-1)+\\sigma^4 g(l-2)-\\sigma^4 g(n-l)+\\sigma^4g(n-r-1)$$\n- \u56e0\u6b64\u6211\u4eec\u7684\u95ee\u9898\u5373\u4e3a\u5355\u70b9\u4fee\u6539\uff0c\u67e5\u8be2\u5355\u70b9\u7684\u56db\u6b21\u524d\u7f00\u548c~~\u8fd8\u662f\u4e0d\u5982\u6839\u53f7~~\uff0c[\u4ee3\u7801\u5b9e\u73b0](https://www.luogu.com.cn/paste/96fl6zj2)\u3002",
        "postTime": 1658274764,
        "uid": 260884,
        "name": "WeLikeStudying",
        "ccfLevel": 0,
        "title": "\u5dee\u5206\u4e0e\u524d\u7f00\u548c\u7684\u7b80\u5355\u8bb0\u5f55"
    },
    {
        "content": "## \u4e00\u3001\u9898\u610f\n\n\u7ed9\u5b9a\u4e00\u4e2a\u5e8f\u5217\uff0c\u8981\u6c42\u652f\u6301\u533a\u95f4\u52a0\uff0c\u67e5\u8be2\u5e8f\u5217\u957f\u5ea6\u5c5e\u4e8e $[l,r]$ \u7684**\u5b50\u6bb5\u548c\u4e4b\u548c** $S$\u3002\n\n\u533a\u95f4\u4fee\u6539\u7684\u5de6\u53f3\u7aef\u70b9**\u4e0d\u4fdd\u8bc1** $l\\le r$\uff08\u7ed9\u5b9a\u94fe\uff09\u3002\n\n## \u4e8c\u3001\u601d\u8def\n\n\u7ebf\u6bb5\u6811\u57fa\u7840\u52a0~~\u5feb\u4e50~~\u63a8\u5f0f\u5b50\u9898\u3002\n\n\u6211\u4eec\u8bbe $pre_1(x)=\\sum_{i=1}^x a_i$\uff0c$pre_2(x)=\\sum_{i=1}^x pre_1(x)$\uff0c\n$pre_3(x)=\\sum_{i=1}^x pre_2(x)$\u3002\n\n\u5bf9\u4e8e\u5b50\u6bb5\u548c\u4e4b\u548c $S$\uff0c\u53ef\u4ee5\u5f97\u5230\n$$\nS=\\sum_{x=l}^r\\sum_{i=x}^n\\sum_{j=i-x+1}^i a_j\n$$\n$$\n=\\sum_{x=l}^r\\sum_{i=x}^n(pre_1(i)-pre_1(i-x))\n$$\n$$\n=\\sum_{x=l}^r(\\sum_{i=x}^npre_1(i)-\\sum_{i=x}^{n}pre_1(i-x))\n$$\n$$\n=\\sum_{x=l}^r(pre_2(n)-pre_2(x-1)-\\sum_{i=0}^{n-x}pre_1(i))\n$$\n$$\n=\\sum_{x=l}^r(pre_2(n)-pre_2(x-1)-pre_2(n-x))\n$$\n$$\n=(r-l+1)pre_2(n)-\\sum_{i=l-1}^{r-1}pre_2(i)-\\sum_{i=n-r}^{n-l}pre_2(i)\n$$\n$$\n=(r-l+1)\\times pre_2(n)-pre_3(r-1)+pre_3(l-2)-pre_3(n-l)+pre_3(n-r-1)\n$$\n\n\u90a3\u4e48\u6211\u4eec\u53ea\u9700\u6c42 $pre_2$ \u4e0e $pre_3$\u3002\n\n\u8bbe $S_0(x)=\\sum_{i=1}^x a_i$\uff0c$S_1(x)=\\sum_{i=1}^x a_i\\cdot i$\uff0c$S_2(x)=\\sum_{i=1}^x a_i\\cdot i^2$\u3002\n\n\u53d1\u73b0\n$$\npre_2(x)=\\sum_{i=1}^x \\sum_{j=1}^i a_j=\\sum_{i=1}^xa_i\\cdot (x+1-i)\n$$\n$$\n=(x+1)\\cdot\\sum_{i=1}^xa_i-\\sum_{i=1}^xa_i\\cdot i\n$$\n$$\n=(x+1)\\cdot S_0(x)-S_1(x)\n$$\n$$\npre_3(x)=\\sum_{i=1}^x \\sum_{j=1}^i\\sum_{k=1}^j a_k=\\sum_{i=1}^x\\sum_{j=1}^i a_j\\cdot(i+1-j)\n$$\n$$\n=\\sum_{j=1}^x a_j\\cdot\\sum_{i=j}^x(i+1-j)\n=\\sum_{j=1}^x a_j\\cdot\\sum_{i=1}^{x-j+1}i\n$$\n$$\n=\\sum_{j=1}^xa_j\\cdot \\dfrac{(x-j+1)(x-j+2)}{2}\n$$\n$$\n=\\dfrac 12\\sum_{j=1}^x a_j\\cdot(j^2-(2x+3)j+(x+1)(x+2))\n$$\n$$\n=\\dfrac 12(S_2(x)-(2x+3)\\cdot S_1(x)+(x+1)(x+2)\\cdot S_0(x))\n$$\n\n\u6211\u4eec\u53ea\u9700\u7ef4\u62a4 $S_0,S_1,S_2$ \u5373\u53ef\u3002\u5bf9\u4e8e $a_i$\uff0c\u5728 $S_1,S_2$ \u4e2d\u6240\u4e58\u7684 $i,i^2$ \u662f**\u56fa\u5b9a**\u7684\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u9884\u5904\u7406 $i,i^2$ \u7684\u524d\u7f00\u548c\uff0c\u5728 pushdown \u65f6\u6c42\u51fa\u533a\u95f4 $i,i^2$ \u7684\u548c\u5e76\u66f4\u65b0 $S_1,S_2$\u3002\n\n\u6ce8\u610f\u53ca\u65f6\u53d6\u6a21\u3002\n\n### AC code\n\n```cpp\n//written_by_FTL\n#include<iostream>\n#include<cstdio>\n#include<cstring>\n#include<string>\n#include<algorithm>\n#include<queue>\n#include<vector>\n#include<map>\n#define ll long long\n#define LD long double\n#define i7 __int128\n#define re return\nusing namespace std;\nconst int N=2e5+5;\nint rd(){\n\tint ans=0,f=0;\n\tchar ch=getchar();\n\twhile(ch<'0'||ch>'9')f^=(ch=='-'),ch=getchar();\n\twhile(ch>='0'&&ch<='9')ans=(ans<<3)+(ans<<1)+(ch^48),ch=getchar();\n\tre f?-ans:ans;\n}\nint n,m;\nll l,r,pre1[N],pre2[N],ans,mod=1e9+7;\nchar s[3];\nll a[N];\nvoid MD(ll &x){//\u53d6\u6a21\n\tif(x>=mod)x-=mod;\n}\nnamespace SGT{\n\t#define vl v<<1\n\t#define vr v<<1|1\n\t#define t d[v]\n\t#define tl d[vl]\n\t#define tr d[vr]\n\t#define z lz[v]\n\t#define zl lz[vl]\n\t#define zr lz[vr]\n\t#define mid ((l+r)>>1)\n\tstruct data{\n\t\tint l,r;ll s[3];\n\t}d[N<<2];\n\tstruct lazy{\n\t\tll x;\n\t}lz[N<<2];\n\tvoid pu(int v){\n\t\tt.s[0]=tl.s[0]+tr.s[0];\n\t\tt.s[1]=tl.s[1]+tr.s[1];\n\t\tt.s[2]=tl.s[2]+tr.s[2];\n\t\tMD(t.s[0]),MD(t.s[1]),MD(t.s[2]);\n\t}\n\tvoid pd(int v){\n\t\tif(z.x==0)re;\n\t\tzl.x+=z.x,zr.x+=z.x;\n\t\tMD(zl.x),MD(zr.x);\n\t\ttl.s[0]=(tl.s[0]+z.x*(tl.r-tl.l+1))%mod;\n\t\ttr.s[0]=(tr.s[0]+z.x*(tr.r-tr.l+1))%mod;\n\t\ttl.s[1]=(tl.s[1]+z.x*(pre1[tl.r]-pre1[tl.l-1]+mod))%mod;\n\t\ttr.s[1]=(tr.s[1]+z.x*(pre1[tr.r]-pre1[tr.l-1]+mod))%mod;\n\t\ttl.s[2]=(tl.s[2]+z.x*(pre2[tl.r]-pre2[tl.l-1]+mod))%mod;\n\t\ttr.s[2]=(tr.s[2]+z.x*(pre2[tr.r]-pre2[tr.l-1]+mod))%mod;\n\t\tz.x=0;\n\t}\n\tvoid bd(int l,int r,int v){\n\t\tt.l=l,t.r=r,z.x=0;\n\t\tif(l==r){\n\t\t\tt.s[0]=a[l];\n\t\t\tt.s[1]=a[l]*l%mod;\n\t\t\tt.s[2]=t.s[1]*l%mod;\n\t\t\tre;\n\t\t}\n\t\tbd(l,mid,vl),bd(mid+1,r,vr);\n\t\tpu(v);\n\t}\n\tll qry(int l,int r,int v,int p){//\u66f4\u65b0\n\t\tif(t.l>=l&&t.r<=r)re t.s[p];\n\t\tpd(v);\n\t\tre (tl.r>=l?qry(l,r,vl,p):0ll)+(tr.l<=r?qry(l,r,vr,p):0ll);\n\t}\n\tvoid ud(int l,int r,int v,ll k){//\u4fee\u6539\n\t\tif(t.l>=l&&t.r<=r){\n\t\t\tt.s[0]=(t.s[0]+k*(t.r-t.l+1))%mod;\n\t\t\tt.s[1]=(t.s[1]+k*(pre1[t.r]-pre1[t.l-1]+mod))%mod;\n\t\t\tt.s[2]=(t.s[2]+k*(pre2[t.r]-pre2[t.l-1]+mod))%mod;\n\t\t\tz.x+=k;MD(z.x);re;\n\t\t}\n\t\tpd(v);\n\t\tif(tl.r>=l)ud(l,r,vl,k);\n\t\tif(tr.l<=r)ud(l,r,vr,k);\n\t\tpu(v);\n\t}\n\t#undef t\n\t#undef mid\n}\nll P2(){//pre2(n)\n\tll tmp=SGT::qry(1,n,1,0)%mod;\n\tre (tmp*(n+1)-SGT::qry(1,n,1,1)%mod+mod)%mod;\n}\nll P3(int x){//pre3\n\tif(x<=0)re 0;\n\tll tmp=(SGT::qry(1,x,1,2)-SGT::qry(1,x,1,1)%mod*(x+x+3)+SGT::qry(1,x,1,0)%mod*(x+1)%mod*(x+2))%mod;\n\tre (tmp*500000004%mod+mod)%mod;\n}\nint main(){\n\tn=rd(),m=rd();\n\tfor(int i=1;i<=n;i++)a[i]=rd();\n\tSGT::bd(1,n,1);\n\tfor(ll i=1;i<=n;i++)pre1[i]=(pre1[i-1]+i)%mod;  //i \u524d\u7f00\u548c\n\tfor(ll i=1;i<=n;i++)pre2[i]=(pre2[i-1]+i*i)%mod;//i^2 \u524d\u7f00\u548c\n\tfor(int i=1;i<=m;i++){\n\t\tif(rd()==1){\n\t\t\tl=rd(),r=rd();\n\t\t\tif(l>r)swap(l,r);\n\t\t\tSGT::ud(l,r,1,rd());\n\t\t}\n\t\telse{\n\t\t\tl=rd(),r=rd();\n\t\t\tif(l>r)swap(l,r);\n\t\t\tans=P2()*(r-l+1)-P3(r-1)+P3(l-2)-P3(n-l)+P3(n-r-1);\n\t\t\tprintf(\"%lld\\n\",(ans%mod+mod)%mod);\n\t\t}\n\t}\n\tre 0;\n}\n```\n\n### $\\text{The End.}$\n",
        "postTime": 1648379651,
        "uid": 346440,
        "name": "FreeTimeLove",
        "ccfLevel": 7,
        "title": "P4458\u3010\u94fe\u4e0a\u4e8c\u6b21\u6c42\u548c\u3011"
    },
    {
        "content": "[link](https://www.luogu.com.cn/problem/P4458)\n\n\u9996\u5148\u5904\u7406\u90a3\u4e2a\u5947\u602a\u7684\u8be2\u95ee\u64cd\u4f5c\u3002\u6211\u4eec\u53ef\u4ee5\u5bf9\u4e8e\u90a3\u4e2a\u5947\u602a\u7684\u4e1c\u897f\u8fdb\u884c\u66b4\u529b\u63a8\u5f0f\uff1a\n\n$$ans(l,r)=\\sum\\limits_{len=l}^r\\sum\\limits_{i=1}^{m-len+1}\\sum\\limits_{j=i}^{i+len-1}{a_j}$$\n\n\u7528\u524d\u7f00\u548c\u641e\u4e00\u4e0b\u5c31\u662f\n\n$$\\sum\\limits_{len=l}^r\\sum\\limits_{i=1}^{m-len+1}{sum_{i+len-1}-sum_{i-1}}$$\n\n\u5206\u79bb\u4e00\u4e0b\n\n$$\\sum\\limits_{len=l}^r{(\\sum\\limits_{i=len}^m{sum_i}-\\sum\\limits_{i=0}^{m-len}sum_i)}$$\n\n\u53d1\u73b0\u5b83\u4f3c\u4e4e\u4ecd\u7136\u5177\u6709\u524d\u7f00\u548c\u7684\u6027\u8d28\uff0c\u8003\u8651\u641e\u4e2a\u524d\u7f00\u548c\u7684\u524d\u7f00\u548c\uff08\u6211\u628a\u5b83\u53eb\u505a $su$ \u6570\u7ec4\uff0c\u4e3a $sum$ \u6570\u7ec4\u7684\u524d\u7f00\u548c\uff09\uff1a\n\n$$\\sum\\limits_{len=l}^r{su_{m}-su_{len-1}-su_{m-len}}$$\n\n\u5c55\u5f00\uff1a\n\n$$su_m\\times(r-l+1)-\\sum\\limits_{i=l-1}^{r-1}su_i-\\sum\\limits_{i=m-r}^{m-l}{su_i}$$\n\n\u4e8e\u662f\u90a3\u4e2a\u5947\u602a\u7684\u8be2\u95ee\u5c31\u53d8\u6210\u4e86\u5355\u7eaf\u7684\u5bf9\u4e8e $su$ \u6570\u7ec4\u7684\u533a\u95f4\u548c\u67e5\u8be2\u3002\n\n\u6309\u7167\u601d\u8003\u6b64\u7c7b\u95ee\u9898\u7684\u60ef\u5e38\u65b9\u6cd5\uff0c\u8003\u8651\u5047\u5982\u6211\u4eec\u7ed9 $[l,r]$ \u4e2d\u7684\u6570\u90fd\u52a0\u4e86\u4e00\u4e2a $a$ ,\u4f1a\u53d1\u751f\u4e9b\u4ec0\u4e48\uff1f\n\n$$\\Delta sum_i=\\begin{cases}0&i\\in[1,l-1]\\\\d\\times(i-l+1)&i\\in[l,r]\\\\d\\times(r-l+1)&i\\in[r+1,m]\\end{cases}$$\n\n\u540c\u6837\u53ef\u4ee5\u5f97\u51fa,\u4e3a\u4e86\u65b9\u4fbf\u8868\u8ff0\uff0c\u5047\u5982\u4ee4 $s(i)=i\\times(i+1)/2$ \u90a3\u4e48\uff1a\n\n$$\\Delta su_i=\\begin{cases}0&i\\in[1,l-1]\\\\d\\times s(i-l+1)&i\\in[l,r]\\\\d\\times s(r-l+1)+d\\times(r-l+1)\\times(i-r)&i\\in[r+1,m]\\end{cases}$$\n\n\u5f00\u5fc3\u5730\u53d1\u73b0 $i\\in[1,l-1]$ \u90e8\u5206\u4e0d\u7528\u7ba1\uff0c\u6240\u4ee5\u5bf9\u4e8e\u5269\u4e0b\u7684\u4e24\u4e2a\u90e8\u5206\u8fdb\u884c\u5904\u7406\u3002\u9996\u5148\u662f $i\\in[r+1,M]$ \u90e8\u5206\uff0c\u4ee4 $len=r-l+1$ \u3002\n\n$$\\Delta su_i=d\\times s(len)+d\\times len\\times(i-r)$$\n$$=d\\times s(len)-d\\times len\\times r+d\\times len\\times r$$\n\n\u53d1\u73b0\u524d\u534a\u90e8\u5206\u662f\u4e2a\u5b9a\u503c\uff0c\u76f8\u5f53\u4e8e\u662f\u666e\u901a\u533a\u95f4\u52a0\uff1b\u540e\u534a\u90e8\u5206\u76f8\u5f53\u4e8e\u662f\u533a\u95f4\u52a0 $d\\times len$ \u500d\u7684\u4e0b\u6807\u3002\u5982\u4f55\u5b9e\u73b0\u540e\u9762\u518d\u8bf4\u3002\u518d\u770b\u4e00\u4e0b\u5bf9\u4e8e $i\\in[r+1,m]$ \u90e8\u5206\u600e\u4e48\u5904\u7406\u3002\n\n$$\\frac{2\\Delta su_i}{d}=(i-l+1)^2+(i-l+1)$$\n$$=i^2+(l-1)^2+2i(1-l)+i+(1-l)$$\n$$=i^2+(3-2l)i+(l-1)(l-2)$$\n\n\u6240\u4ee5\u603b\u7ed3\u4e00\u4e0b\u5c31\u662f\n\n$$2\\Delta su_i=di^2+(3d-2ld)i+(l-1)(l-2)d$$\n\n\u53d1\u73b0 $(l-1)(l-2)$ \u662f\u56fa\u5b9a\u7684\uff0c\u76f8\u5f53\u4e8e\u662f\u533a\u95f4\u52a0\u3002\u4e8e\u662f\u6574\u7406\u4e00\u4e0b\u7ed3\u8bba\uff0c\u6211\u4eec\u9700\u8981\u53ef\u4ee5\u5b8c\u6210\u533a\u95f4\u52a0\u4e0b\u6807\u5e73\u65b9\u548c\u533a\u95f4\u52a0\u4e0b\u6807\u7684\u6570\u636e\u7ed3\u6784\u3002\u8fd9\u5e94\u8be5\u662f\u53ef\u4ee5\u505a\u5230\u7684\uff0c\u4e2a\u4eba\u89c9\u5f97\u601d\u8003\u96be\u5ea6\u5e76\u6ca1\u6709\u90a3\u4e48\u9ad8\u3002\u6253\u61d2\u6807\u8bb0\u5e94\u8be5\u5f88\u7b80\u5355\uff0c\u4e3b\u8981\u5c31\u662f pushnow \u51fd\u6570\u7684\u5199\u6cd5\u3002\u533a\u95f4\u52a0\u4e0b\u6807\u597d\u529e\uff0c\u76f8\u5f53\u4e8e\u662f\u6c42\u4e2a\u7b49\u5dee\u6570\u5217\u7684\u548c\uff0c\u90a3\u533a\u95f4\u52a0\u4e0b\u6807\u5e73\u65b9\u600e\u4e48\u641e\uff1f\u6709\u5e73\u65b9\u548c\u516c\u5f0f\u554a\u3002\n\n$$\\sum\\limits_{i=1}^{m}{i^2}=\\frac{m(m+1)(2m+1)}{6}$$\n\n\u6700\u540e\u6211\u4eec\u53d1\u73b0\uff0c\u4e0a\u9762\u63a8\u51fa\u6765\u7684\u67ff\u5b50\u4e3a\u771f\u6b63\u589e\u91cf\u7684\u4e24\u500d\u3002\u53d6\u6a21\u610f\u4e49\u4e0b\u9664\u6cd5\u7070\u5e38\u9ebb\u70e6\uff0c\u4e8e\u662f\u6211\u7684\u505a\u6cd5\u662f\u7ebf\u6bb5\u6811\u4e2d\u7ef4\u62a4\u7684\u662f\u589e\u91cf\u7684\u4e24\u500d\uff0c\u8be2\u95ee\u65f6\u4e58\u4e0a 2 \u7684\u9006\u5143\u5c31\u53ef\u4ee5\u4e86\u3002\n\n\u6700\u540e\u8bf4\u660e\u4e00\u70b9\uff0c\u7531\u4e8e\u8fd9\u9053\u9898\u5bf9\u53d6\u6a21\u7684\u8981\u6c42\u82db\u523b\u5f97\u6709\u4e9b\u4e27\u5fc3\u75c5\u72c2\uff0c\u4e00\u5b9a\u8981\u8ba4\u771f\u53d6\u6a21\u3002\u7136\u540e\u672c\u849f\u84bb\u4ee3\u7801\u80fd\u529b\u6781\u5dee\uff0c\u4e0d\u5f97\u5df2\u5f00\u4e86\u4e09\u68f5\u7ebf\u6bb5\u6811\u6765\u7ef4\u62a4\u4e0a\u9762\u589e\u91cf\u7684\u4e09\u4e2a\u90e8\u5206\u3002\u7801\u98ce\u6c22\u6c14\uff0c\u89c1\u8c05\u3002\n```\n#include<cstdio>\n//#define zczc\n#define int long long\nconst int N=200010;\nconst int yy=500000004;\nconst int mod=1000000007;\ninline void read(int &wh){\n    wh=0;int f=1;char w=getchar();\n    while(w<'0'||w>'9'){if(w=='-')f=-1;w=getchar();}\n    while(w<='9'&&w>='0'){wh=wh*10+w-'0';w=getchar();}\n    wh*=f;return;\n}\n\nint m,n,a[N];\n\n#define lc (wh<<1)\n#define rc (wh<<1|1)\n#define mid (t[wh].l+t[wh].r>>1)\n//\u76f4\u63a5\u533a\u95f4\u52a0\u7684\u90a3\u68f5\u6811\nnamespace ta{\n\tstruct node{\n\t\tint l,r,data,lazy;\n\t}t[N<<2];\n\tinline void pushup(int wh){\n\t\tt[wh].data=(t[lc].data+t[rc].data)%mod;\n\t\treturn;\n\t}\n\tinline void pushnow(int wh,int val){\n\t\tt[wh].lazy+=val;\n\t\tt[wh].lazy%=mod;\n\t\tt[wh].data+=val*(t[wh].r-t[wh].l+1)%mod;\n\t\tt[wh].data%=mod;\n\t\treturn;\n\t}\n\tinline void pushdown(int wh){\n\t\tif(t[wh].lazy){\n\t\t\tpushnow(lc,t[wh].lazy);\n\t\t\tpushnow(rc,t[wh].lazy);\n\t\t\tt[wh].lazy=0;\n\t\t}\n\t\treturn;\n\t}\n\tinline void build(int wh,int l,int r){\n\t\tt[wh].l=l,t[wh].r=r;\n\t\tif(l==r){\n\t\t\tt[wh].data=a[l];\n\t\t\treturn;\n\t\t}\n\t\tbuild(lc,l,mid);\n\t\tbuild(rc,mid+1,r);\n\t\tpushup(wh);\n\t\treturn;\n\t}\n\tinline void change(int wh,int wl,int wr,int val){\n\t\tif(wl<=t[wh].l&&t[wh].r<=wr){\n\t\t\tpushnow(wh,val);\n\t\t\treturn;\n\t\t}\n\t\tpushdown(wh);\n\t\tif(wl<=mid)change(lc,wl,wr,val);\n\t\tif(wr>mid)change(rc,wl,wr,val);\n\t\tpushup(wh);\n\t\treturn; \n\t}\n\tinline int work(int wh,int wl,int wr){\n\t\tif(wl<=t[wh].l&&t[wh].r<=wr){\n\t\t\treturn t[wh].data;\n\t\t}\n\t\tpushdown(wh);\n\t\tint an=0;\n\t\tif(wl<=mid)an+=work(lc,wl,wr);\n\t\tif(wr>mid)an+=work(rc,wl,wr);\n\t\treturn an%mod; \n\t}\n\tinline int ask(int wh,int pl){\n\t\tif(t[wh].l==t[wh].r)return t[wh].data;\n\t\tpushdown(wh);\n\t\tif(pl<=mid)return ask(lc,pl);\n\t\telse return ask(rc,pl);\n\t}\n}\n//\u533a\u95f4\u52a0\u4e0b\u6807\u7684\u90a3\u68f5\u6811 \nnamespace tb{\n\tstruct node{\n\t\tint l,r,data,lazy;\n\t}t[N<<2];\n\tinline void pushup(int wh){\n\t\tt[wh].data=(t[lc].data+t[rc].data)%mod;\n\t\treturn;\n\t}\n\tinline int s(int l,int r){\n\t\treturn (l+r)*(r-l+1)/2%mod;\n\t}\n\tinline void pushnow(int wh,int val){\n\t\tt[wh].lazy+=val;t[wh].lazy%=mod;\n\t\tt[wh].data+=val*s(t[wh].l,t[wh].r)%mod;\n\t\tt[wh].data%=mod;\n\t\treturn;\n\t}\n\tinline void pushdown(int wh){\n\t\tif(t[wh].lazy){\n\t\t\tpushnow(lc,t[wh].lazy);\n\t\t\tpushnow(rc,t[wh].lazy);\n\t\t\tt[wh].lazy=0;\n\t\t}\n\t\treturn;\n\t}\n\tinline void build(int wh,int l,int r){\n\t\tt[wh].l=l,t[wh].r=r;\n\t\tif(l==r)return;\n\t\tbuild(lc,l,mid);\n\t\tbuild(rc,mid+1,r);\n\t\tpushup(wh);\n\t\treturn;\n\t}\n\tinline void change(int wh,int wl,int wr,int val){\n\t\tif(wl<=t[wh].l&&t[wh].r<=wr){\n\t\t\tpushnow(wh,val);\n\t\t\treturn;\n\t\t}\n\t\tpushdown(wh);\n\t\tif(wl<=mid)change(lc,wl,wr,val);\n\t\tif(wr>mid)change(rc,wl,wr,val);\n\t\tpushup(wh);\n\t\treturn; \n\t}\n\tinline int work(int wh,int wl,int wr){\n\t\tif(wl<=t[wh].l&&t[wh].r<=wr){\n\t\t\treturn t[wh].data;\n\t\t}\n\t\tpushdown(wh);\n\t\tint an=0;\n\t\tif(wl<=mid)an+=work(lc,wl,wr);\n\t\tif(wr>mid)an+=work(rc,wl,wr);\n\t\treturn an%mod; \n\t}\n\tinline int ask(int wh,int pl){\n\t\tif(t[wh].l==t[wh].r)return t[wh].data;\n\t\tpushdown(wh);\n\t\tif(pl<=mid)return ask(lc,pl);\n\t\telse return ask(rc,pl);\n\t}\n}\n//\u533a\u95f4\u52a0\u4e0b\u6807\u5e73\u65b9\u7684\u90a3\u68f5\u6811\nnamespace tc{\n\tstruct node{\n\t\tint l,r,data,lazy;\n\t}t[N<<2];\n\tinline void pushup(int wh){\n\t\tt[wh].data=(t[lc].data+t[rc].data)%mod;\n\t\treturn;\n\t}\n\tinline int s(int wh){\n\t\treturn wh*(wh+1)/2*(2*wh+1)/3%mod;\n\t}\n\tinline void pushnow(int wh,int val){\n\t\tt[wh].lazy+=val;t[wh].lazy%=mod;\n\t\tt[wh].data+=val*(s(t[wh].r)-s(t[wh].l-1)+mod)%mod;\n\t\tt[wh].data%=mod;\n\t\treturn;\n\t}\n\tinline void pushdown(int wh){\n\t\tif(t[wh].lazy){\n\t\t\tpushnow(lc,t[wh].lazy);\n\t\t\tpushnow(rc,t[wh].lazy);\n\t\t\tt[wh].lazy=0;\n\t\t}\n\t\treturn;\n\t}\n\tinline void build(int wh,int l,int r){\n\t\tt[wh].l=l,t[wh].r=r;\n\t\tif(l==r)return;\n\t\tbuild(lc,l,mid);\n\t\tbuild(rc,mid+1,r);\n\t\tpushup(wh);\n\t\treturn;\n\t}\n\tinline void change(int wh,int wl,int wr,int val){\n\t\tif(wl<=t[wh].l&&t[wh].r<=wr){\n\t\t\tpushnow(wh,val);\n\t\t\treturn;\n\t\t}\n\t\tpushdown(wh);\n\t\tif(wl<=mid)change(lc,wl,wr,val);\n\t\tif(wr>mid)change(rc,wl,wr,val);\n\t\tpushup(wh);\n\t\treturn; \n\t}\n\tinline int work(int wh,int wl,int wr){\n\t\tif(wl<=t[wh].l&&t[wh].r<=wr){\n\t\t\treturn t[wh].data;\n\t\t}\n\t\tpushdown(wh);\n\t\tint an=0;\n\t\tif(wl<=mid)an+=work(lc,wl,wr);\n\t\tif(wr>mid)an+=work(rc,wl,wr);\n\t\treturn an%mod; \n\t}\n\tinline int ask(int wh,int pl){\n\t\tif(t[wh].l==t[wh].r)return t[wh].data;\n\t\tpushdown(wh);\n\t\tif(pl<=mid)return ask(lc,pl);\n\t\telse return ask(rc,pl);\n\t}\n} \n#undef lc\n#undef rc\n#undef mid\n\ninline int solve(int l,int r){\n\tif(l==r){\n\t\treturn (ta::ask(1,l)+(tb::ask(1,l)+tc::ask(1,l))%mod*yy%mod)%mod;\n\t}\n\telse{\n\t\treturn (ta::work(1,l,r)+(tb::work(1,l,r)+tc::work(1,l,r))%mod*yy%mod)%mod;\n\t}\n}\n\nsigned main(){\n\t\n\t#ifdef zczc\n\tfreopen(\"a.in\",\"r\",stdin);\n\t#endif\n\t\n\tread(m);read(n);\n\tfor(int i=1;i<=m;i++){read(a[i]);a[i]+=a[i-1];a[i]%=mod;}\n\tfor(int i=1;i<=m;i++)a[i]+=a[i-1],a[i]%=mod;\n\t//for(int i=1;i<=m;i++)printf(\"%d \",a[i]);\n\tta::build(1,0,m);\n\ttb::build(1,0,m);\n\ttc::build(1,0,m);\n\tint op,l,r,val;\n\t\n\twhile(n--){\n\t\tread(op);read(l);read(r);\n\t\tif(l>r){int s1=l;l=r;r=s1;}\n\t\tif(op==2){\n\t\t\tint an=solve(m,m)*(r-l+1)-solve(l-1,r-1)-solve(m-r,m-l);\n\t\t\tprintf(\"%lld\\n\",(an%mod+mod)%mod);\n\t\t}\n\t\telse{\n\t\t\tread(val);\n\t\t\tif(r<m){\n\t\t\t\tint len=r-l+1;\n\t\t\t\tta::change(1,r+1,m,((val*len%mod*(len+1)%mod*yy%mod-val*len%mod*r%mod)%mod+mod)%mod);\n\t\t\t\ttb::change(1,r+1,m,2*val*len%mod);\n\t\t\t}\n\t\t\tta::change(1,l,r,(l-1)*(l-2)%mod*val%mod*yy%mod);\n\t\t\ttb::change(1,l,r,val*(3-2*l)%mod);\n\t\t\ttc::change(1,l,r,val);\n\t\t}\n\t}\n\t\n\treturn 0;\n}\n```",
        "postTime": 1642811759,
        "uid": 302383,
        "name": "Feyn",
        "ccfLevel": 0,
        "title": "P4458 \u9898\u89e3"
    },
    {
        "content": "~~\u5ba1\u6838\u8f9b\u82e6\u4e86\uff0c\u521a\u521a\u90a3\u4e00\u7248\u6709\u70b9\u95ee\u9898\u6211\u91cd\u4ea4\u4e00\u4e0b~~\n\n### \u6b64\u9898\u601d\u8def\u590d\u6742\uff0c\u4ee5\u4e0b\u5185\u5bb9\u5efa\u8bae\u4e00\u884c\u4e00\u884c\u8bfb\uff0c\u4fdd\u8bc1\u4e0a\u4e00\u884c\u7406\u89e3\u540e\u518d\u770b\u4e0b\u4e00\u884c\u3002\n\n[\u9898\u76ee\u4f20\u9001\u95e8](https://www.luogu.com.cn/problem/P4458)\n\n~~\u5982\u679c\u54ea\u91cc\u5199\u7684\u4e0d\u8be6\u7ec6\uff0c\u6b22\u8fce\u7559\u8a00\uff08\u6211\u592a\u83dc\u4e86~~\n\n\u9898\u610f\u5927\u6982\u5c31\u662f\u7ef4\u62a4\u4e00\u4e2a\u5e8f\u5217 $a$\uff0c\u652f\u6301\u533a\u95f4\u4fee\u6539\u548c\u67e5\u8be2\uff1a\n\n$\\sum_{len=l}^{r}\\sum_{i=1}^{n-len+1}\\sum_{j=i}^{i+len-1}a[j] $\u3002\n\n~~\u7136\u540e\u6211\u5c31\u76ef\u7740\u8fd9\u4e2a\u516c\u5f0f\u770b\u4e86\u5341\u5206\u949f~~\n\n\u6211\u4eec\u5148\u4e0d\u7ba1\u4fee\u6539\u64cd\u4f5c\uff0c\u8fd9\u4e2a\u516c\u5f0f\u66b4\u529b\u8ba1\u7b97\u662f $O(n^3)$ \u7684\u590d\u6742\u5ea6\u3002\u89c2\u5bdf\u4e00\u4e0b\u8fd9\u4e2a\u516c\u5f0f\uff0c\u6709\u4e2a $\\sum_{j=i}^{i+len-1}a[j] $ \u3002\u65e2\u7136\u662f\u533a\u95f4\u6c42\u548c\uff0c\u4e0d\u59a8\u5148\u7528\u524d\u7f00\u548c\u5e72\u6389\u4e00\u7ef4\uff0c\u53d8\u6210 $O(n^2)$ \u3002\u6211\u4eec\u5c06\u539f\u6570\u7ec4\u7684\u524d\u7f00\u548c\u8bb0\u4f5c $sum$ \uff0c\u5219\u539f\u516c\u5f0f\u8f6c\u5316\u4e3a\uff1a\n\n$\\sum_{len=l}^{r}\\sum_{i=1}^{n-len+1} ( sum[i+len-1] - sum[i-1] ) $\u3002\n\n\u6210\u529f\u8f6c\u5316\u6210\u4e86 $O(n^2)$ \u3002\u89c2\u5bdf\u5230\u4f3c\u4e4e\u8fd8\u6709\u4e00\u5c42\u533a\u95f4\u6c42\u548c\u3002\u539f\u5f0f\u5982\u679c\u518d\u62c6\u4e00\u4e0b\u5c31\u4f1a\u53d8\u6210\uff1a\n\n$\\sum_{len=l}^{r} ( \\sum_{i=len}^{n}sum[i] - \\sum_{i=0}^{n-len} sum[i]) $\u3002\n\n\u91cc\u9762\u53c8\u6709\u533a\u95f4\u6c42\u548c\uff0c\u518d\u524d\u7f00\u548c\u4e00\u4e0b\u4e0b\u3002\u5c06 $sum$ \u7684\u524d\u7f00\u548c\u8bb0\u4e3a $ssum$ \u3002\n\n$\\sum_{len=l}^{r} (ssum[n] - ssum[len-1]-ssum[n-len]) $\n\n$ = ssum[n] \\times (r-l+1) - \\sum_{len=l}^{r} ssum[len-1]  - \\sum_{len=l}^{r}ssum[n-len]$\n\n$ = ssum[n] \\times (r-l+1) - \\sum_{i=l-1}^{r-1} ssum[i]  - \\sum_{i=n-r}^{n-l}ssum[i]$\n\n\n------------\n\n\n~~\u5982\u679c\u518d\u641e\u4e2a sssum \u5355\u6b21\u67e5\u8be2\u80fd\u505a\u5230 O(1) \u4f46\u8fd9\u8f88\u5b50\u90fd\u522b\u60f3\u4fee\u6539\u4e86~~ \u5982\u679c\u52a0\u4e0a\u4fee\u6539\u64cd\u4f5c\uff0c\u5c31\u5fc5\u987b\u7528\u7ebf\u6bb5\u6811\u4ee3\u66ff\u524d\u7f00\u548c\u3002\u6211\u4eec\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u8fd9\u4e2a $ssum$ \u6570\u7ec4\uff0c\u4f7f\u67e5\u8be2\u64cd\u4f5c\u505a\u5230 $O(logn)$ \u3002\n\n\u6211\u4eec\u5bf9 $a$ \u6570\u7ec4\u7684\u201c\u533a\u95f4\u52a0\u201d\u64cd\u4f5c\uff0c\u4f1a\u5bf9 $ssum$ \u4ea7\u751f\u600e\u6837\u7684\u5f71\u54cd\u5462\uff1f\n\n\u4e0d\u59a8\u5148\u770b\u770b $sum$ \u7684\u53d8\u5316\u3002\u6211\u4eec\u7ed9 $a$ \u7684\u539f\u533a\u95f4 $[L,R]$ \u52a0\u4e0a $d$\uff0c\u663e\u7136\u4e0d\u4f1a\u5f71\u54cd\u5230 $sum[0]$ \u5230 $sum[L-1]$ \u7684\u4efb\u4f55\u4e00\u4e2a\u503c\u3002\u6839\u636e\u524d\u7f00\u548c\u7684\u5b9a\u4e49\uff0c$sum[L]$ \u4f1a\u52a0\u4e0a $d$\uff0c$sum[L+1]$ \u4f1a\u52a0\u4e0a $2d$\uff0c$sum[L+2]$ \u4f1a\u52a0\u4e0a $3d$ ......\u4e5f\u5c31\u662f $[L,R]$ \u8303\u56f4\u5185\u7684\u6bcf\u4e2a $sum[L+i] $ \u4f1a\u52a0\u4e0a $ (i+1)\\times d$ \u3002$sum[R]$ \u4e4b\u540e\u7684\u503c\u589e\u52a0\u91cf\u548c $sum[R]$ \u76f8\u540c (\u4e3a $len \\times d$ )\uff0c\u56e0\u4e3a\u540c\u4f4d\u7f6e\u7684 $a$ \u503c\u4e0d\u518d\u589e\u52a0\u3002\n\n\u7136\u540e\u518d\u6765\u770b\u770b $ssum$ \u7684\u53d8\u5316\u3002\u540c\u6837\u7684\uff0c$ssum[0]$ \u5230 $ssum[L-1]$ \u4e0d\u53d7\u5f71\u54cd\u3002$ssum[L]$ \u5219\u4f1a\u52a0\u4e0a $d$\uff0c$ssum[L+1]$\u4f1a\u52a0\u4e0a $3d$......\n\n\u89c2\u5bdf\u5230\uff0c\u5728 $[L,R]$ \u8303\u56f4\u5185\u7684\u6bcf\u4e00\u4e2a $ssum[L+i]$ \u4f1a\u88ab\u52a0\u4e0a $d$ \u7684\u6b21\u6570 ( \u8bb0\u4e3a $delta[i]$ ) \u7684\u901a\u9879\u516c\u5f0f\uff1a$delta[i] = \\frac{(i+1)\\times(i+2)}{2}$ \n\n\u540c\u65f6\uff0c\u5728 $(R,n]$ \u8303\u56f4\u5185\uff0c\u6bcf\u4e2a $ssum[R+i]$ \u7684\u589e\u52a0\u503c\u4e3a\uff1a\n\n$(delta[len] + i \\times (R-L+1) )\\times d$\n\n\u8fd9\u4e5f\u5f88\u597d\u7406\u89e3\uff0c$delta[len]$ \u662f $ssum[R]$ \u88ab\u52a0 $d$ \u7684\u6b21\u6570\uff0c$sum[R]$ \u540e\u9762\u6bcf\u4e2a $sum[i]$ \u5747\u589e\u52a0 $len\\times d$\uff0c\u7d2f\u8ba1\u52a0\u4e86 $i$ \u6b21\uff0c\u603b\u5171\u52a0\u4e86 $i\\times len \\times d$ \u3002\n\n\n\n------------\n\n\n\u628a $[L,R]$ \u548c $(R,n]$ \u8fd9\u4e24\u90e8\u5206\u5206\u5f00\u5904\u7406\u3002\u5148\u770b\u524d\u4e00\u90e8\u5206\u3002\u96be\u70b9\u5728\u4e8e $lazy$ \u6807\u7b7e\u7684\u8bbe\u8ba1\uff0c\u5fc5\u987b\u6ee1\u8db3\u4ee5\u4e0b\u6761\u4ef6\uff08\u4e0d\u7406\u89e3\u4e5f\u6ca1\u5173\u7cfb\uff0c\u5f80\u4e0b\u770b\uff09\uff1a\n\n- \u80fd\u591f\u7d2f\u52a0\uff1a\u5373\u591a\u6b21\u64cd\u4f5c\u5bf9\u533a\u95f4\u7684\u5f71\u54cd\u53ef\u4ee5\u53e0\u52a0\u53cd\u6620\u5230 $lazy$ \u6807\u7b7e\u4e0a\u3002\n- \u80fd\u591f\u4e0b\u653e\uff1a\u8fd9\u4e2a\u6807\u7b7e\u80fd\u591f\u88ab\u4e0b\u653e\u5230\u4e24\u4e2a\u5b50\u533a\u95f4\n\n\u6bcf\u4e2a\u4f4d\u7f6e\u52a0\u7684\u503c\u90fd\u4e0d\u4e00\u6837\uff0c\u5982\u4f55\u8bbe\u8ba1 $lazy$ \u6807\u7b7e\u5462\uff1f\u5728\u7b2c\u4e00\u90e8\u5206\u4e2d\uff0c\u6bcf\u4e2a\u4f4d\u7f6e $ssum[L+i]$ \u52a0\u7684\u503c\u4e3a $\\frac{(i+1)\\times(i+2)}{2} \\times d$ \uff0c\u5c06\u8fd9\u4e2a\u5f0f\u5b50\u5c55\u5f00\u540e\u5f97\u5230 $\\frac{i^2+3i+2}{2}\\times d$\u3002\n\n\u6240\u4ee5\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u4f4d\u7f6e $ssum[idx]$ \uff0c\u56e0\u4e3a $idx=L+i$\uff0c\u6240\u4ee5\u8fd9\u4e2a\u4f4d\u7f6e\u5728\u4e00\u6b21\u64cd\u4f5c\u540e\u7684\u589e\u52a0\u91cf\u4e3a\uff1a\n\n$\\frac{d(idx-L)^2+3d(idx-L)+2d}{2}$\n\n\u628a $idx$ \u89c6\u4f5c\u4e3b\u5143\uff0c\u5c06\u4e0a\u5f0f\u8f6c\u5316\u4e3a\uff1a\n\n$\\frac{d\\times idx^2 + (3d-2Ld)\\times idx -3dL+2d+dL^2}{2}$\n\n\u5206\u5b50\u662f\u4e00\u4e2a\u5173\u4e8e $idx$ \u7684\u4e8c\u6b21\u4e09\u9879\u5f0f\uff0c\u6211\u4eec\u53ef\u4ee5\u628a\u8fd9\u4e2a\u591a\u9879\u5f0f\u7684 $a,b,c$ \u8bbe\u8ba1\u4e3a $lazy$ \u6807\u7b7e\u3002\u4ee4 $a,b,c$ \u4ee3\u8868\u8fd9\u4e2a\u7ebf\u6bb5\u6811\u8282\u70b9\u6240\u7ef4\u62a4\u533a\u95f4\u5185\u6bcf\u4e2a $ssum[idx]$ \u5e94\u88ab\u52a0\u4e0a $\\frac{a\\times idx^2 + b\\times idx +c}{2}$\n\n\u5219\u4e00\u6b21\u64cd\u4f5c\u540e\uff1a$a=d$ \uff1b$b=3d-2Ld$ \uff1b$c=dL^2-3dL+2d$\n\n\u56e0\u4e3a\u591a\u9879\u5f0f\u7684\u6027\u8d28\uff0c\u8fd9\u4e2a\u6807\u7b7e\u662f\u53ef\u4ee5\u7d2f\u52a0\u7684\uff0c\u5982\u679c\u6709\u591a\u4e2a\u64cd\u4f5c\uff0c\u76f4\u63a5\u628a\u591a\u4e2a $d$\u3001$3d-2Ld$\u3001$dL^2-3dL+2d$ \u52a0\u8d77\u6765\u4f5c\u4e3a\u65b0\u7684 $a,b,c$ \u5c31\u53ef\u4ee5\u3002\n\n\u540c\u6837\uff0c\u8fd9\u4e2a\u6807\u7b7e\u4e5f\u662f\u53ef\u4e0b\u653e\u7684\uff0c\u56e0\u4e3a $a,b,c$ \u7684\u503c\u4e0e\u4f4d\u7f6e $idx$ \u65e0\u5173\uff0c\u53ef\u4ee5\u8ba9\u4e24\u4e2a\u5b50\u8282\u70b9\u7684 $a,b,c$ \u76f4\u63a5\u52a0\u4e0a\u5f53\u524d\u8282\u70b9\u7684 $a,b,c$ \u3002\uff08\u5982\u679c\u8fd8\u662f\u4e0d\u7406\u89e3\u53ef\u4ee5\u5148\u770b\u770b\u4ee3\u7801\uff09\n\n\u518d\u6765\u770b\u770b\u7b2c\u4e8c\u90e8\u5206\u3002\u6bcf\u4e2a\u4f4d\u7f6e\u52a0\u7684\u503c\u4e3a $\\frac{d(R-L)^2+3d(R-L)+2d}{2} + (idx-R)\\times (R-L+1)\\times d$\n\n\u540c\u6837\u628a $idx$ \u89c6\u4e3a\u4e3b\u5143\uff1a\n\n$(R-L+1)\\times d \\times idx + \\frac{d(R-L)^2+3d(R-L)+2d}{2} - R\\times (R-L+1)\\times d$\n\n\u5219 $a=0$ \uff1b$b=2(R-L+1)\\times d$ \uff1b$c=d(R-L)^2+3d(R-L)+2d - 2\\times R\\times (R-L+1)\\times d$ \u3002\u6839\u636e\u4e0a\u9762 $a,b,c$ \u7684\u5b9a\u4e49\uff0c\u8fd9\u91cc\u8981\u4e58\u4ee5 $2$\n\n\u6700\u540e\uff0c\u5047\u8bbe\u73b0\u5728\u7ebf\u6bb5\u6811\u7684\u67d0\u4e2a\u8282\u70b9 $[l,r]$ \u88ab\u52a0\u4e0a\u4e86\u4e00\u7ec4 $a,b,c$\uff0c\u5b83\u7684\u6743\u503c\u5e94\u8be5\u88ab\u52a0\u4e0a\uff1a\n\n- $[l,r]$ \u533a\u95f4\u5185\u6240\u6709 $idx$ \u5e73\u65b9\u548c\u4e58\u4ee5 $a$\uff1b\n- $[l,r]$ \u533a\u95f4\u5185\u6240\u6709 $idx$ \u548c\u4e58\u4ee5 $b$\uff1b\n- $[l,r]$ \u957f\u5ea6\u4e58\u4ee5 $c$\uff1b\n\n\u522b\u5fd8\u4e86\u6700\u540e\u8981\u9664\u4ee5 $2$\u3002\n\n\u7b2c\u4e00\u4e2a\u53ef\u4ee5\u7528\u5e73\u65b9\u548c\u516c\u5f0f\u7b97\uff0c\u7b2c\u4e8c\u4e2a\u7528\u7b49\u5dee\u6570\u5217\u6c42\u548c\u516c\u5f0f\uff0c\u65f6\u95f4\u590d\u6742\u5ea6\u5747\u4e3a $O(1)$\n\n\u5f53\u65f6\u6211\u4ee5\u4e3a\u8fd9\u9053\u9898\u5df2\u7ecf\u505a\u5b8c\u4e86\uff0c\u63d0\u4ea4\u4ee3\u7801\uff0c10pts WA\n\n\u7136\u540e\u518d\u770b\u4e00\u773c\u9898\u9762\uff0c\u8981\u6c42\u819c $1e9+7$\u3002\u4ee5\u4e3a\u52a0\u4e0a\u8fd9\u4e2a\u5c31\u80fd AC\n\n\u7ed3\u679c\u8fd8\u662f\u6211\u592a\u83dc\u4e86\uff0c\u539f\u5f0f\u4e2d\u6709\u9664\u6cd5\uff0c\u600e\u80fd\u968f\u4fbf\u819c\u5462\uff1f\u4e0a\u9006\u5143\u5427\u3002$2$ \u5728\u819c $1e9+7$ \u610f\u4e49\u4e0b\u7684\u9006\u5143\u4e3a $5e8+4$ \u3002\u8fd8\u6709\u6700\u540e\u7b97\u5b8c\u7b54\u6848\u5982\u679c\u662f\u8d1f\u7684\uff0c\u5e94\u8be5\u52a0\u4e0a $1e9+7$\n\n\u7528\u4e58\u4ee5 $5e8+4$ \u4ee3\u66ff\u9664\u4ee5 $2$\uff0c\u63d0\u4ea4\uff0cAC\u3002\n\n\u4e0a Code : \n\n```cpp\n#include<iostream>\n#include<assert.h>\n\nusing namespace std;\n\nconst int mod = 1e9+7;\nconst long long niYuan = 5e8+4;\n\ninline long long sqrSum(long long n){ //\u81ea\u7136\u6570\u5e73\u65b9\u548c\u516c\u5f0f\n\treturn (n*(n+1)*(2*n+1)/6) % mod; \n}\n\nstruct seg{\n\tseg* lson=NULL,*rson=NULL;\n\t\n\tlong long lazyA=0,lazyB=0,lazyC=0;\n\tlong long val;\n\tint segL,segR;\n\t\n\tinline void update(){\n\t\tassert(!(lazyA|lazyB|lazyC)); //\u8c03\u8bd5\u7528\n\t\tval = (lson->val + rson->val) % mod;\n\t}\n\t\n\tinline long long idxSqrSum(){ //\u7f16\u53f7\u5e73\u65b9\u548c\n\t\treturn (sqrSum(segR) - sqrSum(segL-1)) % mod; \n\t}\n\t\n\tinline long long len(){ //\u533a\u95f4\u957f\u5ea6\n\t\treturn (segR - segL + 1) % mod; \n\t}\n\t\n\tinline long long idxSum(){ //\u7f16\u53f7\u548c\n\t\treturn ((segL+segR)*len()/2) % mod; \n\t}\n\t\n\tinline void add(int a,int b,int c){\n\t\tlazyA += a;lazyB += b;lazyC += c;\n\t\tlazyA %= mod;lazyB %= mod;lazyC %= mod;\n\t\t\n\t\tval += ((a*idxSqrSum()%mod + b*idxSum()%mod + c*len()%mod) %mod * niYuan) % mod; //\u9664\u4ee5\u4e8c\u7b49\u4ef7\u4e8e\u4e58\u4ee5 5e8+4 \n\t\tval %= mod;\n\t}\n\t\n\tinline void pushdown(){ \n\t\tlson->add(lazyA,lazyB,lazyC);\n\t\trson->add(lazyA,lazyB,lazyC);\n\t\t\n\t\tlazyA=lazyB=lazyC = 0;\n\t}\n}*root;\n\nlong long a[200009],sum[200009],ssum[200009];\n\nseg* BuildTree(int L,int R){\n\tseg* cur = new seg();cur->segL=L;cur->segR=R;\n\tif(L==R){\n\t\tcur->val = ssum[L];\n\t\treturn cur;\n\t}\n\t\n\tint mid = L+R>>1;\n\tcur->lson = BuildTree(L,mid);\n\tcur->rson = BuildTree(mid+1,R);\n\tcur->update();\n\treturn cur;\n}\n\nint n,m;\n\n// [L,R]\nvoid Add1(seg* cur,long long L,long long R,long long d){\n\tif(cur->segR < L || cur->segL > R){\n\t\treturn;\n\t}\n\tif(cur->segL >= L && cur->segR <= R){\n\t\t\n\t\tcur->add( //\u7b97\u4e00\u6b65\u819c\u4e00\u6b65\u9632\u70b8\n\t\t\td, //a\n\t\t\t(3*d%mod - 2*L%mod*d%mod) % mod, //b\n\t\t\t(d*L%mod*L%mod - 3*d%mod*L%mod + 2*d%mod) % mod //c\n\t\t);\n\t\treturn;\n\t}\n\tcur->pushdown();\n\tAdd1(cur->lson,L,R,d);\n\tAdd1(cur->rson,L,R,d);\n\tcur->update();\n}\n\n// (R,n]\nvoid Add2(seg* cur,long long L,long long R,long long d){\n\tif(cur->segR <= R){ //\u6ce8\u610f\u8fd9\u91cc\u52a0\u7684\u662f (R,n] \n\t\treturn;\n\t}\n\tif(cur->segL > R){\n\t\tcur->add( \n\t\t\t0, //a\n\t\t\t(2 * (R-L+1) % mod * d ) % mod, //b\n\t\t\t(d * (R-L) %mod *(R-L) %mod + 3*d %mod *(R-L) % mod + 2*d %mod - 2*R %mod *(R-L+1) %mod *d %mod) % mod //c\n\t\t);\n\t\treturn;\n\t}\n\tcur->pushdown();\n\tAdd2(cur->lson,L,R,d);\n\tAdd2(cur->rson,L,R,d);\n\tcur->update();\n}\n\nlong long QuerySum(seg* cur,int L,int R){\n\tif(cur->segL > R || cur->segR < L)return 0;\n\t\n\tif(cur->segL >= L && cur->segR <=R){\n\t\treturn cur->val;\n\t}\n\tcur->pushdown();\n\tlong long ans = (QuerySum(cur->lson,L,R) + QuerySum(cur->rson,L,R)) % mod;\n\tcur->update();\n\treturn ans;\n}\n\nvoid dfs(seg* cur){ // \u904d\u5386\uff0c\u8c03\u8bd5\u7528\u7684\n\t\n\tif(!cur->lson){\n\t\tcout<<\"[\"<<cur->segL<<\",\"<<cur->segR<<\"]: \"<<cur->val<<endl;\n\t\treturn;\n\t}\n\t\n\tcur->pushdown();\n\tdfs(cur->lson);\n\tdfs(cur->rson);\n\tcur->update();\n\tcout<<\"[\"<<cur->segL<<\",\"<<cur->segR<<\"]: \"<<cur->val<<endl;\n}\n\nvoid displaySsum(){ // \u8c03\u8bd5\u7528\n\tfor(int i=1; i<=n; i++){\n\t\tcout<<ssum[i]<<' ';\n\t}cout<<endl;\n}\n\nvoid edit(int L,int R,int d){ // \u5bf9\u62cd\u7528\u7684\u66b4\u529b\u7248\n\tfor(int idx=L; idx<=R; idx++){\n\t\tssum[idx] += (d*(idx-L)*(idx-L)+3*d*(idx-L)+2*d) / 2;\n\t}\n\tfor(int idx=R+1; idx<=n; idx++){\n\t\tssum[idx] += (d*(R-L)*(R-L)+3*d*(R-L)+2*d) / 2 + (idx-R) * (R-L+1) * d;\n\t}\n}\n\nint main(){\n\tcin>>n>>m;\n\tfor(int i=1; i<=n; i++){\n\t\tcin>>a[i];\n//\t\ta[i] = rand();\n\t\tsum[i]= (sum[i-1] + a[i]) % mod;\n\t\tssum[i]= (ssum[i-1] + sum[i]) % mod;\n\t}\n\troot = BuildTree(1,n);\n\t\n\twhile(m--){\n\t\tchar cmd;cin>>cmd;\n\t\tswitch(cmd){\n\t\t\tcase '1':{\n\t\t\t\tint u,v,d;cin>>u>>v>>d;\n\t\t\t\tif(u>v)swap(u,v);\n\t\t\t\tAdd1(root,u,v,d);\n\t\t\t\tAdd2(root,u,v,d);\n\t\t\t\t\n//\t\t\t\tedit(u,v,d);\n\t\t\t\t\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase '2':{\n\t\t\t\tint max,min;cin>>min>>max;\n\t\t\t\tlong long ans = ((QuerySum(root,n,n)*(max-min+1))%mod - QuerySum(root,min-1,max-1) - QuerySum(root,n-max,n-min))%mod;\n\t\t\t\twhile(ans<0)ans += mod;\n\t\t\t\tcout<<ans%mod<<endl;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\t\n\treturn 0;\n}\n```\n",
        "postTime": 1629811102,
        "uid": 130352,
        "name": "\u4e00\u4e32\u6570\u5b57",
        "ccfLevel": 7,
        "title": "P4458 [BJOI2018]\u94fe\u4e0a\u4e8c\u6b21\u6c42\u548c   \u65b0\u624b\u5411\u9898\u89e3"
    },
    {
        "content": "\u5927\u6bd2\u7624\u9898\u3002\n\n\u533a\u95f4\u4e0d\u592a\u597d\u505a\uff0c\u56e0\u6b64\u5148\u8003\u8651\u5728 $p$ \u4f4d\u7f6e $+k$\u3002\n\n\u8bbe $D=\\min(p,n-p+1),U=\\max(p,n-p+1)$\u3002\n\n\u90a3\u4e48\u5bf9\u4e8e\u957f\u5ea6 $x\\leq D$ \u7684\u533a\u95f4\uff0c\u6070\u6709 $x$ \u4e2a\u662f\u5305\u542b $p$ \u7684\uff0c\u8d21\u732e\u4e3a $kx$\u3002\n\n\u5bf9\u4e8e\u957f\u5ea6 $x\\in(D,U)$ \u7684\u533a\u95f4\uff0c\u5305\u542b $p$ \u7684\u4e2d\u6709\u4e00\u8fb9\u5df2\u7ecf\u88ab\u56fa\u5b9a\uff0c\u6240\u4ee5\u8d21\u732e\u4e3a $Dk$\u3002\n\n\u5bf9\u4e8e\u957f\u5ea6\u4e3a $x\\geq U$ \u7684\u533a\u95f4\uff0c\u6709 $n-x+1$ \u4e2a\u662f\u5305\u542b $p$ \u7684\uff0c\u8d21\u732e\u4e3a $(n-x+1)k$\u3002\n\n\u4e0d\u96be\u53d1\u73b0\u8fd9\u662f\u4e00\u4e2a\u5206\u6bb5\u4e00\u6b21\u51fd\u6570\u3002\n\n\u5bf9\u4e8e $[l,r]$ \u4e2d\u8fdb\u884c\u533a\u95f4\u52a0\uff0c\u53ea\u9700\u8981\u628a\u8fd9\u4e9b\u60c5\u51b5\u90fd\u53e0\u52a0\u8d77\u6765\u5c31\u597d\u4e86\uff0c\u6240\u4ee5\u5e94\u8be5\u662f\u5206\u6bb5\u4e8c\u6b21\u51fd\u6570\u3002\n\n\u8003\u8651 $l,r$ \u5747\u5728 $n/2$ \u7684\u540c\u4e00\u4fa7\u7684\u60c5\u51b5\u3002\n\n\u8bbe $D1=\\min(D_l,D_r),D2=\\max(D_l,D_r),U2=\\min(U_l,U_r),U1=\\max(U_l,U_r)$\u3002\n\n$x\\in[1,D1],\\Delta=(r-l+1)kx$\n\n$x\\in(D1,D2),\\Delta=-\\frac{1}{2}kx^2+k(r-l+D1+\\frac{1}{2})x-\\frac{1}{2}k(D1-1)D1$\n\n$x\\in[D2,U2],\\Delta=\\dfrac{(D1+D1)(D2-D1+1)}{2}k$\n\n$x\\in(U2,U1),\\Delta=-\\frac{1}{2}kx^2-k(r-l-U1+\\frac{1}{2})x+\\frac{1}{2}k(D1+n)U1+k(r-l+1-U1)(n+1)$\n\n$x\\in[U1,n],\\Delta=-k(r-l+1)x+k(r-l+1)(n+1)$\n\n\u4e8e\u662f\u7ebf\u6bb5\u6811\u7ef4\u62a4\u533a\u95f4\u52a0\u4e8c\u6b21\u51fd\u6570\u5373\u53ef\n\n```cpp\n#include <bits/stdc++.h>\n\nusing namespace std;\n\n# define Rep(i,a,b) for(int i=a;i<=b;i++)\n# define _Rep(i,a,b) for(int i=a;i>=b;i--)\n# define RepG(i,u) for(int i=head[u];~i;i=e[i].next)\n\ntypedef long long ll;\ntypedef double db;\n\n# define chkmax(a,b) a=max(a,b)\n# define chkmin(a,b) a=min(a,b)\n# define PII pair<int,int>\n# define mkp make_pair\n\nconst int N=2e5+5;\nconst int mod=1e9+7;\nconst int inv2=5e8+4;\n\ntemplate<typename T> void read(T &x){\n    x=0;int f=1;\n    char c=getchar();\n    for(;!isdigit(c);c=getchar())if(c=='-')f=-1;\n    for(;isdigit(c);c=getchar())x=(x<<1)+(x<<3)+c-'0';\n    x*=f;\n}\n\nint n,q;\nint a[N];\nint sum[N],sum2[N];\n\nint inc(int x,int y){\n    return x+y>=mod?x+y-mod:x+y;\n}\n\nint dec(int x,int y){\n    return x<y?x-y+mod:x-y;\n}\n\nint linsum(int x){\n    return 1ll*x*(x+1)/2%mod;\n}\n\nint sqrsum(int x){\n    return 1ll*x*(x+1)*(2*x+1)/6%mod;\n}\n\nstruct node{\n    int l,r,sum;\n    int a,b,c;\n}seg[N<<2];\n\n# define lc (u<<1)\n# define rc (u<<1|1)\n\nvoid pushup(int u){\n    seg[u].sum=inc(seg[lc].sum,seg[rc].sum);\n}\n\nvoid renew(int u,int a,int b,int c){\n    seg[u].sum=inc(seg[u].sum,1ll*c*(seg[u].r-seg[u].l+1)%mod);\n    seg[u].sum=inc(seg[u].sum,1ll*b*dec(linsum(seg[u].r),linsum(seg[u].l-1))%mod);\n    seg[u].sum=inc(seg[u].sum,1ll*a*dec(sqrsum(seg[u].r),sqrsum(seg[u].l-1))%mod);\n    seg[u].a=inc(seg[u].a,a);\n    seg[u].b=inc(seg[u].b,b);\n    seg[u].c=inc(seg[u].c,c);\n}\n\nvoid pushdown(int u){\n    renew(lc,seg[u].a,seg[u].b,seg[u].c);\n    renew(rc,seg[u].a,seg[u].b,seg[u].c);\n    seg[u].a=seg[u].b=seg[u].c=0;\n}\n\nvoid build(int u,int l,int r){\n    seg[u].l=l,seg[u].r=r;\n    if(l==r){\n        seg[u].sum=dec(dec(sum2[n],sum2[l-1]),sum2[n-l]);\n        return;\n    }\n    int mid=l+r>>1;\n    build(lc,l,mid);\n    build(rc,mid+1,r);\n    pushup(u);\n}\n\nvoid update(int u,int l,int r,int a,int b,int c){\n    if(seg[u].l>=l&&seg[u].r<=r){\n        renew(u,a,b,c);\n        return;\n    }\n    pushdown(u);\n    int mid=seg[u].l+seg[u].r>>1;\n    if(l<=mid)update(lc,l,r,a,b,c);\n    if(r>mid)update(rc,l,r,a,b,c);\n    pushup(u);\n}\n\nint query(int u,int l,int r){\n    if(seg[u].l>=l&&seg[u].r<=r)return seg[u].sum;\n    pushdown(u);\n    int mid=seg[u].l+seg[u].r>>1;\n    if(r<=mid)return query(lc,l,r);\n    else if(l>mid)return query(rc,l,r);\n    else return inc(query(lc,l,r),query(rc,l,r));\n}\n\nvoid solve(int l,int r,int k){\n    int D1=min(l,n-l+1),D2=min(r,n-r+1),U1=max(l,n-l+1),U2=max(r,n-r+1);\n    if(D1>D2)swap(D1,D2);\n    if(U1<U2)swap(U1,U2);\n    update(1,1,D1,0,1ll*k*(r-l+1)%mod,0);\n    if(D1<D2)\n    update(1,D1+1,D2,mod-1ll*inv2*k%mod,1ll*k*inc(inv2,r-l+D1)%mod,mod-1ll*k*inv2%mod*D1%mod*(D1-1)%mod);\n    if(D2<U2)\n    update(1,D2+1,U2,0,0,1ll*k*(D1+D2)%mod*(D2-D1+1)%mod*inv2%mod);\n    if(U2<U1)\n    update(1,U2+1,U1,mod-1ll*inv2*k%mod,mod-1ll*k*dec(r+inv2,l+U1)%mod,\n    inc(1ll*inv2*(D1+n)%mod*U1%mod*k%mod,1ll*k*dec(r+1,l+U1)%mod*(n+1)%mod));\n    if(U1<n)\n    update(1,U1+1,n,0,mod-1ll*k*(r-l+1)%mod,1ll*k*(r-l+1)%mod*(n+1)%mod);\n}\n\nint main()\n{\n    read(n),read(q);\n    Rep(i,1,n)read(a[i]);\n    Rep(i,1,n)sum[i]=inc(sum[i-1],a[i]);\n    Rep(i,1,n)sum2[i]=inc(sum2[i-1],sum[i]);\n    build(1,1,n);\n    while(q--){\n        int opt,l,r,k;\n        read(opt),read(l),read(r);\n        if(opt==1){\n            read(k);\n            if(l>r)swap(l,r);\n            if(l<=n/2&&r>n/2)solve(l,n/2,k),solve(n/2+1,r,k);\n            else solve(l,r,k);\n        }\n        else printf(\"%d\\n\",query(1,l,r));\n    }\n    return 0;\n}\n```",
        "postTime": 1646202807,
        "uid": 97344,
        "name": "devout",
        "ccfLevel": 9,
        "title": "P4458 [BJOI2018]\u94fe\u4e0a\u4e8c\u6b21\u6c42\u548c"
    }
]