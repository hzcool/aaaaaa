[
    {
        "content": "stO sgygd Orz\n\n\u8fd9\u662f\u4e00\u4e2a\u6211\u81ea\u5df1\u7f16\u7684\u505a\u6cd5\uff0c\u4e0d\u77e5\u9053\u548c std \u662f\u5426\u4e00\u6837\u3002\n\n\u4e4d\u4e00\u770b\u8fd9\u9053\u9898\u7684\u4f20\u9001\u95e8\u548c\u4e00\u5927\u5806\u5947\u602a\u7684\u9650\u5236\u4e00\u70b9\u601d\u8def\u90fd\u6ca1\u6709\u3002\n\n\u6211\u4eec\u5148\u6765\u5206\u6790\u4e00\u4e0b\u5efa\u7acb\u4e00\u5bf9\u4f20\u9001\u95e8\u5b9e\u9645\u4e0a\u4f1a\u53d1\u751f\u4ec0\u4e48\u3002\n\n\u53ef\u4ee5\u53d1\u73b0\uff0c\u5728 $(u_1,v_1)$ \u4e0a\u548c $(u_2,v_2)$ \u4e0a\u5efa\u7acb\u4e00\u5bf9\u4f20\u9001\u95e8\u76f8\u5f53\u4e8e\u65ad\u5f00 $(u_1,v_1)$ \u548c $(u_2,v_2)$\uff0c\u5e76\u8fde\u63a5 $(u_1,u_2)$ \u548c $(v_2,v_2)$\u3002\n\n\u663e\u7136\u4e0a\u9762\u7684\u64cd\u4f5c\u4e0d\u4f1a\u6539\u53d8\u6bcf\u4e2a\u70b9\u7684\u5ea6\u6570\uff0c\u5e76\u4e14\u5f31\u4e8e\u6bcf\u6b21\u4ea4\u6362\u4e24\u4e2a\u70b9\u7684\u7236\u4eb2\u3002\u7531\u4e8e\u9898\u76ee\u8981\u6c42\u6700\u7ec8\u6bcf\u4e2a\u70b9\u90fd\u8981\u80fd\u591f\u5230\u8fbe\uff0c\u6240\u4ee5\u6700\u7ec8\u72b6\u6001\u4e5f\u5fc5\u987b\u662f\u4e00\u68f5\u6811\u3002\n\n\u6ce8\u610f\uff1a\u8fd9\u91cc\u4ea4\u6362\u4e24\u4e2a\u70b9\u7684\u7236\u4eb2\u53ef\u80fd\u4f1a\u5728\u8fc7\u7a0b\u4e2d\u4ea7\u751f\u73af\uff0c\u4f46\u8fd9\u5e76\u4e0d\u91cd\u8981\uff0c\u53ea\u8981\u4fdd\u8bc1\u6700\u7ec8\u662f\u4e00\u68f5\u6811\u5373\u53ef\u3002\n\n\u663e\u7136\u5982\u679c\u65b0\u6811\u4e2d\u6bcf\u4e2a\u70b9\u7684\u5ea6\u6570\u90fd\u4e0e\u539f\u6811\u4e00\u6837\uff0c\u90a3\u4e48\u4e00\u5b9a\u53ef\u4ee5\u8fbe\u5230\u8fd9\u4e2a\u72b6\u6001\u3002\n\n\u73b0\u5728\u6211\u4eec\u7684\u76ee\u6807\u5c31\u662f\u4f7f\u5f97\u65b0\u6811\u4e2d\u6240\u6709\u5173\u952e\u70b9\u7684\u6df1\u5ea6\u4e4b\u548c\u6700\u5c0f\u3002\n\n\u5148\u8003\u8651\u4e00\u4e2a\u66b4\u529b\u505a\u6cd5\u3002\n\n\u628a\u6240\u6709\u7684\u70b9\uff08\u9664\u4e86\u6839\u8282\u70b9\uff09\u6309\u7167\u5ea6\u6570\u4ece\u5927\u5230\u5c0f\u6392\u5e8f\u3002\u5982\u679c\u67d0\u4e2a\u5173\u952e\u70b9\u4e0e\u975e\u5173\u952e\u70b9\u5ea6\u6570\u4e00\u6837\uff0c\u90a3\u4e48\u5173\u952e\u70b9\u6392\u5728\u524d\u9762\u3002\n\n\u6211\u4eec\u9700\u8981\u8003\u8651\u7684\u662f\u65b0\u6811\u4e2d\u6240\u6709\u5173\u952e\u70b9\u548c\u6839\u8282\u70b9\u5f62\u6210\u7684\u865a\u6811\u3002\n\n\u663e\u7136\u865a\u6811\u4e2d\u6240\u6709\u975e\u5173\u952e\u8282\u70b9\u4e00\u5b9a\u5904\u4e8e\u4e00\u4e2a\u524d\u7f00\u4e2d\uff08\u4e5f\u5c31\u662f\u5c3d\u91cf\u5927\uff09\uff0c\u5426\u5219\u80af\u5b9a\u4e0d\u4f18\u3002\n\n\u6211\u4eec\u679a\u4e3e\u8fd9\u4e2a\u524d\u7f00\uff0c\u7136\u540e\u8d2a\u5fc3\u5730\u628a\u6240\u6709\u865a\u6811\u4e2d\u7684\u8282\u70b9\u6309\u7167\u5ea6\u6570\u4ece\u5927\u5230\u5c0f\u4f9d\u6b21\u52a0\u5165\uff0c\u6bcf\u6b21\u9009\u62e9\u4e00\u4e2a\u6df1\u5ea6\u6700\u6d45\u7684\u8fd8\u6ca1\u8fde\u6ee1\u7684\u70b9\u8fde\u4e0a\u53bb\u3002\u8fd9\u6837\u4e00\u5b9a\u662f\u6700\u4f18\u7684\uff08\u611f\u6027\u7406\u89e3\uff09\u3002\n\n\u6ce8\u610f\uff1a\u5982\u679c\u6709\u81f3\u5c11\u4e00\u4e2a\u70b9\u4e0d\u5728\u865a\u6811\u4e2d\uff0c\u5219\u9700\u8981\u4fdd\u8bc1\u8fde\u5b8c\u4e4b\u540e\u81f3\u5c11\u8fd8\u5269\u4e00\u4e2a\u70b9\u6ca1\u6709\u8fde\u6ee1\uff0c\u5426\u5219\u5c31\u4e0d\u5408\u6cd5\u4e86\u3002\n\n\u81f3\u6b64\u6211\u4eec\u5c31\u5f97\u5230\u4e86\u4e00\u4e2a $O(n^2)$ \u505a\u6cd5\u3002\n\n\u90a3\u4e48\u5982\u4f55\u4f18\u5316\u5b83\u5462\uff1f\n\n\u6211\u4eec\u628a\u6bcf\u6b21\u52a0\u5165\u4e00\u4e2a\u8282\u70b9\u6539\u4e3a\u6bcf\u6b21\u52a0\u5165\u4e00\u5c42\u8282\u70b9\u3002\n\n\u5982\u679c\u5f53\u524d\u52a0\u5165\u7684\u8fd9\u4e00\u5c42\u7684\u6240\u6709\u70b9\u5ea6\u6570\u90fd $\\ge 2$\uff0c\u90a3\u4e48\u8fd9\u4e00\u5c42\u7684\u5ea6\u6570\u603b\u548c\u81f3\u5c11\u662f\u4e0a\u4e00\u5c42\u7684 $2$ \u500d\u3002\n\n\u800c\u6240\u6709\u70b9\u7684\u5ea6\u6570\u548c\u662f $O(n)$ \u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u6837\u7684\u5c42\u6570\u4e0d\u4f1a\u8d85\u8fc7 $O(\\log n)$\uff01\n\n\u5728\u679a\u4e3e\u5b8c\u6240\u6709\u8fd9\u6837\u7684\u5c42\u4e4b\u540e\uff0c\u5269\u4e0b\u7684\u70b9\u7684\u5ea6\u6570\u5c31\u90fd $\\le 1$ \u4e86\uff0c\u53ef\u4ee5\u76f4\u63a5 $O(1)$ \u7279\u5224\u6389\u3002\n\n\u5229\u7528\u8fd9\u79cd\u505a\u6cd5\u5c31\u53ef\u4ee5 $O(\\log n)$ \u5730\u7b97\u51fa\u67d0\u4e00\u4e2a\u524d\u7f00\u7684\u7b54\u6848\u3002\u6784\u9020\u65b9\u6848\u65f6\u53ea\u9700\u8981\u8bb0\u5f55\u7b54\u6848\u6700\u4f18\u7684\u524d\u7f00\uff0c\u7136\u540e\u518d $O(n)$ \u6a21\u62df\u4e00\u904d\u4e4b\u524d\u7684\u505a\u6cd5\u5373\u53ef\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log n)$\u3002\n\n\u53c2\u8003\u4ee3\u7801\uff1a\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n#define N 100005\n#define LIM 1000005\n#define ll long long\n#define pb push_back\n#define gc() (P1==P2 && (P2=(P1=buf)+fread(buf,1,LIM,stdin),P1==P2)?EOF:*P1++)\nconst ll INF=1e18;char *P1,*P2,buf[LIM];\nint T,n,m,c,nw,tmp,cnt,dg[N],fa[N],fe[N],fa1[N],z[N],z1[N],s[N],q[N];ll w,res,ans1;\nbool tg[N],tg1[N];set<int> ps[N];struct Edge {int v,id;};vector<Edge> e[N];\nstruct Node {int x;bool tg;};vector<Node> ans[N];\nint rd()\n{\n\tint res=0;char c=0;while(!isdigit(c)) c=gc();\n\twhile(isdigit(c)) res=res*10+c-48,c=gc();return res;\n}\nvoid print(int x) {if(x<10) {putchar(x+48);return;}print(x/10);putchar(x%10+48);return;}\nbool cmp(int x,int y) {return dg[x]*2+tg1[x]==dg[y]*2+tg1[y]?x<y:dg[x]*2+tg1[x]<dg[y]*2+tg1[y];}\nvoid f(int u,int v) {++nw;ans[fe[u]].pb((Node) {nw,tg[u]});ans[fe[v]].pb((Node) {nw,!tg[v]});}\nvoid dfs(int u,int f)\n{fa[u]=f;for(auto i:e[u]) if(i.v!=f) tg[i.v]=i.id<0,fe[i.v]=abs(i.id),++dg[u],dfs(i.v,u);}\nll slv1(int x,int d,int w1,int w2)\n{\n\tint t;ll res=0;if(x<=w1) {return x<w1 || s[x]?1ll*x*d:INF;}\n\tres=1ll*w1*d;++d;x-=w1;w2+=s[x+w1]-s[x];if(!w2) return INF;\n\twhile(1)\n\t{\n\t\tif(x<=w2) {return x<w2 || s[x]?res+1ll*x*d:INF;}\n\t\tres+=1ll*w2*d;++d;x-=w2;w2=s[x+w2]-s[x];if(dg[z1[x]]<2) break;\n\t}if(min(x,cnt)>=w2) return INF;t=x/w2;return res+1ll*(d*2+t-1)*t*w2/2+1ll*(d+t)*(x%w2);\n}\nvoid slv()\n{\n\tn=rd();m=rd();c=rd();if(n==1) {puts(\"0\");return;}nw=cnt=w=0;q[0]=2;q[1]=1;\n\tfor(int i=1;i<=n;++i) dg[i]=fa1[i]=tg1[i]=0,z[i]=i,ps[i].clear(),e[i].clear(),ans[i].clear();\n\tfor(int i=1,u,v;i<n;++i) u=rd(),v=rd(),e[u].pb((Edge) {v,i}),e[v].pb((Edge) {u,-i});\n\tfor(int i=1;i<=m;++i) z1[i]=rd(),tg1[z1[i]]=1;dfs(1,0);\n\t\n\tsort(z+2,z+n+1,cmp);sort(z1+1,z1+m+1,cmp);for(int i=1;i<=m;++i) s[i]=s[i-1]+dg[z1[i]];\n\tfor(int i=1;i<=m;++i) if(!dg[z1[i]]) ++cnt;tmp=n+1;ans1=slv1(m,1,dg[1],0);\n\tfor(int i=n,t=m,d=1,w1=dg[1],w2=0;i>1;--i)\n\t{\n\t\tif(tg1[z[i]]) --t,w+=d;--w1;w2+=dg[z[i]];if(!w1) ++d,swap(w1,w2);\n\t\tres=w+(i>2?slv1(t,d,w1,w2):0);if(res<ans1) tmp=i,ans1=res;\n\t}for(int i=1;i<=dg[1];++i) q[++q[1]]=1;\n\tfor(int i=n;i>1;--i) if(i>=tmp || tg1[z[i]])\n\t{fa1[z[i]]=q[q[0]++];for(int j=1;j<=dg[z[i]];++j) q[++q[1]]=z[i];}\n\tfor(int i=n;i>1;--i) if(!fa1[z[i]])\n\t{fa1[z[i]]=q[q[0]++];for(int j=1;j<=dg[z[i]];++j) q[++q[1]]=z[i];}\n\t\n\tprintf(\"%lld\\n\",ans1);for(int i=2;i<=n;++i) ps[fa[i]].insert(i);\n\tfor(int i=2,t;i<=n;++i) if(fa[i]!=fa1[i])\n\t{\n\t\tt=*ps[fa1[i]].begin();ps[fa[i]].erase(i);\n\t\tf(i,t);ps[fa[t]].erase(t);ps[fa[i]].insert(t);swap(fa[i],fa[t]);\n\t}else ps[fa[i]].erase(i);\n\tfor(int i=2;i<=n;++i) if(tg[i]) reverse(ans[fe[i]].begin(),ans[fe[i]].end());\n\tfor(int i=1;i<n;++i)\n\t{\n\t\tprint(ans[i].size());putchar(' ');\n\t\tfor(auto j:ans[i]) print(j.x),putchar(' '),print(j.tg),putchar(' ');puts(\"\");\n\t}\n}\nint main() {T=rd();while(T--) slv();return 0;}\n```",
        "postTime": 1641136410,
        "uid": 119621,
        "name": "Kubic",
        "ccfLevel": 10,
        "title": "P8004 Welcome to Lunatic City"
    }
]