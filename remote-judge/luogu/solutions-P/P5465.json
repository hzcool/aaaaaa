[
    {
        "content": "\u8fd9\u662f\u4e00\u9053\u975e\u5e38\u6709\u8da3\u7684\u9898\u3002\n\n\u53ef\u4ee5\u5148\u505a$\\texttt{[SCOI2015]\u56fd\u65d7\u8ba1\u5212}$\u3002\n\n\u7f51\u7edc\u4e0a\u5f88\u591a\u9898\u89e3\u90fd\u4e0d\u6e05\u695a\u81ea\u5df1\u7684\u5199\u6cd5\u4e3a\u4ec0\u4e48\u662f\u5bf9\u7684\uff0c\u751a\u81f3\u8fde\u81ea\u5df1\u5b9a\u4e49\u7684\u6570\u7ec4\u662f\u4ec0\u4e48\u90fd\u4e0d\u77e5\u9053\uff0c\u975e\u5e38\u8bef\u4eba\u5b50\u5f1f\u3002\u4ed6\u4eec\u90fd\u6ca1\u60f3\u6e05\u695a\u3002\n\n\u6240\u4ee5\u6211\u6765\u53d1\u5e03\u4e00\u7bc7\u597d\u4e86\u3002\n\n------------\n\n\n\u8bbe$\\text{sum}_{i,j}$\u8868\u793a\u4ece$i$\u5230$j\\sim i$\u7684\u6240\u6709\u70b9\u7684\u6700\u5c0f\u6b65\u6570\u4e4b\u548c\u3002\n\n\u9996\u5148\uff0c\u6211\u4eec\u53d1\u73b0\u5982\u679c\u6c42\u51fa$\\text{sum}_{i,j}$\uff0c\n\n\u90a3\u4e48\u7b54\u6848\u5c31\u662f$\\frac 1{r-l+1}(\\text{sum}_{x,l}-\\text{sum}_{x,r+1})$\n\n\u600e\u4e48\u6c42\u5462\uff1f\u6211\u4eec\u8003\u8651\u4e00\u4e9b\u663e\u7136\u7684\u6027\u8d28\uff1a\n\n### \u6027\u8d28$1$\n\n\u4ece$x$\u51fa\u53d1\uff0c\u53ef\u4ee5\u4e00\u6b65\u5230\u8fbe\u6700\u8fdc\u7684\u70b9\u4e3a$l_x$\uff0c\u800c\u4e14\u53ef\u4ee5\u5230\u8fbe$[l_x,x-1]$\u7684\u6240\u6709\u70b9\u3002\n\n\u5e9f\u8bdd\uff01\n\n### \u6027\u8d28$2$\n\n\u5982\u679c$x$\u53ef\u4ee5$k$\u6b65\u5230\u8fbe\u70b9$y$\uff0c\u90a3\u4e48\u4e00\u5b9a\u53ef\u4ee5\u5230\u8fbe$[y,x-1]$\u3002\n\n\u597d\u50cf\u4e5f\u5f88\u5e9f\u8bdd\u5427...\n\n\n\n------------\n\n\u6211\u4eec\u8003\u8651\u5feb\u901f\u6c42$\\text{sum}_{l,x}$\n\n\u6211\u4eec\u7b2c\u4e00\u6b65\u4ece$x$\u5f00\u59cb\u8df3\uff0c\u53ef\u4ee5\u8df3\u5230\u54ea\u91cc\u5462\uff1f\n\n\u663e\u7136\u53ef\u4ee5\u8df3\u5230\u6700\u5c0f\u7684\u70b9\u4e3a$l_x$\u3002\u6700\u5927\u7684\u5462\uff1f\u662f$x$\uff1fnaive!\n\n\u6ce8\u610f\u5230\u9898\u76ee\u91cc\u7684\u8fb9\u662f\u53cc\u5411\u7684\uff01\n\n\u6240\u4ee5\uff0c\u6700\u5927\u7684\u70b9\uff0c\u5e94\u8be5\u662f\u6240\u4ee5\u6ee1\u8db3$l_k\\leq x(k>x)$\u7684$k$\u7684\u6700\u5927\u503c\uff01\n\n\u53ef\u80fd\u6709\u70b9\u7ed5\uff0c\u4e0d\u8fc7\u591a\u770b\u51e0\u6b21\u5c31\u660e\u767d\u4e86\u3002\n\n\u611f\u8c22 @Fee_cle6418 \u7684\u6307\u6b63\n\n\u7136\u540e\u6211\u4eec\u7b2c\u4e8c\u6b21\u8df3\u8dc3\uff0c\u53ef\u4ee5\u5230\u8fbe\u6700\u5c0f\u7684\u70b9\u662f\u4ec0\u4e48\u5462\uff1f\n\n\u8fd9\u91cc\u7ed9\u51fa\u7ed3\u8bba\uff0c\u662f\n\n$$\\min_{i=l_x}^nl_i$$\n\n\u4f60\u53ef\u80fd\u60f3\u95ee\uff0c\u4e3a\u4ec0\u4e48\u662f$n$\u800c\u4e0d\u662f$k_{\\max}???$\n\n\u4e8b\u5b9e\u4e0a\u4e24\u8005\u5747\u53ef\uff0c\u4f46\u662f\u524d\u8005\u8868\u8ff0\u8d77\u6765\u65b9\u4fbf\u3002\n\n\u56e0\u4e3a\uff0c\u5bf9\u4e8e$(k_{\\max}+1)\\sim n$\u4e4b\u95f4\u7684\u6240\u6709\u70b9\uff0c\u5176$l_i$\u5bf9\u7b54\u6848\u4e0d\u53ef\u80fd\u9020\u6210\u8d21\u732e\u3002\u56e0\u4e3a\u5b83\u4eec\u7684$l$\u503c\u6bd4$x$\u8fd8\u5927\u3002\n\n\u4ee5\u6b64\u7c7b\u63a8\uff0c\u8bbe\u7b2c$a(a>1)$\u6b21\u7684\u53ef\u4ee5\u5230\u8fbe\u6700\u5c0f\u7684\u70b9\u4e3a$b$\uff0c\u7b2c$a+1$\u6b21\u8df3\u8dc3\u53ef\u4ee5\u5230\u8fbe\u6700\u5c0f\u7684\u70b9\u5c31\u662f\n\n$$\\min_{i=b}^nl_i$$\n\n\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u7528\u500d\u589e\u4f18\u5316\u4e86\u3002\n\n\u8bbe$f_{i,0}$\u8868\u793a$\\min\\limits_{k=i}^nl_k,f_{i,j}=\\min\\limits_{k=f_{i,j-1}}^nl_k,g_{i,j}$\u8868\u793a$i$\u5230$f_{i,j}\\sim (i-1)$\u6240\u6709\u70b9\u7684\u6700\u5c0f\u6b65\u6570\u4e4b\u548c\u3002\n\n#### \u5177\u4f53\u8f6c\u79fb\n\n$$f_{i,j}=f_{f_{i,j-1},j-1}$$\n\n$$g_{i,j}=g_{i,j-1}+g_{f_{i,j-1},j-1}+2^{j-1}(f_{i,j-1}-f_{i,j})$$\n\n\u8fd9\u4e2a\u8f6c\u79fb\u753b\u753b\u56fe\u5c31\u7406\u89e3\u4e86\u3002\n\n\u5177\u4f53\u6c42\u6cd5\u5b9e\u73b0\u770b\u770b\u4ee3\u7801\u5427\uff0c\u8fd9\u91cc\u4e0d\u65b9\u4fbf\u53d9\u8ff0\u3002\n\n\n```\ninline ll get(ll x,ll to){//\u8868\u793ax->(to~x-1)\u5185\u6240\u6709\u70b9\u7684\u7b54\u6848\u3002\n    if (L[x]<=to) return x-to;//\u7279\u5224\n    ll ans=x-L[x],tot=1;x=L[x];//\u7b2c\u4e00\u8df3\u8dc3\u6bd4\u8f83\u7279\u6b8a\uff0c\u4e0a\u6587\u6709\u5199\u5230\u3002\n    //tot\u8868\u793a\u5df2\u7ecf\u8df3\u4e86\u591a\u5c11\u6b65\n    for (int i=20;i>=0;i--){\n        if (f[x][i]>=to){//\u5982\u679c\u8df32^i\u6b21\u8fd8\u65e0\u6cd5\u5230\u8fbe\n            ans+=tot*(x-f[x][i])+g[x][i];//\u5148\u7b97\u4e0a\u7b54\u6848\uff0c\u800c\u4e14\u8fd9\u4e9b\u70b9\u8df3\u5230\u8d77\u59cb\u70b9\u4f9d\u65e7\u9700\u8981\u8df3tot\u6b65\u3002\n            tot+=(1<<i);x=f[x][i];\n        }\n    }\n    if (x>to) ans+=tot*(x-to)+x-to;//\u6700\u540e\u6ca1\u6709\u8df3\u6ee1\uff0c\u7b97\u4e0a\u6b8b\u4f59\u7b54\u6848\u3002\n    return ans;\n}\n```\n\n\u5b8c\u6574\u4ee3\u7801\uff1a\n\n```cpp\n#include<bits/stdc++.h>\n#define ll long long\n#define ljc 998244353\nusing namespace std;\n#ifdef Fading\n#define gc getchar\n#endif\n#ifndef Fading\ninline char gc(){\n    static char now[1<<16],*S,*T;\n    if (T==S){T=(S=now)+fread(now,1,1<<16,stdin);if (T==S) return EOF;}\n    return *S++;\n}\n#endif\ninline ll read(){\n    register ll x=0,f=1;char ch=gc();\n    while (!isdigit(ch)){if(ch=='-')f=-1;ch=gc();}\n    while (isdigit(ch)){x=(x<<3)+(x<<1)+ch-'0';ch=gc();}\n    return (f==1)?x:-x;\n}\nint f[302001][21],g[302001][21],L[302001],n,Q;\ninline ll get(ll x,ll to){\n    if (L[x]<=to) return x-to;\n    ll ans=x-L[x],tot=1;x=L[x];\n    for (int i=20;i>=0;i--){\n        if (f[x][i]>=to){\n            ans+=tot*(x-f[x][i])+g[x][i];\n            tot+=(1<<i);x=f[x][i];\n        }\n    }\n    if (x>to) ans+=tot*(x-to)+x-to;\n    return ans;\n}\nsigned main(){\n    n=read();\n    for (int i=2;i<=n;i++){\n        L[i]=read();\n    }\n    f[n][0]=L[n];g[n][0]=n-L[n];\n    for (int i=n-1;i>=2;i--){\n        f[i][0]=min(f[i+1][0],L[i]);\n        g[i][0]=i-f[i][0];\n    }\n    for (int j=1;j<=20;j++){\n        for (int i=(1<<j);i<=n;i++){\n            f[i][j]=f[f[i][j-1]][j-1];\n            g[i][j]=g[i][j-1]+g[f[i][j-1]][j-1]+(1<<j-1)*(f[i][j-1]-f[i][j]);\n        }\n    }\n    Q=read();\n    while (Q--){\n    \tint l=read(),r=read(),X=read();\n    \tll fz=get(X,l)-get(X,r+1),fm=(r-l+1),G=__gcd(fz,fm);\n    \tfz/=G;fm/=G;\n    \tprintf(\"%lld/%lld\\n\",fz,fm);\n    }\n    return 0;\n}\n\n```\n\n",
        "postTime": 1563416192,
        "uid": 20309,
        "name": "Fading",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P5465 \u3010[PKUSC2018]\u661f\u9645\u7a7f\u8d8a\u3011"
    },
    {
        "content": "\u9996\u5148\u8003\u8651\u9898\u76ee\u7684\u6027\u8d28\uff0c\u53d1\u73b0\u70b9\u5411\u533a\u95f4\u8fde\u7684\u8fb9\u4e3a\u53cc\u5411\u8fb9\uff0c\u6240\u4ee5\u4e5f\u5c31\u53ef\u4ee5\u4ece\u4e00\u4e2a\u70b9\u5411\u53f3\u8df3\u5230\u533a\u95f4\u5305\u542b\u8be5\u70b9\u7684\u70b9\uff0c\u5982\u56fe\u6240\u793a\uff1a\n\n![](https://s1.ax1x.com/2020/07/17/U6DHds.png)\n\n\u4f46\u4e8b\u5b9e\u4e0a\u5411\u540e\u8df3\u5176\u5b9e\u662f\u4e0d\u4f18\u7684\uff0c\u53ef\u4ee5\u6709\u66f4\u597d\u7684\u65b9\u6cd5\u6765\u8282\u7701\u82b1\u8d39\uff1a\n\n![](https://s1.ax1x.com/2020/07/17/U6DoLQ.png)\n\n\u56e0\u6b64\u6211\u4eec\u53d1\u73b0\u4e00\u4e2a\u70b9\u8df3\u5230\u5176\u524d\u4e00\u4e2a\u533a\u95f4\u7684\u82b1\u8d39\u4e3a $1$\uff0c\u4e14\u5728\u8df3\u8dc3\u8fc7\u7a0b\u4e2d\u4e0d\u4f1a\u5411\u53f3\u8df3\uff0c\u540c\u65f6\u6211\u4eec\u8fd8\u8bc1\u660e\u4e86\u4e00\u4e2a\u70b9\u5411\u5de6\u7684\u82b1\u8d39\u5355\u8c03\u9012\u589e\u3002\n\n\u4f46\u662f\u4ece\u8d77\u70b9\u8fdb\u884c\u7b2c\u4e00\u6b65\u8df3\u8dc3\u65f6\uff0c\u6709\u53ef\u80fd\u4f1a\u5411\u540e\u8df3\uff1a\n\n![](https://s1.ax1x.com/2020/07/17/U6rO7d.png)\n\n\u5176\u901a\u8fc7\u5411\u540e\u8df3\u6765\u5230\u8fbe\u4e00\u4e2a\u66f4\u5927\u7684\u5305\u542b\u8be5\u70b9\u7684\u533a\u95f4\uff0c\u7136\u540e\u4f7f\u4e0b\u4e00\u6b65\u8df3\u8dc3\u5230\u8fbe\u4e00\u4e2a\u66f4\u5411\u524d\u7684\u4f4d\u7f6e\uff0c\u7b2c\u4e00\u6b65\u91c7\u53d6\u5411\u540e\u8df3\u65b9\u6848\u7684\u82b1\u8d39\u4e3a $2$\u3002\n\n\u53d1\u73b0\u53ea\u6709\u7b2c\u4e00\u6b65\u662f\u7279\u6b8a\u7684\uff0c\u6240\u4ee5\u5355\u72ec\u6765\u8003\u8651\u7b2c\u4e00\u6b65\u7684\u60c5\u51b5\u3002\n\n\u8bbe $pos_i=\\min\\limits_{j=i}^n l_j$\uff0c\u5373 $l_i$ \u7684\u540e\u7f00\u6700\u5c0f\u503c\uff0c$pos_i$ \u5373\u4e3a\u4f4d\u7f6e $i$ \u7b2c\u4e00\u6b65\u91c7\u53d6\u5411\u540e\u8df3\u65b9\u6848\u6765\u5230\u8fbe\u7684\u6700\u5411\u524d\u7684\u4f4d\u7f6e\u3002\n\n\u5bf9\u6bcf\u4e2a\u4f4d\u7f6e\u5efa\u53ef\u6301\u4e45\u5316\u7ebf\u6bb5\u6811\uff0c\u7ebf\u6bb5\u6811\u4e2d\u5bf9\u5e94\u7684\u503c\u4e3a\u8be5\u4f4d\u7f6e\u4e0d\u8003\u8651\u7b2c\u4e00\u6b65\u7684\u82b1\u8d39\uff0c\u4f4d\u7f6e $i$ \u7684\u7ebf\u6bb5\u6811\u4ece\u4f4d\u7f6e $pos_i$ \u8f6c\u79fb\u8fc7\u6765\uff0c\u7136\u540e\u5728\u533a\u95f4 $[1,i-1]$ \u901a\u8fc7\u6807\u8bb0\u6c38\u4e45\u5316\u6765\u5b9e\u73b0\u533a\u95f4\u52a0\u4e00\uff0c\u8868\u793a\u4e0d\u662f\u7b2c\u4e00\u6b65\u8df3\u7684\u82b1\u8d39\u3002\n\n\u67e5\u8be2\u65f6\u53ea\u9700\u5728 $l_x$ \u6240\u5bf9\u5e94\u7684\u7ebf\u6bb5\u6811\u4e0a\u67e5\u8be2\u533a\u95f4 $[l,min(r,l_x-1)]$ \u7684\u548c\uff0c\u5176\u4e3a\u4f4d\u7f6e $x$  \u9664\u53bb\u7b2c\u4e00\u6b65\u7684\u603b\u82b1\u8d39\uff0c\u7136\u540e\u518d\u52a0\u4e0a\u7b2c\u4e00\u6b65\u82b1\u8d39\u7684\u8d21\u732e\u5373\u53ef\u3002\n\n$code:$\n\n```cpp\n#include<bits/stdc++.h>\n#define maxn 300010\n#define maxm 10000010\n#define mid ((l+r)>>1)\nusing namespace std;\ntypedef long long ll;\ntemplate<typename T> inline void read(T &x)\n{\n    x=0;char c=getchar();bool flag=false;\n    while(!isdigit(c)){if(c=='-')flag=true;c=getchar();}\n    while(isdigit(c)){x=(x<<1)+(x<<3)+(c^48);c=getchar();}\n    if(flag)x=-x;\n}\nint n,q,tot;\nint a[maxn],pos[maxn],rt[maxn],ls[maxm],rs[maxm];\nll sum[maxm],add[maxm];\nll gcd(ll a,ll b)\n{\n    return b?gcd(b,a%b):a;\n}\nvoid modify(int L,int R,int l,int r,int &cur)\n{\n    int x=++tot;\n    ls[x]=ls[cur],rs[x]=rs[cur],add[x]=add[cur];\n    sum[x]=sum[cur]+(min(R,r)-max(L,l)+1),cur=x;\n    if(L<=l&&R>=r)\n    {\n        add[cur]++;\n        return;\n    }\n    if(L<=mid) modify(L,R,l,mid,ls[cur]);\n    if(R>mid) modify(L,R,mid+1,r,rs[cur]);\n}\nll query(int L,int R,int l,int r,int cur)\n{\n    if(L>R) return 0;\n    if(L<=l&&R>=r) return sum[cur];\n    ll v=add[cur]*(min(R,r)-max(L,l)+1);\n    if(L<=mid) v+=query(L,R,l,mid,ls[cur]);\n    if(R>mid) v+=query(L,R,mid+1,r,rs[cur]);\n    return v;\n}\nint main()\n{\n    read(n);\n    for(int i=2;i<=n;++i) read(a[i]),pos[i]=a[i];\n    for(int i=n-1;i>=2;--i) pos[i]=min(pos[i],pos[i+1]);\n    for(int i=2;i<=n;++i) rt[i]=rt[pos[i]],modify(1,i-1,1,n,rt[i]);\n    read(q);\n    while(q--)\n    {\n        int l,r,x;\n        ll g,v;\n        read(l),read(r),read(x),v=r-l+1;\n        v+=query(l,min(r,a[x]-1),1,n,rt[a[x]]);\n        g=gcd(v,r-l+1),printf(\"%lld/%lld\\n\",v/g,(r-l+1)/g);\n    }\n    return 0;\n}\n```",
        "postTime": 1594994690,
        "uid": 172489,
        "name": "lhm_",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 P5465 \u3010[PKUSC2018]\u661f\u9645\u7a7f\u8d8a\u3011"
    },
    {
        "content": "## [[PKUSC2018]\u661f\u9645\u7a7f\u8d8a](https://www.luogu.com.cn/problem/P5465)\n\u53ef\u4ee5\u60f3\u5230\uff0c\u66b4\u529b\u505a\u6cd5\u5c31\u662f\u628a\u6574\u5f20\u56fe\u5efa\u51fa\u6765\uff0c\u7136\u540e\u6c42\u5168\u6e90\u6700\u77ed\u8def\uff0c\u6bcf\u6b21\u8be2\u95ee\u76f4\u63a5\u76f8\u52a0\u3002\u663e\u7136\uff0c\u8fd9\u6837\u7684\u505a\u6cd5\u662f\u65e0\u6cd5\u901a\u8fc7\u7684\uff0c\u90a3\u4e48\u6211\u4eec\u600e\u4e48\u4f18\u5316\u5b83\uff1f\n\u5982\u679c\u7528\u56fe\u8bba\u7684\u505a\u6cd5\uff0c\u6211\u4eec\u4f3c\u4e4e\u662f\u65e0\u6cd5\u505a\u4ec0\u4e48\u4f18\u5316\u7684\uff0c\u90a3\u4e48\u8003\u8651\u56fe\u8bba\u4ee5\u5916\u7684\u505a\u6cd5\u3002\n\n\u56e0\u4e3a $R$ \u4e0d\u4e00\u5b9a\u4e0e $x$ \u76f8\u90bb\uff0c\u90a3\u4e48\u8003\u8651\u662f\u5426\u8f6c\u6362\u6210\u76f8\u90bb\u597d\u6c42\u4e00\u70b9\u3002\u53ef\u4ee5\u53d1\u73b0\uff0c\u8be5\u95ee\u9898\u662f\u6ee1\u8db3\u524d\u7f00\u548c\u7684\u6027\u8d28\u7684\uff0c\u5373\u6211\u4eec\u53ef\u4ee5\u7528 $x$ \u5230 $[L,x-1]$ \u7684\u8ddd\u79bb\u548c\u51cf\u53bb\u5230 $[R+1,x-1]$ \u7684\u8ddd\u79bb\u548c\u3002\n\n\u6211\u4eec\u8c8c\u4f3c\u8fd8\u662f\u65e0\u6cd5\u60f3\u5230\u600e\u4e48\u505a\uff0c\u90a3\u4e48\u5c31\u6a21\u62df\u4e00\u4e0b\u6837\u4f8b\u3002\u6211\u4eec\u53d1\u73b0\uff0c\u5bf9\u4e8e $7$ \u53f7\u8282\u70b9\uff0c\u5b83\u5230 $1$ \u5230 $6$ \u53f7\u8282\u70b9\u7684\u8ddd\u79bb\u4f9d\u6b21\u662f $3,3,3,2,2,1$\u3002\u8fd9\u5c31\u542f\u53d1\u6211\u4eec\u662f\u4e0d\u662f\u53ef\u4ee5\u5206\u6bb5\u6765\u505a\uff0c\u56e0\u4e3a\u7b54\u6848\u5e8f\u5217\u662f\u5448\u73b0\u51fa\u4e00\u6bb5\u4e00\u6bb5\u76f8\u7b49\u7684\u6837\u5b50\u3002\u8fd9\u5c31\u9700\u8981\u4e00\u4e2a\u901a\u8fc7\u9884\u5904\u7406\u4e4b\u540e\uff0c\u6bcf\u6b21\u53ef\u4ee5\u8df3\u8fc7\u4e00\u4e2a\u533a\u95f4\uff0c\u5e76\u4e14\u5c06\u8fd9\u4e2a\u533a\u95f4\u7684\u7b54\u6848\u52a0\u4e0a\u7684\u9ad8\u6548\u7684\u65b9\u6cd5\uff0c\u90a3\u4e48\u8fd9\u662f\u4e0d\u662f\u500d\u589e\u5462\uff1f\n\n\u6839\u636e\u500d\u589e\u7684\u60ef\u4f8b\uff0c\u6211\u4eec\u8981\u5b9a\u4e49\u82e5\u5e72\u4e2a\u957f\u5ea6\u4e3a $N \\times 20$ \uff08\u672c\u9898 $n \\leq 3 \\times 10^5$ \uff0c$2^{20}$ \u591f\u7528\u4e86\uff09\u7684\u6570\u7ec4\u6765\u8bb0\u5f55\u4ece\u8282\u70b9 $i$ \u5f00\u59cb\u505a $2^j$ \u6b21\u64cd\u4f5c\u4e4b\u540e\u5f97\u5230\u7684\u6211\u4eec\u9700\u8981\u7684\u503c\u3002\u56e0\u4e3a\u6211\u4eec\u6bcf\u6b21\u8df3\u8fc7\u4e00\u4e2a\u533a\u95f4\uff0c\u5e76\u4e14\u8981\u628a\u533a\u95f4\u7684\u8d21\u732e\u52a0\u5230\u7b54\u6848\u4e2d\uff0c\u90a3\u6211\u4eec\u662f\u4e0d\u662f\u9700\u8981\u77e5\u9053\u6bcf\u6b21\u8df3\u5230\u54ea\u91cc\uff0c\u8df3\u8fc7\u7684\u533a\u95f4\u7684\u8d21\u732e\u662f\u591a\u5c11\uff1f\n\n\u5b9a\u4e49 $pre_{i,j}$ \u8868\u793a\u4ece\u8282\u70b9 $i$ \u5f00\u59cb\uff0c\u8df3 $2^j$ \u6b65\u53ef\u4ee5\u5230\u8fbe\u7684\u6700\u5de6\u8fb9\u7684\u8282\u70b9\u662f\u54ea\u4e00\u4e2a\uff0c $sum_{i,j}$ \u8868\u793a\u4ece\u8282\u70b9 $i$ \u5230\u533a\u95f4 $[pre_{i,j},i-1]$ \u7684\u8ddd\u79bb\u548c\u3002\u90a3\u4e48\u600e\u4e48\u66f4\u65b0\u5462\uff1f\n\n\u5bf9\u4e8e\u8282\u70b9 $x$ \uff0c\u4ece\u5b83\u5f00\u59cb\u8df3\u4e00\u6b65\u53ef\u4ee5\u5230\u8fbe\u7684\u6700\u8fdc\u8ddd\u79bb\u663e\u7136\u662f $l_x$\u3002\u6211\u4eec\u8bb0\u4ece $x$ \u8df3\u4e00\u6b65\u53ef\u4ee5\u5230\u8fbe\u7684\u6700\u53f3\u8fb9\u7684\u8282\u70b9\u4e3a $rmax$\u3002\u90a3\u4e48\u4ece $x$ \u8df3\u4e24\u6b65\u53ef\u4ee5\u5230\u8fbe\u7684\u6700\u5de6\u8fb9\u7684\u70b9\u5e94\u8be5\u662f $min_{k=l_x}^n l_k$\u3002\u8fd9\u91cc\u4e3a\u4ec0\u4e48\u4e0d\u662f\u5230 $rmax$ \u5462\uff1f\u5176\u5b9e\u8fd9\u4e24\u79cd\u90fd\u53ef\u4ee5\uff0c\u56e0\u4e3a\u5bf9\u4e8e\u5728 $rmax$ \u53f3\u8fb9\u7684\u8282\u70b9\uff0c\u5b83\u7684 $l$ \u503c\u4e00\u5b9a\u4e0d\u4f1a\u5bf9\u7b54\u6848\u4ea7\u751f\u5f71\u54cd\uff0c\u4e0d\u7136 $rmax$ \u4e3a\u4ec0\u4e48\u4e0d\u662f\u5b83\u5462\uff1f\n\n\u5bf9\u4e8e $pre$ \u6570\u7ec4\u7684\u9884\u5904\u7406\u5f88\u5bb9\u6613\u60f3\u5230\uff0c\u7c7b\u6bd4\u500d\u589e\u6cd5\u6c42\u6700\u8fd1\u516c\u5171\u7956\u5148\uff0c\u5c31\u662f $pre_{i,j}=pre_{pre_{i,j-1},j-1}$\u3002\u4f46\u662f\u5bf9\u6bd4\u6211\u4eec\u4e0a\u9762\u6240\u8bb2\u5230\u7684\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\uff0c\u6211\u4eec\u4e24\u6b65\u90fd\u5f80\u5de6\u8df3\uff0c\u53ef\u80fd\u6ca1\u6709\u5148\u5f80\u53f3\u8df3\u4e00\u6b65\uff0c\u518d\u5f80\u5de6\u8df3\u66f4\u4f18\u3002\u4ed4\u7ec6\u770b\u540e\u53ef\u4ee5\u53d1\u73b0\uff0c\u5176\u5b9e\u533a\u522b\u5c31\u5728\u4e8e $pre_{i,0}$ \u7684\u503c\u3002\u6211\u4eec\u5982\u679c\u8981\u4fdd\u8bc1 $pre_{i,0}$ \u7684\u7ed3\u679c\u6b63\u786e\uff0c\u5c31\u4e0d\u4e00\u5b9a\u80fd\u4fdd\u8bc1\u540e\u9762\u7684\u7ed3\u679c\u6b63\u786e\u3002\u53cd\u4e4b\uff0c\u6211\u4eec\u5c31\u65e0\u6cd5\u4fdd\u8bc1 $pre_{i,0}$ \u7684\u7ed3\u679c\u662f\u6b63\u786e\u7684\u3002\u90a3\u8fd9\u600e\u4e48\u529e\u5462\uff1f\u5176\u5b9e\u6211\u4eec\u53ea\u8981\u4fdd\u8bc1\u540e\u9762\u7684\u90fd\u662f\u5bf9\u7684\uff0c\u5bf9\u4e8e\u4e00\u6b65\u5c31\u80fd\u5230\u7684\u8282\u70b9\u6c42\u503c\u65f6\u7279\u5224\u4e00\u4e0b\u5c31\u53ef\u4ee5\u4e86\u3002\u56e0\u6b64\uff0c $pre_{i,0}$ \u7684\u516c\u5f0f\u4e3a $pre_{i,0}=min(pre_{i+1,0},l_i)$ \uff08\u540e\u9762\u8fd8\u4f1a\u89e3\u91ca\uff09\u3002\u4f46\u662f\uff0c $pre_{n,0}$ \u5c31\u662f $l_n$\uff0c\u56e0\u4e3a\u5b83\u53f3\u8fb9\u6ca1\u6709\u5176\u4ed6\u8282\u70b9\u4e86\u3002\n\n\u5bf9\u4e8e $sum$ \u7684\u66f4\u65b0\u5c31\u8981\u7a0d\u5fae\u60f3\u4e00\u4e0b\u4e86\uff0c\u8fd9\u91cc\u5148\u7ed9\u51fa\u9012\u63a8\u516c\u5f0f\uff1a\n\n$$sum_{i,0}=i-pre_{i,0}$$\n$$sum_{i,j}=sum_{i,j-1}+sum_{pre_{i,j-1},j-1}+2^{j-1} \\times (pre_{i,j-1}-pre_{i,j})$$ \n\n\u90a3\u4e48\u8fd9\u662f\u600e\u4e48\u6765\u7684\u5462\uff1f\u4e00\u6b65\u53ef\u4ee5\u8df3\u5230\u7684\u8282\u70b9\uff0c\u8ddd\u79bb\u80af\u5b9a\u90fd\u662f $1$ \u3002\u5bf9\u4e8e\u8df3 $2^{j}$ \u6b65\u5230\u7684\u8282\u70b9\uff0c\u6211\u4eec\u5c06\u524d $2^{j-1}$ \u6b65\u548c\u540e $2^{j-1}$ \u6b65\u62c6\u5f00\u6765\u8ba1\u7b97\uff0c\u6700\u540e\u518d\u52a0\u4e0a $i$ \u5230\u533a\u95f4 $[pre_{i,j},pre_{i,j-1}]$ \u7684\u8ddd\u79bb\u548c\u3002\n\n\u6a21\u62df\u4e00\u4e0b\u6837\u4f8b\u53ef\u4ee5\u53d1\u73b0\uff0c\u5bf9\u4e8e $6$ \u53f7\u8282\u70b9\uff0c\u4ece $5$ \u53f7\u8282\u70b9\u8df3\u5230 $1$ \u53f7\u8282\u70b9\u66f4\u4f18\uff0c\u4f46\u662f\u5b9e\u9645\u4ee3\u7801\u5b9e\u73b0\u4f1a\u8df3\u5230 $4$\u3002\u4f46\u662f `pre[4][0]` \u662f $1$\uff0c\u8fd9\u6837\u4e5f\u4fdd\u8bc1\u4e86\u7b54\u6848\u7684\u6b63\u786e\u6027\u3002\u90a3\u4e48\u4e3a\u4ec0\u4e48\u53ef\u4ee5\u4fdd\u8bc1\u7b54\u6848\u7684\u6b63\u786e\u6027\u5462\uff1f\u56e0\u4e3a\u5bf9\u4e8e\u4efb\u610f\u4e00\u4e2a\u76f4\u63a5\u8fde\u63a5 $i$ \u7684\u8282\u70b9\uff0c\u5b83\u5fc5\u7136\u5728 $i$ \u7684\u53f3\u8fb9\u3002\u90a3\u4e48\u5b83\u8df3\u5230 $i$ \u548c\u8df3\u5230 $i+1$ \u6240\u7ecf\u8fc7\u7684\u8ddd\u79bb\u662f\u76f8\u7b49\u7684\uff08\u8fd9\u91cc\u4e0d\u8003\u8651\u5b83\u662f $i+1$ \u7684\u60c5\u51b5\uff0c\u56e0\u4e3a\u8fd9\u6837\u4e0d\u4f1a\u51fa\u73b0\u4e0a\u8ff0\u95ee\u9898\uff09\u3002\u53c8\u56e0\u4e3a\u6211\u4eec\u521d\u59cb\u5316 $pre_{i,0}$ \u7684\u65f6\u5019\uff0c\u6211\u4eec\u662f\u5c06 $l_i$ \u548c $pre_{i+1,0}$ \u53d6\u6700\u5c0f\u503c\u7684\uff0c\u90a3\u4e48\u6211\u4eec\u8df3\u5230 $5$ \u53f7\u8282\u70b9\u518d\u8df3\u5230 $1$\uff0c\u8ddf\u8df3\u5230 $4$ \u53f7\u8282\u70b9\u518d\u8df3\u5230 $1$ \u8ba1\u7b97\u7684\u8ddd\u79bb\u662f\u4e00\u6837\u7684\uff0c\u8fd9\u6837\u5c31\u4fdd\u8bc1\u4e86\u7b54\u6848\u7684\u6b63\u786e\u6027\u3002\n\n```\n#include <bits/stdc++.h>\nusing namespace std;\nconst int N=300010;\nint n,m;\nint l[N];\nint pre[N][20],sum[N][20];\ninline void pre_work()\n{\n    pre[n][0]=l[n],sum[n][0]=n-l[n];\n    for (int i=n-1;i>=2;--i)\n    {\n        pre[i][0]=min(pre[i+1][0],l[i]);\n        sum[i][0]=i-pre[i][0];\n    }\n    for (int i=1;i<20;++i)\n    {\n        for (int j=(1<<i);j<=n;++j)\n        {\n            pre[j][i]=pre[pre[j][i-1]][i-1];\n            sum[j][i]=sum[j][i-1]+sum[pre[j][i-1]][i-1]+(1<<(i-1))*(pre[j][i-1]-pre[j][i]);\n        }\n    }\n}\ninline int calc(int aim,int x)\n{\n    if (aim>=l[x]) return x-aim;//\u7279\u5224\u4e00\u6b65\u4e4b\u5185\u5c31\u80fd\u5230\u7684\n    //\u7279\u6b8a\u5904\u7406\u7b2c\u4e00\u6b65\n    int step=1,ans=x-l[x];\n    x=l[x];\n    for (int i=19;i>=0;--i)\n    {\n        if (pre[x][i]>=aim)\n        {\n            ans+=step*(x-pre[x][i])+sum[x][i];\n            //\u5bf9\u4e8e\u533a\u95f4[x,pre[x][i]]\u5185\u7684\u4efb\u4e00\u8282\u70b9y\uff0c\u5b83\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u5c31\u662fdist(x,y)+dist(start,x)(\u7b49\u4e8estep)\uff0cstart\u8868\u793a\u521d\u59cb\u7684x\u3002\u90a3\u4e48\u6bcf\u4e00\u4e2a\u52a0\u8d77\u6765\u5c31\u662f\u4e0a\u9762\u7684\u5f0f\u5b50\n            step+=(1<<i);\n            x=pre[x][i];\n        }\n    }\n    if (x>aim) ans+=step*(x-aim)+x-aim;\n    return ans;\n}\nint gcd(int a,int b)\n{\n    return b>0?gcd(b,a%b):a;\n}\nint main()\n{\n    scanf(\"%d\",&n);\n    for (int i=2;i<=n;++i) scanf(\"%d\",&l[i]);\n    pre_work();\n    scanf(\"%d\",&m);\n    while (m--)\n    {\n       int L,R,x;\n       scanf(\"%d%d%d\",&L,&R,&x);\n       int dist=calc(L,x)-calc(R+1,x);\n       int g=gcd(dist,R-L+1);\n       printf(\"%d/%d\\n\",dist/g,(R-L+1)/g);\n    }\n    return 0;\n}\n```",
        "postTime": 1679586542,
        "uid": 767793,
        "name": "_ZSR_",
        "ccfLevel": 0,
        "title": "P5465 [PKUSC2018]\u661f\u9645\u7a7f\u8d8a"
    },
    {
        "content": "\u91cd\u8981\u6027\u8d28\uff1a\u5bf9\u4e8e\u67d0\u4e2a\u70b9$x$\uff0c\u5fc5\u5b9a\u662f$x$\u5230$[y,x)$\u4e2d\u6240\u6709\u70b9\u7684\u8ddd\u79bb\u4e3a1\uff0c$x$\u5230$[z,y)$\u4e2d\u6240\u6709\u70b9\u8ddd\u79bb\u4e3a2\u2026\u2026\n(\u6ee1\u8db3$z<y<x$)\n\n\u9996\u5148\u60f370\u5206\u66b4\u529b\u505a\u6cd5\uff08\u6027\u8d28\u7684\u4e0d\u5b8c\u5168\u5229\u7528\uff09\n\n\u5904\u7406\u51fa$dist_{i,j}$\u8868\u793a$i$\u5230$j$\u7684\u6700\u77ed\u8def\n\n\u7b56\u7565\u662f\u6700\u591a\u5411\u53f3\u8d70\u4e00\u6b21\uff0c\u5c3d\u53ef\u80fd\u5411\u5de6\u8d70\n\n\u590d\u6742\u5ea6$O(n^2)$\n\n\u53d1\u73b0\u7b54\u6848\u53ef\u4ee5\u5957\u7528\u524d\u7f00\u548c\u5f62\u5f0f\u6c42\u5f97\n\n\u60f3\u4e00\u60f3\u662f\u5426\u53ef\u4ee5\u6362\u4e00\u79cd\u601d\u8def\uff1a\u5bf9\u4e8e\u67d0\u4e2a\u70b9$x$\uff0c\u5148\u5904\u7406\u51fa\u8df3\u4e00\u6b21\u80fd\u8df3\u5230\u7684\u6700\u5de6\u7684\u70b9\uff0c\u5728\u5904\u7406\u51fa\u8df3\u4e24\u6b21\u80fd\u8df3\u5230\u6700\u5de6\u7684\u70b9\uff0c\u6839\u636e\u91cd\u8981\u6027\u8d28\uff0c\u6bcf\u6b21\u80af\u5b9a\u662f\u5411\u5de6\u8fb9\u4e00\u5757\u4e00\u5757\u533a\u95f4\u7684\u66f4\u65b0\n\n\u90a3\u4e48\u5728\u8fdb\u4e00\u6b65\u601d\u8003\uff0c\u662f\u5426\u53ef\u4ee5\u7528\u500d\u589e\u8fdb\u884c\u4f18\u5316\u64cd\u4f5c\uff1f\n\n\u5982\u679c\u53ef\u4ee5\uff0c\u6bcf\u4e2a\u70b9\u53ea\u9700\u8981$O(logn)$\u7684\u590d\u6742\u5ea6\uff0c\u5c31\u8fc7\u4e86\n\n\u53ef\u4ee5\u8bb0\u5f55$pre_{i,j}$\u8868\u793a\u4ece\u70b9$i$\u8df3$2^j$\u6b65\u6700\u5de6\u7684\u70b9\n\n$sum_{i,j}$\u8868\u793a$i$\u5230\u4ece$(i-1)$\u5230\u70b9$i$\u8df3$2^j$\u6b65\u6700\u5de6\u7684\u70b9\u8ddd\u79bb\u548c\n\n\u500d\u589e\u9884\u5904\u7406\n\u8be2\u95ee$O(logn)$\u6c42\u5f97\n\nCode\uff1a\n\n```cpp\n#include <bits/stdc++.h>\n#define maxn 300010\n#define LL long long\nusing namespace std;\nint n, pre[maxn][21], power[21], L[maxn];\nLL sum[maxn][21];\n\ninline int read(){\n\tint s = 0, w = 1;\n\tchar c = getchar();\n\tfor (; !isdigit(c); c = getchar()) if (c == '-') w = -1;\n\tfor (; isdigit(c); c = getchar()) s = (s << 1) + (s << 3) + (c ^ 48);\n\treturn s * w;\n}\n\nLL gcd(LL n, LL m){ return !m ? n : gcd(m, n % m); }\n\nLL calc(int x, int l){\n\tif (L[x] < l) return x - l;\n\tLL ans = x - l, d = 0;\n\tx = L[x];\n\tfor (int i = 20; i >= 0; --i)\n\t\tif (pre[x][i] >= l) ans += sum[x][i] + (x - pre[x][i]) * d, x = pre[x][i], d |= power[i];\n\treturn ans + (x - l) * (d + 1);\n}\n\nint main(){\n\tn = read();\n\tfor (int i = 2; i <= n; ++i) L[i] = read();\n\tL[1] = 1, pre[n + 1][0] = n;\n\tfor (int i = n; i; --i) sum[i][0] = i - (pre[i][0] = min(pre[i + 1][0], L[i]));\n\tpower[0] = 1;\n\tfor (int i = 1; i <= 20; ++i) power[i] = power[i - 1] << 1;\n\tfor (int j = 0; power[j + 1] <= n; ++j)\n\t\tfor (int i = 1; i <= n; ++i)\n\t\t\tpre[i][j + 1] = pre[pre[i][j]][j], sum[i][j + 1] = sum[i][j] + sum[pre[i][j]][j] + power[j] * (pre[i][j] - pre[i][j + 1]);\n\tint Q = read();\n\twhile (Q--){\n\t\tint l = read(), r = read(), x = read();\n\t\tLL p = calc(x, l) - calc(x, r + 1), q = r - l + 1, g = gcd(p, q);\n\t\tprintf(\"%lld/%lld\\n\", p / g, q / g);\n\t}\n\treturn 0;\n}\n```\n",
        "postTime": 1576069879,
        "uid": 51719,
        "name": "ModestCoder_",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P5465 \u3010[PKUSC2018]\u661f\u9645\u7a7f\u8d8a\u3011"
    },
    {
        "content": "# [P5465[PKUSC2018]\u661f\u9645\u7a7f\u8d8a](https://www.luogu.com.cn/problem/P5465)\n\n\u4e00\u9053\u500d\u589e\u597d\u9898\u3002\n\n\u5efa\u8bae\u5148\u628a [P4155 [SCOI2015]\u56fd\u65d7\u8ba1\u5212](https://www.luogu.com.cn/problem/P4155) \u505a\u6389\uff0c\u5e76\u7406\u89e3 LCA \u7684\u500d\u589e\u65b9\u6cd5\u548c ST \u8868\u7684\u500d\u589e\u65b9\u6cd5\uff0c\u6b64\u9898\u662f\u4e8c\u8005\u7684\u7ed3\u5408 ~~\u4e0d\u7136\u4e3a\u4ec0\u4e48\u662f\u7d2b\u7684~~\u3002\n\n\u5148\u8bfb\u9898\uff0c\u9996\u5148\u7ed9\u51fa\u4e00\u4e2a\u6570\u7ec4 $L_x , x \\in [2, n]$\uff0c\u5bf9\u6bcf\u4e00\u4e2a $ver_i \\in [L_x, x]$\uff0c\u90fd\u4f1a\u548c $ver_x$ \u8fde\u4e00\u6761\u53cc\u5411\u8fb9\u3002\u7ed9\u51fa $m$ \u6b21\u8be2\u95ee\uff0c\u6c42 $\\sum_{y = l_i}^{r_i}dist(x,y)/(r_i - l_i + 1)$\u3002\n\n\u63a5\u7740\u8bfb\u6837\u4f8b\n![](https://cdn.luogu.com.cn/upload/pic/63831.png)\n\u5b9e\u8d28\u4e0a\u662f\u5728\u6c42 $ver_x$ \u5230 $ver_{l_i} \\sim ver_{r_i}$ \u7684\u6700\u77ed\u8ddd\u79bb\u548c\n\n\u6700\u540e\u770b\u4e00\u773c\u6570\u636e\u8303\u56f4 $n,q \\le 3\\cdot 10^5$\n\u53ef\u4ee5\u731c\u51fa\u590d\u6742\u5ea6\u5927\u81f4\u4e3a $O(q \\log n)$\u3002\n\n## ~~\u6211\u4f1a\u66b4\u529b~~\n\n\u5bf9\u6bcf\u6b21\u8be2\u95ee\u90fd\u8fdb\u884c\u8ba1\u7b97 $\\sum_{y = l_i}^{r_i}dist(x,y)$\u3002\n\n## \u6211\u4f1a\u89c2\u5bdf\u6027\u8d28\n\n\u624b\u52a8\u6a21\u62df\u4e00\u4e0b\u8d70\u6cd5\uff0c\u53ef\u4ee5\u53d1\u73b0 $dist(x,i)$ \u968f\u7740 $i$ \u7684\u589e\u5927\u800c\u4e0d\u964d\u3002\n\n## \u6211\u4f1a\u4f18\u5316\n\n\u5728\u6587\u7ae0\u7684\u5f00\u5934\u5df2\u7ecf\u63d0\u5230\u4e86\u8fd9\u662f\u4e00\u9053\u500d\u589e\u9898\uff0c\u63a5\u4e0b\u6765\u5c31\u662f\u5982\u4f55\u4f7f\u7528\u500d\u589e\u4f18\u5316\u4e0a\u8ff0\u7684\u7b97\u6cd5\u3002\n\n\u9996\u5148\u6211\u4eec\u89c2\u5bdf\u5230\u9898\u76ee\u95ee\u7684\u662f $l_i \\sim r_i$ \u7684\u8ddd\u79bb\u4e4b\u548c\uff0c\u5f88\u81ea\u7136\u5c31\u4f1a\u60f3\u5230\u524d\u7f00\u548c\u4f18\u5316\u6765\u5feb\u901f\u8ba1\u7b97\uff0c\u7136\u800c\u5982\u679c\u8981\u5b58\u4e0b\u8fd9\u4e2a $sum$ \u65e0\u8bba\u662f\u5728\u7a7a\u95f4\u8fd8\u662f\u65f6\u95f4\u4e0a\u90fd\u662f\u65e0\u6cd5\u63a5\u53d7\u7684\u3002\n\n\u4f46\u662f\u6211\u4eec\u8fd8\u6709\u6027\u8d28\uff0c\u89c2\u5bdf\u5982\u4e0b\u7684\u4e00\u5217\u6570\n$$dist_x = \\{4,4,4,4,4,3,3,3,3,2,2,2,2,2,2,1,1,1,0 \\}$$\n\u6211\u4eec\u6709\u4e24\u4e2a\u95ee\u9898\uff0c\u7b2c\u4e00\uff0c\u8fd9\u5217\u6570\u5982\u4f55\u751f\u6210\uff0c\u7b2c\u4e8c\uff0c\u8fd9\u5217\u6570\u6709\u4ec0\u4e48\u7528\u3002\n\n### \u5982\u4f55\u8ba1\u7b97 $dist$\n\n\u8bbe $y_{x,i}$ \u8868\u793a\u4ee5 $ver_x$ \u4e3a\u8d77\u70b9\uff0c$dist_y$ \u4e3a $i$ \u7684\u6700\u5c0f\u7684 $y$\u3002\n\n$$\\begin{cases}\n  y_{x,0} = L_x \\\\\n  y_{x,1} = \\min \\{ L_{y_{x,0}}, \\cdots L_n \\}\\\\\n  \\vdots\n\\end{cases}$$\n\n\u5173\u4e8e\u4e3a\u4f55 $\\min$ \u53f3\u8fb9\u754c\u4e3a $L_n$\uff0c\u5176\u4ed6\u9898\u89e3\u5df2\u7ecf\u89e3\u91ca\u5f97\u6bd4\u8f83\u660e\u767d\u4e86\uff0c\u5c31\u4e0d\u518d\u8d58\u8ff0\u3002\n\n### $dist$ \u6709\u4ec0\u4e48\u7528\n\u5b9e\u9645\u4e0a\u8fd9\u4e2a\u7b97\u6cd5\u7684\u590d\u6742\u5ea6\u4e3a $O(n^2)$ \u4e0d\u8db3\u4ee5\u901a\u8fc7\u6b64\u9898\uff0c\u8003\u8651\u4f18\u5316\u3002\n~~\u90fd\u8bf4\u4e86\u8fd9\u662f\u500d\u589e\u9898~~\u53ef\u4ee5\u5c1d\u8bd5\u4f18\u5316\u4e3a\u500d\u589e\u3002\n\n\u8bbe $pre_{x,i}$ \u4e3a $ver_x$ \u5de6\u8fb9 $dist_y$ \u4e3a $2^i$ \u7684\u6700\u5de6\u4fa7\u8282\u70b9\u3002\n\n\u6240\u4ee5\u6709\n$$pre_{n,0} = L_n$$\n\n$$pre_{i,0} = \\min_i^n \\{L_y\\}$$\n\n$$pre_{i,j} = pre_{pre_{i,j - 1},j - 1}$$\n\n\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528\u500d\u589e\u6cd5\u6765\u5feb\u901f\u8ba1\u7b97 $sum$ \u4e86\u3002\n\n\u4ee4 $sum_{i,j}$ \u4e3a\u4ee5 $ver_i$ \u4e3a\u8d77\u70b9\uff0c\u5de6\u7aef\u70b9\u503c\u4e3a $2^j$ \u7684\u524d\u7f00\u548c\n\n\u5219\u6709\n\n$$sum_{i,0} = i - pre_{i,0}$$\n\n$$sum_{i,j} = sum_{i,j - 1} + sum_{pre_{i,j - 1},j - 1} + 2 ^ {i - 1}\\cdot(pre_{i,j - 1} - pre_{i,j})$$\n\n\u90a3\u4e48\u6700\u7ec8\u500d\u589e\u6c42\u89e3\u7684\u524d\u7f00\u548c\u4fbf\u662f\uff1a\n\n$$S = S + sum_{p,i} + cnt \\cdot (p - pre_{p,i})$$\n\n\u6700\u7ec8\u590d\u6742\u5ea6\u4e3a $O((n+q)\\log n)$\u3002\n\n## \u4e00\u4e9b\u7ec6\u8282\n\n\u6b64\u9898\u5728\u8ba1\u7b97\u65f6\u7531\u4e8e\u7b2c\u4e00\u6b65\u5728\u8d70\u51fa\u65f6\u4e0d\u4e00\u5b9a\u4f1a\u5411\u5de6\u8fb9\u8d70\uff0c\u6545\u9700\u5355\u72ec\u8ba1\u7b97\u3002\n\n**\u4e0d\u8981\u5fd8\u8bb0\u672c\u9898\u9700\u8981\u7ea6\u5206**\u3002\n\n## code\n\n```cpp\n// coding by cxz_0\n#include <bits/stdc++.h>\n#define awa cerr << \"xlx is my superman!!!!!!!!!!!\\n\";\n#define FOR(x,l,r) for(int (x) = (l); (x) <= (r); (x)++)\n#define _FOR(x,l,r) for(int (x) = (r); (x) >= (l); (x)--)\n#define gc getchar()\n#define pb emplace_back\n#define mp make_pair\n#define pii pair<int, int >\n#define PII pair<ll, ll >\n#define fi first\n#define se second\n#define p_q priority_queue\n// #define int ll\n#define il inline\nusing namespace std;\ntypedef long long ll;\n\nconst int N = 3e5 + 5,MOD = 1e9 + 7;\nint n, m, a[N], pre[N][20];\nll sum[N][20];\n\nnamespace cxz_0\n{\n    il int read(int x=0,bool f=0,char c=gc){while(!isdigit(c))f=c=='-',c=gc;while(isdigit(c))x=(x<<1)+(x<<3)+(c^48),c=gc;return f?-x:x;}\n    il void write(int x){if(x<0)x=-x,putchar('-');if(x>9)write(x/10);putchar(x%10+'0');}\n    il ll readl(ll x=0,bool f=0,char c=gc){while(!isdigit(c))f=c=='-',c=gc;while(isdigit(c))x=(x<<1)+(x<<3)+(c^48),c=gc;return f?-x:x;}\n    il void writel(ll x){if(x<0)x=-x,putchar('-');if(x>9)writel(x/10);putchar(x%10+'0');}\n    il int qpow(int a, int n, int p){int b=1;while(n){if(n&1)b=1ll*b*a%p;a=1ll*a*a%p;n>>=1;}return b;}\n    il int max(int&a,int&b){return a>b?a:b;}\n    il int min(int&a,int&b){return a<b?a:b;}\n    il void swap(int&a,int&b){a^=b^=a^=b;}\n    il int Mod(int x){return x>MOD?Mod(x-MOD):x;}\n} using namespace cxz_0;\n\nil ll cal (int fr, int to)\n{\n    if (a[fr] <= to) return fr - to;\n    ll S = fr - a[fr];\n    int cnt = 1;\n    fr = a[fr];\n    _FOR (i, 0, 19) if (pre[fr][i] >= to)\n    {\n        S += cnt * (fr - pre[fr][i]) + sum[fr][i];\n        cnt += (1 << i);\n        fr = pre[fr][i];\n    }\n    if (fr > to) S += cnt * (fr - to) + fr - to;\n    return S;\n}\n\nsigned main()\n{\n#ifndef ONLINE_JUDGE\n    double start = clock();\n    freopen(\"test.in\", \"r\", stdin);\n    freopen(\"test.out\", \"w\", stdout);\n#endif\n    n = read ();\n    FOR (i, 2, n) a[i] = read ();\n    int mi = a[n];\n    pre[n][0] = a[n], sum[n][0] = n - a[n];\n    _FOR (i, 1, n - 1) mi = min (mi, a[i]), pre[i][0] = mi, sum[i][0] = i - mi;\n    FOR (j, 1, 19) FOR (i, 1, n) pre[i][j] = pre[pre[i][j - 1]][j - 1];\n    FOR (j, 1, 19) FOR (i, 1, n) sum[i][j] = sum[i][j - 1] + sum[pre[i][j - 1]][j - 1] + (1 << (j - 1)) * (pre[i][j - 1] - pre[i][j]);\n    m = read ();\n    while (m--)\n    {\n        int l = read (), r = read (), x = read ();\n        ll c = cal (x, l) - cal (x, r + 1), d = r - l + 1, g = __gcd (c, d);\n        writel (c / g);\n        putchar (47);\n        writel (d / g);\n        putchar (10);\n    }\n#ifndef ONLINE_JUDGE\n    cerr << \"Time: \" << 1e3 * (clock() - start) / CLOCKS_PER_SEC << \" ms\" << endl;\n    awa\n#endif\n    return 0;\n}\n```",
        "postTime": 1676090245,
        "uid": 295509,
        "name": "\u4f60\u7684\u6d1b",
        "ccfLevel": 4,
        "title": "P5465\u9898\u89e3"
    },
    {
        "content": "\u8003\u8651\u5982\u679c\u4ece $x$ \u51fa\u53d1\u53ea\u8df3\u4e00\u6b65\uff0c\u6700\u8fdc\u80fd\u8df3\u5230\u54ea\u91cc\u3002\u6700\u8fdc\u80fd\u8df3\u5230 $l_x$\u3002\n\n\u8003\u8651\u5982\u679c\u4ece $x$ \u8df3\u4e24\u6b65\uff0c\u6700\u8fdc\u80fd\u8df3\u5230\u54ea\u91cc\u3002\u8fd9\u65f6\u5019 $x$ \u6709\u53ef\u80fd\u5148\u5f80\u540e\u8df3\uff0c\u7136\u540e\u518d\u5f80\u524d\u8df3\uff0c\u4e5f\u6709\u53ef\u80fd\u4e24\u6b21\u90fd\u5f80\u524d\u8df3\u3002\u56e0\u6b64\uff0c\u6700\u8fdc\u80fd\u8df3\u5230 $\\min_{i = l_x}^{n} l_i$ \u3002\n\n\u6211\u4eec\u8bbe\u7b2c\u4e8c\u6b21\u6700\u8fdc\u80fd\u8df3\u5230\u7684\u4f4d\u7f6e\u662f $d$ \uff0c\u90a3\u4e48\u7b2c\u4e09\u6b21\u80fd\u591f\u8df3\u5230\u7684\u6700\u8fdc\u7684\u4f4d\u7f6e\u662f $\\min_{i = d}^{n} l_i$\u3002\n\n\u6211\u4eec\u53d1\u73b0\u6211\u4eec\u53ea\u9700\u8981\u500d\u589e\u7c7b\u4f3c\u7b2c\u4e8c\u6b65\u7684\u64cd\u4f5c\u5373\u53ef\u3002\n\n\u8bbe $f_{i , j}$ \u8868\u793a\u4ece $[i , n]$ \u9009\u51fa $l_k$ \u6700\u5c0f\u7684 $k$\uff0c\u4ece $k$ \u5f00\u59cb\u8df3\u5230 $l_k$\uff0c\u7136\u540e\u4ece $l_k$ \u5f00\u59cb\u91cd\u590d\u8fd9\u4e2a\u64cd\u4f5c $2^j - 1$ \u6b21\u8df3\u5230\u7684\u4f4d\u7f6e\u3002\n\n$g_{i , j}$ \u8868\u793a\u4ece $[i , n]$ \u9009\u51fa $l_k$ \u6700\u5c0f\u7684 $k$\uff0c\u4ece $k$ \u5f00\u59cb\u8df3\u5230 $l_k$\uff0c\u7136\u540e\u4ece $l_k$ \u5f00\u59cb\u91cd\u590d\u8fd9\u4e2a\u64cd\u4f5c $2^j - 1$ \u6b21\u6574\u4e2a\u8fc7\u7a0b\u7684\u4ee3\u4ef7\u3002 \n\n\u8bbe $calc(x , t)$ \u8868\u793a\u4ece $x$ \u8df3\u5230 $[t , x - 1]$ \u7684\u4ee3\u4ef7\u4e4b\u548c\uff0c\u6700\u7ec8\u7b54\u6848\u4e3a $calc(x , l) - calc(x , r + 1)$ \n\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<algorithm>\n#include<cstring>\n#include<cmath>\n\nusing namespace std;\n\nconst int N = 3e5 + 10;\n\nint n , l[N] , q , p[22][N];\nlong long g[22][N];\n\nlong long gcd(int a , int b) {\n    if(b == 0) return a;\n    return gcd(b , a % b);\n}\n\nlong long calc(int x , int t) {\n    if(l[x] <= t) return x - t;\n    long long ans = x - l[x];\n    int tot = 1; x = l[x];\n    for(int i = 20 ; i >= 0 ; -- i) {\n        if(p[i][x] > t) {\n            ans += 1ll * tot * (x - p[i][x]) + g[i][x];\n            x = p[i][x] , tot += (1 << i);\n        }\n    }\n    ans += 1ll * (tot + 1) * (x - t);\n    return ans;\n}\n\nint main(void) {\n\n    scanf(\"%d\" , &n);\n\n    for(int i = 2 ; i <= n ; ++ i) {\n        scanf(\"%d\" , &l[i]);\n    }\n\n    memset(p , -1 , sizeof(p));\n\n    p[0][n] = l[n] , g[0][n] = n - l[n];\n\n    for(int i = n - 1 ; i >= 2 ; -- i) {\n        p[0][i] = min(p[0][i + 1] , l[i]);\n        g[0][i] = i - p[0][i];\n    }\n\n    for(int j = 1 ; j <= 20 ; ++ j) {\n        for(int i = 1 ; i <= n ; ++ i) {\n            if(p[j - 1][i] != -1) {\n                p[j][i] = p[j - 1][p[j - 1][i]];\n                g[j][i] = g[j - 1][i] + g[j - 1][p[j - 1][i]] + 1ll * (1 << (j - 1)) * (p[j - 1][i] - p[j][i]);\n            }\n        }\n    }\n\n    scanf(\"%d\" , &q);\n\n    while(q -- ) {\n        int st , ed , x;\n        scanf(\"%d%d%d\" , &st , &ed , &x);\n        long long ans = calc(x , st) - calc(x , ed + 1) , base = ed - st + 1 , d = gcd(ans , base);\n        ans /= d , base /= d;\n        printf(\"%lld/%lld\\n\" , ans , base);\n    }\n\n    return 0;\n\n}\n\n\n```",
        "postTime": 1658828673,
        "uid": 120017,
        "name": "JeffZhao",
        "ccfLevel": 0,
        "title": "PKUSC2018\u661f\u9645\u7a7f\u8d8a"
    },
    {
        "content": "\u7b80\u5355\u9898\u3002\n\n\u8003\u8651\u4e00\u4e2a $\\text{dist}(x,y)$ \u548b\u7b97\uff0c\u4e0d\u59a8\u8bbe $x>y$\uff0c\u53d1\u73b0\u5982\u679c\u4e00\u6b65\u8d70\u4e0d\u5230 $y$\uff0c\u90a3\u4e48\u80af\u5b9a\u662f\u4ece $x$ \u5f00\u59cb\uff0c\u627e\u5230\u4ed6\u80fd\u8d70\u5230\u7684\u6240\u6709 $j$ \u4e2d $l_j$ \u6700\u5c0f\u7684 $j$\uff0c\u7136\u540e\u8df3\u5230 $j$\uff1b\u76f4\u5230\u5f53\u524d\u7684 $l_x\\le y$\u3002\u5bf9\u6bcf\u4e2a $x$ \u7b97\u51fa\u8fd9\u4e2a $j$\uff0c\u8bb0\u4e3a $p_x=j$\uff1b\u5bf9\u6240\u6709 $(x,p_x)$ \u8fde\u8fb9\u53ef\u4ee5\u5f97\u5230\u4e00\u68f5\u6811\uff0c$\\text{dist}(x,y)$ \u5c31\u662f $x$ \u7684\u6700\u8fd1\u7684\u4f7f\u5f97 $l_u\\le y$ \u7684\u7956\u5148 $u$ \u4e0e $x$ \u7684\u8ddd\u79bb $+1$\u3002\n\n\u73b0\u5728\u8003\u8651\u600e\u4e48\u7b97 $\\sum_{i=1}^k\\text{dist}(i,x)$\uff0c\u53d1\u73b0\u53ea\u9700\u8981\u5b9a\u4f4d\u51fa $k$ \u7684\u4f4d\u7f6e\u5373\u6700\u8fd1\u4e00\u4e2a $l_u\\le k$ \u7684\u7956\u5148 $u$\uff0c\u5269\u4e0b\u7684\u5c31\u662f\u4e00\u4e2a $\\sum \\text{dep}_x-\\text{dep}_v+1$ \u7684\u5f62\u5f0f\uff0c\u62c6\u6210 $k\\times (\\text{dep}_x+1)$ \u4e0e $\\sum -\\text{dep}_v$ \u5373\u53ef\u3002\u540e\u9762\u90a3\u4e00\u9879\u53ef\u4ee5\u9884\u5904\u7406\u3002\n\n\u53ea\u9700\u8981\u6811\u4e0a\u500d\u589e\u5b9a\u4f4d $k$ \u5373\u53ef\uff1b\u627e $x$ \u5bf9\u5e94\u7684 $j$ \u53ea\u9700\u8981\u5b9e\u73b0 RMQ\uff0c\u8fd9\u662f\u56e0\u4e3a $x$ \u5f80\u5de6\u80fd\u5230 $j\\in[l_x,x-1]$ \u7684\u6240\u6709 $j$\uff0c\u5f80\u53f3\u80fd\u5230 $l_j\\le x$ \u7684\u6240\u6709 $j$\uff0c\u4e8c\u8005\u90fd\u5f62\u6210\u4e00\u6bb5\u533a\u95f4\u3002\n\n> \u5b9e\u9645\u4e0a\uff0c\u53ea\u9700\u8981\u5b9e\u73b0\u539f\u5e8f\u5217\u4e0a $l$ \u7684 RMQ\uff0c\u7136\u540e\u5728 $[l_x,n]$ \u4e2d\u53d6\u6700\u5c0f\u503c\u5373\u53ef\u3002\u8fd9\u662f\u56e0\u4e3a\u5982\u679c\u53d6\u5230\u4e86\u5de6\u8fb9\u663e\u7136\u5408\u6cd5\uff0c\u5982\u679c\u53d6\u5230\u4e86\u53f3\u8fb9\uff0c\u7531\u4e8e\u5de6\u8fb9\u7684\u6700\u5c0f\u503c\u5df2\u7ecf\u6709 $l_x-1$ \u4e86\uff0c\u6240\u4ee5\u5982\u679c\u53d6\u5230\u53f3\u8fb9\u90a3\u80af\u5b9a\u4e0d\u4f1a\u8d85\u8fc7\u8fd9\u4e2a\u6570\uff0c\u8bf4\u660e\u53d6\u5230\u7684\u70b9\u4ecd\u7136\u80fd\u5230\u8fbe $x$\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O((n+q)\\log n)$\u3002\n\n```cpp\n#include<bits/stdc++.h>\n\n#define int long long\n\nusing namespace std;\n\ninline int read(){\n\tint x=0,f=1;char c=getchar();\n\tfor(;(c<'0'||c>'9');c=getchar()){if(c=='-')f=-1;}\n\tfor(;(c>='0'&&c<='9');c=getchar())x=x*10+(c&15);\n\treturn x*f;\n}\n\nconst int mod=1e9+7;\nint ksm(int x,int y,int p=mod){\n\tint ans=1;\n\tfor(int i=y;i;i>>=1,x=1ll*x*x%p)if(i&1)ans=1ll*ans*x%p;\n\treturn ans%p;\n}\nint inv(int x,int p=mod){return ksm(x,p-2,p)%p;}\nint randint(int l,int r){return rand()*rand()%(r-l+1)+l;}\nvoid add(int &x,int v){x+=v;if(x>=mod)x-=mod;}\nvoid Mod(int &x){if(x>=mod)x-=mod;}\n\nconst int N=3e5+5;\nconst int K=20;\nvector<int>G[N];\nint ed[N],ST[K][N],fa[N][K],Lg[N],n,q;\n\nvoid ST_build(){\n\tfor(int i=2;i<=n;i++)Lg[i]=Lg[i>>1]+1;\n\tfor(int i=1;i<=n;i++)ST[0][i]=i;\n\tfor(int i=1;i<K;i++){\n\t\tfor(int j=1;j+(1<<i)-1<=n;j++){\n\t\t\tif(ed[ST[i-1][j]]<ed[ST[i-1][j+(1<<(i-1))]])ST[i][j]=ST[i-1][j];\n\t\t\telse ST[i][j]=ST[i-1][j+(1<<(i-1))];\n\t\t}\n\t}\n}\nint qmin(int l,int r){\n\tint k=Lg[r-l+1];\n\tif(ed[ST[k][l]]<ed[ST[k][r-(1<<k)+1]])return ST[k][l];\n\treturn ST[k][r-(1<<k)+1];\n}\n\nint val[N],dep[N];\nvoid dfs(int u){\n\tfor(int i=1;i<K;i++)fa[u][i]=fa[fa[u][i-1]][i-1];\n\tfor(int v:G[u]){\n\t\tfa[v][0]=u,dep[v]=dep[u]+1;\n\t\tassert(ed[u]<ed[v]);\n\t\tval[v]=val[u]+(ed[v]-ed[u])*dep[u];\n\t\tdfs(v);\n\t}\n}\nint get(int u,int k){\n\tfor(int i=K-1;i>=0;i--)if(ed[fa[u][i]]>k)u=fa[u][i];\n\tif(ed[u]<=k)return u;\n\telse return fa[u][0];\n}\nint ans(int u,int k){\n\tint v=get(u,k);\n\tassert(ed[v]<=k);\n\treturn k*(dep[u]+1)-(val[v]+(k-ed[v]+1)*dep[v]);\n}\n\nint gcd(int x,int y){return y?gcd(y,x%y):x;}\n\nsigned main(void){\n\n#ifdef YUNQIAN\n\tfreopen(\"in.in\",\"r\",stdin);\n#endif\n\n\tn=read();ed[1]=0;\n\tfor(int i=2;i<=n;i++)ed[i]=read();\n\tST_build();\n\tfor(int i=2;i<=n;i++){\n\t\tint p=qmin(ed[i],n);\n\t\tG[p].emplace_back(i);\n\t}\n\tdfs(1);\n\tq=read();\n\twhile(q--){\n\t\tint l=read(),r=read(),x=read();\n\t\tint w=ans(x,r)-ans(x,l-1),len=r-l+1;\n\t\tint g=gcd(w,len);w/=g,len/=g;\n\t\tcout<<w<<'/'<<len<<'\\n';\n\t}\n\n\treturn 0;\n}\n```",
        "postTime": 1681950682,
        "uid": 307453,
        "name": "\u4e91\u6d45\u77e5\u5904",
        "ccfLevel": 6,
        "title": "\u661f\u9645\u7a7f\u8d8a"
    },
    {
        "content": "\u9898\u76ee\u5927\u610f\uff1a\n\n$n$ \u4e2a\u661f\u7403\uff0c\u53ef\u89c6\u4e3a\u6570\u8f74\u4e0a\u7684 $1 \\sim n$\uff0c\u7b2c $i$ \u4e2a\u661f\u7403\u53ef\u4ee5\u5230\u8fbe $[l_i,i-1]$ \u4e2d\u7684\u4efb\u610f\u4e00\u4e2a\u661f\u7403\uff0c\u4e14\u4e0e\u8fd9\u4e2a\u533a\u95f4\u5185\u7684\u6240\u6709\u661f\u7403\u6709\u53cc\u5411\u8fb9\u3002\n\n\u4ece $u$ \u5230 $v$ \u6216\u4ece $v$ \u5230 $u$ \u9700\u8981\u82b1\u8d39 $1$ \u4e2a\u5355\u4f4d\u65f6\u95f4\uff0c$dist(x,y)$ \u8868\u793a\u4ece $x$ \u5230 $y$ \u6240\u82b1\u8d39\u7684\u6700\u5c11\u65f6\u95f4\u3002\n\n\u6709 $q$ \u4e2a\u5546\u4eba\uff0c\u7b2c $i$ \u4e2a\u5546\u4eba\u5728\u661f\u7403 $x_i$\uff0c\u4ed6\u7684\u76ee\u7684\u5730\u4e3a $[l_i,r_i]$ \u533a\u95f4\u5185\u7684\u4e00\u4e2a\u661f\u7403\uff0c\u4e14 $l_i<r_i<x_i$\u3002\n\n\u7b49\u6982\u7387\u9009\u53d6\u661f\u7403 $y$\uff0c\u901a\u8fc7\u4f20\u9001\u95e8\u62b5\u8fbe $y$ \u4e14\u7528\u65f6\u6700\u77ed\uff0c\u6c42\u671f\u671b\u65f6\u95f4\u3002\n\n\u601d\u8def\uff1a\n\n1. \u66f4\u65b0\uff1a \u70b9 $u$ \u8df3\u5230\u524d\u4e00\u4e2a\u533a\u95f4\u7684\u82b1\u8d39\u4e3a $1$\uff0c\u4e14\u8df3\u8dc3\u8fc7\u7a0b\u4e2d\u4e0d\u4f1a\u5411\u53f3\u8df3\uff0c\u4e14\u4e00\u4e2a\u70b9\u5411\u5de6\u8df3\u7684\u82b1\u8d39\u5355\u8c03\u9012\u589e\uff08\u7b2c\u4e00\u6b65\u662f\u7279\u6b8a\u7684\uff09\u3002 \u8bbe $mi_i$ \u8868\u793a $l_i$ \u7684\u540e\u7f00\u6700\u5c0f\u503c\uff0c\u5373\u5bf9\u4f4d\u7f6e $i$ \u7b2c\u4e00\u6b65\u91c7\u53d6\u5411\u540e\u8df3\u7684\u65b9\u5f0f\u5230\u8fbe\u6700\u5411\u524d\u7684\u4f4d\u7f6e\u3002\u53ef\u5bf9\u6bcf\u4e2a\u4f4d\u7f6e\u7ef4\u62a4\u4e00\u4e2a\u53ef\u6301\u4e45\u5316\u7ebf\u6bb5\u6811\uff0c\u7ebf\u6bb5\u6811\u7684\u503c\u4e3a\u5f53\u524d\u4f4d\u7f6e\u4e0d\u8003\u8651\u7b2c\u4e00\u6b65\u7684\u82b1\u8d39\u3002$i$ \u7684\u7ebf\u6bb5\u6811\u4ece $mi_i$ \u8f6c\u79fb\uff0c\u5728\u533a\u95f4 $[1,i-1]$ \u8fdb\u884c\u6807\u8bb0\u6c38\u4e45\u5316\uff0c\u5b9e\u73b0\u533a\u95f4\u52a0\u4e00\uff0c \u5373\u4e0d\u662f\u7b2c\u4e00\u6b65\u8df3\u7684\u82b1\u8d39\u3002\n \n2. \u67e5\u8be2\uff1a\u5728 $l_x$ \u5bf9\u5e94\u7684\u7ebf\u6bb5\u6811\u4e0a\uff0c\u67e5\u8be2\u533a\u95f4 $[l,min(r,l_x-1)]$ \u7684\u548c\uff0c\u503c\u4e3a $x$ \u9664\u53bb\u7b2c\u4e00\u6b65\u7684\u603b\u82b1\u8d39\uff0c\u518d\u52a0\u4e0a\u7b2c\u4e00\u6b65\u82b1\u8d39\u5373\u53ef\u3002\n\n```cpp\n#include <bits/stdc++.h>\nnamespace IO{\n\t#define LL long long\n\tinline LL read(){\n\t\tLL x=0,f=1;char c=getchar();\n\t\tfor (;!isdigit(c);c=getchar())if (c=='-')f=-1;\n\t\tfor (;isdigit(c);c=getchar())x=(x<<3)+(x<<1)+(c^48);\n\t\treturn x*f;\n\t}\n\tinline void write(LL x,char c='\\n'){\n\t\tif (x){\n\t\t\tif (x<0)x=-x,putchar('-');\n\t\t\tchar a[30];short l;\n\t\t\tfor (l=0;x;x/=10)a[l++]=x%10^48;\n\t\t\tfor (l--;l>=0;l--)putchar(a[l]);\n\t\t}else putchar('0');putchar(c);\n\t}\n}using namespace IO;\nusing namespace std;\n\n#define int long long\nconst int N = 3e5+10;\nstruct Segmt{int l,r,sum,val;}tree[N<<5];\nint n,q,cnt,a[N],mi[N],root[N];\nint gcd(int m,int n){return m%n==0?n:gcd(n,m%n);}\nvoid update(int &now,int l,int r,int x,int y){\n\ttree[++cnt]=tree[now];\n\ttree[cnt].sum=tree[cnt].sum+min(r,y)-max(l,x)+1;\n\tnow=cnt;int mid=(l+r)>>1;\n\tif (x<=l&&r<=y)return tree[now].val++,void();\n\tif (x<=mid)update(tree[now].l,l,mid,x,y);\n\tif (mid<y) update(tree[now].r,mid+1,r,x,y);\n}\nint query(int now,int l,int r,int x,int y){\n\tif (x>y)return 0;\n\tif (x<=l&&r<=y)return tree[now].sum;\n\tint mid=(l+r)>>1,res=tree[now].val*(min(r,y)-max(l,x)+1);\n\tif (x<=mid)res+=query(tree[now].l,l,mid,x,y);\n\tif (mid<y) res+=query(tree[now].r,mid+1,r,x,y);\n\treturn res;\n}\nsigned main(){\n\tn=read();\n\tfor (int i=2;i<=n;i++)a[i]=mi[i]=read();\n\tfor (int i=n-1;i>=2;i--)mi[i]=min(mi[i],mi[i+1]);\n\tfor (int i=2;i<=n;i++)update((root[i]=root[mi[i]]),1,n,1,i-1);\n\tq=read();\n\tfor (int i=1;i<=q;i++){\n\t\tint l=read(),r=read(),x=read(),len=r-l+1;\n\t\tlen+=query(root[a[x]],1,n,l,min(r,a[x]-1));\n\t\tint d=gcd(len,r-l+1);\n\t\twrite(len/d,'/'),write((r-l+1)/d);\n\t}\n\treturn 0;\n}\n```\n\n\u518d\u9644\u4e0a ST \u8868\u7684\u4ee3\u7801\uff0c\u5176\u4e2d $pre_{i,j}$ \u8868\u793a\u4ece\u70b9 $i$ \u8df3 $2^j$ \u6b65\u540e\u6700\u5de6\u7684\u70b9\uff0c$sum_{i,j}$ \u8868\u793a $i$ \u5230\u201c\u4ece $i-1$ \u5230 $i$ \u8df3 $2^j$ \u6b65\u540e\u6700\u5de6\u7684\u70b9\u201d\u7684\u8ddd\u79bb\u548c\u3002\n\n```cpp\n#include <bits/stdc++.h>\nnamespace IO{\n\t#define LL long long\n\tinline LL read(){\n\t\tLL x=0,f=1;char c=getchar();\n\t\tfor (;!isdigit(c);c=getchar())if (c=='-')f=-1;\n\t\tfor (;isdigit(c);c=getchar())x=(x<<3)+(x<<1)+(c^48);\n\t\treturn x*f;\n\t}\n\tinline void write(LL x,char c='\\n'){\n\t\tif (x){\n\t\t\tif (x<0)x=-x,putchar('-');\n\t\t\tchar a[30];short l;\n\t\t\tfor (l=0;x;x/=10)a[l++]=x%10^48;\n\t\t\tfor (l--;l>=0;l--)putchar(a[l]);\n\t\t}else putchar('0');putchar(c);\n\t}\n}using namespace IO;\nusing namespace std;\n\n#define int long long\nconst int N = 3e5+10;\nint pre[N][30],sum[N][30],a[N],lg[N],n,q;\nint gcd(int m,int n){return m%n==0?n:gcd(n,m%n);}\nint query(int x,int l){\n\tif (a[x]<l)return x-l;\n\tint res=x-l,fl=0;x=a[x];\n\tfor (int i=20;i>=0;i--)\n\t\tif (pre[x][i]>=l)\n\t\t\tres+=sum[x][i]+(x-pre[x][i])*fl,x=pre[x][i],fl|=lg[i];\n\treturn res+(x-l)*(fl+1);\n}\nsigned main(){\n\tn=read(),lg[0]=1,a[1]=1,pre[n+1][0]=n;\n\tfor (int i=2;i<=n;i++)a[i]=read();\n\tfor (int i=n;i>=1;i--)\n\t\tsum[i][0]=i-(pre[i][0]=min(pre[i+1][0],a[i]));\n\tfor (int i=1;i<=20;i++)lg[i]=lg[i-1]<<1;\n\tfor (int j=0;lg[j+1]<=n;j++)\n\t\tfor (int i=1;i<=n;i++)\n\t\t\tpre[i][j+1]=pre[pre[i][j]][j],\n\t\t\tsum[i][j+1]=sum[i][j]+sum[pre[i][j]][j]+lg[j]*(pre[i][j]-pre[i][j+1]);\n\tq=read();\n\tfor (int i=1;i<=q;i++){\n\t\tint l=read(),r=read(),x=read(),len=r-l+1;\n\t\tint val=query(x,l)-query(x,r+1),d=gcd(val,len);\n\t\twrite(val/d,'/'),write(len/d);\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1672136049,
        "uid": 518232,
        "name": "dage666",
        "ccfLevel": 0,
        "title": "P5465 \u89e3\u9898\u62a5\u544a"
    }
]