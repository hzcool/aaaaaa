[
    {
        "content": "~~\u8fd9\u9898\u771f\u662f\u7cdf\u7cd5\u554a~~\n\n~~\u91cd\u6784\u4e00\u904d\u5c31\u8fc7\u4e86~~\n\n## \u89e3\u9898\u601d\u8def\n\n\u89c2\u5bdf\u5230\u9898\u76ee\u7ef4\u62a4\u7684\u662f\u52a8\u6001\u6811\u4e0a\u7684\u6811\u94fe\u4fe1\u606f\u95ee\u9898\uff0c\u4e0d\u96be\u60f3\u5230\u7528 LCT \u7ef4\u62a4\u3002\n\n\u8003\u8651\u7ef4\u62a4\u4fee\u6539\u64cd\u4f5c\u3002\u7531\u4e8e\u6309\u4f4d\u5f02\u6216\u64cd\u4f5c\u5bf9\u6309\u4f4d\u4e0e\uff0c\u6309\u4f4d\u6216\u548c\u6c42\u548c\u64cd\u4f5c\u4e0d\u5177\u6709\u5206\u914d\u7387\uff0c\u6240\u4ee5\u6211\u4eec\u8ba8\u8bba\u6bcf\u4e00\u4f4d\u7684\u60c5\u51b5\u3002\n\n\u4e0d\u96be\u53d1\u73b0\uff0c\u5f02\u6216\u4e8c\u8fdb\u5236\u62c6\u4f4d\u540e\u5177\u6709\u5206\u914d\u7387\u3002\u5982\u679c\u5f02\u6216\u7684 $v$ \u503c\u5728\u4e8c\u8fdb\u5236\u4e0a\u7684\u7b2c $i$ \u4f4d\u6709\u503c\u7684\u8bdd\uff0c\u4f1a\u5c06\u8fd9\u68f5\u5b50\u6811\u91cc\u7684\u6240\u6709\u503c\u7684\u8fd9\u4e00\u4f4d\u4e0a\u90fd\u4f1a\u53cd\u8f6c\uff08\u5373 $0$ \u53d8\u4e3a $1$ \uff0c $1$ \u53d8\u4e3a $0$ \uff09\u3002\n\n\u6211\u4eec\u4ee5\u8f85\u52a9\u6811\u5b50\u6811\u4e2d\u6bcf\u4e00\u4f4d\u4e0a $0$ \u548c $1$ \u7684\u6570\u91cf\u6765\u8bb0\u5f55\u6811\u94fe\u7684\u4fe1\u606f\u5e76\u5904\u7406\u67e5\u8be2\u3002\n\n\u8fdb\u884c\u4fee\u6539\u64cd\u4f5c\u65f6\uff0c\u63d0\u53d6\u51fa $x$ \u5230 $y$ \u7684\u6811\u94fe\u5230\u4e00\u68f5\u6811\u4e0a\uff0c\u5c06\u6839\u8282\u70b9\u4e0a\u5bf9\u5e94\u4f4d\u7684 $0$ \u548c $1$ \u7684\u6570\u91cf\u4ea4\u6362\uff0c\u7136\u540e\u6253\u4e0a\u6807\u8bb0\u3002\u5728\u8fdb\u884c ```splay``` \u64cd\u4f5c\u524d\uff0c\u5148\u4e0b\u4f20\u6240\u6709\u8def\u5f84\u4e0a\u4f1a\u7ecf\u8fc7\u7684\u6807\u8bb0\u3002\n\n\u67e5\u8be2\u6811\u94fe\u4fe1\u606f\u65f6\uff0c\u6211\u4eec\u540c\u6837\u63d0\u53d6\u51fa $x$ \u5230 $y$ \u4e4b\u95f4\u7684\u6811\u94fe\u3002\n\n\u5bf9\u4e8e\u6bcf\u4e00\u4f4d\uff0c\u5982\u679c\u5b50\u6811\u4e2d\u8fd9\u4e00\u4f4d\u4e0a\u6ca1\u6709 $0$ \uff0c\u8bf4\u660e\u8fd9\u4e00\u4f4d\u4e0a ```and``` \u503c\u4e3a $1$ \uff1b\n\n\u5982\u679c\u5b50\u6811\u4e2d\u8fd9\u4e00\u4f4d\u4e0a\u81f3\u5c11\u6709\u4e00\u4e2a $1$ \uff0c\u8bf4\u660e\u8fd9\u4e00\u4f4d\u4e0a ```or``` \u503c\u4e3a $1$ \uff1b\n\n\u5982\u679c\u5b50\u6811\u4e2d\u8fd9\u4e00\u4f4d\u4e0a $1$ \u7684\u4e2a\u6570\u4e3a\u5947\u6570\uff0c\u8bf4\u660e\u8fd9\u4e00\u4f4d\u4e0a ```xor``` \u7684\u503c\u4e3a $1$ \u3002\n\n\u6c42\u6811\u94fe\u548c\u65f6\uff0c\u53ea\u9700\u6c42\u51fa\u6240\u6709\u4f4d\u4e0a $1$ \u7684\u4e2a\u6570\u4e58\u8fd9\u4e2a\u6570\u4f4d\u7684\u5927\u5c0f\u7684\u603b\u548c\u3002\u8fd9\u91cc\u9700\u8981\u4f7f\u7528 ```long long``` \u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log _2 n\\log_2 A)$ \uff0c\u7a7a\u95f4\u590d\u6742\u5ea6 $O(n\\log_2 A)$ \u3002\n\n## \u53c2\u8003\u4ee3\u7801\n\n```cpp\n#include<cstdio>\n#include<cstring>\n#include<algorithm>\nusing namespace std;\nconst int maxn=100010;\nint n,q,x,y,z;\nchar op;\ntypedef long long ll;\nll ans;\nstruct Splay\n{\n\tint ch[maxn][2],fa[maxn],v[maxn],tag[maxn],xr[maxn],zero[maxn][31],ones[maxn][31];\n\tvoid clear(int x)\n\t{\n\t\tch[x][0]=ch[x][1]=fa[x]=tag[x]=xr[x]=0;\n\t\tfor(int i=0;i<=30;i++)zero[x][i]=ones[x][i]=0;\n\t}\n\tint getch(int x){return ch[fa[x]][1]==x;}\n\tint isroot(int x){return ch[fa[x]][0]!=x&&ch[fa[x]][1]!=x;}\n\tvoid maintain(int x)\n\t{\n\t\tfor(int i=0;i<=30;i++)zero[x][i]=ones[x][i]=0;\n\t\tfor(int i=0;i<=30;i++)if(v[x]&(1<<i))ones[x][i]++;else zero[x][i]++;\n\t\tif(ch[x][0])for(int i=0;i<=30;i++)zero[x][i]+=zero[ch[x][0]][i],ones[x][i]+=ones[ch[x][0]][i];\n\t\tif(ch[x][1])for(int i=0;i<=30;i++)zero[x][i]+=zero[ch[x][1]][i],ones[x][i]+=ones[ch[x][1]][i];\n\t}\n\tvoid pushdown(int x)\n\t{\n\t\tif(tag[x])\n\t\t{\n\t\t\tif(ch[x][0])swap(ch[ch[x][0]][0],ch[ch[x][0]][1]),tag[ch[x][0]]^=1;\n\t\t\tif(ch[x][1])swap(ch[ch[x][1]][0],ch[ch[x][1]][1]),tag[ch[x][1]]^=1;\n\t\t\ttag[x]=0;\n\t\t}\n\t\tif(xr[x])\n\t\t{\n\t\t\tif(ch[x][0])\n\t\t\t{\n\t\t\t\tfor(int i=0;i<=30;i++)if(xr[x]&(1<<i))swap(zero[ch[x][0]][i],ones[ch[x][0]][i]);\n\t\t\t\tv[ch[x][0]]^=xr[x];xr[ch[x][0]]^=xr[x];\n\t\t\t}\n\t\t\tif(ch[x][1])\n\t\t\t{\n\t\t\t\tfor(int i=0;i<=30;i++)if(xr[x]&(1<<i))swap(zero[ch[x][1]][i],ones[ch[x][1]][i]);\n\t\t\t\tv[ch[x][1]]^=xr[x];xr[ch[x][1]]^=xr[x];\n\t\t\t}\n\t\t\txr[x]=0;\n\t\t}\n\t}\n\tvoid update(int x)\n\t{\n\t\tif(!isroot(x))update(fa[x]);\n\t\tpushdown(x);\n\t}\n\tvoid rotate(int x)\n\t{\n\t\tint y=fa[x],z=fa[y],chx=getch(x),chy=getch(y);\n\t\tfa[x]=z;if(!isroot(y))ch[z][chy]=x;\n\t\tch[y][chx]=ch[x][chx^1];fa[ch[x][chx^1]]=y;\n\t\tch[x][chx^1]=y;fa[y]=x;\n\t\tmaintain(y);maintain(x);\n\t}\n\tvoid splay(int x)\n\t{\n\t\tupdate(x);\n\t\tfor(int f=fa[x];f=fa[x],!isroot(x);rotate(x))\n\t\tif(!isroot(f))rotate(getch(x)==getch(f)?f:x);\n\t}\n\tvoid access(int x)\n\t{\n\t\tfor(int f=0;x;f=x,x=fa[x])\n\t\tsplay(x),ch[x][1]=f,maintain(x);\n\t}\n\tvoid makeroot(int x)\n\t{\n\t\taccess(x);splay(x);\n\t\ttag[x]^=1;\n\t\tswap(ch[x][0],ch[x][1]);\n\t}\n}st;\nint main()\n{\n\tscanf(\"%d%d\",&n,&q);\n\tfor(int i=1;i<=n;i++)scanf(\"%d\",&st.v[i]),st.maintain(i);\n\twhile(q--)\n\t{\n\t\tscanf(\" %c%d%d\",&op,&x,&y);\n\t\tif(op=='L')\n\t\t{\n\t\t\tst.makeroot(x);st.fa[x]=y;\n\t\t}\n\t\tif(op=='C')\n\t\t{\n\t\t\tst.makeroot(x);st.access(y);st.splay(y);\n\t\t\tst.fa[x]=st.ch[y][0]=0;\n\t\t\tst.maintain(y);\n\t\t}\n\t\tif(op=='U')\n\t\t{\n\t\t\tscanf(\"%d\",&z);\n\t\t\tst.makeroot(x);st.access(y);st.splay(y);\n\t\t\tfor(int i=0;i<=30;i++)if(z&(1<<i))swap(st.zero[y][i],st.ones[y][i]);\n\t\t\tst.xr[y]^=z;st.v[y]^=z;\n\t\t}\n\t\tif(op=='A')\n\t\t{\n\t\t\tst.makeroot(x);st.access(y);st.splay(y);\n\t\t\tans=0;\n\t\t\tfor(int i=0;i<=30;i++)if(!st.zero[y][i])ans+=(1<<i);\n\t\t\tprintf(\"%lld\\n\",ans);\n\t\t}\n\t\tif(op=='O')\n\t\t{\n\t\t\tst.makeroot(x);st.access(y);st.splay(y);\n\t\t\tans=0;\n\t\t\tfor(int i=0;i<=30;i++)if(st.ones[y][i])ans+=(1<<i);\n\t\t\tprintf(\"%lld\\n\",ans); \n\t\t}\n\t\tif(op=='X')\n\t\t{\n\t\t\tst.makeroot(x);st.access(y);st.splay(y);\n\t\t\tans=0;\n\t\t\tfor(int i=0;i<=30;i++)if(st.ones[y][i]&1)ans+=(1<<i);\n\t\t\tprintf(\"%lld\\n\",ans);\n\t\t}\n\t\tif(op=='S')\n\t\t{\n\t\t\tst.makeroot(x);st.access(y);st.splay(y);\n\t\t\tans=0;\n\t\t\tfor(int i=0;i<=30;i++)ans+=(ll)(1<<i)*(ll)st.ones[y][i];\n\t\t\tprintf(\"%lld\\n\",ans);\n\t\t}\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1557143765,
        "uid": 43486,
        "name": "hsfzLZH1",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P5352 \u3010Terrible Homework\u3011"
    },
    {
        "content": "`\u613f\u5929\u5802\u6ca1\u6709J*\u9898\u548cJ*\u51fa\u9898\u4eba\u3002`  \n\n\u770b\u8d77\u6765\u4e0d\u592a\u597d\u641e\uff0c\u5b9e\u9645\u4e0a\u662f\u4e00\u9053\u5e76\u65e0\u6280\u672f\u542b\u91cf\u7684**\u6c34\u9898**\u3002  \n(\u4f46\u8fd8\u662f\u56e0\u4e3aLCT\u677f\u5b50\u6253\u9519\u8c03\u4e862h)  \n\u6709\u52a8\u6001\u52a0\u8fb9\u5220\u8fb9\uff0c\u8003\u8651\u7528LCT\u7ef4\u62a4\u3002  \n\n\u94fe\u4e0a\u64cd\u4f5c\u6709\u6574\u4f53$\\text{xor}$\u4e00\u4e2a\u503c\uff0c\u8003\u8651\u6309\u4f4d\u7b97\uff0c\u7ef4\u62a4\u94fe\u4e0a\u6240\u6709\u6570\u7b2c$i$\u4f4d$1$\u7684\u4e2a\u6570\u3002 \n\u7ed9\u67d0\u4e00\u4f4d$\\text{xor}$\u4e0a$1$\uff0c\u5c31\u76f8\u5f53\u4e8e\u628a$1$\u90fd\u53d8\u6210\u4e86$0$\uff0c$0$\u90fd\u53d8\u6210\u4e86$1$\u3002  \n\n\u6c42\u94fe\u4e0a$\\text{and}$\u548c\uff0c\u5fc5\u987b\u6bcf\u4e2a\u70b9\u7684\u7b2c$i$\u4f4d\u90fd\u662f$1$\uff0c\u7ed3\u679c\u7684\u7b2c$i$\u4f4d\u624d\u4f1a\u662f$1$\u3002  \n\u5bf9\u4e8e$\\text{or}$\u548c\uff0c\u53ea\u8981\u6709\u4e00\u4e2a\u70b9\u7684\u7b2c$i$\u4f4d\u662f$1$\uff0c\u7ed3\u679c\u7684\u7b2c$i$\u4f4d\u5c31\u662f$1$\u3002   \n\u5bf9\u4e8e\u6c42$\\text{xor}$\u548c\uff0c\u7b2c$i$\u4f4d\u662f$1$\u7684\u70b9\u6709\u5947\u6570\u4e2a\uff0c\u7ed3\u679c\u7684\u7b2c$i$\u4f4d\u624d\u4f1a\u662f$1$\u3002  \n\u76f4\u63a5\u6c42\u548c\u662f\u6700\u7b80\u5355\u7684\uff0c\u5bf9\u4e8e\u6240\u6709\u7684$i$\uff0c\u7b2c$i$\u4f4d$1$\u7684\u4e2a\u6570\u5de6\u79fb$i$\u4f4d\u4e4b\u548c\u5373\u662f\u7b54\u6848\u3002  \n\n\u7531\u4e8e\u662fLCT\uff0c\u5e76\u4e0d\u662f\u7ebf\u6bb5\u6811\uff0c\u6ce8\u610f\u7ef4\u62a4\u5b50\u6811\u5927\u5c0f\u7b49\u4fe1\u606f\u3002\n\nCode\uff1a  \n```cpp\n#include<cstdio>\n#include<iostream>\n#include<cstring>\n#include<algorithm>\n#include<cmath>\n#include<vector>\n#include<queue>\n#define N 100007\n#define int long long\n#define reg register\n#define inf 0x3f3f3f3f\n#define ls son[u][0]\n#define rs son[u][1]\n#define K 32\nusing namespace std;\n\nint a[N];\nint n,q;\n\nstruct Link_Cut_Tree{\n    int st[N],fa[N],son[N][2],size[N];\n    int r[N],s[N][K],tag[N][K];\n\n    inline bool notroot(int u){\n        return son[fa[u]][0]==u||son[fa[u]][1]==u;\n    }\n\n    inline void pushup(int u){\n        size[u] = size[ls]+size[rs]+1;\n        for(reg int i=0;i<K;++i) //pushup\u4e5f\u6309\u4f4d\u7b97\n            s[u][i] = s[ls][i]+s[rs][i]+((a[u]>>i)&1);\n    }\n\n    inline void pushr(int u){\n        swap(ls,rs);\n        r[u] ^= 1;\n    }\n\n    inline void pushxor(int u,int i){\n    \t//\u5904\u7406\u5f02\u6216\u6807\u8bb0,\u7ed9u\u7684\u7b2ci\u4e3a\u5f02\u6216\u4e0a1\n        a[u] ^= 1<<i;\n        tag[u][i] ^= 1; \n        s[u][i] = size[u]-s[u][i];\n    }\n\n    inline void pushdown(int u){\n        for(reg int i=0;i<K;++i){\n            if(!tag[u][i]) continue;\n            if(ls) pushxor(ls,i);\n            if(rs) pushxor(rs,i);\n            tag[u][i] = 0;\n        }\n        if(!r[u]) return;\n        if(ls) pushr(ls);\n        if(rs) pushr(rs);\n        r[u] = 0;\n    }\n\n    inline void rotate(int x){\n        int y = fa[x],z = fa[y];\n        int k = son[y][1]==x,w = son[x][k^1];\n        if(notroot(y)) son[z][son[z][1]==y] = x;\n        son[x][k^1] = y;\n        son[y][k] = w;\n        if(w) fa[w] = y;\n        fa[y] = x,fa[x] = z;\n        pushup(y);\n    }\n\n    inline void splay(int x){\n        int y = x,z = 0;\n        st[++z] = y;\n        while(notroot(y)) st[++z] = y = fa[y];\n        while(z) pushdown(st[z--]);\n        while(notroot(x)){\n            y = fa[x],z = fa[y];\n            if(notroot(y)){\n                if((son[z][1]==y)==(son[y][1]==x)) rotate(y);\n                else rotate(x);\n            }\n            rotate(x);\n        }\n        pushup(x);\n    }\n\n    inline void access(int u){\n        for(int y=0;u;u=fa[u]){\n            splay(u);\n            rs = y;\n            pushup(u);\n            y = u;\n        }\n    }\n\n    inline void makeroot(int u){\n        access(u),splay(u);\n        pushr(u);\n    }\n\n    inline int findroot(int u){\n        access(u),splay(u);\n        while(ls){\n            pushdown(u);\n            u = ls;\n        }\n        splay(u);\n        return u;\n    }\n\n    inline void split(int u,int v){\n        makeroot(u);\n        access(v),splay(v);\n    }\n\n    inline void link(int u,int v){\n        makeroot(u);\n        if(findroot(v)!=u) fa[u] = v;\n    }\n\n    inline void cut(int u,int v){\n        makeroot(u);\n        if(findroot(v)!=u||son[v][0]||fa[v]!=u) return;\n        fa[v] = son[u][1] = 0;\n        pushup(u);\n    }\n\n    inline void modify(int u,int v,int k){\n        split(u,v);\n        for(reg int i=0;k;++i){\n            if(k&1) pushxor(v,i); //\u6309\u4f4d\u6253\u6807\u8bb0\n            k >>= 1;\n        }\n    }\n\n    inline int qsum(int u,int v){\n    \t//\u6c42\u548c\n        split(u,v);\n        int res = 0;\n        for(reg int i=0;i<K;++i)\n            res += s[v][i]<<i;\n        return res;\n    }\n\n    inline int qxor(int u,int v){\n    \t//\u6c42xor\u548c\n        split(u,v);\n        int res = 0;\n        for(reg int i=0;i<K;++i)\n            if(s[v][i]&1) res |= 1ll<<i;\n        return res;\n    }\n\n    inline int qand(int u,int v){\n    \t//\u6c42and\u548c\n        split(u,v);\n        int res = 0;\n        for(reg int i=0;i<K;++i)\n            if(s[v][i]==size[v]) res |= 1ll<<i;\n        return res;    \n    }\n\n    inline int qor(int u,int v){\n    \t//\u6c42or\u548c\n        split(u,v);\n        int res = 0;\n        for(reg int i=0;i<K;++i)\n            if(s[v][i]) res |= 1ll<<i;\n        return res;    \n    }\n}T;\n\ninline void read(int &x);\nvoid print(int x);\n\nsigned main(){\n    int u,v,k;\n    read(n),read(q);\n    for(reg int i=1;i<=n;++i){\n        read(a[i]);\n        T.size[i] = 1; //\u521d\u59cb\u6bcf\u4e2a\u70b9\u7684\u5b50\u6811\u5927\u5c0f\u90fd\u662f1\n    }\n    while(q--){\n        char c = getchar();\n        while(c<'A'||c>'Z') c = getchar();\n        read(u),read(v);\n        if(c=='U') read(k);\n        if(c=='L') T.link(u,v);\n        else if(c=='C') T.cut(u,v);\n        else if(c=='U') T.modify(u,v,k);\n        else if(c=='O') print(T.qor(u,v)),putchar('\\n');\n        else if(c=='A') print(T.qand(u,v)),putchar('\\n');\n        else if(c=='X') print(T.qxor(u,v)),putchar('\\n');\n        else print(T.qsum(u,v)),putchar('\\n');\n    }\n    return 0;\n}\n\ninline void read(int &x){\n    x = 0;\n    char c = getchar();\n    while(c<'0'||c>'9') c = getchar();\n    while(c>='0'&&c<='9'){\n        x = (x<<3)+(x<<1)+(c^48);\n        c = getchar();\n    }\n}\n\nvoid print(int x){\n    if(x>9) print(x/10);\n    putchar(x%10+'0');\n}\n```",
        "postTime": 1557070658,
        "uid": 115864,
        "name": "NaCly_Fish",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 P5352 \u3010Terrible Homework\u3011"
    },
    {
        "content": "~~\u4e0d\u662f\u6570\u8bba\u9898\u5417\u600e\u4e48\u51fa\u6210\u6570\u636e\u7ed3\u6784\u4e86\u554a~~\n\n$\\rm Link-Cut-Tree$\u88f8\u9898\u3002\n\n\u6211\u4eec\u5957\u8def\u5730\u5bf9\u6bcf\u4e00\u4f4d\u5206\u522b\u7ef4\u62a4\u4e00\u4e0b\u548c\u5c31\u597d\u4e86\u3002\n\n\u6bcf\u6761\u91cd\u94fe\u7684splay\u4e0a\u6253\u4e00\u4e0b\u5f02\u6216\u6807\u8bb0\u5c31\u53ef\u4ee5\u4e86\u3002\n\n\u4e5f\u6ca1\u6709\u4ec0\u4e48\u5751\uff0c\u6807\u8bb0\u7684\u4e0b\u653e\uff0c\u4e0a\u4f20\u4e5f\u975e\u5e38\u7b80\u5355\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6$O(30n\\log n)$\u3002\n\n## Code\uff1a\n```cpp\n#include<cstdio>\n#include<algorithm>\nconst int N=1e5+5;\nint n,m;\ntypedef long long LL;\nnamespace lct{\n\tint ch[N][2],tag[N],val[N],fa[N],And[N],Or[N],Xor[N],sum[N][30],xtag[N],sz[N];\n\tinline int ckr(int x,int p=1){return ch[fa[x]][p]==x;}\n\tinline int isroot(int x){return!(ckr(x)||ckr(x,0));}\n\tinline void flip(int x){tag[x]^=1,std::swap(ch[x][0],ch[x][1]);}\n\tinline void update(int x){\n\t\tsz[x]=sz[ch[x][0]]+sz[ch[x][1]]+1;\n\t\tAnd[x]=And[ch[x][0]]&And[ch[x][1]]&val[x];\n\t\tOr[x]=Or[ch[x][0]]|Or[ch[x][1]]|val[x];\n\t\tXor[x]=Xor[ch[x][0]]^Xor[ch[x][1]]^val[x];\n\t\tfor(int i=0;i<30;++i)\n\t\tsum[x][i]=sum[ch[x][0]][i]+sum[ch[x][1]][i]+(val[x]>>i&1);\n\t}\n\tvoid modify(int x,int v){\n\t\txtag[x]^=v,val[x]^=v;\n\t\tint&A=And[x],&O=Or[x],&X=Xor[x];\n\t\tA=O=X=0;\n\t\tfor(int i=0;i<30;++i){\n\t\t\tif(v>>i&1)sum[x][i]=sz[x]-sum[x][i];\n\t\t\tA|=(sum[x][i]==sz[x])<<i,O|=(!!sum[x][i])<<i,X|=(sum[x][i]&1)<<i;\n\t\t}\n\t}\n\tinline void pushdown(int x){\n\t\tif(tag[x]){\n\t\t\ttag[x]=0;\n\t\t\tif(ch[x][0])flip(ch[x][0]);\n\t\t\tif(ch[x][1])flip(ch[x][1]);\n\t\t}\n\t\tif(xtag[x]){\n\t\t\tif(ch[x][0])modify(ch[x][0],xtag[x]);\n\t\t\tif(ch[x][1])modify(ch[x][1],xtag[x]);\n\t\t\txtag[x]=0;\n\t\t}\n\t}\n\tinline void rotate(int x){\n\t\tint y=fa[x],z=fa[y],k=ckr(x);\n\t\tif(!isroot(y))ch[z][ckr(y)]=x;\n\t\tfa[x]=z,fa[y]=x,fa[ch[x][!k]]=y;\n\t\tch[y][k]=ch[x][!k],ch[x][!k]=y,update(y);\n\t}\n\tinline void splay(int x){\n\t\tstatic int sta[N],top;sta[top=1]=x;\n\t\tfor(int y=x;!isroot(y);sta[++top]=y=fa[y]);\n\t\twhile(top)pushdown(sta[top--]);\n\t\tfor(;!isroot(x);rotate(x))\n\t\tif(!isroot(fa[x]))rotate((ckr(x)^ckr(fa[x]))?x:fa[x]);\n\t\tupdate(x);\n\t}\n\tinline void access(int x){for(int t=0;x;ch[x][1]=t,t=x,x=fa[x])splay(x);}\n\tinline void makeroot(int x){access(x),splay(x),flip(x);}\n\tinline void split(int x,int y){makeroot(x),access(y),splay(y);}\n\tinline int findroot(int x){access(x);for(splay(x);ch[x][0];x=ch[x][0]);splay(x);return x;}\n\tinline void link(int x,int y){makeroot(x),fa[x]=y;}\n\tinline void cut(int x,int y){split(x,y),fa[x]=ch[y][0]=0,update(y);}\n\tinline void modify(int x,int y,int v){split(x,y),modify(y,v);}\n\tinline LL query(int x,int y,char op){\n\t\tsplit(x,y);\n\t\tswitch(op){\n\t\t\tcase'A':return And[y];\n\t\t\tcase'O':return Or[y];\n\t\t\tcase'X':return Xor[y];\n\t\t\tcase'S':\n\t\t\t\tLL ans=0;\n\t\t\t\tfor(int i=0;i<30;++i)\n\t\t\t\tans+=sum[y][i]*(1LL<<i);\n\t\t\t\treturn ans;\n\t\t}\n\t}\n}\nint main(){\n\tscanf(\"%d%d\",&n,&m);\n\tlct::And[0]=(1<<30)-1;\n\tfor(int i=1;i<=n;++i)scanf(\"%d\",lct::val+i),lct::update(i);\n\twhile(m--){\n\t\tchar op[3];int x,y;\n\t\tscanf(\"%s%d%d\",op,&x,&y);\n\t\tswitch(*op){\n\t\t\tcase'L':{\n\t\t\t\tlct::link(x,y);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase'C':{\n\t\t\t\tlct::cut(x,y);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcase'U':{\n\t\t\t\tint v;\n\t\t\t\tscanf(\"%d\",&v);\n\t\t\t\tlct::modify(x,y,v);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tdefault:printf(\"%lld\\n\",lct::query(x,y,*op));\n\t\t}\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1557057523,
        "uid": 6813,
        "name": "mrsrz",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P5352 \u3010Terrible Homework\u3011"
    },
    {
        "content": "## \u524d\u7f6e\u77e5\u8bc6\uff1aLCT\uff08\u52a8\u6001\u6811\uff09\n\n\u770b\u5230\u9898\u76ee\u91cc\u8981\u6c42Link\u548cCut\uff0c\u5f53\u7136\u5c31\u4f1a\u60f3\u5230LCT\u3002\n\n\u8003\u8651\u7528LCT\uff0c\u4f46\u56e0\u4e3a\u6709\u6c42\u94fe\u4e0a$and$\u548c\u94fe\u4e0a$or$\uff0c\u800c$and$\u7684\u7ed3\u679c\u548c$or$\u7684\u7ed3\u679c\u5728\u8fdb\u884c\u4e00\u6b21\u94fe\u4e0a\u5f02\u6216\u64cd\u4f5c\u540e\uff0c\u4fe1\u606f\u96be\u4ee5\u76f4\u63a5\u7ef4\u62a4\u3002\u4f46$N$\u7684\u5927\u5c0f\u662f$1e5$\u7684\uff0c\u53ef\u4ee5\u8003\u8651\u5efa30\u68f5LCT\uff0c\u7b2c$i(0\\leq i<30)$\u68f5\u7ef4\u62a4\u8fd9\u68f5\u6811\u4e0a\u8fd9\u4e2a\u70b9\u5728\u7b2c$i$\u4e2a\u4e8c\u8fdb\u5236\u4f4d\u4e0a\u7684\u503c\uff0c\u590d\u6742\u5ea6$O(nlog^2n)$\uff0c\u5e94\u8be5\u662f\u53ef\u884c\u7684\u3002\n\n\u8003\u8651\u7ef4\u62a4\u7684\u4e1c\u897f\uff0c\u8bb0$js[x][i]$\u4e3a\u4ee5$x$\u4e3a\u6839\u7684splay\u4e2d\u6240\u6709\u6570\uff0c\u4e8c\u8fdb\u5236\u7b2c$i$\u4f4d\u4e3a1\u7684\u70b9\u6570\u3002\n\n\u5bf9\u4e8e\u8be2\u95ee\u64cd\u4f5c\uff0c\u82e5split\u51fa\u6765\u7684splay\u5728\u7b2c$i$\u4f4d1\u7684\u6570\u91cf\u4e3a\u5947\u6570\uff0c\u5219\u5f02\u6216\u503c\u52a0\u4e0a\u8be5$1<<i$\uff1b\u82e5\u6570\u91cf\u7b49\u4e8e\u8be5splay\u7684\u5927\u5c0f\uff0c\u5219and\u503c\u52a0\u4e0a$1<<i$\uff1b\u82e5\u6570\u91cf\u4e0d\u4e3a0\uff0c\u5219or\u503c\u52a0\u4e0a$1<<i$\u3002\n\n\u5bf9\u4e8e\u4fee\u6539\u64cd\u4f5c\uff0c\u76f4\u63a5\u5c06split\u51fa\u6765\u7684splay\u5bf9\u4e8e\u8be5splay\u4e2d\u7684\u6bcf\u4e00\u4e2a\u8282\u70b9$x$,\u5bf9\u4e8e$i(0\\leq i<30)$\uff0c$js[x][i]=sz[x]-js[x][i]$\uff0c\u5f53\u7136\u4e0d\u80fd\u76f4\u63a5\u66b4\u529b\uff0c\u8981\u6253\u61d2\u6807\u8bb0\u3002\n\n\u7136\u540e\u5c31\u662f\u4ee3\u7801\u5b9e\u73b0\u4e86\u3002\n\n```cpp#include<bits/stdc++.h>\n#define res register int\nusing namespace std;\nconst int N=3000010,t=31;\nint n,m;\nint fa[N],ch[N][2],sz[N],js[N][t+1];\nbool rev[N],val[N][t+1],r[N][t+1];\ninline bool get(res x){\n    return x==ch[fa[x]][1];\n}\ninline bool nroot(res x){\n    return ch[fa[x]][0]!=x&&ch[fa[x]][1]!=x;\n}\ninline void pushup(res x){\n    sz[x]=sz[ch[x][0]]+1+sz[ch[x][1]];\n    for(int i=0;i<t;++i){\n\t    js[x][i]=js[ch[x][0]][i]+val[x][i]+js[ch[x][1]][i];\n\t}\n}\ninline void reverse(res x){\n    rev[x]^=1;\n    swap(ch[x][0],ch[x][1]);\n}\ninline void assign(res x,int len){\n    val[x][len]^=1;\n    r[x][len]^=1;\n    js[x][len]=sz[x]-js[x][len];\n}\ninline void pushdown(res x){\n    if(rev[x]){\n        rev[x]=0;\n        if(ch[x][0])reverse(ch[x][0]);\n        if(ch[x][1])reverse(ch[x][1]);\n    }\n    for(int i=0;i<t;++i){\n\t    if(r[x][i]){\n\t        r[x][i]=0;\n\t        if(ch[x][0])assign(ch[x][0],i);\n\t        if(ch[x][1])assign(ch[x][1],i);\n\t\t}\n\t}\n}\ninline void rotate(res x){\n    res f=fa[x],oldf=fa[f],k=get(x);\n    if(!nroot(f))ch[oldf][get(f)]=x;\n    fa[x]=oldf;\n    ch[f][k]=ch[x][k^1],fa[ch[x][k^1]]=f;\n    ch[x][k^1]=f,fa[f]=x;\n    pushup(f),pushup(x);\n}\nint st[N],top;\ninline void splay(res x){\n    res y=x;\n    st[++top]=y;\n    while(!nroot(y))st[++top]=fa[y],y=fa[y];\n    while(top)\n        pushdown(st[top--]);\n    while(1){\n        res y=fa[x];\n        if(nroot(x))return;\n        if(get(x)==get(y)&&!nroot(y))rotate(y);\n        rotate(x);\n    }\n}\ninline void access(res x){\n    for(res y=0;x;y=x,x=fa[x]){\n        splay(x),ch[x][1]=y,pushup(x);\n    }\n}\ninline void makeroot(res x){\n    access(x),splay(x);\n    reverse(x);\n}\ninline int findroot(int x){\n    access(x),splay(x);\n    while(ch[x][0])pushdown(x),x=ch[x][0];\n    splay(x);\n    return x;\n}\ninline void split(int x,int y){\n    makeroot(x);\n    access(y),splay(y); \n}\ninline bool link(int x,int y){\n    makeroot(x);\n    if(findroot(y)==x)return 0;\n    fa[x]=y;\n    return 1;\n}\ninline int cut(int x,int y){\n    makeroot(x);\n    if(findroot(y)==x&&sz[x]==2)\n        fa[y]=ch[x][1]=0;\n    pushup(x);\n    return 1;\n}\ninline int read(){\n    res ret=0;char c;\n    for(c=getchar();!isdigit(c);c=getchar());\n    for(;isdigit(c);ret=(ret<<1)+(ret<<3)+c-'0',c=getchar());\n    return ret;\n}\nint main(){\n\tcin>>n>>m;\n\tfor(res i=1;i<=n;++i){\n\t    res x=read();\n\t    for(res j=0;j<t;++j){\n\t        val[i][j]=bool(x&(1<<j));\n\t\t}\n\t}\n\twhile(m--){\n\t\tchar op[2];\n\t\tscanf(\"%s\",op);\n\t\tif(op[0]=='L'){\n\t\t    res x=read(),y=read();\n\t\t    link(x,y);\n\t\t}else if(op[0]=='A'){\n\t\t    res x=read(),y=read(),ans=0;\n\t\t    split(x,y);\n\t\t    for(res i=0;i<t;++i){\n\t\t        if(js[y][i]==sz[y]){\n\t\t            ans|=(1<<i);\n\t\t\t\t}\n\t\t\t}\n\t\t\tprintf(\"%d\\n\",ans);\n\t\t}else if(op[0]=='U'){\n\t\t    res x=read(),y=read(),z=read();\n\t\t\tsplit(x,y);\n\t\t    for(res i=0;i<t;++i){\n\t\t    \tif(z&(1<<i)){\n\t\t\t        assign(y,i);\n\t\t\t    }\n\t\t\t}\n\t\t}else if(op[0]=='O'){\n\t\t    res x=read(),y=read(),ans=0;\n\t\t    split(x,y);\n\t\t    for(res i=0;i<t;++i){\n\t\t        if(js[y][i]){\n\t\t            ans|=(1<<i);\n\t\t\t\t}\n\t\t\t}\n\t\t\tprintf(\"%d\\n\",ans);\n\t\t}else if(op[0]=='X'){\n\t\t\tres x=read(),y=read(),ans=0;\n\t\t    split(x,y);\n\t\t    for(res i=0;i<t;++i){\n\t\t        if(js[y][i]&1)ans|=(1<<i);\n\t\t\t}\n\t\t\tprintf(\"%d\\n\",ans);\n\t\t}else if(op[0]=='C'){\n\t\t    res x=read(),y=read();\n\t\t    cut(x,y);\n\t\t}else{\n\t\t    res x=read(),y=read();\n\t\t\tlong long ans=0;\n\t\t    split(x,y);\n\t\t    for(res i=0;i<t;++i){\n\t\t        ans+=(1ll<<i)*js[y][i];\n\t\t\t}\n\t\t\tprintf(\"%lld\\n\",ans);\n\t\t}\n\t}\n}\n```",
        "postTime": 1557021139,
        "uid": 48143,
        "name": "zhenglier",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P5352 \u3010Terrible Homework\u3011"
    },
    {
        "content": "\u8fd9\u9898\u53ef\u771f\u662f\u6bd2\u7624\u554a~~\u53ea\u662f\u5bf9\u672c\u849f\u84bb\u6765\u8bf4~~\n\n\u56e0\u4e3a$n < (1<<31) $,\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u6309\u4f4d\u8bb0\u5f55\u4fe1\u606f\n\n\u65f6\u95f4\u590d\u6742\u5ea6$O(nlog^2n)$\n\n$sum[x][i]$\u8868\u793a\u4ee5$x$\u4e3a\u6839\u7684\u5b50\u6811\u4e2d\u6743\u503c\u7b2c$i$\u4f4d\u4e3a\u4e00\u7684\u8282\u70b9\u6570\n\n$size[x]$\u8868\u793a\u4ee5$x$\u4e3a\u6839\u7684\u5b50\u6811\u5927\u5c0f\n\n\u6709\u96be\u5ea6\u7684\u64cd\u4f5c\u5c31\u53ea\u6709$pushup$\u548c$pushdown$\u4e86\n\n\u5bf9\u4e8e$pushup$\uff0c\u76f4\u63a5\u628a\u5de6\u53f3\u513f\u5b50\u7684\u4fe1\u606f\u548c\u5f53\u524d\u8282\u70b9\u7684\u4fe1\u606f\u52a0\u8d77\u6765\u5373\u53ef\n\n```cpp\ninline void pushup(int x) {\n\tfor(register int i=0 ; i<=30 ; ++i) sum[x][i]=sum[ch[x][0]][i]+sum[ch[x][1]][i]+(bool)((1<<i)&val[x]);\n\tsize[x]=size[ch[x][0]]+size[ch[x][1]]+1;\n}\n\n```\n\n\u7136\u540e\u5bf9\u4e8e$pushdown$\uff0c\u76f4\u63a5\u7528\u4e00\u4e2a$lazytag$\n\n\u5148\u5efa\u7acb\u4e00\u4e2a$push$\u51fd\u6570\n\n```cpp\ninline void push(int x,int c) {\n\tval[x]^=c,xr[x]^=c;\n\tfor(register int i=0 ; i<=30 ; ++i) sum[x][i]=(c&(1<<i))?size[x]-sum[x][i]:sum[x][i];\n}\n```\n\n\u8fd9\u4e2a\u51fd\u6570\u7684\u610f\u601d\u5c31\u662f\u628a\u4ee5\u8282\u70b9$x$\u4e3a\u6839\u7684\u5b50\u6811\u6240\u6709\u7684\u503c $xor$ \u4e0a$c$\n\n\u5982\u679c\u8fd9\u4e2a\u8282\u70b9\u7b2c$i$\u4f4d\u662f$1$\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u9700\u8981\u5c06$sum[x][i]$\u6539\u6210$size[x]-sum[x][i]$\uff0c\u56e0\u4e3a\u4ee5$x$\u4e3a\u6839\u7684\u6240\u6709$y$\u8282\u70b9\u7b2c$i$\u4f4d\u90fd\u8981\u6539\u6210\u4e0e\u5b83\u672c\u6765\u4e0d\u540c\u7684\u503c\uff0c\u5373$1->0;0->1$,\u6240\u4ee5\u5176\u5b9e\u662f$1$\u7684\u4e2a\u6570\u4e0e$0$\u7684\u4e2a\u6570\u4ea4\u6362\u4e86\n\n\u7136\u540e\u5c31\u662f$pushdown$\u51fd\u6570\n\n```cpp\ninline void pushdown(int x) {\n\tif(tag[x]) {\n\t\tswap(ch[x][0],ch[x][1]);\n\t\ttag[ch[x][0]]^=1,tag[ch[x][1]]^=1;\n\t\ttag[x]=0;\n\t}\n\tif(xr[x]) {\n\t\tif(ch[x][0]) push(ch[x][0],xr[x]);\n\t\tif(ch[x][1]) push(ch[x][1],xr[x]);\n\t\txr[x]=0;\n\t}\n}\n```\n\n\u5bf9\u4e8e$L$\u64cd\u4f5c\uff0c\u76f4\u63a5$link(x,y)$\u5373\u53ef\n\n\u5bf9\u4e8e$C$\u64cd\u4f5c\uff0c\u76f4\u63a5$cut(x,y)$\u5373\u53ef\n\n\u5bf9\u4e8e$U$\u64cd\u4f5c\uff0c\u6211\u4eec\u5148$split(x,y)$\uff0c\u518d$push(y,v)$\n\n$P.S.$\u6211\u521a\u5f00\u59cb\u6ca1\u628a$push$\u5199\u6210\u8fd9\u79cd\u5f62\u5f0f\uff0c\u7136\u540e\u4e00\u4e2a\u70b9\u90fd\u6ca1$AC$\n\n\u5bf9\u4e8e$A$\u64cd\u4f5c\uff0c\u82e5\u7b2c$i$\u4f4d$sum[x][i]==size[x]$,\u5219$ans+=(1<<i)$\n\n\u5bf9\u4e8e$O$\u64cd\u4f5c\uff0c\u82e5\u7b2c$i$\u4f4d$sum[x][i]!=0$,\u5219$ans+=(1<<i)$\n\n\u5bf9\u4e8e$X$\u64cd\u4f5c\uff0c\u82e5\u7b2c$i$\u4f4d$sum[x][i]$\u662f\u5947\u6570,\u5219$ans+=(1<<i)$\n\n\u5bf9\u4e8e$S$\u64cd\u4f5c\uff0c$ans+=sum[x][i]*(1<<i)$\n\u6ce8\u610f\u8fd9\u4e2a\u8981\u5f00$long \\ long$\n\n\u7136\u540e$show \\ you \\ the \\ code$\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n\ninline int read() {\n\tint res=0,f=1;char ch;\n\twhile(isspace(ch=getchar()));\n\tif(ch=='-') ch=getchar(),f=-1;\n\tdo {\n\t\tres=res*10+ch-'0';\n\t} while(isdigit(ch=getchar()));\n\treturn res*f;\n}\n\nconst int N=100005;\n\nint size[N],ch[N][2],f[N],sum[N][32],xr[N],val[N];\n\nbool tag[N];\n\ninline bool nroot(int x) {\n\treturn ch[f[x]][0]==x||ch[f[x]][1]==x;\n}\n\ninline bool get(int x) {\n\treturn ch[f[x]][1]==x;\n}\n\ninline void pushup(int x) {\n\tfor(register int i=0 ; i<=30 ; ++i) sum[x][i]=sum[ch[x][0]][i]+sum[ch[x][1]][i]+(bool)((1<<i)&val[x]);\n\tsize[x]=size[ch[x][0]]+size[ch[x][1]]+1;\n}\n\ninline void push(int x,int c) {\n\tval[x]^=c,xr[x]^=c;\n\tfor(register int i=0 ; i<=30 ; ++i) sum[x][i]=(c&(1<<i))?size[x]-sum[x][i]:sum[x][i];\n}\n\ninline void pushdown(int x) {\n\tif(tag[x]) {\n\t\tswap(ch[x][0],ch[x][1]);\n\t\ttag[ch[x][0]]^=1,tag[ch[x][1]]^=1;\n\t\ttag[x]=0;\n\t}\n\tif(xr[x]) {\n\t\tif(ch[x][0]) push(ch[x][0],xr[x]);\n\t\tif(ch[x][1]) push(ch[x][1],xr[x]);\n\t\txr[x]=0;\n\t}\n}\n\ninline void rotate(int x) {\n\tint fa=f[x],grfa=f[fa],k=get(x),c=ch[x][!k];\n\tif(nroot(fa)) ch[grfa][get(fa)]=x;\n\tch[x][!k]=fa,ch[fa][k]=c;\n\tif(c) f[c]=fa;\n\tf[fa]=x,f[x]=grfa;\n\tpushup(fa);\n}\n\nint stk[N],top;\n\ninline void pushall(int x) {\n\tstk[top=1]=x;\n\twhile(nroot(x)) stk[++top]=x=f[x];\n\twhile(top) pushdown(stk[top--]);\n}\n\ninline void splay(int x) {\n\tpushall(x);\n\twhile(nroot(x)) {\n\t\tint fa=f[x];\n\t\tif(nroot(fa)) rotate((get(x)!=get(fa))?x:fa);\n\t\trotate(x);\n\t}\n\tpushup(x);\n}\n\ninline void access(int x) {\n\tfor(register int fa=0 ; x ; x=f[fa=x]) splay(x),ch[x][1]=fa,pushup(x);\n}\n\ninline void makeroot(int x) {\n\taccess(x),splay(x),tag[x]^=1;\n}\n\ninline void split(int x,int y) {\n\tmakeroot(x),access(y),splay(y);\n}\n\ninline void link(int x,int y) {\n\tmakeroot(x),f[x]=y;\n}\n\ninline void cut(int x,int y) {\n\tsplit(x,y),f[x]=ch[y][0]=0,pushup(y);\n}\n\ninline long long query_xor(int x) {\n\tlong long ans=0;\n\tfor(register int i=0 ; i<=30 ; ++i) ans+=1LL*((sum[x][i]&1)?(1<<i):0);\n\treturn ans;\n}\n\ninline long long query_sum(int x) {\n\tlong long ans=0;\n\tfor(register int i=0 ; i<=30 ; ++i) ans+=1LL*(1<<i)*sum[x][i];\n\treturn ans;\n}\n\ninline long long query_or(int x) {\n\tlong long ans=0;\n\tfor(register int i=0 ; i<=30 ; ++i) ans+=1LL*((sum[x][i])?(1<<i):0);\n\treturn ans;\n}\n\ninline long long query_and(int x) {\n\tlong long ans=0;\n\tfor(register int i=0 ; i<=30 ; ++i) ans+=1LL*((sum[x][i]==size[x])?(1<<i):0);\n\treturn ans;\n}\n\nint main() {\n\tint n=read(),q=read();\n\tfor(register int i=1 ; i<=n ; ++i) {\n\t\tval[i]=read(),size[i]=1;\n\t\tfor(register int j=0 ; j<=30 ; ++j) sum[i][j]=(bool)((1<<j)&val[i]);\n\t}\n\tchar opt[10];\n\twhile(q--) {\n\t\tscanf(\"%s\",opt);\n\t\tint x=read(),y=read();\n\t\tif(opt[0]=='L') link(x,y);\n\t\telse if(opt[0]=='C') cut(x,y);\n\t\telse {\n\t\t\tsplit(x,y);\n\t\t\tif(opt[0]=='U') push(y,read());\n\t\t\telse if(opt[0]=='A') printf(\"%lld\\n\",query_and(y));\n\t\t\telse if(opt[0]=='O') printf(\"%lld\\n\",query_or(y));\n\t\t\telse if(opt[0]=='X') printf(\"%lld\\n\",query_xor(y));\n\t\t\telse printf(\"%lld\\n\",query_sum(y));\n\t\t}\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1560045768,
        "uid": 79075,
        "name": "mzgwty",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P5352 \u3010Terrible Homework\u3011"
    },
    {
        "content": "\u795e\u4ed9@[TheLostWeak](https://www.luogu.org/space/show?uid=28382)\u51fa\u7684\u9898\uff0c\u56e0\u4e3a\u4ed6\u6700\u8fd1\u6ca1\u65f6\u95f4\u6240\u4ee5\u6211\u5148\u5199\u4e00\u4e0bsol\uff08\u5176\u5b9e\u6211\u4e5f\u6ca1\u4ec0\u4e48\u65f6\u95f4\uff09\n\n\u4f5c\u4e3a\u4e00\u9053~~\u7b80\u5355~~\u7684\u6570\u636e\u7ed3\u6784\u9898\u60f3\u5fc5\u5927\u5bb6\u90fd\u80fd\u770b\u51fa\u5fc5\u987b\u7528**LCT**\u7ef4\u62a4\u4fe1\u606f\u5427\n\n\u4e00\u4e2a\u6734\u7d20\u7684\u60f3\u6cd5\u5c31\u662f\u76f4\u63a5\u7ef4\u62a4\u56db\u79cd\u64cd\u4f5c\u7684\u503c\uff0c\u4f46\u662f\u8fd9\u6837\u4fee\u6539\u9664\u4e86\u5f02\u6216\u597d\u50cf\u90fd\u4e0d\u80fd\u7ef4\u62a4\n\n\u65e2\u7136\u4e00\u4e2a$\\log$\u4e0d\u53ef\u884c\u90a3\u4e48\u5c31\u5927\u529b\u4e24\u4e2a$\\log$\u5427\uff0c\u5f88\u5bb9\u6613\u60f3\u5230\u76f4\u63a5\u628a\u4fe1\u606f\u62c6\u5206\u6210\u4e8c\u8fdb\u5236\u6765\u5b58\uff0c\u7136\u540e\u8bb0\u4e00\u4e0b\u5b50\u6811\u5185\u6240\u6709\u6570\u6bcf\u4e00\u4f4d\u4e0a$1$\u7684\u4e2a\u6570\u548c\n\n\u540c\u65f6\u6211\u4eec\u518d\u7ef4\u62a4\u4e00\u4e2a\u5b50\u6811\u5927\u5c0f\uff0c\u90a3\u4e48\u5bf9\u4e8e\u6bcf\u79cd\u8be2\u95ee\u65f6\u76f4\u63a5\u5927\u529b\u679a\u4e3e\u6bcf\u4e00\u4f4d\u7684\u60c5\u51b5\u5224\u65ad\u5373\u53ef\uff1a\n\n- ```and```\uff1a\u5224\u65ad\u8fd9\u4e00\u4f4d\u4e0a$1$\u7684\u4e2a\u6570\u662f\u5426\u7b49\u4e8e\u5b50\u6811\u5927\u5c0f\n- ```or```\uff1a\u5224\u65ad\u8fd9\u4e00\u4f4d\u4e0a\u662f\u5426\u6709$1$\n- ```xor```\uff1a\u5224\u65ad\u8fd9\u4e00\u4f4d\u4e0a$1$\u7684\u4e2a\u6570\u7684\u5947\u5076\u6027\n- ```sum```\uff1a\u5927\u529b\u7d2f\u52a0\u8d77\u6765\u5c31\u597d\u4e86\n\n\u5177\u4f53\u7684\uff0c\u4fee\u6539\u7684\u65f6\u5019\u7531\u4e8e\u662f\u5f02\u6216\u64cd\u4f5c\uff0c\u56e0\u6b64\u76f4\u63a5\u628a\u5bf9\u5e94\u8981\u53d8\u7684\u90a3\u4e00\u4f4d$0,1$\u7684\u4e2a\u6570\u8c03\u6362\uff0c\u5373\u7528\u5b50\u6811\u5927\u5c0f\u51cf\u53bb$1$\u7684\u4e2a\u6570\n\n\u7136\u540e\u8fd8\u9700\u8981\u4e0b\u4f20\u6807\u8bb0\uff0c\u8fd9\u4e2a\u76f4\u63a5**lazy tag**\u7ef4\u62a4\u4e00\u4e0b\u5c31\u597d\u4e86\uff0c\u7c7b\u4f3c\u4e8e[Luogu P1501 [\u56fd\u5bb6\u96c6\u8bad\u961f]Tree II](https://www.luogu.org/problemnew/show/P1501)\n\n\u7136\u540e\u6211\u4eec\u5c31\u628a\u8fd9\u9053\u6c34\u6c34\u7684\u9001\u5206\u9898\u5199\u5b8c\u4e86\uff0cLCT\u7531\u4e8e\u662f\u677f\u5b50\u6240\u4ee5\u4f1a\u6bd4\u8f83\u957f\uff0c\u5176\u5b9e\u662f\u6838\u5fc3\u4ee3\u7801\u662f\u5f88\u77ed\u7684\n\nCODE\n\n```cpp\n#include<cstdio>\n#include<cctype>\n#define RI register int\n#define CI const int&\n#define Tp template <typename T>\nusing namespace std;\ntypedef long long LL;\nconst int N=100005,RG=30;\nint n,m,val[N],x,y,z; char opt;\nclass FileInputOutput\n{\n    private:\n        static const int S=1<<21;\n        #define tc() (A==B&&(B=(A=Fin)+fread(Fin,1,S,stdin),A==B)?EOF:*A++)\n        #define pc(ch) (Ftop<S?Fout[Ftop++]=ch:(fwrite(Fout,1,S,stdout),Fout[(Ftop=0)++]=ch))\n        char Fin[S],Fout[S],*A,*B; int Ftop,pt[25];\n    public:\n        Tp inline void read(T& x)\n        {\n            x=0; char ch; while (!isdigit(ch=tc()));\n            while (x=(x<<3)+(x<<1)+(ch&15),isdigit(ch=tc()));\n        }\n        inline void get_alpha(char& ch)\n        {\n            while (!isalpha(ch=tc()));\n        }\n        Tp inline void write(T x)\n        {\n            if (!x) return (void)(pc('0'),pc('\\n')); RI ptop=0;\n            while (x) pt[++ptop]=x%10,x/=10; while (ptop) pc(pt[ptop--]+48); pc('\\n');\n        }\n        inline void Fend(void)\n        {\n            fwrite(Fout,1,Ftop,stdout);\n        }\n        #undef tc\n        #undef pc\n}F;\nclass Link_Cut_Tree\n{\n    private:\n        struct splay\n        {\n            int ch[2],fa,s[RG],size,tag; bool rev;\n        }node[N]; int stack[N],top;\n        #define lc(x) node[x].ch[0]\n        #define rc(x) node[x].ch[1]\n        #define fa(x) node[x].fa\n        #define S(x,y) node[x].s[y]\n        #define SZ(x) node[x].size\n        #define R(x) node[x].rev\n        #define T(x) node[x].tag\n        inline void swap(int& x,int& y)\n        {\n            int t=x; x=y; y=t;\n        }\n        inline void rever(CI now)\n        {\n            swap(lc(now),rc(now)); R(now)^=1;\n        }\n        inline void upt(CI now,CI xv)\n        {\n            for (RI i=0;i<RG;++i) if ((xv>>i)&1)\n            S(now,i)=SZ(now)-S(now,i); val[now]^=xv; T(now)^=xv;\n        }\n        inline void pushup(CI now)\n        {\n            SZ(now)=SZ(lc(now))+SZ(rc(now))+1; for (RI i=0;i<RG;++i)\n            S(now,i)=S(lc(now),i)+S(rc(now),i)+((val[now]>>i)&1);\n        }\n        inline void pushdown(CI now)\n        {\n            if (R(now)) rever(lc(now)),rever(rc(now)),R(now)=0;\n            if (T(now)) upt(lc(now),T(now)),upt(rc(now),T(now)),T(now)=0;\n        }\n        inline int identify(CI now)\n        {\n            return rc(fa(now))==now;\n        }\n        inline void connect(CI x,CI y,CI d)\n        {\n            node[fa(x)=y].ch[d]=x;\n        }\n        inline bool isroot(CI now)\n        {\n            return lc(fa(now))!=now&&rc(fa(now))!=now;\n        }\n        inline void rotate(CI now)\n        {\n            int x=fa(now),y=fa(x),d=identify(now); if (!isroot(x)) node[y].ch[identify(x)]=now;\n            fa(now)=y; connect(node[now].ch[d^1],x,d); connect(x,now,d^1); pushup(x); pushup(now);\n        }\n        inline void splay(int now)\n        {\n            int t=now; while (stack[++top]=t,!isroot(t)) t=fa(t);\n            while (top) pushdown(stack[top--]); for (;!isroot(now);rotate(now))\n            t=fa(now),!isroot(t)&&(rotate(identify(now)!=identify(t)?now:t),0);\n        }\n        inline void access(int x)\n        {\n            for (int y=0;x;x=fa(y=x)) splay(x),rc(x)=y,pushup(x);\n        }\n        inline void makeroot(CI now)\n        {\n            access(now); splay(now); rever(now);\n        }\n        inline int findroot(int now)\n        {\n            for (access(now),splay(now);lc(now);now=lc(now)) pushdown(now); return splay(now),now;\n        }\n        inline void split(CI x,CI y)\n        {\n            makeroot(x); access(y); splay(y);\n        }\n    public:\n        inline void build(void)\n        {\n            for (RI i=1;i<=n;++i) for (RI j=0;j<RG;++j) S(i,j)=(val[i]>>j)&1;\n        }\n        inline void link(CI x,CI y)\n        {\n            makeroot(x); if (findroot(y)!=x) fa(x)=y;\n        }\n        inline void cut(CI x,CI y)\n        {\n            makeroot(x); if (findroot(y)==x&&fa(y)==x&&!lc(y)) rc(x)=fa(y)=0; pushup(x);\n        }\n        inline void modify_xor(CI x,CI y,CI z)\n        {\n            split(x,y); upt(y,z);\n        }\n        inline int query_and(CI x,CI y,int ret=0)\n        {\n            split(x,y); for (RI i=0;i<RG;++i)\n            if (S(y,i)==SZ(y)) ret|=1<<i; return ret;\n        }\n        inline int query_or(CI x,CI y,int ret=0)\n        {\n            split(x,y); for (RI i=0;i<RG;++i)\n            if (S(y,i)) ret|=1<<i; return ret;\n        }\n        inline int query_xor(CI x,CI y,int ret=0)\n        {\n            split(x,y); for (RI i=0;i<RG;++i)\n            if (S(y,i)&1) ret|=1<<i; return ret;\n        }\n        inline LL query_sum(CI x,CI y,LL ret=0)\n        {\n            split(x,y); for (RI i=0;i<RG;++i)\n            ret+=1LL*(1<<i)*S(y,i); return ret;\n        }\n        #undef lc\n        #undef rc\n        #undef fa\n        #undef S\n        #undef SZ\n        #undef R\n        #undef T\n}LCT;\nint main()\n{\n    //freopen(\"CODE.in\",\"r\",stdin); freopen(\"CODE.out\",\"w\",stdout);\n    RI i; for (F.read(n),F.read(m),i=1;i<=n;++i) F.read(val[i]);\n    for (LCT.build(),i=1;i<=m;++i)\n    {\n        F.get_alpha(opt); F.read(x); F.read(y);\n        switch (opt)\n        {\n            case 'L':\n                LCT.link(x,y); break;\n            case 'C':\n                LCT.cut(x,y); break;\n            case 'U':\n                F.read(z); LCT.modify_xor(x,y,z); break;\n            case 'A':\n                F.write(LCT.query_and(x,y)); break;\n            case 'O':\n                F.write(LCT.query_or(x,y)); break;\n            case 'X':\n                F.write(LCT.query_xor(x,y)); break;\n            case 'S':\n                F.write(LCT.query_sum(x,y)); break;\n        }\n    }\n    return F.Fend(),0;\n}\n```",
        "postTime": 1557138957,
        "uid": 41698,
        "name": "hl666",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P5352 \u3010Terrible Homework\u3011"
    }
]