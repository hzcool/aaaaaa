[
    {
        "content": "\u524d\u7f6e\u829d\u58eb\uff1a[P4719](https://www.luogu.com.cn/problem/P4719)\n\n~~\u4f17\u6240\u5468\u77e5\uff0c\u51fa\u9898\u4eba\u4e3a\u4e86\u5361\u79bb\u7ebf\u7b97\u6cd5\u548c $ O(n\\log^2n) $ \u7684\u6811\u5256\u51fa\u4e86\u8fd9\u9898\u3002~~\n\n\u770b\u5230\u73b0\u5728\u7684\u9898\u89e3\u91cc\u9762\u6ca1\u6709\u4e00\u4e2a\u662f\u6811\u5256\u7684 $ O(2^3\\times n\\log^2n) $ \u505a\u6cd5\uff0c\u90a3\u4e48\u6211\u5c31\u6765\u5199\u4e00\u7bc7\u9898\u89e3\u6559\u5927\u5bb6\u5982\u4f55\u5361\u5e38\u5427\u3002\n\n\u9996\u5148\u6211\u628a\u6211\u7684 P4719 \u4ee3\u7801\u8d34\u4e0a\u6765\u3002\n\n```\n#include<cstdio>\nnamespace something_useful\n{\n\tinline int max(int a,int b){ return a>b?a:b;}\n\tinline int read()\n\t{\n\t\tint s=0,w=1;char ch;\n\t\twhile((ch=getchar())>'9'||ch<'0') if(ch=='-') w=-1;\n\t\twhile(ch>='0'&&ch<='9') s=s*10+ch-'0',ch=getchar();\n\t\treturn s*w;\n\t}\n\tstruct line\n\t{\n\t\tint nx;\n\t\tint to;\n\t};\n\tstruct graph\n\t{\n\t\tint head[100001];\n\t\tline a[200001];\n\t\tint tot;\n\t\tvoid ad(int u,int v)\n\t\t{\n\t\t\ttot++;\n\t\t\ta[tot].to=v;\n\t\t\ta[tot].nx=head[u];\n\t\t\thead[u]=tot;\n\t\t}\n\t\tvoid add(int u,int v){ ad(u,v),ad(v,u);}\n\t\tint st(int num){ return head[num];}\n\t\tint to(int num){ return a[num].to;}\n\t\tint nx(int num){ return a[num].nx;}\n\t};\n\tstruct mat\n\t{\n\t\tint a[3][3];\n\t\tint m,n;\n\t\tmat (){ a[1][1]=a[1][2]=a[2][1]=a[2][2]=0;}\n\t\tmat (int mm,int nn){ m=mm,n=nn,mat();}\n\t\tmat operator * (mat b)\n\t\t{\n\t\t\tmat ans;\n\t\t\tfor(int i=1;i<=2;i++)\n\t\t\t\tfor(int k=1;k<=2;k++)\n\t\t\t\t{\n\t\t\t\t\tint s=a[i][k];\n\t\t\t\t\tfor(int j=1;j<=2;j++)\n\t\t\t\t\t\tans.a[i][j]=max(ans.a[i][j],s+b.a[k][j]);\n\t\t\t\t}\n\t\t\treturn ans;\n\t\t}\n\t\tvoid operator = (mat b)\n\t\t{\n\t\t\tfor(int i=1;i<=2;i++)\n\t\t\t\tfor(int j=1;j<=2;j++)\n\t\t\t\t\ta[i][j]=b.a[i][j];\n\t\t}\n\t};\n}\nusing namespace something_useful;\nint f[100001][2];\nint hson[100001];\nint siz[100001];\nint dfn[100001];\nint top[100001];\nint end[100001];\nint rk[100001];\nint fa[100001];\nmat t[400001];\nmat g[100001];\nint a[100001];\ngraph in;\nint tot;\nint n,m;\nvoid read_all()\n{\n\tn=read(),m=read();\n\tfor(int i=1;i<=n;i++) a[i]=read();\n\tfor(int i=1;i<n;i++) in.add(read(),read());\n}\nvoid dfs(int num)\n{\n\tsiz[num]=1;f[num][1]=a[num];\n\tfor(int i=in.st(num);i;i=in.nx(i))\n\t{\n\t\tint p=in.to(i);\n\t\tif(p==fa[num]) continue;\n\t\tfa[p]=num;dfs(p);\n\t\tsiz[num]+=siz[p];\n\t\tif(siz[p]>siz[hson[num]]) hson[num]=p;\n\t\tf[num][1]+=f[p][0],f[num][0]+=max(f[p][1],f[p][0]);\n\t}\n}\nvoid dfs(int num,int t)\n{\n\ttop[num]=t;\n\tdfn[num]=++tot;\n\trk[tot]=num;\n\tend[t]=tot;\n\tif(hson[num]) dfs(hson[num],t);\n\tg[num].a[2][2]=-0x3f3f3f3f;g[num].a[2][1]=a[num];\n\tfor(int i=in.st(num);i;i=in.nx(i))\n\t{\n\t\tint p=in.to(i);\n\t\tif(p==fa[num]||p==hson[num]) continue;\n\t\tdfs(p,p);\n\t\tg[num].a[1][1]+=max(f[p][0],f[p][1]);\n\t\tg[num].a[2][1]+=f[p][0];\n\t}\n\tg[num].a[1][2]=g[num].a[1][1];\n}\nvoid push_up(int p){ t[p]=t[p*2]*t[p*2|1];}\nvoid build(int p,int pl,int pr)\n{\n\tif(pl==pr)\n\t{\n\t\tt[p]=g[rk[pl]];\n\t\treturn ;\n\t}\n\tint mid=(pl+pr)>>1;\n\tbuild(p*2,pl,mid);\n\tbuild(p*2|1,mid+1,pr);\n\tpush_up(p);\n}\nvoid init()\n{\n\tdfs(1);dfs(1,1);\n\tbuild(1,1,n);\n}\nmat get(int p,int pl,int pr,int l,int r)\n{\n\tif(l<=pl&&pr<=r) return t[p];\n\tint mid=(pl+pr)>>1;\n\tif(mid<l) return get(p*2|1,mid+1,pr,l,r);\n\tif(r<=mid) return get(p*2,pl,mid,l,r);\n\treturn get(p*2,pl,mid,l,r)*get(p*2|1,mid+1,pr,l,r);\n}\nvoid change(int p,int pl,int pr,int x)\n{\n\tif(pl==pr){ t[p]=g[rk[x]];return ;}\n\tint mid=(pl+pr)>>1;\n\tif(x<=mid) change(p*2,pl,mid,x);\n\telse change(p*2|1,mid+1,pr,x);\n\tpush_up(p);\n}\nvoid update(int pos,int val)\n{\n\tg[pos].a[2][1]+=val-a[pos];\n\ta[pos]=val;\n\twhile(pos)\n\t{\n\t\tmat last=get(1,1,n,dfn[top[pos]],end[top[pos]]);\n\t\tchange(1,1,n,dfn[pos]);\n\t\tmat now=get(1,1,n,dfn[top[pos]],end[top[pos]]);\n\t\tpos=fa[top[pos]];\n\t\tg[pos].a[1][1]+=max(now.a[1][1],now.a[2][1])-max(last.a[1][1],last.a[2][1]);\n\t\tg[pos].a[1][2]=g[pos].a[1][1];\n\t\tg[pos].a[2][1]+=now.a[1][1]-last.a[1][1];\n\t}\n}\nvoid run()\n{\n\tint pos=read(),val=read();\n\tupdate(pos,val);\n\tmat ans=get(1,1,n,1,end[1]);\n\tprintf(\"%d\\n\",max(ans.a[1][1],ans.a[2][1]));\n}\nint main()\n{\n\tread_all();\n\tinit();\n\tfor(int i=1;i<=m;i++) run();\n\treturn 0;\n}\n```\n\n\u524d\u9762\u7684\u90a3\u4e2a namespace \u662f\u6211\u7684\u94fe\u5f0f\u524d\u5411\u661f\u6a21\u677f\u548c\u5feb\u8bfb\uff0c\u5927\u5bb6\u53ef\u4ee5\u4e0d\u7528\u7ba1\u5b83\u3002\n\n\u4e0b\u9762\u6211\u4eec\u6765\u770b\u54ea\u91cc\u9700\u8981\u66f4\u6539\u3002\n\n\u7b2c\u4e00\u6b65\uff1a\u6570\u7ec4\u5927\u5c0f\n\n\u539f\u9898\u7684\u6570\u636e\u8303\u56f4\u662f $ n\\le 10^5 $\uff0c\u73b0\u5728\u88ab\u6539\u6210\u4e86 $ n\\le 10^6 $\uff0c\u5bf9\u5e94\u7684\uff0c\u6211\u4eec\u7684\u6570\u7ec4\u5927\u5c0f\u4e5f\u8981\u5f00\u5927\u5341\u500d\u3002\n\n\u6ce8\u610f\uff1a\u4e0d\u8981\u5fd8\u4e86\u7ebf\u6bb5\u6811\u7684\u5927\u5c0f\u8981\u5f00\u5230 $ 4\\times 10^6 $\u3002\n\n\u7b2c\u4e8c\u6b65\uff1a\u5f3a\u5236\u5728\u7ebf\n\n\u6ce8\u610f\u5230\u8fd9\u4e00\u9898\u662f\u5f3a\u5236\u5728\u7ebf\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u5728\u8bfb\u5165\u8282\u70b9\u7f16\u53f7\u7684\u65f6\u5019\u8981\u5f02\u6216\u4e0a\u4e00\u6b21\u7684\u7b54\u6848\u3002\n\n\u6ce8\u610f\uff1a\n1.  \u53ea\u6709\u8282\u70b9\u7f16\u53f7\u8981\u5f02\u6216\uff0c\u4fee\u6539\u7684\u503c\u662f\u4e0d\u7528\u7684\uff1b\n\n2.  \u522b\u5fd8\u4e86\u7ed9 $ lastans $ \u8d4b\u521d\u503c\u4ee5\u53ca\u6bcf\u6b21\u7b97\u5b8c\u7b54\u6848\u8981\u8d4b\u503c\u3002\n\n\u81f3\u6b64\uff0c\u6211\u4eec\u7684\u4fee\u6539\u90e8\u5206\u5b8c\u6210\u4e86\u3002\n\n\u63d0\u4ea4\u4e4b\u540e\uff0c\u4f60\u6709\u53ef\u80fd\u4f1a\u53d1\u73b0 TLE \u4e86\uff08\u6211\u6302\u4e86\u4e00\u4e2a\u70b9\uff09\u6216\u8005\u662f MLE\u3002\n\n\u5f53\u7136\uff0c\u5230\u8fd9\u91cc\u5927\u5bb6\u53ef\u4ee5\u9009\u62e9\u7b2c\u5341\u4e2a\u70b9\u66b4\u529b\u76f4\u63a5 A \u9898\uff0c\u4f46\u662f\u672c\u7740\u5b66\u4e60\u65b0\u6280\u5de7\u800c\u4e0d\u662f A \u9898\u7684\u6001\u5ea6\uff0c\u6211\u4eec\u5f00\u59cb\u5361\u5e38\u3002\n\n\u56e0\u4e3a\u6bd4\u8f83\u7b80\u5355\uff0c\u6240\u4ee5\u5148\u8bb2\u4e00\u4e0b MLE \u7684\u89e3\u51b3\u65b9\u6848\u3002\n\n\u7b2c\u4e00\u6b65\uff1a\u77e9\u9635\u6570\u7ec4\n\n\u672c\u9898\u7684\u77e9\u9635\u662f $ 2\\times2 $ \u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ea\u9700\u8981\u628a\u6570\u7ec4\u5927\u5c0f\u6539\u6210\u7c7b\u4f3c\u4e8e `a[2][2]` \u5c31\u53ef\u4ee5\u4e86\uff0c\u8fd9\u6837\u5b50\u4e0e\u539f\u6765\u7684 `a[3][3]` \u5bf9\u6bd4\uff0c\u77e9\u9635\u7684\u7a7a\u95f4\u4f1a\u5c0f\u5230\u539f\u6765\u7684\u4e00\u534a\u3002\n\n\u7b2c\u4e8c\u6b65\uff1a\u5b58\u56fe\n\n\u4e0d\u77e5\u9053\u6709\u591a\u5c11\u5c0f\u4f19\u4f34\u7528\u7684\u662f vector\uff0c\u5982\u679c\u8fd8\u662f MLE\uff0c\u53ef\u4ee5\u8003\u8651\u6539\u6210\u94fe\u5f0f\u524d\u5411\u661f\uff0c\u8282\u7701\u7a7a\u95f4\u3002\n\n\u6ce8\u610f\uff1a\u5982\u679c\u4f60\u7b97\u8fc7\u4e86\u4f60\u7684\u7a7a\u95f4\u786e\u5b9e\u4e0d\u4f1a\u70b8\uff0c\u800c\u4e14\u57fa\u672c\u6ca1\u6709\u70b9 AC\uff0c\u90a3\u4e48**\u5927\u6982\u7387**\u662f\u5199\u6302\u4e86\uff0c\u5efa\u8bae\u770b\u4e00\u773c\u6709\u6ca1\u6709\u65e0\u9650\u9012\u5f52\u3002\n\n\u5148\u6765\u6211\u4eec\u6765\u8bb2 TLE \u89e3\u51b3\u65b9\u6848\u3002\n\n\u7b2c\u4e00\u6b65\uff1a\u8bfb\u5165\n\n\u4f7f\u7528\u5feb\u8bfb\u53ef\u4ee5\u51cf\u5c11\u65f6\u95f4\u590d\u6742\u5ea6\uff0c\u5927\u5bb6\u5e94\u8be5\u90fd\u4f1a\uff0c\u8fd9\u91cc\u4e0d\u7ec6\u8bf4\u3002\n\n\u7b2c\u4e8c\u6b65\uff1a\u77e9\u9635\u4e58\u6cd5\n\n\u672c\u9898\u7684\u77e9\u9635\u662f $ 2\\times2 $ \u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4e0d\u4f7f\u7528\u5faa\u73af\uff0c\u76f4\u63a5\u5c06\u77e9\u9635\u4e58\u6cd5\u5c55\u5f00\uff0c\u4ee3\u7801\u653e\u5230\u4e0b\u9762\uff1a\n\n```\nmat operator * (mat b)\n{\n\tmat ans;\n\tans.a[0][0]=max(a[0][0]+b.a[0][0],a[0][1]+b.a[1][0]);\n\tans.a[1][0]=max(a[1][0]+b.a[0][0],a[1][1]+b.a[1][0]);\n\tans.a[0][1]=max(a[0][0]+b.a[0][1],a[0][1]+b.a[1][1]);\n\tans.a[1][1]=max(a[1][0]+b.a[0][1],a[1][1]+b.a[1][1]);\n\treturn ans;\n}\n```\n\n\u7b2c\u4e09\u6b65\uff1a\u7ebf\u6bb5\u6811\n\n\u8fd9\u662f\u5361\u5e38\u5361\u7684\u6700\u591a\u7684\u4e00\u90e8\u5206\u3002\n\n\u4f7f\u7528\u6811\u5256\u7684\u65f6\u5019\uff0c\u65f6\u95f4\u590d\u6742\u5ea6\u7684\u74f6\u9888\u5728\u4e8e\u5bf9\u67d0\u4e2a\u70b9\u6743\u503c\u4fee\u6539\u7684\u90e8\u5206\uff0c\u73b0\u5728\u6211\u4eec\u5bf9\u8fd9\u90e8\u5206\u8fdb\u884c\u5361\u5e38\u3002\n\n\u53ef\u4ee5\u53d1\u73b0\uff0c\u6211\u4eec\u5728\u67e5\u8be2\u7ebf\u6bb5\u6811\u7684\u65f6\u5019\u6bcf\u6b21\u53ea\u4f1a\u67e5\u627e\u4e00\u4e2a\u91cd\u94fe\u7684\u77e9\u9635\u4e4b\u79ef\uff0c\u8003\u8651\u5bf9\u6bcf\u4e00\u4e2a\u91cd\u94fe\u5355\u72ec\u5f00\u4e00\u4e2a\u7ebf\u6bb5\u6811\uff0c\u4ee5\u51cf\u5c11\u5e38\u6570\u3002\n\n\u6709\u4eba\u53ef\u80fd\u4f1a\u95ee\uff1a\u4f60\u8fd9\u4e0d\u5c31\u662f\u4e00\u4e2a\u6c34\u5230\u6781\u81f4\uff0c\u57fa\u672c\u6ca1\u7528\u7684\u5e38\u6570\u4f18\u5316\u5417\uff0c\u7ed9\u4f60\u4e00\u6761\u94fe\u4e0d\u5c31\u76f8\u5f53\u4e8e\u5565\u90fd\u6ca1\u6709\u3002\n\n\u771f\u7684\u662f\u8fd9\u6837\u5417\uff1f\u6211\u4eec\u6765\u770b\u4e00\u773c\u53d8\u5316\u3002\n\n\u539f\u6765\u7684\u4ee3\u7801\uff1a\n\n```\nvoid update(int pos,int val)\n{\n\tg[pos].a[2][1]+=val-a[pos];\n\ta[pos]=val;\n\twhile(pos)\n\t{\n\t\tmat last=get(1,1,n,dfn[top[pos]],end[top[pos]]);\n\t\tchange(1,1,n,dfn[pos]);\n\t\tmat now=get(1,1,n,dfn[top[pos]],end[top[pos]]);\n\t\tpos=fa[top[pos]];\n\t\tg[pos].a[1][1]+=max(now.a[1][1],now.a[2][1])-max(last.a[1][1],last.a[2][1]);\n\t\tg[pos].a[1][2]=g[pos].a[1][1];\n\t\tg[pos].a[2][1]+=now.a[1][1]-last.a[1][1];\n\t}\n}\n```\n\n\u66f4\u6539\u8fc7\u540e\u7684\u4ee3\u7801\uff1a\n\n```\nvoid update(int pos,int val)\n{\n\tg[pos].a[1][0]+=val-a[pos];\n\ta[pos]=val;\n\twhile(pos)\n\t{\n\t\tmat last=t[root[top[pos]]];\n\t\tchange(root[top[pos]],dfn[top[pos]],end[top[pos]],dfn[pos]);\n\t\tmat now=t[root[top[pos]]];\n\t\tpos=fa[top[pos]];\n\t\tg[pos].a[0][0]+=max(now.a[0][0],now.a[1][0])-max(last.a[0][0],last.a[1][0]);\n\t\tg[pos].a[0][1]=g[pos].a[0][0];\n\t\tg[pos].a[1][0]+=now.a[0][0]-last.a[0][0];\n\t}\n}\n```\n\n\u6ce8\u610f\u4e00\u4e0b\uff1a\u4f60\u53ef\u80fd\u4f1a\u53d1\u73b0\u4fee\u6539\u7684\u65f6\u5019\u77e9\u9635\u7684\u4f4d\u7f6e\u4e0d\u4e00\u6837\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u539f\u6765 MLE \u8fc7\uff0c\u7136\u540e\u628a\u77e9\u9635\u4ece $ 3\\times 3 $ \u6539\u6210 $ 2\\times 2 $ \u4e86\u3002\n\n\u6709\u4ec0\u4e48\u53d8\u5316\u5462\uff1f\n\n\u6ca1\u9519\uff01\u5faa\u73af\u4e2d\u5c11\u4e86\u4e24\u6b21\u51fd\u6570\u7684\u8c03\u7528\uff01\n\n\u81f3\u6b64\uff0c\u6211\u4eec\u7684\u6811\u5256\u5df2\u7ecf\u53ef\u4ee5\u901a\u8fc7\u8fd9\u9053\u9898\u3002\n\n\u6700\u540e\uff0c\u7ed9\u5927\u5bb6\u653e\u4e0a\u5b8c\u6574\u4ee3\u7801\uff1a\n\n```\n#include<cstdio>\nnamespace something_useful\n{\n\tinline int max(int a,int b){ return a>b?a:b;}\n\tinline int read()\n\t{\n\t\tint s=0,w=1;char ch;\n\t\twhile((ch=getchar())>'9'||ch<'0') if(ch=='-') w=-1;\n\t\twhile(ch>='0'&&ch<='9') s=s*10+(ch^48),ch=getchar();\n\t\treturn s*w;\n\t}\n\tstruct line\n\t{\n\t\tint nx;\n\t\tint to;\n\t};\n\tstruct graph\n\t{\n\t\tint head[1000001];\n\t\tline a[2000000];\n\t\tint tot;\n\t\tvoid ad(int u,int v)\n\t\t{\n\t\t\ttot++;\n\t\t\ta[tot].to=v;\n\t\t\ta[tot].nx=head[u];\n\t\t\thead[u]=tot;\n\t\t}\n\t\tvoid add(int u,int v){ ad(u,v),ad(v,u);}\n\t\tint st(int num){ return head[num];}\n\t\tint to(int num){ return a[num].to;}\n\t\tint nx(int num){ return a[num].nx;}\n\t};\n\tstruct mat\n\t{\n\t\tint a[2][2];\n\t\tmat operator * (mat b)\n\t\t{\n\t\t\tmat ans;\n\t\t\tans.a[0][0]=max(a[0][0]+b.a[0][0],a[0][1]+b.a[1][0]);\n\t\t\tans.a[1][0]=max(a[1][0]+b.a[0][0],a[1][1]+b.a[1][0]);\n\t\t\tans.a[0][1]=max(a[0][0]+b.a[0][1],a[0][1]+b.a[1][1]);\n\t\t\tans.a[1][1]=max(a[1][0]+b.a[0][1],a[1][1]+b.a[1][1]);\n\t\t\treturn ans;\n\t\t}\n\t};\n}\nusing namespace something_useful;\nint f[1000001][2];\nint hson[1000001];\nint root[1000001];\nint siz[1000001];\nint dfn[1000001];\nint top[1000001];\nint end[1000001];\nint rk[1000001];\nint fa[1000001];\nint ls[4000001];\nint rs[4000001];\nmat t[4000001];\nmat g[1000001];\nint a[1000001];\ngraph in;\nint last;\nint tot;\nint n,m;\nint nod;\nvoid read_all()\n{\n\tn=read(),m=read();\n\tfor(int i=1;i<=n;i++) a[i]=read();\n\tfor(int i=1;i<n;i++) in.add(read(),read());\n}\nvoid dfs(int num)\n{\n\tsiz[num]=1;f[num][1]=a[num];\n\tfor(int i=in.st(num);i;i=in.nx(i))\n\t{\n\t\tint p=in.to(i);\n        if(p==fa[num]) continue;\n    \tfa[p]=num;dfs(p);\n    \tsiz[num]+=siz[p];\n    \tif(siz[p]>siz[hson[num]]) hson[num]=p;\n    \tf[num][1]+=f[p][0],f[num][0]+=max(f[p][1],f[p][0]);\n\t}\n}\nvoid dfs(int num,int t)\n{\n\ttop[num]=t;\n\tdfn[num]=++tot;\n\trk[tot]=num;\n\tend[t]=tot;\n\tif(hson[num]) dfs(hson[num],t);\n\tg[num].a[1][1]=-0x3f3f3f3f;g[num].a[1][0]=a[num];\n\tfor(int i=in.st(num);i;i=in.nx(i))\n\t{\n\t\tint p=in.to(i);\n        if(p==fa[num]||p==hson[num]) continue;\n    \tdfs(p,p);\n    \tg[num].a[0][0]+=max(f[p][0],f[p][1]);\n    \tg[num].a[1][0]+=f[p][0];\n\t}\n\tg[num].a[0][1]=g[num].a[0][0];\n}\nvoid push_up(int p){ t[p]=t[ls[p]]*t[rs[p]];}\nvoid build(int &p,int pl,int pr)\n{\n\tp=++nod;\n\tif(pl==pr)\n\t{\n\t\tt[p]=g[rk[pl]];\n\t\treturn ;\n\t}\n\tint mid=(pl+pr)>>1;\n\tbuild(ls[p],pl,mid);\n\tbuild(rs[p],mid+1,pr);\n\tpush_up(p);\n}\nvoid init()\n{\n\tdfs(1);dfs(1,1);\n\tfor(int i=1;i<=n;i++) if(top[i]==i) build(root[i],dfn[i],end[i]);\n}\nmat get(int p,int pl,int pr,int l,int r)\n{\n\tif(l<=pl&&pr<=r) return t[p];\n\tint mid=(pl+pr)>>1;\n\tif(mid<l) return get(rs[p],mid+1,pr,l,r);\n\tif(r<=mid) return get(ls[p],pl,mid,l,r);\n\treturn get(ls[p],pl,mid,l,r)*get(rs[p],mid+1,pr,l,r);\n}\nvoid change(int p,int pl,int pr,int x)\n{\n\tif(pl==pr){ t[p]=g[rk[x]];return ;}\n\tint mid=(pl+pr)>>1;\n\tif(x<=mid) change(ls[p],pl,mid,x);\n\telse change(rs[p],mid+1,pr,x);\n\tpush_up(p);\n}\nvoid update(int pos,int val)\n{\n\tg[pos].a[1][0]+=val-a[pos];\n\ta[pos]=val;\n\twhile(pos)\n\t{\n\t\tmat last=t[root[top[pos]]];\n\t\tchange(root[top[pos]],dfn[top[pos]],end[top[pos]],dfn[pos]);\n\t\tmat now=t[root[top[pos]]];\n\t\tpos=fa[top[pos]];\n\t\tg[pos].a[0][0]+=max(now.a[0][0],now.a[1][0])-max(last.a[0][0],last.a[1][0]);\n\t\tg[pos].a[0][1]=g[pos].a[0][0];\n\t\tg[pos].a[1][0]+=now.a[0][0]-last.a[0][0];\n\t}\n}\nvoid run()\n{\n\tint pos=read()^last,val=read();\n\tupdate(pos,val);\n\tmat ans=t[root[1]];\n\tprintf(\"%d\\n\",last=max(ans.a[0][0],ans.a[1][0]));\n}\nint main()\n{\n\tread_all();\n\tinit();\n\tfor(int i=1;i<=m;i++) run();\n\treturn 0;\n}\n```\n\n\u611f\u8c22\u89c2\u770b\uff01",
        "postTime": 1642234665,
        "uid": 400201,
        "name": "Wuyanru",
        "ccfLevel": 7,
        "title": "P4751\u9898\u89e3"
    },
    {
        "content": "\u4f60\u4eec\u53ef\u4ee5\u770b\u770b\u8fd9\u4e2a[\u5b9d\u8d1d](https://www.cnblogs.com/RabbitHu/p/9112811.html)\u6765\u4e86\u89e3\u4e00\u4e0b\u8fd9\u4e2a\u8be1\u5f02\u7684\u505a\u6cd5\u3002\n\n\u9996\u5148\uff0c\u9700\u8981\u524d\u7f6e\u6280\u80fd[\u52a8\u6001dp](https://www.luogu.org/problemnew/show/P4719)\uff0c\u7136\u540e\u624d\u80fd\u591f\u505a\u8fd9\u9053\u9898\u3002\n\n\u5f88\u660e\u663e\uff0c\u5229\u7528\u6811\u5256\u5957\u7ebf\u6bb5\u6811\u76f4\u63a5\u7ef4\u62a4\u77e9\u9635\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u662f$O(2^3qlog^2n)$\u7684\u3002\u518d\u6570\u636e\u6076\u610f\u5361\u7684\u60c5\u51b5\u4e0b\uff0c\u8ba1\u7b97\u51fa\u6765\u7684\u590d\u6742\u5ea6\u9ad8\u8fbe$1e9$\u7ea7\uff0c\u518d\u7b97\u4e0a\u7ebf\u6bb5\u6811\u7684\u5de8\u5927\u5e38\u6570\uff0c\u57fa\u672c\u4e0a\u76f4\u63a5\u5c31$TLE$\u4e86\u3002\u8fd9\u65f6\uff0c\u6211\u4eec\u9700\u8981\u4e00\u79cd\u66f4\u9760\u8c31\u7684\u590d\u6742\u5ea6\u6765\u7ef4\u62a4\u3002\n\n\u6839\u636e\u7ecf\u9a8c\uff0c\u5728\u7ef4\u62a4\u5185\u5bb9\u7b80\u5355\u7684\u60c5\u51b5\u4e0b\uff0c\u5982\u679c\u67d0\u4e2a\u4fe1\u606f\u53ef\u4ee5\u7528$splay$\u505a\u5230\u548c\u7ebf\u6bb5\u6811\u540c\u7ea7\u7684\u7ef4\u62a4\uff0c\u90a3\u4e48\u5728$LCT$\u7684\u610f\u4e49\u4e0b\uff0c\u662f\u53ef\u4ee5\u5c06\u4e24\u4e2a$log$\u4f18\u5316\u5230\u4e00\u4e2a$log$\u7684\u3002\n\n\u90a3\u4e48\u6211\u4eec\u7684\u57fa\u672c\u601d\u8def\u5c31\u51fa\u6765\u4e86:\u5c31\u662f\u4e0d\u4f7f\u7528\u6811\u5256\u5957\u7ebf\u6bb5\u6811\u6765\u7ef4\u62a4\u77e9\u9635\uff0c\u800c\u662f\u6539\u4e3a\u4f7f\u7528$LCT$\u6765\u7ef4\u62a4\u77e9\u9635\u3002\u8fd9\u6837\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u5c31\u7531$O(2^3q\\log^2 n)$\u4f18\u5316\u81f3$O(2^3q\\log n)$\u3002\n\n\u4e0d\u8fc7$LCT$\u7684\u5e38\u6570\u8fc7\u4e8e\u5de8\u5927\uff0c\u5e76\u4e14\u6811\u7684\u5f62\u6001\u56fa\u5b9a\uff0c\u6211\u4eec\u4e5f\u4e0d\u9700\u8981\u52a8\u6001\u6765\u7ef4\u62a4\u4e00\u68f5\u6811\u3002\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u4e0e$LCT$\u7c7b\u4f3c\u7684\u6570\u636e\u7ed3\u6784\u6765\u7ef4\u62a4\uff0c\u540c\u65f6\u4e5f\u4fdd\u8bc1\u5b83\u7684\u590d\u6742\u5ea6\u3002\n\n\u6211\u4eec\u91c7\u7528\u4e00\u68f5\u666e\u901a\u7684\u4e8c\u53c9\u641c\u7d22\u6811\u6765\u7ef4\u62a4\u8fd9\u4e2a\u7ed3\u6784\u3002\u5176\u7ed3\u6784\u4e0e$LCT$\u76f8\u4f3c\uff0c\u5b58\u5728\u8f7b\u8fb9\u548c\u91cd\u8fb9\u4e4b\u5206\uff0c\u4e14\u4e00\u6bb5\u91cd\u94fe\u7528\u76f8\u8fde\u7684\u4e00\u6bb5\u4e8c\u53c9\u641c\u7d22\u6811\u7ef4\u62a4\uff0c\u800c\u8f7b\u8fb9\u76f4\u63a5\u7528\u8f7b\u8fb9\u6302\u5728\u7236\u4eb2\u8282\u70b9\u4e0b\u3002\u8fd9\u6837\uff0c\u6211\u4eec\u53ea\u8981\u4fdd\u8bc1\u8fd9\u4e2a\u7ed3\u6784\u7684\u6df1\u5ea6\u4e0d\u8d85\u8fc7$O(\\log n)$\u7ea7\uff0c\u6211\u4eec\u7684\u590d\u6742\u5ea6\u5c31\u662f\u6b63\u786e\u7684\u3002\n\n\u8fd9\u65f6\u5c31\u6709\u4e00\u4e2a\u5f88\u7b80\u5355\u7684\u6784\u9020\u601d\u60f3\u4e86\u3002\u5148\u5c06\u6574\u68f5\u6811\u6811\u94fe\u5256\u5206(\u91cd\u94fe\u5256\u5206)\uff0c\u518d\u5bf9\u4e8e\u6bcf\u4e2a\u70b9\uff0c\u8bb0\u5f55\u8be5\u70b9\u7684\u8f7b\u5b50\u6811\u7684$size$\u4e4b\u548c+1\uff0c\u4f5c\u4e3a\u4ed6\u7684\u6743\u3002\u7136\u540e\u5bf9\u4e8e\u5f53\u524d\u91cd\u94fe\uff0c\u8bb0\u5f55\u5b83\u7684\u52a0\u6743\u91cd\u5fc3\uff0c\u4f5c\u4e3a\u8be5\u91cd\u94fe\u7684\u6839\uff0c\u7136\u540e\u5411\u4e24\u8fb9\u9012\u5f52\u5efa\u6811\u3002\u8f7b\u8fb9\u8fd8\u662f\u4e00\u6837\u6302\u5728\u5176\u7236\u4eb2\u4e0a\u3002\u8fd9\u6837\u53ef\u4ee5\u5c06\u6811\u9ad8\u4e25\u683c\u5361\u5728$O(\\log n)$\u5185\u3002\u8bc1\u660e\u975e\u5e38\u7b80\u5355\uff0c\u6bcf\u4e2a\u70b9\u7684\u7236\u4eb2\u5b50\u6811\u5927\u5c0f**\u81f3\u5c11\u662f\u5b83\u81ea\u5df1\u5b50\u6811\u5927\u5c0f\u76842\u500d**\u3002\u8fd9\u6837\u7ecf\u8fc7\u4e0d\u8d85\u8fc7$\\log n$\u6b21\u540e\uff0c\u5176\u5b50\u6811\u5927\u5c0f\u4f1a\u53d8\u6210$n$\u3002\n\n\u4ee3\u7801(\u4ec5\u4f9b\u53c2\u8003)\uff1a\n\n```cpp\n#include<bits/stdc++.h>\n#define Rep(i,a,b) for(register int i=(a);i<=(b);++i)\n#define Repe(i,a,b) for(register int i=(a);i>=(b);--i)\n#define pb push_back\n#define Chkmax(a,b) a=a>b?a:b\n#define Chkmin(a,b) a=a<b?a:b\n#define mx(a,b) (a>b?a:b)\ntypedef unsigned long long uint64;\ntypedef unsigned int uint32;\ntypedef long long ll;\nusing namespace std;\n\nnamespace IO\n{\n    const uint32 Buffsize=1<<15,Output=1<<24;\n    static char Ch[Buffsize],*St=Ch,*T=Ch;\n    inline char getc()\n    {\n        return((St==T)&&(T=(St=Ch)+fread(Ch,1,Buffsize,stdin),St==T)?0:*St++);\n    }\n    static char Out[Output],*nowps=Out;\n\n    inline void flush(){fwrite(Out,1,nowps-Out,stdout);nowps=Out;}\n    \n\n    template<typename T>inline void read(T&x)\n    {\n        x=0;static char ch;T f=1;\n        for(ch=getc();!isdigit(ch);ch=getc())if(ch=='-')f=-1;\n        for(;isdigit(ch);ch=getc())x=x*10+(ch^48);\n        x*=f;\n    }\n\n    template<typename T>inline void write(T x,char ch='\\n')\n    {\n        if(!x)*nowps++=48;\n        if(x<0)*nowps++='-',x=-x;\n        static uint32 sta[111],tp;\n        for(tp=0;x;x/=10)sta[++tp]=x%10;\n        for(;tp;*nowps++=sta[tp--]^48);\n        *nowps++=ch;\n    }\n}\nusing namespace IO;\n\ninline void file()\n{\n#ifndef ONLINE_JUDGE\n    freopen(\"Ddp++.in\",\"r\",stdin);\n    freopen(\"Ddp++.out\",\"w\",stdout);\n#endif\n}\n\nconst int inf=0x3f3f3f3f,MAXN=1e6+7;\n\nstruct matrix\n{\n    int s[2][2];\n    matrix(){s[0][0]=s[0][1]=s[1][0]=s[1][1]=-inf;}\n\n    matrix(int x){s[0][0]=s[1][1]=0;s[0][1]=s[1][0]=-inf;}\n\n    friend matrix operator*(matrix a,matrix b)\n    {\n        matrix c;\n        Chkmax(c.s[0][0],b.s[0][0]+a.s[0][0]);\n        Chkmax(c.s[0][0],b.s[0][1]+a.s[1][0]);\n        Chkmax(c.s[0][1],b.s[0][0]+a.s[0][1]);\n        Chkmax(c.s[0][1],b.s[0][1]+a.s[1][1]);\n        Chkmax(c.s[1][0],b.s[1][0]+a.s[0][0]);\n        Chkmax(c.s[1][0],b.s[1][1]+a.s[1][0]);\n        Chkmax(c.s[1][1],b.s[1][0]+a.s[0][1]);\n        Chkmax(c.s[1][1],b.s[1][1]+a.s[1][1]);\n        return c;\n    }\n\n    inline int getmx()\n    {return mx(mx(s[0][0],s[0][1]),mx(s[1][0],s[1][1]));}\n};\n\nstatic int n,m;\n\nstatic int sz[MAXN],son[MAXN],g[MAXN][2],w[MAXN];\n\nstatic struct edge\n{\n    int v,nxt;\n}p[MAXN<<1];\nstatic int head[MAXN],e;\n\ninline void add(int u,int v){p[++e]={v,head[u]};head[u]=e;}\n\nvoid dfs(int u)\n{\n    sz[u]=1;g[u][1]=w[u];\n    for(register int v=head[u];v;v=p[v].nxt)if(!sz[p[v].v])\n\n    {\n        dfs(p[v].v);sz[u]+=sz[p[v].v];\n        if(sz[p[v].v]>sz[son[u]])son[u]=p[v].v;\n        g[u][0]+=mx(g[p[v].v][0],g[p[v].v][1]);\n        g[u][1]+=g[p[v].v][0];\n    }\n}\n\nnamespace bst\n{\n    static matrix W[MAXN],S[MAXN];\n    static int so[MAXN][2],fa[MAXN],sta[MAXN],tp;\n    static int ssz[MAXN],rt;\n\n    inline void update(int u){S[u]=S[so[u][0]]*W[u]*S[so[u][1]];}\n\n    int build_tree(int l,int r)\n    {\n        if(l>r)return 0;\n        static int tot;tot=0;Rep(i,l,r)tot+=ssz[sta[i]];\n        for(register int i=l,cnt=ssz[sta[i]];i<=r;++i,cnt+=ssz[sta[i]])\n            if(cnt*2>=tot)\n            {\n                int rs=build_tree(l,i-1),ls=build_tree(i+1,r);\n                so[sta[i]][0]=ls,so[sta[i]][1]=rs;\n                fa[ls]=fa[rs]=sta[i];update(sta[i]);\n                return sta[i];\n            }\n    }\n\n    inline void getpoi(int u)\n    {W[u].s[0][0]=W[u].s[0][1]=**(g+u);W[u].s[1][0]=*(*(g+u)+1);}\n\n    int build(int top,int fr)\n    {\n        for(int t=top;t;fr=t,t=son[t])\n        {\n            for(register int v=head[t];v;v=p[v].nxt)\n                if(p[v].v^son[t]&&p[v].v^fr)\n                    fa[build(p[v].v,t)]=t;\n            getpoi(t);\n        }\n        tp=0;\n        for(int t=top;t;t=son[t])\n            sta[++tp]=t,ssz[t]=sz[t]-sz[son[t]];\n        return build_tree(1,tp);\n    }\n\n    bitset<MAXN>isr;\n\n    void modify(int u,int val)\n    {\n        g[u][1]+=val-w[u];\n        w[u]=val;\n        static int dp0[2],dp1[2];\n        for(;u;u=fa[u])\n        {\n            dp0[0]=mx(S[u].s[0][0],S[u].s[0][1]);\n            dp0[1]=mx(S[u].s[1][0],S[u].s[1][1]);\n            getpoi(u);update(u);\n            dp1[0]=mx(S[u].s[0][0],S[u].s[0][1]);\n            dp1[1]=mx(S[u].s[1][0],S[u].s[1][1]);\n            if(isr.test(u))\n            {\n                g[fa[u]][0]+=mx(dp1[0],dp1[1])-mx(dp0[0],dp0[1]);\n                g[fa[u]][1]+=dp1[0]-dp0[0];\n            }\n        }\n    }\n}\nvoid dfs(int u,int fr)\n{\n    if(!son[u])return;\n    g[u][0]-=mx(g[son[u]][0],g[son[u]][1]);\n    g[u][1]-=g[son[u]][0];\n    for(register int v=head[u];v;v=p[v].nxt)if(p[v].v^fr)dfs(p[v].v,u);\n}\nusing namespace bst;\n\ninline void init()\n{\n    read(n);read(m);\n    Rep(i,1,n)read(w[i]);\n    static int u,v;\n    Rep(i,1,n-1)read(u),read(v),add(u,v),add(v,u);\n    dfs(1);\n    dfs(1,0);\n    W[0]=S[0]=matrix(0);\n    rt=build(1,0);\n    Rep(i,1,n)if(i^so[fa[i]][0]&&i^so[fa[i]][1])isr.set(i);\n}\n\ninline void solve()\n{\n    static int lasans=0;\n    static int x,y;\n    Rep(i,1,m)\n    {\n        read(x);read(y);\n        x^=lasans;\n        modify(x,y);\n        write(lasans=S[rt].getmx());\n    }\n    flush();\n}\n\nint main()\n{\n    file();\n    init();\n    solve();\n    cerr<<1.0*clock()/CLOCKS_PER_SEC<<endl;\n    return 0;\n}\n```",
        "postTime": 1534082649,
        "uid": 7035,
        "name": "Great_Influence",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P4751 \u3010\u52a8\u6001dp\u3010\u52a0\u5f3a\u7248\u3011\u3011"
    },
    {
        "content": "## \u52a8\u6001 dp \u5165\u95e8\n\n\u7ed9\u9053\u5165\u95e8\u9898\u3002\n\n\u9898\u76ee\uff1aDTOJ #4579. Hello 2019\n\n\u4e00\u4e2a\u4e32\u662f\u597d\u7684\uff0c\u5f53\u4e14\u4ec5\u5f53\u5176\u5305\u542b\u5b50\u5e8f\u5217 $9102$ \u4e14\u4e0d\u5305\u542b\u5b50\u5e8f\u5217 $8102$. (\u5b50\u5e8f\u5217\u4e0d\u4e00\u5b9a\u8fde\u7eed)\n\n\u6709\u4e2a\u6570\u5b57\u4e32 $S$\uff0c\u6bcf\u6b21\u8be2\u95ee\u4e00\u4e2a\u533a\u95f4 $(l,r)$\uff0c\u6c42\u81f3\u5c11\u4ece\u4e32\u4e2d\u5220\u6389\u591a\u5c11\u4e2a\u5b57\u7b26\uff0c\u65b9\u80fd\u4f7f\u5b50\u4e32 $S(l,r)$ \u662f\u597d\u7684\u3002\n\n$|S| \\le 2\\times 10^5$ | $q\\le 2\\times 10^5$\u3002\n\n\u9898\u89e3\uff1a\u9996\u5148 reverse\uff0c\u7136\u540e\u8bb0\u4e00\u4e2a $f_{i,0/1/2/3/4}$\uff0c\u8868\u793a\u6070\u597d\u5339\u914d $0/1/2/3/4$ \u4e2a\u8981\u5220\u51e0\u4e2a\u5b57\u7b26\uff0c\u7136\u540e\u7528 $5\\times 5$ \u7684\u77e9\u9635\u8f6c\u79fb\uff0c\u6bcf\u6b21\u628a $[l,r]$ \u5185\u7684\u77e9\u9635\u4e58\u8d77\u6765\u3002\u8be6\u7ec6\u7684\u5efa\u8bae\u81ea\u5df1\u63a8\u3002\n\n## \u52a8\u6001\u6811\u5206\u6cbb\u5165\u95e8\n\n\u9898\u76ee\uff1a\u6d1b\u8c37 P4719 \u3010\u6a21\u677f\u3011\"\u52a8\u6001 DP\"&\u52a8\u6001\u6811\u5206\u6cbb\n\n\u5148\u5199\u51fa\u4e00\u822c\u6700\u5927\u6743\u72ec\u7acb\u96c6\u5f0f\u5b50\uff1a\n$$\n\\begin{aligned}\nf_{u,0} =& \\sum_{v}\\max(f_{v,0}, f_{v,1})\\\\\nf_{u,1} =& w_u+\\sum_{v} f_{v,0}\n\\end{aligned}\n$$\n\u5176\u4e2d $f_{u,0/1}$ \u8868\u793a $u$ \u4e0d\u9009/\u9009\u7684\u7b54\u6848\u3002\n\n\u7136\u540e\u5bf9\u4e8e\u6574\u68f5\u6811\u8fdb\u884c\u6811\u5256\uff0c\u5206\u5f00\u8bb0\u91cd\u513f\u5b50\u548c\u8f7b\u513f\u5b50\u7684\u7b54\u6848\u3002\n\n$g_{u,0}$\uff1a$u$ \u7684\u6240\u6709\u8f7b\u513f\u5b50\u5168\u4e0d\u9009\u7684\u603b\u548c\u52a0\u4e0a $w_u$\u3002\n\n$g_{u,1}$\uff1a$u$ \u7684\u6240\u6709\u8f7b\u513f\u5b50\u9009\u6216\u4e0d\u9009\u7684\u6700\u5927\u503c\u603b\u548c\u3002\n\n$f_{u,0}$\uff1a$u$ \u4e0d\u9009\u7684\u7b54\u6848\u3002\n\n$f_{u,1}$\uff1a$u$ \u9009\u6216\u4e0d\u9009\u7684\u7b54\u6848\u3002\n\n\u8bb0 $v$ \u4e3a\u91cd\u513f\u5b50\uff0c\u6709\uff1a\n$$\n\\begin{aligned}\nf_{u,0} =& f_{v,1} + g_{u, 1}\\\\\nf_{u,1} =& \\max(f_{v,1} + g_{u, 1}, f_{v,0} + g_{u,0})\n\\end{aligned}\n$$\n\u7136\u540e\u53ef\u4ee5\u628a $f_u$\u3001$g_u$ \u548c $f_v$ \u5199\u6210\u77e9\u9635\uff0c\u8981\u70b9\u662f $f_u$ \u548c $f_v$ \u957f\u5f97\u4e00\u6837\uff0c$g_u$ \u53ea\u548c $u$ \u6709\u5173\uff1a\n$$\n\\begin{bmatrix}\nf_{u, 0} & f_{u, 1}\n\\end{bmatrix}\n=\n\\begin{bmatrix}\nf_{v, 0} & f_{v,1}\n\\end{bmatrix}\n\\times\n\\begin{bmatrix}\n-\\infty & g_{u,0}\\\\\ng_{u, 1} & g_{u,1}\n\\end{bmatrix}\n$$\n\u5f53\u7136\u8fd9\u91cc\u77e9\u9635\u4e58\u6cd5\u7684\u5b9a\u4e49\u662f $(+, \\max)$\u3002\n\n\u8fd9\u6837\u4e00\u4e2a**\u8282\u70b9**\u5230**\u91cd\u94fe\u9876\u7aef**\u7684\u7b54\u6848\u5c31\u662f $\\begin{bmatrix}0 & 0\\end{bmatrix}$ \u548c\u8fd9\u6761\u94fe\u7684\u53f6\u7ed3\u70b9\u4ece\u5e95\u5230\u9876\u7684\u4e00\u5806\u77e9\u9635\u76f8\u4e58\u3002\n\n\u6b64\u65f6\u5982\u679c\u4fee\u6539\u4e00\u4e2a\u8282\u70b9\uff0c\u53ea\u9700\u6539\u7684\u5b83\u7684 $g_u$ \u77e9\u9635\u3002\n\n\u7136\u540e\u8dd1\u5230\u91cd\u94fe\u9876\u7aef\uff0c\u6c42\u51fa\u65b0\u77e9\u9635\uff0c\u5bf9\u94fe\u9876\u7236\u4eb2\u7684 $g_u$ \u4fee\u6539\u4e00\u4e0b\uff0c\u7136\u540e\u7ee7\u7eed\u8dd1\u3002\n\n\u5b9e\u73b0\u4e0a\u9700\u8981\u6ce8\u610f\u77e9\u9635\u662f\u4ece\u94fe\u5e95\u7aef\u4e58\u5230\u94fe\u9876\u7aef\uff0c\u5012\u5e8f\u3002\n\n\u4f3c\u4e4e\u53ea\u9700\u8981\u7ebf\u6bb5\u6811\u4e0a $\\texttt{query}$ \u7684\u65f6\u5019\u662f\u53f3\u5b50\u6811\u4e58\u5de6\u5b50\u6811\u5373\u53ef\u3002\n\n\u51e0\u4e2a\u8981\u70b9\uff1a\n\n1. \u6269\u5c55 $f_{u,1}$ \u7684\u5b9a\u4e49\uff1a$u$ \u9009\u7684\u7b54\u6848 $\\to$ $u$ \u9009\u6216\u4e0d\u9009\u7684\u7b54\u6848\u3002\n2. \u628a\u9664\u91cd\u513f\u5b50\u5916\u7684\u4e1c\u897f\u6253\u5305\u5230 $g_u$ \u8003\u8651\u3002\n3. \u6765\u81ea[P4719 \u6700\u9ad8\u8d5e\u9898\u89e3](https://www.luogu.com.cn/blog/Tweetuzki/solution-p4179)\uff1a\u6bcf\u6761\u91cd\u94fe\u7684\u94fe\u5c3e\u90fd\u662f\u53f6\u5b50\u8282\u70b9\uff0c\u4e14\u53ea\u6709\u53f6\u5b50\u8282\u70b9\u6ca1\u6709\u91cd\u513f\u5b50\u3002\u8fd9\u4e3a\u52a8\u6001\u89c4\u5212\u7684\u521d\u59cb\u72b6\u6001\u548c\u8f6c\u79fb\u65b9\u5f0f\u505a\u4e86\u4fdd\u969c\u3002\n\n[\u63d0\u4ea4\u8bb0\u5f55](https://www.luogu.com.cn/record/76042967)\n\n## \u5168\u5c40\u5e73\u8861\u4e8c\u53c9\u6811\n\n\u5168\u5c40\u5e73\u8861\u4e8c\u53c9\u6811\n\nlxl\uff1a**G**lobal **B**iased **T**ree\uff08**GBT**\uff09\n\nYang Zhe\uff1a**G**lobal **B**alanced **BST**\uff08**GBBST**\uff09\n\n[\u6d1b\u8c37 P4751 \u3010\u6a21\u677f\u3011\"\u52a8\u6001DP\"&\u52a8\u6001\u6811\u5206\u6cbb\uff08\u52a0\u5f3a\u7248\uff09](https://www.luogu.com.cn/problem/P4751)\n\n\u6570\u636e\u8303\u56f4\u5df2\u7ecf\u4e0d\u5141\u8bb8 $O(\\log^2 n)$ \u7684\u505a\u6cd5\u4e86\u3002\n\n\u6ce8\u610f\u5230\u4e0a\u9762\u90a3\u4e2a\u505a\u6cd5\u7684\u52a3\u52bf\u5728\u4e8e\uff1a\u6bcf\u6b21\u6811\u5256\u67e5\u8be2\u7684\u662f\u82e5\u5e72\u6761\u91cd\u94fe\uff0c\u800c\u5c31\u7b97\u4e00\u6761\u94fe\u7684\u957f\u5ea6 $l=1$\uff0c\u5355\u6b21\u67e5\u8be2\u91cd\u94fe\u590d\u6742\u5ea6\u90fd\u662f $O(\\log n)$\uff0c\u56e0\u4e3a\u662f\u5f00\u4e00\u68f5\u7ebf\u6bb5\u6811\u7ef4\u62a4\u6240\u6709\u8282\u70b9\u7684\u77e9\u9635\u3002\u603b\u7684\u5408\u5e76\u590d\u6742\u5ea6\u5c31\u662f $O(\\log^2 n)$\u3002\n\n\u8003\u8651\u4fee\u6539\u4e00\u4e0b\uff0c\u5bf9\u6bcf\u6761\u91cd\u94fe\u5355\u72ec\u7528\u4e00\u4e2a\u5f62\u6001\u4e0d\u53d8\u7684\u4e8c\u53c9\u6811\u7ef4\u62a4\uff0c\u7f51\u7edc\u4e0a\u5927\u90e8\u5206\u535a\u5ba2\u90fd\u662f\u975e leafy \u7ed3\u6784\uff0c\u7c7b\u4f3c\u5e73\u8861\u6811\u3002\u4f46\u5199\u6210 leafy \u7684\u7ebf\u6bb5\u6811\u4e5f\u4e0d\u4f1a\u9519\u3002\n\n> leafy \u4e24\u500d\u5e38\u6570 \u2014\u2014 rsy\n\n\u95ee\u9898\u5728\u4e8e\u5982\u679c\u8fd8\u662f\u6309\u7167\u4e00\u822c\u7684\u7ebf\u6bb5\u6811\u5efa\u6811\uff0c\u6bcf\u6b21\u627e\u4e2d\u70b9\uff0c$O(\\log n)\\sum O(\\log l)$ \u4ecd\u53ef\u4ee5\u5361\u5230 $O(\\log^2 n)$\u3002\n\n\u8003\u8651\u8bb0\uff1a\n$$\n\\mathrm{Lsize}(u)=1+\\sum_{v\\in \\mathrm{LightSon}(u)} \\mathrm{size}_v\n$$\n\u5373\u6240\u6709\u8f7b\u513f\u5b50 $\\mathrm{size}$ \u4e4b\u548c\u52a0\u4e0a\u81ea\u5df1\u3002\n\n\u8fd9\u65f6\u5019\uff0c\u5982\u679c\u5728\u91cd\u94fe\u4e0a\u6309\u7167 $\\mathrm{Lsize}$ \u4e3a\u6743\u503c\uff0c\u627e\u5230\u5e26\u6743\u4e2d\u70b9\uff0c\u7136\u540e\u9012\u5f52\u5230\u5de6\u53f3\u5efa\uff08\u5e73\u8861/\u7ebf\u6bb5\uff09\u6811\u6765\u7ef4\u62a4\u4fe1\u606f\uff0c\u5747\u644a\u4e0b\u6765\u4fee\u6539\u7684\u590d\u6742\u5ea6\u5c31\u662f $O(\\log n)$ \u7684\u3002\n\n\u4e3a\u4ec0\u4e48\uff1f\u4e0d\u77e5\u9053\u3002\u96be\u9053\u4f60\u77e5\u9053\u4e3a\u4ec0\u4e48 Splay \u5747\u644a\u662f $O(q\\log n )$ \u7684\u5417\uff1f\n\n\u8be6\u7ec6\u8bc1\u660e\u53ef\u89c1 [Yang Zhe - QTREE \u89e3\u6cd5\u7684\u4e00\u4e9b\u7814\u7a76](https://wenku.baidu.com/view/75906f160b4e767f5acfcedb)\n\n[\u63d0\u4ea4\u8bb0\u5f55](https://www.luogu.com.cn/record/76069612)\uff08\u65e0 IO \u4f18\u5316\uff09\n\n\u5173\u4e8e\u6b65\u9aa4\uff1a\n\n1. \u6811\u94fe\u5256\u5206\u3002\n2. \u627e\u51fa\u8fde\u63a5\u6839\u8282\u70b9\u7684\u91cd\u94fe\uff0c\u5bf9**\u8fd9\u6761\u91cd\u94fe**\u5efa\u7acb\u4e8c\u53c9\u641c\u7d22\u6811\uff0c\u7136\u540e\u5bf9\u8fde\u63a5\u8fd9\u6761\u91cd\u94fe\u7684\u5176\u4ed6\u91cd\u94fe**\u9012\u5f52**\u5efa\u7acb\u3002\n3. \u4e00\u68f5\u4e8c\u53c9\u641c\u7d22\u6811\u6839\u8282\u70b9\u8981\u7ef4\u62a4\u8fd9\u68f5\u4e8c\u53c9\u6811\u7684**\u6240\u6709\u77e9\u9635\u4e58\u79ef**\u3002\n4. \u4fee\u6539 $a_u \\gets x$\uff1a\n   1. \u627e\u5230 $u$ \u6240\u5bf9\u5e94\u7684\u5e73\u8861/\u7ebf\u6bb5\u6811\u8282\u70b9\u3002\n   2. \u4fee\u6539 $a_u$ \u5bf9\u5e94\u7684\u77e9\u9635\u3002\n   3. \u66b4\u529b\u5f80\u4e0a\u8df3\uff0c\u6bcf\u6b21\u90fd push_up\u3002\n   4. \u5230\u6839\u4e86\uff0c\u67e5\u770b\u8fd9\u68f5\u5e73\u8861/\u7ebf\u6bb5\u6811**\u6240\u5bf9\u5e94\u7684\u91cd\u94fe**\uff0c\u627e\u5230\u94fe\u5934\u7684\u7236\u4eb2\uff0c\u8bb0\u4f5c\u65b0\u7684 $u$\uff0c\u6ca1\u7236\u4eb2\u5c31\u53ef\u4ee5\u9000\u51fa\u4e86\u3002\n   5. \u56de\u5230\u6b65\u9aa4 4.2\u3002\n\n\u5173\u4e8e\u5b9e\u73b0\uff1a\n\n1. \u4e0a\u6587\u6709\u8bf4\u662f\u5bf9\u6bcf\u6761\u91cd\u94fe\u4f9d\u7167\u5e26\u6743\u4e2d\u70b9\u4e8c\u5206\u5efa\u7acb\u4e00\u68f5\u5e73\u8861\u6811\uff0c**\u8fd9\u6837\u662f\u5bf9\u7684**\uff0c\u4f46\u662f\u6709\u4e00\u4e9b\u5176\u4ed6\u7684\u5b9e\u73b0\u65b9\u5f0f\u3002\u6bd4\u5982\u5927\u90e8\u5206\u535a\u5ba2\u4f1a\u628a\u8f7b\u513f\u5b50\u5411\u7236\u4eb2\u7684\u5e73\u8861/\u7ebf\u6bb5\u6811\u8282\u70b9\u8fde\u4e00\u6761**\u865a\u8fb9**\u3002\n2. \u6240\u8c13**\u865a\u8fb9**\uff1a\u56e0\u4e3a\u5b83\u7236\u4eb2\u6240\u5728\u7684\u91cd\u94fe\u81ea\u5df1\u6784\u6210\u4e86\u4e00\u68f5\u4e8c\u53c9\u6811\uff0c\u5176\u7236\u4eb2\u65e0\u6cd5\u53d8\u6210\u591a\u53c9\u6811\uff0c\u6307\u5411\u8f7b\u513f\u5b50\uff0c\u4f46\u662f\u8f7b\u513f\u5b50\u53ef\u4ee5\u6307\u5411\u7236\u4eb2\u3002\u5373**\u865a\u8fb9**\uff0c\u6709**\u8ba4\u7236\u4e0d\u8ba4\u5b50**\u7684\u7279\u70b9\u3002\u63a8\u8350\u8fd9\u6837\u7684\u5b9e\u73b0\u65b9\u5f0f\uff0c\u8fd9\u6837\u5728\u4fee\u6539\u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u4ece $u$ \u8282\u70b9\u8df3\u76f4\u63a5\u5230\u9876\uff0c\u7701\u53bb\u4e0d\u5c11\u9ebb\u70e6\u3002\u8be6\u7ec6\u89c1\u4ee3\u7801\u3002\n\n### Code\n\n```cpp\n// Problem: P4751 \u3010\u6a21\u677f\u3011\"\u52a8\u6001DP\"&\u52a8\u6001\u6811\u5206\u6cbb\uff08\u52a0\u5f3a\u7248\uff09\n// From: Luogu\n// URL: https://www.luogu.com.cn/problem/P4751\n// Time: 2022-05-19 21:21\n// Author: lingfunny\n\n#include <bits/stdc++.h>\n#define LL long long\nusing namespace std;\nconst int mxn = 1e6+10, inf = 1e9;\n\nint n, m, lst, a[mxn], rt, f[mxn][2], g[mxn][2];\nvector <int> G[mxn];\n\nstruct mat {\n\tstatic const int V = 2;\n\tint a[V][V];\n\tmat(int a00 = 0, int a01 = -inf, int a10 = -inf, int a11 = 0) { a[0][0] = a00, a[0][1] = a01, a[1][0] = a10, a[1][1] = a11; }\n\tinline mat operator * (const mat &rhs) const {\n\t\tmat res;\n\t\tfor(int i = 0; i < V; ++i) for(int j = 0; j < V; ++j) {\n\t\t\tres.a[i][j] = -inf;\n\t\t\tfor(int k = 0; k < V; ++k) res.a[i][j] = max(res.a[i][j], a[i][k] + rhs.a[k][j]);\n\t\t}\n\t\treturn res;\n\t}\n\tinline void show() {\n\t\tfor(int i = 0; i < V; ++i) for(int j = 0; j < V; ++j) printf(\"%d%c\", a[i][j], \" \\n\"[j==V-1]);\n\t}\n} gm[mxn];\n\nstruct node { int lc, rc, anc; mat u, s; } nd[mxn];\ninline void psup(int u) {\n\tnode &o = nd[u];\n\to.s = nd[o.rc].s * o.u * nd[o.lc].s;\t// \u53cd\u7740\u4e58\uff0c\u539f\u56e0\u89c1\u4e0a\u6587 P4719\n}\n\nint sz[mxn], lsz[mxn], dep[mxn], fa[mxn], son[mxn], top[mxn], End[mxn], dfn[mxn], mp[mxn], dfc;\n// lsz[u]: Lsize[u]\n// top/End: \u91cd\u94fe\u9876/\u5e95\n// mp: mp[dfn[u]] = u\n\nvoid dfs(int u, int f) {\n\tlsz[u] = sz[u] = 1, dep[u] = dep[f] + 1, fa[u] = f;\n\tfor(int v: G[u]) if(v != f) {\n\t\tdfs(v, u), sz[u] += sz[v];\n\t\tif(sz[v] > sz[son[u]]) son[u] = v;\n\t}\n\tlsz[u] = sz[u] - sz[son[u]];\n}\nvoid dfs2(int u) {\n\tEnd[u] = mp[dfn[u] = ++dfc] = u; g[u][0] = a[u];\n\tif(son[u]) top[son[u]] = top[u], dfs2(son[u]), End[u] = End[son[u]];\n\tfor(int v: G[u]) if(v != fa[u] && v != son[u]) top[v] = v, dfs2(v), g[u][0] += f[v][0], g[u][1] += f[v][1];\n\tf[u][0] = f[son[u]][1] + g[u][1];\n\tf[u][1] = max(f[u][0], f[son[u]][0] + g[u][0]);\n\tgm[u] = mat(-inf, g[u][0], g[u][1], g[u][1]);\n}\n\nint sbuild(int L, int R) {\n\tif(L > R) return 0;\n\tLL sum = 0, qsum = 0;\n\tfor(int i = L; i <= R; ++i) sum += lsz[mp[i]];\n\tfor(int i = L, o; i <= R; ++i) {\n\t\tqsum += lsz[mp[i]];\n\t\tif(qsum * 2 > sum) {\n\t\t\to = mp[i];\n\t\t\tnode &u = nd[o];\n\t\t\tu.u = gm[o];\n\t\t\tu.lc = sbuild(L, i-1), nd[u.lc].anc = o;\n\t\t\tu.rc = sbuild(i+1, R), nd[u.rc].anc = o;\n\t\t\tpsup(o);\n\t\t\treturn o;\n\t\t}\n\t}\n\treturn -114514;\n}\n\nint build(int Tp) {\n\tint Ed = End[Tp], X = sbuild(dfn[Tp], dfn[Ed]);\n\tfor(int i = dfn[Tp]; i <= dfn[Ed]; ++i) {\n\t\tconst int &u = mp[i];\n\t\tfor(int v: G[u]) if(v != son[u] && v != fa[u]) nd[build(v)].anc = u;\n\t}\n\treturn X;\n}\n\ninline void modify(int u, int x) {\n\tgm[u].a[0][1] += x - a[u]; a[u] = x;\n\tnd[u].u = gm[u];\n\twhile(u) {\n\t\tint F = nd[u].anc;\n\t\tif(nd[F].lc != u && nd[F].rc != u && F) { // \u5982\u679c\u5f53\u524d\u8282\u70b9\u5230\u7236\u4eb2\u7684\u8fb9\u662f\u865a\u8fb9\n\t\t\tmat bef = nd[u].s;\n\t\t\tpsup(u);\n\t\t\tmat aft = nd[u].s;\n\t\t\tint _f0 = max(bef.a[0][0], bef.a[1][0]), _f1 = max(bef.a[0][1], bef.a[1][1]),\n\t\t\tf0 = max(aft.a[0][0], aft.a[1][0]), f1 = max(aft.a[0][1], aft.a[1][1]);\n\t\t\tmat &r = nd[F].u;\n\t\t\tr.a[0][1] += f0 - _f0;\n\t\t\tr.a[1][0] += f1 - _f1, r.a[1][1] += f1 - _f1;\n\t\t\tgm[F] = r;\n\t\t} else psup(u);\n\t\tu = F;\n\t}\n}\n\nsigned main() {\n\tscanf(\"%d%d\", &n, &m);\n\tfor(int i = 1; i <= n; ++i) scanf(\"%d\", a+i);\n\tfor(int i = 1, u, v; i < n; ++i) scanf(\"%d%d\", &u, &v), G[u].push_back(v), G[v].push_back(u);\n\tdfs(1, 0), top[1] = 1, dfs2(1), rt  = build(1);\n\twhile(m--) {\n\t\tint x, y; scanf(\"%d%d\", &x, &y); x ^= lst;\n\t\tmodify(x, y);\n\t\tprintf(\"%d\\n\", lst=max(nd[rt].s.a[0][1], nd[rt].s.a[1][1]));\n\t}\n\treturn 0;\n}\n```\n\n~~\u6211\u80fd\u6c34\u4e00\u7bc7\u9898\u89e3\u5417~~",
        "postTime": 1652936526,
        "uid": 280800,
        "name": "lingfunny",
        "ccfLevel": 7,
        "title": "ddp \u548c gbbst \u53e3\u80e1\u62a5\u544a"
    },
    {
        "content": "~~\u7a81\u7136\u5fc3\u8840\u6765\u6f6e\u4ea4\u4e86\u4e00\u53d1\u4ee5\u524d\u768490\u5206LCT\u4ee3\u7801\uff0c\u5c45\u7136\u8fc7\u4e86,\u8fd8\u53ea\u89812.4s\uff1f\uff1f~~\n\n\u4e0d\u7981\u56de\u5fc6\u8d77\u4e86\u6211\u4ee5\u524d\u5361\u4e86\u4e24\u5929\u8fd8\u5dee0.3s\u7684\u7edd\u671b\u3002\n\n\u4e8e\u662f\u6211\u5c31\u6765\u63d0\u4f9b\u4e00\u4e2a\u9605\u8bfb\u6027\u6bd4\u8f83\u597d\u7684LCT\u4ee3\u7801\uff0c\u5e76\u63d0\u4f9b\u4e00\u4e2a\u5361\u5e38\u7684\u65b9\u6cd5\u3002\n\n~~LCTNB!!!~~\n\n1.\u5faa\u73af\u5c55\u5f00\u3002\n\n2.IO\u4f18\u5316\n\n3.#pragma GCC optimize\n\n125\u884c\u4f60\u503c\u5f97\u62e5\u6709\n\n\n```cpp\n/*\n@Date    : 2019-08-16 11:34:40\n@Author  : Adscn (adscn@qq.com)\n@Link    : https://www.cnblogs.com/LLCSBlog\n*/\n#pragma GCC optimize(2)\n#pragma GCC optimize(3)\n#pragma GCC optimize(\"Ofast\")\n#pragma GCC optimize(\"inline\")\n#include<bits/stdc++.h>\nusing namespace std;\ntypedef unsigned long long uint64;\ntypedef unsigned int uint32;\ntypedef long long ll;\n#define IL inline\n#define RG register\n#define gi getint()\n#define gc getchar()\n#define File(a) freopen(a\".in\",\"r\",stdin);freopen(a\".out\",\"w\",stdout)\nIL int getint()\n{\n\tRG int xi=0;\n\tRG char ch=gc;\n\tbool f=0;\n\twhile(ch<'0'||ch>'9')ch=='-'?f=1:f,ch=gc;\n\twhile(ch>='0'&&ch<='9')xi=(xi<<1)+(xi<<3)+ch-48,ch=gc;\n\treturn f?-xi:xi;\n}\ntemplate<typename T>\nIL void pi(T k,char ch=0)\n{\n\tif(k<0)k=-k,putchar('-');\n\tif(k>=10)pi(k/10,0);\n\tputchar(k%10+'0');\n\tif(ch)putchar(ch);\n}\nconst int N=1e6+7;\nstruct edge{\n\tint v,nxt;\n}e[N<<1];\nint head[N],cnt;\nint n,m;\nint a[N],dp[N][2];\ninline void add(const int &u,const int &v){e[++cnt]=(edge){v,head[u]},head[u]=cnt;}\ninline int max(const int &a,const int &b){return a>b?a:b;}\nnamespace LCT{\n\t#define ls(x) (c[x][0])\n\t#define rs(x) (c[x][1])\n\t#define s(x,k) (c[x][k])\n\tint fa[N],c[N][2];\n\tstruct matrix{\n\t\tint a[4];\n\t\tinline int &operator [] (const int &x){return a[x];}\n\t\tinline const int &operator [] (const int &x)const{return a[x];}\n\t\tinline matrix operator * (const matrix &b)const{\n\t\t\tmatrix c;\n\t\t\tc[0]=max(a[1]+b[2],a[0]+b[0]);\n\t\t\tc[1]=max(a[0]+b[1],a[1]+b[3]);\n\t\t\tc[2]=max(a[3]+b[2],a[2]+b[0]);\n\t\t\tc[3]=max(a[3]+b[3],a[2]+b[1]);\n\t\t\treturn c;\n\t\t}\n\t}ret[N],val[N];\n\tinline bool ws(const int &x){return ls(fa[x])^x;}\n\tinline bool nrt(const int &x){return ls(fa[x])==x||rs(fa[x])==x;}\n\tinline void pushup(const int &x){\n\t\tret[x]=val[x];\n\t\tif(ls(x))ret[x]=ret[ls(x)]*ret[x];\n\t\tif(rs(x))ret[x]=ret[x]*ret[rs(x)];\n\t}\n\tinline void rotate(const int &x){\n\t\tint p=fa[x],g=fa[p],t=ws(x),w=s(x,!t);\n\t\tif(nrt(p))s(g,ws(p))=x;s(x,!t)=p,s(p,t)=w;\n\t\tfa[w]=p;fa[p]=x,fa[x]=g;\n\t\tpushup(p);\n\t}\n\tinline void Splay(const int &x)\n\t{\n\t\twhile(nrt(x))\n\t\t{\n\t\t\tint p=fa[x];\n\t\t\tif(nrt(p))rotate(ws(x)^ws(p)?x:p);\n\t\t\trotate(x);\n\t\t}\n\t\tpushup(x);\n\t}\n\tinline void access(register int x)\n\t{\n\t\tfor(register int y=0;x;x=fa[y=x]){\n\t\t\tSplay(x);\n\t\t\tval[x][0]+=max(ret[rs(x)][0],ret[rs(x)][2])-max(ret[y][0],ret[y][2]),val[x][2]+=ret[rs(x)][0]-ret[y][0];\n\t\t\tval[x][1]=val[x][0];\n\t\t\trs(x)=y,pushup(x);\n\t\t}\n\t}\n\tinline void modify(const int &x,const int &y)\n\t{\n\t\taccess(x),Splay(x);\n\t\tval[x][2]-=a[x]-y,a[x]=y;\n\t\tpushup(x);\n\t}\n}\nusing namespace LCT;\ninline void dfs(const int &p)\n{\n\tfor(int i=head[p],v;i;i=e[i].nxt)\n\t\tif((v=e[i].v)^fa[p])\n\t\t\tfa[v]=p,dfs(v),dp[p][0]+=max(dp[v][0],dp[v][1]),dp[p][1]+=dp[v][0];\n\tval[p][0]=val[p][1]=dp[p][0],val[p][2]=(dp[p][1]+=a[p]),ret[p]=val[p],val[p][3]=-1e9;\n}\nint main(void)\n{\n\tn=gi,m=gi;\n\tfor(int i=1;i<=n;++i)a[i]=gi;\n\tfor(int i=1,u,v;i<n;++i)u=gi,v=gi,add(u,v),add(v,u);\n\tdfs(1);\n\tint lastans=0;\n\twhile(m--)\n\t{\n\t\tint x=gi,y=gi;\n\t\tmodify(x^lastans,y),Splay(1);\n\t\tpi(lastans=max(ret[1][0],ret[1][2]),'\\n');\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1590824919,
        "uid": 19607,
        "name": "ACA\u306d",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 P4751 \u3010\u3010\u6a21\u677f\u3011\"\u52a8\u6001DP\"&\u52a8\u6001\u6811\u5206\u6cbb\uff08\u52a0\u5f3a\u7248\uff09\u3011"
    },
    {
        "content": "[Luogu4751 \u3010\u6a21\u677f\u3011\"\u52a8\u6001DP\"&\u52a8\u6001\u6811\u5206\u6cbb\uff08\u52a0\u5f3a\u7248\uff09](https://www.luogu.com.cn/problem/P4751)\n\n[\u6211\u7684\u535a\u5ba2](https://www.cnblogs.com/GK0328/p/13662045.html)\n\n# \u52a8\u6001DP\n\n\u6811\u5256\u7684\u52a8\u6001DP\u505a\u6cd5\u89c1\u6b64\uff0c\u52a8\u6001DP\u539f\u7406\u4e5f\u5728\u91cc\u9762\uff0c\u8fd9\u7bc7\u535a\u5ba2\u5c31\u4e0d\u5199\u4e86\uff1a[\u6811\u5256\u52a8\u6001DP](https://www.cnblogs.com/GK0328/p/13601566.html)\n\n\u7531\u4e8e**\u6811\u5256**\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a$O(n \\log^2 n)$\uff0c\u4f1a\u88ab\u8fd9\u9053\u9898\u5361\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981**\u5168\u5c40\u5e73\u8861\u4e8c\u53c9\u6811**\n\n**\u5168\u5c40\u5e73\u8861\u4e8c\u53c9\u6811**\u7c7b\u4f3c$LCT$\uff0c\u6709\u865a\u5b9e\u8fb9\u4e4b\u5206\uff0c\u6211\u4eec\u628a\u6240\u6709\u7684**\u91cd\u8fb9**\u4f5c\u4e3a**\u5b9e\u8fb9**\uff0c**\u8f7b\u8fb9**\u4f5c\u4e3a\u865a\u8fb9\uff0c\u5f3a\u884c\u6784\u9020\u4e00\u68f5$LCT$\n\n**\u5168\u5c40\u5e73\u8861\u4e8c\u53c9\u6811**\u53ef\u4ee5\u770b\u505a\u4e00\u68f5\u9759\u6001\u7684$LCT$\uff0c\u56e0\u4e3a\u6211\u4eec\u5df2\u7ecf\u5f3a\u884c\u628a**\u5b9e\u8fb9**\u3001**\u8f7b\u8fb9**\u662f\u54ea\u4e9b\u8fb9\uff0c\u4ee5\u53ca**\u6811\u7684\u7ed3\u6784**\u90fd\u94a6\u5b9a\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u65e0\u6cd5\u5229\u7528$Splay$\u7b49\u64cd\u4f5c\u4fee\u6539**\u6811\u7684\u7ed3\u6784**\uff0c\u4f46\u662f\u6211\u4eec\u4e5f\u4e0d\u9700\u8981\n\n\u4e5f\u5c31\u662f\u8bf4\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u6761\u91cd\u94fe\uff0c\u6211\u4eec\u90fd\u6784\u5efa\u4e00\u68f5\u4e8c\u53c9\u641c\u7d22\u6811\uff0c\u5bf9\u4e8e\u6839\u8282\u70b9\uff0c\u5b83\u7684\u5de6\u513f\u5b50\u90fd\u662f\u5b83\u7684\u7236\u4eb2\uff0c\u53f3\u513f\u5b50\u90fd\u662f\u5b83\u7684\u5b50\u5b59\uff08\u4e0e$LCT$\u6781\u5176\u7c7b\u4f3c\uff09\uff0c\u7136\u540e\u7528\u8f7b\u8fb9\u8fde\u63a5\u8d77\u6765\n\n\u6ce8\u610f\uff0c\u7531\u4e8e**\u5168\u5c40\u5e73\u8861\u4e8c\u53c9\u6811**\u4e00\u5806\u4e8c\u53c9\u641c\u7d22\u6811\u7528\u8f7b\u8fb9\u8fde\u63a5\u7ec4\u6210\uff0c\u53ef\u4ee5\u6cbf\u8f7b\u8fb9\u4fee\u6539\uff0c\u6240\u4ee5\u5bf9\u4e8e\u4e00\u6761\u91cd\u94fe\u7684\u6bcf\u4e2a\u8282\u70b9\uff0c\u5b83\u90fd\u6302\u7740\u4e00\u68f5\u8f7b\u5b50\u6811\uff0c\u56e0\u6b64\uff0c\u6211\u4eec\u94a6\u5b9a\u7684\u8fd9\u6761\u91cd\u94fe\u7684\u6839\u662f\u5e26\u6743\u7684\uff0c\u8fd9\u6837\u624d\u80fd\u6ee1\u8db3\u5168\u5c40\u5e73\u8861\uff08\u4e00\u4e2a\u8282\u70b9\u7684\u6743\u91cd\u4e3a\u5176\u8f7b\u5b50\u6811\u7684\u5927\u5c0f\u52a0\u4e0a\u81ea\u5df1$size_{light}+1$\uff09\n\n\u627e\u5230\u4e00\u6761\u94fe\u7684\u6839\uff0c\u53ef\u4ee5\u4e8c\u5206\uff08\u66b4\u529b\u679a\u4e3e\u4e5f\u6ca1\u95ee\u9898\uff09\uff0c\u7136\u540e\u7ee7\u7eed\u9012\u5f52\u5de6\u53f3\u5b50\u6811\uff0c\u6700\u7ec8\u5efa\u6210\u4e8c\u53c9\u641c\u7d22\u6811\uff0c\u8fd9\u68f5\u4e8c\u53c9\u641c\u7d22\u6811\u7684\u6839\u7684\u7236\u4eb2\u4e3a\u8fd9\u68f5\u4e8c\u53c9\u641c\u7d22\u6811\u6240\u4ee3\u8868\u7684\u91cd\u94fe\u7684\u7236\u4eb2\uff08\u5176\u5b9e\u4f1a$LCT$\u7684\u6839\u672c\u4e0d\u9700\u8981\u89e3\u91ca\uff09\n\n\u90a3\u4e48\u4fee\u6539\u65f6\u5c31\u66b4\u529b\u8df3\u7236\u4eb2\uff0c\u5982\u679c\u662f\u91cd\u8fb9\uff0c\u76f4\u63a5$update$\uff0c\u5982\u679c\u662f\u8f7b\u8fb9\uff0c\u90a3\u4e48\u5c31\u6d88\u9664\u539f\u6709\u7684\u8d21\u732e\uff0c\u52a0\u4e0a\u65b0\u7684\u8d21\u732e\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a$O(n \\log n)$\n\n$Code:$\n\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<algorithm>\n#define N 1000005\n#define INF 1000000007\n#define ls(x) ch[x][0]\n#define rs(x) ch[x][1]\n#define fa(x) F[x]\nusing namespace std;\nint n,m,x,y,tot,rt,lst=0,v[N],F[N],fr[N],d[N << 1],nxt[N << 1];\nint sz[N],son[N],q[N],qz[N];\nint f[N][2],g[N][2],ch[N][2];\ninline int Rmn(int x,int y)\n{\n    return (x<y)?x:y;\n}\ninline int Rmx(int x,int y)\n{\n    return (x>y)?x:y;\n}\nstruct mat\n{\n    int w[2][2];\n    inline mat operator * (mat b)\n    {\n        mat c;\n        c.w[0][0]=Rmx(w[0][0]+b.w[0][0],w[0][1]+b.w[1][0]);\n        c.w[0][1]=Rmx(w[0][0]+b.w[0][1],w[0][1]+b.w[1][1]);\n        c.w[1][0]=Rmx(w[1][0]+b.w[0][0],w[1][1]+b.w[1][0]);\n        c.w[1][1]=Rmx(w[1][0]+b.w[0][1],w[1][1]+b.w[1][1]);\n        return c;\n    }\n}z[N],s[N];\nvoid Rs(mat &q,int a,int b,int c,int d)\n{\n    q.w[0][0]=a,q.w[0][1]=b;\n    q.w[1][0]=c,q.w[1][1]=d;\n}\ninline int read()\n{\n    int s=0,w=1;\n    char c=getchar();\n    while (c<'0' || c>'9')\n    {\n        if (c=='-')\n            w=-1;\n        c=getchar();\n    }\n    while ('0'<=c && c<='9')\n        s=s*10+c-'0',c=getchar();\n    return s*w;\n}\nvoid write(int x)\n{\n    if (x>9)\n        write(x/10);\n    putchar(x%10+'0');\n}\nvoid add(int x,int y)\n{\n    tot++;\n    d[tot]=y;\n    nxt[tot]=fr[x];\n    fr[x]=tot;\n}\nvoid dfs(int u)\n{\n    int mx=0;\n    sz[u]=1;\n    for (int i=fr[u];i;i=nxt[i])\n    {\n        int v=d[i];\n        if (v==fa(u))\n            continue;\n        fa(v)=u;\n        dfs(v);\n        sz[u]+=sz[v];\n        if (sz[v]>mx)\n        {\n            mx=sz[v];\n            son[u]=v;\n        }\n    }\n}\nbool isrt(int x)\n{\n    return ls(fa(x))!=x && rs(fa(x))!=x;\n}\nvoid update(int x)\n{\n    s[x]=s[ls(x)]*z[x]*s[rs(x)];\n}\nint build(int l,int r)\n{\n    if (l>r)\n        return 0;\n    int sm=qz[r]-qz[l-1];\n    sm=(sm+1) >> 1;\n    int L=l,R=r,nrt;\n    while (L<=R)\n    {\n        int mid=(L+R) >> 1;\n        if (qz[mid]-qz[l-1]>=sm)\n        {\n            nrt=mid;\n            R=mid-1;\n        } else\n            L=mid+1;\n    }\n    ls(q[nrt])=build(l,nrt-1);\n    rs(q[nrt])=build(nrt+1,r);\n    fa(ls(q[nrt]))=q[nrt];\n    fa(rs(q[nrt]))=q[nrt];\n    update(q[nrt]);\n    return q[nrt];\n}\nvoid dfs2(int u)\n{\n    g[u][0]=0;\n    g[u][1]=v[u];\n    if (!son[u])\n    {\n        Rs(z[u],0,-INF,v[u],-INF);\n        f[u][0]=g[u][0],f[u][1]=g[u][1];\n        if (son[fa(u)]!=u)\n        {\n            int rf=fa(u);\n            q[0]=0,qz[0]=0;\n            for (int v=u;v;v=son[v])\n                q[++q[0]]=v,qz[q[0]]=qz[q[0]-1]+sz[v]-sz[son[v]];\n            rt=build(1,q[0]);\n            fa(rt)=rf;\n        }\n        return;\n    }\n    dfs2(son[u]);\n    for (int i=fr[u];i;i=nxt[i])\n    {\n        int v=d[i];\n        if (v==fa(u) || v==son[u])\n            continue;\n        dfs2(v);\n        g[u][0]+=Rmx(f[v][0],f[v][1]);\n        g[u][1]+=f[v][0];\n    }\n    f[u][0]=g[u][0]+Rmx(f[son[u]][0],f[son[u]][1]);\n    f[u][1]=g[u][1]+f[son[u]][0];\n    Rs(z[u],g[u][0],g[u][0],g[u][1],-INF);\n    if (son[fa(u)]!=u)\n    {\n        int rf=fa(u);\n        q[0]=0,qz[0]=0;\n        for (int v=u;v;v=son[v])\n            q[++q[0]]=v,qz[q[0]]=qz[q[0]-1]+sz[v]-sz[son[v]];\n        rt=build(1,q[0]);\n        fa(rt)=rf;\n    }\n}\nvoid modify(int x,int y)\n{\n    g[x][1]=g[x][1]-v[x]+y;\n    v[x]=y;\n    Rs(z[x],g[x][0],g[x][0],g[x][1],-INF);\n    for (int u=x;u;u=fa(u))\n        if (isrt(u) && fa(u))\n        {\n            int v=fa(u);\n            g[v][0]-=Rmx(s[u].w[0][0],s[u].w[1][0]);\n            g[v][1]-=s[u].w[0][0];\n            update(u);\n            g[v][0]+=Rmx(s[u].w[0][0],s[u].w[1][0]);\n            g[v][1]+=s[u].w[0][0];\n            Rs(z[v],g[v][0],g[v][0],g[v][1],-INF);\n        } else\n            update(u);\n}\nint main()\n{\n    n=read(),m=read();\n    for (int i=1;i<=n;i++)\n        v[i]=read();\n    for (int i=1;i<n;i++)\n    {\n        x=read(),y=read();\n        add(x,y);\n        add(y,x);\n    }\n    dfs(1);\n    Rs(z[0],0,-INF,-INF,0);\n    Rs(s[0],0,-INF,-INF,0);\n    dfs2(1);\n    while (m --> 0)\n    {\n        x=read(),y=read(),x^=lst;\n        modify(x,y);\n        lst=Rmx(s[rt].w[0][0],s[rt].w[1][0]);\n        write(lst),putchar('\\n');\n    }\n    return 0;\n}\n```",
        "postTime": 1600165696,
        "uid": 10341,
        "name": "GK0328",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P4751 \u3010\u3010\u6a21\u677f\u3011\"\u52a8\u6001DP\"&\u52a8\u6001\u6811\u5206\u6cbb\uff08\u52a0\u5f3a\u7248\uff09\u3011"
    },
    {
        "content": "\u76f8\u4fe1\u770b\u5230\u8fd9\u91cc\u7684\u5927\u4f6c\u90fd\u5df2\u7ecf\u5b66\u4f1a\u52a8\u6001dp\u4e86\uff0c\u8fd9\u91cc\u8bb2lct\u600e\u4e48\u5361\u5e38\u3002\u4e0d\u5c11\u4eba\u90fd\u5361\u4e86\u4e00\u7248\uff0c\u73b0\u5728\u7684\u901a\u8fc7\u7387\u4e5f\u53ef\u4ee5\u8bf4\u660e\u4eba\u5747\u63d0\u4ea410+\u6b21\u3002\n\n\u8fd9\u7bc7\u9898\u89e3\u6ca1\u6709\u5f88\u591a\u4ef7\u503c\uff0c\u4e3b\u8981\u662f\u5e0c\u671b\u4e0d\u8981\u6709\u5f88\u591a\u4eba\u518d\u4e3a\u4e86\u8c03\u968f\u673a\u6570\u63d0\u4ea4\u4e00\u7248\u3002\n\n\u672c\u9898\u6700\u6bd2\u7624\u7684\u5730\u65b9\u5728\u4e8e\uff1a\u524d3\u4e2a\u70b9\u5361\u6389\u4e86\u66b4\u529b\uff0c\u6b63\u89e3\u53ef\u4ee5\u901a\u8fc7\uff1b4-9\u70b9\u6b63\u89e3\u548c\u66b4\u529b\u90fd\u53ef\u4ee5\u901a\u8fc7\uff1b\u7b2c10\u4e2a\u70b9\u5361\u6389\u4e86\u5927\u90e8\u5206\u6b63\u89e3\uff0c\u66b4\u529b\u53ef\u4ee5\u901a\u8fc7\u3002\n\n\u6211\u672c\u6765\u4f7f\u7528\u4e86 @\u6768\u94e0\u8fdc \u9898\u89e3\u91cc\u7684\u65b9\u6cd5\uff0c\u4ece\u66b4\u529b\u548clct\u4e2d\u968f\u673a\u4e00\u79cd\u65b9\u6cd5\uff0c\u7136\u540e\u5361\u4e8620\u6b21\u8fd8\u4e0d\u6210\u529f\u3002\u6700\u540e\u5728\u8ba8\u8bba\u4e2d\u7ffb\u5230\u4e86\u51fa\u9898\u4eba\u7684\u6570\u636e\u8303\u56f4\uff1a\n\n> \u7b2c10\u4e2a\u70b9 $n = 5 \\times 10 ^ 5, m = 3 \\times 10 ^ 6$\uff1b\u5176\u5b83\u70b9 $n = m = 10 ^ 6$\u3002\n\n\u6240\u4ee5\u4e0d\u9700\u8981\u8c03\u968f\u673a\u53c2\u6570\u6216\u8005\u4ea4\u4e00\u6574\u7248\uff0c\u76f4\u63a5\u5224\u65ad\u4e00\u4e0b $n$ \u7684\u503c\u5c31\u884c\u4e86\u3002\n\n~~\u987a\u4fbf\u8bf4\u4e00\u4e0b\uff0c\u6211\u628a\u8fd9\u9898\u7684\u63d0\u4ea4\u9876\u5230\u4e864k~~\n\n\u8fd8\u662f\u653e\u4e00\u4e0b\u4ee3\u7801\uff1a\n\n```cpp\n// \u7701\u7565 40 \u884c\u5b8f\u4f18\u5316\uff0c\u8bf7\u53c2\u8003\u6d1b\u8c37\u65e5\u62a5\uff1a\n// #219[Ofnoname]\u9884\u5904\u7406\u547d\u4ee4\n// https://www.luogu.org/blog/ofnoname/yu-chu-li-ming-ling\n#define _CRT_DISABLE_PERFCRIT_LOCKS\n#include<cstdio>\n#include<ctime>\n#include<algorithm>\n#include<vector>\n#define getchar(x) getchar_unlocked(x) // \u5176\u4ed6\u4e00\u4e9b\u4f18\u5316\uff0c\u4e0d\u8fc7\u4e0d\u52a0\u53ef\u80fd\u7f16\u8bd1\u5668\u4e5f\u81ea\u52a8\u505a\u4e86\n#define putchar(x) putchar_unlocked(x)\n#define next _next\nusing namespace std;\nconst int N = 1000005, inf = 0x3f3f3f3f;\nint n, m;\nint a[N];\nint first[N], next[N * 2], to[N * 2];\nint dp[N][2];\ninline int read() { // \u4f7f\u7528 scanf \u5149IO\u5c31\u4f1a\u8d85\u65f6\n\tint res = 0, f = 1; char ch = getchar();\n\twhile (ch < '0' || ch > '9') {if (ch == '-') f = -1; ch = getchar();}\n\twhile (ch <= '9' && ch >= '0') {res = (res << 3) + (res << 1) + ch - '0'; ch = getchar();}\n\treturn res * f;\n}\ninline void write(int x) {\n\tif (x < 0) x = -x, putchar('-');\n\tif (x > 9) write(x / 10);\n\tputchar(x % 10 + '0');\n}\nvoid add(int x, int y) {\n\tstatic int cnt = 0;\n\tto[++cnt] = y;\n\tnext[cnt] = first[x];\n\tfirst[x] = cnt;\n}\n// \u77e9\u9635\u90e8\u5206\nstruct matrix {\n\tint a[2][2] = {-inf, -inf, -inf, -inf};\n\tmatrix operator * (const matrix &x) const {\n\t\tmatrix tmp;\n\t\tfor (int i = 0; i < 2; i++)\n\t\t\tfor (int j = 0; j < 2; j++)\n\t\t\t\tfor (int k = 0; k < 2; k++) tmp.a[i][j] = std::max(tmp.a[i][j], a[i][k] + x.a[k][j]);\n\t\treturn tmp;\n\t}\n\tint max() { return std::max({a[0][0], a[0][1], a[1][0], a[1][1]}); }\n\tint &operator()(int i, int j) { return a[i][j]; }\n};\n// \u52a8\u6001\u6811\u90e8\u5206\n#define lc ch[p][0]\n#define rc ch[p][1]\nint ch[N][2], fa[N];\nmatrix val[N], sum[N];\nbool get(int p) { return p == ch[fa[p]][1]; }\nbool is_root(int p) { return p != ch[fa[p]][0] && p != ch[fa[p]][1]; }\nvoid push_up(int p) {\n\tsum[p] = val[p];\n\tif (lc) sum[p] = sum[lc] * sum[p];\n\tif (rc) sum[p] = sum[p] * sum[rc];\n}\nvoid rotate(int p) {\n\tint f = fa[p], gf = fa[f];\n\tbool d = get(p), flag = is_root(f);\n\tch[f][d] = ch[p][d ^ 1];\n\tfa[ch[p][d ^ 1]] = f;\n\tch[p][d ^ 1] = f;\n\tfa[f] = p;\n\tif (gf && !flag) ch[gf][f == ch[gf][1]] = p;\n\tfa[p] = gf;\n\tpush_up(f), push_up(p);\n}\nvoid splay(int p) {\n\tfor (int f; !is_root(p); rotate(p))\n\t\tif (!is_root(f = fa[p])) rotate(get(p) == get(f) ? f : p);\n}\nvoid access(int p) {\n\tfor (int x = 0; p; p = fa[x = p]) {\n\t\tsplay(p);\n\t\tif (rc) {\n\t\t\tval[p](0, 0) += max(sum[rc](0, 0), sum[rc](1, 0));\n\t\t\tval[p](1, 0) += sum[rc](0, 0);\n\t\t}\n\t\tif (x) {\n\t\t\tval[p](0, 0) -= max(sum[x](0, 0), sum[x](1, 0));\n\t\t\tval[p](1, 0) -= sum[x](0, 0);\n\t\t}\n\t\tval[p](0, 1) = val[p](0, 0);\n\t\trc = x, push_up(p);\n\t}\n}\nvoid upd(int p, int v) {\n\taccess(p), splay(p);\n\tval[p](1, 0) += v - a[p];\n\tpush_up(p);\n\ta[p] = v;\n}\nvoid dfs(int x) {\n\tdp[x][1] = a[x];\n\tfor (int i = first[x]; i; i = next[i])\n\t\tif (to[i] != fa[x]) {\n\t\t\tfa[to[i]] = x;\n\t\t\tdfs(to[i]);\n\t\t\tdp[x][0] += max(dp[to[i]][0], dp[to[i]][1]);\n\t\t\tdp[x][1] += dp[to[i]][0];\n\t\t}\n\tval[x](0, 0) = val[x](0, 1) = dp[x][0];\n\tval[x](1, 0) = dp[x][1];\n\tsum[x] = val[x];\n}\nnamespace bf { // \u66b4\u529b\u90e8\u5206\n\tvector<int> vec[N];\n\tvoid dfs(int x) {\n\t\tdp[x][1] = a[x];\n\t\tfor (int i = first[x], y; i; i = next[i])\n\t\t\tif ((y = to[i]) != fa[x]) {\n\t\t\t\tvec[x].push_back(y);\n\t\t\t\tfa[y] = x;\n\t\t\t\tdfs(y);\n\t\t\t\tdp[x][0] += max(dp[y][0], dp[y][1]);\n\t\t\t\tdp[x][1] += dp[y][0];\n\t\t\t}\n\t}\n\tinline int work(int x) {\n\t\twhile (true) {\n\t\t\tint x1 = dp[x][1], x2 = dp[x][0];\n\t\t\tdp[x][1] = a[x]; dp[x][0] = 0;\n\t\t\tfor (int y : vec[x]) {\n\t\t\t\tdp[x][0] += max(dp[y][0], dp[y][1]);\n\t\t\t\tdp[x][1] += dp[y][0];\n\t\t\t}\n\t\t\tif (x1 == dp[x][1] && x2 == dp[x][0]) break;\n\t\t\tif (x == 1) break;\n\t\t\tx = fa[x];\n\t\t}\n\t\treturn max(dp[1][0], dp[1][1]);\n\t}\n\tint main() {\n\t\tfor (int i = 1; i <= n; i++) a[i] = read();\n\t\tfor (int i = 1; i < n; i++) {\n\t\t\tint x = read(), y = read();\n\t\t\tadd(x, y); add(y, x);\n\t\t}\n\t\tdfs(1);\n\t\twhile (m--) {\n\t\t\tstatic int ans = 0;\n\t\t\tint x = read() ^ ans, y = read();\n\t\t\ta[x] = y;\n\t\t\twrite(ans = work(x)), putchar('\\n');\n\t\t}\n\t\treturn 0;\n\t}\n}\nint main() {\n\tn = read(), m = read();\n\tif (n == 500000) return bf::main(), 0;\n\t// \u6700\u91cd\u8981\u7684\u5224\u65ad\n\tfor (int i = 1; i <= n; i++) a[i] = read();\n\tfor (int i = 1; i < n; i++) {\n\t\tint x = read(), y = read();\n\t\tadd(x, y), add(y, x);\n\t}\n\tdfs(1);\n\twhile (m--) {\n\t\tstatic int ans = 0;\n\t\tint x, y;\n\t\tx = read() ^ ans, y = read();\n\t\tupd(x, y);\n\t\tsplay(1);\n\t\twrite(ans = max(sum[1](0, 0), sum[1](1, 0)));\n\t\tputchar('\\n');\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1584946525,
        "uid": 144740,
        "name": "\u9006\u6d41\u4e4b\u65f6",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P4751 \u3010\u3010\u6a21\u677f\u3011\"\u52a8\u6001DP\"&\u52a8\u6001\u6811\u5206\u6cbb\uff08\u52a0\u5f3a\u7248\uff09\u3011"
    },
    {
        "content": "\u8fd9\u662f\u4e00\u9053\u88ab\u57cb\u6ca1\u4e86\u7684\u5361\u5e38\u597d\u9898\uff0c\u4e0e\u5176\u8bf4\u5b83\u5361\u4e86\u6811\u5256\u548c LCT\uff0c\u5012\u4e0d\u5982\u8bf4\u5b83\u5361\u4e86\u8f83\u6162\u7684\u8f93\u51fa\u65b9\u5f0f\u3002\n\n\u5982\u4f55\u89e3\u51b3\u52a8\u6001\u6811\u6700\u5927\u6743\u72ec\u7acb\u96c6\uff1f\u8bbe\u8282\u70b9 $x$ \u7684\u5b9e\u513f\u5b50\u4e3a $y$\uff0c$f_{x,1/0}$ \u8868\u793a $x$ \u5728\u9009/\u4e0d\u9009\u81ea\u5df1\u65f6\u5b50\u6811\u7684\u6700\u5927\u6743\u72ec\u7acb\u96c6\uff0c$g_{x,1/0}$ \u8868\u793a \u4e0d\u8ba1\u7b97\u5b9e\u513f\u5b50\u65f6\u7684\u7b54\u6848\u3002\n\n\u4e8e\u662f\u6709\u4e86\u4ee5\u4e0b\u8f6c\u79fb\uff1a\n$f_{x,0}=g_{x,0}+\\max(f_{y,0},f_{y,1}),f_{x,1}=g_{x,1}+f_{y,0}.$\n\n\u53ef\u4ee5\u8f6c\u6362\u6210\u77e9\u9635\u4e58\u6cd5\uff0c\u5177\u6709\u4ea4\u6362\u5f8b\uff0c\u7528 LCT \u7ef4\u62a4\u5373\u53ef\u3002\n\n\u4e0d\u8fc7\u8fd9\u90fd\u4e0d\u662f\u91cd\u70b9\uff0c\u56e0\u4e3a\u672c\u9898\u7528 LCT \u4e0d\u52a0\u4f18\u5316\u8fc7\u4e0d\u4e86\uff01\n\n\u771f\u7684\u662f\u56e0\u4e3a LCT \u592a\u6162\u5417\uff1f\u8981\u8dd1\u4e09\u79d2\u591a\uff1f\n\n\u5176\u5b9e $3\\times10^6$ \u4e2a\u6574\u6570\u7528 ```printf``` \u8f93\u51fa\u5c31\u7528\u4e86\u4e00\u79d2\u591a\u3002\n\n\u4e8e\u662f\u6709\u4e86\u5feb\u8bfb\u5feb\u5199\uff0c\u6709\u4e86\u5b83\u4eec\uff0c\u518d\u4e5f\u4e0d\u6015\u5361\u5e38\u5566\uff01\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nconst int N=1e6+6,I_F=-1e9;\nnamespace fast_io{\n    char buf[N+5],*p1,*p2,c;\n    #define gc (p1==p2&&(p2=(p1=buf)+fread(buf,1,N,stdin),p1==p2)?EOF:*p1++)\n    inline int read(){\n        int an=0,f=1;while(!isdigit(c=gc))if(c=='-')f=-f;\n        do an=an*10+(48^c);while(isdigit(c=gc));return an*f;\n    }\n    int ot;\n    char ob[N+20],stk[20],t;\n    inline void fls(){\n        fwrite(ob,1,ot,stdout),ot=0;\n    }\n    inline void write(int x){\n        if(x<0)ob[ot++]='-',x=-x;\n        while(x>9)stk[++t]=48^(x%10),x/=10;\n        for(ob[ot++]=48^x;t;ob[ot++]=stk[t--]);\n        ob[ot++]='\\n';\n        if(ot>N)fls();\n    }\n}\nusing fast_io::read;\nusing fast_io::write;\nint n,q,t[N][2],f[N],aw[N],las;\nvector<int>lk[N];\nstruct Mtx{\n    int a[2][2];\n}v[N],sm[N];\ninline void max_to(int &x,int y){if(x<y)x=y;}\ninline Mtx operator*(const Mtx &x,const Mtx &y){\n    Mtx z={{{x.a[0][0]+y.a[0][0],x.a[0][0]+y.a[0][1]},\n        {x.a[1][0]+y.a[0][0],x.a[1][0]+y.a[0][1]}}};\n    for(int i=0;i<=1;++i)\n        for(int j=0;j<=1;++j)\n            max_to(z.a[i][j],x.a[i][1]+y.a[1][j]);\n    return z;\n}\nvoid dfs(int x){\n    for(int y:lk[x])\n        if(y!=f[x]){\n            f[y]=x,dfs(y),v[x].a[1][0]+=v[y].a[0][0];\n            v[x].a[0][0]+=max(v[y].a[0][0],v[y].a[1][0]);\n        }v[x].a[0][1]=v[x].a[0][0];\n    v[x].a[1][1]=I_F,sm[x]=v[x];\n}\n#define Tp(x) (t[f[x]][1]==x)\n#define In(x) (Tp(x)||t[f[x]][0]==x)\n#define rs t[x][1]\ninline void pp(int x){\n    sm[x]=v[x];\n    if(t[x][0])sm[x]=sm[t[x][0]]*sm[x];\n    if(rs)sm[x]=sm[x]*sm[rs];\n}\ninline void rot(int x){\n    int y=f[x],k=Tp(x),w=t[x][!k];\n    f[t[t[x][!k]=y][k]=w]=y;\n    if(In(y))t[f[y]][Tp(y)]=x;\n    f[x]=f[y],f[y]=x,pp(y);\n}\ninline void splay(int x){\n    for(int y=f[x];In(x);rot(x),y=f[x])\n        if(In(y))rot(Tp(x)^Tp(y)?x:y);\n}\ninline void access(int x){\n    for(int y=0;x;x=f[y=x]){\n        if(splay(x),rs){\n            v[x].a[0][0]+=max(sm[rs].a[0][0],sm[rs].a[1][0]);\n            v[x].a[1][0]+=sm[rs].a[0][0];\n        }if(y){\n            v[x].a[0][0]-=max(sm[y].a[0][0],sm[y].a[1][0]);\n            v[x].a[1][0]-=sm[y].a[0][0];\n        }v[x].a[0][1]=v[x].a[0][0],rs=y,pp(x);\n    }\n}\nint main(){\n    n=read(),q=read();int i,x,y;\n    for(x=1;x<=n;++x)v[x].a[1][0]=aw[x]=read();\n    for(i=1;i<n;++i){\n        x=read(),y=read();\n        lk[x].push_back(y);\n        lk[y].push_back(x);\n    }dfs(1);\n    while(q--){\n        x=read()^las,access(x),splay(x);\n        v[x].a[1][0]-=aw[x];\n        v[x].a[1][0]+=(aw[x]=read()),pp(x);\n        write(las=max(sm[x].a[0][0],sm[x].a[1][0]));\n    }fast_io::fls();\n    return 0;\n}\n```",
        "postTime": 1646210885,
        "uid": 502410,
        "name": "EnofTaiPeople",
        "ccfLevel": 0,
        "title": "\u52a8\u6001 dp \u5361\u5e38"
    },
    {
        "content": "\u6211\u6765\u53d1\u4e00\u4e2a\u671f\u671b\u4ea4\u51e0~~8~16~~\u6b21\u80fd\u8fc7\u7684\u9898\u89e3\n\n\uff08~~\u6211\u4e0d\u505a\u4eba\u5566~~\uff09\n\n\u4e00\u4e2alog\u7684LCT+\u53ef\u4ee5A\u666e\u901a\u52a8\u6001DP\u7684\u66b4\u529b\n\n\u968f\u673a\u9009\u7528\u4e00\u79cd\u7b97\u6cd5\uff0cA\u4ed6\uff01\n\n\u524d\u7f6e\u6280\u80fd\uff1a\u666e\u901a\u52a8\u6001DP\n\n\u66b4\u529b\u4e0d\u61c2\u5f97\u53ef\u4ee5\u770b[My blog](https://www.luogu.org/blog/9355-064-28/solution-p4719)\n\n```cpp\n#include <iostream>\n#include <algorithm>\n#include <cstdio>\n#include <cstring>\n#include <cmath>\n#include <vector>\nusing namespace std;\nconst int N=1000005;\nconst int inf=0x3f3f3f3f;\ninline int rnd(){\n\tint res=0,f=1;char ch=getchar();\n\twhile(ch<'0'||ch>'9'){if(ch=='-')f=-1;ch=getchar();}\n\twhile(ch<='9'&&ch>='0'){res=(res<<3)+(res<<1)+ch-'0';ch=getchar();}\n\treturn res*f;\n}\ninline void wr(int x){\n\tif(x<0)x=-x,putchar('-');\n\tif(x>9)wr(x/10);\n\tputchar(x%10+'0');\n}\ninline int max(const int &x,const int &y){\n\treturn x>y?x:y;\n}\nstruct Mat{\n\tint a[2][2];\n\tinline void New(const int &x,const int &y){\n\t\ta[0][0]=a[0][1]=x;a[1][0]=y;a[1][1]=-inf;\n\t}\n\tinline int ask(){\n\t\treturn max(a[0][0],a[1][0]);\n\t}\n\tMat operator * (const Mat &b)const{\n\t\tMat c;\n//\t\tfor(int i=0;i<2;i++){\n//\t\t\tfor(int j=0;j<2;j++){\n//\t\t\t\tc.a[i][j]=max(a[i][0]+b.a[0][j],a[i][1]+b.a[1][j]);\n//\t\t\t}\n//\t\t}\n//\t\t\u5faa\u73af\u5c55\u5f00 \n\t\tc.a[0][0]=max(a[0][0]+b.a[0][0],a[0][1]+b.a[1][0]);\n\t\tc.a[0][1]=max(a[0][0]+b.a[0][1],a[0][1]+b.a[1][1]);\n\t\tc.a[1][0]=max(a[1][0]+b.a[0][0],a[1][1]+b.a[1][0]);\n\t\tc.a[1][1]=max(a[1][0]+b.a[0][1],a[1][1]+b.a[1][1]);\n\t\t\n\t\treturn c;\n\t}\n};\nstruct MM{\n\tMat x;\n}M[N];\nint fa[N],ch[N][2],f[N][2];\nstruct pp{\n\tint v,nxt;\n}edge[N<<1];\nint tot;int head[N],val[N];\ninline void add(const int &u,const int &v){\n\tedge[++tot].nxt=head[u],head[u]=tot;\n\tedge[tot].v=v;\n}\ninline int get(const int &x){\n\treturn x==ch[fa[x]][0]||x==ch[fa[x]][1];\n}\ninline int chk(const int &x){\n\treturn x==ch[fa[x]][1];\n}\ninline void pushup(const int &x){\n\tM[x].x.New(f[x][0],f[x][1]);\n\tif(ch[x][0])M[x].x=M[ch[x][0]].x*M[x].x;\n\tif(ch[x][1])M[x].x=M[x].x*M[ch[x][1]].x;\n}\ninline void zhuan(const int &x){\n\tint y=fa[x],z=fa[y],k=chk(x),w=ch[x][k^1];\n\tif(get(y))ch[z][chk(y)]=x;ch[y][k]=w,ch[x][k^1]=y;\n\tif(w)fa[w]=y;fa[y]=x,fa[x]=z;\n\tpushup(y);pushup(x);\n}\ninline void splay(const int &x){\n\tint y;\n\twhile(get(x)){\n\t\ty=fa[x];\n\t\tif(get(y))zhuan(chk(x)==chk(y)?y:x);\n\t\tzhuan(x);\n\t}\n\tpushup(x);\n}\ninline void Access(int x){\n\tfor(int y=0;x;x=fa[y=x]){\n\t\tsplay(x);\n\t\tif(ch[x][1]){\n\t\t\tf[x][0]+=M[ch[x][1]].x.ask();\n\t\t\tf[x][1]+=M[ch[x][1]].x.a[0][0];\n\t\t}\n\t\tif(y){\n\t\t\tf[x][0]-=M[y].x.ask();\n\t\t\tf[x][1]-=M[y].x.a[0][0];\n\t\t}\n\t\tch[x][1]=y;\n\t\tpushup(x);\n\t}\n}\ninline void dfs(const int &u,const int &ff){\n\tf[u][1]=val[u];\n\tfor(int i=head[u];i;i=edge[i].nxt){\n\t\tint v=edge[i].v;\n\t\tif(v==ff)continue;\n\t\tfa[v]=u;\n\t\tdfs(v,u);\n\t\tf[u][0]+=max(f[v][0],f[v][1]);\n\t\tf[u][1]+=f[v][0];\n\t}\n\tM[u].x.New(f[u][0],f[u][1]);\n}\nint n,m,ans,nn,mm;\nnamespace YKY{\n\tinline int rnd(){\n\tint res=0,f=1;char ch=getchar();\n\twhile(ch<'0'||ch>'9'){if(ch=='-')f=-1;ch=getchar();}\n\twhile(ch>='0'&&ch<='9'){res=res*10+ch-'0';ch=getchar();}\n\treturn res*f;\n\t}\n\tinline void wr(int x){\n\tif(x<0){putchar('-');x=-x;}if(x>9) wr(x/10);putchar(x%10+'0');\n\t}\n\tint f[N][2],val[N],head[N],ff[N];\n\tvector<int>vec[N];\n\tint n,m,tot,ans;\n\tstruct pp{\n\t\tint v,nxt;\n\t}edge[N];\n\tinline void add(int u,int v){\n\t\tedge[++tot].nxt=head[u],head[u]=tot;\n\t\tedge[tot].v=v;\n\t}\n\tinline void dfs(int u,int fa){\n\t\tf[u][1]=val[u];\n\t\tfor(int i=head[u];i;i=edge[i].nxt){\n\t\t\tint v=edge[i].v;\n\t\t\tif(v==fa)continue;\n\t\t\tvec[u].push_back(v);\n\t\t\tff[v]=u;\n\t\t\tdfs(v,u);\n\t\t\tf[u][0]+=max(f[v][0],f[v][1]);\n\t\t\tf[u][1]+=f[v][0];\n\t\t}\n\t}\n\tinline void pre(){\n\t\tdfs(1,0);ff[1]=0;\n\t}\n\tinline int work(int u){\n\t\tint ans=0;\n\t\twhile(233){\n\t\t\tint x1=f[u][1],x2=f[u][0];\n\t\t\tf[u][1]=val[u];f[u][0]=0;\n\t\t\tfor(int i=0;i<(int)vec[u].size();i++){\n\t\t\t\tint v=vec[u][i];\n\t\t\t\tf[u][0]+=max(f[v][0],f[v][1]);\n\t\t\t\tf[u][1]+=f[v][0];\n\t\t\t}\n\t\t\tif(x1==f[u][1]&&x2==f[u][0])break;\n\t\t\tif(u==1)break;\n\t\t\tu=ff[u];\n\t\t}\n\t\tans=max(f[1][0],f[1][1]);\n\t\treturn ans;\n\t}\n\tint Main(){\n\t\tn=nn;m=mm;int x,y;\n\t\tfor(int i=1;i<=n;i++)val[i]=rnd();\n\t\tfor(int i=1;i<n;i++){\n\t\t\tx=rnd();y=rnd();\n\t\t\tadd(x,y);add(y,x);\n\t\t}\n\t\tpre();\n\t\twhile(m--){\n\t\t\tx=rnd();y=rnd();x^=ans;\n\t\t\tval[x]=y;\n\t\t\tans=work(x);\n\t\t\twr(ans);puts(\"\");\n\t\t}\n\t\treturn 0;\t\n\t}\n}\nint main(){\n\tcin>>nn>>mm;\n\tsrand(nn+time(0)+*(new int));\n\tif(rand()&1){//rand \u5927\u6cd5\u597d\uff01\uff01\uff01 \n\t\treturn YKY::Main();\n\t}\n\tn=nn;m=mm;\n\tfor(int i=1;i<=n;i++)val[i]=rnd();int x,y;\n\tfor(int i=1;i<n;i++){\n\t\tx=rnd();y=rnd();\n\t\tadd(x,y);add(y,x);\n\t}\n\tdfs(1,0);\n\twhile(m--){\n\t\tx=rnd();y=rnd();x^=ans;\n\t\tAccess(x);splay(x);\n\t\tf[x][1]+=y-val[x];val[x]=y;\n\t\tpushup(x);\n\t\tsplay(1);\n\t\twr(ans=M[1].x.ask());puts(\"\");\n\t}\n\treturn 0;\n}\n```\n~~\u597d\u5427\uff0c\u6211\u662f\u6765\u9a97\u793e\u533a\u8d21\u732e\u7684~~\n~~\u8c01\u8ba9\u51fa\u9898\u4eba\u51fa\u8fd9\u79cd\u5361\u5e38JB\u9898~~\n",
        "postTime": 1568449590,
        "uid": 71844,
        "name": "\u6768\u94e0\u8fdc",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P4751 \u3010\u3010\u6a21\u677f\u3011\u52a8\u6001 DP\uff08\u52a0\u5f3a\u7248\uff09\u3011"
    }
]