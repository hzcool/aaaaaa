[
    {
        "content": "\u6211\u4eec\u5c06\u7b54\u6848\u62c6\u6210\u4e09\u90e8\u5206\uff0c\u524dk\u4e2a\u6570\u5185\u90e8\u7684\u8fde\u7eed\u6bb5\uff0c\u540en-k\u4e2a\u6570\u7684\u5185\u90e8\u7684\u8fde\u7eed\u6bb5\uff0c\u8de8\u8d8a\u4e86\u7b2ck\u4e2a\u6570\u7684\u8fde\u7eed\u6bb5\u3002\n\n\u7b2c1\u90e8\u5206\u662f\u7ecf\u5178\u95ee\u9898\uff0c\u4e0d\u4f1a\u7684\u5efa\u8bae\u5148\u505a\u522b\u7684\u9898\u6bd4\u5982 https://www.luogu.com.cn/problem/P4747\u3002\n\n\u4e4b\u540e\u4e00\u4e2a\u7ed3\u8bba\u662f\uff0c\u8003\u8651\u524dk\u4e2a\u6570\u5c06\u503c\u57df\u5206\u4e3a\u7684\u82e5\u5e72\u6bb5\uff0c\u5219\u540c\u4e00\u6bb5\u5185\u7684\u6570\u5728\u6700\u7ec8\u6392\u5217\u4e2d\u90fd\u662f\u76f8\u90bb\u7684\u3002\u4e25\u683c\u7684\u8bc1\u660e\u8fd9\u91cc\u6ca1\u6709\u56e0\u4e3a\u6211\u61d2\u5f97\u60f3\u3002\n\n\u6709\u4e86\u8fd9\u4e2a\u7ed3\u8bba\u540e\uff0c\u540en-k\u4e2a\u6570\u7684\u5185\u90e8\u7684\u8fde\u7eed\u6bb5\u6570\u91cf\u5df2\u7ecf\u53ef\u4ee5\u7b97\u51fa\u6765\u4e86\uff0c\u53ea\u6709\u8de8\u8d8a\u7684\u90e8\u5206\u6bd4\u8f83\u68d8\u624b\u3002\n\n\u8003\u8651\u4ecek\u52301 DP\u8ba1\u7b97\uff0c\u4e00\u4e2a\u6027\u8d28\u662f\uff0c\u5bf9\u4e8e\u4efb\u610f $1 \\le i \\le k$\uff0c\u8bb0 $L=min_{l=i}^{k}p_l,R=max_{l=i}^{k}p_l$ \u4e00\u5b9a\u5b58\u5728 $k \\le j \\le n$\uff0c\u4f7f\u5f97 $[i,j]$\u6784\u6210\u8fde\u7eed\u6bb5\uff0c\u4e14 $R=max_{l=i}^{j}p_l$\uff0c$L=min_{l=i}^{j}p_l$\uff0c\u76f4\u89c2\u63cf\u8ff0\u5c31\u662f\u503c\u57df\u533a\u95f4 $[L,R]$ \u5185\u7684\u7a7a\u6d1e\u4e00\u5b9a\u88ab\u586b\u6ee1\u4e86\u3002\n\n\u4e4b\u540e\u4e00\u4e2a\u6027\u8d28\u662f\u4e3a\u4e86\u4fbf\u4e8e\u6211\u4eecDP\u8ba1\u7b97\u800c\u53d1\u6398\u7684\u3002\u5c31\u662f\u5982\u679cL-1\u6ca1\u6709\u51fa\u73b0\u5728\u524dk\u4e2a\u6570\u4e2d\uff0c\u5219L-1\u6240\u5904\u7684\u6781\u957f\u672a\u51fa\u73b0\u5728\u524dk\u4e2a\u6570\u4e2d\u7684\u503c\u57df\u8fde\u7eed\u6bb5\u4e00\u5b9a\u662f\u9012\u51cf\u6392\u5e03\u7684\uff1b\u540c\u6837\u7684R+1\u82e5\u6ca1\u51fa\u73b0\uff0c\u5219\u5176\u6240\u5904\u7684\u6781\u957f\u6bb5\u4e00\u5b9a\u9012\u589e\u6392\u5e03\u7684\u3002\n\n\u4e8e\u662f\uff0c\u5bf9\u4e8ei\u4e2a\u4f4d\u7f6e\u7684\u8d21\u732e\uff0c\u552f\u4e00\u6709\u51b3\u7b56\u5fc5\u8981\u7684\u5c31\u662fL-1\u548cR+1\u6240\u5904\u6781\u957f\u6bb5\u7684\u60c5\u51b5\u3002\u8fd9\u6837\u6211\u4eec\u5c31\u5f97\u5230\u4e86DP\u72b6\u6001 $f_{i,s1,s2}$  \u7528\u4ee5\u8bb0\u5f55\u6240\u6709\u53ef\u80fd\u533a\u95f4 $[k+1,j]$ \u5185\u4efb\u610f\u653e\u7f6e\u5143\u7d20\uff0c\u914d\u5408\u533a\u95f4 $[i,k]$ \u4ea7\u751f\u7684\u6700\u5927\u8d21\u732e\uff0c\u5176\u4e2d $s_1,s_2 \\in \\{0,1,2\\}$ \u5206\u522b\u8bb0\u5f55\u5de6/\u53f3\u6781\u957f\u6bb5\u7684\u60c5\u51b5\uff0c0\u8868\u793a\u672a\u9009\u4e2d\uff0c1\u8868\u793a\u662f\u6700\u540e\u4e00\u4e2a\u88ab\u9009\u4e2d\uff0c2\u8868\u793a\u88ab\u9009\u4e2d\u4e14\u4e0d\u662f\u6700\u540e\u4e00\u4e2a\uff0c\u8fd9\u91cc\u9009\u4e2d\u5b9a\u4e49\u4e3a\u51fa\u73b0\u5728 $[k+1,j]$ \u4e2d\u3002\n\n## \u8f6c\u79fb\u7684\u7ec6\u8282\n\n\u5177\u4f53\u5b9e\u73b0\u53ef\u4ee5\u89c1\u540e\u6587\u4ee3\u7801\u90e8\u5206\u4e2d\u7b2c\u4e00\u4e2a `for(i=k;i;--i)` \u7684\u5faa\u73af\u5185\u90e8\u3002\n\n\u65b9\u4fbf\u8d77\u89c1\uff0c\u6211\u4eec\u53ea\u8003\u8651 $L,R$ \u53d1\u751f\u53d8\u5316\u7684\u4f4d\u7f6e $i$\u3002\u8bb0\u4e0a\u4e00\u4e2a\u4f4d\u7f6e\u4e3aii\u3002\n\n\u4e00\u4e2a\u6027\u8d28\u662f $[\u8f6c\u79fb\u524d\u540e\u5de6\u6781\u957f\u6bb5\u76f8\u540c]+[\u8f6c\u79fb\u524d\u540e\u53f3\u6781\u957f\u6bb5\u76f8\u540c]=1$\uff0c\u56e0\u4e3aii\u5230i $L,R$ \u6070\u597d\u6709\u4e00\u4e2a\u53d1\u751f\u53d8\u5316\u3002\n\n### \u5254\u9664\u975e\u6cd5\u72b6\u6001\u4e0e\u8f6c\u79fb\n\n\u9996\u5148\u8981\u5254\u9664\u4e00\u4e9b\u975e\u6cd5\u72b6\u6001\u3002\u6839\u636e\u5b9a\u4e49 $s_1,s_2$ \u4e0d\u80fd\u540c\u65f6\u4e3a1\uff0c\u65b9\u4fbf\u8d77\u89c1\u6211\u4eec\u5f3a\u5236\u8981\u6c42 $s_1 \\neq 0$ \u65f6\u5de6\u6781\u957f\u6bb5\u5fc5\u987b\u975e\u7a7a\uff0c$s_2$ \u4e5f\u662f\u3002\u8fd9\u90e8\u5206\u53ef\u4ee5\u89c1\u4ee3\u7801\u7b2c55-57\u884c\u3002\n\n\u8fd8\u8981\u5254\u9664\u4e00\u4e9b\u975e\u6cd5\u8f6c\u79fb\u3002\n\n\u5982\u679c\u8f6c\u79fb\u524d\u540e\u5de6\u6781\u957f\u6bb5\u76f8\u540c\uff0c\u5e76\u4e14\u5728ii\u7684\u72b6\u6001\u4e2d $s_1=2$\uff08\u88ab\u5176\u5b83\u4e1c\u897f\u76d6\u4f4f\u4e86\uff09\uff0c\u90a3\u4e48\u5728i\u7684\u72b6\u6001\u4e2d\uff0c$s_1$ \u5c31\u4e0d\u80fd\u4e3a1\u3002\u8fd9\u90e8\u5206\u53ef\u4ee5\u89c1\u4ee3\u7801\u7b2c58\u884c\u3002\n\n\u5982\u679c\u8f6c\u79fb\u524d\u540e\u5de6\u6781\u957f\u6bb5\u76f8\u540c\uff0c\u5e76\u4e14\u5728ii\u7684\u72b6\u6001\u4e2d $s_1 \\neq 0$\uff08\u5df2\u9009\u4e2d\uff09\uff0c\u90a3\u4e48\u5728i\u7684\u72b6\u6001\u4e2d\uff0c$s_1$ \u5c31\u4e0d\u80fd\u4e3a0\u3002\u8fd9\u90e8\u5206\u53ef\u4ee5\u89c1\u4ee3\u7801\u7b2c61\u884c\u3002\n\n\u5982\u679c\u8f6c\u79fb\u524d\u540e\u5de6\u6781\u957f\u6bb5\u76f8\u540c\uff0c\u5e76\u4e14\u5728\u8f6c\u79fb\u524d\u540e $s1$ \u5747\u4e3a1\uff0c\u5c31\u8981\u597d\u597d\u8ba8\u8bba\u4e86\u3002\u6b64\u65f6\u8f6c\u79fb\u5408\u6cd5\u5f53\u4e14\u4ec5\u5f53\u5de6\u6781\u957f\u6bb5\u53ef\u4ee5\u76f4\u63a5\u7ee7\u627f\u800c\u65e0\u9700\u5728\u4e2d\u95f4\u63d2\u5165\u5176\u5b83\u4e1c\u897f\u3002\u5982\u679ci\u7684\u72b6\u6001\u7684 $s_2=2$\uff0c\u5219\u53f3\u6781\u957f\u8fde\u7eed\u6bb5\u4e00\u5b9a\u662f\u65b0\u76d6\u4f4f\u7684\uff0c\u8fd9\u662f\u4e00\u79cd\u975e\u6cd5\u60c5\u51b5\u3002\u53e6\u4e00\u79cd\u975e\u6cd5\u60c5\u51b5\u662f\uff0cR\u53d8\u5927\u65f6\u53ef\u80fd\u4f1a\u5bfc\u81f4\u65b0\u7684\u503c\u57df\u7a7a\u6d1e\u4ea7\u751f\uff0c\u5982\u679c\u9700\u8981\u586b\u5751\uff0c\u90a3\u4e48\u4e5f\u662f\u4e00\u79cd\u975e\u6cd5\u60c5\u51b5\u3002\u6211\u4eec\u7ef4\u62a4\u4e00\u4e2a\u524d\u7f00\u548c\u6570\u7ec4 `ss2` \u7528\u4e8e\u7ef4\u62a4\u4e00\u6bb5\u533a\u95f4\u4e2d\u5751\u7684\u6570\u91cf\uff0c\u7136\u540e\u5224\u4e00\u4e0b\u5728ii\u7684\u72b6\u6001\u4e2d\u5df2\u7ecf\u586b\u4e0a\u7684\u5751\u7684\u6570\u91cf\u2014\u2014\u8fd9\u7b49\u4e8eii\u7684\u72b6\u6001\u4e2d $[s_2=2]$\u3002\u8fd9\u90e8\u5206\u53ef\u4ee5\u89c1\u4ee3\u7801\u7b2c59-60\u884c\u3002\n\n\u5982\u679c\u53f3\u6781\u957f\u6bb5\u76f8\u540c\uff0c\u5bf9\u79f0\u5730\u8ba8\u8bba\u5373\u53ef\u3002\n\n### \u8ba1\u7b97\u8f6c\u79fb\u7684\u6743\u503c\u3002\n\n\u9996\u5148\u8981\u8003\u8651 $[L,R]$ \u662f\u5426\u53ef\u4ee5\u6784\u6210\u8fde\u7eed\u6bb5\uff0c\u4ea6\u5373 $[L,R]$ \u4e2d\u6ca1\u6709\u6d1e\uff0c\u4e14\u6ca1\u6709\u5de6\u53f3\u6781\u957f\u6bb5\u4ea7\u751f\u5e72\u6270\u3002\n\n\u5982\u679c\u8f6c\u79fb\u524d\u540e\u5de6\u6781\u957f\u6bb5\u76f8\u540c\uff0c\u5219\u53ea\u9700\u68c0\u67e5ii\u7684\u72b6\u6001\u4e2d $s_1=2$ \uff0c\u6216\u8005 $s_1=1$ \u4e14\u5728\u8f6c\u79fb\u5230i\u7684\u8fc7\u7a0b\u4e2d\u88ab\u76d6\u4e0a\u4e86\u2014\u2014\u8fd9\u5728\u524d\u9762\u5224\u201c\u8f6c\u79fb\u524d\u540e $s1$ \u5747\u4e3a1\u201d\u7684\u65f6\u5019\u5df2\u7ecf\u8ba8\u8bba\u8fc7\u4e86\u3002\u8fd9\u90e8\u5206\u53ef\u4ee5\u89c1\u4ee3\u7801\u7b2c69-72\u884c\u3002\n\n\u53f3\u6781\u957f\u6bb5\u540c\u7406\u3002\n\n\u4e4b\u540e\u8981\u8003\u8651\u7684\u662f\u5de6\u53f3\u6781\u957f\u6bb5\u7684\u8d21\u732e\uff0c\u524d\u9762\u5df2\u7ecf\u7ed9\u4e86\u90a3\u4e48\u591a\u8ba8\u8bba\u7684\u793a\u8303\u4e86\uff0c\u8fd9\u91cc~~\u6211\u5c31\u5495\u5495\u5495\u4e86~~\u5c31\u7559\u7ed9\u8bfb\u8005\u81ea\u884c\u601d\u8003\u4e86\uff0c\u9700\u8981\u63d0\u9192\u7684\u662f\u8d21\u732e\u503c\u53ef\u80fd\u7b49\u4e8e\u6781\u957f\u6bb5\u957f\u5ea6\uff0c\u4e5f\u53ef\u80fd\u7b49\u4e8e1\uff0c\u9700\u8981\u4ed4\u7ec6\u5206\u6790\u3002\u8fd9\u90e8\u5206\u53ef\u4ee5\u89c1\u4ee3\u7801\u7b2c78-80\u884c\u3002\n\n\u6700\u540e\u6784\u65b9\u6848\u662f\u7b80\u5355\u7684\uff0c\u8bb0\u4e0b\u6bcf\u4e2a\u72b6\u6001\u7684\u524d\u9a71\u5373\u53ef\uff0c\u5f80\u524d\u8d70\u7684\u65f6\u5019\u770b\u4e0b\u5de6\u53f3\u6781\u957f\u6bb5\u600e\u4e48\u653e\u5373\u53ef\u3002\n\n\u4e0b\u9762\u662floj\u4e0a\u7684AC\u4ee3\u7801\uff0c\u5b83\u5728\u6d1b\u8c37\u4e0a\u8fd8\u5728judging\u3002\n\n```C++\n#include <bits/stdc++.h>\nusing namespace std;\ntypedef long long ll;\ninline ll C2(int x){return 1ll*x*(x+1)>>1;}\nconst int N=2e5+5;\nint n,k,i,ii,j,l,p[N],ip[N],mn[N],mx[N],ss[N],ss2[N],prr[N],sf[N],st1[N],st2[N],tp,pr[N];\nll C1,f[N][9];int pre[N][9];\nnamespace N1{\nstruct info{int v,c;};\ninline info uni(const info&a,const info&b){\n\tstatic info c;c.v=max(a.v,b.v);\n\tc.c=(a.v==c.v?a.c:0)+(b.v==c.v?b.c:0);return c;\n}\nconst info E=info{-(1<<25),0};\nstruct node{\n\tint ad,lb,rb,md;info s;\n}t[N*3];\ninline void upd(int i){t[i].s=uni(t[i<<1].s,t[i<<1|1].s);t[i].s.v+=t[i].ad;}\nvoid build(int i,int l,int r){\n\tt[i]=node{0,l,r,l+r>>1,0,r-l+1};if(l==r)return;\n\tbuild(i<<1,l,t[i].md);build(i<<1|1,t[i].md+1,r);\n}\nvoid mdy(int i,int l,int r,int v){\n\tif(l<=t[i].lb && t[i].rb<=r){t[i].ad+=v;t[i].s.v+=v;return;}\n\tif(l<=t[i].md)mdy(i<<1,l,r,v);if(t[i].md<r)mdy(i<<1|1,l,r,v);upd(i);\n}\ninfo ask(int i,int l,int r){\n\tif(l<=t[i].lb && t[i].rb<=r)return t[i].s;\n\tinfo ret=uni(l<=t[i].md?ask(i<<1,l,r):E,t[i].md<r?ask(i<<1|1,l,r):E);\n\tret.v+=t[i].ad;return ret;\n}\ninline void main(){\n\tbuild(1,1,n);\n\tfor(i=1;i<=k;++i){\n\t\tmdy(1,1,i,-1);\n\t\tif(ip[p[i]-1])mdy(1,1,ip[p[i]-1],1);\n\t\tif(ip[p[i]+1])mdy(1,1,ip[p[i]+1],1);\n\t\tinfo u=ask(1,1,i);C1+=u.v==-1?u.c:0;\n\t\tip[p[i]]=i;\n\t}\n}\n}\nint main(){\n\tscanf(\"%d%d\",&n,&k);for(i=1;i<=k;++i)scanf(\"%d\",p+i),ss[p[i]]=1;\n\tfor(i=1;i<=n;++i)ss[i]+=ss[i-1];\n\tmn[k]=mx[k]=p[k];for(i=k-1;i;--i)mn[i]=min(mn[i+1],p[i]),mx[i]=max(mx[i+1],p[i]);\n\tN1::main();\n\tfor(i=1;i<=n;++i)pr[i]=ip[i]?0:pr[i-1]+1;for(i=n;i;--i)sf[i]=ip[i]?0:sf[i+1]+1;\n\tfor(i=1;i<=n;++i)if(!ip[i] && (i==1 || ip[i-1]))C1+=C2(sf[i]),ss2[i]=1;\n\tfor(i=1;i<=n;++i)ss2[i]+=ss2[i-1];\n\tfor(i=k;i;--i)if(mn[i]!=mn[i-1] || mx[i]!=mx[i-1]){\n\t\tfor(ii=i;mn[i]==mn[ii] && mx[i]==mx[ii];++ii);prr[i]=ii;\n\t\tfor(j=0;j<9;++j)for(l=0;l<9;++l){\n\t\t\tint Lj=j%3,Rj=j/3,Ll=l%3,Rl=l/3;\n\t\t\tif(Lj==1 && Rj==1)continue;if(Ll==1 && Rl==1)continue;\n\t\t\tif(Lj && !pr[mn[i]-1])continue;if(Rj && !sf[mx[i]+1])continue;\n\t\t\tif(Ll && !pr[mn[ii]-1])continue;if(Rl && !sf[mx[ii]+1])continue;\n\t\t\tif(mn[i]==mn[ii] && Lj==1 && Ll==2)continue;\n\t\t\tif(mn[i]==mn[ii] && Ll==1 && Lj==1 && (Rj==2\n\t\t\t\t || ss2[mx[i]-1]-ss2[mx[ii]]>(Rl==0 || !sf[mx[ii]+1]?0:1)))continue;\n\t\t\tif(mn[i]==mn[ii] && !Lj && Ll)continue;\n\t\t\tif(mx[i]==mx[ii] && Rj==1 && Rl==2)continue;\n\t\t\tif(mx[i]==mx[ii] && Rl==1 && Rj==1 && (Lj==2 \n\t\t\t\t || ss2[mn[ii]-1]-ss2[mn[i]]>(Ll==0 || !pr[mn[ii]-1]?0:1)))continue;\n\t\t\tif(mx[i]==mx[ii] && !Rj && Rl)continue;\n\t\t\tll nv=f[ii][l];\n\t\t\tif(ss[mx[i]]-ss[mn[i]-1]==k-i+1){\n\t\t\t\tint zz=mx[i]-mn[i]>k-i;\n\t\t\t\tif(mn[i]==mn[ii]){\n\t\t\t\t\tif(Ll==2)zz=0;\n\t\t\t\t\tif(Ll==1 && ss2[mx[i]-1]-ss2[mx[ii]]>(Rl==2?1:0))zz=0;\n\t\t\t\t}\n\t\t\t\tif(mx[i]==mx[ii]){\n\t\t\t\t\tif(Rl==2)zz=0;\n\t\t\t\t\tif(Rl==1 && ss2[mn[ii]-1]-ss2[mn[i]]>(Ll==2?1:0))zz=0;\n\t\t\t\t}\n\t\t\t\tnv+=zz;\n\t\t\t\tif(Lj==1 || (Lj==2 && (mn[i]==mn[ii]?Ll==0\n\t\t\t\t\t\t|| (Ll==1 && ss2[mx[i]-1]-ss2[mx[ii]]<=(Rl==2?1:0)):1)))nv+=pr[mn[i]-1];\n\t\t\t\t\telse if(Lj)nv++;\n\t\t\t\tif(Rj==1 || (Rj==2 && (mx[i]==mx[ii]?Rl==0\n\t\t\t\t\t\t|| (Rl==1 && ss2[mn[ii]-1]-ss2[mn[i]]<=(Ll==2?1:0)):1)))nv+=sf[mx[i]+1];\n\t\t\t\t\telse if(Rj)nv++;\n\t\t\t}\n\t\t\tif(nv>f[i][j])f[i][j]=nv,pre[i][j]=l;\n\t\t}\n\t}\n\tll mxx=-N;int id;for(i=0;i<9;++i)if(f[1][i]>mxx)mxx=f[1][i],id=i;\n\tprintf(\"%lld\\n\",mxx+C1);\n\tfor(i=1;i<=k;)st1[++tp]=i,st2[tp]=id,id=pre[i][id],i=prr[i];\n\tfor(i=k;tp;--tp){\n\t\tint x=st1[tp],y=st1[tp+1];\n\t\tif(y){\n\t\t\tif(mn[x]<mn[y]){for(j=mn[y]-1;j>mn[x];--j)if(!ip[j])p[++i]=j;}\n\t\t\t\telse for(j=mx[y]+1;j<mx[x];++j)if(!ip[j])p[++i]=j;\n\t\t}\n\t\tauto pushR=[&](){\n\t\t\tif(st2[tp]/3 && (mx[x]!=mx[y] || !(st2[tp+1]/3)))\n\t\t\t\tfor(j=mx[x]+1;j<=n && !ip[j];++j)p[++i]=j,ip[j]=-1;\n\t\t};\n\t\tauto pushL=[&](){\n\t\t\tif(st2[tp]%3 && (mn[x]!=mn[y] || !(st2[tp+1]%3)))\n\t\t\t\tfor(j=mn[x]-1;j && !ip[j];--j)p[++i]=j,ip[j]=-1;\n\t\t};\n\t\tif(st2[tp]/3==1)pushL(),pushR();\n\t\t\telse pushR(),pushL();\n\t}\n\tfor(i=1;i<=n;++i)printf(\"%d%c\",p[i],i==n?'\\n':' ');\n}\n```\n\n\n\n\n\n\n\n",
        "postTime": 1611188773,
        "uid": 19567,
        "name": "zx2003",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P6795 \u3010[SNOI2020] \u6392\u5217\u3011"
    },
    {
        "content": "\u622a\u81f3 2023.5.16 \u53ea\u80fd\u627e\u5230\u4e00\u7bc7 dp \u9898\u89e3\uff0c\u8fd9\u5927\u6982\u662f\u7b2c\u4e00\u7bc7\u8d2a\u5fc3\u9898\u89e3\u3002\n\n\u8bbe $b_{1\\dots m}$ \u662f $a_{1\\dots m}$ \u79bb\u6563\u5316\u540e\u7684\u7ed3\u679c\u3002\n\n\u8fdb\u884c\u4e00\u4e9b\u57fa\u672c\u7684\u5206\u6790\u53ef\u4ee5\u5f97\u5230\uff1a\n\n\u7ed3\u8bba $1$\uff1a\u5982\u679c $[l,r]$ \u4e2d\u7684\u6240\u6709\u6570\u90fd\u4e0d\u5728 $a_{1\\dots m}$ \u4e2d\uff0c\u90a3\u4e48 $[l,r]$ \u4e2d\u7684\u6570\u5728 $a$ \u4e2d\u4e00\u5b9a\u7ec4\u6210\u4e86\u4e00\u4e2a\u8fde\u7eed\u6bb5\u3002\n\n\u7ed3\u8bba $2$\uff1a\u5982\u679c $b_{l\\dots m}$ \u662f\u4e00\u4e2a\u8fde\u7eed\u6bb5\uff0c\u90a3\u4e48\u4e00\u5b9a\u5b58\u5728 $r\\in (m,n]$ \u6ee1\u8db3 $a_{l\\dots r}$ \u662f\u4e00\u4e2a\u8fde\u7eed\u6bb5\u3002\n\n\u6839\u636e\u7ed3\u8bba $1$ \u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u786e\u5b9a $a_{m+1\\dots n}$ \u4e2d\u7684\u8fde\u7eed\u6bb5\u4e2a\u6570\u3002\u800c $a_{1\\dots m}$ \u4e2d\u7684\u8fde\u7eed\u6bb5\u4e2a\u6570\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811\u8ba1\u7b97\u51fa\u6765\u3002\u56e0\u6b64\u6211\u4eec\u53ea\u9700\u8981\u8003\u8651\u8de8\u8fc7\u4e24\u6bb5\u7684\u8fde\u7eed\u6bb5\u4e2a\u6570\u5373\u53ef\u3002\n\n\u7ed3\u8bba $2$ \u5df2\u7ecf\u786e\u5b9a\u4e86\u4e00\u90e8\u5206\u8d21\u732e\uff0c\u6211\u4eec\u9700\u8981\u8ba1\u7b97\u5269\u4f59\u90e8\u5206\u7684\u6700\u5927\u8d21\u732e\u3002\n\n\u8bbe $pre_i$ \u548c $suf_i$ \u5206\u522b\u8868\u793a $i$ \u524d\u9762\u548c\u540e\u9762\u7b2c\u4e00\u4e2a\u5728 $a_{1\\dots m}$ \u4e2d\u7684\u6570\u3002\u5982\u679c $pre_i$ \u4e0d\u5b58\u5728\u5219\u8bbe\u5176\u4e3a $0$\uff0c\u5982\u679c $suf_i$ \u4e0d\u5b58\u5728\u5219\u8bbe\u5176\u4e3a $n+1$\u3002\n\n\u8003\u8651 $b_{1\\dots m}$ \u7684\u6bcf\u4e2a\u540e\u7f00\u8fde\u7eed\u6bb5\uff0c\u8bbe\u5171\u6709 $c$ \u4e2a\uff0c\u4e14\u4ece\u540e\u5f80\u524d\u7b2c $i$ \u4e2a\u7684\u503c\u57df\u4e3a $[l_i,r_i]$\u3002\n\n\u4e00\u4e2a\u57fa\u672c\u7684\u601d\u8def\u662f\u4ece $[l_1,r_1]$ \u5f00\u59cb\u4f9d\u6b21\u6269\u5c55\u5230 $[l_c,r_c]$\uff0c\u6bcf\u6b21\u5c06\u5de6\u8fb9\u8981\u8865\u4e0a\u7684\u6570\u4ece\u5927\u5f80\u5c0f\u586b\uff0c\u5c06\u53f3\u8fb9\u8981\u8865\u4e0a\u7684\u6570\u4ece\u5c0f\u5f80\u5927\u586b\u3002\u4f46\u8fd9\u6837\u53ef\u80fd\u4e0d\u4f18\u3002\n\n\u5982\u679c $l_i=l_{i+1}$\uff0c\u6709\u53ef\u80fd\u662f\u5728\u6269\u5c55\u5230 $[l_{i+1},r_{i+1}]$ \u4e4b\u524d\u5c31\u5c06 $(pre_{l_i},l_i)$ \u4e2d\u7684\u6570\u5148\u586b\u4e0a\u3002\n\n\u8003\u8651\u5148\u5bf9\u5f80\u5de6\u586b\u7684\u90e8\u5206\u8fdb\u884c\u5206\u6790\uff0c\u5373\u8003\u8651\u6240\u6709\u5f62\u5982\u5728 $a_{1\\dots m}$ \u4e2d\u51fa\u73b0\u8fc7\u7684 $x(x\\le l_1)$ \u6240\u5bf9\u5e94\u7684\u503c\u57df\u533a\u95f4 $(pre_x,x)$\u3002\n\n\u7ed3\u8bba $3$\uff1a\u5bf9\u4e8e\u4e00\u4e2a\u5728 $a_{1\\dots m}$ \u4e2d\u51fa\u73b0\u8fc7\u7684 $x(x\\le l_1)$\uff0c\u8bbe $i$ \u4e3a\u6ee1\u8db3 $x\\ge l_i$ \u7684\u6700\u5927\u4f4d\u7f6e\u3002\u90a3\u4e48\uff1a\n\n- \u5982\u679c $x>l_i$\uff0c\u90a3\u4e48 $(pre_x,x)$ \u5728\u6269\u5c55\u5230 $[l_j,r_j]$ \u65f6\u586b\u3002**\u8fd9\u79cd\u60c5\u51b5\u4e00\u5b9a\u4e0d\u4f1a\u4ea7\u751f\u8d21\u732e**\u3002\n\n- \u5982\u679c $x=l_i$\uff0c\u90a3\u4e48\u8bbe $j$ \u4e3a\u6ee1\u8db3 $l_i=l_j$ \u7684\u6700\u5c0f\u4f4d\u7f6e\uff0c\u90a3\u4e48\u5b58\u5728\u4e00\u4e2a $k\\in [j,i]$\uff0c\u4f7f\u5f97 $(pre_x,x)$ \u5728\u6269\u5c55\u5230 $[l_k,r_k]$ \u65f6\u586b\u3002**\u8fd9\u79cd\u60c5\u51b5\u53ef\u80fd\u4f1a\u4ea7\u751f\u8d21\u732e**\u3002\n\n\u6269\u5c55\u5230 $[l_i,r_i]$ \u4e4b\u540e\uff0c\u5c06 $(pre_{l_i},l_i)$ \u586b\u4e0a\u4ea7\u751f\u7684\u8d21\u732e\u53ef\u4ee5\u8868\u793a\u4e3a $wl_i\\times (l_i-pre_{l_i}-1)$\u3002\n\n\u5bf9\u4e8e\u4e00\u4e2a $i$\uff0c\u8003\u8651\u5982\u4f55\u8ba1\u7b97\u5b83\u5bf9\u5e94\u7684 $wl_i$\u3002\u8fd9\u76f8\u5f53\u4e8e\u662f\u8003\u8651\u586b\u4e0a $l_i-1$ \u65f6\u6709\u54ea\u4e9b\u540e\u7f00\u4f1a\u6210\u4e3a\u65b0\u7684\u8fde\u7eed\u6bb5\u3002\u8bbe $j$ \u4e3a\u6ee1\u8db3 $l_i=l_j$ \u4e14 $[r_j,r_i]$ \u5168\u90e8\u5728 $a_{1\\dots m}$ \u4e2d\u51fa\u73b0\u8fc7\u7684\u6700\u5c0f\u4f4d\u7f6e\u3002\u5982\u679c $l_i=l_{j-1}$ \u4e14 $[suf_{r_{j-1}},r_j]$ \u5168\u90e8\u5728 $a_{1\\dots m}$ \u51fa\u73b0\u8fc7\uff0c\u90a3\u4e48 $tl_i=i-j+2$\uff0c\u5426\u5219 $tl_i=i-j+1$\u3002\n\n\u8bbe $wl_x=\\max\\limits_{l_i=x}\\{tl_x\\}$\u3002\n\n\u7c7b\u4f3c\u5730\u6211\u4eec\u4e5f\u53ef\u4ee5\u5b9a\u4e49 $tr,wr$\u3002\n\n\u6b64\u65f6\u6211\u4eec\u83b7\u5f97\u4e86\u4e00\u4e2a\u8d21\u732e\u7684\u4e0a\u754c\uff1a\n\n$$\\sum wl_x(x-pre_x-1)+\\sum wr_x(suf_x-x-1)$$\n\n\u4f46\u5de6\u53f3\u4e24\u90e8\u5206\u5e76\u4e0d\u5b8c\u5168\u72ec\u7acb\uff0c\u5b83\u4eec\u53ef\u80fd\u4f1a\u4e92\u76f8\u5f71\u54cd\u5bfc\u81f4\u8d21\u732e\u53d8\u5c0f\u3002\n\n\u731c\u6d4b\u6700\u7ec8\u8d21\u732e\u4e00\u5b9a\u80fd\u53d6\u5230\u4e0a\u754c\uff0c\u5c1d\u8bd5\u8fdb\u884c\u6784\u9020\u3002\n\n\u53ef\u4ee5\u53d1\u73b0\u8d21\u732e\u53d8\u5c0f\u65f6\u4e00\u5b9a\u5b58\u5728\u4e00\u4e2a $i$ \u6ee1\u8db3 $(pre_{l_i},l_i),(r_i,suf_{r_i})$ \u8fd9\u4e24\u6bb5\u90fd\u5728\u6269\u5c55\u5230 $[l_i,r_i]$ \u65f6\u586b\u3002\u663e\u7136\u53ea\u6709\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u5de6\u53f3\u4e24\u8fb9\u7684\u8d21\u732e\u624d\u53ef\u80fd\u4e92\u76f8\u5f71\u54cd\u3002\n\n\u5982\u679c\u5148\u586b $(pre_{l_i},l_i)$\uff0c\u90a3\u4e48 $(r_i,suf_{r_i})$ \u7684\u8d21\u732e\u53ef\u80fd\u65e0\u6cd5\u8fbe\u5230 $tr_i\\times (r_i,suf_{r_i})$\u3002\u53cd\u4e4b\u4ea6\u7136\u3002\u8003\u8651\u8fdb\u884c\u4e00\u4e9b\u5206\u6790\u907f\u514d\u8d21\u732e\u53d8\u5c0f\u3002\n\n\u663e\u7136 $l_i<l_{i-1}$ \u548c $r_i>r_{i-1}$ \u4e2d\u81f3\u5c11\u6709\u4e00\u4e2a\u6210\u7acb\uff0c\u4e0d\u59a8\u8bbe $l_i<l_{i-1}$\u3002\u6839\u636e $tl$ \u548c $tr$ \u7684\u8ba1\u7b97\u65b9\u6cd5\u53ef\u4ee5\u5f97\u5230 $tl_i=1$\u3002\u5982\u679c\u6211\u4eec\u5148\u586b $(r_i,suf_{r_i})$\uff0c\u518d\u586b $(pre_{l_i},l_i)$\uff0c\u53ef\u4ee5\u53d1\u73b0\u6b64\u65f6 $(pre_{l_i},l_i)$ \u4ea7\u751f\u7684\u8d21\u732e\u4e3a $l_i-pre_{l_i}-1$\uff0c\u6ca1\u6709\u53d8\u5c0f\u3002\n\n\u56e0\u6b64\u6211\u4eec\u53ea\u9700\u8981\u6839\u636e $tl,tr,wl,wr$ \u8ba1\u7b97\u51fa\u6bcf\u4e2a $(pre_x,x),(x,suf_x)$ \u586b\u7684\u65f6\u95f4\uff0c\u7136\u540e\u5229\u7528\u4e0a\u8ff0\u65b9\u5f0f\u8fdb\u884c\u6784\u9020\u5373\u53ef\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log n)$\u3002\u74f6\u9888\u5728\u4e8e\u4f7f\u7528\u7ebf\u6bb5\u6811\u6c42 $a_{1\\dots m}$ \u4e2d\u7684\u8fde\u7eed\u6bb5\u4e2a\u6570\uff0c\u540e\u9762\u7684\u8d2a\u5fc3\u548c\u6784\u9020\u90e8\u5206\u90fd\u662f $O(n)$ \u7684\u3002\n\n\u53c2\u8003\u4ee3\u7801\uff1a\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n#define N 200005\n#define mid ((l+r)/2)\n#define ll long long\nconst int INF=1e9;\nint n,m,tp,a[N],b[N],vs[N],id[N],id1[N],L[N],R[N],w1[N],w2[N],ps1[N],ps2[N];\nll ans;struct Seg {int vl,cnt,tg;}sg[N*4];\nvoid pu(int p)\n{\n\tsg[p].vl=min(sg[p*2].vl,sg[p*2+1].vl);sg[p].cnt=0;\n\tif(sg[p].vl==sg[p*2].vl) sg[p].cnt=sg[p*2].cnt;\n\tif(sg[p].vl==sg[p*2+1].vl) sg[p].cnt+=sg[p*2+1].cnt;\n}\nvoid mdf(int p,int vl) {sg[p].vl+=vl;sg[p].tg+=vl;}\nvoid pd(int p) {mdf(p*2,sg[p].tg);mdf(p*2+1,sg[p].tg);sg[p].tg=0;}\nvoid build(int p,int l,int r)\n{\n\tif(l==r) {sg[p].vl=INF;sg[p].cnt=1;return;}\n\tbuild(p*2,l,mid);build(p*2+1,mid+1,r);pu(p);\n}\nvoid upd(int p,int l,int r,int qL,int qR,int vl)\n{\n\tif(qL>qR) return;if(l>=qL && r<=qR) {mdf(p,vl);return;}pd(p);\n\tif(qL<=mid) upd(p*2,l,mid,qL,qR,vl);\n\tif(qR>mid) upd(p*2+1,mid+1,r,qL,qR,vl);pu(p);\n}\nint main()\n{\n\tscanf(\"%d %d\",&n,&m);\n\tif(!m)\n\t{\n\t\tprintf(\"%lld\\n\",1ll*n*(n+1)/2);\n\t\tfor(int i=1;i<=n;++i) printf(\"%d \",i);return 0;\n\t}build(1,1,n);\n\tfor(int i=1;i<=m;++i)\n\t{\n\t\tscanf(\"%d\",&a[i]);vs[a[i]]=i;upd(1,1,n,i,i,-INF);upd(1,1,n,1,i,1);\n\t\tif(vs[a[i]-1]) upd(1,1,n,1,vs[a[i]-1],-1);\n\t\tif(vs[a[i]+1]) upd(1,1,n,1,vs[a[i]+1],-1);\n\t\tif(i<m && sg[1].vl==1) ans+=sg[1].cnt;\n\t}for(int i=1;i<=n;++i) if(vs[i]) b[id[i]=++tp]=i;b[tp+1]=n+1;\n\tfor(int i=1;i<=tp;++i)\n\t{\n\t\tid1[i]=id1[i-1]+(i==1 || b[i]>b[i-1]+1);\n\t\tif(id1[i]>id1[i-1]) L[id1[i]]=i;R[id1[i]]=i;\n\t}for(int i=0;i<=tp;++i) ans+=1ll*(b[i+1]-b[i])*(b[i+1]-b[i]-1)/2;\n\tfor(int i=m,t,nw1=0,nw2=0,l=INF,r=-INF,l1=INF,r1=-INF;i;--i)\n\t{\n\t\tt=id[a[i]];l=min(l,t);r=max(r,t);\n\t\tif(r-l==m-i)\n\t\t{\t\t\n\t\t\tif(l<l1) nw1=0;else if(id1[r]!=id1[r1]) nw1=(r1==R[id1[r]-1]);++nw1;\n\t\t\tif(r>r1) nw2=0;else if(id1[l]!=id1[l1]) nw2=(l1==L[id1[l]+1]);++nw2;\n\t\t\tif(nw1>w1[l]) w1[l]=nw1,ps1[l]=i;\n\t\t\tif(nw2>w2[r]) w2[r]=nw2,ps2[r]=i;++ans;l1=l;r1=r;\n\t\t}\n\t}for(int i=1;i<=tp;++i) ans+=1ll*w1[i]*(b[i]-b[i-1]-1)+1ll*w2[i]*(b[i+1]-b[i]-1);\n\tprintf(\"%lld\\n\",ans);for(int i=1;i<=m;++i) printf(\"%d \",a[i]);\n\tfor(int i=m,t,l=INF,r=-INF,l1=INF,r1=-INF;i;--i)\n\t{\n\t\tt=id[a[i]];l=min(l,t);r=max(r,t);\n\t\tif(r-l==m-i)\n\t\t{\t\n\t\t\tif(l1>r1) for(int j=l;j<r;++j) for(int k=b[j]+1;k<b[j+1];++k) printf(\"%d \",k);\n\t\t\telse\n\t\t\t{\n\t\t\t\tfor(int j=l1-1;j>l;--j) for(int k=b[j]-1;k>b[j-1];--k) printf(\"%d \",k);\n\t\t\t\tfor(int j=r1+1;j<r;++j) for(int k=b[j]+1;k<b[j+1];++k) printf(\"%d \",k);\n\t\t\t}l1=l;r1=r;\n\t\t\tif(i==ps1[l] && w1[l]>1) {for(int j=b[l]-1;j>b[l-1];--j) printf(\"%d \",j);}\n\t\t\tif(i==ps2[r] && w2[r]>1) {for(int j=b[r]+1;j<b[r+1];++j) printf(\"%d \",j);}\n\t\t\tif(i==ps1[l] && w1[l]==1) {for(int j=b[l]-1;j>b[l-1];--j) printf(\"%d \",j);}\n\t\t\tif(i==ps2[r] && w2[r]==1) {for(int j=b[r]+1;j<b[r+1];++j) printf(\"%d \",j);}\n\t\t}\n\t}return 0;\n}\n```",
        "postTime": 1684236511,
        "uid": 119621,
        "name": "Kubic",
        "ccfLevel": 10,
        "title": "P6795 [SNOI2020] \u6392\u5217"
    }
]