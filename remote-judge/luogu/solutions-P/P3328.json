[
    {
        "content": "\u4ece\u67d0\u4f4d\u4e0d\u613f\u900f\u9732\u59d3\u540d\u7684\u795e\u4ed9\u5904\u83b7\u5f97\u4e86\u4e00\u4e2a\u505a\u6cd5\u3002\n\n\u4e00\u79cd\u7ebf\u6bb5\u6811\u914d\u5408\u77e9\u9635\u4e58\u6cd5\u7684\u505a\u6cd5\u3002\n\n\u9996\u5148\u770b\u5230\u8fd9\u4e2a\u7ebf\u6027\u9012\u63a8\u5f0f\u5b50\uff0c\u663e\u7136\u53ef\u4ee5\u76f4\u63a5\u77e9\u9635\u5feb\u901f\u5e42\u6ca1\u6709\u4ec0\u4e48\u95ee\u9898\uff0c\u5c31\u628a\u5411\u91cf\u8bbe\u4e3a\u5f62\u5982 $F_i,F_{i-1},1$ \u5c31\u53ef\u4ee5\u4e86\uff0c\u6211\u4eec\u53eb\u8fd9\u4e2a\u5411\u91cf\u662f $V(i)$\uff0c\u7136\u540e\u6211\u4eec\u8bbe\u4f7f\u5f97 $i$ \u52a0\u4e00\u7684\u8f6c\u79fb\u77e9\u9635\u4e3a $pl$\uff0c\u51cf\u4e00\u7684\u4e3a $mi$\u3002\n\n\u7136\u540e\u770b\uff0c\u6700\u7ec8\u6211\u4eec\u8ba1\u7b97\u8d21\u732e\u7684\u5f0f\u5b50\u662f\uff1a$F_{A_{i-1}+1}F_{A_{i+1}-1}$\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\uff0c\u5982\u679c\u6309\u7167\u6211\u4eec\u5199\u4ee3\u7801\u65f6\uff0c\u628a\u5411\u91cf\u653e\u8fdb\u77e9\u9635\u91cc\u9762\uff0c\u5047\u8bbe $V$ \u662f\u5217\u5411\u91cf\uff0c\u90a3\u4e48\u8f6c\u7f6e\u5c31\u662f\u4e2a\u884c\u5411\u91cf\u3002\u7528\u8fd9\u4e24\u4e2a\u5bf9\u5e94\u7684\u77e9\u9635\uff0c\u5217\u5411\u91cf\u5de6\u4e58\u884c\u5411\u91cf\u5f97\u5230\u7684\u7ed3\u679c\u5c31\u6070\u597d\u662f\u4e24\u4e2a\u5411\u91cf\u7b2c\u4e00\u4f4d\u4e4b\u79ef\u3002\n\n\u90a3\u4e48\u8fd9\u4e2a\u4e58\u79ef\u5c31\u53ef\u4ee5\u63cf\u8ff0\u6210 $(V(A_{i-1}+1)\\times V(A_{i+1}-1)^T)[0][0]$ \u7684\uff0c\u8fd9\u4e2a\u4e1c\u897f\u6709\u4ec0\u4e48\u7528\u5462\uff1f\u6211\u4eec\u8bbe $W(i)=V(A_{i-1}+1)\\times V(A_{i+1}-1)^T$\n\n\u6211\u4eec\u8003\u8651\u5bf9\u4e00\u4e2a\u70b9 $i$\uff0c\u6211\u4eec\u90fd\u7ef4\u62a4\u4e00\u4e0b $W(i)$\u3002\u8fd9\u6837\u6709\u4ec0\u4e48\u7528\u5462\uff1f\u5047\u8bbe\u6211\u60f3\u8981\u8ba9 $A_{i-1}$ \u548c $A_{i+1}$ \u90fd\u52a0\u4e0a $1$\uff0c\u90a3\u4e48\u65b0\u7684\u8d21\u732e\u4e00\u5b9a\u53ef\u4ee5\u901a\u8fc7 $((pl\\times V(A_{i-1}+1))\\times (pl\\times V(A_{i+1}-1))^T)[0][0]=(pl\\times W(i)\\times pl^T)[0][0]$ \u8868\u793a\u51fa\u6765\u3002\n\n\u90a3\u6b64\u65f6\u4f7f\u7528\u7ebf\u6bb5\u6811\u7684\u601d\u8def\u5c31\u660e\u4e86\u4e86\uff0c\u56e0\u4e3a\u77e9\u9635\u4e58\u6cd5\u5bf9\u52a0\u6cd5\u5177\u6709\u5206\u914d\u5f8b\uff0c\u6240\u4ee5\u6211\u4eec\u7ebf\u6bb5\u6811\u7ef4\u62a4\u533a\u95f4 $W$ \u4e4b\u548c\uff0c\u7136\u540e\u4fee\u6539\u7684\u65f6\u5019\u76f4\u63a5\u6574\u4f53\u5728\u524d\u9762\u6216\u8005\u540e\u9762\u4e58\u4e0a\u8f6c\u79fb\u77e9\u9635\uff0c\u5c31\u53ef\u4ee5\u5f97\u51fa\u7b54\u6848\u4e86\uff01\u5f62\u5f0f\u5316\u5730\u5199\uff0c\u5373\uff1a\uff08\u4ee5\u5de6\u53f3\u5747\u4e58\u52a0\u4e00\u77e9\u9635\u4e3a\u4f8b\uff09\n$$\npl\\times (\\sum_{i=l}^r W(i))\\times pl^T=\\sum_{i=l}^r pl\\times W(i)\\times pl^T\n$$\n\u4e8e\u662f\u672c\u9898\u89e3\u51b3\u4e86\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $O((n+Q)\\log n)$\u3002\n\n\u53e6\u5916\u4e0d\u77e5\u9053\u4e3a\u4ec0\u4e48\u8fd9\u4e2a\u9898\u76f4\u63a5\u5199\u666e\u901a\u7ebf\u6bb5\u6811\u4f1a TLE\uff0c\u4f46\u5982\u679c\u5199\u52a8\u6001\u5f00\u70b9\u5c31\u80fd\u8fc7\uff0c\u5f88\u8ff7\u60d1\u3002\n\n### \u4ee3\u7801\n\n```cpp\n#include <bits/stdc++.h>\n#define lint long long\nusing namespace std;\ninline int read(){\n\tchar c;int f=1,res=0;\n\twhile(c=getchar(),!isdigit(c))if(c=='-')f*=-1;\n\twhile(isdigit(c))res=res*10+c-'0',c=getchar();\n\treturn res*f;\n}\nconst int N=3e5+5;\nconst lint md=1e9+7;\n#define add(x,y) x=(x+y)%md\nstruct mat{\n\tlint v[3][3];\n\tmat(lint x=0){\n\t\tmemset(v,0,sizeof v);\n\t\tfor(int i=0;i<3;++i)v[i][i]=x;\n\t}inline lint* operator[](int x)\n\t\t{return v[x];}\n\tinline mat operator*(mat x){\n\t\tmat r;\n\t\tfor(int i=0;i<3;++i)\n\t\t\tfor(int k=0;k<3;++k)\n\t\t\t\tfor(int j=0;j<3;++j)\n\t\t\t\t\tadd(r[i][j],v[i][k]*x[k][j]);\n\t\treturn r;\n\t}inline mat operator+(mat x){\n\t\tfor(int i=0;i<3;++i)\n\t\t\tfor(int j=0;j<3;++j)\n\t\t\t\tadd(x[i][j],v[i][j]);\n\t\treturn x;\n\t}inline mat T(){\n\t\tmat r;\n\t\tfor(int i=0;i<3;++i)\n\t\t\tfor(int j=0;j<3;++j)\n\t\t\t\tr[i][j]=v[j][i];\n\t\treturn r;\n\t}inline mat qpow(lint x){\n\t\tmat r(1),t=*this;\n\t\twhile(x){\n\t\t\tif(x&1)r=r*t;\n\t\t\tt=t*t;x>>=1;\n\t\t}return r;\n\t}\n}pl,mi,tpl,tmi,f,tf;\nint n,nq;lint a,b,v[N];\ninline lint qpow(lint x,lint y=md-2){\n\tlint res=1;\n\twhile(y){\n\t\tif(y&1)res=res*x%md;\n\t\tx=x*x%md;y>>=1;\n\t}return res;\n}\ninline void init(){\n\tpl[0][0]=pl[1][0]=pl[2][2]=1;\n\tpl[0][1]=a;pl[0][2]=b;\n\tf[0][0]=2;f[1][0]=f[2][0]=1;\n\ttpl=pl.T();tf=f.T();\n\tif(a){\n\t\tmi[0][1]=mi[2][2]=1;\n\t\tmi[1][0]=qpow(a);\n\t\tmi[1][1]=md-qpow(a);\n\t\tmi[1][2]=md-b*qpow(a)%md;\n\t}else{\n\t\tmi[0][1]=mi[1][1]=mi[2][2]=1;\n\t\tmi[1][2]=md-b;\n\t}tmi=mi.T();\n}\nmat s[N<<1],tl[N<<1],tr[N<<1];\nint ch[N<<1][2],tot,rt;\ninline void nupd(int x,mat lu,mat ru){\n\ttl[x]=lu*tl[x];tr[x]=tr[x]*ru;\n\ts[x]=lu*s[x]*ru;\n}inline void pushdown(int x){\n\tnupd(ch[x][0],tl[x],tr[x]);\n\tnupd(ch[x][1],tl[x],tr[x]);\n\ttl[x]=tr[x]=mat(1);\n}void build(int &x=rt,int l=2,int r=n-1){\n\tx=++tot;tl[x]=tr[x]=mat(1);\n\tif(l==r){\n\t\ts[x]=pl.qpow(v[l-1]-1)*f;\n\t\ts[x]=s[x]*tf*tpl.qpow(v[l+1]-3);\n\t\treturn;\n\t}int mid=l+r>>1;\n\tbuild(ch[x][0],l,mid);\n\tbuild(ch[x][1],mid+1,r);\n\ts[x]=s[ch[x][0]]+s[ch[x][1]];\n}\nvoid upd(int lp,int rp,mat lu,mat ru,int x=rt,int l=2,int r=n-1){\n\tif(l>rp||r<lp)return;\n\tif(lp<=l&&r<=rp)return nupd(x,lu,ru);\n\tint mid=l+r>>1;pushdown(x);\n\tupd(lp,rp,lu,ru,ch[x][0],l,mid);\n\tupd(lp,rp,lu,ru,ch[x][1],mid+1,r);\n\ts[x]=s[ch[x][0]]+s[ch[x][1]];\n}\nmat query(int lp,int rp,int x=rt,int l=2,int r=n-1){\n\tif(l>rp||r<lp)return mat();\n\tif(lp<=l&&r<=rp)return s[x];\n\tint mid=l+r>>1;pushdown(x);\n\tmat res=query(lp,rp,ch[x][0],l,mid);\n\tres=res+query(lp,rp,ch[x][1],mid+1,r);\n\treturn res;\n}\nint main(){\n\tn=read();nq=read();\n\ta=read();b=read();\n\tfor(int i=1;i<=n;++i)v[i]=read();\n\tinit();build();\n\twhile(nq--){\n\t\tstring op;cin>>op;\n\t\tint l=read(),r=read();\n\t\tif(op==\"plus\"){\n\t\t\tupd(l+1,r+1,pl,mat(1));\n\t\t\tupd(l-1,r-1,mat(1),tpl);\n\t\t}else if(op==\"minus\"){\n\t\t\tupd(l+1,r+1,mi,mat(1));\n\t\t\tupd(l-1,r-1,mat(1),tmi);\n\t\t}else if(op==\"query\")\n\t\t\tprintf(\"%lld\\n\",query(l+1,r-1)[0][0]);\n\t}return 0;\n}\n\n```\n\n",
        "postTime": 1647351425,
        "uid": 206258,
        "name": "SDNetFriend",
        "ccfLevel": 7,
        "title": "P3328 [SDOI2015]\u97f3\u8d28\u68c0\u6d4b \u9898\u89e3"
    },
    {
        "content": "[P3328 [SDOI2015]\u97f3\u8d28\u68c0\u6d4b](https://www.luogu.org/problemnew/show/P3328)\n\n\u8d81\u6ca1\u6709\u9898\u89e3\u8d76\u7d27\u62a2\u4e00\u53d1\u4e00\u8840\u3002\u3002\u3002\n\n## \u5148\u8bf4\u4e00\u70b9\u9898\u5916\u8bdd\n\n\n\n\u9996\u5148\u6d1b\u8c37\u4e0a\u53ea\u80fd\u8bc4\u6d4b\uff0c\u9898\u9762\u6682\u65f6\u4e0d\u5168\u3002\u3002\u3002\n\n\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u53bb$Vijos$\u641e\u641e\u4e8b\u3002\n\n\u5f53\u7136\u5982\u679c\u4f60\u6709\u67d0$ZOJ$\u7684~~\u6c2a\u91d1~~\u6743\u9650\u53f7\uff0c\u4f60\u4e5f\u53ef\u4ee5\u53bb\u67d0$ZOJ$\u3002\u3002\u3002\n\n\u7136\u800cVijos\u4e0a\u6570\u636e\u8303\u56f4\u4e0d\u5bf9\uff0c\u5e94\u8be5\u662f\u6d1b\u8c37\u4e0a\u7684\u6570\u636e\u8303\u56f4\u3002\u3002\u3002\n\n\u6240\u4ee5\u6ca1\u94b1\u6c2a\u91d1\u5c31\u51d1\u5408\u7740\u770b\u5427\u3002\u3002\u3002\n\n\u8fd9\u91cc\u9644\u4e0a$Vijos$\u7684\u9898\u9762\u3002\n\n[1958 \u97f3\u8d28\u68c0\u6d4b](https://vijos.org/p/1958)\n\n## \u6b65\u5165\u6b63\u9898\n\n\u8fd9\u4e2a\u9898\u7b80\u76f4\u5c31\u662f\u9053\u795e\u9898\u3002\u3002\u3002\n\n\u9996\u5148\uff0c\u7ebf\u6bb5\u6811+\u5947\u5947\u602a\u602a\u7684\u77e9\u9635\u5feb\u901f\u5e42\u5e94\u8be5\u90fd\u80fd\u60f3\u5230\u3002\n\n\u5173\u952e\u662f\u600e\u4e48\u505a\u5bf9\u5427\u3002\u3002\u3002\n\n\u9996\u5148\u8003\u8651\u4e00\u4e2a\u6027\u8d28\uff1a\n\n\u6211\u4eec\u5982\u679c\u6709\u6570\u5217\u7684\u76f8\u90bb\u4e24\u9879$f[i],f[i+1]$\u3002\n\n\u90a3\u4e48\u7528\u8fd9\u4e24\u9879\u5411\u540e\u63a8$k$\u9879\u5176\u7ebf\u6027\u8868\u793a\u7cfb\u6570\u4e00\u5b9a\u3002\n\n\u5373\u8868\u793a\u4e3a$f[i+k]=A\\times f[i]+B\\times f[i+1]+C$\u7684\u5f62\u5f0f\u3002\n\n\u90a3\u4e48\u8fd9\u6837\u6211\u4eec\u9884\u5904\u7406\u8fd9\u4e9b\u7cfb\u6570\u5c31\u597d\u4e86\u561b\u3002\n\n\u6ce8\u610f\u5230\u7ef4\u62a4\u7684\u662f\u4e00\u4e2a\u4e58\u79ef\u7684\u5f62\u5f0f\uff0c\u90a3\u4e48\u6211\u4eec\u8981\u7ef4\u62a4\u8fd9\u4e2a\u5fc5\u987b\u5f97\u7ef4\u62a4$8$\u4e2a\u91cf\u3002\n\n**\u5bf9\uff01\u4f60\u6ca1\u6709\u770b\u9519\uff01$8$\u4e2a\uff01**\n\n\u5c06\u5176\u5199\u6210$3\\times 3$\u77e9\u9635\u7684\u5f62\u5f0f\u8f6c\u79fb\u4f1a\u6bd4\u8f83\u79d1\u5b66\u3002\n\n\u6ce8\u610f$a==0$\u65f6\u7684\u7279\u5224\u3002 \n\n\u4ee5\u4e0a\u662f\u6b63\u89e3\u3002\n\n\u7136\u540e\u67d0\u4f4d\u5de8\u4f6c\u7528\u4e86$BSGS$\u9884\u5904\u7406$f$\u51fd\u6570\uff0c\u7b80\u76f4\u65e0\u654c\u4e86\uff1a[\u94fe\u63a5](https://blog.csdn.net/qq_20669971/article/details/70208601)\u3002\n\n\u7136\u800c\u6211\u8868\u793a\u5e76\u4e0d\u80fd\u7801\u51fa\u6765\uff0c\u4e8e\u662f\u81ea\u5df1$YY$\u4e86\u4e00\u4e2a\u65b9\u6848\u3002\n\n\u601d\u8def\u5927\u81f4\u5dee\u4e0d\u591a\uff0c\u4f46\u662f\u7ef4\u62a4\u7684\u4e1c\u897f\u591a\u4e86\u70b9\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4$f[a_{i-1}],f[a_{i-1}+1],f[a_{i-1}-1],f[a_{i+1}],f[a_{i+1}+1],f[a_{i+1}-1]$\u7684\u503c\uff0c\u4ee5\u53ca\u4e24\u4e24\u4e58\u79ef\u548c\u3002\n\n\u52a0\u4e00\u7684\u65f6\u5019\u53ef\u4ee5\u76f4\u63a5\u7528\u9012\u63a8\u5f0f\u7528\u4fdd\u5b58\u7684$f$\u503c\u6c42\u51fa\u65b0\u7684\u503c\u3002\n\n\u51cf\u4e00\u7684\u65f6\u5019\u4e5f\u53ef\u4ee5\u89e3\u65b9\u7a0b\u6c42\u503c\u3002\n\n\u540c\u6837\u6ce8\u610f$a==0$\u65f6\u7684\u7279\u5224\u3002 \n\n\u7136\u540e\u5f00\u59cb\u7801\u7801\u7801\u3002\u3002\u3002\n\n\u597d\u957f\u554a\u3002\u3002\u3002\n\n\u7136\u540e\u8fd9\u9898\u8fd8\u6709\u4e00\u5927\u5806\u4e71\u4e03\u516b\u7cdf\u7684\u7ec6\u8282\uff0c\u8fd9\u91cc\u603b\u7ed3\u4e86\u4e2a\u4eba\u7684\u51e0\u70b9\uff1a\n\n1. \u8bb0\u5f97\u5c3d\u91cf\u964d\u4f4e\u65f6\u95f4\u3001\u7a7a\u95f4\u590d\u6742\u5ea6\uff0c\u80fd$return$\u7684\u5730\u65b9\u5c3d\u91cf$return$\uff0c\u4ee5\u514d\u4e0d\u5fc5\u8981\u7684\u641c\u7d22\u5bfc\u81f4$TLE/MLE$\u3002\n\n2. \u8fd8\u6709\u4e00\u4ef6\u4e8b\uff0c\u6ce8\u610f\u5f00$long\\ long$\uff01\n\n3. \u8fd8\u6709\u4e00\u4ef6\u4e8b\uff0c\u505a\u51cf\u6cd5\u7684\u65f6\u5019\u5982\u679c\u51cf\u4e86\u4e24\u6b21\uff0c\u4e00\u5b9a\u8981\u5148\u53d6\u6a21\uff0c\u518d\u52a0\u4e0a\u6a21\u6570\uff0c\u518d\u53d6\u6a21\uff01\u4e0d\u7136\u4f1a\u6c42\u51fa\u6765\u8d1f\u6570\uff0c\u5c31\u5149\u8363\u5730$WA$\u4e86\u3002\u3002\u3002\n\n4. \u8fd8\u6709\u4e00\u4ef6\u4e8b\uff0c\u6ce8\u610f\u7ebf\u6bb5\u6811\u7684\u8fb9\u754c\u95ee\u9898\uff0c\u4e3a\u8fd9\u4e2a\u6211\u8fd8\u6d6a\u8d39\u4e86\u4e00\u6b21\u63d0\u4ea4\uff0c\u836f\u4e38\u3002\u3002\u3002\n\n[\u8bb0\u5f97\u6709\u7a7a\u5230\u672c\u849f\u84bb\u7684\u535a\u5ba2\u91cc\u559d\u559d\u8336\u54e6\uff01](https://www.cnblogs.com/Yangrui-Blog/p/9623294.html)\n\n\u9644\u4e0a\u7092\u9e21\u957f\u7684\u4ee3\u7801\uff08\u7801\u98ce\u8f83\u4e11\u4e0d\u8981\u6253\u6211\u3002\u3002\u3002\uff09\uff1a\n```cpp\n#include<iostream>\n#include<algorithm>\n#include<cstdio>\n#define LSON rt<<1\n#define RSON rt<<1|1\n#define DATA(x,i,j) a[x].data[i-1][j-1]\n#define SUM(x,i,j) a[x].sum[i-1][j-1]//\u4e3a\u4e86\u7701\u7a7a\u95f4\uff0c\u53ea\u80fd\u8fd9\u6837\u5e72\u4e86\u3002\u3002\u3002\n#define ADD(x) a[x].c\n#define DEL(x) a[x].d\n#define LSIDE(x) a[x].l\n#define RSIDE(x) a[x].r\n#define WIDTH(x) (RSIDE(x)-LSIDE(x)+1)\n#define MAXN 300010\n#define MOD 1000000007LL\nusing namespace std;\nint n,m;\nlong long A,B,inv,f[MAXN][4];\nstruct node{//\u77e9\u9635\n\tlong long val[4][4];\n\tinline void clean(){\n\t\tfor(int i=1;i<=3;i++)\n\t\tfor(int j=1;j<=3;j++)\n\t\tval[i][j]=(i==j);\n\t}\n\tfriend node operator *(const node x,const node y){\n\t\tnode ret;\n\t\tfor(int i=1;i<=3;i++)\n\t\tfor(int j=1;j<=3;j++){\n\t\t\tret.val[i][j]=0;\n\t\t\tfor(int k=1;k<=3;k++)ret.val[i][j]=(ret.val[i][j]+x.val[i][k]*y.val[k][j]%MOD)%MOD;\n\t\t}\n\t\tret.val[3][3]=1;\n\t\treturn ret;\n\t}\n}one,two,power[35];\nstruct Segment_Tree{//\u7ebf\u6bb5\u6811\uff0c\u8bb0\u5f97\u4e0d\u8981\u5728\u7ed3\u6784\u4f53\u91cc\u518d\u5f00\u7ed3\u6784\u4f53\u3002\u3002\u3002\n\tlong long sum[3][3],data[3][3];\n\tint c,d,l,r;\n}a[MAXN<<2];\ninline long long read(){\n\tlong long date=0,w=1;char c=0;\n\twhile(c<'0'||c>'9'){if(c=='-')w=-1;c=getchar();}\n\twhile(c>='0'&&c<='9'){date=date*10+c-'0';c=getchar();}\n\treturn date*w;\n}\nlong long mexp(long long a,long long b,long long c){//\u666e\u901a\u5feb\u901f\u5e42\n\tlong long s=1;\n\twhile(b){\n\t\tif(b&1)s=s*a%c;\n\t\ta=a*a%c;\n\t\tb>>=1;\n\t}\n\treturn s;\n}\nnode pow(long long k){//\u77e9\u9635\u5feb\u901f\u5e42\n\tnode s;\n\ts.clean();\n\tint i=1;\n\twhile(k){\n\t\tif(k&1)s=s*power[i];//\u9884\u5904\u7406\u77e9\u9635\u76842\u7684\u5e42\u6b21\u65b9\n\t\tk>>=1;\n\t\ti++;\n\t}\n\treturn s;\n}\nvoid function(int i){\n\tnode s=one*pow(f[i][0]-2);\n\tf[i][1]=s.val[1][2];f[i][2]=s.val[1][1];\n}\nvoid build(){\n\tone.val[1][1]=2;one.val[1][2]=one.val[1][3]=1;\n\ttwo.val[1][1]=two.val[1][2]=two.val[3][3]=1;\n\ttwo.val[2][1]=A;two.val[3][1]=B;\n\tfor(int i=1;i<=32;i++){//\u9884\u5904\u7406\u77e9\u9635\u76842\u7684\u5e42\u6b21\u65b9\n\t\tpower[i]=two;\n\t\ttwo=two*two;\n\t}\n}\n\n//-------------------\u4ee5\u4e0b\u662f\u7ebf\u6bb5\u6811-------------------\n\ninline void pushup(int rt){//\u4e0a\u4f20\n\tfor(int i=1;i<=3;i++)\n\tfor(int j=1;j<=3;j++){\n\t\tDATA(rt,i,j)=(DATA(LSON,i,j)+DATA(RSON,i,j))%MOD;\n\t\tSUM(rt,i,j)=(SUM(LSON,i,j)+SUM(RSON,i,j))%MOD;\n\t}\n}\ninline void add(int rt,int l){//\u4e0b\u4f20\u52a0\u6cd5\u6807\u8bb0\uff0c\u53ef\u4ee5\u4e0d\u7528\u7279\u5224A==0\n\tfor(int i=1;i<=2;i++)SUM(rt,l,i)=SUM(rt,l,i+1);\n\tSUM(rt,l,3)=(SUM(rt,l,2)+A*SUM(rt,l,1)%MOD+B*WIDTH(rt)%MOD)%MOD;\n\tif(l==1){\n\t\tfor(int i=1;i<=2;i++)\n\t\tfor(int j=1;j<=3;j++)\n\t\tDATA(rt,i,j)=DATA(rt,i+1,j);\n\t\tfor(int i=1;i<=3;i++)DATA(rt,3,i)=(DATA(rt,2,i)+A*DATA(rt,1,i)%MOD+B*SUM(rt,2,i)%MOD)%MOD;\n\t}\n\telse{\n\t\tfor(int i=1;i<=3;i++)\n\t\tfor(int j=1;j<=2;j++)\n\t\tDATA(rt,i,j)=DATA(rt,i,j+1);\n\t\tfor(int i=1;i<=3;i++)DATA(rt,i,3)=(DATA(rt,i,2)+A*DATA(rt,i,1)%MOD+B*SUM(rt,1,i)%MOD)%MOD;\n\t}\n}\ninline void del(int rt,int l){//\u4e0b\u4f20\u51cf\u6cd5\u6807\u8bb0\n\tif(A==0){//\u8bb0\u5f97\u7279\u5224\uff01\n\t\tfor(int i=2;i>=1;i--)SUM(rt,l,i+1)=SUM(rt,l,i);\n\t\tSUM(rt,l,1)=(SUM(rt,l,2)-B*WIDTH(rt)%MOD+MOD)%MOD;\n\t\tif(l==1){\n\t\t\tfor(int i=2;i>=1;i--)\n\t\t\tfor(int j=1;j<=3;j++)\n\t\t\tDATA(rt,i+1,j)=DATA(rt,i,j);\n\t\t\tfor(int i=1;i<=3;i++)DATA(rt,1,i)=(DATA(rt,2,i)-B*SUM(rt,2,i)%MOD+MOD)%MOD;\n\t\t}\n\t\telse{\n\t\t\tfor(int i=1;i<=3;i++)\n\t\t\tfor(int j=2;j>=1;j--)\n\t\t\tDATA(rt,i,j+1)=DATA(rt,i,j);\n\t\t\tfor(int i=1;i<=3;i++)DATA(rt,i,1)=(DATA(rt,i,2)-B*SUM(rt,1,i)%MOD+MOD)%MOD;\n\t\t}\n\t\treturn;\n\t}\n\tfor(int i=2;i>=1;i--)SUM(rt,l,i+1)=SUM(rt,l,i);\n\tSUM(rt,l,1)=((SUM(rt,l,3)-SUM(rt,l,2)-B*WIDTH(rt)%MOD)*inv%MOD+MOD)%MOD;\n\tif(l==1){\n\t\tfor(int i=2;i>=1;i--)\n\t\tfor(int j=1;j<=3;j++)\n\t\tDATA(rt,i+1,j)=DATA(rt,i,j);\n\t\tfor(int i=1;i<=3;i++)DATA(rt,1,i)=((DATA(rt,3,i)-DATA(rt,2,i)-B*SUM(rt,2,i)%MOD)*inv%MOD+MOD)%MOD;\n\t}\n\telse{\n\t\tfor(int i=1;i<=3;i++)\n\t\tfor(int j=2;j>=1;j--)\n\t\tDATA(rt,i,j+1)=DATA(rt,i,j);\n\t\tfor(int i=1;i<=3;i++)DATA(rt,i,1)=((DATA(rt,i,3)-DATA(rt,i,2)-B*SUM(rt,1,i)%MOD)*inv%MOD+MOD)%MOD;\n\t}\n}\ninline void pushdown_sign(int rt,int l,int c){//\u4e0b\u4f20\u6807\u8bb0\uff0c\u4e3a\u4e86\u65b9\u4fbf\u5c31\u5199\u6210\u4e86\u51fd\u6570\n\tif(!c)return;\n\tif(c>0)for(int i=1;i<=c;i++)add(rt,l);\n\telse for(int i=-1;i>=c;i--)del(rt,l);\n}\ninline void pushdown(int rt){//\u771f\u6b63\u7684\u7ebf\u6bb5\u6811\u4e0b\u4f20\u6807\u8bb0\n\tif(LSIDE(rt)==RSIDE(rt))return;\n    \n\tADD(LSON)+=ADD(rt);\n    DEL(LSON)+=DEL(rt);\n\tpushdown_sign(LSON,1,ADD(rt));\n    pushdown_sign(LSON,2,DEL(rt));\n    //----------------------------------\n\tADD(RSON)+=ADD(rt);\n    DEL(RSON)+=DEL(rt);\n\tpushdown_sign(RSON,1,ADD(rt));\n    pushdown_sign(RSON,2,DEL(rt));\n    \n\tADD(rt)=DEL(rt)=0;\n}\nvoid buildtree(int l,int r,int rt){//\u5efa\u6811\n\tLSIDE(rt)=l;RSIDE(rt)=r;ADD(rt)=DEL(rt)=0;\n\tif(l==r){\n\t\tfor(int i=1;i<=3;i++){\n\t\t\tSUM(rt,1,i)=f[l-1][i];\n\t\t\tSUM(rt,2,i)=f[l+1][i];\n\t\t}\n\t\tfor(int i=1;i<=3;i++)\n\t\tfor(int j=1;j<=3;j++)\n\t\tDATA(rt,i,j)=SUM(rt,1,i)*SUM(rt,2,j)%MOD;\n\t\treturn;\n\t}\n\tint mid=LSIDE(rt)+RSIDE(rt)>>1;\n\tbuildtree(l,mid,LSON);\n\tbuildtree(mid+1,r,RSON);\n\tpushup(rt);\n}\nvoid update_add(int l,int r,int c,int rt){//\u533a\u95f4\u52a0\n\tif(l<=LSIDE(rt)&&RSIDE(rt)<=r){\n\t\tADD(rt)+=c;\n\t\tpushdown_sign(rt,1,c);\n\t\treturn;\n\t}\n\tpushdown(rt);\n\tint mid=LSIDE(rt)+RSIDE(rt)>>1;\n\tif(l<=mid)update_add(l,r,c,LSON);\n\tif(mid<r)update_add(l,r,c,RSON);\n\tpushup(rt);\n}\nvoid update_del(int l,int r,int c,int rt){//\u533a\u95f4\u51cf\n\tif(l<=LSIDE(rt)&&RSIDE(rt)<=r){\n\t\tDEL(rt)+=c;\n\t\tpushdown_sign(rt,2,c);\n\t\treturn;\n\t}\n\tpushdown(rt);\n\tint mid=LSIDE(rt)+RSIDE(rt)>>1;\n\tif(l<=mid)update_del(l,r,c,LSON);\n\tif(mid<r)update_del(l,r,c,RSON);\n\tpushup(rt);\n}\nlong long query(int l,int r,int rt){//\u533a\u95f4\u6c42\u548c\n\tif(l>r)return 0;//\u7279\u5224\u4e00\u4e0b\n\tlong long ans=0;\n\tif(l<=LSIDE(rt)&&RSIDE(rt)<=r)return DATA(rt,3,1);\n\tpushdown(rt);\n\tint mid=LSIDE(rt)+RSIDE(rt)>>1;\n\tif(l<=mid)ans=(ans+query(l,r,LSON))%MOD;\n\tif(mid<r)ans=(ans+query(l,r,RSON))%MOD;\n\treturn ans;\n}\n\n//-------------------\u4ee5\u4e0a\u662f\u7ebf\u6bb5\u6811-------------------\n\nvoid work(){\n\tchar ch[7];\n\tint x,y,l,r;\n\twhile(m--){\n\t\tscanf(\"%s\",ch);x=read();y=read();\n\t\tif(ch[0]=='p'){//\u6ce8\u610f\u8fb9\u754c\u95ee\u9898\u4ee5\u53ca\u4e0d\u5fc5\u8981\u7684\u641c\u7d22\n        \n\t\t\tl=x+1;r=y+1;\n\t\t\tif(r>n)r=n;\n\t\t\tif(l<=r)update_add(l,r,1,1);\n            \n\t\t\tl=x-1;r=y-1;\n\t\t\tif(l<1)l=1;\n\t\t\tif(l<=r)update_del(l,r,1,1);\n\t\t}\n\t\telse if(ch[0]=='m'){\n        \n\t\t\tl=x+1;r=y+1;\n\t\t\tif(r>n)r=n;\n\t\t\tif(l<=r)update_add(l,r,-1,1);\n            \n\t\t\tl=x-1;r=y-1;\n\t\t\tif(l<1)l=1;\n\t\t\tif(l<=r)update_del(l,r,-1,1);\n\t\t}\n\t\telse printf(\"%lld\\n\",query(x+1,y-1,1));\n\t}\n}\nvoid init(){\n\tn=read();m=read();A=read();B=read();\n\tinv=mexp(A,MOD-2,MOD);//\u9884\u5904\u7406\u9006\u5143\n\tbuild();\n\tfor(int i=1;i<=n;i++){//\u9884\u5904\u7406f\u51fd\u6570\n\t\tf[i][0]=read();\n\t\tfunction(i);\n\t\tf[i][3]=(f[i][2]+f[i][1]*A%MOD+B)%MOD;\n\t}\n\tbuildtree(1,n,1);\n}\nint main(){//\u4e3b\u51fd\u6570So easy!\n\tinit();\n\twork();\n    return 0;\n}\n\n```",
        "postTime": 1536588173,
        "uid": 49998,
        "name": "\u65af\u5fb7\u54e5\u5c14\u6469",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 P3328 \u3010[SDOI2015]\u97f3\u8d28\u68c0\u6d4b\u3011"
    }
]