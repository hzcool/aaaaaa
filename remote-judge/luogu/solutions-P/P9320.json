[
    {
        "content": "\u6811\u72b6\u6570\u7ec4+ODT \u505a\u6cd5\uff0c\u4ee3\u7801\u5f88\u77ed\uff0c\u8dd1\u7684\u4e5f\u5f88\u5feb\u3002~~\u8fd9\u5c31\u662f\u73c2\u6735\u8389\u5e26\u7ed9\u6211\u7684\u81ea\u4fe1\uff01\uff01\uff01~~\n\n\u9996\u5148\u7528 ODT \u7ef4\u62a4\u6bcf\u4e2a\u6e38\u5ba2\u6240\u5728\u7684\u57ce\u5e02\u7f16\u53f7\uff0c\u8003\u8651\u5982\u4f55\u7ef4\u62a4\u6bcf\u4e2a\u6e38\u5ba2\u7684\u8bc4\u5206\u3002\n\n\u53ef\u4ee5\u5bf9\u6bcf\u4e2a\u57ce\u5e02\u6253\u4e00\u4e2a `tag` \u7ef4\u62a4\u6bcf\u4e2a\u57ce\u5e02\u901a\u8fc7 `e` \u64cd\u4f5c\u52a0\u5f97\u7684\u8bc4\u5206\uff0c\u90a3\u4e48\u5728\u57ce\u5e02 $col$ \u7684\u6e38\u5ba2 $i$\uff0c\u8bbe\u5176\u8bc4\u5206\u4e3a $d_{col}+val_i$\u3002\n\n\u90a3\u4e48\u5bf9\u4e8e `t` \u64cd\u4f5c\uff0c\u5c31\u662f\u88f8\u7684\u5728 ODT \u4e0a\u533a\u95f4\u8d4b\u503c\u3002  \n\u800c\u5bf9\u4e8e\u4e00\u4e2a\u989c\u8272\u6bb5\u7684\u6574\u4f53\u4fee\u6539\uff0c\u53d1\u73b0\u4f1a\u8ba9\u8fd9\u4e2a\u533a\u95f4\u7684 $val$ \u503c\u6574\u4f53\u52a0\u4e0a\u4e00\u4e2a\u6570\uff0c\u7528\u6811\u72b6\u6570\u7ec4\u7ef4\u62a4\u3002\n\n\u5bf9\u4e8e `e` \u64cd\u4f5c\uff0c\u5c31\u662f\u76f4\u63a5\u5bf9 $d$ \u503c\u5355\u70b9\u4fee\u6539\u3002\n\n\u5bf9\u4e8e `q` \u64cd\u4f5c\uff0c\u8f93\u51fa\u8bc4\u5206 $d_{col}+val_i$\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(n \\log n)$\u3002\n\n\u5177\u4f53\u5b9e\u73b0\u8be6\u89c1\u4ee3\u7801\uff1a\n```cpp\n#include<bits/stdc++.h>\n#define ll long long\nusing namespace std;\nconst int N=2e5+10;\nint n,m,q,a[N];\nll val[N];\nint tot,head[N],ver[N<<1],nxt[N<<1];\nvoid add(int u,int v){ver[++tot]=v,nxt[tot]=head[u],head[u]=tot;}\nint sz[N],son[N],fa[N],top[N],dep[N];\nvoid dfs1(int x){\n\tsz[x]=1;\n\tfor(int i=head[x],y;i;i=nxt[i]){\n\t\ty=ver[i];\n\t\tif(y==fa[x]) continue;\n\t\tfa[y]=x,dep[y]=dep[x]+1;\n\t\tdfs1(y);\n\t\tsz[x]+=sz[y];\n\t\tif(sz[y]>sz[son[x]]) son[x]=y;\n\t}\n}\nvoid dfs2(int x,int topf){\n\ttop[x]=topf;\n\tif(son[x]) dfs2(son[x],topf);\n\tfor(int i=head[x],y;i;i=nxt[i]){\n\t\ty=ver[i];\n\t\tif(y==fa[x]||y==son[x]) continue;\n\t\tdfs2(y,y);\n\t}\n}\nint lca(int x,int y){\n\twhile(top[x]!=top[y]){\n\t\tif(dep[top[x]]<dep[top[y]]) swap(x,y);\n\t\tx=fa[top[x]];\n\t}\n\treturn dep[x]<dep[y]?x:y;\n}\nint dis(int x,int y){\n\tint lc=lca(x,y);\n\treturn 2*dep[lc]-dep[x]-dep[y];\n}\nll t[N],d[N];\nint lowbit(int x){return x&-x;}\nvoid addt(int x,ll k){for(;x<=m;x+=lowbit(x)) t[x]+=k;}\nll ask(int x){ll res=0;for(;x;x-=lowbit(x)) res+=t[x];return res;}\n\nstruct chtholly{\n\tint l,r,v;\n\tbool operator<(const chtholly &A)const{return l<A.l;}\n};\nset<chtholly> s;\nset<chtholly>::iterator split(int x){\n\tset<chtholly>::iterator it=s.lower_bound((chtholly){x,0,0});\n\tif(it!=s.end()&&it->l==x) return it;\n\tit--;\n\tif(it->r<x) return s.end();\n\tint l=it->l,r=it->r,v=it->v;\n\ts.erase(it);\n\ts.insert((chtholly){l,x-1,v});\n\treturn s.insert((chtholly){x,r,v}).first;\n}\nvoid assign(int l,int r,int k){\n\tset<chtholly>::iterator itr=split(r+1),itl=split(l);\n\tfor(set<chtholly>::iterator it=itl;it!=itr;++it) \n\t\taddt(it->l,dis(it->v,k)+d[it->v]-d[k]),\n\t\taddt(it->r+1,-dis(it->v,k)-d[it->v]+d[k]);\n\ts.erase(itl,itr);\n\ts.insert((chtholly){l,r,k});\n}\nll query(int x){\n\tset<chtholly>::iterator it=prev(s.upper_bound((chtholly){x,0,0}));\n\treturn ask(x)+d[it->v];\n}\nint main(){\n\tscanf(\"%d%d%d\",&n,&m,&q);\n\tfor(int i=1;i<=m;++i) scanf(\"%d\",a+i),s.insert((chtholly){i,i,a[i]});\n\tfor(int i=1,u,v;i<n;++i) scanf(\"%d%d\",&u,&v),add(u,v),add(v,u);\n\tdep[1]=1;dfs1(1);dfs2(1,1);\n\tint l,r,p;\n\tll v;\n\tchar op[5];\n\twhile(q--){\n\t\tscanf(\"%s\",op);\n\t\tif(op[0]=='t'){\n\t\t\tscanf(\"%d%d%d\",&l,&r,&p);\n\t\t\tassign(l,r,p);\n\t\t}\n\t\telse if(op[0]=='e'){\n\t\t\tscanf(\"%d%lld\",&p,&v);\n\t\t\td[p]+=v;\n\t\t}\n\t\telse scanf(\"%d\",&p),printf(\"%lld\\n\",query(p));\n\t}\n\treturn 0;\n}\n```\n",
        "postTime": 1684634913,
        "uid": 255581,
        "name": "gao_yc",
        "ccfLevel": 0,
        "title": "P9320 [EGOI2022] Tourists / \u4e4c\u6258\u90a6\u65c5\u884c\u56e2 \u9898\u89e3"
    },
    {
        "content": "## problem\n\u4e00\u4e2a\u957f\u4e3a $m$ \u7684\u6570\u7ec4 $a$\uff0c\u6bcf\u4e2a\u6570\u7684\u53d6\u503c\u4e3a $[1,n]$ \u7684\u6b63\u6574\u6570\uff1b\u53e6\u5916\u6709\u4e00\u4e2a\u957f\u4e3a $m$ \u7684\u6570\u7ec4 $b$\uff0c\u521d\u59cb\u5168\u96f6\uff1b\u53e6\u5916\u6709\u4e00\u68f5 $n$ \u4e2a\u70b9\u7684\u6811\uff0c\u6c42\u6811\u4e0a\u4e24\u70b9\u8ddd\u79bb\u7684\u51fd\u6570\u4e3a $dist$\u3002\u8bf7\u652f\u6301\u4e09\u79cd\u64cd\u4f5c\uff1a\n- \u8f93\u5165 $l,r,c$\uff0c\u679a\u4e3e $i\\in [l,r]$\uff0c\u4f7f\u5f97 $b_i\\gets b_i-dist(a_i,c)$\uff0c\u7136\u540e $a_i\\gets c$\u3002\n- \u8f93\u5165 $c,d$\uff0c\u5bf9\u6240\u6709 $a_i=c$ \u7684 $i$\uff0c\u4f7f\u5f97 $b_i\\gets b_i+d$\u3002\n- \u8f93\u5165 $i$\uff0c\u67e5\u8be2 $b_i$\u3002\n\n\u6570\u636e\u8303\u56f4\u5168\u90e8\u4e3a\u4e8c\u5341\u4e07\u3002\n\n## solution\n\u5982\u679c\u6ca1\u6709\u64cd\u4f5c\u4e8c\uff0c\u6211\u4eec\u53ef\u4ee5\u989c\u8272\u6bb5\u5747\u644a\uff08\u6216\u8005\u53eb\u201c\u73c2\u6735\u8389\u6811\u201d\uff09\uff1a\u7528 `std::set` \u66b4\u529b\u7684\u8fdb\u884c\u533a\u95f4\u63a8\u5e73\u3002\u4f46\u662f\u73b0\u5728\u6709\u8fd9\u6837\u7684\u64cd\u4f5c\uff0c\u4f1a\u4f7f\u5f97\u590d\u6742\u5ea6\u5047\u6389\u3002\n\n\u8003\u8651\u6539\u6210\u7ebf\u6bb5\u6811\uff0c\u5728\u7ebf\u6bb5\u6811\u4e0a\u8fdb\u884c\u533a\u95f4\u8986\u76d6\uff0c\u4ee3\u66ff\u8fd9\u4e2a\u989c\u8272\u6bb5\u5747\u644a\u7684\u8fc7\u7a0b\u3002\n\n\u6211\u4eec\u60f3\u8c61\uff0c\u5bf9\u4e8e\u4e00\u4e2a $a_i$\uff0c\u5b83\u7684\u6bcf\u4e00\u6b21\u4fee\u6539\uff08\u4ece $a_i=c$ \u6539\u4e3a $d$\uff09\uff0c\u4f1a\u4f7f\u5f97 $b$ \u589e\u52a0 $-dist(c,d)$ \u52a0\u4e0a\u8fd9\u4e00\u6bb5\u65f6\u95f4\u57ce\u5e02 $c$ \u4ea7\u751f\u7684\u4ef7\u503c\u3002  \n\u4e5f\u5c31\u662f\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u70b9\uff0c\u6211\u4eec\u60f3\u8c61\u6253\u5728\u5b83\u8eab\u4e0a\u7684\u662f\u4e00\u5806\u5f62\u5982 $(t,u)$ \u7684\u64cd\u4f5c\uff0c\u8868\u793a\u5728 $t$ \u65f6\u523b\u8fd9\u4e2a\u4eba\u8d70\u5230 $u$ \u70b9\uff0c\u5b83\u7684\u4ef7\u503c\u53ef\u4ee5\u901a\u8fc7\u8ba1\u7b97\u4e24\u4e2a\u64cd\u4f5c\u7684\u4ef7\u503c\u5f97\u5230\u3002\n\uff08\u5b9a\u4e49\u51fd\u6570 $f:(t_1,u_1)\\to(t_2,u_2)$\uff0c\u8868\u793a\u524d\u4e00\u4e2a\u64cd\u4f5c\u4ea7\u751f\u7684\u603b\u8d21\u732e\uff0c\u8fd9\u4e2a\u662f\u7528\u53ef\u6301\u4e45\u5316\u7ebf\u6bb5\u6811\uff09\n\n\u8fd9\u4e00\u5806\u64cd\u4f5c\uff0c\u662f\u53ef\u4ee5\u5408\u5e76\u7684\uff1a\u6211\u4eec\u5c06\u64cd\u4f5c\u6253\u5305\u79f0\u4e3a\u64cd\u4f5c\u5305\uff0c\u8bb0\u5f55\u7b2c\u4e00\u4e2a\u64cd\u4f5c\u548c\u6700\u540e\u4e00\u4e2a\u64cd\u4f5c\uff0c\u4ee5\u53ca\u603b\u5171\u4ea7\u751f\u7684\u8d21\u732e\uff1b\u90a3\u4e48\u4e24\u4e2a\u64cd\u4f5c\u5305\u5408\u5e76\u7684\u65f6\u5019\uff0c\u53ea\u9700\u8981\u8ba1\u7b97\u524d\u4e00\u4e2a\u7684\u6700\u540e\u4e00\u4e2a\u548c\u540e\u4e00\u4e2a\u7684\u7b2c\u4e00\u4e2a\u7684\u8d21\u732e\u5373\u53ef\u3002\n\n\u5c06\u8fd9\u4e2a\u64cd\u4f5c\u5305\u4f5c\u4e3a\u61d2\u6807\u8bb0\u6253\u5230\u7ebf\u6bb5\u6811\u4e0a\u5373\u53ef\u3002\u603b\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u662f $O(n\\log^2 n)$\u3002\n\n## code\n\n\u4e0d\u77e5\u9053\u90a3\u4e9b 1s \u7684\u4eba\u600e\u4e48\u8fc7\u7684\uff0c\u6211\u53ea\u80fd 4s\u3002\n```cpp\n\n#include <cstdio>\n#include <vector>\n#include <cstring>\n#include <algorithm>\nusing namespace std;\n#ifdef LOCAL\n#define debug(...) fprintf(stderr,##__VA_ARGS__)\n#else\n#define debug(...) void(0)\n#endif\ntypedef long long LL;\ntemplate<int N> struct egoi2022{\n\tint ch[N+10][2],tot; LL val[N+10];\n\tint newnode(int q=0){int p=++tot;return memcpy(ch[p],ch[q],sizeof ch[0]),val[p]=val[q],p;}\n\tegoi2022():tot(0){val[0]=0,memset(ch[0],0,sizeof ch[0]);}\n\tvoid build(int &p,int l,int r){\n\t\tp=newnode();\n\t\tif(l==r) return ;\n\t\tint mid=(l+r)>>1;\n\t\tbuild(ch[p][0],l,mid),build(ch[p][1],mid+1,r);\n\t}\n\tint modify(int x,LL k,int p,int l,int r){\n\t\tint q=newnode(p);\n\t\tif(l==r) return val[q]+=k,q;\n\t\tint mid=(l+r)>>1;\n\t\tif(x<=mid) ch[q][0]=modify(x,k,ch[p][0],l,mid);\n\t\telse ch[q][1]=modify(x,k,ch[p][1],mid+1,r);\n\t\treturn q;\n\t}\n\tLL query(int x,int p,int l,int r){\n\t\tif(!p||l==r) return val[p];\n\t\tint mid=(l+r)>>1;\n\t\tif(x<=mid) return query(x,ch[p][0],l,mid);\n\t\telse return query(x,ch[p][1],mid+1,r);\n\t}\n};\nstruct node{\n//\tint t,u; LL s;//\u89c4\u5b9a t=0 \u4e3a\u7a7a\u72b6\u6001\n\tint tl,tr,ul,ur; LL s;\n};\nnode O={0,0,0,0,0};\nLL calc(int lt,int rt,int u);\ntemplate<int N> struct segtree{\n\tnode tag[N<<2];\n\tvoid build(int a[],int p,int l,int r){\n\t\tif(l==r) return tag[p]={1,1,a[l],a[l],0ll},void();\n\t\tint mid=(l+r)>>1; tag[p]=O;\n\t\tbuild(a,p<<1,l,mid),build(a,p<<1|1,mid+1,r);\n\t}\n\tvoid add(node k,int p){tag[p]+=k;}\n\tvoid pushdown(int p){add(tag[p],p<<1),add(tag[p],p<<1|1),tag[p]=O;}\n\tvoid modify(int L,int R,node k,int p,int l,int r){\n\t\tif(L<=l&&r<=R) return add(k,p);\n\t\tint mid=(l+r)>>1; pushdown(p);\n\t\tif(L<=mid) modify(L,R,k,p<<1,l,mid);\n\t\tif(mid<R) modify(L,R,k,p<<1|1,mid+1,r);\n\t}\n\tLL query(int tim,int x,int p,int l,int r){\n\t\tif(l==r) return tag[p].s+calc(tag[p].tr,tim,tag[p].ur);\n\t\tint mid=(l+r)>>1; pushdown(p);\n\t\tif(x<=mid) return query(tim,x,p<<1,l,mid);\n\t\telse return query(tim,x,p<<1|1,mid+1,r);\n\t}\n};\nint n,m,Q,a[1<<18],root[1<<18],fa[19][1<<18],dep[1<<18];\nvector<int> g[1<<18];\nsegtree<1<<18> t;\negoi2022<1<<23> T;\nvoid dfs(int u,int f=0){fa[0][u]=f,dep[u]=dep[f]+1; for(int v:g[u]) if(v!=f) dfs(v,u);}\nint lca(int u,int v){\n\tint d=dep[u]-dep[v]; if(d<0) swap(u,v),d=-d;\n\tfor(int j=18;j>=0;j--) if(d>>j&1) u=fa[j][u];\n\tif(u==v) return u;\n\tfor(int j=18;j>=0;j--) if(fa[j][u]!=fa[j][v]) u=fa[j][u],v=fa[j][v];\n\treturn fa[0][u];\n}\nint dist(int u,int v){return dep[u]+dep[v]-2*dep[lca(u,v)];}\nLL calc(int lt,int rt,int u){return T.query(u,root[rt],1,n)-T.query(u,root[lt-1],1,n);}\nbool operator==(node a,node b){\n\treturn a.tl==b.tl&&a.tr==b.tr&&a.ul==b.ul&&a.ur==b.ur&&a.s==b.s;\n}\nnode operator+=(node &a,node b){\n\tif(b==O) return a; else if(a==O) return a=b;\n\treturn a={\n\t\ta.tl,b.tr,a.ul,b.ur,\n\t\ta.s+b.s-dist(a.ur,b.ul)+calc(a.tr,b.tl-1,a.ur)\n\t};\n}\nint main(){\n//\t#ifdef LOCAL\n//\t \tfreopen(\"input.in\",\"r\",stdin);\n//\t#endif\n\tscanf(\"%d%d%d\",&n,&m,&Q);\n\tfor(int i=1;i<=m;i++) scanf(\"%d\",&a[i]);\n\tt.build(a,1,1,m);\n\tT.build(root[0],1,n);\n\tfor(int i=1,u,v;i<n;i++) scanf(\"%d%d\",&u,&v),g[u].push_back(v),g[v].push_back(u);\n\tdfs(1);\n\tfor(int j=1;j<=18;j++) for(int i=1;i<=n;i++) fa[j][i]=fa[j-1][fa[j-1][i]];\n\tfor(int i=2;i<=Q+1;i++){\n\t\troot[i]=root[i-1];\n\t\tchar op;\n\t\tscanf(\" %c\",&op);\n\t\tif(op=='t'){\n\t\t\tint l,r,c;\n\t\t\tscanf(\"%d%d%d\",&l,&r,&c);\n\t\t\tt.modify(l,r,{i,i,c,c,0},1,1,m);\n\t\t}else if(op=='e'){\n\t\t\tint c,d;\n\t\t\tscanf(\"%d%d\",&c,&d);\n\t\t\troot[i]=T.modify(c,d,root[i],1,n);\n\t\t}else{\n\t\t\tint x;\n\t\t\tscanf(\"%d\",&x);\n\t\t\tprintf(\"%lld\\n\",t.query(i,x,1,1,m));\n\t\t}\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1683530278,
        "uid": 509229,
        "name": "yukimianyan",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P9320 \u3010[EGOI2022] Tourists\u3011"
    }
]