[
    {
        "content": " ## [\u9898\u610f](https://blog.csdn.net/BeNoble_/article/details/79775006)\n\n\u7ed9\u4f60\u4e00\u4e2a\u5e8f\u5217,\u6bcf\u6b21\u8be2\u95ee\u4e00\u4e2a\u533a\u95f4,\u6c42\u5176\u6240\u6709\u5b50\u533a\u95f4\u7684\u6700\u5c0f\u503c\u4e4b\u548c\n\n---\n\n## \u9898\u89e3\n\n\u8fd9\u91cc\u6709\u4e24\u79cd\u65b9\u6cd5,\u4e00\u79cd\u662f\u79bb\u7ebf\u7684\u83ab\u961f,\u4e00\u79cd\u662f\u5728\u7ebf\u7b97\u6cd5\n\n### \u4e00.\u83ab\u961f\n\n\u8fd9\u9898\u96be\u5c31\u96be\u5728\u600e\u4e48\u7531$[l,r]$\u63a8\u5411$[l,r+1]$\n\n\u8003\u8651\u4ed6\u4eec\u4e4b\u95f4\u7684\u589e\u91cf\u5c31\u662f\u65b0\u589e\u7684$[l,r+1],[l+1,r+1],\\ldots,[r+1,r+1]$\u8fd9$r-l+2$\u4e2a\u533a\u95f4\u7684\u6700\u5c0f\u503c\u4e4b\u548c\n\n\u8003\u8651\u6c42\u51fa$[l,r+1]$\u7684\u6700\u5c0f\u503c\u4f4d\u7f6e\u662f$p$,\u90a3\u4e48\u6240\u6709\u5de6\u7aef\u70b9\u5728$[l,p]$\u4e4b\u95f4\u7684\u533a\u95f4\u7b54\u6848\u90fd\u662f$a[p]$\n\n\u8d21\u732e\u5c31\u662f$a[p]\\times(p-l+1)$,\u8fd9\u4e00\u90e8\u5206\u53ef\u4ee5\u7528$rmq$\u6c42\u6700\u5c0f\u503c\u5904\u7406\n\n\u8003\u8651\u5269\u4e0b\u7684\u5de6\u7aef\u70b9\u5728$[p+1,r+1]$\u7684\u533a\u95f4\n\n\u8bbe$f[l][r]$\u8868\u793a\u4ee5$r$\u4e3a\u53f3\u7aef\u70b9,\u5de6\u7aef\u70b9\u5728$[l,r]$\u7684\u533a\u95f4\u7684\u7b54\u6848(\u8981\u6c42\u7684\u5c31\u662f$f[p+1][r+1]$)\n\n\u8bb0\u5f55\u4e00\u4e0b$pre_i$\u8868\u793a\u4ece$i$\u5411\u524d\u7b2c\u4e00\u4e2a\u6bd4$i$\u5c0f\u7684\u6570\u7684\u4f4d\u7f6e(\u8fd9\u4e2a\u53ef\u4ee5\u7528\u5355\u8c03\u6808$O(n)$\u6c42\u51fa)\n\n\u90a3\u4e48\u5de6\u7aef\u70b9\u5728$[pre_r,r]$\u7684\u533a\u95f4\u6700\u5c0f\u503c\u90fd\u662f$a[r]$\n\n\u90a3\u4e48\u5c31\u6709$f[l][r]=f[l][pre_r]+a_r\\times(r-pre_r)$\n\n\u53ef\u4ee5\u53d1\u73b0$dp$\u589e\u91cf\u53ea\u548c$r$\u81ea\u8eab\u6709\u5173,\u6240\u4ee5\u53ef\u4ee5\u53bb\u6389$l$\u90a3\u4e00\u7ef4\n\n>\u56e0\u4e3a\u6700\u7ec8\u4e00\u5b9a\u4f1a\u5b58\u5728\u4e00\u4e2a\u70b9$x$,\u6ee1\u8db3$pre_x=p$\n\n>\u90a3\u4e48$f_{r+1}=a_{r+1}\\times(r+1-pre_{r+1})+\\ldots+a_x\\times(x-p)+f_p$\n\n>\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0$f_{r+1}-f_p$\u5c31\u662f\u539f\u6765\u8981\u6c42\u7684$f[p+1][r+1]$\n\n\u8fd9\u6837\u6211\u4eec\u5c31\u53ef\u4ee5\u9884\u5904\u7406\u51fa$f$,\u7136\u540e\u5c31\u53ef\u4ee5$O(1)$\u5b8c\u6210\u8f6c\u79fb\u4e86\n\n\u5220\u9664\u7684\u8bdd\u6211\u4eec\u5c31\u51cf\u53bb$[l,r-1]\\to[l,r]$\u7684\u589e\u91cf\u5c31\u597d\u4e86\n\n\u81f3\u4e8e\u5728\u5de6\u8fb9\u52a0,\u5c31\u5bf9\u79f0\u5904\u7406\u5c31\u597d\u4e86\n\n\u590d\u6742\u5ea6$O(n\\log n+n\\sqrt n)$\n\n($rmq$\u7684$qry$\u91cc$R-(1<<t)+1$\u7684\"$+1$\u201d,\u5fd8\u8bb0\u6253\u4e86\u8c03\u4e86\u4e00\u4e2a\u5c0f\u65f6$/$\u4e00\u8138\u60b2\u4f24)\n\n```\n#include<bits/stdc++.h>\n#define fp(i,a,b) for(register int i=a,I=b+1;i<I;++i)\n#define fd(i,a,b) for(register int i=a,I=b-1;i>I;--i)\n#define go(u) for(register int i=fi[u],v=e[i].to;i;v=e[i=e[i].nx].to)\n#define file(s) freopen(s\".in\",\"r\",stdin),freopen(s\".out\",\"w\",stdout)\ntemplate<class T>inline bool cmax(T&a,const T&b){return a<b?a=b,1:0;}\ntemplate<class T>inline bool cmin(T&a,const T&b){return a>b?a=b,1:0;}\nusing namespace std;\nchar ss[1<<17],*A=ss,*B=ss;\ninline char gc(){return A==B&&(B=(A=ss)+fread(ss,1,1<<17,stdin),A==B)?-1:*A++;}\ntemplate<class T>inline void sd(T&x){\n    char c;T y=1;while(c=gc(),(c<48||57<c)&&c!=-1)if(c==45)y=-1;x=c-48;\n    while(c=gc(),47<c&&c<58)x=x*10+c-48;x*=y;\n}\nchar sr[1<<21],z[20];int C=-1,Z;\ninline void Ot(){fwrite(sr,1,C+1,stdout),C=-1;}\ntemplate<class T>inline void we(T x){\n    if(C>1<<20)Ot();if(x<0)sr[++C]=45,x=-x;\n    while(z[++Z]=x%10+48,x/=10);\n    while(sr[++C]=z[Z],--Z);sr[++C]='\\n';\n}\nconst int N=1e5+5,inf=2e9;\ntypedef int arr[N];\ntypedef long long ll;\nstruct Q{\n    int l,r,x,id;\n    inline bool operator<(const Q b)const{return x==b.x?x&1?r<b.r:r>b.r:x<b.x;}\n}q[N];\nint n,m,Sz,Top,Mi[17],f[N][17];arr a,pre,suf,S,Log;ll Now,fl[N],fr[N],ans[N];\ninline int cmp(const int x,const int y){return a[x]<a[y]?x:y;}\ninline int qry(int L,int R){int t=Log[R-L+1];return cmp(f[L][t],f[R-Mi[t]+1][t]);}\ninline ll left(int L,int R){int p=qry(L-1,R);return (ll)a[p]*(R-p+1)+fl[L-1]-fl[p];}\ninline ll right(int L,int R){int p=qry(L,R+1);return (ll)a[p]*(p-L+1)+fr[R+1]-fr[p];}\nint main(){\n    #ifndef ONLINE_JUDGE\n        file(\"s\");\n    #endif\n    sd(n);sd(m);Sz=sqrt(n);a[n+1]=a[0]=inf;\n    Mi[0]=1;fp(i,1,16)Mi[i]=Mi[i-1]<<1;\n    fp(i,2,n)Log[i]=Log[i>>1]+1;\n    fp(i,1,n)sd(a[i]),f[i][0]=i;\n    fp(j,1,Log[n])fp(i,1,n-Mi[j-1]+1)\n        f[i][j]=cmp(f[i][j-1],f[i+Mi[j-1]][j-1]);\n    fp(i,1,n){\n        while(Top&&a[S[Top]]>a[i])suf[S[Top--]]=i;\n        pre[i]=S[Top];S[++Top]=i;\n    }while(Top)pre[S[Top]]=S[Top-1],suf[S[Top--]]=n+1;\n    fp(i,1,n)fr[i]=(ll)a[i]*(i-pre[i])+fr[pre[i]];\n    fd(i,n,1)fl[i]=(ll)a[i]*(suf[i]-i)+fl[suf[i]];\n    int x,y,L,R;\n    fp(i,1,m)sd(x),sd(y),q[i]={x,y,x/Sz,i};\n    sort(q+1,q+m+1);L=q[1].l,R=L-1;\n    fp(i,1,m){\n        x=q[i].l,y=q[i].r;\n        while(L>x)Now+=left(L,R),L--;\n        while(R<y)Now+=right(L,R),R++;\n        while(L<x)Now-=left(L+1,R),++L;\n        while(R>y)Now-=right(L,R-1),--R;\n        ans[q[i].id]=Now;\n    }\n    fp(i,1,m)we(ans[i]);\nreturn Ot(),0;\n}\n```\n\n### \u4e8c.\u5728\u7ebf\u7b97\u6cd5\n\n\u6211\u4eec\u5047\u8bbe\u533a\u95f4$[l,r]$\u7684\u6700\u5c0f\u503c\u7684\u4f4d\u7f6e\u662f$p$\n\n\u90a3\u4e48\u5bf9\u4e8e\u5de6\u7aef\u70b9\u5728$[l,p]$,\u53f3\u7aef\u70b9\u5728$[p,r]$\u7684\u533a\u95f4\u6700\u5c0f\u503c\u90fd\u662f$a[p]$\n\n\u8fd9\u4e00\u90e8\u5206\u7684\u8d21\u732e\u662f$a[p]\\times(p-l+1)\\times(r-p+1)$\n\n\u6211\u4eec\u8fd8\u6ca1\u6709\u7edf\u8ba1$[l,p-1]$\u548c$[p+1,r]$\u7684\u7b54\u6848\n\n\u5728\u83ab\u961f\u7b97\u6cd5\u4e2d\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\n\n>\u56e0\u4e3a\u6700\u7ec8\u4e00\u5b9a\u4f1a\u5b58\u5728\u4e00\u4e2a\u70b9$x$,\u6ee1\u8db3$pre_x=p$\n\n>\u90a3\u4e48$f_{r+1}=a_{r+1}\\times(r+1-pre_{r+1})+\\ldots+a_x\\times(x-p)+f_p$\n\n>\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0$f_{r+1}-f_p$\u5c31\u662f\u539f\u6765\u8981\u6c42\u7684$f[p+1][r+1]$\n\n \u7136\u800c\u8fd9\u4e2a\u662f\u4ee5$r+1$\u4e3a\u53f3\u7aef\u70b9,\u5de6\u7aef\u70b9\u5728$(p,r+1]$\u7684\u7b54\u6848\n\n\u5728\u8fd9\u91cc\u6211\u4eec\u5c31\u8981\u8003\u8651\u5de6\u7aef\u70b9\u5728$(p,x]$,\u53f3\u7aef\u70b9\u5728$[x,r]$\u7684\u5168\u90e8\u7b54\u6848\n\n\u5bf9\u4e8e\u70b9$r$,\u6240\u6709\u4ee5$r$\u4e3a\u53f3\u7aef\u70b9,\u5de6\u7aef\u70b9\u5728$(p,r]$\u7684\u533a\u95f4\u7b54\u6848\u662f$f_r-f_p$\n\n\u5bf9\u4e8e\u70b9$r-1$,\u6240\u6709\u4ee5$r-1$\u4e3a\u53f3\u7aef\u70b9,\u5de6\u7aef\u70b9\u5728$(p,r-1]$\u7684\u533a\u95f4\u7b54\u6848\u662f$f_{r-1}-f_p$\n\n$\\ldots$\n\n\u5bf9\u4e8e\u70b9$p+1$,\u6240\u6709\u4ee5$p+1$\u4e3a\u53f3\u7aef\u70b9,\u5de6\u7aef\u70b9\u5728$(p,p+1]$\u7684\u533a\u95f4\u7b54\u6848\u662f$f_{p+1}-f_p$\n\n\u8bbe$g_i=\\sum_{j=1}^if_j$,\u901a\u8fc7\u89c2\u5bdf\u53d1\u73b0,\u8fd9\u4e00\u90e8\u5206\u7684\u7b54\u6848\u5c31\u662f$g_r-g_p-f_p\\times(r-p)$\n\n\u540c\u6837\u7684,$p$\u5de6\u8fb9\u7684\u60c5\u51b5\u4e5f\u662f\u7c7b\u4f3c\n\n\u590d\u6742\u5ea6$O(n\\log n)$\n```\n#include<bits/stdc++.h>\n#define fp(i,a,b) for(register int i=a,I=b+1;i<I;++i)\n#define fd(i,a,b) for(register int i=a,I=b-1;i>I;--i)\n#define go(u) for(register int i=fi[u],v=e[i].to;i;v=e[i=e[i].nx].to)\n#define file(s) freopen(s\".in\",\"r\",stdin),freopen(s\".out\",\"w\",stdout)\ntemplate<class T>inline bool cmax(T&a,const T&b){return a<b?a=b,1:0;}\ntemplate<class T>inline bool cmin(T&a,const T&b){return a>b?a=b,1:0;}\nusing namespace std;\nchar ss[1<<17],*A=ss,*B=ss;\ninline char gc(){return A==B&&(B=(A=ss)+fread(ss,1,1<<17,stdin),A==B)?-1:*A++;}\ntemplate<class T>inline void sd(T&x){\n    char c;T y=1;while(c=gc(),(c<48||57<c)&&c!=-1)if(c==45)y=-1;x=c-48;\n    while(c=gc(),47<c&&c<58)x=x*10+c-48;x*=y;\n}\nchar sr[1<<21],z[20];int C=-1,Z;\ninline void Ot(){fwrite(sr,1,C+1,stdout),C=-1;}\ntemplate<class T>inline void we(T x){\n    if(C>1<<20)Ot();if(x<0)sr[++C]=45,x=-x;\n    while(z[++Z]=x%10+48,x/=10);\n    while(sr[++C]=z[Z],--Z);sr[++C]='\\n';\n}\nconst int N=1e5+5,inf=2e9;\ntypedef int arr[N];\ntypedef long long ll;\nint n,m,Top,Mi[17],f[N][17];arr a,pre,suf,S,Log;ll fl[N],fr[N],gl[N],gr[N];\ninline int cmp(const int x,const int y){return a[x]<a[y]?x:y;}\ninline int qry(int L,int R){int t=Log[R-L+1];return cmp(f[L][t],f[R-Mi[t]+1][t]);}\nint main(){\n    #ifndef ONLINE_JUDGE\n        file(\"s\");\n    #endif\n    sd(n);sd(m);a[n+1]=a[0]=inf;\n    Mi[0]=1;fp(i,1,16)Mi[i]=Mi[i-1]<<1;\n    fp(i,2,n)Log[i]=Log[i>>1]+1;\n    fp(i,1,n)sd(a[i]),f[i][0]=i;\n    fp(j,1,Log[n])fp(i,1,n-Mi[j-1]+1)\n        f[i][j]=cmp(f[i][j-1],f[i+Mi[j-1]][j-1]);\n    fp(i,1,n){\n        while(Top&&a[S[Top]]>a[i])suf[S[Top--]]=i;\n        pre[i]=S[Top];S[++Top]=i;\n    }while(Top)pre[S[Top]]=S[Top-1],suf[S[Top--]]=n+1;\n    fp(i,1,n)fr[i]=(ll)a[i]*(i-pre[i])+fr[pre[i]],gr[i]=gr[i-1]+fr[i];\n    fd(i,n,1)fl[i]=(ll)a[i]*(suf[i]-i)+fl[suf[i]],gl[i]=gl[i+1]+fl[i];\n    int l,r,p;\n    while(m--){\n        sd(l),sd(r),p=qry(l,r);\n        we((ll)(p-l+1)*(r-p+1)*a[p]+\n            gr[r]-gr[p]-fr[p]*(r-p)+\n\t\t\tgl[l]-gl[p]-fl[p]*(p-l));\n    }\nreturn Ot(),0;\n}\n```\n\n\u5230\u8fd9\u91cc\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0,\u8fd9\u4e2a\u7b97\u6cd5\u7684\u590d\u6742\u5ea6\u74f6\u9888\u5c31\u5728\u4e8e$rmq$\u4e86\n\n\u6734\u7d20\u500d\u589e$rmq$\u9884\u5904\u7406\u901f\u5ea6\u592a\u6162\n\n\u6211\u4eec\u53ef\u4ee5$O(n)$\u5efa\u7acb\u7b1b\u5361\u5c14\u6811\u6765\u8fdb\u884c$rmq$,\u8bbe\u5355\u6b21\u8be2\u95ee\u590d\u6742\u5ea6$=k\\lt\\log n$\n\n\u6240\u4ee5\u8fd9\u9898\u53ef\u4ee5\u505a\u5230$O(n+km)$\n\n```\n#include<bits/stdc++.h>\n#define fp(i,a,b) for(register int i=a,I=b+1;i<I;++i)\n#define fd(i,a,b) for(register int i=a,I=b-1;i>I;--i)\n#define go(u) for(register int i=fi[u],v=e[i].to;i;v=e[i=e[i].nx].to)\n#define file(s) freopen(s\".in\",\"r\",stdin),freopen(s\".out\",\"w\",stdout)\ntemplate<class T>inline bool cmax(T&a,const T&b){return a<b?a=b,1:0;}\ntemplate<class T>inline bool cmin(T&a,const T&b){return a>b?a=b,1:0;}\nusing namespace std;\nchar ss[1<<17],*A=ss,*B=ss;\ninline char gc(){return A==B&&(B=(A=ss)+fread(ss,1,1<<17,stdin),A==B)?-1:*A++;}\ntemplate<class T>inline void sd(T&x){\n    char c;T y=1;while(c=gc(),(c<48||57<c)&&c!=-1)if(c==45)y=-1;x=c-48;\n    while(c=gc(),47<c&&c<58)x=x*10+c-48;x*=y;\n}\nchar sr[1<<21],z[20];int C=-1,Z;\ninline void Ot(){fwrite(sr,1,C+1,stdout),C=-1;}\ntemplate<class T>inline void we(T x){\n    if(C>1<<20)Ot();if(x<0)sr[++C]=45,x=-x;\n    while(z[++Z]=x%10+48,x/=10);\n    while(sr[++C]=z[Z],--Z);sr[++C]='\\n';\n}\nconst int N=1e5+5,inf=2e9;\ntypedef int arr[N];\ntypedef long long ll;\nint n,m,rt;arr a,lc,rc,pre,suf,S,Log;ll fl[N],fr[N],gl[N],gr[N];\ninline int cmp(const int x,const int y){return a[x]<a[y]?x:y;}\ninline int qry(int L,int R){for(int x=rt;;x=(x>R?lc:rc)[x])if(L<=x&&x<=R)return x;}\nint main(){\n    #ifndef ONLINE_JUDGE\n        file(\"s\");\n    #endif\n    sd(n);sd(m);a[n+1]=a[0]=inf;int*Top=S;\n    fp(i,1,n){\n        sd(a[i]);\n        while(Top!=S&&a[*Top]>=a[i])lc[i]=*Top--;\n        rc[*Top]=i;*++Top=i;\n    }rt=S[1];int top=0;\n    fp(i,1,n){\n        while(top&&a[S[top]]>a[i])suf[S[top--]]=i;\n        pre[i]=S[top];S[++top]=i;\n    }while(top)pre[S[top]]=S[top-1],suf[S[top--]]=n+1;\n    fp(i,1,n)fr[i]=(ll)a[i]*(i-pre[i])+fr[pre[i]],gr[i]=gr[i-1]+fr[i];\n    fd(i,n,1)fl[i]=(ll)a[i]*(suf[i]-i)+fl[suf[i]],gl[i]=gl[i+1]+fl[i];\n    int l,r,p;\n    while(m--){\n        sd(l),sd(r),p=qry(l,r);\n        we((ll)(p-l+1)*(r-p+1)*a[p]+\n            gr[r]-gr[p]-fr[p]*(r-p)+\n\t\t\tgl[l]-gl[p]-fl[p]*(p-l));\n    }\nreturn Ot(),0;\n}\n```\n\n\u4ece$O(n\\log n+n\\sqrt n)\\to O(n\\log n)\\to O(n+km)$\u53ef\u89c1\u8fd9\u9898\u591a\u4e48~~\u6bd2\u7624\u4e00\u822c\u7684~~\u4f18\u79c0\n\n\u8c8c\u4f3c\u53ef\u4ee5\u51fa\u4e00\u9053\u52a0\u5f3a\u7248(\u5f3a\u5236\u5728\u7ebf,\u6570\u636e\u8303\u56f4$n,m\\le 2\\times 10^6$)\n\n---\n\n$upd:2018.4.5$\n\n\u5514~\u7b1b\u5361\u5c14\u6811\u88ab$hack$\u4e86\n\n\u770b\u6765\u8fd9\u9898\u8fd8\u662f\u53ea\u80fd\u505a\u5230$O(n\\log n)$\n\n\u611f\u8c22@\u5154\u5b50\u63a5\u70e7\u997c \u6307\u51fa\u6211\u7a0b\u5e8f\u7684\u9519\u8bef\n",
        "postTime": 1522515316,
        "uid": 20156,
        "name": "Kelin",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P3246 \u3010[HNOI2016]\u5e8f\u5217\u3011"
    },
    {
        "content": "# \u5f15\u5165\n\u672c\u9898\u5927\u591a\u6570\u9898\u89e3\u4f7f\u7528\u7684\u90fd\u662f$\\color{Red}\\text{\u83ab\u961f}$\u7b97\u6cd5\uff0c\u8fd9\u79cd~~\u9ad8\u7aef\u9738\u6c14\u4e0a\u6863\u6b21~~\u7684\u7b97\u6cd5\u6211\u8fd9\u79cd\u849f\u84bb\u81ea\u7136\u662f\u4e0d\u4f1a\u7684\u3002\n\n\u90a3\u4e48\u5bf9\u4e8e\u8fd9\u9053\u9898\u6765\u8bf4\u849f\u84bb\u4eec\u7684\u51fa\u8def\u5728\u54ea\u91cc\u5462\uff1f\n\n\n\u7b54\u6848\u5c31\u662f$\\color{Red}\\text{\u4e8c\u7ef4\u5dee\u5206}$\uff01\n\n# \u601d\u8def\n## $\\mathtt{First \\;Step}\\;\\text{\u9006\u5411}$\n- \u65e2\u7136\u9898\u76ee\u4e2d\u8981\u6c42\u6211\u4eec\u6c42**\u4e00\u4e2a\u5e8f\u5217**\u7684\u6bcf\u4e00\u4e2a**\u5b50\u5e8f\u5217\u7684\u6700\u5c0f\u503c**\u7684**\u548c**\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u5f88\u81ea\u7136\u5730\u60f3\u5230\u4e24\u79cd\u6c42\u89e3\u65b9\u5f0f\uff1a\n\n\t$\\mathtt{1.}$\u901a\u8fc7**\u679a\u4e3e\u5b50\u5e8f\u5217**\u6765\u5f97\u5230\u6700\u5c0f\u503c\u5e76\u6700\u7ec8\u6c42\u548c\n    \n   $\\mathtt{2.}$\u901a\u8fc7**\u679a\u4e3e\u539f\u5e8f\u5217\u7684\u503c**\u6765\u5f97\u5230\u6bcf\u4e2a\u503c\u4f5c\u4e3a\u6700\u5c0f\u503c\u5bf9\u548c\u7684\u8d21\u732e\n   \n   \u76f8\u8f83\u4e8e\u7b2c\u4e8c\u79cd\u65b9\u5f0f\uff0c\u7b2c\u4e00\u79cd\u65b9\u5f0f\u9700\u8981\u679a\u4e3e\u7684\u6b21\u6570\u663e\u7136\u662f\u66f4\u591a\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u81ea\u7136\u62e9\u4f18\u628a\u7b2c\u4e8c\u79cd\u601d\u8def\u5ef6\u4f38\u4e0b\u53bb\u3002\n- \u5bf9\u4e8e\u539f\u5e8f\u5217\u4e2d\u7684\u4e00\u4e2a\u5143\u7d20$a_i$\uff0c\u5176\u5de6\u4fa7**\u7b2c\u4e00\u4e2a\u5c0f\u4e8e\u5176\u81ea\u8eab\u7684\u503c**\u7684\u5143\u7d20\u4e3a$a_{l_i}$\uff0c\u5176\u53f3\u4fa7**\u7b2c\u4e00\u4e2a\u5c0f\u4e8e\u7b49\u4e8e\u5176\u81ea\u8eab\u7684\u503c**\u7684\u5143\u7d20\u4e3a$a_{r_i}$\uff0c\u5219$a_i$**\u505a\u51fa\u8d21\u732e\u7684\u5e8f\u5217**\u7684\u5de6\u7aef\u70b9\u8303\u56f4\u4e3a$\\left[{l_i+1},i\\right]$\uff0c\u53f3\u7aef\u70b9\u8303\u56f4\u4e3a$\\left[i,{r_i-1}\\right]$\uff0c$l_i$\u4e0e$r_i$\u8fd9\u4e24\u4e2a\u503c\u6211\u4eec\u53ef\u901a\u8fc7\u5355\u8c03\u6808\u6765\u6c42\u5f97\uff08\u8fd9\u5e94\u8be5\u662f\u6bd4\u8f83\u57fa\u7840\u7684\u64cd\u4f5c\uff09\u3002\n\n## $\\mathtt{Second\\;Step}\\;\\text{\u8f6c\u5316}$\n- \u540c\u6837\u5730\uff0c\u5982\u679c\u53ea\u662f\u5355\u7eaf\u5730\u679a\u4e3e\uff0c\u5bf9\u4e8e\u6211\u4eec$1e5$\u7684\u8be2\u95ee\u663e\u7136\u4e5f\u662f\u4f1aT\u7206\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u7ee7\u7eed\u6df1\u5165\u601d\u8003\uff1a\n    \n    \u51b3\u5b9a\u672c\u9898\u7b54\u6848\u7684\u662f\u4ec0\u4e48\uff1f\u6700\u5c0f\u503c\uff1b\n    \n    \u51b3\u5b9a\u6700\u5c0f\u503c\u7684\u56e0\u7d20\u662f\u4ec0\u4e48\uff1f\u5e8f\u5217\uff1b\n    \n    \u51b3\u5b9a\u5e8f\u5217\u7684\u56e0\u7d20\u662f\u4ec0\u4e48\uff1f\u7aef\u70b9\uff1b\n    \n    \u7aef\u70b9\u6709\u51e0\u4e2a\uff1f\u4e24\u4e2a\u3002\n    \n    \u601d\u8003\u5230\u8fd9\u91cc\uff0c\u8f6c\u5316\u7684\u65b9\u5f0f\u5df2\u7ecf\u51fa\u73b0\u4e86\uff1a\u6211\u4eec\u53ef\u4ee5\u5c06\u4e00\u4e2a**\u5e8f\u5217\u8f6c\u5316\u4e3a\u4e00\u4e2a\u70b9**\uff0c\u70b9\u7684\u6a2a\u7eb5\u5750\u6807\u5206\u522b\u4e3a\u5e8f\u5217\u7684\u5de6\u53f3\u7aef\u70b9\uff0c\u70b9\u7684\u6743\u503c\u4e3a\u8fd9\u4e2a\u5e8f\u5217\u7684\u6700\u5c0f\u503c\u3002\n    \n- \u6309\u7167\u4e0a\u8ff0\u65b9\u5f0f\uff0c\u5bf9\u4e8e\u5e8f\u5217$a[l:r]$\uff0c\u6211\u4eec\u6240\u6c42\u7684\u5176\u6240\u6709**\u5b50\u5e8f\u5217\u7684\u6700\u5c0f\u503c\u4e4b\u548c**\u5c31\u76f8\u5f53\u4e8e\u4e8c\u7ef4\u5e73\u9762\uff08x\u8f74\u6b63\u65b9\u5411\u4e3a\u53f3\uff0cy\u8f74\u6b63\u65b9\u5411\u4e3a\u4e0b\uff09\u5185\u5de6\u4e0a\u89d2\u4e3a$(l,l)$\uff0c\u53f3\n\u4e0b\u89d2\u4e3a$(r,r)$\u7684\u4e00\u4e2a**\u77e9\u5f62\u5185\u7684\u70b9\u6743\u548c**\u3002\n\n-\t\u6211\u4eec\u89c4\u5b9a\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u5de6\u4e0a\u89d2\u4e3a$(1,1)$\u53f3\u4e0b\u89d2\u4e3a$(x,y)$\u7684\u77e9\u5f62\uff0c\u5176\u70b9\u6743\u548c\u8868\u793a\u4e3a$sum_{x,y}$\uff0c\u5219$2.2$\u4e2d\u77e9\u5f62\u9762\u79ef\u4e3a$sum_{l-1,l-1} + sum_{r,r} - sum_{l-1,r} - sum_{r,l-1}$\uff0c\u5373\u5c06\u539f\u67e5\u8be2\u77e9\u5f62**\u5206\u6210\u56db\u4e2a\u67e5\u8be2\u70b9**\u3002\n    \n    \u8fd9\u6837\uff0c\u67e5\u8be2\u7684\u8f6c\u5316\u5c31\u5b8c\u6210\u4e86\uff0c\u63a5\u4e0b\u6765\u5c31\u662f\u5904\u7406\u539f\u5e8f\u5217\u4e86\u3002\n- \u6309\u7167$2.1$\u6240\u8ff0\uff0c\u5904\u7406\u539f\u5e8f\u5217\u7684\u8fc7\u7a0b\u5c31\u76f8\u5f53\u4e8e**\u7ed9\u4e8c\u7ef4\u5e73\u9762\u4e2d\u7684\u70b9\u8d4b\u503c\u7684\u8fc7\u7a0b**\u3002\u7531\u4e8e\u539f\u5e8f\u5217\u4e2d\u7684\u5143\u7d20\u5f80\u5f80\u90fd\u662f**\u5bf9\u591a\u4e2a\u5e8f\u5217\u6709\u8d21\u732e**\u7684\uff0c\u6240\u4ee5\u8d4b\u503c\u7684\u8fc7\u7a0b\u5176\u5b9e\u662f**\u4e8c\u7ef4\u7684\u533a\u95f4\u4fee\u6539**\u3002\u7531$1.2$\u4e2d\u7684\u5206\u6790\u53ef\u77e5\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u5143\u7d20$a_i$\uff0c\u5904\u7406\u65f6\u9700\u8981\u5c06\u5de6\u4e0a\u89d2\u4e3a$(l_i+1,i)$\uff0c\u53f3\u4e0b\u89d2\u4e3a$(i,r_i-1)$\u7684\u77e9\u5f62\u5185\u7684\u70b9\u6743\u53d8\u4e3a$a_i$\u7684\u503c\u3002\n\n\t\u8fd9\u6837\uff0c\u539f\u5e8f\u5217\u7684\u5904\u7406\u4e5f\u5c31\u5b8c\u6210\u4e86\uff0c\u63a5\u4e0b\u6765\u5c31\u8be5\u770b\u770b\u5dee\u5206\u4f18\u5316\u4e86\u3002\n    \n## $\\mathtt{Third\\;Step}\\;\\text{\u5dee\u5206}$\n- \u7531$2.4$\u53ef\u77e5\uff0c\u5728\u5904\u7406\u8fc7\u7a0b\u4e2d\u6211\u4eec\u9700\u8981\u7528\u5230\u4e8c\u7ef4\u533a\u95f4\u4fee\u6539\uff0c\u7531\u6b64\u6211\u4eec\u81ea\u7136\u53ef\u4ee5\u60f3\u5230\u7528\u5dee\u5206\u6765\u4f18\u5316\uff08\u4e8c\u7ef4\u5dee\u5206\u8fd9\u91cc\u4e0d\u4e88\u8be6\u7ec6\u89e3\u6790\uff0c\u53ef\u4ee5\u81ea\u5df1BDFS\u4e00\u4e0b\uff09\u3002\n\n\t\u90a3\u4e48\u95ee\u9898\u5c31\u6765\u4e86\uff0c\u6211\u4eec\u5e94\u8be5\u600e\u6837\u5b8c\u6210\u533a\u95f4\u6c42\u548c\u7684\u64cd\u4f5c\u5462\uff1f\n- \u6211\u4eec\u5728$2.3$\u4e2d\u5df2\u7ecf\u89e3\u6790\u4e86\u4efb\u610f\u77e9\u5f62\u9762\u79ef\u7684\u6c42\u89e3\u65b9\u6cd5\uff0c\u6240\u4ee5\u6211\u4eec\u53ea\u9700\u8981\u8003\u8651\u5de6\u4e0a\u89d2\u4e3a$(1,1)$\u7684\u77e9\u5f62\u7684$sum$\u503c\u8be5\u600e\u6837\u6c42\u89e3\u5c31\u53ef\u4ee5\u4e86\u3002\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/wls5d52w.png)\n\n- \u6ce8\uff1a\u4e0a\u56fe\u5750\u6807\u6570\u503c\u65e0\u5b9e\u9645\u610f\u4e49\u3002\n- \u5bf9\u4e8e\u4e00\u4e2a\u4f4d\u7f6e$(i,j)$\uff0c$d_{i,j}$\u8868\u793a\u5dee\u5206\u6570\u7ec4\u7684\u503c\uff0c$p_{i,j}$\u8868\u793a\u70b9\u6743\uff0c\u5219$p_{i,j}=\\sum\\limits_{s = 1}^i\\sum\\limits_{t = 1}^jd_{s,t}$\uff0c$sum_{x,y}=\\sum\\limits_{i = 1}^x\\sum\\limits_{j = 1}^yp_{i,j}$\u3002\n\n\t\u56e0\u4e3a\u6211\u4eec\u5728\u533a\u95f4\u4fee\u6539\u65f6\u662f\u5bf9\u5dee\u5206\u6570\u7ec4\u8fdb\u884c\u7684\u8c03\u6574\uff0c\u6240\u4ee5\u6211\u4eec\u4e0d\u59a8\u63a2\u5bfb\u4e00\u4e0b$sum$\u4e0e$d$\u4e4b\u95f4\u7684\u5173\u7cfb\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u7701\u7565\u6389\u8f6c\u5316\u6210$p$\u7684\u6b65\u9aa4\u3002\n    \n    \u6211\u4eec\u8003\u8651\u5dee\u5206\u6570\u7ec4\u4e2d\u7684\u4e00\u4e2a\u5143\u7d20$d_{i,j}$\uff0c\u7531\u4e0a\u8ff0\u4e24\u4e2a\u516c\u5f0f\u53ef\u77e5\uff0c\u5b83\u5728\u8ba1\u7b97$sum_{x,y}$\u65f6\uff0c\u56fe\u4e2d**\u9ed1\u8272\u77e9\u5f62\u9762\u79ef\u5c31\u662f\u5b83\u88ab\u8ba1\u7b97\u7684\u6b21\u6570**\uff08\u5728\u9ed1\u8272\u77e9\u5f62\u4e2d\u7684\u6bcf\u4e00\u4e2a\u70b9\u7684$p$\u503c\u90fd\u5305\u542b\u6709$d_{i,j}$\uff09\u3002\u6362\u53e5\u8bdd\u8bf4\uff0c$d_{i,j}$\u5bf9$sum_{x,y}$\u7684\u8d21\u732e\u4e3a$(x-i+1)\\times(y-j+1)\\times d_{i,j}$\u3002\n   \n- \u7ed3\u5408\u4e0a\u8ff0\u5185\u5bb9\u6211\u4eec\u4fbf\u53ef\u4ee5\u5f97\u51fa$d$\u4e0e$sum$\u7684\u5173\u7cfb\uff1a\n\t\n    $sum_{x,y}=\\sum\\limits_{i = 1}^x\\sum\\limits_{j = 1}^y(x-i+1)\\times(y-j+1)\\times d_{i,j}$\n    \n## $\\mathtt{Forth \\;Step}\\;\\text{\u6811\u72b6\u6570\u7ec4}$\n- \u6709\u4e86\u5dee\u5206\uff0c\u81ea\u7136\u9003\u4e0d\u6389\u6811\u72b6\u6570\u7ec4\u3002\u9996\u5148\uff0c\u6211\u4eec\u5c06$3.5$\u4e2d\u5f97\u51fa\u7684\u5f0f\u5b50\u6574\u7406\u4e00\u4e0b\uff0c\u62c6\u5206\u6210\u56db\u4e2a\u90e8\u5206\uff1a\n\n\t$\\mathtt{1.}$ $(x+1)\\times(y+1)\\times\\sum\\limits_{i = 1}^x\\sum\\limits_{j = 1}^yd_{i,j}$\n    \n    $\\mathtt{2.}$ $-(x+1)\\times\\sum\\limits_{i = 1}^x\\sum\\limits_{j = 1}^yj\\times d_{i,j}$\n    \n    $\\mathtt{3.}$ $-(y+1)\\times\\sum\\limits_{i = 1}^x\\sum\\limits_{j = 1}^yi\\times d_{i,j}$\n    \n    $\\mathtt{4.}$ $\\sum\\limits_{i = 1}^x\\sum\\limits_{j = 1}^y i\\times j\\times d_{i,j}$\n    \n    \u8fd9\u6837\u6211\u4eec\u5c31\u9700\u8981\u4f7f\u7528\u56db\u4e2a\u4e0d\u540c\u7684\u6811\u72b6\u6570\u7ec4\u6765\u7ef4\u62a4\u5dee\u5206\u6570\u7ec4\uff0c\u4ed6\u4eec\u4e4b\u95f4\u7684\u5dee\u522b\u53ea\u662f\u5728\u66f4\u65b0\u7684\u65f6\u5019\u589e\u52a0\u7684\u503c\u4e0d\u540c\u3002\u5982\u679c$d_{i,j}$\u589e\u52a0\u4e86$k$\uff0c\u5219$1$\u66f4\u65b0$k$\uff0c$2$\u66f4\u65b0$j\\times k$\uff0c$3$\u66f4\u65b0$i\\times k$\uff0c$4$\u66f4\u65b0$i\\times j\\times k$\u3002\n    \n- \u4e8c\u7ef4\u6811\u72b6\u6570\u7ec4\u8fd9\u79cd\u4e1c\u897f\u6211\u600e\u4e48\u53ef\u80fd\u4f1a\u5462\uff1f\u6240\u4ee5\u6211\u7684\u60f3\u6cd5\u5c31\u662f\u5c06**\u4e8c\u7ef4\u7684\u5e73\u9762\u538b\u7f29\u5230x\u8f74**\u4e0a\uff0c\u7531\u6b64\u5c31\u53ef\u4ee5\u5c06\u4e4b\u8f6c\u5316\u4e3a\u6b63\u5e38\u7684\u6811\u72b6\u6570\u7ec4\u4e86\u3002\n\n\t\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u6ce8\u610f\uff0c\u538b\u7f29\u80af\u5b9a\u662f\u6709\u9650\u5236\u7684\uff0c\u5426\u5219\u4e8c\u7ef4\u95ee\u9898\u5c82\u4e0d\u662f\u548c\u4e00\u7ef4\u95ee\u9898\u6ca1\u4ec0\u4e48\u533a\u522b\u4e86\uff1f\n- **\u9650\u52361\uff1a** \u79bb\u7ebf\u5904\u7406\n\n\t\u5982\u679c\u5728\u7ebf\u5904\u7406\u7684\u8bdd\u6211\u4eec\u5c31\u5f88\u96be\u907f\u514d\u51fa\u73b0**\u9700\u8981\u91cd\u590d\u8ba1\u7b97**\u7684\u5730\u65b9\uff0c\u4f1a\u4f7f\u65f6\u95f4\u590d\u6742\u5ea6\u5927\u5927\u589e\u52a0\uff0c\u800c\u79bb\u7ebf\u5904\u7406\u5219\u53ef\u4ee5\u907f\u514d\u51fa\u73b0\u8fd9\u79cd\u72b6\u51b5\uff0c\u4f7f\u5f97\u6bcf\u4e00\u4e2a\u9700\u8981\u5904\u7406\u7684\u70b9\u53ea\u4f1a\u88ab\u5904\u7406\u4e00\u6b21\u3002\n    \n    \u79bb\u7ebf\u5904\u7406\u7684\u65b9\u5f0f\u5c31\u662f\u6784\u9020\u4e00\u4e2a\u70b9\u6570\u7ec4\uff0c\u5c06\u9700\u8981\u4e8c\u7ef4\u5dee\u5206\u65f6**\u9700\u8981\u4fee\u6539\u7684\u70b9**\u7684\u4fe1\u606f\u4ee5\u53ca**\u67e5\u8be2\u65f6\u6240\u9700\u8981\u7684\u70b9**\u7684\u4fe1\u606f\u5b58\u5165\uff0c\u6700\u540e\u7edf\u4e00\u5904\u7406\u5373\u53ef\u3002\n- **\u9650\u52362\uff1a** \u6392\u5e8f\n\n\t\u56e0\u4e3a\u6211\u4eec\u662f\u5411x\u8f74\u538b\u7f29\uff0c\u6240\u4ee5\u6211\u4eec\u5e94\u8be5\u4ee5\u7eb5\u5750\u6807\u4e3a\u5173\u952e\u5b57\u5bf9\u70b9\u6570\u7ec4\u4e2d\u7684\u5143\u7d20\u8fdb\u884c\u6392\u5e8f\uff0c\u5426\u5219\u5c31\u4f1a\u51fa\u73b0\u4e0b\u56fe\u7684\u72b6\u51b5\u3002\n    \n    ![](https://cdn.luogu.com.cn/upload/image_hosting/90xz0lzp.png)\n    \n    \u5982\u679c**\u4fee\u6539\u70b9\u5148\u88ab\u5904\u7406**\u7684\u8bdd\uff0c\u90a3\u4e48\u5176\u6a2a\u5750\u6807\u4e0a\u7684\u503c\u4e5f\u4f1a\u968f\u4e4b\u4fee\u6539\u3002\u8fd9\u4e4b\u540e\u518d\u53bb\u5904\u7406\u67e5\u8be2\u70b9\u65f6\u65f6**\u672c\u5e94\u67e5\u8be2\u7684\u90e8\u5206\u662f\u4e0d\u5305\u542b\u56fe\u4e2d\u4fee\u6539\u70b9\u7684**\uff0c\u800c\u7531\u4e8e\u6211\u4eec\u662f\u4ee5**\u6a2a\u5750\u6807\u4e3a\u51c6**\uff0c\u6240\u4ee5\u76f8\u5f53\u4e8e\u5c06**\u4fee\u6539\u70b9\u4e5f\u5305\u542b\u5728\u67e5\u8be2\u8303\u56f4**\u5185\u4e86\uff0c\u4e5f\u5c31\u662f\u5f97\u5230\u7684\u7ed3\u679c\u8981\u6bd4\u6b63\u786e\u7ed3\u679c**\u591a\u4e86\u4e00\u4e2a\u4fee\u6539\u70b9\u7684\u503c**\u3002\n    \n    \u8fd9\u663e\u7136\u662f\u4e0d\u53ef\u884c\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u5c31\u91c7\u53d6\u5bf9\u7eb5\u5750\u6807\u6392\u5e8f\u7684\u65b9\u6cd5\u6765\u4fdd\u8bc1\u4e0d\u4f1a\u6709\u4e0a\u8ff0\u60c5\u51b5\u7684\u53d1\u751f\u3002\n    \n## $\\mathtt{Fifth \\;Step}\\;\\text{\u70b9\u6570\u7ec4}$\n    \n- \u6211\u4eec\u5728$4.3$\u4e2d\u63d0\u5230\u4e86\u70b9\u6570\u7ec4\uff0c\u90a3\u4e48\u5b83\u5177\u4f53\u5e94\u8be5\u600e\u6837\u6784\u5efa\u5462\uff1f\n\n\n\t\u7531\u4e8e\u70b9\u6570\u7ec4\u4e2d\u53ea\u9700\u8981\u5b58\u50a8\u4e24\u7c7b\u5143\u7d20\uff1a\u4fee\u6539\u70b9\u4e0e\u67e5\u8be2\u70b9\uff0c\u6240\u4ee5\u6211\u4eec\u53ea\u9700\u8981\u8003\u8651\u6b64\u4e8c\u8005\u9700\u8981\u7528\u54ea\u4e9b\u53d8\u91cf\u6765\u53bb\u63cf\u8ff0\u5c31\u53ef\u4ee5\u4e86\u3002\n    \n- **\u67e5\u8be2\u70b9**\u6240\u5305\u542b\u7684\u53d8\u91cf\u6709\uff1a\u6a2a\u5750\u6807\u3001\u7eb5\u5750\u6807\u3001**\u77e9\u5f62\u7f16\u53f7**\u3001**\u7cfb\u6570**\u3002\n\n\t\u6a2a\u7eb5\u5750\u6807\u6211\u5c31\u4e0d\u591a\u8bf4\u4e86\uff1b\n    \n    \u6211\u4eec\u5728$2.3$\u4e2d\u63d0\u5230\u53ef\u4ee5\u5c06\u4e00\u4e2a\u67e5\u8be2\u77e9\u5f62\u5206\u6210\u56db\u4e2a\u67e5\u8be2\u70b9\uff0c\u53c8\u56e0\u4e3a\u6211\u4eec\u4f7f\u7528\u7684\u662f\u79bb\u7ebf\u5904\u7406\uff0c\u6240\u4ee5\u6211\u4eec\u9700\u8981\u5c06**\u67e5\u8be2\u70b9\u96b6\u5c5e\u4e8e\u54ea\u4e2a\u77e9\u5f62**\u8bb0\u5f55\u4e0b\u6765\u5373**\u77e9\u5f62\u7f16\u53f7**\uff1b\n    \n    \u540c\u6837\u5730\uff0c$2.3$\u4e2d\u7ed9\u51fa\u7684\u516c\u5f0f\u4e2d\u5404\u9879\u7684\u7cfb\u6570\u662f\u4e0d\u540c\u7684\uff0c\u4e5f\u5c31\u662f\u539f\u67e5\u8be2\u77e9\u5f62\u5206\u6210\u7684\u56db\u4e2a\u67e5\u8be2\u70b9**\u5bf9\u67e5\u8be2\u77e9\u5f62\u7684\u8d21\u732e\u6709\u6b63\u6709\u8d1f**\uff1a\u5de6\u4e0a\u89d2\u4e0e\u53f3\u4e0b\u89d2\u8d21\u732e\u4e3a\u6b63\uff0c\u5de6\u4e0b\u89d2\u4e0e\u53f3\u4e0a\u89d2\u8d21\u732e\u4e3a\u8d1f\u3002\u6240\u4ee5\u5de6\u4e0a\u89d2\u4e0e\u53f3\u4e0b\u89d2\u67e5\u8be2\u70b9\u7684**\u7cfb\u6570**\u4e3a$1$\uff0c\u5de6\u4e0b\u89d2\u4e0e\u53f3\u4e0a\u89d2\u67e5\u8be2\u70b9\u7684**\u7cfb\u6570**\u4e3a$-1$\u3002\n    \n    \u5982\u679c\u6211\u4eec\u5c06\u6700\u540e\u7684\u7b54\u6848\u5b58\u5165$ans$\u6570\u7ec4\u4e2d\uff0c\u90a3\u4e48\u6bcf\u6b21\u9047\u5230\u67e5\u8be2\u70b9\u9700\u8981\u7684\u64cd\u4f5c\u53ea\u662f\u5c06$ans\\left[\\text{\u77e9\u5f62\u7f16\u53f7}\\right]$\u52a0\u4e0a$\\text{\u7cfb\u6570}\\times sum_{\\text{\u67e5\u8be2\u70b9}}$\u3002\n    \n- **\u4fee\u6539\u70b9**\u6240\u5305\u542b\u7684\u53d8\u91cf\u6709\uff1a\u6a2a\u5750\u6807\u3001\u7eb5\u5750\u6807\u3001**\u6743\u503c**\u3002\n\n\t\u6a2a\u7eb5\u5750\u6807\u6211\u5c31\u4e0d\u591a\u8bf4\u4e86\uff1b\n    \n    \u8fd9\u91cc\u7684**\u6743\u503c**\u6307\u7684\u662f\u5dee\u5206\u6570\u7ec4\u4e2d\u8fd9\u4e2a\u70b9\u7684\u503c\uff0c\u56e0\u4e3a\u65e0\u8bba\u662f\u5dee\u5206\u8fd8\u662f\u6811\u72b6\u6570\u7ec4\u90fd\u5b8c\u5168\u662f**\u5728\u4e8c\u7ef4\u5dee\u5206\u6570\u7ec4\u4e0a\u8fdb\u884c\u7684\u64cd\u4f5c**\uff0c\u4e0e\u539f\u6570\u7ec4\u5df2\u7ecf\u6ca1\u6709\u5173\u7cfb\u4e86\u3002\n    \n- \u7efc\u5408\u6765\u770b\uff0c\u4e00\u4e2a\u70b9\u9700\u8981\u5305\u542b\u7684\u53d8\u91cf\u6709\uff1a\u6a2a\u5750\u6807\u3001\u7eb5\u5750\u6807\u3001\u77e9\u5f62\u7f16\u53f7\u3001\u7cfb\u6570\u3001\u6743\u503c\u3002\n\n\t\u67e5\u8be2\u70b9\u6743\u503c\u4e3a$0$\uff1b\u4fee\u6539\u70b9\u77e9\u5f62\u7f16\u53f7\u3001\u7cfb\u6570\u5747\u4e3a$0$\u3002\n\n## $\\mathtt{Sixth \\;Step}\\;\\text{\u6ce8\u610f}$\n\n- $1.2$\u4e2d\u63d0\u5230\u5bf9\u4e8e\u539f\u5e8f\u5217\u7684\u4e00\u4e2a\u5143\u7d20$a_i$\uff0c\u6211\u4eec\u8981\u627e\u5230**\u5de6\u4fa7**\u7b2c\u4e00\u4e2a**\u5c0f\u4e8e**\u5176\u81ea\u8eab\u7684\u503c\u7684\u5143\u7d20\uff0c**\u53f3\u4fa7**\u7b2c\u4e00\u4e2a**\u5c0f\u4e8e\u7b49\u4e8e**\u5176\u81ea\u8eab\u7684\u503c\u7684\u5143\u7d20\uff0c\u8fd9\u662f\u4e3a\u4ec0\u4e48\u5462\uff1f\u6211\u4eec\u770b\u4e0b\u9762\u8fd9\u4e2a\u5e8f\u5217\uff1a\n\t\n\t```cpp\n\t2 9 5 7 5 8\n\t```\n\n\t\u5bf9\u4e8e\u7b2c\u4e00\u4e2a$5$\u6765\u8bf4\uff0c\u5de6\u4fa7\u7b2c\u4e00\u4e2a\u5c0f\u4e8e\u5b83\u7684\u662f$2$\uff0c\u53f3\u4fa7\u7b2c\u4e00\u4e2a\u5c0f\u4e8e\u7b49\u4e8e\u5b83\u7684\u662f\u7b2c\u4e8c\u4e2a$5$\uff0c\u53f3\u4fa7\u6ca1\u6709\u5c0f\u4e8e\u5b83\u7684\uff1b\n    \n    \u5bf9\u4e8e\u7b2c\u4e8c\u4e2a$5$\u6765\u8bf4\uff0c\u5de6\u4fa7\u7b2c\u4e00\u4e2a\u5c0f\u4e8e\u5b83\u7684\u662f$2$\uff0c\u5de6\u4fa7\u7b2c\u4e00\u4e2a\u5c0f\u4e8e\u7b49\u4e8e\u5b83\u7684\u662f\u7b2c\u4e00\u4e2a$5$\uff0c\u53f3\u4fa7\u6ca1\u6709\u5c0f\u4e8e\u7b49\u4e8e\u5b83\u7684\uff1b\n    \n    \u65e0\u8bba\u662f\u5de6\u4fa7\u6539\u6210\u5c0f\u4e8e\u7b49\u4e8e\u6216\u8005\u53f3\u4fa7\u6539\u6210\u5c0f\u4e8e\uff0c\u90fd\u4f1a\u51fa\u73b0\u7b2c\u4e00\u4e2a$5$\u5230\u7b2c\u4e8c\u4e2a$5$\u8fd9\u6bb5**\u533a\u95f4\u88ab\u91cd\u590d\u8ba1\u7b97**\u7684\u60c5\u51b5\uff0c\u800c\u4e00\u8fb9\u662f\u5c0f\u4e8e\uff0c\u4e00\u8fb9\u662f\u5c0f\u4e8e\u7b49\u4e8e\u5c31\u907f\u514d\u4e86\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\u3002\n    \n- $5.1$\u4e2d\u63d0\u5230\u70b9\u6570\u7ec4\u4e2d\u53ea\u5305\u542b\u67e5\u8be2\u70b9\u4e0e\u4fee\u6539\u70b9\uff0c\u800c$4.4$\u4e2d\u63d0\u5230\u9700\u8981\u5bf9\u70b9\u8fdb\u884c\u6392\u5e8f\u3002\u8fd9\u91cc\u6211\u4eec\u9700\u8981\u6ce8\u610f\u5230\u8fd9\u6837\u4e00\u79cd\u60c5\u51b5\uff1a**\u67e5\u8be2\u70b9\u4e0e\u4fee\u6539\u70b9\u91cd\u5408**\u3002\n\n\t\u6211\u4eec\u663e\u7136\u8981**\u5148\u5904\u7406\u4fee\u6539\u70b9**\u518d\u53bb\u5904\u7406\u67e5\u8be2\u70b9\uff0c\u800c\u6211\u4eec\u600e\u6837**\u5229\u7528\u6392\u5e8f**\u533a\u5206\u5148\u540e\u5462\uff1f\u5f88\u7b80\u5355\uff0c\u5c06**\u77e9\u5f62\u7f16\u53f7**\u4f5c\u4e3a\u7b2c\u4e8c\u5173\u952e\u5b57\u3002\u7531\u4e8e$5.4$\u4e2d\u63d0\u5230\u4fee\u6539\u70b9\u77e9\u5f62\u7f16\u53f7\u4e3a$0$\uff0c\u800c\u67e5\u8be2\u70b9\u7684\u77e9\u5f62\u7f16\u53f7\u4e00\u5b9a\u662f\u5927\u4e8e$0$\u7684\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u987a\u624b\u628a\u8fd9\u4e2a\u95ee\u9898\u89e3\u51b3\u4e86\u3002\n    \n# $\\mathtt{AC\\;CODE}$\n\n\u4e0a\u4ee3\u7801\uff0c\u8bf7\u5404\u4f4d\u5ba2\u5b98**\u8c28\u614e\u98df\u7528**\uff08\u6284\u88ad\u53ef\u803b\uff0cWA\u4e86\u4e0d\u602a\u6211\u54dfQvQ\uff09\u3002\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define zrl long long/*\u4e0d\u5f00long long \u89c1\u7956\u5b97*/\nconst int N = 1e6 + 10;\nint n, q, lef[N], rig[N], l, r, st[N], top = 0, cnt = 0;\nzrl a[N], ans[N], sumnot[N], sumordinate[N], sumabscissa[N], sumcoordinate[N];\nstruct node\n{\n    int x, y, id, flag;\n    zrl val;\n}p[N * 5];/*\u70b9\u6570\u7ec4*/\nint lowbit(int t)\n{\n    return t & (-t);\n}\nvoid addnot(int t, zrl pre)\n{\n    while(t <= n)\n    {\n        sumnot[t] += pre;\n        t += lowbit(t);\n    }\n}\nvoid addordinate(int t, zrl pre)\n{\n    while(t <= n)\n    {\n        sumordinate[t] += pre;\n        t += lowbit(t);\n    }\n}\nvoid addabscissa(int t, zrl pre)\n{\n    while(t <= n)\n    {\n        sumabscissa[t] += pre;\n        t += lowbit(t);\n    }\n}\nvoid addcoordinate(int t, zrl pre)\n{\n    while(t <= n)\n    {\n        sumcoordinate[t] += pre;\n        t += lowbit(t);\n    }\n}/*\u6811\u72b6\u6570\u7ec4*/\nzrl finnot(int t)\n{\n    zrl num = 0;\n    while(t > 0)\n    {\n        num += sumnot[t];\n        t -= lowbit(t);\n    }\n    return num;\n}\nzrl finordinate(int t)\n{\n    zrl num = 0;\n    while(t > 0)\n    {\n        num += sumordinate[t];\n        t -= lowbit(t);\n    }\n    return num;\n}\nzrl finabscissa(int t)\n{\n    zrl num = 0;\n    while(t > 0)\n    {\n        num += sumabscissa[t];\n        t -= lowbit(t);\n    }\n    return num;\n}\nzrl fincoordinate(int t)\n{\n    zrl num = 0;\n    while(t > 0)\n    {\n        num += sumcoordinate[t];\n        t -= lowbit(t);\n    }\n    return num;\n}/*\u6811\u72b6\u6570\u7ec4*/\nvoid addp(int setx, int sety, int bel, int xs, zrl much)\n{\n    p[++cnt].x = setx;\n    p[cnt].y = sety;\n    p[cnt].id = bel;\n    p[cnt].flag = xs;\n    p[cnt].val = much;\n}/*\u70b9\u6570\u7ec4*/\nvoid prepare()/*\u9884\u5904\u7406*/\n{\n    for(int i = 1; i <= n; i++)\n    {\n        while(top && a[st[top]] >= a[i])\n        {\n            rig[st[top]] = i;\n            top--;\n        }\n        lef[i] = st[top];\n        st[++top] = i;\n    }/*\u5355\u8c03\u6808*/\n    for(int i = 1; i <= n; i++)\n    {\n        if(rig[i] == 0)\n        {\n            rig[i] = n + 1;\n        }\n    }\n    for(int i = 1; i <= n; i++)\n    {\n        if((lef[i] + 1) <= i && i <= (rig[i] - 1))\n        {\n            int x1 = i, y1 = lef[i] + 1, x2 = rig[i] - 1, y2 = i;\n            addp(x1, y1, 0, 0, a[i]);\n            addp(x1, y2 + 1, 0, 0, -a[i]);\n            addp(x2 + 1, y1, 0, 0, -a[i]);\n            addp(x2 + 1, y2 + 1, 0, 0, a[i]);\n        }\n    }/*\u4fee\u6539\u70b9*/\n}\nbool comp(node a, node b)\n{\n    if(a.y == b.y)\n    {\n        if(a.x == b.x)\n        {\n            return a.id < b.id;/*\u7b2c\u4e8c\u5173\u952e\u5b57*/\n        }\n        return a.x < b.x;\n    }\n    return a.y < b.y;/*\u7b2c\u4e00\u5173\u952e\u5b57*/\n}/*\u6392\u5e8f*/\n\nint main()\n{\n    cin >> n >> q;\n    for(int i = 1; i <= n; i++)\n    {\n        cin >> a[i];\n    }\n    prepare();\n    for(int i = 1; i <= q; i++)\n    {\n        cin >> l >> r;\n        addp(l - 1, l - 1, i, 1, 0);\n        addp(r, r, i, 1, 0);\n        addp(l - 1, r, i, -1, 0);\n        addp(r, l - 1, i, -1, 0);\n    }/*\u67e5\u8be2\u70b9*/\n    sort(p + 1, p + cnt + 1, comp);\n    for(int i = 1; i <= cnt; i++)\n    {\n        if(p[i].id == 0)\n        {\n            addnot(p[i].x, p[i].val);\n            addordinate(p[i].x, p[i].val * (zrl)p[i].y);\n            addabscissa(p[i].x, p[i].val * (zrl)p[i].x);\n            addcoordinate(p[i].x, p[i].val * (zrl)p[i].x * (zrl)p[i].y);\n            /*\u5bf9\u56db\u4e2a\u6811\u72b6\u6570\u7ec4\u5206\u522b\u64cd\u4f5c*/\n        }\n        else\n        {\n            zrl first = 1ll * (p[i].x + 1) * (p[i].y + 1) * finnot(p[i].x);\n            zrl second = 1ll * (p[i].x + 1) * finordinate(p[i].x);\n            zrl third = 1ll * (p[i].y + 1) * finabscissa(p[i].x);\n            zrl forth = 1ll * fincoordinate(p[i].x);/*\u62c6\u5206\u51fa\u7684\u56db\u4e2a\u90e8\u5206*/\n            ans[p[i].id] += p[i].flag * (first - second - third + forth);\n        }\n    }\n    for(int i = 1; i <= q; i++)\n    {\n        cout << ans[i] << endl;\n    }\n    return 0;\n}\n\n```\n\u6c42\u7ba1\u7406\u5458\u5927\u5927\u901a\u8fc7~~",
        "postTime": 1609771302,
        "uid": 342798,
        "name": "Desert_Lycoris",
        "ccfLevel": 4,
        "title": "\u9898\u89e3P3246\u3010[HNOI2016]\u5e8f\u5217\u3011"
    },
    {
        "content": "# \u9898\u89e3-[HNOI2016]\u5e8f\u5217\n\n## [\u535a\u5ba2\u4e2d\u9605\u8bfb](https://www.cnblogs.com/Wendigo/p/12634706.html)\n\n> [\\[HNOI2016\\]\u5e8f\u5217](https://www.luogu.com.cn/problem/P3246)\n\n> \u7ed9\u5b9a $n$ \u548c $m$ \u4ee5\u53ca\u5e8f\u5217 $a\\{n\\}$\u3002\u6709 $m$ \u6b21\u8be2\u95ee\uff0c\u6bcf\u6b21\u7ed9\u5b9a\u533a\u95f4 $[l,r]\\in[1,n]$\uff0c\u6c42 \n> $$\\sum_{l\\le l'\\le r'\\le r}\\min_{i=l'}^{r'}a_i$$\n\n> \u6570\u636e\u8303\u56f4\uff1a$1\\le n,m\\le 10^5$\uff0c$|a_i|\\le 10^9$\u3002\n\n---\n\u849f\u84bb\u8981\u7ec3\u4e60\u7701\u9009\u9898\uff0c\u7ed3\u679c\u5c31\u9047\u5230\u8fd9\u9053\u6570\u636e\u7ed3\u6784\uff08\u597d\u4e45\u6ca1\u5199\u6570\u636e\u7ed3\u6784\u9898\u90fd\u5fd8\u5149\u4e86\uff09\u3002\u7ed3\u679c\u6b63\u597d\u9047\u5230\u4e00\u9053\u6bd2\u7624\u9898\uff0c\u4e8e\u662f\u849f\u84bb\u6765\u5199\u7bc7\u9898\u89e3\u3002\n\n---\n\u8fd9\u9898\u662f\u9759\u6001\u79bb\u7ebf\uff0c\u4ee4\u4eba\u60f3\u5230 **$\\texttt{ST}$ \u8868\u548c\u83ab\u961f**\u2014\u2014\u771f\u7684\u5c31\u662f\u4ed6\u4eec\u3002\n\n\u5c06\u533a\u95f4\u5b58\u4e0b\u6765\u6392\u5e8f\uff0c\u5c06\u5de6\u7aef\u70b9\u8303\u56f4\u4ece\u5c0f\u5230\u5927\u5206 $\\sqrt n$ \u4efd\uff0c**\u5de6\u7aef\u70b9\u6309\u4efd\u6392\u5e8f\uff0c\u53f3\u7aef\u70b9\u5947\u5076\u6ce2\u6d6a\u6392\u5e8f\u3002**\n\n```cpp\nfriend int operator<(Moq x,Moq y){\n\tif(cas[x.l]!=cas[y.l]) return x.l<y.l;\n\treturn (cas[x.l]&1)?x.r<y.r:x.r>y.r;\n}\n```\n\n\u7136\u540e\u4f9d\u6b21\u8003\u8651\u6392\u5e8f\u540e\u6bcf\u4e00\u4e2a\u533a\u95f4\u8be2\u95ee\uff0c\u5e76\u901a\u8fc7\u4e0a\u4e00\u4e2a\u533a\u95f4\u7684\u7b54\u6848\u9012\u63a8\uff0c**\u8fd9\u5c31\u662f\u83ab\u961f\u7684\u601d\u60f3**\u3002\n\n---\n**\u7136\u540e\u770b\u8fd9\u9898\uff1a**\n\n\u5982\u4f55\u901a\u8fc7\u4e0a\u4e00\u4e2a\u7b54\u6848\u9012\u63a8\u5462\uff1f\u9700\u8981\u5148\u77e5\u9053**\u8fb9\u754c\u7aef\u70b9\u7684\u8d21\u732e**\u3002\n\n\u5373\u7ed9\u5b9a\u533a\u95f4 $[l,r]$\uff0c$l$ \u7aef\u70b9\u7684\u8d21\u732e$=Ans[l,r]-Ans[l+1,r]$\u3002\n\n\u6bd4\u5982\u4e0b\u9762\u7ed9\u51fa\u4e00\u4e2a\u5e8f\u5217 $a\\{n\\}(n=10)$\uff1a\n\n```cpp\n4 4 5 3 6 2 1 5 6 9\n```\n\n\u7ed9\u5b9a\u533a\u95f4 $[l,r]=[3,9]$\uff0c\u5373 $a_l\\sim a_r$ \u4e3a\uff1a\n\n```cpp\n5 3 6 2 1 5 6\n```\n\n\u6240\u4ee5**\u5de6\u7aef\u70b9 $(l=3,a_l=5)$ \u7684\u8d21\u732e**\u5e94\u8be5\u4e3a\n\n$$\\sum_{j=l}^r\\min\\limits_{k=l}^j a_k$$\n\n\u5373\n\n$$\\min\\{5\\}+\\min\\{5,3\\}+\\min\\{5,3,6\\}+\\cdots+\\min\\{5,3,6,2,1,5,6\\}$$\n\n$$=5+3+3+2+1+1+1$$\n\n\u4ee4\u4eba\u60f3\u8d77\u5355\u8c03\u6808\uff0c\u7136\u800c\u4e0d\u53ef\u80fd\u6bcf\u6b21\u8be2\u95ee $\\Theta(n)$ \u8dd1\u4e00\u904d\u3002\u6240\u4ee5\u53ef\u4ee5\u9884\u5904\u7406\uff1a\n\n\u901a\u8fc7**\u7ef4\u62a4\u5355\u8c03\u6808**\uff0c\u6c42\u51fa\u5bf9\u4e8e\u6bcf\u4e2a $a_i$\uff0c$lw_i(lw_i<i)$ \u8868\u793a $i$ \u5de6\u8fb9\u7b2c\u4e00\u4e2a\u6bd4 $a_i$ \u5c0f\u7684\u5143\u7d20\u7684\u4e0b\u6807\uff1b$rw_i(rw_i>i)$ \u8868\u793a $i$ \u53f3\u8fb9\u7b2c\u4e00\u4e2a\u6bd4 $a_i$ \u5c0f\u7684\u5143\u7d20\u7684\u4e0b\u6807\uff08\u5982\u679c\u5de6\u8fb9\u4e0d\u5b58\u5728\u6bd4 $a_i$ \u5c0f\u7684\u5143\u7d20\uff0c$lw_i=0$\uff1b\u5982\u679c\u53f3\u8fb9\u4e0d\u5b58\u5728\u6bd4 $a_i$ \u5c0f\u7684\u5143\u7d20\uff0c$rw_i=n+1$\uff09\u3002\n\n\u8fd9\u6837\u7684\u8bdd\uff0c\u5c31\u53ef\u4ee5\u7ef4\u62a4\u4e00\u4e2a**\u524d\u7f00\u548c $lsm_i$ \u540e\u7f00\u548c $rsm_i$**\uff0c\u5176\u4e2d\n\n$$lsm_i=lsm_{lw_i}+a_i(i-lw_i),rsm_i=rsm_{rw_i}+a_i(rw_i-i)$$\n\n\u7136\u540e\u4e0a\u9762\u7684 $5+3+3+2$ \u5c31\u53ef\u4ee5\u901a\u8fc7**\u540e\u7f00\u548c\u76f8\u51cf**\u5f97\uff0c\u6c42\u53f3\u7aef\u70b9\u8d21\u732e\u65f6\u5219\u7528**\u524d\u7f00\u548c\u76f8\u51cf**\u3002\n\n> \u56e0\u4e3a\u5bf9\u4e8e\u533a\u95f4 $[lw_i+1,i]$ \u6216 $[i,rw_i-1]$\uff0c$a_i$ \u4e3a\u5176\u6700\u5c0f\u5143\u7d20\u3002\n\n```cpp\nvoid Side(){\n\tlw.rz(n+7),rw.rz(n+7);\n\ta[0]=-inf;\n\tq.clear(),q.pb(0);\n\tfor(int i=1;i<=n;i++){\n\t\twhile(q.size()&&a[q.back()]>=a[i]) q.pop_back();\n\t\tlw[i]=q.back(),q.pb(i);\n\t}\n\ta[0]=0;\n\ta[n+1]=-inf;\n\tq.clear(),q.pb(n+1);\n\tfor(int i=n;i>=1;i--){\n\t\twhile(q.size()&&a[q.back()]>=a[i]) q.pop_back();\n\t\trw[i]=q.back(),q.pb(i);\n\t}\n\ta[n+1]=0;\n\tlsm.rz(n+7),rsm.rz(n+7);\n\tfor(int i=1;i<=n;i++) lsm[i]=lsm[lw[i]]+(lng)(i-lw[i])*a[i];\n\tfor(int i=n;i>=1;i--) rsm[i]=rsm[rw[i]]+(lng)(rw[i]-i)*a[i];\n}\n```\n\n---\n\n\u6700\u540e\u4e00\u4e2a\u95ee\u9898\uff1a$1+1+1$ \u90e8\u5206\u600e\u4e48\u529e\uff1f\n\n\u56e0\u4e3a\u53f3\u7aef\u70b9\u662f**\u968f\u673a**\u7684\uff0c\u6240\u4ee5\u5982\u679c\u76f4\u63a5\u628a\u5de6\u7aef\u70b9\u7684\u8d21\u732e\u5f53\u505a $rsm_l-rsm_r$\uff0c\u5fc5\u7136\u4e0d\u59a5\u3002\n\n\u8003\u8651\u5230\u5047\u8bbe\u533a\u95f4 $[l,r]$ \u4e2d $a_p$ \u6700\u5c0f\uff0c\u90a3\u4e48\u5fc5\u7136\n\n$$\\forall j\\in[p,r],\\left(\\min\\limits_{k=l}^j a_k\\right)=a_p$$\n\n\u6240\u4ee5\u7b97 $1+1+1$ \u90e8\u5206\u53ef\u4ee5\u901a\u8fc7**\u7ef4\u62a4\u9759\u6001\u533a\u95f4\u6700\u5c0f\u503c\u4e0b\u6807**\uff08$\\texttt{ST}$ \u8868\uff09\u627e\u5230 $p$\uff0c\u7b97\u51fa $a_p(r-p+1)$\u3002\n\n\u7136\u540e\u6b63\u56e0\u4e3a $a_p$ \u662f $[l,r]$ \u533a\u95f4\u4e2d\u6700\u5c0f\u7684\u5143\u7d20\uff0c\u6240\u4ee5 $[l,p-1]$ \u6bb5\u7684\u5de6\u7aef\u70b9\u8d21\u732e\u4e5f\u81ea\u7136\u662f $rsm_l-rsm_p$\u3002\n\n\u6240\u4ee5\u5bf9\u4e8e\u533a\u95f4 $[l,r]$\uff0c\u5de6\u7aef\u70b9\u8d21\u732e\u4e3a\n\n$$rsm_l-rsm_p+a_p(r-p+1)\\qquad [a_p=\\min_{i=l}^r a_i]$$\n\n**\u53f3\u7aef\u70b9\u540c\u7406\u3002**\n\n\u7136\u540e**\u76f8\u90bb\u4e24\u4e2a\u533a\u95f4**\u4e4b\u95f4\u5c31\u53ef\u4ee5\u9010\u6b65\u8f6c\u79fb\u4e86\u3002\n\n```cpp\nlng Mol(int l,int r){\n\tint p=getmin(l,r);\n\treturn rsm[l]-rsm[p]+(lng)(r-p+1)*a[p];\n}\nlng Mor(int l,int r){\n\tint p=getmin(l,r);\n\treturn lsm[r]-lsm[p]+(lng)(p-l+1)*a[p];\n}\nvoid runMo(){\n\tint L=1,R=0;\n\tfor(int i=1;i<=m;i++){\n\t\twhile(L>qu[i].l) res+=Mol(--L,R);\n\t\twhile(R<qu[i].r) res+=Mor(L,++R);\n\t\twhile(L<qu[i].l) res-=Mol(L++,R);\n\t\twhile(R>qu[i].r) res-=Mor(L,R--);\n\t\tans[qu[i].I]=res;\n\t}\n}\n```\n\n---\n**\u65f6\u95f4\u590d\u6742\u5ea6 $\\Theta(m\\sqrt n)$\uff0c\u7a7a\u95f4\u590d\u6742\u5ea6 $\\Theta(n+m)$\u3002**\n\n---\n## Code\n\n\u6211\u8fd9\u4e2a\u849f\u84bb\u5783\u573e\u771f\u662f\u50bb\u50bb\u8bb2\u4e0d\u6e05\u695a\uff0c\u8fd8\u662f\u653e\u4ee3\u7801\u5427\uff08\u8981\u5f00 $\\texttt{long long}$\uff09\u3002\n\n\u4ee3\u7801\u6709\u70b9\u957f\uff0c\u4e8e\u662f\u849f\u84bb\u5212\u5206\u4e86\u4e00\u4e0b\u3002\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n\n//Start\n#define lng long long\n#define db double\n#define mk make_pair\n#define pb push_back\n#define fi first\n#define se second\n#define rz resize\nconst int inf=0x3f3f3f3f;\nconst lng INF=0x3f3f3f3f3f3f3f3f;\n\n//Data\nint n,m;\nvector<int> a;\n\n//Side\nvector<int> lw,rw,q;\nvector<lng> lsm,rsm;\nvoid Side(){\n\tlw.rz(n+7),rw.rz(n+7);\n\ta[0]=-inf;\n\tq.clear(),q.pb(0);\n\tfor(int i=1;i<=n;i++){\n\t\twhile(q.size()&&a[q.back()]>=a[i]) q.pop_back();\n\t\tlw[i]=q.back(),q.pb(i);\n\t}\n\ta[0]=0;\n\ta[n+1]=-inf;\n\tq.clear(),q.pb(n+1);\n\tfor(int i=n;i>=1;i--){\n\t\twhile(q.size()&&a[q.back()]>=a[i]) q.pop_back();\n\t\trw[i]=q.back(),q.pb(i);\n\t}\n\ta[n+1]=0;\n\tlsm.rz(n+7),rsm.rz(n+7);\n\tfor(int i=1;i<=n;i++) lsm[i]=lsm[lw[i]]+(lng)(i-lw[i])*a[i];\n\tfor(int i=n;i>=1;i--) rsm[i]=rsm[rw[i]]+(lng)(rw[i]-i)*a[i];//\u4e2d\u95f4\u9012\u63a8\u4e5f\u8981\u6ce8\u610f\u7206int\n}\n\n//ST\nvector<int> lg;\nvector<vector<int> > st;\nint stcmp(int x,int y){\n\treturn a[x]<a[y]?x:y;\n}\nvoid buildst(){\n\tlg.rz(n+7);\n\tfor(int i=2;i<=n;i++) lg[i]=lg[i-1]+((1<<(lg[i-1]+1))<=i?1:0); //lg[i]=(int)log(i)\n\tst.rz(lg[n]+7);\n\tfor(int j=0;j<=lg[n];j++) st[j].rz(n+7);\n\tfor(int i=1;i<=n;i++) st[0][i]=i;\n\tfor(int j=1;j<=lg[n];j++)\n\t\tfor(int i=1;i<=n-(1<<(j-1));i++) st[j][i]=stcmp(st[j-1][i],st[j-1][i+(1<<(j-1))]);\n}\nint getmin(int l,int r){\n\tint len=lg[r-l+1];\n\treturn stcmp(st[len][l],st[len][r-(1<<len)+1]);\n}\n\n//Moq\nint sq;\nlng res;\nvector<int> cas;\nvector<lng> ans;\nstruct Moq{\n\tint l,r,I;\n\tfriend int operator<(Moq x,Moq y){\n\t\tif(cas[x.l]!=cas[y.l]) return x.l<y.l;\n\t\treturn (cas[x.l]&1)?x.r<y.r:x.r>y.r;\n\t}\n};\nvector<Moq> qu;\nvoid buildMo(){\n\tcas.rz(n+7),qu.rz(m+1);\n\tsq=sqrt(n);\n\tfor(int i=1;i<=m;i++) scanf(\"%d%d\",&qu[i].l,&qu[i].r),qu[i].I=i;\n\tfor(int i=1;i<=n;i++) cas[i]=(i-1)/sq+1;\n\tsort(qu.begin(),qu.end());\n}\nlng Mol(int l,int r){\n\tint p=getmin(l,r);\n\treturn rsm[l]-rsm[p]+(lng)(r-p+1)*a[p];\n}\nlng Mor(int l,int r){\n\tint p=getmin(l,r);\n\treturn lsm[r]-lsm[p]+(lng)(p-l+1)*a[p];\n}\nvoid runMo(){\n\tint L=1,R=0;\n\tfor(int i=1;i<=m;i++){\n\t\twhile(L>qu[i].l) res+=Mol(--L,R);\n\t\twhile(R<qu[i].r) res+=Mor(L,++R);\n\t\twhile(L<qu[i].l) res-=Mol(L++,R);\n\t\twhile(R>qu[i].r) res-=Mor(L,R--);\n\t\tans[qu[i].I]=res;\n\t}\n}\n\n//Main\nint main(){\n\tscanf(\"%d%d\",&n,&m);\n\ta.rz(n+7);\n\tfor(int i=1;i<=n;i++) scanf(\"%d\",&a[i]);\n\tans.rz(m+7);\n\tSide(),buildst(),buildMo(),runMo();\n\tfor(int i=1;i<=m;i++)\n\t\tprintf(\"%lld\\n\",ans[i]);\n\treturn 0;\n}\n```\n---\n**\u795d\u5927\u5bb6\u5b66\u4e60\u6109\u5feb\uff01**\n",
        "postTime": 1586010383,
        "uid": 118365,
        "name": "George1123",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3246 \u3010[HNOI2016]\u5e8f\u5217\u3011"
    },
    {
        "content": "# \u9898\u76ee\n&emsp;&emsp;[\u70b9\u8fd9\u91cc](https://www.luogu.com.cn/problem/P3246)\u770b\u9898\u76ee\u3002  \n# \u5206\u6790\n&emsp;&emsp;\u8003\u8651\u5c06\u6240\u6709\u5b50\u5e8f\u5217\u753b\u6210$n\\times n$\u7684\u8868\u7684\u5f62\u5f0f\uff0c\u8868\u4e2d\u7684\u5143\u7d20$(x,y)$\u5c31\u8868\u793a\u5b50\u5e8f\u5217$a[x:y]$\u7684\u6700\u5c0f\u503c\u3002\uff08$x>y$\u5219$(x,y)=0$\uff09  \n&emsp;&emsp;\u90a3\u4e48\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u5143\u7d20$a_i$\uff0c\u8bb0\u5b83\u5de6\u8fb9\u7b2c\u4e00\u4e2a**\u5c0f\u4e8e\u5b83**\u7684\u4f4d\u7f6e\u4e3a$lef(i)$\uff0c\u53f3\u8fb9\u7b2c\u4e00\u4e2a**\u5c0f\u4e8e\u7b49\u4e8e\u5b83**\u7684\u4f4d\u7f6e\u4e3a$rig(i)$\u3002\u90a3\u4e48\uff0c\u5728\u8868\u683c\u4e2d\uff0c\u4ece$(lef(i)+1,i)$\u5230$(i,rig(i)-1)$\u7684\u8fd9\u4e9b\u5e8f\u5217\u7684\u6700\u5c0f\u503c\uff0c\u90fd\u4f1a\u662f$a_i$\u3002\u56e0\u6b64\uff0c\u4e00\u4e2a\u5143\u7d20\u5c31\u76f8\u5f53\u4e8e\u5728\u8fd9\u4e2a\u8868\u683c\u4e0a\u9762\u8fdb\u884c\u4e86\u4e00\u6b21\u77e9\u5f62\u8986\u76d6\u3002    \n&emsp;&emsp;\u518d\u8003\u8651\u67e5\u8be2\uff0c\u5bf9\u4e8e\u67e5\u8be2$(l,r)$\uff0c\u5b83\u67e5\u8be2\u7684\u5b9e\u9645\u5c31\u662f\u8868\u683c\u4e0a$(l,l)$\u5230$(r,r)$\u7684\u5143\u7d20\u548c\u3002\u8003\u8651\u5230$\\forall 1\\le i< l, l\\le j\\le r, (j,i)=0$\uff0c\u56e0\u6b64\uff0c\u8be2\u95ee\u5b9e\u9645\u4e0a\u7b49\u4ef7\u4e8e$(l,1)$\u5230$(r,r)$\u7684\u5143\u7d20\u548c\u3002  \n&emsp;&emsp;\u63a5\u4e0b\u6765\u5c31\u662f\u4e00\u4e2a\u79bb\u7ebf\u7684\u626b\u63cf\u7ebf\u95ee\u9898\u4e86\u3002\u5c06\u77e9\u5f62\u8986\u76d6\u5206\u4e3a\u4e24\u7c7b\uff0c\u4e00\u7c7b\u662f\u5df2\u7ecf\u88ab\u626b\u63cf\u7ebf\u626b\u8fc7\u4e86\uff0c\u4e00\u7c7b\u662f\u6b63\u5728\u88ab\u626b\u63cf\u3002\u5bf9\u4e8e\u7b2c\u4e00\u7c7b\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u4e00\u4e2a\u7ebf\u6bb5\u6811$T_1$\u7ef4\u62a4\u5b83\u7684\u8d21\u732e\uff08\u56e0\u4e3a\u626b\u8fc7\u4e86\u4e4b\u540e\u5b83\u7684\u8d21\u732e\u5c31\u4e0d\u4f1a\u6539\u53d8\u4e86\uff09\uff1b\u5bf9\u4e8e\u7b2c\u4e8c\u7c7b\uff0c\u6211\u4eec\u505a\u4e00\u4e2a\u5dee\u5206\uff0c\u5c06\u5b83\u5df2\u7ecf\u56fa\u5b9a\u4e86\u7684\u8d21\u732e$(lef-1)*a$\u52a0\u5165\u5230$T_1$\u4e2d\uff0c\u518d\u7528\u53e6\u4e00\u4e2a\u7ebf\u6bb5\u6811$T_2$\u7ef4\u62a4\u5f53\u524d\u626b\u63cf\u7ebf\u4e0a\u7684\u60c5\u51b5\u3002\u67e5\u8be2\u7684\u65f6\u5019\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5c06$T_2$\u7684\u8d21\u732e\u4e58\u4e0a\u626b\u63cf\u7ebf\u7684\u4f4d\u7f6e\uff0c\u518d\u4e0e$T_1$\u7684\u8d21\u732e\u76f8\u51cf\uff0c\u8fd9\u6837\u7b2c\u4e8c\u7c7b\u77e9\u5f62\u7684\u8d21\u732e\u5c31\u53ef\u4ee5\u7b97\u51fa\u6765\u4e86\u3002   \n&emsp;&emsp;\u65f6\u95f4\u662f$O(n\\log_2n)$\u3002  \n# \u4ee3\u7801\n```cpp\n#include <cstdio>\n#include <vector>\n#include <cstring>\nusing namespace std;\n\ntypedef long long LL;\n\nconst int MAXN = 1e5 + 5;\n\ntemplate<typename _T>\nvoid read( _T &x )\n{\n\tx = 0;char s = getchar();int f = 1;\n\twhile( s > '9' || s < '0' ){if( s == '-' ) f = -1; s = getchar();}\n\twhile( s >= '0' && s <= '9' ){x = ( x << 3 ) + ( x << 1 ) + ( s - '0' ), s = getchar();}\n\tx *= f;\n}\n\ntemplate<typename _T>\nvoid write( _T x )\n{\n\tif( x < 0 ){ putchar( '-' ); x = ( ~ x ) + 1; }\n\tif( 9 < x ){ write( x / 10 ); }\n\tputchar( x % 10 + '0' );\n}\n\nstruct SegmentTree\n{\n\tLL s[MAXN << 2], tag[MAXN << 2];\n\t\n\tSegmentTree() { memset( s, 0, sizeof s ), memset( tag, 0, sizeof tag ); }\n\t\n\tvoid upt( const int x ) { s[x] = s[x << 1] + s[x << 1 | 1]; }\n\tvoid add( const int x, const LL v, const int l, const int r ) { s[x] += ( r - l + 1 ) * v, tag[x] += v; }\n\t\n\tvoid normalize( const int x, const int l, const int r )\n\t{\n\t\tif( ! tag[x] ) return ;\n\t\tint mid = l + r >> 1;\n\t\tadd( x << 1, tag[x], l, mid ), add( x << 1 | 1, tag[x], mid + 1, r );\n\t\ttag[x] = 0;\n\t}\n\t\n\tvoid update( const int u, const int l, const int r, const int segL, const int segR, const LL val )\n\t{\n\t\tif( segL <= l && r <= segR ) { add( u, val, l, r ); return ; }\n\t\tint mid = l + r >> 1; normalize( u, l, r );\n\t\tif( segL <= mid ) update( u << 1, l, mid, segL, segR, val );\n\t\tif( segR > mid ) update( u << 1 | 1, mid + 1, r, segL, segR, val );\n\t\tupt( u );\n\t}\n\n\tLL query( const int u, const int l, const int r, const int segL, const int segR )\n\t{\n\t\tif( segL <= l && r <= segR ) return s[u];\n\t\tLL ret = 0; int mid = l + r >> 1; normalize( u, l, r );\n\t\tif( segL <= mid ) ret += query( u << 1, l, mid, segL, segR );\n\t\tif( mid < segR ) ret += query( u << 1 | 1, mid + 1, r, segL, segR );\n\t\treturn ret;\n\t}\n}T1, T2;\n\nvector<int> add[MAXN], sub[MAXN], q[MAXN];\n\nLL ans[MAXN], qL[MAXN], qR[MAXN];\nint a[MAXN], lef[MAXN], rig[MAXN], stk[MAXN];\nint N, Q, top;\n\nsigned main()\n{\n\tread( N ), read( Q );\n\tfor( int i = 1 ; i <= N ; i ++ ) read( a[i] );\n\tfor( int i = 1 ; i <= N ; i ++ )\n\t{\n\t\twhile( top && a[stk[top]] >= a[i] ) rig[stk[top --]] = i;\n\t\tstk[++ top] = i;\n\t}\n\twhile( top ) rig[stk[top --]] = N + 1;\n\tfor( int i = N ; i ; i -- )\n\t{\n\t\twhile( top && a[stk[top]] > a[i] ) lef[stk[top --]] = i;\n\t\tstk[++ top] = i;\n\t}\n\twhile( top ) lef[stk[top --]] = 0;\n\tfor( int i = 1 ; i <= N ; i ++ ) add[i].push_back( i ), sub[rig[i]].push_back( i );\n\tfor( int i = 1 ; i <= Q ; i ++ ) \n\t{\n\t\tread( qL[i] ), read( qR[i] );\n\t\tq[qR[i]].push_back( i );\n\t}\n\tint id;\n\tfor( int i = 1 ; i <= N ; i ++ )\n\t{\n\t\tfor( int j = 0 ; j < add[i].size() ; j ++ )\n\t\t{\n\t\t\tid = add[i][j];\n\t\t\tT1.update( 1, 1, N, lef[id] + 1, id, 1ll * ( i - 1 ) * a[id] );\n\t\t\tT2.update( 1, 1, N, lef[id] + 1, id, a[id] );\n\t\t}\n\t\tfor( int j = 0 ; j < sub[i].size() ; j ++ )\n\t\t{\n\t\t\tid = sub[i][j];\n\t\t\tT1.update( 1, 1, N, lef[id] + 1, id, -1ll * ( i - 1 ) * a[id] );\n\t\t\tT2.update( 1, 1, N, lef[id] + 1, id, - a[id] );\n\t\t}\n\t\tfor( int j = 0 ; j < q[i].size() ; j ++ )\n\t\t{\n\t\t\tid = q[i][j];\n\t\t\tans[id] = 1ll * i * T2.query( 1, 1, N, qL[id], qR[id] ) - T1.query( 1, 1, N, qL[id], qR[id] );\n\t\t}\n\t}\n\tfor( int i = 1 ; i <= Q ; i ++ ) write( ans[i] ), putchar( '\\n' );\n\treturn 0;\n}\n``` ",
        "postTime": 1590986649,
        "uid": 123809,
        "name": "crashed",
        "ccfLevel": 0,
        "title": "[HNOI2016]\u5e8f\u5217"
    },
    {
        "content": "\u597d\u50cf\u641e\u51fa\u4e86\u4e00\u4e2a\u548c\u9898\u89e3\u4e0d\u4e00\u6837\u7684\u505a\u6cd5(\u7136\u800c\u6211\u8003\u573a\u4e0a\u6ca1\u5199\u51fa\u6765\u8fd8\u662f\u7206\u96f60)\n\n\u4e00\u4e2a\u5f88\u663e\u7136\u7684\u601d\u8def\u662f\u8003\u8651\u6bcf\u4e2a\u6700\u5c0f\u503c\u7684\u8d21\u732e\u3002\n\n\u9884\u5904\u7406\u51fa\u6bcf\u4e2a\u6570\u5de6\u8fb9\u7b2c\u4e00\u4e2a\u6bd4\u4ed6\u5c0f\u7684\u6570\uff0c\u53f3\u8fb9\u7b2c\u4e00\u4e2a\u6bd4\u4ed6\u5927\u7684\u6570\u3002\n\n\u90a3\u4e48$[L_i + 1, i]$\u5bf9$[i, R_i]$\u4e2d\u7684\u6bcf\u4e2a\u6570\u90fd\u4f1a\u6709$a[i]$\u7684\u8d21\u732e\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u62bd\u8c61\u6210\u4e00\u4e2a\u4e8c\u7ef4\u5e73\u9762\u5185\u7684\u77e9\u5f62\u52a0\u3002\n\n\u8be2\u95ee\u5c31\u662f\u8be2\u95ee\u6700\u4e0b\u89d2\u4e3a$(l, l)$\uff0c\u53f3\u4e0a\u89d2\u4e3a$(r, r)$\u7684\u77e9\u5f62\u5185\u7684\u6743\u503c\n\n\u4e5f\u5c31\u662f\u6211\u4eec\u9700\u8981\u89e3\u51b3\u8fd9\u4e48\u4e00\u4e2a\u95ee\u9898\uff1a\u4e24\u4e2a\u64cd\u4f5c, \u77e9\u5f62\u52a0\u77e9\u5f62\u6c42\u548c\uff0c\u800c\u4e14\u524d\u8005\u90fd\u5728\u540e\u8005\u7684\u524d\u9762\u6267\u884c\n\n\u6211\u4eec\u53ef\u4ee5\u628a\u6240\u6709\u77e9\u5f62\u52a0\u64cd\u4f5c\u5168\u90fd\u5411\u53f3\u4e0a\u89d2\u5dee\u5206\uff0c\u6240\u6709\u8be2\u95ee\u64cd\u4f5c\u5168\u90fd\u5411\u5de6\u4e0b\u89d2\u5dee\u5206\u3002\u8fd9\u6837\u6211\u4eec\u5c31\u53ea\u9700\u8981\u8003\u8651\u6bcf\u4e2a$(i, j)$\u5de6\u4e0b\u89d2\u7684\u6240\u6709\u4fee\u6539$(x, y)$\u7684\u5f71\u54cd\uff0c\u8fd9\u90e8\u5206\u7684\u6743\u503c\u4e3a$(i - x + 1) * (j - y + 1) * w$\n\n\u76f4\u63a5\u62c6\u5f00\uff0c\u53d1\u73b0\u53ef\u4ee5\u7528\u6811\u72b6\u6570\u7ec4\u7ef4\u62a4(\u5355\u70b9\u4fee\u6539\uff0c\u67e5\u524d\u7f00\u548c)\u3002\u7136\u540e\u5c31\u505a\u5b8c\u4e86\n\n\u590d\u6742\u5ea6$O(nlogn)$\n\n```cpp\n#include<bits/stdc++.h>\n#define LL long long \n#define fi first\n#define se second\n#define getchar() (p1 == p2 && (p2 = (p1 = buf) + fread(buf, 1, 1<<22, stdin), p1 == p2) ? EOF : *p1++)\nchar buf[(1 << 22)], *p1 = buf, *p2 = buf;\nchar obuf[1<<24], *O = obuf;\nvoid print(int x) {if(x > 9) print(x / 10); *O++ = x % 10 + '0';}\n#define OS  *O++ = '\\n';\n#define fout fwrite(obuf, O-obuf, 1 , stdout); \nusing namespace std;\nconst int MAXN = 1e5 + 10, INF = 1e9 + 10;\ntemplate<typename A, typename B> inline bool chmax(A &x, B y) {return x < y ? x = y, 1 : 0;}\ntemplate<typename A, typename B> inline bool chmin(A &x, B y) {return x > y ? x = y, 1 : 0;}\ninline int read() {\n\tchar c = getchar(); int x = 0, f = 1;\n\twhile(c < '0' || c > '9') {if(c == '-') f = -1; c = getchar();}\n\twhile(c >= '0' && c <= '9') x = x * 10 + c - '0', c = getchar();\n\treturn x * f;\n}\nint N, M, Q, a[MAXN],  st[MAXN], L[MAXN], R[MAXN]; \nLL ans[MAXN];\nstruct Modify {\n\tint h;LL v;\n};\nvector<Modify> tag[MAXN];\nstruct Query {\n\tint h, id, opt;\n};\nvector<Query> q[MAXN];\nvoid Add(int x1, int y1, int x2, int y2, int v) {\n\ttag[x1].push_back({y1, v});\n\ttag[x2 + 1].push_back({y1, -v});\n\ttag[x1].push_back({y2 + 1, -v});\n\ttag[x2 + 1].push_back({y2 + 1, v});\n}\nvoid Query(int x1, int y1, int x2, int y2, int id) {\n\tq[x2].push_back({y2, id, 1});\n\tq[x1 - 1].push_back({y2, id, -1});\n\tq[x2].push_back({y1 - 1, id, -1});\n\tq[x1 - 1].push_back({y1 - 1, id, 1});\n}\n#define lb(x) (x & (-x))\nLL s1[MAXN], s2[MAXN], s3[MAXN], s4[MAXN];\nvoid TreeAdd(int x, LL v1, LL v2, LL v3, LL v4) {\n\twhile(x <= M) \n\t\ts1[x] += v1, s2[x] += v2, s3[x] += v3, s4[x] += v4, x += lb(x);\n}\npair<pair<LL, LL>, pair<LL, LL> > TreeQuery(int x) {\n\tpair<pair<LL, LL>, pair<LL, LL> > ans;\n\twhile(x) \n\t\tans.fi.fi += s1[x], ans.fi.se += s2[x], ans.se.fi += s3[x], ans.se.se += s4[x], x -= lb(x);\n\treturn ans;\n}\n#undef lb\nvoid solve() {\n\tfor(int i = 1; i <= M; i++) {\t\n\t\tfor(auto y: tag[i]) {\n\t\t\tint v = y.v;\n\t\t\tTreeAdd(y.h, 1ll * v, 1ll * (y.h - 1) * v, 1ll * (i - 1) * v, 1ll * (y.h - 1) * (i - 1) * v);\n\t\t}\n\t\tfor(auto x : q[i]) {\n\t\t\tLL sumv = 0, sumyv = 0, sumxv = 0, sumxyv = 0;\n\t\t\tpair<pair<LL, LL>, pair<LL, LL> > tmp = TreeQuery(x.h);\n\t\t\tsumv = tmp.fi.fi;\n\t\t\tsumyv = tmp.fi.se;\n\t\t\tsumxv = tmp.se.fi;\n\t\t\tsumxyv = tmp.se.se;\n\t\t\tint j = x.h;\n\t\t\tans[x.id] += 1ll * x.opt * (1ll * i * j * sumv - 1ll * i * sumyv - 1ll * j * sumxv + sumxyv);\n\t\t}\n\t}\n}\n\nvoid Pre() {\n\ta[0] = -INF; a[N + 1] = -INF; int top = 0;\n\tfor(int i = 1; i <= N + 1; i++) {\n\t\twhile(top && a[i] < a[st[top]]) R[st[top--]] = i;\n\t\tL[i] = st[top];\n\t\tst[++top] = i;\n\t}\n\tfor(int i = 1; i <= N; i++)\n\t\tif((i <= R[i] - 1) && (L[i] + 1 <= i)) \n\t\t\tAdd(i, L[i] + 1, R[i] - 1, i, a[i]);\n}\nsigned main() {\n\t//freopen(\"a.in\", \"r\", stdin); freopen(\"b.out\", \"w\", stdout);\n\tN = read(); M = N + 1; Q = read();\n\tfor(int i = 1; i <= N; i++) a[i] = read();\n\tPre();\n\tfor(int i = 1; i <= Q; i++) {\n\t\tint l = read(), r = read(), ans = 0;\n\t\tQuery(l, l, r, r, i);\n\t}\n\tsolve();\n\tfor(int i = 1; i <= Q; i++) cout << ans[i] << '\\n';\n\treturn 0;\n}\n```",
        "postTime": 1551314244,
        "uid": 36984,
        "name": "attack",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3246 \u3010[HNOI2016]\u5e8f\u5217\u3011"
    },
    {
        "content": "\u6ca1\u4eba\u5199\u732b\u6811\u5417\u3002\n\n\u8fd9\u662f\u4e00\u4e2a $O(n\\log n)+O(1)+O(n\\log n)$ \u7684\u5728\u7ebf\u505a\u6cd5\u3002\n\n\u732b\u6811\uff0c\u5bf9\u4e8e\u67d0\u4e2a\u8282\u70b9\uff0c\u5148\u9884\u5904\u7406\u51fa\u4e00\u4e2a\u70b9\u5230\u4e2d\u70b9\u7684\u7b54\u6848\u3002\u8fd9\u53ef\u4ee5\u4f7f\u7528\u5355\u8c03\u6808\u6c42\u51fa\u3002\u90a3\u4e48\u6211\u4eec\u9700\u8981\u8ba1\u7b97\u8de8\u4e2d\u70b9\u7684\u8d21\u732e\u3002\n\n\u9884\u5904\u7406\u51fa\u6bcf\u4e2a\u70b9\u5230\u4e2d\u70b9\u7684\u6700\u5c0f\u503c\uff0c\u5e76\u5904\u7406\u51fa\u8fd9\u4e2a\u6700\u5c0f\u503c\u80fd\u5ef6\u4f38\u5230\u53f3\u8fb9\u54ea\u91cc\u3002\u8fd9\u53ef\u4ee5\u5bf9\u5de6\u53f3\u4e24\u4e2a\u533a\u95f4\u8fdb\u884c\u4e00\u6b21\u5f52\u5e76\u5f97\u5230\u3002\n\n\u8d21\u732e\u5206\u4e3a\u4e24\u79cd\uff1a\u6700\u5c0f\u503c\u5728\u5de6\u8fb9\u7684\uff0c\u6211\u4eec\u5728\u5de6\u7aef\u70b9\u5904\u8ba1\u7b97\u8d21\u732e\uff1b\u6700\u5c0f\u503c\u5728\u53f3\u8fb9\u7684\uff0c\u6211\u4eec\u5728\u53f3\u7aef\u70b9\u5904\u8ba1\u7b97\u8d21\u732e\u3002\n\n\u82e5\u67e5\u8be2\u5de6\u7aef\u70b9\u5230\u4e2d\u70b9\u7684\u6700\u5c0f\u503c\u4e0d\u80fd\u5ef6\u4f38\u5230\u53f3\u7aef\u70b9\uff0c\u5219\u5de6\u8fb9\u6240\u6709\u70b9\u90fd\u6709\u5230\u5176\u5ef6\u4f38\u7684\u53f3\u7aef\u70b9\u7684\u5b8c\u6574\u7684\u8d21\u732e\u3002\u5bf9\u4e8e\u53f3\u534a\u90e8\u5206\uff0c\u5de6\u7aef\u70b9\u5ef6\u4f38\u7684\u6700\u8fdc\u70b9\u5de6\u8fb9\u7684\u6240\u6709\u70b9\u90fd\u6709\u5b8c\u6574\u7684\u8d21\u732e\uff0c\u800c\u53f3\u8fb9\u5230\u53f3\u7aef\u70b9\u7684\u6240\u6709\u70b9\u90fd\u53ea\u6709\u5230\u5de6\u7aef\u70b9\u7684\u8d21\u732e\u3002\u8fd9\u4e9b\u4e1c\u897f\u90fd\u662f\u53ef\u4ee5\u62c6\u5f00\u7136\u540e\u9884\u5904\u7406\u51fa\u6765\u7684\u3002\n\n\u53e6\u4e00\u79cd\u60c5\u51b5\u7684\u8bdd\u540c\u7406\u53ef\u5f97\u3002\n\n\u4ee3\u7801\u5b9e\u73b0\u4e0a\uff0c\u8fd9\u4e2a\u5230\u4e2d\u70b9\u7684\u524d\u7f00\u548c\u5f88\u70e6\u4eba\uff0c\u6240\u4ee5\u6211\u5206\u522b\u4fdd\u5b58\u7684\u5de6\u8fb9\u7684\u7b54\u6848\u548c\u53f3\u8fb9\u7684\u7b54\u6848\u3002\n\n\u53e6\u5916\u8fd9\u4e2a\u505a\u6cd5\u5176\u5b9e\u662f\u548c\u90a3\u4e2a rmq \u7684\u505a\u6cd5\u672c\u8d28\u76f8\u540c\uff0c\u90a3\u4e2a\u505a\u6cd5\u57fa\u672c\u4e0a\u76f8\u5f53\u4e8e\u628a\u8fd9\u4e2a\u505a\u6cd5\u642c\u5230\u7b1b\u5361\u5c14\u6811\u4e0a\uff0c\u7136\u540e\u5c31\u5c11\u4e86\u4e00\u5806\u7279\u5224\u2026\u2026\n```cpp\n#include<cctype>\n#include<cstdio>\nusing namespace std;\ninline int readint(){\n\tint x=0;\n\tbool f=0;\n\tchar c=getchar();\n\twhile(!isdigit(c)&&c!='-') c=getchar();\n\tif(c=='-'){\n\t\tf=1;\n\t\tc=getchar();\n\t}\n\twhile(isdigit(c)){\n\t\tx=x*10+c-'0';\n\t\tc=getchar();\n\t}\n\treturn f?-x:x;\n}\nconst int maxn=1e5+5;\nint n,q,a[maxn*2];\ntypedef long long ll;\nint pos[maxn*2];\nll s1[25][maxn*2],s2l[25][maxn*2],s2r[25][maxn*2];\nint mn[25][maxn*2],pp[25][maxn*2];\nll s3l[25][maxn*2],s3r[25][maxn*2];\nll s4l[25][maxn*2],s4r[25][maxn*2];\nint st[maxn],top;\nvoid build(int o,int l,int r,int d){\n\tif(l==r){\n\t\tpos[r]=o;\n\t\treturn;\n\t}\n\tint mid=l+(r-l)/2;\n\tbuild(o*2,l,mid,d+1);\n\tbuild(o*2+1,mid+1,r,d+1);\n\tll res=0;\n\tst[top=0]=mid+1;\n\tfor(int i=mid;i>=l;i--){\n\t\twhile(top&&a[i]<a[st[top]]){\n\t\t\tres-=1ll*a[st[top]]*(st[top-1]-st[top]);\n\t\t\ttop--;\n\t\t}\n\t\tst[++top]=i;\n\t\tres+=1ll*a[i]*(st[top-1]-i);\n\t\ts1[d][i]=i==mid?res:s1[d][i+1]+res;\n\t\tmn[d][i]=a[st[1]];\n\t}\n\tres=0;\n\tst[top=0]=mid;\n\tfor(int i=mid+1;i<=r;i++){\n\t\twhile(top&&a[i]<a[st[top]]){\n\t\t\tres-=1ll*a[st[top]]*(st[top]-st[top-1]);\n\t\t\ttop--;\n\t\t}\n\t\tst[++top]=i;\n\t\tres+=1ll*a[i]*(i-st[top-1]);\n\t\ts1[d][i]=i==mid+1?res:s1[d][i-1]+res;\n\t\tmn[d][i]=a[st[1]];\n\t}\n\tint cur=r;\n\tfor(int i=l;i<=mid;i++){\n\t\twhile(cur>mid&&mn[d][cur]<mn[d][i]) pp[d][cur--]=i;\n\t\tpp[d][i]=cur;\n\t}\n\tfor(int i=mid+1;i<=cur;i++) pp[d][i]=mid+1;\n\tfor(int i=mid;i>=l;i--){\n\t\ts2l[d][i]=s2l[d][i+1]+1ll*mn[d][i]*(pp[d][i]-mid);\n\t\ts3l[d][i]=s3l[d][i+1]+1ll*mn[d][i]*mid;\n\t\ts4l[d][i]=s4l[d][i+1]+mn[d][i];\n\t}\n\tfor(int i=mid+1;i<=r;i++){\n\t\ts2r[d][i]=s2r[d][i-1]+1ll*mn[d][i]*(mid+1-pp[d][i]);\n\t\ts3r[d][i]=s3r[d][i-1]+1ll*mn[d][i]*(mid+1);\n\t\ts4r[d][i]=s4r[d][i-1]+mn[d][i];\n\t}\n}\nint lg[maxn*4];\nint main(){\n\t#ifdef LOCAL\n\tfreopen(\"in.txt\",\"r\",stdin);\n\tfreopen(\"out.txt\",\"w\",stdout);\n\t#endif\n\tn=readint();\n\tq=readint();\n\tfor(int i=1;i<=n;i++) a[i]=readint();\n\tint len=1;\n\twhile(len<n) len*=2;\n\tbuild(1,1,len,1);\n\tfor(int i=2;i<=n*4;i++) lg[i]=lg[i/2]+1;\n\twhile(q--){\n\t\tint l,r;\n\t\tl=readint();\n\t\tr=readint();\n\t\tif(l==r){\n\t\t\tprintf(\"%d\\n\",a[r]);\n\t\t\tcontinue;\n\t\t}\n\t\tint k=lg[pos[r]]-lg[pos[l]^pos[r]];\n\t\tll ans=s1[k][l]+s1[k][r];\n\t\tif(pp[k][l]<r){\n\t\t\tans+=s2l[k][l]+s2r[k][pp[k][l]];\n\t\t\tans+=s3r[k][r]-s3r[k][pp[k][l]];\n\t\t\tans-=(s4r[k][r]-s4r[k][pp[k][l]])*l;\n\t\t}\n\t\telse{\n\t\t\tans+=s2r[k][r]+s2l[k][pp[k][r]];\n\t\t\tans-=s3l[k][l]-s3l[k][pp[k][r]];\n\t\t\tans+=(s4l[k][l]-s4l[k][pp[k][r]])*r;\n\t\t}\n\t\tprintf(\"%lld\\n\",ans);\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1591684188,
        "uid": 174045,
        "name": "FZzzz",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3246 \u3010[HNOI2016]\u5e8f\u5217\u3011"
    },
    {
        "content": "\u9996\u5148\u53ef\u4ee5\u60f3\u5230\u83ab\u961f\u3002\u7136\u540e\u5c31\u9700\u8981\u8003\u8651\u600e\u4e48\u8003\u8651\u4e24\u8fb9\u6269\u5c55\u5bf9\u7b54\u6848\u7684\u5f71\u54cd\u3002\u9996\u5148\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u9884\u5904\u7406\u4e00\u4e2a$f[i]$\u8868\u793a\u4ee5$i$\u7ed3\u5c3e\u7684\u6bcf\u4e2a\u540e\u7f00\u7684\u7b54\u6848\uff08\u533a\u95f4\u6700\u5c0f\u503c\uff09\u4e4b\u548c\uff0c\u9996\u5148\u6211\u4eec\u53ef\u4ee5\u9884\u5904\u7406\u51fa$pre[i]$\u8868\u793a$i$\u4f4d\u7f6e\u7684\u524d\u9762\u7684\u7b2c\u4e00\u4e2a\u5c0f\u4e8e\u5b83\u7684\u5143\u7d20\u4f4d\u7f6e\uff0c\u4e4b\u540e\u7684\u8f6c\u79fb\u5c31\u5341\u5206\u7684\u7b80\u5355\u4e86:\n$$f[i]=f[pre[i]]+(i-pre[i]) \\times a[i]$$\n\u4e5f\u5c31\u662f$i$\u4f4d\u7f6e\u6240\u7ba1\u8f96\u7684\u533a\u95f4\u7684\u8d21\u732e\u518d\u52a0\u4e0a\u524d\u9762\u7684\u8d21\u732e\u3002\u90a3\u4e48\u6211\u4eec\u8003\u8651\u5bf9\u4e8e\u4e00\u4e2a$L,R$\u600e\u4e48\u6c42\u51fa\u533a\u95f4$[L,R],[L+1,R]....[R,R]$\u7684\u8d21\u732e\uff0c\u6211\u4eec\u8003\u8651\u627e\u5230$[L,R]$\u533a\u95f4\u5185\u7684\u6700\u5c0f\u503c\u4f4d\u7f6e\uff0c\u8bb0\u4e3a$po$\uff0c\u90a3\u4e48\u5de6\u7aef\u70b9\u5728$[L,po]$\u533a\u95f4\u5185\u7684\u7b54\u6848\u5c31\u80af\u5b9a\u4e3a$a[po]$\uff0c\u7136\u540e\u6211\u4eec\u8003\u8651$[po+1,R]$\u4e4b\u95f4\u7684\u7b54\u6848\uff0c\u6211\u4eec\u9996\u5148\u53ef\u4ee5\u60f3\u5230$f[R]$\uff0c\u4f46\u662f\u4f1a\u53d1\u73b0\u8fd9\u53ea\u662f\u5305\u62ec\u4e86\u6211\u4eec\u8981\u6c42\u7684\uff0c\u4f46\u662f\u8fd8\u662f\u6709\u591a\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u8003\u8651\u600e\u4e48\u628a\u591a\u7684\u51cf\u6389\u3002\n\n\u80af\u5b9a\u6709\u60f3\u5230$f[R]-f[po]$\u8fd9\u4e2a\u770b\u8d77\u6765\u5e76\u4e0d\u600e\u4e48\u6b63\u786e\u7684\u5f0f\u5b50\uff0c\u4f46\u662f\u4e8b\u5b9e\u4e0a\uff0c\u8fd9\u4e2a\u5c31\u662f\u5bf9\u7684\u3002\u4e3a\u4ec0\u4e48\u5462\uff1f\u6211\u4eec\u8003\u8651$po$\u8fd9\u4e2a\u4f4d\u7f6e\u4e0a\u7684\u503c\u56e0\u4e3a\u662f\u6700\u5c0f\u503c\uff0c\u6240\u4ee5$[po,R]$\u533a\u95f4\u5185\u53d6\u53f3\u7aef\u70b9\uff0c\u5728$[1,po]$\u4e4b\u5185\u53d6\u5de6\u7aef\u70b9\u7684\u503c\u5e76\u4e0d\u53d7\u533a\u95f4$[po+1,R]$\u503c\u4e4b\u5185\u7684\u503c\u5f71\u54cd\uff0c\u6240\u4ee5\u524d\u9762\u7684\u7b54\u6848\u7684\u503c\u5c31\u662f$f[po]$\u3002\n\n\u8fd9\u4e2a\u5c31\u662f\u83ab\u961f\u7684\u53f3\u8fb9\u52a0\u51cf\uff0c\u81f3\u4e8e\u5de6\u8fb9\u7684\u52a0\u51cf\uff0c\u53ef\u4ee5\u7c7b\u4f3c\u7684\u5904\u7406\u3002$nxt$\uff08\u53f3\u8fb9\u7b2c\u4e00\u4e2a\u5c0f\u7684\uff09\uff0c$g[i]$\uff08\u4ee5$i$\u7ed3\u5c3e\u7684\u524d\u7f00\u7b54\u6848\u7684\u548c\uff09\uff0c\u7528\u4e0a\u8ff0\u76f8\u540c\u7684\u65b9\u6cd5\u8fdb\u884c\u8003\u8651\u5373\u53ef\u3002\n\n\u4ee3\u7801\u5982\u4e0b\uff1a\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<cstring>\n#include<algorithm>\n#include<cmath>\n#define maxn 1000100\n#define inf 1000000007\nusing namespace std;\ntypedef long long ll;\nll read()\n{\n    ll x=0,f=1;\n    char ch=getchar();\n    while(ch-'0'<0||ch-'0'>9){if(ch=='-') f=-1;ch=getchar();}\n    while(ch-'0'>=0&&ch-'0'<=9){x=x*10+ch-'0';ch=getchar();}\n    return x*f;\n}\nint n,Q;\nint a[maxn];\nint q[maxn];\nint pre[maxn],nxt[maxn];\nll f[maxn],g[maxn];\nint pos[maxn][22];\nint get(int x,int y)\n{\n    if(a[x]<a[y])  return x;\n    return y;\n}\nint lg[maxn];\nstruct P{\n    int l,r,id,bl;\n}b[maxn];\nbool cmp(P a,P b)\n{\n    if(a.bl==b.bl)  return a.r<b.r;\n    return a.bl<b.bl;\n}\nll rig(int r,int l)\n{\n    int len=r-l+1;\n    int po=get(pos[l][lg[len]],pos[r-(1<<(lg[len]))+1][lg[len]]);\n    ll tmp=0;\n    tmp=(ll)(po-l+1)*a[po];\n    tmp+=f[r]-f[po];\n    return tmp;\n}\nll lef(int l,int r)\n{\n    int len=(r-l+1);\n    int po=get(pos[l][lg[len]],pos[r-(1<<(lg[len]))+1][lg[len]]);\n    ll tmp=0;\n    tmp=(ll)(r-po+1)*a[po];\n    tmp+=g[l]-g[po];\n    return tmp;\n}\nll ans[maxn];\nbool cmpx(P a,P b)\n{\n    return a.id<b.id;\n}\nint main()\n{\n    n=read();Q=read();\n    for(int i=1;i<=n;i++)  a[i]=read();\n    a[0]=a[n+1]=-inf;\n    int l=1,r=0;\n    q[++r]=0;\n    for(int i=1;i<=n;i++)\n    {\n        while(l<=r&&a[q[r]]>=a[i])  r--;\n        pre[i]=q[r];\n        q[++r]=i;\n    }\n    l=1,r=0;\n    q[++r]=n+1;\n    for(int i=n;i>=1;i--)\n    {\n        while(l<=r&&a[q[r]]>=a[i])  r--;\n        nxt[i]=q[r];\n        q[++r]=i;\n    }\n    for(int i=1;i<=n;i++)  f[i]=f[pre[i]]+(ll)(i-pre[i])*(ll)a[i];\n    for(int i=n;i>=1;i--)  g[i]=g[nxt[i]]+(ll)(nxt[i]-i)*(ll)a[i];\n    for(int i=1;i<=n;i++)  pos[i][0]=i;\n    for(int j=1;j<=20;j++)\n      for(int i=1;i<=n;i++)  pos[i][j]=get(pos[i][j-1],pos[i+(1<<(j-1))][j-1]);\n    for(int i=1;i<=n;i++)  lg[i]=(int)(log(i)/log(2));\n    int block=sqrt(n);\n    for(int i=1;i<=Q;i++)\n    {\n        b[i].l=read();b[i].r=read();b[i].id=i;\n        b[i].bl=(b[i].l-1)/block+1;\n    }\n    sort(b+1,b+Q+1,cmp);\n    int L=1,R=0;\n    ll now=0;\n    for(int i=1;i<=Q;i++)\n    {\n        while(R<b[i].r)\n        {\n            R++;\n            now+=rig(R,L);\n        }\n        while(R>b[i].r)\n        {\n            now-=rig(R,L);\n            R--;\n        }\n        while(L<b[i].l)\n        {\n            now-=lef(L,R);\n            L++;\n        }\n        while(L>b[i].l)\n        {\n            L--;\n            now+=lef(L,R);\n        }\n        ans[b[i].id]=now;\n    }\n    for(int i=1;i<=Q;i++)   printf(\"%lld\\n\",ans[i]);\n    return 0;\n}\n```",
        "postTime": 1541506350,
        "uid": 46396,
        "name": "justin_cao",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3246 \u3010[HNOI2016]\u5e8f\u5217\u3011"
    },
    {
        "content": "\u4e8c\u7ef4\u6570\u70b9\u3002\n\n\u9996\u5148\uff0c\u53ef\u4ee5\u9884\u5904\u7406\u51fa$L_i$\u548c$R_i$\uff0c\u8868\u793a$i$\u8fd9\u4e2a\u70b9\u6700\u8fdc\u80fd\u591f\u62d3\u5c55\u5230\u54ea\u91cc\u3002\n\n\u7136\u540e\uff0c\u4ee5\u5de6\u7aef\u70b9\u4e3a\u6a2a\u5750\u6807\uff0c\u53f3\u7aef\u70b9\u4e3a\u7eb5\u5750\u6807\uff0c\u5efa\u7acb\u5750\u6807\u7cfb\u3002\n\n\u8fd9\u6837\u7684\u8bdd\uff0c\u8be2\u95ee\u5c31\u8f6c\u6362\u4e3a\u4e86\u4e00\u4e2a\u77e9\u5f62$[L_i,R_i]-[L_i,R_i]$\u3002\n\n\u4e0e\u6b64\u540c\u65f6\uff0c\u6bcf\u4e2a\u70b9\u7684\u8d21\u732e\u533a\u95f4\u4e5f\u662f\u4e00\u4e2a\u77e9\u5f62($[L_i,i]-[i,R_i]$)\u3002\n\n\u8fd9\u6837\u53ef\u4ee5\u5229\u7528\u56db\u53c9\u6811\u76f4\u63a5\u6570\uff0c\u53ef\u4ee5\u652f\u6301\u5728\u7ebf\uff0c\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a$O(n\\log^2 n)$\uff0c\u53ef\u4ee5\u88ab\u5361\u3002\n\n\u7136\u800c\u8fd9\u9053\u9898\u5e76\u4e0d\u9700\u8981\u5728\u7ebf\u505a\uff0c\u6211\u4eec\u8003\u8651\u4f7f\u7528\u79bb\u7ebf\u626b\u63cf\u7ebf\u7684\u65b9\u6cd5\u3002\n\n\u5c06\u8be2\u95ee\u67e5\u5206\uff0c\u53d8\u6210\u8be2\u95ee\u4e24\u6bb5\u524d\u7f00\u548c\u3002\u90a3\u4e48\uff0c\u5c31\u9700\u8981\u652f\u6301\u5bf9\u4e00\u4e2a\u77e9\u5f62\u6c42\u524d\u7f00\u548c\u3002\n\n\u76f4\u63a5\u5c06\u77e9\u5f62\u62c6\u6210\u76f4\u7ebf\u660e\u663e\u4e0d\u884c\uff0c\u4f46\u662f\u53ef\u4ee5\u53d1\u73b0\uff0c\u968f\u7740\u626b\u63cf\u7ebf\u5411\u53f3\uff0c\u77e9\u5f62\u5bf9\u9762\u79ef\u7684\u8d21\u732e\u4e3a\u4e00\u4e2a\u4e00\u6b21\u51fd\u6570$x+L_i-1$\u3002\n\n\u90a3\u4e48\uff0c\u76f4\u63a5\u5bf9\u4e8e\u6bcf\u4e2a\u70b9\uff0c\u7ef4\u62a4\u4e00\u6b21\u51fd\u6570\u7684\u4e24\u4e2a\u7cfb\u6570\u5c31\u53ef\u4ee5\u4e86\u3002\u6ce8\u610f\u56e0\u4e3a\u53ea\u9700\u8981\u7528\u5230\u533a\u95f4\u52a0\u548c\u533a\u95f4\u8be2\u95ee\uff0c\u56e0\u6b64\u53ef\u4ee5\u91c7\u7528\u6811\u72b6\u6570\u7ec4\u5b8c\u6210\u7ef4\u62a4\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6$O(n\\log n)$\uff0c\u5e38\u6570\u6709\u70b9\u5927\u3002\n\n\u4ee3\u7801:\n\n```cpp\n#include<bits/stdc++.h>\n#define Rep(i,a,b) for(register int i=(a);i<=(b);++i)\n#define Repe(i,a,b) for(register int i=(a);i>=(b);--i)\n#define pb push_back\n#define mp make_pair\n#define Chkmax(a,b) a=a>b?a:b\n#define Chkmin(a,b) a=a<b?a:b\n#define mx(a,b) (a>b?a:b)\n#define mn(a,b) (a<b?a:b)\ntypedef unsigned long long uint64;\ntypedef unsigned int uint32;\ntypedef long long ll;\nusing namespace std;\n\nnamespace IO\n{\n    const uint32 Buffsize=1<<15,Output=1<<23;\n    static char Ch[Buffsize],*S=Ch,*T=Ch;\n    inline char getc()\n\t{\n\t\treturn((S==T)&&(T=(S=Ch)+fread(Ch,1,Buffsize,stdin),S==T)?0:*S++);\n\t}\n    static char Out[Output],*nowps=Out;\n    \n    inline void flush(){fwrite(Out,1,nowps-Out,stdout);nowps=Out;}\n\n    template<typename T>inline void read(T&x)\n\t{\n\t\tx=0;static char ch;T f=1;\n\t\tfor(ch=getc();!isdigit(ch);ch=getc())if(ch=='-')f=-1;\n\t\tfor(;isdigit(ch);ch=getc())x=x*10+(ch^48);\n\t\tx*=f;\n\t}\n\n\ttemplate<typename T>inline void write(T x,char ch='\\n')\n\t{\n\t\tif(!x)*nowps++='0';\n\t\tif(x<0)*nowps++='-',x=-x;\n\t\tstatic uint32 sta[111],tp;\n\t\tfor(tp=0;x;x/=10)sta[++tp]=x%10;\n\t\tfor(;tp;*nowps++=sta[tp--]^48);\n\t\t*nowps++=ch;\n\t}\n}\nusing namespace IO;\n\ninline void file()\n{\n#ifndef ONLINE_JUDGE\n\tFILE*WA=freopen(\"water.in\",\"r\",stdin);\n\tFILE*TER=freopen(\"water.out\",\"w\",stdout);\n#endif\n}\n\nconst int MAXN=1e5+7;\n\nstatic int n,Q,a[MAXN],L[MAXN],R[MAXN];\n\nstatic struct modi\n{\n\tint tm,l,r;\n\tll k,b;\n\tfriend bool operator<(modi a,modi b)\n\t{return a.tm<b.tm;}\n}p[MAXN<<1];\n\nstatic struct quer\n{\n\tint tm,l,r,id,w;\n\tfriend bool operator<(quer a,quer b)\n\t{return a.tm<b.tm;}\n}q[MAXN<<1];\n\ninline void init()\n{\n\tread(n),read(Q);\n\tRep(i,1,n)read(a[i]);\n\tRep(i,1,n)\n\t{\n\t\tL[i]=R[i]=i;\n\t\tfor(register int j=i-1;j&&a[i]<a[j];j=L[j]-1)L[i]=L[j];\n\t}\n\tRepe(i,n,1)\n\t\tfor(register int j=i+1;j<=n&&a[i]<=a[j];j=R[j]+1)R[i]=R[j];\n\n\tRep(i,1,n)\n\t{\n\t\tp[2*i-1]=(modi){L[i],i,R[i],a[i],-1ll*a[i]*(L[i]-1)};\n\t\tp[i<<1]=(modi){i+1,i,R[i],-a[i],1ll*a[i]*i};\n\t}\n\tstatic int l,r;\n\tRep(i,1,Q)\n\t{\n\t\tread(l),read(r);\n\t\tq[2*i-1]=(quer){l-1,l,r,i,-1};\n\t\tq[i<<1]=(quer){r,l,r,i,1};\n\t}\n\tsort(p+1,p+n*2+1),sort(q+1,q+Q*2+1);\n}\n\nstruct BIT\n{\n\tll c[MAXN];\n\n\tinline void add(int u,ll v){for(;u<=n;u+=u&-u)c[u]+=v;}\n\n\tinline ll query(int u)\n\t{\n\t\tregister ll sm;\n\t\tfor(sm=0ll;u;u-=u&-u)sm+=c[u];\n\t\treturn sm;\n\t}\n};\n\nstruct BBIT\n{\n\tBIT sm,cnt;\n\n\tinline void add(int l,int r,ll w)\n\t{\n\t\tcnt.add(l,w),sm.add(l,w*l);\n\t\tif(r<n)cnt.add(r+1,-w),sm.add(r+1,-w*(r+1));\n\t}\n\n\tinline ll query(int l,int r)\n\t{\n\t\tregister ll X;\n\t\tX=(r+1)*cnt.query(r)-sm.query(r);\n\t\tX-=l*cnt.query(l-1)-sm.query(l-1);\n\t\treturn X;\n\t}\n}k,b;\n\nstatic ll ans[MAXN];\n\ninline void solve()\n{\n\tint pos=1;\n\tRep(i,1,Q*2)\n\t{\n\t\twhile(pos<=n*2&&p[pos].tm<=q[i].tm)\n\t\t{\n\t\t\tk.add(p[pos].l,p[pos].r,p[pos].k),\n\t\t\tb.add(p[pos].l,p[pos].r,p[pos].b),++pos;\n\t\t}\n\t\tans[q[i].id]+=q[i].w*(k.query(q[i].l,q[i].r)*q[i].tm+\n\t\t\t\tb.query(q[i].l,q[i].r));\n\t}\n\tRep(i,1,Q)write(ans[i]);\n\tflush();\n}\n\nint main()\n{\n    init();\n    solve();\n    return 0;\n}\n```",
        "postTime": 1543645810,
        "uid": 7035,
        "name": "Great_Influence",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3246 \u3010[HNOI2016]\u5e8f\u5217\u3011"
    },
    {
        "content": "[\u9898\u9762\u4f20\u9001\u95e8](https://www.luogu.com.cn/problem/P3246)\n\n~~\u8fd9\u9053\u9898\u4e3a\u4ec0\u4e48\u6211\u5c31\u6ca1\u60f3\u51fa\u6765\u5462/kk~~\n\n\u5bf9\u4e8e\u6bcf\u7ec4\u8be2\u95ee $[l,r]$\uff0c\u6211\u4eec\u9996\u5148\u6c42\u51fa\u533a\u95f4 $[l,r]$ \u4e2d\u6700\u5c0f\u503c\u7684\u4f4d\u7f6e $x$\uff0c\u8fd9\u4e2a\u53ef\u4ee5\u7528 ST \u8868\u5b9e\u73b0 $\\mathcal O(n\\log n)-\\mathcal O(1)$ \u7ef4\u62a4\uff0c\u90a3\u4e48\u663e\u7136 $\\forall l'\\in[l,x],r'\\in[x,r],\\min\\limits_{t\\in[l',r']}a_t=a_x$\uff0c\u4ea7\u751f\u7684\u8d21\u732e\u4e3a $(r-x+1)(x-l+1)a_x$\uff0c\u4e8e\u662f\u6211\u4eec\u53ea\u7528\u8ba1\u7b97 $[x+1,r],[l,x-1]$ \u4e24\u4e2a\u533a\u95f4\u7684\u8d21\u732e\u5373\u53ef\u3002\n\n\u8fd9\u4e2a\u4e1c\u897f\u600e\u4e48\u8ba1\u7b97\u5462\uff1f\u8003\u8651\u679a\u4e3e\u533a\u95f4\u7684\u53f3\u7aef\u70b9 $R$\uff0c\u6211\u4eec\u8981\u8ba1\u7b97 $[x+1,R],[x+2,R],\\cdots,[R,R]$ \u8fd9 $R-x$ \u4e2a\u533a\u95f4\u7684\u6700\u5c0f\u503c\u4e4b\u548c\uff0c\u6211\u4eec\u8bb0 $pre_x$ \u4e3a\u6700\u5927\u7684\u6ee1\u8db3 $y<x,a_y\\le a_x$ \u7684 $y$\u2014\u2014$pre_x$ \u663e\u7136\u53ef\u4ee5\u7528\u5355\u8c03\u6808\u5728\u7ebf\u6027\u65f6\u95f4\u5185\u6c42\u51fa\u3002\u518d\u8bb0\u5e8f\u5217 $p_1,p_2,\\cdots,p_k$ \u6ee1\u8db3 $p_0=0,p_k=R,\\forall i\\in[1,k],p_{i-1}=pre_{p_i}$ \u7684\u5e8f\u5217\uff08\u8bf4\u767d\u4e86\u5c31\u662f\u5355\u8c03\u6808\u6c42\u5b8c $pre_R$ \u4e4b\u540e\uff0c\u6808\u5e95\u5230\u6808\u9876\u4f4d\u7f6e\u4e0a\u5143\u7d20\u7684\u4e0b\u6807\u4f9d\u6b21\u5f62\u6210\u7684\u5e8f\u5217\uff09\uff0c\u90a3\u4e48\u663e\u7136 $\\forall i\\in[1,k],l\\in(p_{i-1},p_i]$ \u90fd\u6709 $\\min\\limits_{t=l}^xa_t=a_{p_i}$\uff0c\u4e5f\u5c31\u662f\u8bf4 $a_{p_i}$ \u4f4d\u7f6e\u4f1a\u6210\u4e3a $p_i-p_{i-1}$ \u4e2a\u4f4d\u7f6e\u7684\u6700\u5c0f\u503c\u3002\u5982\u679c\u6211\u4eec\u8bb0 $f_R$ \u4e3a $[1,R],[2,R],\\cdots,[R,R]$ \u7684\u6700\u5c0f\u503c\u4e4b\u548c\uff0c\u90a3\u4e48\u6839\u636e\u4e4b\u524d\u7684\u63a8\u8bba\u6709\u9012\u63a8\u5f0f $f_R=f_{pre_R}+(R-pre_R)a_R$\uff0c\u53ef\u7ebf\u6027\u6c42\u51fa\u3002\n\n\u8fd9\u91cc\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\uff0c\u90a3\u5c31\u662f\u6211\u4eec\u8981\u8ba1\u7b97 $[x+1,R],[x+2,R],\\cdots,[R,R]$ \u7684\u8d21\u732e instead of $[1,R],[2,R],\\cdots,[R,R]$\uff0c\u4e5f\u5c31\u662f\u8bf4\u6211\u4eec\u8981\u51cf\u53bb $[1,R],[2,R],\\cdots,[x,R]$ \u7684\u8d21\u732e\u3002\u8fd9\u4e1c\u897f\u53c8\u600e\u4e48\u6c42\u5462\uff1f\u5f88\u660e\u663e $p$ \u5e8f\u5217\u6709\u4e00\u4e2a\u6027\u8d28\u5c31\u662f\u5fc5\u5b9a $\\exist id\\in[1,k]$ \u6ee1\u8db3 $p_{id}=x$\uff0c\u6b63\u786e\u6027\u663e\u7136\uff0c\u5e76\u4e14\u5bb9\u6613\u6ce8\u610f\u5230 $\\forall l\\in[1,x],\\min\\limits_{t=l}^Ra_t=\\min\\limits_{t=l}^xa_t$\uff0c\u4e5f\u5c31\u662f\u8bf4 $[1,R],[2,R],\\cdots,[x,R]$ \u7684\u8d21\u732e\u5176\u5b9e\u5c31\u662f $[1,x],[2,x],\\cdots,[x,x]$\uff0c\u56e0\u6b64\u53ea\u9700\u62ff $f_R-f_x$ \u5c31\u53ef\u4ee5\u5f97\u5230 $[x+1,R],[x+2,R],\\cdots,[R,R]$ \u7684\u8d21\u732e\u3002\n\n\u6545\u6700\u7ec8 $[x+1,r]$ \u7684\u8d21\u732e\u4e4b\u548c\u5c31\u662f $\\sum\\limits_{R=x+1}^rf_R-f_x$\uff0c\u8fd9\u4e2a\u663e\u7136\u524d\u7f00\u548c\u968f\u4fbf\u7b97\u4e00\u4e0b\u5c31\u884c\u4e86\u3002\u6c42 $[l,x-1]$ \u7684\u8d21\u732e\u4e5f\u540c\u7406\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $n\\log n$\uff0c\u74f6\u9888\u5728\u4e8e RMQ\u3002\n\n```cpp\nconst int MAXN=1e5;\nconst int LOG_N=18;\nconst int INF=0x3f3f3f3f;\nint n,qu,a[MAXN+5],pre[MAXN+5],nxt[MAXN+5];\nll fl[MAXN+5],fr[MAXN+5],gl[MAXN+5],gr[MAXN+5];\npii st[MAXN+5][LOG_N+2];\npii query(int l,int r){\n\tint k=31-__builtin_clz(r-l+1);\n\treturn min(st[l][k],st[r-(1<<k)+1][k]);\n}\nint main(){\n\tscanf(\"%d%d\",&n,&qu);a[0]=a[n+1]=-INF;\n\tfor(int i=1;i<=n;i++) scanf(\"%d\",&a[i]);\n\tstack<int> stk;stk.push(0);\n\tfor(int i=1;i<=n;i++){\n\t\twhile(!stk.empty()&&a[stk.top()]>=a[i]) stk.pop();\n\t\tpre[i]=stk.top();stk.push(i);\n\t} while(!stk.empty()) stk.pop();\n\tstk.push(n+1);\n\tfor(int i=n;i;i--){\n\t\twhile(!stk.empty()&&a[stk.top()]>=a[i]) stk.pop();\n\t\tnxt[i]=stk.top();stk.push(i);\n\t}\n//\tfor(int i=1;i<=n;i++) printf(\"%d %d\\n\",pre[i],nxt[i]);\n\tfor(int i=1;i<=n;i++) fl[i]=fl[pre[i]]+1ll*a[i]*(i-pre[i]),gl[i]=gl[i-1]+fl[i];\n\tfor(int i=n;i;i--) fr[i]=fr[nxt[i]]+1ll*a[i]*(nxt[i]-i),gr[i]=gr[i+1]+fr[i];\n\tfor(int i=1;i<=n;i++) st[i][0]=mp(a[i],i);\n\tfor(int i=1;i<=LOG_N;i++) for(int j=1;j+(1<<i)-1<=n;j++)\n\t\tst[j][i]=min(st[j][i-1],st[j+(1<<i-1)][i-1]);\n\twhile(qu--){\n\t\tint l,r;scanf(\"%d%d\",&l,&r);int p=query(l,r).se;\n\t\tprintf(\"%lld\\n\",1ll*a[p]*(p-l+1)*(r-p+1)+gr[l]-gr[p]-1ll*fr[p]*(p-l)+gl[r]-gl[p]-1ll*fl[p]*(r-p));\n\t}\n\treturn 0;\n}\n```\n\n",
        "postTime": 1616516642,
        "uid": 115194,
        "name": "lTgMFePRoeZ",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3246 [HNOI2016]\u5e8f\u5217"
    },
    {
        "content": "\u5f88\u4e45\u4e4b\u524d\u505a\u8fc7\u8fd9\u9053\u9898\uff0c\u4f46\u662f\u8dd1\u5f97\u8d3c\u6162\uff0c\u73b0\u5728\u7528\u4e86\u53ef\u4ee5\u88ab\u5361\u6210 n m \u7684\u7b1b\u5361\u5c14\u6811\u505a\u6cd5\uff0c\u53d1\u73b0\u8dd1\u5f97\u8d3c\u5feb\u3010\u96fe\n\n# noteskey\n\n\u4ecb\u7ecd\u4e00\u79cd\u590d\u6742\u5ea6\u9519\u8bef\u7136\u9e45\u5728\u968f\u673a\u6570\u636e\u4e0b\u8dd1\u5f97\u8d3c\u5feb\u7684\u7b97\u6cd5\uff1a \u7b1b\u5361\u5c14\u6811\n\n\u65b9\u6cd5\u5c31\u662f $O~ n$ \u6784\u9020\u4e00\u4e2a\u7b1b\u5361\u5c14\u6811\uff0c\u7136\u540e\u540c\u5728\u7ebf\u505a\u6cd5\u4e00\u6837\uff0c\u5c31\u662f\u6bcf\u4e2a\u70b9\u5904\u7406\u51fa  $fr[i],fl[i]$  \u8868\u793a\u4ee5 i \u4e3a\u7ec8\u6b62\u7684\u524d\u7f00\u8d21\u732e\u548c\u540e\u7f00\u8d21\u732e\uff0c\u5e76\u7528 $gr[i],gl[i]$ \u8868\u793a\u5176\u524d/\u540e\u7f00\u548c\n\n\n\u7136\u540e\u6bcf\u6b21\u7b1b\u5361\u5c14\u6811\u627e\u5230\u533a\u95f4\u6700\u5c0f\u503c\u7684\u4f4d\u7f6e\uff0c\u7136\u540e\u8fd9\u4e2a\u70b9\u4f1a\u628a\u6574\u4e2a\u533a\u95f4\u5206\u6210\u4e24\u4efd\uff0c\u8fd9\u6837\u7684\u8bdd\u6211\u4eec\u53ea\u8981\u5904\u7406\u4e24\u4efd\u533a\u95f4\u5185\u7684\u7b54\u6848\u5c31\u597d\u4e86\n\n\u5bf9\u4e8e\u4e24\u4efd\u533a\u95f4\u6211\u4eec\u7528 $fl~ fr~ gl~ gr$ \u56db\u4e2a\u6570\u7ec4\u5c31\u53ef\u4ee5\u5904\u7406\u51fa\u5206\u522b\u7684\u8d21\u732e\u4e86\n\n\n\n\n\n# code\n\n\u8fd9\u4efd\u4ee3\u7801\u5728\u6d1b\u5495 4 \u662f\u600e\u4e48\u4e5f\u8dd1\u4e0d\u8fdb 150 ms \u7684\n\n\n```\n//by Judge\n#include<cstdio>\n#include<cstring>\n#include<iostream>\n#define Rg register\n#define fp(i,a,b) for(Rg int i=(a),I=(b)+1;i<I;++i)\n#define fd(i,a,b) for(Rg int i=(a),I=(b)-1;i>I;--i)\n#define ll long long\nusing namespace std;\nconst int M=1e5+3;\ntypedef int arr[M];\ntypedef ll ARR[M];\n#ifndef Judge\n#define getchar() (p1==p2&&(p2=(p1=buf)+fread(buf,1,1<<21,stdin),p1==p2)?EOF:*p1++)\n#endif\nchar buf[1<<21],*p1=buf,*p2=buf;\ninline int read(){ int x=0,f=1; char c=getchar();\n\tfor(;!isdigit(c);c=getchar()) if(c=='-') f=-1;\n\tfor(;isdigit(c);c=getchar()) x=x*10+c-'0'; return x*f;\n} char sr[1<<21],z[20];int CCF=-1,Z;\ninline void Ot(){fwrite(sr,1,CCF+1,stdout),CCF=-1;}\ninline void print(ll x,char chr='\\n'){\n\tif(CCF>1<<20)Ot();if(x<0)sr[++CCF]=45,x=-x;\n\twhile(z[++Z]=x%10+48,x/=10);\n\twhile(sr[++CCF]=z[Z],--Z);sr[++CCF]=chr;\n} int n,m,rt,top; arr a,s,lc,rc,pre,suf; ARR fl,fr,gl,gr;\ninline int query(int l,int r){ //\u627e\u5230\u8fd9\u4e2a\u533a\u95f4\u5185\u7684\u6700\u5c0f\u503c\u4f4d\u7f6e \n\tfor(Rg int x=rt;;x=x>r?lc[x]:rc[x])\n\t\tif(l<=x&&x<=r) return x;\n}\nint main(){ n=read(),m=read(),a[0]=a[n+1]=2e9;\n\tfp(i,1,n){ a[i]=read();\n\t\twhile(top&&a[s[top]]>=a[i]) lc[i]=s[top--]; \n        \trc[s[top]]=i,s[++top]=i;\n\t} rt=s[1],top=0;\n\tfp(i,1,n){\n\t\twhile(top&&a[s[top]]>a[i]) suf[s[top--]]=i;\n\t\tpre[i]=s[top],s[++top]=i;\n\t}\n\twhile(top) pre[s[top]]=s[top-1],suf[s[top--]]=n+1;\n\tfp(i,1,n) fr[i]=fr[pre[i]]+1ll*a[i]*(i-pre[i]),gr[i]=gr[i-1]+fr[i];\n\tfd(i,n,1) fl[i]=fl[suf[i]]+1ll*a[i]*(suf[i]-i),gl[i]=gl[i+1]+fl[i];\n\tfp(i,1,m){ Rg int l=read(),r=read(),p=query(l,r); //\u548c\u5728\u7ebf\u65f6\u4e00\u6837\u7684\u601d\u8def \n\t\tprint(1ll*(p-l+1)*(r-p+1)*a[p]+gr[r]-gr[p]-fr[p]*(r-p)+gl[l]-gl[p]-1ll*fl[p]*(p-l));\n\t} return Ot(),0;\n}\n```\n\n\n",
        "postTime": 1555985279,
        "uid": 38576,
        "name": "J\u03bcdge",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3246 \u3010[HNOI2016]\u5e8f\u5217\u3011"
    },
    {
        "content": "\u9996\u5148,\u770b\u5230\u9898\u76ee,\u5e94\u8be5\u53ef\u4ee5\u60f3\u5230\u83ab\u961f\u3002\n\n\u4e0d\u8003\u8651\u65f6\u95f4\u548c\u7a7a\u95f4,\u6211\u4eec\u53ef\u4ee5\u8bbe\u8ba1\u5982\u4e0b\u7b97\u6cd5:\n\n\u8bb0$ansl_{l,r}$\u4e3a\u4ee5$l$\u4e3a\u5de6\u7aef\u70b9,\u53f3\u7aef\u70b9\u5728$[l,r]$\u8303\u56f4\u5185\u7684\u533a\u95f4\u7684\u6700\u5c0f\u503c\u4e4b\u548c;$ansr_{l,r}$\u4e3a\u4ee5$r$\u4e3a\u53f3\u7aef\u70b9,\u5de6\u7aef\u70b9\u5728$[l,r]$\u8303\u56f4\u5185\u7684\u533a\u95f4\u6700\u5c0f\u503c\u4e4b\u548c\u3002\n\n\u8bb0\u4e0a\u4e00\u4e2a\u6bd4$a_i$\u5c0f\u7684\u6570\u7684**\u4f4d\u7f6e**\u4e3a$s_i$,\u53ef\u4ee5\u7528\u5355\u8c03\u6808\u6c42\u5f97\u3002\u5219$ansr_{l,r}=ansr_{l,s_r}+a_r\\times(r-s_r)$,$ansl$\u540c\u7406\u3002\n\n\u7136\u540e\u770b\u770b\u5982\u4f55\u83ab\u961f\u3002\n\n\u5f53\u4ece\u5de6\u8fb9\u52a0\u5165\u4e00\u4e2a\u6570\u65f6,\u7b54\u6848\u52a0\u4e0a$ansl_{l-1,r}$;\n\n\u5f53\u4ece\u53f3\u8fb9\u52a0\u5165\u4e00\u4e2a\u6570\u65f6,\u7b54\u6848\u52a0\u4e0a$ansr_{l,r+1}$;\n\n\u5f53\u4ece\u5de6\u8fb9\u51cf\u53bb\u4e00\u4e2a\u6570\u65f6,\u7b54\u6848\u51cf\u53bb$ansl_{l,r}$;\n\n\u5f53\u4ece\u53f3\u8fb9\u51cf\u53bb\u4e00\u4e2a\u6570\u65f6,\u7b54\u6848\u51cf\u53bb$ansr_{l,r}$;\n\n\u4f46\u662f\u53d1\u73b0$ansl,ansr$\u6570\u7ec4\u7684\u65f6\u95f4\u548c\u7a7a\u95f4\u90fd\u662f$O(n^2)$\u7684\u3002\n\n\u8003\u8651\u4f18\u5316(\u4ee5$ansr$\u4e3a\u4f8b):\n\n![\u56fe\u70b8\u4e86QWQ](https://i.ibb.co/vB6VX51/BZOJ4540.png)\n\n\u4e8e\u662f,\u6539\u53d8$ansr$\u7684\u5b9a\u4e49,\u6539\u4e3a:\n\n$ansr_i=ansr_{s_i}+a_i\\times(i-s_i)$\n\n\u5f53\u6211\u4eec\u60f3\u8be2\u95ee\u4ee5$r$\u4e3a\u53f3\u7aef\u70b9,\u5de6\u7aef\u70b9\u5728$[l,r]$\u8303\u56f4\u5185\u7684\u7b54\u6848\u65f6,\u7b54\u6848$=ansr_r-ansr_l$(\u524d\u63d0\u662f$r$\u901a\u8fc7\u4e0d\u505c\u53d6$s_r$\u80fd\u591f\u53d6\u5230$l$\u3002\u4e4b\u540e\u7684\u8be2\u95ee\u65b9\u5f0f\u4fdd\u8bc1\u4e86\u8fd9\u4e00\u70b9)\u3002\n\n\u56de\u5230\u95ee\u9898\u3002\n\n\u4e8e\u662f\u5f53\u4ece\u53f3\u8fb9\u52a0\u5165\u4e00\u4e2a\u6570\u65f6\u8bbe**\u5f53\u524d**\u533a\u95f4\u7684RMQ\u4f4d\u4e8e$id$,\u65b0\u4ea7\u751f\u7684\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u4e3a$(ans_r-ans_{id})+a_{id}\\times(id-l+1)$\u3002\n\n\u7b2c\u4e00\u4e2a\u62ec\u53f7\u5185\u5373\u4e0a\u56fe\u4e2d\u7eff\u8272\u533a\u57df\u7684\u8d21\u732e,\u52a0\u53f7\u4e4b\u540e\u4e3a\u84dd\u8272\u533a\u57df\u548cRMQ\u4f4d\u7f6e\u7684\u8d21\u732e\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\u964d\u4e3a\u83ab\u961f\u7684$O(n\\sqrt{n})$(RMQ\u53ef\u4ee5O(1),\u89c1\u4ee3\u7801)\u3002\n\ncode:\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nconst int INF=2e9;\nstruct query{\n    int l,r,blk,id;\n}q[100010];\nint n,m,bs,a[100010],d[100010],id[100010],sz,Log2[100010],mn[100010][20],mp[100010][20],l,r;\nlong long lans[100010],rans[100010],ans,prt[100010];\nbool cmp(query x,query y){\n    if(x.blk==y.blk){\n        if(x.blk&1)return x.r>y.r;\n        else return x.r<y.r;\n    }else return x.blk<y.blk;\n}\nint RMQ(int L,int R){\n    int l2=Log2[R-L+1];\n    if(mn[L][l2]<mn[R-(1<<l2)+1][l2])return mp[L][l2];\n    else return mp[R-(1<<l2)+1][l2];\n}\nvoid Insl(int x){\n    int Id=RMQ(l,r);\n    ans+=lans[l]-lans[Id]+1ll*a[Id]*(r-Id+1);\n}\nvoid Insr(int x){\n    int Id=RMQ(l,r);\n    ans+=rans[r]-rans[Id]+1ll*a[Id]*(Id-l+1);\n}\nvoid Dell(int x){\n    int Id=RMQ(l,r);\n    ans-=lans[l]-lans[Id]+1ll*a[Id]*(r-Id+1);\n}\nvoid Delr(int x){\n    int Id=RMQ(l,r);\n    ans-=rans[r]-rans[Id]+1ll*a[Id]*(Id-l+1);\n}\nint main(){\n    scanf(\"%d%d\",&n,&m);\n    bs=sqrt(n);\n    for(int i=1;i<=n;i++)Log2[i]=(1<<Log2[i-1]+1)>i?Log2[i-1]:Log2[i-1]+1;\n    for(int i=1;i<=n;i++){\n        scanf(\"%d\",&a[i]);\n        mn[i][0]=a[i];\n        mp[i][0]=i;\n    }\n    for(int i=1;i<=Log2[n];i++){\n        mn[n+1][i]=INF;\n        for(int j=1;j<=n;j++){\n            if(mn[j][i-1]<mn[j+(1<<i-1)][i-1])mn[j][i]=mn[j][i-1],mp[j][i]=mp[j][i-1];\n            else mn[j][i]=mn[j+(1<<i-1)][i-1],mp[j][i]=mp[j+(1<<i-1)][i-1];\n        }\n    }\n    for(int i=1;i<=n;i++){\n        while(sz>0&&d[sz]>=a[i])sz--;\n        d[++sz]=a[i];\n        id[sz]=i;\n        rans[i]=1ll*a[i]*(i-id[sz-1])+rans[id[sz-1]];\n    }\n    for(int i=n;i>=1;i--){\n        while(sz>0&&d[sz]>=a[i])sz--;\n        d[++sz]=a[i];\n        id[sz]=i;\n        lans[i]=1ll*a[i]*(id[sz-1]-i)+lans[id[sz-1]];\n    }\n    for(int i=1;i<=m;i++){\n        scanf(\"%d%d\",&q[i].l,&q[i].r);\n        q[i].blk=q[i].l/bs;\n        q[i].id=i;\n    }\n    sort(q+1,q+m+1,cmp);\n    l=1;\n    r=0;\n    ans=0;\n    for(int i=1;i<=m;i++){\n        while(l>q[i].l)l--,Insl(l);\n        while(r<q[i].r)r++,Insr(r);\n        while(l<q[i].l)Dell(l),l++;\n        while(r>q[i].r)Delr(r),r--;\n        prt[q[i].id]=ans;\n    }\n    for(int i=1;i<=m;i++)printf(\"%lld\\n\",prt[i]);\n    return 0;\n}\n```\n\n\n\n",
        "postTime": 1543404840,
        "uid": 26294,
        "name": "xryjr233",
        "ccfLevel": 9,
        "title": "[2018.11.27]BZOJ4540 [Hnoi2016]\u5e8f\u5217(\u83ab\u961f)"
    },
    {
        "content": "~~\u6b64\u9898\u7684\u8fd9\u79cd\u505a\u6cd5\u6781\u5ea6\u8003\u5bdf\u4ee3\u7801\u80fd\u529b~~\n\n\u9898\u610f\uff1a\u6c42\u4e00\u4e2a\u533a\u95f4\u4e2d\u6240\u6709\u5b50\u533a\u95f4\u7684 $\\min$ \u4e4b\u548c\uff0c\u591a\u6b21\u8be2\u95ee\u3002\n\n\u7c97\u7565\u770b\u4e86\u4e00\u4e0b\u9898\u89e3\u597d\u50cf\u6709\u51e0\u4e2a\u90fd\u662f\u6ca1\u6709\u4f18\u5316\u8fc7\u7684\u8fd9\u4e2a\u505a\u6cd5\uff08\n\n\u770b\u5230 $\\min$ \u7b2c\u4e00\u6b65\u5c31\u662f\u5efa\u7b1b\u5361\u5c14\u6811\u554a\u3002\n\n\u6839\u636e\u4e00\u4e2a\u5957\u8def\uff0c\u9884\u5904\u7406 $L[i]$ \u548c $R[i]$ \u8868\u793a\u8282\u70b9 $i$ \u7684\u5b50\u6811\u4ee3\u8868\u5e8f\u5217\u4e0a\u7684\u4e00\u4e2a\u533a\u95f4 $[L[i],R[i]]$\u3002\n\n\u7b54\u6848\u5f88\u660e\u663e\u662f $\\sum_{i=l}^ra[i]\\times(\\min(R[i],r)-i+1)\\times(i-\\max(L[i],l)+1)$\u3002\n\n\u5f00\u59cb\u5927\u529b\u62c6\u5f0f\u5b50\uff1a\n$$\\sum_{i=l}^ra[i]\\times(\\min(R[i]+1,r+1)-i)\\times(i-\\max(L[i]-1,l-1))$$\n$$(\\sum_{i=l}^ra[i]\\min(R[i]+1,r+1)\\max(L[i]-1,l-1))$$\n$$+(\\sum_{i=l}^ri\\times a[i]\\times(\\max(L[i]-1,l-1)+\\min(R[i]+1,r+1)))$$\n$$-(\\sum_{i=l}^ri^2\\times a[i])$$\n\u7b2c\u4e8c\u4e2a $\\sum$ \u548c\u7b2c\u4e09\u4e2a $\\sum$ \u90fd\u76f8\u5f53\u5e73\u51e1\u3002\n\n\u7b2c\u4e8c\u4e2a $\\sum$ \u7684\u5177\u4f53\u505a\u6cd5\u662f\uff0c\u5c06 $\\min$ \u548c $\\max$ \u5206\u5f00\uff0c\u7136\u540e\u5c06\u8be2\u95ee\u79bb\u7ebf\u5230 $l-1$ \u548c $r+1$ \u4e0a\uff0c\u7136\u540e\u7ef4\u62a4\u6bcf\u4e00\u4e2a\u4f4d\u7f6e\u73b0\u5728\u662f $L[i]-1$ \u8fd8\u662f $l-1$\uff0c\u6811\u72b6\u6570\u7ec4\u53ef\u4ee5\u505a\u5230 $O(m\\log n)$\u3002\n\n\u7b2c\u4e00\u4e2a $\\sum$ \u6709\u70b9\u513f\u50cf\u533a\u95f4\u4e8c\u7ef4\u6570\u70b9\uff0c\u6811\u5957\u6811\u53ef\u4ee5\u505a\u5230 $O(m\\log^2n)$\uff0c\u5b9e\u9645\u4e0a\u6709\u529e\u6cd5\u4f18\u5316\u5230 $O(m\\log n)$\u3002\n\n\u8003\u8651\u6574\u4e2a\u5e8f\u5217\u51cf\u53bb\u524d\u7f00\u548c\u540e\u7f00\u7684\u8d21\u732e\u3002\u6ce8\u610f\u5230\u5bf9\u4e8e $i\\in[1,L)$ \u6709 $l[i]\\leq l$ \u548c\u5bf9\u4e8e $i\\in(R,n]$ \u6709 $R[i]\\geq r$\uff0c\u80fd\u591f\u5f97\u5230\uff1a\n$$\\sum_{i=1}^na[i]\\min(R[i]+1,r+1)\\max(L[i]-1,l-1)$$\n$$-(\\sum_{i=1}^{l-1}a[i](l-1)\\min(R[i]+1,r+1)+\\sum_{i=r+1}^na[i](r+1)\\max(L[i]-1,l-1))$$\n\u540e\u9762\u4e24\u4e2a\u4f7f\u7528\u524d\u9762\u7b2c\u4e09\u4e2a $\\sum$ \u7684\u505a\u6cd5\u5373\u53ef\uff0c\u7b2c\u4e00\u4e2a\u76f4\u63a5\u4f7f\u7528\u4e3b\u5e2d\u6811\u5373\u53ef\u3002\n\n\u4f7f\u7528\u524d\u7f00\u548c\u4f18\u5316\u4e00\u4e0b\u53ef\u4ee5\u505a\u5230\u53ea\u67e5\u8be2\u4e00\u6b21\u4e3b\u5e2d\u6811\u3002\n\n\u590d\u6742\u5ea6 $O((n+m)\\log n)$\u3002\n\n\u4e3a\u4ec0\u4e48\u8fd9\u662f\u5bf9\u7684\uff1f\n\n\u8003\u8651\u5efa\u7acb\u7b1b\u5361\u5c14\u6811\u7684\u8fc7\u7a0b\uff0c\u662f\u5f39\u51fa\u4e00\u5806\u5143\u7d20\u518d\u52a0\u5165\u4e00\u4e2a\u5143\u7d20\u3002\n\n\u8fd9\u4e2a\u64cd\u4f5c\u7684\u672c\u8d28\u662f **\u56fa\u5b9a\u5f39\u51fa\u5143\u7d20\u6240\u5bf9\u5e94\u7684\u533a\u95f4\uff0c\u5e76\u4e14\u4ee4\u6808\u5185\u5143\u7d20\u7684\u53f3\u7aef\u70b9\u53f3\u79fb**\u3002\n\n\u8003\u8651\u4ece\u4e00\u4e2a\u533a\u95f4\u7684\u7b1b\u5361\u5c14\u6811\u6269\u5c55\u5230\u6574\u4e2a\u5e8f\u5217\u7684\u7b1b\u5361\u5c14\u6811\uff0c\u53ef\u4ee5\u901a\u8fc7\u4e0a\u8ff0\u7684\u63d2\u5165\u64cd\u4f5c\u6765\u5b8c\u6210\u3002\n\n\u56e0\u6b64\u8fd9\u6837\u6bcf\u4e2a\u8282\u70b9\u6240\u5bf9\u5e94\u7684\u533a\u95f4\u4e00\u5b9a\u662f\u6b63\u786e\u7684\u3002\n\n\u8fd8\u6709\u4e00\u79cd\u7406\u89e3\uff0c\u662f\u533a\u95f4\u7684\u7b1b\u5361\u5c14\u6811\u76f8\u5f53\u4e8e\u5bf9\u5e8f\u5217\u7b1b\u5361\u5c14\u6811\u5efa\u7acb\u865a\u6811\u3002\n```cpp\n#include<cstdio>\n#include<vector>\ntypedef long long ull;\nconst int M=1e5+5;\nint n,m,l[M],r[M],a[M],L[M],R[M],ls[M],rs[M],siz[M];int top,stk[M];ull ans[M];\null BIT1[M],BIT2[M];std::vector<int>idL[M],idR[M];\nstruct Query{\n\tint L,R,id,opt;\n};\ninline void Mdf1(int x,const ull&V){\n\twhile(x<=n)BIT1[x]+=V,x+=x&-x;\n}\ninline void Mdf2(int x,const ull&V){\n\twhile(x<=n)BIT2[x]+=V,x+=x&-x;\n}\ninline ull Qry1(int x){\n\tull ans(0);\n\twhile(x>=1)ans+=BIT1[x],x^=x&-x;\n\treturn ans;\n}\ninline ull Qry2(int x){\n\tull ans(0);\n\twhile(x>=1)ans+=BIT2[x],x^=x&-x;\n\treturn ans;\n}\nnamespace Sol1{\n//\\sum[l,r] i*Vi*(max(L[i]-1,l-1)+min(R[i]+1,r+1))\n\tstd::vector<Query>Q1[M],Q2[M];\n\tinline void init(){\n\t\tfor(int i=1;i<=m;++i){\n\t\t\tQ1[r[i]+1].push_back((Query){l[i],r[i],i,1});\n\t\t\tQ2[l[i]-1].push_back((Query){l[i],r[i],i,1});\n\t\t}\n\t}\n\tinline void Solve(){\n\t\tfor(int i=1;i<=n;++i)BIT1[i]=BIT2[i]=0;\n\t\tfor(int i=1;i<=n;++i)Mdf1(i,1ull*i*a[i]);\n\t\tfor(int i=1;i<=n+1;++i){\n\t\t\tfor(int&x:idR[i-1])Mdf1(x,-1ull*x*a[x]),Mdf2(x,1ull*x*a[x]*(R[x]+1));\n\t\t\tfor(Query&x:Q1[i])ans[x.id]+=x.opt*(1ull*(x.R+1)*(Qry1(x.R)-Qry1(x.L-1))+(Qry2(x.R)-Qry2(x.L-1)));\n\t\t}\n\t\tfor(int i=1;i<=n;++i)BIT1[i]=BIT2[i]=0;\n\t\tfor(int i=1;i<=n;++i)Mdf1(i,1ull*i*a[i]);\n\t\tfor(int i=n;i>=0;--i){\n\t\t\tfor(int&x:idL[i+1])Mdf1(x,-1ull*x*a[x]),Mdf2(x,1ull*x*a[x]*(L[x]-1));\n\t\t\tfor(Query&x:Q2[i])ans[x.id]+=x.opt*(1ull*(x.L-1)*(Qry1(x.R)-Qry1(x.L-1))+(Qry2(x.R)-Qry2(x.L-1)));\n\t\t}\n\t}\n}\nnamespace Sol2{\n//\\sum[1,l) Vi*(l-1)*min(R[i]+1,r+1)\n//\\sum(r,n] Vi*(r+1)*max(L[i]-1,l-1)\n\tstd::vector<Query>Q1[M],Q2[M];\n\tinline void init(){\n\t\tfor(int i=1;i<=m;++i){\n\t\t\tQ1[r[i]+1].push_back((Query){l[i],r[i],i,l[i]-1});\n\t\t\tQ2[l[i]-1].push_back((Query){l[i],r[i],i,r[i]+1});\n\t\t}\n\t}\n\tinline void Solve(){\n\t\tfor(int i=1;i<=n;++i)BIT1[i]=BIT2[i]=0;\n\t\tfor(int i=1;i<=n;++i)Mdf1(i,a[i]);\n\t\tfor(int i=1;i<=n+1;++i){\n\t\t\tfor(int&x:idR[i-1])Mdf1(x,-a[x]),Mdf2(x,1ull*a[x]*(R[x]+1));\n\t\t\tfor(Query&x:Q1[i])ans[x.id]+=x.opt*(1ull*(x.R+1)*(Qry1(x.L-1)-Qry1(0))+(Qry2(x.L-1)-Qry2(0)));\n\t\t}\n\t\tfor(int i=1;i<=n;++i)BIT1[i]=BIT2[i]=0;\n\t\tfor(int i=1;i<=n;++i)Mdf1(i,a[i]);\n\t\tfor(int i=n;i>=0;--i){\n\t\t\tfor(int&x:idL[i+1])Mdf1(x,-a[x]),Mdf2(x,1ull*a[x]*(L[x]-1));\n\t\t\tfor(Query&x:Q2[i])ans[x.id]+=x.opt*(1ull*(x.L-1)*(Qry1(n)-Qry1(x.R))+(Qry2(n)-Qry2(x.R)));\n\t\t}\n\t}\n}\nnamespace Sol3{\n//\\sum[1,n] i*Vi*min(R[i]+1,r+1)*max(L[i]-1,l-1)\n\tstruct Node{\n\t\tint L,R;ull sum1,sum2,sum3,sum4;\n\t}t[M*20];\n\tint tot,root[M];ull T1,T2,T3,T4,S1x[M],S1y[M],S2x[M],S2y[M],S3x[M],S3y[M],S4x[M],S4y[M];ull S1,S2,S3,S4;\n\tinline int Mdf(int u,const int&x,const ull&V1,const ull&V2,const ull&V3,const ull&V4,const int&L=1,const int&R=n){\n\t\tconst int id=++tot;\n\t\tt[id]=t[u];\n\t\tt[id].sum1+=V1;\n\t\tt[id].sum2+=V2;\n\t\tt[id].sum3+=V3;\n\t\tt[id].sum4+=V4;\n\t\tif(L<R){\n\t\t\tconst int mid=L+R>>1;\n\t\t\tif(x<=mid)t[id].L=Mdf(t[u].L,x,V1,V2,V3,V4,L,mid);\n\t\t\telse t[id].R=Mdf(t[u].R,x,V1,V2,V3,V4,mid+1,R);\n\t\t}\n\t\treturn id;\n\t}\n\tinline void Qry(int q,int p,const int&l,const int&r,const int&L=1,const int&R=n){\n\t\tif(l>R||L>r||!p)return;\n\t\tif(l<=L&&R<=r){\n\t\t\tS1+=t[p].sum1-t[q].sum1;\n\t\t\tS2+=t[p].sum2-t[q].sum2;\n\t\t\tS3+=t[p].sum3-t[q].sum3;\n\t\t\tS4+=t[p].sum4-t[q].sum4;\n\t\t\treturn;\n\t\t}\n\t\tconst int mid=L+R>>1;\n\t\tQry(t[q].L,t[p].L,l,r,L,mid);Qry(t[q].R,t[p].R,l,r,mid+1,R);\n\t}\n\tinline void init(){\n\t\tfor(int i=1;i<=n;++i){\n\t\t\troot[i]=root[i-1];\n\t\t\tfor(int&ID:idR[i]){\n\t\t\t\tconst ull&V=a[ID];const int&l=L[ID]-1,&r=R[ID]+1;\n\t\t\t\troot[i]=Mdf(root[i],L[ID],V,V*l,V*r,V*l*r);\n\t\t\t}\n\t\t}\n\t\tfor(int i=1;i<=n;++i){\n\t\t\tconst ull&V=a[i];const int&l=L[i]-1,&r=R[i]+1;\n\t\t\tS1x[R[i]]+=V;S1y[L[i]]+=V;T1+=V;\n\t\t\tS2x[R[i]]+=V*l;S2y[L[i]]+=V*l;T2+=V*l;\n\t\t\tS3x[R[i]]+=V*r;S3y[L[i]]+=V*r;T3+=V*r;\n\t\t\tS4x[R[i]]+=V*l*r;S4y[L[i]]+=V*l*r;T4+=V*l*r;\n\t\t}\n\t\tfor(int i=1;i<=n;++i){\n\t\t\tS1x[i]+=S1x[i-1];S1y[i]+=S1y[i-1];\n\t\t\tS2x[i]+=S2x[i-1];S2y[i]+=S2y[i-1];\n\t\t\tS3x[i]+=S3x[i-1];S3y[i]+=S3y[i-1];\n\t\t\tS4x[i]+=S4x[i-1];S4y[i]+=S4y[i-1];\n\t\t}\n\t}\n\tinline void Solve(){\n\t\tfor(int i=1;i<=m;++i){\n\t\t\tconst int&L=l[i],&R=r[i];\n\t\t\tS1=S2=S3=S4=0;Qry(root[0],root[R],1,L);\n\t\t\tans[i]-=\n\t\t\t1ull*S3*(L-1)+\n\t\t\t1ull*(S4x[R]-S4)+\n\t\t\t1ull*(S1y[L]-S1)*(R+1)*(L-1)+\n\t\t\t1ull*(T2-S2x[R]-S2y[L]+S2)*(R+1);\n\t\t}\n\t}\n}\nnamespace Sol4{\n//\\sum[l,r] i^2*Vi\n\tull sum[M];\n\tinline void init(){\n\t\tfor(int i=1;i<=n;++i)sum[i]=sum[i-1]+1ull*i*i*a[i];\n\t}\n\tinline void Solve(){\n\t\tfor(int i=1;i<=m;++i){\n\t\t\tans[i]-=sum[r[i]]-sum[l[i]-1];\n\t\t}\n\t}\n}\ninline void Build(){\n\tfor(int i=1;i<=n;++i){\n\t\tif(top&&a[i]<=a[stk[top]]){\n\t\t\twhile(top&&a[i]<=a[stk[top]])--top;\n\t\t\tls[i]=stk[top+1];\n\t\t}\n\t\tif(top)rs[stk[top]]=i;stk[++top]=i;\n\t}\n}\ninline void DFS(const int&u){\n\tif(ls[u])DFS(ls[u]);if(rs[u])DFS(rs[u]);\n\tL[u]=u-siz[ls[u]];R[u]=u+siz[rs[u]];\n\tsiz[u]=siz[ls[u]]+siz[rs[u]]+1;\n}\nsigned main(){\n\tscanf(\"%d%d\",&n,&m);\n\tfor(int i=1;i<=n;++i)scanf(\"%d\",a+i);Build();DFS(stk[1]);\n\tfor(int i=1;i<=n;++i){\n\t\tidL[L[i]].push_back(i);\n\t\tidR[R[i]].push_back(i);\n\t}\n\tfor(int i=1;i<=m;++i)scanf(\"%d%d\",l+i,r+i);\n\tSol1::init();Sol2::init();Sol3::init();Sol4::init();\n\tSol1::Solve();Sol2::Solve();Sol3::Solve();Sol4::Solve();\n\tfor(int i=1;i<=m;++i)printf(\"%lld\\n\",ans[i]);\n}\n```",
        "postTime": 1645530057,
        "uid": 160839,
        "name": "Prean",
        "ccfLevel": 7,
        "title": "\u6570\u636e\u7ed3\u6784 \u7b1b\u5361\u5c14\u6811+\u4e3b\u5e2d\u6811+\u6811\u72b6\u6570\u7ec4 P3246\u9898\u89e3"
    },
    {
        "content": "\u9898\u76ee\u8981\u6c42\u7684\u662f\u6240\u6709\u5b50\u533a\u95f4\u7684\u6700\u5c0f\u503c\uff0c\u6240\u4ee5\u4e00\u4e2a\u6570\u663e\u7136\u5f88\u6709\u53ef\u80fd\u88ab\u7b97\u5f88\u591a\u6b21\u3002\u6211\u4eec\u8003\u8651\u600e\u4e48\u7b97\u8d21\u732e\uff1a\n\n\u5bf9\u4e8e\u4e00\u4e2a\u533a\u95f4 $[L,R]$\uff0c\u6211\u4eec\u627e\u5230\u8fd9\u4e2a\u533a\u95f4\u7684\u6700\u5c0f\u503c $x$\u3002\u90a3\u4e48\uff0c\u5bf9\u4e8e\u5de6\u7aef\u70b9\u5728\u5de6\u534a\u90e8\u5206\uff0c\u53f3\u7aef\u70b9\u5728\u53f3\u534a\u90e8\u5206\u7684\u5b50\u533a\u95f4\uff0c\u5176\u7b54\u6848\u5fc5\u5b9a\u662f $x$\u3002\n\n\u73b0\u5728\u8981\u7edf\u8ba1\u7684\u5c31\u662f\u5de6\u534a\u90e8\u5206\u7684\u7b54\u6848\u548c\u53f3\u534a\u90e8\u5206\u7684\u7b54\u6848\u3002\u7531\u4e8e\u5de6\u53f3\u5730\u4f4d\u5bf9\u79f0\uff0c\u6211\u4eec\u53ea\u8003\u8651\u53f3\u534a\u90e8\u5206\u3002\n\n\u6211\u4eec\u4ee4 $pre_i$ \u8868\u793a $i$ \u524d\u9762\u7b2c\u4e00\u4e2a\u5c0f\u4e8e $a_i$ \u7684\u6570\u7684\u4f4d\u7f6e\uff0c$f_i$ \u4e3a\u4ee5 $i$ \u4e3a\u53f3\u7aef\u70b9\u7684\u7b54\u6848\u3002\n\n\u56e0\u4e3a $pre_i$ \u662f\u7b2c\u4e00\u4e2a\u66f4\u5c0f\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5217\u51fa\u9012\u63a8\u5f0f\uff1a$f_i = f_{pre_i} + (i - pre_i) \\times a_i$\u3002\n\n\u7531\u4e8e\u6700\u7ec8\u5fc5\u5b9a\u5b58\u5728\u4e00\u4e2a\u70b9\uff0c\u5176 $pre=x$\uff0c\u6240\u4ee5\u5c06\u5176\u5c55\u5f00\u5f97\u5230\u533a\u95f4 $[l,r]$ \u7684\u7b54\u6848\u4e3a $f_r-f_{l-1}$\u3002\n\n\u5bf9 $f$ \u505a\u524d\u7f00\u548c\u5373\u53ef\u6c42\u51fa\u6574\u4e2a\u53f3\u534a\u90e8\u5206\u7684\u7b54\u6848\u3002\n\n\u81f3\u4e8e\u5de6\u534a\u90e8\u5206\u540c\u7406\u3002\n\n\u7b97\u6cd5\u74f6\u9888\u5728\u4e8e RMQ\uff0c\u53ef\u4ee5\u7528 Four Russian \u4f18\u5316\u3002\n\n```cpp\n#include <algorithm>\n#include <cmath>\n#include <cstdio>\n#include <stack>\nusing namespace std;\nconst int N = 1e5 + 5;\nlong long a[N];\nint n, m;\n#define isdigit(ch) (ch >= '0' && ch <= '9')\n#define debug(...) fprintf(stderr, __VA_ARGS__)\n#define Debug(x)                                                               \\\n    debug(\"Passing [%s] in LINE %d , %s=%d\\n\", __FUNCTION__, __LINE__, #x, x)\nchar buf[1 << 23], *p1 = buf, *p2 = buf;\n#define getchar()                                                              \\\n    (p1 == p2 && (p2 = (p1 = buf) + fread(buf, 1, 1 << 21, stdin), p1 == p2) ? EOF : *p1++ )\ninline int read() {\n    int x = 0, f = 1;\n    char ch = getchar();\n    while (!isdigit(ch)) {\n        if (ch == '-')\n            f = -1;\n        ch = getchar();\n    }\n    while (isdigit(ch))\n        x = x * 10 + (ch ^ 48), ch = getchar();\n    return x * f;\n}\nnamespace FR {\nint st[N / 100][30], lg[N];\nint pre[N], suf[N];\nint pos[N];\nint block;\ninline int bf(int l, int r) {\n    int p = l;\n    for (int i = l; i <= r; i++)\n        if (a[i] < a[p])\n            p = i;\n    return p;\n}\ninline void init() {\n    for (int i = 1; i <= n; i++)\n        pos[i] = (i + block - 1) / block;\n    for (int i=2; i<=n; i++) lg[i] = lg[i>>1] + 1;\n    int p = pos[n];\n    for (int i=1; i<=n; i++) {\n        int j = pos[i];\n        if (a[i] < a[st[j][0]]) st[j][0] = i;\n    }\n    for (int len=1; len<=lg[p]; len++) {\n        for (int i=1; i<=p-(1<<len)+1; i++) {\n            if (a[st[i][len - 1]] <= a[st[i + (1 << (len - 1))][len - 1]])\n                st[i][len] = st[i][len - 1];\n            else st[i][len] = st[i + (1 << (len - 1))][len - 1];\n        }\n    }\n    pre[1] = 1;\n    for (int i = 2; i <= n; i++)\n        if (pos[i-1] == pos[i]) {\n            if (a[pre[i - 1]] <= a[i])\n                pre[i] = pre[i - 1];\n            else\n                pre[i] = i;\n        } else\n            pre[i] = i;\n    suf[n] = n;\n    for (int i = n - 1; i >= 1; i--)\n        if (pos[i+1] == pos[i]) {\n            if (a[suf[i + 1]] <= a[i])\n                suf[i] = suf[i + 1];\n            else\n                suf[i] = i;\n        } else\n            suf[i] = i;\n}\ninline int rmq(int x, int y) {\n    int l = pos[x], r = pos[y];\n    if (l == r)\n        return bf(x, y);\n    else if (r - l == 1) {\n        return a[pre[y]] <= a[suf[x]] ? pre[y] : suf[x];\n    } else {\n        int e = lg[r - l - 1];\n        int p, pl = st[l + 1][e], pr = st[r-(1<<e)][e];\n        p = a[pl] <= a[pr] ? pl : pr;\n        if (a[suf[x]] <= a[pre[y]] && a[suf[x]] <= a[p])\n            return suf[x];\n        else if (a[pre[y]] <= a[suf[x]] && a[pre[y]] <= a[p])\n            return pre[y];\n        else\n            return p;\n    }\n}\n} // namespace FR\nint sta[N], top;\nint pre[N], suf[N];\nlong long L[N], R[N], LL[N], RR[N];\nint main() {\n    n = read(), m = read();\n    FR::block = sqrt(n);\n    a[0] = a[n + 1] = 0x3f3f3f3f3f3f3f3f;\n    for (int i = 1; i <= n; i++)\n        a[i] = read();\n    FR::init();\n    for (int i = 1; i <= n + 1; i++) {\n        while (top && a[sta[top]] > a[i]) {\n            suf[sta[top]] = i;\n            top--;\n        }\n        pre[i] = sta[top];\n        sta[++top] = i;\n    }\n    for (int i = 1; i <= n; i++)\n        R[i] = a[i] * (i - pre[i]) + R[pre[i]], RR[i] = RR[i - 1] + R[i];\n    for (int i = n; i >= 1; i--)\n        L[i] = a[i] * (suf[i] - i) + L[suf[i]], LL[i] = LL[i + 1] + L[i];\n    for (int l, r; m; m--) {\n        l = read(), r = read();\n        int p = FR::rmq(l, r);\n        printf(\"%lld\\n\", (p - l + 1) * (r - p + 1) * a[p] + LL[l] - LL[p] -\n                             L[p] * (p - l) + RR[r] - RR[p] - R[p] * (r - p));\n    }\n    return 0;\n}\n```\n\n",
        "postTime": 1623132969,
        "uid": 255095,
        "name": "PragmaGCC",
        "ccfLevel": 6,
        "title": "P3246 \u9898\u89e3"
    },
    {
        "content": "### [\u9898\u76ee\u4f20\u9001\u95e8](https://www.luogu.com.cn/problem/P3246)\n\n## \u9898\u610f\n\n- \u7ed9\u5b9a\u4e00\u4e2a\u957f\u5ea6\u4e3a $n$ \u7684\u6b63\u6574\u6570\u5e8f\u5217\uff0c\u6709 $q$ \u6b21\u8be2\u95ee\u3002\n\n- \u6bcf\u6b21\u8be2\u95ee\u7ed9\u5b9a\u533a\u95f4 $[l,r]$ \uff0c\u6c42\u7ed9\u5b9a\u533a\u95f4\u7684**\u6240\u6709\u5b50\u6bb5\u4e2d\u7684\u6700\u5c0f\u503c\u7684\u548c**\u3002\n\n## Sol\n\n~~\u6bd4\u6a21\u677f\u7b80\u5355\u7684\u83ab\u961f\u4e8c\u6b21\u79bb\u7ebf~~\n\n\u9898\u76ee\u4e2d\u8981\u6c42\u533a\u95f4\u6700\u5c0f\uff0c\u56e0\u4e3a\u95ee\u8be2\u6709\u591a\u6b21\u4e14\u65e0\u4fee\u6539\uff0c\u5148\u5c1d\u8bd5\u91c7\u7528 $\\text{ST\u8868}$\uff0c\u9884\u5904\u7406 $O(n \\log n)$\uff0c\u95ee\u8be2 $O(1)$\u3002\uff08\u6ca1\u7528\u4e5f\u6ca1\u4e8b\uff08\u96fe\uff09\uff09\n\n\u53ef\u79bb\u7ebf\u7684\u533a\u95f4\u95ee\u8be2\uff0c\u663e\u7136**\u83ab\u961f**\u3002\n\n\u4f46\u6211\u4eec\u53d1\u73b0\u83ab\u961f\u7684\u8bdd\uff0c\u590d\u6742\u5ea6\u5df2\u7ecf $O(n \\sqrt n)$ \u4e86\uff0c\u4e8e\u662f\u4fbf\u8981\u6c42\u66f4\u65b0\u64cd\u4f5c\u662f $O(1)$ \u7684\u3002\n\n\u6211\u4eec\u6765\u63a2\u8ba8\u4e00\u4e0b**\u66f4\u65b0\u64cd\u4f5c**\u3002\n\n\u6211\u4eec\u53ea\u8bf4\u53f3\u7aef\u70b9\u53f3\u79fb\u64cd\u4f5c\u66f4\u65b0\uff0c\u5176\u4ed6\u4ee5\u6b64\u7c7b\u63a8\u3002\n\n\u8bbe\u65b0\u533a\u95f4\u4e3a $[l,r]$\uff0c\u6211\u4eec\u66f4\u65b0\u7684\u7b54\u6848\u5c31\u662f $\\sum\\limits_{i=l}^rmin[i,r]$\u3002\n\n\u8bbe $min[l,r]=a_x$\u3002\n\n#### \u56e0\u4e3a\u4e0d\u786e\u5b9a $x$ \u7684\u4f4d\u7f6e\u8fdb\u884c\u5206\u7c7b\u8ba8\u8bba\u3002\n\n1. $i \\le x$\n\n   $min[i,r]=a_x$\uff0c\u6240\u4ee5\u5bf9\u7b54\u6848\u7684\u603b\u8d21\u732e\u662f $(x-l+1) \\times a_x$\u3002\n\n2. $1 \\le i \\le r$ \n\n   \u5b9a\u4e49 $sumL_i=\\sum\\limits_{j=1}^imin[j,i]$\u3002\n\n   \u6211\u4eec\u53ef\u5f97\u8d21\u732e\u4e3a $sumL_r$\u3002\n\n3. $1 \\le i \\le x$\n\n   \u56e0\u4e3a $a_x=min[l,r]$\u3002\n\n   \u6240\u4ee5 $min[i,r]=min[i,x]$\u3002\n\n   \u6240\u4ee5\u8d21\u732e\u5373\u4e3a $sumL_x$\u3002\n\n\u7efc\u4e0a\uff0c\u66f4\u65b0\u7b54\u6848\u4e3a $(x-l+1) \\times a_x-sumL_x+sumL_r$\u3002\n\n\u90a3\u4e48\u6211\u4eec\u5c31\u8981\u8ba1\u7b97 $sumL_i,sumR_i$\u3002\n\n\u8bbe $lst_i$ $=$ $i$ \u4e4b\u524d\u7b2c\u4e00\u4e2a\u5c0f\u4e8e $a[i]$ \u7684\u503c\u7684\u4f4d\u7f6e\u3002\n\n\u5f53\u53f3\u7aef\u70b9\u4e3a $i$ \u65f6\uff0c\u8fdb\u884c\u5206\u8ba8\u3002\n\n1. $j  > lst_i$ \n\n   $min[j,i]=a[i]$\u3002\n\n2. $j \\le lst_i$\n\n   $sumL_i=sumL_{lst_i}+(i-lst_i) \\times a_i$\u3002\n\n\u7136\u540e\u6211\u4eec\u5c31\u53d1\u73b0\u8fd8\u8981\u8ba1\u7b97 $lst_i,nxt_i$\u3002\uff08$nxt_i$ \u5c31\u662f\u53cd\u8fc7\u6765\u3002\uff09\n\n\u8bbe $x < y$\uff0c$a_x \\ge a_y$\u3002\n\n\u5219\u5f53 $i > y$ \u65f6\uff0c$x$ \u5bf9\u5176\u65e0\u8d21\u732e\u3002\n\n\u6240\u4ee5\u6211\u4eec\u7528\u5355\u8c03~~\u961f\u5217~~\u6808\u7ef4\u62a4\u3002\n\n\u5f53\u4e14\u4ec5\u5f53 $a_i \\le a_{q_{r-1}}$ \u65f6\uff0c$nxt_{q_{r-1}}=i$\uff0c\u5e76\u8e22\u51fa $q_{r-1}$\u3002\n\n\u51b3\u7b56\uff1a$lst_i=q_{r-1}$\u3002\n\n#### \u73b0\u5728\u4f60\u4ec0\u4e48\u90fd\u6709\u4e86\u3002/cy\n\n\u4f60\u5c31\u53ef\u4ee5\u624b\u5207\u8fd9\u9898\u5566\u3002/cy\n\n```cpp\n/*\n***\n\u8fd8\u8981\u7ee7\u7eed\u52aa\u529b\n\u6210\u4e3a\u4e00\u540d\u70e4\u5495\u5b66\u5bb6\u54e6\n***\n*/\n#include<bits/stdc++.h>\nusing namespace std;\ntypedef long long ll;\nconst ll N=1e5+5,INF=0x3f3f3f3f;\nll n,m,k,a[N],ans[N],len,qu[N],tot,l,r,f[N][25],Log[N],suml[N],sumr[N],lst[N],nxt[N]; \nstruct question{ll l,r,id,pos;}q[N];\ntemplate <typename T> void rd(T &x){\n\tll fl=1;x=0;char c=getchar();\n\tfor(;!isdigit(c);c=getchar()) if(c=='-') fl=-fl;\n\tfor(;isdigit(c);c=getchar()) x=(x<<3)+(x<<1)+c-'0';\n\tx*=fl;\n}\nvoid wr(ll x){\n\tif(x<0) x=-x,putchar('-');\n\tif(x<10) putchar(x+'0');\n\tif(x>9) wr(x/10),putchar(x%10+'0');\n}\nbool cmp(question x,question y){\n\tif(x.pos!=y.pos) return x.pos<y.pos;\n\tif(x.pos&1) return x.r<y.r;\n\treturn x.r>y.r;\n}\ninline ll RMQ(ll L,ll R){\n    ll val=Log[R-L+1];\n\tll to=R-(1<<val)+1;\n    return (a[f[L][val]]>a[f[to][val]]?f[to][val]:f[L][val]);\n}\ninline void upd(ll op){\n\tll x=RMQ(l,r);\n\tif(op==1) tot+=(r-x+1)*a[x]+sumr[l]-sumr[x];\n\tif(op==2) tot+=(x-l+1)*a[x]+suml[r]-suml[x];\n\tif(op==3) tot-=(r-x+1)*a[x]+sumr[l]-sumr[x];\n\tif(op==4) tot-=(x-l+1)*a[x]+suml[r]-suml[x];\n}\nint main(){\n//\tfreopen(\".in\",\"r\",stdin);\n//\tfreopen(\".out\",\"w\",stdout);\n\trd(n);rd(m);\n\tmemset(a,INF,sizeof(a));\n\tlen=(ll)sqrt(n);qu[0]=0;l=0,r=1;Log[0]=-1;\n\tfor(ll i=1;i<=n;i++) rd(a[i]),Log[i]=Log[i/2]+1,f[i][0]=i;\n\tfor(ll i=1;i<=m;i++) rd(q[i].l),rd(q[i].r),q[i].id=i,q[i].pos=(q[i].l-1)/len+1;\n\tfor(ll i=1;i<25;i++)\n\t\tfor(ll j=1;j<=n-(1<<(i-1));j++){\n\t\t\tll to=j+(1<<(i-1));\n\t\t\tf[j][i]=(a[f[j][i-1]]>a[f[to][i-1]]?f[to][i-1]:f[j][i-1]);\n\t\t}\n\tfor(ll i=1;i<=n;i++){\n\t\tfor(;l<r&&a[i]<a[qu[r-1]];r--) nxt[qu[r-1]]=i;\n\t\tlst[i]=qu[r-1];\n\t\tqu[r++]=i;\n\t}\n\tfor(;l<r;r--) nxt[qu[r-1]]=n+1;\n\tfor(ll i=1;i<=n;i++) suml[i]=suml[lst[i]]+(i-lst[i])*a[i];\n\tfor(ll i=n;i>0;i--) sumr[i]=sumr[nxt[i]]+(nxt[i]-i)*a[i];\n\tsort(q+1,q+m+1,cmp);l=1;r=0;\n\tfor(ll i=1;i<=m;i++){\n\t\twhile(l>q[i].l) --l,upd(1);\n\t\twhile(r<q[i].r) ++r,upd(2);\n\t\twhile(l<q[i].l) upd(3),l++;\n\t\twhile(r>q[i].r) upd(4),r--;\n\t\tans[q[i].id]=tot;\n\t}\n\tfor(ll i=1;i<=m;i++) wr(ans[i]),puts(\"\");\n\treturn 0;\n}\n```\n\n\u771f\u662f\u4ee4\u4eba\u9ad8\u5174\u5462\u3002/cy",
        "postTime": 1601107335,
        "uid": 83999,
        "name": "Demoe",
        "ccfLevel": 7,
        "title": "[HNOI2016]\u5e8f\u5217 \u9898\u89e3 \u83ab\u961f\u4e8c\u6b21\u79bb\u7ebf"
    },
    {
        "content": "\n. \u505a\u6cd5: \u83ab\u961f.\n\n. \u8be5\u9898\u7528\u83ab\u961f\u6765\u505a, \u53ea\u9700\u77e5\u9053\u5982\u4f55$\\mathcal{O}(1)$\u6c42\u533a\u95f4$[l,r], [l+1,r]$, $[l+2,r]$,...,$[r,r]$\u7684\u6700\u5c0f\u503c\u7684\u548c(\u8bbe\u4e3a$S$).\n\n. \u8003\u8651\u7ef4\u62a4\u4e00\u4e2a$pre$\u6570\u7ec4,\u4ee4$pre_i=\\sum_{j=1}^{i}min_{k=j}^{i}a_k$.\n\n\u8bbe$i$\u7684\u524d\u65b9\u7b2c\u4e00\u4e2a\u6bd4$i$\u5c0f\u7684\u6570\u7684\u4f4d\u7f6e\u4e3a$l_i$(\u6ca1\u6709\u6bd4$i$\u5c0f\u7684\u6570\u5219$l_i=0$), \u5219$pre_i=pre_{l_i}+(i-l_i)\\times a_i$.\n\n. \u8bbe\u533a\u95f4$[l,r]$\u7684\u6700\u5c0f\u503c\u7684\u4f4d\u7f6e\u4e3a$pos$, \u5219$\\forall i\\in [l,pos], min_{j=i}^{pos}a_j=a_{pos}$, \u5373$[l,r]$,...,$[pos,r]$\u7684\u7b54\u6848\u4e3a$a_{pos}\\times(pos-l+1)$, \u800c$[pos+1,r],...,[r,r]$\u7684\u7b54\u6848\u4e3a$pre_r-pre_{pos}$.\n\n. \u6545$S=a_{pos}\\times(pos-l+1)+pre_r-pre_{pos}$.\n\n```cpp\n#include <iostream>\n#include <cstdio>\n#include <algorithm>\nusing namespace std;\n\nint read() {\n    int x = 0, f = 1;\n    char c = getchar();\n    while (c < '0' || c > '9') {\n        if (c == '-') f = -1;\n        c = getchar();\n    }\n    while (c >= '0' && c <= '9') {\n        x = x * 10 + c - '0';\n        c = getchar();\n    }\n    return x * f;\n}\n\nint n, m;\nlong long st[200005][20], a[200005];\nint pos[200005][20];\nint p2[20], lg2[200005];\nvoid mkst() {\n    p2[0] = 1;\n    for (int i = 1; i <= 18; ++i) p2[i] = p2[i - 1] * 2;\n    lg2[0] = -1;\n    for (int i = 1; i <= n; ++i) lg2[i] = lg2[i >> 1] + 1;\n    for (int i = 1; (1 << i) <= n; ++i) {\n        for (int j = 1; j + (1 << i) - 1 <= n; ++j) {\n            if (st[j][i - 1] < st[j + p2[i - 1]][i - 1]) {\n                st[j][i] = st[j][i - 1];\n                pos[j][i] = pos[j][i - 1];\n            } else {\n                st[j][i] = st[j + p2[i - 1]][i - 1];\n                pos[j][i] = pos[j + p2[i - 1]][i - 1];\n            }\n        }\n    }\n    return ;\n}\n\nint stqry(int l, int r) {\n    int t = lg2[r - l + 1];\n    return min(st[l][t], st[r - p2[t] + 1][t]);\n}\n\nint l[200005], r[200005];\nlong long pre[200005], pst[200005];\nvoid gtpp() {\n    for (int i = 1; i <= n; ++i) {\n        l[i] = i;\n        while (l[i] > 1 && a[i] < a[l[i] - 1]) l[i] = l[l[i] - 1];\n        pre[i] = pre[l[i] - 1] + (i - l[i] + 1) * a[i];\n    }\n    for (int i = n; i >= 1; --i) {\n        r[i] = i;\n        while (r[i] < n && a[i] < a[r[i] + 1]) r[i] = r[r[i] + 1];\n        pst[i] = pst[r[i] + 1] + (r[i] - i + 1) * a[i];\n    }\n    return ;\n}\n\nstruct Q {\n    int l, r;\n    int i;\n} q[200005];\n\nbool cmp(Q a, Q b) {\n    if (a.l / 315 == b.l / 315) return a.r < b.r;\n    return a.l < b.l;\n}\n\nlong long ans[200005], res;\nint qpos(int l, int r) {\n    int t = lg2[r - l + 1];\n    if (st[l][t] < st[r - p2[t] + 1][t]) return pos[l][t];\n    return pos[r - p2[t] + 1][t];\n}\n\nint main() {\n    n = read(), m = read();\n    for (int i = 1; i <= n; ++i) {\n        st[i][0] = a[i] = read();\n        pos[i][0] = i;\n    }\n    mkst();\n    gtpp();\n    for (int i = 1; i <= m; ++i) {\n        q[i].l = read();\n        q[i].r = read();\n        q[i].i = i;\n    }\n    sort(q + 1, q + 1 + m, cmp);\n    int L = 1, R = 1;\n    res = a[1];\n    for (int i = 1; i <= m; ++i) {\n        while (R < q[i].r) {\n            R++;\n            int ps = qpos(L, R);\n            res += (long long)(ps - L + 1) * a[ps] + pre[R] - pre[ps];\n        }\n        while (L > q[i].l) {\n            L--;\n            int ps = qpos(L, R);\n            res += (long long)(R - ps + 1) * a[ps] + pst[L] - pst[ps];\n        }\n        while (R > q[i].r) {\n            int ps = qpos(L, R);\n            res -= (long long)(ps - L + 1) * a[ps] + pre[R] - pre[ps];\n            R--;\n        }\n        while (L < q[i].l) {\n            int ps = qpos(L, R);\n            res -= (long long)(R - ps + 1) * a[ps] + pst[L] - pst[ps];\n            L++;\n        }\n        ans[q[i].i] = res;\n    }\n    for (int i = 1; i <= m; ++i) {\n        printf(\"%lld\\n\", ans[i]);\n    }\n    return 0;\n}\n```",
        "postTime": 1548743617,
        "uid": 51237,
        "name": "Kinandra",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3246 \u3010[HNOI2016]\u5e8f\u5217\u3011"
    },
    {
        "content": "~~\u884c\u5427\u884c\u5427\u6211copy\u4e00\u904d\u539f\u6765\u7684\u603b\u53ef\u4ee5\u4e86\u5427==~~\n\n\uff08\u4ee5\u4e0a\u4e0e\u6587\u7ae0\u65e0\u5173\uff0c\u4ee5\u4e0b\u5185\u5bb9\u6765\u81ea\u672c\u4eba\u7684[csdn\u535a\u5ba2](https://blog.csdn.net/Joky_2002/article/details/85000739)\uff09\n\n\n## [\u9898\u76ee\u94fe\u63a5](https://lydsy.com/JudgeOnline/problem.php?id=4540) ##\n\n\u597d\u4e45\u4ee5\u524d\u5199\u7684\u4e1c\u897f\u4e86==\uff0c\u73b0\u5728\u5df2\u7ecf\u8bb0\u4e0d\u8d77\u6765\u5f53\u65f6\u7ebf\u6bb5\u6811\u548b\u5199\u7684\u4e86\n\u4e8e\u662f$YY$\u51fa\u4e00\u4e2a$CDQ$\u7684\u505a\u6cd5\n\u597d\u50cf\u8fd8\u6ca1\u4eba\u53d1\u8fc7$CDQ$\u7684\u9898\u89e3\uff1f~~\u62a2\u4e2afb~~\n\n\u9996\u5148\u5148\u628a\u7ed9\u7684\u5e8f\u5217\u9884\u5904\u7406\u4e00\u628a\n\u8bb0$L[i]$\u4e3a $i$\u5de6\u8fb9\u5c0f\u7b49$a[i]$\u7684\u4f4d\u7f6e$+1$\n\u540c\u7406\u6709$R[i]$\u4e3a $i$\u53f3\u8fb9\u5c0f\u7b49$a[i]$\u7684\u4f4d\u7f6e$-1$\n\n\u7136\u540e\u4e0a\u4e00\u628a\u4e8c\u7ef4\u6570\u70b9~~\u53eb\u6211\u4e8c\u7ef4\u6570\u70b9\u5927\u5e08~~\n\n\u663e\u7136\u53ef\u4ee5\u53d1\u73b0\uff0c\u4e00\u4e2a\u4ee5$(L[i],i)$\u4e3a\u5de6\u4e0b\u89d2\u7684\uff0c\u4ee5$(i,R[i])$\u4e3a\u53f3\u4e0a\u89d2\u7684\u77e9\u5f62\u4f1a\u8d21\u732e$a[i]$\u7684\u7b54\u6848\uff08\u4e5f\u5c31\u662f\u8bf4\uff0c\u8fd9\u4e2a\u77e9\u5f62\u91cc\u5168\u662f$a[i]$\n\n\u7136\u540e\u8be2\u95ee\u5c31\u76f8\u5f53\u4e8e\u67e5\u8be2\u4e00\u4e2a\u4ee5$(l,l)$\u4e3a\u5de6\u4e0b\u89d2\u7684\uff0c\u4ee5$(r,r)$\u4e3a\u53f3\u4e0a\u89d2\u7684\u77e9\u5f62\u548c\n\n\u8003\u8651\u64cd\u4f5c\u548c\u8be2\u95ee\u90fd\u5177\u6709\u524d\u7f00\u6027\uff0c\u4e8e\u662f\u53ef\u4ee5\u628a\u4e00\u4e2a\u77e9\u5f62\u62c6\u6210\u56db\u4e2a\u70b9\n\u5177\u4f53\u6765\u8bf4\uff0c\u628a\u64cd\u4f5c$(xl,xr,yl,yr)$\u62c6\u6210$(xl,yl),(xl,yr + 1),(xr + 1,yl),(xr + 1,yr + 1)$\n\n\u628a\u8be2\u95ee$(xl,xr,yl,yr)$\u62c6\u6210$(xr,yr),(xl - 1,yr),(xr,yl - 1),(xl - 1,yl - 1)$\n\n\u7136\u540e\u586b\u586b\u6b63\u8d1f\u53f7\n\u7b54\u6848\u5373\u4e3a\u8be2\u95ee\u548c\u64cd\u4f5c\u7684\u56db\u4e2a\u70b9\u4e24\u4e24\u8d21\u732e\u7684\u548c\n\n\u5f53\u7136\u76f4\u63a5\u8ba1\u7b97\u4e24\u4e24\u8d21\u732e\u662f$O(n ^ 2)$\u7684\n\n\u8003\u8651$CDQ$\u5206\u6cbb\n\n\u5c31\u662f\u5148\u628a\u8be2\u95ee\u548c\u64cd\u4f5c\u90fd\u6309$x$\u6392\u5e8f\uff0c\u7136\u540e\u8003\u8651\u8ba1\u7b97\u5b8c\u8d21\u732e\u540e\u5f52\u5e76$y$\u4e0a\u6765\n\n\u7136\u540e\u8003\u8651\u4e00\u4ef6\u4e8b\u60c5\uff1a\u5982\u4f55\u8ba1\u7b97\u8d21\u732e\uff1f\n\n\u5982\u679c\u8bf4\u76f4\u63a5\u8ba1\u7b97\u8d21\u732e\u7684\u8bdd\uff0c\u5c31\u662f$val[i] * val[j].val * abs(x[i] - x[j] + 1) * abs(y[i] - y[j] + 1)$\n\uff08\u4e5f\u5c31\u662f\u628a\u4ee5$i$\u548c$j$\u5f62\u6210\u7684\u77e9\u5f62\u5927\u5c0f\u4e58\u4ee5\u6743\u503c\uff0c\u5176\u4e2d$i$\u4e3a\u64cd\u4f5c\uff0c$j$\u4e3a\u8be2\u95ee\uff0c$val$\u662f\u586b\u4e0a\u6b63\u8d1f\u53f7\u7684\u6743\u503c\uff09\n\n\u5f53\u7136\u8fd9\u6837\u76f4\u63a5\u505a\u662f\u4e0d\u884c\u7684\uff0c\u8003\u8651\u600e\u4e48\u5229\u7528$x[i] < x[j]$\u5e76\u4e14$y$\u6709\u5e8f\u7684\u6027\u8d28\n\n\u8003\u8651\u67d0\u4e2a$j$\u70b9\u8ba1\u7b97\u5b8c\u7b54\u6848\u957f\u5565\u6837\u5b50\uff1a\n\n![\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0](https://img-blog.csdnimg.cn/20181214113335950.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0pva3lfMjAwMg==,size_16,color_FFFFFF,t_70)\n\n\u7136\u540e\u6211\u4eec\u73b0\u5728\u8981\u628a\u4ed6\u53d8\u6210\n\n![\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0](https://img-blog.csdnimg.cn/2018121411351670.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0pva3lfMjAwMg==,size_16,color_FFFFFF,t_70)\n\n\u7c7b\u4f3c\u8fd9\u6837\u7684\u5f62\u72b6\n\n\u8bb0\u4e00\u4e2a$len$\u548c$wid$\uff0c\u5206\u522b\u8868\u793a$i_1,i_2,i_3$\u5230$j$\u7684\u957f\u548c\u5bbd\u7684\u5e26\u6743\u548c\n\n\u5177\u4f53\u800c\u8a00\u5c31\u662f\n![\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0](https://img-blog.csdnimg.cn/20181214113948168.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0pva3lfMjAwMg==,size_16,color_FFFFFF,t_70)\n\n\uff08\u5927\u6982\u662f\u8fd9\u4e2a\u610f\u601d\uff0c\u53ea\u4e0d\u8fc7\u8981\u5e26\u6743\n\n\u90a3\u6211\u4eec\u6bcf\u6b21\u5148\u628a\u539f\u6765\u7684\u77e9\u5f62\u5411\u5de6\u5411\u53f3\u6269\u4e00\u4e0b\uff0c\u518d\u5411\u4e0a\u5411\u4e0b\u6269\u4e00\u4e0b\uff0c\u5c31\u53ef\u4ee5\u4e86\n\n\u7528$len$\u548c$wid$\u8868\u73b0\u51fa\u6765\u5c31\u662f\n$now += wid * (x[i] - x[j - 1]); len += sum * (x[j] - x[j - 1]);$\n$now += len * (y[i] - y[j - 1]); wid += sum * (y[i] - y[j - 1]);$\n$sum$\u8868\u793a\u5f53\u524d\u6240\u6709\u70b9\u7684\u6743\u503c\u548c\n\u5f53\u7136\u53ef\u80fd\u4f1a\u51fa\u73b0\u65b0\u7684\u70b9\uff08\u4e5f\u5c31\u662f\u539f\u6765\u4e0d\u5728$j$\u7684\u8303\u56f4\u5185\uff0c\u73b0\u5728\u51fa\u73b0\u5728$j + 1$\u7684\u8303\u56f4\u5185\u4e86\uff09\uff0c\u90a3\u4e48\u8fd9\u4e2a\u76f4\u63a5\u52a0\u8d77\u6765\u5c31\u597d\u4e86\n\n\u6700\u540e\u8981\u5f00$\\_int128$\uff0c\u5f53\u7136\u56e0\u4e3a\u535a\u4e3b\u6bd4\u8f83\u61d2\uff0c$long\\ long$\u4ea4\u4e86\u4e00\u4e2a$80pts$\u7684\u5c31\u6ca1\u518d\u7ba1\u4e86\n\n\u4ee3\u7801\uff08$80pts$\uff09\n```\n#include<cstdio>\n#include<cmath>\n#include<queue>\n#include<stack>\n#include<vector>\n#include<algorithm>\n#include<cstring>\nusing namespace std;\n\ntypedef long long LL;\n\nconst int maxn = 1000010;\n\nstruct node{\n\tint x,y,val,typ,id;\n}q[maxn],tmp[maxn];\n\nint n,m,N,L[maxn],R[maxn],a[maxn];\nint stk[maxn],top;\nLL ans[maxn];\n\ninline LL getint()\n{\n\tLL ret = 0,f = 1;\n\tchar c = getchar();\n\twhile (c < '0' || c > '9')\n\t{\n\t\tif (c == '-') f = -1;\n\t\tc = getchar();\n\t}\n\twhile (c >= '0' && c <= '9')\n\t\tret = ret * 10 + c - '0',c = getchar();\n\treturn ret * f;\n}\n\ninline int cmp(node a,node b)\n{\n\treturn a.x < b.x || (a.x == b.x && a.y < b.y) || (a.x == b.x && a.y == b.y && a.typ < b.typ);\n}\n\ninline void solve(int l,int r)\n{\n\tif (l == r) return;\n\tint mid = l + r >> 1;\n\tsolve(l,mid); solve(mid + 1,r);\n\tint j = l,pre = 0; LL now = 0,len = 0,wid = 0,cnt = 0;\n\tfor (int i = mid + 1; i <= r; i++)\n\t{\n\t\tif (!q[i].typ) continue;\n\t\tnow += wid * (q[i].x - q[pre].x); len += 1ll * cnt * (q[i].x - q[pre].x);\n\t\tnow += len * (q[i].y - q[pre].y); wid += 1ll * cnt * (q[i].y - q[pre].y);\n\t\tpre = i;\n\t\twhile (j <= mid && q[j].y <= q[i].y)\n\t\t{\n\t\t\tif (q[j].typ) {j++; continue;}\n\t\t\tlen += 1ll * q[j].val * (q[i].x - q[j].x + 1); \n\t\t\twid += 1ll * q[j].val * (q[i].y - q[j].y + 1);\n\t\t\tnow += 1ll * q[j].val * (q[i].x - q[j].x + 1) * (q[i].y - q[j].y + 1);\n\t\t\tcnt += q[j].val; j++;\n\t\t}\n\t\tans[q[i].id] += q[i].val * now;\n\t}\n\n\tint u = l,v = mid + 1,cur = l - 1;\n\twhile (u <= mid && v <= r)\n\t{\n\t\tif (q[u].y <= q[v].y) tmp[++cur] = q[u++];\n\t\telse tmp[++cur] = q[v++];\n\t}\n\tfor (int i = u; i <= mid; i++) tmp[++cur] = q[i];\n\tfor (int i = v; i <= r; i++) tmp[++cur] = q[i];\n\tfor (int i = l; i <= r; i++) q[i] = tmp[i];\n}\n\ninline void split(int xl,int xr,int yl,int yr,int typ,int id)\n{\n\tif (typ == 0)\n\t{\n\t\tq[++N] = (node){xl,yl,a[id],0,id};\n\t\tq[++N] = (node){xl,yr + 1,-a[id],0,id};\n\t\tq[++N] = (node){xr + 1,yl,-a[id],0,id};\n\t\tq[++N] = (node){xr + 1,yr + 1,a[id],0,id};\n\t}\n\telse \n\t{\n\t\tq[++N] = (node){xr,yr,1,1,id};\n\t\tq[++N] = (node){xl - 1,yr,-1,1,id};\n\t\tq[++N] = (node){xr,yl - 1,-1,1,id};\n\t\tq[++N] = (node){xl - 1,yl - 1,1,1,id};\n\t}\n}\n\nint main()\n{\n\t#ifdef AMC\n\t\tfreopen(\"AMC1.txt\",\"r\",stdin);\n\t\tfreopen(\"AMC2.txt\",\"w\",stdout);\n\t#endif\n\tn = getint(); m = getint();\n\tfor (int i = 1; i <= n; i++) a[i] = getint();\n\tfor (int i = 1; i <= n; i++)\n\t{\n\t\twhile (top && a[stk[top]] > a[i]) top--;\n\t\tL[i] = stk[top] + 1;\n\t\tstk[++top] = i;\n\t}\n\n\ttop = 0;\n\tfor (int i = n; i >= 1; i--)\n\t{\n\t\twhile (top && a[stk[top]] > a[i]) top--;\n\t\tif (top) R[i] = stk[top] - 1; else R[i] = n;\n\t\tstk[++top] = i;\n\t}\n\n\tfor (int i = 1; i <= n; i++)\n\t\tsplit(L[i],i,i,R[i],0,i);\n\t\n\tfor (int i = 1; i <= m; i++)\n\t{\n\t\tint l = getint(),r = getint();\n\t\tsplit(l,r,l,r,1,i);\n\t}\n\n\tsort(q + 1,q + N + 1,cmp);\n\n\tsolve(1,N);\n\n\tfor (int i = 1; i <= m; i++)\n\t\tprintf(\"%lld\\n\",ans[i]);\n\treturn 0;\n}\n```\n\u975e\u5e38\u597d\u5199\u5e76\u4e14\u77ed233333333",
        "postTime": 1544794334,
        "uid": 20888,
        "name": "Joky_02",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3246 \u3010[HNOI2016]\u5e8f\u5217\u3011"
    },
    {
        "content": "\u6211\u4e0d\u592a\u4f1a\u83ab\u961f\uff0c\u6240\u4ee5\u8003\u8651\u66b4\u529b\u5206\u5757\u3002\n\n\u4ee4 $st_i$ \u8868\u793a\u5757 $i$ \u7684\u5f00\u5934\u4f4d\u7f6e\uff0c$ed_i$ \u8868\u793a\u5176\u7ed3\u5c3e\u4f4d\u7f6e\u3002\n\n\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u8be2\u95ee\u533a\u95f4\uff0c\u628a\u5b83\u5212\u5206\u6210\u5de6\u6563\u5757\u3001\u6574\u5757\u548c\u53f3\u6563\u5757\u4e09\u4e2a\u90e8\u5206\u3002\n\n\u90a3\u4e48\u8003\u8651\u5206\u522b\u8ba1\u7b97\u4ee5\u4e0b\u4e94\u79cd\u60c5\u51b5\uff1a\n\n- \u5de6\u6563\u5757\u5185\u90e8\u7684\u8d21\u732e\n\n- \u53f3\u6563\u5757\u5185\u90e8\u7684\u8d21\u732e\n\n- \u6574\u5757\u5185\u90e8\u7684\u8d21\u732e\n\n- \u5de6\u6563\u5757\u5bf9\u6574\u5757\u7684\u8d21\u732e\n\n- \u53f3\u6563\u5757\u5bf9\u6574\u5757\u548c\u5de6\u6563\u5757\u7684\u8d21\u732e\n\n\u6700\u540e\u663e\u7136\u6c42\u548c\u5c31\u662f\u7b54\u6848\u3002\n\n\u5bf9\u4e8e\u524d\u4e24\u79cd\uff0c\u76f4\u63a5\u66b4\u529b\u8ba1\u7b97\u3002\u5bf9\u4e8e\u7b2c\u4e09\u79cd\uff0c\u9884\u5904\u7406\u51fa $f_{i,j}$ \u8868\u793a\u533a\u95f4 $[st_i,j]$ \u7684\u7b54\u6848\uff0c\u8fd9\u4e2a\u9884\u5904\u7406\u663e\u7136\u53ef\u4ee5 $O(n\\sqrt n)$ \u505a\u3002\n\n\u5bf9\u4e8e\u7b2c\u56db\u79cd\uff0c\u9884\u5904\u7406\u51fa $g_{i,j}$ \u8868\u793a $\\sum\\limits_{k=st_i}^j\\min\\limits_{l=st_i}^ka_l$\u3002\u7136\u540e\u679a\u4e3e\u5de6\u6563\u5757\u4e2d\u7684\u6bcf\u4e2a\u5143\u7d20\uff0c\u5229\u7528 $g$ \u53ef\u4ee5\u8ba1\u7b97\u51fa\u4ee5\u5176\u4e3a\u5f00\u5934\u5bf9\u6574\u5757\u7684\u8d21\u732e\u3002\n\n\u7b2c\u4e94\u79cd\u540c\u7406\u3002\n\n\u65f6\u7a7a\u590d\u6742\u5ea6\u5747\u4e3a $O(n\\sqrt n)$\u3002\n\n\u5e38\u6570\u548c\u4ee3\u7801\u590d\u6742\u5ea6\u90fd\u5927\u5f97\u4e00\u5339\u3002\n\n```cpp\n#include<bits/stdc++.h>\n#define int long long\nusing namespace std;\nconst int maxn = 100005, maxb = 325;\nint n, m, block, t;\nint a[maxn];\nint st[maxb], ed[maxb], pos[maxn];\nint f[maxb][maxn];\nint g[maxb][maxn], h[maxb][maxn];\nint l[maxn], r[maxn];\nint L[maxn], R[maxn];\nint sum[maxn];\nstack<int> s;\nvoid init() {\n    block = sqrt(n); t = ceil(n * 1. / block);\n    for (int i = 1; i <= t; i++) {\n        st[i] = (i - 1) * block + 1; ed[i] = min(i * block, n);\n        for (int j = st[i]; j <= ed[i]; j++) pos[j] = i;\n    }\n    for (int i = 1; i <= t; i++) {\n        while (!s.empty()) s.pop();\n        for (int j = st[i]; j <= n; j++) l[j] = st[i] - 1;\n        for (int j = st[i]; j <= n; j++) {\n            while (!s.empty() && a[s.top()] > a[j]) s.pop();\n            if (!s.empty()) l[j] = s.top(); s.push(j);\n        }\n        for (int j = st[i]; j <= n; j++) f[i][j] = a[j] * (j - l[j]) + f[i][l[j]];\n        for (int j = st[i]; j <= n; j++) f[i][j] += f[i][j - 1];\n    }\n    for (int i = 1; i <= t; i++) {\n        int minn = 1e9;\n        for (int j = st[i]; j <= n; j++)\n            g[i][j] = g[i][j - 1] + (minn = min(minn, a[j]));\n    }\n    for (int i = t; i >= 1; i--) {\n        int minn = 1e9;\n        for (int j = ed[i]; j >= 1; j--)\n            h[i][j] = h[i][j + 1] + (minn = min(minn, a[j]));\n    }\n    for (int i = 1; i <= n; i++) L[i] = 0;\n    while (!s.empty()) s.pop();\n    for (int i = 1; i <= n; i++) {\n        while (!s.empty() && a[s.top()] >= a[i]) s.pop();\n        if (!s.empty()) L[i] = s.top();\n        s.push(i);\n    }\n    while (!s.empty()) s.pop();\n    for (int i = 1; i <= n; i++) R[i] = n + 1;\n    for (int i = n; i >= 1; i--) {\n        while (!s.empty() && a[s.top()] > a[i]) s.pop();\n        if (!s.empty()) R[i] = s.top();\n        s.push(i);\n    }\n}\nint get(int x, int y) {\n    for (int i = x; i <= y; i++) l[i] = x - 1;\n    while (!s.empty()) s.pop();\n    for (int i = x; i <= y; i++) {\n        while (!s.empty() && a[s.top()] >= a[i]) s.pop();\n        if (!s.empty()) l[i] = s.top();\n        s.push(i);\n    }\n    for (int i = x; i <= y; i++) r[i] = y + 1;\n    while (!s.empty()) s.pop();\n    for (int i = y; i >= x; i--) {\n        while (!s.empty() && a[s.top()] > a[i]) s.pop();\n        if (!s.empty()) r[i] = s.top();\n        s.push(i);\n    }\n    int ans = 0;\n    for (int i = x; i <= y; i++) ans += (r[i] - i) * (i - l[i]) * a[i];\n    return ans;\n}\nint query(int x, int y) {\n    int p = pos[x], q = pos[y];\n    if (p == q) return get(x, y);\n    int ans = get(x, ed[p]) + get(st[q], y) + f[p + 1][ed[q - 1]];\n    int minn = 0;\n    for (int i = ed[p]; i >= x; i--) {\n        if (minn == 0 || a[minn] > a[i]) minn = i;\n        if (R[minn] > ed[q - 1]) ans += a[minn] * (ed[q - 1] - ed[p]);\n        else ans += a[minn] * (R[minn] - st[p + 1]) + g[p + 1][ed[q - 1]] - g[p + 1][R[minn] - 1];\n    }\n    minn = 0;\n    for (int i = st[q]; i <= y; i++) {\n        if (minn == 0 || a[minn] > a[i]) minn = i;\n        if (L[minn] < x) ans += a[minn] * (ed[q - 1] - x + 1);\n        else ans += a[minn] * (ed[q - 1] - L[minn]) + h[q - 1][x] - h[q - 1][L[minn] + 1];\n    }\n    return ans;\n}\nsigned main() {\n    cin >> n >> m;\n    for (int i = 1; i <= n; i++) cin >> a[i];\n    init();\n    for (int i = 1; i <= m; i++) {\n        int x, y; cin >> x >> y;\n        cout << query(x, y) << endl;\n    }\n    return 0;\n}\n```\n",
        "postTime": 1668998061,
        "uid": 305027,
        "name": "Tarantula",
        "ccfLevel": 6,
        "title": "P3246 [HNOI2016]\u5e8f\u5217 \u9898\u89e3"
    },
    {
        "content": "\u6bd4\u8f83\u8003\u6280\u5de7\u4e0e\u6027\u8d28\u7684\u4e00\u9053\u83ab\u961f\u9898\u3002\n\n\u4e0d\u5f00 O2 \u6839\u672c\u600e\u4e48\u5361\u5e38\u90fd\u8fc7\u4e0d\u4e86\uff0c\u6709\u53ef\u80fd\u662f ST \u8868\u4e5f\u6709\u5e38\u6570\u5427\u3002         \n\n\u6211\u4eec\u8003\u8651\u7528\u83ab\u961f\u8f6c\u79fb\u533a\u95f4 $[l , r]$ \u81f3\u533a\u95f4 $[l , r + 1]$ \uff0c\u589e\u52a0\u7684\u91cf\u5373\u56fa\u5b9a\u4e0b\u6765\u7684\u53f3\u7aef\u70b9\u5230 $l$ \u6240\u4ea7\u751f\u7684\u6240\u6709\u5b50\u5e8f\u5217\u8d21\u732e\u7684\u7b54\u6848\u3002            \n\n\u6211\u4eec\u8003\u8651\u7ef4\u62a4\u4e00\u4e2a\u524d\u7f00 $Sum_i$ \u8868\u793a $[1 , i] , [2 , i] \u2026\u2026[i , i]$ \u7684\u7b54\u6848\uff0c\u8003\u8651\u5982\u4f55 $O(n)$ \u9012\u63a8\u3002           \n\n\u6211\u4eec\u627e\u5230\u524d\u9762\u7b2c\u4e00\u4e2a\u6bd4 $a_i$ \u5c0f\u7684\u6570\uff0c\u5176\u4f4d\u7f6e\u8bb0\u4e3a $pos$ \uff0c\u90a3\u4e48 $[pos + 1 , i]$ \u4e2d\u6ca1\u6709\u4e00\u4e2a\u6570\u6bd4 $a_i$ \u5c0f\uff0c\u800c $[pos - 1 , i] , [pos - 2 , i] \u2026\u2026 [1 , i]$ \u4e2d\u7684\u6700\u5c0f\u503c\u4e5f\u4e00\u5b9a\u4ea7\u751f\u5728 $pos$ \u4e4b\u524d\uff0c\u4ee4 $val(l , r)$ \u4e3a\u4e00\u4e2a\u533a\u95f4\u7684\u7b54\u6848\uff0c\u90a3\u4e48   \n\n$val([pos , pos]) = val([pos , i]) , val([pos - 1 , pos]) = val([pos - 1 , i]) \u2026\u2026 val([1 , pos]) = val([1 , i])$         \n\n\u5373\u8fd9\u4e00\u90e8\u5206\u7684\u8d21\u732e\u7b49\u4ef7\u4e8e $Sum_p$ \uff0c\u6240\u4ee5\u9012\u63a8\u5f0f\u5c31\u51fa\u6765\u4e86\uff1a         \n\n$Sum_i = Sum_p + (i - pos) \\times a_i$               \n\n\u63a5\u7740\u6211\u4eec\u5012\u7740\u628a\u540e\u7f00\u4e5f\u505a\u4e00\u904d\u7c7b\u4f3c\u7684\u64cd\u4f5c\uff0c\u8bb0\u4e3a $Suf_i$ \u3002\u8fd9\u662f\u4e3a\u4e86\u5904\u7406\u5de6\u7aef\u70b9\u79fb\u52a8\u65f6\u7684\u8d21\u732e\u8ba1\u7b97\uff0c\u5176\u5b9e\u5c31\u662f\u628a\u53f3\u7aef\u70b9\u7684\u64cd\u4f5c\u5bf9\u79f0\u4e00\u4e0b\u5c31\u597d\u4e86\u3002                   \n\n\u4e4b\u540e\u6211\u4eec\u5728\u83ab\u961f\u8f6c\u79fb\u65f6\u518d\u6362\u4e00\u79cd\u65b9\u6cd5\u8ba1\u7b97\u8d21\u732e\uff0c\u8fd8\u662f\u4ee5 $[l , r] -> [l , r + 1]$ \u4e3e\u4f8b\u3002               \n\n\u6211\u4eec\u5148\u627e\u5230\u533a\u95f4 $[l , r]$ \u5185\u6700\u5c0f\u503c\u5bf9\u5e94\u7684\u70b9\uff0c\u8bb0\u4e3a $P$ \uff0c\u90a3\u4e48 $[l \\sim P , r]$ \u7684\u533a\u95f4\u8d21\u732e\u5c31\u53ef\u4ee5 $O(1)$ \u7b97\u4e86\u3002            \n\n\u63a5\u7740\u6211\u4eec\u8003\u8651 $[P + 1 \\sim  r , r]$ \u7684\u8d21\u732e\u5982\u4f55\u8ba1\u7b97\uff0c\u8003\u8651\u4f7f\u7528\u6211\u4eec\u9884\u5904\u7406\u51fa\u6765\u7684\u524d\u7f00 $Sum$ \u3002       \n\n\u6211\u4eec\u77e5\u9053 $a[P] < min_{i = P + 1} ^ r a[i]$ \uff0c\u6240\u4ee5\u5982\u679c\u5bf9\u4e8e\u4e00\u4e2a\u5de6\u7aef\u70b9\u4e0d\u56fa\u5b9a\u7684\u533a\u95f4 $[ll , r]$ \u800c\u8a00\uff0c\u5982\u679c $ll <= P$ \uff0c\u90a3\u4e48\u8fd9\u4e2a\u533a\u95f4\u7684\u6700\u5c0f\u503c\u5c31\u53c8\u4e0d\u5728 $[P + 1 , r]$ \u4e4b\u95f4\u4e86\u3002         \n\n\u6362\u53e5\u8bdd\u8bf4\u8fd9\u4e9b\u533a\u95f4\u7684\u7b54\u6848\u53c8\u53ef\u4ee5\u548c $[ll , P]$ \u7b49\u4ef7\u4e86\uff0c\u800c\u6211\u4eec\u8981\u505a\u7684\u4e0d\u5c31\u662f\u53ea\u8981 $[P + 1 \\sim r , r]$ \u8fd9\u4e9b\u533a\u95f4\u7684\u8d21\u732e\u5417\uff1f\u90a3\u4e48\u76f4\u63a5\u7528 $Sum_r - Sum_P$ \u5c31\u597d\u4e86\u3002            \n\n\u5bf9\u4e8e\u5de6\u7aef\u70b9\u79fb\u52a8\u7684\u60c5\u51b5\u5c31\u5168\u90e8\u53cd\u8fc7\u6765\u5c31\u597d\u4e86\u3002       \n\n\u5173\u4e8e\u627e\u6700\u5c0f\u70b9\u548c\u6700\u8fd1\u7684\u4e00\u4e2a\u6bd4\u5b83\u5c0f\u7684\u70b9\uff0c\u524d\u4e00\u4e2a\u6211\u4eec\u76f4\u63a5\u7528 ST \u8868\u9884\u5904\u7406\uff0c\u540e\u4e00\u4e2a\u4e8c\u5206\u6216\u5355\u8c03\u6808\u90fd\u53ef\u4ee5\u505a\u3002    \n\n\u6700\u540e\u65f6\u95f4\u590d\u6742\u5ea6 $O(n \\log n + n \\sqrt n)$ \u4e0d\u77e5\u9053\u4e3a\u4ec0\u4e48\u628a\u83ab\u961f\u5361\u4e86\uff0c\u5f97\u5f00 O2 \u624d\u80fd\u8fc7\u3002          \n\n\u5efa\u8bae ST \u8868\u5361\u4e00\u4e0b Cache \u3002",
        "postTime": 1624851924,
        "uid": 132533,
        "name": "Hakuoro",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3246 [HNOI2016]\u5e8f\u5217"
    },
    {
        "content": "\u63d0\u4ea4\u8bb0\u5f55\u91cc\u4e00\u5806\u7ebf\u6bb5\u6811\uff0c\u8868\u793a\u8ff7\u60d1\u3002\n\n\u5176\u5b9e\u83ab\u961f\u5427\u2026\u4e5f\u4e0d\u600e\u4e48\u4f1a\u3002\n\n\u83ab\u961f\u53ef\u4ee5\u628a\u8fd9\u4e2a\u95ee\u9898\u53d8\u6210\u5bf9\u4e8e\u533a\u95f4[l,r]\uff0c\u4ee5r\u4e3a\u53f3\u7aef\u70b9\uff0c\u6c42\u7b54\u6848\u3002\u800c\u4e14\u7531\u4e8e\u83ab\u961f\u7684\u590d\u6742\u5ea6\uff0c\u5fc5\u9700\u505a\u5230$O(1)$\n\n\u672c\u6765\u60f3\u5b58\u4e00\u4e2a\u6bcf\u4e2a\u70b9\u5de6\u53f3\u6bd4\u5b83\u5c0f\u7684\u7b2c\u4e00\u4e2a\u6570\uff0c\u7ed3\u679c\u53d1\u73b0\uff0c\u8c8c\u4f3c\u6210\u4e86\u4e00\u4e2a\u9012\u5f52\u7684\u5b50\u95ee\u9898\uff0c\u504f\u79bb\u4e86\u521d\u8877\n\n\u7136\u540e\u6559\u7ec3\u8bb2\u8fc7\u4e00\u79cd\u5de7\u5999\u7684\u505a\u6cd5\uff1a\u6709\u533a\u95f4$[1,r]$\u7684\u7b54\u6848\uff0c\u5411\u5de6\u6269\u5c55\u4e00\u4f4d\u3002\n\n\u5148\u627e\u51fa$[1,r+1]$\u4e2d\u6700\u5c0f\u7684\u6570$k$\uff0c$k$\u5de6\u8fb9\u4f5c\u4e3a\u5de6\u7aef\u70b9\u6240\u4ee5\u5bf9\u7b54\u6848\u6709\u8d21\u732e\u7684\u662f$k$\u3002\n\n\u8ba1\u7b97$[k+1,r]$\uff0c\u53ef\u4ee5\u4e00\uff08\u6162\uff09\u773c\uff08\u6162\uff09\u77aa\uff08\u8ba1\uff09\u51fa\uff08\u7b97\uff09\uff0c$[k+1,r]$\u4e2d\u6bd4$k$\u90fd\u5927\u3002\u9884\u5904\u7406\u4ee5$i$\u4e3a\u53f3\u7aef\u70b9\u7684\u533a\u95f4\u7684\u7b54\u6848\u548c$s[i]$\u3002\n\n\u7531\u4e8e$k$\u53ca$k$\u5de6\u4fa7\u7684\u8d21\u732e\u90fd\u4f1a\u662f$k$\u5de6\u8fb9\u7684\u6570\uff0c\u6240\u4ee5\u5728$s[k+1]$\u548c$s[r]$\u662f\u53ef\u4ee5\u76f8\u51cf\u7684,\u505a\u4e00\u505a\u51cf\u6cd5\u5c31\u597d\u4e86\u3002\n\n$RMQ$\u662f$O(1)$\u7684\u3002\n\nPS\uff1a\u9664100\u4f1aWA\uff0c\u4e0d\u77e5\u9053\u4e3a\u4ec0\u4e48\u2026\n\n[\u8bc4\u6d4b\u8bb0\u5f55](https://www.luogu.com.cn/record/33695123)",
        "postTime": 1589773011,
        "uid": 327534,
        "name": "Siyunshan",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3246 \u3010[HNOI2016]\u5e8f\u5217\u3011"
    },
    {
        "content": "## \u4e71\u641e\u505a\u6cd5\n\n\u8fd9\u662f\u83dc\u9e21\u5728\u8003\u573a\u4e0a\u60f3\u5230\u7684\u4e71\u641e\u505a\u6cd5\u3002\n\n\u9996\u5148\u770b\u5355\u7ec4\u8be2\u95ee\u600e\u4e48\u505a\uff1a\u663e\u7136\u662f\u5355\u8c03\u6808\uff0c\u51fa\u6808\u7684\u65f6\u5019\u7b97\u4e00\u4e0b\u8d21\u732e\u5373\u53ef\u3002\u8fd9\u6837\u53ef\u5f97\u5230 $60$ \u5206\uff08\u76f4\u63a5\u505a $40$\uff0c\u9884\u5904\u7406\u6bcf\u4e2a\u533a\u95f4\u7684\u7b54\u6848 $20$\uff09\u3002\n\n\u591a\u7ec4\u8be2\u95ee\u5462\uff1f\u8003\u8651\u5c06\u8be2\u95ee\u6309\u7167\u53f3\u7aef\u70b9\u4ece\u5de6\u5230\u53f3\u5904\u7406\u3002\u6bcf\u4e2a\u6570 $a_i$ \u5bf9\u8be2\u95ee $[l,r]$ \u7684\u8d21\u732e\u4e3a\uff1a\uff08$fl,fr$ \u4e3a\u4e00\u4e2a\u70b9\u4f5c\u4e3a\u6700\u5c0f\u503c\u7684\u533a\u95f4\u5de6\u53f3\u7aef\u70b9\uff0c\u5747\u53ef\u7528\u5355\u8c03\u6808\u7ef4\u62a4\u51fa\uff09\n\n$$a_i(fr_i-i+1)(i-fl_i+1)$$\n\n\u8003\u8651\u5982\u4f55\u5904\u7406\u8fd9\u4e2a\u8d21\u732e\u3002\u5047\u8bbe\u73b0\u5728\u626b\u63cf\u7684\u53f3\u7aef\u70b9\u4e3a $R$\uff0c\u5219\u6240\u6709 $i\\le r$ \u7684 $fl$ \u90fd\u5df2\u7ecf\u786e\u5b9a\u3002\u5c06\u6240\u6709\u4f4d\u7f6e\u5206\u4e3a\u4e24\u90e8\u5206\uff0c\u4e00\u90e8\u5206\u662f $fr\\le R$ \u5373\u5df2\u7ecf\u4ece\u5355\u8c03\u6808\u5185\u5f39\u51fa\u7684\u70b9\uff0c\u4e00\u90e8\u5206\u662f\u8fd8\u5728\u6808\u5185\u7684\u70b9\u3002\u7b2c\u4e00\u90e8\u5206\u597d\u7ef4\u62a4\uff08\u56e0\u4e3a $fr$ \u5df2\u7ecf\u6210\u4e3a\u5b9a\u503c\uff09\uff0c\u5982\u4f55\u7ef4\u62a4\u7b2c\u4e8c\u90e8\u5206\u5462\uff1f\u6ce8\u610f\u5230 $R$ \u8fd9\u4e9b\u70b9\u6bcf\u5f80\u53f3\u79fb\u52a8\u4e00\u6b65\uff0c\u8fd9\u4e9b\u70b9\u7684 $fr$ \u5c31\u5f80\u53f3\u79fb\u52a8\u4e00\u6b65\uff0c\u56e0\u6b64\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811\u5904\u7406\uff1a\u7ef4\u62a4\u8fd9\u4e9b\u70b9\u7684 $a_i(i-fl_i+1)$ \u4e4b\u548c\uff0c\u6bcf\u6b21\u8ba9\u603b\u8d21\u732e\u52a0\u4e0a\u8fd9\u4e2a\u548c\u5373\u53ef\u3002\n\n\u7136\u540e\u4e00\u4e2a\u8be2\u95ee\u4e00\u4e2a\u8be2\u95ee\u770b\uff1a\u8bbe\u8be2\u95ee\u4e3a $[L,R]$\uff08\u5176\u4e2d $R$ \u4e3a\u5b9a\u503c\uff09\uff0c\u5219\u8fd9\u4e2a\u8be2\u95ee\u7684\u7b54\u6848\u4e3a \n\n$$\\sum\\limits_{i=L}^{R} a_i(fr_i-i+1)(i-\\min(L,fl_i)+1)$$\n\n\u5047\u5982\u6ca1\u6709 $\\min$ \u6211\u4eec\u5b8c\u5168\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\uff0c\u4f46\u662f $\\min$ \u4f7f\u6211\u4eec\u4e71\u4e86\u9635\u811a\u3002\u8fd9\u4fbf\u5f15\u51fa\u4e86\u672c\u79cd\u4e71\u641e\u7684\u7cbe\u9ad3\uff1a\u6211\u4eec\u5c06 $[L,R]$ \u5212\u5206\u4e3a\u8bb8\u591a\u5c0f\u533a\u95f4\uff0c\u4f7f\u5f97\u6bcf\u4e2a\u533a\u95f4\u5185\u8981\u4e48 $fl_i$ \u90fd\u5c0f\u4e8e\u7b49\u4e8e $L$\uff0c\u8981\u4e48\u90fd\u5927\u4e8e\u7b49\u4e8e $L$\uff0c\u5bb9\u6613\u53d1\u73b0\u8fd9\u4e24\u79cd\u60c5\u51b5\u90fd\u53ef\u4ee5\u76f4\u63a5\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u533a\u95f4\u548c\u3002\u5047\u5982\u4e0d\u5c5e\u4e8e\u8fd9\u4e24\u79cd\u60c5\u51b5\uff0c\u5c31\u5728\u7ebf\u6bb5\u6811\u4e0a\u5f80\u4e0b\u9012\u5f52\uff0c\u603b\u80fd\u5212\u5206\u6210\u4e24\u79cd\u60c5\u51b5\u4e4b\u4e00\uff1a\u8fd9\u6837\u5c31\u80fd\u7ef4\u62a4\u51fa\u7b54\u6848\u3002\n\n\u590d\u6742\u5ea6\uff1f\u6700\u574f\u663e\u7136\u662f $\\Theta(n^2)$\uff0c\u4f46\u662f\u5f88\u96be\u5361\uff08\u9700\u8981 $fl$ \u7684\u503c\u4e0a\u4e0b\u52a8\u8361\u5927\uff0c\u800c\u4e00\u4e2a\u6b63\u5e38\u51fa\u9898\u4eba\u662f\u7edd\u5bf9\u60f3\u4e0d\u5230\u7684\uff09\uff0c\u56e0\u6b64\u5b9e\u9645\u6548\u7387\u4e0e $O(n\\log^2 n)$ \u7684\u7b97\u6cd5\u76f8\u8fd1\uff0c\u5728\u666e\u901a\u6570\u636e\u4e0a\u6700\u5927\u70b9\u8017\u65f6\u7ea6\u4e3a $700\\text{ms}$\u3002\n\n\u5230\u5e95\u8981\u7ef4\u62a4\u54ea\u4e9b\u6807\u8bb0\uff1f\u6211\u4eec\u6570\u6570\uff08\u4ee5\u4e0b\u7701\u7565 $\\sum$\uff09\uff1a\n\n1. $\\min,\\max fl$\uff08\u4e3a\u4e86\u5212\u5206\u533a\u95f4\uff09\uff1b\n2. $a_i(fr_i-i+1)(i-fl_i+1)$\uff08$\\min fl\\ge L$ \u65f6\u7b54\u6848\uff09\uff1b\n3. $a_i(fr_i-i+1)$ \u548c $(i-fl_i+1)a_i$\uff08\u53ef\u7b97\u51fa $\\max fl\\le L$ \u65f6\u7b54\u6848\uff09\uff1b\n4. $(i-fl_i+1)a_i$\uff0c$(i+1)a_i$\uff0c$a_i$\uff08\u4e3a\u4e86\u5feb\u901f\u7b97\u51fa $R$ \u53f3\u79fb\u65f6\u7b54\u6848\u7684\u53d8\u5316\u91cf\uff09\u3002\n\n\u4e00\u5171\u516b\u4e2a\u6807\u8bb0\uff0c\u6bd4\u6807\u7b97\uff08\u83ab\u961f\uff09\u4e0d\u77e5\u9053\u96be\u5199\u5230\u54ea\u91cc\u53bb\u4e86\u3002\n\n\u4ee3\u7801\u5982\u4e0b\uff1a\n\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<algorithm>\n#include<cstring>\n#include<cmath>\n#include<set>\n#include<vector>\nusing namespace std;\ntypedef long long ll;\nint n,m,a[100005],st[100005],top,fl[100005],fr[100005],minn[400005],maxx[400005],tag[400005];\n//sum:sum{a[i](fr[i]-i+1)(i-fl[i]+1)}\n//sumr:sum{(i+1)a[i](fr[i]-i+1)}\n//sumr2:sum{a[i](fr[i]-i+1)}\n//summ:sum{(i-fl[i]+1)a[i]}\n//summ2:sum{(i+1)a[i]}\n//summ3:sum{a[i]}\nll fans[100005],sum[400005],sumr[400005],sumr2[400005];\nll summ[400005],summ2[400005],summ3[400005];\nvector<int> vec[100005];\nstruct Query {\n\tint l,r;\n} q[100005];\nvoid Addtag(int p,int q) {\n\tsum[p]+=q*summ[p];\n\tsumr[p]+=q*summ2[p];\n\tsumr2[p]+=q*summ3[p];\n\ttag[p]+=q;\n}\nvoid Pushdown(int p) {\n\tif(tag[p]) {\n\t\tAddtag(p*2,tag[p]);\n\t\tAddtag(p*2+1,tag[p]);\n\t\ttag[p]=0;\n\t}\n}\nvoid Pushup(int p) {\n\tsum[p]=sum[p*2]+sum[p*2+1];\n\tsumr[p]=sumr[p*2]+sumr[p*2+1];\n\tsumr2[p]=sumr2[p*2]+sumr2[p*2+1];\n\tsumm[p]=summ[p*2]+summ[p*2+1];\n\tsumm3[p]=summ3[p*2]+summ3[p*2+1];\n\tsumm2[p]=summ2[p*2]+summ2[p*2+1];\n\tminn[p]=min(minn[p*2],minn[p*2+1]);\n\tmaxx[p]=max(maxx[p*2],maxx[p*2+1]);\n}\nvoid Modifyr(int p,int l,int r,int x,int y) {\n\tif(l==r) {\n\t\tsumr[p]=1ll*(l+1)*a[l]*(y-x+1);\n\t\tsumr2[p]=1ll*a[l]*(y-x+1);\n\t\tsum[p]=1ll*a[l]*(y-x+1)*(l-fl[l]+1);\n\t\tsumm[p]=summ2[p]=summ3[p]=0;\n\t\treturn ;\n\t}\n\tPushdown(p);\n\tint mid=(l+r)/2;\n\tif(x<=mid)Modifyr(p*2,l,mid,x,y);\n\telse Modifyr(p*2+1,mid+1,r,x,y);\n\tPushup(p);\n}\nvoid Modifyl(int p,int l,int r,int x,int y) {\n\tif(l==r) {\n\t\tfl[l]=y;\n\t\tsumr[p]=1ll*(l+1)*a[l];\n\t\tsumr2[p]=a[l];\n\t\tsum[p]=1ll*a[l]*(l-fl[l]+1);\n\t\tsumm3[p]=a[l];\n\t\tsumm2[p]=1ll*(l+1)*a[l];\n\t\tsumm[p]=1ll*(l-y+1)*a[l];\n\t\tminn[p]=maxx[p]=y;\n\t\treturn ;\n\t}\n\tPushdown(p);\n\tint mid=(l+r)/2;\n\tif(x<=mid)Modifyl(p*2,l,mid,x,y);\n\telse Modifyl(p*2+1,mid+1,r,x,y);\n\tPushup(p);\n}\nll Query(int p,int l,int r,int x,int y) {\n\tif(x<=l&&r<=y) {\n\t\tif(minn[p]>=x)return sum[p];\n\t\tif(maxx[p]<=x)return sumr[p]-1ll*x*sumr2[p];\n\t\tPushdown(p);\n\t\tint mid=(l+r)/2;\n\t\tll ret=Query(p*2,l,mid,x,y)+Query(p*2+1,mid+1,r,x,y);\n\t\tPushup(p);\n\t\treturn ret;\n\t}\n\tPushdown(p);\n\tint mid=(l+r)/2;\n\tll ret=0;\n\tif(x<=mid)ret+=Query(p*2,l,mid,x,y);\n\tif(mid<y)ret+=Query(p*2+1,mid+1,r,x,y);\n\tPushup(p);\n\treturn ret;\n}\nint main() {\n\t//freopen(\"sequence.in\",\"r\",stdin);\n\t//freopen(\"sequence.out\",\"w\",stdout);\n\tscanf(\"%d%d\",&n,&m);\n\tfor(int i=1; i<=n; i++)scanf(\"%d\",&a[i]);\n\tfor(int j=1; j<=m; j++)scanf(\"%d%d\",&q[j].l,&q[j].r),vec[q[j].r].push_back(j);\n\tmemset(minn,0x3f,sizeof(minn));\n\tfor(int i=1; i<=n; i++) {\n\t\twhile(top&&a[st[top]]>a[i]) {\n\t\t\tfr[st[top]]=i-1;\n\t\t\tModifyr(1,1,n,st[top],i-1);//fr\u53d8\u6210\u4e86i-1\n\t\t\ttop--;\n\t\t}\n\t\tAddtag(1,1);//\u6ca1\u6709fr\u7684\u5411\u53f3\u63a8\u8fdb\u4e00\u683c\n\t\tModifyl(1,1,n,i,top?st[top]+1:1);//i\u7684fl\u52a0\u8fdb\u53bb\n\t\tst[++top]=i;\n\t\tfor(int j=0; j<vec[i].size(); j++) {\n\t\t\tint id=vec[i][j];\n\t\t\tfans[id]=Query(1,1,n,q[id].l,q[id].r);//\u590d\u6742\u5ea6\u4e0d\u6e05\u695a\u6b63\u4e0d\u6b63\u786e\u2026\u2026\n\t\t}\n\t}\n\tfor(int i=1; i<=m; i++)printf(\"%lld\\n\",fans[i]);\n}\n```",
        "postTime": 1588405826,
        "uid": 42156,
        "name": "feecle6418",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3246 \u3010[HNOI2016]\u5e8f\u5217\u3011"
    },
    {
        "content": "\u4ecb\u7ecd\u4e00\u79cdO(n\u221an)\u7684\u7b97\u6cd5\uff1a\u83ab\u961f\n\n\n\u83ab\u961f\u7684\u96be\u70b9\u5c31\u5728\u4e8e\u72b6\u6001\u8f6c\u79fb\uff0c\u600e\u4e48\u901a\u8fc7[l,r]\u7684\u7b54\u6848\u63a8\u51fa[l,r+1]\u7684\u7b54\u6848\u3002\n\n\n\u8003\u8651\u627e\u5230[l,r+1]\u91cc\u7684\u6700\u5c0f\u503c\u7684\u4f4d\u7f6e\uff08ST\u8868\u5b9e\u73b0\uff09\uff0c\u8bb0\u4e3apos\u3002\n\n\n[l,r+1]\u76f8\u5bf9\u4e8e[l,r]\u5176\u5b9e\u5c31\u591a\u4e86r-l+2\u4e2a\u5305\u62ecr+1\u7684\u5b50\u5e8f\u5217\uff0c\n\n\n\u90a3\u4e48[l,pos]\u7684\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u5c31\u7b49\u4e8e(pos-l+1)\\*a[pos]\n\n\n\u90a3\u4e48\u600e\u4e48\u6c42[pos+1,r]\u7684\u8d21\u732e\u5462\n\n\n\u8fd9\u91cc\u5f15\u5165\u4e00\u4e2a\u7c7b\u4f3c\u524d\u7f00\u548c\u7684\u4e1c\u897f\uff0c\n\n\n\u6211\u4eec\u7528last[i]\u8868\u793aa[i]\u5de6\u8fb9\u7b2c\u4e00\u4e2a\u6bd4a[i]\u5c0f\u7684\u6570\u7684\u4f4d\u7f6e\uff0cnext[i]\u8868\u793a\u53f3\u8fb9\uff0c\n\n\n\u8fd9\u4e2a\u8fc7\u7a0b\u663e\u7136\u53ef\u4ee5\u7528\u5355\u8c03\u6808O(n)\u5b9e\u73b0\n\n\n\u7136\u540e\u5f002\u4e2a\u6570\u7ec4suml,sumr\u3002\n\n\nsuml[i]\u8868\u793a[1,i]\u7684\u8d21\u732e\uff0c\u90a3\u4e48suml[i]\u53ef\u901a\u8fc7suml[i]=suml[last[i]]+(i-last[i])\\*a[i]\u5f97\u5230\u3002\n\n\nsumr\u540c\u7406\u3002\n\n\n\u7136\u540e\u5c31\u662f\u83ab\u961f\u7684\u6a21\u677f\u4e86\u3002\n\n\n```cpp\n#include <iostream>\n#include <cstdio>\n#include <cstring>\n#include <cmath>\n#include <algorithm>\n#include <queue>\n#include <set>\n#include <map>\n#include <vector>\n#include <stack>\n#include <list>\n#define rep(i,m,n) for(int i=m;i<=n;++i)\n#define dop(i,m,n) for(int i=m;i>=n;--i)\n#define lowbit(x) (x&(-x))\n#define ll long long\n#define INF 2147483647\nusing namespace std;\ninline int read(){\n    int s=0,w=1;\n    char ch=getchar();\n    while(ch<'0'||ch>'9'){if(ch=='-')w=-1;ch=getchar();}\n    while(ch>='0'&&ch<='9') s=s*10+ch-'0',ch=getchar();\n    return s*w;\n}\ninline void write(int x){\n    if(x<0) x=-x,putchar('-');\n    if(x>9) write(x/10);\n    putchar(x%10+'0');\n}\nconst int maxn=1000010;\nconst int maxm=1000010;\nint g,last[maxn],n,m,a[maxn],i,Log[maxn],f[maxn][22],Next[maxn],l=1,r=1;\nll ans,Ans[maxm],suml[maxn],sumr[maxn];\ninline int get(int x){ //\u5206\u5757\n    return (x-1)/g+1;\n}\nstruct STACK{    //\u624b\u5199\u6808\n    int s[maxn],tall;\n    STACK(){memset(s,0,sizeof(s));tall=0;}\n    inline void push(int x){s[++tall]=x;}\n    inline void pop(){--tall;}\n    inline int top(){return s[tall];}\n}s;\nstruct ASK{   //\u79bb\u7ebf\u7b97\u6cd5\uff0c\u8bb0\u5f55\u8be2\u95ee\n    int l,r,lk,id;\n    bool operator < (const ASK &A) const{\n         return lk==A.lk?r<A.r:lk<A.lk;\n    }\n}A[maxm];\ninline int Query(int l,int r){   //ST\u8868\uff08\u8bb0\u5f55\u4f4d\u7f6e\u7248\uff09\u67e5\u8be2\n    int k=Log[r-l+1],pos=r-(1<<k)+1;\n    return a[f[l][k]]>a[f[pos][k]]?f[pos][k]:f[l][k];\n}\ninline void updata(int mode){  //\u83ab\u961f\u66f4\u65b0\u72b6\u6001\n    if(mode==1) {int pos=Query(l,r);ans+=(pos-l+1)*a[pos]+suml[r]-suml[pos];}  //l,r+1\n    if(mode==2) {int pos=Query(l,r);ans-=(pos-l+1)*a[pos]+suml[r]-suml[pos];}  //l,r-1\n    if(mode==3) {int pos=Query(l,r);ans-=(r-pos+1)*a[pos]+sumr[l]-sumr[pos];}  //l+1,r\n    if(mode==4) {int pos=Query(l,r);ans+=(r-pos+1)*a[pos]+sumr[l]-sumr[pos];}  //l-1,r\n}\nint main(){\n     g=sqrt(n=read());m=read();Log[0]=-1;\n     rep(i,1,n) a[i]=read(),Log[i]=Log[i/2]+1,f[i][0]=i;\n     rep(i,1,16)\n        rep(j,1,n){\n           int pos=j+(1<<(i-1));\n           f[j][i]=a[f[j][i-1]]>a[f[pos][i-1]]?f[pos][i-1]:f[j][i-1];\n        }\n     rep(i,1,n){  //\u5355\u8c03\u6808\u6c42last\u548cNext\n        while(s.tall&&a[i]<a[s.top()]) Next[s.top()]=i,s.pop();\n        last[i]=s.top();\n        s.push(i);\n     }\n     while(s.tall) Next[s.top()]=n+1,s.pop();\n     rep(i,1,m){\n        A[i].l=read();A[i].r=read();\n        A[i].lk=get(A[i].l);A[i].id=i;\n     }\n     rep(i,1,n) suml[i]=suml[last[i]]+(ll)(i-last[i])*a[i];    //\u524d\u7f00\u548c\n     dop(i,n,1) sumr[i]=sumr[Next[i]]+(ll)(Next[i]-i)*a[i];\n     sort(A+1,A+m+1);ans=a[1];\n     rep(i,1,m){\n        while(r<A[i].r) ++r,updata(1);\n        while(l>A[i].l) --l,updata(4);\n        while(r>A[i].r) updata(2),--r;\n        while(l<A[i].l) updata(3),++l;\n        Ans[A[i].id]=ans;\n     }\n     rep(i,1,m) printf(\"%lld\\n\",Ans[i]);\n     return 0;\n}\n```",
        "postTime": 1509797072,
        "uid": 61834,
        "name": "Huami360",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 P3246 \u3010[HNOI2016]\u5e8f\u5217\u3011"
    },
    {
        "content": "\u849f\u84bb\u53c8\u6765\u6c34\u9898\u89e3\u8fa3\n\n\n\u597d\u50cf\u8fd9\u662f\u4e00\u9053\u83ab\u961f\u7684\u9898\uff0c\uff0c\uff0c\u7136\u800c\u6211\u4e3a\u4ec0\u4e48\u8981\u7528\u7ebf\u6bb5\u6811\u5462\uff1f\uff1f\uff1f\uff1f\uff1f\n\n\uff08\u5047\u88c5\u662f\u56e0\u4e3a\u6211\u60f3\u7ec3\u7ebf\u6bb5\u6811\u563f\u563f\uff09\n\n\n\u9898\u9762\u7684\u610f\u601d\u5c31\u662f\u5bf9\u4e8e\u6bcf\u4e2a\u8be2\u95ee\u6c42\u4e00\u4e0b\u5b50\u533a\u95f4\u7684\u6700\u5c0f\u503c\u7684\u548c\uff0c\uff0c\u770b\u5230\u8fd9\u9898\u7684\u7b2c\u4e00\u611f\u89c9\u5c31\u662f\u548cbzoj\u6709\u9053rmq-sum\u7684\u9898\u597d\u50cf\u554a\uff0c\u90fd\u53ef\u4ee5\u79bb\u7ebf\u7528\u626b\u63cf\u6cd5\u505aww\u3002\n\n\n\u5927\u81f4\u7684\u505a\u6cd5\u5c31\u662f\u6211\u4eec\u5148\u7528\u5355\u8c03\u6808\u8bb0\u5f55\u4e00\u4e0b\u6bcf\u4e2a\u6570i\u4e4b\u524d\u7b2c\u4e00\u6bd4\u5b83\u5c0f\u7684\u6570\u7684\u4f4d\u7f6elef[i]\u3002\n\n\n\u7136\u540e\u518d\u8bb0\u5f55\u6bcf\u4e00\u7ec4\u8be2\u95ee\uff0c\u6309\u7167r\u5347\u5e8f\u6392\u5e8f\u3002\n\n\n\u6211\u4eec\u518d\u7528\u4e00\u4e2a\u53d8\u91cfnow\u53bb\u7ef4\u62a4\u76ee\u524d\u7684\u6700\u53f3\u7aef\uff0c\n\n\u521d\u59cb now=1\u3002\n\n\n\u7ebf\u6bb5\u6811\u7684\u6bcf\u4e2a\u8282\u70b9\u8bb0\u5f55\u4ee5\u8fd9\u4e2a\u70b9\u4e3a\u5de6\u7aef\u70b9\uff0c\u53f3\u7aef\u70b9\u6700\u8fdc\u5230now\u7684\u5e8f\u5217\u7684\u6700\u5c0f\u503c\u4e4b\u548c\u3002\n\n\n\u5f53now\u5c0f\u4e8e\u7b49\u4e8e\u76ee\u524d\u8be2\u95ee\u7684\u53f3\u7aef\u70b9\u65f6\uff0c\u6211\u4eec\u5c31\u628a\u4ee5now\u4e3a\u53f3\u7aef\u70b9\u7684\u6240\u6709\u533a\u95f4\u5728\u7ebf\u6bb5\u6811\u91cc\u66f4\u65b0\u4e00\u4e0b\u3002\n\n\u6211\u4eec\u77e5\u9053lef[now]+1~now\u7684\u6240\u6709\u6570\u4e2dnow\u4e00\u5b9a\u662f\u6700\u5c0f\u7684\uff0c\u6240\u4ee5now\u52a0\u8fdb\u6765\u5bf9\u4e8e\u7ebf\u6bb5\u6811\u4e0alef[now]+1~now\u7684\u8d21\u732e\u90fd\u662fa[now](now\u4f4d\u7f6e\u4e0a\u7684\u6570)\u3002\n\n\u7136\u540e\u6211\u4eec\u4e00\u76f4\u8fd9\u6837\u8fed\u4ee3\u4e0b\u53bb\uff08\u52a0\u5b8c\u8d21\u732e\u4e4b\u540enow=lef[now]\uff09\uff0c\u76f4\u5230now=0\uff0c\u5c31\u628anow\u52a0\u8fdb\u6765\u7684\u8d21\u732e\u7b97\u5b8c\u4e86\u3002\n\n\u7136\u540enow++,\u76f4\u5230now>\u76ee\u524d\u8be2\u95ee\u7684\u53f3\u7aef\u70b9\n\n\n\u8ba1\u7b97\u7b54\u6848\u7684\u8bdd\u76f4\u63a5\u8be2\u95ee\u7ebf\u6bb5\u6811\u4e0a\u7684\u533a\u95f4\u548c\uff08ask[i].l~ask[i].r\uff09\u5c31\u53ef\u4ee5\u4e86\uff08\u6240\u4ee5\u8bf4\u6211\u4e3a\u4ec0\u4e48\u8111\u62bd\u5199\u4e86\u4e2a\u524d\u7f00\u548c\u76f8\u51cf\u3002\u3002\u3002\u3002\u5c31\u5f53\u5a31\u4e50\u4e86\u53cd\u6b63\u80fdA  hh\uff09\n\n\ncode\uff1a\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n   \n\n\n\n\n\n\n\n   \n\n\n\n   \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n```cpp\n#include<bits/stdc++.h>\n#define ll long long\nusing namespace std;\nstruct node{\nll pos,v;\n}s[100005];\nstruct ask{\nll l,r,num;\n}a[100005];\nbool cmp(ask x,ask y){\n  return x.r<y.r;\n}\nll n,m,top=0,b[100005],lef[100005];\nll sum[400005],add[400005],ans[100005];\nll le,ri,v;\nvoid update(ll o,ll l,ll r){\n   if(l>=le&&r<=ri){\n       add[o]+=v,sum[o]+=v*(r-l+1);\n       return;\n   }\n   ll mid=l+r>>1,lc=o<<1,rc=(o<<1)|1;\n   if(le<=mid) update(lc,l,mid);\n   if(ri>mid) update(rc,mid+1,r);\n   sum[o]=sum[lc]+sum[rc]+add[o]*(r-l+1);\n}\ninline void work(ll x){\n  while(x){\n     ri=x,le=lef[x]+1,v=b[x];\n     update(1,1,n);\n     x=lef[x];\n  }\n}\nll query(ll o,ll l,ll r,ll addv){\n   if(l>=le&&r<=ri) return(addv*(r-l+1)+sum[o]);\n   ll mid=l+r>>1,lc=o<<1,rc=(o<<1)|1,ansd=0;\n   if(le<=mid) ansd+=query(lc,l,mid,addv+add[o]);\n   if(ri>mid) ansd+=query(rc,mid+1,r,addv+add[o]);\n   return ansd;\n}\nint main(){\n   scanf(\"%lld%lld\",&n,&m);\n   s[++top]=(node){0,-(1<<30)};\n   for(ll i=1;i<=n;i++){\n      scanf(\"%lld\",b+i);\n      while(s[top].v>=b[i]) top--;\n      lef[i]=s[top].pos;\n      s[++top]=(node){i,b[i]};\n   }\n   for(ll i=1;i<=m;i++) scanf(\"%lld%lld\",&a[i].l,&a[i].r),a[i].num=i;\n   sort(a+1,a+m+1,cmp);\n   ll now=1;\n   for(ll i=1;i<=m;i++){\n      while(now<=a[i].r) work(now),now++;\n      le=1,ri=a[i].r;\n      ans[a[i].num]=query(1,1,n,0);\n      if(a[i].l>1){\n         ri=a[i].l-1;\n         ans[a[i].num]-=query(1,1,n,0);\n      }\n   }\n   for(ll i=1;i<=m;i++) printf(\"%lld\\n\",ans[i]);\n//   for(ll i=1;i<=n;i++) cout<<lef[i]<<' ';\n   return 0;\n}\n```",
        "postTime": 1502369390,
        "uid": 31377,
        "name": "\u91d1\u7237\u7237\u54c8\u54c8",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3246 \u3010[HNOI2016]\u5e8f\u5217\u3011"
    }
]