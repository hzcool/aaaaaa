[
    {
        "content": "[\u6211\u7684CEOI\u4f5c\u6218\u8bb0\u5f55&\u9898\u89e3-\u6d1b\u8c37\u535a\u5ba2](https://www.luogu.com.cn/blog/s-r-f/ceoi2020-zuo-zhan-ji-lu-ti-xie-shi-gong-zhong-post)\n\n[\u6211\u7684CEOI\u4f5c\u6218\u8bb0\u5f55&\u9898\u89e3-cnblogs](https://www.cnblogs.com/s-r-f/p/13581895.html)\n\n---\n\n\u8003\u8651\u4e00\u4e2a $O(nq)$ \u7684\u66b4\u529b/\u7ed3\u8bba:\n\n\u9996\u5148,\u5982\u679c\u53f6\u5b50\u8282\u70b9\u6570\u76ee\u4e3a\u5947\u6570,\u5219\u5fc5\u7136\u65e0\u89e3,\u8fd4\u56de $-1$. \n\n\u968f\u4fbf\u9009\u53d6\u4e00\u4e2a\u5ea6\u6570 $>1$ \u7684\u70b9 $rt$ \u4e3a\u6839\u8fdb\u884cdfs,\u7136\u540e\u8003\u8651\u6bcf\u4e2a\u5b50\u6811 $x(x\\neq rt).$ \n\n\u8bb0 $siz_x$ \u4e3a $x$ \u5b50\u6811\u5185\u7684\u53f6\u5b50\u8282\u70b9\u4e2a\u6570,\u8fd9\u4e2a\u53ef\u4ee5\u5728dfs\u7684\u8fc7\u7a0b\u4e2d\u7edf\u8ba1\u51fa.\n\n\u5982\u679c $siz_x$ \u4e3a\u5947\u6570,\u90a3\u4e48 $x$ \u5230\u7236\u4eb2\u7684\u8fb9\u81f3\u5c11\u8981\u88ab\u6e05\u626b $1$ \u6b21.\n\n\u5982\u679c $siz_x$ \u4e3a\u5076\u6570,\u90a3\u4e48 $x$ \u5230\u7236\u4eb2\u7684\u8fb9\u81f3\u5c11\u8981\u88ab\u6e05\u626b $2$ \u6b21.\n\n---\n\n\u8bc1\u660e:\n\n\u53ef\u4ee5\u53d1\u73b0\u8fd9\u4e2a\u95ee\u9898\u662f\u4e00\u4e2a\u628a\u6240\u6709\u53f6\u5b50\u8282\u70b9\u4e24\u4e24\u5339\u914d\u5e76\u4fdd\u8bc1\u6240\u6709\u6811\u4e0a\u7684\u8fb9\u90fd\u88ab\u8986\u76d6\u5230\u7684\u95ee\u9898.\n\n\u90a3\u4e48,\u6bcf\u4e2a\u5b50\u6811 $x$ (\u9664\u4e86\u6839\u4e4b\u5916)\u5fc5\u987b\u8981\u6709\u81f3\u5c11\u4e00\u4e2a\u53f6\u5b50 $z$ ,\u5b83\u548c\u5b50\u6570\u5916\u7684\u53e6\u4e00\u4e2a\u53f6\u5b50\u8fdb\u884c\u5339\u914d.\n\n\u90a3\u4e48\u5982\u679c\u5b50\u6811\u5185\u7684\u53f6\u5b50\u6570\u76ee\u662f\u5947\u6570,\u90a3\u4e48\u6211\u5c31\u4e24\u4e24\u5339\u914d\u7136\u540e\u7559\u4e0b $1$ \u4e2a,\u5426\u5219\u6211\u5c31\u4e24\u4e24\u5339\u914d\u7136\u540e\u7559\u4e0b $2$ \u4e2a.\n\n\u56e0\u4e3a\u6240\u6709\u975e\u53f6\u5b50\u8282\u70b9\u5ea6\u6570 $>1$ ,\u5e76\u4e14\u6bcf\u4e2a\u5b50\u6811\u5f80\u5916\u5339\u914d\u7684\u53f6\u5b50\u6570\u76ee\u53ea\u6709 $1$ \u6216 $2$ \u4e2a,\u6240\u4ee5\u4e00\u5b9a\u53ef\u4ee5\u6210\u529f\u5339\u914d.\n\n---\n\n\u73b0\u5728\u6211\u4eec\u8003\u8651\u4f18\u5316.\n\n\u7b54\u6848\u4e3a \u603b\u70b9\u6570 $-$ $2$ $+$ $\\sum\\limits_{x\u2208T}[siz_x$ \u662f\u5076\u6570 $]$\n\n\u8fd9\u4e2a\u4e1c\u897f\u53ef\u4ee5\u76f4\u63a5\u6811\u5256\u7ef4\u62a4, $O((\\sum\\limits_{i=1}^q D_i)\\log^2 n).$ \n\n\u4e5f\u53ef\u4ee5\u7528\u865a\u6811\u505a\u5230 $O((n+ \\sum\\limits_{i=1}^q D_i)\\log n).$ \n\n\u6811\u5256\u505a\u6cd5\u4ee3\u7801:\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\nconst int N = 100050;\nint n,rt,deg[N],size[N],fa[N],dpt[N],son[N],dval[N],suml; bool isl[N];\nvector<int>G[N];\ninline void dfs1(int x){\n\tsize[x] = 1,dval[x] = 0; isl[x] = 1;\n\tfor (int y,i = 0; i < G[x].size(); ++i) if ((y=G[x][i])^fa[x]){\n\t\tfa[y] = x,dfs1(y),size[x] += size[y],isl[x] = 0,dval[x] ^= dval[y];\n\t\tif (size[y] > size[son[x]]) son[x] = y; \n\t}\n\tif (isl[x]) dval[x] = 1,++suml;\n}\nint top[N],id[N],pos[N],Time;\ninline void dfs2(int x){\n\tid[x] = ++Time; pos[Time] = x;\n\tif (son[x]){\n\t\ttop[son[x]] = top[x],dfs2(son[x]);\n\t\tfor (int y,i = 0; i < G[x].size(); ++i) if (!top[y=G[x][i]]) top[y] = y,dfs2(y);\n\t}\n}\nint f0[N<<2],f1[N<<2]; bool rev[N<<2];\ninline void up(int o){ f0[o] = f0[o<<1] + f0[o<<1|1],f1[o] = f1[o<<1] + f1[o<<1|1]; }\ninline void Build(int o,int l,int r){\n\trev[o] = f0[o] = f1[o] = 0;\n\tif (l == r){ if (dval[pos[l]]) f1[o] = 1; else f0[o] = 1; return; }\n\tint mid = l+r>>1; Build(o<<1,l,mid); Build(o<<1|1,mid+1,r); up(o); \n}\ninline void Tag(int o){ rev[o] ^= 1,swap(f0[o],f1[o]); }\ninline void down(int o){ if (rev[o]) Tag(o<<1),Tag(o<<1|1),rev[o] = 0; }\nint ll,rr;\ninline void Rev(int o,int l,int r){\n\tif (ll <= l && rr >= r){ Tag(o); return; }\n\tdown(o); int mid = l+r>>1; if (ll <= mid) Rev(o<<1,l,mid); if (rr > mid) Rev(o<<1|1,mid+1,r); up(o);\n}\ninline void change(int l,int r){ if (l <= r) ll = l,rr = r,Rev(1,1,n); }\ninline void work(int x){\n\twhile (top[x] ^ rt) change(id[top[x]],id[x]),x = fa[top[x]]; change(id[rt],id[x]);\n}\nint opv[N],_,p[N],len;\nint main(){\n\tint i,x,y,q; suml = 0;\n\tcin >> n >> q;\n\tfor (i = 1; i < n; ++i)\tcin >> x >> y,G[x].push_back(y),G[y].push_back(x),++deg[x],++deg[y];\n\tfor (i = 1; i <= n; ++i) if (deg[i] > 1) rt = i;\n\tdfs1(rt),top[rt] = rt,dfs2(rt); Build(1,1,n);\n\twhile (q--){\n\t\tcin >> len;\n\t\tfor (i = 1; i <= len; ++i) cin >> p[i];\n\t\tsort(p+1,p+len+1);\n\t\tint cl = suml + len;\n\t\tfor (_ = 0,i = 1; i <= len; ++i){\n\t\t\tif (opv[_] == p[i]) --_; else opv[++_] = p[i];\n\t\t\tif (p[i] != p[i-1] && isl[p[i]]){\n\t\t\t\tif (opv[_] == p[i]) --_; else opv[++_] = p[i]; --cl;\n\t\t\t}\n\t\t}\n\t\tfor (i = 1; i <= _; ++i) work(opv[i]);\n\t\tcout << ((cl&1) ? -1 : len + n - 2 + f0[1]) << '\\n';\n\t\tfor (i = 1; i <= _; ++i) work(opv[i]);\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1598774888,
        "uid": 52518,
        "name": "s_r_f",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P6805 \u3010[CEOI2020]\u6625\u5b63\u5927\u626b\u9664\u3011"
    },
    {
        "content": "\u4f3c\u4e4e\u6ca1\u4eba\u7528 LCT\uff1f\u6ca1\u5361\u5e38\u7684\u4ee3\u7801\u5c31 rk1 \u4e86\u3002\n\n\u968f\u4fbf\u4ee5\u4e00\u4e2a\u975e\u53f6\u8282\u70b9\u4e3a\u6839\u4ece\u4e0b\u5f80\u4e0a\u8003\u8651\uff0c\u8bbe\u6bcf\u4e2a\u8282\u70b9\u5b50\u6811\u5185\u7684\u53f6\u5b50\u4e2a\u6570\u4e3a $tt_x$\u3002\n\n\u6bcf\u6761\u8fb9(\u8bbe\u8fb9\u4e2d\u7684\u513f\u5b50\u4e3a $x$)\u5411\u4e0a\u4f20\u4e00\u4e2a\u53f6\u5b50\uff0c\u5982\u679c $tt_x$ \u4e3a\u5076\u6570\u4f1a\u6709\u4e00\u4e2a\u6ca1\u914d\u5bf9\uff0c\u5f97\u591a\u5f80\u4e0a\u4f20\u4e00\u4e2a\uff0c\u8d21\u732e\u5c31\u4e3a $1+[tt_x\\%2=0]$\u3002\n\n\u603b\u8d21\u732e\u4e3a $(\\sum_x 1+[tt_x\\%2=0])-1-[tt_{rt}\\%2=0]$ \uff0c\u56e0\u4e3a\u6839\u6ca1\u6709\u5230\u7236\u4eb2\u7684\u8fb9\u8d21\u732e\u6240\u4ee5\u8981\u51cf\u6389\u3002\n\n\u8bbe $\\sum_x1$\uff0c\u4e5f\u5c31\u662f\u6811\u4e0a\u7684\u70b9\u6570\u4e3a $n$\uff0c\u628a\u5f0f\u5b50\u5316\u7b80\u4e00\u4e0b\uff1a\n\n\u539f\u5f0f $=(n+\\sum_x[tt_x\\%2=0])-1-[tt_{rt}\\%2=0]$\n\n\u6ce8\u610f\u5230\u603b\u53f6\u5b50\u4e2a\u6570\u4e3a\u5076\u6570\u624d\u80fd\u4e24\u4e24\u914d\u5bf9\uff0c\u6545\u6709\u89e3\u65f6\u4e00\u5b9a\u6709 $[tt_{rt}\\%2=0]=1$\u3002\n\n\u6545\u539f\u5f0f $=n-2+\\sum_x[tt_x\\%2=0]$\n\n\u518d\u770b\u8be2\u95ee\uff0c\u5c31\u662f\u5230\u6839 $tt$ \u52a0\u4e00\uff0c\u5168\u5c40\u67e5\u8be2\u3002\n\n\u6811\u5256+\u7ebf\u6bb5\u6811 = \u4e24\u4e2a\u6570\u636e\u7ed3\u6784 + \u4e24\u53ea log\uff0cLCT = \u4e00\u4e2a\u6570\u636e\u7ed3\u6784 + \u4e00\u53ea log\uff0c\u7801\u91cf\u548c\u590d\u6742\u5ea6\u4e0a\u770b\u90fd\u662f LCT \u8840\u8d5a\u3002\n\n\u5177\u4f53\u5b9e\u73b0\u4e0a\u66f4\u7b80\u5355\uff0c\u9009\u5b9a\u6839\u540e\u6839\u4e0d\u53d8\uff0cMake_root \u90fd\u4e0d\u7528\u5199\uff0c\u6bcf\u6b21 Access \u5c31\u884c\u4e86\u3002\n\n\u6ce8\u610f\u4e00\u4e0b\u52a0\u70b9\u540e $n$ \u4e5f\u8981\u52a0\u5c31\u884c\u4e86\u3002\n\n[\u8dd1\u5f97\u5feb\u4f46\u4e0d\u4f1a\u6709\u4eba\u770b\u7684\u4ee3\u7801](https://www.luogu.com.cn/paste/s4lcl28j)",
        "postTime": 1620783485,
        "uid": 158948,
        "name": "\u7ea6\u745f\u592b\u7528\u8111\u73a9",
        "ccfLevel": 0,
        "title": "P6805 [CEOI2020]\u6625\u5b63\u5927\u626b\u9664"
    },
    {
        "content": "# \u9898\u610f\n\u53f6\u5b50\u8282\u70b9\u4e24\u4e24\u5339\u914d\uff0c\u8981\u6c42\u8986\u76d6\u6240\u6709\u8fb9\uff0c\u6c42\u6700\u5c0f\u8986\u76d6\u8fb9\u957f\u3002[$QAQ$](https://www.luogu.com.cn/blog/xzc/solution-p6805)\n# \u5206\u6790\n\u5148\u5355\u72ec\u5bf9\u6bcf\u4e2a\u8282\u70b9\u8003\u8651\u3002\n\n- \u53f6\u5b50\u8282\u70b9\u3002\u56e0\u4e3a\u81ea\u5df1\u4e0d\u80fd\u548c\u81ea\u5df1\u5339\u914d\uff0c\u76f4\u63a5\u5411\u7236\u4eb2\u4e0a\u4f20\u3002\n\n- \u975e\u53f6\u8282\u70b9\u3002\u5982\u679c\u5b50\u6811\u4e2d\u53f6\u5b50\u4e2a\u6570\u4e3a\u5947\u6570\uff0c\u90a3\u4e48\u8fd9\u4e2a\u53ef\u4ee5\u5b8c\u7f8e\u5339\u914d\u7684\uff0c\u5269\u4e0b\u4e00\u6761\u4f20\u7ed9\u7236\u4eb2\uff0c\u5982\u679c\u4e3a\u5076\u6570\uff0c\u5c31\u53ea\u80fd\u627e\u4e24\u6761\u90fd\u4f20\u7ed9\u7236\u4eb2\uff0c\u6b64\u65f6\u5411\u7236\u4eb2\u7684\u8fb9\u5c31\u591a\u8d70\u4e86\u4e00\u6b21\u3002\n\n- \u6839\u8282\u70b9\u3002\u56e0\u4e3a\u6ca1\u6709\u7236\u4eb2\uff0c\u5fc5\u987b\u603b\u53f6\u5b50\u6570\u4e3a\u5076\u6570\u624d\u6709\u89e3\u3002\n\n\u90a3\u4e48\u5c31\u8003\u8651\u4e00\u4e2a\u53f6\u5b50\u8282\u70b9\u7684\u8d21\u732e\uff0c\u53d1\u73b0\u53f6\u5b50\u8282\u70b9\u53ea\u4f1a\u5f71\u54cd\u8fd9\u4e2a\u8282\u70b9\u5230\u6839\u8282\u70b9\u7684\u8def\u5f84\u4e0a\u7684\u6240\u6709\u8282\u70b9\u3002\u90a3\u4e48\u603b\u8986\u76d6\u8fb9\u957f\u4e3a $n-2 + \\sum[si_i\\%2=0]$ \u3002\u6700\u540e\u7b54\u6848\u53ea\u548c $si_i$ \u7684\u5947\u5076\u6709\u5173\uff0c\u76f4\u63a5\u6811\u94fe\u5256\u5206\u7ef4\u62a4\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n\\log^2n)$ \u3002\n# \u4ee3\u7801\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nconst int N = 4e5+100;\nstruct Edge{int to,nxt;}e[N<<1];\nint top[N],fa[N],si[N],Id,id[N],son[N],head[N],du[N],dep[N];\nint t[N][2],tag[N],ecnt = 0,n;\nvoid add(int x,int y){e[++ecnt].to = y;e[ecnt].nxt = head[x];head[x] = ecnt;}\nint read() {\n\tint x = 0,f = 0;char ch = getchar();\n\twhile(!isdigit(ch)) {if(ch=='-')f=1;ch=getchar();}\n\twhile(isdigit(ch)) {x=x*10+ch-'0';ch=getchar();}\n\treturn f?-x:x;\n}\nvoid dfs1(int x,int f,int Dep){\n\tdep[x] = Dep;fa[x] = f;si[x] = 1;\n\tfor(int i = head[x];i;i = e[i].nxt){\n\t\tint y = e[i].to;\n\t\tif(y == f) continue;\n\t\tdfs1(y,x,Dep+1);\n\t\tsi[x] += si[y];\n\t\tif(si[y] > si[son[x]]) son[x] = y; \n\t} \n}\nvoid dfs2(int x,int f,int Top){\n\ttop[x] = Top;id[x] = ++Id;\n\tif(son[x]) dfs2(son[x],x,Top);\n\tfor(int i = head[x];i;i = e[i].nxt){\n\t\tint y = e[i].to;\n\t\tif(y == f || y == son[x])  continue;\n\t\tdfs2(y,x,y);\n\t}\n}\nvoid pushdown(int u){\n\tif(tag[u]){\n\t\tswap(t[u<<1][1],t[u<<1][0]);\n\t\tswap(t[u<<1|1][1],t[u<<1|1][0]);\n\t\ttag[u<<1] ^= tag[u];\n\t\ttag[u<<1|1] ^= tag[u];\n\t\ttag[u] = 0;\n\t}\n}\nvoid update(int u,int l,int r,int L,int R) {\n\tif(l > R || r < L) return;\n\tif(L <= l && r <= R){\n\t\tswap(t[u][0],t[u][1]);\n\t\ttag[u] ^= 1;return;\n\t}\n\tpushdown(u);\n\tint mid = l + r >> 1;\n\tupdate(u<<1,l,mid,L,R);update(u<<1|1,mid+1,r,L,R);\n\tt[u][1] = t[u<<1][1] + t[u<<1|1][1];\n\tt[u][0] = t[u<<1][0] + t[u<<1|1][0];\n}\nint ask(int u,int l,int r,int pos){\n\tif(l==r) {return t[u][1]?1:0;}\n\tint mid=l+r>>1;pushdown(u);if(pos <= mid) return ask(u<<1,l,mid,pos);else return ask(u<<1|1,mid+1,r,pos);\n}\nvoid update2(int a,int b){\n\twhile(top[a] != top[b]) {\n\t\tif(dep[top[a]] < dep[top[b]]) swap(a,b);\n\t\tupdate(1,1,n,id[top[a]],id[a]);\n\t\ta = fa[top[a]];\n\t}\n\tif(dep[a] > dep[b]) swap(a,b);\n\tupdate(1,1,n,id[a],id[b]);\n}\nvoid build(int u,int l,int r){\n\tif(l == r) {t[u][0] = 1;return;}\n\tint mid = l + r >> 1;\n\tbuild(u<<1,l,mid);build(u<<1|1,mid+1,r);\n\tt[u][0] = t[u<<1][0] + t[u<<1|1][0];\n}\nvector<int> leaf;\nint main()\n{\n\tint rt = 0,vis = 0;\n\tn = read();int Q = read();\n\tfor(int i = 1;i < n;i++) {\n\t\tint a = read(),b = read();\n\t\tadd(a,b);add(b,a);du[a]++;du[b]++;\n\t}\n\tfor(int i = 1;i <= n;i++) {if(du[i] > 1) rt = i;}\n\tdfs1(rt,0,1);dfs2(rt,0,rt);build(1,1,n);\n\tfor(int i = 1;i <= n;i++) {\n\t\tif(du[i] == 1) update2(rt,i),vis++;\n\t}\n\twhile(Q--) {\n\t\tint sum = read();\n\t\tleaf.clear();\n\t\tfor(int i = 1;i <= sum;i++) {\n\t\t\tint a = read();\n\t\t\tif(du[a] != 1) update2(a,rt),vis++; \n\t\t\tdu[a]++;leaf.push_back(a);\n\t\t}\n\t\t(vis&1)?printf(\"-1\\n\"):printf(\"%d\\n\",n+sum-2+t[1][0]);\n\t\tfor(int i = 0;i < leaf.size();i++) {\n\t\t\tint a = leaf[i];\n\t\t\tdu[a]--;\n\t\t\tif(du[a] != 1) update2(a,rt),vis--;\n\t\t}\n\t}\n} \n```\n",
        "postTime": 1599467774,
        "uid": 227824,
        "name": "JK_LOVER",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P6805 \u3010[CEOI2020]\u6625\u5b63\u5927\u626b\u9664\u3011"
    },
    {
        "content": "[\u9898\u76ee\u94fe\u63a5](https://www.luogu.com.cn/problem/P6805)\n\n## \u9898\u76ee\u5927\u610f\n\n- $n$ \u4e2a\u7ed3\u70b9\u7684\u6811\uff0c\u8981\u6c42\u6240\u6709\u53f6\u5b50\u4e24\u4e24\u5339\u914d\uff0c\u53f6\u5b50\u95f4\u7684\u8def\u5f84\u8986\u76d6\u4e86\u6811\u4e0a\u6240\u6709\u8fb9\u3002\n\n- \u6bcf\u6b21\u72ec\u7acb\u6dfb\u52a0 $D$ \u4e2a\u53f6\u5b50\uff0c\u6c42\u8def\u5f84\u957f\u5ea6\u548c\u7684\u6700\u5c0f\u503c\uff0c\u5e76\u5224\u65ad\u65e0\u89e3\u3002\n\n- $n,q,\\sum D\\leq 10^5$\u3002\n\n# Solution\n\n\u9996\u5148\u5947\u6570\u4e2a\u53f6\u5b50\u663e\u7136\u65e0\u89e3\uff0c\u7136\u540e\u53d1\u73b0\u5076\u6570\u4e2a\u53f6\u5b50\u5fc5\u6709\u89e3\uff0c\u6bd4\u5982\u968f\u4fbf\u627e\u4e2a\u975e\u53f6\u7ed3\u70b9\u5f53\u6839\uff08$n \\geq 3$\uff09\uff0c\u8ba9\u6240\u6709\u8def\u5f84\u90fd\u7ecf\u8fc7\u6839\u5373\u53ef\u3002\n\n\u5148\u8003\u8651\u9759\u6001\u95ee\u9898\uff0c\u5c1d\u8bd5\u7528 dp \u89e3\u51b3\u3002\u8bbe $f_i$ \u4ee5 $i$ \u4e3a\u6839\u7684\u5b50\u6811\u5185\u7684\u7b54\u6848\uff0c$g_i$ \u4e3a\u6709\u591a\u5c11\u53f6\u5b50\u7684\u8def\u5f84\u7ecf\u8fc7 $i$ \u4f46\u5e76\u4e3a\u5339\u914d\u3002\u90a3\u4e48\u5bf9\u4e8e\u4e00\u4e2a $i$\uff0c\u4ed6\u80af\u5b9a\u8981\u8ba9\u6240\u6709\u513f\u5b50 $x$ \u7684 $g$ \u4e00\u90e8\u5206\u5339\u914d\uff0c\u4e00\u90e8\u5206\u5411\u4e0a\u7ee7\u627f\u3002\u4e3a\u4e86\u8ba9\u4ee3\u4ef7\u6700\u5c0f\u4e14\u80fd\u591f\u8986\u76d6\u6240\u6709\u8fb9\uff0c$g_i$ \u4e0d\u80fd\u4e3a $0$ \u4e14\u8981\u6700\u5c0f\u5316\uff0c\u800c\u4e00\u6b21\u5339\u914d\u53ea\u80fd\u53d6\u51fa\u4e24\u4e2a\u672a\u5339\u914d\u7684\u53f6\u5b50\uff0c\u6240\u4ee5 $g_i$ \u7684\u5947\u5076\u6027\u5f97\u8ddf $\\sum_{x} g_x$ \u4fdd\u6301\u4e00\u76f4\uff0c\u6700\u540e\u7684\u53d6\u503c\u5c31\u53ea\u80fd\u6709 $\\{1,2\\}$\uff0c\u5177\u4f53\u6765\u8bf4\uff1a\n\n\u8bbe $S=\\sum_{x} g_x$\uff0c\u5219\n\n$$ f_i=S+\\sum_{x} f_x $$\n\n$$ g_i=2- (S\\bmod 2) $$\n\n\u5f53 $S$ \u4e3a\u5076\u65f6 $g_i=2$\uff0c\u5f53 $S$ \u4e3a\u5947\u65f6\uff0c$g_i=1$\u3002\u5bf9\u4e8e\u53f6\u5b50\uff0c$f_i=0,g_i=1$\u3002\n\n\u8fd9\u6837\u5bf9\u4e8e\u6bcf\u4e2a\u8be2\u95ee\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528\u52a8\u6001 dp \u4e86\u3002\u518d\u6b64\u4e4b\u524d\u6211\u4eec\u601d\u8003\u4e00\u4e0b\u8fd9\u4e2a\u8f6c\u79fb\u600e\u4e48\u77e9\u9635\u9012\u63a8\u3002\n\n\u6211\u4eec\u5148\u53bb\u6389\u91cd\u513f\u5b50\u7684\u8d21\u732e\uff0c\u5c31\u53d8\u6210\u4e00\u4e2a\u94fe\u4e0a\u7684\u95ee\u9898\u3002\u5047\u5982\u6211\u4eec\u628a\u72b6\u6001\u77e9\u9635\u8bbe\u4e3a\n\n$$ \\begin{bmatrix} f_i & g_i  \\end{bmatrix} $$\n\n\u8f6c\u79fb\u65f6\u589e\u52a0\u91cd\u513f\u5b50\u7684\u8d21\u732e\uff0c\u53d1\u73b0\u8f6c\u79fb\u77e9\u9635\u7684\u5de6\u4e0a\u89d2\u5fc5\u4e3a $1$\uff0c\u56e0\u4e3a $f_i$ \u9700\u8981\u4fdd\u7559\u518d\u4e0e $f_x,g_x$ \u76f8\u52a0\uff0c\u4f46\u662f\u53d1\u73b0 $g_i$ \u7684\u4f4d\u7f6e\u5c31\u975e\u5e38\u5c34\u5c2c\uff0c\u56e0\u4e3a\u5f0f\u5b50\u91cc\u5e76\u6ca1\u6709 $g_i$ \u8ddf\u67d0\u4e2a\u53d8\u91cf\u7684\u4e58\u79ef\u9879\uff0c\u6240\u4ee5\u72b6\u6001\u5411\u91cf\u957f\u5ea6\u80af\u5b9a\u5927\u4e8e $2$\u3002\n\n\u90a3\u5e72\u8106\u628a $g_i$ \u62c6\u6389\uff0c\u5f53 $g_i=1$ \u65f6\n\n$$ \\begin{bmatrix} f_i & 1 & 0  \\end{bmatrix} $$\n\n\u5f53 $g_i=2$ \u65f6\n\n$$ \\begin{bmatrix} f_i & 0 & 1  \\end{bmatrix} $$\n\n\u8fd9\u6837\u8f6c\u79fb\u77e9\u9635\u627e\u8d77\u6765\u5c31\u8212\u670d\u591a\u4e86\uff0c\u5f53 $g_x=1$ \u65f6\n\n$$ \\begin{bmatrix} 1 & 0 & 0 \\\\ f_i+1 & 0 & 1 \\\\  f_i+2 & 1 &0 \\end{bmatrix} $$\n\n\u5f53 $g_x=2$ \u65f6\n\n$$ \\begin{bmatrix} 1 & 0 & 0 \\\\ f_i+1 & 1 & 0 \\\\  f_i+2 & 0 & 1 \\end{bmatrix} $$\n\n\u7136\u540e\u60f3\u4e00\u4e0b\u521d\u59cb\u72b6\u6001\u957f\u5565\u6837\uff0c\u4ed6\u4e58\u4ee5\u94fe\u4f4e\u7684\u53f6\u5b50\u5c31\u8981\u5b8c\u5168\u83b7\u53d6\u5979\u7684\u4fe1\u606f\uff0c$f_i$ \u7684\u6765\u6e90\u6709 $f_i+1$ \u6216 $f_i+2$\uff0c\u5982\u679c\u662f $f_i+1$\uff0c\u521d\u59cb\u5411\u91cf\u4e3a\n\n$$ \\begin{bmatrix} -1 & 1 & 0 \\end{bmatrix} $$\n\n\u4f46\u662f\u8fd9\u6837 $g_i$ \u7684\u72b6\u6001\u5c31\u53cd\u4e86\uff08\u4e00\u5f00\u59cb\u4ee5\u4e3a\u8fd9\u6837\u662f\u5bf9\u7684\u6240\u4ee5\u67e5\u9519\u4e86\u5f88\u4e45qwq\uff09\uff0c\u6240\u4ee5\u6b63\u786e\u7684\u521d\u59cb\u5411\u91cf\u4e3a\n\n$$ \\begin{bmatrix} -2 & 0 & 1 \\end{bmatrix} $$\n\n\u67e5\u8be2\u65f6\u4e00\u4e2a\u7ed3\u70b9\u4e0b\u6302\u4e86\u8bb8\u591a\u53f6\u5b50\uff0c$f_{a_i}$ \u5bf9\u5e94\u589e\u52a0 $g_{a_i}$ \u5bf9\u5e94\u7ffb\u8f6c\u5373\u53ef\uff0c\u6ce8\u610f\u7531\u4e8e\u53f6\u5b50 $g$ \u672c\u6765\u5c31\u662f $1$\uff0c\u4fee\u6539\u5979\u65f6\u8981\u591a\u7ffb\u8f6c\u4e00\u6b21\u3002\n\n\u6700\u540e\u5957\u8def\u5730\u7528\u5404\u79cd\u6570\u636e\u7ed3\u6784\u7ef4\u62a4\u5373\u53ef\uff0c300ms \u5361\u5f97\u6709\u70b9\u7d27\uff0c\u63a8\u8350\u4f7f\u7528[\u5168\u5c40\u5e73\u8861\u4e8c\u53c9\u6811](https://blog.csdn.net/ez_lcw/article/details/123574885)\u3002\n\n\u65f6\u95f4\uff1a$O(27(n+\\sum D)\\log n)$\uff1b\u7a7a\u95f4\uff1a$O(9n)$\u3002\n\n~~\u597d\u5dee\u52b2\u554a~~\n\n# Code\n\n\u4ee3\u7801\u975e\u5e38\u957f\uff01\n\n```cpp\n#include<bits/stdc++.h>\n#define Lson(x) node[x].Son[0]\n#define Rson(x) node[x].Son[1]\n#define fa(x) node[x].father\nusing namespace std;\n\ntypedef long long ll;\ntypedef pair<int,int> pr;\n\nconst int MAXN=1e5;\n\nstruct Matrix\n{\n\tint data[3][3];\n\tinline void Clean() {memset(data,0,sizeof data);}\n\tinline void operator = (const Matrix &a)\n\t{\n\t\tfor(int i=0;i<3;i++)\n\t\t\tfor(int j=0;j<3;j++)\n\t\t\t\tdata[i][j]=a.data[i][j];\n\t}\n\tinline Matrix operator * (const Matrix &a)\n\t{\n\t\tMatrix res;\n\t\tfor(int i=0;i<3;i++)\n\t\t\tfor(int j=0;j<3;j++)\n\t\t\t{\n\t\t\t\tres.data[i][j]=0;\n\t\t\t\tfor(int k=0;k<3;k++) res.data[i][j]+=data[i][k]*a.data[k][j]; \n\t\t\t}\n\t\treturn res;\n\t}\n\tinline int Fval() {return data[2][0]-2;}\n\tinline int Gval() {return data[2][1]==1 ? 1 : 2;}\n\tinline void rev()\n\t{\n\t\tdata[1][1]^=1,data[1][2]^=1;\n\t\tdata[2][1]^=1,data[2][2]^=1;\n\t}\n\tinline void Print()\n\t{\n\t\tfor(int i=0;i<3;i++)\n\t\t{\n\t\t\tfor(int j=0;j<3;j++) printf(\"%d \",data[i][j]);\n\t\t\tprintf(\"\\n\");\n\t\t}\n\t}\n};\n\nstruct OVBST\n{\n\tint Son[2],father;\n\tMatrix dp,T;\n}node[MAXN+5];\n\nint n,q,root;\nvector<int> nxt[MAXN+5];\nint Mson[MAXN+5],Size[MAXN+5],f[MAXN+5],ovroot;\nint F[MAXN+5],G[MAXN+5],A[MAXN+5];\n\ninline void Link(int a,int b)\n{\n\tif(!b) return;\n\tF[a]+=F[b]+G[b];\n\tif(G[b]==1) G[a]=3-G[a];\n}\n\ninline void Cut(int a,int b)\n{\n\tif(!b) return;\n\tF[a]-=F[b]+G[b];\n\tif(G[b]==1) G[a]=3-G[a];\n}\n\nvoid CalMsg(int now)\n{\t\n\tint S=0;\n\tSize[now]=1;\n\tfor(int i=0,rear;i<nxt[now].size();i++)\n\t{\n\t\trear=nxt[now][i];\n\t\tif(rear==f[now]) continue;\n\t\tf[rear]=now;\n\t\tCalMsg(rear);\n\t\tSize[now]+=Size[rear];\n\t\tif(Size[rear]>Size[Mson[now]]) Mson[now]=rear;\n\t\n\t\tS+=G[rear];\n\t\tF[now]+=F[rear];\n\t}\n\tif(nxt[now].size()==1) F[now]=0,G[now]=1;\n\telse\n\t{\n\t\tF[now]+=S;\n\t\tif(S&1) G[now]=1;\n\t\telse G[now]=2;\n\t}\n\t\n\tCut(now,Mson[now]);\n\tnode[now].T.data[0][0]=1;\n\tnode[now].T.data[1][0]=F[now]+1;\n\tnode[now].T.data[2][0]=F[now]+2;\n\tif(G[now]==1) node[now].T.data[2][1]=node[now].T.data[1][2]=1;\n\telse node[now].T.data[1][1]=node[now].T.data[2][2]=1;\n\tLink(now,Mson[now]);\n}\n\ninline void PushUp(int x)\n{\n\tnode[x].dp=node[x].T;\n\tif(Lson(x)) node[x].dp=node[x].dp*node[Lson(x)].dp;\n\tif(Rson(x)) node[x].dp=node[Rson(x)].dp*node[x].dp;\n}\ninline bool isRoot(int x) {return Lson(fa(x))!=x && Rson(fa(x))!=x;}\n\nint Build(int L,int R)\n{\n\tif(L==R) {PushUp(L);return L;}\n\tll sum=0;int now;\n\tfor(int i=L;1;i=Mson[i]) {sum+=Size[i]-Size[Mson[i]];if(i==R) break;}\n\tsum>>=1;\n\tfor(int i=L;1;i=Mson[i]) {sum-=Size[i]-Size[Mson[i]];if(sum<=0) {now=i;break;}}\n\tif(L!=now) Lson(now)=Build(L,f[now]),fa(Lson(now))=now;\n\tif(R!=now) Rson(now)=Build(Mson[now],R),fa(Rson(now))=now;\n\tPushUp(now);\n\treturn now;\n}\n\nvoid TCP(int now,int Top)\n{\n\tif(Mson[now]) TCP(Mson[now],Top);\n\tfor(int i=0,rear;i<nxt[now].size();i++)\n\t{\n\t\trear=nxt[now][i];\n\t\tif(rear==f[now] || rear==Mson[now]) continue;\n\t\tTCP(rear,rear);\n\t}\n\tif(now==Top)\n\t{\n\t\tint R=now;while(Mson[R]) R=Mson[R];\n\t\tfa(Build(now,R))=f[now];\n\t}\n}\n\ninline void Modify(int x,int v,bool c)\n{\n\tnode[x].T.data[1][0]+=v;\n\tnode[x].T.data[2][0]+=v;\n\tif(c) node[x].T.rev();\n\t\n\tfor(;x!=ovroot;x=fa(x))\n\t{\n\t\tif(isRoot(x))\n\t\t{\n\t\t\tint delta=node[x].dp.Fval()+node[x].dp.Gval();\n\t\t\tnode[fa(x)].T.data[1][0]-=delta;\n\t\t\tnode[fa(x)].T.data[2][0]-=delta;\n\t\t\tif(node[x].dp.Gval()==1) node[fa(x)].T.rev();\n\t\t}\n\t\tPushUp(x);\n\t\tif(isRoot(x))\n\t\t{\n\t\t\tint delta=node[x].dp.Fval()+node[x].dp.Gval();\n\t\t\tnode[fa(x)].T.data[1][0]+=delta;\n\t\t\tnode[fa(x)].T.data[2][0]+=delta;\n\t\t\tif(node[x].dp.Gval()==1) node[fa(x)].T.rev();\n\t\t}\n\t}\n\tPushUp(ovroot);\n}\n\nint main()\n{\n\tscanf(\"%d %d\",&n,&q);\n\tfor(int i=1,a,b;i<n;i++)\n\t{\n\t\tscanf(\"%d %d\",&a,&b);\n\t\tnxt[a].push_back(b);\n\t\tnxt[b].push_back(a);\n\t}\n\tfor(int i=1;i<=n;i++)\n\t\tif(nxt[i].size()>1) {root=i;break;}\n\tCalMsg(root),TCP(root,root);\n\tfor(int i=1;i<=n;i++) if(!fa(i)) {ovroot=i;break;}\n\tfor(int d;q--;)\n\t{\n\t\tscanf(\"%d\",&d);\n\t\tfor(int i=1;i<=d;i++) scanf(\"%d\",&A[i]);\n\t\tsort(A+1,A+d+1),A[d+1]=0;\n\t\tfor(int i=1,cnt=0;i<=d;i++)\n\t\t{\n\t\t\t++cnt;\n\t\t\tif(A[i]!=A[i+1])\n\t\t\t{\n\t\t\t\tif(nxt[A[i]].size()>1) Modify(A[i],cnt,cnt&1);\n\t\t\t\telse Modify(A[i],cnt,(cnt^1)&1);\n\t\t\t\tcnt=0;\n\t\t\t}\n\t\t}\n\t\t\n\t\tif(node[ovroot].dp.Gval()==1) printf(\"-1\\n\");\n\t\telse printf(\"%d\\n\",node[ovroot].dp.Fval());\n\t\t\n\t\tfor(int i=1,cnt=0;i<=d;i++)\n\t\t{\n\t\t\t++cnt;\n\t\t\tif(A[i]!=A[i+1])\n\t\t\t{\n\t\t\t\tif(nxt[A[i]].size()>1) Modify(A[i],-cnt,cnt&1);\n\t\t\t\telse Modify(A[i],-cnt,(cnt^1)&1);\n\t\t\t\tcnt=0;\n\t\t\t}\n\t\t}\n\t}\n\treturn 0;\n}\n```\n",
        "postTime": 1659591607,
        "uid": 54591,
        "name": "Seauy",
        "ccfLevel": 9,
        "title": "[CEOI2020] \u6625\u5b63\u5927\u626b\u9664 \u7684\u9898\u89e3"
    }
]