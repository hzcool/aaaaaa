[
    {
        "content": "## \u5b98\u65b9\u9898\u89e3\u3002\n\n\u672c\u6587\u4e2d\u6240\u6709\u672a\u7ecf\u8bf4\u660e\u7684\u51fd\u6570\u90fd\u4e0e\u9898\u76ee\u4e2d\u5f62\u5f0f\u5316\u9898\u9762\u7684\u5b9a\u4e49\u76f8\u540c\u3002\u8bbe $S(x,y)$ \u8868\u793a $x$ \u5230 $y$ \u7684\u7b80\u5355\u8def\u5f84\u4e0a\u6240\u6709\u8282\u70b9\u7684\u70b9\u6743\u548c\uff08$x$ \u548c $y$ \u4e5f\u7b97\u5728\u5185\uff09\uff0c$P(x,y)$ \u8868\u793a $x$ \u5230 $y$ \u7684\u7b80\u5355\u8def\u5f84\u4e0a\u6240\u6709\u8282\u70b9\u7684\u70b9\u6743\u79ef\uff08$x$ \u548c $y$ \u4e5f\u7b97\u5728\u5185\uff09\uff0c$siz_u$ \u8868\u793a\u4ee5 $u$ \u4e3a\u6839\u7684\u5b50\u6811\u8282\u70b9\u4e2a\u6570\uff0c\u6839\u662f\u54ea\u4e2a\u8282\u70b9\u89c1\u8bed\u5883\u3002\n\n\u5148\u8003\u8651\u5bf9\u4e8e\u786e\u5b9a\u7684 $r$\uff0c\u786e\u5b9a\u7684 $u$\uff0c\u600e\u4e48\u8ba1\u7b97 $W(u)=\\sum_{v=1}^nf(v,u)$\u3002\n\n$f$ \u7684\u5b9a\u4e49\u5c31\u662f\u4e00\u4e2a\u5206\u6bb5\u51fd\u6570\u7684\u5f62\u5f0f\uff0c\u6240\u4ee5\u8003\u8651\u5bf9\u4e8e $x\\in A_u$ \u548c $x\\not\\in A_u$ \u7684\u4e24\u79cd $x$ \u5206\u522b\u6c42\u548c\u3002$f(x,u)$ \u4e2d\u60c5\u51b5 $x\\in A_u$ \u7684\u5f0f\u5b50\u53ef\u4ee5\u505a\u51fa\u5982\u4e0b\u8f6c\u6362\uff1a\n$$\\begin{aligned}f(F(x),u)+a_x&=f(F(F(x)),u)+a_{F(x)}\\\\&=f(F(F(F(x))),u)+a_{F(F(x))}+a_{F(x)}+a_x\\\\&\\cdots\\\\&=S(x,u)+f(F(u),u)\\end{aligned}$$\n\u4e8e\u662f\uff0c\u5904\u7406\u51fa $SS_u$ \u8868\u793a $\\sum_{v\\in A_u}S(v,u)$\uff0c\u4ee5 $u$ \u4e3a\u6839\u7684\u5b50\u6811\u4e2d\u8282\u70b9\u7684 $f$ \u548c\u5c31\u662f $SS_u+siz_u\\cdot f(F(u),u)$\u3002\u8fd9\u91cc\u7ed9\u51fa $SS$ \u7684\u9012\u63a8\u5f0f\uff1a$SS_u=siz_ua_u+\\sum_{v\\in B_u,v\\ne F(u)}SS_v$\u3002\n\n\u5bf9\u4e8e $x\\not\\in A_u$ \u7684\u60c5\u51b5\uff0c\u4ee5 $F(u)$ \u4e3a\u6839\uff0c$D(x,u)$ \u4e3a\u8282\u70b9 $x$ \u7684\u6df1\u5ea6\uff0c\u62ce\u8d77\u4e00\u68f5\u6811\uff0c\u76f4\u63a5\u6c42\u5373\u53ef\u3002\n\n\u5f53 $u$ \u53d8\u5316\u65f6\uff0c\u4ee5 $u$ \u4e3a\u6839\u7684\u5b50\u6811\u4e2d\u8282\u70b9\u7684 $f$ \u548c\u4ecd\u7136\u53ef\u4ee5\u7528 $SS_u+siz_u\\cdot f(F(u),u)$\uff1a\u9996\u5148\u8981\u5bf9\u4e8e\u6240\u6709\u8282\u70b9 $u$ \u6c42\u51fa $SS_u$ \u548c $siz_u$\uff0c\u7136\u540e\u5bf9\u4e8e $f(F(u),u)$ \u7684\u8ba1\u7b97\uff0c\u8003\u8651\u5728\u4e0b\u56fe\u4e2d\uff0c\u5c06 $u$ \u6362\u6210\u5b83\u7684\u4e00\u4e2a\u5b69\u5b50 $v$\uff0c$f(F(u),u)$ \u4f1a\u53d1\u751f\u4ec0\u4e48\u53d8\u5316\uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/sgc1vmpy.png)\n\n\u89c2\u5bdf\u56fe\uff0c\u539f\u6765\u5b50\u6811\u5916\u7684\u90e8\u5206\u662f\u7eff\u6846\uff0c\u73b0\u5728\u662f\u84dd\u6846\uff0c\u53d1\u73b0\u591a\u7684\u90e8\u5206\u5c31\u662f $u$ \u9664 $v$ \u4ee5\u5916\u5176\u4ed6\u5b69\u5b50\u7684\u5b50\u6811\u548c $u$\uff0c\u4e5f\u5c31\u662f\u56fe\u4e2d\u7ea2\u8272\u6846\u7684\u90e8\u5206\uff0c\u6309\u7167\u539f\u6765\u5c42\u6b21\u4f20\u4e0a\u6765\u7684\u8d21\u732e\u3002\u4e8e\u662f\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u8282\u70b9 $x$\uff0c\u6c42\u51fa $SP_x=a_x\\cdot\\max_{y\\in B_x,y\\ne F(x)}SP_y$\uff0c\u5728\u6bcf\u6b21\u51c6\u5907\u5c06 $u$ \u6362\u6210 $v$ \u65f6\uff0c\u5bf9\u4e8e $u$ \u7684\u6240\u6709\u5b69\u5b50\u7684 $SP$ \u6309\u7167 dfs \u987a\u5e8f\u6c42\u4e00\u4e2a\u524d\u7f00 $\\max$ \u548c\u540e\u7f00 $\\max$\uff0c\u8f6c\u79fb\u5373\u53ef\u3002\n\n\u5230\u73b0\u5728\uff0c\u4ee5\u4e00\u6b21 $\\mathcal O(n)$ \u7684\u590d\u6742\u5ea6\uff0c\u6c42\u51fa\u4e86 $C(r)$\uff0c\u603b\u65f6\u95f4\u590d\u6742\u5ea6\u662f $\\mathcal O(n^2)$\uff0c\u8fd8\u4e0d\u591f\u4f18\u79c0\uff0c\u8003\u8651\u7ee7\u7eed\u4f18\u5316\u3002\u56e0\u4e3a\u8fd9\u91cc\u662f\u5bf9\u6bcf\u4e2a\u8282\u70b9\u6c42\u4e00\u4e2a\u503c\uff0c\u6839\u636e\u5957\u8def\uff0c\u8003\u8651\u6362\u6839\uff0c\u5373\u8003\u8651\u6839\u4ece $r_1$ \u53d8\u5230 $r_2$ \u65f6\u7b54\u6848\u7684\u53d8\u5316\u3002\n\n\u6b64\u5904\u5148\u8003\u8651 $x\\not\\in A_u$\u3002\u6ce8\u610f\u5230\u6839 $r$ \u7684\u53d8\u5316\uff0c\u9664\u4e86 $u=r_1$ \u548c $u=r_2$\uff0c\u5f71\u54cd\u4e0d\u5230\u4f60\u62ce\u8d77\u6765\u7684\u8fd9\u68f5\u6811\u3002\u8fd9\u68f5\u62ce\u8d77\u6765\u7684\u6811\u53ea\u8ddf $F(u)$\uff0c$D(x,u)$ \u6709\u5173\uff0c\u800c\u8fd9\u4e9b\u4e1c\u897f\uff0c\u9664\u4e86 $u=r_1$ \u548c $u=r_2$\uff0c\u5728\u6362\u6839\u65f6\u6ca1\u6709\u53d8\u5316\u3002\u7c7b\u4f3c\u5730\uff0c$x\\in A_u$ \u7684\u60c5\u51b5\uff0c\u53ea\u8ddf\u5b50\u6811\u4e2d\u6709\u54ea\u4e9b\u8282\u70b9\u6709\u5173\uff0c\u9664\u4e86 $u=r_1$ \u548c $u=r_2$\uff0c\u5176\u4ed6\u7684\u5b50\u6811\u90fd\u6ca1\u6709\u53d8\u5316\uff01\u4e8e\u662f\uff0c\u7528\u4e0a\u9762\u7684\u8ba1\u7b97\u65b9\u6cd5\uff0c\u53ea\u9700\u8981\u7279\u6b8a\u5904\u7406 $u=r_1$ \u548c $u=r_2$ \u65f6\u7684 $W(u)$\u3002~~\u6211\u592a\u61d2\u4e86\u5c31\u6ca1\u6709\u753b\u56fe\u3002~~\n\n\u5904\u7406 $u=r_1$ \u548c $u=r_2$ \u65f6\u7684 $W(u)$ \u9700\u8981\u7b97\u51fa\u4e00\u4e9b\u989d\u5916\u7684\u503c\uff1a$AS_x$ \u8868\u793a\u6811\u4e2d\u6240\u6709\u8282\u70b9\u5230 $x$ \u8def\u5f84\u4e0a\u7684\u70b9\u6743\u548c\uff0c\u5373 $AS_x=\\sum_{y=1}^nS(x,y)$\uff0c\u8fd9\u4e2a\u503c\u53ef\u4ee5\u7528\u6362\u6839 dp \u6c42\u51fa\uff1b\u5176\u4ed6\u7684\u503c\u53ef\u4ee5\u7528\u7c7b\u4f3c\u4e0a\u9762\u7684\u65b9\u6cd5\u6c42\u51fa\u3002\u603b\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal O(n)$\u3002\u4ee3\u7801\uff08\u5efa\u8bae\u590d\u5236\u5230 IDE \u91cc\u770b\uff09\uff1a\n```cpp\n#include<bits/stdc++.h>\nusing namepace std;\nconst int mod=998244353;\nvector<int>g[500010];\nint n,siz[500010];\nlong long a[500010],ss[500010],as[500010],sp[500010],ssp[500010],uans[500010],ans[500010];//ssp\u4e3a\u5b50\u6811\u5185sp\u7684\u548c\uff0cuans[x]\u8868\u793a\u5f53r=1\u65f6\u7684W(r)\ninline int read()//\u5feb\u8bfb\n{\n\tchar c=getchar();\n\tint x=0;\n\twhile(c<'0'||c>'9')\n\t\tc=getchar();\n\twhile(c>='0'&&c<='9'){\n\t\tx=(x<<3)+(x<<1)+c-'0'; c=getchar();\n\t}\n\treturn x;\n}\ninline void write(int x)//\u5feb\u5199\n{\n\tif(!x){\n\t\tputchar('0'); putchar('\\n');\n\t\treturn;\n\t}\n\twhile(x<0) x+=mod;\n\tint sta[10],tp=0;\n\twhile(x){\n\t\tsta[++tp]=x%10; x/=10;\n\t}\n\twhile(tp)\n\t\tputchar(sta[tp--]+'0');\n\tputchar('\\n');\n}\nvoid dfs(int x,int f)//\u6c42\u51fasiz,ss,sp,ssp\n{\n\tsiz[x]=1;\n\tsp[x]=-1;\n\tfor(int i=0;i<g[x].size();i++)\n\t\tif(g[x][i]!=f)\n\t\t{\n\t\t\tdfs(g[x][i],x);\n\t\t\tsiz[x]+=siz[g[x][i]];\n\t\t\tss[x]=(ss[x]+ss[g[x][i]])%mod;\n\t\t\tsp[x]=max(sp[x],sp[g[x][i]]);\n\t\t}\n\tss[x]=(ss[x]+siz[x]*a[x]%mod)%mod;\n\tif(sp[x]==-1)\n\t\tssp[x]=sp[x]=a[x];\n\telse\n\t\tssp[x]=sp[x]=sp[x]*a[x]%mod;\n\tfor(int i=0;i<g[x].size();i++)\n\t\tif(g[x][i]!=f)\n\t\t\tssp[x]=(ssp[x]+ssp[g[x][i]])%mod;\n}\nvoid dp1(int x,int f,long long nf,long long ns)//\u6c42\u51fauans,ans[1],as\n{\n\tuans[x]=(ss[x]+nf*siz[x]%mod+ns)%mod;\n\tans[1]=(ans[1]+uans[x])%mod;\n\tif(x!=1)\n\t\tas[x]=(as[f]-a[f]*siz[x]+a[x]*(n-siz[x])%mod)%mod;\n\tint i,pt=0,lt=g[x].size()-2;\n\tvector<long long>pm,lm;//\u524d\u7f00\uff0c\u540e\u7f00\u6700\u5927\u503c\n\tif(x==1)\n\t\tlt++;\n\tpm.push_back(0);\n\tlm.push_back(0);\n\tfor(i=0;i<g[x].size();i++)\n\t\tif(g[x][i]!=f)\n\t\t\tpm.push_back(max(pm.back(),sp[g[x][i]]));\n\tfor(i=g[x].size()-1;~i;i--)\n\t\tif(g[x][i]!=f)\n\t\t\tlm.push_back(max(lm.back(),sp[g[x][i]]));\n\tfor(i=0;i<g[x].size();i++)\n\t\tif(g[x][i]!=f)\n\t\t{\n\t\t\tdp1(g[x][i],x,max(max(nf,1ll),max(pm[pt],lm[lt]))*a[x]%mod,(ns+ssp[x]-ssp[g[x][i]]-sp[x]+max(max(nf,1ll),max(pm[pt],lm[lt]))*a[x]%mod)%mod);\n\t\t\tpt++;\n\t\t\tlt--;\n\t\t}\n}\nvoid dp2(int x,int f)//\u6c42\u51faans\n{\n\tans[x]=(ans[f]-as[f]-uans[x]+as[x]+ssp[x]+sp[x]*(n-siz[x])%mod+as[f]-ss[x]-a[f]*siz[x]%mod)%mod;\n\tfor(int i=0;i<g[x].size();i++)\n\t\tif(g[x][i]!=f)\n\t\t\tdp2(g[x][i],x);\n}\nint main()\n{\n\tint i,x,y;\n\tn=read();\n\tfor(i=1;i<=n;i++)\n\t\ta[i]=read()%mod;//\u8fdb\u6765\u8981\u5148%\uff01\u5426\u5219\u5728\u6bd4\u8f83\u5927\u5c0f\u65f6\u4f1a\u51fa\u95ee\u9898\n\tfor(i=1;i<n;i++)\n\t{\n\t\tx=read();\n\t\ty=read();\n\t\tg[x].push_back(y);\n\t\tg[y].push_back(x);\n\t}\n\tdfs(1,0);\n\tas[1]=ss[1];\n\tdp1(1,0,0,0);\n\tfor(i=0;i<g[1].size();i++)//\u4e0d\u60f3\u8ba9\u8282\u70b91\u518d\u8f6c\u79fb\u4e00\u904d\uff0c\u6240\u4ee5\u76f4\u63a5\u5bf91\u7684\u5b69\u5b50\u505a\n\t\tdp2(g[1][i],1);\n\tfor(i=1;i<=n;i++)\n\t\twrite(ans[i]);\n\treturn 0;\n}\n```",
        "postTime": 1615821289,
        "uid": 150522,
        "name": "b6e0_",
        "ccfLevel": 9,
        "title": "\u5b50\u6811 \u9898\u89e3"
    }
]