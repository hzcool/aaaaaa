[
    {
        "content": "\u9898\u89e3:\n\n\n\u8fd9\u4e2a\u9898\u53ef\u4ee5\u91c7\u53d6\u79bb\u7ebf\u5904\u7406\u7684\u65b9\u5f0f.\u5148\u5904\u7406\u51fa\u6bcf\u4e2a\u70b9i\u5de6\u8fb9\u7b2c\u4e00\u4e2a\u6bd4\u5b83\u5927\u7684\u70b9L[i],\u548c\u53f3\u8fb9\u7b2c\u4e00\u4e2a\u6bd4\u5b83\u5927\u7684\u70b9R[i].\n\n\u90a3\u4e48\u5bf9\u4e8e\u533a\u95f4L[i]\u5230R[i]\u6709p1\u7684\u8d21\u732e.\u2460\n\n\u5bf9\u4e8e\u5de6\u7aef\u70b9\u5728L[i]+1\u5230i-1,\u53f3\u7aef\u70b9\u4e3aR[i]\u7684\u533a\u95f4\u6709p2\u7684\u8d21\u732e.\u2461\n\n\u5bf9\u4e8e\u5de6\u7aef\u70b9\u4e3aL[i],\u53f3\u7aef\u70b9\u4e3ai+1\u5230R[i]-1\u7684\u533a\u95f4\u4e5f\u6709p2\u7684\u8d21\u732e.\u2462\n\n\u6240\u4ee5\u6211\u4eec\u79bb\u7ebf\u6392\u5e8f\u5904\u7406\u597d.\n\n\u5bf9\u4e8e\u2460\u60c5\u51b5,\u6211\u4eec\u5728\u626b\u5230R[i]\u65f6,\u66f4\u65b0\u70b9L[i]\u7684\u8d21\u732e\n\n\u5bf9\u4e8e\u2461\u60c5\u51b5,\u6211\u4eec\u5728\u626b\u5230R[i]\u65f6,\u66f4\u65b0\u533a\u95f4L[i]+1\u5230i-1\u7684\u8d21\u732e\n\n\u5bf9\u4e8e\u2462\u60c5\u51b5,\u6211\u4eec\u5728\u626b\u5230L[i]\u65f6,\u66f4\u65b0\u533a\u95f4i+1\u5230R[i]-1\u7684\u8d21\u732e\n\n\u6211\u4eec\u5bf9\u4e8e\u6bcf\u4e2a\u8be2\u95ee[l,r],\u5728\u626b\u5230l-1\u65f6,\u6211\u4eec\u8bb0\u5f55\u6b64\u65f6\u533a\u95f4l\u5230r\u7684\u6bcf\u4e2a\u70b9\u7684\u8d21\u732e\u548c\u4e3asum1,\u7136\u540e\u5f53\u6211\u4eec\u626b\u5230r\u7684\u65f6\u5019,\u518d\u6b21\u8bb0\u5f55\u6b64\u65f6\u7684\u533a\u95f4l\u5230r\u7684\u6bcf\u4e2a\u70b9\u7684\u8d21\u732e\u548c\u4e3asum2,\u663e\u7136\u7b54\u6848\u5c31\u662fsum2-sum1\u4e86.\n\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<cstdlib>\n#include<algorithm>\n#include<cmath>\n#include<cstring>\n#include<queue>\n#include<vector>\n#include<set>\n#define RG register\n#define LL long long int\n#define MAXN 500010\nusing namespace std;\nconst int INF=1e9;\nstruct node{\n  int l,r,x,id,v;\n  node(){}\n  node(int l_,int r_,int x_,int id_,int v_):l(l_),r(r_),x(x_),id(id_),v(v_){}\n  bool operator <(const node &tmp)const{\n    return x<tmp.x;\n  }\n}s1[MAXN],s2[MAXN];\nint n,m,p1,p2;\nint k[MAXN],q[MAXN],top;\nint L[MAXN],R[MAXN];\nLL ans[MAXN],c1[MAXN],c2[MAXN];\nint lowbit(int x)\n{\n  return x&(-x);\n}\nvoid add(int x,int y)//\u533a\u95f4\u4fee\u6539\u64cd\u4f5c\n{\n  if(x) for(int i=x;i<=n;i+=lowbit(i)) c1[i]+=y,c2[i]+=(LL)x*y;\n}\nLL sum(int x)\n{\n  LL num=0;\n  for(int i=x;i>0;i-=lowbit(i)) num+=(x+1)*c1[i]-c2[i];\n  return num;\n}\nint main()\n{\n  freopen(\"1.in\",\"r\",stdin);\n  scanf(\"%d%d%d%d\",&n,&m,&p1,&p2);\n  k[0]=k[n+1]=n+1;q[++top]=0;\n  for(int i=1;i<=n;i++) scanf(\"%d\",&k[i]);\n  for(int i=1;i<=n+1;i++)\n    {\n      while(k[q[top]]<k[i]) R[q[top]]=i,top--;\n      L[i]=q[top];q[++top]=i;\n    }\n  int x,y;\n  for(int i=1;i<=m;i++)\n    {\n      scanf(\"%d%d\",&x,&y);ans[i]+=(y-x)*p1;\n      s1[i]=node(x,y,x-1,i,-1);s1[i+m]=node(x,y,y,i,1);\n    }\n  sort(s1+1,s1+2*m+1);int tot=0;\n  for(int i=1;i<=n;i++)\n    {\n      if(1<=L[i]&&R[i]<=n) s2[++tot]=node(L[i],L[i],R[i],0,p1);\n      if(1<=L[i]&&R[i]>i+1) s2[++tot]=node(i+1,R[i]-1,L[i],0,p2);\n      if(L[i]+1<i&&R[i]<=n) s2[++tot]=node(L[i]+1,i-1,R[i],0,p2);\n    }\n  sort(s2+1,s2+tot+1);int n1=1,n2=1;\n  while(!s1[n1].x) n1++;\n  for(int i=1;n1<=m*2&&i<=n;i++)\n    {\n      while(n2<=tot&&s2[n2].x==i){\n    add(s2[n2].r+1,-s2[n2].v);\n    add(s2[n2].l,s2[n2].v);\n    n2++;\n      }\n      while(n1<=m*2&&s1[n1].x==i){\n    ans[s1[n1].id]+=s1[n1].v*(sum(s1[n1].r)-sum(s1[n1].l-1));\n    n1++;\n      } \n    }\n  for(int i=1;i<=m;i++) printf(\"%lld\\n\",ans[i]);\n  return 0;\n}\n```",
        "postTime": 1513861412,
        "uid": 38708,
        "name": "\u82b1\u6837\u767e\u51fa",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3722 \u3010[AH/HNOI2017]\u5f71\u9b54\u3011"
    },
    {
        "content": "\u611f\u89c9\u8fd8\u662f\u633a\u6709\u601d\u7ef4\u96be\u5ea6\u7684\u4e00\u9053\u9898\u3002\u849f\u84bb\u60f3\u4e86\u4e0d\u77ed\u65f6\u95f4\u624d\u4ece\u66b4\u529b$O(n^3)$\u4f18\u5316\u5230$O(nlogn)$\n\n### \u7eaf\u66b4\u529b\n\n$O(n^3)$ \u66b4\u529b\u679a\u4e3e\u533a\u95f4\u5185\u7684\u70b9\u5bf9\uff0c\u66b4\u529b\u626b\u63cf\u533a\u95f4\u6700\u5927\u503c\u3002\n\n### \u7a0d\u5fae\u597d\u70b9\u7684\u66b4\u529b\n\n\u6700\u5927\u503c\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\uff0c\u4f18\u5316\u5230 $O(n^2logn)$\u3002\n\n\uff08\u5176\u5b9e$st$\u8868\u80fd\u8fbe\u5230 $O(n^2)$ \uff0c\u4e0d\u8fc7\u849f\u84bb\u65e9\u5fd8\u4e86\u548b\u5199\u4e86\u3002\u3002\u3002\u603b\u4e4b\u6700\u5927\u503c\u53ef\u4ee5\u7528\u6570\u636e\u7ed3\u6784\u4f18\u5316)\n\n### \uff08\u91cd\u70b9\uff01\uff09\u9ad8\u7aef\u7684\u4f18\u5316\n\n\u4f3c\u4e4e\u5230\u4e0a\u9762\u5c31\u4e0d\u662f\u5f88\u597d\u60f3\u4e86\u3002\u74f6\u9888\u5c31\u5728\u4e8e\u679a\u4e3e\u70b9\u5bf9\u7684 $n^2$\u3002\u53ef\u4e0d\u53ef\u4ee5\u5c11\u679a\u4e3e\u70b9\u4e1c\u897f\uff1f\n\n\u4e00\u4e2a\u70b9\u5bf9 $(i,j)$ \u7684\u8d21\u732e\u4e0e\u4e09\u4e2a\u503c\u6709\u5173\uff1a$a[i],a[j],max(a[k])(i<k<j)$\n\n\u4e0d\u679a\u4e3e$i,j$\uff0c\u90a3\u5c31\u679a\u4e3e\u4e2d\u95f4\u7684 $a[k]$\u3002\u8fd9\u91cc\u5f15\u5165\u4e24\u4e2a\u503c\uff1a\u5b9a\u4e49 $ll[i]$ \u4e3a**\u4ece\u70b9 $i$ \u5411\u5de6\u8d70\uff0c\u76f4\u5230\u9047\u5230\u7b2c\u4e00\u4e2a\u5927\u4e8e\u5b83\u7684\u6570\u7684\u4f4d\u7f6e\uff08\u6ca1\u6709\u5219\u4e3a0\uff09**\uff1b\u540c\u7406\uff0c$rr[i]$\u5c31\u662f\u5411\u53f3\u8d70\uff08\u6ca1\u6709\u5219\u4e3an+1)\u3002\n\n\u4e5f\u5c31\u662f\u8bf4\uff0c**\u70b9 $i$ \u662f\u533a\u95f4$[ll[i]+1,rr[i]-1]$\u7684\u6700\u5927\u503c\uff0c\u4e14\u6ee1\u8db3\u8fd9\u4e2a\u533a\u95f4\u957f\u5ea6\u6700\u5c0f**\u3002\n\n\u8fd9\u6837\uff0c\u679a\u4e3e\u8fd9\u4e2a\u70b9\uff08\u8bb0\u4e3a $i$ )\u7684\u65f6\u5019\uff1a\uff08\u533a\u95f4\u8bb0\u4e3a$[L,R]$\uff09\n\n- \u5982\u679c $ll[i]$ \u4e0e $rr[i]$ \u90fd\u5728\u533a\u95f4\u4e2d\uff0c\u5c31\u4f1a\u6709\u4e00\u70b9\u5bf9 $(ll[i],rr[i])$\u6ee1\u8db3\u6761\u4ef6 $1$\u3002\n- \u5982\u679c $ll[i]$ \u5728\u533a\u95f4\u4e2d\uff0c\u90a3\u4e48\u6bcf\u4e2a\u70b9\u5bf9 $(ll[i],k)(i<k<min(rr[i],R))$ \u6ee1\u8db3\u6761\u4ef6 $2$\u3002\uff08\u56e0\u4e3a $a[k]<a[i]$ \uff0c$a[i]<a[ll[i]]$ \uff0c $a[i]$ \u4e3a\u533a\u95f4 $[ll[i]+1,k-1]$\u7684\u6700\u5927\u503c\u3002\u6ce8\u610f\u4e0d\u80fd\u8d70\u51fa\u53bb\u6240\u4ee5\u53d6min\uff09\n-  \u5982\u679c $rr[i]$ \u5728\u533a\u95f4\u4e2d\uff0c\u90a3\u4e48\u6bcf\u4e2a\u70b9\u5bf9 $(k,rr[i])(max(ll[i],L)<k<i)$ \u6ee1\u8db3\u6761\u4ef6 $2$\u3002\uff08\u539f\u56e0\u540c\u4e0a\uff09\n\n\u8fd9\u6837\u5c31\u80fd\u5f97\u5230 $O(n^2)$ \u7684\u505a\u6cd5\u3002\n\n### \u9876\u7ea7\u7684\u4f18\u5316\n\n\u524d\u9762\u94fa\u57ab\u8fd9\u4e48\u591a\uff0c\u7ec8\u4e8e\u8f6e\u5230\u6b63\u89e3\u51fa\u573a\u4e86\uff01\n\n\u6839\u636e\u4e0a\u9762\uff0c\u6211\u4eec\u9700\u8981\u4e00\u79cd\u65b9\u6cd5\uff0c\u80fd\u5feb\u901f\u5f97\u77e5\uff1a\n\n- \u6bcf\u4e2a $ll[i]$ \u5728\u533a\u95f4\u5185\u7684\u6570\u7684 $min(rr[i],R)-i$\n- \u6bcf\u4e2a $rr[i]$ \u5728\u533a\u95f4\u5185\u7684\u6570\u7684 $i-max(ll[i],L)$ \n- $ll[i]$\uff0c$rr[i]$\u90fd\u5728\u533a\u95f4\u5185\u6570\u7684\u4e2a\u6570\u3002\n\n\u867d\u7136\u6709\u70b9\u9ebb\u70e6\uff0c\u4e0d\u8fc7\u672c\u9898\u53ea\u6709\u8be2\u95ee\uff0c\u662f\u4e0d\u662f\u53ef\u4ee5\u79bb\u7ebf\u4e0b\u6765\u641e\u4e00\u641e\u5462\uff1f\n\n\u5148\u5904\u7406\u7b2c\u4e00\u79cd\u3002\u4ece\u53f3\u5f80\u5de6\u626b\u63cf\u6570\u5217\uff0c\u9047\u5230\u67d0\u4e2a\u6570\u7684 $ll[i]$ \u518d\u628a\u8fd9\u4e2a\u6570\u4ea7\u751f\u7684\u8d21\u732e\u7528\u67d0\u79cd\u6570\u636e\u7ed3\u6784\u7ef4\u62a4\u8d77\u6765\uff0c\u9047\u5230\u67d0\u4e2a\u8be2\u95ee\u7684\u5de6\u7aef\u70b9\u5c31\u76f4\u63a5\u67e5\u8be2\uff0c\u8fd9\u6837\u4fdd\u8bc1\u4e86**\u53ea\u6709 $ll[i]$ \u5728\u533a\u95f4\u5185\u7684\u6570\u624d\u4f1a\u4ea7\u751f\u8d21\u732e**\u3002\n\n\u5177\u4f53\u6765\u8bf4\uff1a\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u3002\u9047\u5230 $ll[i]$ \u5c31\u628a $[i+1,rr[i]-1]$\uff08\u6ce8\u610f\u4e0d\u80fd\u53d6\u4e24\u7aef\uff09\u52a0 $1$\uff0c\u9047\u5230\u8be2\u95ee\u5de6\u7aef\u70b9\u5c31\u67e5\u8be2 $[L,R]$ \u7684\u548c\u3002\u4ed4\u7ec6\u60f3\u60f3\u5c31\u4f1a\u53d1\u73b0\uff0c\u8fd9\u6837\u4e5f\u4f1a\u5728\u67e5\u8be2\u65f6\u76f8\u5f53\u4e8e\u53d6\u4e86$min(rr[i],R)$\u3002\n\n\u7b2c\u4e8c\u79cd\u5012\u8fc7\u6765\u626b\u5c31\u597d\u4e86\u3002\n\n\u7b2c\u4e09\u79cd\u6b63\u7740\u626b\u5012\u7740\u626b\u7686\u53ef\u3002\u4ee5\u5012\u7740\u626b\u4e3a\u4f8b\uff1a\u9047\u5230 $ll[i]$ \u628a$[rr[i],n]$\u52a0 $1$\uff08\u610f\u4e3a\u8be2\u95ee\u53f3\u7aef\u70b9\u843d\u5728$[rr[i],n]$\u90fd\u4f1a\u8986\u76d6\u5230$rr[i]$\uff0c\u5c31\u6709 1 \u8d21\u732e\uff09\uff0c\u8fd9\u6837\u67e5\u8be2\u65f6\u5355\u70b9\u67e5 $R$ \u5373\u53ef\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a$O(nlogn)$\uff08\u5e38\u6570\u6709\u70b9\u5927\u6700\u6162$1100ms+$\u3002\u3002\u3002\uff09\n\n\u7ec6\u8282\uff1a1.\u5173\u4e8e\u9884\u5904\u7406$ll$\u3001$rr$\uff1a\u849f\u84bb\u597d\u50cf\u60f3\u590d\u6742\u4e86\uff0c\u6ca1\u6709\u4ec0\u4e48\u597d\u65b9\u6cd5\uff0c\u53ea\u80fd\u8bb0\u5f55\u4e0b\u4f4d\u7f6e\uff0c\u6309\u6743\u503c\u6392\u5e8f\u540e\u9020\u68f5\u5e73\u8861\u6811\u5012\u7740\u626b\u6570\u5217\uff0c\u63d2\u5165\u6bcf\u4e2a\u70b9\u7684\u4f4d\u7f6e\uff0c$ll$\u3001$rr$\u5206\u522b\u67e5\u524d\u9a71\u540e\u7ee7\u3002\u3002\u3002\n\n2.\u7edf\u8ba1\u7684\u7b54\u6848\u8981\u5f00long long\uff01\n\n$update:$\n\n3.\u6709\u4e00\u70b9\u5fd8\u4e86\u8bf4\u4e86\uff1a\u5bf9\u4e8e\u60c5\u51b51\uff0c\u6ee1\u8db3$i+1=j$\u540c\u6837\u4f1a\u6709\u8d21\u732e\uff0c\u800c\u8be5\u65b9\u6cd5\u7edf\u8ba1\u4e0d\u4e0a\uff0c\u6240\u4ee5\u8f93\u51fa\u65f6\u76f4\u63a5\u52a0\u4e0a\u5c31\u597d\u3002\n\n\u4e0a\u4ee3\u7801\uff1a\n```cpp\n#define Kafuu signed\n#define Chino main\n\n#include <iostream>\n#include <cstdio>\n#include <algorithm>\n#include <cmath>\n#include <cstring>\n#include <vector>\n\n#define maxn 200005\n#define inf 0x3f3f3f\n\nusing namespace std;\n\ninline int read(){\n\tint x=0,y=0;\n\tchar ch=getchar();\n\twhile(ch<'0'||ch>'9'){if(ch=='-')y=1;ch=getchar();}\n\twhile(ch>='0'&&ch<='9')x=(x<<1)+(x<<3)+(ch^48),ch=getchar();\n\treturn y?-x:x;\n}\ntemplate<typename T>\ninline T read(){\n\tT x=0;\n\tint y=0;\n\tchar ch=getchar();\n\twhile(ch<'0'||ch>'9'){if(ch=='-')y=1;ch=getchar();}\n\twhile(ch>='0'&&ch<='9')x=(x<<1)+(x<<3)+(ch^48),ch=getchar();\n\treturn y?-x:x;\n}//\u5feb\u8bfb\ninline int ran(){\n\tstatic int seed=45562;\n\treturn seed=seed*48271LL%2147483647;\n}//\u4e00\u4e2a\u4f18\u5316\u5e38\u6570\u7684\u968f\u673a\u6570\u51fd\u6570\nint a[maxn],pos[maxn],ll[maxn],rr[maxn],n;\nvector<int>lq[maxn],rq[maxn],li[maxn],ri[maxn];\n//\u5206\u522b\u7528\u6765\u5b58\u8be2\u95ee\u5de6\u7aef\u70b9\u3001\u53f3\u7aef\u70b9\u548cll\u3001rr\u7684\u4f4d\u7f6e\u60c5\u51b5\n//vector\u53ef\u4ee5\u7528\u94fe\u5f0f\u524d\u5411\u661f\u4ee3\u66ff\uff0c\u5e38\u6570\u5c0f\u3002\u4e0d\u8fc7\u6211\u61d2\u4e86\u3002\u3002\u3002\nstruct Question{\n\tint l,r;\n\tlong long ans;\n}q[maxn];\nstruct Treap{\n#define ls(x) ls[x]\n#define rs(x) rs[x]\n\tint dat[maxn],ls[maxn],rs[maxn],ra[maxn],root,cnt;\n\tvoid right(int &node){\n\t\tint rec=ls(node);\n\t\tls(node)=rs(rec);\n\t\trs(rec)=node;\n\t\tnode=rec;\n\t}\n\tvoid left(int &node){\n\t\tint rec=rs(node);\n\t\trs(node)=ls(rec);\n\t\tls(rec)=node;\n\t\tnode=rec;\n\t}\n\tvoid insert(int &node,int d){\n\t\tif(\uff01node){\n\t\t\tnode=++cnt;\n\t\t\tdat[node]=d;\n\t\t\tra[node]=ran();\n\t\t\treturn;\n\t\t}\n\t\tif(dat[node]<d){\n\t\t\tinsert(rs(node),d);\n\t\t\tif(ra[rs(node)]>ra[node])left(node);\n\t\t}\n\t\telse {\n\t\t\tinsert(ls(node),d);\n\t\t\tif(ra[ls(node)]>ra[node])right(node);\n\t\t}\n\t}\n\tint getpre(int d){\n\t\tint ans=0,node=root;\n\t\twhile(node){\n\t\t\tif(dat[node]<d)ans=max(ans,dat[node]),node=rs(node);\n\t\t\telse node=ls(node);\n\t\t}\n\t\treturn ans;\n\t}\n\tint getnex(int d){\n\t\tint ans=n+1,node=root;\n\t\twhile(node){\n\t\t\tif(dat[node]<d)node=rs(node);\n\t\t\telse ans=min(ans,dat[node]),node=ls(node);\n\t\t}\n\t\treturn ans;\n\t}\t\n}tr;//\u5e73\u8861\u6811\n#undef ls\n#undef rs\n#define ls(x) (x<<1)\n#define rs(x) (x<<1|1)\nstruct Segment_Tree{\n\tint dat[maxn<<2],tag[maxn<<2];\n\tinline void update(int node){\n\t\tdat[node]=dat[ls(node)]+dat[rs(node)];\n\t}\n\tinline void datadown(int l,int r,int node,int d){\n\t\tdat[node]+=(r-l+1)*d;\n\t\ttag[node]+=d;\n\t}\n\tinline void pushdown(int l,int r,int node){\n\t\tint mid=l+r>>1;\n\t\tdatadown(l,mid,ls(node),tag[node]);\n\t\tdatadown(mid+1,r,rs(node),tag[node]);\n\t\ttag[node]=0;\n\t}\n\tvoid add(int L,int R,int l,int r,int node){\n\t\tif(L<=l&&R>=r){\n\t\t\tdat[node]+=r-l+1;\n\t\t\t++tag[node];\n\t\t\treturn;\n\t\t}\n\t\tif(tag[node])pushdown(l,r,node);\n\t\tint mid=l+r>>1;\n\t\tif(L<=mid)add(L,R,l,mid,ls(node));\n\t\tif(R>mid)add(L,R,mid+1,r,rs(node));\n\t\tupdate(node);\n\t}\n\tlong long ask(int L,int R,int l,int r,int node){\n\t\tif(L<=l&&R>=r)return (long long)dat[node];\n\t\tif(tag[node])pushdown(l,r,node);\n\t\tint mid=l+r>>1;\n\t\tlong long ans=0;\n\t\tif(L<=mid)ans=ask(L,R,l,mid,ls(node));\n\t\tif(R>mid)ans+=ask(L,R,mid+1,r,rs(node));\n\t\treturn ans;\n\t}\n}st1,st2,st3;//\u7a7a\u95f4\u591f\u5927\u5f00\u4e09\u68f5\u7ebf\u6bb5\u6811QwQ\nKafuu Chino(){\n\tn=read();\n\tint m=read();\n\tlong long p1=read<long long>(),p2=read<long long>();\n\tfor(register int i=1;i<=n;++i){\n\t\ta[i]=read();\n\t\tpos[a[i]]=i;\n\t}\n\tsort(a+1,a+1+n);\n\tfor(register int i=n;i;--i){\n\t\tint L=tr.getpre(pos[a[i]]),R=tr.getnex(pos[a[i]]);\n\t\tll[pos[a[i]]]=L;\n\t\trr[pos[a[i]]]=R;\n\t\tif(L!=-inf)li[L].push_back(pos[a[i]]);\n\t\tif(R!=inf)ri[R].push_back(pos[a[i]]);\n\t\ttr.insert(tr.root,pos[a[i]]);\t\n\t}\n\tfor(register int i=1;i<=m;++i)\n\t\tq[i].l=read(),q[i].r=read(),lq[q[i].l].push_back(i),rq[q[i].r].push_back(i);\n\tfor(register int i=n;i;--i){\n\t\tfor(register int j=0;j<li[i].size();++j){\n\t\t\tif(li[i][j]+1<rr[li[i][j]])st1.add(li[i][j]+1,rr[li[i][j]]-1,0,n+1,1);\n\t\t\tst3.add(rr[li[i][j]],n+1,0,n+1,1);\n\t\t}\n\t\tfor(register int j=0;j<lq[i].size();++j)\n\t\t\tq[lq[i][j]].ans+=st1.ask(i,q[lq[i][j]].r,0,n+1,1)*p2+st3.ask(q[lq[i][j]].r,q[lq[i][j]].r,0,n+1,1)*p1;\n\t}\n\tfor(register int i=1;i<=n;++i){\n\t\tfor(register int j=0;j<ri[i].size();++j)\n\t\t\tif(ll[ri[i][j]]+1<ri[i][j])st2.add(ll[ri[i][j]]+1,ri[i][j]-1,0,n+1,1);\n\t\tfor(register int j=0;j<rq[i].size();++j)\n\t\t\tq[rq[i][j]].ans+=st2.ask(q[rq[i][j]].l,i,0,n+1,1)*p2;\n\t}\n\tfor(register int i=1;i<=m;++i)\n\t\tprintf(\"%d\\n\",q[i].ans+(long long)(q[i].r-q[i].l)*p1);\n}\n\n```\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
        "postTime": 1550405081,
        "uid": 111762,
        "name": "_ctz",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3722 \u3010[AH2017/HNOI2017]\u5f71\u9b54\u3011"
    },
    {
        "content": "\u9996\u5148\u628a\u4e24\u79cd\u8d21\u732e\u6362\u6210\u4eba\u8bdd\uff1a\n\n\u5982\u679c\u5bf9\u4e8e\u4e24\u4e2a\u4f4d\u7f6e$l,r$\n\n\u4ed6\u4eec\u662f\u533a\u95f4$[l,r]$\u4e2d\u7684\u6700\u5927\u503c\u548c\u6b21\u5927\u503c\uff0c\u4ea7\u751f$p1$\u7684\u8d21\u732e\n\u5982\u679c\u6070\u597d\u6709\u4e00\u4e2a\u662f\u6700\u5927\u503c\uff0c\u4ea7\u751f$p2$\u7684\u8d21\u732e\n\n\u90a3\u4e48\uff0c\u5bf9\u4e8e\u5f53\u524d\u4f4d\u7f6e$i$\uff0c\u5047\u8bbe\u5de6/\u53f3\u7b2c\u4e00\u4e2a\u6bd4\u4ed6\u5927\u7684\u4f4d\u7f6e\u662f$l,r$\n\n\u90a3\u4e48\uff0c$(l,r)$\u4ea7\u751f$p1$\u7684\u8d21\u732e\n\n$(l+1..i-1,r),(l,i+1..r-1)$\u4f1a\u4ea7\u751f$p2$\u7684\u8d21\u732e\n\n\n\u53ef\u4ee5\u628a\u4ed6\u5206\u89e3\u4e3a\u4e8c\u7ef4\u5e73\u9762\u5185\u7684\u77e9\u9635\u6c42\u548c\u95ee\u9898\uff0c\u8fd9\u4e2a\u53ef\u4ee5\u7528\u626b\u63cf\u7ebf\u6765\u89e3\u51b3\n\n\u5f53\u7136\uff0c\u4e3b\u8981\u7684\u95ee\u9898\u662f\u600e\u4e48\u8f6c\u6362\u4e3a\u4e8c\u7ef4\u5e73\u9762\u6c42\u77e9\u9635\u548c\u3002\u3002\u3002\n\n\u6211\u4eec\u7b97\u7684\u662f\u5f53\u524d\u52a0\u4e0a\u4e86\u4f4d\u7f6e$i$\u4ee5\u540e\u4ea7\u751f\u7684\u8d21\u732e\n\n\u5982\u679c\u5bf9\u4e8e\u4e00\u4e2a\u8be2\u95ee$L,R$\uff0c$i$\u5728\u5176\u8303\u56f4\u5185\uff0c\u5f53\u7136\u5c31\u8981\u8003\u8651\u5b83\u4ea7\u751f\u7684\u8d21\u732e\n\n\n\u90a3\u4e48\uff0c$i$\u4ea7\u751f\u7684\u8d21\u732e\u662f\u4ec0\u4e48\uff1f\n\n\u5c06\u4e00\u4e2a\u4f4d\u7f6e$i$\u62c6\u5206\u6210$3$\u4e2a\u8d21\u732e\uff1a\n\n\u5f53\u52a0\u5165\u5b8c\u4f4d\u7f6e$R[i]$\u4e4b\u540e\uff0c\u8981\u5bf9\u4e8e$L[i]$\u4ea7\u751f$p1$\u7684\u8d21\u732e\n\n\u5f53\u52a0\u5165\u5b8c\u4f4d\u7f6e$L[i]$\u4e4b\u540e\uff0c\u8981\u5bf9\u4e8e$(i,R[i])$\u7684\u6bcf\u4e2a\u4f4d\u7f6e\u4ea7\u751f$p2$\u7684\u8d21\u732e\n\n\n\n\u5f53\u52a0\u5165\u5b8c\u4f4d\u7f6e$R[i]$\u4e4b\u540e\uff0c\u8981\u5bf9\u4e8e$(L[i],i)$\u7684\u6bcf\u4e2a\u4f4d\u7f6e\u4ea7\u751f$p2$\u7684\u8d21\u732e\n\n\u90a3\u4e48\uff0c\u4e00\u4e2a\u8be2\u95ee$L,R$\uff0c\u53ea\u8981\u8003\u8651\u5b83\u8303\u56f4\u5185\u7684\u8d21\u732e\n\n\u56e0\u6b64\u62c6\u5206\u6210\u4e09\u90e8\u5206\n\n\u52a0\u5165\u5b8c$L-1$\u4f4d\u7f6e\u4e4b\u540e\uff0c\u8981\u5ffd\u7565\u6389\u524d\u9762\u6240\u6709$L,R$\u4f4d\u7f6e\u4ea7\u751f\u7684\u8d21\u732e\n\n\u52a0\u5165\u5b8c$R$\u4f4d\u7f6e\u4e4b\u540e\uff0c\u8981\u8003\u8651\u6240\u6709\u7684$L,R$\u4f4d\u7f6e\u4ea7\u751f\u7684\u8d21\u732e\n\u989d\u5916\u8003\u8651\u6bcf\u4e00\u7ec4\u8303\u56f4\u5185\u7684\uff0c$(i,i+1)$\u4ea7\u751f\u7684\u8d21\u732e$p1$\n\n\u8fd9\u6837\u5b50\uff0c\u626b\u63cf\u7ebf+\u533a\u95f4\u52a0\u6cd5+\u533a\u95f4\u6c42\u548c\u5373\u53ef\n\n\u53ef\u4ee5\u7528\u5355\u8c03\u6808+\u6811\u72b6\u6570\u7ec4\u5b9e\u73b0\u3002\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<cstdlib>\n#include<cstring>\n#include<cmath>\n#include<algorithm>\n#include<set>\n#include<map>\n#include<vector>\n#include<queue>\nusing namespace std;\n#define ll long long\n#define RG register\n#define MAX 222222\ninline int read()\n{\n    RG int x=0,t=1;RG char ch=getchar();\n    while((ch<'0'||ch>'9')&&ch!='-')ch=getchar();\n    if(ch=='-')t=-1,ch=getchar();\n    while(ch<='9'&&ch>='0')x=x*10+ch-48,ch=getchar();\n    return x*t;\n}\nint L[MAX],R[MAX];\nint a[MAX],n,m,p1,p2;\nint S[MAX],top,cnt,tot;\nstruct Line{int x,l,r,v;}p[MAX<<2];\nbool operator<(Line a,Line b){return a.x<b.x;}\nstruct query{int x,l,r,v,id;}q[MAX<<2];\nbool operator<(query a,query b){return a.x<b.x;}\nll c1[MAX],c2[MAX],ans[MAX];\nvoid Modify(int x,int w)\n{\n\tfor(int i=x;i<=n;i+=i&(-i))\n\t\tc1[i]+=w,c2[i]+=x*w;\n}\nll Query(int x)\n{\n\tll ret=0;\n\tfor(int i=x;i;i-=i&(-i))\n\t\tret+=(x+1)*c1[i]-c2[i];\n\treturn ret;\n}\nint main()\n{\n\tn=read();m=read();p1=read();p2=read();\n\tfor(int i=1;i<=n;++i)a[i]=read();\n\tS[top=0]=0;\n\tfor(int i=1;i<=n;++i)\n\t{\n\t\twhile(top&&a[S[top]]<a[i])--top;\n\t\tL[i]=S[top];S[++top]=i;\n\t}\n\tS[top=0]=n+1;\n\tfor(int i=n;i>=1;--i)\n\t{\n\t\twhile(top&&a[S[top]]<a[i])--top;\n\t\tR[i]=S[top];S[++top]=i;\n\t}\n\tfor(int i=1;i<=m;++i)\n\t{\n\t\tint l=read(),r=read();ans[i]=(r-l)*p1;\n\t\tq[++cnt]=(query){r,l,r,1,i};\n\t\tq[++cnt]=(query){l-1,l,r,-1,i};\n\t}\n\tsort(&q[1],&q[cnt+1]);\n\tfor(int i=1;i<=n;++i)\n\t{\n\t\tif(L[i]&&R[i]<n+1)p[++tot]=(Line){R[i],L[i],L[i],p1};\n\t\tif(L[i]&&R[i]>i+1)p[++tot]=(Line){L[i],i+1,R[i]-1,p2};\n\t\tif(L[i]+1<i&&R[i]<n+1)p[++tot]=(Line){R[i],L[i]+1,i-1,p2};\n\t}\n\tsort(&p[1],&p[tot+1]);\n\tfor(int i=1,j=1;i<=cnt;++i)\n\t{\n\t\twhile(j<=tot&&p[j].x<=q[i].x)\n\t\t{\n\t\t\tModify(p[j].l,p[j].v);\n\t\t\tModify(p[j].r+1,-p[j].v);\n\t\t\t++j;\n\t\t}\n\t\tans[q[i].id]+=q[i].v*(Query(q[i].r)-Query(q[i].l-1));\n\t}\n\tfor(int i=1;i<=m;++i)printf(\"%lld\\n\",ans[i]);\n\treturn 0;\n}\n\n```\n\n",
        "postTime": 1522593233,
        "uid": 21283,
        "name": "yybyyb",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P3722 \u3010[AH2017/HNOI2017]\u5f71\u9b54\u3011"
    },
    {
        "content": "\u672c\u9898\u53ef\u4ee5\u91c7\u7528\u4e3b\u5e2d\u6811\u7684\u5728\u7ebf\u505a\u6cd5\uff0c\u53ea\u4e0d\u8fc7\u5e38\u6570\u4f1a $super$ \u5927\u3002\n\n\u548c\u5176\u4ed6\u9898\u89e3\u5dee\u4e0d\u591a\uff0c\u6211\u4eec\u5148\u8981\u6c42\u51fa\u7b2c $i$ \u4e2a\u6570\u7684 $l_i$ \u548c $r_i$ \uff0c\u5176\u4e2d $l_i$ \u8868\u793a\u5de6\u8fb9\u7b2c\u4e00\u4e2a\u6bd4\u5b83\u5927\u7684\u70b9(\u82e5\u6ca1\u6709\u5219\u4e3a $0$ )\uff0c $r_i$ \u8868\u793a\u53f3\u8fb9\u6bd4\u5b83\u5927\u7684\u7b2c\u4e00\u4e2a\u70b9\uff0c\u82e5\u6ca1\u6709\u5219\u4e3a $n+1$ \u3002\n\n\u90a3\u4e48\u5bf9\u4e8e $i$   \n1. \u70b9\u5bf9 $(l_i,r_i)$ \u53ef\u4ee5\u6709 $p_1$ \u7684\u8d21\u732e  \n\n2. \u70b9\u5bf9 $([l_i+1,i-1],r_i),(l_i,[i+1,r_i-1])$ \u53ef\u4ee5\u6709 $p_2$ \u7684\u8d21\u732e $(l_i+1<i-1),(i+1<r_i-1)$  \n\n3. $(i,i+1)$ \u4e5f\u53ef\u4ee5\u6709 $p_1$ \u7684\u8d21\u732e\n\n\u6709\u4e86\u8fd9\u4e48\u51e0\u70b9\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u62ff\u4e3b\u5e2d\u6811\u6765\u7ef4\u62a4\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u70b9\u5bf9\uff0c\u6211\u4eec\u4ee5 $x$ \u66f4\u65b0\uff0c\u82e5 $x$ \u4e3a\u533a\u95f4\uff0c\u5219\u4ee5 $y$ \u66f4\u65b0\u3002\n\n\u7528\u4e00\u4e2a\u5355\u8c03\u6808\u9884\u5904\u7406\uff0c\u94fe\u8868\uff08\u6216 $vector$ \u5b58\u50a8\u66f4\u65b0\u4fe1\u606f\uff09\u3002\n\n$AC \\kern 0.4emCODE$:\n```cpp\n#include<bits/stdc++.h>\n#define ri register int\n#define p(i) ++i\n#define LL long long\nusing namespace std;\nconst int N=2e5+7;\ninline int read() {\n\tint x=0,f=1;char ch=getchar();\n\twhile(ch<'0'||ch>'9'){if (ch=='-') f=-1;ch=getchar();}\n\twhile(ch>='0'&&ch<='9'){x=(x<<1)+(x<<3)+(ch^48);ch=getchar();}\n\treturn x*f;\n}\nstruct node{\n\tint l,r,w;\n\tnode(){}\n\tnode(int l,int r,int w):l(l),r(r),w(w){}\n};\nstruct E{\n\tint first[N],t;\n\tvoid init() {t=1;}\n\tstruct edge{\n\t\tint nxt;\n\t\tnode v;\n\t}e[N<<2];\n\tinline void add(int u,node v) {\n\t\te[t].v=v;\n\t\te[t].nxt=first[u];\n\t\tfirst[u]=t++;\n\t} \n}E;\nstruct Seg{\n\tint root[N],tot;\n\tstruct Segmenttree{\n\t\tint l,r;\n\t\tLL sum,tag;\n\t}T[N*32];\n\tinline void update(int &x,int l,int r,int lt,int rt,int w) {\n\t\tif (!x) x=p(tot);\n\t\tT[x].sum+=1ll*(min(r,rt)-max(l,lt)+1)*w;\n\t\tif (l<=lt&&rt<=r) {T[x].tag+=1ll*w;return;}\n\t\tint mid=(lt+rt)>>1;\n\t\tif (l<=mid) update(T[x].l,l,r,lt,mid,w);\n\t\tif (r>mid) update(T[x].r,l,r,mid+1,rt,w);\n\t}\n\tinline int merge(int x,int y) {\n\t\tif (!x||!y) return x+y;\n\t\tT[x].sum+=T[y].sum;T[x].tag+=T[y].tag;\n\t\tT[x].l=merge(T[x].l,T[y].l);\n\t\tT[x].r=merge(T[x].r,T[y].r);\n\t\treturn x;\n\t}\n\tinline LL query(int x,int l,int r,int lt,int rt) {\n\t\tif (!x) return 0;\n\t\tif (l<=lt&&rt<=r) return T[x].sum;\n\t\tint mid=(lt+rt)>>1;LL res=0;\n\t\tif (l<=mid) res+=query(T[x].l,l,r,lt,mid);\n\t\tif (r>mid) res+=query(T[x].r,l,r,mid+1,rt);\n\t\treturn res+1ll*(min(r,rt)-max(l,lt)+1)*T[x].tag;\n\t}\n}T;\nint n,st[N],p,pp,at[N],ll[N],rr[N],m;\nint main() {\n\tn=read(),m=read(),p=read(),pp=read();\n\tconst int p1=p,p2=pp;\n\tint tp=0;\n\tfor (ri i(1);i<=n;p(i)) {\n\t\tat[i]=read();\n\t\twhile(tp&&at[st[tp]]<at[i]) rr[st[tp--]]=i;\n\t\tll[i]=st[tp];\n\t\tst[p(tp)]=i;\n\t}\n\twhile(tp) rr[st[tp--]]=n+1;\n\tE.init();\n\tfor (ri i(1);i<=n;p(i)) {\n\t\tif (i!=n) E.add(i,node(i+1,i+1,p1));\n\t\tif (ll[i]&&rr[i]<=n) E.add(ll[i],node(rr[i],rr[i],p1));\n\t\tif (ll[i]&&i+1<=rr[i]-1) E.add(ll[i],node(i+1,rr[i]-1,p2));\n\t\tif (rr[i]<=n&&ll[i]+1<=i-1) E.add(rr[i],node(ll[i]+1,i-1,p2));\n\t}\n\tfor (ri i(1);i<=n;p(i)) {\n\t\tfor (ri j(E.first[i]);j;j=E.e[j].nxt) {\n\t\t\tnode v=E.e[j].v;\n\t\t\tint l=v.l,r=v.r,w=v.w;\n\t\t\tT.update(T.root[i],l,r,1,n,w);\n\t\t}\n\t\tT.root[i]=T.merge(T.root[i],T.root[i-1]);\n\t}\n\tfor (ri i(1);i<=m;p(i)) {\n\t\tint l=read(),r=read();\n\t\tprintf(\"%lld\\n\",T.query(T.root[r],l,r,1,n)-T.query(T.root[l-1],l,r,1,n));\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1617955283,
        "uid": 141958,
        "name": "\u6960\u67ab",
        "ccfLevel": 6,
        "title": "P3722 [AH2017/HNOI2017]\u5f71\u9b54 \u9898\u89e3"
    },
    {
        "content": "\u63a8\u5e7f\u4e00\u53d1[\u8001K\u7684\u535a\u5ba2](https://cnyali-lk.com)\n\n\u6211\u4eec\u5148\u4e0d\u8003\u8651p1\uff0c\u8003\u8651\u4e00\u4e2a\u70b9\u5bf9\u5982\u679c\u6709\u4efb\u610f\u4e00\u4e2a\u70b9\u7684\u6743\u503c\u5927\u4e8e\u4e4b\u95f4\u7684\u6240\u6709\u70b9\u6743\uff0c\u90a3\u4e48\u5c31\u6709p2\u7684\u8d21\u732e\u3002\n\n\u90a3\u4e48p1\u4f1a\u7b97\u4e3a2\u4e2ap2.\n\n\n\u600e\u4e48\u679a\u4e3e\u5462\uff1f\n\n\u5148\u8003\u8651\u5355\u4fa7\uff0c\u53e6\u4e00\u4fa7\u53cd\u8fc7\u6765\u5373\u53ef\u3002\n\n\u7528\u5355\u8c03\u6808\u8bb0\u5f55\u6bcf\u4e2a\u70b9x\u540e\u9762\u7b2c\u4e00\u4e2a\u6bd4\u5b83\u5927\u7684z\u3002\n\n\u90a3\u4e48$x<y\\le z$\u7684\u6240\u6709y\u90fd\u6ee1\u8db3(x,y)\u6709p2\u7684\u8d21\u732e\uff08\u663e\u7136\uff09\n\n~~\u7136\u540e\u8fd9\u6837\u5c31\u5b8c\u4e86~~\u4f60\u6210\u529f\u7684\u83b7\u5f97\u4e8630\u5206\u4e5f\u5c31\u662fp1=2p2\u7684\u90e8\u5206\u3002\n\n\u7531\u4e8e\u70b9\u6743\u7ec4\u6210\u4e86\u6392\u5217\uff0c\u4e0d\u5b58\u5728\u67092\u4e2a\u70b9\u70b9\u6743\u76f8\u7b49\u3002\n\n\u90a3\u4e48\u5bf9\u4e8ep1\u7684\u8d21\u732e\uff0c\u663e\u7136\u53ea\u53ef\u80fd\u4e00\u8fb9\u662f\u6700\u5927\u503c\u4e00\u8fb9\u662f\u6b21\u5927\u503c\u3002\n\n\u90a3\u4e48\u6211\u4eec\u5728\u4e0a\u9762\u627e\u5230z\u7684\u65f6\u5019\uff0c\u663e\u7136$(x,z)$\u70b9\u5bf9\u7684\u8d21\u732e\u5e94\u8be5\u662fp1\uff0c\u4f46\u662f\u4f1a\u88ab\u7b97\u4e3a2p2\uff0c\u90a3\u4e48\u76f4\u63a5\u52a0\u4e0a$p1-2p2$\u7684\u8d21\u732e\u5373\u53ef\u3002\n\n\u5177\u4f53\u600e\u4e48\u7b97\u5462\uff1f\n\n\u5148\u628a\u8be2\u95ee\u6309\u7167\u5de6\u7aef\u70b9\u6392\u5e8f\u3002\n\n\u679a\u4e3ex\u4ecen\u52301\uff0c\u7136\u540e\u627e\u5230z\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u70b9\u5bf9(x,y)\u7684\u8d21\u732e\uff0c\u76f4\u63a5\u52a0\u5728y\u4e0a\u3002\u7136\u540e\u5bf9\u4e8e\u6240\u6709\u5de6\u7aef\u70b9\u4e3ax\u7684\u8be2\u95ee\uff0c\u76f4\u63a5\u6c42l\u5230r\u7684\u8d21\u732e\u548c\u5373\u53ef\u3002\n\n```C++\n/*\nAuthor: CNYALI_LK\nLANG: C++\nPROG: 3722.cpp\nMail: cnyalilk@vip.qq.com\n*/\n#include<bits/stdc++.h>\n#define debug(...) fprintf(stderr,__VA_ARGS__)\n#define DEBUG printf(\"Passing [%s] in LINE %lld\\n\",__FUNCTION__,__LINE__)\n#define Debug debug(\"Passing [%s] in LINE %lld\\n\",__FUNCTION__,__LINE__)\n#define all(x) x.begin(),x.end()\nusing namespace std;\nconst double eps=1e-8;\nconst double pi=acos(-1.0);\ntypedef long long ll;\ntypedef pair<ll,ll> pii;\ntemplate<class T>ll chkmin(T &a,T b){return a>b?a=b,1:0;}\ntemplate<class T>ll chkmax(T &a,T b){return a<b?a=b,1:0;}\ntemplate<class T>T sqr(T a){return a*a;}\ntemplate<class T>T mmin(T a,T b){return a<b?a:b;}\ntemplate<class T>T mmax(T a,T b){return a>b?a:b;}\ntemplate<class T>T aabs(T a){return a<0?-a:a;}\n#define min mmin\n#define max mmax\n#define abs aabs\nll read(){\n    ll s=0,base=1;\n    char c;\n    while(!isdigit(c=getchar()))if(c=='-')base=-base;\n    while(isdigit(c)){s=s*10+(c^48);c=getchar();}\n    return s*base;\n}\nchar WritellBuffer[1024];\ntemplate<class T>void write(T a,char end){\n    ll cnt=0,fu=1;\n    if(a<0){putchar('-');fu=-1;}\n    do{WritellBuffer[++cnt]=fu*(a%10)+'0';a/=10;}while(a);\n    while(cnt){putchar(WritellBuffer[cnt]);--cnt;}\n    putchar(end);\n}\nstruct _ask{\n    ll t,l,r;\n    _ask(){}\n    _ask(ll _t){\n        t=_t;\n        l=read();r=read();\n    }\n};\n_ask ask[204847];\n\nll n,m,p1,p2;\nll a[204847];\nstruct smt{\n    smt *l,*r;\n    ll _l,_r,sum,add;\n#define push_up sum=l->sum+r->sum\n    smt(ll ls,ll rs){\n        _l=ls;_r=rs;\n        sum=add=0;\n        if(ls!=rs){\n            ll mid=(ls+rs)>>1;\n            l=new smt(ls,mid);\n            r=new smt(mid+1,rs);\n        }\n    }\n    void put_tag(ll w){\n        sum+=w*(_r-_l+1);\n        add+=w;\n    }\n    void push_down(){\n        l->put_tag(add);\n        r->put_tag(add);\n        add=0;\n    }\n    void change(ll ls,ll rs,ll w){\n        if(ls<=_l&&_r<=rs)put_tag(w);\n        else{\n            push_down();\n            if(ls<=l->_r)l->change(ls,rs,w);\n            if(rs>=r->_l)r->change(ls,rs,w);\n            push_up;\n        }\n    }\n    ll query(ll ls,ll rs){\n        if(ls<=_l&&_r<=rs)return sum;\n        else{\n            push_down();\n            ll ans=0;\n            if(ls<=l->_r)ans+=l->query(ls,rs);\n            if(rs>=r->_l)ans+=r->query(ls,rs);\n            return ans;\n        }\n    }\n};\nll nx[204847],ans[204847];\nvoid calc(){\n    sort(ask+1,ask+m+1,[](_ask a,_ask b){return a.l<b.l;});\n    stack<ll> stk;\n    stk.push(n+1);\n    smt *r=new smt(1,n+1);\n    ll j=m;\n    for(ll i=n;i;--i){\n        while(a[stk.top()]<a[i])stk.pop();\n        nx[i]=stk.top();\n        stk.push(i);\n        r->change(i+1,nx[i],p2);\n        r->change(nx[i],nx[i],p1-2*p2);\n        while(ask[j].l==i){\n            ans[ask[j].t]+=r->query(ask[j].l,ask[j].r);\n            --j;\n        }\n    }\n}\nint main(){\n#ifdef cnyali_lk\n    freopen(\"3722.in\",\"r\",stdin);\n    freopen(\"3722.out\",\"w\",stdout);\n#endif\n    n=read();\n    m=read();p1=read();p2=read();\n    for(ll i=1;i<=n;++i)a[i]=read();\n    a[n+1]=n+1;\n    for(ll i=1;i<=m;++i){\n         ask[i]=_ask(i);\n    }\n    calc();\n    reverse(a+1,a+n+1);\n    for(ll i=1;i<=m;++i){ask[i].l=n+1-ask[i].l;ask[i].r=n+1-ask[i].r;swap(ask[i].l,ask[i].r);}\n    calc();\n    for(ll i=1;i<=m;++i)write(ans[i],'\\n');\n    return 0;\n}\n\n\n```\n\n\n\n\n\n",
        "postTime": 1522921974,
        "uid": 8943,
        "name": "\u8001K",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3722 \u3010[AH2017/HNOI2017]\u5f71\u9b54\u3011"
    },
    {
        "content": "\u9996\u5148\u6574\u4e2a\u5e8f\u5217\u662f\u4e00\u4e2a\u6392\u5217\uff0c\u8fd9\u662f\u4e00\u4e2a\u5f88\u91cd\u8981\u7684\u6027\u8d28\n\n\u8003\u8651$(i,j)$\u4ec0\u4e48\u65f6\u5019\u4f1a\u4ea7\u751f\u8d21\u732e\uff1a\n\n1. \u5f53$k_i,k_j$\u4e3a\u533a\u95f4$(i,j)$\u7684\u6700\u5927\u503c\u548c\u6b21\u5927\u503c\uff0c\u8d21\u732e\u4e3a$p1$\n2. \u5f53$k_i,k_j$\u5176\u4e2d\u4e00\u4e2a\u4e3a\u533a\u95f4\u6700\u5927\u503c\uff0c\u53e6\u4e00\u4e2a\u4e0d\u662f\u6b21\u5927\u503c\uff0c\u8d21\u732e\u4e3a$p2$\n\n\u7ef4\u62a4\u51fa\u6bcf\u4e2a$i$\u4f4d\u7f6e\u5de6\u8fb9\u53f3\u8fb9\u7b2c\u4e00\u4e2a\u6bd4\u5b83\u5927\u7684\u4f4d\u7f6e\uff0c\u8bb0\u4f5c$L_i,R_i$\uff0c\u8fd9\u4e2a\u53ef\u4ee5\u7528\u5355\u8c03\u6808\u6c42\u3002\u4e8e\u662f$(L_i,R_i)$\uff0c$(i,i+1)$\u7684\u8d21\u732e\u4e3a$p1$\uff0c$(L_i+1...i-1,R_i)$\uff0c$(L_i,i+1...R_i-1)$\u7684\u8d21\u732e\u4e3a$p2$\n\n\u53ef\u4ee5\u53d1\u73b0\u5982\u679c\u6709$(p,q)$\u6ee1\u8db3$p<L_i,q>R_i$\uff0c$(p,q)$\u5982\u679c\u6709\u8d21\u732e\uff0c\u5219\u4f1a\u7b97\u5728\u53e6\u4e00\u4e2a$i$\u4e0a\uff0c\u6240\u4ee5\u4e0d\u4f1a\u7b97\u91cd\n\n\u5bf9\u4e8e$(i,i+1)$\uff0c\u76f4\u63a5\u6839\u636e\u8be2\u95ee\u533a\u95f4\u957f\u5ea6\u7b97\u8d21\u732e\n\n\u5bf9\u4e8e$(L_i,R_i)$\uff0c\u6211\u4eec\u5728\u679a\u4e3e\u5230$R_i$\u65f6\u5728$L_i$\u4e0a\u52a0\u4e0a\u8d21\u732e\n\n\u5bf9\u4e8e$(L_i+1...i-1,R_i)$\uff0c\u6211\u4eec\u5728\u679a\u4e3e\u5230$R_i$\u65f6\u5728$L_i+1...i-1$\u8fd9\u6bb5\u533a\u95f4\u52a0\u4e0a\u8d21\u732e\n\n\u5bf9\u4e8e$(L_i,i+1...R_i)$\uff0c\u540c\u4e0a\u4e00\u6761\n\n\u56de\u7b54\u4e00\u4e2a\u8be2\u95ee$[a,b]$\u65f6\uff0c\u5982\u679c\u5728\u679a\u4e3e\u5230$b$\u65f6\u76f4\u63a5\u6c42$[a,b]$\u7684\u533a\u95f4\u548c\uff0c\u4f1a\u5b58\u5728\u4e00\u4e9b$(i,j)$\u6ee1\u8db3$i<a,a<j<b$\u7684\u4e0d\u5408\u6cd5\u7684\u8d21\u732e\u3002\u6240\u4ee5\u6211\u4eec\u9700\u8981\u51cf\u53bb\u679a\u4e3e\u5230$a-1$\u65f6$[a,b]$\u7684\u533a\u95f4\u548c\uff0c\u8fd9\u6837\u6709\u8d21\u732e\u7684$(i,j)$\u5c31\u90fd\u5728\u533a\u95f4\u5185\n\n$Code\\ Below:$\n```cpp\n#include<bits/stdc++.h>\n#define ts cout<<\"ok\"<<endl\n#define int long long\n#define hh puts(\"\")\n#define pc putchar\n#define ls(x) ((x)<<1)\n#define rs(x) ((x)<<1|1)\n//#define getchar() (p1==p2&&(p2=(p1=buf)+fread(buf,1,1<<21,stdin),p1==p2)?EOF:*p1++)\n//char buf[1<<21],*p1=buf,*p2=buf;\nusing namespace std;\nconst int N=200005;\nint n,m,p1,p2,a[N],st[N],top,L[N],R[N],cnt,tot;\nint tr[N<<2],tag[N<<2],ans[N];\nstruct que{\n\tint x,l,r,v,id;\n\tfriend bool operator < (que A,que B){\n\t\treturn A.x<B.x;\n\t}\n}q[N<<1];\nstruct ope{\n\tint x,l,r,v;\n\tfriend bool operator < (ope A,ope B){\n\t\treturn A.x<B.x;\n\t}\n}op[N<<2];\ninline int read(){\n    int ret=0,ff=1;char ch=getchar();\n    while(!isdigit(ch)){if(ch=='-') ff=-1;ch=getchar();}\n    while(isdigit(ch)){ret=ret*10+(ch^48);ch=getchar();}\n    return ret*ff;\n}\nvoid write(int x){if(x<0){x=-x,pc('-');}if(x>9) write(x/10);pc(x%10+48);}\nvoid writeln(int x){write(x),hh;}\nvoid writesp(int x){write(x),pc(' ');}\nvoid push_down(int l,int r,int k){\n\tint mid=(l+r)>>1;\n\ttag[ls(k)]+=tag[k];\n\ttag[rs(k)]+=tag[k];\n\ttr[ls(k)]+=tag[k]*(mid-l+1);\n\ttr[rs(k)]+=tag[k]*(r-mid);\n\ttag[k]=0;\n}\nvoid update(int l,int r,int x,int y,int v,int k){\n\tif(x<=l&&r<=y){\n\t\ttr[k]+=(r-l+1)*v;\n\t\ttag[k]+=v;\n\t\treturn;\n\t}\n\tpush_down(l,r,k);\n\tint mid=(l+r)>>1;\n\tif(x<=mid) update(l,mid,x,y,v,ls(k));\n\tif(mid+1<=y) update(mid+1,r,x,y,v,rs(k));\n\ttr[k]=tr[ls(k)]+tr[rs(k)];\n}\nint query(int l,int r,int x,int y,int k){\n\tif(x<=l&&r<=y) return tr[k];\n\tpush_down(l,r,k);\n\tint mid=(l+r)>>1,res=0;\n\tif(x<=mid) res+=query(l,mid,x,y,ls(k));\n\tif(mid+1<=y) res+=query(mid+1,r,x,y,rs(k));\n\treturn res;\n}\nsigned main(){\n\tn=read(),m=read(),p1=read(),p2=read();\n\tfor(int i=1;i<=n;i++) a[i]=read();\n\tst[top=0]=0;\n\tfor(int i=1;i<=n;i++){\n\t\twhile(top&&a[i]>a[st[top]]) top--;\n\t\tL[i]=st[top];st[++top]=i;\n\t}\n\tst[top=0]=n+1;\n\tfor(int i=n;i>=1;i--){\n\t\twhile(top&&a[i]>a[st[top]]) top--;\n\t\tR[i]=st[top];st[++top]=i;\n\t}\n\tfor(int i=1;i<=m;i++){\n\t\tint l=read(),r=read();ans[i]=(r-l)*p1;//(i,i+1)\u7684\u8d21\u732e \n\t\tq[++cnt]=(que){l-1,l,r,-1,i};\n\t\tq[++cnt]=(que){r,l,r,1,i};\n\t}\n\tsort(q+1,q+cnt+1);\n\tfor(int i=1;i<=n;i++){\n\t\tif(L[i]>=1&&R[i]<=n) op[++tot]=(ope){R[i],L[i],L[i],p1};\n\t\tif(L[i]>=1&&R[i]-1>=i+1) op[++tot]=(ope){L[i],i+1,R[i]-1,p2};\n\t\tif(L[i]+1<=i-1&&R[i]<=n) op[++tot]=(ope){R[i],L[i]+1,i-1,p2};\n\t}\n\tsort(op+1,op+tot+1);\n\tfor(int i=1,j=1;i<=cnt;i++){\n\t\twhile(j<=tot&&op[j].x<=q[i].x){\n\t\t\tupdate(1,n,op[j].l,op[j].r,op[j].v,1);\n\t\t\tj++;\n\t\t}\n\t\tans[q[i].id]+=q[i].v*query(1,n,q[i].l,q[i].r,1);\n\t}\n\tfor(int i=1;i<=m;i++) writeln(ans[i]);\n    return 0;\n}\n```\n",
        "postTime": 1591419494,
        "uid": 27858,
        "name": "ycyaw",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P3722 \u3010[AH2017/HNOI2017]\u5f71\u9b54\u3011"
    },
    {
        "content": "\u8bbe$l[i]$\u4e3ai\u5de6\u8fb9\u7b2c\u4e00\u4e2a\u6bd4i\u5927\u7684\u6570\u7684\u4e0b\u6807\u3002$r[i]$\u4e3ai\u53f3\u8fb9\u7b2c\u4e00\u4e2a\u6bd4i\u5927\u7684\u6570\u7684\u4e0b\u6807\u3002  \n\u6211\u4eec\u628a$p1,p2$\u5206\u5f00\u8003\u8651\u3002  \n\u5f53\u4ea7\u751f\u8d21\u732e\u4e3a$p1$\u65f6$i$\u548c$j$\u4e00\u5b9a\u6ee1\u8db3\uff0c\u5206\u522b\u4e3a$l[x],r[x]$\u679a\u4e3e\u6bcf\u4e00\u4e2a\u503c\u4e3a$i$\uff0c$j$\u4e4b\u95f4\u6700\u5927\u503c\u53ef\u8bc1\u3002  \n\u515a\u4ea7\u751f\u8d21\u732e\u4e3a$p2$\u65f6$i$\u548c$j$\u6ee1\u8db3\u5206\u522b\u4e3a$l[x],[x+1,r[x]-1]$\u6216$[l[x]+1,x-1],r[x]$\uff0c\u6b64\u65f6$a[x]$\u4e3a$i$\uff0c$j$\u4e4b\u95f4\u6700\u5927\u503c\uff0c$i$\uff0c$j$\u4e00\u4e2a\u6bd4$a[x]$\u5927\uff0c\u4e00\u4e2a\u6bd4$a[x]$\u5c0f\u3002  \n\u7136\u540e\u5c31\u628a\u95ee\u9898\u8f6c\u5316\u4e3a\u4e8c\u7ef4\u6570\u70b9\u95ee\u9898\u3002\u4ea7\u751f\u8d21\u732e\u7684\u70b9\u5bf9\u5bf9\u5e94\u5750\u6807\u7cfb\u4e2d\u7684\u4e00\u4e2a\u70b9\uff08\u4e3a\u4e86\u907f\u514d\u91cd\u590d\u8ba1\u6570\u5982$(r[x],l[x])$\u548c$(l[x],r[x])$\uff0c\u53ef\u4ee5\u628a\u5c0f\u7684\u4f5c\u4e3a\u6a2a\u5750\u6807\uff0c\u5927\u7684\u4f5c\u4e3a\u7eb5\u5750\u6807\uff09\u3002\u7136\u540e\u6211\u4eec\u6bcf\u4e00\u6b21\u8be2\u95ee\u5c31\u662f\u6a2a\u5750\u6807\u5728$[l,r]$\u4e4b\u95f4\uff0c\u7eb5\u5750\u6807\u5728$[l,r]$\u4e4b\u95f4\u7684\u6743\u503c\u548c\u3002  \n\u7136\u540e\u5c31\u53ef\u4ee5\u7528\u4e3b\u5e2d\u6811\u505a\u4e86\u3002\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<cmath>\n#include<algorithm>\n#include<cstring>\n#include<vector>\nusing namespace std;\n#define int long long\nconst int N=201000; \nstruct line{ int l,r,w; }; \nvector<line> vec[N]; \nint tot,root[N],lazy[N*70],ch[N*70][2],sum[N*70]; \nint n,m,p1,p2,a[N],stack[N],top,l[N],r[N]; \nvoid add(int l,int r,int L,int R,int w,int pre,int &now){ \n\tnow=++tot;\n\tch[now][0]=ch[pre][0]; \n\tch[now][1]=ch[pre][1]; \n\tlazy[now]=lazy[pre]; \n\tsum[now]=sum[pre]+(R-L+1)*w; \n\tif(l==L&&r==R){ \n\t\tlazy[now]+=w; \n\t\treturn; \n\t} \n\tint mid=(l+r)>>1; \n\tif(L>mid)add(mid+1,r,L,R,w,ch[pre][1],ch[now][1]); \n\telse if(R<=mid)add(l,mid,L,R,w,ch[pre][0],ch[now][0]); \n\telse{ \n\t\tadd(l,mid,L,mid,w,ch[pre][0],ch[now][0]); \n\t\tadd(mid+1,r,mid+1,R,w,ch[pre][1],ch[now][1]); \n\t} \n} \nint check(int l,int r,int L,int R,int pre,int now){ \n\tif(l==L&&r==R)return sum[now]-sum[pre]; \n\tint mid=(l+r)>>1; \n\tif(L>mid)return (lazy[now]-lazy[pre])*(R-L+1)+check(mid+1,r,L,R,ch[pre][1],ch[now][1]);\n    else if(R<=mid)return (lazy[now]-lazy[pre])*(R-L+1)+check(l,mid,L,R,ch[pre][0],ch[now][0]); \n\telse return (lazy[now]-lazy[pre])*(R-L+1) \n\t+check(l,mid,L,mid,ch[pre][0],ch[now][0]) \n\t+check(mid+1,r,mid+1,R,ch[pre][1],ch[now][1]);\n} \nint read(){ \n\tint sum=0,f=1;char ch=getchar(); \n\twhile(ch<'0'||ch>'9'){if(ch=='-')f=-1;ch=getchar();} \n\twhile(ch>='0'&&ch<='9'){sum=sum*10+ch-'0';ch=getchar();} \n\treturn sum*f; \n} \nsigned main(){ \n\tn=read(),m=read(),p1=read(),p2=read(); \n\tfor(int i=1;i<=n;i++)a[i]=read(); \n\tfor(int i=1;i<=n;i++){ \n\t\twhile(a[i]>a[stack[top]]&&top)r[stack[top--]]=i; \n\t\tstack[++top]=i; \n\t} \n\twhile(top)r[stack[top--]]=n+1; \n\tfor(int i=n;i>=1;i--){ \n\t\twhile(a[i]>a[stack[top]]&&top)l[stack[top--]]=i; \n\t\tstack[++top]=i; \n\t} \n\twhile(top)l[stack[top--]]=0; \n\tfor(int i=1;i<=n;i++){\n\t\tline x; \n\t\tif(i!=n&&i+1<=r[i]-1){ \n\t\t\tx.l=i+1;x.r=r[i]-1;x.w=p2; \n\t\t\tvec[l[i]].push_back(x); \n\t\t} \n\t\tif(l[i]+1<=i-1&&i!=1){ \n\t\t\tx.l=l[i]+1;x.r=i-1;x.w=p2; \n\t\t\tvec[r[i]].push_back(x); \n\t\t} \n\t\tx.l=i;x.r=i;x.w=p1; \n\t\tvec[l[i]].push_back(x);\n\t\tvec[r[i]].push_back(x);\n\t} \n\tfor(int i=1;i<=n;i++){ \n\t\troot[i]=root[i-1]; \n\t\tfor(int j=0;j<vec[i].size();j++)\n\t\t\tadd(1,n,vec[i][j].l,vec[i][j].r,vec[i][j].w,root[i],root[i]);\n\t} \n\tfor(int i=1;i<=m;i++){ \n\t\tint l=read(),r=read(); \n\t\tprintf(\"%lld\\n\",check(1,n,l,r,root[l-1],root[r])); \n\t} \n\treturn 0; \n}\n```",
        "postTime": 1546216360,
        "uid": 52173,
        "name": "xudaxia",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 P3722 \u3010[AH2017/HNOI2017]\u5f71\u9b54\u3011"
    },
    {
        "content": "\u5b89\u5229\u4e2a\u4eba blog\uff1ahttps://www.cnblogs.com/ET2006/\n\n[\u9898\u9762\u4f20\u9001\u95e8](https://www.luogu.com.cn/problem/P3722)\n\n\u9996\u5148\u6211\u4eec\u628a\u8fd9\u4e24\u4e2a\u8d21\u732e\u7ffb\u8bd1\u6210\u4eba\u8bdd\uff1a\n\n- \u533a\u95f4 $[l,r]$ \u4ea7\u751f $p_1$ \u7684\u8d21\u732e\u5f53\u4e14\u4ec5\u5f53 $a_l,a_r$ \u5206\u522b\u4e3a\u533a\u95f4 $[l,r]$ \u7684\u6700\u5927\u503c\u548c\u6b21\u5927\u503c\u3002\n- \u533a\u95f4 $[l,r]$ \u4ea7\u751f $p_2$ \u7684\u8d21\u732e\u5f53\u4e14\u4ec5\u5f53 $a_l$ \u4e3a\u533a\u95f4 $[l,r]$ \u7684\u6700\u5927\u503c\u4e14 $a_r$ \u4e0d\u662f\u533a\u95f4 $[l,r]$ \u7684\u6b21\u5927\u503c\uff0c\u6216\u8005 $a_r$ \u4e3a\u533a\u95f4 $[l,r]$ \u7684\u6700\u5927\u503c\u4e14 $a_l$ \u4e0d\u662f\u533a\u95f4 $[l,r]$ \u7684\u6b21\u5927\u503c\u3002\n\n\u6211\u4eec\u8003\u8651\u8f6c\u5316\u8d21\u732e\u4f53\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u533a\u95f4 $[l,r]$ \u5206\u4e24\u79cd\u60c5\u51b5\uff1a\n\n- \u82e5 $r-l=1$\uff0c\u90a3\u4e48\u663e\u7136\u6240\u6709\u8fd9\u6837\u7684\u533a\u95f4\u90fd\u4f1a\u4ea7\u751f $p_1$ \u7684\u8d21\u732e\uff0c\u8fd9\u4e2a\u6211\u4eec\u7279\u5224\u4e00\u4e0b\u5373\u53ef\u3002\n- \u82e5 $r-l\\ge 2$\uff0c\u90a3\u4e48\u663e\u7136\u5bf9\u4e8e\u533a\u95f4 $[l+1,r-1]$ \u6709\u4e00\u4e2a\u552f\u4e00\u7684\u6700\u5927\u503c\uff0c\u8bbe\u5176\u4f4d\u7f6e\u4e3a $i$\uff0c\u4e8e\u662f\u6211\u4eec\u6539\u679a\u4e3e $i$\uff0c\u770b\u770b\u5b83\u4f1a\u5bf9\u54ea\u4e9b\u533a\u95f4\u4ea7\u751f\u8d21\u732e\u3002\n\n\u6211\u4eec\u8bbe $L_i$ \u4e3a\u5728 $i$ \u524d\u9762\u7684\u6700\u9760\u8fd1 $i$ \u7684\u6ee1\u8db3 $a_j>a_i$ \u7684 $j$\uff0c$R_i$ \u4e3a\u5728 $i$ \u540e\u9762\u7684\u6700\u9760\u8fd1 $i$ \u7684\u6ee1\u8db3 $a_j>a_i$ \u7684 $j$\uff0c\u8fd9\u4e2a\u663e\u7136\u53ef\u4ee5\u4e00\u904d\u5355\u8c03\u6808\u6c42\u51fa\uff0c\u7136\u540e\u5206\u60c5\u51b5\u8ba8\u8bba\uff1a\n\n- \u82e5 $i$ \u4e3a\u533a\u95f4 $[l+1,r-1]$ \u7684\u6700\u5927\u503c\uff0c\u4e14\u533a\u95f4 $[l,r]$ \u4ea7\u751f $p_1$ \u7684\u8d21\u732e\uff0c\u90a3\u663e\u7136\u53ea\u80fd\u662f $l=L_i,r=R_i$\uff0c\u56e0\u4e3a\u5982\u679c\u5de6\u7aef\u70b9 $l>L_i$ \u90a3 $a_l$ \u5c31\u4e0d\u662f $[l,r]$ \u7684\u8f83\u5927\u503c\uff08\u6216\u6b21\u5927\u503c\uff09\u4e86\uff08\u56e0\u4e3a $a_l<a_i$\uff09\uff0c\u5982\u679c\u5de6\u7aef\u70b9 $l<L_i$ \u90a3 $a_i$ \u5c31\u4e0d\u662f $[l+1,r-1]$ \u7684\u6700\u5927\u503c\u4e86\uff08\u56e0\u4e3a $a_{L_i}>a_i$\uff09\uff1b\u53f3\u7aef\u70b9\u540c\u7406\u3002\n- \u82e5 $i$ \u4e3a\u533a\u95f4 $[l+1,r-1]$ \u7684\u6700\u5927\u503c\uff0c\u4e14\u533a\u95f4 $[l,r]$ \u4ea7\u751f $p_2$ \u7684\u8d21\u732e\uff0c\u90a3\u6211\u4eec\u5206\u6700\u5927\u503c\u5728\u5de6\u7aef\u70b9\u5904\u548c\u6700\u5927\u503c\u5728\u53f3\u7aef\u70b9\u5904\u4e24\u79cd\u60c5\u51b5\u3002\u8fd9\u91cc\u4ee5\u6700\u5927\u503c\u5728\u5de6\u7aef\u70b9\u5904\u4e3a\u4f8b\uff0c\u663e\u7136 $l=L_i$\uff0c\u800c\u53f3\u7aef\u70b9\u7406\u8bba\u4e0a\u6765\u8bf4\u53ef\u4ee5\u53d6\u904d $(L_i,R_i)$ \u4e2d\u6240\u6709\u503c\uff0c\u800c\u6211\u4eec\u5f3a\u5236 $i$ \u4e3a\u533a\u95f4 $[l+1,r-1]$ \u7684\u6700\u5927\u503c\uff0c\u6545 $r\\in(i,R_i)$\u3002\u4e5f\u5c31\u662f\u8bf4 $l=L_i,r\\in(i,R_i)$\uff0c\u53e6\u4e00\u534a\u540c\u7406\u53ef\u5f97 $r=R_i,l\\in(L_i,i)$\u3002\n\n\u8003\u8651\u501f\u9274 P5445 [APIO2019]\u8def\u706f \u7684\u5957\u8def\uff0c\u5efa\u7acb\u4e8c\u7ef4\u5e73\u9762\u76f4\u89d2\u5750\u6807\u7cfb\uff0c\u70b9 $(i,j)$ \u8868\u793a\u4ee5 $i,j$ \u4e3a\u7aef\u70b9\u7684\u533a\u95f4\u7684\u8d21\u732e\uff0c\u90a3\u4e48\u663e\u7136\u5bf9\u4e8e\u6bcf\u7ec4\u8be2\u95ee\u6211\u4eec\u53ea\u9700\u6c42\u51fa\u4ee5 $(l,l)$ \u5de6\u4e0b\u89d2\uff0c$(r,r)$ \u4e3a\u53f3\u4e0b\u89d2\u7684\u77e9\u5f62\u4e2d\u6240\u6709\u6570\u7684\u548c\u3002\u800c\u663e\u7136\u4e0a\u9762\u7684\u8d21\u732e\u90fd\u53ef\u8f6c\u5316\u4e3a\u201d\u7eb5\u5750\u6807\u4e3a $y$\uff0c\u6a2a\u5750\u6807\u5728\u533a\u95f4 $[l,r]$ \u4e2d\u7684\u70b9\u7684\u8d21\u732e\u589e\u52a0 $v$ \u7684\u5f62\u5f0f\u201c\u3002\u90a3\u4e48\u663e\u7136\u6211\u4eec\u53ef\u4ee5\u628a\u8be2\u95ee\u8fdb\u884c\u5dee\u5206\u5904\u7406\uff0c\u5e76\u79bb\u7ebf\u626b\u63cf\u7ebf+\u7ebf\u6bb5\u6811\u56de\u7b54\u6bcf\u4e2a\u8be2\u95ee\uff0c\u590d\u6742\u5ea6\u7ebf\u5bf9\u3002\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n#define fi first\n#define se second\n#define fz(i,a,b) for(int i=a;i<=b;i++)\n#define fd(i,a,b) for(int i=a;i>=b;i--)\n#define ffe(it,v) for(__typeof(v.begin()) it=v.begin();it!=v.end();it++)\n#define fill0(a) memset(a,0,sizeof(a))\n#define fill1(a) memset(a,-1,sizeof(a))\n#define fillbig(a) memset(a,63,sizeof(a))\n#define pb push_back\n#define ppb pop_back\n#define mp make_pair\ntemplate<typename T1,typename T2> void chkmin(T1 &x,T2 y){if(x>y) x=y;}\ntemplate<typename T1,typename T2> void chkmax(T1 &x,T2 y){if(x<y) x=y;}\ntypedef pair<int,int> pii;\ntypedef long long ll;\ntemplate<typename T> void read(T &x){\n\tx=0;char c=getchar();T neg=1;\n\twhile(!isdigit(c)){if(c=='-') neg=-1;c=getchar();}\n\twhile(isdigit(c)) x=x*10+c-'0',c=getchar();\n\tx*=neg;\n}\nconst int MAXN=2e5;\nint n,m,qu=0,p1,p2,a[MAXN+5],L[MAXN+5],R[MAXN+5];\nstruct node{int l,r;ll sum,lz;} s[MAXN*4+5];\nvoid build(int k,int l,int r){\n\ts[k].l=l;s[k].r=r;if(l==r) return;\n\tint mid=(l+r)>>1;build(k<<1,l,mid);build(k<<1|1,mid+1,r);\n}\nvoid pushdown(int k){\n\tif(s[k].lz){\n\t\ts[k<<1].sum+=1ll*(s[k<<1].r-s[k<<1].l+1)*s[k].lz;s[k<<1].lz+=s[k].lz;\n\t\ts[k<<1|1].sum+=1ll*(s[k<<1|1].r-s[k<<1|1].l+1)*s[k].lz;s[k<<1|1].lz+=s[k].lz;\n\t\ts[k].lz=0;\n\t}\n}\nvoid modify(int k,int l,int r,int x){\n\tif(l<=s[k].l&&s[k].r<=r){\n\t\ts[k].sum+=1ll*x*(s[k].r-s[k].l+1);\n\t\ts[k].lz+=x;return;\n\t} pushdown(k);int mid=(s[k].l+s[k].r)>>1;\n\tif(r<=mid) modify(k<<1,l,r,x);\n\telse if(l>mid) modify(k<<1|1,l,r,x);\n\telse modify(k<<1,l,mid,x),modify(k<<1|1,mid+1,r,x);\n\ts[k].sum=s[k<<1].sum+s[k<<1|1].sum;\n}\nll query(int k,int l,int r){\n\tif(l<=s[k].l&&s[k].r<=r) return s[k].sum;\n\tpushdown(k);int mid=(s[k].l+s[k].r)>>1;\n\tif(r<=mid) return query(k<<1,l,r);\n\telse if(l>mid) return query(k<<1|1,l,r);\n\telse return query(k<<1,l,mid)+query(k<<1|1,mid+1,r);\n}\nvector<pair<pii,int> > add[MAXN+5];\nstack<pii> stk;ll ans[MAXN+5];\nstruct query{\n\tint x,l,r,p,t;\n\tbool operator <(const query &rhs){return x<rhs.x;}\n} q[MAXN*2+5];\nint main(){\n\tscanf(\"%d%d%d%d\",&n,&m,&p1,&p2);\n\tfor(int i=1;i<=n;i++) scanf(\"%d\",&a[i]);\n\tfor(int i=1;i<=n;i++){\n\t\twhile(!stk.empty()&&stk.top().fi<a[i]) R[stk.top().se]=i,stk.pop();\n\t\tstk.push(mp(a[i],i));\n\t} while(!stk.empty()) R[stk.top().se]=n+1,stk.pop();\n\tfor(int i=n;i;i--){\n\t\twhile(!stk.empty()&&stk.top().fi<a[i]) L[stk.top().se]=i,stk.pop();\n\t\tstk.push(mp(a[i],i));\n\t} while(!stk.empty()) L[stk.top().se]=0,stk.pop();\n\tfor(int i=1;i<=n;i++){\n\t\tif(L[i]&&R[i]!=n+1) add[L[i]].pb(mp(mp(R[i],R[i]),p1));\n\t\tif(L[i]&&R[i]!=i+1) add[L[i]].pb(mp(mp(i+1,R[i]-1),p2));\n\t\tif(R[i]!=n+1&&L[i]!=i-1) add[R[i]].pb(mp(mp(L[i]+1,i-1),p2));\n\t}\n\tfor(int i=1;i<=m;i++){\n\t\tint l,r;scanf(\"%d%d\",&l,&r);ans[i]+=1ll*(r-l)*p1;\n\t\tq[++qu]={r,l,r,i,1};q[++qu]={l-1,l,r,i,-1};\n\t} build(1,1,n);\n\tsort(q+1,q+qu+1);int cur=1;\n\tfor(int i=1;i<=qu;i++){\n\t\twhile(cur<=q[i].x){\n\t\t\tffe(it,add[cur]) modify(1,it->fi.fi,it->fi.se,it->se);\n\t\t\tcur++;\n\t\t} ans[q[i].p]+=q[i].t*query(1,q[i].l,q[i].r);\n\t}\n\tfor(int i=1;i<=m;i++) printf(\"%lld\\n\",ans[i]);\n\treturn 0;\n}\n```\n\n",
        "postTime": 1613660055,
        "uid": 115194,
        "name": "lTgMFePRoeZ",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3722 \u3010[AH2017/HNOI2017]\u5f71\u9b54\u3011"
    },
    {
        "content": "\u6807\u7b7e\uff1a\u7ebf\u6bb5\u6811\n\n\u9898\u89e3\uff1a\n\nhttp://www.cnblogs.com/D-O-Time/p/7922500.html\n\n\u9996\u5148\u5bf9\u4e8e\u9898\u76ee\u7684\u6761\u4ef6\u8fdb\u884c\u5206\u6790\uff0cp1\u7684\u6761\u4ef6\u662f\u4e00\u4e2a\u533a\u95f4\u7684\u4e24\u4e2a\u7aef\u70b9\u5fc5\u987b\u662f\u8fd9\u4e00\u4e2a\u533a\u95f4\u7684\u6700\u5927\u4e0e\u6b21\u5927\u503c\u3002p2\u7684\u6761\u4ef6\u662f\u4e00\u4e2a\u533a\u95f4\u7684\u4e00\u4e2a\u7aef\u70b9\u662f\u6700\u5927\u503c\uff0c\u800c\u53e6\u4e00\u4e2a\u7aef\u70b9\u4e0d\u662f\u6b21\u5927\u503c\u3002\u663e\u7136\uff0c\u4ed6\u4eec\u90fd\u9700\u8981\u4e24\u4e2a\u6761\u4ef6\uff08\u5bf9\u4e8e\u4e24\u4e2a\u7aef\u70b9\u90fd\u6709\u8981\u6c42\uff0c\u8fd9\u6837\u7684\u8bdd\u4e0d\u592a\u597d\u64cd\u4f5c\uff09\u3002\u611f\u53d7\u4e00\u4e0b\uff0cp1\u7684\u6761\u4ef6\u66f4\u4e3a\u4e25\u82db\uff0c\u4e8e\u662f\u6211\u4eec\u8fd9\u6837\u8003\u8651\uff1a\n\n\u4e00\u4e2a\u533a\u95f4\u7684\u4e00\u4e2a\u7aef\u70b9\u662f\u6700\u5927\u503c\uff08\u4e24\u4e2a\u6761\u4ef6\u7684\u516c\u5171\u90e8\u5206\uff09\uff0c\u53e6\u4e00\u4e2a\u4e0d\u7ba1\uff0c\u6b64\u65f6\u52a0\u4e0ap2\u7684\u8d21\u732e\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u7ebf\u6bb5\u6811\u6c42\u89e3\u51fa\u8fd9\u4e00\u4e2a\u4e1c\u897f\u3002\u5bf9\u4e8ei\uff0c\u627e\u5230\u53f3\u8fb9\u5927\u4e8e\u4ed6\u7684\u7b2c\u4e00\u4e2a\u6570\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u81ea\u7136\u662f\u6700\u540e\u4e00\u4e2a\u6570\uff0c\u4f46\u662f\u8fd9\u6837\u4e0d\u597d\uff0c\u4e8e\u662f\u6211\u4eec\u52a0\u4e00\u4e2a\u7b2cn+1\u4e2a\u6570\u4e3a+\u221e\u3002\u7136\u540e\u8bberi\u4e3a\u53f3\u8fb9\u5927\u4e8e\u4ed6\u7684\u7b2c\u4e00\u4e2a\u6570\uff0c\u90a3\u4e48[i,i+1]\u3001[i,i+2]\u3001......[i,ri]\u90fd\u7b26\u5408\u6761\u4ef6\uff0c\u4e8e\u662f\u5728\u7ebf\u6bb5\u6811\u4e2d\u5bf9\u4e8e[i+1,ri]\u90fd+=p2\u3002\u5bf9\u4e8e\u5168\u90e8\u8be2\u95ee\u6392\u5e8f\uff0c\u7ed9\u4ee5i\u4e3a\u5de6\u7aef\u70b9\u7684\u533a\u95f4\u52a0\u4e0a\u8d21\u732e\uff0c\u67e5\u8be2[i+1,R]\u7684\u548c\u3002\u53cd\u8fc7\u6765\u518d\u641e\u4e00\u904d\uff0c\u6ce8\u610f\u8be2\u95ee\u533a\u95f4\u4e5f\u8981\u53cd\u8fc7\u6765\u3002\n\n\u7136\u540e\u6211\u4eec\u53d1\u73b0\u9898\u76ee\u4e2d\u7684\u5bf9\u53e6\u4e00\u4e2a\u7aef\u70b9\u7684\u9650\u5236\u662f\u4e92\u8865\u7684\uff0c\u6211\u4eec\u7684\u533a\u95f4[i,ri]\u6ee1\u8db3p1\uff0c\u800c[i,i+1~ri-1]\u6ee1\u8db3p2\u3002\u56e0\u4e3a\u53ea\u6709\u4e00\u4e2a\u6ee1\u8db3p1\uff0c\u800c\u4e14\u4e00\u4e2ai\u5bf9\u5e94\u4e00\u4e2ari\uff0c\u4e8e\u662f\u6211\u4eec\u5728ri\u5904+p1-p2-p2\u5373\u53ef\uff0c\u5b8c\u7f8e\u89e3\u51b3\u8fd9\u4e00\u4e2a\u95ee\u9898\u3002\n\n\u5c0f\u7ed3\uff1a\u6b64\u9898\u5173\u952e\u5728\u4e8e\u4e24\u4e2a\u6761\u4ef6\u6709\u4e00\u534a\u76f8\u540c\uff0c\u800c\u53e6\u4e00\u534a\u4e92\u8865\uff0c\u6240\u4ee5\u53ef\u4ee5\u4e0d\u7ba1\u4e92\u8865\u7684\u90a3\u4e00\u534a\u5230\u65f6\u5019\u518d\u8003\u8651\u3002\n\n```cpp\n  1 #include<cstdio>\n  2 #include<cstring>\n  3 #include<iostream>\n  4 #include<algorithm>\n  5 #define ls k*2\n  6 #define rs (k*2+1)\n  7 #define LL long long\n  8 using namespace std;\n  9 const int MAXN=210000;\n 10 int n,m,p1,p2,tp;\n 11 int v[MAXN],aft[MAXN],st[MAXN];\n 12 LL ans[MAXN],sum[MAXN*5],lz[MAXN*5];\n 13 struct ed\n 14 {\n 15   int L,R,id;\n 16 }ask[MAXN];\n 17 #define down()\\\n 18 {\\\n 19   sum[ls]+=lz[k]*(mid-ll+1);\\\n 20   sum[rs]+=lz[k]*(rr-mid);\\\n 21   lz[ls]+=lz[k];\\\n 22   lz[rs]+=lz[k];\\\n 23   lz[k]=0;\\\n 24 }\n 25 inline int gi() {int res; scanf(\"%d\",&res); return res;}\n 26 bool comp(ed x,ed y){return x.L<y.L;}\n 27 int find(int x)\n 28 {\n 29   int L=1,R=m,mid;\n 30   while(L<=R)\n 31     {\n 32       mid=(L+R)/2;\n 33       if(ask[mid].L<x)\n 34         L=mid+1;\n 35       else\n 36         R=mid-1;\n 37     }\n 38   return L;\n 39 }\n 40 void add(int k,int ll,int rr,int L,int R,LL Val)\n 41 {\n 42   if(ll==L && rr==R)\n 43     {\n 44       sum[k]+=Val*(rr-ll+1);\n 45       lz[k]+=Val;\n 46       return;\n 47     }\n 48   int mid=(ll+rr)/2;\n 49   down();\n 50   if(R<=mid)\n 51     add(ls,ll,mid,L,R,Val);\n 52   else if(mid<L)\n 53     add(rs,mid+1,rr,L,R,Val);\n 54   else\n 55     {\n 56       add(ls,ll,mid,L,mid,Val);\n 57       add(rs,mid+1,rr,mid+1,R,Val);\n 58     }\n 59   sum[k]=sum[ls]+sum[rs];\n 60 }\n 61 LL query(int k,int ll,int rr,int L,int R)\n 62 {\n 63   if(ll==L && rr==R) return sum[k];\n 64   int mid=(ll+rr)/2;\n 65   down();\n 66   if(R<=mid)\n 67     return query(ls,ll,mid,L,R);\n 68   else if(mid<L)\n 69     return query(rs,mid+1,rr,L,R);\n 70   else\n 71     return query(ls,ll,mid,L,mid)+query(rs,mid+1,rr,mid+1,R);\n 72 }\n 73 void work()\n 74 {\n 75   tp=0; st[0]=n+1;\n 76   for(int i=n;i>=1;i--)\n 77     {\n 78       while(tp && v[st[tp]]<v[i]) tp--;\n 79       aft[i]=st[tp];\n 80       st[++tp]=i;\n 81     }\n 82   memset(sum,0,sizeof sum);\n 83   memset(lz,0,sizeof lz);\n 84   for(int i=n;i>=1;i--)\n 85     {\n 86       if(aft[i]>i)\n 87         {\n 88           add(1,1,n+1,i+1,aft[i],p2);\n 89           add(1,1,n+1,aft[i],aft[i],p1-2*p2);\n 90         }\n 91       int p=find(i);\n 92       while(ask[p].L==i)\n 93         {\n 94           ans[ask[p].id]+=query(1,1,n+1,i+1,ask[p].R);\n 95           p++;\n 96         }\n 97     }\n 98 }\n 99 int main()\n100 {\n101   n=gi();m=gi();p1=gi();p2=gi();\n102   for(int i=1;i<=n;i++) v[i]=gi();\n103   for(int i=1;i<=m;i++) ask[i].L=gi() , ask[i].R=gi() , ask[i].id=i;\n104   sort(ask+1,ask+1+m,comp);\n105   work();\n106   reverse(v+1,v+1+n);\n107   for(int i=1;i<=m;i++)\n108     {\n109       swap(ask[i].L,ask[i].R);\n110       ask[i].L=n-ask[i].L+1;\n111       ask[i].R=n-ask[i].R+1;\n112     }\n113   sort(ask+1,ask+1+m,comp);\n114   work();\n115   for(int i=1;i<=m;i++)\n116     printf(\"%lld\\n\",ans[i]);\n117   return 0;\n118 }\n```",
        "postTime": 1512179392,
        "uid": 38711,
        "name": "DOTime",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3722 \u3010[AH/HNOI2017]\u5f71\u9b54\u3011"
    },
    {
        "content": "\u4e0d\u4e45\u524d\u521a\u505a\u8fc7[P3246 [HNOI2016]\u5e8f\u5217](https://www.luogu.com.cn/problem/P3246)\n\n\u770b\u5230\u8fd9\u9898\u611f\u89c9\u505a\u6cd5\u6709\u70b9\u719f\u6089 \u6ca1\u60f3\u5230\u8fd9\u73a9\u610f\u5c31\u662fHNOI2017\n~~\u6211\u6284\u6211\u81ea\u5df1~~\n\n\u53ef\u4ee5\u60f3\u5230\u7ef4\u62a4\u4e00\u4e2a$l_i$, $r_i$\uff0c\u8868\u793a$i$\u5de6\u8fb9/\u53f3\u8fb9\u7b2c\u4e00\u4e2a\u6bd4\u5b83($k_i$)\u5927\u7684\u4f4d\u7f6e,\u6570\u7ec4\u662f\u4e00\u4e2a\u6392\u5217\uff0c\u6240\u4ee5\u4e0d\u7528\u8003\u8651\u7b49\u4e8e\n\n\u8fd9\u4e2a\u73a9\u610f\u53ef\u4ee5\u901a\u8fc7\u5355\u8c03\u6808\u6765\u5b9e\u73b0$O(n)$(\u5c31\u662f\u6a21\u677f\u9898)\n\n\u7136\u540e\u6027\u8d28\u5c31\u662f$k_i$\u5728$(l_i,r_i)$\u4e2d\u662f\u6700\u5927\u503c\uff0c\u4e14$k_i<k_{l_i},k_i<k_{r_i}$\n\n\u6240\u4ee5$\\max_{j=l_i+1}^{r_i-1}\\left \\{k_j\\right \\}<\\min(k_{l_i},k_{r_i})$\n\n\u5373$(l_i,r_i)$\u7684\u6700\u5927\u503c\u90fd\u6bd4$k_{l_i},k_{r_i}$\u6765\u7684\u5c0f\uff0c\u5c31\u4ea7\u751f\u4e86\u4e00\u4e2a$p_1$\u7684\u8d21\u732e\n\n\u7136\u540e\u76f8\u90bb\u7684\u4e24\u4e2a\u4e4b\u95f4\u662f\u6ca1\u6709\u4e1c\u897f\u7684\uff0c\u4e5f\u6ee1\u8db3\u201c\u4e0d\u5b58\u5728\u5927\u4e8e\u201d\u7684\u6761\u4ef6\uff0c\u4e5f\u662f$p_1$\uff0c\u6240\u4ee5\u4e00\u4e2a\u8be2\u95ee$[l,r]$\uff0c\u5b83\u9996\u5148\u6709\u4e00\u4e2a$(r-l)*p_1$\u7684\u57fa\u7840\u7b54\u6848\n\n\u4e8e\u662f$p_1$\u7684\u60c5\u51b5\u5c31\u8ba8\u8bba\u5b8c\u4e86\uff0c\u770b$p_2$\u7684\u60c5\u51b5\n\n\u4efb\u610f\u4e00\u4e2a$l_i<l<i,\\ i<r<r_i$\u7684\u533a\u95f4$[l,r]$\u7684\u6700\u5927\u503c\u90fd\u662f$k_i$\uff0c\u5426\u5219\u4e0d\u662f\uff0c\u6211\u4eec\u53d6$k_{l_i}$\u4f5c\u4e0a\u754c\uff0c\u5219\u4e0b\u754c\u8981$<k_i$\uff0c\u90a3\u6211\u4eec\u53ef\u4ee5\u53d6$(i,r_i)$\u4e2d\u7684\u4efb\u4f55\u4e00\u4e2a\u6570\uff0c\u6240\u4ee5$(i,r_i)$\u4e2d\u7684\u6bcf\u4e2a\u6570\u90fd\u80fd\u4ea7\u751f$p_2$\u7684\u8d21\u732e\n\n\u6211\u4eec\u8003\u8651\u6bcf\u4e2a\u6570\u5b57\u5bf9\u6240\u6709\u8be2\u95ee\u7684\u8d21\u732e\uff0c\u7531\u4e8e\u8be2\u95ee\u533a\u95f4$[a_j,b_j]$\u4e0e$[l_i,r_i]$\u7684\u5173\u7cfb\u5e76\u4e0d\u786e\u5b9a\uff0c\u8fdb\u884c\u4e00\u4e0b\u5206\u7c7b\u8ba8\u8bba\n\n$1.a_j\\leq l_i,\\ b_j \\geq r_i$\u5373$[l_i,r_i]$\u5305\u542b\u4e8e$[a_i,b_i]$\uff0c\u5219\u6211\u4eec\u80fd\u540c\u65f6\u53d6\u5230$k_{l_i}$\u548c$k_{r_i}$\uff0c\u6240\u4ee5\u4f1a\u6709\u4e00\u4e2a$p_1$\u7684\u8d21\u732e\uff0c\u6211\u4eec\u80fd\u53d6\u5230$k_{l_i}$\u4ee5\u53ca$(i,r_i)$\u7684\u6240\u6709\u6570\uff0c\u6240\u4ee5\u4f1a\u6709$p_2(ri-i-1)$\u7684\u8d21\u732e\uff0c\u540c\u7406\u8fd8\u6709$p_2(i-l_i-1)$\u7684\u8d21\u732e\uff0c\u5408\u8d77\u6765\u5c31\u662f$p_1+p_2(r_i-l_i-2)$\n\n$2.a_j\\leq l_i,\\ i<b_j<r_i$ \u5373\u8be2\u95ee\u533a\u95f4\u5305\u542b\u5de6\u534a\u8fb9\u800c\u53f3\u534a\u8fb9\u53ea\u6846\u5230$b_j$\u8fd9\u90e8\u5206\uff0c\u90a3\u4e48\u53ea\u6709$p_2(b_j-i)$\n\n$2.a_j>l_i,\\ b_j>r_i$ \u5373\u8be2\u95ee\u533a\u95f4\u5305\u542b\u53f3\u534a\u8fb9\u800c\u5de6\u534a\u8fb9\u53ea\u6846\u5230$a_j$\u8fd9\u90e8\u5206\uff0c\u90a3\u4e48\u53ea\u6709$p_2(i-a_j)$\n\n\u77e5\u9053\u4e86\u6bcf\u4e2a\u4f4d\u7f6e\u5bf9\u6bcf\u4e2a\u8be2\u95ee\u7684\u8d21\u732e\u4e4b\u540e\uff0c\u600e\u4e48\u6765\u7ef4\u62a4\u5462\n\n\u8fd9\u662f\u4e00\u4e2a\u5f88\u663e\u7136\u7684\u4e8c\u7ef4\u504f\u5e8f\uff0c\u6240\u4ee5\u6211\u4e00\u5f00\u59cb\u60f3\u4e86\u4e2akd-tree\uff08[\u4e0d\u4f1a\u7684\u6765\u8fd9\u91cc\u5b66](https://www.luogu.com.cn/blog/van/qian-tan-pian-xu-wen-ti-yu-k-d-tree)\uff09\n\n\u628a\u6240\u6709\u8be2\u95ee\u5f53\u4f5c\u70b9\u5bf9$(a,b)$\u4e22\u5230kdtree\u91cc\u9762\uff0c\u7136\u540e\u6bcf\u4e2a\u6570\u5b57\u53bb\u6811\u4e0a\u77e9\u5f62\u4fee\u6539\uff0c\u7531\u4e8e\u6211\u4eec\u9700\u8981\u52a0\u7684\u6570\u5b57\u4e0e$b_j,a_j$\u8fd9\u79cd\u4e0e\u70b9\u81ea\u8eab\u76f8\u5173\u7684\u4fe1\u606f\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u6253\u4e09\u4e2a\u52a0\u6cd5\u6807\u8bb0\uff0c\u4e00\u4e2a\u662f\u65e0\u5173\u7684$tag_0$\uff0c\u4e00\u4e2a\u662f\u4e0e$a$\u76f8\u5173\u7684$tag_1$\uff0c\u53e6\u4e00\u4e2a\u662f\u4e0e$b$\u76f8\u5173\u7684$tag_2$\uff0c\u8fd9\u6837\u5728\u6700\u540e\u904d\u5386\u6574\u68f5\u6811\u7edf\u8ba1\u7b54\u6848\u7684\u65f6\u5019\u5c31\u662f$tag_0+tag_1*a+tag_2*b$\n\n\u7531\u4e8ekdtree\u672c\u8eab\u5e38\u6570\u5c31\u5f88\u5927\u4e86\uff0c\u518d\u6253\u6807\u8bb0\u5c31\u7206\u70b8\u4e86\uff0c\u6240\u4ee5\u8003\u8651\u6807\u8bb0\u6c38\u4e45\u5316\uff0c\u6807\u8bb0\u4e0d\u5728\u4fee\u6539\u8fc7\u7a0b\u4e2d\u4e0b\u4f20\uff0c\u6700\u540e\u4e00\u6b21\u904d\u5386\u7684\u65f6\u5019\u624d\u628a\u5230\u6839\u8def\u5f84\u4e0a\u7684\u6240\u6709\u6807\u8bb0\u7d2f\u8ba1\u8d77\u6765\u770b,$O(n\\sqrt n)$\n\n~~\u7136\u800c\u5f00\u4e86O2\u548c\u6307\u4ee4\u96c6\u8fd8\u662f\u5361\u4e0d\u8fc7\u53bb~~\n\n30\u5206\u4ee3\u7801\uff1a\n\n~~\u522b\u8d70\u554a\uff0c\u6211\u8fd8\u6709\u7ebf\u6bb5\u6811\u6ee1\u5206\u505a\u6cd5~~\n```cpp\n#include<stack>\n#include<cstdio>\n#include<algorithm>\nusing std::stack;\nusing std::nth_element;\ntemplate<class type>inline const type min(const type &a,const type &b){return a<b?a:b;}\ntemplate<class type>inline const type max(const type &a,const type &b){return a>b?a:b;}\ntemplate<class type>inline const void read(type &in)\n{\n\tin=0;char ch(getchar());bool f(0);\n\twhile (ch<48||ch>57)f|=ch=='-',ch=getchar();\n\twhile (ch>47&&ch<58)in=(in<<3)+(in<<1)+(ch&15),ch=getchar();\n\tif (f)in=-in;\n}\ntypedef long long ll;\nconst int k(2),N(2e5+5);\nint f;\nll ans[N];\nstruct point\n{\n\tint d[k],id;\n\tinline point(){d[0]=d[1]=0;}\n\tinline point(const int &x,const int &y,const int id=0):id(id){d[0]=x;d[1]=y;}\n\tinline const bool operator<(const point &p)const\n\t{\n\t\treturn d[f]<p.d[f];\n\t}\n}b[N];\nstruct tree\n{\n\tll tag[3],val[3];\n\tpoint range,mn,mx;\n\ttree *son[2];\n\tstatic tree *null;\n\tvoid *operator new(size_t size);\n\tinline tree(){son[0]=son[1]=null;tag[0]=tag[1]=tag[2]=0;}\n\tinline tree(const point &p):range(p),mn(p),mx(p)\n\t{\n\t\tstatic bool init(0);\n\t\tif (!init)\n\t\t{\n\t\t\tinit=1;\n\t\t\tnull=new tree;\n\t\t\tnull->son[0]=null->son[1]=null;\n\t\t\tfor (int i(0);i<k;i++)null->mn.d[i]=N;\n\t\t}\n\t\tson[0]=son[1]=null;\n\t\ttag[0]=tag[1]=tag[2]=0;\n\t}\n\tinline const void pushup()\n\t{\n\t\tfor (int i(0);i<k;i++)\n\t\t\tmn.d[i]=min(range.d[i],min(son[0]->mn.d[i],son[1]->mn.d[i])),\n\t\t\tmx.d[i]=max(range.d[i],max(son[0]->mx.d[i],son[1]->mx.d[i]));\n\t}\n\tinline const bool in(const point &x,const point &y)\n\t{\n\t\tfor (int i(0);i<k;i++)\n\t\t\tif (!(mn.d[i]>=x.d[i]&&mx.d[i]<=y.d[i]))\n\t\t\t\treturn 0;\n\t\treturn 1;\n\t}\n\tinline const bool out(const point &x,const point &y)\n\t{\n\t\tfor (int i(0);i<k;i++)\n\t\t\tif (mn.d[i]>y.d[i]||mx.d[i]<x.d[i])\n\t\t\t\treturn 1;\n\t\treturn 0;\n\t}\n\tinline const bool at(const point &x,const point &y)\n\t{\n\t\tfor (int i(0);i<k;i++)\n\t\t\tif (!(range.d[i]>=x.d[i]&&range.d[i]<=y.d[i]))\n\t\t\t\treturn 0;\n\t\treturn 1;\n\t}\n}*root,*tree::null;\n#define null tree::null\nchar memory_pool[N*sizeof(tree)],*tail(memory_pool+sizeof(memory_pool));\ninline void *tree::operator new(size_t size){return tail-=size;}\ninline tree *build(const int &l,const int &r,const int &d)\n{\n\tif (l>r)return null;\n\tconst int mid(l+r>>1);f=d;\n\tnth_element(b+l,b+mid,b+r+1);\n\ttree *p(new tree(b[mid]));\n\tif (l==r)return p;\n\tp->son[0]=build(l,mid-1,(d+1)%k);\n\tp->son[1]=build(mid+1,r,(d+1)%k);\n\tp->pushup();\n\treturn p;\n}\ntemplate<const int f>inline const void add(tree *p,const point &x,const point &y,const ll &z)\n{\n\tif (p==null)return;\n\tif (p->out(x,y))return;\n\tif (p->in(x,y))return p->tag[f]+=z,void();\n\tif (p->at(x,y))p->val[f]+=z,void();\n\tadd<f>(p->son[0],x,y,z);add<f>(p->son[1],x,y,z);\n}\ninline const void check(tree *p,ll add0,ll add1,ll add2)\n{\n\tif (p==null)return;\n\tans[p->range.id]+=p->val[0]+(add0+=p->tag[0]);\n\tans[p->range.id]+=p->range.d[0]*(p->val[1]+(add1+=p->tag[1]));\n\tans[p->range.id]+=p->range.d[1]*(p->val[2]+(add2+=p->tag[2]));\n\tcheck(p->son[0],add0,add1,add2);check(p->son[1],add0,add1,add2);\n}\nint n,m,p1,p2,a[N],l[N],r[N];\nstack<int>s;\nint main()\n{\n\tread(n);read(m);read(p1);read(p2);\n\tfor (int i(1);i<=n;i++)read(a[i]);\n\tfor (int i(1);i<=n;i++)\n\t{\n\t\twhile (!s.empty()&&a[s.top()]<=a[i])s.pop();\n\t\tif (!s.empty())l[i]=s.top();\n\t\ts.push(i);\n\t}\n\twhile (!s.empty())s.pop();\n\tfor (int i(n);i;i--)\n\t{\n\t\twhile (!s.empty()&&a[s.top()]<=a[i])s.pop();\n\t\tif (!s.empty())r[i]=s.top();else r[i]=n+1;\n\t\ts.push(i);\n\t}\n\tfor (int i(1);i<=m;i++)\n\t\tread(b[i].d[0]),read(b[i].d[1]),\n\t\tans[b[i].id=i]=1ll*p1*(b[i].d[1]-b[i].d[0]);\n\troot=build(1,m,0);\n\tfor (int i(1);i<=n;i++)\n\t\tadd<0>(root,point(1,r[i]),point(l[i],n),p1+(r[i]-l[i]-2ll)*p2),\n\t\tadd<0>(root,point(1,i+1),point(l[i],r[i]-1),-1ll*i*p2),\n\t\tadd<2>(root,point(1,i+1),point(l[i],r[i]-1),p2),\n\t\tadd<0>(root,point(l[i]+1,r[i]),point(i-1,n),1ll*p2*i),\n\t\tadd<1>(root,point(l[i]+1,r[i]),point(i-1,n),-p2);\n\tcheck(root,0,0,0);\n\tfor (int i(1);i<=m;i++)printf(\"%lld\\n\",ans[i]);\n\treturn 0;\n}\n```\n\u73b0\u5728\u6765\u8bb2\u4e00\u4e0b\u6b63\u5e38\u4eba\u7684\u7ebf\u6bb5\u6811\u505a\u6cd5\n\n\u521a\u521a\u8fd9\u9053\u9898\u7684\u5b9e\u8d28\u8f6c\u5316\u4e3a\u4e86\u77e9\u5f62\u52a0\uff0c\u5355\u70b9\u67e5\u8be2\n\n\u5176\u5b9e\u626b\u63cf\u7ebf\u5c31\u5b8c\u4e8b\u4e86\n\n$O(n \\log n)$\n\n100\u5206AC\u4ee3\u7801\uff1a\n```cpp\n#include<stack>\n#include<cstdio>\n#include<algorithm>\nusing std::stack;\nusing std::sort;\ntemplate<class type>inline const void read(type &in)\n{\n\tin=0;char ch(getchar());bool f(0);\n\twhile (ch<48||ch>57)f|=ch=='-',ch=getchar();\n\twhile (ch>47&&ch<58)in=(in<<3)+(in<<1)+(ch&15),ch=getchar();\n\tif (f)in=-in;\n}\ntypedef long long ll;\nconst int N(2e5+5);\nstruct triple\n{\n\tll a,b,c;\n\tinline triple():a(0),b(0),c(0){}\n\tinline triple(const ll &a,const ll &b,const ll &c):a(a),b(b),c(c){}\n\tinline friend const triple operator+=(triple &a,const triple &b)\n\t{\n\t\treturn a=triple(a.a+b.a,a.b+b.b,a.c+b.c);\n\t}\n\tinline const triple operator*(const int &x)\n\t{\n\t\treturn triple(a*x,b*x,c*x);\n\t}\n};\nstruct tree\n{\n\ttriple tag;\n\ttree *lson,*rson;\n\tvoid *operator new(size_t size);\n\tinline tree(){}\n\tinline const void update(const int &l,const int &r,const int &L,const int &R,const triple &v)\n\t{\n\t\tif (l>R||r<L)return;\n\t\tif (l>=L&&r<=R)return tag+=v,void();\n\t\tconst int mid(l+r>>1);\n\t\tlson->update(l,mid,L,R,v);\n\t\trson->update(mid+1,r,L,R,v);\n\t}\n\tinline const triple query(const int &l,const int &r,const int &k,triple add)\n\t{\n\t\tadd+=tag;\n\t\tif (l==r)return add;\n\t\tconst int mid(l+r>>1);\n\t\tif (k<=mid)return lson->query(l,mid,k,add);\n\t\telse return rson->query(mid+1,r,k,add);\n\t}\n}*root;\nchar memory_pool[N*sizeof(tree)<<1],*tail(memory_pool+sizeof(memory_pool));\ninline void *tree::operator new(size_t size){return tail-=size;}\ninline const void build(tree *&p,const int &l,const int &r)\n{\n\tp=new tree;\n\tif (l==r)return;\n\tconst int mid(l+r>>1);\n\tbuild(p->lson,l,mid);\n\tbuild(p->rson,mid+1,r);\n}\nll ans[N];\nint n,m,p1,p2,a[N],l[N],r[N],cnt;\nstack<int>s;\nstruct seg\n{\n\tint type,x,y1,y2;triple v;\n\tinline seg(){}\n\tinline seg(const int &type,const int &x,const int &y,const int &id):type(type),x(x),y1(y),y2(id){}\n\tinline seg(const int &type,const int &x,const int &y1,const int &y2,const triple &v):type(type),x(x),y1(y1),y2(y2),v(v){}\n\tinline const bool operator<(const seg &s)const\n\t{\n\t\tif (x^s.x)return x<s.x;\n\t\treturn type>s.type;\n\t}\n}b[N*7];\nint main()\n{\n\tread(n);read(m);read(p1);read(p2);\n\tfor (int i(1);i<=n;i++)read(a[i]);\n\tfor (int i(1);i<=n;i++)\n\t{\n\t\twhile (!s.empty()&&a[s.top()]<=a[i])s.pop();\n\t\tif (!s.empty())l[i]=s.top();\n\t\ts.push(i);\n\t}\n\twhile (!s.empty())s.pop();\n\tfor (int i(n);i;i--)\n\t{\n\t\twhile (!s.empty()&&a[s.top()]<=a[i])s.pop();\n\t\tif (!s.empty())r[i]=s.top();else r[i]=n+1;\n\t\ts.push(i);\n\t}\n\tbuild(root,1,n);\n\tfor (int i(1);i<=n;i++)\n\t\tb[++cnt]=seg(1,1,r[i],n,triple(p1+p2*(r[i]-l[i]-2ll),0,0)),\n\t\tb[++cnt]=seg(-1,l[i],r[i],n,triple(p1+p2*(r[i]-l[i]-2ll),0,0)),\n\t\tb[++cnt]=seg(1,1,i+1,r[i]-1,triple(-1ll*i*p2,0,p2)),\n\t\tb[++cnt]=seg(-1,l[i],i+1,r[i]-1,triple(-1ll*i*p2,0,p2)),\n\t\tb[++cnt]=seg(1,l[i]+1,r[i],n,triple(1ll*p2*i,-p2,0)),\n\t\tb[++cnt]=seg(-1,i-1,r[i],n,triple(1ll*p2*i,-p2,0));\n\tfor (int l,r,i(1);i<=m;i++)\n\t\tread(l),read(r),\n\t\tans[i]=1ll*p1*(r-l),\n\t\tb[++cnt]=seg(0,l,r,i);\n\tsort(b+1,b+cnt+1);\n\tfor (int i(1);i<=cnt;i++)\n\t\tif (!b[i].type)\n\t\t{\n\t\t\tconst triple t(root->query(1,n,b[i].y1,triple(0,0,0)));\n\t\t\tans[b[i].y2]+=t.a+b[i].x*t.b+b[i].y1*t.c;\n\t\t}\n\t\telse\n\t\t\troot->update(1,n,b[i].y1,b[i].y2,b[i].v*b[i].type);\n\tfor (int i(1);i<=m;i++)printf(\"%lld\\n\",ans[i]);\n\treturn 0;\n}\n```",
        "postTime": 1591855370,
        "uid": 14374,
        "name": "zhengrunzhe",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P3722 \u3010[AH2017/HNOI2017]\u5f71\u9b54\u3011"
    },
    {
        "content": "\u611f\u89c9\u8fd9\u9898\u8fd8\u633a\u6709\u610f\u601d\u7684\uff0c\u4e0d\u8fc7\u4f30\u8ba1\u662fHNOI2017\u7b2c\u4e8c\u5bb9\u6613\u7684\u9898\u76ee\u3002  \n**UPD\uff1a\u539f\u6765\u7684\u89e3\u91ca\u6709\u70b9\u9519\u8bef\uff0c\u4fee\u6b63\u4e00\u4e0b\u3002**  \n\u53d1\u73b0\u4e24\u4e2a\u9650\u5236\u6761\u4ef6\u5f88\u9ebb\u70e6\uff0c\u4e0d\u59a8\u5148\u4e0d\u8003\u8651\u53f3\u7aef\u70b9\u5143\u7d20\uff0c\u627e\u5230\u5f53\u524d\u5143\u7d20$a[i]$\u7684\u53f3\u65b9\u540e\u7ee7\uff08\u53ef\u7b49\u4e8e$a[i]$\uff09$a[k]$\u3002\u5219\u4ece$[i,i+1]$\u5230$[i,k)$\u8fd9\u4e9b\u533a\u95f4\u90fd\u6ee1\u8db3p2\u7684\u8d21\u732e\u8981\u6c42\uff0c\u800c$[i,k]$\u5219\u6ee1\u8db3p1\u7684\u8d21\u732e\u8981\u6c42\u3002\u800c\u6bcf\u6b21\u8be2\u95ee\u5219\u8981\u6c42\u5f53\u524d\u533a\u95f4\u6240\u6709\u5b50\u533a\u95f4\u7684\u7b54\u6848\uff0c\u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u533a\u95f4\u53f3\u7aef\u70b9\u7684\u8d21\u732e\uff0c\u66f4\u65b0\u65f6\u5c06$(i,k)$\u52a0\u4e0ap2,\u5c06$[k,k]$\u52a0\u4e0a$p1$\u5c31\u53ef\u4ee5\u4e86\u3002\u67e5\u8be2\u662f\u53ef\u4ee5\u76f4\u63a5\u67e5\u8be2$(L+1,R)$\u7684\u7b54\u6848\u7684\u3002    \n\u4f46\u662f\u8fd9\u6837\u8fd8\u6709\u4e9b\u95ee\u9898\uff0c\u6211\u4eec\u53ef\u80fd\u4f1a\u7b97\u5165L\u5de6\u8fb9\u533a\u95f4\u7684\u8d21\u732e\u3002\u6240\u4ee5\u53ea\u9700\u8981\u5c06\u8be2\u95ee\u533a\u95f4\u6309L\u4ece\u5927\u5230\u5c0f\u6392\u5e8f\u5c31\u53ef\u4ee5\u4e86\u3002\u8ba1\u7b97\u540e\u7ee7\u53ef\u4ee5\u7528\u5355\u8c03\u6808\u6765\u7ef4\u62a4\uff0c\u5f53\u7136\u4f60\u4e5f\u53ef\u4ee5\u6d6a\u8d39\u4e00\u70b9\u590d\u6742\u5ea6\u6765$\\rm lower\\_bound$\u3002  \n\u81f3\u4e8e\u5de6\u8fb9\u7684\u533a\u95f4\u600e\u4e48\u529e\uff1f\u5c06\u533a\u95f4\u548c\u8be2\u95ee\u53cd\u5411\u5c31\u53ef\u4ee5\u4e86\u3002**\u6ce8\u610f\u53cd\u5411\u540e\u8be2\u95ee\u7684\u53d8\u5316\u3002**  \n**\u4f46\u6211\u4eec\u6ce8\u610f\u5230\u53f3\u7aef\u70b9\u7684\u503c\u53ef\u80fd\u5bf9\u7b54\u6848\u6709\u5f71\u54cd\uff1a\u6bd4\u5982$[i,k]$\u8fd9\u4e2a\u533a\u95f4\u5728\u53cd\u5411\u8ba1\u7b97\u65f6\u662f\u589e\u52a0\u4e86p2\u7684\u65e0\u610f\u4e49\u8d21\u732e\u7684\u3002\u6211\u4eec\u8981\u5728\u8fd9\u91cc\u51cf\u6389\u3002$**  \n\u8fd8\u6709\u5c31\u662f\u8981\u5f00$\\rm long\\ long$\u3002\n```cpp\n// luogu-judger-enable-o2\n#include<iostream>\n#include<cstdio>\n#include<cstdlib>\n#include<algorithm>\n#include<cstring>\n#define neko 200010\n#define chkmax(a,b) ((a)>(b)?(a):(b))\n#define f(i,a,b) for(register int i=(a);i<=(b);i=-(~i))\n#define rf(i,a,b) for(register int i=(a);i>=(b);i=~(-i))\nstruct node\n{\n    int l,r,id;\n}q[neko];\nint n,m;\ntypedef long long ll;\nll p1,p2,a[neko],ans[neko],stk[neko],suc[neko],Sum[neko<<2],Add[neko<<2];\nusing namespace std;\nnamespace Seg\n{\n    #define ori tagl,tagr\n    #define mid ((l+r)>>1)\n    #define lson root<<1,l,mid\n    #define rson root<<1|1,mid+1,r\n    #define pushup(root) Sum[root]=Sum[root<<1]+Sum[root<<1|1]\n    void pushdown(int root,int l,int r)\n    {\n        if(Add[root])\n        {\n            Sum[root<<1]+=1ll*(mid-l+1)*Add[root];\n            Sum[root<<1|1]+=1ll*(r-mid)*Add[root];\n            Add[root<<1]+=Add[root];\n            Add[root<<1|1]+=Add[root];\n            Add[root]=0;\n        }\n    }\n    ll query(int root,int l,int r,int tagl,int tagr)\n    {\n        if(l>=tagl&&r<=tagr)return Sum[root];\n        pushdown(root,l,r);\n        ll tmp=0;\n        if(tagl<=mid)tmp+=query(lson,ori);\n        if(tagr>mid)tmp+=query(rson,ori);\n        return tmp;\n    }\n    void update(int root,int l,int r,int tagl,int tagr,int x)\n    {\n        if(l>=tagl&&r<=tagr){Add[root]+=x,Sum[root]+=(r-l+1)*x;return;}\n        pushdown(root,l,r);\n        if(tagl<=mid)update(lson,ori,x);\n        if(tagr>mid)update(rson,ori,x);\n        pushup(root);\n    }\n    #undef ori\n    #undef mid\n    #undef lson\n    #undef rson\n}\nnamespace Cons\n{\n    using namespace Seg;\n    bool cmp(node a,node b)\n    {return a.l<b.l;}\n    void init()\n    {memset(Sum,0,sizeof(Sum)),memset(Add,0,sizeof(Add));}\n    void calc()\n    {\n        int top=0,now=m;stk[0]=n+1;\n        init();\n        rf(i,n,1)\n        {\n            while(top&&a[stk[top]]<a[i])--top;\n            suc[i]=stk[top];\n            stk[++top]=i;\n        }\n        rf(i,n,1)\n        {\n            if(suc[i]>i)update(1,1,n+1,i+1,suc[i],p2),update(1,1,n+1,suc[i],suc[i],p1-2*p2);\n            while(q[now].l==i)ans[q[now].id]+=query(1,1,n+1,i+1,q[now].r),--now;\n        }\n    }\n}\nusing namespace Cons;\nint main()\n{\n    scanf(\"%d%d%lld%lld\",&n,&m,&p1,&p2);\n    f(i,1,n)scanf(\"%lld\",&a[i]);//a[n+1]=1e9;\n    f(i,1,m)scanf(\"%d%d\",&q[i].l,&q[i].r),q[i].id=i;\n    sort(q+1,q+m+1,cmp),calc();\n    reverse(a+1,a+n+1);\n    f(i,1,m)swap(q[i].l,q[i].r),q[i].l=n-q[i].l+1,q[i].r=n-q[i].r+1;\n    sort(q+1,q+m+1,cmp),calc();\n    f(i,1,m)printf(\"%lld\\n\",ans[i]);return 0;\n}\n```",
        "postTime": 1523502011,
        "uid": 7020,
        "name": "teafrogsf",
        "ccfLevel": 0,
        "title": "[AH/HNOI2017]\u5f71\u9b54"
    },
    {
        "content": "\u601d\u8def\u4e0e\u5176\u4ed6\u9898\u89e3\u76f8\u540c\uff0c\u8be6\u7ec6\u89e3\u91ca\u4e00\u4e0b\u8f6c\u5316\u6210\u77e9\u9635\u6c42\u548c\u7684\u90e8\u5206\u3002\n\n---\n\n$k$ \u662f\u4e00\u4e2a\u6392\u5217\uff0c\u56e0\u6b64\u4e92\u4e0d\u76f8\u540c\u3002\u5355\u8c03\u6808\u53ef\u4ee5 $O(n)$ \u6c42\u51fa\u5bf9\u4e8e\u6bcf\u4e2a $i$\uff0c$k_i$ \u4e3a\u6700\u5927\u503c\u7684\u533a\u95f4 $[l_i,r_i]$\uff0c\u6bcf\u4e2a $i$ \u7684\u8d21\u732e\u53ef\u4ee5\u5206\u4e3a $3$ \u79cd\uff1a\n\n1. \u5bf9\u5de6\u7aef\u70b9 $l_i-1$\uff0c\u53f3\u7aef\u70b9 $r_i+1$ \u8d21\u732e $p_1$\n2. \u5bf9\u5de6\u7aef\u70b9 $l_i-1$\uff0c\u53f3\u7aef\u70b9 $[i+1,r_i]$ \u8d21\u732e $p_2$\n3. \u5bf9\u5de6\u7aef\u70b9 $[l_i,i-1]$\uff0c\u53f3\u7aef\u70b9 $r_i+1$ \u8d21\u732e $p_2$\n\n\u5c06\u5de6\u7aef\u70b9\u770b\u505a\u6a2a\u5750\u6807\uff0c\u53f3\u7aef\u70b9\u770b\u505a\u7eb5\u5750\u6807\uff0c\u753b\u5230\u5750\u6807\u7cfb\u4e0a\uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/mw5vnq1h.png)\n\n\u79bb\u7ebf\uff0c\u6309 $x$ \u5750\u6807\u6392\u5e8f\u540e BIT \u7ef4\u62a4\u7eb5\u8f74\u53ef\u4ee5\u8f7b\u6613\u5904\u7406\u64cd\u4f5c $1,2$\uff0c\u4f46 $3$ \u4e0d\u597d\u5904\u7406\u3002\n\n\u8003\u8651\u4e0d\u9650\u5236\u6a2a\u8f74\u3001\u7eb5\u8f74\u5177\u4f53\u662f\u54ea\u4e2a\u7aef\u70b9\uff0c\u5e76\u5c06 $3$ \u548c\u8be2\u95ee\u6309 $y=x$ \u5bf9\u79f0\uff0c\u5f97\u5230\uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/11z66kxe.png)\n\n\u53d1\u73b0\u91cd\u5408\u90e8\u5206\u76f8\u540c\uff0c\u56e0\u6b64\u53ef\u4ee5\u5c06\u64cd\u4f5c $3$ \u7684\u53f3\u7aef\u70b9\u770b\u505a $x$ \u5750\u6807\uff0c\u4ece\u800c\u8f6c\u5316\u6210\u64cd\u4f5c $2$\u3002\u76f8\u5e94\u7684\uff0c\u8be2\u95ee\u4e5f\u53d8\u6210\u6b63\u65b9\u5f62\u3002\n\n```cpp\nconst int N = 4e5+5;\nint n,m,w1,w2,a[N];\nstruct Node { int x,l,r,val,id; } q[N];\nbool operator < (const Node &x,const Node &y) { return x.x < y.x; }\n\nint an,le[N],ri[N];\nLL ans[N];\nNode add[N];\nint tp,stk[N];\n\nstruct BIT {\n\tLL t1[N],t2[N];\n\tvoid add(int i,int x) {\n\t\tfor(int j = i; j <= n; j += j&-j)\n\t\t\tt1[j] += x, t2[j] += i*x;\n\t}\n\tLL sum(int i) {\n\t\tLL res = 0;\n\t\tfor(int j = i; j; j -= j&-j) res += (i+1) * t1[j] - t2[j];\n\t\treturn res;\n\t}\n\tvoid add(int l,int r,int x) { add(l,x), add(r+1,-x); }\n\tLL sum(int l,int r) { return sum(r) - sum(l-1); }\n} bit;\n\nsigned main() {\n\tread(n,m,w1,w2);\n\tFor(i,1,n) read(a[i]);\n\ta[0] = N, stk[++tp] = 0;\n\tFor(i,1,n) {\n\t\twhile( a[i] > a[stk[tp]] ) ri[stk[tp--]] = i-1;\n\t\tle[i] = stk[tp]+1;\n\t\tstk[++tp] = i;\n\t} while( tp ) ri[stk[tp--]] = n;\n\tFor(i,1,n) {\n\t\tif( 1 < le[i] && ri[i] < n ) add[++an] = Node{le[i]-1,ri[i]+1,ri[i]+1,w1};\n\t\tif( 1 < le[i] && i < ri[i] ) add[++an] = Node{le[i]-1,i+1,ri[i],w2};\n\t\tif( le[i] < i && ri[i] < n ) add[++an] = Node{ri[i]+1,le[i],i-1,w2};\n\t} sort(add+1,add+an+1);\n\tFor(i,1,m) {\n\t\tint l,r; read(l,r);\n\t\tans[i] += (r-l) * w1;\n\t\tq[i] = Node{l-1,l,r,-1,i}, q[i+m] = Node{r,l,r,1,i};\n\t} sort(q+1,q+2*m+1);\n\tfor(int i = 1, j = 1; i <= 2*m; ++i) {\n\t\twhile( j <= an && add[j].x <= q[i].x )\n\t\t\tbit.add(add[j].l,add[j].r,add[j].val), ++j;\n\t\tans[q[i].id] += q[i].val * bit.sum(q[i].l,q[i].r);\n\t}\n\tFor(i,1,m) write(ans[i]);\n\treturn iocl();\n}\n```",
        "postTime": 1630462934,
        "uid": 236866,
        "name": "401rk8",
        "ccfLevel": 9,
        "title": "P3722 [AH2017/HNOI2017]\u5f71\u9b54 \u9898\u89e3"
    },
    {
        "content": "\u7701\u9009\u524d\u7684\u6700\u540e\u4e00\u7bc7\u9898\u89e3 ~~\u5e0c\u671b\u4e0d\u8981\u662fOI\u751f\u6daf\u4e2d\u7684\u6700\u540e\u4e00\u7bc7\u9898\u89e3~~\n\n\u6700\u5927\u503c\u95ee\u9898\u53ef\u4ee5\u8003\u8651**\u7b1b\u5361\u5c14\u6811**\n\n\u8003\u8651\u4e24\u79cd\u8d21\u732e\u7684\u6761\u4ef6,\u5047\u8bbe $i>j,k_i>k_j$\n\n\u53ef\u4ee5\u53d1\u73b0 $p1$ \u7684\u6761\u4ef6\u7b49\u4ef7\u4e8e $j$ \u662f $i$ \u7684\u5de6\u513f\u5b50\u7684\u53f3\u94fe\n\n$p2$ \u7684\u6761\u4ef6\u7b49\u4ef7\u4e8e $j$ \u662f $i$ \u7684\u5de6\u513f\u5b50\u7684\u53f3\u94fe\u7684\u5de6\u5b50\u6811\n\n\u7136\u540e\u79bb\u7ebf\u533a\u95f4,\u5728\u6bcf\u4e00\u4e2a $i$ \u52a0\u5165\u65f6\u8ba1\u7b97 $i>j,k_i>k_j$ \u7684\u8d21\u732e,\u53d1\u73b0\u5982\u679c\u76f4\u63a5\u679a\u4e3e\u5de6\u513f\u5b50\u7684\u53f3\u94fe,\u590d\u6742\u5ea6\u662f $O(n)$ \u7684,\u56e0\u4e3a\u6bcf\u4e2a\u8282\u70b9\u53ea\u4f1a\u5728\u7236\u4eb2\u548c\u7236\u4eb2\u7684\u7236\u4eb2\u88ab\u8ba1\u7b97,\u4e8e\u662f\u5c31\u53ea\u8981\u5b9e\u73b0\u533a\u95f4\u52a0\u548c\u533a\u95f4\u67e5\u8be2\u5c31\u597d\u4e86\n\n```cpp\n#include<algorithm>\n#include<iostream>\n#include<vector>\n#include<cstdio>\n#include<cstring>\nusing namespace std;\n#define ll long long\n//{{{ read()\ninline ll read(){\n\tregister ll x=0,f=1;\n\tregister char ch=getchar();\n\twhile(ch<'0'||ch>'9'){\n\t\tif(ch=='-')\tf=-1;\n\t\tch=getchar();\n\t}\n\twhile(ch>='0'&&ch<='9')\tx=x*10+(ch^48),ch=getchar();\n\treturn x*f;\n}\n//}}}\nconst int N=2e5+5; \nstruct pi{\n\tint l,r,id;\n}q[N];\nll b[N<<2],la[N<<2],ans[N];\nint n,m,p1,p2,a[N],lp[N],rp[N],ls[N],rs[N],lg[N],st[N][18];\nvoid add(int rt,int l,int r,int z){\n\tb[rt]+=(r-l+1)*z,la[rt]+=z;\n}\nvoid push(int rt,int l,int r){\n\tif(!la[rt]) return ;\n\tint mid=(l+r)>>1;\n\tadd(rt<<1,l,mid,la[rt]);\n\tadd(rt<<1|1,++mid,r,la[rt]),la[rt]=0;\n}\nvoid add(int l,int r,int x,int y,int z,int rt){\n\tif(x<=l&&y>=r){\n\t\tadd(rt,l,r,z);\n\t\treturn ;\n\t}\n\tint mid=(l+r)>>1; push(rt,l,r);\n\tif(x<=mid)\t add(l,mid,x,y,z,rt<<1);\n\tif(y>mid)\tadd(++mid,r,x,y,z,rt<<1|1);\n\tb[rt]=b[rt<<1]+b[rt<<1|1];\n}\nll query(int l,int r,int x,int y,int rt){\n\tif(x<=l&&y>=r) return b[rt];\n\tint mid=(l+r)>>1;\n\tll ans=0; push(rt,l,r);\n\tif(x<=mid) ans=query(l,mid,x,y,rt<<1);\n\tif(y>mid)  ans+=query(++mid,r,x,y,rt<<1|1);\n\treturn ans;\n}\nint min(int x,int y){\n\tif(a[x]<a[y]) return y;\n\treturn x;\n}\nint get(int l,int r){\n\tint k=lg[r-l+1];\n\treturn min(st[l][k],st[r-(1<<k)+1][k]);\n}\nint build(int l,int r){\n\tint x=get(l,r); lp[x]=l,rp[x]=r;\n\tif(l<x) ls[x]=build(l,x-1);\n\tif(r>x) rs[x]=build(x+1,r);\n\treturn x;\n}\nbool com(pi x,pi y){\n\treturn x.r<y.r;\n}\nbool cmp(pi x,pi y){\n\treturn x.l>y.l;\n}\nint main(){\n\tfreopen(\"1.in\",\"r\",stdin);\n\t//freopen(\".out\",\"w\",stdout);\n\tn=read(),m=read(),p1=read(),p2=read();\n\tfor(int i=2;i<=n;i++) lg[i]=lg[i>>1]+1;\n\tfor(int i=1;i<=n;i++) a[i]=read(),st[i][0]=i;\n\tfor(int j=1;j<=lg[n];j++)\n\t\tfor(int i=1;i+(1<<j)<=n+1;i++)\n\t\t\tst[i][j]=min(st[i][j-1],st[i+(1<<(j-1))][j-1]);\n\tfor(int i=1;i<=m;i++) q[i].l=read(),q[i].r=read(),q[i].id=i;\n\tbuild(1,n),sort(q+1,q+m+1,com);\n\tfor(int i=1,j=1;i<=n&&j<=m;i++){\n\t\tint x=ls[i];\n\t\twhile(x){\n\t\t\tif(ls[x]) add(1,n,lp[x],x-1,p2,1);\n\t\t\tadd(1,n,x,x,p1,1),x=rs[x];\n\t\t}\n\t\twhile(j<=m&&q[j].r==i) ans[q[j].id]=query(1,n,q[j].l,q[j].r,1),j++;\n\t}\n\tmemset(la,0,sizeof(la));\n\tmemset(b,0,sizeof(b));\n\tsort(q+1,q+m+1,cmp);\n\tfor(int i=n,j=1;i&&j<=m;i--){\n\t\tint x=rs[i];\n\t\twhile(x){\n\t\t\tif(rs[x]) add(1,n,x+1,rp[x],p2,1);\n\t\t\tadd(1,n,x,x,p1,1),x=ls[x];\n\t\t}\n\t\twhile(j<=m&&q[j].l==i) ans[q[j].id]+=query(1,n,q[j].l,q[j].r,1),j++;\n\t}\n\tfor(int i=1;i<=m;i++)\tprintf(\"%lld\\n\",ans[i]);\n\treturn 0;\n}\n```",
        "postTime": 1592390366,
        "uid": 88567,
        "name": "lzk5627",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P3722 \u3010[AH2017/HNOI2017]\u5f71\u9b54\u3011"
    },
    {
        "content": "\u5355\u8c03\u6808+\u7ebf\u6bb5\u6811+\u79bb\u7ebf\u5904\u7406\n\n# \u4e00\u5b9a\u8981\u5f00LONGLONG\uff01\uff01\uff01\n\n\u55ef~ o(\\*\uffe3\u25bd\uffe3\\*)o\u6211\u4eec\u53d1\u73b0\u8981\u5904\u7406\u4e00\u5806\u533a\u95f4\n\n\u6211\u4eec\u53d1\u73b0\u5bf9\u4e8ep1\u7c7b\u578b\u7684\u533a\u95f4\u3010i\uff0cj\u3011\n\n\u5982\u679cj>i\u90a3\u4e48j\u4e00\u5b9a\u662fi\u53f3\u4fa7\u7b2c\u4e00\u4e2a\u6bd4\u5b83\u5927\u7684\u70b9\n\n\uff08\u4ec0\u4e48\uff1fj\u5c0f\u4e8ei\uff1f\uff0c\u53cd\u8f6c\u533a\u95f4\u53ef\u4ee5\u5316\u6210\u60c5\u51b5\u4e00\uff09\n\n\u518d\u8003\u8651p2\u60c5\u51b5\u7c7b\u578b\u7684\u533a\u95f4\u3010i\uff0cj\u3011\n\n\u5982\u679ci\u5c0f\u4e8ej\u5219i\u4e00\u5b9a\u662f\u8fd9\u6837\u7684\u70b9\uff0c\u5b83\u5728\u533a\u95f4\uff08p\uff0cq\uff09\u4e4b\u95f4\n\n//\uff08p,q)\u662f\u5f00\u533a\u95f4\uff01\uff01\uff01\n\n\u5176\u4e2d\u3010q\uff0cj\u3011\u662f\u4e00\u4e2ap1\u7c7b\u578b\u7684\u533a\u95f4\uff0cp\u662fq\u5de6\u4fa7\u7b2c\u4e00\u4e2a\u6bd4\n\nq\u5927\u7684\u70b9\uff08\u540c\u7406i>j\u662f\u53ef\u4ee5\u53cd\u8f6c\u533a\u95f4\u8f6c\u6362\u4e3a\u60c5\u51b5\u4e00\uff09\n\n\u901a\u8fc7\u53cd\u8bc1\u6cd5\u6211\u4eec\u53ef\u4ee5\u5f88\u5bb9\u6613\u7684\u8bc1\u660e\u4e0a\u9762\u7684\u8bf4\u6cd5\u53ef\u4ee5\u4e0d\u91cd\u4e0d\u6f0f\u7684\n\n\u679a\u4e3e\u51fa\u6240\u6709\u7684p1\uff0cp2\uff08\u5047\u8bbe\u6709\u4e00\u4e2a\u4e0d\u7b26\u5408\u6761\u4ef6\u7684\u533a\u95f4\uff0c\u53d1\u73b0\u5f88\u5feb\u5c31\u4f1a\u51fa\u77db\u76fe\uff09\n\n\u53d1\u73b0\u4e0a\u8ff0\u4e00\u5957\u82b1\u91cc\u80e1\u54e8\u7684\u5b9a\u4e49\u53ea\u9700\u8981\u4e24\u4e2a\u4fe1\u606f\uff0c\n\n\u70b9 i \u5de6\u4fa7\u7b2c\u4e00\u4e2a\u6bd4\u4ed6\u5927\u7684\u70b9\u662f\u8c01\n\n\u70b9 i \u53f3\u4fa7\u7b2c\u4e00\u4e2a\u6bd4\u4ed6\u5927\u7684\u70b9\u662f\u8c01\n\n\u597d\u50cf\u5355\u8c03\u6808\u5c31\u53ef\u4ee5\u5904\u7406\u6b38\n\n\u63a5\u4e0b\u6765\u662f\u7edf\u8ba1\u533a\u95f4\n\n\u53d1\u73b0\u5728\u7ebf\u5904\u7406\u4f1a\u76f4\u63a5\u6655\u6389\uff0c\u8003\u8651\u79bb\u7ebf\u5904\u7406\n\n\u628a\u8be2\u95ee\u6309\u53f3\u7aef\u70b9\u6392\u5e8f\uff0c\u4e4b\u540e\u6bcf\u6b21\u62d3\u5c55\u53f3\u7aef\u70b9\n\n\u66f4\u65b0\u6240\u6709\u5408\u6cd5\u7684\u5de6\u7aef\u70b9\u5373\u53ef\n\n\u53d1\u73b0p1\u662f\u5355\u70b9\u4fee\u6539\uff0cp2\u662f\u533a\u95f4\u4fee\u6539\n\n//\u90fd\u5f00\u7ebf\u6bb5\u6811\u597d\u4e86\uff0c\u8fd9\u91cc\u61d2\u4e86\n\n\u7136\u540e\u7ebf\u6bb5\u6811sum\u4e00\u4e0b\u5c31\u662f\u7ed3\u679c\u4e86\n\n\u53e6\u5916\uff0c\u4e0a\u8ff0\u53ea\u5904\u7406\u4e86\u4e00\u534a\uff08\u5373i\u5c0f\u4e8ej\uff09\n\n\u6211\u4eec\u53ef\u4ee5\u628a\u533a\u95f4\u548c\u8be2\u95ee\u7edf\u7edf\u53cd\u8f6c\uff0c\u5904\u7406\u4e0b\u4e00\u534a\u60c5\u51b5\n\n//\u7ec6\u8282\u770b\u6ce8\u91ca\u5427\uff0c\u4e0d\u770b\u4ee3\u7801\u521a\u624d\u8bb2\u7684\u597d\u591a\u7ec6\u8282\u6ca1\u6709\n\n\u4e0a\u4ee3\u7801~\n\n    \n```cpp\n    #include<cstdio>\n    #include<algorithm>\n    using namespace std;\n    int n;int m;int p1;int p2;\n    int a[200010];long long ans[200010];\n    //\u5f00longlong\n    struct data\n    {\n        int l;int r;int num;\n        friend bool operator <(data a,data b){return a.r<b.r;}\n    }q[200010];\n    struct graph//\u8fd9\u91cc\u7528\u90bb\u63a5\u8868\u5b58\u53f3\u8fb9\u7b2c\u4e00\u4e2a\u5927\u7684\u70b9\u95f4\u7684\u5173\u7cfb\n    {\n        struct edge{int v;int nxt;}edge[400010];\n        int cnt;int alist[200010];\n        inline void add(int u,int v)\n        {edge[++cnt].v=v;edge[cnt].nxt=alist[u];\n        alist[u]=cnt;return;}\n        inline void clear()\n        {for(int i=0;i<=n;i++)alist[i]=0;\n        for(int i=0;i<=cnt;i++)edge[i].v=0,edge[i].nxt=0;\n        cnt=0;return;}\n    }g;int left[200010];\n    struct sta//\u624b\u5199\u7684\u6808\n    {\n        int stk[200010];int nop;\n        inline void push(int x){stk[++nop]=x;return;}\n        inline void pop(){if(nop>0)nop--;return;}\n        inline int top(){return stk[nop];}\n        inline bool empty(){return nop>0;}\n        inline void clear(){while(empty())pop();}\n    }s;\n    struct linetree//\u57fa\u672c\u7ebf\u6bb5\u6811\n    {\n        int val[800010];int lazy[800010];\n        inline void pushdown(int p,int l,int r)\n        {\n            val[p]+=lazy[p]*(r-l);\n            if(r-l>1)\n            {lazy[2*p]+=lazy[p],lazy[2*p+1]+=lazy[p];}\n            lazy[p]=0;return;\n        }\n        inline void setlazy(int p,int l,int r,int dl,int dr,int plus)\n        {\n            if(dl==dr)return;\n            if(lazy[p]!=0)pushdown(p,l,r);\n            if(dl==l&&dr==r)\n            {lazy[p]+=plus;pushdown(p,l,r);return;}\n            int mid=(l+r)/2;\n            if(dl<mid)setlazy(2*p,l,mid,dl,min(mid,dr),plus);\n            else pushdown(2*p,l,mid);\n            if(mid<dr)setlazy(2*p+1,mid,r,max(dl,mid),dr,plus);\n            else pushdown(2*p+1,mid,r);\n            val[p]=val[2*p]+val[2*p+1];return;\n        }\n        inline int sum(int p,int l,int r,int dl,int dr)\n        {\n            if(lazy[p]!=0)pushdown(p,l,r);\n            if(dl==l&&dr==r){return val[p];}\n            int mid=(l+r)/2;int res=0;\n            if(dl<mid)res+=sum(2*p,l,mid,dl,min(mid,dr));\n            if(mid<dr)res+=sum(2*p+1,mid,r,max(dl,mid),dr);\n            return res;\n        }\n        inline void clear()\n        {for(int i=0;i<=4*n+1;i++){val[i]=0;lazy[i]=0;}return;}\n    }lt1,lt2;//\u5f00\u4e24\u4e2a\uff0c\u4e00\u4e2ap1\u578b\u5de6\u7aef\u70b9\u4e2a\u6570\uff0c\u53e6\u4e00\u4e2a\u662fp2\u578b\n    void reverse()//\u53cd\u8f6c\u533a\u95f4\u548c\u8be2\u95ee\n    {\n        for(int i=1;i<=n/2;i++)swap(a[i],a[n-i+1]);\n        for(int i=1;i<=m;i++)\n        {swap(q[i].l,q[i].r);q[i].l=n-q[i].l+1,q[i].r=n-q[i].r+1;}\n        return;\n    }\n    void work()\n    {\n        sort(q+1,q+m+1);//\u53f3\u7aef\u70b9\u6392\u5e8f\n        for(int i=1;i<=n;i++)//\u53f3\u4fa7\u7b2c\u4e00\u4e2a\u5927\n        {\n            while(s.empty()&&a[i]>a[s.top()])\n            {g.add(i,s.top());\n            //\u8fd9\u91cc\u6ce8\u610f\uff0c\u4e00\u4e2a\u70b9\u53ef\u80fd\u662f\u597d\u51e0\u4e2a\u70b9\u7684\u7b2c\u4e00\u4e2a\u5927\u503c\n            //\u6240\u4ee5\u8981\u7528\u4e34\u63a5\u8868\u5b58\n            //printf(\"right[%d]=%d\\n\",a[s.top()],a[i]);\n            s.pop();}s.push(i);\n        }\n        for(int i=n;i>=1;i--)//\u5de6\u4fa7\u7b2c\u4e00\u4e2a\u5927\n        {\n            while(s.empty()&&a[i]>a[s.top()])\n            {left[s.top()]=i;//\u53ef\u662f\u4e00\u4e2a\u70b9\u53ea\u6709\u4e00\u4e2a\u5de6\u4fa7\u7b2c\u4e00\u5927\n            //printf(\"left[%d]=%d\\n\",a[s.top()],a[i]);\n            s.pop();}s.push(i);\n        }int cot=1;//\u679a\u4e3e\u6bcf\u4e2a\u8282\u70b9\n        for(int i=1;i<=m;i++)\n        {\n            for(;cot<=q[i].r;cot++)\n            {\n                int nxt=g.alist[cot];//\u679a\u4e3e\u8fd9\u4e2a\u70b9\u7684\u6240\u6709\u5de6\u7aef\u70b9\n                while(nxt)\n                {\n                    int v=g.edge[nxt].v;\n                    lt1.setlazy(1,0,n,v-1,v,1);//\u66f4\u65b0p1\u578b\u5de6\u7aef\u70b9\n                    //printf(\"p1:%d,%d\\n\",a[cot],a[v]);\n                    lt2.setlazy(1,0,n,left[v],v-1,1);//\u66f4\u65b0p2\u578b\u53f3\u7aef\u70b9\n                    //printf(\"p2:%d->%d~%d\\n\",a[cot],a[v],a[left[v]]);\n                    nxt=g.edge[nxt].nxt;\n                }\n            }\n            //\u52a1\u5fc5\u662flonglong\n            ans[q[i].num]+=(long long)p1*(long long)lt1.sum(1,0,n,q[i].l-1,q[i].r);\n            ans[q[i].num]+=(long long)p2*(long long)lt2.sum(1,0,n,q[i].l-1,q[i].r);\n        }return;\n    }\n    int main()\n    {\n         //\u8bfb\u5165\n        scanf(\"%d%d%d%d\",&n,&m,&p1,&p2);\n        for(int i=1;i<=n;i++){scanf(\"%d\",&a[i]);}\n        for(int i=1;i<=m;i++)\n        {q[i].num=i;scanf(\"%d%d\",&q[i].l,&q[i].r);}\n        work();//\u5e72\u6d3b\n        s.clear();lt1.clear();lt2.clear();\n        g.clear();for(int i=0;i<=n;i++)left[i]=0;\n        reverse();//\u6e05\u7406\u5e76\u53cd\u8f6c\n        work();//\u63a5\u7740\u5e72\u6d3b\n        for(int i=1;i<=m;i++)\n        {\n            printf(\"%lld\\n\",ans[i]);\n        }return 0;//\u62dc\u62dc\u7a0b\u5e8f~\n}\n```",
        "postTime": 1513070271,
        "uid": 56384,
        "name": "shadowice1984",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3722 \u3010[AH/HNOI2017]\u5f71\u9b54\u3011"
    },
    {
        "content": "\u521a\u505a\u5b8c [P3246 [HNOI2016]\u5e8f\u5217](https://www.luogu.com.cn/problem/P3246) \u5c31\u78b0\u5230\u8fd9\u4e2a\u9898\u4e86\u3002\n\n\uff08\u8bdd\u8bf4\u4e3a\u4ec0\u4e48 HN \u4e24\u5e74\u51fa\u4e86\u4e00\u6837\u7684\u9898\u2026\u2026\n\n\u6839\u636e\u9898\u610f\u53ef\u4ee5\u53d1\u73b0\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u533a\u95f4 $[l,r]$ \u6765\u8bf4\uff0c\u65e0\u8bba\u662f\u60f3\u8981\u8d21\u732e $p1$\uff0c\u8fd8\u662f\u60f3\u8981\u8d21\u732e $p2$\uff0c\u5c31\u90fd\u9700\u8981\u8003\u8651 $[l,r]$ \u4e2d\u6700\u5927\u503c\u548c\u4e24\u7aef\u70b9\u7684\u5173\u7cfb\u3002\n\n\u8003\u8651\u66b4\u529b\u600e\u4e48\u505a\uff0c\u679a\u4e3e\u4e24\u4e2a\u7aef\u70b9\uff0c\u7136\u540e\u6c42\u51fa\u533a\u95f4 $RMQ$\uff0c\u4e4b\u540e\u6bd4\u8f83\u4e24\u7aef\u70b9\u548c $RMQ$ \u7684\u5173\u7cfb\u3002\u663e\u7136\u8fd9\u6837\u4f1a T\u3002\u90a3\u6211\u4eec\u4e0d\u5982\u53cd\u8fc7\u6765\u8003\u8651\uff0c\u5047\u8bbe\u4e00\u4e2a\u70b9\u4f5c\u4e3a $RMQ$\uff0c\u7136\u540e\u8003\u8651\u5b83\u53c2\u4e0e\u8fdb\u54ea\u4e9b\u533a\u95f4\u7684\u8fd0\u7b97\u3002\n\n\u5f88\u81ea\u7136\u5730\u53d1\u73b0\uff0c\u5bf9\u4e00\u4e2a\u70b9\u6765\u8bf4\u53ea\u8981\u77e5\u9053\u5b83\u5de6\u53f3\u4e24\u8fb9\u7b2c\u4e00\u4e2a\u5927\u4e8e\u5b83\u7684\u6570\u7684\u4f4d\u7f6e\uff0c\u5c31\u80fd\u786e\u5b9a\u5b83\u4f5c\u4e3a $RMQ$ \u53c2\u4e0e\u8fd0\u7b97\u7684\u533a\u95f4\u8303\u56f4\uff0c\u8fd9\u4e2a\u53ef\u4ee5\u62ff\u5355\u8c03\u6808\u6765\u505a\u3002\n\n\u8bbe\u5de6\u53f3\u4e24\u8fb9\u7b2c\u4e00\u4e2a\u5927\u4e8e $i$ \u7684\u6570\u7684\u4f4d\u7f6e\u4e3a $lef[i],right[i]$\u3002\u5982\u679c\u6211\u4eec\u5c06\u6bcf\u4e2a\u533a\u95f4 $(i,j)$ \u6620\u5c04\u5230\n\u5e73\u9762\u4e0a\uff0c\u5219\u4e00\u4e2a\u70b9 i \u6240\u8d21\u732e\u7684\u5c31\u662f\u4e00\u4e2a\u77e9\u5f62 $[lef[i],i-1]-[i+1,right[i]]$\u3002\n\n\u9898\u76ee\u5df2\u7ecf\u544a\u8bc9\u6211\u4eec\uff0c\u5bf9\u4e8e\u4efb\u610f\u4e00\u4e2a\u533a\u95f4\u5b83\u7684\u8d21\u732e\u662f $0$\u3001$p1$ \u6216\u8005 $p2$\u3002\n\u5bf9\u4e8e$[lef[i],i-1]-[i+1,right[i]]$ \u8fd9\u4e2a\u77e9\u5f62\uff0c\u6ee1\u8db3\u5176\u5185\u90e8\u4efb\u610f\u4e00\u70b9\u8d21\u732e\u90fd\u4e3a $0$ \u3002\u6b63\u786e\u6027\u663e\u7136\uff08\u56e0\u4e3a\u4f60\u8fd9\u4e2a\u77e9\u5f62\u662f\u901a\u8fc7\u9884\u5904\u7406 $lef$ \u548c $right$ \u6c42\u51fa\u6765\u7684\uff0c\u6240\u4ee5\u8be5\u70b9\u7684\u5de6\u53f3\u7aef\u70b9\u90fd\u5728 $lef$ \u548c $right$ \u8303\u56f4\u5185\u3002\n\n\u63a5\u4e0b\u6765\u8003\u8651\u8d21\u732e\u4e3a $p1$ \u7684\u60c5\u51b5\u3002\u53ef\u4ee5\u53d1\u73b0\u5bf9\u4e00\u4e2a\u70b9 $i$ \u6765\u8bf4\uff0c\u5176 $lef$ \u548c $right$ \u5206\u522b\u5411\u5916\u6269\u5927\u4e00\u4f4d\u540e\u7684\u4f4d\u7f6e\u4e0a\u7684\u6570\u5927\u4e8e $k_i$\uff0c\u8fd9\u663e\u7136\u4e0d\u5c31\u6784\u6210 $p1$ \u6210\u7acb\u7684\u6761\u4ef6\u4e86\u5417\uff01\u5fc5\u8981\u6027\u663e\u7136\u3002\n\n\u6700\u540e\u6211\u4eec\u4e0d\u8003\u8651\u8d21\u732e $p2$ \u7684\u60c5\u51b5\uff0c\u800c\u662f\u76f4\u63a5\u8003\u8651\u67e5\u8be2\u64cd\u4f5c\u3002\u8be2\u95ee $[l,r]$ \u8fd9\u4e2a\u533a\u95f4\u610f\u5473\u7740\u5728\u5e73\u9762\u4e0a\u8be2\u95ee $(l,l)-(rr)$ \u8fd9\u4e2a\u533a\u57df\uff0c\u8be5\u95ee\u9898\u5c31\u88ab\u8f6c\u5316\u4e3a\u4e86\u5e73\u9762\u4e0a\u77e9\u5f62\u52a0\u3001\u77e9\u5f62\u67e5\u8be2\u7684\u64cd\u4f5c\u3002\u5b9e\u73b0\u7684\u65b9\u5f0f\u591a\u79cd\u591a\u6837\uff0c\u4ec0\u4e48\u4e8c\u7ef4\u6811\u72b6\u6570\u7ec4\u3001\u626b\u63cf\u7ebf\u3001\u56db\u53c9\u6811\u3001kdt\u2026\u2026\u968f\u4fbf\u7528\u5c31\u662f\u4e86\n\n\u6700\u540e\u8bf4\u4e00\u4e0b\u4e3a\u4ec0\u4e48\u4e0d\u8ba8\u8bba\u8d21\u732e $p2$ \u7684\u60c5\u51b5\u3002\u53ef\u4ee5\u76f4\u63a5\u5c06\u77e9\u5f62\u9ed8\u8ba4\u503c\u8d4b\u4e3a $p2$ \uff0c\u505a $0$ \u8d21\u732e\u76f8\u5f53\u4e8e\u505a $-p2$ \u8d21\u732e\uff0c\u505a $p1$ \u8d21\u732e\u76f8\u5f53\u4e8e\u505a $p1-p2$ \u8d21\u732e\uff0c\u5c31\u80fd\u89e3\u51b3\u95ee\u9898\u3002\n\n```cpp\n#include<bits/stdc++.h>\n\nusing namespace std;\n\n#define int long long\n#define INF 1ll<<30\n#define Int unsigned long long \n\ntemplate<typename _T>\ninline void read(_T &x)\n{\n\tx=0;char s=getchar();int f=1;\n\twhile(s<'0'||s>'9') {f=1;if(s=='-')f=-1;s=getchar();}\n\twhile('0'<=s&&s<='9'){x=(x<<3)+(x<<1)+s-'0';s=getchar();}\n\tx*=f;\n}\n\n#define lowbit(x) (x&(-x))\n#define gb(x) ((x-1)/T + 1)\n#define gl(x) ((x-1)*T + 1)\n#define pb push_back \n#define Re register\n#define MOD(x) (x = (x + mod)%mod)\n\nconst int np =2e5 + 5;\n\nint a[np] , sta[np] , top;\nint lef[np],right_[np];\nint ql[np],qr[np],ans[np];\nint h[np];\nint n,q,p1,p2;\nvector<int> Add[np],jian[np],qry[np],Addp1[np];\n\nstruct node{\n\tint l,r;\n\tnode *ls,*rs;\n\tint sum,tag;\n\t\n\tinline bool inrange(int L,int R){return L<=l&&r<=R;}\n\tinline bool outofrange(int L,int R){return r < L||R < l;}\n\t\n\tinline void pushup()\n\t{\n\t\tsum = ls->sum + rs->sum;\n\t}\n\t\n\tinline void maketag(int vl)\n\t{\n\t\tsum += (r - l + 1) * vl;\n\t\ttag += vl;\n\t}\n\t\n\tinline void pushdown()\n\t{\n\t\tif(tag)\n\t\t{\n\t\t\tls->maketag(tag);\n\t\t\trs->maketag(tag);\n\t\t\ttag = 0 ;\n\t\t}\n\t\treturn ;\n\t}\n\t\n\tinline int query(int L,int R)\n\t{\n\t\tif(inrange(L,R))\n\t\t{\n\t\t\treturn sum;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif(!outofrange(L,R))\n\t\t\t{\n\t\t\t\tpushdown();\n\t\t\t\treturn ls->query(L,R) + rs->query(L,R);\n\t\t\t}\n\t\t}\n\t}\n\t\n\tinline void upd(int L,int R,int vl)\n\t{\n\t\tif(inrange(L,R))\n\t\t{\n\t\t\tmaketag(vl);\n\t\t\treturn;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif(!outofrange(L,R))\n\t\t\t{\n\t\t\t\tpushdown();\n\t\t\t\tls->upd(L,R,vl);\n\t\t\t\trs->upd(L,R,vl);\n\t\t\t\tpushup();\n\t\t\t}\n\t\t}\n\t}\n}mem[np * 5],*pool = mem,*T1,*T2;\ninline node *New(){return ++pool;}\ninline node *build(int L,int R)\n{\n\tnode *u = New();\n\tu->l = L , u->r  = R;\n\tif(L == R)\n\t{\n\t\tu->ls = u->rs =NULL;\n\t}\n\telse\n\t{\n\t\tint mid = L + R>>1;\n\t\tu->ls = build(L,mid);\n\t\tu->rs = build(mid + 1,R);\n\t\tu->pushup();\n\t}\n\treturn u;\n}\n\nsigned main()\n{\n\tread(n);\n\tread(q);\n\tread(p1);\n\tread(p2);\n\t\n\tfor(int i=1;i<=n;i++) read(a[i]);\n\t\n\tfor(int i=1;i<=n;i++)\n\t{\n\t\twhile(a[sta[top]] < a[i] && top >= 1) top--;\n\t\tif(top) lef[i] = sta[top] + 1;\n\t\telse lef[i] = 1;\n\t\tsta[++top] = i;\n\t}\n\t\n\ttop = 0;\n\tfor(int i=n;i>=1;i--)\n\t{\n\t\twhile(a[sta[top]] <= a[i] && top >= 1) top--;\n\t\tif(top) right_[i] = sta[top] - 1;\n\t\telse right_[i] = n;\n\t\tsta[++top] = i;\t\t\n\t}\n\t// 0\u7c7b\u8d21\u732e [lef , i - 1] , [i + 1,right] \n\t// p1\u7c7b\u8d21\u732e (lef,right) \n\t// \u5269\u4e0b\u90fd\u662fp2\u7c7b\u8d21\u732e  \n\tfor(int i=1;i<=n;i++)\n\t{\n\t\tif(i + 1 <= n) Addp1[i + 1].pb(i);\n\t\tif(1 <= lef[i] - 1 && right_[i] + 1 <= n) Addp1[right_[i] + 1].pb(lef[i] - 1);\n\t\tif(lef[i]>i-1 || i + 1 >right_[i]) continue;\n\t\tif(lef[i] == right_[i]) continue;\n\t\tAdd[i + 1].pb(i);\n\t\tjian[right_[i]].pb(i);\n\t}\n\t\n\tT1 = build(1,n); // \u7ef4\u62a4\u5df2\u7ecf\u843d\u4e0b\u7684\u77e9\u5f62 \n\tT2 = build(1,n); // \u7ef4\u62a4\u6b63\u5728\u843d\u4e0b\u7684\u77e9\u5f62 \n\tfor(int i=1;i<=q;i++)\n\t{\n\t\tread(ql[i]);read(qr[i]);\n\t\tqry[qr[i]].pb(i);\n\t}\n\t\n\th[0] = 0;\n\tfor(int i=1;i<=n;i++) h[i] = h[i-1] + 1;\n\t\n\tfor(int i=1;i<=n;i++)\n\t{\n\t\tfor(auto j:Addp1[i])\n\t\t{\n\t\t\tT1->upd(j,j,p1-p2);\n\t\t } \n\t\t\n\t\tfor(auto j:Add[i])\n\t\t{\n\t\t\tT1->upd(lef[j],j-1,(i-1)*p2);\n\t\t\tT2->upd(lef[j],j-1,-p2);\n\t\t}\n\t\t\n\t\tfor(auto j:jian[i])\n\t\t{\n\t\t\tT1->upd(lef[j],j-1,-i*p2);\n\t\t\tT2->upd(lef[j],j-1,p2);\n\t\t}\n\t\t\n\t\tfor(auto j:qry[i])\n\t\t{\n\t\t\tint x = (qr[j] - ql[j] + 1) * i * p2;\n\t\t\tint y = -(h[ql[j]] + h[qr[j]]) * (qr[j] - ql[j] + 1)/2*p2;\n\t\t\tx+=y;\n\t\t\tans[j] = x + i * T2->query(ql[j],qr[j]) + T1->query(ql[j],qr[j]);\n\t\t}\n\t}\n\t\n\tfor(int i=1;i<=q;i++) printf(\"%lld\\n\",ans[i]);\n\t\n\treturn 0;\n }\n\n```\n\n ",
        "postTime": 1625036554,
        "uid": 307042,
        "name": "\u4e00Iris\u4e00",
        "ccfLevel": 7,
        "title": "P3722 [AH2017/HNOI2017]\u5f71\u9b54"
    },
    {
        "content": "# \u5f71\u9b54\n\u9898\u89e3\uff1a\n\n\u6211\u4eec\u5148\u7528\u5355\u8c03\u6808\u6c42\u51fa\u4e00\u4e2a\u6570\u5de6\u8fb9\u7b2c\u4e00\u4e2a\u6bd4\u5b83\u5927\u7684\uff0c\u548c\u53f3\u8fb9\u7b2c\u4e00\u4e2a\u6bd4\u5b83\u5927\u7684\u3002$l_i$\u548c$r_i$\u5c31\u8868\u793a\u8fd9\u4e24\u4e2a\u503c\u3002\n\n\u7136\u540e\u6211\u4eec\u53d1\u73b0\uff0c$(l_i,r_i)$\u5c31\u662f\u4e00\u4e2a\u5408\u6cd5\u7684\u7b2c\u4e00\u4e2a\u6761\u4ef6\u7684\u70b9\u5bf9\u3002\n\n\u63a5\u4e0b\u6765\u6211\u4eec\u8003\u8651\u5982\u4f55\u7edf\u8ba1\u7b2c\u4e8c\u4e2a\u6761\u4ef6\u7684\u70b9\u5bf9\u3002\n\n\u7b2c\u4e8c\u4e2a\u6761\u4ef6\u7684\u8bdd\u5982\u679c\u8fd8\u60f3\u7528\u521a\u624d\u7684\u503c\u8868\u793a\u7684\u8bdd\uff0c\u6211\u4eec\u53d1\u73b0\u5c31\u662f\u5728\u5e73\u9762\u4e0a\u679a\u4e3e\u4e00\u4e2a\u7ebf\u6bb5\uff0c\u7136\u540e\u628a\u8fd9\u4e2a\u7ebf\u6bb5\u67d3\u8272\u3002\n\n\u6bcf\u6b21\u7edf\u8ba1\u4e00\u4e2a\u77e9\u5f62\u4e2d\u591a\u5c11\u4e2a\u70b9\u662f\u67d3\u8272\u7684\u3002\n\n\u800c\u8fd9\u4e2a\u8fc7\u7a0b\u6211\u4eec\u53ef\u4ee5\u7528\u4e3b\u5e2d\u6811+\u6807\u8bb0\u6c38\u4e45\u5316\u6765\u5b9e\u73b0\u7684\u3002\n\nCode:\n```cpp\n#include <iostream>\n#include <cstdio>\n#include <cstring>\n#include <algorithm>\n#define N 200010 \n#define lson l,mid,ls[x],ls[y]\n#define rson mid+1,r,rs[x],rs[y]\nusing namespace std; typedef long long ll;\nchar *p1,*p2,buf[100000];\n#define nc() (p1==p2&&(p2=(p1=buf)+fread(buf,1,100000,stdin),p1==p2)?EOF:*p1++)\nint rd() {int x=0; char c=nc(); while(c<48) c=nc(); while(c>47) x=(((x<<2)+x)<<1)+(c^48),c=nc(); return x;}\nstruct Node\n{\n\tint x,l,r; ll p;\n\tNode() {}\n\tNode(int x_,int l_,int r_,ll p_) {x=x_,l=l_,r=r_,p=p_;}\n}v[N<<2];\nint a[N],lp[N],rp[N],sta[N],top,cnt,root[N],ls[N<<6],rs[N<<6],tot;\nll sum[N<<6],add[N<<6];\ninline bool cmp(const Node &a,const Node &b) {return a.x<b.x;}\ninline void pushup(int x) {sum[x]=sum[ls[x]]+sum[rs[x]];}\nvoid insert(int b,int e,ll a,int l,int r,int x,int &y)\n{\n\ty=++tot,ls[y]=ls[x],rs[y]=rs[x],add[y]=add[x],sum[y]=sum[x]+a*(e-b+1);\n\tif(b==l&&r==e) {add[y]+=a; return;}\n\tint mid=(l+r)>>1;\n\tif(e<=mid) insert(b,e,a,lson);\n\telse if(b>mid) insert(b,e,a,rson);\n\telse insert(b,mid,a,lson),insert(mid+1,e,a,rson);\n}\nll query(int b,int e,int l,int r,int x,int y)\n{\n\tif(b<=l&&r<=e) return sum[y]-sum[x];\n\tint mid=(l+r)>>1; ll ans=(add[y]-add[x])*(e-b+1);\n\tif(e<=mid) return ans+query(b,e,lson);\n\telse if(b>mid) return ans+query(b,e,rson);\n\telse return ans+query(b,mid,lson)+query(mid+1,e,rson);\n}\nint main()\n{\n\tint n,m,i,j,x,y;\n\tll p1,p2;\n\tn=rd(),m=rd(); p1=rd(),p2=rd(); for(int i=1;i<=n;i++) a[i]=rd();\n\ta[0]=a[n+1]=1<<30,top=1;\n\tfor(i=1;i<=n;i++)\n\t{\n\t\twhile(a[sta[top]]<a[i]) top--;\n\t\tlp[i]=sta[top],sta[++top]=i;\n\t}\n\ttop=1,sta[1]=n+1;\n\tfor(i=n;i>=1;i--)\n\t{\n\t\twhile(a[sta[top]]<a[i])top--;\n\t\trp[i]=sta[top],sta[++top]=i;\n\t}\n\tfor(i=1;i<=n;i++)\n\t{\n\t\tif(lp[i]!=0&&rp[i]!=n+1) v[++cnt]=Node(lp[i],rp[i],rp[i],p1);\n\t\tif(i<n) v[++cnt]=Node(i,i+1,i+1,p1);\n\t\tif(lp[i]!=0&&rp[i]-i>1) v[++cnt]=Node(lp[i],i+1,rp[i]-1,p2);\n\t\tif(rp[i]!=n+1&&i-lp[i]>1) v[++cnt]=Node(rp[i],lp[i]+1,i-1,p2);\n\t}\n\tsort(v+1,v+cnt+1,cmp);\n\tfor(i=j=1;i<=n;i++)\n\t{\n\t\troot[i]=root[i-1];\n\t\twhile(j<=cnt&&v[j].x==i)\n\t\t\tinsert(v[j].l,v[j].r,v[j].p,1,n,root[i],root[i]),j++;\n\t}\n\twhile(m--)\n\t{\n\t\tx=rd(),y=rd();\n\t\tprintf(\"%lld\\n\",query(x,y,1,n,root[x-1],root[y]));\n\t}\n\treturn 0;\n}\n```\n\u63a8\u9500\u4e2a\u4ebablog [JZYshuraK](https://www.cnblogs.com/ShuraK/p/10238938.html)",
        "postTime": 1546930281,
        "uid": 58178,
        "name": "JZYshuraK",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3722 \u3010[AH2017/HNOI2017]\u5f71\u9b54\u3011"
    },
    {
        "content": "\u53ef\u4ee5\u76f4\u63a5\u770b\u6211\u535a\u5ba2\uff1ahttp://www.cnblogs.com/zzmmm/p/7502127.html\n\n\u601d\u8def{\n\n\u548c\u53bb\u5e74\u7684\u5e8f\u5217\u6709\u70b9\u50cf\u554a...\n\n\u5bf9\u4e8e\u4e00\u4e2a\u70b9,\u5355\u72ec\u8ba1\u7b97\u5176\u4f5c\u4e3a\u533a\u95f4\u6700\u5927\u503c\u7684\u8d21\u732e\uff0c\u8fd9\u4e5f\u662f\u4e00\u822c\u7684\u5e8f\u5217\u95ee\u9898\u7684\u5957\u8def\u3002\n\n\u5bf9\u4e8e\u5355\u70b9$ i $\uff0c\u4ed6\u6240\u80fd\u4f5c\u4e3a\u4e00\u6bb5\u533a\u95f4\u5185\u7684\u6700\u5927\u503c\u6240\u80fd\u505a\u51fa\u7684\u8d21\u732e\u662f\u4ec0\u4e48\uff0c\n\n\u627e\u51fa\u5de6\u8fb9\u7b2c\u4e00\u4e2a\u5927\u4e8e$K_i$\u7684\u4f4d\u7f6e$L_i$,\n\n\u53f3\u8fb9\u7b2c\u4e00\u4e2a\u5927\u4e8e$K_i$\u7684\u4f4d\u7f6e$R_i$\uff1b\n\n\u4e00\u6bb5\u533a\u95f4\u505a\u51fa\u7684\u8d21\u732e\uff0c\u53c8\u5341\u5206\u81ea\u7136\u60f3\u5230\u4e86\u626b\u63cf\u7ebf.\n\n\u7531\u4e8e\u8bbe\u4e8c\u7ef4\u5e73\u9762\u4e0a\u7684\u70b9$( x , y ) $  \u4e2d$ y $\u503c\u8868\u793a\u6240\u4ee3\u8868\u7684\u70b9.$x$\u503c\u8868\u793a\u5b83\u6240\u80fd\u591f\u5f71\u54cd\u5230\u7684\u70b9\u3002\n\n$P_1$\u5bf9\u5e94\u4e86\u70b9$ ( i , L_i ) $\u5230$ ( i , R_i ) $\u7684\u7ebf\u6bb5\uff0c\n\n$P_2$\u5bf9\u5e94\u4e86\u70b9$ ( L_i , i + 1 ) $\u5230$ ( i , R_i - 1 ) $\u7684\u7ebf\u6bb5\uff0c\n\n$P_2$\u5bf9\u5e94\u4e86\u70b9$ ( R_i , L_i + 1 ) $\u5230$ ( R_i , i - 1 ) $\u7684\u7ebf\u6bb5\uff0c\n\n\u8be2\u95ee\u62bd\u8c61\u6210\u4e24\u6761\u5e73\u884c\u4e8e $ x $ \u8f74\u7684\u7ebf\u6bb5,\n\n\u6bcf\u6761\u7ebf\u6bb5\u5de6\u53f3\u7aef\u70b9\u5373\u4e3a\u6240\u4ea7\u751f\u7684\u8d21\u732e\u8303\u56f4.\u90a3\u7ebf\u6bb5\u7684\u5de6\u53f3\u7aef\u70b9\u548c\u4e0a\u4e0b\u7aef\u70b9\u90fd\u662f$L,R$\u4e86.\n\n\u90a3\u4e48\u5c31\u662f\u6c42\u8be2\u95ee\u6240\u4ee3\u8868\u7684\u533a\u95f4\u5185\u7684\u6743\u503c\u548c\u4e86!!\n\n\u7528\u626b\u63cf\u7ebf+\u533a\u95f4\u4fee\u6539\u6811\u72b6\u6570\u7ec4\u7ef4\u62a4\u8fd9\u4e2a\u4e1c\u897f\u5373\u53ef.\n\n\u8fd9\u4e48\u8bf4\u6765\u5e94\u8be5\u4e5f\u53ef\u4ee5\u7528\u626b\u63cf\u7ebf\u6765\u89e3\u51b3\u53bb\u5e74\u7684\u5e8f\u5217\u4e86.\n\n```cpp\n}\n#define RG register\n#define ll long long\n#define db double\n#define N 200010\n#define lowbit (i&-i)\nusing namespace std;\nint l[N],r[N],st[N],a[N],n,m,p1,p2;\nll Ans[N];\nnamespace BIT{\n  ll t1[N],t2[N];\n  void clear(){memset(t1,0,sizeof(t1));memset(t2,0,sizeof(t2));}\n  void add(int x,int y){\n    for(int i=x;i<=n;i+=lowbit)t1[i]+=y,t2[i]+=1ll*x*y;\n  }\n  void Insert(int l,int r,int num){\n    add(l,num),add(r+1,-num);\n  }\n  ll Query(int pos){\n    ll Sum(0);\n    for(int i=pos;i;i-=lowbit)Sum+=(pos+1)*t1[i]-t2[i];\n    return Sum;\n  }\n  ll sum(int l,int r){\n    return Query(r)-Query(l-1);\n  }\n}\nstruct event{\n  int l,r,h,bel,val;\n  event() {}\n  event(int a,int b,int c,int d,int e):l(a),r(b),h(c),bel(d),val(e) {}\n}eve1[N*2],eve2[N*3];int tot1,tot2;\nbool comp(const event & a,const event & b){return a.h<b.h;}\nint main(){\n  scanf(\"%d%d%d%d\",&n,&m,&p1,&p2);\n  for(int i=1;i<=n;++i)scanf(\"%d\",&a[i]);\n  for(int i=1;i<=n;++i){\n    while(st[0]&&a[st[st[0]]]<a[i])r[st[st[0]--]]=i;\n    st[++st[0]]=i;\n  }\n  while(st[0])r[st[st[0]--]]=n+1;\n  for(int i=n;i;i--){\n    while(st[0]&&a[st[st[0]]]<a[i])l[st[st[0]--]]=i;\n    st[++st[0]]=i;\n  }\n  while(st[0])l[st[st[0]--]]=0;\n  for(int i=1;i<=m;++i){int l,r;\n    scanf(\"%d%d\",&l,&r);Ans[i]+=1ll*(r-l)*p1;\n    eve1[++tot1]=event(l,r,r,i,1);\n    eve1[++tot1]=event(l,r,l-1,i,-1);\n  }\n  sort(eve1+1,eve1+tot1+1,comp);\n  for(int i=1;i<=n;++i){\n    if(l[i]&&r[i]!=n+1)eve2[++tot2]=event(l[i],l[i],r[i],0,p1);\n    if(l[i]&&r[i]>i+1)eve2[++tot2]=event(i+1,r[i]-1,l[i],0,p2);\n    if(r[i]!=n+1&&l[i]+1<i)eve2[++tot2]=event(l[i]+1,i-1,r[i],0,p2);\n  }\n  sort(eve2+1,eve2+tot2+1,comp);\n  int h1(1),h2(1);\n  while(!eve1[h1].h)h1++;\n  for(int i=1;i<=n&&h1<=tot1;++i){\n    while(h2<=tot2&&eve2[h2].h==i){\n      BIT::Insert(eve2[h2].l,eve2[h2].r,eve2[h2].val);\n      h2++;\n    }\n    while(h1<=tot1&&eve1[h1].h==i){\n      Ans[eve1[h1].bel]+=eve1[h1].val*(BIT::sum(eve1[h1].l,eve1[h1].r));\n      h1++; \n    }\n  }\n  for(int i=1;i<=m;++i)cout<<Ans[i]<<\"\\n\";\n  return 0;\n}\n\n```",
        "postTime": 1507772549,
        "uid": 23122,
        "name": "\u57c3\u7f57\u8292\u963f\u8001\u5e08\u00b7",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3722 \u3010[AH/HNOI2017]\u5f71\u9b54\u3011"
    }
]