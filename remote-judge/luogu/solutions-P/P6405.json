[
    {
        "content": "[\u9898\u9762\u4f20\u9001\u95e8](https://www.luogu.com.cn/problem/P6405)\n\n[\u53ef\u80fd\u66f4\u597d\u7684\u9605\u8bfb\u4f53\u9a8c](https://www.cnblogs.com/275307894a/p/14315742.html)\n\n\u8fd9\u9898\u5341\u5206\u5361\u7cbe\u5ea6\uff0c\u6211\u5f00\u5230\u4e86$10^{-12}$\u624d\u8fc7\u53bb\u3002\n\n\u4e3b\u8981\u6709\u4e24\u79cd\u505a\u6cd5\u3002\n\n\u4e24\u79cd\u505a\u6cd5\u7684\u6838\u5fc3\u90fd\u662f\u4e00\u6837\u7684\uff0c\u5c31\u662f\u6c42\u51fa\u76f8\u90bb\u4e24\u68f5\u6811\u5728\u4ec0\u4e48\u65f6\u5019\u4e00\u6837\u9ad8\u3002\u5efa\u6743\u503c\u4e3a\u540c\u6837\u9ad8\u65f6\u95f4\u7684\u8fb9\uff0c\u7136\u540e\u627e\u51fa\u6700\u5927\u7684\u8fde\u901a\u5757\u4f7f\u7684\u8fb9\u6743\u76f8\u540c\u3002\n\n\u4f46\u662f\u5728\u627e\u7684\u8fc7\u7a0b\u4e2d\u6211\u4eec\u53d1\u73b0\u6709\u4e00\u4e9b\u6811\u53ef\u80fd\u521d\u59cb\u9ad8\u5ea6\u4e00\u6837\u4e14\u751f\u957f\u901f\u5ea6\u4e00\u6837\uff0c\u90a3\u4e48\u8fd9\u4e9b\u6811\u5728\u4efb\u4f55\u65f6\u5019\u90fd\u76f8\u540c\u9ad8\u3002\u5728\u5904\u7406\u8fd9\u4e00\u5757\u4e0a\u884d\u751f\u51fa\u4e86\u4e24\u79cd\u505a\u6cd5\u3002\n\n\n\u505a\u6cd5\u4e00:\u53ef\u64a4\u9500\u5e76\u67e5\u96c6\u3002\n\u5c06\u4efb\u4f55\u65f6\u5019\u90fd\u4e00\u6837\u9ad8\u7684\u8fb9(\u4ee5\u4e0b\u79f0\u5176\u4e3a\u4e07\u80fd\u8fb9)\u6700\u5148\u52a0\u5165\u5e76\u67e5\u96c6\uff0c\u7136\u540e\u679a\u4e3e\u6bcf\u4e00\u4e2a\u51fa\u73b0\u8fc7\u7684\u5929\u6570\uff0c\u5c06\u540c\u662f\u8fd9\u4e2a\u5929\u6570\u7684\u8fb9\u52a0\u5165\u5e76\u67e5\u96c6\uff0c\u6bcf\u6b21\u627e\u5230\u6700\u5927\u8fde\u901a\u5757\u3002\n\n\u6ce8\u610f\u6bcf\u4e00\u4e2a\u5929\u6570\u679a\u4e3e\u5b8c\u8981\u64a4\u9500\u3002\u65f6\u95f4\u590d\u6742\u5ea6$O(n^2log^2n)$\n\n\u4ee3\u7801\u5b9e\u73b0:\n```cpp\n#include<cstdio>\n#include<algorithm>\n#define d(i,j) ((i-1)*n+j)\n#define esp 1e-12\n#define max(a,b) ((a)>(b)?(a):(b))\n#define abs(x) ((x)>0?(x):-(x))\nusing namespace std;\nint n,m,k,ans=1,cnt,un,wn,lasttop;\nstruct yyy{int x,y;double z;}s[2000039];\nint a[2039][2039],b[2039][2039];\ninline bool cmp(yyy x,yyy y){return x.z<y.z;}\ninline void swap(int &x,int &y){x^=y^=x^=y;}\nstruct ques{int x,y,flag;};\nstruct dsu{\n\tint fa[600039],w[600039],siz[600039],sh;\n\tques st[600039],tmp;\n\tinline int find(int x){return fa[x]==x?x:find(fa[x]);}\n\tinline void merge(int x,int y){\n\t\tint un=find(x),wn=find(y);\n\t\tif(un!=wn){\n\t\t\tif(w[un]<w[wn]) swap(un,wn);\n\t\t\tst[++sh]=(ques){un,wn,w[un]==w[wn]};\n\t\t\tsiz[un]+=siz[wn];fa[wn]=un;w[un]+=(w[un]==w[wn]);\n\t\t}\n\t}\n\tinline void del(){\n\t\ttmp=st[sh--];\n\t\tfa[tmp.y]=tmp.y;w[tmp.x]-=tmp.flag;siz[tmp.x]-=siz[tmp.y];\n\t}\n}f;\nint main(){\n\tfreopen(\"1.in\",\"r\",stdin);\n//\tfreopen(\"suma.out\",\"w\",stdout);\n\tregister int i,j,h;\n\tscanf(\"%d\",&n);\n\tfor(i=1;i<=n;i++){\n\t\tfor(j=1;j<=n;j++) scanf(\"%d\",&a[i][j]);\n\t}\n\tfor(i=1;i<=n;i++){\n\t\tfor(j=1;j<=n;j++) scanf(\"%d\",&b[i][j]);\n\t}\n\tfor(i=1;i<=n*n;i++) f.fa[i]=i,f.siz[i]=f.w[i]=1;\n\tfor(i=1;i<=n;i++){\n\t\tfor(j=1;j<=n;j++){\n\t\t\tif(i!=1){\n\t\t\t\tif(b[i][j]==b[i-1][j]){\n\t\t\t\t\tif(a[i][j]==a[i-1][j])f.merge(d(i,j),d(i-1,j));\n\t\t\t\t} \n\t\t\t\telse s[++cnt]=(yyy){d(i,j),d(i-1,j),((double)(a[i-1][j]-a[i][j]))/(b[i][j]-b[i-1][j])};\n\t\t\t} \n\t\t\tif(s[cnt].z<-esp) cnt--;\n\t\t\tif(j!=1){\n\t\t\t\tif(b[i][j]==b[i][j-1]){\n\t\t\t\t\tif(a[i][j]==a[i][j-1])f.merge(d(i,j),d(i,j-1));\n\t\t\t\t} \n\t\t\t\telse s[++cnt]=(yyy){d(i,j),d(i,j-1),((double)(a[i][j-1]-a[i][j]))/(b[i][j]-b[i][j-1])};\n\t\t\t} \n\t\t    if(s[cnt].z<-esp) cnt--;\n\t\t}\n\t}\n\tsort(s+1,s+cnt+1,cmp);lasttop=f.sh;\n\tfor(i=1;i<=n*n;i++) ans=max(ans,f.siz[i]);\n\tfor(i=1;i<=cnt;i++){\n\t\tfor(j=i;j<=cnt;j++){\n\t\t\tif(abs(s[i].z-s[j].z)>esp) break;\n\t\t\tf.merge(s[j].x,s[j].y);\n\t\t\tun=f.siz[f.find(s[j].x)];\n\t\t\tans=max(ans,un);\n\t\t}\n\t\twhile(f.sh!=lasttop) f.del();\n\t\ti=j-1;\n\t}\n\tprintf(\"%d\\n\",ans);\n}\n```\n\u505a\u6cd5\u4e8c:\u5c06\u6240\u6709\u4e07\u80fd\u8fb9\u52a0\u5165\u5e76\u67e5\u96c6\u7f29\u70b9\uff0c\u7136\u540e\u540c\u6837\u679a\u4e3e\u5929\u6570\u6bcf\u6b21\u8fdb\u884cdfs\u67e5\u627e\u8fde\u901a\u5757\u5927\u5c0f\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6$O(n^2)$\uff0c\u4f46\u8fd8\u6ca1\u5e76\u67e5\u96c6\u8dd1\u5f97\u5feb\u3002\n\n\u4ee3\u7801\u5b9e\u73b0(\u653e\u4e00\u4e0bzjdl\u7684\u4ee3\u7801):\n```cpp\n#include<cstdio>\n#include<algorithm>\n#define ll long long\n#define maxn 2001\nusing namespace std;\nint n;\nstruct frac{\n\tint x,y;//x/y\n\tfrac(int x=0,int y=1):x(x),y(y){}\n\tfriend bool operator == (const frac &a,const frac &b){\n\t\treturn (ll)a.x*b.y==(ll)b.x*a.y;\n\t}\n\tfriend bool operator < (const frac &a,const frac &b){\n\t\tif((ll)a.y*b.y>0)return (ll)a.x*b.y-(ll)b.x*a.y<0;\n\t\telse return (ll)a.x*b.y-(ll)b.x*a.y>0;\n\t}\n};\nstruct edges{\n\tint u,v;\n\tfrac k;\n}edge[maxn*maxn];\nint len;\nvoid add(int u,int v,frac k){\n\tedge[++len]=(edges){u,v,k};\n}\nint dx[4]={0,1,0,-1};\nint dy[4]={1,0,-1,0};\nint id(int x,int y){return (x-1)*n+y;}\nint a[maxn][maxn],b[maxn][maxn];\nint fa[maxn*maxn],size[maxn*maxn],ksize[maxn*maxn],w[maxn*maxn],tans;\nint get(int x){return fa[x]==x?x:fa[x]=get(fa[x]);}\nvoid merge(int x,int y){\n\tint gx=get(x),gy=get(y);\n\tif(gx==gy)return;\n\tsize[gy]+=size[gx];\n\tfa[gx]=gy;\n\tw[gy]+=w[gx];\n\ttans=max(tans,w[gy]);\n}\nint ans;\nbool cmp(const edges &x,const edges &y){\n\treturn x.k<y.k;\n}\nint main(){\n\tscanf(\"%d\",&n);\n\tfor(int i=1;i<=n;i++)for(int j=1;j<=n;j++)scanf(\"%d\",&b[i][j]);\n\tfor(int i=1;i<=n;i++)for(int j=1;j<=n;j++)scanf(\"%d\",&a[i][j]);\n\tfor(int i=1;i<=n*n;i++)fa[i]=i,size[i]=1;\n\tfor(int i=1;i<=n;i++){\n\t\tfor(int j=1;j<=n;j++){\n\t\t\tfor(int k=0;k<4;k++){\n\t\t\t\tint ii=i+dx[k],jj=j+dy[k];\n\t\t\t\tif(a[i][j]==a[ii][jj]&&b[i][j]==b[ii][jj])merge(id(i,j),id(ii,jj));\n\t\t\t}\n\t\t}\n\t}\n\tfor(int i=1;i<=n*n;i++)get(i),ksize[fa[i]]=size[fa[i]];\n\tfor(int i=1;i<=n;i++){\n\t\tfor(int j=1;j<=n;j++){\n\t\t\tfor(int k=0;k<4;k++){\n\t\t\t\tint ii=i+dx[k],jj=j+dy[k];\n\t\t\t\tif(ii<1||ii>n||jj<1||jj>n)continue;\n\t\t\t\tif(fa[id(i,j)]==fa[id(ii,jj)])continue;\n\t\t\t\tif(a[i][j]==a[ii][jj])continue;\n\t\t\t\tif((ll)(b[i][j]-b[ii][jj])*(a[ii][jj]-a[i][j])<0)continue;\n\t\t\t\tadd(fa[id(i,j)],fa[id(ii,jj)],frac(b[i][j]-b[ii][jj],a[ii][jj]-a[i][j]));\n\t\t\t}\n\t\t}\n\t}\n\tsort(edge+1,edge+1+len,cmp);\n\tfor(int i=1;i<=n*n;i++)fa[i]=i,size[i]=1,w[i]=ksize[i],ans=max(ans,w[i]);\n\ttans=0;\n\tint l=1;\n\tfor(int i=1;i<=len;i++){\n\t\tif(i!=len&&edge[i].k==edge[i+1].k){\n\t\t\tmerge(edge[i].u,edge[i].v);\n\t\t}\n\t\telse{\n\t\t\tans=max(ans,tans);\n\t\t\tfor(int j=l;j<=i;j++){\n\t\t\t\tfa[edge[j].u]=edge[j].u;\n\t\t\t\tfa[edge[j].v]=edge[j].v;\n\t\t\t\tsize[edge[j].u]=size[edge[j].v]=1;\n\t\t\t\tw[edge[j].u]=ksize[edge[j].u];\n\t\t\t\tw[edge[j].v]=ksize[edge[j].v];\n\t\t\t}\n\t\t\ttans=0;l=i+1;\n\t\t}\n\t}\n\tprintf(\"%d\",ans);\n\treturn 0;\n}\n```",
        "postTime": 1611325427,
        "uid": 181766,
        "name": "275307894a",
        "ccfLevel": 0,
        "title": "luogu P6405 [COCI2014-2015#2] \u0160UMA"
    },
    {
        "content": "[BLOG](https://wgyhm.cf/2022/10/17/P6405-COCI2014-2015-2-SUMA/)\n\n\u76f8\u90bb\u4e24\u68f5\u6811\u7684\u5173\u7cfb\u662f\u4ee5\u4e0b\u51e0\u79cd\u4e4b\u4e00\uff1a\n\n* $h_i=h_j,v_i=v_j$ \u6c38\u8fdc\u76f8\u7b49\uff0c\u6211\u4eec\u79f0\u4e3a **\u4e07\u80fd\u8fb9**\u3002\n* $h_i=h_j,v_i\\not = v_j$ \u6c38\u8fdc\u4e0d\u76f8\u7b49\u3002\n* $t=\\dfrac{h_i-h_j}{v_j-v_i}$\uff0c\u4e24\u68f5\u6811\u5f53\u4e14\u4ec5\u5f53\u5728\u65f6\u523b $t$ \u65f6\u76f8\u7b49\u3002\u5982\u679c\u65f6\u523b $t<0$ \uff0c\u90a3\u4e48\u6c38\u8fdc\u4e0d\u76f8\u7b49\u3002\u5426\u5219\uff0c\u6211\u4eec\u628a\u4e24\u68f5\u6811\u7684\u8fb9\u6743\u8bbe\u4e3a $t$\u3002\n\n\u6211\u4eec\u628a\u4e07\u80fd\u8fb9\u7528\u5e76\u67e5\u96c6\u7f29\u6210\u4e00\u4e2a\u70b9\uff0c\u5e76\u91cd\u65b0\u5efa\u56fe\u3002\u7136\u540e\u628a\u6240\u6709\u7684\u4e24\u4e2a\u6570\u76f8\u7b49\u7684\u65f6\u523b $t$ \u79bb\u6563\u5316\uff0c\u65b9\u4fbf\u679a\u4e3e\u3002\n\n\u679a\u4e3e\u65f6\u523b $t$\uff0c\u5c06\u6240\u6709\u8fb9\u6743\u4e3a $t$ \u7684\u4e24\u4e2a\u70b9\u5408\u5e76\u3002\u5e76\u5224\u65ad\u6700\u5927\u7684\u8fde\u901a\u5757\u3002\n\n\u6bcf\u4e2a\u975e\u4e07\u80fd\u8fb9\u6700\u591a\u679a\u4e3e\u4e00\u6b21\u3002\u4e07\u80fd\u8fb9\u5df2\u7ecf\u7f29\u6ca1\u4e86\u3002\u6240\u4ee5\u590d\u6742\u5ea6\u65f6 $O(cn^2)$\uff0c\u5176\u4e2d $c$ \u662f\u5e76\u67e5\u96c6\u7684\u590d\u6742\u5ea6\u3002\n\n```cpp\n#include<bits/stdc++.h>\n#define ll long long\n#define ull unsigned long long\n#define maxn 705\n#define put() putchar('\\n')\n#define Tp template<typename Ty>\n#define Ts template<typename Ty,typename... Ar>\nusing namespace std;\ninline void read(int &x){\n    int f=1;x=0;char c=getchar();\n    while (c<'0'||c>'9') {if (c=='-') f=-1;c=getchar();}\n    while (c>='0'&&c<='9') {x=x*10+c-'0';c=getchar();}\n    x*=f;\n}\nnamespace Debug{\n\tTp void _debug(char* f,Ty t){cerr<<f<<'='<<t<<endl;}\n\tTs void _debug(char* f,Ty x,Ar... y){while(*f!=',') cerr<<*f++;cerr<<'='<<x<<\",\";_debug(f+1,y...);}\n\tTp ostream& operator<<(ostream& os,vector<Ty>& V){os<<\"[\";for(auto& vv:V) os<<vv<<\",\";os<<\"]\";return os;}\n\t#define gdb(...) _debug(#__VA_ARGS__,__VA_ARGS__)\n}using namespace Debug;\nint h[maxn][maxn],v[maxn][maxn],n,m;\nint he[maxn*maxn],head=1;\nstruct yyy{\n\tint to,z,wx,wy;\n\tinline void add(int x,int y,int val,int vall) {\n\t\tto=y;z=he[x];he[x]=head;wx=val;wy=vall;\n\t}\n}a[maxn*maxn*8];\nstruct edges {\n\tint x,y;\n\tedges(int a=0,int b=0) {x=a;y=b;}\n};\nint fx[5]={0,1,-1,0,0};\nint fy[5]={0,0,0,1,-1};\nvector<edges>e[maxn*maxn];\ninline int id(int x,int y) {return (x-1)*n+y;}\nint size[maxn*maxn],fa[maxn*maxn],vis[maxn*maxn],nsize[maxn*maxn],tr[maxn*maxn];\ninline int getfa(int x) {return x==fa[x]?x:fa[x]=getfa(fa[x]);}\ninline void merge(int x,int y) {\n\tx=getfa(x),y=getfa(y);\n\tif (x^y) fa[x]=y,size[y]+=size[x];\n}\ninline void dfs(int x,int cur) {\n\tint i;vis[x]=1,merge(x,cur);\n\tfor (i=he[x];i;i=a[i].z) if (a[i].wx==-1&&a[i].wy==-1&&!vis[a[i].to]) dfs(a[i].to,cur);\n}\nint tot,ans;\nll g[maxn*maxn*4];\nconst int base=1e6;\nsigned main(void){\n\tint i,j,k,x,y,gg;\n\tread(n);\n\tfor (i=1;i<=n;i++) for (j=1;j<=n;j++) read(h[i][j]);\n\tfor (i=1;i<=n;i++) for (j=1;j<=n;j++) read(v[i][j]);\n\tfor (i=1;i<=n;i++) {\n\t\tfor (j=1;j<=n;j++) {\n\t\t\tfor (k=1;k<=4;k++) {\n\t\t\t\tx=i+fx[k],y=j+fy[k];\n\t\t\t\tif (x>=1&&x<=n&&y>=1&&y<=n) ;else continue;\n\t\t\t\tif (v[i][j]==v[x][y]) {\n\t\t\t\t\tif (h[i][j]==h[x][y]) a[++head].add(id(i,j),id(x,y),-1,-1);\n\t\t\t\t}\n\t\t\t\telse if (h[i][j]==h[x][y]) a[++head].add(id(i,j),id(x,y),0,0);\n\t\t\t\telse {\n\t\t\t\t\tint tmpy=h[x][y]-h[i][j],tmpx=v[i][j]-v[x][y];\n\t\t\t\t\tif (1ll*tmpx*tmpy<0) continue;\n\t\t\t\t\ttmpy=abs(tmpy),tmpx=abs(tmpx);gg=__gcd(tmpx,tmpy);\n\t\t\t\t\ta[++head].add(id(i,j),id(x,y),tmpy/gg,tmpx/gg);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tfor (i=1;i<=n;i++) for (j=1;j<=n;j++) size[id(i,j)]=1,fa[id(i,j)]=id(i,j);\n\tfor (i=1;i<=n;i++) for (j=1;j<=n;j++) if (!vis[id(i,j)]) dfs(id(i,j),id(i,j));//,gdb(i,j,size[getfa(id(i,j))]);\n\tint cnt=0;\n\tfor (i=1;i<=n;i++) for (j=1;j<=n;j++) if (fa[id(i,j)]==id(i,j)) tr[id(i,j)]=++cnt,nsize[cnt]=size[id(i,j)];//,gdb(i,j,cnt,nsize[cnt]);\n\tfor (i=1;i<=n;i++) {\n\t\tfor (j=1;j<=n;j++) {\n\t\t\tint pus=getfa(id(i,j));\n\t\t\tfor (k=he[pus];k;k=a[k].z) {\n\t\t\t\tint now=getfa(a[k].to);\n\t\t\t\tif (tr[now]!=tr[pus])assert(a[k].wx!=-1),g[++tot]=1ll*a[k].wx*base+a[k].wy;\n\t\t\t} \n\t\t}\n\t}\n\tsort(g+1,g+1+tot);\n\ttot=unique(g+1,g+1+tot)-g-1;\n\tfor (i=1;i<=n;i++) {\n\t\tfor (j=1;j<=n;j++) {\n\t\t\tint pus=getfa(id(i,j));\n\t\t\tfor (k=he[pus];k;k=a[k].z) {\n\t\t\t\tint now=getfa(a[k].to);\n\t\t\t\tif (tr[now]!=tr[pus]) {\n\t\t\t\t\tint w=lower_bound(g+1,g+1+tot,1ll*a[k].wx*base+a[k].wy)-g;\n\t\t\t\t\te[w].push_back(edges(tr[pus],tr[now]));\n\t\t\t\t}\n\t\t\t} \n\t\t}\n\t}\n\tfor (i=1;i<=cnt;i++) fa[i]=i,size[i]=nsize[i];\n\tfor (i=1;i<=tot;i++) {\n\t\tfor (auto tmp:e[i]) {\n\t\t\tmerge(tmp.x,tmp.y);\n\t\t\tans=max(ans,size[getfa(tmp.x)]);\n\t\t}\n\t\tfor (auto tmp:e[i]) fa[tmp.x]=tmp.x,size[tmp.x]=nsize[tmp.x],fa[tmp.y]=tmp.y,size[tmp.y]=nsize[tmp.y];\n\t}\n\tprintf(\"%d\",ans);\n\treturn 0;\n}\n\n```\n\n",
        "postTime": 1665993285,
        "uid": 51569,
        "name": "\u8fdd\u89c4\u7528\u6237\u540dFkZyA0!2",
        "ccfLevel": 0,
        "title": "P6405 [COCI2014-2015#2] \u0160UMA"
    }
]