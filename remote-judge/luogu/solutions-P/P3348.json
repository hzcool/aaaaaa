[
    {
        "content": "## \u601d\u8def\u5206\u6790\n\n\u6700\u7b80\u5355\u7c97\u66b4\u7684\u60f3\u6cd5\uff0c\u80af\u5b9a\u662f\u5927\u529bLCT\uff0c\u6bcf\u4e2a\u6811\u90fd\u6765\u4e00\u904dlink\u4e4b\u7c7b\u7684\u64cd\u4f5c\u5566\uff08T\u98de\u5c31\u4e0d\u8bf4\u4e86\uff09\n\n\u8003\u8651\u5982\u4f55\u4f18\u5316\u7b97\u6cd5\u3002\u5982\u679c\u6ca1\u67091\u64cd\u4f5c\uff0c\u80af\u5b9a\u6bcf\u4e2a\u6811\u90fd\u957f\u4e00\u6837\u3002\u6709\u4e861\u64cd\u4f5c\uff0c\u5c31\u6765\u4ed4\u7ec6\u5206\u6790\u4e00\u4e0b\u5bf9\u4e0d\u540c\u6811\u7684\u5f71\u54cd\u3002\n\n\u5047\u8bbe\u6709\u4e00\u4e2a1\u64cd\u4f5c\u5f62\u5982$l\\ r\\ x$\uff0c\u90a3\u4e48\u4ece\u5fae\u89c2\u6765\u770b\u5dee\u5f02\uff0c\u6211\u4eec\u53ea\u5173\u6ce8\u7b2cl-1\u68f5\u6811\u548c\u7b2cl\u68f5\u6811\u3002\u518d\u5047\u8bbe\u4ee5\u540e\u90fd\u6ca1\u6709\u4e860\u64cd\u4f5c\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u8ba4\u4e3a\uff0c\u7b2cl\u68f5\u6811\u662f\u7b2cl-1\u68f5\u6811\u628a\u8fd9\u4e2a1\u64cd\u4f5c\u4ee5\u540e\u5ac1\u63a5\u5728\u539f\u6765\u751f\u957f\u8282\u70b9\u4e0a\u7684\u6240\u6709\u8282\u70b9\uff08\u4ee5\u53ca\u6240\u6709\u5b50\u6811\uff09\u5168\u90e8\u8f6c\u800c\u5ac1\u63a5\u5230x\u4e0a\u3002\u518d\u770b\u7b2cr\u68f5\u6811\u548c\u7b2cr+1\u68f5\u6811\uff0c\u662f\u4e0d\u662f\u53ef\u4ee5\u8ba4\u4e3a\u53c8\u628a\u8fd9\u4e9b\u5b50\u6811\u5ac1\u63a5\u56de\u6765\u4e86\u5bf9\u5427\uff1f\n\n\u6ce8\u610f\u5230\u9898\u76ee\u6ca1\u6709\u8bf4\u5728\u7ebf\uff0c\u53c8\u56e0\u4e3a1\u64cd\u4f5c\u662f\u6709\u9650\u7684\uff0c\u53ea\u6709\u4e24\u4e2a\u7aef\u70b9\uff0c\u90a3\u4e48\u5982\u679c\u6211\u4eec\u80fd\u591f\u5feb\u901f\u4ece\u4e00\u68f5\u6811\u8f6c\u79fb\u5230\u4e0b\u4e00\u9897\u6811\uff0c\u590d\u6742\u5ea6\u5c31\u80fd\u591f\u4fdd\u8bc1\u4e86\u3002\n\n\u95ee\u9898\u5c31\u5728\u4e8e\uff0c\u600e\u6837\u628a\u4e00\u5806\u5b50\u6811\u7684\u7236\u4eb2\u5168\u90e8\u8f6c\u79fb\u3002~~zcy\u592a\u5f3a\u8fa3\uff0c\u6211\u4ec0\u4e48ETT\u90fd\u4e0d\u4f1a~~\u3002\u3002\u3002\u3002\u3002\u3002\n\n\u6240\u4ee5\u53ef\u80fd\u53c8\u8981\u7528\u4e00\u4e2a\u865a\u70b9\u7684\u5957\u8def\u3002\u5bf9\u4e8e\u6bcf\u4e2a1\u64cd\u4f5c\u5efa\u4e00\u4e2a\u865a\u70b9\uff0c\u4ee5\u540e\u76840\u64cd\u4f5c\u90fd\u8fde\u5728\u6700\u8fd1\u5efa\u597d\u7684\u865a\u70b9\u4e0a\u3002\u8fd9\u6837\u6bcf\u6b21\u6574\u4f53\u5ac1\u63a5\u7684\u65f6\u5019\uff0c\u76f4\u63a5\u628a\u8fd9\u4e2a\u865a\u70b9\u65ad\u6389\u5b83\u539f\u6765\u7684\u7236\u4eb2\uff0c\u518dlink\u8fc7\u53bb\u5c31\u5927\u529f\u544a\u6210\u5566\uff01\u4e00\u5f00\u59cb\u9ed8\u8ba4\u6240\u6709\u865a\u70b9\u90fd\u5728\u4e00\u8d77\uff08\u8868\u793a\u9ed8\u8ba4\u751f\u957f\u8282\u70b9\u4ece\u6765\u6ca1\u53d8\u8fc7\uff09\uff0c\u628a1\u64cd\u4f5c\u62c6\u6210\u4e24\u4e2a\u5ac1\u63a5\u64cd\u4f5c\uff0c\u518d\u5bf9\u6240\u6709\u64cd\u4f5c\u4ee5\u7aef\u70b9\u4e3a\u7b2c\u4e00\u5173\u952e\u5b57\uff0c\u539f\u65f6\u95f4\u987a\u5e8f\u4e3a\u7b2c\u4e8c\u5173\u952e\u5b57\u6392\u5e8f\uff0c\u518d\u4ece\u5de6\u5230\u53f3\u4e00\u4e2a\u4e2a\u5904\u7406\u3002\n\n\u81f3\u4e8e2\u64cd\u4f5c\uff0c\u53ef\u4ee5\u53d1\u73b0\u7b49\u4e00\u68f5\u6811\u5168\u5904\u7406\u5b8c\u518d\u56de\u7b54\u5173\u4e8e\u8fd9\u68f5\u6811\u7684\u6240\u6709\u8be2\u95ee\u662f\u5b8c\u5168\u6ca1\u6709\u95ee\u9898\u7684\u3002\u5177\u4f53\u5b9e\u73b0\u53c8\u600e\u4e48\u529e\uff1f\u9996\u5148\u8981\u8bbe\u70b9\u6743\u4e86\uff0c\u5b9e\u70b9\uff080\u64cd\u4f5c\u52a0\u7684\u70b9\uff09\u4e3a1\uff0c\u865a\u70b9\u4e3a0\u3002\u7136\u540e\u5c31split\uff1fNoNoNo\uff01\u7b2c\u4e00\uff0c\u8fd9\u4e2a\u6811\u662f\u6709\u6839\u7684\uff08\u6839\u4e3a1\uff09\uff0c\u5f3a\u884cmakeroot\u4f1a\u7834\u574f\u539f\u5148\u7684\u7236\u5b50\u5173\u7cfb\uff1b\u7b2c\u4e8c\uff0c\u4e24\u4e2a\u70b9\u5728LCT\u4e2d\u7684LCA\u53ef\u80fd\u662f\u865a\u70b9\uff01\u90a3\u53c8\u5982\u4f55\u662f\u597d\uff1f\u53c8\u6765\u4e00\u6ce2\u6811\u4e0a\u5dee\u5206\uff0c\u7b54\u6848\u662f$s[x]+s[y]-2*s[$LCT\u4e2d\u7684LCA$]$\uff08~~\u8c8c\u4f3c\u4e0d\u592a\u65b9\u4fbf\u76f4\u63a5\u8bc1\u660e\uff0c\u81ea\u5df1\u4e3e\u4e00\u4e9b\u6817\u5b50yy\u5c31\u597d\u5566qwq~~\uff09\n\n\u7136\u540e\u5728LCT\u4e2d\u5982\u4f55\u6c42LCA\u5462\uff1f\u5c31\u662faccess(x)\u518d\u63a5\u7740access(y)\uff0caccess(y)\u8fc7\u7a0b\u4e2d\u6700\u540e\u4e00\u4e2a\u8df3\u5230\u7684\u865a\u8fb9\u7684\u7236\u8282\u70b9\uff08\u5728access\u5b8c\u6210\u540e\u51fd\u6570\u91cc\u7684x\u4f1a\u53d8\u62100\uff0c\u800cy\u5c31\u662f\u8fd9\u4e2a\u70b9\uff09\u3002\u719f\u6089LCT\u7684\u5404\u79cd\u6027\u8d28\u5e94\u8be5\u662f\u53ef\u4ee5\u5f88\u8f7b\u677e\u7684\u77e5\u9053\u8fd9\u79cd\u65b9\u6cd5\u3002\uff08\u5173\u4e8e\u6027\u8d28\u65b9\u9762[\u849f\u84bb\u7684LCT\u603b\u7ed3](http://www.cnblogs.com/flashhu/p/8324551.html)\u4f9d\u65e7\u5e0c\u671b\u8def\u8fc7\u7684Dalao\u4eec\u6307\u6b63qwq\uff09\n\n\u86c7\u76ae\u538b\u884c\u5361\u5e38\uff08\u61d2\u5f97\u5199fread\u4e86\uff09\u5de8\u4e11\u65e0\u6bd4\u7684\u4ee3\u7801\n~~\u4e0d\u8fc7\u53d8\u91cf\u540d\u5e94\u8be5\u662f\u5f88\u597d\u61c2\u7684~~\n```cpp\n#include<cstdio>\n#include<cstring>\n#include<algorithm>\n#define RG register\n#define R RG int\n#define I inline\n#define G ch=getchar()\n#define lc c[x][0]\n#define rc c[x][1]\n#define qr(P,O,X,Y) qry[++q]=(QRY){P,O,X,Y}\nusing namespace std;\nconst int N=300009;\nstruct QRY{//\u5c01\u7ed3\u6784\u4f53\uff0c\u628a\u5ac1\u63a5\u548c\u8be2\u95ee\u6309\u987a\u5e8f\u6392\u5e8f\n    int pos,ord,x,y;\n    I bool operator<(RG QRY a)const{\n        return pos<a.pos||(pos==a.pos&&ord<a.ord);\n    }\n}qry[N];\nint f[N],c[N][2],s[N],gl[N],gr[N],at[N],ans[N];\nbool v[N];\nI void in(R&x){\n    register char G;\n    while(ch<'-')G;\n    x=ch&15;G;\n    while(ch>'-')x*=10,x+=ch&15,G;\n}\nI bool nrt(R x){return c[f[x]][0]==x||c[f[x]][1]==x;}\nI void up(R x){s[x]=s[lc]+s[rc]+v[x];}\nI void rot(R x){\n    R y=f[x],z=f[y],k=c[y][1]==x,w=c[x][!k];\n    if(nrt(y))c[z][c[z][1]==y]=x;c[x][!k]=y;c[y][k]=w;\n    up(f[w]=y);f[y]=x;f[x]=z;\n}\nI void sp(R x){\n    for(R y;nrt(x);rot(x))\n        if(nrt(y=f[x]))rot((c[f[y]][0]==y)^(c[y][0]==x)?x:y);\n    up(x);\n}\nI int ac(R x){R y=0;while(x)sp(x),rc=y,up(y=x),x=f[x];return y;}\nI void ct(R x){ac(x);sp(x);lc=f[lc]=0;up(x);}\nI void lk(R x,R y){sp(x);f[x]=y;}//\u849f\u84bb\u7684LCT\u8d8a\u5199\u8d8a\u4e11\u4e86\u3002\u3002\u3002\nint main(){\n    R q=0,tot=0,n,m,p,real,aux,i,op,l,r,x,y;\n    in(n);in(m);\n    real=v[1]=s[1]=at[1]=gl[1]=1;gr[1]=n;\n    lk(p=aux=2,1);//\u4e00\u5f00\u59cb\u4e5f\u8981\u6765\u4e00\u4e2a\u865a\u70b9\n    for(i=1;i<=m;++i){\n        in(op);in(l);in(r);\n        if(op==0){//\u9ed8\u8ba4\u4e00\u5f00\u59cb\u5168\u957f\u5728\u4e00\u8d77\n            lk(at[++real]=++p,aux);v[p]=s[p]=1;\n            gl[real]=l;gr[real]=r;\n        }//gl\u548cgr\u65b9\u4fbf\u4e0b\u9762\u628a\u65e0\u7528\u7684\u533a\u95f4\u53bb\u6389\n        else if(op==1){//\u6709\u4e9b\u533a\u95f4\u8fde\u8fd9\u4e2a\u70b9\u90fd\u6ca1\u957f\u51fa\u6765\uff0c\u76f4\u63a5\u53d6min\uff0cmax\n            in(x);l=max(l,gl[x]);r=min(r,gr[x]);\n            if(l>r)continue;\n            lk(++p,aux);\n            qr(l,i-m,p,at[x]);qr(r+1,i-m,p,aux);//-m\u662f\u4e3a\u4e86\u628a\u6240\u6709\u5ac1\u63a5\u653e\u5230\u8be2\u95ee\u4e4b\u524d\n            aux=p;//\u66f4\u65b0\u751f\u957f\u8282\u70b9\u4f4d\u7f6e\n        }\n        else in(x),qr(l,++tot,at[r],at[x]);\n    }\n    sort(qry+1,qry+q+1);\n    for(i=1;i<=q;++i){\n        if(qry[i].ord>0){\n              ac(x=qry[i].x);sp(x);r=s[x];\n            l=ac(y=qry[i].y);sp(y);r+=s[y];\n              ac(l);ans[qry[i].ord]=r-(s[l]<<1);//\u5dee\u5206\u4e00\u4e0b\n        }\n        else ct(qry[i].x),lk(qry[i].x,qry[i].y);\n    }\n    for(i=1;i<=tot;++i)printf(\"%d\\n\",ans[i]);\n    return 0;\n}\n```",
        "postTime": 1522836237,
        "uid": 61325,
        "name": "FlashHu",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P3348 \u3010[ZJOI2016]\u5927\u68ee\u6797\u3011"
    },
    {
        "content": "### 1.\u601d\u8def\n1.\u6240\u6709\u4fee\u6539\u548c\u67e5\u8be2\u90fd\u79bb\u7ebf\u5904\u7406\uff0c\u53cc\u5173\u952e\u5b57\u6392\u5e8f\uff0c\u7b2c\u4e00\u5173\u952e\u5b57\uff1a\u4f4d\u7f6e\uff0c\u7b2c\u4e8c\u5173\u952e\u5b57\uff1a\u64cd\u4f5c\u987a\u5e8f\uff08\u4e25\u683c\u4fdd\u8bc1\u4fee\u6539\u5728\u67e5\u8be2\u524d\uff09\u3002\n    \n2.\u672c\u9898 `makeroot` \u4f1a\u7834\u574f\u7236\u5b50\u5173\u7cfb\uff0c\u6240\u4ee5\u6211\u4eec `link` \u64cd\u4f5c\u65f6\u65e0\u6cd5\u4f7f\u7528 `makeroot` \u3002\u8bc1\u660e\u53ca\u64cd\u4f5c\u5728\u4e0b\u9762\u3002\n    \n3.\u5bf9\u4e8e\u6bcf\u6b21 0 \u64cd\u4f5c\uff0c\u6211\u4eec\u8bb0\u5f55\u4e0b\u5de6\u53f3\u7aef\u70b9\uff0c 1 \u64cd\u4f5c\u8981\u66f4\u6539\u65f6\u53ef\u4ee5\u76f4\u63a5\u83b7\u5f97\u5305\u542b\u6b64\u8282\u70b9\u7684\u533a\u95f4\uff0c\u5e76\u628a\u65b0\u5efa\u8282\u70b9\u4e0e\u6700\u8fd1\u7684\u865a\u8282\u70b9 `link` \u3002\n\n4.\u5bf9\u4e8e\u6bcf\u6b21 1 \u64cd\u4f5c\uff0c\u6211\u4eec\u91c7\u7528\u7c7b\u4f3c\u4e8e\u5dee\u5206\u7684\u601d\u8def\uff0c\u6211\u4eec\u5efa\u4e00\u4e2a\u865a\u8282\u70b9\uff0c\u5e76\u628a\u4fee\u6539\u62c6\u6210\u4e24\u6b21\u64cd\u4f5c\u3002\n  \n4.1\uff1a\u904d\u5386\u5230 $l$ \u65f6\uff0c\u5c06\u65b0\u5efa\u865a\u8282\u70b9\uff08\u5305\u542b\u540e\u9762\u7684\u65b0\u5efa\u8282\u70b9\uff09\u4e0e\u8981\u4fee\u6539\u7684\u751f\u957f\u8282\u70b9 `link` \uff0c\u4ece\u800c\u8fbe\u5230\u628a $l - r$ \u7684\u4ee5\u540e\u7684 0 \u64cd\u4f5c\u90fd\u5728\u8981\u4fee\u6539\u7684\u751f\u957f\u8282\u70b9\u4e4b\u4e0b\u7684\u76ee\u7684\u3002\n\n4.2\uff1a\u904d\u5386\u5230 $r+1$ \u65f6\uff0c $r+1 - n$ \u4e0e\u6b64\u64cd\u4f5c\u65e0\u5173\uff0c\u6240\u4ee5\u9700\u8981\u628a\u65b0\u5efa\u865a\u8282\u70b9\u4e0e\u4e0a\u4e00\u4e2a\u865a\u8282\u70b9 link \u4ece\u800c\u8fbe\u5230 $r+1 - n$ \u4e0d\u53d7\u6b64\u64cd\u4f5c\u5f71\u54cd\u7684\u76ee\u7684\u3002\n\n\u4e0d\u61c2\u6362\u751f\u957f\u8282\u70b9\u64cd\u4f5c\u7684\u53ef\u4ee5\u770b\u4e0b\u9762\u7684\u56fe\uff0c 4 \u64cd\u4f5c\u5c31\u662f \u56fe1 - \u56fe2 - \u56fe1\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/dgomkre0.png)\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/n8qdw8ex.png)\n\n5.\u5bf9\u4e8e\u6bcf\u6b21 2 \u64cd\u4f5c\uff0c\u6211\u4eec\u76f4\u63a5\u5728 LCT \u4e0a\u6c42 `lca` \uff0c\u7136\u540e\u6811\u4e0a\u5dee\u5206\u6c42\u8ddd\u79bb\uff08$dis(x,y) = dep[x] + dep[y] - 2 \\times dep[lca]$\uff09\uff0c\n\n\u5982\u56fe\uff0c `access(x)` \u540e `access(y)` \u7684\u6700\u540e\u4e00\u6b21\u5230\u8fbe\u94fe\u4e0a\u7684\u8282\u70b9\u5373\u4e3a `lca` \uff0c\u56e0\u4e3a     `access(x)` \u540e $x$ \u7684\u6240\u6709\u7956\u5148\u8282\u70b9\u90fd\u5728\u94fe\u4e0a\uff0c\n\n`access(y)` \u6700\u540e\u4e00\u6b21\u5230\u8fbe\u94fe\u4e0a\u7684\u8282\u70b9\u5373\u4e3a $x$ \u548c $y$ \u7684\u516c\u5171\u7956\u5148\u4e14\u4e3a\u6700\u8fd1\u516c\u5171\u7956\u5148\u3002 $dep[x]$ \u5c31\u662f `access(x)` , `splay(x)` \u7684\u5b50\u6811\u5927\u5c0f\uff0c\u56e0\u4e3a\u94fe\u4e0a\u7684\u90fd\u662f\u7956\u5148\u8282\u70b9\u3002\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/eb6k7gfj.png)\n\n### 2.\u65e0 makeroot \u7684 link \u7684\u6b63\u786e\u6027\u8bc1\u660e\n\u5f88\u591a\u9898\u89e3\u90fd\u6ca1\u6709\u8bf4\u4e3a\u4ec0\u4e48 link \u524d\u53ef\u4ee5\u76f4\u63a5 `splay` ,\u7136\u540e\u6211\u60f3\u4e86\u4e00\u4e0b\u53d1\u73b0 `splay` \u90fd\u4e0d\u7528\u2026\u2026\u672c\u9898\u4e2d `link` \u6709\u4e24\u79cd\u60c5\u51b5\uff0c\u7b2c\u4e00\u79cd\u662f 1 \u548c 2 \u64cd\u4f5c\u4e2d\u7684\u65b0\u5efa\u8282\u70b9\uff0c\u6beb\u65e0\u7591\u95ee\u662f\u6839\uff0c\u7b2c\u4e8c\u79cd\u662f `sort` \u540e\u7684\u4fee\u6539\uff0c\u5728 `link` \u524d\u5df2\u7ecf `cut` \u4e86\uff0c\u6b64\u65f6\u6b64\u8282\u70b9\u5fc5\u4e3a\u6839\u3002\n```cpp\nvoid link(int x,int y)\n{\n  a[x].fa=y;\n}\n```\n### 3.\u4ee3\u7801\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nint n,m,k,x,y,z,l[300010],r[300010],cnt,last,cnt2,ans[300010];\nint read()\n{\n\tchar ch=getchar();\n\tint r=0,w=1;\n\twhile(ch<'0'||ch>'9') w=ch=='-'?-1:w,ch=getchar();\n\twhile(ch>='0'&&ch<='9') r=r*10+ch-'0',ch=getchar();\n\treturn r*w;\n}\nstruct LCT\n{\n\tstruct node\n\t{\n\t\tint v,sum,size,son[2],fa,tag;\n\t}a[300010];\n\tbool checkrt(int x)\n\t{\n\t\treturn a[a[x].fa].son[0]==x||a[a[x].fa].son[1]==x;\n\t}\n\tvoid pushup(int x)\n\t{\n\t\ta[x].sum=a[a[x].son[0]].sum+a[a[x].son[1]].sum+a[x].v;\n\t}\n\tvoid rotate(int x)\n\t{\n\t\tint fa=a[x].fa,ffa=a[fa].fa,k=a[fa].son[1]==x,f=a[x].son[!k];\n\t\tif(checkrt(fa))\n\t\ta[ffa].son[a[ffa].son[1]==fa]=x;\n\t\ta[x].son[!k]=fa,a[fa].son[k]=f;\n\t\tif(f)\n\t\ta[f].fa=fa;\n\t\ta[fa].fa=x,a[x].fa=ffa;\n\t\tpushup(fa);\n\t}\n\tvoid splay(int x)\n\t{\n\t\tint fa,ffa;\n\t\twhile(checkrt(x))\n\t\t{\n\t\t\tfa=a[x].fa,ffa=a[fa].fa;\n\t\t\tif(checkrt(fa))\n\t\t\trotate((a[fa].son[0]==x)^(a[ffa].son[0]==fa)?x:fa);\n\t\t\trotate(x);\n\t\t}\n\t\tpushup(x);\n\t}\n\tint access(int x)\n\t{\n\t\tint i;\n\t\tfor(i=0;x;x=a[i=x].fa)\n\t\tsplay(x),a[x].son[1]=i,pushup(x);\n\t\treturn i;\n\t}\n\tint LCA(int x,int y)\n\t{\n\t\taccess(x);\n\t\treturn access(y);\n\t}\n\tint dep(int x)\n\t{\n\t\taccess(x),splay(x);\n\t\treturn a[x].sum;\n\t}\n\tvoid link(int x,int y)\n\t{\n\t\ta[x].fa=y;\n\t}\n\tvoid cut(int x)\n\t{\n\t\taccess(x),splay(x);\n\t\ta[a[x].son[0]].fa=0,a[x].son[0]=0,pushup(x);\n\t}\n\tint ask(int x,int y)\n\t{\n\t\tint lca=LCA(x,y);\n\t\treturn dep(x)+dep(y)-2*dep(lca)+1;\n\t}\n}t;\nstruct ASK\n{\n\tint v,id,x,y;\n\tbool operator<(const ASK &z)const\n\t{\n\t\treturn v^z.v?v<z.v:id<z.id;\n\t}\n}a[300010];\nint main()\n{\n\tn=read(),m=last=read();\n\tl[1]=1,r[1]=n;\n\t++cnt,t.a[cnt].v=t.a[cnt].sum=1,++last;\n\tt.link(last,cnt);\n\tfor(int i=1;i<=m;i++)\n\t{\n\t\tk=read(),x=read(),y=read();\n\t\tif(!k)\n\t\t{\n\t\t\t++cnt,t.a[cnt].v=t.a[cnt].sum=1;\n\t\t\tl[cnt]=x,r[cnt]=y;\n\t\t\tt.link(cnt,last);\n\t\t}\n\t\telse if(k==1)\n\t\t{\n\t\t\tz=read();\n\t\t\tx=max(l[z],x),y=min(r[z],y);\n\t\t\tif(x>y)\n\t\t\tcontinue;\n\t\t\t++last;\n\t\t\tt.link(last,last-1);\n\t\t\ta[++cnt2]={x,i-m,last,z};\n\t\t\ta[++cnt2]={y+1,i-m,last,last-1};\n\t\t}\n\t\telse\n\t\tz=read(),a[++cnt2]={x,i,y,z};\n\t}\n\tsort(a+1,a+cnt2+1);\n\tfor(int i=1;i<=cnt2;i++)\n\tif(a[i].id<=0)\n\tt.cut(a[i].x),t.link(a[i].x,a[i].y);\n\telse\n\tans[a[i].id]=t.ask(a[i].x,a[i].y);\n\tfor(int i=1;i<=m;i++)\n\tif(ans[i])\n\tprintf(\"%d\\n\",ans[i]-1);\n}\n```",
        "postTime": 1624576086,
        "uid": 363350,
        "name": "hxdts",
        "ccfLevel": 6,
        "title": "P3348 [ZJOI2016]\u5927\u68ee\u6797 \u9898\u89e3"
    },
    {
        "content": "[\u5728\u535a\u5ba2\u67e5\u770b](https://www.cnblogs.com/chenxiaoran666/p/BZOJ4573.html)\n\n**\u5927\u81f4\u9898\u610f\uff1a** \u6709$n$\u68f5\u6811\uff0c\u521d\u59cb\u5404\u6709$1$\u4e2a\u7f16\u53f7\u4e3a$1$\u7684\u8282\u70b9\uff0c\u4e14\u5176\u4e3a\u751f\u957f\u8282\u70b9\u3002$3$\u79cd\u64cd\u4f5c\uff1a\u5c06$[l,r]$\u533a\u95f4\u5185\u7684\u6811\u589e\u52a0\u4e00\u4e2a\u65b0\u7684\u7f16\u53f7\u7684\u8282\u70b9\uff0c\u4fee\u6539$[l,r]$\u533a\u95f4\u5185\u7684\u6811\u751f\u957f\u8282\u70b9\uff08\u6ca1\u6709\u8be5\u8282\u70b9\u7684\u6811\u5ffd\u7565\u6b64\u64cd\u4f5c\uff09\uff0c\u8be2\u95ee\u67d0\u4e00\u68f5\u6811\u4e0a\u4e24\u70b9\u7684\u8ddd\u79bb\uff08\u4fdd\u8bc1\u5b58\u5728\uff09\u3002\n\n### \u8003\u8651\u79bb\u7ebf\n\n\u4e0d\u96be\u53d1\u73b0\uff0c\u65e0\u8bba\u4ec0\u4e48\u64cd\u4f5c\uff0c\u90fd\u4e0d\u4f1a\u6539\u53d8\u539f\u6709\u6811\u7684\u5f62\u6001\uff0c\u56e0\u6b64\uff0c\u8be2\u95ee\u7684\u7b54\u6848\u662f\u4e0d\u4f1a\u53d8\u7684\u3002\n\n\u56e0\u6b64\uff0c\u5c31\u4e0d\u96be\u60f3\u5230\u79bb\u7ebf\uff0c\u4ece$1$\u5230$n$\u679a\u4e3e\u6bcf\u68f5\u6811\uff0c\u6bcf\u6b21\u53ea\u8003\u8651\u76f8\u90bb\u4e24\u68f5\u6811\u4e4b\u95f4\u7684\u5dee\u5f02\uff0c\u7136\u540e\u4fee\u6539\u5e76\u8fdb\u884c\u8be2\u95ee\u3002\n\n\u8fd9\u4e5f\u662f\u505a\u8fd9\u9053\u9898\u7684\u4e00\u4e2a\u57fa\u7840\u601d\u60f3\u3002\n\n\u800c\u8981\u8fdb\u884c\u4fee\u6539\uff0c\u5c31\u9700\u8981\u4f7f\u7528$LCT$\u3002\n\n\u5173\u4e8e$LCT$\uff0c\u53ef\u4ee5\u8be6\u89c1\u8fd9\u7bc7\u535a\u5ba2\uff1a[LCT\u5165\u95e8](https://www.cnblogs.com/chenxiaoran666/p/LCT.html)\u3002\n\n\u53c8\u7531\u4e8e\u8fd9\u9898\u6811\u7684\u5f62\u6001\u56fa\u5b9a\uff0c\u56e0\u6b64\u8981\u7528**\u4e0d\u6362\u6839$LCT$**\u3002\n\n### \u8003\u8651\u589e\u52a0\u8282\u70b9\u64cd\u4f5c\n\n\u63a5\u4e0b\u6765\u6211\u4eec\u8003\u8651\u589e\u52a0\u8282\u70b9\u64cd\u4f5c\u3002\n\n\u4e0d\u96be\u53d1\u73b0\uff0c\u5176\u5b9e\u6211\u4eec\u628a\u5bf9$[l,r]$\u589e\u52a0\u8282\u70b9\u6539\u6210\u5bf9$[1,n]$\u589e\u52a0\u8282\u70b9\uff0c\u5176\u5b9e\u5bf9\u7b54\u6848\u4e0d\u4f1a\u6709\u4efb\u4f55\u5f71\u54cd\u3002\n\n\u56e0\u4e3a\u4f60\u589e\u52a0\u8282\u70b9\u4e0e\u8be2\u95ee\u65f6\uff0c\u90fd\u4e0d\u53ef\u80fd\u5bf9\u8fd9\u4e2a\u5e76\u4e0d\u5b9e\u9645\u5b58\u5728\u7684\u70b9\u8fdb\u884c\u64cd\u4f5c\uff0c\u56e0\u6b64\u8fd9\u4e2a\u70b9\u5373\u4f7f\u5b58\u5728\uff0c\u4e5f\u662f\u5b8c\u5168\u591a\u4f59\u7684\uff0c\u4e0d\u4f1a\u9020\u6210\u4efb\u4f55\u5f71\u54cd\u3002\n\n\u4f46\u662f\u8981\u6ce8\u610f\u9898\u76ee\u4e2d\u7684\u63d0\u9192\uff0c\u5728\u4fee\u6539\u751f\u957f\u8282\u70b9\u65f6\u4e00\u5b9a\u4e0d\u80fd\u4fee\u6539\u6ca1\u6709\u8fd9\u4e2a\u70b9\u7684\u6811\u3002\n\n\u8fd9\u5176\u5b9e\u4e5f\u53ea\u8981\u8bb0\u4e00\u4e0b\u6bcf\u4e2a\u70b9\u5b9e\u9645\u5b58\u5728\u7684\u533a\u95f4\uff0c\u4fee\u6539\u65f6\u5c06\u4fee\u6539\u5de6\u8fb9\u754c\u4e0e\u5b9e\u9645\u5b58\u5728\u7684\u5de6\u8fb9\u754c\u53d6$max$\uff0c\u4fee\u6539\u53f3\u8fb9\u754c\u4e0e\u5b9e\u9645\u5b58\u5728\u7684\u53f3\u8fb9\u754c\u53d6$min$\u5373\u53ef\u3002\n\n### \u8003\u8651\u8be2\u95ee\u64cd\u4f5c\n\n\u6682\u65f6\u5148\u4e0d\u8003\u8651\u4fee\u6539\u751f\u957f\u8282\u70b9\u7684\u64cd\u4f5c\uff0c\u6211\u4eec\u5148\u8003\u8651\u4e4b\u524d\u63d0\u5230\u7684\uff0c\u5728\u77e5\u9053\u5f53\u524d\u6811\u7684\u60c5\u51b5\u4e0b\uff0c\u5982\u4f55\u6c42\u4e24\u70b9\u8ddd\u79bb\uff0c\u5373\u5982\u4f55\u5904\u7406\u8be2\u95ee\u3002\n\n\u8fd9\u65f6\u5c31\u8981\u7528\u5230\u4e00\u4e2a\u795e\u5947\u7684\u6280\u5de7\uff1a$Access$\u6c42$LCA$\u3002\n\n\u5047\u8bbe\u8981\u5728$LCT$\u4e2d\u6c42$x,y$\u7684$LCA$\uff0c\u5219\u6211\u4eec\u5148$Access(x)$\uff0c\u6b64\u65f6$x$\u5230\u6839\u7684\u8def\u5f84\u4e0a\u7684\u8fb9\u90fd\u53d8\u6210\u4e86\u5b9e\u8fb9\u3002\n\n\u7136\u540e$Access(y)$\uff0c\u6b64\u65f6$y$\u5230\u6839\u7684\u8def\u5f84\u4e0a\u7684\u8fb9\u90fd\u53d8\u6210\u4e86\u5b9e\u8fb9\u3002\n\n\u800c$LCA(x,y)$\uff0c\u4e0d\u96be\u53d1\u73b0\u5e94\u8be5\u662f\u5728\u4e24\u6b21\u64cd\u4f5c\u4e2d\uff0c\u90fd\u53ef\u4ee5\u4ece\u6839\u51fa\u53d1\u53ea\u8d70\u5b9e\u8fb9\u5230\u8fbe\u7684\u6df1\u5ea6\u6700\u5927\u7684\u8282\u70b9\u3002\n\n\u8fd9\u5176\u5b9e\u5c31\u662f\u6211\u4eec\u5728$Access(y)$\u65f6\u6700\u540e\u64cd\u4f5c\u7684\u8282\u70b9\uff01\uff08\u5177\u4f53\u5b9e\u73b0\u53ef\u4ee5\u89c1\u4ee3\u7801\uff09\n\n\u800c\u6c42\u51fa\u4e86$LCA$\uff0c\u53ea\u8981\u7528$Depth_x+Depth_y$\u51cf\u53bb$2Depth_{LCA}$\u5373\u53ef\u3002\n\n\u4f46$Depth$\u600e\u4e48\u6c42\u5462\uff1f\n\n\u6211\u4eec\u53ef\u4ee5\u5bf9\u4e8e$LCT$\u7684$Splay$\u4e2d\u7684\u6bcf\u4e2a\u70b9\uff0c\u8bb0\u5f55\u4e0b\u5b83\u5b50\u6811\u5185\u5b9e\u8282\u70b9\u7684\u4e2a\u6570\uff08\u4e4b\u6240\u4ee5\u8981\u8bf4\u5b9e\u8282\u70b9\uff0c\u662f\u56e0\u4e3a\u4e3a\u4e86\u5904\u7406\u4fee\u6539\u751f\u957f\u8282\u70b9\u7684\u64cd\u4f5c\uff0c\u6211\u4eec\u9700\u8981\u589e\u52a0\u865a\u8282\u70b9\uff0c\u8fd9\u5728\u540e\u6587\u6709\u8be6\u7ec6\u89e3\u91ca\uff09\u3002\n\n\u800c\u5728$Access$\u5e76$Splay$\u4e86$x/y/LCA$\u4e4b\u540e\uff0c\u6b64\u65f6\u4ee5\u5176\u4e3a\u6839\u7684$Splay$\u7ef4\u62a4\u7684\u5c31\u662f\u4ece\u6839\u8282\u70b9\u5230\u5176\u8def\u5f84\u4e0a\u7684\u4fe1\u606f\uff0c\u800c\u6b64\u65f6$Splay$\u5185\u7684\u5b9e\u8282\u70b9\u6570\uff0c\u5176\u5b9e\u5c31\u76f8\u5f53\u4e8e\u5b83\u7684\u6df1\u5ea6\uff01\n\n\u8fd9\u6837\u4e00\u6765\uff0c\u8be2\u95ee\u64cd\u4f5c\u5c31\u5904\u7406\u5b8c\u4e86\u3002\n\n### \u8003\u8651\u4fee\u6539\u751f\u957f\u8282\u70b9\u64cd\u4f5c\n\n\u8fd9\u5e94\u8be5\u662f\u6700\u70e6\u7684\uff0c\u4e5f\u662f\u6bd4\u8f83\u96be\u7406\u89e3\u7684\u4e00\u4e2a\u64cd\u4f5c\u4e86\u3002\n\n\u8003\u8651\u6211\u4eec\u4fee\u6539\u751f\u957f\u8282\u70b9\u4e4b\u540e\uff0c\u5176\u5b9e\u4e5f\u5c31\u76f8\u5f53\u4e8e\u5728\u4e0b\u4e00\u6b21\u4fee\u6539\u751f\u957f\u64cd\u4f5c\u4e4b\u524d\uff0c\u6240\u6709\u88ab\u4fee\u6539\u751f\u957f\u8282\u70b9\u7684\u6811\u88ab\u65b0\u52a0\u5165\u7684\u8282\u70b9\uff0c\u7236\u4eb2\u5c31\u4ece\u539f\u5148\u751f\u957f\u8282\u70b9\u53d8\u6210\u4e86\u65b0\u7684\u751f\u957f\u8282\u70b9\u3002\n\n\u800c\u8003\u8651\u6ca1\u6709\u88ab\u4fee\u6539\u751f\u957f\u8282\u70b9\u4e0e\u88ab\u4fee\u6539\u751f\u957f\u8282\u70b9\u7684\u4e24\u68f5\u6811\u7684\u5dee\u5f02\uff0c\u5176\u5b9e\u4e5f\u5c31\u662f\u8fd9\u4e9b\u70b9\u7684\u4f4d\u7f6e\u53d1\u751f\u4e86\u53d8\u5316\u3002\n\n\u5982\u679c\u6211\u4eec\u8981\u6309\u7167\u4e4b\u524d\u63d0\u5230\u7684\u79bb\u7ebf\u601d\u60f3\uff0c\u6211\u4eec\u6bcf\u6b21\u4fee\u6539\u65f6\uff0c\u5c31\u76f8\u5f53\u4e8e\u8981\u5c06\u8fd9\u4e00\u5768\u8282\u70b9\u4ece\u4e00\u4e2a\u8282\u70b9\u7684\u513f\u5b50\u88ab\u79fb\u4f5c\u53e6\u4e00\u4e2a\u8282\u70b9\u7684\u513f\u5b50\u3002\n\n\u800c\u8981\u5feb\u901f\u79fb\u52a8\u7684\u8bdd\uff0c\u5c31\u9700\u8981\u65b0\u5efa\u4e00\u4e2a\u865a\u70b9\uff0c\u7136\u540e\u5c06\u8fd9\u4e9b\u8282\u70b9\u5168\u90e8\u4f5c\u4e3a\u8fd9\u4e2a\u865a\u70b9\u7684\u513f\u5b50\uff0c\u5e76\u5c06\u865a\u70b9\u4f5c\u4e3a\u76ee\u6807\u8282\u70b9\u7684\u513f\u5b50\uff0c\u8fd9\u6837\u8981\u79fb\u52a8\u513f\u5b50\u76f4\u63a5\u5c06\u8fd9\u4e2a\u865a\u70b9\u5728$LCT$\u4e0a$Cut$\u5e76$Link$\u4e00\u4e0b\u5373\u53ef\u3002\n\n\u800c\u5177\u4f53\u5b9e\u73b0\u4e2d\u8fd8\u6709\u4e00\u5b9a\u7ec6\u8282\uff0c\u53ef\u53c2\u8003\u4ee3\u7801\u3002\n\n### \u4ee3\u7801\n\n```cpp\n#include<bits/stdc++.h>\n#define Tp template<typename Ty>\n#define Ts template<typename Ty,typename... Ar>\n#define Reg register\n#define RI Reg int\n#define Con const\n#define CI Con int&\n#define I inline\n#define W while\n#define N 100000\n#define M 200000\n#define swap(x,y) (x^=y^=x^=y)\n#define Gmin(x,y) (x>(y)&&(x=(y)))\n#define Gmax(x,y) (x<(y)&&(x=(y)))\n#define pb push_back\nusing namespace std;\nint n,m,RtoA[M+5],IsReal[M+5],L[M+5],R[M+5],ans[M+5];\nstruct Op {int p,x,y;I Op(CI t=0,CI a=0,CI b=0):p(t),x(a),y(b){}};\nvector<Op> v[N+5];\nclass FastIO\n{\n\tprivate:\n\t\t#define FS 100000\n\t\t#define tc() (A==B&&(B=(A=FI)+fread(FI,1,FS,stdin),A==B)?EOF:*A++)\n\t\t#define pc(c) (C^FS?FO[C++]=c:(fwrite(FO,1,C,stdout),FO[(C=0)++]=c))\n\t\t#define tn (x<<3)+(x<<1)\n\t\t#define D isdigit(c=tc())\n\t\tint T,C;char c,*A,*B,FI[FS],FO[FS],S[FS];\n\tpublic:\n\t\tI FastIO() {A=B=FI;}\n\t\tTp I void read(Ty& x) {x=0;W(!D);W(x=tn+(c&15),D);}\n\t\tTp I void write(Ty x) {W(S[++T]=x%10+48,x/=10);W(T) pc(S[T--]);}\n\t\tTs I void read(Ty& x,Ar&... y) {read(x),read(y...);}\n\t\tTp I void writeln(Con Ty& x) {write(x),pc('\\n');}\n\t\tI void clear() {fwrite(FO,1,C,stdout);}\n}F;\nclass LinkCutTree//\u4e0d\u6362\u6839LCT\n{\n\tprivate:\n\t\t#define PU(x) (O[x].Sz=O[O[x].S[0]].Sz+O[O[x].S[1]].Sz+IsReal[x])\n\t\t#define Re(x) (swap(O[x].S[0],O[x].S[1]),O[x].R^=1)\n\t\t#define PD(x) (O[x].R&&(Re(O[x].S[0]),Re(O[x].S[1]),O[x].R=0))\n\t\t#define Wh(x) (O[O[x].F].S[1]==x)\n\t\t#define Co(x,y,d) (O[O[x].F=y].S[d]=x)\n\t\t#define IR(x) (O[O[x].F].S[0]^x&&O[O[x].F].S[1]^x)\n\t\tint St[M+5];struct node {int Sz,R,F,S[2];}O[M+5];\n\t\tI void Ro(RI x) \n\t\t{\n\t\t\tRI f=O[x].F,p=O[f].F,d=Wh(x);!IR(f)&&(O[p].S[Wh(f)]=x),\n\t\t\tO[x].F=p,Co(O[x].S[d^1],f,d),Co(f,x,d^1),PU(f);\n\t\t}\n\t\tI void S(RI x) \n\t\t{\n\t\t\tRI f=x,T=0;W(St[++T]=f,!IR(f)) f=O[f].F;W(T) PD(St[T]),--T;\n\t\t\tW(!IR(x)) f=O[x].F,!IR(f)&&(Ro(Wh(f)^Wh(x)?x:f),0),Ro(x);PU(x);\n\t\t}\n\t\tI int Ac(RI x) {RI s;for(s=0;x;x=O[s=x].F) S(x),O[x].S[1]=s,PU(x);return s;}//\u6b64\u5904Access\u8fd4\u56de\u6700\u540e\u64cd\u4f5c\u7684\u8282\u70b9\u7f16\u53f7\uff0c\u7528\u4e8e\u6c42LCA\n\tpublic:\n\t\tI void Link(CI x,CI y) {S(x),O[x].F=y;}//\u8fde\u8fb9\n\t\tI void Cut(CI x) {Ac(x),S(x),O[x].S[0]=O[O[x].S[0]].F=0,PU(x);}//\u5220\u6389\u4e0e\u7236\u4eb2\u7684\u8fb9\n\t\tI int GetDis(CI x,CI y)//\u6c42\u8ddd\u79bb\n\t\t{\n\t\t\tRI t,dx,dy;Ac(x),S(x),dx=O[x].Sz,t=Ac(y),S(y),dy=O[y].Sz;//\u6c42\u51faDepth[x]\u548cDepth[y]\uff0c\u540c\u65f6\u6c42\u51faLCA(x,y)\n\t\t\treturn Ac(t),S(t),dx+dy-(O[t].Sz<<1);//\u6c42\u51faDepth[LCA]\uff0c\u4ece\u800c\u8ba1\u7b97x\u4e0ey\u7684\u8ddd\u79bb\n\t\t}\n}LCT;\n#define BuildR(x,y) (IsReal[RtoA[++CR]=++CA]=1,L[CR]=x,R[CR]=y)//\u65b0\u5efa\u4e00\u4e2a\u5b9e\u9645\u5b58\u5728\u4e8e[l,r]\u6811\u5185\u7684\u5b9e\u70b9\nint main()\n{\n\tfreopen(\"forest.in\",\"r\",stdin),freopen(\"forest.out\",\"w\",stdout);\n\tRI i,j,sz,op,x,y,z,lstV,CA=0,CR=0,Qcnt=0;\n\tfor(F.read(n,m),BuildR(1,n),LCT.Link(lstV=++CA,CR),i=1;i<=m;++i)//\u521d\u59cb\u5316\uff0c\u5efa\u7acb\u5b9e\u70b91\uff0c\u5e76\u7ed91\u5efa\u4e00\u4e2a\u865a\u70b9\n\t{\n\t\tswitch(F.read(op,x,y),op)\n\t\t{\n\t\t\tcase 0:BuildR(x,y),LCT.Link(CA,lstV);break;//\u589e\u52a0\u8282\u70b9\uff0c\u5728LCT\u4e2d\u4e0e\u4e0a\u4e00\u4e2a\u865a\u70b9\u8fde\u8fb9\uff0c\u65b9\u4fbf\u8f6c\u79fb\n\t\t\tcase 1:\n\t\t\t\tif(F.read(z),Gmax(x,L[z]),Gmin(y,R[z]),x>y) continue;//\u5982\u679c\u8981\u4fee\u6539\u7684\u533a\u95f4\u4e3a\u7a7a\uff0c\u5219\u8df3\u8fc7\n\t\t\t\tLCT.Link(++CA,lstV),v[x].pb(Op(-1,CA,RtoA[z])),v[y+1].pb(Op(-1,CA,lstV)),\n\t\t\t\tlstV=CA;break;//\u65b0\u5efa\u865a\u70b9\uff0c\u5e76\u5b58\u4e0b\u6b64\u64cd\u4f5c\n\t\t\tcase 2:F.read(z),v[x].pb(Op(++Qcnt,RtoA[y],RtoA[z]));break;//\u5b58\u4e0b\u6b64\u64cd\u4f5c\n\t\t}\n\t}\n\tfor(i=1;i<=n;++i) for(sz=v[i].size(),j=0;j^sz;++j)//\u4ece\u5de6\u5230\u53f3\u626b\u63cf\u6bcf\u4e00\u68f5\u6811\n\t\t~v[i][j].p?ans[v[i][j].p]=LCT.GetDis(v[i][j].x,v[i][j].y)://\u5904\u7406\u8be2\u95ee\n\t\t(LCT.Cut(v[i][j].x),LCT.Link(v[i][j].x,v[i][j].y),0);//\u66f4\u6539\u751f\u957f\u8282\u70b9\n\tfor(i=1;i<=Qcnt;++i) F.writeln(ans[i]);return F.clear(),0;//\u8f93\u51fa\u7b54\u6848\n}\n```",
        "postTime": 1553687841,
        "uid": 28382,
        "name": "TheLostWeak",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P3348 \u3010[ZJOI2016]\u5927\u68ee\u6797\u3011"
    },
    {
        "content": "\u7531\u4e8e\u6700\u8fd1\u5728\u8865\u6587\u5316\u8bfe\uff0c\u73b0\u5728\u505a\u9898\u7684\u901f\u5ea6\u8d3c\u6162\u2026\u2026\n\n\u6628\u5929\u548c\u4eca\u5929\u4e00\u76f4\u5728\u7406\u89e3\u865a\u70b9\u7684\u505a\u6cd5\uff0c\u7406\u89e3\u4e86\u5f88\u4e45\uff0c\u4e0d\u8fc7\u6211\u5bf9 $LCT$ \u7684\u8ba4\u8bc6\u4e5f\u66f4\u52a0\u6df1\u5165\u4e86\u3002\n\n### \u524d\u7f6e\u77e5\u8bc6\uff1a\u6df1\u5165\u7406\u89e3 $LCT$\uff0c\u4e0d\u80fd\u8bb0\u677f\u5b50\uff01\n\n\u8ba9\u6211\u4eec\u770b\u770b\u8fd9\u9053\u9898\u7684\u64cd\u4f5c\uff1a\n\n\u64cd\u4f5c $0$\uff1a \u533a\u95f4\u52a0\u7ed3\u70b9\n\n\u64cd\u4f5c $1$\uff1a \u533a\u95f4\u6362\u6839\uff08\u751f\u957f\u7ed3\u70b9\uff09\n\n\u64cd\u4f5c $2$\uff1a \u5355\u70b9\u67e5\u8be2\u6811\u4e0a\u8ddd\u79bb\n\n\u4e00\u770b\u4e0d\u53ef\u505a\uff0c\u5927\u529b $O(n^2\\log n)$ \u80af\u5b9a\u662f\u4e0d\u884c\u7684\u2026\u2026\n\n\u90a3\u4e48\u8ba9\u6211\u4eec\u6316\u6398\u4e00\u4e0b\u64cd\u4f5c\u7684\u6027\u8d28\u3002\n\n### 1\u3001\u540e\u7eed\u7684\u64cd\u4f5c $0,1$ \u4e0d\u4f1a\u5f71\u54cd\u524d\u9762\u64cd\u4f5c $2$ \u7684\u7ed3\u679c\n\n\u56e0\u4e3a\u6ca1\u6709\u5220\u70b9\u4e5f\u6ca1\u6709\u533a\u95f4\u65ad\u8fb9\uff0c\u6240\u4ee5\u8fd9\u6ee1\u8db3\u79bb\u7ebf\u7684\u57fa\u672c\u6761\u4ef6\u3002\n\n\u79bb\u7ebf\u540e\u6211\u4eec\u5c06 $n$ \u68f5\u6811\u7f29\u6210\u4e00\u68f5\u6811\uff0c\u7136\u540e\u5c31\u64cd\u4f5c $0$ \u5c31\u6ca1\u4e86\u3002\n\n\u7a81\u7136\u4e00\u770b\u64cd\u4f5c $2$ \u8be2\u95ee\u7684\u662f\u8fb9\u6570\uff1f\u90a3\u6211\u4eec\u5c31\u591a\u52a0\u4e00\u4e2a\u7ed3\u70b9\u4e3a\u8fb9\u6743\uff0c\u6743\u503c\u4e3a $1$\uff0c\u5426\u5219\u6743\u503c\u4e3a $0$\uff0c\u8be2\u95ee\u7684\u7b54\u6848\u4e3a $sum_x+sum_y-2\\times sum_{lca(x,y)}$\n\n### 2\u3001\u5bf9\u4e8e\u64cd\u4f5c $0,1$ \u5efa\u865a\u70b9\n\n\u64cd\u4f5c $0$ \u5efa\u8fb9\u6743\u7684\u70b9\uff0c\u64cd\u4f5c $1$ \u5efa\u65e0\u8fb9\u6743\u7684\u70b9\u3002\u6bcf\u6b21\u64cd\u4f5c $0$ \u548c\u64cd\u4f5c $1$ \u90fd\u8fde\u5411\u4e0a\u4e00\u4e2a\u64cd\u4f5c $1$\uff0c\u8fd9\u6837\u4fdd\u8bc1\u9ed8\u8ba4\u751f\u957f\u7ed3\u70b9\u4e3a $1$\u3002\u82e5\u6ee1\u8db3\u524d\u63d0\u6761\u4ef6\uff08\u6709\u5751\uff09\uff0c\u90a3\u4e48\u8fd9\u4e2a\u64cd\u4f5c $1$ \u5728 $0$ \u4f4d\u7f6e\u8fde\u5411 $id_x$\uff08$id_x$ \u4e3a\u7b2c $x$ \u4e2a\u751f\u957f\u7ed3\u70b9\u5728 $LCT$ \u4e2d\u7684\u4f4d\u7f6e\uff09\uff0c\u5728 $r+1$ \u4f4d\u7f6e\u518d\u65ad\u6389\u3002\u8be2\u95ee\u4fbf\u662f\u6700\u540e\u8be2\u95ee\u5566\u3002\n\n\u76f8\u5f53\u4e8e\u6211\u4eec\u79bb\u7ebf\u4e4b\u540e\u5148\u6309\u64cd\u4f5c\u4f4d\u7f6e\u6392\u5e8f\uff0c\u518d\u6309\u662f\u5426\u4e3a\u8be2\u95ee\u64cd\u4f5c\u6392\u5e8f\uff0c\u6700\u540e\u6309\u64cd\u4f5c\u987a\u5e8f\u6392\u5e8f\u3002\u5728\u6700\u5f00\u59cb\u7684\u65f6\u5019\u8981\u53e6\u5916\u7533\u8bf7\u4e24\u4e2a\u7ed3\u70b9\uff0c\u8868\u793a\u7b2c\u4e00\u4e2a\u7ed3\u70b9\u548c\u7b2c $0$ \u6b21\u64cd\u4f5c $1$\n\n\u6211\u6df1\u77e5\u6ca1\u56fe\u7684\u75db\u82e6\uff0c\u6240\u4ee5\u6211\u4eec\u6765\u89e3\u91ca\u4e00\u4e0b\u6837\u4f8b\u5427\u3002\n\n\u4e94\u4e2a\u64cd\u4f5c\u6392\u5e8f\u540e\u8fd9\u6837\u5b50\u7684\uff1a\n\n```cpp\n0 1 5\n0 1 4\n2 1 1 3\n1 2 4 2\n2 2 1 3\n```\n\n\u6700\u521d\u6811\u7684\u5f62\u6001\uff1a\n\n![](https://cdn.luogu.com.cn/upload/pic/53396.png)\n\n\u8be2\u95ee\u7ed3\u675f\u540e\u6811\u7684\u5f62\u6001\uff1a\n\n![](https://cdn.luogu.com.cn/upload/pic/53397.png)\n\n\u9996\u5148\u4e24\u4e2a $0$ \u64cd\u4f5c\uff1a\n\n![](https://cdn.luogu.com.cn/upload/pic/53398.png)\n\n\u7b2c\u4e00\u6b21\u8be2\u95ee\u64cd\u4f5c\u662f\u4ece\u56fe\u4e2d\u7684 $1$ \u5230 $5$\uff0c\u7b54\u6848\u4e3a $1$\u3002\n\n\u7136\u540e $1$ \u64cd\u4f5c $cut$ \u540e $link$\uff1a\n\n![](https://cdn.luogu.com.cn/upload/pic/53401.png)\n\n\u7b2c\u4e8c\u6b21\u8be2\u95ee\u524d\u6811\u7684\u5f62\u6001\uff1a\n\n![](https://cdn.luogu.com.cn/upload/pic/53402.png)\n\n\u7b2c\u4e8c\u6b21\u8be2\u95ee\u662f\u4ece\u56fe\u4e2d\u7684 $1$ \u5230 $5$\uff0c\u7b54\u6848\u4e3a $2$\n\n\u63a5\u4e0b\u6765\u5c31\u662f $LCT$ \u7684\u57fa\u672c\u64cd\u4f5c + \u5728 $LCT$ \u4e0a\u627e $lca$ \u4e86\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log n)$\u3002\u867d\u7136\u770b\u4e0a\u6765\u6570\u636e\u5f88\u5c0f\uff0c\u4f46\u662f $LCT$ \u81ea\u5e26\u5927\u5e38\u6570 + \u4e00\u6b21\u627e $lca$ \u9700\u8981 $6$ \u500d\u5e38\u6570\uff0c\u6240\u4ee5\u8dd1\u5f97\u8d85\u7ea7\u6162\u3002\u3002\u3002\n\n$Update:2019.03.29$\n\n$ljc1301$ \u5728\u7701\u9009\u7684\u65f6\u5019\u95ee\u6211\u4e3a\u4ec0\u4e48\u6ca1\u6709\u4eba\u76f4\u63a5\u66b4\u529b $split(x,y)$ \u6c42\u51fa $sum$\uff0c\u6211\u5f53\u65f6\u6ca1\u60f3\u5230\uff0c\u73b0\u5728\u7279\u5730\u89e3\u91ca\u4e00\u4e0b\u3002\n\n\u56e0\u4e3a\u5728\u4e24\u4e2a\u5b9e\u70b9\u7684\u8def\u5f84\u4e0a\u6709\u53ef\u80fd\u5b58\u5728\u865a\u70b9\uff0c\u6240\u4ee5\u9700\u8981\u5dee\u5206\u7b54\u6848\u3002\n\n$Code\\ Below:$\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\nconst int maxn=400000+10;\nint n,m,last,cnt,ch[maxn][2],fa[maxn],val[maxn],sum[maxn];\nint L[maxn],R[maxn],id[maxn],ans[maxn],ind,qn,tot;\n\nstruct Query{\n\tint pos,id,x,y;\n\tQuery(int pos=0,int id=0,int x=0,int y=0):pos(pos),id(id),x(x),y(y){}\n}q[maxn];\n\ninline bool cmp(const Query &a,const Query &b){\n\treturn (a.pos!=b.pos)?a.pos<b.pos:a.id<b.id;\n}\n\ninline int read(){\n\tregister int x=0,f=1;char ch=getchar();\n\twhile(!isdigit(ch)){if(ch=='-')f=-1;ch=getchar();}\n\twhile(isdigit(ch)){x=(x<<3)+(x<<1)+ch-'0';ch=getchar();}\n\treturn (f==1)?x:-x;\n}\n\ninline void pushup(int x){sum[x]=sum[ch[x][0]]+sum[ch[x][1]]+val[x];}\ninline bool nrt(int x){return ch[fa[x]][0]==x||ch[fa[x]][1]==x;}\ninline void rotate(int x){\n\tint y=fa[x],z=fa[y],k=(ch[y][1]==x),u=ch[x][k^1];\n\tif(nrt(y)) ch[z][ch[z][1]==y]=x;\n\tch[y][k]=u;ch[x][k^1]=y;\n\tif(u) fa[u]=y;fa[y]=x;fa[x]=z;\n\tpushup(y);pushup(x);\n}\ninline void splay(int x){\n\tint y,z;\n\twhile(nrt(x)){\n\t\ty=fa[x],z=fa[y];\n\t\tif(nrt(y)) rotate((ch[y][1]==x)^(ch[z][1]==y)?x:y);\n\t\trotate(x);\n\t}\n}\ninline int access(int x){\n\tint y=0;\n\tfor(;x;y=x,x=fa[x])\n\t\tsplay(x),ch[x][1]=y,pushup(x);\n\treturn y;\n}\ninline void link(int x,int y){splay(x);fa[x]=y;}\ninline void cut(int x){access(x),splay(x);fa[ch[x][0]]=0;ch[x][0]=0;pushup(x);}\ninline void newnode(int x){cnt++;val[cnt]=sum[cnt]=x;}\ninline int query(int x,int y){\n\tint ans=0,lca;\n\taccess(x),splay(x),ans+=sum[x];\n\tlca=access(y),splay(y),ans+=sum[y];\n\taccess(lca),splay(lca),ans-=2*sum[lca];\n\treturn ans;\n}\n\nint main()\n{\n\tn=read(),m=read();\n\tnewnode(1);L[1]=1;R[1]=n;id[ind=1]=1;\n\tnewnode(0);link(2,1);last=2;\n\tint op,l,r,x,u,v;\n\tfor(int i=1;i<=m;i++){\n\t\top=read();\n\t\tif(op==0){\n\t\t\tl=read(),r=read();\n\t\t\tnewnode(1);L[++ind]=l;R[ind]=r;id[ind]=cnt;\n\t\t\tq[++tot]=Query(1,i-m,cnt,last);\n\t\t}\n\t\tif(op==1){\n\t\t\tl=read(),r=read(),x=read();\n\t\t\tl=max(l,L[x]);r=min(r,R[x]);\n\t\t\tif(l<=r){\n\t\t\t\tnewnode(0);link(cnt,last);\n\t\t\t\tq[++tot]=Query(l,i-m,cnt,id[x]);\n\t\t\t\tq[++tot]=Query(r+1,i-m,cnt,last);\n\t\t\t\tlast=cnt;\n\t\t\t}\n\t\t}\n\t\tif(op==2){\n\t\t\tx=read(),u=read(),v=read();\n\t\t\tq[++tot]=Query(x,++qn,id[u],id[v]);\n\t\t}\n\t}\n\tsort(q+1,q+tot+1,cmp);\n\tfor(int i=1,j=1;i<=n;i++)\n\t\tfor(;i==q[j].pos;j++){\n\t\t\tif(q[j].id<=0) cut(q[j].x),link(q[j].x,q[j].y);\n\t\t\telse ans[q[j].id]=query(q[j].x,q[j].y);\n\t\t}\n\tfor(int i=1;i<=qn;i++) printf(\"%d\\n\",ans[i]);\n\treturn 0;\n}\n```",
        "postTime": 1552037858,
        "uid": 35069,
        "name": "Owen_codeisking",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3348 \u3010[ZJOI2016]\u5927\u68ee\u6797\u3011"
    },
    {
        "content": "## [Zjoi2016]\u5927\u68ee\u6797\n\n \n\n~~\u7eed\u547d\u9898 (#@*^Y!&~~\n> \u53ef\u4ee5\u70b9\u51fb\u8fdb\u5165\u6211\u7684[Blog](bartholomew.cf)\u89c2\u770b\u6548\u679c\u66f4\u4f73\n\n### sol\n\n- \u5982\u679c\u540c\u65f6\u7ef4\u62a4$n$\u68f5\u6811\u5f62\u6001\u5e76\u4e0d\u53ef\u53d6.\n\n- \u53d1\u73b0\u6240\u6709$\\text{opt: 2}$\u64cd\u4f5c\u653e\u5728\u52a0\u70b9\u64cd\u4f5c\u7ed3\u675f\u540e\u8be2\u95ee\u7b54\u6848\u76f8\u540c.\n\n\u6545\u8003\u8651\u79bb\u7ebf\u7ef4\u62a4\u6bcf\u68f5\u6811\u7684\u5f62\u6001, \u786e\u5207\u6765\u8bf4, **\u5c31\u662f\u7ef4\u62a4\u5f53\u524d\u6811\u4e0e\u524d\u4e00\u68f5\u6811\u7684\u533a\u522b.**\n\n\n\n#### \u9898\u76ee\u6027\u8d28\n\n1. \u5bf9\u4e8e$\\text{opt: 0}$\u64cd\u4f5c\u751f\u957f\u51fa\u7684\u8282\u70b9, \u8003\u8651\u5b83\u5728\u7b2c$x$\u68f5\u6811\u5bf9\u5e94\u63a5\u5230\u90a3\u4e2a\u8282\u70b9:\n\n   \u4e0d\u96be\u53d1\u73b0, \u6240\u8fde\u8282\u70b9\u5c31\u662f\u79bb\u8fd9\u6b21\u64cd\u4f5c\u6700\u8fd1\u7684(\u65f6\u95f4\u5728\u5176\u4e4b\u524d\u7684) \n\n   \u4e14\u5728$x$\u5904\u751f\u6548\u7684$\\text{opt: 1}$\u64cd\u4f5c\u7684\u751f\u957f\u8282\u70b9.\n\n2. \u663e\u7136\u5982\u679c\u6211\u4eec\u66b4\u529b\u5bf9\u6240\u6709\u8282\u70b9$link$\u4e0e$cut$\u80af\u5b9a\u4f1a$TLE$\n\n3. \u53ef\u4ee5\u5229\u7528\"**\u865a\u70b9**\"\u6765\u89e3\u51b3 `2` \u7684\u95ee\u9898: \n\n   - \u5c06\u6240\u6709 \u751f\u957f\u51fa\u7684\u70b9 \u8fde\u5411\u8be5 \u751f\u957f\u8282\u70b9 \u5bf9\u5e94\u7684 \u865a\u70b9 , \n\n     \u90a3\u4e48\u5982\u679c\u66f4\u6362\u4e86\u751f\u957f\u8282\u70b9\u5c31\u53ef\u4ee5\u76f4\u63a5\u5bf9\u8be5\u865a\u70b9\u505a$O(1)$\u6b21\u64cd\u4f5c($link$ \u4e0e $cut$) \n\n     \u5373\u53ef\u8f6c\u79fb\u6240\u6709\u7684\u70b9.\n\n   - \u5bf9\u4e8e\u9898\u76ee\u8be2\u95ee\u8def\u5f84$(u,v)$\u957f\u5ea6\u53ea\u8981\u8bb0\u5f55\u8def\u5f84\u4e0a\u7684\u5b9e\u70b9\u4e2a\u6570\u5373\u53ef.\n\n~~\u5177\u4f53\u600e\u4e48\u505a\u5462?~~\n\n\n\n\u6211\u4eec**\u79bb\u7ebf\u6784\u9020**\u5b8c\u4e00\u4e2a\u865a\u70b9\u5e8f\u5217, \u6784\u9020\u5982\u4e0b\n\n1. \u5c06\u6bcf\u4e00\u4e2a$\\text{opt: 1}$\u64cd\u4f5c\u7684\u751f\u957f\u8282\u70b9\u5bf9\u5e94\u7684\u865a\u70b9\u6309\u7167\u65f6\u95f4\u6392\u597d\u5e8f\n\n2. \u5c06\u6bcf\u4e2a\u865a\u70b9\u8fde\u5411\u65f6\u95f4\u65e9\u4e8e\u5b83\u7684\u524d\u4e00\u4e2a\u865a\u70b9\n\n3. \u6839\u636e\u524d\u6587\u7684\u6027\u8d281, \u5c06\u6bcf\u4e2a$\\text{opt: 0}$\u64cd\u4f5c\u751f\u957f\u51fa\u7684\u8282\u70b9(\u5b9e\u70b9)\n\n   \u8fde\u5728\u65f6\u95f4\u6700\u63a5\u8fd1\u5b83\u7684\u90a3\u4e2a$\\text{opt: 1}$\u64cd\u4f5c\u5bf9\u5e94\u865a\u70b9\u4e0a.\n\n\u5927\u81f4\u957f\u8fd9\u6837\u7684:\n\n![](https://s2.ax1x.com/2019/07/12/Zfl5QI.png)\n\n~~\u90a3\u4e48\u8fd9\u5e8f\u5217\u4ec0\u4e48\u7528~~\n\n\u9996\u5148, \u6211\u4eec\u5bf9\u6bcf\u4e2a$\\text{opt: 1}$\u64cd\u4f5c\u7684\u865a\u70b9\u5b9a\u4e49:\n\n1. \u751f\u6548, \u5373$no.x$\u68f5\u6811\u4f4d\u4e8e$\\text{opt: 1}$\u5bf9\u5e94\u7684\u533a\u95f4\u4e0a\n2. \u5931\u6548, \u4e0d\u5728\u6240\u5bf9\u5e94\u7684\u533a\u95f4\u4e0a.\n\n\u90a3\u4e48\u5982\u679c\u865a\u70b9\u751f\u6548\u6211\u4eec\u5c31\u5c06\u5b83\u8fde\u5411\u5bf9\u5e94\u7684\u5b9e\u70b9, \u5982\u679c\u5b83\u5931\u6548\u5c31\u8fde\u5411\u524d\u4e00\u4e2a\u865a\u70b9.\n\n\u8fd9\u6837\u4e00\u6765, \u89c2\u5bdf$no.1\\to n$\u7684\u6811\u7684\u5f62\u6001\u662f\u5426\u6b63\u786e:\n\n- $case1: $\n\n![](https://s2.ax1x.com/2019/07/12/Zf3y5D.png)\n\n\u5982\u679c$b'$,$c'$\u5747\u5931\u6548, \u4e5f\u5c31\u662f\u4e0a\u56fe\u5f62\u6210\u7684\u5c40\u9762.\n\n\u90a3\u4e48**\u8fd8\u662f\u6839\u636e\u6027\u8d281**, \u7ea2\u5708\u5708\u51fa\u7684\u70b9\u5728\u6811\u4e0a\u5bf9\u5e94\u7740\u4f1a\u8fde\u5728**\u64cd\u4f5c\u65f6\u95f4\u6700\u63a5\u8fd1\u5b83\u4e14\u751f\u6548\u7684\u751f\u957f\u70b9\u4e0a**, \u4e5f\u5c31\u662f$a'.$\n\n\u663e\u7136, \u56fe\u4e2d\u662f\u6ee1\u8db3\u7684(\u8003\u8651\u7ea2\u8272\u7bad\u5934\u5bf9\u5e94\u7684\u8def\u5f84, \u76f8\u5f53\u4e8e\u7ea2\u5708\u70b9\u8fde\u5728\u4e86$a'$\u4e0a) \n\n- $case2:$\n\n![](https://s2.ax1x.com/2019/07/12/Zf8goT.png)\n\n\u82e5$c'$ \u4f9d\u65e7\u5931\u6548, $b'$\u751f\u6548.\n\n\u90a3\u4e48\u6211\u4eec\u4f1a\u5c06$b'$\u4e0e$a'$\u7684\u8fb9$cut$\u6389, \u5e76\u5c06\u5176\u8fde\u5728\u5bf9\u5e94\u5b9e\u70b9$b$\u4e0a\n\n~~\u90a3\u4e48\u8fd8\u662f\u6839\u636e\u6027\u8d281~~, \u7ea2\u5708\u70b9\u4f1a\u8fde\u5728$b'$\u4e0a, \u7531\u6b64\u8fde\u5411$b$, \u540c\u6837\u7b26\u5408\u9898\u610f.\n\n\n\n~~\u6545\u8fd9\u6837\u53ef\u4ee5\u7ef4\u62a4n\u68f5\u6811\u5f62\u6001~~ \n\n\u53ea\u8981\u5229\u7528$Lct$\u7ef4\u62a4\u6bcf\u6b21\u7684\u6dfb\u5220\u8fb9\u64cd\u4f5c\u5373\u53ef, \u4f46\u9700\u8981\u6ce8\u610f:\n\n\u6211\u4eec\u5bf9\u4e8e\u64cd\u4f5c$[l,r]$\u79fb\u52a8\u751f\u957f\u8282\u70b9\u81f3$x$\u7684\u64cd\u4f5c--\u4e5f\u5c31\u662f\u5bf9\u5e94\u5230\u865a\u70b9\u5e8f\u5217\u7684link\n\n\u4e0ecut\u64cd\u4f5c: \u53ef\u4ee5\u62c6\u62102\u4e2a\u72ec\u7acb\u64cd\u4f5c, \u5373\u5728l\u5904\u6807\u8bb0\u8be5\u865a\u70b9\u751f\u6548, \u5728r+1\u5904\u6807\u8bb0\u4e3a\u5931\u6548.\n\n\u90a3\u4e48\u5c31\u53ef\u4ee5\u6309\u7167$pos$\u4e3a\u7b2c\u4e00\u5173\u952e\u5b57\u6392\u5e8f, $time$\u4e3a\u7b2c\u4e8c\u5173\u952e\u5b57\u6392\u5e8f\n\n\u4ece\u5de6\u5411\u53f3\u4f9d\u6b21\u5904\u7406\u6bcf\u4e2a\u64cd\u4f5c\u5373\u53ef.\n\n\n\n\u540c\u6837\u7684, \u7531\u4e8e\u662f\u6709\u6839\u6811, \u90a3\u4e48\u6c42\u8def\u5f84\u65f6\u4e0d\u53ef\u4ee5$make\\_root$\u64cd\u4f5c, \u5426\u5219\u4f1a\u5f71\u54cd$lca$\u4e0e$root$\u4fe1\u606f\n\n\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u8003\u8651:\n$$\nf(u, v) = f(u, rt) + f(v, rt) - 2\\cdot f(lca, rt)\n$$\n$f(a, b)$\u8868\u793a$(a,b)$\u8def\u5f84\u4e0a\u7684\u5b9e\u70b9\u4e2a\u6570.\n\n> \u53ef\u4ee5\u8bc1\u660e, \u65e0\u8bba$lca$\u662f\u5b9e\u70b9\u8fd8\u662f\u865a\u70b9\u90fd\u4e0d\u4f1a\u5f71\u54cd\u7b54\u6848.\n\n\u7136\u540e\u5c31\u6ca1\u4e86, **\u6ce8\u610f\u4ee3\u7801\u7ec6\u8282!!!**\n\n### Code\n\n\u987b\u58f0\u660e\u8fd9\u91cc$Lct$\u51fd\u6570\u4e2d\u7684$link$\u64cd\u4f5c:\n\n```cpp\n  void link(int u, int v) {\n      splay(u);\n      fa(u) = v;\n  }\n```\n\n\n\u4e00\u822c\u662f\u4e0d\u4f1a\u8fd9\u4e48\u5199\u7684, ~~\u56e0\u4e3a\u663e\u7136\u4e0d\u5bf9.~~\n\n\u4f46\u662f\u6b64\u9898\u4e2d\u4e0d\u53ef\u4ee5$make\\_root$, \u800c\u4e14\u9898\u76ee\u6709**\u7279\u6b8a\u6027\u8d28**, \u6545\u53ef\u4ee5\u8fd9\u4e48\u5199\n\n- \u5b83\u5b9e\u8d28\u5c31\u662f\u5c06$u$\u5bf9\u5e94\u7684\u91cd\u8fb9\u4e0a\u6df1\u5ea6\u6700\u6d45\u7684\u70b9\u8fde\u5411$v$\n\n\u90a3\u4e48\u89c2\u5bdf\u4ee3\u7801\u4e2d\u6bcf\u6b21\u7684$link$\u64cd\u4f5c\u4f1a\u53d1\u73b0\u5fc5\u7136\u5b58\u5728\u4e00\u4e2a\u70b9\u4e3a\u8be5\u6811\u7684\u6839\n\n\u6240\u4ee5\u53ef\u4ee5\u5c06\u5b83\u5f53\u6210\u8fd9\u91cc\u7684$u$, \u53e6\u4e00\u4e2a\u70b9\u5f53\u6210$v$, \u8fd9\u6837$link$\u5c31\u6ca1\u95ee\u9898\u4e86\n\n\n\n\n```cpp\n%:pragma GCC optimize(2)\n#include <bits/stdc++.h>\nusing namespace std;\nconst int N = 4e5 + 50;\n\n# define pb push_back\n\nnamespace {\n    inline void read(int &x) {\n        x = 0; char c = getchar();\n        for(; !isdigit(c); c = getchar());\n        for(;  isdigit(c); c = getchar())\n            x = (x << 3) + (x << 1) + (c ^ '0');\n    }\n}\n\nint n, m, opt, x, u, v;\nint lasvir, realp, L, R, cnt, l[N], r[N], ans[N];\n/*\nlasvir \u8868\u793a\u4e0a\u4e00\u4e2a\u865a\u70b9\u7684\u7f16\u53f7\nrealp \u8868\u793a\u4e0a\u4e00\u4e2a\u5b9e\u70b9\u7f16\u53f7\nl[x], r[x] \u8868\u793a\u7f16\u53f7\u4e3ax\u7684\u70b9\u4f1a\u51fa\u73b0\u5728\u90a3\u4e9b\u6811\u4e2d\n*/\nstruct Opt {\n    int pos, key, x, y;\n    Opt() {}\n    Opt(int pos, int key, int x, int y) : \n        pos(pos), key(key), x(x), y(y) {}\n    bool operator <(Opt const &a) const {\n        return (a.pos != pos) ? pos < a.pos : key < a.key;\n    }\n} a[N];\n\nnamespace Lct {\n# define fa(x) t[x].fa\n# define ls(x) t[x].ch[0]\n# define rs(x) t[x].ch[1]\n    struct node {\n        int val, sum, ch[2], fa;\n        node() {}\n        node(int val) : val(val) {\n            sum = val;\n            ch[0] = ch[1] = fa = 0;\n        }    \n    } t[N]; \n\n    inline int ch(int x) { return rs(fa(x)) == x; }\n    inline int isroot(int x) { return ls(fa(x)) != x && rs(fa(x)) != x; } \n    inline void connect(int u, int v, int c) { t[fa(u) = v].ch[c] = u; }\n    inline int S(int x) { return x ? t[x].sum : 0; }\n    inline void upd(int x) { t[x].sum = t[x].val + S(ls(x)) + S(rs(x)); }\n    void rotate(int x) {\n        int y = fa(x), z = fa(y), d = ch(x);\n        if(!isroot(y)) connect(x, z, ch(y));\n        fa(x) = z;\n        connect(t[x].ch[!d], y, d);\n        connect(y, x, !d);\n        upd(y), upd(x);\n    }\n    void splay(int x) {\n        while(!isroot(x)) {\n            int y = fa(x);\n            if(!isroot(y)) (ch(x) ^ ch(y)) ? rotate(x) : rotate(y);\n            rotate(x);\n        }\n    }\n    int access(int x) {\n        int y = 0;\n        for(; x; y = x, x = fa(x)) \n            splay(x), rs(x) = y, upd(x);\n        return y;\n    }\n    int lca(int u, int v) {\n        return access(u), access(v);\n    }\n    int path(int x) {\n        access(x), splay(x);\n        return S(x);\n    }\n    void link(int u, int v) {\n        splay(u);\n        fa(u) = v;\n    }\n    void cut(int u) {\n        access(u), splay(u);\n        fa(ls(u)) = 0, ls(u) = 0, upd(u);\n    }\n    int query(int u, int v) {\n        int uv = lca(u, v), ans;\n        ans = path(u) + path(v) - path(uv) * 2;\n        return ans + 1;\n    }\n# undef ls\n# undef rs\n}\nusing Lct :: node;\nusing Lct :: t;\n\nint main() {\n    read(n), read(m);\n    l[1] = 1, r[1] = n; // \u6ce8\u610f\u8fd9\u91cc, \u8868\u793a1\u53f7\u751f\u957f\u8282\u70b9\u5bf9\u5e94\u533a\u95f4\u4e3a[1, n]\n    lasvir = m;\n    t[++realp] = node(1); // create node 1\n    t[++lasvir] = node(0);\n    Lct :: link(lasvir, realp); // create virtual node 1'\n    for(int i = 1; i <= m; ++i) {\n        read(opt);\n        if(!opt) {\n            read(L), read(R);\n            t[++realp] = node(1);\n            l[realp] = L, r[realp] = R;\n            Lct :: link(realp, lasvir); // \u5b9e\u70b9\u8fde\u5411\u6700\u8fd1\u7684\u865a\u70b9\n        } else if(opt == 1) {\n            read(L), read(R), read(x);\n            L = max(L, l[x]), R = min(R, r[x]);\n            if(L > R) continue;\n            t[++lasvir] = node(0);\n            Lct :: link(lasvir, lasvir - 1); // \u5f53\u524d\u865a\u70b9\u4e0e\u4e0a\u4e00\u4e2a\u865a\u70b9\u76f8\u8fde, \u6784\u6210\"\u865a\u70b9\u5e8f\u5217\".\n            {\n                a[++cnt] = Opt(L, i - m, lasvir, x);\n                a[++cnt] = Opt(R + 1, i - m, lasvir, lasvir - 1);\n            }\n        } else {\n            read(x), read(u), read(v);\n            a[++cnt] = Opt(x, i, u, v);\n        }\n    }\n    sort(a + 1, a + 1 + cnt);\n    for(int i = 1; i <= cnt; ++i) {\n       if(a[i].key < 0) {\n            Lct :: cut(a[i].x);\n            Lct :: link(a[i].x, a[i].y);\n        } else \n            ans[a[i].key] = Lct :: query(a[i].x, a[i].y);\n    }\n    for(int i = 1; i <= m; ++i)\n        if(ans[i]) printf(\"%d\\n\", ans[i] - 1);\n    return 0;\n}\n```\n\n\n\n",
        "postTime": 1562929276,
        "uid": 50047,
        "name": "Bartholomew",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3348 \u3010[ZJOI2016]\u5927\u68ee\u6797\u3011"
    },
    {
        "content": "\u6ca1\u6709\u4e0a\u9762\u9898\u89e3\u8fd9\u4e48\u9ebb\u70e6\u554a\u3002\u3002\n\n\u9996\u5148\u5148\u79bb\u7ebf\u7136\u540e\u5148\u628a\u6240\u6709\u7684\u52a0\u70b9\u64cd\u4f5c\u5148\u52a0\u5b8c\uff08\u5177\u4f53\u6709\u4e2a\u7ed9\u4fee\u6539\u7f29\u5c0f\u533a\u95f4\u7684\u64cd\u4f5c\u5e94\u8be5\u90fd\u80fd\u770b\u61c2\uff0c\u89c1\u4ee3\u7801\uff09\u3002\n\n\u7136\u540e\u770b\u8fd9\u9898\u663e\u7136\u53ea\u80fd\u5efa\u51fa\u4e00\u68f5\u6811\u6765\uff0c\u6240\u4ee5\u8003\u8651\u76f8\u90bb\u4e24\u68f5\u6811\u4e4b\u95f4\u7684\u5dee\u5f02\uff0c\u7136\u540e\u6307\u9488\u4ece\u7b2c$1$\u68f5\u6811\u626b\u5230\u7b2c$n$\u68f5\u6811\uff0c\u5b9e\u9645\u5b9e\u73b0\u53ea\u9700\u8981\u6309\u7167\u4e0b\u6807\u4e3a\u7b2c\u4e00\u5173\u952e\u5b57\uff0c\u65f6\u95f4\u4e3a\u7b2c\u4e8c\u5173\u952e\u5b57\uff0c\u628a\u79bb\u7ebf\u7684\u4fee\u6539\u548c\u8be2\u95ee\u6392\u5e8f\u5373\u53ef\u3002\n\n\u663e\u7136\u7b2c$k$\u4e2a$l \\sim r$\u7684\u6362\u8282\u70b9\u64cd\u4f5c\uff0c\u5728$1 \\sim l-1$\u5904\u4ee5\u53ca$r+1 \\sim n$\u5904\u662f\u4e0d\u4f1a\u751f\u6548\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\u5728$1 \\sim l-1$\u5904\u4ee5\u53ca$ r+1 \\sim n$\u5904\u663e\u7136\u662f$k-1$\u5728\u8d77\u4f5c\u7528\uff0c\u5f53\u7136\u5982\u679c$k-1$\u4e5f\u6ca1\u7528\u7684\u8bdd\u5c31\u63a5\u7740\u5f80\u524d\u63a8\u3002\n\n\u5177\u4f53\u6765\u8bf4\u5bf9\u4e8e\u7b2c$k$\u4e2a\u6362\u8282\u70b9\u64cd\u4f5c\u5efa\u865a\u70b9\u5e76\u5c06\u7b2c$k+1$\u4e2a\u64cd\u4f5c\u4e4b\u524d\u7684\u52a0\u8282\u70b9\u64cd\u4f5c\u8fde\u5230\u8fd9\u4e2a\u865a\u70b9\u4e0a\uff0c\u7136\u540e\u5728\u5f00\u59cb\u65f6\u5c06\u5b83\u8fde\u7ed9$k-1$\u7684\u865a\u70b9\uff0c$l$\u65f6\u5c06\u5b83\u8fde\u7ed9\u5bf9\u5e94\u7684$x$\uff0c\u6700\u540e\u5728$r+1$\u65f6\u518d\u8fde\u56de$k-1$\u3002\n\n\u8be2\u95ee\u7684\u65f6\u5019\u5c31\u611f\u89c9\u522b\u4eba\u5904\u7406\u7684\u5c31\u6709\u70b9\u9ebb\u70e6\u4e86\uff0c\u4e0d\u9700\u8981\u4ec0\u4e48\u4e0d\u6362\u6839LCT\uff0c\u53ea\u9700\u8981\u628a\u865a\u70b9\u62c6\u70b9\u6210\u4e24\u4e2a\uff0c\u4e00\u4e2a\u503c\u662f$-1$\uff0c\u7528\u6765\u8fde\u7236\u4eb2\uff0c\u4e00\u4e2a\u503c\u662f$1$\uff0c\u7528\u6765\u8fde\u8981\u8fde\u5411\u4ed6\u7684\u4eba\uff0c\u8fd9\u6837\u4f60\u81ea\u5df1\u753b\u753b\u56fe\u663e\u7136\u5c31\u662f\u5bf9\u7684\uff0c\u4e5f\u5c31\u662f\u8bf4\u6c42\u7b54\u6848\u53ea\u9700\u8981\u7ecf\u5178LCT\u4e2d\uff0cchange_rt,access,splay\u4e09\u8fde\u5373\u53ef\u3002\n\n\uff08\u4ee3\u7801\u653e\u5173\u952e\u90e8\u5206\uff09\n\n``` cpp\n\nstruct Req\n{\n\tint pos,t,opt,x,y;\n\tfriend bool operator < (const Req &x,const Req &y)\n\t{\n\t\treturn x.pos==y.pos?(x.t==y.t?x.opt>y.opt:x.t<y.t):x.pos<y.pos;//\u7b2c\u4e09\u5173\u952e\u5b57\u662f\u4fdd\u8bc1\u4e00\u6b21\u4fee\u6539\u91cc\u4ec5\u6709\u7684\u4e24\u4e2a\u64cd\u4f5c\u2014\u2014\u65ad\u8fb9\u548c\u8fde\u8fb9\u7684\u987a\u5e8f\n\t}\n}req[maxm<<2];\nint L[maxm];\nint R[maxm];\nint ans[maxm];\n\nint main()\n{\n\trint n=read<int>(),m=read<int>(),q=0,cnt1=1,cnt2=m;\n\tt[1].val=1,L[1]=1,R[1]=n;\n    cnt2++,t[cnt2].val=-1,link(cnt2,1);\n    cnt2++,t[cnt2].val=1,link(cnt2,cnt2-1);\n\tmemset(ans,-1,m+1<<2);//\u8fd9\u91cc\u5904\u7406\u7684\u6709\u70b9nt\uff0c\u4e5f\u5c31\u56fe\u4e00\u4e50\n\tfor(rint i=1;i<=m;i++)\n\t{\n\t\trint opt=read<int>();\n\t\tif(opt==0)\n\t\t{\n\t\t\tt[++cnt1].val=1;t[cnt1].sum=t[cnt1].val=1;\n\t\t\tlink(cnt1,cnt2);\n\t\t\tL[cnt1]=read<int>(),R[cnt1]=read<int>();\n\t\t}\n\t\tif(opt==1)\n\t\t{\n\t\t\trint l=read<int>(),r=read<int>(),x=read<int>();\n\t\t\tl=max(l,L[x]),r=min(r,R[x]);//\u7f29\u533a\u95f4\uff0c\u628ax\u4e0d\u5b58\u5728\u7684\u4fee\u6539\u6254\u6389\n\t\t\tif(l>r) continue;\n\t\t\tcnt2++,t[cnt2].val=-1,link(cnt2,cnt2-1);\n\t\t\tcnt2++,t[cnt2].val=1,link(cnt2,cnt2-1);\n\t\t\treq[++q]=(Req){l,i,1,cnt2-1,cnt2-2};//\u663e\u7136\u8fd9\u91cccnt2-1\u662f\u90a3\u4e2a\u503c\u662f-1\u7684\u90a3\u4e00\u534a\uff0ccnt2-2\u662f\u4e0a\u4e00\u4e2a\u6362\u8282\u70b9\u64cd\u4f5c\u76841\u90a3\u4e00\u534a\n\t\t\treq[++q]=(Req){l,i,0,cnt2-1,x};\n\t\t\treq[++q]=(Req){r+1,i,1,cnt2-1,x};\n\t\t\treq[++q]=(Req){r+1,i,0,cnt2-1,cnt2-2};\n\t\t}\n\t\tif(opt==2)\n\t\t{\n\t\t\trint x=read<int>(),y=read<int>(),z=read<int>();\n\t\t\treq[++q]=(Req){x,i,2,y,z};\n\t\t}\n\t}\n\tsort(req+1,req+q+1);\n\tfor(rint i=1;i<=q;i++)\n\t{\n\t\tif(req[i].opt==0) link(req[i].x,req[i].y);\n\t\tif(req[i].opt==1) cut(req[i].x,req[i].y);\n\t\tif(req[i].opt==2) ans[req[i].t]=query(req[i].x,req[i].y);\n\t}\n\tfor(rint i=1;i<=m;i++)\n\t\tif(~ans[i]) printf(\"%d\\n\",ans[i]-1);\n\treturn 0;\n}",
        "postTime": 1608470322,
        "uid": 50477,
        "name": "linfourxu",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3348 \u3010[ZJOI2016]\u5927\u68ee\u6797\u3011"
    },
    {
        "content": "\u8fd9\u9898\u6709\u5751\u2026\u2026\n\n\u8bf7\u6ce8\u610f\u64cd\u4f5c\u4e8c\u7684\u751f\u6548\u8303\u56f4\n\n__________________\n\n### \u672c\u9898\u9898\u89e3\n\n\u9996\u5148\u4e4d\u4e00\u770b\u8fd9\u9053\u9898\n\n\u86e4\uff1f\u533a\u95f4\u79cd\u6811\uff1f\n\n\u7136\u540e\u7ee7\u7eed\u8bfb\u9898\n\n\u6ca1\u6709\u5f3a\u5236\u5728\u7ebf\uff0c\u53ea\u6709\u5355\u70b9\u8be2\u95ee\n\n\u518d\u4ed4\u7ec6\u770b\u4e00\u773c\u53d1\u73b0\u6ca1\u6709\u5220\u70b9\u64cd\u4f5c\uff0c\u6240\u4ee5\u8be2\u95ee\u7b54\u6848\u548c\u8be2\u95ee\u65f6\u95f4\u6ca1\u6709\u5173\u7cfb\n\n\u4e8e\u662f\u6211\u4eec\u60f3\u5230\u4e86\u626b\u63cf\u7ebf\n\n\u6211\u4eec\u5c06\u5f71\u54cd\u8fd9\u9897\u6811\u7684\u6240\u6709\u64cd\u4f5c\u62ce\u51fa\u6765\uff0c\u6309\u7167\u65f6\u95f4\u6392\u4e00\u4e2a\u5e8f\uff0c\u5f62\u6210\u4e00\u4e2a\u65f6\u95f4\u5e8f\u5217\n\n\u7136\u540e\u4ece\u5de6\u5230\u6709\u626b\u63cf\u7ebf\u5904\u7406\u533a\u95f4\u64cd\u4f5c\u7684\u5f71\u54cd\n\n\u73b0\u5728\u6211\u4eec\u652f\u6301\u7684\u64cd\u4f5c\u6709\n\n1.\u63d2\u5165\u4e00\u4e2a\u64cd\u4f5c0\uff0c\u65b0\u589e\u7684\u8282\u70b9\u7684\u7236\u4eb2\u4e3a\u79bb\u5b83\u6700\u8fd1\u7684\u64cd\u4f5c2\u4ea7\u751f\u7684\u751f\u957f\u8282\u70b9\n\n2.\u63d2\u5165\u4e00\u4e2a\u64cd\u4f5c1\uff0c\u5c06\u8fd9\u4e2a\u65f6\u95f4\u70b9\u5f00\u59cb\u5230\u4e0b\u4e00\u4e2a\u64cd\u4f5c2\u4e3a\u6b62\u7684\u70b9\u7684\u7236\u4eb2\u66f4\u6539\u4e3a\u8fd9\u4e2a\u64cd\u4f5c2\u7684\u5bf9\u5e94\u8282\u70b9\n\n3.\u5220\u9664\u4e00\u4e2a\u64cd\u4f5c0\n\n4.\u5220\u9664\u4e00\u4e2a\u64cd\u4f5c1\n\n5.\u8be2\u95ee\u6811\u4e0a\u8ddd\u79bb\n\n\u4e00\u8a00\u4ee5\u853d\u4e4b\uff0c\u5355\u70b9\u6362\u7236\u4eb2\uff0c\u533a\u95f4\u6362\u7236\u4eb2\uff0c\u8be2\u95ee\u6811\u4e0a\u8ddd\u79bb\n\n\u76f4\u63a5\u505a\u80af\u5b9a\u662f\u505a\u4e0d\u4e86\u7684\u4e86\u2026\u2026\n\n\u6240\u4ee5\u6211\u4eec\u8003\u8651\u4e00\u4e9b\u4e8b\u60c5\uff0c\u6211\u4eec\u5c06\u5386\u53f2\u4e0a\u6240\u6709\u64cd\u4f5c1\u5168\u90e8\u62ff\u51fa\u6765\uff0c\u6bcf\u4e2a\u64cd\u4f5c1\u5efa\u4e00\u4e2a\u865a\u70b9\uff0c\u628a\u8fd9\u4e9b\u64cd\u4f5c1\u8fde\u6210\u4e00\u6761\u94fe\uff0c\u5176\u4e2d\u5982\u679c\u865a\u70b9i\u548ci-1\u6709\u8fde\u8fb9\u8bc1\u660e\u8fd9\u4e2a\u64cd\u4f5c\u5728\u8fd9\u4e00\u65f6\u523b\u8fd8\u4e0d\u5b58\u5728\n\n\u90a3\u4e48\uff0c\u6211\u4eec\u4f1a\u53d1\u73b0\u5728t\u8fd9\u4e2a\u4f4d\u7f6e\uff0c\u6bcf\u4e00\u4e2a\u865a\u70b9\u7684\u8054\u901a\u5757\u4ee3\u8868\u4e86\u8fd9\u4e00\u65f6\u523b\u5b9e\u9645\u5b58\u5728\u7684\u64cd\u4f5c1\u6240\u7ba1\u8f96\u7684\u64cd\u4f5c0\u70b9\u7684\u63d2\u5165\u65f6\u95f4\u8303\u56f4\uff0c\u6362\u53e5\u8bdd\u8bf4\u6bcf\u4e00\u4e2a\u8054\u901a\u5757\u7684\u9876\u90e8\u4ee3\u8868\u4e86\u6b64\u65f6\u5b9e\u9645\u5b58\u5728\u7684\u64cd\u4f5c1\uff0c\u800c\u5728\u8fd9\u4e00\u65f6\u523b\u5982\u679c\u67d0\u4e00\u4e2a\u64cd\u4f5c0\u4ea7\u751f\u7684\u70b9\u7684\u7236\u4eb2\u6070\u597d\u662f\u8fd9\u4e2a\u64cd\u4f5c2\u7684\u70b9\u7684\u8bdd\uff0c\u90a3\u4e48\u4ed6\u7684\u63d2\u5165\u65f6\u95f4\u5fc5\u987b\u5728\u8fd9\u4e2a\u8054\u901a\u5757\u7684\u64cd\u4f5c\u65f6\u95f4\u8303\u56f4\u5185\n\n\u8bf7\u4ed4\u7ec6\u7406\u89e3\u4e0a\u9762\u8fd9\u4e00\u6bb5\u8bdd\uff0c\u5b9e\u5728\u662f\u5f88\u96be\u89e3\u91ca\u7528\u8bed\u8a00\u89e3\u91ca\u6e05\u695a\uff0c\u8bf7\u52a1\u5fc5\u81ea\u5df1\u753b\u56fe\u7406\u89e3\u4e00\u4e0b\n\n\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u8fd9\u6837\u6267\u884c\u64cd\u4f5c0\uff0c**\u5c06\u64cd\u4f5c0\u8fde\u5230\u5728\u5386\u53f2\u4e0a\u7684\u6240\u6709\u64cd\u4f5c1\u70b9\u4e2d\uff0c\u6267\u884c\u65f6\u95f4\u79bb\u4ed6\u6700\u8fd1\u7684\u64cd\u4f5c1\u865a\u70b9\u4e0a**\uff0c\u65e0\u8bba\u8fd9\u4e2a\u64cd\u4f5c1\u865a\u70b9\u5728\u63d2\u5165\u64cd\u4f5c0\u7684\u65f6\u5019\u8fd8\u662f\u5426\u751f\u6548\n\n\u90a3\u4e48\u6839\u636e\u4e0a\u9762\u7684\u6027\u8d28\u53ef\u4ee5\u77e5\u9053\uff0c\u5728\u4efb\u610f\u4f4d\u7f6et\uff0c\u6240\u6709\u64cd\u4f5c0\u7684\u7236\u4eb2\u53ef\u4ee5\u88ab\u770b\u4f5c\u662f\u79bb\u5b83\u6700\u8fd1\u4e14\u751f\u6548\u7684\u64cd\u4f5c1\u865a\u70b9\uff0c\u6362\u53e5\u8bdd\u5c31\u662f\u5b83\u6240\u5728\u7684\u865a\u94fe\u7684\u9876\u90e8\n\n\u6b64\u65f6\u6211\u4eec\u53ea\u9700\u8981\u628a\u5404\u4e2a\u865a\u94fe\u7684\u9876\u90e8\u6309\u7167\u7236\u5b50\u5173\u7cfb\u8fde\u597d\u5c31\u884c\u4e86\n\n\u533a\u95f4\u6362\u7236\u4eb2\u7684\u65f6\u5019\u56e0\u4e3a\"\u533a\u95f4\"\u8fd9\u4e2a\u6982\u5ff5\u5df2\u7ecf\u88ab\u6211\u4eec\u4f7f\u7528\u865a\u70b9\u5f3a\u884c\u6620\u5c04\u5230\u4e86\u8fd9\u9897\u6811\u4e0a\u4e86\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5link\u548ccut\u8fc7\u53bb\uff0c\u6548\u679c\u662f\u5c31\u5148\u6fc0\u6d3b\u8fd9\u4e2a\u64cd\u4f5c\u865a\u70b9\uff08\u65ad\u6389i\u548ci-1\uff09\uff0c\u6b64\u65f6i\u8fd9\u4e2a\u865a\u70b9\u6240\u5728\u7684\u865a\u94fe\u4e0a\u7684\u70b9\u5c31\u662f\u5168\u90e8\u7684\u53d7\u5230\u5f71\u54cd\u7684\u8282\u70b9\uff0c\u7136\u540e\u63a5\u4e0b\u6765\u8fde\u5230\u5b9e\u9645\u7684\u751f\u957f\u8282\u70b9\u4e0a\uff0c\u8fd9\u6837\u5c31\u5b9e\u73b0\u4e86\u533a\u95f4\u6362\u7236\u4eb2\u8fd9\u4e2a\u64cd\u4f5c\n\n\n\u597d\u4e86\u6700\u540e\u4e00\u4e2a\u95ee\u9898\uff0c\u8be2\u95ee\u6811\u4e0a\u8ddd\u79bb\n\n\u86e4?\u53c8\u662f\u865a\u70b9\u53c8\u662f\u865a\u94fe\u7684\uff0c\u8fd8\u6709makerroot\u548caccess\uff0clink\uff0ccut\u6811\u4e0a\u7684\u7236\u5b50\u5173\u7cfb\u65e9\u6ca1\u4e86\u597d\u5427\u2026\u2026\n\n\u7b54\u6848\u662flct\u7684\u4e00\u822c\u5957\u8def\uff0c\u628a\u8fb9\u62c6\u6210\u70b9\u5373\u53ef\u2026\u2026\n\n\u8fd9\u6837\u7684\u8bdd\u603b\u70b9\u6570\u4f1a\u81a8\u80c03\u500d\uff0c\u53ef\u4ee5\u63a5\u53d7\n\n\u90a3\u4e48\u6211\u4eec\u5c31\u53ef\u4ee5\u4f7f\u7528lct\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u4e86\n\n\u7b80\u8ff0\u4e0b\u7b97\u6cd5\u6d41\u7a0b\n\n1.\u521d\u59cb\u5316\uff0c\u5c06\u6240\u6709\u64cd\u4f5c1\u5efa\u4e00\u4e2a\u865a\u70b9\uff0c\u8fde\u6210\u4e00\u6761\u94fe\n\n2.\u79bb\u7ebf\u626b\u63cf\u7ebf\uff0c\u5c06\u6240\u6709\u64cd\u4f5c\u62c6\u6210\u4e00\u4e2a\u63d2\u5165\u548c\u4e00\u4e2a\u5220\u9664\n\n3.\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u64cd\u4f5c0\u5904\u7406\u51fa\u4e00\u4e2a\u5386\u53f2\u4e0a\u79bb\u4ed6\u65f6\u95f4\u6700\u8fd1\u7684\u64cd\u4f5c2\u865a\u70b9\n\n4.\u5f00\u59cb\u626b\u6574\u4e2a\u64cd\u4f5c\u5e8f\u5217\n\n4.1\u5982\u679c\u662f\u63d2\u5165\u64cd\u4f5c0\n\n\u76f4\u63a5\u7ed9\u8fd9\u4e2a\u70b9\u548c\u5bf9\u5e94\u7684\u865a\u70b9\u8fde\u8fb9\uff0c\u6ce8\u610f\u8fb9\u4e5f\u8981\u4ee5\u70b9\u7684\u5f62\u5f0f\u8fde\u4e0a\n\n4.2\u5982\u679c\u662f\u63d2\u5165\u64cd\u4f5c1\n\n\u65ad\u5f00i\uff0ci-1\uff0c\u5c06i\u8fde\u5230\u5bf9\u5e94\u7684\u751f\u957f\u8282\u70b9\u4e0a(\u5b9e\u70b9)\n\n\u5220\u9664\u540c\u7406\uff0c\u5c06\u63d2\u5165\u64cd\u4f5c\u5b8c\u5168\u9006\u8fc7\u53bb\u5c31\u884c\n\n\u8be2\u95ee\u76f4\u63a5\u65e0\u8111makeroot(u),access(v),splay(v)\u4e09\u8fde\u5373\u53ef\n\n\u6700\u540e\u4e00\u70b9\u6ce8\u610f\u7684\u662f\u6bcf\u4e00\u4e2a\u64cd\u4f5c0\u72ec\u5360\u4e00\u4e2a\u72ec\u7acb\u7684\u7f16\u53f7\uff0c\u56e0\u6b64\u64cd\u4f5c1\u7684\u751f\u6548\u533a\u95f4\u5e94\u8be5\u548c\u64cd\u4f5c0\u7684\u751f\u6548\u533a\u95f4\u6c42\u4ea4\u2026\u2026\n\n\u53e6\u59161\u53f7\u70b9\u7684\u751f\u6548\u533a\u95f4\u662f(1,n)\n\n\u4e0a\u4ee3\u7801~\n\n```C\n// luogu-judger-enable-o2\n#include<cstdio>\n#include<algorithm>\nusing namespace std;const int N=4*1e5+10;int n;int m;\nstruct linkcuttree//\u7b80\u6613lct\u677f\u5b50 \n{\n    int s[N][2];int fa[N];int siz[N];int rv[N];int v[N];int st[N];int tp;\n    inline int gc(int x){return s[fa[x]][1]==x;}\n    inline bool isr(int x){return s[fa[x]][1]!=x&&s[fa[x]][0]!=x;}\n    inline void ud(int x){siz[x]=siz[s[x][1]]+v[x]+siz[s[x][0]];}\n    inline void pd(int x){if(rv[x]){swap(s[x][1],s[x][0]);rv[s[x][0]]^=1;rv[s[x][1]]^=1;rv[x]=0;}}\n    inline void upd(int x){for(;;x=fa[x]){st[++tp]=x;if(isr(x))break;}while(tp){pd(st[tp]);tp--;}}\n    inline void rt(int x)\n    {\n        int d=fa[x];int t=gc(x);s[d][t]=s[x][t^1];fa[s[x][t^1]]=d;\n        if(!isr(d))s[fa[d]][gc(d)]=x;fa[x]=fa[d];s[x][t^1]=d;fa[d]=x;ud(d);ud(x);\n    }\n    inline void rtup(int x){rt(gc(x)^gc(fa[x])?x:fa[x]);rt(x);}\n    inline void splay(int x){upd(x);for(;!isr(fa[x])&&!isr(x);rtup(x));if(!isr(x))rt(x);}\n    inline void mg(int x,int y){splay(x);s[y][1]=x;fa[x]=y;ud(y);}\n    inline void spl(int x){splay(x);s[x][1]=0;ud(x);}\n    inline void acc(int x){for(spl(x);fa[x];splay(x)){spl(fa[x]);mg(x,fa[x]);}}\n    inline void mkr(int x){acc(x);splay(x);rv[x]^=1;}\n    inline void lk(int u,int v){mkr(u);fa[u]=v;}\n    inline void ct(int u,int v){mkr(u);acc(v);splay(v);s[v][0]=0;fa[u]=0;ud(v);}\n    inline int query(int u,int v){mkr(u);acc(v);splay(v);return siz[v];}\n}lct;\nstruct opt//\u626b\u63cf\u7ebf \n{\n    int tp;int u;int v;int fr;int pos;\n    friend bool operator <(opt a,opt b){return (a.pos==b.pos)?a.tp<b.tp:a.pos<b.pos;}\n}op[2*N];int hd;int rpt=1;int vpt;int L[N];int R[N];int ans[N];\ninline void att(const int& u,const int& v){lct.lk(u,u+vpt);lct.lk(u+vpt,v);}\ninline void mov(const int& u,const int& v){lct.ct(u,u-1);lct.lk(u,v);}\ninline void del(const int& u,const int& v){lct.ct(u,u+vpt);lct.ct(u+vpt,v);}\ninline void rmv(const int& u,const int& v){lct.ct(u,v);lct.lk(u,u-1);}\nint main()\n{\n    scanf(\"%d%d\",&n,&m);L[1]=1;R[1]=n;\n    for(int i=1,t,l,r,x;i<=m;i++)\n    {\n        scanf(\"%d\",&t);\n        switch(t)\n        {\n            case 0:{scanf(\"%d%d\",&l,&r);++rpt;L[rpt]=l;R[rpt]=r;op[++hd]=(opt){1,rpt,0,0,l};op[++hd]=(opt){5,rpt,0,0,r};break;}\n            case 1:\n            {\n                scanf(\"%d%d%d\",&l,&r,&x);if(x>rpt)break;l=max(l,L[x]);r=min(r,R[x]);if(l>r)break;//\u533a\u95f4\u6c42\u4ea4 \n                op[++hd]=(opt){2,0,x,0,l};op[++hd]=(opt){4,0,x,0,r};break;\n            }\n            case 2:{scanf(\"%d%d%d\",&x,&l,&r);op[++hd]=(opt){3,l,r,i,x};break;}\n        }\n    }vpt=rpt+1;\n    for(int i=1;i<=hd;i++)\n    {\n        switch(op[i].tp)\n        {\n            case 1:{op[i].v=vpt;break;}\n            case 2:{op[i].u=++vpt;break;}\n            case 3:{break;}\n            case 4:{op[i].u=vpt;break;}\n            case 5:{op[i].v=vpt;break;}\n        }\n    }sort(op+1,op+hd+1);lct.lk(1,rpt+1);\n    for(int i=rpt+2;i<=vpt;i++)lct.lk(i-1,i);\n    for(int i=1;i<=m;i++)ans[i]=-1;\n    for(int i=1;i<=rpt;i++)lct.v[vpt+i]=1;\n    for(int i=1;i<=hd;i++)\n    {\n        if(op[i].pos)\n        switch(op[i].tp)\n        {\n            case 1:{att(op[i].u,op[i].v);break;}\n            case 2:{mov(op[i].u,op[i].v);break;}\n            case 3:{ans[op[i].fr]=lct.query(op[i].u,op[i].v);break;}\n            case 4:{rmv(op[i].u,op[i].v);break;}\n            case 5:{del(op[i].u,op[i].v);break;}\n        }\n    }for(int i=1;i<=m;i++)if(ans[i]!=-1)printf(\"%d\\n\",ans[i]);return 0;//\u62dc\u62dc\u7a0b\u5e8f~ \n}\n```\n\n\n\n\n\n\n\n\n",
        "postTime": 1529934165,
        "uid": 56384,
        "name": "shadowice1984",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3348 \u3010[ZJOI2016]\u5927\u68ee\u6797\u3011"
    },
    {
        "content": "[$$\\large \\color{purple}My\\;Blog$$](https://www.cnblogs.com/p-b-p-b/p/10660155.html)\n\n--------------------\n\n\u5237\u4e86\u90a3\u4e48\u4e45\u6c34\u9898\u4e4b\u540e\u7ec8\u4e8e\u6709\u4e00\u9898\u53ef\u4ee5\u6765\u5199\u5199\u535a\u5ba2\u4e86\u3002\n\n\u4f46\u662f\u8fd9\u9898\u592a\u795e\u4ed9\u4e86\u6211\u8fd8\u6ca1\u5b8c\u5168\u5f04\u61c2\u2026\u2026\n\nupd\uff1a\u5199\u5b8c\u535a\u5ba2\u4e4b\u540e\u4f3c\u4e4e\u61c2\u4e86\u3002\n\n-------------------------\n\n## \u601d\u8def\n\n\u9996\u5148\u5f88\u5bb9\u6613\u60f3\u5230$O(n^2\\log n)$\u4e58\u4e0a$O(\\frac{n}{\\log n})$\u7684\u5de8\u5927\u5e38\u6570\u7684\u66b4\u529b\u505a\u6cd5\uff08\u96fe\n\n\u7136\u540e\u53ef\u4ee5\u53d1\u73b0\u8fd9\u9898\u652f\u6301\u628a\u8be2\u95ee\u62bd\u79bb\u51fa\u6765\u6700\u540e\u505a\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u5148\u53ea\u5173\u6ce8\u4fee\u6539\u64cd\u4f5c\u3002\n\n\u53ef\u4ee5\u53d1\u73b0\u4e00\u4e2a\u70b9\u5728$[l,r]$\u7684\u6811\u4e0a\u8fde\u4e0a\u53bb\u548c\u5728\u6240\u6709\u6811\u4e0a\u90fd\u8fde\u4e0a\u53bb\u5176\u5b9e\u6ca1\u6709\u592a\u5927\u533a\u522b\uff0c\u53ea\u662f\u4fee\u6539\u751f\u957f\u8282\u70b9\u65f6\u8981\u5224\u4e00\u4e0b\u662f\u5426\u5b58\u5728\uff0c\u5176\u4ed6\u65f6\u5019\u5176\u5b9e\u53ef\u4ee5\u6bcf\u4e00\u68f5\u6811\u4e0a\u90fd\u8fde\u4e00\u4e2a\uff0c\u56e0\u4e3a\u4e0d\u5b58\u5728\u7684\u70b9\u5e76\u4e0d\u4f1a\u88ab\u8be2\u95ee\u5230\u3002\n\n\u53d1\u73b0\u8fd9\u9898\u4e3b\u8981\u6076\u5fc3\u57281\u64cd\u4f5c\uff08\u4e5f\u5c31\u662f\u66f4\u6362\u751f\u957f\u8282\u70b9\uff09\uff0c\u5982\u679c\u6ca1\u67091\u64cd\u4f5c\u90a3\u4e48\u6240\u6709\u6811\u7684\u5f62\u6001\u5c31\u90fd\u4e00\u6837\u4e86\u3002\n\n\u8003\u8651\u7528\u67d0\u79cd\u65b9\u6cd5\u4f7f\u5f97\u6211\u4eec\u53ef\u4ee5\u53ea\u7ef4\u62a4\u4e00\u68f5\u6811\uff0c\u7136\u540e\u5728\u8fd9\u4e00\u68f5\u6811\u4e0a\u9762\u5b9e\u73b0\u4ece$1$\u5230$n$\u7684\u7075\u6d3b\u8f6c\u6362\u3002\n\n\u5176\u5b9e\u4e5f\u4e0d\u7528\u592a\u8fc7\u7075\u6d3b\uff0c\u53ea\u9700\u8981\u80fd\u591f\u4ece$i$\u5feb\u901f\u63a8\u5230$i+1$\u5373\u53ef\u3002\n\n\u65e2\u71361\u64cd\u4f5c\u6076\u5fc3\uff0c\u90a3\u4e48\u6211\u4eec\u91cd\u70b9\u5206\u67901\u64cd\u4f5c\u3002\n\n\u8003\u8651$[l,r],x$\u7684\u8fd9\u6837\u4e00\u6b21\u64cd\u4f5c\uff0c\u5bf9$l,l-1$\u8fd9\u4e24\u68f5\u6811\u4f1a\u9020\u6210\u4ec0\u4e48\u5dee\u5f02\u3002\u5047\u8bbe$l-1$\u7684\u751f\u957f\u8282\u70b9\u4e3a$y$\u3002\n\n\u90a3\u4e48\u8fd9\u5c31\u76f8\u5f53\u4e8e\u628a\u63a5\u4e0b\u6765\u6240\u6709\u8fde\u5728$y$\u4e0a\u9762\u7684\u8282\u70b9\u4ee5\u53ca\u5b83\u4eec\u7684\u5b50\u6811\u5168\u90fd\u63a5\u5230$x$\u4e0a\u3002\uff08**\u6ce8\u610f\uff1a\u4e0d\u7ba1\u5b83\u4eec\u662f\u5426\u771f\u7684\u6709\u5728$x$\u6811\u4e0a\uff0c\u8fd9\u5bf9\u7b54\u6848\u6ca1\u6709\u5f71\u54cd**\uff09\n\n\u540c\u7406\uff0c$r,r+1$\u4e4b\u95f4\u7684\u5dee\u5f02\u76f8\u5f53\u4e8e\u63a5\u56de\u53bb\u3002\n\n\u90a3\u4e48\u6211\u4eec\u53ea\u8981\u8fc5\u901f\u5730\u4fee\u6539\u4e00\u5806\u5b50\u6811\u7684\u7236\u4eb2\u5373\u53ef\u3002\n\n\u8003\u8651\u5728\u4e00\u4e2a\u865a\u70b9\u4e0b\u9762\u8fde\u4e0a\u8fd9\u4e00\u5806\u5b50\u6811\uff0c\u90a3\u4e48\u6bcf\u6b21\u5c31\u53ea\u9700\u8981\u4fee\u6539\u865a\u70b9\u7684\u7236\u4eb2\u5c31\u597d\u4e86\u3002\n\n\u6bcf\u5f53\u6709\u4e00\u4e2a\u65b0\u76841\u64cd\u4f5c$[l,r],x$\u65f6\u5c31\u65b0\u5f00\u4e00\u4e2a\u865a\u70b9$p$\uff0c\u8868\u793a\u63a5\u4e0b\u6765\u6240\u67090\u64cd\u4f5c\u7684\u70b9\u90fd\u8fde\u5230$p$\u4e0a\uff0c\u540c\u65f6$p$\u4e5f\u8981\u8fde\u5230\u4e0a\u4e00\u4e2a\u865a\u70b9\u4e0a\uff0c\u4fdd\u8bc1\u4e4b\u524d\u7684\u865a\u70b9\u4e5f\u8fde\u4e0a\u4e86\u6240\u6709\u70b9\u3002\n\n$p$\u5728$l$\u6811\u4e4b\u524d\u4e00\u76f4\u8fde\u5728\u539f\u865a\u70b9\u4e0a\uff0c$[l,r]$\u65f6\u8fde\u5728$x$\u4e0a\uff0c\u4e4b\u540e\u518d\u8fde\u56de\u53bb\u3002\n\n\u7136\u540e\u5c31\u53ef\u4ee5\u4ece$1$\u5230$n$\u5904\u7406\u8fd9\u68f5\u6811\u4e0a\u7684\u4fee\u6539\u548c\u8be2\u95ee\uff0c\u7136\u540e\u5c31\u505a\u5b8c\u4e86\u3002\n\n**\u6211\u4e0d\u6562\u786e\u5b9a\u81ea\u5df1\u662f\u5426\u771f\u7684\u7406\u89e3\u4e86\u505a\u6cd5\uff0c\u8bf7\u53d1\u73b0\u601d\u8def\u4e0a\u7684\u9519\u8bef\u7684\u5927\u4f6c\u6307\u6b63\uff0c\u8c22\u8c22\uff01**\n\n----------------------------\n\n## \u4ee3\u7801\n\n\u6ce8\u610f\u8fd9\u91cc\u6ca1\u6709\u4fdd\u5b58\u4e00\u4e2a\u70b9\u5728\u539f\u6811\u4e0a\u7684\u7236\u4eb2\u662f\u8c01\uff0c\u6240\u4ee5\u4e0d\u80fd\u968f\u4fbf$\\text{makeroot}$\u7834\u574fLCT\u4e0a\u7684\u7236\u5b50\u7ed3\u6784\u3002\n\n\u4f46\u662f\u6211\u8fd8\u662f\u4e0d\u600e\u4e48\u660e\u767d$\\text{cut}$\u51fd\u6570\u4e2d\u4e3a\u4ec0\u4e48$lson(x)$\u4e00\u5b9a\u662f$x$\u5728\u539f\u6811\u4e2d\u7684\u7236\u4eb2\uff0c\u5e0c\u671b\u6709\u5927\u4f6c\u8d50\u6559\u3002\n\n```cpp\n#include<bits/stdc++.h>\nclock_t t=clock();\nnamespace my_std{\n\tusing namespace std;\n\t#define pii pair<int,int>\n\t#define fir first\n\t#define sec second\n\t#define MP make_pair\n\t#define rep(i,x,y) for (int i=(x);i<=(y);i++)\n\t#define drep(i,x,y) for (int i=(x);i>=(y);i--)\n\t#define go(x) for (int i=head[x];i;i=edge[i].nxt)\n\t#define templ template<typename T>\n\t#define sz 404040\n\ttypedef long long ll;\n\ttypedef double db;\n\tmt19937 rng(chrono::steady_clock::now().time_since_epoch().count());\n\ttempl inline T rnd(T l,T r) {return uniform_int_distribution<T>(l,r)(rng);}\n\ttempl inline bool chkmax(T &x,T y){return x<y?x=y,1:0;}\n\ttempl inline bool chkmin(T &x,T y){return x>y?x=y,1:0;}\n\ttempl inline void read(T& t)\n\t{\n\t\tt=0;char f=0,ch=getchar();double d=0.1;\n\t\twhile(ch>'9'||ch<'0') f|=(ch=='-'),ch=getchar();\n\t\twhile(ch<='9'&&ch>='0') t=t*10+ch-48,ch=getchar();\n\t\tif(ch=='.'){ch=getchar();while(ch<='9'&&ch>='0') t+=d*(ch^48),d*=0.1,ch=getchar();}\n\t\tt=(f?-t:t);\n\t}\n\ttemplate<typename T,typename... Args>inline void read(T& t,Args&... args){read(t); read(args...);}\n\tchar __sr[1<<21],__z[20];int __C=-1,__zz=0;\n\tinline void Ot(){fwrite(__sr,1,__C+1,stdout),__C=-1;}\n\tinline void print(register int x)\n\t{\n\t\tif(__C>1<<20)Ot();if(x<0)__sr[++__C]='-',x=-x;\n\t\twhile(__z[++__zz]=x%10+48,x/=10);\n\t\twhile(__sr[++__C]=__z[__zz],--__zz);__sr[++__C]='\\n';\n\t}\n\tvoid file()\n\t{\n\t\t#ifndef ONLINE_JUDGE\n\t\tfreopen(\"a.in\",\"r\",stdin);\n\t\t#endif\n\t}\n\tinline void chktime()\n\t{\n\t\t#ifndef ONLINE_JUDGE\n\t\tcout<<(clock()-t)/1000.0<<'\\n';\n\t\t#endif\n\t}\n\t#ifdef mod\n\tll ksm(ll x,int y){ll ret=1;for (;y;y>>=1,x=x*x%mod) if (y&1) ret=ret*x%mod;return ret;}\n\tll inv(ll x){return ksm(x,mod-2);}\n\t#else\n\tll ksm(ll x,int y){ll ret=1;for (;y;y>>=1,x=x*x) if (y&1) ret=ret*x;return ret;}\n\t#endif\n//\tinline ll mul(ll a,ll b){ll d=(ll)(a*(double)b/mod+0.5);ll ret=a*b-d*mod;if (ret<0) ret+=mod;return ret;}\n}\nusing namespace my_std;\n\nint n,m;\n\nint fa[sz],ch[sz][2],w[sz],sum[sz];\n#define ls ch[x][0]\n#define rs ch[x][1]\nvoid pushup(int x){sum[x]=w[x]+sum[ls]+sum[rs];}\nbool get(int x){return ch[fa[x]][1]==x;}\nbool nroot(int x){return ch[fa[x]][0]==x||ch[fa[x]][1]==x;}\nvoid rotate(int x)\n{\n\tint y=fa[x],z=fa[y],k=get(x),w=ch[x][!k];\n\tif (nroot(y)) ch[z][get(y)]=x;ch[x][!k]=y;ch[y][k]=w;\n\tif (w) fa[w]=y;fa[y]=x;fa[x]=z;\n\tpushup(y);pushup(x);\n}\nvoid splay(int x){for (int y;(y=fa[x],nroot(x));rotate(x)) if (nroot(y)) rotate(get(x)==get(y)?y:x);}\nint access(int x){int y=0;for (;x;x=fa[y=x]) splay(x),rs=y,pushup(x);return y;}\nvoid link(int x,int y){splay(x);fa[x]=y;}\nvoid cut(int x){access(x);splay(x);fa[ls]=0;ls=0;pushup(x);}\nint query(int x,int y)\n{\n\tint ret=0;\n\taccess(x);splay(x);ret+=sum[x];\n\tint lca=access(y);\n\tsplay(y);\n\tret+=sum[y];\n\taccess(lca);splay(lca);ret-=2*sum[lca];\n\treturn ret;\n}\n\nint L[sz],R[sz]; // x\u70b9\u5b58\u5728\u7684\u533a\u95f4\nint pos[sz]; // x\u5728LCT\u4e2d\u7684\u7f16\u53f7\n\nstruct hh\n{\n\tint pos,x,y,id;\n\tconst bool operator < (const hh &y) const { return pos==y.pos?id<y.id:pos<y.pos; }\n}q[sz];int c;\n\nint ans[sz];\n\nint main()\n{\n\tfile();\n\tread(n,m);\n\tint ima,real,cnt; // \u5f53\u524d\u865a\u70b9\u3001\u5b9e\u70b9\u7f16\u53f7\uff0c\u603b\u7f16\u53f7 \n\tima=2;real=1;cnt=2;\n\tL[1]=1;R[1]=n;pos[1]=1;w[1]=sum[1]=1;\n\tlink(2,1);\n\tint opt,x,y,z,l,r;\n\trep(i,1,m)\n\t{\n\t\tread(opt);\n\t\tif (opt==0)\n\t\t{\n\t\t\tread(l,r);\n\t\t\tx=++real;pos[x]=++cnt;w[pos[x]]=sum[pos[x]]=1;\n\t\t\tlink(pos[x],ima);\n\t\t\tL[x]=l,R[x]=r;\n\t\t}\n\t\telse if (opt==1)\n\t\t{\n\t\t\tread(l,r,x);\n\t\t\tl=max(l,L[x]);r=min(r,R[x]);\n\t\t\tif (l>r) continue;\n\t\t\tz=++cnt;link(z,ima);\n\t\t\tq[++c]=(hh){l,z,pos[x],i-m};\n\t\t\tq[++c]=(hh){r+1,z,ima,i-m};\n\t\t\tima=z;\n\t\t}\n\t\telse read(z,x,y),q[++c]=(hh){z,pos[x],pos[y],i};\n\t}\n\tsort(q+1,q+c+1);\n\tmemset(ans,-1,sizeof(ans));\n\trep(i,1,c) \n\t\tif (q[i].id<=0) cut(q[i].x),link(q[i].x,q[i].y);\n\t\telse ans[q[i].id]=query(q[i].x,q[i].y);\n\trep(i,1,m) if (ans[i]!=-1) printf(\"%d\\n\",ans[i]);\n\treturn 0;\n}\n```",
        "postTime": 1554517103,
        "uid": 76481,
        "name": "p_b_p_b",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3348 \u3010[ZJOI2016]\u5927\u68ee\u6797\u3011"
    },
    {
        "content": "\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u64cd\u4f5c1\uff0c\u6211\u4eec\u5efa\u7acb\u4e00\u4e2a\u865a\u70b9\uff0c\u7136\u540e\u5c060\u64cd\u4f5c\u7684\u70b9\u6302\u5728\u6700\u65e9\u7684\u865a\u70b9\u4e0b\u9762\u3002\n\n\u533a\u95f4\u96c6\u4f53\u6362\u7236\u4eb2\u5176\u5b9e\u53ef\u4ee5\u7528ETT\u8fdb\u884c\u7ef4\u62a4\uff0c\u4f46\u662f\u5982\u679c\u4f7f\u7528\u4e86\u865a\u70b9\u505a\u6cd5LCT\u5373\u53ef\u3002\n\n```cpp\n#include<bits/stdc++.h>\nconst int N=4e5+5;\nusing namespace std;\nstruct Link_Cut_Tree{\n    int size[N],w[N],c[N][2],fa[N],cnt,rev[N],q[N];\n    inline void newnode(int x){++cnt;size[cnt]=w[cnt]=x;}\n    inline bool isroot(int x){return (c[fa[x]][1]!=x&&c[fa[x]][0]!=x)||!x;}\n    inline void pushup(int x){size[x]=size[c[x][0]]+size[c[x][1]]+w[x];}\n    inline void pushdown(int x){\n        int l=c[x][0],r=c[x][1];\n        if(rev[x]){\n            rev[l]^=1;rev[r]^=1;rev[x]^=1;\n            swap(c[x][0],c[x][1]);\n        }\n    }\n    inline void rotate(int x){\n        int y=fa[x],z=fa[y],l,r;\n        if(c[y][0]==x)l=0;else l=1;r=l^1;\n        if(!isroot(y)){if(c[z][0]==y)c[z][0]=x;else c[z][1]=x;}\n        fa[x]=z;fa[y]=x;fa[c[x][r]]=y;\n        c[y][l]=c[x][r];c[x][r]=y;\n        pushup(y);pushup(x);\n    }\n    inline void splay(int x){\n        int top=1;q[top]=x;\n        for(int i=x;!isroot(i);i=fa[i])q[++top]=fa[i];\n        for(int i=top;i;i--)pushdown(q[i]);\n        while(!isroot(x)){\n            int y=fa[x],z=fa[y];\n            if(!isroot(y)){\n                if((c[y][0]==x)^(c[z][0]==y))rotate(x);\n                else rotate(y);\n            }rotate(x);\n        }\n        pushup(x);\n    }\n    inline int access(int x){int t=0;for(;x;t=x,x=fa[x])splay(x),c[x][1]=t,pushup(x);return t;}\n    inline void cut(int x){access(x),splay(x),fa[c[x][0]]=0,c[x][0]=0;pushup(x);}\n    inline void link(int x,int y){splay(x);fa[x]=y;}\n}T;\nstruct Opt{\n    int pos,opt,x,y;\n    Opt(int pos=0,int opt=0,int x=0,int y=0):pos(pos),opt(opt),x(x),y(y){}\n}a[N];\nbool cmp(Opt a,Opt b){return a.pos==b.pos?a.opt<b.opt:a.pos<b.pos;}\nint n,m,op[N],ed[N],b[N],tot=1,ans[N],vis[N],top;\ninline int read(){\n    int f=1,x=0;char ch;\n    do{ch=getchar();if(ch=='-')f=-1;}while(ch<'0'||ch>'9');\n    do{x=x*10+ch-'0';ch=getchar();}while(ch>='0'&&ch<='9');\n    return f*x;\n}\nint main(){\n    n=read();m=read();int now=0;\n    T.newnode(1);T.newnode(0);T.link(2,1);now=2;\n    b[1]=1;op[1]=1;ed[1]=n;\n    for(int i=1;i<=m;i++){\n        int opt=read(),l=read(),r=read();\n        if(opt==0){\n            ++tot;T.newnode(1);\n            b[tot]=T.cnt;op[tot]=l;ed[tot]=r;\n            a[++top]=Opt(1,i-m,T.cnt,now);\n        }\n        else if(opt==1){\n            int k=read();l=max(op[k],l);r=min(r,ed[k]);\n            if(l<=r){\n                T.newnode(0);T.link(T.cnt,now);\n                a[++top]=Opt(l,i-m,T.cnt,b[k]);\n                a[++top]=Opt(r+1,i-m,T.cnt,now);\n                now=T.cnt;\n            }\n        }\n        else{\n            int k=read();vis[i]=1;\n            a[++top]=Opt(l,i,b[r],b[k]);\n        }\n    }\n    sort(a+1,a+top+1,cmp);int k=1,t=0;\n    for(int i=1;i<=n;i++){\n        for(;a[k].pos==i;k++){\n            if((t=a[k].opt)>0){\n                int x=a[k].x,y=a[k].y;\n                T.access(x);T.splay(x);ans[t]+=T.size[x];\n                int lca=T.access(y);T.splay(y);ans[t]+=T.size[y];\n                T.access(lca);T.splay(lca);ans[t]-=T.size[lca]*2;\n            }else{T.cut(a[k].x);T.link(a[k].x,a[k].y);}\n        }\n    }\n    for(int i=1;i<=m;i++)if(vis[i])printf(\"%d\\n\",ans[i]);\n}\n```",
        "postTime": 1503878044,
        "uid": 2978,
        "name": "zcysky",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3348 \u3010[ZJOI2016]\u5927\u68ee\u6797\u3011"
    },
    {
        "content": "[P3348 [ZJOI2016]\u5927\u68ee\u6797](https://www.luogu.com.cn/problem/P3348)\n\n\u76f4\u63a5lct\u6a21\u62df$n^2logn$\u3002\n\n\u6b63\u89e3\u5148\u6709\u6027\u8d28\uff1a\n\n+ \u6027\u8d281\uff0c\u6bcf\u4e2a0\u64cd\u4f5c\u8303\u56f4\u5982\u679c\u4e3a$1\uff5en$\uff0c\u53ea\u89811\u64cd\u4f5c\u6b63\u786e(\u4e0d\u4f1a\u628a\u751f\u957f\u8282\u70b9\u79fb\u5230\u4e0d\u5b58\u5728\u7684\u8282\u70b9)\uff0c\u4e0d\u4f1a\u5f71\u54cd\u8be2\u95ee\u7684\u7b54\u6848\n+ \u6027\u8d282\uff0c\u5bf9\u4e8e\u6bcf\u68f5\u6811\uff0c\u5148\u4fee\u6539\u5b8c\uff0c\u518d\u8be2\u95ee\uff0c\u7b54\u6848\u4e5f\u4e0d\u4f1a\u53d8\n\n\u6240\u4ee5\u6211\u4eec\u79bb\u7ebf\u5904\u7406\uff0c\u4ece\u524d\u5f80\u540e\u626b\u6811\uff0c\u53ea\u7ef4\u62a4\u4e00\u68f5$lct$\uff0c\u53ea\u9700\u4fee\u6539\u7b2c$i$\u68f5\u6811\u4e0e$i-1$\u68f5\u7684\u4e0d\u540c\u3002\n\n\u5bf9\u4e8e\u751f\u957f\u8282\u70b9\u7684\u4fee\u6539\uff0c\u5efa\u865a\u70b9\uff0c\u4fee\u6539\u751f\u957f\u8282\u70b9$x$\u6b21\uff0c\u5c31\u5efa$x+1$\u4e2a\u865a\u70b9\uff0c\u5c06\u865a\u70b9\u8fde\u8d77\u6765\uff0c\u6700\u4e0a\u9762\u8fde\u7740$1$\u53f7\u6839\u8282\u70b9\uff08\u5b9e\u70b9\uff09\uff0c$i$\u865a\u70b9\u4fa7\u9762\u8fde\u4e0a\u751f\u957f\u8282\u70b9\u4fee\u6539$i$\u6b21\u540e$i+1$\u6b21\u524d$0$\u64cd\u4f5c\u65b0\u52a0\u7684\u70b9\u3002\n\u5bf9\u4e8e\u751f\u957f\u8282\u70b9\u7b2c$id$\u6b21\u88ab\u6539\uff0c$[l, r]$\u6811\u5185\u751f\u957f\u8282\u70b9\u6539\u4e3a\u4e86$x$\uff0c\u9996\u5148\u6839\u636e$[l, r]$\u548c$x$\u5b58\u5728\u7684\u533a\u95f4\uff0c\u786e\u5b9a\u51fa\u751f\u957f\u8282\u70b9\u9700\u8981\u6539\u4e3a$x$\u7684\u533a\u95f4\uff0c\n\u79bb\u7ebf\u5904\u7406\u65f6\uff0c \u626b\u5230\u7b2c$l$\u68f5\u6811\uff0c\u5176$id$\u53f7\u865a\u70b9$cut$\u6389\u7236\u8fb9\uff0c$link$\u4e0a$x$\uff0c \u626b\u5230\u7b2c$r + 1$\u68f5\u6811\uff0c\u5176$id$\u53f7\u865a\u70b9$cut$\u6389\u7236\u8fb9\uff0c$link$\u4e0a$id-1$\u53f7\u865a\u70b9\u3002\n\u6bcf\u68f5\u6811\u5148\u4fee\u6539\u5b8c\u518d\u8be2\u95ee\u3002\n\n\u5bf9\u4e8e\u8be2\u95ee\uff0c\u6ce8\u610f$dis[x,y]$\u4e0d\u80fd\u6362\u6839\u7136\u540e$split$\uff0c\u8981\u7528\u5dee\u5206\u627e$dis$\uff0c$dep[x]+dep[y]-2*dep[lca(x,y)]$,$lca$\u5728$access$\u65f6\u5019\u7a0d\u5fae\u7ef4\u62a4\u4e00\u4e0b\u5c31\u597d\u3002\n\n\u4e3a\u4ec0\u4e48\u4e0d\u80fd\u6362\u6839\uff0c\u56e0\u4e3a\u8fd9\u662f\u6709\u6839\u6811\uff0c\u6211\u4eec\u8981\u7ef4\u62a4\u539f\u6811\u4e2d\u786e\u5b9a\u7684\u7236\u5b50\u5173\u7cfb\uff0c\u624d\u80fd\u6b63\u786e\u7684$cut$\u6389\u7236\u8fb9\n\n\n```cpp\n#include <bits/stdc++.h>\n#define rint register int\n#define F(x) (t[x].fa)\n#define L(x) (t[x].ch[0])\n#define R(x) (t[x].ch[1])\n#define get(x) (x == t[F(x)].ch[1])\n#define not_root(x) (x == t[F(x)].ch[0] || x == t[F(x)].ch[1])\n#define up(x) ({ t[x].sum = t[L(x)].sum + t[R(x)].sum + t[x].val; })\n\nconst int maxn = 1e5, maxm = 2e5;\n\nint n, m, xc = 1, nc = 1, ac;\nint fwl[maxm], fwr[maxm];// \u6bcf\u4e2a\u70b9\u7684\u5b58\u5728\u8303\u56f4\nint ans[maxm];\nstruct Node{\n\tint val, sum, fa, ch[2];\n}t[maxm];\nstruct Sim{\n\tint pos, opt, x, y, z;\n\tbool operator < (const Sim &B)const{\n\t\tif(pos != B.pos) return pos < B.pos;\n\t\treturn opt < B.opt;\n\t}\n}a[maxm * 2];\nstruct Tmp{\n\tint opt, l, r, x;\n}tmp[maxm];\n\nint read(rint x = 0, register bool f = 0, register char ch = getchar()){\n\tfor(;!isdigit(ch);ch = getchar()) f |= ch == '-';\n\tfor(; isdigit(ch);ch = getchar()) x = (x << 3) + (x << 1) + (ch & 15);\n\treturn f ? -x : x ;\n}\n\nvoid add(rint x, rint f, rint d){\n\tif(x) F(x) = f;\n\tif(f) t[f].ch[d] = x;\n}\n\nvoid rotate(rint x){\n\trint y = F(x), z = F(y), gx = get(x), gy = get(y);\n\tif(not_root(y)) add(x, z, gy);\n\telse F(x) = z;\n\tadd(t[x].ch[gx ^ 1], y, gx), add(y, x, gx ^ 1);\n\tup(y);\n}\n\nvoid splay(rint x){\n\twhile(not_root(x)){\n\t\trint y = F(x);\n\t\tif(not_root(y)) get(x) != get(y) ? rotate(x) : rotate(y);\n\t\trotate(x);\n\t}\n\tup(x);\n}\n\nint access(rint x){\n\trint y = 0;\n\tfor(;x;y = x, x = F(x)) splay(x), R(x) = y, up(x);\n\treturn y;//\u8fd4\u56delca\n}\n\nvoid link(rint x, rint y){\n\tsplay(x), F(x) = y; // \u4e0d\u9700\u8981access\uff0c\u6211\u4eec\u6ca1\u6709\u6362\u6839\uff0c\u6240\u4ee5\u8fd9\u4e2ax\u662f\u5176\u5b50\u6811\u7684\u7236\u4eb2\n}\nvoid cut(rint x){\n\taccess(x), splay(x), L(x) = F(L(x)) = 0, up(x);//\u8fd9\u91cc\u5c31\u9700\u8981access\u4e86\uff0c\u56e0\u4e3a\u8981\u8ba9\u4ed6\u7236\u4eb2\u627e\u5230\u4ed6\n}\n\nint cal(rint x, rint y){\n\trint ans = 0, lca;\n\taccess(x), splay(x), ans = t[x].sum;\n\tlca = access(y), splay(y), ans += t[y].sum;\n\taccess(lca), splay(lca), ans -= t[lca].sum * 2;\n\treturn ans;\n}\n\nint main(){\n#ifdef lzx\n\tfreopen(\"1.in\",\"r\",stdin);\n#endif\n\tn = read(), m = read();\n\tfwl[1] = 1, fwr[1] = n; // \u6ce8\u610f1\u7684\u521d\u59cb\u5316\n\tfor(rint i = 1;i <= m; ++i){// \u8bfb\u53d6\u4fee\u6539\u548c\u8be2\u95ee\uff0c\u5904\u7406\u51fa\u865a\u70b9\u548c\u5b9e\u70b9\u7684\u4e2a\u6570\uff0c\u5b9e\u70b9\u7f16\u53f71 ~ nc,\u865a\u70b9\u7f16\u53f7nc + 1 ~ xc\n\t\ttmp[i].opt = read(), tmp[i].l = read(), tmp[i].r = read();\n\t\tif(tmp[i].opt != 0) tmp[i].x = read();\n\t\tswitch(tmp[i].opt){\n\t\t\tcase 0: fwl[++nc] = tmp[i].l, fwr[nc] = tmp[i].r; break; // nc\u5b9e\u70b9\u4e2a\u6570\n\t\t\tcase 1: ++xc; break; // \u865a\u70b9\u4e2a\u6570\n\t\t}\n\t}\n\tfor(rint i = 1;i <= nc; ++i) t[i].val = 1;\n\tlink(nc + 1, 1); // \u6ce8\u610flink\u4f20\u53c2\u7684\u987a\u5e8f\u4e0d\u8981\u53d8\uff0c\u7236\u8282\u70b9\u5728\u540e\n\tfor(rint i = 1, nown = 1, nowx = 1, l, r;i <= m; ++i){//\u5148\u628a\u521d\u59cb\u7684\u6811\u5efa\u51fa\u6765\uff0c\n\t\tswitch(tmp[i].opt){\n\t\t\tcase 0: link(++nown, nowx + nc); break;\n\t\t\tcase 1:\n\t\t\t\tlink(nowx + 1 + nc, nowx + nc), ++nowx;\n\t\t\t\tl = std:: max(tmp[i].l, fwl[tmp[i].x]);\n\t\t\t\tr = std:: min(tmp[i].r, fwr[tmp[i].x]);\n\t\t\t\tif(l <= r){\n\t\t\t\t\ta[++ac] = (Sim){l, 1, nowx + nc, tmp[i].x};\n\t\t\t\t\ta[++ac] = (Sim){r + 1, 1, nowx + nc, nowx - 1 + nc};\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 2: a[++ac] = (Sim){tmp[i].l, 2, tmp[i].r, tmp[i].x, i}; break;\n\t\t}\n\t}\n\tstd:: sort(a + 1, a + 1 + ac);\n\tfor(rint i = 1, j = 1;i <= n; ++i){//\u4ece\u524d\u5f80\u540e\uff0c\u5bf9\u4e8e\u4e00\u68f5\u6811\uff0c\u5148\u5904\u7406link\u548ccut\uff0c\u518d\u5904\u7406\u8be2\u95ee\n\t\tfor(;a[j].pos == i; ++j){\n\t\t\tif(a[j].opt == 1) cut(a[j].x), link(a[j].x, a[j].y);\n\t\t\tif(a[j].opt == 2) ans[a[j].z] = cal(a[j].x, a[j].y);\n\t\t}\n\t}\n\tfor(rint i = 1;i <= m; ++i) if(tmp[i].opt == 2) printf(\"%d\\n\", ans[i]);\n\treturn 0;\n}\n```\n",
        "postTime": 1608691156,
        "uid": 316961,
        "name": "liuzhaoxu",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P3348 \u3010[ZJOI2016]\u5927\u68ee\u6797\u3011"
    },
    {
        "content": "[\u6211\u7684\u535a\u5ba2](https://www.cnblogs.com/GK0328/p/14433094.html)\n\n### $LCT$\n\n\u8fd9\u9053\u9898\u521d\u770b\u5341\u5206\u6050\u6016\uff0c\u9700\u8981\u7ef4\u62a4\u533a\u95f4\u52a0\u53f6\u5b50\u8282\u70b9\uff0c\u533a\u95f4\u4fee\u6539\u751f\u957f\u8282\u70b9\uff0c\u6bcf\u68f5\u6811\u4e2d\u52a0\u5165\u53f6\u5b50\u8282\u70b9\u7684\u4f4d\u7f6e\u53ef\u80fd\u4e0d\u540c\uff0c\u5f88\u96be\u5bf9\u4e8e\u6bcf\u68f5\u6811\u76f4\u63a5\u7ef4\u62a4\u3002\n\n\u867d\u7136\u6bcf\u68f5\u6811\u90fd\u4f1a\u4ea7\u751f\u5927\u91cf\u4fe1\u606f\uff0c\u4f46\u662f\u6211\u4eec\u5982\u679c\u51b7\u9759\u5206\u6790\u4e00\u4e0b\uff0c\u5c31\u4f1a\u53d1\u73b0\u6709\u8bb8\u591a\u4fe1\u606f\u662f\u91cd\u590d\u7684\u3002\n\n\u6211\u4eec\u5148\u4f7f\u95ee\u9898\u7b80\u5355\u5316\u3002\n\n\u6ce8\u610f\u5230$0$\u64cd\u4f5c\u4e2d\u6dfb\u52a0\u7684\u70b9\u53ea\u80fd\u4f5c\u7528\u5728\u4e00\u6bb5\u533a\u95f4\u4e0a\uff0c\u6211\u4eec\u53ef\u4ee5\u53bb\u9664\u8fd9\u4e2a\u9650\u5236\uff0c\u8ba9\u65b0\u7684\u8282\u70b9\u52a0\u5230\u6bcf\u4e00\u68f5\u6811\u4e0a\uff0c\u56e0\u4e3a\u5728\u4e00\u6b21\u64cd\u4f5c\u4e2d\uff0c\u4ea7\u751f\u7684\u8282\u70b9\u7f16\u53f7\u662f\u56fa\u5b9a\u7684\uff0c\u800c\u4e14\u4e0d\u4f1a\u5728\u5176\u4ed6\u64cd\u4f5c\u4e2d\u751f\u6210\uff0c\u540c\u65f6\u4e0d\u53ef\u80fd\u8be2\u95ee\u4e00\u68f5\u6811\u4e2d\u4e0d\u5b58\u5728\u7684\u8282\u70b9\uff0c\u6240\u4ee5\u6211\u4eec\u5c31\u53ef\u4ee5\u8ba9\u8282\u70b9\u5728\u6bcf\u4e00\u68f5\u6811\u4e0a\u751f\u6210\u3002\n\n\u5728$1$\u64cd\u4f5c\u4e2d\u63d0\u5230\uff0c\u5982\u679c\u4e00\u68f5\u6811\u4e0a\u6ca1\u6709\u8282\u70b9$x$\uff0c\u5219\u4e0d\u4fee\u6539\uff0c\u4e0d\u8fc7\u6211\u4eec\u6ce8\u610f\u5230\uff0c\u5b58\u5728\u8282\u70b9$x$\u7684\u4e00\u5b9a\u662f\u4e00\u6bb5\u533a\u95f4\u7684\u6811\uff08\u4ee3\u7801\u4e2d\u6ce8\u610f\u8282\u70b9$1$\u7684\u5b58\u5728\u533a\u95f4\u4e3a$[1,n]$\uff09\uff0c\u56e0\u6b64\u6211\u4eec\u5c06\u4fee\u6539\u533a\u95f4\u4e0e\u5b58\u5728$x$\u8282\u70b9\u7684\u533a\u95f4\u53d6\u4e00\u4e2a\u4ea4\u96c6\u5c31\u53ef\u4ee5\u83b7\u5f97\u771f\u6b63\u4fee\u6539\u7684\u533a\u95f4\u3002\n\n\u5bf9\u4e8e\u64cd\u4f5c$2$\uff0c\u6211\u4eec\u89c2\u5bdf\u5230\u6bcf\u68f5\u6811\u53ea\u4f1a\u6dfb\u52a0\u8282\u70b9\uff0c\u800c\u6ca1\u6709\u968f\u610f\u65ad\u8fb9\u8fde\u8fb9\uff0c\u8fd9\u5c31\u4fdd\u8bc1\u4e86\u6211\u4eec\u7684\u6811\u5728$t$\u65f6\u523b\u7684\u90a3\u4e00\u90e8\u5206\u5f62\u6001\u4e0d\u4f1a\u5728\u4ee5\u540e\u88ab\u6539\u53d8\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u5148\u5efa\u5b8c\u6811\uff0c\u7136\u540e\u4e00\u6b21\u6027\u5904\u7406\u5b8c\u6240\u6709\u8be2\u95ee\uff0c\u8fd9\u5c31\u542f\u53d1\u6211\u4eec\u79bb\u7ebf\u4e0b\u6765\u89e3\u51b3\u3002\n\n\u5047\u8bbe\u6211\u4eec\u5904\u7406\u5b8c\u4e86\u7b2c$x$\u68f5\u6811\uff0c\u7136\u540e\u53bb\u5904\u7406\u7b2c$x+1$\u68f5\u6811\uff0c\u4e00\u4e2a\u5f88\u81ea\u7136\u7684\u60f3\u6cd5\u5c31\u662f\u5229\u7528\u7b2c$x$\u68f5\u6811\u7684\u4fe1\u606f\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u53bb\u5bfb\u627e\u7b2c$x$\u68f5\u6811\u548c\u7b2c$x+1$\u68f5\u6811\u7684\u76f8\u540c\u70b9\uff0c\u7531\u4e8e\u6211\u4eec\u53bb\u6389\u4e86$0$\u64cd\u4f5c\u7684\u533a\u95f4\u9650\u5236\uff0c\u5982\u679c\u4e0d\u5b58\u5728$1$\u64cd\u4f5c\uff0c\u7b2c$x,x+1$\u68f5\u6811\u7684\u5f62\u6001\u5fc5\u5b9a\u76f8\u540c\u3002\n\n\u52a0\u5165\u4e86$1$\u64cd\u4f5c\u4e4b\u540e\uff0c\u6211\u4eec\u4f9d\u7136\u53ef\u4ee5\u53d1\u73b0\uff0c\u5728\u4e24\u6b21\u95f4\u9694\u7684$1$\u64cd\u4f5c\u4e4b\u95f4\uff0c\u7b2c$x,x+1$\u68f5\u6811\u65b0\u6dfb\u52a0\u7684\u8282\u70b9\u5f62\u6001\u4ecd\u7136\u76f8\u540c\uff0c\u53ea\u662f\u751f\u957f\u8282\u70b9\u4e0d\u540c\u7f62\u4e86\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u5982\u4f55\u628a\u8fd9\u4e9b\u8282\u70b9\u642c\u8fd0\u8fc7\u53bb\u3002\n\n\u6211\u4eec\u663e\u7136\u4e0d\u80fd\u4e00\u4e2a\u4e00\u4e2a\u642c\u8fd0\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u5efa\u7acb\u4e00\u4e2a\u865a\u70b9\u6765\u7edf\u8f96\u8fd9\u4e9b\u8282\u70b9\uff0c\u8fd9\u6837\u6211\u4eec\u642c\u8fd0\u65f6\u53ea\u9700\u8981\u4e00\u6b65$cut$\uff0c\u4e00\u6b65$link$\u5c31\u53ef\u4ee5\u4e86\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u6bcf\u5230\u8fbe\u4e00\u4e2a$1$\u64cd\u4f5c\uff0c\u5c31\u5efa\u7acb\u4e00\u4e2a\u865a\u70b9\uff0c\u8ba9\u8fd9\u4e9b\u865a\u70b9\u7edf\u8f96\u4ece\u8fd9\u6b21\u64cd\u4f5c\u5230\u4e0b\u4e00\u6b21$1$\u64cd\u4f5c\u4e4b\u95f4\u4ea7\u751f\u7684\u8282\u70b9\u3002\n\n\u7136\u540e\u6211\u4eec\u8bb0\u5f55\u4e00\u4e0b\u90a3\u4e9b\u4f4d\u7f6e\u9700\u8981\u642c\u8fd0\uff0c\u5bf9\u4e8e\u64cd\u4f5c$1$\u7684\u771f\u6b63\u4fee\u6539\u533a\u95f4$[l,r]$\uff0c\u6211\u4eec\u5728\u4ece$l-1$\u8f6c\u79fb\u5230$l$\u65f6\u9700\u8981\u642c\u8fd0\u4e00\u6b21\uff0c\u4ece$r$\u8f6c\u79fb\u5230$r+1$\u65f6\u9700\u8981\u642c\u8fd0\u4e00\u6b21\u3002\n\n\u56e0\u6b64\u6211\u4eec\u603b\u642c\u8fd0\u6b21\u6570\u4e0d\u8d85\u8fc7$2M$\uff0c\u53ef\u4ee5\u4fdd\u8bc1\u65f6\u95f4\u590d\u6742\u5ea6\u3002\n\n\u6211\u4eec\u6709\u4e86\u5927\u81f4\u7684\u6846\u67b6\uff0c\u5148\u4e0d\u4fee\u6539\u751f\u957f\u8282\u70b9\uff0c\u6309\u9898\u76ee\u8981\u6c42\u5efa\u51fa\u4e00\u68f5\u5e26\u865a\u70b9\u7684\u6811\uff08\u53ef\u4ee5\u770b\u6210\u7b2c$0$\u68f5\u6811\uff09\uff0c\u7136\u540e\u901a\u8fc7\u642c\u8fd0\u4f9d\u6b21\u8f6c\u79fb\u5230\u7b2c$1\\sim n$\u68f5\u6811\uff0c\u5f53\u6211\u4eec\u5904\u7406\u5b8c\u7b2c$i$\u68f5\u6811\u65f6\uff0c\u89e3\u51b3\u6240\u6709\u5173\u4e8e\u7b2c$i$\u68f5\u6811\u7684\u56de\u7b54\u3002\n\n\u7531\u4e8e\u53ea\u9700\u8981\u642c\u8fd0\u5b50\u6811\uff0c\u6211\u4eec\u7684$LCT$\u4e0d\u9700\u8981\u7528\u5230$makeroot$\u64cd\u4f5c\u3002\n\n\u5982\u4f55\u5904\u7406\u56de\u7b54\u5462\uff1f\u6211\u4eec\u5148\u7ed9\u51fa\u7ed3\u8bba\uff0c\u5047\u8bbe$h_i$\u8868\u793a\u8282\u70b9$i$\u5230\u6839\u8282\u70b9$1$\u7684**\u5b9e\u8282\u70b9**\u6570\u91cf\uff0c\u90a3\u4e48\u4e00\u5bf9\u70b9$x,y$\u7684\u7b54\u6848\u5c31\u662f$h_x+h_y-2h_{lca(x,y)}$\u3002\n\n\u60f3\u5fc5\u6709\u4eba\u4f1a\u5bf9\u4e0a\u9762\u7684\u5f0f\u5b50\u4ea7\u751f\u7591\u95ee\uff0c\u7b54\u6848\u96be\u9053\u4e0d\u662f$x$\u5230$y$\u8def\u5f84\u4e0a\u5b9e\u8282\u70b9\u6570\u91cf$-1$\u5417\uff0c\u6b63\u5e38\u7684\u8ba1\u7b97\u94fe\u4e0a\u8282\u70b9\u6570\u91cf\u662f$h_x+h_y-h_{lca(x,y)}-h_{fa_{lca(x,y)}}$\uff0c\u56e0\u6b64\u7b54\u6848\u96be\u9053\u4e0d\u662f$h_x+h_y-h_{lca(x,y)}-h_{fa_{lca(x,y)}}-1$\u5417\uff1f\n\n\u89e3\u91ca\u4e00\u4e0b\u8fd9\u4e2a\u95ee\u9898\uff0c\u9996\u5148\uff0c\u5982\u679c$lca(x,y)$\u4e3a\u5b9e\u8282\u70b9\uff0c\u90a3\u4e48\u4e0a\u5f0f\u663e\u7136\u6210\u7acb\uff0c\u56e0\u4e3a$h_{lca(x,y)}=h_{fa_{lca(x,y)}}+1$\u3002\u5f53$lca(x,y)$\u4e3a\u865a\u8282\u70b9\u65f6\uff0c\u6839\u636e\u6211\u4eec\u5efa\u6811\u7684\u8fc7\u7a0b\uff0c\u867d\u7136$(x,y)$\u5728\u6811\u4e0a\u7684$lca$\u662f\u865a\u70b9\uff0c\u4f46\u662f\u5b9e\u9645\u4e0a\u5728\u539f\u6811\u4e2d\u5b83\u4eec\u7684$lca$\u662f\u865a\u70b9\u7684\u7236\u4eb2$u$\uff0c\u56e0\u4e3a\u865a\u70b9\u53ea\u662f\u4ee3\u7406\u7ba1\u8f96\u4e00\u4e0b$u$\u7684\u5b50\u5b59\u8282\u70b9\u800c\u5df2\uff0c\u5728\u771f\u6b63\u7684\u6811\u4e2d\uff0c$u$\u5728$x,y$\u6240\u5728\u7684\u94fe\u4e0a\uff0c\u800c\u6211\u4eec\u5728\u5229\u7528$LCT$\u7edf\u8ba1\u5b9e\u8282\u70b9\u6570\u65f6\u5ffd\u7565\u4e86\u8fd9\u4e2a\u8282\u70b9\uff0c\u56e0\u6b64\uff1a\n\n$$\nans=(h_x+h_y-h_{lca(x,y)}-h_{fa_{lca(x,y)}}-1)+1\n$$\n$$\n=h_x+h_y-h_{lca(x,y)}-h_{fa_{lca(x,y)}}\n$$\n$$\n=h_x+h_y-2h_{lca(x,y)}\n$$\n\n\u90a3\u4e48\u8fd9\u9053\u9898\u5c31\u5b8c\u7f8e\u89e3\u51b3\u4e86\u3002\n\n$Code:$\n\n```cpp\ntype node=record\n    fa,num,v:longint;\n\tch:array[0..1] of longint;\nend;\ntype qry=record\n    o,x,u,v,idt:longint;\nend;\nvar\n    n,m,i,opt,rl,cnt,gr,l,r,x,u,v,tot,qc:longint;\n    zl,zr,re:array[0..200005] of longint;\n\ta:array[0..200005] of node;\n    g:array[0..400005] of qry;\n    ans:array[0..200005] of longint;\nfunction cmn(x,y:longint):longint;\nbegin\n    if x<y then\n        exit(x) else\n        exit(y);\nend;\nfunction cmx(x,y:longint):longint;\nbegin\n    if x>y then\n        exit(x) else\n        exit(y);\nend;\nfunction ls(x:longint):longint;\nbegin\n    exit(a[x].ch[0]);\nend;\nfunction rs(x:longint):longint;\nbegin\n    exit(a[x].ch[1]);\nend;\nfunction fa(x:longint):longint;\nbegin\n    exit(a[x].fa);\nend;\nfunction num(x:longint):longint;\nbegin\n    exit(a[x].num);\nend;\nfunction va(x:longint):longint;\nbegin\n    exit(a[x].v);\nend;\nfunction isrt(x:longint):boolean;\nbegin\n    exit((ls(fa(x))<>x) and (rs(fa(x))<>x));\nend;\nfunction id(x:longint):longint;\nbegin\n    if ls(fa(x))=x then\n        exit(0);\n    exit(1);\nend;\nprocedure update(x:longint);\nbegin\n    a[x].num:=num(ls(x))+num(rs(x))+va(x);\nend;\nprocedure connect(x,f,son:longint);\nbegin\n    a[x].fa:=f;\n    a[f].ch[son]:=x;\nend;\nprocedure rot(x:longint);\nvar\n    y,r,yson,rson:longint;\nbegin\n    y:=fa(x);\n    r:=fa(y);\n\tyson:=id(x);\n\trson:=id(y);\n    if isrt(y) then\n        a[x].fa:=r else\n        connect(x,r,rson);\n    connect(a[x].ch[yson xor 1],y,yson);\n    connect(y,x,yson xor 1);\n    update(y);\n    update(x);\nend;\nprocedure splay(x:longint);\nvar\n    y:longint;\nbegin\n    while not isrt(x) do\n    begin\n        y:=fa(x);\n        if isrt(y) then\n            rot(x) else\n        if id(x)=id(y) then\n        begin\n            rot(x);\n            rot(x);\n        end else\n        begin\n            rot(y);\n            rot(x);\n        end;\n    end;\nend;\nprocedure access(x:longint);\nvar\n    y:longint;\nbegin\n    y:=0;\n    while x<>0 do\n    begin\n        splay(x);\n        a[x].ch[1]:=y;\n        update(x);\n        y:=x;\n        x:=fa(x);\n    end;\nend;\nfunction access_lca(x,y:longint):longint;\nvar\n    z,ans:longint;\nbegin\n    z:=0;\n    ans:=0;\n    while x<>0 do\n    begin\n        splay(x);\n        a[x].ch[1]:=z;\n        update(x);\n        z:=x;\n        x:=fa(x);\n    end;\n    inc(ans,num(z));\n    z:=0;\n    while y<>0 do\n    begin\n        splay(y);\n        a[y].ch[1]:=z;\n        update(y);\n        z:=y;\n        y:=fa(y);\n    end;\n    y:=z;\n    inc(ans,num(z));\n    ans:=ans-(num(z)-num(rs(z)))*2;\n    exit(ans);\nend;\nprocedure link(x,y:longint);\nbegin\n    a[x].fa:=y;\nend;\nprocedure cut(x:longint);\nbegin\n    access(x);\n    splay(x);\n    a[ls(x)].fa:=0;\n    a[x].ch[0]:=0;\n    update(x);\nend;\nprocedure ins(o,x,u,v,idt:longint);\nbegin\n    inc(tot);\n    g[tot].o:=o;\n    g[tot].x:=x;\n    g[tot].u:=u;\n    g[tot].v:=v;\n    g[tot].idt:=idt;\nend;\nfunction cmp(x,y:qry):boolean;\nbegin\n    if x.x<>y.x then\n        exit(x.x<y.x);\n    exit(x.o<y.o);\nend;\nprocedure sort(l,r:longint);\nvar\n    i,j,k:longint;\n    t:qry;\nbegin\n    i:=l;\n    j:=r;\n    k:=(l+r) div 2;\n    t:=g[k];\n    g[k]:=g[i];\n    while i<j do\n    begin\n        while (i<j) and cmp(t,g[j]) do\n            dec(j);\n        if i<j then\n        begin\n            g[i]:=g[j];\n            inc(i);\n        end;\n        while (i<j) and cmp(g[i],t) do\n            inc(i);\n        if i<j then\n        begin\n            g[j]:=g[i];\n            dec(j);\n        end;\n    end;\n    g[i]:=t;\n    if i-1>l then\n        sort(l,i-1);\n    if i+1<r then\n        sort(i+1,r);\nend;\nbegin\n    read(n);\n\tread(m);\n    cnt:=2;\n    gr:=2;\n\trl:=1;\n\tqc:=0;\n\tre[1]:=1;\n\ta[1].v:=1;\n\tzl[1]:=1;\n\tzr[1]:=n;\n\tupdate(1);\n    link(2,1);\n    for i:=1 to m do\n    begin\n        read(opt);\n        case opt of\n            0:  begin\n                    read(l);\n                    read(r);\n                    inc(rl);\n                    inc(cnt);\n                    a[cnt].v:=1;\n                    update(cnt);\n                    re[rl]:=cnt;\n                    link(cnt,gr);\n                    zl[rl]:=l;\n                    zr[rl]:=r;\n                end;\n            1:  begin\n                    read(l);\n                    read(r);\n                    read(x);\n                    l:=cmx(l,zl[x]);\n                    r:=cmn(r,zr[x]);\n                    if l>r then\n                        continue;\n                    x:=re[x];\n                    inc(cnt);\n                    link(cnt,gr);\n                    ins(0,l,cnt,x,0);\n                    ins(0,r+1,cnt,gr,0);\n                    gr:=cnt;\n                end;\n            2:  begin\n                    read(x);\n                    read(u);\n                    read(v);\n                    inc(qc);\n                    ins(1,x,re[u],re[v],qc);\n                end;\n\t\tend;\n    end;\n    sort(1,tot);\n    for i:=1 to tot do\n    begin\n        if g[i].o=0 then\n        begin\n            cut(g[i].u);\n            link(g[i].u,g[i].v);\n        end else\n\t\t\tans[g[i].idt]:=access_lca(g[i].u,g[i].v);\n    end;\n    for i:=1 to qc do\n        writeln(ans[i]);\nend.\n```",
        "postTime": 1614003540,
        "uid": 10341,
        "name": "GK0328",
        "ccfLevel": 0,
        "title": "P3348 [ZJOI2016]\u5927\u68ee\u6797 \u9898\u89e3"
    },
    {
        "content": "**\u9898\u610f** : \u7ef4\u62a4\u4e00\u6392 $n$ \u68f5\u6811\uff0c\u6bcf\u68f5\u6811\u90fd\u6709\u4e00\u4e2a\u7279\u6b8a\u8282\u70b9\uff0c\u79f0\u4e3a\u201c\u751f\u957f\u8282\u70b9\u201d\u3002\n\n\u521d\u59cb\u65f6\uff0c\u6bcf\u4e2a\u6811\u90fd\u4ec5\u6709\u4e00\u4e2a\u751f\u957f\u8282\u70b9\u3002\n\n\u652f\u6301\u4e0b\u5217\u64cd\u4f5c \uff1a\n\n- `0 l r` \n\n  \u8ba9\u7b2c $l$ \u68f5\u6811\u5230\u7b2c $r$ \u68f5\u6811\u7684\u751f\u957f\u8282\u70b9\u4e0b\u9762\u957f\u51fa\u4e00\u4e2a\u5b50\u8282\u70b9\uff0c\u5b50\u8282\u70b9\u7684\u6807\u53f7\u4e3a\u4e0a\u4e00\u4e2a $0$ \u53f7\u64cd\u4f5c\u53f6\u5b50\u6807\u53f7\u52a0 $1$\u3002\n  \n  \uff08\u8fd9\u6837\uff0c$l$ \u5230 $r$ \u4e4b\u95f4\u7684\u6811\u957f\u51fa\u7684\u8282\u70b9\u6807\u53f7\u90fd\u76f8\u540c\u3002\u4f8b\u5982\uff0c\u7b2c\u4e00\u4e2a $0$ \u53f7\u64cd\u4f5c\u4ea7\u751f\u7684\u5b50\u8282\u70b9\u6807\u53f7\u4e3a $2$\uff09\n\n- `1 l r x` \n\n  \u5c06\u7b2c $l$ \u68f5\u6811\u5230\u7b2c $r$ \u68f5\u6811\u7684\u751f\u957f\u8282\u70b9\u6539\u5230\u6807\u53f7\u4e3a $x$ \u7684\u8282\u70b9\u3002\n  \n  \u5bf9\u4e8e $i$ ($l\\leq i\\leq r$) \u8fd9\u68f5\u6811\uff0c\u5982\u679c\u6807\u53f7 $x$ \u7684\u70b9\u4e0d\u5728\u5176\u4e2d\uff0c\u90a3\u4e48\u8fd9\u4e2a\u64cd\u4f5c\u5bf9\u8be5\u6811\u4e0d\u4ea7\u751f\u5f71\u54cd\u3002\n\n- `2 x u v` \n\n  \u8be2\u95ee\u7b2c $x$ \u68f5\u6811\u4e2d\u8282\u70b9 $u$ \u5230\u8282\u70b9 $v$ \u70b9\u7684\u8ddd\u79bb\u3002\u4fdd\u8bc1\u7f16\u53f7 $u,v$ \u5728\u8be5\u6811\u4e2d\u5b58\u5728\u3002\n  \n\u5141\u8bb8\u79bb\u7ebf\uff0c$n\\leq 10^5,m\\leq 2\\times 10^5$ \uff0c\u65f6\u9650$\\texttt{1s}$\u3002\n\n------------\n\n\u9996\u5148\u89c2\u5bdf\u51fa\u4e24\u4e2a\u91cd\u8981\u6027\u8d28 :\n\n- \u53d1\u751f\u5728\u67d0\u4e2a\u8be2\u95ee\u540e\u7684\u64cd\u4f5c\u4e0d\u4f1a\u5f71\u54cd\u8be5\u8be2\u95ee\u7684\u7b54\u6848\u3002\n\n  \u56e0\u6b64\uff0c\u53ef\u4ee5\u5148\u5b8c\u6210\u6240\u6709\u4fee\u6539\u518d\u56de\u7b54\u8be2\u95ee\u3002\n\n- \u8be2\u95ee\u65f6\u4fdd\u8bc1\u7f16\u53f7\u5b58\u5728\u3002\n\n  \u56e0\u6b64\uff0c\u5728\u64cd\u4f5c 0 \u4e2d\uff0c\u53ef\u4ee5\u6539\u4e3a\u7ed9\u6240\u6709\u6811\u90fd\u957f\u4e00\u4e2a\u70b9\uff08\u800c\u4e0d\u53ea\u662f\u7ed9\u5b9a\u533a\u95f4\u5185\u7684\u6811\uff09\u3002\u591a\u51fa\u6765\u7684\u70b9\u4e0d\u4f1a\u88ab\u8be2\u95ee\u5230\uff0c\u6545\u4e0d\u4f1a\u5f71\u54cd\u7b54\u6848\u3002\n  \n  \u4f46\u8981\u6ce8\u610f\uff0c\u5728\u64cd\u4f5c 1 \u4e2d\uff0c\u82e5\u70b9 $x$ \u4e0d\u5b58\u5728\u5219\u65e0\u5f71\u54cd\uff0c\u6240\u4ee5\u8981\u5c06\u64cd\u4f5c\u533a\u95f4\u548c\u8be5\u7f16\u53f7\u7684\u5b58\u5728\u533a\u95f4\u6c42\u4ea4\u96c6\u3002\n\n\u96be\u4ee5\u540c\u65f6\u7ef4\u62a4 $n$ \u68f5\u6811\uff0c\u8003\u8651\u5dee\u5206\uff08\u626b\u63cf\u7ebf\uff09\uff0c\u5373\u7ef4\u62a4\u76f8\u90bb\u4e24\u68f5\u6811\u7684\u53d8\u5316\u3002\n\n\u4e00\u4e2a 1 \u64cd\u4f5c\u4f1a\u5728 $l,l+1$ \u4ee5\u53ca $r,r+1$ \u4e4b\u95f4\u4ea7\u751f\u5f71\u54cd\u3002\n\n\u9ebb\u70e6\u5728\u4e8e\uff0c\u5404\u4e2a 1 \u64cd\u4f5c\u8fd8\u6709\u5404\u81ea\u7684\u53d1\u751f\u65f6\u95f4\uff0c\u82e5\u6211\u4eec\u6309\u7167\u5e8f\u5217\u672c\u8eab\u7684\u987a\u5e8f\u8fdb\u884c\uff0c\u5219\u5fc5\u7136\u5bfc\u81f4\u64cd\u4f5c\u65f6\u95f4\u7684\u4e71\u5e8f\u3002\n\n\u8003\u8651\u8bbe\u8ba1\u4e00\u79cd\u65b9\u6cd5\uff0c\u5728\u4ee5\u4efb\u610f\u987a\u5e8f\u7ed9\u51fa\u6216\u64a4\u9500\u64cd\u4f5c 1 \u65f6\uff08\u4e0d\u6309\u7167\u539f\u672c\u7684\u65f6\u95f4\u987a\u5e8f\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u53ef\u4ee5\u63d2\u5165\u64cd\u4f5c\uff0c\u4e5f\u53ef\u4ee5\u5220\u9664\u64cd\u4f5c\uff09\uff0c\u80fd\u7ef4\u62a4\u6811\u7684\u5f62\u6001\u3002\n\n\u5c06\u4e00\u4e2a\u53d1\u751f\u5728\u65f6\u523b $t$ \u7684\uff0c\u5c06\u751f\u957f\u70b9\u6539\u4e3a $x$ \u7684\u64cd\u4f5c\u8bb0\u4e3a $(t,x)$\u3002\n\n\u521d\u59cb\u65f6\uff0c\u6ca1\u6709\u6362\u751f\u957f\u70b9\u64cd\u4f5c\uff0c\u6240\u6709 0 \u64cd\u4f5c\u4ea7\u751f\u7684\u70b9\u90fd\u6302\u5728\u8282\u70b9 $1$ \u4e0b\u9762\u3002\n\n\u82e5\u63d2\u5165\u64cd\u4f5c $(t,x)$ \uff0c\u67e5\u770b\u76ee\u524d\u5b58\u5728\u7684\u64cd\u4f5c\u96c6\u5408\u4e2d\uff08\u4ee5 $t$ \u4e3a\u5e8f\uff09\u7684\u524d\u9a71\u540e\u7ee7 $(t_0,x_0),(t_1,x_1)$\u3002\n\n\u4e0d\u96be\u53d1\u73b0\uff0c\u7531\u4e8e\u64cd\u4f5c $(t_1,x_1)$ \u7684\u4f5c\u7528\uff0c\u64cd\u4f5c $(t,x)$ \u7684\u6548\u529b\u4e0d\u4f1a\u5f71\u54cd\u5230 $t_1$ \u4ee5\u53ca\u66f4\u540e\u7684\u65f6\u523b\u3002\u4e8e\u662f\uff0c\u6211\u4eec\u53ea\u9700\u8981\u8003\u8651\u51fa\u73b0\u65f6\u95f4\u5728 $t\\sim t_1-1$ \u5185\u7684\u8282\u70b9\u3002\n\n\u8fd9\u4e9b\u8282\u70b9\u539f\u672c\u5168\u90fd\u63a5\u5728\u8282\u70b9 $x_0$ \u4e0b\uff0c\u6211\u4eec\u5c06 $x_0$ \u4e0b\u51fa\u73b0\u65f6\u95f4 $\\geq t$ \u7684\u8282\u70b9\u90fd\u5ac1\u63a5\u5230 $x$ \u4e0b\u5373\u53ef\u3002\n\n\u4e0d\u96be\u53d1\u73b0\uff0c\u6bcf\u4e2a\u70b9\u7684\u76f4\u63a5\u513f\u5b50\u7684\u51fa\u73b0\u65f6\u95f4\u90fd\u662f\u4e00\u4e2a\u533a\u95f4\u3002\n\n\u5982\u4f55\u5feb\u901f\u5ac1\u63a5\uff1f\u8003\u8651\u4f7f\u7528\u865a\u70b9\uff0c\u4e3a\u6bcf\u4e2a\u65f6\u523b\u5efa\u7acb\u4e00\u4e2a\u865a\u70b9\uff0c\u5c06\u5bf9\u5e94\u7684\u5b9e\u70b9\u6302\u5728\u865a\u70b9\u4e0b\u3002\uff08\u865a\u70b9\u4e0b\u53ef\u80fd\u6ca1\u6709\u5b9e\u70b9\uff0c\u6216\u6070\u6709\u4e00\u4e2a\uff09\n\n\u82e5\u65f6\u523b $tl\\sim tr$ \u4e2d\u4ea7\u751f\u7684\u8282\u70b9\u7684\u7236\u4eb2\u5747\u4e3a\u5b9e\u70b9 $u$ \uff0c\u5219\u865a\u70b9 $tl$ \u8fde\u63a5\u5b9e\u70b9 $u$ \uff0c\u5176\u4ed6\u865a\u70b9 $i\\in(tl,tr]$ \u8fde\u63a5\u865a\u70b9 $i-1$\u3002\n\n\u8fd9\u6837\uff0c\u6bcf\u4e2a\u5b9e\u70b9\u4e0b\u65b9\u90fd\u6709\u4e00\u6761\u6309\u7167\u7f16\u53f7\uff08\u65f6\u95f4\uff09\u4e3a\u5e8f\u7684\u865a\u70b9\u94fe\u3002\u5ac1\u63a5\u65f6\uff0c\u53ea\u9700\u5c06\u94fe\u65ad\u5f00\uff0c\u7136\u540e\u5c06\u4e0b\u9762\u7684\u90e8\u5206\u63a5\u5230\u5bf9\u5e94\u4f4d\u7f6e\u3002\n\n\u5f53\u5220\u9664 \u64cd\u4f5c $(t,x)$ \u65f6\uff0c\u7c7b\u4f3c\u5730\u8003\u8651\u524d\u9a71\u540e\u7ee7 $(t_0,x_0),(t_1,x_1)$ \uff0c\u5c06\u8282\u70b9 $t\\sim t_1-1$ \u5ac1\u63a5\u56de $x_0$ \u4e0b\u65b9\u5373\u53ef\u3002\n\n\u5ac1\u63a5\u64cd\u4f5c\u65f6\uff0c\u4e5f\u53ea\u9700\u8981\u65ad\u5f00\u865a\u70b9 $t$ \u7684\u7236\u8fb9\uff0c\u7136\u540e\u6302\u5230\u56de\u865a\u70b9 $t-1$ \u4e0b\u9762\u3002\n\n\uff08\u5177\u4f53\u5b9e\u73b0\u65f6\u5e76\u4e0d\u9700\u8981\u771f\u7684\u67e5\u627e\u524d\u9a71\u540e\u7ee7\uff09\n\n\u63a5\u4e0b\u6765\u5229\u7528\u4e0a\u8ff0\u7b97\u6cd5\u8fdb\u884c\u626b\u63cf\u7ebf\u5373\u53ef\u3002\n\n\u6211\u4eec\u5df2\u7ecf\u7ef4\u62a4\u4e86\u6811\u7684\u5f62\u6001\uff0c\u73b0\u5728\u8981\u5904\u7406\u67e5\u8be2\u3002\n\n\u8bb0 $s(u)$ \u4e3a $u$ \u5230\u6839\u7684\u8def\u5f84\u4e0a\u5b9e\u70b9\u7684\u4e2a\u6570\uff0c\u5219 $u,v$ \u4e4b\u95f4\u7684\u8ddd\u79bb\u7b49\u4e8e $s(u)+s(v)-s\\big({\\rm lca}(u,v)\\big)$\u3002\n\nLCA \u53ef\u4ee5\u5229\u7528 `access` \u64cd\u4f5c\u6c42\u51fa\u3002\n\n\u5b9e\u73b0\u7ec6\u8282 : \u672c\u9898\u7684 LCT \u7ef4\u62a4\u7684\u662f\u6709\u6839\u6811\uff0c\u6240\u4ee5\u65e0\u9700 `makert` \u548c\u53cd\u8f6c\u6807\u8bb0\u3002\u4e14 Link \u548c Cut \u8981\u6839\u636e\u7236\u5b50\u5173\u7cfb\u5b9e\u73b0\u3002\n\n\u590d\u6742\u5ea6 $O(n\\log n)$\u3002\n\n```cpp\n#include<algorithm>\n#include<cstdio>\n#include<vector>\n#define pb push_back\n#define MaxM 205000\n#define MaxN 105000\nusing namespace std;\nstruct Node{int l,r,f,c;}a[MaxM<<1];\ninline bool nrt(int u)\n{return a[a[u].f].l==u||a[a[u].f].r==u;}\nint m;\ninline void up(int u)\n{a[u].c=a[a[u].l].c+a[a[u].r].c+(u>m);}\ninline void rot(int u)\n{\n  int fa=a[u].f,gf=a[fa].f;\n  a[a[fa].f=u].f=gf;\n  if (a[gf].l==fa)a[gf].l=u;\n  if (a[gf].r==fa)a[gf].r=u;\n  if (a[fa].l==u){\n    a[a[fa].l=a[u].r].f=fa;\n    a[u].r=fa;\n  }else {\n    a[a[fa].r=a[u].l].f=fa;\n    a[u].l=fa;\n  }up(fa);up(u);\n}\nvoid splay(int u)\n{\n  while(nrt(u)){\n    int fa=a[u].f,gf=a[fa].f;\n    if (nrt(fa)&&((a[gf].l==fa)==(a[fa].l==u)))\n      rot(fa);\n    rot(u);\n  }\n}\nint access(int u){\n  int v=0;\n  for (;u;v=u,u=a[u].f){\n    splay(u);\n    a[u].r=v;up(u);\n  }return v;\n}\nint lca(int u,int v)\n{access(u);return access(v);}\nint dep(int u)\n{access(u);splay(u);return a[u].c;}\nvoid link(int u,int v)\n{access(u);splay(u);a[u].f=v;}\nvoid cut(int u){\n  access(u);splay(u);\n  a[a[u].l].f=0;a[u].l=0;up(u);\n}\nstruct QData{int u,v,p;};\nvector<QData> q[MaxN];\nstruct Data{int t,x;bool op;};\nvector<Data> b[MaxN];\nint n,tn,sl[MaxM<<1],sr[MaxM<<1],ans[MaxM],fa[MaxM<<1];\nint main()\n{\n  scanf(\"%d%d\",&n,&m);m++;tn=m+1;\n  sl[m+1]=1;sr[m+1]=n;\n  for (int i=2,op,l,r,u,v,p;i<=m;i++){\n    scanf(\"%d\",&op);\n    if (op==0){\n      fa[++tn]=i;\n      scanf(\"%d%d\",&sl[tn],&sr[tn]);\n    }\n    if (op==1){\n      scanf(\"%d%d%d\",&l,&r,&u);u+=m;\n      if (u<=tn){\n        l=max(l,sl[u]);r=min(r,sr[u]);\n        if (l<=r){\n          b[l].pb((Data){i,u,1});\n          b[r+1].pb((Data){i,0,0});\n        }\n      }\n    }\n    if (op==2){\n      scanf(\"%d%d%d\",&p,&u,&v);\n      q[p].pb((QData){m+u,m+v,i});\n    }ans[i]=-1;\n  }\n  for (int i=m+1;i<=tn;i++)a[i].c=1;\n  link(1,m+1);\n  for (int i=2;i<=m;i++)link(i,i-1);\n  for (int i=m+2;i<=tn;i++)link(i,fa[i]);\n  for (int i=1;i<=n;i++){\n    for (int j=0;j<b[i].size();j++)\n      if (b[i][j].op==1){\n        cut(b[i][j].t);\n        link(b[i][j].t,b[i][j].x);\n      }else {\n        cut(b[i][j].t);\n        link(b[i][j].t,b[i][j].t-1);\n      }\n    for (int j=0;j<q[i].size();j++){\n      int t=lca(q[i][j].u,q[i][j].v);\n      ans[q[i][j].p]=dep(q[i][j].u)+dep(q[i][j].v)-2*dep(t);\n    }\n  }\n  for (int i=2;i<=m;i++)\n    if (ans[i]!=-1)printf(\"%d\\n\",ans[i]);\n  return 0;\n}\n```",
        "postTime": 1610362463,
        "uid": 58705,
        "name": "command_block",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P3348 \u3010[ZJOI2016]\u5927\u68ee\u6797\u3011"
    },
    {
        "content": "# Solution\n\n - \u9996\u5148\u53d1\u73b0\u628a $2$ \u64cd\u4f5c\u90fd\u4e22\u5230\u6700\u540e\u5904\u7406\u4e0d\u4f1a\u5f71\u54cd\u7b54\u6848\n - \u90a3\u4e48\u53ef\u4ee5\u628a\u6240\u6709\u4fee\u6539\u64cd\u4f5c\u62c6\u6210\u5728 $l$ \u5904\u52a0\u5165\uff0c\u5728 $r+1$ \u5904\u5220\u9664\n - \u628a\u6240\u6709\u64cd\u4f5c\u8bfb\u5165\u4e4b\u540e\u6309**\u6811\u7684\u7f16\u53f7**\u987a\u5e8f\u5904\u7406\n - \u52a8\u6001\u7ef4\u62a4**\u4e00\u68f5\u6811**\uff0c\u5373\u5904\u7406\u7b2c $i$ \u68f5\u6811\u540e\uff0c\u8fd9\u68f5\u6811\u5c31\u662f\u7b2c $i$ \u68f5\u6811\u7684\u7ed3\u6784\n ****\n - \u4f46\u662f\u4e0d\u7ef4\u62a4\u539f\u6811\u7ed3\u6784\uff0c\u800c\u662f\u7ef4\u62a4\u4e00\u4e2a\u7b49\u4ef7\u7684\u4e1c\u897f\uff1a\n - \u7ed9\u6bcf\u4e2a $1$ \u64cd\u4f5c\u5efa\u4e00\u4e2a\u865a\u70b9\uff0c\u6bcf\u4e2a $0$ \u64cd\u4f5c\uff08\u4e5f\u53ef\u4ee5\u8bf4\u662f\u539f\u6811\u4e0a\u7684\u6bcf\u4e2a\u70b9\uff09\u5efa\u4e00\u4e2a\u5b9e\u70b9\n - \u5b9e\u70b9\u7684\u7236\u4eb2\u59cb\u7ec8\u4e0d\u53d8\uff08\u6240\u4ee5\u4e00\u5f00\u59cb\u5c31\u8fde\u597d\uff09\uff0c\u90fd\u662f\u5728\u5b83\u4e4b\u524d\u7684\u7b2c\u4e00\u4e2a $1$ \u64cd\u4f5c\u7684\u865a\u70b9\n - \u5904\u7406\u7b2c $i$ \u68f5\u6811\u540e\uff0c\u5982\u679c\u865a\u70b9 $x$ \u5bf9\u5e94\u7684\u64cd\u4f5c\u5728\u8fd9\u68f5\u6811\u4e0a\u751f\u6548\uff0c\u90a3\u4e48 $x$ \u7684\u7236\u4eb2\u4e3a\u5b83\u5bf9\u5e94\u7684\u5b9e\u70b9\uff0c\u5426\u5219 $x$ \u5411\u4e0a\u4e00\u4e2a\u865a\u70b9\u8fde\u8fb9\n****\n - \u4e00\u5f00\u59cb\u53ef\u4ee5\u770b\u4f5c\u6267\u884c\u4e00\u4e2a**\u628a\u6240\u6709\u6811\u7684\u751f\u957f\u8282\u70b9\u90fd\u6539\u4e3a $1$** \u7684\u64cd\u4f5c\uff0c\u56e0\u6b64\u4e00\u5f00\u59cb\u591a\u5efa\u4e00\u4e2a\u865a\u70b9\uff0c\u5b83\u7684\u7236\u4eb2\u662f\u5b9e\u70b9 $1$\n - \u7136\u540e\u4e00\u5f00\u59cb\u8fd8\u8981\u628a\u6240\u6709\u865a\u70b9\u90fd\u8fde\u5411\u4e0a\u4e00\u4e2a\n - \u6784\u5efa\u591a\u4f59\u7684\u5b9e\u70b9\u4e0d\u4f1a\u5f71\u54cd\u7b54\u6848\uff0c\u4f46 $1$ \u64cd\u4f5c ($1$ $l$ $r$ $x$) \u7684**\u533a\u95f4 $[l,r]$ \u91cc\u4e0d\u4e00\u5b9a\u6240\u6709\u6811\u90fd\u957f\u8fc7\u7f16\u53f7\u4e3a $x$ \u7684\u8282\u70b9**\uff0c\u4f46\u662f\u957f\u8fc7\u7f16\u53f7\u4e3a $x$ \u7684\u8282\u70b9\u7684\u6811\u4e00\u5b9a\u6784\u6210\u4e00\u4e2a\u533a\u95f4 $[u,v]$\uff0c\u6240\u4ee5 $[l,r]$ \u548c $[u,v]$ \u53d6\u5e76\u96c6\u5373\u53ef\n - \u64cd\u4f5c $0$ \u7684\u5f71\u54cd\u4e5f\u53ea\u6709\u8fd9\u4e9b\uff0c\u4e0d\u7528\u62c6\u6210 $l$ \u548c $r+1$\n****\n - \u64cd\u4f5c $1$ \u5728 $l$ \u5904\u52a0\u5165\uff1a\u628a\u5bf9\u5e94\u865a\u70b9\u8fde\u5411\u5bf9\u5e94\u5b9e\u70b9\n - \u5728 $r+1$ \u5904\u5220\u9664\uff1a\u628a\u5bf9\u5e94\u865a\u70b9\u8fde\u56de\u4e0a\u4e00\u4e2a\u865a\u70b9\n - \u5bf9\u4e8e\u7b2c $i$ \u68f5\u6811\uff0c\u5904\u7406\u597d\u6240\u6709\u5173\u4e8e\u5b83\u7684\u4fee\u6539\u4e4b\u540e\u5373\u53ef\u67e5\u8be2\u7b54\u6848\n****\n - \u67e5\u8be2\u7b54\u6848\uff1a\u8bb0 $s(x)$ \u4e3a $x$ \u5230\u6839\u8def\u5f84\u4e0a\u70b9\u6743\u4e4b\u548c\uff0c\u663e\u7136\u5b9e\u70b9\u6743\u503c\u4e3a $1$\uff0c\u865a\u70b9\u4e3a $0$\n - \u90a3\u4e48 $ans=s(x)+s(y)-s(lca(x,y))$\n - \u6ce8\u610f\u6b64\u9898\u4e2d\u4e0d\u80fd $makeroot$\uff0c\u56e0\u4e3a\u4e0d\u80fd\u6253\u4e71\u7236\u5b50\u5173\u7cfb\uff0c\u6811\u8fb9\u662f\u6709\u5411\u7684\n - \u627e $lca$\uff1a\u5148 $access(x)$\uff0c\u7136\u540e $access(y)$ \n - $access(y)$ \u7684\u5faa\u73af\u7ed3\u675f\u6761\u4ef6\uff1a\u5df2\u7ecf\u5230\u4e86\u548c\u6839\u540c\u4e00\u6761\u5b9e\u94fe\u4e0a\uff0c\u7136\u540e\u4e0d\u662f\u6709\u4e2a $rc[u]=v$ \u8fd9\u6837\u7684\u4e1c\u897f\u5417\uff0c\u6b64\u65f6\u7684 $u$ \u5373 $lca(x,y)$\n - \u597d\u50cf\u4e0d\u592a\u597d\u63cf\u8ff0\u6e05\u695a\uff0c\u90a3\u4e48\u4e0a\u4ee3\u7801\uff1a\n ```cpp\ninline int access(int x)\n{\n\tint y;\n\tfor (y = 0; x; y = x, x = fa[x])\n\t{\n\t\tsplay(x);\n\t\trc[x] = y;\n\t\tif (y) fa[y] = x;\n\t\tupt(x);\n\t}\n\treturn y;\n}\n ```\n - \u53ef\u4ee5\u7ef4\u62a4\u6bcf\u4e2a\u70b9 $splay$ \u4e0a\u7684\u5b50\u6811\u70b9\u6743\u548c\uff0c\u67e5\u8be2 $s(x)$ \u53ea\u8981 $splay(x)$ \u7136\u540e\u7528\u81ea\u5df1\u70b9\u6743\u52a0\u4e0a\u5de6\u5b50\u6811\u70b9\u6743\u4e4b\u548c\n\n# Code\n```cpp\n#include <bits/stdc++.h>\n\nusing namespace std;\n\ntemplate <class t>\ninline void read(t & res)\n{\n\tchar ch;\n\twhile (ch = getchar(), !isdigit(ch));\n\tres = ch ^ 48;\n\twhile (ch = getchar(), isdigit(ch))\n\tres  = res * 10 + (ch ^ 48);\n}\n\ntemplate <class t>\ninline void print(t x)\n{\n\tif (x > 9) print(x / 10);\n\tputchar(x % 10 + 48);\n}\n\nconst int e = 1e6 + 5;\nstruct point\n{\n\tint opt, x, y, id;\n};\nvector<point>g[e];\nint lc[e], rc[e], fa[e], num, sum[e], n, m, c1 = 1, c2 = 1, q, ans[e], val[e], lst[e];\nint ld[e], rd[e];\n\ninline bool which(int x)\n{\n\treturn rc[fa[x]] == x;\n}\n\ninline bool isroot(int x)\n{\n\treturn !fa[x] || (lc[fa[x]] != x && rc[fa[x]] != x);\n}\n\ninline void upt(int x)\n{\n\tsum[x] = val[x];\n\tif (lc[x]) sum[x] += sum[lc[x]];\n\tif (rc[x]) sum[x] += sum[rc[x]];\n}\n\ninline void rotate(int x)\n{\n\tint y = fa[x], z = fa[y], b;\n\tif (z && !isroot(y)) (lc[z] == y ? lc[z] : rc[z]) = x;\n\tb = (lc[y] == x ? rc[x] : lc[x]);\n\tfa[x] = z;\n\tfa[y] = x;\n\tif (b) fa[b] = y;\n\tif (lc[y] == x)\n\t{\n\t\trc[x] = y;\n\t\tlc[y] = b;\n\t}\n\telse\n\t{\n\t\tlc[x] = y;\n\t\trc[y] = b;\n\t}\n\tupt(y);\n\tupt(x);\n}\n\ninline void splay(int x)\n{\n\twhile (!isroot(x))\n\t{\n\t\tif (!isroot(fa[x]))\n\t\t{\n\t\t\tif (which(x) == which(fa[x])) rotate(fa[x]);\n\t\t\telse rotate(x);\n\t\t}\n\t\trotate(x);\n\t}\n}\n\ninline int access(int x)\n{\n\tint y;\n\tfor (y = 0; x; y = x, x = fa[x])\n\t{\n\t\tsplay(x);\n\t\trc[x] = y;\n\t\tif (y) fa[y] = x;\n\t\tupt(x);\n\t}\n\treturn y;\n}\n\ninline void link(int x, int y)\n{\n\tlst[x] = y;\n\tsplay(x);\n\tfa[x] = y;\n}\n\ninline void cut(int x)\n{\n\taccess(x);\n\tsplay(x);\n\tfa[lc[x]] = 0;\n\tlc[x] = 0;\n\tupt(x);\n}\n\ninline int lca(int x, int y)\n{\n\taccess(x);\n\treturn access(y);\n}\n\ninline int query(int x)\n{\n\taccess(x);\n\tsplay(x);\n\treturn val[x] + sum[lc[x]];\n}\n\nint main()\n{\n\tint i, opt, l, r, x, j;\n\tread(n); read(m);\n\tlink(c1 + m, c2);\n\tval[c2] = sum[c2] = 1;\n\tld[1] = 1;\n\trd[1] = n;\n\tfor (i = 1; i <= m; i++)\n\t{\n\t\tread(opt);\n\t\tread(l);\n\t\tread(r);\n\t\tif (opt == 0) \n\t\t{\n\t\t\tc2++;\n\t\t\tld[c2] = l;\n\t\t\trd[c2] = r;\n\t\t\tval[c2] = sum[c2] = 1;\n\t\t\tcut(c2);\n\t\t\tlink(c2, c1 + m);\n\t\t}\n\t\telse if (opt == 1)\n\t\t{\n\t\t\tc1++;\n\t\t\tcut(c1 + m);\n\t\t\tlink(c1 + m, c1 + m - 1);\n\t\t\tread(x);\n\t\t\tl = max(l, ld[x]);\n\t\t\tr = min(r, rd[x]);\n\t\t\tif (l > r) continue;\n\t\t\tg[l].push_back((point){1, c1 + m, x, 0});\n\t\t\tg[r + 1].push_back((point){-1, c1 + m, c1 + m - 1, 0});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tread(x);\n\t\t\tg[l].push_back((point){2, r, x, ++q});\n\t\t}\n\t}\n\tpoint u;\n\tfor (i = 1; i <= n; i++)\n\t{\n\t\tfor (auto u : g[i])\n\t\tif (u.opt == -1 || u.opt == 1) \n\t\t{\n\t\t\tcut(u.x);\n\t\t\tlink(u.x, u.y);\n\t\t}\n\t\tfor (auto u : g[i])\n\t\tif (u.opt == 2) ans[u.id] = query(u.x) + query(u.y) - 2 * query(lca(u.x, u.y));\t\n\t}\n\tfor (i = 1; i <= q; i++)\n\t{\n\t\tprint(ans[i]);\n\t\tputchar('\\n');\n\t}\n\treturn 0;\n}\n```\n",
        "postTime": 1566745026,
        "uid": 15268,
        "name": "\u82b1\u6dc7\u6dcb",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3348 \u3010[ZJOI2016]\u5927\u68ee\u6797\u3011"
    },
    {
        "content": "[P3348 [ZJOI2016]\u5927\u68ee\u6797](https://www.luogu.com.cn/problem/P3348) \n\n\u66b4\u529b\uff1a\u5efa $n$ \u68f5 LCT \u7136\u540e\u6309\u9898\u610f\u6a21\u62df\uff0c\u590d\u6742\u5ea6 $O(n^2\\log n)$ \u3002\u63a5\u4e0b\u6765\u6211\u4eec\u8003\u8651\u5982\u4f55\u4f18\u5316\u3002\n\n* **\u5bf9\u4e8e\u8be2\u95ee\u64cd\u4f5c** \n\n\u53d1\u73b0\u9898\u76ee\u6027\u8d28\uff1a**0\uff0c1\u64cd\u4f5c\u5e76\u4e0d\u4f1a\u5f71\u54cd 2 \u64cd\u4f5c\u7684\u7b54\u6848\uff0c\u53ef\u4ee5\u6700\u540e\u518d\u5904\u7406 2 \u64cd\u4f5c**\u3002\n\n\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u628a\u64cd\u4f5c**\u79bb\u7ebf**\u4e0b\u6765\uff0c\u4ece 1 \u5230 $n$ \u679a\u4e3e\u6bcf\u68f5\u6811\uff0c\u6bcf\u6b21\u53ea\u8003\u8651\u76f8\u90bb\u4e24\u68f5\u6811\u4e4b\u95f4\u7684\u5dee\u5f02\uff0c\u7136\u540e\u4fee\u6539\u5e76\u8fdb\u884c\u8be2\u95ee\u3002 \u8be2\u95ee\u65f6\u53ef\u4ee5\u7528 $access$ \u64cd\u4f5c\u6c42\u51fa lca\u3002\n\n* **\u5bf9\u4e8e\u52a0\u70b9\u64cd\u4f5c**\n\n\u53d1\u73b0\u9898\u76ee\u6027\u8d28\uff1a\u628a\u5bf9 $[l,r]$ \u589e\u52a0\u8282\u70b9\u6539\u6210\u5bf9 $[1,n]$ \u589e\u52a0\u8282\u70b9\uff0c\u5176\u5b9e\u5bf9\u7b54\u6848\u4e0d\u4f1a\u6709\u4efb\u4f55\u5f71\u54cd \u3002\u56e0\u4e3a\u6211\u4eec\u4e0d\u53ef\u80fd\u5bf9\u4e0d\u5b58\u5728\u7684\u70b9\u8fdb\u884c\u4efb\u4f55\u64cd\u4f5c\u3002 \n\n\u4f46\u4fee\u6539\u751f\u957f\u8282\u70b9\u65f6\u4e00\u5b9a\u4e0d\u80fd\u4fee\u6539\u6ca1\u6709\u8fd9\u4e2a\u70b9\u7684\u6811 \uff0c\u90a3\u4e48\u6211\u4eec\u53ea\u9700\u8981\u8bb0\u4e00\u4e0b\u6bcf\u4e2a\u5b9e\u70b9\u51fa\u73b0\u7684\u533a\u95f4\uff0c\u4fee\u6539\u65f6\u5c06\u4fee\u6539\u5de6\u8fb9\u754c\u4e0e\u5b9e\u9645\u5b58\u5728\u7684\u5de6\u8fb9\u754c\u53d6max\uff0c\u4fee\u6539\u53f3\u8fb9\u754c\u4e0e\u5b9e\u9645\u5b58\u5728\u7684\u53f3\u8fb9\u754c\u53d6min\u5373\u53ef\u3002 \n\n* **\u5bf9\u4e8e\u6362\u6839\u64cd\u4f5c\uff08\u672c\u9898\u6838\u5fc3\uff09**\n\n\u53d1\u73b0\u9898\u76ee\u6027\u8d28\uff1a**0 \u64cd\u4f5c\u751f\u957f\u51fa\u7684\u8282\u70b9\u7684\u7236\u4eb2\u5c31\u662f\u4e0a\u4e00\u6b21 1 \u64cd\u4f5c\u94a6\u5b9a\u7684\u751f\u957f\u8282\u70b9\u3002**\n\n\u5ef6\u7eed\u4e0a\u9762\u8bf4\u7684\u5dee\u5206\u601d\u60f3\uff0c\u5047\u8bbe\u6709\u4e00\u4e2a 1 \u64cd\u4f5c\u5f62\u5982 $(l,r,x)$\uff0c\u4e14\u4e4b\u540e\u4e0d\u518d\u6709 1 \u64cd\u4f5c\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u8ba4\u4e3a\uff0c\u7b2c $l$ \u68f5\u6811\u662f\u7b2c $l-1$ \u68f5\u6811\u628a\u5f53\u524d 1 \u64cd\u4f5c\u4ee5\u540e\u5ac1\u63a5\u5728\u539f\u6765\u751f\u957f\u8282\u70b9\u4e0a\u7684\u6240\u6709\u8282\u70b9\uff08\u4ee5\u53ca\u6240\u6709\u5b50\u6811\uff09\u5168\u90e8\u8f6c\u800c\u5ac1\u63a5\u5230 $x$ \u4e0a\uff1b\u540c\u7406\uff0c\u7b2c $r+1$ \u68f5\u6811\u662f\u628a\u8fd9\u4e9b\u8282\u70b9\u53c8\u5ac1\u63a5\u56de\u6765\u4e86\u3002\n\n\u6309\u8fd9\u4e2a\u601d\u8def\uff0c\u6211\u4eec\u53ef\u4ee5\u628a $n$ \u68f5\u6811\u538b\u6210 1 \u68f5\u6811\uff0c\u7136\u540e\u4e0d\u65ad\u5ac1\u63a5\u5b50\u6811\u3002LCT \u4e0d\u652f\u6301\u5ac1\u63a5\u5b50\u6811\uff0c\u4e8e\u662f\u6211\u4eec\u8003\u8651\u5efa\u865a\u70b9\u3002\u5bf9\u6bcf\u4e2a 1 \u64cd\u4f5c\u5efa\u4e00\u4e2a\u70b9\u6743\u4e3a 0 \u7684\u865a\u70b9\uff0c\u5bf9\u6bcf\u4e2a 0 \u64cd\u4f5c\u5efa\u4e00\u4e2a\u70b9\u6743\u4e3a 1 \u7684\u5b9e\u70b9\uff0c\u521d\u59cb\u65f6\u5b9e\u70b9\u548c\u865a\u70b9\u90fd\u8fde\u5411\u4e0a\u4e00\u4e2a\u5efa\u597d\u7684\u865a\u70b9\u4e0a\uff0c\u8fd9\u6837\u6bcf\u6b21\u6574\u4f53\u5ac1\u63a5\u7684\u65f6\u5019\uff0c\u76f4\u63a5\u65ad\u6389\u8fd9\u4e2a\u865a\u70b9\u4e0e\u5b83\u7236\u4eb2\u4e4b\u95f4\u7684\u8fb9\uff0c\u518d\u8fde\u5411\u65b0\u7236\u4eb2\u5c31\u53ef\u4ee5\u4e86\u3002\n\n\u5177\u4f53\u5730\uff0c\u628a\u6362\u6839\u64cd\u4f5c\u8fdb\u884c\u5dee\u5206\uff0c\u5728 $l$ \u65f6\u5c06\u865a\u70b9\u7684\u7236\u4eb2\u6539\u4e3a\u8fd9\u4e2a\u865a\u70b9\u5bf9\u5e94\u7684\u5b9e\u70b9\uff0c \u5728 $r+1$ \u65f6\u518d\u6539\u56de\u6765\u3002\u8fd8\u6709\u4e00\u4e9b\u7ec6\u8282\uff0c\u5177\u4f53\u53ef\u4ee5\u770b\u4ee3\u7801\u4e2d\u7684\u6ce8\u91ca\u3002\n\n```cpp\n#include<bits/stdc++.h>\n#define ls c[x][0]\n#define rs c[x][1]\nusing namespace std;\nnamespace FGF\n{\n\tint n,m,Q;\n\tconst int N=3e5+5;\n\tstruct ques{\n\t\tint pos,tim,x,y;\n\t}q[N<<1];\n\tbool operator <(ques u,ques v)\n\t{\n\t\treturn u.pos^v.pos? u.pos<v.pos:u.tim<v.tim;\n\t}\n\tint L[N],R[N],rl[N],num,cnt,tot,ans[N],lst;\n\tstruct LCT{//\u672c\u9898\u662f\u6709\u6839\u6811\uff0c\u8981\u7528\u4e0d\u6362\u6839\u7684LCT \n\t\tint fa[N],c[N][2],s[N],a[N];\n\t\tvoid pushup(int x){s[x]=s[ls]+s[rs]+a[x];}\n\t\tbool isrt(int x){return c[fa[x]][0]!=x&&c[fa[x]][1]!=x;}\n\t\tvoid rotat(int x)\n\t\t{\n\t\t\tint y=fa[x],z=fa[y],k=(c[y][1]==x);\n\t\t\tif(!isrt(y))c[z][c[z][1]==y]=x;\n\t\t\tfa[x]=z,fa[y]=x,fa[c[x][k^1]]=y;\n\t\t\tc[y][k]=c[x][k^1],c[x][k^1]=y;\n\t\t\tpushup(y),pushup(x);\n\t\t}\n\t\tvoid splay(int x)\n\t\t{\n\t\t\twhile(!isrt(x))\n\t\t\t{\n\t\t\t\tif(!isrt(fa[x]))rotat((c[fa[x]][0]==x)^(c[fa[fa[x]]][0]==fa[x])? x:fa[x]);\n\t\t\t\trotat(x);\n\t\t\t}\n\t\t\tpushup(x);\n\t\t}\n\t\tint access(int x){int y=0;while(x)splay(x),rs=y,pushup(x),y=x,x=fa[x];return y;}\n\t\tvoid link(int x,int y){splay(x);fa[x]=y;}\n\t\tvoid cut(int x){access(x),splay(x),ls=fa[ls]=0,pushup(x);}\n\t}T;\n\tvoid work()\n\t{\n\t\tscanf(\"%d%d\",&n,&m);\n\t\tnum=cnt=lst=T.a[1]=T.s[1]=L[1]=rl[1]=1;R[1]=n;\n\t\tfor(int i=1;i<=m;i++)\n\t\t{\n\t\t\tint op,l,r,x;\n\t\t\tscanf(\"%d%d%d\",&op,&l,&r);\n\t\t\tif(op==0)\n\t\t\t{\n\t\t\t\trl[++num]=++cnt;//rl\u8bb0\u5f55num\u8fd9\u4e2a\u865a\u70b9\u662f\u6211\u4eec\u5efa\u7684\u54ea\u4e2a\u70b9 \n\t\t\t\tT.link(cnt,lst);//\u7b2c\u4e00\u6b211\u64cd\u4f5c\u4e4b\u524d\u76840\u64cd\u4f5c\u53ef\u4ee5\u76f4\u63a5\u628a\u5b9e\u70b9\u8fde\u57281\u4e0a\uff0c\u56e0\u4e3a\u4e4b\u540e\u4e0d\u4f1a\u79fb\u52a8\u8fd9\u4e9b\u70b9 \n\t\t\t\tT.a[cnt]=T.s[cnt]=1;//\u5b9e\u70b9\u70b9\u6743\u4e3a1 \n\t\t\t\tL[num]=l,R[num]=r;//\u8bb0\u5f55\u8fd9\u4e2a\u865a\u70b9\u5b58\u5728\u7684\u533a\u95f4 \n\t\t\t}\n\t\t\tif(op==1)\n\t\t\t{\n\t\t\t\tscanf(\"%d\",&x);\n\t\t\t\tl=max(l,L[x]),r=min(r,R[x]);\n\t\t\t\tif(l>r)continue;\n\t\t\t\tT.link(++cnt,lst);\n\t\t\t\tq[++Q].pos=l,q[Q].tim=0,q[Q].x=cnt,q[Q].y=rl[x];//tim\u4e3a0\u4fdd\u8bc1\u64cd\u4f5c\u5728\u8be2\u95ee\u4e4b\u524d\u8fdb\u884c \n\t\t\t\tq[++Q].pos=r+1,q[Q].tim=0,q[Q].x=cnt,q[Q].y=lst;\n\t\t\t\tlst=cnt;\n\t\t\t}\n\t\t\tif(op==2)\n\t\t\t{\n\t\t\t\tscanf(\"%d\",&x);\n\t\t\t\tq[++Q].pos=l,q[Q].tim=++tot,q[Q].x=rl[r],q[Q].y=rl[x];\n\t\t\t}\t\t\n\t\t}\n\t\tsort(q+1,q+Q+1);\n\t\tfor(int i=1;i<=Q;i++)\n\t\t{\n\t\t\tif(!q[i].tim)T.cut(q[i].x),T.link(q[i].x,q[i].y);\n\t\t\telse\n\t\t\t{\n\t\t\t\tT.access(q[i].x),T.splay(q[i].x);ans[q[i].tim]+=T.s[q[i].x];\n\t\t\t\tint lca=T.access(q[i].y);T.splay(q[i].y);ans[q[i].tim]+=T.s[q[i].y];\n\t\t\t\tT.access(lca),ans[q[i].tim]-=2*T.s[lca];\n\t\t\t}\n\t\t}\n\t\tfor(int i=1;i<=tot;i++)\n\t\t\tprintf(\"%d\\n\",ans[i]);\n\t}\n}\nint main()\n{\n\tFGF::work();\n\treturn 0;\n}\n```",
        "postTime": 1607584772,
        "uid": 224403,
        "name": "\u6728xx\u6728\u5927",
        "ccfLevel": 9,
        "title": "P3348 [ZJOI2016]\u5927\u68ee\u6797\uff08\u865a\u70b9+\u5dee\u5206+LCT\uff09"
    }
]