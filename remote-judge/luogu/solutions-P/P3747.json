[
    {
        "content": "## Solution\n\n+ \u8fd9\u771f\u662f\u4e00\u9053\u6d6a\u8d39\u65f6\u95f4\u6d6a\u8d39\u751f\u547d\u7684\u597d\u9898\u554a\uff01\u6211\u4ece11\u67088\u53f7\u8e0f\u4e0a\u53bb\u79e6\u7687\u5c9b\u7684\u5f81\u9014\u65f6\uff0c\u5728\u706b\u8f66\u4e0a\u548cSGCollin\u4e00\u8d77\u641e\u8fd9\u9053\u9898\uff0c\u76f4\u5230\u73b0\u5728\u624d\u628a\u8fd9\u9898\u641e\u6389\u3002\u679c\u7136\u8fd8\u662f\u81ea\u5df1\u592a\u83dc\u4e86\u3002\n\n+ \u5982\u679c\u6ca1\u6709\u505a\u8fc7[P4139 \u4e0a\u5e1d\u4e0e\u96c6\u5408\u7684\u6b63\u786e\u7528\u6cd5](https://www.luogu.org/problemnew/show/P4139)\u5efa\u8bae\u5148\u53bb\u505a\u4e00\u505a\uff0c\u522b\u770b\u8fd9\u662f\u4e2a\u7d2b\u724c\u9898\uff0c\u5176\u5b9e\u6838\u5fc3\u4ee3\u7801\u8d85\u7ea7\u77ed\u3002\u5177\u4f53\u6765\u8bb2\uff0c\u4f60\u53ea\u9700\u8981\u4e00\u4e2a\u7ebf\u6027\u7b5b\u6cd5\uff0c\u4e00\u4e2a\u5feb\u901f\u5e42\uff0c\u4e00\u4e2adfs\u8dd1\u6269\u5c55\u6b27\u62c9\u5b9a\u7406\u5c31\u505a\u5b8c\u4e86\u3002\n\n+ \u6269\u5c55\u6b27\u62c9\u5b9a\u7406\u4e0d\u5fc5\u591a\u8bf4\uff0c\u6ce8\u610f\u597d\u5b83\u7684\u5206\u7c7b\u8ba8\u8bba\u60c5\u51b5\uff0c\u5373\u6307\u6570\u662f\u5426\u6bd4$\\varphi(p)$\u5927\uff0c\u82e5\u6307\u6570\u6bd4$\\varphi(p)$\u5c0f\u5219\u65e0\u6cd5\u8fdb\u5165\u6307\u6570\u5faa\u73af\u8282\uff0c\u4e0d\u80fd\u7528$ a^k \\equiv a^{k \\% \\varphi(p)+\\varphi(p) } \\ (mod \\ p) $\uff0c\u4f46\u662f\u5728\u90a3\u4e2a\u7d2b\u724c\u9898\u4e2d\uff0c\u663e\u7136$ 2^{2^{2^{......}} } $\u662f\u6bd4$\\varphi(p)$\u8981\u5927\u7684\u591a\u7684\uff0c\u6240\u4ee5\u5b9a\u7406\u6700\u540e\u4e00\u6761\u53ef\u4ee5\u76f4\u63a5\u7528\u3002\n\n+ \u5f88\u663e\u7136\u6bcf\u4e00\u6b21\u7684\u6a21\u6570\u90fd\u4f1a\u53d8\u4e3a\u5b83\u81ea\u5df1\u7684\u6b27\u62c9\u51fd\u6570\uff0c\u800c\u8fd9\u4e2a\u8fc7\u7a0b\u7684\u6b21\u6570\u4e0d\u4f1a\u8d85\u8fc7\u5bf9\u6570\u7ea7\u522b\u3002\u6709\u4e00\u4e2a\u7b80\u5355\u7684\u8bc1\u660e\uff0c\u6839\u636e\u6b27\u62c9\u51fd\u6570\u7684\u516c\u5f0f\uff0c\u53ef\u4ee5\u770b\u5230\u4e00\u4e2a\u5076\u6570\u5728\u6c42\u6b27\u62c9\u51fd\u6570\u65f6\uff0c\u4e00\u5b9a\u4f1a\u628a\u4e00\u4e2a\u7d20\u56e0\u5b502\u63d0\u51fa\u6765\u53d8\u62101\uff0c\u4e5f\u5c31\u662f\u81f3\u5c11\u9664\u4ee52\uff0c\u800c\u4e00\u4e2a\u5947\u6570\u4e00\u5b9a\u4f1a\u628a\u81ea\u5df1\u7684\u4e00\u4e2a\u5947\u8d28\u56e0\u5b50\u63d0\u51fa\u6765\u51cf1\uff0c\u53d8\u6210\u4e00\u4e2a\u5076\u6570\uff0c\u63a5\u4e0b\u6765\u5c31\u662f\u91cd\u590d\u4ee5\u4e0a\u8fc7\u7a0b\uff0c\u76f4\u5230\u6a21\u6570\u53d8\u62101\u4e3a\u6b62\u3002\u8fd9\u65f6\u4efb\u610f\u5b9e\u6570\u6a211\u90fd\u662f0\uff0c\u76f4\u63a5\u8fd4\u56de\u5c31\u597d\u3002\u6545P4139\u7684\u6838\u5fc3\u4ee3\u7801\u5982\u4e0b\uff1a\n\n```\ninline int dfs(int mod){\n    if(mod==1) return 0;\n    return quick_pow(2,dfs(phi[mod])+phi[mod],mod);\n}\n```\n\n+ \u6211\u4eec\u770b\u8fd9\u9053\u9898\uff0c$c^{c^{c^{......}}} mod \\ p$\u53ef\u4ee5\u8f6c\u5316\u4e3a$c^{c^{c^{......}} \\ mod \\ \\varphi(p)+\\varphi(p)} mod \\ p $\uff0c\u7136\u540e\u518d\u8ba1\u7b97$ c^{c^{c^{......}}} \\ mod \\ \\varphi(p) $\uff0c\u8fd9\u53c8\u53ef\u4ee5\u8f6c\u5316\u4e3a$ c^{c^{c^{......}} \\ mod \\ \\varphi(\\varphi(p))+\\varphi(\\varphi(p))} mod \\ \\varphi(p) $\uff0c\u5982\u6b64\u53cd\u590d\u5d4c\u5957\uff0c\u6839\u636e\u4e0a\u9762\u63d0\u5230\u7684\u4e1c\u897f\uff0c\u5b83\u81f3\u591a\u8fdb\u884c\u5bf9\u6570\u7ea7\u522b\u5c42\uff0c\u4e5f\u5c31\u662f\u8bf4\u53ea\u6709\u8fd9\u51e0\u5c42\u4f1a\u5bf9\u7b54\u6848\u4ea7\u751f\u5f71\u54cd\u3002\n\n+ \u8fd8\u6709\u4e00\u9053\u9898\uff0c[P4145 \u4e0a\u5e1d\u9020\u9898\u7684\u4e03\u5206\u949f2 / \u82b1\u795e\u6e38\u5386\u5404\u56fd](https://www.luogu.org/problemnew/show/P4145)\u3002\u4e3a\u4ec0\u4e48\u8981\u63d0\u8fd9\u9053\u9898\u5462\uff1f\u6ce8\u610f\u5230\u9898\u76ee\u4e2d\u7684\u64cd\u4f5c\u4e0d\u5177\u6709\u533a\u95f4\u6027\u8d28\uff0c\u4f46\u662f$ c^{c^{c^{......}}} mod \\ p $\u7684\u503c\uff0c\u5728\u6307\u6570\u7684\u5c42\u6570\u8fbe\u5230\u4e00\u5b9a\u503c\u4ee5\u540e\u5c31\u4e0d\u518d\u53d8\u5316\uff0c\u5c31\u53d8\u6210\u4e86\u4e0a\u9762\u63d0\u5230\u7684\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u5e76\u4e14\u5bf9\u6570\u5f88\u5c0f\uff0c\u53ef\u4ee5\u8003\u8651\u7ef4\u62a4\u5176\u5355\u70b9\u4fee\u6539\u6b21\u6570\uff0c\u4fee\u6539\u65f6\u76f4\u63a5\u66b4\u529b\uff0c\u8fbe\u5230\u4e34\u754c\u6761\u4ef6\u540e\u5c31\u4e0d\u518d\u66f4\u6539\u3002\u4e0e\u8fd9\u9053\u84dd\u724c\u9898\u7684\u601d\u8def\u5c31\u5f88\u76f8\u4f3c\u3002\n\n+ \u56de\u5230\u8fd9\u9053\u9898\uff0c\u4e0a\u9762\u7684\u4e1c\u897f\u7efc\u5408\u8d77\u6765\u5c31\u662f\u8fd9\u9898\u7684\u6b63\u89e3\u7b97\u6cd5\u3002\u8003\u8651\u7ebf\u6bb5\u6811\uff0c\u7ef4\u62a4\u4e00\u4e2a\u533a\u95f4\u7684\u6700\u5c0f\u4fee\u6539\u6b21\u6570\u3002\u7531\u4e8e\u6211\u4eec\u8981\u7528\u5230\u7684\u6b27\u62c9\u51fd\u6570\u7684\u6570\u76ee\u5f88\u5c11\uff0c\u53ef\u4ee5\u76f4\u63a5\u66b4\u529b\u7b97\u51fa\u6765\uff0c\u4fee\u6539\u65f6\u7684$power \\ tower$\u76f4\u63a5\u66b4\u7b97\u5230\u5e95\uff0c\u5feb\u901f\u5e42\u65f6\u52a0\u4e0a\u4e00\u70b9\u7279\u5224\uff0c\u5c31\u53ef\u4ee5\u5224\u65ad\u6269\u5c55\u6b27\u62c9\u5b9a\u7406\u8fd0\u7528\u7684\u4e24\u4e2a\u6761\u4ef6\uff0c\u4e5f\u5c31\u662f\uff1a\n\n```\ntypedef long long LL;\n\ninline LL qpow(LL t,LL mod){\n    LL val=1,a=c;\n    flag=0;\n    while(t){\n        if(t&1) val=val*a;\n        a=a*a;\n        t>>=1;\n        if(val>=mod) val%=mod,flag=1;\n        if(a>=mod) a%=mod;\n    }\n    return val;\n}\n```\n\n+ \u7136\u540e\u5355\u6b21\u4fee\u6539\u7684\u590d\u6742\u5ea6\u5c31\u662f \u5e8f\u5217\u64cd\u4f5c$\\times$\u9012\u5f52\u5c42\u6570$\\times$\u5feb\u901f\u5e42\uff0c\u8fbe\u5230\u4e86\u4e09\u4e2a$\\log$\uff0c\u590d\u6742\u5ea6\u6bd4\u8f83\u9ad8\uff0c\u5e38\u6570\u5927\u7684\u4f1a\u88ab\u7b2c9\u300111\u4e24\u4e2a\u70b9\u5361T\uff08\u6211\u5438\u4e86\u6c27\u628a\u7b2c9\u4e2a\u70b9\u8fc7\u4e86\uff0c\u6069\uff09\u3002\n\n+ \u7136\u540e\u5c31\u662f\u6700\u7ec8\u7684\u4f18\u5316\u3002\u6839\u636e\u7f51\u4e0a\u8bf4\u6cd5\uff0c\u6b27\u62c9\u51fd\u6570\u5f88\u5c11\uff0c\u610f\u5473\u7740\u6a21\u6570\u5f88\u5c11\uff0c\u8003\u8651\u5c06\u5feb\u901f\u5e42\u9884\u5904\u7406\uff0c\u5206\u4e3a$c^{i}\\ (mod \\ p)$ \u4e0e $c^{10000 \\times i} \\ (mod \\ p)$\uff0c\u67e5\u8be2\u65f6\u76f4\u63a5\u5c06\u4e24\u5757\u8fdb\u884c\u62fc\u63a5\uff0c\u4e0a\u9762\u7684\u7279\u5224\u7528\u4e00\u4e2abool\u6570\u7ec4\u5b58\u4e0b\u6765\uff0c\u5c31\u53ef\u4ee5\u5c11\u6389\u4e00\u4e2a$\\log$\u4e86\u3002\u7136\u540e\u52a0\u8bfb\u4f18\u3001inline\uff0c\u518d\u5199\u7684\u7f8e\u89c2\u4e00\u4e9b\uff0c\u5c31\u8db3\u4ee5\u901a\u8fc7\u6b64\u9898\u3002\n\n## Code\n```\n#include<cmath>\n#include<cctype>\n#include<cstdio>\n#include<cstdlib>\n#include<cstring>\n#include<iostream>\n#include<algorithm>\n\n#define M 55\n#define maxn 100005\n\nusing namespace std;\n\ntypedef unsigned long long LL;\n\ntemplate<typename T> inline void read(T &x){\n    x=0; char c=getchar();\n    while(!isdigit(c)) c=getchar();\n    while(isdigit(c)) x=(x<<1)+(x<<3)+(c^48),c=getchar();\n}\n\nint n,m,mint,ls[maxn],rs[maxn],ti[maxn],cnt;\n\nLL p,c,pow1[maxn][M],pow2[maxn][M],v[maxn],val[maxn],phi[M];\n\nbool flag,b1[maxn][M],b2[maxn][M];\n\ninline LL calc_phi(LL vi){\n    LL ret=vi,tmp=vi,lim=sqrt(vi);\n    for(LL i=2;i<=lim;++i){\n        if(!(tmp%i)){\n            ret=ret*(i-1)/i;\n            while(!(tmp%i)) tmp/=i;\n        }\n    }\n    if(tmp>1) ret=ret*(tmp-1)/tmp;\n    return ret;\n}\n\ninline void pre_work(){\n    LL tmp=p; phi[0]=p;\n    while(tmp!=1) tmp=calc_phi(tmp),phi[++mint]=tmp;\n    phi[++mint]=1;\n    for(int i=0;i<=mint;++i){\n        pow1[0][i]=1;\n        for(int j=1;j<=10000;++j){\n            pow1[j][i]=pow1[j-1][i]*c;\n            if(pow1[j][i]>=phi[i]) pow1[j][i]%=phi[i],b1[j][i]=1;\n            b1[j][i]|=b1[j-1][i];\n        }\n    }\n    for(int i=0;i<=mint;++i){\n        pow2[0][i]=1;\n        b2[1][i]=b1[10000][i];\n        for(int j=1;j<=10000;++j){\n            pow2[j][i]=pow2[j-1][i]*pow1[10000][i];\n            if(pow2[j][i]>=phi[i]) pow2[j][i]%=phi[i],b2[j][i]=1;\n            b2[j][i]|=b2[j-1][i];\n        }\n    }\n}\n\ninline LL calc(LL v,LL id){\n    flag=0;\n    LL v1=v%10000,v2=v/10000,ret=pow1[v1][id]*pow2[v2][id];\n    if(ret>=phi[id]) ret=ret%phi[id],flag=1;\n    flag|=b1[v1][id]|b2[v2][id];\n    return ret;\n}\n\ninline LL dfs(LL vi,int deep,int lim){\n    flag=0;\n    if(deep==lim){\n        if(vi>=phi[deep]) flag=1,vi%=phi[deep];\n        return vi;\n    }\n    LL ci=dfs(vi,deep+1,lim);\n    return calc(flag?ci+phi[deep+1]:ci,deep);\n}\n\ninline void build(int L,int R,int cur){\n    if(L==R){ read(v[cur]); val[cur]=v[cur]; return ; }\n    int mid=(L+R)>>1;\n    ls[cur]=++cnt; build(L,mid,ls[cur]);\n    rs[cur]=++cnt; build(mid+1,R,rs[cur]);\n    val[cur]=val[ls[cur]]+val[rs[cur]];\n    if(val[cur]>=p) val[cur]-=p;\n}\n\ninline void update(int L,int R,int l,int r,int cur){\n    if(ti[cur]>=mint) return ;\n    if(L==R){\n        ++ti[cur]; val[cur]=dfs(v[cur],0,ti[cur]);\n        return ;\n    }\n    int mid=(L+R)>>1;\n    if((l<=mid)&&(ti[ls[cur]]<mint)) update(L,mid,l,r,ls[cur]);\n    if((r>mid)&&(ti[rs[cur]]<mint)) update(mid+1,R,l,r,rs[cur]);\n    val[cur]=val[ls[cur]]+val[rs[cur]];\n    if(val[cur]>=p) val[cur]-=p;\n    ti[cur]=min(ti[ls[cur]],ti[rs[cur]]);\n}\n\ninline LL query(int L,int R,int l,int r,int cur){\n    if((l<=L)&&(R<=r)) return val[cur];\n    int mid=(L+R)>>1; LL ret=0;\n    if(l<=mid) ret=query(L,mid,l,r,ls[cur]);\n    if(r>mid) ret+=query(mid+1,R,l,r,rs[cur]);\n    return (ret>=p)?(ret-p):ret;\n}\n\nint main(){\n    ios::sync_with_stdio(false);\n    cin.tie(0); cout.tie(0);\n    read(n); read(m); read(p); read(c);\n    build(1,n,++cnt); pre_work();\n    while(m--){\n        int opt,l,r;\n        read(opt); read(l); read(r);\n        if(opt==0) update(1,n,l,r,1);\n        else if(opt==1) cout<<query(1,n,l,r,1)<<endl;\n    }\n    return 0;\n}\n```",
        "postTime": 1542461846,
        "uid": 83253,
        "name": "Luan_233",
        "ccfLevel": 0,
        "title": "P3747 [\u516d\u7701\u8054\u80032017]\u76f8\u9022\u662f\u95ee\u5019 \u9898\u89e3byLuan"
    },
    {
        "content": "\u5b89\u5229$:$ [\u6742\u9898\u9009\u505a](https://www.luogu.com.cn/blog/s-r-f/liu-yue-qi-yue-za-ti-xuan-zuo)\n\n[P3747 [\u516d\u7701\u8054\u80032017]\u76f8\u9022\u662f\u95ee\u5019](https://www.luogu.com.cn/problem/P3747)\n\n\u9996\u5148\u53ef\u4ee5\u60f3\u5230\u901a\u8fc7\u6b27\u62c9\u5b9a\u7406\u8ba1\u7b97$.$\n\n\u4e0d\u96be\u53d1\u73b0\u53ea\u6709\u524d$log$\u6b21\u4fee\u6539\u662f\u6709\u7528\u7684$,$\u90a3\u4e48\u76f4\u63a5\u7ef4\u62a4\u5c31\u53ef\u4ee5\u4e86$.$\n\n\u6ce8\u610f\u4e0d\u8981\u6bcf\u6b21\u8ba1\u7b97\u7684\u65f6\u5019\u76f4\u63a5\u8c03\u7528\u5feb\u901f\u5e42$,$\u8fd9\u6837\u4f1a\u591a\u4e00\u4e2a$\\log.$\n\n\u6b63\u786e\u7684\u59ff\u52bf\u662f\u5bf9\u4e8e\u6bcf\u4e2a$mod$ $O(\\sqrt{2\\times mod})$\u9884\u5904\u7406\u4e00\u4e0b$c^x$\u548c$c^{mx}$ $,$\u7136\u540e\u5c31\u53ef\u4ee5\u505a\u5230$O(1)$\u8ba1\u7b97\u4e00\u4e2a$c^x.$\n\n\u5b9e\u73b0\u7684\u597d\u53ef\u4ee5\u505a\u5230$O(nlog^2max(p,n))$\n\n\u4ee3\u7801$:$\n\n```cpp\n#include <bits/stdc++.h>\n#define LL long long\nusing namespace std;\nconst int N = 50005,D = 60;\ninline int calcphi(int n){\n\tstatic int t,i,ans; t = n,ans = n;\n\tfor (i = 2; i * i <= n; ++i) if (t % i == 0){\n\t\twhile (!(t%i)) t /= i;\n\t\tans = ans / i * (i-1);\n\t}\n\tif (t > 1) ans = ans / t * (t-1);\n\treturn ans;\n}\nint P;\nint c;\nint p[D],cntp,c1[D][1<<15],c2[D][1<<15];\ninline int Mo(LL n,int p){ return n >= p ? (n % p + p) : n; }\ninline void init_c(){\n\tint i,j;\n\tfor (i = 0; i <= cntp; ++i){\n\t\tc1[i][0] = c2[i][0] = 1;\n\t\tfor (j = 1; j < 1<<15; ++j) c1[i][j] = Mo((LL)c1[i][j-1] * c,p[i]);\n\t\tc2[i][1] = Mo((LL)c1[i][(1<<15)-1] * c,p[i]);\n\t\tfor (j = 2; j < 1<<15; ++j) c2[i][j] = Mo((LL)c2[i][j-1] * c2[i][1],p[i]);\n\t}\n}\ninline int power(int n,int i){ return Mo((LL)c1[i][n&32767]*c2[i][n>>15],p[i]); }\nint n,m,a[N][D];\ninline int calc(int x,int cnt,int i){\n\tif (!cnt) return Mo(x,p[i]); if (i == cntp) return c ? 1 : 0;\n\treturn power(calc(x,cnt-1,i+1),i);\n}\nint sum[N<<2],mn[N<<2];\ninline void up(int o){\n\tmn[o] = min(mn[o<<1],mn[o<<1|1]);\n\tsum[o] = sum[o<<1] + sum[o<<1|1];\n\tif (sum[o] >= P) sum[o] -= P; \n}\ninline void Build(int o,int l,int r){\n\tmn[o] = 0; if (l == r){ sum[o] = a[l][0]; return; }\n\tint mid = l+r>>1; Build(o<<1,l,mid); Build(o<<1|1,mid+1,r); up(o);\n}\nint ll,rr;\ninline void Add(int o,int l,int r){\n\tif (mn[o] > cntp) return;\n\tif (l == r){ ++mn[o],sum[o] = a[l][mn[o]]; return; } \n\tif (ll <= l && rr >= r){ int mid = l+r>>1; Add(o<<1,l,mid); Add(o<<1|1,mid+1,r); up(o); return; }\n\tint mid = l+r>>1; if (ll <= mid) Add(o<<1,l,mid); if (rr > mid) Add(o<<1|1,mid+1,r); up(o);\n}\nint qans;\ninline void Ask(int o,int l,int r){\n\tif (ll <= l && rr >= r){ qans = (qans + sum[o] >= P) ? (qans + sum[o] - P) : (qans + sum[o]); return; }\n\tint mid = l+r>>1; if (ll <= mid) Ask(o<<1,l,mid); if (rr > mid) Ask(o<<1|1,mid+1,r);\n}\nint main(){\n\tint i,j,op;\n\tcin >> n >> m >> P >> c;\n\tp[cntp = 0] = P; while (p[cntp] > 1) ++cntp,p[cntp] = calcphi(p[cntp-1]);\n\tinit_c();\n\tfor (i = 1; i <= n; ++i){\n\t\tcin >> a[i][0];\n\t\tfor (j = 1; j <= cntp+1; ++j) a[i][j] = calc(a[i][0],j,0) % P;\n\t\ta[i][0] %= P;\n\t}\n\tBuild(1,1,n);\n\twhile (m--){\n\t\tcin >> op >> ll >> rr;\n\t\tif (op == 0) Add(1,1,n);\n\t\telse qans = 0,Ask(1,1,n),cout << qans << '\\n';\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1594120028,
        "uid": 52518,
        "name": "s_r_f",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P3747 \u3010[\u516d\u7701\u8054\u80032017]\u76f8\u9022\u662f\u95ee\u5019\u3011"
    },
    {
        "content": "Latex\u6302\u4e86\u53ef\u4ee5\u53bb\u6d1b\u8c37blog\u6216\u8005\u4e0b\u9762\u7684\u94fe\u63a5\u67e5\u770b\n\n[\u66f4\u597d\u7684\u9605\u8bfb\u4f53\u9a8c](https://juju527.github.io/post/ti-jie-p3747-liu-sheng-lian-kao-2017xiang-feng-shi-wen-hou/)\n\n## \u7ebf\u6bb5\u6811+\u6269\u5c55\u6b27\u62c9\u5b9a\u7406+\u9884\u5904\u7406\n\n\u8bb0\u5f55\u4e00\u4e0b\u521a\u4e86\u6211\u4e00\u665a\u4e0a\u7684\u6bd2\u7624\u9898\n\n### \u524d\u7f6e\u77e5\u8bc6\n\u7ebf\u6bb5\u6811(~~\u60a8\u90fd\u6765\u505a\u9ed1\u9898\u4e86\u8fd8\u4e0d\u4f1a\u7ebf\u6bb5\u6811\u662f\u4e0d\u662f\u6709\u70b9\u8fc7\u5206~~)\n\n\u6269\u5c55\u6b27\u62c9\u5b9a\u7406\n\n---\n### \u6269\u5c55\u6b27\u62c9\u5b9a\u7406\n\n\u8fd9\u91cc\u4e22\u4e2a\u5f0f\u5b50\n\n$$a^b\\equiv a^{b \\mod \\varphi(p)}\\mod p[gcd(a,p)==1]$$\n$$a^b\\equiv a^{b}\\mod p[gcd(a,p)!=1\\And b<\\varphi(p)]$$\n$$a^b\\equiv a^{b\\mod \\varphi(p)+\\varphi(p)}\\mod p[gcd(a,p)!=1\\And b>=\\varphi(p)]$$\n\n\u81f3\u4e8e\u8be5\u5b9a\u7406\u7684\u8bc1\u660e\u662f\u6839\u636e\u6b27\u62c9\u5b9a\u7406$a^{\\varphi(p)}\\equiv 1\\mod p$\u8bc1\u7684\n\n\u6709\u4e86\u6b27\u62c9\u5b9a\u7406\u6269\u5c55\u6b27\u62c9\u5b9a\u7406\u53ef\u4ee5\u7406\u89e3\u4e3a\u6bcf$\\varphi(p)$\u4e2a$a$\u4e58\u8d77\u6765\u5c31\u53d8\u6210\u4e861\n\n\u81f3\u4e8e\u6b27\u62c9\u5b9a\u7406\u7684\u8bc1\u660e\u7f51\u4e0a\u5e94\u8be5\u6709\u633a\u591a\u7684\uff0c\u6269\u5c55\u6b27\u62c9\u5b9a\u7406\u7684\u4e25\u8c28\u8bc1\u660e\u4e5f\u6709\u633a\u591a\u7684\uff0c\u8fd9\u91cc\u5c31\u4e0d\u518d\u8d58\u8ff0\n\n### \u601d\u8def\n\n\u770b\u5230\u9898\u610f\u662f\u533a\u95f4\u4fee\u6539+\u533a\u95f4\u67e5\u8be2\u548c\uff0c\u8fd9\u5f88\u7ebf\u6bb5\u6811\n\n\u4f46\u662f\u4fee\u6539\u64cd\u4f5c\u5e76\u4e0d\u4e0e\u4e00\u822c\u7684\u7ebf\u6bb5\u6811\u9898\u76f8\u540c\n\n\u6bcf\u4e00\u4e2a\u70b9\u6743\u503c\u5f62\u5f0f\u4e3a$c^{c^{...^{a_i}}}$\u8fd9\u6837\u5b50\n\n\u8bb0\u8fd9\u4e2a\u4e00\u4e2ak\u4e2ac\u7684\u5e42,$a_i$\u6a21p\u4e3a$f(a_i,k,p)$\n\n\u5bf9$f(k,a_i)$\u7528\u6269\u5c55\u6b27\u62c9\u5b9a\u7406\n\n(\u8fd9\u91cc\u9ed8\u8ba4\u662f\u6269\u5c55\u6b27\u62c9\u5b9a\u7406\u7684\u7b2c\u4e09\u79cd\u60c5\u51b5\uff0c\u4f46\u5177\u4f53\u5b9e\u73b0\u65f6\u9700\u8003\u8651\u5176\u4ed6\u7684\u60c5\u51b5)\n\n$$\nf(a_i,k,p)\\equiv c^{f(a_i,k-1, \\varphi(p))+\\varphi(p)}\\mod p\n$$\n\n\u6211\u4eec\u53ef\u4ee5\u5bf9\u4e0b\u9762\u8fd9\u4e2a\u4e1c\u897f\u505a\u540c\u6837\u7684\u4e8b\u60c5\n$$f(a_i,k-1,\\varphi(p))$$\n\n\u6a21\u6570\u4f1a\u6709$p,\\varphi(p),\\varphi(\\varphi(p))...$\n\n\u76f4\u5230\u67d0\u6b21\u8fed\u4ee3\u5f97\u5230\u7684\u503c\u4e3a1\u5219\u540e\u9762\u7684\u5e42\u90fd\u6ca1\u6709\u610f\u4e49\u4e86\n\n\u7531\u4e8e\u5076\u6570\u7684\u6b27\u62c9\u51fd\u6570\u8fed\u4ee31\u6b21\u540e\u81f3\u5c11\u7f29\u5c0f\u4e00\u534a(\u6240\u6709\u5076\u6570\u4e0d\u4e0e\u5b83\u4e92\u8d28)\n\n\u5947\u6570\u7684\u6b27\u62c9\u51fd\u6570\u8fed\u4ee31\u6b21\u540e\u5fc5\u4e3a\u5076\u6570(\u7531$\\varphi$\u7684\u8ba1\u7b97\u5f0f\u53ef\u77e5)\n\n\u6545\u8fed\u4ee3\u6b21\u6570\u662flog\u7ea7\u7684\n\n\u8fd9\u4e5f\u4ee3\u8868\u7740\u4e00\u4e2a\u503c\u6700\u591a\u7ecf\u8fc7log\u4e2a\u4fee\u6539\u64cd\u4f5c\u540e\u503c\u4e0d\u518d\u6539\u53d8\n\n\u90fd\u4f1a\u53d8\u6210$c^{c^{c^{...^c}}}$\n\n\u8bb0\u5bf9$p$\u8fdb\u884c$h$\u6b21\u6b27\u62c9\u51fd\u6570\u8fed\u4ee3\u540ep\u53d8\u4e3a1\n\n\u6211\u4eec\u53ea\u8981\u5bf9\u4e8e\u6bcf\u4e00\u4e2a$a_i$\u9884\u5904\u7406$f(i,a_i,m),i\\in[0,h]$m\u4e3ap\u8fed\u4ee3\u51fa\u6765\u7684\u6240\u6709\u6570\u5373\u53ef\n\n\u800c\u60f3\u6c42f\uff0c\u6211\u4eec\u53ef\u4ee5\u8bbe$s_1(i,m),s_2(i,m)$\u7528\u4e8e\u6c42$c^i$\u6a21m\u7684\u503c\uff0cm\u7684\u5b9a\u4e49\u4e0e\u4e0a\u65b9\u4e00\u6837\n\n\u800c\u7279\u5224\u6b27\u62c9\u5b9a\u7406\u6211\u4eec\u53ef\u4ee5\u518d\u5f00\u4e24\u4e2abool\u6570\u7ec4\u5224\u65ad\n\n\u5177\u4f53\u53ef\u4ee5\u770b\u4e0b\u4ee3\u7801\u91cc\u7684pre\u51fd\u6570\n\n### \u590d\u6742\u5ea6\u5206\u6790\n\u6bcf\u6b21\u4fee\u6539\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u4f4d\u7f6e\u66b4\u529b\u4fee\u6539\uff0c\u7531\u4e8e\u4e00\u4e2a\u4f4d\u7f6e\u4fee\u6539log\u6b21\u540e\u7ee7\u7eed\u4fee\u6539\u503c\u662f\u4e0d\u53d8\u7684\n\n\u6545\u6211\u4eec\u8bb0\u5f55\u4e00\u4e0b\u6bcf\u4e2a\u4f4d\u7f6e\u7684\u4fee\u6539\u6b21\u6570\uff0c\u6bcf\u4e2a\u70b9\u6700\u591a\u4fee\u6539log\u6b21\u3002\n\n\u7531\u4e8e\u6211\u4eec\u6bcf\u6b21\u904d\u5386\u4e86\u6240\u6709\u8986\u76d6\u67d0\u4e2a\u533a\u95f4\u7684\u7ebf\u6bb5\u6811\u8282\u70b9\uff0c\u603b\u590d\u6742\u5ea6$O(nlog^2)$\n\n\u6211\u4eec\u9884\u5904\u7406\u51fa\u4e86$f(i,j,k)$,\u8fd9\u4e2a\u4e1c\u897f\u662f$nlog^2\u7684$\n\n\u7a7a\u95f4\u590d\u6742\u5ea6\u4e5f\u662f$O(nlog^2)$\n\n~~\u597d\u50cf\u9898\u89e3\u5927\u4f6c\u6709\u7a7a\u95f4\u66f4\u4f18\u79c0\u7684\u505a\u6cd5qaq~~\n```cpp\n#include<bits/stdc++.h>\n#define int long long\nusing namespace std;\nconst int maxn=50005;\nstruct seg{\n\tint v,mn;\n}t[maxn<<2];\nint n,m,p,c;\nint len=0;\nint phi[30];\nlong long s1[10005][30],s2[10005][30];\nbool b1[maxn][30],b2[maxn][30];\nlong long f[maxn][30][30];\nbool bj[maxn][30][30];\nint g[30];\nint a[maxn];\nint read(){\n\tint x=0,y=1;\n\tchar ch=getchar();\n\twhile(ch<'0'||ch>'9'){if(ch=='-')y=-1;ch=getchar();}\n\twhile(ch>='0'&&ch<='9')x=(x<<3)+(x<<1)+(ch^48),ch=getchar();\n\treturn x*y;\n}\nint gcd(register int x,register int y){\n\treturn y==0?x:gcd(y,x%y);\n}\nint get_phi(int x){\n\tlong long ans=x;\n\tfor(long long i=2;i<=sqrt(x);i++){\n\t\tif(x%i)continue;\n\t\tans=ans*(i-1)/i;\n\t\twhile(x%i==0)x/=i;\n\t}\n\tif(x>1)ans=ans*(x-1)/x;\n\treturn ans;\n}\nvoid pre(){\n\tint x=p;\n\tphi[0]=p;\n\twhile(x!=1){x=get_phi(x);phi[++len]=x;}\n\tphi[++len]=1;\n\tfor(int i=0;i<=len;i++)g[i]=gcd(c,phi[i]);\n\tfor(int j=0;j<=len;j++){\n\t\ts2[0][j]=1;\n\t\tfor(int i=1;i<=10000;i++){\n\t\t\ts2[i][j]=s2[i-1][j]*c;\n\t\t\tif(s2[i][j]>=phi[j]){s2[i][j]%=phi[j];b2[i][j]=1;}\n\t\t\tb2[i][j]|=b2[i-1][j];\n\t\t}\n\t}\n\tfor(int j=0;j<=len;j++){\n\t\ts1[0][j]=1;\n\t\tb1[1][j]=b2[10000][j];\n\t\tfor(int i=1;i<=10000;i++){\n\t\t\ts1[i][j]=s1[i-1][j]*s2[10000][j];\n\t\t\tif(s1[i][j]>=phi[j]){s1[i][j]%=phi[j];b1[i][j]=1;}\n\t\t\tb1[i][j]|=b1[i-1][j];\n\t\t}\n\t}\n\tfor(int i=1;i<=n;i++){\n\t\tfor(int k=0;k<=len;k++){\n\t\t\tf[i][0][k]=a[i]%phi[k];\n\t\t\tif(a[i]>=phi[k])bj[i][0][k]=1;\n\t\t}\n\t\tfor(int j=1;j<=len;j++){\n\t\t\tf[i][j][len]=0;\n\t\t\tfor(int k=0;k<len;k++){\n\t\t\t\tf[i][j][k]=s1[f[i][j-1][k+1]/10000][k]*s2[f[i][j-1][k+1]%10000][k];\n\t\t\t\tbj[i][j][k]=(b1[f[i][j-1][k+1]/10000][k]||b2[f[i][j-1][k+1]%10000][k]);\n\t\t\t\tif(f[i][j][k]>=phi[k]){f[i][j][k]%=phi[k];bj[i][j][k]=1;}\n\t\t\t\tif(g[k]!=1&&bj[i][j-1][k+1]){\n\t\t\t\t\tf[i][j][k]=f[i][j][k]*s1[phi[k+1]/10000][k]%phi[k]*s2[phi[k+1]%10000][k];\n\t\t\t\t\tif(f[i][j][k]>=phi[k]){f[i][j][k]%=phi[k];bj[i][j][k]=1;}\n\t\t\t\t\tbj[i][j][k]=(bj[i][j][k]||b1[phi[k+1]/10000][k]||b2[phi[k+1]%10000][k]);\n\t\t\t\t}\n\t\t\t}\t\n\t\t}\n\t}\n\treturn ;\n}\nvoid pushup(int k){\n\tt[k].v=t[k<<1].v+t[k<<1|1].v;\n\tt[k].mn=min(t[k<<1].mn,t[k<<1|1].mn);\n\treturn ;\n}\nvoid build(int k,int l,int r){\n\tif(l==r){\n\t\tt[k].v=a[l];\n\t\tt[k].mn=0;\n\t\treturn ;\n\t}\n\tint mid=l+((r-l)>>1);\n\tbuild(k<<1,l,mid);\n\tbuild(k<<1|1,mid+1,r);\n\tpushup(k);\n\treturn ;\n}\nvoid modify(int k,int l,int r,int x,int y){\n\tif(t[k].mn>=len)return ;\n\tif(l>y||r<x)return ;\n\tif(l==r){\n\t\tt[k].mn++;t[k].v=f[l][t[k].mn][0]%p;\n\t\treturn ;\n\t}\n\tint mid=l+((r-l)>>1);\n\tif(t[k<<1].mn<len)modify(k<<1,l,mid,x,y);\n\tif(t[k<<1|1].mn<len)modify(k<<1|1,mid+1,r,x,y);\n\tpushup(k);\n\treturn ;\n}\nint query(int k,int l,int r,int x,int y){\n\tif(l>y||r<x)return 0;\n\tif(l>=x&&r<=y)return t[k].v%p;\n\tint mid=l+((r-l)>>1);\n\treturn (query(k<<1,l,mid,x,y)+query(k<<1|1,mid+1,r,x,y))%p;\n}\nsigned main(){\n\tn=read();m=read();p=read();c=read();\n\tfor(int i=1;i<=n;i++)a[i]=read();\n\tpre();\n\tbuild(1,1,n);\n\tfor(int i=1;i<=m;i++){\n\t\tint opt,l,r;\n\t\topt=read();l=read();r=read();\n\t\tif(opt==0)modify(1,1,n,l,r);\n\t\telse printf(\"%lld\\n\",query(1,1,n,l,r));\n\t}\n\treturn 0;\n}\n\n```",
        "postTime": 1588512528,
        "uid": 98527,
        "name": "juju527",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3747 \u3010[\u516d\u7701\u8054\u80032017]\u76f8\u9022\u662f\u95ee\u5019\u3011"
    },
    {
        "content": "# Solution\n - \u5efa\u8bae\u5148\u505a[\u8fd9\u9898](https://www.luogu.org/problemnew/show/P4139)\n - \u6839\u636e\u6269\u5c55\u6b27\u62c9\u5b9a\u7406\n $$a^b\\% p \u2261 a^{b \\%\\phi(p)+\\phi(p)}\\% p,b\u2265\\phi(p)$$\n $$a^b\\% p \u2261 a^{b \\%\\phi(p)}\\% p,b<\\phi(p)$$\n - [\u8fd9\u9898](https://www.luogu.org/problemnew/show/P4139)\u6838\u5fc3\u4ee3\u7801\u5982\u4e0b\n ```cpp\n inline int solve(int p) // \u9012\u5f52\u5904\u7406\u6a21\u6570\u4e3ap\u7684\u7b54\u6848\n{\n    if (p == 1) return 0;\n    return ksm(2, solve(phi[p]) + phi[p], p); // ksm(x,y) = x ^ y\n}\n ```\n - \u53d1\u73b0\u6bcf\u6b21\u9012\u5f52\u90fd\u4f1a\u5c06 $p$ \u53d8\u4e3a $\\phi(p)$\n - \u5f53 $p$ \u662f\u5076\u6570\u65f6\uff0c $p$ \u53d8 $\\phi(p)$ \u81f3\u5c11\u9664\u4ee5 $2$\uff1b\u5f53 $p$ \u662f\u5947\u6570\u65f6\uff0c\u6839\u636e $\\phi(p)$ \u7684\u8ba1\u7b97\u516c\u5f0f ($q[i]$ \u4e3a $p$ \u7684\u6240\u6709\u8d28\u56e0\u5b50\uff0c\u4e14\u4e92\u4e0d\u76f8\u540c)$$p*\\Pi_{i=1}^k(q[i]-1)\\div q[i]$$\n - $q[i]-1$\u5fc5\u6709\u5076\u6570\uff0c\u90a3\u4e48$\\phi(p)$\u662f\u5076\u6570\n - **\u53ef\u77e5 $p$ \u4f1a\u5728 $O(\\log p)$ \u5185\u6b21\u53d8\u4e3a $1$\uff0c\u7ed3\u675f\u9012\u5f52**\n ****\n - \u800c\u4e0a\u9898\u4e2d\uff0c\u5bf9\u6269\u5c55\u6b27\u62c9\u5b9a\u7406\u7684\u5e94\u7528\u4e3a\uff1a$$2^{2^{2^{2^{...}}}}\\% p \u2261 2^{2^{2^{2^{...}}} \\%\\phi(p)+\\phi(p)}$$\n - \u5047\u8bbe $2$ \u7684\u4e2a\u6570\u6709\u9650\uff0c\u7b49\u5f0f\u5de6\u8fb9\u6709 $x$ \u4e2a $2$\uff0c \u90a3\u4e48\u7b49\u5f0f\u53f3\u8fb9\u7684\u6307\u6570\uff0c\u4e5f\u5c31\u662f\u9012\u5f52\u5904\u7406\u7684\u90e8\u5206\uff0c\u6709 $x-1$ \u4e2a $2$\n - \u4e5f\u5c31\u662f\u8bf4\uff0c\u6bcf\u6b21\u9012\u5f52\u51cf\u5c11\u4e86\u4e00\u4e2a $2$\n - **\u90a3\u4e48\u51cf\u5c11 $O(\\log p)$ \u4e2a $2$ \u540e\u5fc5\u5b9a\u7ed3\u675f\u9012\u5f52\uff0c\u5373\u5f53 $2$ \u7684\u4e2a\u6570\u8d85\u8fc7 $\\log p$ \u65f6\uff0c\u7b54\u6848\u5168\u90e8\u4e00\u6837**\n - \u56de\u5230\u672c\u9898\uff0c\u53ef\u4ee5\u5f97\u51fa\u4e00\u4e2a\u6570\u7684\u4fee\u6539\u6b21\u6570\u4e0a\u9650\u4e3a $O(\\log p)$\n - \u90a3\u4e48\u7ef4\u62a4\u7ebf\u6bb5\u6811\uff0c\u5982\u679c\u6574\u4e2a\u533a\u95f4\u4fee\u6539\u6b21\u6570\u90fd\u5230\u4e0a\u9650\u4e86\uff0c\u5c31 $return$\n - \u6613\u5f97\u4e00\u5171\u4f1a\u78b0\u5230\u53f6\u5b50\u8282\u70b9 $O (n \\log p)$ \u6b21\n ****\n - ~~\u4e3a\u4e86\u65b9\uff08\u5077\uff09\u4fbf\uff08\u61d2\uff09~~ \uff0c\u8bb0 $b[i][j]$ \u4e3a $c^{c^{c^{...^{a_{i}}}}}$ (\u5171 $j$ \u4e2a $c$\uff0c**\u6ce8\u610f\u6ca1\u6709\u53d6\u6a21**\uff09\uff0c\u8bb0 $f(i,j,p)$ \u4e3a $c^{c^{c^{...^{a_{i}}}}} \\%p$ (\u5171 $j$ \u4e2a $c$)\uff0c\u90a3\u4e48\u6709\u9012\u63a8\u5f0f$$f(i,j,p)=c^{f(i,j-1,\\phi(p))+(b[i][j-1]<\\phi(p)?0:\\phi(p))}$$\n - **\u9884\u5904\u7406\u51e0\u4e2a\u503c\u5728 $1e8$ \u5185\u7684 $b[i][j]$** \u5c31\u597d\u4e86\uff0c\u663e\u7136 $j$ \u90fd\u6bd4\u8f83\u5c0f\uff0c$j$ \u7a0d\u5927\u4e00\u70b9\u5c31\u662f\u5929\u6587\u6570\u5b57\u4e86\uff0c\u80af\u5b9a\u6bd4 $\\phi(p)$ \u5927\uff0c\u5f53\u7136\uff0c**\u6ce8\u610f\u7279\u5224 $c=1$ \u548c $j$ \u8f83\u5927\u7684\u60c5\u51b5**\n - **$p$ \u6709 $1e8$\uff0c\u4e0d\u80fd\u7528\u6570\u7ec4\u628a\u6240\u6709\u7684 $\\phi(x),x\u2264p$ \u90fd\u5b58\u4e0b\u6765**\uff0c\u53d1\u73b0\u7528\u5230\u7684 $x$ \u53ea\u6709 $p,\\phi(p),\\phi(\\phi(p)),...,1$\uff0c\u8003\u8651\u9884\u5904\u7406\u51fa\u6240\u6709\u8fd9\u6837\u7684 $x$\uff0c\u5e76\u5b58\u4e0b\u5b83\u4eec\u7684 $\\phi$\uff0c\u8bb0\u8fd9\u4e9b $x$ \u5206\u522b\u4e3a $d[m..1]$\uff08\u5373 $d[k-1] = \\phi(d[k])$\uff09\uff0c\u90a3\u4e48\u4e0a\u5f0f\u6539\u5199\u4e3a$$f(i,j,k)=c^{f(i,j-1,k-1)+(b[i][j-1]<d[k-1]?0:d[k-1])}$$ \n - \u6ce8\u610f\u9012\u5f52\u8fb9\u754c\uff1a$j=0$ \u6216 $k=1$\n - \u7531\u4e8e\u7528\u5230\u5feb\u901f\u5e42\uff0c\u4e0a\u5f0f\u65f6\u95f4\u590d\u6742\u5ea6 $O (\\log^2p)$\n - \u53d1\u73b0 $f(i,j,m)$ \u4e0d\u80fd\u76f4\u63a5\u7531 $f(i,j-1,m)$ \u5f97\u6765\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u6bcf\u6b21\u5230\u53f6\u5b50\u8282\u70b9\u90fd\u8981\u91cd\u65b0\u8ba1\u7b97\uff0c\u90a3\u4e48\u603b\u590d\u6742\u5ea6 $O (n \\log n \\log^2p)$\uff0c~~\u76f4\u63a5\u7206\u70b8~~\uff0c\u8003\u8651\u4f18\u5316\u6389\u5feb\u901f\u5e42\n ****\n - **\u5bf9\u4e8e\u8fd9$m$\u4e2a\u6a21\u6570**\uff0c\u5206\u522b\u9884\u5904\u7406 $c1[i]$ \u4e3a $c^{i*20000}$\uff0c$c2[i]$ \u4e3a $c^i$\uff0c\u90a3\u4e48 $$c^y=c1[y/20000]*c2[y\\%20000]$$\n - \u7136\u540e\u5c31\u53ef\u4ee5 $O(1)$ \u5feb\u901f\u5e42\u4e86\n - \u603b\u65f6\u95f4\u590d\u6742\u5ea6 $O(n (\\log n \\log p + \\log^2p))$\n\n# Code\n```cpp\n#include <bits/stdc++.h>\n\nusing namespace std;\n\n#define ll long long\n#define p2 p << 1\n#define p3 p << 1 | 1\n\ntemplate <class t>\ninline void read(t & res)\n{\n\tchar ch;\n\twhile (ch = getchar(), !isdigit(ch));\n\tres = ch ^ 48;\n\twhile (ch = getchar(), isdigit(ch))\n\tres = res * 10 + (ch ^ 48);\n}\n\nconst int e = 5e4 + 5, o = 5e4 + 5, bl = 2e4, z = 105;\nint a[e], cnt[o * 4], c1[z][20005], c2[z][20005], n, m, c, mod, phi[e];\nint num[e], d[e], c4, c3[e], b[e][20], sum[o * 4];\n\ninline void upt(int &x, int y)\n{\n\tx = y;\n\tif (x >= mod) x -= mod;\n}\n\ninline int solve(int x)\n{\n\tint s = sqrt(x), res = x, i;\n\tfor (i = 2; i <= s; i++)\n\tif (x % i == 0)\n\t{\n\t\twhile (x % i == 0) x /= i;\n\t\tres /= i;\n\t\tres *= i - 1;\n\t}\n\tif (x > 1)\n\t{\n\t\tres /= x;\n\t\tres *= x - 1;\n\t}\n\treturn res;\n}\n\ninline void init()\n{\t\n\td[d[0] = 1] = mod;\n\tfor (;;)\n\t{\n\t\td[0]++;\n\t\td[d[0]] = solve(d[d[0] - 1]);\n\t\tif (d[d[0]] == 1) break;\n\t}\n\treverse(d + 1, d + d[0] + 1);\n\tint i, j;\n\tll y = 1;\n\tc3[0] = 1;\n\tfor (i = 1; i < bl; i++) \n\t{\n\t\tif (y <= 1e8)\n\t\t{\n\t\t\ty = y * c; \n\t\t\tc3[i] = y;\n\t\t\tif (y <= 1e8) c4 = i;\n\t\t}\n\t\telse break;\n\t}\n\tfor (i = 1; i <= d[0]; i++)\n\t{\n\t\tc1[i][0] = c2[i][0] = 1;\n\t\tfor (j = 1; j < bl; j++) c2[i][j] = (ll)c2[i][j - 1] * c % d[i];\n\t\tc1[i][1] = (ll)c2[i][bl - 1] * c % d[i];\n\t\tfor (j = 2; j < bl; j++) c1[i][j] = (ll)c1[i][j - 1] * c1[i][1] % d[i];\n\t}\n\tfor (i = 1; i <= n; i++)\n\t{\n\t\tb[i][0] = a[i];\n\t\tfor (j = 1; j <= 6; j++)\n\t\t{\n\t\t\tint x = b[i][j - 1], p1 = x / bl, p0 = x % bl;\n\t\t\tif (c3[p0] > 1e8 || p1 || p0 > c4) break;\n\t\t\tb[i][j] = c3[p0];\n\t\t\tnum[i] = j;\n\t\t}\n\t}\n}\n\ninline int ksm(int y, int id)\n{\n\treturn (ll)c1[id][y / bl] * c2[id][y % bl] % d[id]; \n}\n\ninline int f(int i, int j, int mod)\n{\n\tif (mod == 1) return 0;\n\tif (j == 0) return a[i] % d[mod];\n\tif (c == 1 || (c != 1 && j - 1 <= num[i] && b[i][j - 1] < d[mod - 1])) \n\treturn ksm(f(i, j - 1, mod - 1), mod);\n\telse return ksm(f(i, j - 1, mod - 1) + d[mod - 1], mod);\n}\n\ninline void collect(int p)\n{\n\tcnt[p] = min(cnt[p2], cnt[p3]);\n\tupt(sum[p], sum[p2] + sum[p3]);\n}\n\ninline void build(int l, int r, int p)\n{\n\tif (l == r)\n\t{\n\t\tsum[p] = a[l];\n\t\treturn;\n\t}\n\tint mid = l + r >> 1;\n\tbuild(l, mid, p2);\n\tbuild(mid + 1, r, p3);\n\tcollect(p);\n}\n\ninline void update(int l, int r, int s, int t, int p)\n{\n\tif (cnt[p] > d[0]) return;\n\tif (l == r)\n\t{\n\t\tcnt[p]++;\n\t\tsum[p] = f(l, cnt[p], d[0]);\n\t\treturn;\n\t}\n\tint mid = l + r >> 1;\n\tif (s <= mid) update(l, mid, s, t, p2);\n\tif (t > mid) update(mid + 1, r, s, t, p3);\n\tcollect(p);\n}\n\ninline int query(int l, int r, int s, int t, int p)\n{\n\tif (l == s && r == t) return sum[p];\n\tint mid = l + r >> 1, res = 0;\n\tif (t <= mid) res = query(l, mid, s, t, p2);\n\telse if (s > mid) res = query(mid + 1, r, s, t, p3);\n\telse upt(res, query(l, mid, s, mid, p2) + query(mid + 1, r, mid + 1, t, p3));\n\treturn res;\n}\n\nint main()\n{\n\tread(n); read(m); read(mod); read(c);\n\tint i, opt, l, r;\n\tfor (i = 1; i <= n; ++i) read(a[i]);\n\tinit();\n\tbuild(1, n, 1);\n\twhile (m--)\n\t{\n\t\tread(opt);\n\t\tread(l);\n\t\tread(r);\n\t\tif (!opt) update(1, n, l, r, 1);\n\t\telse printf(\"%d\\n\", query(1, n, l, r, 1));\n\t}\n\treturn 0;\n}\n```\n",
        "postTime": 1549267238,
        "uid": 15268,
        "name": "\u82b1\u6dc7\u6dcb",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3747 \u3010[\u516d\u7701\u8054\u80032017]\u76f8\u9022\u662f\u95ee\u5019\u3011"
    },
    {
        "content": "\u5728\u540c\u4f59p\u7684\u60c5\u51b5\u4e0b\u5bf9\u4e00\u4e2a\u6570c\u4e0d\u65ad\u53d6\u03c6\uff0c\u6700\u591a\u9636\u4e58log p\u6b21\u5c31\u53ef\u4ee5\u4fdd\u6301\u4e0d\u53d8\u3002\u4e8e\u662f\u5bf9\u4e8e\u4e00\u4e2a\u6570\u3002\u6211\u4eec\u53ef\u4ee5\u6269\u5c55\u6b27\u62c9\u51fd\u6570\u5bf9\u6570c\u7684\u5e42\u6b21\u4e0d\u65ad\u62bd\u53d6\u03c6,\u53cd\u590d\u8fed\u4ee3\u3002\n\n\u6700\u540e\u4f1a\u8fed\u4ee3\u51fac^((c.......)%\u03c6(\u03c6(\u03c6(\u03c6.......p)))+\u03c6(\u03c6(\u03c6(\u03c6.......p)))<``\u03c6(\u03c6(\u03c6(\u03c6.......p)))=1``>\n\n\u6240\u4ee5\u6211\u4eec\u53ea\u7528\u627e\u5230\u4e00\u4e2a\u4e34\u754c\u662f\u4e00\u5806\u03c6\u7b49\u4e8e1\u3002\u7136\u540e\u5c31\u4e0d\u7528\u518d\u5bf9\u4ed6\u8fdb\u884c\u4fee\u6539\u3002\n\n\u7136\u540e\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u4e00\u4e2a\u533a\u95f4\u6700\u5c11\u4fee\u6539\u7684\u6b21\u6570\u3002\u5982\u679c\u5df2\u7ecf\u5230\u4e34\u754c\u5c31\u4e0d\u7528\u518d\u4fee\u6539\u4e86\u3002\n\n\u5982\u679c\u8fd8\u8981\u518d\u6539\u5c31\u66b4\u529b\u5230\u6839\u8282\u70b9~~\u4f46\u662f\u5e38\u6570\u6bd4\u8f83\u5927~~\n\n[\u4e09\u4ebacp\u535a\u5ba2](http://www.cnblogs.com/ck666/p/7499209.html)\n\n```cpp\n#include<iostream>\n#include<cstdlib>\n#include<cstdio>\n#include<algorithm>\n#define ll (long long)\n#define LL long long \n#define IN int \nusing namespace std;\nconst IN maxn=50000+99;\nconst IN N=10000+99;\nint read(){\n    int an=0,f=1;\n    char ch=getchar();\n    while(!('0'<=ch&&ch<='9')){if(ch=='-')f=-f;ch=getchar();}\n    while('0'<=ch&&ch<='9'){an=an*10+ch-'0';ch=getchar();}\n    return an*f;\n}\nIN phi[35],a[maxn],F;\nIN n,m,p,c;\nIN prime[maxn],isp[maxn],k,maxp;//k\u662f\u8d28\u6570\u4e2a\u6570,ips\u8bf4\u660e\u8fd9\u662f\u548c\u6570 \nstruct saber{\nIN sum,tag,l,r;\n}tr[maxn<<2];\nIN Phi(IN x){\n    LL ans=x;\n    for(IN i=1;i<=k && prime[i]*prime[i]<=x;i++){\n        if(!(x%prime[i]))ans=ans*(prime[i]-1)/prime[i];\n        while(!(x%prime[i]))x=x/prime[i];\n    }\n    if(x>1)ans=ans/x*(x-1);\n    return ans;\n}\nvoid euler(){\n    for(IN i=2;i<=N;i++){\n        if(!isp[i])k++,prime[k]=i;\n        for(IN j=1;j<=k;j++){\n            if(i*prime[j]>N)break;\n            isp[i*prime[j]]=1;\n            if(!(i%prime[j]))break;\n        }\n    }\n    phi[maxp]=p;\n    while(phi[maxp]!=1)maxp++,phi[maxp]=Phi(phi[maxp-1]);\n    maxp++;\n    phi[maxp]=1;\n}\nvoid build(IN k,IN l,IN r){\n    tr[k].l=l;\n    tr[k].r=r;\n    if(l==r){\n        tr[k].sum=a[l];\n        return ;\n    }\n    IN mid=(l+r)>>1;\n    build(k<<1,l,mid);\n    build(k<<1|1,mid+1,r);\n    tr[k].sum=tr[k<<1].sum+tr[k<<1|1].sum;\n}\nIN ask(IN k,IN i,IN j){\n    IN l=tr[k].l,r=tr[k].r;\n    if(l==i&&r==j)return tr[k].sum;\n    IN mid=(l+r)>>1;\n    if(mid>=j)return ask(k<<1,i,j);\n    else if(i>mid)return ask(k<<1|1,i,j);\n    else return (ask(k<<1,i,mid)+ask(k<<1|1,mid+1,j))%p;\n}\nIN qw(LL k,IN mod){\n    LL ans=1;LL s=c;\n    while(k){\n        if(k&1)ans*=s;\n        k>>=1;\n        s*=s;\n        if(s>=mod)F=1,s%=mod;\n        if(ans>=mod)F=1,ans%=mod;\n    }\n    return ans%mod;\n}\nLL work(LL a,LL t){\n    LL tmp=a;\n    if(tmp>phi[t])tmp=tmp%phi[t]+phi[t];\n    for(IN i=t;i>0;i--){\n        F=0;tmp=qw(tmp,phi[i-1]);\n        if(F)tmp+=phi[i-1],F=0;\n    }\n    return tmp;\n}\nvoid change(IN k,IN i,IN j){\n    if(tr[k].tag>=maxp)return;\n    LL l=tr[k].l,r=tr[k].r;\n    if(l==r){\n        tr[k].tag++;\n        tr[k].sum=work(a[l],tr[k].tag)%p;\n        return;\n    }\n    IN mid=(l+r)>>1;\n    if(mid>=j)change(k<<1,i,j);\n    else if(i>mid)change(k<<1|1,i,j);\n    else {change(k<<1,i,mid);change(k<<1|1,mid+1,j);}\n    tr[k].sum=tr[k<<1].sum+tr[k<<1|1].sum;\n    tr[k].tag=min(tr[k<<1].tag,tr[k<<1|1].tag);\n}\nint main(){\n    n=read();m=read();p=read();c=read();\n    for(IN i=1;i<=n;i++)a[i]=read();\n    euler();\n    build(1,1,n);\n    while(m)\n    {m--;\n        IN x,y,z;\n        x=read();y=read();z=read();\n        if(x){\n            printf(\"%lld\\n\",ask(1,y,z)%p);\n        }\n        else {\n            change(1,y,z);\n        }\n    }\n    return 0;\n}\n```\n~~\u6309\u7167\u67d0\u8bb2\u9898\u4eba\u6253\u7684,\u5e38\u6570\u95ee\u9898T\u4e24\u4e2a\u70b9,\u5728\u8fd9\u52a0\u4e2a\u9898\u89e3\u7ed9\u601d\u8def~~\n",
        "postTime": 1505905657,
        "uid": 24570,
        "name": "s_a_b_e_r",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3747 \u3010[\u516d\u7701\u8054\u80032017]\u76f8\u9022\u662f\u95ee\u5019\u3011"
    },
    {
        "content": "[\u535a\u5ba2\u5185\u98df\u7528\u66f4\u4f73](https://blog.csdn.net/devout_/article/details/105349027)\n\n\u770b\u5230\u533a\u95f4\u4fee\u6539\u533a\u95f4\u67e5\u8be2\uff0c\u5927\u5bb6\u4e00\u5b9a\u4f1a\u89c9\u5f97\u8fd9\u662f\u4e00\u4e2a\u7ebf\u6bb5\u6811\u9898\n\n\u7136\u540e\u518d\u770b\u4fee\u6539\u64cd\u4f5c$a_i=c^{a_i}$\n\n\u8fd9\u73a9\u610f\u771f\u7684\u80fd\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u5417\uff1f\uff1f\uff1f\n\n~~\u7b54\u6848\u662f\uff1a\u663e\u7136\u4e0d\u80fd~~\n\n\u90a3\u600e\u4e48\u529e\u5462\uff1f\n\n\u770b\u5230\u8fd9\u4e48\u591a\u843d\u5728\u4e00\u8d77\u7684\u5e42\uff0c\u597d\u591a\u8fd8\u90fd\u4e00\u6837($c$)\uff0c\u6211\u4eec\u53ef\u4ee5\u8054\u60f3\u5230[\u8fd9\u9053\u9898](https://www.luogu.com.cn/problem/P4139)\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u7528\u6269\u5c55\u6b27\u62c9\u5b9a\u7406\u63a8\u4e00\u4e0b\uff0c~~[\u987a\u4fbf\u7ed9\u81ea\u5df1\u7684\u535a\u5ba2\u6253\u5e7f\u544a\u5624\u5624\u5624~](https://blog.csdn.net/devout_/article/details/105300960)~~\n\n\u6839\u636e\u6269\u5c55\u6b27\u62c9\u5b9a\u7406\uff1a$a^c\\equiv a^{c\\bmod \\phi(p)+\\phi(p)}\\bmod p$\n\n\u90a3\u4e48\u7ecf\u8fc7\u4e00\u6bb5\u65f6\u95f4\uff0c\u5f53$\\phi(\\phi(\\phi(\\phi(...\\phi(\\phi(p))))))=1$\u4e4b\u540e\uff0c\u6211\u4eec\u7684\u5f0f\u5b50\u5c31\u53d8\u6210\u4e86$c^{c^{c...^c}}$\uff0c\u5c31\u548c$a_i$\u65e0\u5173\u4e86\uff01\uff01\uff01\n\n\u4e8e\u662f\u6211\u4eec\u53c8\u60f3\u5230\u4e86[\u8fd9\u9053\u9898](https://www.luogu.com.cn/problem/P4145)\uff0c\u91c7\u53d6\u4e00\u6837\u7684\u505a\u6cd5\uff0c\u5bf9\u4e8e\u4fee\u6539\uff0c\u66b4\u529b\u4fee\u6539\u5982\u679c\u4fee\u6539\u5230$\\phi(\\phi(\\phi(\\phi(...\\phi(\\phi(p))))))=1$\u4e4b\u540e\u5c31\u4e0d\u7ba1\u4ed6\u4e86\n\n\u53ef\u4ee5\u8bc1\u660e\uff0c\u6700\u591a\u7ecf\u8fc7$2\\log p$\u6b21\u4e4b\u540e\uff0c$\\phi(\\phi(\\phi(\\phi(...\\phi(\\phi(p))))))=1$\uff0c\u4e5f\u5c31\u662f\u8bf4\u6bcf\u4e2a\u70b9\u6700\u591a\u4f1a\u88ab\u4fee\u6539$2\\log p$\u6b21\uff0c\u800c\u6bcf\u6b21\u4fee\u6539\u6700\u591a\u9700\u8981$\\log$\u6b21\u9012\u5f52\uff0c\u6bcf\u6b21\u9012\u5f52\u7684\u65f6\u5019\u9700\u8981$\\log$\u7684\u65f6\u95f4\u6765\u7b97\u5feb\u901f\u5e42\uff0c\u4e5f\u5c31\u662f\u8bf4\u8fd9\u9053\u9898\u6211\u4eec\u5c31\u505a\u51fa\u4e86\u4e00\u79cd$O(m\\log^3 p)$\u7684\u505a\u6cd5\n\n\u7136\u540e\u6211\u4eec\u624b\u63a8\u4e00\u4e0b\u5c31\u4f1a\u53d1\u73b0$5\\times 10^4\\times \\log^3 (5\\times10^8)\\approx4\\times 10^9$\u663e\u7136\u662f\u8dd1\u4e0d\u8fc7\u53bb\u7684\uff0c\u4f46\u662f\u80fd\u591f\u62ff\u5230$80$\u5206\uff0c\u4f46\u662f~~\u56e0\u4e3a\u8fd9\u9898\u6807\u7a0b\u51fa\u9505\u4e86\uff0c\u6240\u4ee5\u6570\u636e\u7279\u522b\u6c34~~\uff0c\u6240\u4ee5\u5b9e\u9645\u80fd\u591f\u62ff\u5230$90$\u3002\n\n\u4f46\u662f\u6ce8\u610f\u8fd9\u91cc\u6709\u4e00\u4e2a\u7ec6\u8282\uff0c\u56e0\u4e3a\u6269\u5c55\u6b27\u62c9\u5b9a\u7406\u53ea\u6709\u5728\u6307\u6570$c\\geq \\phi(p)$\u7684\u65f6\u5019\u624d\u6210\u7acb\uff0c\u6240\u4ee5\u6211\u4eec\u8981\u5224\u65ad\u4e00\u4e0b\u8981\u4e0d\u8981\u52a0\u4e0a$\\phi(p)$\uff0c\u8fd9\u91cc\u53ef\u4ee5\u7528\u4e00\u4e2aflag\u53d8\u91cf\u6765\u6c42\n\n\u56e0\u4e3a\u63a5\u4e0b\u6765\u8981\u7528\u5230\u7684\u5149\u901f\u5e42\u7684\u4f18\u5316\u53ef\u80fd\u6709\u4eba\u4e4b\u524d\u6ca1\u6709\u5b66\u8fc7\uff08\u6bd4\u5982\u8bf4\u6211\uff09\uff0c\u6240\u4ee5\u672c\u6765\u5e94\u8be5\u8d34\u4e00\u4e0b\u4ee3\u7801\u7684\uff0c\u4f46\u662f\u56e0\u4e3a\u8003\u8651\u5230\u6d1b\u8c37\u9898\u89e3\u7684\u7bc7\u5e45\u9650\u5236\uff0c\u5927\u5bb6\u53ef\u4ee5\u53bb\u6211\u7684\u535a\u5ba2\u91cc\u9762\u53bb\u770b$90$\u5206\u4ee3\u7801\n****\n\u90a3\u4e48\u6211\u4eec\u8003\u8651\u600e\u4e48\u4f18\u5316\n\n\u6211\u4eec\u53d1\u73b0\u6211\u4eec\u6bcf\u6b21\u66b4\u529b\u6c42\u7b54\u6848\u7684\u65f6\u5019\uff0c\u5e95\u6570\u662f\u4e00\u6837\u7684\uff0c\u800c\u6a21\u6570\u4e5f\u4e0d\u591a\n\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5bf9\u4e8e\u6bcf\u4e2a\u6a21\u6570\u8fdb\u884c\u4e00\u4e0b[\u5149\u901f\u5e42\uff08\u7ee7\u7eed\u6253\u5e7f\u544a\uff09](https://blog.csdn.net/devout_/article/details/105348614)\u7136\u540e\u6211\u4eec\u53ef\u4ee5\u4f18\u5316\u6389\u4e00\u4e2a$\\log$\u53d8\u6210$O(m\\log^2p)$\u5c31\u89e3\u51b3\u4e86\n\n\u540c\u65f6\u6211\u4eec\u4e5f\u8981\u5728\u9884\u5904\u7406\u7684\u65f6\u5019\u5904\u7406\u4e00\u4e0b\u6709\u6ca1\u6709\u6ea2\u51fa\u7684\u60c5\u51b5\uff08\u5728\u505a\u7684\u8fc7\u7a0b\u4e2d\u51fa\u73b0\u4e86$\\geq\\phi(p)$\uff09\uff0c\u5982\u679c\u6709\u5c31\u52a0\u4e0a$\\phi(p)$\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n\n# define Rep(i,a,b) for(int i=a;i<=b;i++)\n# define _Rep(i,a,b) for(int i=a;i>=b;i--)\n# define RepG(i,u) for(int i=head[u];~i;i=e[i].next)\n\ntypedef long long ll;\n\nconst int N=1e5+5;\nconst int bl=10000;\nconst int M=65;\n\ntemplate<typename T> void read(T &x){\n   x=0;int f=1;\n   char c=getchar();\n   for(;!isdigit(c);c=getchar())if(c=='-')f=-1;\n   for(;isdigit(c);c=getchar())x=(x<<1)+(x<<3)+c-'0';\n    x*=f;\n}\n\n# define int long long\n\nint n,m,p,c;\nint a[N];\nint phi[N],dep;\nint qpow[bl+5][M][2];\nbool flag,over[bl+5][M][2];\n\nstruct segment_tree{\n    int l,r;\n    int sum,tim;\n}seg[N<<2];\n\n# define lc (u<<1)\n# define rc (u<<1|1)\n\nint getphi(int x){\n    int res=x;\n    for(int i=2;1ll*i*i<=x;i++){\n        if(x%i==0)\n            res=res/i*(i-1);\n        while(x%i==0)x/=i;\n    }\n    if(x>1)res=res/x*(x-1);\n    return res;\n}   \n\nvoid init(){\n    int x=p;\n    phi[0]=x;\n    while(x>1){\n        x=getphi(x);\n        phi[++dep]=x;//\u53ea\u5904\u7406\u4f1a\u7528\u5230\u7684phi\n    }\n    phi[++dep]=1;\n    Rep(i,0,dep){\n        qpow[0][i][0]=1;\n        Rep(j,1,bl){\n            qpow[j][i][0]=qpow[j-1][i][0]*c;//\u9884\u5904\u7406\n            if(qpow[j][i][0]>=phi[i])over[j][i][0]=true,qpow[j][i][0]%=phi[i];\n            over[j][i][0]|=over[j-1][i][0];//\u5904\u7406\u6709\u6ca1\u6709\u6ea2\u51fa\n        }\n    }\n    Rep(i,0,dep){\n        qpow[0][i][1]=1;\n        Rep(j,1,bl){\n            qpow[j][i][1]=qpow[j-1][i][1]*qpow[bl][i][0];//\u9884\u5904\u7406\n            if(qpow[j][i][1]>=phi[i])over[j][i][1]=true,qpow[j][i][1]%=phi[i];\n            over[j][i][1]|=over[j-1][i][1];//\u6ea2\u51fa\n        }\n    }\n}\n\nint Qpow(int ind,int p){\n    flag|=over[ind%bl][p][0]|over[ind/bl][p][1];\n    int res=qpow[ind%bl][p][0]*qpow[ind/bl][p][1];//\u8ba1\u7b97\n    if(res>=phi[p])flag=true,res%=phi[p];//\u5728\u4e58\u7684\u65f6\u5019\u6ea2\u51fa\u4e5f\u7b97\n    return res;\n}\n\nint calc(int id,int lim,int d){\n    flag=false;\n    if(d==lim){\n        if(a[id]>=phi[d]){\n            flag=true;\n            return a[id]%phi[d];\n        }\n        return a[id];\n    }\n    int x=calc(id,lim,d+1);//\u9012\u5f52\u6c42\u89e3\uff0c\u540c\u4e0a\u5e1d\u90a3\u9053\u9898\n    if(flag)x+=phi[d+1],flag=false;\n    return Qpow(x,d);\n}\n\nvoid pushup(int u){\n    seg[u].sum=(seg[lc].sum+seg[rc].sum)%p;\n    seg[u].tim=min(seg[lc].tim,seg[rc].tim);\n}\n\nvoid build(int u,int l,int r){\n    seg[u].l=l,seg[u].r=r;\n    if(l==r){\n        seg[u].sum=a[l];\n        seg[u].tim=0;\n        return;\n    }\n    int mid=l+r>>1;\n    build(lc,l,mid);\n    build(rc,mid+1,r);\n    pushup(u);\n}\n\nvoid update(int u,int l,int r){\n    if(seg[u].tim>=dep)return;\n    if(seg[u].l==seg[u].r){\n        seg[u].tim++;\n        seg[u].sum=calc(seg[u].l,seg[u].tim,0);//\u66b4\u529b\u4fee\u6539\n        return;\n    }\n    int mid=seg[u].l+seg[u].r>>1;\n    if(l<=mid)update(lc,l,r);\n    if(r>mid)update(rc,l,r);\n    pushup(u);\n}\n\nint query(int u,int l,int r){\n    if(seg[u].l>=l&&seg[u].r<=r)return seg[u].sum;\n    int mid=seg[u].l+seg[u].r>>1;\n    int res=0;\n    if(l<=mid)res+=query(lc,l,r);\n    if(r>mid)res+=query(rc,l,r);\n    res%=p;\n    return res;\n}\n\nsigned main()\n{\n    read(n),read(m),read(p),read(c);\n    Rep(i,1,n)read(a[i]);\n    init();\n    build(1,1,n);\n    Rep(i,1,m){\n        int opt,x,y;\n        read(opt),read(x),read(y);\n        if(!opt)update(1,x,y);\n        else printf(\"%lld\\n\",query(1,x,y));\n    }\n    return 0;\n}\n```\n",
        "postTime": 1586171985,
        "uid": 97344,
        "name": "devout",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3747 \u3010[\u516d\u7701\u8054\u80032017]\u76f8\u9022\u662f\u95ee\u5019\u3011"
    },
    {
        "content": "\u524d\u7f6e\u829d\u58eb\u6269\u5c55\u6b27\u62c9\u5b9a\u7406\uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/kxeno956.png)\n\n\u5f15\u7406\uff1a\u4e00\u4e2a\u6570\u81f3\u591a\u53d6$O(log)$\u6b21\u6b27\u62c9\u51fd\u6570\u4f1a\u53d8\u4e3a1.\n\n\u53e3\u80e1\u8bc1\u660e\uff1a\u5bf9\u4e8e\u5076\u6570\uff0c\u6240\u6709\u5c0f\u4e8e\u5b83\u7684\u5076\u6570\u90fd\u4e0e\u5b83\u4e0d\u4e92\u8d28\uff0c\u5176\u6b27\u62c9\u51fd\u6570\u81f3\u5c11\u4e3a\u5176$\\frac{1}{2}$\u3002\u5bf9\u4e8e\u5947\u6570\uff0c\u5176\u6b27\u62c9\u51fd\u6570\u5fc5\u662f\u5076\u6570\u3002\u8bc1\u6bd5\u3002\n\n\u7531\u6b64\u53ef\u5f97\u67d0\u6570\u5728\u4fee\u6539$O(log)$\u6b21\u4e4b\u540e\u5c06\u4e0d\u518d\u6539\u53d8\u3002\n\n\u8003\u8651\u66b4\u529b\u5206\u5757\u3002\n\n\u5c06\u5e8f\u5217\u5206\u4e3a$\\frac{n}{B}$\u4e2a\u5927\u5c0f\u4e3a$B$\u7684\u5757\u3002\u4fee\u6539\u65f6\u66b4\u529b\u4fee\u6539\u6574\u5757\u4e0e\u6563\u5757\uff0c\u82e5\u67d0\u4e00\u6b21\u4fee\u6539\u540e\u53d1\u73b0\u5f53\u524d\u5757\u6ca1\u6709\u6570\u5b57\u88ab\u6539\u53d8\uff0c\u8bf4\u660e\u7ee7\u7eed\u4fee\u6539\u8fd9\u4e2a\u5757\u4e5f\u4e0d\u518d\u751f\u6548\uff0c\u6253\u4e0a\u6807\u8bb0\u4e0d\u518d\u4fee\u6539\u3002\n\n\u8003\u8651\u5982\u4f55\u4fee\u6539\u5355\u70b9\u3002\n\n\u8bb0\u5f55\u6bcf\u4e2a\u4f4d\u7f6e\u7684\u4fee\u6539\u6b21\u6570\uff0c\u7528\u6269\u5c55\u6b27\u62c9\u5b9a\u7406\u76f4\u63a5\u5d4c\u5957\u6c42\u89e3\uff0c\u5bb9\u6613\u5199\u51fa\u50cf\u8fd9\u6837\u7684\u4ee3\u7801\uff1a\n\n```cpp\nvoid getans(int x, int t, int p) {\n//x\u4e3a\u5f53\u524d\u4f4d\u7f6e\u521d\u59cb\u503c\uff0ct\u4e3a\u4fee\u6539\u6b21\u6570\uff0cp\u4e3a\u5f53\u524d\u6a21\u6570\u3002\n\tif(!t) return x%p;\n\tif(p==1) return 0;\n\tint b = getans(x, t-1, phi[p])+phi[p];\n\treturn pwc(b, p);\n//\u5176\u4e2dpwc(b, p)\u8868\u793a\u6c42c^b mod p\u7684\u503c\u3002\n}\n```\n\u8fd9\u6837\u5199\u663e\u7136\u662f\u6709\u4e00\u70b9\u70b9\u5c0f\u95ee\u9898\u7684\uff0c\u4ee3\u7801\u4e2d\u5e76\u6ca1\u6709\u5224\u65ad$b$\u4e0e$\\varphi(p)$\u7684\u5927\u5c0f\uff0c\u5f15\u5165\u4e00\u4e2a\u7ed3\u6784\u4f53\u6765\u5b58\u50a8\u6570\u636e\u662f\u5426\u5df2\u7ecf\u8d85\u8fc7$p$\u5373\u53ef\u89e3\u51b3\u6b64\u95ee\u9898\u3002\n\n```cpp\nstruct Node {int x, flag;};\nNode getans(int x, int t, int P) {\n\tif(!t) return (Node) {x%P, x>=P};\n\tif(P == 1) return (Node) {0, 1};\n\tNode tmp = getans(x, t-1, phi[P]);\n\tint b = tmp.x + phi[P] * tmp.flag;\n\treturn pwc(b, P); //\u5728pwc()\u4e2d\u4e5f\u9700\u8981\u5224\u65ad\uff0c\u8be6\u89c1\u4ee3\u7801\u3002\n}\n```\n\u8fd9\u6837\u770b\u8d77\u6765\u5355\u70b9\u4fee\u6539\u7684\u65f6\u95f4\u662f$O(log^2n)$\u7684\uff0c\u96be\u4ee5\u63a5\u53d7\u3002\u8003\u8651\u4f18\u5316\u5feb\u901f\u5e42\u3002\n\n\u8003\u8651\u66b4\u529b\u5206\u5757\u3002\u8bbe\u6700\u5927\u6307\u6570\u4e3a$V$\uff0c\u5219\u53ef\u4ee5\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u6a21\u6570\u9884\u5904\u7406\u51fa\u4ee5\u4e0b\u4e24\u4e2a\u4fe1\u606f\uff1a\n\n1\u3001$c^1,c^2,c^3,c^4,c^5....,c^{\\sqrt{V}}$\u3002\n\n2\u3001$c^{\\sqrt{V}},c^{2\\sqrt{V}},c^{3\\sqrt{V}},c^{4\\sqrt{V}},....c^{V}$\u3002\n\n\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u6307\u6570$b<V$\uff0c\u6709\uff1a\n\n$$b=k\\sqrt{V}+t(k \\in N,t\u2264\\sqrt{V})$$\n\n\u7531\u4e8e\u6a21\u6570\u6700\u591a\u53ea\u6709$O(logn\\sqrt{V})$\u9884\u5904\u7406$O(1)$\u6c42\u89e3$c$\u7684\u5e42\u6b21\u65b9\u3002\n\n\u7531\u6b64\u8fbe\u6210\u4e86$O(logn)$\u5355\u70b9\u4fee\u6539\u3002\n\n\u968f\u4fbf\u5047\u8bbe\u4e00\u4e0b$log(n),log(p)$\u540c\u9636\u6765\u5206\u6790\u590d\u6742\u5ea6\u3002(\u61d2\uff09\n\n\u7531\u4e8e\u6bcf\u4e2a\u5757\u6700\u591a\u88ab\u6574\u5757\u4fee\u6539$O(logn)$\u6b21\uff0c\u6bcf\u6b21\u4fee\u6539\u590d\u6742\u5ea6\u4e3a$O(Blogn)$\uff0c\u5171\u6709$O(\\frac{n}{B})$\u4e2a\u5757\uff0c\u56e0\u6b64\u6574\u5757\u4fee\u6539\u7684\u590d\u6742\u5ea6\u4e3a\u5747\u644a$O(nlog^2n)$\uff0c\u6563\u5757\u4fee\u6539\u590d\u6742\u5ea6$O(nBlogn)$\u3002\n\n\u5bf9\u4e8e\u8be2\u95ee\u64cd\u4f5c\uff0c\u590d\u6742\u5ea6\u4e3a$O(nB+\\frac{n^2}{B})$\n\n\u5f53$B=\\sqrt{\\frac{n}{log_2n}}$\u7684\u65f6\u5019\u590d\u6742\u5ea6\u6700\u4f18\uff0c\u4e3a$O(nlog^2n+(nlogn)^{\\frac{3}{2}})$\n\n\u53ef\u4ee5\u8349\u8fc7\u672c\u9898\u3002\u4e0a\u4ee3\u7801\uff1a\n\n```cpp\n#include <bits/stdc++.h>\n#define bl(x) ((x-1)/siz+1)\n#define L(x) (x-1)*siz+1\n#define R(x) std::min(x*siz, n)\nusing namespace std;\nconst int MAXN = 50050, MAXB = 250, GSM = 12000, MAXV = 1e8;\nint s[MAXB], a[MAXN], tag[MAXN], n, m, p, c, siz, tms[MAXN], ori[MAXN], notp[MAXV+5], phi[MAXV+5], prime[MAXV+5];\nint id[MAXV+5], _c[150][GSM+5], __c[150][GSM+5], ccc, cntp, _b[150][GSM+5], __b[150][GSM+5];\nstruct Node {int x, flag;};\nvoid read(int &x) {\n\tchar ch; while(ch = getchar(), ch < '!'); x = ch - 48;\n\twhile(ch = getchar(), ch > '!') x = (x << 3) + (x << 1) + ch - 48;\n}\nvoid write(int x) {if(x > 9) write(x / 10); putchar(x % 10 + 48);}\nint Getphi(int x) {\n\tint ans = x;\n\tfor(int i = 2; i * i <= x; ++i)\n\t\tif(x % i == 0) {\n\t\t\tans = ans / i * (i-1);\n\t\t\twhile(x % i == 0) x /= i;\n\t\t}\n\tif(x > 1) ans = ans / x * (x-1);\n\treturn ans;\n}\nvoid init(int P) {\n\tid[P] = ++ccc; _c[id[P]][0] = __c[id[P]][0] = 1;\n\tfor(int i = 1; i <= GSM; ++i) {\n\t\t_c[id[P]][i] = 1ll*_c[id[P]][i-1]*c%P;\n\t\t_b[id[P]][i] = (_b[id[P]][i-1] || _c[id[P]][i-1]*c >= P);\n\t}\n\t__c[id[P]][1] = _c[id[P]][GSM]; __b[id[P]][1] = _b[id[P]][GSM];\n\tfor(int i = 2; i <= GSM; ++i) {\n\t\t__c[id[P]][i] = 1ll*__c[id[P]][i-1]*__c[id[P]][1]%P;\n\t\t__b[id[P]][i] = (__b[id[P]][i-1] || __c[id[P]][i-1]*_c[id[P]][1] >= P);\n\t}\n}\nNode pwc(int b, int P) {\n\treturn (Node) {1ll*__c[id[P]][b/GSM]*_c[id[P]][b%GSM]%P, __b[id[P]][b/GSM]||_b[id[P]][b%GSM]||__c[id[P]][b/GSM]*_c[id[P]][b%GSM]>=P};\n}\nNode getans(int x, int t, int P) {\n\tif(!t) return (Node) {x%P, x>=P};\n\tif(P == 1) return (Node) {0, 1};\n\tNode tmp = getans(x, t-1, phi[P]);\n\tint b = tmp.x + phi[P] * tmp.flag;\n\treturn pwc(b, P);\n}\nvoid update(int b) {for(int i = L(b); i <= R(b); ++i) s[b] = (s[b] + a[i]) % p;}\nvoid modify(int i) {\n\ts[bl(i)] -= a[i]; ++tms[i];\n\ta[i] = getans(ori[i], tms[i], p).x;\n\ts[bl(i)] += a[i]; s[bl(i)] = (s[bl(i)] + p) % p;\n}\nvoid work(int b) {\n\tif(tag[b]) return; tag[b] = 1;\n\tfor(int i = L(b); i <= R(b); ++i) {\n\t\tint t = a[i]; modify(i);\n\t\tif(t != a[i]) tag[b] = 0;\n\t}\n}\nint main() {\n\tread(n); read(m); read(p); read(c); siz = max(1.0, sqrt(n/log2(n)));\n\tint tmp = p;\n\tfor(; tmp > 1; tmp = phi[tmp]) phi[tmp] = Getphi(tmp), init(tmp); init(1);\n\tfor(int i = 1; i <= n; ++i) read(a[i]), ori[i] = a[i];\n\tfor(int i = 1; i <= bl(n); ++i) update(i);\n\tfor(int opt, l, r; m--; ) {\n\t\tread(opt); read(l); read(r);\n\t\tif(!opt) {\n\t\t\tif(bl(l) == bl(r))\n\t\t\t\tfor(int i = l; i <= r; ++i) modify(i);\n\t\t\telse {\n\t\t\t\tfor(int i = l; i <= R(bl(l)); ++i) modify(i);\n\t\t\t\tfor(int i = bl(l)+1; i <= bl(r)-1; ++i) work(i);\n\t\t\t\tfor(int i = L(bl(r)); i <= r; ++i) modify(i);\n\t\t\t}\n\t\t} else {\n\t\t\tif(bl(l) == bl(r)) {\n\t\t\t\tint res = 0;\n\t\t\t\tfor(int i = l; i <= r; ++i) res = (res + a[i]) % p;\n\t\t\t\twrite(res); putchar('\\n');\n\t\t\t} else {\n\t\t\t\tint res = 0;\n\t\t\t\tfor(int i = l; i <= R(bl(l)); ++i) res = (res + a[i]) % p;\n\t\t\t\tfor(int i = bl(l)+1; i <= bl(r)-1; ++i) res = (res + s[i]) % p;\n\t\t\t\tfor(int i = L(bl(r)); i <= r; ++i) res = (res + a[i]) % p;\n\t\t\t\twrite(res); putchar('\\n');\n\t\t\t}\n\t\t}\n\t}\n}\n```",
        "postTime": 1570695792,
        "uid": 2491,
        "name": "\u8bd7\u4e43",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P3747 \u3010[\u516d\u7701\u8054\u80032017]\u76f8\u9022\u662f\u95ee\u5019\u3011"
    },
    {
        "content": "\u9996\u5148\u77e5\u9053\u62d3\u5c55\u6b27\u62c9\u5b9a\u7406\u3002\u5173\u4e8e\u62d3\u5c55\u6b27\u62c9\u5b9a\u7406\u53ef\u4ee5\u770b[\u8fd9\u7bc7\u535a\u5ba2](https://www.cnblogs.com/amagaisite/p/13418408.html)\u3002\n\n\u8003\u8651\u6211\u4eec\u76f4\u63a5\u6d88\u6389\u6307\u6570\uff0c\u7528\u62d3\u5c55\u6b27\u62c9\u5b9a\u7406\u5904\u7406\u3002\u5728\u9012\u5f52\u7684\u8fc7\u7a0b\u4e2d\u8ba1\u7b97\u8d21\u732e\uff0c\u6a21\u6570\u53d8\u6210\u4e0a\u4e00\u4e2a\u6a21\u6570\u7684\u6b27\u62c9\u51fd\u6570\uff0c\u5982\u679c\u5f53\u524d\u5df2\u7ecf\u8fbe\u5230\u4e86\u5904\u7406\u4e0a\u9650\uff0c\u6211\u4eec\u5c31\u8fd4\u56de\u3002\u81f3\u4e8e\u8fd9\u4e2a\u8fc7\u7a0b\u53ef\u4ee5\u76f4\u63a5\u7528 `dfs` \u5904\u7406\u3002\n\n\u95ee\u9898\u51fa\u73b0\u4e86\uff1a`dfs` \u7684\u590d\u6742\u5ea6\u662f\u5426\u6b63\u786e\uff1f\n\n\u6211\u4eec\u53d1\u73b0 `dfs` \u7684\u65f6\u95f4\u590d\u6742\u5ea6\u53d6\u51b3\u4e8e $\\dots\\varphi(\\varphi(n))\\dots$\uff08\u5373\u5d4c\u5957\u51e0\u5c42\uff09\u6211\u4eec\u5bf9\u4e00\u4e2a\u5076\u6570 $a$ \u8fdb\u884c $a \u2190 \\varphi(a)$\uff0c\u53d1\u73b0\u4f1a\u6392\u6389\u81f3\u5c11\u4e00\u4e2a\u8d28\u56e0\u6570 $2$\uff0c\u5373 $a'\\leq \\dfrac{a}{2}$\uff1b\u5bf9\u4e00\u4e2a\u5947\u6570\uff0c\u5982\u679c\u5b83\u662f\u8d28\u6570 $a$ \u8fdb\u884c $a \u2190 \\varphi(a)$\uff0c$a'$ \u5c31\u4f1a\u53d8\u6210\u5076\u6570\uff1b\u5426\u5219\u53c8\u4f1a\u6709\u4e00\u4e2a\u8d28\u56e0\u5b50 $p$\uff0c\u4f7f\u5f97 $a' \\leq \\dfrac{a}{p}$\u3002\u6240\u4ee5 `dfs` \u7684\u65f6\u95f4\u590d\u6742\u5ea6\u5b9e\u9645\u4e0a\u662f $O(\\log n)$ \u7684\u3002\n\n\u4e8e\u662f\u5bf9\u4e8e\u7b2c\u4e00\u4e2a\u64cd\u4f5c\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\uff0c\u4fdd\u5b58\u4e00\u4e0b\u5f53\u524d\u8fd9\u4e2a\u7ed3\u70b9\u6240\u5305\u542b\u7684\u533a\u95f4\u5185\u64cd\u4f5c\u6700\u5c11\u7684\u64cd\u4f5c\u4e86\u591a\u5c11\u6b21\u3002\u5982\u679c\u5df2\u7ecf\u8fbe\u5230\u4e86\u8fd9\u4e2a\u6a21\u6570\u7684\u4e0a\u9650\u5c31\u53ef\u4ee5\u76f4\u63a5\u4e0d\u5904\u7406\uff08\u56e0\u4e3a\u518d\u5904\u7406\u4e5f\u4e0d\u4f1a\u53d8\u4e86\uff09\uff0c\u5426\u5219**\u66b4\u529b**\u5904\u7406\u3002\n\n\u5bf9\u4e8e\u7b2c\u4e8c\u4e2a\u64cd\u4f5c\u4e5f\u5f88\u597d\u5904\u7406\uff0c\u76f4\u63a5\u4e0a\u7ebf\u6bb5\u6811\u7684\u533a\u95f4\u6c42\u548c\u5c31\u884c\u4e86\u3002\n\n\u5f53\u7136\u4f1a\u6709\u70b9\u5361\u5e38\uff0c\u8fd9\u4e2a\u65f6\u5019\u53ef\u4ee5\u5206\u5757\u9884\u5904\u7406\u4e00\u4e0b\u5e95\u6570\uff08\u56e0\u4e3a\u6a21\u6570\u5f88\u5c11\uff09\uff0c\u5c31\u80fd\u5c11\u6389\u4e00\u53ea $\\log$\uff0c\u5c31\u53ef\u4ee5\u8fc7\u4e86\u3002\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define lc(x) (x<<1)\n#define rc(x) ((x<<1)|1)\n#define Mm int mid=(l+r)>>1\ntypedef long long LL;\nchar buf[1<<21],*p1=buf,*p2=buf;\n#define getchar() (p1==p2 && (p2=(p1=buf)+fread(buf,1,1<<21,stdin),p1==p2)?EOF:*p1++)\nLL read()\n{\n\tLL x=0,f=1;\n\tchar c=getchar();\n\twhile(c<'0' || c>'9')\n\t{\n\t\tif(c=='-')\tf=-1;\n\t\tc=getchar();\n\t}\n\twhile(c>='0' && c<='9')\tx=(x<<1)+(x<<3)+(c^'0'),c=getchar();\n\treturn x*f;\n}\nvoid write(LL x)\n{\n\tif(x<0)\tputchar('-'),x=-x;\n\tif(x>9)\twrite(x/10);\n\tputchar(x%10+'0');\n}\nLL Eular(LL n)\n{\n\tLL ans=n;\n\tfor(LL i=2;i*i<=n;++i)\n\t{\n\t\tif(n%i==0)\n\t\t{\n\t\t\tans-=ans/i;\n\t\t\twhile(n%i==0)\tn/=i;\n\t\t}\n\t}\n\tif(n>1)\tans-=ans/n;\n\treturn ans;\n}\nLL n,m,p,c,a[50005],sum[400005],minn[400005],modifyUpper,phi[10005],pre1[50005][45],pre2[50005][45];\nbool flag,mdl1[10005][45],mdl2[10005][45];\nLL QuickPow(LL x,LL pp,LL mod)\n{\n\tLL base=x,ans=1;\n\twhile(pp)\n\t{\n\t\tif(pp&1)\tans*=base,flag|=(ans>=mod),ans%=mod;\n\t\tpp>>=1;\n\t\tbase*=base;\n\t\tif(pp && base>=mod)\tflag=true;\n\t\tbase%=mod;\n\t}\n\treturn ans;\n}\nvoid gsmPrepare()\n{\n\tfor(int i=0;i<=modifyUpper;++i)\n\t{\n\t\tpre1[0][i]=1;\n\t\tfor(int j=1;j<=10000;++j)\n\t\t{\n\t\t\tpre1[j][i]=pre1[j-1][i]*c;\n\t\t\tif(pre1[j][i]>=phi[i])\tpre1[j][i]%=phi[i],mdl1[j][i]=true;\n\t\t\tmdl1[j][i]|=mdl1[j-1][i];\n\t\t}\n\t}\n\tfor(int i=0;i<=modifyUpper;++i)\n\t{\n\t\tpre2[0][i]=1;\n\t\tfor(int j=1;j<=10000;++j)\n\t\t{\n\t\t\tpre2[j][i]=pre2[j-1][i]*pre1[10000][i];\n\t\t\tif(pre2[j][i]>=phi[i])\tpre2[j][i]%=phi[i],mdl2[j][i]=true;\n\t\t\tmdl2[j][i]|=mdl2[j-1][i];\n\t\t}\n\t}\n}\nLL asFastasWXK_QuickPow(LL x,LL pp)\n{\n\tflag=false;\n\tLL s=x%10000,t=x/10000,ans=pre1[s][pp]*pre2[t][pp];\n\tif(ans>=phi[pp])\tans%=phi[pp],flag=true;\n\tflag|=(mdl1[s][pp]|mdl2[s][pp]);\n\treturn ans;\n}\nLL dfs(LL now,LL dep,LL upper)\n{\n\tflag=false;\n\tif(upper==dep)\n\t{\n\t\tif(now>=phi[dep])\tflag=true,now%=phi[dep];\n\t\treturn now;\n\t}\n\tLL ans=dfs(now,dep+1,upper),k=ans+(flag?phi[dep+1]:0);\n\tflag=false;\n\treturn asFastasWXK_QuickPow(k,dep);\n}\nvoid build(LL l,LL r,LL now)\n{\n\tif(l==r)\n\t{\n\t\tsum[now]=a[l];\n\t\treturn ;\n\t}\n\tMm;\n\tbuild(l,mid,lc(now));\n\tbuild(mid+1,r,rc(now));\n\tsum[now]=(sum[lc(now)]+sum[rc(now)])%p;\n}\nvoid modify(LL l,LL r,LL x,LL y,LL now)\n{\n\tif(minn[now]>=modifyUpper)\treturn ;\n\tif(l==r)\n\t{\n\t\t++minn[now];\n\t\tsum[now]=dfs(a[l],0,minn[now]);\n\t\treturn ;\n\t}\n\tMm;\n\tif(x<=mid)\tmodify(l,mid,x,y,lc(now));\n\tif(mid+1<=y)\tmodify(mid+1,r,x,y,rc(now));\n\tsum[now]=(sum[lc(now)]+sum[rc(now)])%p;\n\tminn[now]=min(minn[lc(now)],minn[rc(now)]);\n}\nLL query(LL l,LL r,LL x,LL y,LL now)\n{\n\tif(x<=l && r<=y)\treturn sum[now];\n\tMm;\n\tLL ans=0;\n\tif(x<=mid)\tans+=query(l,mid,x,y,lc(now)),ans%=p;\n\tif(mid+1<=y)\tans+=query(mid+1,r,x,y,rc(now)),ans%=p;\n\treturn ans;\n}\nint main(){\n\tn=read(),m=read(),p=read(),c=read();\n\tLL tmp=p;\n\tphi[0]=p; \n\twhile(tmp!=1)\ttmp=Eular(tmp),phi[++modifyUpper]=tmp;\n\tphi[++modifyUpper]=1;\n\tgsmPrepare();\n\tfor(LL i=1;i<=n;++i)\ta[i]=read();\n\tbuild(1,n,1);\n\twhile(m-->0)\n\t{\n\t\tLL op=read(),l=read(),r=read();\n\t\tif(!op)\tmodify(1,n,l,r,1);\n\t\telse\twrite(query(1,n,l,r,1)),puts(\"\");\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1596615674,
        "uid": 184977,
        "name": "pomelo_nene",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3747 \u3010[\u516d\u7701\u8054\u80032017]\u76f8\u9022\u662f\u95ee\u5019\u3011"
    },
    {
        "content": "# \u76f8\u9022\u662f\u95ee\u5019\n[\u9898\u76ee\u4f20\u9001\u95e8](https://www.luogu.com.cn/problem/P3747)\n## \u601d\u8def\n\u62d6\u4e86\u51e0\u4e2a\u6708\uff0c\u7136\u540e\u809d\u4e86\u4e00\u4e0a\u5348\u7ec8\u4e8e\u628a\u8fd9\u9053\u9898\u809d\u51fa\u6765\u4e86\uff0c\u53d1\u7bc7\u9898\u89e3\u7eaa\u5ff5\u4e00\u4e0b\u3002\u3002\u3002\n\n\u9996\u5148\uff0c\u6211\u4eec\u89c2\u5bdf\u8fd9\u4e2a\u5f0f\u5b50\u3002\u3002\u3002\u5b8c\u4e86\uff0c\u8fd9\u79cd\u73a9\u610f\u771f\u7684\u53ef\u4ee5\u7ef4\u62a4\u4e48\uff1f~~\u5403\u5c4e\u53bb\u5427\uff01\uff01\uff01~~\n\n\u7136\u540e\u6211\u4eec\u8054\u60f3\u8d77\u4e86\u4ee5\u524d\u7b2c\u4e00\u773c\u4e5f\u89c9\u5f97\u4e0d\u53ef\u505a\u7684\u4e00\u9053\u9898:[\u4e0a\u5e1d\u4e0e\u96c6\u5408\u7684\u6b63\u786e\u7528\u6cd5](https://www.luogu.com.cn/problem/P4139),\u7136\u540e\u6211\u4eec\u60f3\u8d77\u4e86\u62d3\u5c55\u6b27\u62c9\u5b9a\u7406\u3002\u54a6\uff0c\u8fd9\u91cc\u80fd\u7528\u4e48\uff1f\u7b54\u6848\u662f\uff0c\u53ef\u4ee5\u7684\u3002\n\n\u4e3e\u4e2a\u4f8b\u5b50\uff1a\n\n$$c^{c^x}\\equiv c^{c^{x mod \\phi(p)+\\phi(p)}\\phi(p)+\\phi(p)} (mod p)$$\n\n\u7136\u540e\uff0c\u6211\u4eec\u5c31\u53d1\u73b0\uff0c\u4e00\u65e6\u8fd9\u79cd\u5d4c\u5957\u5d4c\u5957\u591a\u4e86\uff0c\u5c31\u4f1a\u53d8\u6210\u8fd9\u6837:\n\n$$c^{.^{.^{.^{.^{.^{.}}}}}mod \\phi(\\phi(\\phi(...)))+\\phi(\\phi(\\phi(...)))}$$\n\n\u4e8e\u662f\u5f53$\\phi(\\phi(\\phi(...)))\\equiv 1(mod\\ \\ p)$\u7684\u65f6\u5019\u5c31\u4e0d\u4f1a\u4ea7\u751f\u5176\u4f59\u7684\u5f71\u54cd\u4e86\u3002\u6211\u4eec\u53ef\u4ee5\u9884\u5904\u7406\u51fa\u6700\u591a\u6709\u591a\u5c11\u5c42\uff0c\u5c31\u6682\u4e14\u8bbe\u4e3a$x$\u3002\n\n\u7136\u540e\u600e\u4e48\u529e\u5462\uff1f\u6211\u4eec\u53d1\u73b0\u6700\u591a\u53ea\u4f1a\u6709$\\log $\u5c42\uff0c\u4e8e\u662f\u6211\u4eec\u53c8\u8054\u60f3\u5230\u4e86\u8fd9\u9053\u9898:[\u4e0a\u5e1d\u9020\u9898\u7684\u4e03\u5206\u949f2 / \u82b1\u795e\u6e38\u5386\u5404\u56fd](https://www.luogu.com.cn/problem/P4145)\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u4e00\u4e0b\u533a\u95f4\u6700\u5c0f\u7684\u70b9\u4fee\u6539\u6b21\u6570\u4ee5\u53ca\u533a\u95f4\u548c\uff0c\u5982\u679c\u8fde\u5b83\u90fd\u5927\u4e8e$x$,\u90a3\u4e48\u663e\u7136\u6211\u4eec\u5c31\u4e0d\u7528\u4fee\u6539\u4e86\u3002\u5426\u5219\uff0c\u6211\u4eec\u5c31\u76f4\u63a5\u66b4\u529b\u4fee\u6539\u6bcf\u4e2a\u70b9\u3002\n\n\u4e0d\u8fc7\u8fd9\u6837\u505a\u7684\u8bdd\u53ea\u80fd\u5f97\u5230$90$\u5206\u3002\u600e\u4e48\u529e\u5462\uff1f\u6211\u4eec\u53d1\u73b0\u5feb\u901f\u5e42\u7684\u5e95\u6570\u4e00\u76f4\u90fd\u662f$c$,\u800c\u4e14\u6307\u6570\u5b9e\u9645\u4e0a\u6700\u591a$10^8$,\u4e8e\u662f\u6211\u4eec\u5206\u6210\u4e24\u6bb5\u9884\u5904\u7406\uff0c\u4e00\u6bb5\u662f$c^{0,1,2,3...}mod\\ \\ \\phi$,\u53e6\u4e00\u6bb5\u662f$c^{0,10000,20000,30000,...}mod\\ \\ phi$\u3002\n\n\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u62d3\u5c55\u6b27\u62c9\u5b9a\u7406\u53ea\u5728\u6307\u6570\u5927\u4e8e$\\phi$\u7684\u65f6\u5019\u6210\u7acb\uff0c\u6240\u4ee5\u9700\u8981\u5224\u65ad\u3002\n## $\\text {Code}$\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n\n#define Int register int\n#define MAXN 50005\n\nint n,m,p,c,f,ci;\nint val[MAXN],pow1[55][10005],pow2[55][10005];\n\nbool b1[55][10005],b2[55][10005];\n\nint tot;\nint phi[MAXN],prime[MAXN];\n\nbool vis[MAXN];\n\nvoid prework ()\n{\n\tfor (Int i = 0;i <= ci;++ i)\n\t{\n\t\tpow1[i][0] = 1;\n\t\tfor (Int j = 1;j <= 10000;++ j)\n\t\t{\n\t\t\tpow1[i][j] = 1ll * pow1[i][j - 1] * c % phi[i];\n\t\t\tb1[i][j] = b1[i][j - 1] | (1ll * pow1[i][j - 1] * c >= phi[i]);\n\t\t}\n\t}\n\tfor (Int i = 0;i <= ci;++ i)\n\t{\n\t\tpow2[i][0] = 1;\n\t\tfor (Int j = 1;j <= 10000;++ j)\n\t\t{\n\t\t\tpow2[i][j] = 1ll * pow2[i][j - 1] * pow1[i][10000] % phi[i];\n\t\t\tb2[i][j] = b2[i][j - 1] | (1ll * pow2[i][j - 1] * pow1[i][10000] >= phi[i]);\n\t\t}\n\t}\n}\n\nstruct Node\n{\n\tint l,r,tag,sum;//tag\u8868\u793a\u8fd9\u6bb5\u533a\u95f4\u7684\u70b9\u4e2d\u6700\u5c0f\u4fee\u6539\u6b21\u6570\uff0csum\u8868\u793a\u533a\u95f4\u548c \n}tree[MAXN << 2];\n\nvoid Pushup (int i)\n{\n\ttree[i].tag = min (tree[i << 1].tag,tree[i << 1 | 1].tag);\n\ttree[i].sum = (tree[i << 1].sum + tree[i << 1 | 1].sum) % p;\n}\n\nint Phi (int x)\n{\n\tint temp = x;\n\tfor (Int i = 1;i <= tot && prime[i] * prime[i] <= x;++ i)\n\t{\n\t\tif (x % prime[i] == 0)\n\t\t{\n\t\t\ttemp = temp / prime[i] * (prime[i] - 1);\n\t\t\twhile (x % prime[i] == 0) x /= prime[i];\n\t\t}\n\t}\t\n\tif (x > 1) temp = temp / x * (x - 1);\n\treturn temp;\n}\n\nvoid Prime ()\n{\n\tfor (Int i = 2;i <= 10000;++ i)\n\t{\n\t\tif (!vis[i]) prime[++ tot] = i;\n\t\tfor (Int j = 1;j <= tot && i * prime[j] <= 10000;++ j)\n\t\t{\n\t\t\tvis[i * prime[j]] = 1;\n\t\t\tif (i % prime[j] == 0) break;\n\t\t}\n\t}\n\tphi[ci] = p;\n\twhile (phi[ci] != 1) ++ ci,phi[ci] = Phi (phi[ci - 1]);\n\tphi[++ ci] = 1;\n}\n\nint quick_pow (int b,int id)\n{\n\tf = 0;\n\tint v1 = b % 10000,v2 = b / 10000,res = 1ll * pow1[id][v1] * pow2[id][v2] % phi[id];\n\tif (1ll * pow1[id][v1] * pow2[id][v2] >= phi[id]) f = 1;\n\tf |= b1[id][v1] | b2[id][v2];\n\treturn res;\n}\n\nint C (int a,int x)\n{\n\tint tmp = a;\n\tif (tmp > phi[x]) tmp = tmp % phi[x] + phi[x];\n\tfor (Int i = x;i;-- i)\n\t{\n\t\tf = 0;\n\t\ttmp = quick_pow (tmp,i - 1);\n\t\tif (f) tmp += phi[i - 1],f = 0;\n\t}\n\treturn tmp;\n}\n\nvoid build (int i,int l,int r)\n{\n\ttree[i].l = l,tree[i].r = r;\n\tif (l == r) return tree[i].sum = val[l],void ();\n\tint mid = (l + r) >> 1;\n\tbuild (i << 1,l,mid),build (i << 1 | 1,mid + 1,r);\n\tPushup (i);\n}\n\nvoid update (int i,int l,int r)\n{\n\tif (tree[i].tag >= ci) return ;\n\tif (tree[i].l > r || l > tree[i].r) return ;\n\tif (tree[i].l == tree[i].r)\n\t{\n\t\ttree[i].sum = C (val[tree[i].l],++ tree[i].tag);\n\t\treturn ;\n\t}\n\tupdate (i << 1,l,r);\n\tupdate (i << 1 | 1,l,r);\n\tPushup (i);\n}\n\nint query (int i,int l,int r)\n{\n\tif (tree[i].l > r || l > tree[i].r) return 0;\n\tif (tree[i].l >= l && tree[i].r <= r) return tree[i].sum;\n\treturn (query (i << 1,l,r) + query (i << 1 | 1,l,r)) % p;\n}\n\ntemplate <typename T> inline void read (T &t){t = 0;char c = getchar();int f = 1;while (c < '0' || c > '9'){if (c == '-') f = -f;c = getchar();}while (c >= '0' && c <= '9'){t = (t << 3) + (t << 1) + c - '0';c = getchar();} t *= f;}\ntemplate <typename T,typename ... Args> inline void read (T &t,Args&... args){read (t);read (args...);}\ntemplate <typename T> inline void write (T x){if (x < 0){x = -x;putchar ('-');}if (x > 9) write (x / 10);putchar (x % 10 + '0');}\n\nsigned main()\n{\n\tread (n,m,p,c);\n\tfor (Int i = 1;i <= n;++ i) read (val[i]);\n\tbuild (1,1,n);\n\tPrime ();\n\tprework ();\n\twhile (m --)\n\t{\n\t\tint type,l,r;\n\t\tread (type,l,r);\n\t\tif (type == 0) update (1,l,r);\n\t\telse write (query (1,l,r)),putchar ('\\n');\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1585987227,
        "uid": 124781,
        "name": "Walking_Dead",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3747 \u3010[\u516d\u7701\u8054\u80032017]\u76f8\u9022\u662f\u95ee\u5019\u3011"
    },
    {
        "content": "\u66f4\u597d\u7684\u9605\u8bfb\u4f53\u9a8c\u70b9[\u8fd9\u91cc](https://wa-automaton.github.io/2019/03/18/%E4%B9%9D%E7%9C%81%E8%81%94%E8%80%832018-%E7%9B%B8%E9%80%A2%E6%98%AF%E9%97%AE%E5%80%99/)~\n## \u9898\u76ee\u5927\u610f\n> Informatik verbindet dich und mich.  \n> \u4fe1\u606f\u5c06\u4f60\u6211\u8fde\u7ed3\u3002 \n\n\u7ef4\u62a4\u4e00\u4e2a\u6570\u5217A\uff0c\u652f\u6301\u4e24\u79cd\u64cd\u4f5c\uff1a\n* 0 l r \uff1a\u8868\u793a\u5c06A[l..r]\u8fd9\u4e2a\u533a\u95f4\u7684\u6bcf\u4e2a\u6570$A_i$\u53d8\u6210$c^{A_i}$\uff08c\u662f\u8f93\u5165\u7ed9\u5b9a\u7684\u5e38\u91cf\uff09\n* 1 l r : \u8868\u793a\u6c42$A[l..r]$\u7684\u548c\uff0c\u7ed3\u679c\u5bf9p\uff08\u8f93\u5165\u7ed9\u5b9a\u7684\u5e38\u91cf\uff09\u53d6\u6a21\u3002\n\n## \u6570\u636e\u8303\u56f4\u4e0e\u7ea6\u5b9a\n* \u5bf9\u4e8e 100% \u7684\u6d4b\u8bd5\u70b9\uff0c $1 \\leq n \\leq 50000; 1 \\leq m \\leq 50000; 1 \\leq p \\leq 100000000; 0 < c <p; 0 \\leq ai < p$\u3002\n\n## \u89e3\u6cd5\n\u89c2\u5bdf\u6570\u636e\u8303\u56f4\uff0c$n,m\\leq 50000$\u3002\u8fd9\u4e2a~~\u4e0d\u4f26\u4e0d\u7c7b\u7684~~\u8303\u56f4\u5e94\u8be5\u662f$O(n \\log n \\log C)$\u4e4b\u7c7b\u7684\u5427\uff1f  \n\u8fd8\u6709\u533a\u95f4\u6c42\u548c...?\u7ebf\u6bb5\u6811\uff1f  \n\u4e0d\u77e5\u9053\u5927\u5bb6\u6709\u6ca1\u6709\u505a\u8fc7\u7ebf\u6bb5\u6811\u533a\u95f4\u53d6\u6a21\u548c\u533a\u95f4\u5f00\u65b9\u4e4b\u7c7b\u7ef4\u62a4\u5947\u602a\u8fd0\u7b97\u7684\u9898\uff1f\u5b83\u4eec\u6709\u4e00\u4e2a\u5171\u540c\u70b9\uff1a\u66b4\u529b\u9012\u5f52\u5230\u53f6\u5b50\u8282\u70b9\u4fee\u6539\uff0c\u56e0\u4e3a\u8fd0\u7b97\u7684\u7279\u6b8a\u6027\u8d28\u51b3\u5b9a\u4e86\u4fee\u6539\u6b21\u6570\u4e0d\u8d85\u8fc7$O(n\\log C)$\uff0c\u6240\u4ee5\u590d\u6742\u5ea6\u6b63\u786e\u3002\n\u8003\u8651\u8fd9\u4e2a\u5947\u602a\u7684\u8fd0\u7b97\u3002\u73b0\u5728\u6211\u4eec\u8981\u89e3\u51b3\u7684\u95ee\u9898\u5c31\u662f\u5982\u4f55\u5feb\u901f\uff08$O(\\log\\ n)$\u4ee5\u5185\uff09\u6c42\u8fd9\u4e2a\uff1a\n$$\\LARGE{c^{c^{c^{c^{...a_i}}}}}$$\n\u4e0d\u77e5\u9053\u60a8\u6709\u6ca1\u6709\u505a\u8fc7[\u8fd9\u4e2a\u9898](https://www.luogu.org/problemnew/show/P4139)\uff0c\u5982\u679c\u6ca1\u6709\u73c2\u4ee5\u53bb\u505a\u4e00\u4e0bqwq.  \n\u505a\u5b8c\u4e86\u5427\uff1f\u90a3\u73b0\u5728\u60a8\u4e00\u5b9a\u4f1a\u4e86\u6b27\u62c9\u5b9a\u7406\uff1a  \n$$a^b \\bmod p=\\left \\{  \\begin{aligned}  &a^{b \\bmod \\phi (p) +\\phi(p)} &b\\geq \\phi (p)\\\\  &a^b &b<\\phi (p)  \\end{aligned} \\right.  $$\n\n> \u5f15\u7406\uff1a\u5bf9\u4e8e\u4e00\u4e2a\u6570$n\\in \\mathbb N^*$\uff0c\u4e00\u76f4\u53d6$\\phi (n)$,\u6700\u591a\u53d6$O(\\log n)$\u6b21\u5c31\u4f1a\u53d8\u62101.  \n> \u7b80\u8981\u8bc1\u660e\uff1a\u5bf9\u4e8e\u5076\u6570\uff0c\u6240\u6709\u5076\u6570\u90fd\u4e0e\u5b83\u4e0d\u4e92\u8d28\u3002\u53d6$\\phi (n)$\u81f3\u5c11\u4f1a\u9664\u4ee52.\u5bf9\u4e8e\u5947\u6570\uff0c\u8003\u8651\u5b9a\u4e49\u5f0f\uff0c\u5b83\u4e00\u5b9a\u4f1a\u53d8\u6210\u5076\u6570\u3002\u6240\u4ee5\u6700\u591a$2\\log n$\u6b21\u4f1a\u53d8\u62101.\n\n\u6240\u4ee5\u5f53\u4fee\u6539\u6b21\u6570\u592a\u5927\u7684\u65f6\u5019\uff0c\u4ece\u67d0\u4e00\u5c42\u5f00\u59cb\uff0c\u6a21\u6570\u90fd\u662f1.\u8fd9\u5c31\u6ca1\u5fc5\u8981\u7b97\u4e86\u3002\u6240\u4ee5\u7528\u533a\u95f4\u5f00\u65b9\u7684\u601d\u8def\uff0c\u7ebf\u6bb5\u6811\u8bb0\u5f55\u533a\u95f4\u548c\u3001\u533a\u95f4\u4fee\u6539\u6b21\u6570\u3002\u4fee\u6539\u6b21\u6570\u8d85\u8fc7\u6700\u5927\u503c\u65f6\u5ffd\u7565\u4fee\u6539\u3002\u5426\u5219\u7ee7\u7eed\u9012\u5f52\u3002\u6bcf\u9012\u5f52\u5230\u53f6\u5b50\u8282\u70b9\u65f6\uff0c\u66b4\u529b\u4fee\u6539\u53f6\u5b50\u7684\u503c\u3002\u987a\u4fbf\u7ef4\u62a4\u533a\u95f4\u548c\u3002\u8fd9\u65f6\uff0c\u603b\u590d\u6742\u5ea6\u662f$O(n \\log^2 n\\log C)$\u7684\u3002\u4e0d\u592a\u80fd\u627f\u53d7\u3002\u4f46\u662f\u6211\u4eec\u53d1\u73b0\u8ba1\u7b97\u8fc7\u7a0b\u4e2d\u6a21\u6570\u53ea\u6709$O(\\log n)$\u79cd\u53d6\u503c\uff0c\u6240\u4ee5\u5149\u901f\u5e42\u9884\u5904\u7406\u4e00\u4e0b\uff0c\u5c31\u53ef\u4ee5\u5c11\u6389\u4e00\u4e2alog\u5566\u3002\u7136\u540e\u5c31\u73c2\u4ee5\u6109\u5feb\u5730\u901a\u8fc7\u672c\u9898\u5566\u3002\u6211\u4eba\u4e11\u81ea\u5e26\u5927\u5e38\u6570\uff0c\u6240\u4ee5\u597d\u50cf\u8fd8\u8981wys~~\u6216\u8005mcfx~~\u4e00\u4e0b\u4ee3\u7801\n## \u4ee3\u7801\uff1a\n\u7565\u4e11qwq\u89c1\u8c05\n```cpp\n#pragma GCC optimize(\"-Ofast\")\n#pragma GCC optimize(3)\n#include <cstdio>\n#include <cctype>\n#include <cmath>\n#include <utility>\n#define ls l,mid,o<<1\n#define rs mid+1,r,o<<1|1\n\nusing std::pair;\nusing std::make_pair;\n\ntypedef long long ll;\n\nconst int maxn=(5e4+100)*2;\n\nint a[maxn<<2],count[maxn<<2],P,c,maxlim;\nll sumv[maxn<<2];\nint phi[maxn],Sqrt[maxn];\n\nchar buf[1<<24],*fs;\nll c_sqrt[150][maxn],c_x[150][maxn];\nbool is_greater[100][maxn],is_greater_sqrt[100][maxn];\n\n// #define gc() getchar()\n#define gc() (*fs++)\n\ntemplate<class T>inline T max(T a,T b){return a<b?b:a;}\ntemplate<class T>inline T min(T a,T b){return a<b?a:b;}\n\ninline int read()\n{\n    char ch;\n    while (!isdigit(ch=gc()));\n    int x=ch^48;\n    while (isdigit(ch=gc())) x=x*10+ch-48;\n    return x;\n}\n\ninline pair<ll,bool> qpow(ll a,ll b,ll P)\n{\n    ll ans=1%P;\n    bool gr=false;\n    for (;b;b>>=1)\n    {\n        if (b&1) ans=ans*a;\n        if (ans>=P) ans%=P,gr=true;\n        a=a*a%P;\n    }\n    return make_pair(ans,gr);\n}\n\ninline void CalcPower(int x,int now)\n{\n    int T=Sqrt[now]=sqrt(x);\n    c_x[now][0]=1;c_x[now][1]=c;\n    c_sqrt[now][0]=1;pair<ll,bool> pr=qpow(c,T,x);c_sqrt[now][1]=pr.first;\n    if (c_x[now][1]>=x) is_greater[now][1]=true,c_x[now][1]%=x;\n    if (pr.second) is_greater_sqrt[now][1]=true;\n    if (c_x[now][0]>=x) is_greater[now][0]=true,c_x[now][0]%=x;\n    if (c_sqrt[now][0]>=x) is_greater_sqrt[now][0]=true,c_sqrt[now][0]%=x;\n    for (int i=2;i<=T*2;++i)\n    {\n        c_x[now][i]=c_x[now][i-1]*c;\n        c_sqrt[now][i]=c_sqrt[now][i-1]*c_sqrt[now][1];\n        if (c_x[now][i]>=x) is_greater[now][i]=true,c_x[now][i]%=x;\n        if (c_sqrt[now][i]>=x) is_greater_sqrt[now][i]=true,c_sqrt[now][i]%=x;\n    }\n}\n\ninline pair<ll,bool> Fastpow(int b,int now)\n{\n    ll t=c_x[now][b%Sqrt[now]]*c_sqrt[now][b/Sqrt[now]];\n    bool flag=is_greater[now][b%Sqrt[now]]|is_greater_sqrt[now][b/Sqrt[now]];\n    if (t>=phi[now]) flag=true,t%=phi[now];\n    return make_pair(t,flag);\n}\n\ninline int Getphi(int x)\n{\n    int ret=x;\n    for (int i=2;i<=x;++i)\n    {\n        if (x%i==0)\n        {\n            while (x%i==0) x/=i;\n            ret=ret/i*(i-1);\n        }\n    }\n    if (x>1) ret=ret/x*(x-1);\n    return ret;\n}\n\ninline void Prework(int P,int i=1)\n{\n    ++maxlim;\n    if (P==1) phi[i]=1;\n    CalcPower(phi[i]=Getphi(P),i);\n    if (P==1) return;\n    Prework(phi[i],i+1);\n}\n\ninline ll CalcNumber(int expo,int depth,int limit)\n{\n    // if (phi[depth-1]==1) return 0;\n    if (depth==limit+1) return expo>phi[limit]?expo%phi[limit]+phi[limit]:expo;\n    int t=CalcNumber(expo,depth+1,limit);\n    pair<ll,bool> pr=Fastpow(t,depth-1);\n    // printf(\"depth=%d ,exp=%d\\n\",depth,pr.second?pr.first+phi[depth-1]:pr.first);\n    if (pr.second==1) return pr.first+phi[depth-1];\n    return pr.first;\n}\n\ninline void Pushup(int o)\n{\n    sumv[o]=sumv[o<<1]+sumv[o<<1|1];\n    if (sumv[o]>=P) sumv[o]-=P;\n}\n\ninline void BuildSeg(int l,int r,int o)\n{\n    if (l==r) return void(sumv[o]=a[l]);\n    int mid=(l+r)>>1;\n    BuildSeg(ls);BuildSeg(rs);\n    Pushup(o);\n}\n\ninline void Modify(int L,int R,int l,int r,int o)\n{\n    if (count[o]>=maxlim) return;\n    if (l==r)\n    {\n        ++count[o];\n        sumv[o]=CalcNumber(a[l],1,count[o])%P;\n        // printf(\"pos=%d num=%d\\n\",l,sumv[o]);\n        return;\n    }\n    int mid=(l+r)>>1;\n    if (L<=mid) Modify(L,R,ls);\n    if (R> mid) Modify(L,R,rs);\n    Pushup(o);\n    count[o]=min(count[o<<1],count[o<<1|1]);\n}\n\ninline int Query(int L,int R,int l,int r,int o)\n{\n    if (L<=l && R>=r) return sumv[o];\n    int mid=(l+r)>>1;\n    int tot=0;\n    if (L<=mid) tot+=Query(L,R,ls);\n    if (R> mid) tot+=Query(L,R,rs);\n    if (tot>=P) tot-=P;\n    return tot;\n}\n\nint main()\n{\n    fread(fs=buf,1,1<<24,stdin);\n    int n=read(),m=read();phi[0]=P=read(),c=read();Sqrt[0]=sqrt(P);\n    CalcPower(P,0);\n    for (int i=1;i<=n;++i) a[i]=read();\n    Prework(P);BuildSeg(1,n,1);\n    for (int i=1,opt,l,r;i<=m;++i)\n    {\n        opt=read();l=read();r=read();\n        if (opt) printf(\"%d\\n\",Query(l,r,1,n,1));\n        else Modify(l,r,1,n,1);\n    }\n}\n```",
        "postTime": 1552894830,
        "uid": 48711,
        "name": "_WA\u81ea\u52a8\u673a",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 P3747 \u3010[\u516d\u7701\u8054\u80032017]\u76f8\u9022\u662f\u95ee\u5019\u3011"
    },
    {
        "content": "\u6c34\u4e00\u6ce2Pascal\u9898\u89e3~~~\n\n\u8fd9\u9898\uff0c\u89e3\u6cd5\u5177\u4f53\u7684\u4e0d\u8bf4\u4e86\u3002\u53e6\u5916\u4e24\u4e2a\u5927\u4f6c\u5df2\u7ecf\u8bf4\u7684\u5f88\u6e05\u695a\u4e86\u3002\n\n\u6b64\u9898\uff0c\u663e\u7136\u7528\u6269\u5c55\u6b27\u62c9\u5b9a\u7406\u964d\u5e42\u3002\n\n\u56e0\u4e3a$\\phi(\\phi(\\dots))=1$\uff0c\u6240\u4ee5\u5982\u679c\u6ca1\u51e0\u9879\u5c31\u66b4\u529b\u5904\u7406\uff0c\u5230\u4e86\u8fb9\u754c\u5c31\u4e0d\u7528\u7ba1\u4e86\u3002\n\n\u6b64\u5916\uff0c\u8981\u6ce8\u610f\u7684\u5c31\u662f\u5224\u65ad\u662f\u5426\u8981\u52a0\u4e0a$\\phi(p)$\u3002\n\n\u4e00\u9879\u4e00\u9879\u6c42$\\phi(\\phi(\\dots))$\u7684\u65f6\u5019\uff0c\u6700\u540e\u8fd8\u8981\u52a0\u4e0a\u4e00\u4e2a$1$\uff0c\u9632\u6b62\u8fb9\u754c\u51fa\u95ee\u9898\u3002\n\n\u6c42\u89e3\u5e42\u7684\u65f6\u5019\uff0c\u5206\u5757\u62fc\u51d1\uff0c\u4e0d\u7136\u5c31\u4f1a\u50cf\u67d0\u4f4d\u5927\u4f6c\u4e00\u683780\u5206\u3002\n\n\u4ee3\u7801\uff1a\n\n```pas\nvar\n  a:array[1..50000]of longint; //\u539f\u6765\u7684\u6570\u503c\n  s,t:array[1..200000]of longint;//\u7ef4\u62a4\u4e24\u9897\u7ebf\u6bb5\u6811\uff1as\u662f\u6c42\u548c\uff0ct\u662f\u6c42\u6700\u5c0f\u503c\uff0ct\u7528\u6765\u68c0\u67e5\u8fb9\u754c\u6761\u4ef6\n  rp:array[0..100]of longint;  //\u03c6(p),\u03c6(\u03c6(p)),...,1\n  p1,p2:array[0..100,0..10000]of int64;//\u5206\u5757\u62fc\u51d1\u7684\u6570\u503c\n  b1,b2:array[0..100,0..10000]of boolean;//\u662f\u5426\u5bf9\u03c6(p)\u53d6\u6a21\u8fc7\n  n,m,p,c,i,x,l,r,num:longint; //num\u662f\u03c6(\u03c6(...))\u6709\u51e0\u4e2a\n  b:boolean;                   //\u8fd9\u4e2a\u50a8\u5b58\u662f\u5426mod\u8fc7\u03c6(p)\nfunction min(x,y:longint):longint;//\u4e0d\u89e3\u91ca\nbegin\n  if x<y then\n    exit(x)\n  else\n    exit(y);\nend;\nfunction phi(x:longint):longint;//\u66b4\u529b\u6c42\u03c6(i)\nvar\n  i:longint;\nbegin\n  phi:=x;\n  for i:=2 to trunc(sqrt(x)) do\n    if x mod i=0 then\n    begin\n      dec(phi,phi div i);\n      while x mod i=0 do\n        x:=x div i;\n    end;\n  if x>1 then\n    dec(phi,phi div x);\nend;\nprocedure init;                //\u9884\u5904\u7406\nvar\n  i,j:longint;\nbegin\n  num:=0;\n  rp[0]:=p;\n  while rp[num]>1 do           //\u5904\u7406\u03c6(p),\u03c6(\u03c6(p)),...\n  begin\n    inc(num);\n    rp[num]:=phi(rp[num-1]);\n  end;\n  inc(num);                    //\u6ce8\u610f\uff1a\u4e00\u5b9a\u8981\u518d\u52a0\u4e00\u4e2a1\n  rp[num]:=1;\n  for i:=0 to num do           //\u5904\u7406\u5206\u5757\u62fc\u51d1\uff0c\u5199\u7684\u5f88\u4e11\uff08\u4e0d\u8fc7\u5e94\u8be5\u53ef\u4ee5\u7406\u89e3\uff09\n  begin                        //\uff08\u5f3a\u5236\u7c7b\u578b\u8f6c\u6362\u8fd9\u4e48\u591a\u5f53\u7136\u5f88\u4e11\uff09\n    p1[i,0]:=1;\n    b1[i,0]:=false;\n    for j:=1 to 10000 do\n    begin\n      p1[i,j]:=p1[i,j-1]*c;\n      if p1[i,j]>=rp[i] then\n      begin\n        p1[i,j]:=p1[i,j] mod rp[i];\n        b1[i,j]:=true;\n      end\n      else\n        b1[i,j]:=b1[i,j-1];\n    end;\n    p2[i,0]:=1;\n    b2[i,0]:=false;\n    p2[i,1]:=p1[i,10000];\n    b2[i,1]:=b1[i,10000];\n    for j:=2 to 10000 do\n    begin\n      p2[i,j]:=p2[i,j-1]*p2[i,1];\n      if p2[i,j]>=rp[i] then\n      begin\n        p2[i,j]:=p2[i,j] mod rp[i];\n        b2[i,j]:=true;\n      end\n      else\n        b2[i,j]:=b2[i,j-1];\n    end;\n  end;\nend;\nfunction power(x,p:longint):int64;//\u5206\u5757\u62fc\u51d1\u7684kasumi\uff0c\u987a\u4fbf\u5904\u7406b\nbegin\n  b:=false;\n  power:=p1[p,x mod 10000]*p2[p,x div 10000];\n  if power>=rp[p] then\n  begin\n    power:=power mod rp[p];\n    b:=true;\n  end\n  else\n    b:=b1[p,x mod 10000] or b2[p,x div 10000];\nend;\nfunction solve(x,y:longint):longint;//\u6c42\u89e3\u95ee\u9898\nvar\n  i:longint;\nbegin\n  solve:=x;\n  if solve>rp[y] then\n    solve:=solve mod rp[y]+rp[y];\n  for i:=y-1 downto 0 do\n  begin\n    solve:=power(solve,i);\n    if b then\n      solve:=solve+rp[i];\n  end;\n  solve:=solve mod p;\nend;\nprocedure pushup(x:longint);   //\u7ebf\u6bb5\u6811\u6ca1\u4ec0\u4e48\u53ef\u4ee5\u8bf4\u7684\nbegin\n  s[x]:=(s[x shl 1]+s[x shl 1 or 1]) mod p;\n  t[x]:=min(t[x shl 1],t[x shl 1 or 1]);\nend;\nprocedure build(l,r,x:longint);\nbegin\n  if l=r then\n  begin\n    s[x]:=a[l];\n    t[x]:=0;\n    exit;\n  end;\n  build(l,(l+r) shr 1,x shl 1);\n  build((l+r) shr 1+1,r,x shl 1 or 1);\n  pushup(x);\nend;\nprocedure update(l,r,tl,tr,x:longint);\nbegin\n  if t[x]=num then             //\u526a\u679d\u526a\u6389\u4e0d\u9700\u8981\u5904\u7406\u7684\u533a\u95f4\n    exit;\n  if l=r then\n  begin\n    inc(t[x]);\n    s[x]:=solve(a[l],t[x]);    //\u6bcf\u6b21\u90fd\u66b4\u529b\u6c42\u89e3\n    exit;\n  end;\n  if tl<=(l+r) shr 1 then\n    update(l,(l+r) shr 1,tl,tr,x shl 1);\n  if tr>(l+r) shr 1 then\n    update((l+r) shr 1+1,r,tl,tr,x shl 1 or 1);\n  pushup(x);\nend;\nfunction query(l,r,tl,tr,x:longint):int64;\nbegin\n  if (l>=tl) and (r<=tr) then\n    exit(s[x]);\n  query:=0;\n  if tl<=(l+r) shr 1 then\n    query:=query(l,(l+r) shr 1,tl,tr,x shl 1);\n  if tr>(l+r) shr 1 then\n    query:=(query+query((l+r) shr 1+1,r,tl,tr,x shl 1 or 1)) mod p;\n  pushup(x);\nend;\nbegin                          //\u4e3b\u7a0b\u5e8f\u6ca1\u4ec0\u4e48\u597d\u8bf4\u7684\n  read(n,m,p,c);\n  init;\n  for i:=1 to n do\n    read(a[i]);\n  build(1,n,1);\n  for i:=1 to m do\n  begin\n    read(x,l,r);\n    if x=0 then\n      update(1,n,l,r,1)\n    else\n      writeln(query(1,n,l,r,1));\n  end;\nend.\n```",
        "postTime": 1548740087,
        "uid": 40241,
        "name": "dblark",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3747 \u3010[\u516d\u7701\u8054\u80032017]\u76f8\u9022\u662f\u95ee\u5019\u3011"
    }
]