[
    {
        "content": "> [P9138 [THUPC 2023 \u521d\u8d5b] \u516c\u5e73\u5408\u4f5c](https://www.luogu.com.cn/problem/P9138)\n\n\u5957\u8def\u9898\uff0c\u4f46\u662f\u5b66\u5230\u5f88\u591a\u3002\n\n\u8bbe\u5148\u624b\u548c\u540e\u624b\u9009\u62e9\u7684\u5bb9\u5668\u7684\u4f53\u79ef\u4e4b\u548c\u5206\u522b\u4e3a $X$ \u548c $Y$\u3002\u5f88\u660e\u663e\uff0c\u540e\u624b\u53ef\u4ee5\u6839\u636e\u5148\u624b\u7684\u51b3\u7b56\u6765\u51b3\u7b56\uff0c\u4e14\u7b56\u7565\u552f\u4e00\uff1a\u4e0d\u65ad\u9009\u62e9\u5bb9\u5668\u76f4\u5230 $Y > X$\u3002\n\n\u8bbe $f_{i, j}$ \u8868\u793a\u8981\u6c42\u4f53\u79ef\u548c\u5927\u4e8e $i$ \u7684\u524d\u63d0\u4e0b\uff0c\u4f53\u79ef\u548c\u4e3a $j$ \u7684\u6982\u7387\uff0c\u4e14 $j$ \u662f\u7b2c\u4e00\u6b21\u4f53\u79ef\u548c\u5927\u4e8e $i$\u3002\u5176\u7b49\u4ef7\u4e8e $X = i$ \u65f6\uff0c$Y = j$ \u7684\u6982\u7387\u3002\u521d\u59cb $f_{i, 0} = 1$\uff08$i < 0$\uff09\u3002\u4ece $f_{i - 1}\\to f_i$ \u65f6\uff0c\u5c06 $f_{i - 1, i}$ \u4e58\u4ee5 $\\frac 1 n$ \u8f6c\u79fb\u5230\u6240\u6709 $f_{i, i + a_j}$\u3002\u663e\u7136\uff0c\u5bf9\u4e8e\u4efb\u610f $f_i$\uff0c\u5176\u6709\u503c\u7684\u957f\u5ea6\u4e3a $m = \\max a_i$\u3002\n\n\u8bbe $p_i$ \u8868\u793a\u5f53 $X = i$ \u65f6\uff0c$i < Y \\leq L$ \u7684\u6982\u7387\uff0c\u5219 $p_i = \\sum_{j = i + 1} ^ L f_{i, j}$\u3002\n\n\u8bbe $q_i$ \u8868\u793a\u5f53 $X = i$ \u65f6\uff0c\u5148\u624b\u83b7\u80dc\u7684\u6982\u7387\uff0c\u5219\u5148\u624b\u53ef\u4ee5\u7ee7\u7eed\u9009\u62e9\u5bb9\u5668\u6216\u505c\u6b62\uff0c\u56e0\u6b64 $q_i = \\max(1 - p_i, \\frac {1} {n}\\sum_{j} q_{i + a_j})$\u3002$p_i$ \u548c $1 - q_i$ \u7684\u533a\u522b\u5728\u4e8e\u5bf9\u4e8e $p_i$\uff0c\u5148\u624b\u53ef\u4ee5\u7ee7\u7eed\u51b3\u7b56\uff0c\u4f46 $q_i$ \u53ea\u5141\u8bb8\u540e\u624b\u51b3\u7b56\u3002\n\n\u8bbe $C = L - m$\uff0c\u56e0\u4e3a $X$ \u6700\u7ec8\u5fc5\u7136\u843d\u5728 $(C, L]$ \u4e4b\u95f4\uff0c\u6240\u4ee5\u7b54\u6848\u7b49\u4e8e $\\sum_{i = C + 1} ^ L f_{C, i} q_i$\u3002\n\n\u73b0\u5728\u53ea\u8981\u6c42 $f_C$\u3002\n\n$f$ \u7684\u5f62\u5f0f\u8ba9\u6211\u4eec\u60f3\u5230\u5e38\u7cfb\u6570\u9f50\u6b21\u7ebf\u6027\u9012\u63a8\uff0c\u4f46\u5b83\u4e0d\u662f\u4e25\u683c\u610f\u4e49\u4e0a\u7684\u7ebf\u6027\u9012\u63a8\uff0c\u56e0\u4e3a\u7ebf\u6027\u9012\u63a8\u662f\u6bcf\u6b21\u6c42\u51fa\u4e00\u4e2a\u5143\u7d20\uff0c\u800c $f$ \u662f\u6bcf\u6b21\u7528\u4e00\u4e2a\u5143\u7d20\u8d21\u732e\u5b83\u540e\u9762\u7684\u5143\u7d20\u3002\u4f46\u662f\u6211\u4eec\u53ef\u4ee5\u501f\u7528\u7ebf\u6027\u9012\u63a8\u7684\u601d\u60f3\uff1a**\u591a\u9879\u5f0f\u53d6\u6a21**\u3002\u5bf9\u4e8e\u6bcf\u4e2a $a_i$\uff0c\u4e3a\u4e86\u8ba9 $\\frac 1 n [x ^ k]$ \u8d21\u732e\u81f3 $[x ^ {k - a_j}]$\uff0c\u6211\u4eec\u6784\u9020 $A = x ^ m - \\sum_{j = 1} ^ n \\frac 1 n x ^ {m - a_j}$\u3002\u8003\u8651 $c_k x ^ k$ \u6a21 $A$\uff0c\u53d1\u73b0 $\\frac {c_k} {n}$ \u4f1a\u8d21\u732e\u5230\u6bcf\u4e2a $x ^ {k - a_j}$ \u524d\u7684\u7cfb\u6570\uff0c\u7b26\u5408\u6211\u4eec\u7684\u8981\u6c42\u3002\n\n\u6ce8\u610f\u8fd9\u6837\u5f97\u5230\u7684\u503c\u662f\u53cd\u8fc7\u6765\u7684\uff0c\u4e5f\u5c31\u662f\u4e0b\u6807\u8f83\u5c0f\u7684\u503c\u4e3a\u591a\u9879\u5f0f\u8f83\u9ad8\u6b21\u9879\u7684\u7cfb\u6570\uff0c\u6240\u4ee5\u5148\u7ffb\u8f6c\u7cfb\u6570\uff08$x ^ i$ \u524d\u7684\u7cfb\u6570\u7ffb\u8f6c\u5230 $x ^ {m - i - 1}$ \u524d\uff09\uff0c\u53d1\u73b0 $[x ^ k]$ \u7b49\u4e8e\u67d0\u4e2a $f_{i, i + k + 1}$\u3002\u53c8\u56e0\u4e3a $x ^ m$ \u6a21 $A$ \u5f97\u5230\u7684\u591a\u9879\u5f0f\u7cfb\u6570\u7ffb\u8f6c\u540e\uff0c$[x ^ k]$ \u7b49\u4e8e $f_{0, k + 1}$\uff0c\u53ef\u77e5 $x ^ L \\bmod A$ \u5904\u7406\u540e\u5f97\u5230 $f_{L - m}$\uff0c\u5373\u6211\u4eec\u8981\u6c42\u7684 $f_C$\u3002\u500d\u589e + \u66b4\u529b\u591a\u9879\u5f0f\u4e58\u6cd5 + \u66b4\u529b\u591a\u9879\u5f0f\u53d6\u6a21\u5373\u53ef\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(m ^ 2\\log L)$\u3002\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\nusing ll = long long;\nusing ull = unsigned long long;\n\nbool Mbe;\nconstexpr int N = 4e3 + 5;\nint n, mx, L;\ndouble w, a[N], f[N], g[N], p[N], q[N];\nvoid mul(double *f, double *g) { // \u8ba1\u7b97 f * g mod A\n  static double h[N];\n  memset(h, 0, sizeof(h));\n  for(int i = 0; i < mx; i++)\n    for(int j = 0; j < mx; j++)\n      h[i + j] += f[i] * g[j];\n  for(int i = mx * 2 - 2; i >= mx; i--)\n    for(int j = 1; j <= mx; j++)\n      h[i - j] += h[i] * a[j];\n  for(int i = 0; i < mx; i++) f[i] = h[i];\n}\n\nbool Med;\nint main() {\n  fprintf(stderr, \"%.3lf MB\\n\", (&Mbe - &Med) / 1048576.0);\n  ios::sync_with_stdio(0), cin.tie(0), cout.tie(0);\n  #ifdef ALEX_WEI\n    FILE* IN = freopen(\"1.in\", \"r\", stdin); \n    FILE* OUT = freopen(\"1.out\", \"w\", stdout);\n  #endif\n  cin >> n >> L, w = 1.0 / n;\n  for(int i = 1, v; i <= n; i++) {\n    cin >> v, mx = max(mx, v), a[v] += w;\n    // a \u8868\u793a\u591a\u9879\u5f0f\u5bf9 A \u53d6\u6a21\u65f6\u7684\u7cfb\u6570\uff0c\u800c\u4e0d\u662f A\n  }\n\n  f[0] = 1, g[1] = 1;\n  while(L) { // \u8ba1\u7b97 x ^ L mod A\n    if(L & 1) mul(f, g);\n    mul(g, g), L >>= 1;\n  }\n  reverse(f, f + mx);\n  // \u8bbe C = L - mx, f[i] \u8868\u793a\u8981\u6c42 > C \u65f6\uff0c\u53d6\u5230 C + i + 1 \u7684\u6982\u7387\n\n  memcpy(g, f, sizeof(f));\n  // \u63a5\u4e0b\u6765\u4ece 0 \u5230 mx - 1 \u679a\u4e3e i\uff0c\u5176\u4e2d g[i + j] \u8868\u793a\uff1a\n  // \u5728\u5faa\u73af\u5f00\u5934\uff0c\u8981\u6c42 Y > C + i \u65f6 Y = C + i + j + 1 \u7684\u6982\u7387\n  // \u5728\u5faa\u73af\u7ed3\u5c3e\uff0c\u8981\u6c42 Y > C + i + 1 \u65f6 Y = C + i + j + 1 \u7684\u6982\u7387\n  p[0] = 1;\n  // \u8ba1\u7b97 p[i] \u8868\u793a X = C + i + 1 \u65f6\uff0c\u540e\u624b\u7684 Y \u5728 (C + i + 1, L] \u4e4b\u95f4\u7684\u6982\u7387\n  for(int i = 0; i < mx; i++) {\n    if(i) p[i] = p[i - 1];\n    for(int j = 1; j <= mx; j++) { // \u540e\u624b\u5728 Y = C + i + 1 \u65f6\u5fc5\u987b\u7ee7\u7eed\u9009\u62e9\u5bb9\u5668\n      if(i + j >= mx) p[i] -= g[i] * a[j];\n      // \u5f53 i + j >= mx \u65f6\uff0cY = C + i + j + 1 > L\uff0c\u8d85\u51fa\u9650\u5236\uff0cg[i] * a[j] \u4e0d\u4f1a\u8d21\u732e\u81f3 p[i]\n      else g[i + j] += g[i] * a[j];\n      // \u5426\u5219\u7d2f\u52a0\u5165 Y = C + i + j + 1 \u5bf9\u5e94\u7684 g[i + j]\n    }\n  }\n\n  double ans = 0;\n  for(int i = mx - 1; ~i; i--) {\n    // \u8ba1\u7b97 q[i] \u8868\u793a X = C + i + 1 \u65f6\u7684\u80dc\u7387\uff0cp \u548c q \u7684\u533a\u522b\u5728\u4e8e\u5bf9\u4e8e\u540e\u8005\uff0c\u5148\u624b\u8fd8\u53ef\u4ee5\u7ee7\u7eed\u9009\u62e9\n    // \u8981\u4e48\u4e0d\u9009\u5bb9\u5668\uff0c\u80dc\u7387\u4e3a p[i]\uff1b\u8981\u4e48\u9009\u5bb9\u5668\uff0c\u4ece\u63a5\u4e0b\u6765\u7684 q \u8f6c\u79fb\n    for(int j = 1; i + j < mx; j++) q[i] += q[i + j] * a[j];\n    q[i] = max(q[i], 1 - p[i]);\n    ans += f[i] * q[i];\n  }\n  printf(\"%.12lf\\n\", ans);\n\n  cerr << 1e3 * clock() / CLOCKS_PER_SEC << \" ms\\n\";\n  return 0;\n}\n```",
        "postTime": 1678861689,
        "uid": 123294,
        "name": "Alex_Wei",
        "ccfLevel": 10,
        "title": "P9138 [THUPC 2023 \u521d\u8d5b] \u516c\u5e73\u5408\u4f5c"
    },
    {
        "content": "## \u9898\u89e3\n\u9996\u5148\u5982\u679c $L\\leq 2\\times 10^3$ \u95ee\u9898\u662f\u7b80\u5355\u7684\uff1a\n\n- \u5bf9\u4e8e\u6bcf\u4e2a $i$\uff0c\u6211\u4eec\u6c42\u51fa\u5982\u679c A \u88c5\u5165\u4e86 $i$ \u4efd\uff0cB \u83b7\u80dc\u7684\u6982\u7387\uff0c\u8fd9\u4e2a\u53ef\u4ee5 $O(nL)$ \u6c42\u51fa\u3002\n- \u5bf9\u4e8e\u6bcf\u4e2a $i$\uff0c\u6211\u4eec\u6c42\u51fa A \u5df2\u7ecf\u88c5\u4e86 $i$ \u4efd\u540e\u83b7\u80dc\u7684\u6982\u7387\uff0c\u51b3\u7b56\u53ef\u4ee5\u9009\u62e9\u518d\u88c5\u4e00\u6876\u6216\u8005\u505c\u6b62\uff0c\u901a\u8fc7\u524d\u7f00\u548c\u4e5f\u53ef\u4ee5 $O(nL)$ \u6c42\u51fa\u3002\n\n\u7136\u540e\u6211\u4eec\u8003\u8651\u5f53 $x<L-\\max A$ \u7684\u65f6\u5019\uff0cA \u88c5 $x$ \u4efd\u662f\u5fc5\u8f93\u7684\uff0c\u56e0\u4e3a\u6b64\u65f6 B \u53ea\u8981\u6ca1\u88c5\u5230 $x$ \u4efd\u5c31\u7ee7\u7eed\u88c5\uff0c\u4e00\u5b9a\u80fd\u8d85\u8fc7 A \u4e14\u4e0d\u6ea2\u51fa\u3002\n\n\u56e0\u6b64\u6211\u4eec\u53ea\u9700\u8981\u6c42\u51fa A \u88c5 $[L-\\max A,L]$ \u4efd\u7684\u6982\u7387\u3002\u4e0d\u96be\u53d1\u73b0\u8fd9\u662f\u4e00\u4e2a\u5e38\u7cfb\u6570\u9f50\u6b21\u7ebf\u6027\u9012\u63a8\uff0c\u53ef\u4ee5 $O((\\max A)^2\\log L)$ \u6c42\u5355\u9879\uff0c$O(\\max A)$ \u6c42\u4e0b\u4e00\u9879\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O((\\max A)^2\\log L)$\u3002\n## \u4ee3\u7801\n\u961f\u53cb\u5199\u7684\u3002\n\n```cpp\n//\u4e0d\u56de\u5bb6\u4e86\uff0c\u6211\u4eec\u53bb\u9e1f\u5de2\uff01\n#include<bits/stdc++.h>\nusing namespace std;\ninline int read(){\n   int s=0,w=1;\n   char ch=getchar();\n   while(ch<'0'||ch>'9'){if(ch=='-')w=-1;ch=getchar();}\n   while(ch>='0'&&ch<='9') s=s*10+ch-'0',ch=getchar();\n   return s*w;\n}\ndouble a[8008],f[8008],g[8008],h[4003];\ndouble sdt[8008],ps[8008];\nconst int N=2000;\nvoid mul(double *F,double *G,double *R)\n{\n    memset(h,0,sizeof(h));\n    for(int i=0; i<=N; ++i)\n        for(int j=0; j<=N; ++j)\n            h[i+j]+=F[i]*G[j];\n    for(int i=N*2; i>N; --i)\n        for(int j=1; j<=N; ++j)\n            h[i-j]+=h[i]*a[j];\n    for(int i=0; i<=N; ++i) R[i]=h[i];\n    return ;\n}\ndouble ans[100003];\ndouble p[8008],Q[8008],*q=Q+4002,win[8008],tmp_q[8008];\nsigned main()\n{\n    int n=read(),L=read();\n    double w=1.0/n;\n    sdt[0]=1;\n    for(int i=1,x; i<=n; ++i) a[read()]+=w;\n    for(int i=1; i<=4000; ++i)\n        for(int j=1; j<=2000; ++j)\n            if(i-j>=0)sdt[i]+=sdt[i-j]*a[j];\n    for(int i=1;i<=2000;i++)ps[i]=ps[i-1]+a[i];\n    int m=max(L-4000,0);\n    if(L<=4000)\n    {\n        for(int i=0;i<=L;i++)\n        {\n            for(int j=i-1;j>=0;j--)p[i]+=(ps[min(L-j,2000)]-ps[min(2000,i-j-1)])*sdt[j];\n            // printf(\"%.6lf \",p[i]);\n        }\n        p[0]++;\n        win[L]=1;\n        for(int i=L-1;i>=0;i--)\n        {\n            double p1=0,p2=0;\n            for(int j=1;j<=2000;j++)p1+=a[j]*win[i+j];\n            p2=p[i+1];\n            win[i]=max(p1,1-p2);\n        }\n        double ns=0;\n        printf(\"%.12lf\\n\",win[0]);\n        return 0;\n    }\n    memset(f,0,sizeof(f)),\n    memset(g,0,sizeof(g));\n    f[1]=1,g[0]=1;\n    while(m)\n    {\n        if(m&1) mul(f,g,g);\n        mul(f,f,f),m>>=1;\n    }\n    for(int i=0; i<=N; ++i)\n        ans[0]+=sdt[i]*g[i];\n    m=L-4000;\n    for(int i=1; i<=L-m; ++i)\n    {\n        for(int j=N; j>=0; --j) g[j+1]=g[j];\n        g[0]=0;\n        for(int j=1; j<=N; ++j) g[N+1-j]+=a[j]*g[N+1];\n        for(int j=0; j<=N; ++j) ans[i]+=sdt[j]*g[j];\n    }\n    for(int i=0;i<4000;i++)\n    {\n        int j=L-m-i;\n        if(j>=0)q[2000-i]=ans[j];\n    }\n    for(int i=1;i<=2000;i++)tmp_q[i]=q[i],q[i]=0;\n    o_o:;\n    double sumq=0;\n    for(int i=2000;i>=1;i--)\n    {\n        for(int j=1;j<=2000;j++)\n            q[i]+=q[i-j]*a[j];\n        // printf(\"%.6lf \",q[i]);\n        sumq+=q[i];\n    }\n    // puts(\"\");\n    for(int i=2000;i>=1;i--)\n    {\n        for(int j=i;j<=2000;j++)p[i]+=q[j];\n        for(int j=i-1;j>=1;j--)\n            p[i]+=(ps[2000-j]-ps[i-j-1])*tmp_q[j];\n    }\n    // for(int i=1;i<=2000;i++)printf(\"%.6lf \",p[i]);puts(\"\");\n    // puts(\"\");\n    // for(int i=1999;i>=0;i--)p[i]+=p[i+1];\n    win[2000]=1;\n    for(int i=1999;i>=1;i--)\n    {\n        double p1=0,p2=0;\n        for(int j=1;j<=2000;j++)p1+=a[j]*win[i+j];\n        p2=p[i+1];\n        win[i]=max(p1,1-p2);\n    }\n    double ns=0;\n    for(int i=1;i<=2000;i++)ns+=q[i]*win[i];\n    printf(\"%.12lf\\n\",ns);\n    // for(int i=-2000;i<=2000;i++)printf(\"%.6lf \",q[i]);\n    // for(int i=0; i<L; ++i) printf(\"%.8lf\\n\",ans[i]);\n    return 0;\n}\n```",
        "postTime": 1678197228,
        "uid": 111055,
        "name": "dead_X",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P9138"
    }
]