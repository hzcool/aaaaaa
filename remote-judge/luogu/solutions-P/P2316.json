[
    {
        "content": "### 0.\u524d\u8a00\n\n\u901a\u8fc7\u968f\u673a\u8df3\u9898\u8df3\u5230\u6b64\u9898\uff0c\u7136\u540e\u5c31\u548c\u8fd9\u9898\u6760\u4e0a\u4e86\u3002\u3002\u3002\n\n### 1.\u601d\u8def\n\n\u601d\u8def\u4e00\uff1a\u6734\u7d20\u60f3\u6cd5\uff0c\u5728\u6240\u6709\u5207\u70b9\u95f4\u66b4\u529b\u5efa\u8fb9\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u8be2\u95ee\u987a\u65f6\u9488\u9006\u65f6\u9488\u4ea4\u66ff\u641c\u7d22\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a$O($\u7384\u5b66$)$\n\n\u601d\u8def\u4e8c\uff1a\u4e0d\u96be\u53d1\u73b0\u6b64\u9898\u7684\u6bcf\u7ec4\u8be2\u95ee\u4e4b\u95f4\u6709\u4e14\u4ec5\u6709\u4e24\u6761\u8def\u5f84\uff0c\u4e14\u8fd9\u4e24\u6761\u8def\u5f84\u4e4b\u548c\u4e3a\u8def\u5f84\u4e0a\u6240\u6709\u7ecf\u8fc7\u7684\u5706\u7684\u5468\u957f\u4e4b\u548c\u3002\n\n\u4e8e\u662f\u60f3\u5230\u6c42\u51fa\u4efb\u610f\u4e00\u6761\u8def\u5f84\uff0c\u7136\u540e\u4f7f\u7528\u8def\u5f84\u4e0a\u6240\u6709\u7ecf\u8fc7\u7684\u5706\u7684\u5468\u957f\u4e4b\u548c\u51cf\u53bb\u8fd9\u6761\u8def\u5f84\u7684\u957f\u5ea6\u5f97\u5230\u53e6\u4e00\u6761\u8def\u5f84\u957f\u5ea6\uff0c\u518d\u6bd4\u8f83\u5927\u5c0f\u3002\n\n\u5c06\u6bcf\u4e2a\u5706\u770b\u4f5c\u4e00\u4e2a\u70b9\uff0c\u4e24\u5706\u76f8\u5207\u5219\u8fde\u8fb9\uff0c\u4e0d\u96be\u770b\u51fa\u8fd9\u662f\u4e00\u68f5\u6811\u3002\n\n\u5c06\u6700\u5927\u7684\u5706\u4ee3\u8868\u7684\u70b9\u770b\u505a\u6839\u8282\u70b9\uff0c\u5219\u5176\u5b9e\u4e00\u6761\u8def\u5f84\u4e0a\u6240\u6709\u7ecf\u8fc7\u7684\u5706\u5c31\u662f\u8fd9\u4e24\u4e2a\u70b9\u7684LCA\u6240\u7ecf\u8fc7\u7684\u70b9\u4ee3\u8868\u7684\u5706\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7LCA\u6c42\u8def\u5f84\u7684\u65b9\u5f0f\u5feb\u901f\u6c42\u51fa\u4f7f\u7528\u8def\u5f84\u4e0a\u6240\u6709\u7ecf\u8fc7\u7684\u5706\u7684\u5468\u957f\u4e4b\u548c\u3002\n\n\u7136\u540e\u518d\u8fdb\u4e00\u6b65\uff0c\u5176\u5b9e\u4e24\u70b9\u95f4\u8def\u5f84\u4e5f\u53ef\u4ee5\u901a\u8fc7\u7c7b\u4f3c\u7684\u65b9\u5f0f\uff08\u6bd4\u5982\u5b9a\u4e49\u4e00\u4e2a\u6807\u51c6\u65b9\u5411\uff0c\u5373\u5728\u6df1\u5ea6\u4e3a\u5076\u6570\u7684\u5706\u4e0a\u987a\u65f6\u9488\u8d70\uff0c\u6df1\u5ea6\u4e3a\u5947\u6570\u7684\u5706\u4e0a\u987a\u65f6\u9488\u8d70\uff09\u3002\n\n\u7136\u540e\u5c31\u53ef\u4ee5\u53d1\u73b0\u5176\u5b9e\u4e00\u6761\u8def\u5f84\u53ef\u4ee5\u5206\u4e3a\u4e94\u90e8\u5206\uff0c\u5373\u5728\u8be2\u95ee\u4e2d\u4e00\u4e2a\u7ed9\u5b9a\u7684\u8282\u70b9\uff08\u5706\uff09\u7531\u7ed9\u5b9a\u5e45\u89d2\u5230\u4e0e\u5b83\u7236\u4eb2\u8282\u70b9\uff08\u5706\uff09\u7684\u5207\u70b9\u6309\u7167\u6807\u51c6\u65b9\u5411\u8d70\u7684\u8def\u5f84\u3001\u8fd9\u4e2a\u7ed9\u5b9a\u7684\u8282\u70b9\uff08\u5706\uff09\u4e0e\u5b83\u7236\u4eb2\u8282\u70b9\uff08\u5706\uff09\u7684\u5207\u70b9\u5230\u7ed9\u5b9a\u7684\u4e24\u4e2a\u8282\u70b9\u7684LCA\uff08\u5706\uff09\u6309\u7167\u6807\u51c6\u65b9\u5411\u8d70\u7684\u8def\u5f84\u3001\u5728\u7ed9\u5b9a\u7684\u4e24\u4e2a\u8282\u70b9\u7684LCA\uff08\u5706\uff09\u4e0a\u6309\u7167\u6807\u51c6\u65b9\u5411\u8d70\u7684\u8def\u5f84\uff0c\u53e6\u4e00\u4e2a\u7ed9\u5b9a\u7684\u8282\u70b9\uff08\u5706\uff09\u4e0e\u5b83\u7236\u4eb2\u8282\u70b9\uff08\u5706\uff09\u7684\u5207\u70b9\u5230\u7ed9\u5b9a\u7684\u4e24\u4e2a\u8282\u70b9\u7684LCA\uff08\u5706\uff09\u6309\u7167\u9006\u6807\u51c6\u65b9\u5411\u8d70\u7684\u8def\u5f84\u3001\u8fd9\u4e2a\u7ed9\u5b9a\u7684\u8282\u70b9\uff08\u5706\uff09\u7531\u7ed9\u5b9a\u5e45\u89d2\u5230\u4e0e\u5b83\u7236\u4eb2\u8282\u70b9\uff08\u5706\uff09\u7684\u5207\u70b9\u6309\u7167\u9006\u6807\u51c6\u65b9\u5411\u8d70\u7684\u8def\u5f84\u3002\n\n\u53ef\u80fd\u4e0a\u4e00\u6bb5\u770b\u8d77\u6765\u6709\u70b9\u5197\u957f\uff0c\u5219\u54b1\u4eec\u6765\u770b\u70b9\u76f4\u89c2\u7684\uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/2aozyil4.png)\n\n\u7bad\u5934\u4ee3\u8868\u8fd9\u4e2a\u5706\u7684\u6807\u51c6\u65b9\u5411\uff0c\u5219\u4ece$A$\u70b9\u5230$B$\u70b9\u7684\u8def\u5f84\u53ef\u4ee5\u5206\u4e3a\u4e94\u6bb5\uff0c\u5373\u7ea2\u6bb5\u3001\u6a59\u6bb5\u3001\u9ec4\u6bb5\u3001\u7eff\u6bb5\uff08\u4f60\u6ca1\u770b\u9519\u90a3\u5c31\u662f\u4e00\u4e2a\u70b9\uff09\uff0c\u84dd\u6bb5\u3002\n\n\u7136\u540e\u5f97\u5230\u7b54\u6848\u5c31\u5f88\u7b80\u5355\u5566\u3002\n\n\u4f46\u662f\u6ce8\u610f\u8fd8\u6709\u4e24\u79cd\u60c5\u51b5\uff0c\u5373\u4e00\u4e2a\u5706\u662f\u53e6\u4e00\u4e2a\u5706\u7236\u4eb2\u7684\u60c5\u51b5\u6216\u5728\u540c\u4e00\u5706\u4e0a\u7684\u60c5\u51b5\uff0c\u9700\u5355\u72ec\u8003\u8651\uff0c\u7531\u4e8e\u6bd4\u8f83\u7b80\u5355\uff0c\u7559\u7ed9\u8bfb\u8005\u81ea\u5df1\u601d\u8003~~\u5176\u5b9e\u662f\u6211\u61d2~~\u3002\n\n\u4e0b\u9762\u4e0a\u6211~~\u5197\u957f~~\u7684\u4ee3\u7801\uff08\u542b\u6ce8\u91ca\uff09\uff1a\n\n```\n#include<bits/stdc++.h>\nusing namespace std;\nconst double pi=3.14159265358979323846;\nint nex[6005],beg[6005],to[6005],r[3005],n,m,t,e,s,ee[3005];\nstruct T{\n\tdouble x,y,sonf[15],faf,wtcl;\n\tint d,fa[25],sn,snn,son[15];\n}tree[3005];//\u5b9a\u4e49\u8282\u70b9\uff0csonf\u3001faf\u4e3a\u513f\u5b50\u8282\u70b9\uff08\u5706\uff09\u3001\u7236\u4eb2\u8282\u70b9\uff08\u5706\uff09\u7684\u5e45\u89d2\nvoid add(int x,int y){\n\tto[++e]=y;\n\tnex[e]=beg[x];\n\tbeg[x]=e;\n}//\u94fe\u5f0f\u524d\u5411\u661f\ndouble dist(int d,double x,double y){\n\tif(x>y)return (2*pi-x+y)*r[d];\n\treturn (y-x)*r[d];\n}//\u8ba1\u7b97\u4e24\u70b9\u5728\u5c3a\u5bf8\u4e3ad\u7684\u5706\u4e0a\u9006\u65f6\u9488\u8ddd\u79bb\nvoid dfs(int s){\n\tfor(int i=1;(1<<i)<=tree[s].d;i++)\n\t\ttree[s].fa[i]=tree[tree[s].fa[i-1]].fa[i-1];\n\tfor(int i=beg[s];i;i=nex[i])dfs(to[i]);\n}//\u500d\u589e\u9884\u5904\u7406\nvoid dfs2(int s){\n\tfor(int i=1;i<=tree[s].sn;i++)\n\t\tif(tree[s].d%2==0){ \n\t\t\ttree[tree[s].son[i]].wtcl=tree[s].wtcl+dist(tree[s].d,tree[s].sonf[i],tree[s].faf);\n\t\t\tdfs2(tree[s].son[i]);\n\t\t}\n\t\telse {\n\t\t\ttree[tree[s].son[i]].wtcl=tree[s].wtcl+dist(tree[s].d,tree[s].faf,tree[s].sonf[i]);\n\t\t\tdfs2(tree[s].son[i]);\n\t\t}\n}//\u6807\u51c6\u65b9\u5411\u7684\u8ddd\u79bb\u9884\u5904\u7406\nint lca(int a,int b){\n\tif(tree[a].d>tree[b].d)\n\t\tswap(a,b);\n\tfor(int i=20;i>=0;i--)\n\t\tif(tree[a].d+(1<<i)<=tree[b].d)\n\t\t\tb=tree[b].fa[i];\n\tif(a==b)return -1;\n\tfor(int i=20;i>=0;i--)\n\t\tif(tree[a].fa[i]!=tree[b].fa[i]){\n\t\t\ta=tree[a].fa[i];\n\t\t\tb=tree[b].fa[i];\n\t\t}\n\treturn tree[a].fa[0];\n}//LCA\nint main(){\n\tscanf(\"%d%d%d\",&n,&m,&t);\n\tr[0]=1e5;\n\tee[0]=1e5;//ee\u662fr\u7684\u524d\u7f00\u548c\n\tfor(int i=1;i<=n;i++)\n\t\tscanf(\"%d\",&r[i]),ee[i]=ee[i-1]+r[i];\n\ts=1;//\u6839\u8282\u70b9\u4e3a1\n\tfor(int i=1;i<=m;i++){\n\t\tscanf(\"%lf%lf%d%d\",&tree[i].x,&tree[i].y,&tree[i].d,&tree[i].fa[0]);//\u5176\u5b9e\u5c3a\u5bf8\u5c31\u76f8\u5f53\u4e8e\u6df1\u5ea6\n\t\ttree[tree[i].fa[0]].son[++tree[tree[i].fa[0]].sn]=i;//\u8bb0\u5f55\u513f\u5b50\n\t\tadd(tree[i].fa[0],i);//\u52a0\u8fb9\n\t}\n\tfor(int i=2;i<=m;i++){\n\t\ttree[tree[i].fa[0]].snn++;\n\t\tif(tree[i].x==tree[tree[i].fa[0]].x){\n\t\t\tif(tree[i].y>tree[tree[i].fa[0]].y)tree[tree[i].fa[0]].sonf[tree[tree[i].fa[0]].snn]=pi/2;\n\t\t\telse tree[tree[i].fa[0]].sonf[tree[tree[i].fa[0]].snn]=3*pi/2;\n\t\t}\n\t\telse{\n\t\t\tif(tree[i].x>tree[tree[i].fa[0]].x&&tree[i].y>=tree[tree[i].fa[0]].y)tree[tree[i].fa[0]].sonf[tree[tree[i].fa[0]].snn]=atan((tree[i].y-tree[tree[i].fa[0]].y)/(tree[i].x-tree[tree[i].fa[0]].x));\n\t\t\tif(tree[i].x<tree[tree[i].fa[0]].x&&tree[i].y>=tree[tree[i].fa[0]].y)tree[tree[i].fa[0]].sonf[tree[tree[i].fa[0]].snn]=pi+atan((tree[i].y-tree[tree[i].fa[0]].y)/(tree[i].x-tree[tree[i].fa[0]].x));\n\t\t\tif(tree[i].x<tree[tree[i].fa[0]].x&&tree[i].y<tree[tree[i].fa[0]].y)tree[tree[i].fa[0]].sonf[tree[tree[i].fa[0]].snn]=pi+atan((tree[i].y-tree[tree[i].fa[0]].y)/(tree[i].x-tree[tree[i].fa[0]].x));\n\t\t\tif(tree[i].x>tree[tree[i].fa[0]].x&&tree[i].y<tree[tree[i].fa[0]].y)tree[tree[i].fa[0]].sonf[tree[tree[i].fa[0]].snn]=2*pi+atan((tree[i].y-tree[tree[i].fa[0]].y)/(tree[i].x-tree[tree[i].fa[0]].x));\n\t\t}//\u5206\u56db\u4e2a\u533a\u57df\u548c\u5e73\u884c\u4e8ex\u8f74\u7684\u4e24\u79cd\u60c5\u51b5\u8ba8\u8bba\u5e45\u89d2\n\t}//\u6c42\u51fasonf\n\tfor(int i=1;i<=m;i++)\n\t\tfor(int j=1;j<=tree[i].sn;j++){\n\t\t\tif(tree[i].x==tree[tree[i].son[j]].x){\n\t\t\t\tif(tree[i].y>tree[tree[i].son[j]].y)tree[tree[i].son[j]].faf=pi/2;\n\t\t\t\telse tree[tree[i].son[j]].faf=3*pi/2;\n\t\t\t}\n\t\t\telse{\n\t\t\t\tif(tree[i].x>tree[tree[i].son[j]].x&&tree[i].y>=tree[tree[i].son[j]].y)tree[tree[i].son[j]].faf=atan((tree[i].y-tree[tree[i].son[j]].y)/(tree[i].x-tree[tree[i].son[j]].x));\n\t\t\t\tif(tree[i].x<tree[tree[i].son[j]].x&&tree[i].y>=tree[tree[i].son[j]].y)tree[tree[i].son[j]].faf=pi+atan((tree[i].y-tree[tree[i].son[j]].y)/(tree[i].x-tree[tree[i].son[j]].x));\n\t\t\t\tif(tree[i].x<tree[tree[i].son[j]].x&&tree[i].y<tree[tree[i].son[j]].y)tree[tree[i].son[j]].faf=pi+atan((tree[i].y-tree[tree[i].son[j]].y)/(tree[i].x-tree[tree[i].son[j]].x));\n\t\t\t\tif(tree[i].x>tree[tree[i].son[j]].x&&tree[i].y<tree[tree[i].son[j]].y)tree[tree[i].son[j]].faf=2*pi+atan((tree[i].y-tree[tree[i].son[j]].y)/(tree[i].x-tree[tree[i].son[j]].x));\n\t\t\t}//\u5206\u56db\u4e2a\u533a\u57df\u548c\u5e73\u884c\u4e8ex\u8f74\u7684\u4e24\u79cd\u60c5\u51b5\u8ba8\u8bba\u5e45\u89d2\n\t}//\u6c42\u51fafaf\n\tdfs(s);//\u500d\u589e\n\tfor(int i=1;i<=tree[1].sn;i++)\n\t\tdfs2(tree[1].son[i]);//\u6c42\u51fa\u6807\u51c6\u65b9\u5411\u4e0a\u7684\u8ddd\u79bb\n\twhile(t--){\n\t\tint x,y,xxx,yyy;\n\t\tdouble ans,xx,yy,xf,yf,xh,yh,xxxx,yyyy,hh;\n\t\tscanf(\"%d%lf%d%lf\",&x,&xf,&y,&yf);\n\t\tif(x==y){\n\t\t\tprintf(\"%.0lf\\n\",min(fabs(xf-yf),2*pi-fabs(xf-yf))*r[tree[x].d]/pi);\n\t\t\tcontinue;\n\t\t}//\u5728\u540c\u4e00\u5706\u4e0a\u7684\u60c5\u51b5\n\t\tint h=lca(x,y);//\u6c42LCA\n\t\tif(h==-1){\n\t\t\tans=0;\n\t\t\tif(tree[x].d>tree[y].d)\n\t\t\t\tswap(x,y),swap(xf,yf);\n\t\t\tint kk;\n\t\t\tfor(int i=1;i<=tree[x].sn;i++)\n\t\t\t\tif(lca(tree[x].son[i],y)==-1)kk=i;\n\t\t\tif(tree[x].d%2==0)ans+=dist(tree[x].d,tree[x].sonf[kk],xf);\n\t\t\telse ans+=dist(tree[x].d,xf,tree[x].sonf[kk]);\n\t\t\tif(tree[y].d%2==0)ans+=dist(tree[y].d,yf,tree[y].faf);\n\t\t\telse ans+=dist(tree[y].d,tree[y].faf,yf);\n\t\t\tans+=tree[y].wtcl;\n\t\t\tans-=tree[tree[x].son[kk]].wtcl;\n\t\t\tif(ans>pi*(ee[tree[y].d]-ee[tree[x].d]+r[tree[x].d]))ans=2*pi*(ee[tree[y].d]-ee[tree[x].d]+r[tree[x].d])-ans;\n\t\t\tprintf(\"%.0lf\\n\",ans/pi);\n\t\t\tcontinue;\n\t\t}//\u201c\u76f4\u7cfb\u8840\u4eb2\u201d\u7684\u60c5\u51b5\n\t\tfor(int i=1;i<=tree[h].sn;i++){\n\t\t\tif(lca(tree[h].son[i],x)==-1)xxx=tree[h].son[i],xxxx=tree[h].sonf[i];\n\t\t\tif(lca(tree[h].son[i],y)==-1)yyy=tree[h].son[i],yyyy=tree[h].sonf[i];\n\t\t}\n\t\tif(tree[x].d%2==0)xx=dist(tree[x].d,xf,tree[x].faf);\n\t\telse xx=dist(tree[x].d,tree[x].faf,xf);\n\t\tif(tree[y].d%2==0)yy=dist(tree[y].d,tree[y].faf,yf);\n\t\telse yy=dist(tree[y].d,yf,tree[y].faf);\n\t\txh=tree[x].wtcl-tree[xxx].wtcl;\n\t\tyh=2*pi*(ee[tree[y].d-1]-ee[tree[h].d])-(tree[y].wtcl-tree[yyy].wtcl);\n\t\tif(tree[h].d%2==0)hh=dist(tree[h].d,xxxx,yyyy);\n\t\telse hh=dist(tree[h].d,yyyy,xxxx);\n\t\tans=xh+yh+xx+yy+hh;//\u5206\u4e94\u6bb5\u6c42\u548c\n\t\tif(ans>pi*(ee[tree[x].d]+ee[tree[y].d]-ee[tree[h].d]-ee[tree[h].d-1]))ans=2*pi*(ee[tree[x].d]+ee[tree[y].d]-ee[tree[h].d]-ee[tree[h].d-1])-ans;//\u6700\u540e\u518d\u6bd4\u8f83\u5927\u5c0f\n\t\tprintf(\"%.0lf\\n\",ans/pi);//\u8f93\u51fa\n\t}\n\treturn 0;\n}\n```\n",
        "postTime": 1585393629,
        "uid": 104662,
        "name": "PrincessQi",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P2316 \u3010[HNOI2005]\u5206\u5f62\u3011"
    }
]