[
    {
        "content": "\u4e00\u5171\u53ea\u6709\u4e24\u4e2a\u9519\u8bef\u6211\u7adf\u7136\u8c03\u4e86\u4e00\u4e2a\u5c0f\u65f6...~~\uff08\u6211\u624d\u4e0d\u4f1a\u8bf4\u6211\u5feb\u8bfb\u6ca1\u5224\u8d1f\u6570\u7136\u540e\u8fdeWA\u56db\u6b21\uff09~~\n\n\u5450\uff0c\u8fd9\u9898\u6839\u672c\u7528\u4e0d\u7740\u52a8\u6001\u70b9\u5206\u6cbb\u8fd9\u79cd\u9ad8\u5927\u4e0a\u7684\u4e1c\u897f\uff0c\u70b9\u5206\u6cbb\u90fd\u7528\u4e0d\u5230\uff0c\u53ea\u8981\u6811\u5256\u778e\u641e\u4e00\u641e\u5c31\u53ef\u4ee5\u4e86\u3002\n\n\u4e3a\u4e86\u65b9\u4fbf\u8ba1\u7b97\uff0c\u6211\u4eec\u7ef4\u62a4\u6bcf\u4e2a\u70b9\u5f53\u524d\u6743\u503c\uff0c\u90a3\u4e48\u4fee\u6539\u70b9\u6743\u5c31\u8f6c\u5316\u4e3a\u4e86\u589e\u52a0\u70b9\u6743\u3002\n\n\u6211\u4eec\u5148\u8003\u8651\u5982\u679c\u6ca1\u6709\u6362\u6839\u64cd\u4f5c\u3002\n\n\u90a3\u4e48\uff0c\u4fee\u6539\u67d0\u4e2a\u70b9\u7684\u6743\u503c\u53ea\u4f1a\u5f71\u54cd\u5b83\u6240\u6709\u7956\u5148\u7684\u201c\u5b50\u6811\u70b9\u6743\u548c\u201d\u3002\n\n\u5148\u6811\u5256\u628a\u95ee\u9898\u8f6c\u5316\u5230\u5e8f\u5217\u4e0a\uff0c\u95ee\u9898\u5c31\u53d8\u6210\u4e86\u533a\u95f4\u52a0\u548c\u7ef4\u62a4\u533a\u95f4\u5e73\u65b9\u548c\u3002\u6211\u4eec\u53ea\u9700\u8981\u5728\u7ebf\u6bb5\u6811\u4e0a\u7ef4\u62a4\u533a\u95f4\u548c\u548c\u533a\u95f4\u5e73\u65b9\u548c\uff0c\u90a3\u4e48\u5982\u679c\u6709\u4e00\u4e2a\u533a\u95f4\u52a0\u6807\u8bb0$a$\uff0c\u533a\u95f4\u548c\u5c31\u53d8\u6210\u4e86$\\sum_i(s_i+a)=a\\times len+\\sum_is_i$\uff0c\u533a\u95f4\u5e73\u65b9\u548c\u53d8\u6210\u4e86$\\sum_i(s_i+a)^2=a^2\\times len+2a\\sum_is_i+\\sum_is_i^2$\uff0c\u76f4\u63a5\u7ef4\u62a4\u5373\u53ef\u3002\n\n\u518d\u6765\u8003\u8651\u6362\u6839\u3002\u5047\u8bbe\u539f\u6765\u7684\u6839\u662f$1$\uff0c\u73b0\u5728\u7684\u6839\u662f$u$\uff0c\u90a3\u4e48\u53ef\u4ee5\u53d1\u73b0\u201c\u5b50\u6811\u70b9\u6743\u548c\u201d\u6539\u53d8\u7684\u70b9\u53ea\u6709\u4ece$1$\u5230$u$\u7684\u8def\u5f84\u4e0a\u7684\u70b9\u3002\u5047\u8bbe\u8fd9\u6761\u8def\u5f84\u662f$1=u_0-u_1-u_2-...-u_k=u$\uff0c\u5bf9\u5e94\u6bcf\u4e2a\u70b9\u7684\u5b50\u6811\u70b9\u6743\u548c\u662f\uff08\u4ee5$1$\u4e3a\u6839\uff09$a_k$\u548c\uff08\u4ee5$u$\u4e3a\u6839\uff09$b_k$\u90a3\u4e48\u7b54\u6848\u662f$ans_u=ans_1-\\sum_{i=0}^ka_i^2+\\sum_{i=0}^kb_i^2$\uff0c\u5176\u4e2d$ans_1$\u662f\u4ee5$1$\u4e3a\u6839\u65f6\u7684\u7b54\u6848\u3002\n\n\u5bb9\u6613\u77e5\u9053$a_{i+1}+b_i=a_0=b_k$\uff08\u90fd\u7b49\u4e8e\u6240\u6709\u70b9\u7684\u70b9\u6743\u603b\u548c\uff09\uff0c\u6240\u4ee5\u6709\n\n$$ans_u=ans_1-\\sum_{i=0}^ka_i^2+\\sum_{i=0}^kb_i^2=ans_1-a_0^2-\\sum_{i=1}^ka_i^2+b_k^2+\\sum_{i=0}^{k-1}(a_0-a_{i+1})^2$$\n\n\u5316\u7b80\u5f97\n\n$$ans_u=ans_1+(k-1)a_0^2-2a_0\\sum_{i=1}^ka_i$$\n\n\u4e8e\u662f\u6211\u4eec\u53ea\u9700\u8981\u7edf\u8ba1\u51fa\u8fd9\u6761\u8def\u5f84\u4e0a\u7684\u70b9\u7684\u4e2a\u6570\u548c\u5b50\u6811\u70b9\u6743\u548c\u7684\u548c\u5373\u53ef\u3002\u4e8e\u662f\u5728\u6811\u5256\u4e0a\u8dd1\u5c31\u53ef\u4ee5\u4e86\u3002\u65f6\u95f4\u590d\u6742\u5ea6$O(nlog^2n)$\uff08\u5982\u679c\u4f60\u975e\u8981\u5199$O(nlogn)$\u7684LCT\u4e5f\u6ca1\u4eba\u62e6\u7740\uff09\n\n\u4ee3\u7801\uff1a\n\n```cpp\n#include <cctype>\n#include <cstdio>\n#include <cstring>\ntypedef long long LL;\nconst LL N = 200050;\nLL n;\n\ninline char readChar() {\n  static char buf[10000000], *p = buf, *end = buf;\n  if (p == end) end = buf + fread(p = buf, sizeof(char), 10000000, stdin);\n  return *(p++);\n}\n\ninline int readInt() {\n  int ans = 0, c, f = 1;\n  while (!isdigit(c = readChar())) if (c == '-') f *= -1;\n  do ans = ans * 10 + c - '0';\n  while (isdigit(c = readChar()));\n  return ans * f;\n}\n\nnamespace TreeChain{\nLL A[N];\nLL s[N];\nLL pre[N], nxt[N * 2], to[N * 2], cnt;\nLL dep[N], node[N], pos[N], top[N], fa[N], siz[N], belong[N], cnt2, cnt3;\n\ninline void addEdge(LL x, LL y) {\n  nxt[cnt] = pre[x];\n  to[pre[x] = cnt++] = y;\n  nxt[cnt] = pre[y];\n  to[pre[y] = cnt++] = x;\n}\n\nvoid dfs1(LL x) {\n  dep[x] = dep[fa[x]] + 1;\n  siz[x] = 1;\n  s[x] = A[x];\n  for (LL i = pre[x]; ~i; i = nxt[i])\n    if (to[i] != fa[x]) {\n      fa[to[i]] = x;\n      dfs1(to[i]);\n      siz[x] += siz[to[i]];\n      s[x] += s[to[i]];\n    }\n}\n\nvoid dfs2(LL x, bool n = false) {\n  if (n) {\n    ++cnt2;\n    top[cnt2] = x;\n  }\n  node[pos[x] = cnt3++] = x;\n  belong[x] = cnt2;\n  if (siz[x] > 1) {\n    LL l = 0;\n    for (LL i = pre[x]; ~i; i = nxt[i])\n      if (to[i] != fa[x] && siz[to[i]] > siz[l])\n        l = to[i];\n    dfs2(l);\n    for (LL i = pre[x]; ~i; i = nxt[i])\n      if (to[i] != fa[x] && to[i] != l)\n        dfs2(to[i], true);\n  }\n}\n\ninline void work() {\n  memset(pre, -1, sizeof pre);\n  for (LL i = 1; i < n; ++i)\n    addEdge(readInt(), readInt());\n  for (LL i = 1; i <= n; ++i)\n    A[i] = readInt();\n  dfs1(1);\n  cnt3 = 1;\n  dfs2(1, true);\n}\n};\n\nnamespace SegTree{\nLL ss[N * 4], ss2[N * 4], addv[N * 4];\n#define lch (o << 1)\n#define rch (o << 1 | 1)\n\ninline void maintain(LL o, LL l, LL r) {\n  using TreeChain::s;\n  using TreeChain::node;\n  if (l == r) {\n    ss[o] = addv[o] + s[node[l]];\n    ss2[o] = ss[o] * ss[o];\n  } else {\n    ss[o] = ss[lch] + ss[rch] + addv[o] * (r - l + 1);\n    ss2[o] = ss2[lch] + ss2[rch] +\n      addv[o] * addv[o] * (r - l + 1) + 2 * addv[o] * (ss[lch] + ss[rch]);\n  }\n}\n\ninline void pushdown(LL o, LL l, LL r) {\n  using TreeChain::s;\n  using TreeChain::node;\n  if (l == r) s[node[l]] += addv[o];\n  else {\n    addv[lch] += addv[o];\n    addv[rch] += addv[o];\n  }\n  addv[o] = 0;\n}\n\nvoid build(LL o, LL l, LL r) {\n  if (l != r) {\n    LL mid = (l + r) / 2;\n    build(lch, l, mid);\n    build(rch, mid + 1, r);\n  }\n  maintain(o, l, r);\n}\n\nvoid modify(LL o, LL l, LL r, LL L, LL R, LL add) {\n  if (l > R || r < L) return;\n  if (r <= R && l >= L)\n    addv[o] += add;\n  else {\n    LL mid = (l + r) / 2;\n    modify(lch, l, mid, L, R, add);\n    modify(rch, mid + 1, r, L, R, add);\n  }\n  maintain(o, l, r);\n}\n\nvoid query(LL o, LL l, LL r, LL L, LL R, LL &ans2, LL &ans) {\n  maintain(o, l, r);\n  if (l > R || r < L) return;\n  if (r <= R && l >= L) {\n    ans2 += ss2[o];\n    ans += ss[o];\n  } else {\n    LL mid = (l + r) / 2;\n    pushdown(o, l, r);\n    query(lch, l, mid, L, R, ans2, ans);\n    query(rch, mid + 1, r, L, R, ans2, ans);\n  }\n}\n};\n\nusing TreeChain::A;\nLL sa = 0;\nLL query(LL x) {\n  using SegTree::query;\n  using TreeChain::belong;\n  using TreeChain::pos;\n  LL ans = 0, ss = 0, tmp;\n  query(1, 1, n, 1, n, ans, tmp);\n  LL k = 0;\n  while (belong[x] != belong[1]) {\n    LL top = TreeChain::top[belong[x]];\n    k += pos[x] - pos[top] + 1;\n    query(1, 1, n, pos[top], pos[x], tmp, ss);\n    x = TreeChain::fa[top];\n  }\n  k += pos[x] - pos[1];\n  query(1, 1, n, pos[1] + 1, pos[x], tmp, ss);\n  return ans + sa * (k * sa - 2 * ss);\n}\n\nvoid modify(LL x, LL y) {\n  using SegTree::modify;\n  using TreeChain::belong;\n  using TreeChain::pos;\n  y -= A[x];\n  A[x] += y;\n  sa += y;\n  while (x) {\n    LL top = TreeChain::top[belong[x]];\n    modify(1, 1, n, pos[top], pos[x], y);\n    x = TreeChain::fa[top];\n  }\n}\n\nint main() {\n  n = readInt();\n  LL q = readInt();\n  TreeChain::work();\n  sa = TreeChain::s[1];\n  SegTree::build(1, 1, n);\n  while (q--) {\n    if (readInt() == 1) {\n      LL x = readInt();\n      LL y = readInt();\n      modify(x, y);\n    } else {\n      LL x = readInt();\n      printf(\"%lld\\n\", query(x));\n    }\n  }\n  return 0;\n}\n```",
        "postTime": 1514167679,
        "uid": 7868,
        "name": "_rqy",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P3676 \u3010\u5c0f\u6e05\u65b0\u6570\u636e\u7ed3\u6784\u9898\u3011"
    },
    {
        "content": "\u611f\u89c9\u6700\u5c0f\u6e05\u65b0\u7684\u5176\u5b9e\u662f\u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\u9898\u554a\uff0c~~\u94fe\u5256\u76f4\u63a5\u66b4\u529b\u8ba8\u8bba\u4e00\u6ce2\u5c31\u8279\u8fc7\u53bb\u4e86\u597d\u6c14\u554a~~\uff0c\u4e0b\u9762\u6765\u8bb2\u4e00\u79cd\u6bd4\u8f83\u5bb9\u6613work~~\u5168\u662f\u677f\u5b50~~\u7684$O(nlogn)$\u505a\u6cd5\u3002\n\n\n\u9996\u5148\u6211\u4eec\u53d1\u73b0\u6709\u4e00\u4e2a\u826f\u5fc330\u5206\u90e8\u5206\u5206\uff0c\u6bcf\u6b21\u8be2\u95ee\u6839\u90fd\u4e3a1\uff0c\u8fd9\u4e2a\u8981\u600e\u4e48\u641e\u5462\uff1f\n\n\n\u6211\u4eec\u7684\u8981\u6c42\u5c31\u662f\u628a\u4e00\u4e2a\u70b9\u5230\u6839\u7684\u8def\u5f84\u4e0a\u7684\u5b50\u6811\u548c\u5168\u90e8\u52a0\u4e0a\u4e00\u4e2a\u503c\uff0c\u8be2\u95ee\u6240\u6709\u70b9\u5b50\u6811\u5e73\u65b9\u548c\u3002\n\n\n\u8003\u8651\u5bf9\u4e00\u4e2a\u70b9x\u70b9\u6743+y\u5bf9\u7b54\u6848\u7684\u8d21\u732e\uff0c\u6211\u4eec\u53d1\u73b0\u5bf9\u4e8e\u6bcf\u4e2ax\u7684\u7236\u4eb2f\uff0c\u5047\u8bbe\u539f\u6765\u70b9\u6743\u548c\u4e3ap\uff0c\u73b0\u5728\u5c31\u53d8\u6210\u4e86p+y\uff0c\u90a3\u4e48\u5bf9\u7b54\u6848\u8d21\u732e\u5c31\u662f$(p+y)^2-p^2=2py+y^2$\uff0c\u6211\u4eec\u53ea\u8981\u7edf\u8ba1x\u5230\u6839\u7684\u70b9\u6743\u548c\u5373\u53ef\u3002\n\n\n\u90a3\u4e48\u6211\u4eec\u53ea\u8981\u652f\u6301\u5c06\u4e00\u4e2a\u70b9\u5230\u6839\u7684\u8def\u5f84\u70b9\u6743\u52a0\u4e0a\u4e00\u4e2a\u6570\u548c\u7edf\u8ba1\u4e00\u4e2a\u70b9\u5230\u6839\u7684\u70b9\u6743\u548c\uff0c\u76f4\u63a5\u6811\u94fe\u5256\u5206\u5c31\u53ef\u4ee5\u505a\u5230\u4e24\u4e2alog\uff0c\u5f53\u7136\u5982\u679c\u4f60\u8ffd\u6c42\u7406\u8bba\u590d\u6742\u5ea6\u90a3\u4e48\u7528lct\u5c31\u53ef\u4ee5\u505a\u5230\u4e00\u4e2alog\u3002\n\n\n\u73b0\u5728\u8003\u8651\u6ee1\u5206\uff0c\u6211\u4eec\u53d1\u73b0\u8fd9\u4e2a\u5e73\u65b9\u5341\u5206\u9ebb\u70e6\uff0c\u4e0d\u59a8\u8003\u8651\u5982\u679c\u6ca1\u6709\u5e73\u65b9\u600e\u4e48\u505a\uff0c\u5373\u8981\u4ee5\u70b9p\u4e3a\u6839\u8003\u8651\u6574\u68f5\u6811\uff0c\u6c42\u51fa\u6bcf\u4e2a\u70b9\u5b50\u6811\u7684\u70b9\u6743\u548c\uff0c\u76f4\u63a5\u52a0\u5728\u4e00\u8d77\u3002\n\n\n\u8003\u8651\u4e00\u4e2a\u70b9s\u7684\u70b9\u6743$v_s$\u53ea\u6709\u5b83\u53ca\u7956\u5148\u624d\u4f1a\u8ba1\u5165\uff0c\u5373\u8ba1\u5165\u4e86$dis(s,p)+1$\u6b21\uff0c\u90a3\u4e48\u6ca1\u6709\u5e73\u65b9\u7684\u7b54\u6848\u5c31\u662f$\\sum_{i=1}^n dis(p,i)v_i+\\sum_{i=1}^n v_i$\uff0c\u8fd9\u4e2a\u4e1c\u897f\u663e\u7136\u662f\u53ef\u4ee5\u7528\u52a8\u6001\u70b9\u5206\u6cbb\u7ef4\u62a4\u7684\uff0c\u53c2\u89c1bzoj3924\u3002\n\n\n\u73b0\u5728\u95ee\u9898\u5c31\u662f\u8fd9\u4e2a\u5e73\u65b9\uff0c\u6211\u4eec\u8bbe$s_x$\u4e3ax\u5b50\u6811\u7684\u70b9\u6743\u548c\uff0cw\u4e3a\u70b9\u6743\u603b\u548c\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0$\\sum_{i=1}^n s_i(w-s_i)$\u65e0\u8bba\u6839\u662f\u5565\u90fd\u662f\u4e00\u4e2a\u5b9a\u503c\u3002\n\n\n\u8bc1\u660e\u5341\u5206\u7b80\u5355\uff0c\u8003\u8651\u5bf9\u4e8e\u6bcf\u5bf9\u70b9(i,j)\uff0c\u5728i\u5230j\u7684\u8def\u5f84\u4e0a\u6bcf\u6761\u8fb9\u90fd\u52a0\u4e0a$v_iv_j$\u7684\u6743\u503c\uff0c\u90a3\u4e48i\u5f80\u7236\u4eb2\u8fb9\u6743\u7684\u5c31\u662f$s_i(w-s_i)$\uff0c\u56e0\u4e3a\u8981\u5728\u81ea\u5df1\u5b50\u6811\u4e2d\u9009\u4e00\u4e2a\u70b9\u6743\uff0c\u5916\u9762\u9009\u4e00\u4e2a\uff0c\u663e\u7136\u52a0\u5728\u4e00\u8d77\u503c\u4e0d\u4f1a\u53d8\u3002\n\n\n\u90a3\u4e48\u6211\u4eec\u57281\u4e3a\u6839\u7684\u65f6\u5019\u6c42\u51fa$\\sum_{i=1}^n s_iw-s_i^2$\uff0c\u7136\u540e\u5728p\u4e3a\u6839\u65f6\u6c42\u51fa$\\sum_{i=1}^n s_i$\uff0c\u628a$\\sum_{i=1}^n s_i^2$\u89e3\u51fa\u6765\u5373\u53ef\u3002\n",
        "postTime": 1489932332,
        "uid": 4134,
        "name": "fjzzq2002",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P3676 \u3010\u5c0f\u6e05\u65b0\u6570\u636e\u7ed3\u6784\u9898\u3011"
    },
    {
        "content": "\u9898\u610f:\u6c42\u5f53u\u4e3a\u6839\u65f6,\u6240\u6709\u5b50\u6811\u7684\u70b9\u6743\u548c\u7684\u5e73\u65b9\u548c,\u5e26\u4fee\u6539\n\n\u8003\u8651\u6ca1\u6709\u6362\u6839\u7684\u64cd\u4f5c(\u5047\u8bbe\u5f53\u524d\u6839\u662f$1$)\u5982\u4f55\u8ba1\u7b97\u6240\u6c42\n\n\u8003\u8651\u5230\u4fee\u6539\u4e00\u4e2a\u70b9u\u7684\u6743\u503c,\u53ea\u4f1a\u5f71\u54cd\u5230$path(1,u)$\u4e0a\u7684\u70b9\u7684\u5b50\u6811\u70b9\u6743\u548c\n\n\u8bb0$s_i$\u4e3a$i$\u5b50\u6811\u7684\u70b9\u6743\u548c,\u628a\u4fee\u6539\u53d8\u6210\u589e\u52a0,\u90a3\u4e48\u5176\u8d21\u732e\u5c31\u662f\n\n$\\sum_{i\\in path(1,u)}(s_i+a)^2-\\sum_{i\\in path(1,u)}s_i^2=a^2len+2a\\sum_{i\\in path(1,u)}s_i$\n\n\u6240\u4ee5\u53ea\u8981$dfs$\u9884\u5904\u7406\u51fa$ans=\\sum_{i=1}^ns_i^2$\u7136\u540e\u7ef4\u62a4$\\sum_{i\\in path(1,u)}s_i$\u5c31$ok$\u4e86\n\n\u6ce8\u610f\u4fee\u6539\u5b8c\u8fd8\u8981$ans+=a^2len+2a\\sum_{i\\in path(1,u)}s_i$\n\n\u8003\u8651\u6709\u6362\u6839\u7684\u64cd\u4f5c\u600e\u4e48\u529e?\n\n\u5176\u5b9e\u5b50\u6811\u70b9\u6743\u548c\u53d7\u5230\u5f71\u54cd\u7684\u8fd8\u662fpath(1,u)\u4e0a\u7684\u70b9\n\n\u8bbe$path(1,u)$\u4e0a\u7684\u70b9\u4e3a$v_1,v_2,\\ldots,v_k$(\u8fde\u7eed\u7684)\n\n\u5bf9\u5e94\u6bcf\u4e2a\u70b9$v_i$\u7684\u5b50\u6811\u70b9\u6743\u548c\u662f$a_i$(\u4ee5$1$\u4e3a\u6839)\u548c$b_i$(\u4ee5$u$\u4e3a\u6839)\n\n\u6ce8\u610f\u5230$a_{i+1}+b_i=a_1=b_k$($ans_u$\u8868\u793a\u5f53\u6839\u662f$u$\u65f6\u7684\u7b54\u6848)\n\n$ans_u=ans_1-\\sum_{i=1}^ka_i^2+\\sum_{i=1}^kb_i^2$\n\n$=ans_1-\\sum_{i=1}^ka_i^2+\\sum_{i=1}^{k-1}(a_1-a_{i+1})^2+b_k^2$\n\n$=ans_1-\\sum_{i=2}^ka_i^2+\\sum_{i=2}^{k}(a_1-a_i)^2$\n\n$=ans_1+(k-1)a_1^2-2a_1\\sum_{i=2}^ka_i$\n\n$=ans+s_1[(k-1)s_1-2(\\sum_{i\\in path(1,u)}^ks_i-s_1)]$\n\n$=ans+s_1[(k+1)s_1-2\\sum_{i\\in path(1,u)}^ks_i]$\n\n\u6811\u4e0a\u8def\u5f84\u70b9\u6743\u548c\u663e\u7136\u53ef\u4ee5\u7528\u6811\u5256\u6216\u8005LCT\u7ef4\u62a4\n\n\u6811\u5256\u7684\u8bdd\u6ca1\u5fc5\u8981\u5199\u7ebf\u6bb5\u6811,\u6811\u72b6\u6570\u7ec4\u5c31\u597d\u4e86\n\n\u6811\u5256+BIT\n```\n#include<bits/stdc++.h>\n#define fp(i,a,b) for(int i=a,I=b;i<=I;++i)\n#define fd(i,a,b) for(int i=a,I=b;i>=I;--i)\n#define go(i,u) for(int i=fi[u],v=e[i].to;i;v=e[i=e[i].nx].to)\nusing namespace std;\nconst int N=2e5+5;\ntypedef int arr[N];\ntypedef long long ll;\nstruct eg{int nx,to;}e[N<<1];\nint n,m,ce,cnt;arr w,c,fi,fa,sz,id,pos,dep,son,top;ll ans,c1[N],c2[N];\nvoid dfs(int u){\n\tdep[u]=dep[fa[u]]+(sz[u]=1);\n\tgo(i,u)if(v^fa[u]){\n\t\tfa[v]=u,dfs(v),w[u]+=w[v],sz[u]+=sz[v];\n\t\tif(sz[v]>sz[son[u]])son[u]=v;\n\t}ans+=1ll*w[u]*w[u];\n}\ninline void Mdy(int x,ll w){for(int i=x;i<=n;i+=i&(-i))c1[i]+=w,c2[i]+=(ll)x*w;}\ninline ll Qry(int x){ll w=0;for(int i=x;i;i-=i&(-i))w+=1ll*(x+1)*c1[i]-c2[i];return w;}\nvoid dfs(int u,int t){\n\ttop[u]=t;pos[id[u]=++cnt]=u;\n\tMdy(id[u],w[u]-w[pos[cnt-1]]);\n\tif(son[u])dfs(son[u],t);\n\tgo(i,u)if(v^fa[u]&&v^son[u])dfs(v,v);\n}\ninline ll qry(int u){\n\tint k=0,x=Qry(1);ll s=0;\n\tfor(;u;u=fa[top[u]])\n\t\tk+=id[u]-id[top[u]]+1,\n\t\ts+=Qry(id[u])-Qry(id[top[u]]-1);\n\treturn ans+x*((k+1)*x-(s<<1));\n}\ninline void mdy(int u,int x){\n\tint k=0;ll s=0;\n\tfor(;u;u=fa[top[u]])\n\t\tk+=id[u]-id[top[u]]+1,\n\t\ts+=Qry(id[u])-Qry(id[top[u]]-1),\n\t\tMdy(id[top[u]],x),Mdy(id[u]+1,-x);\n\tans+=x*(x*k+(s<<1));\n}\ninline void add(int u,int v){e[++ce]=eg{fi[u],v};fi[u]=ce;}\nint main(){\n\tscanf(\"%d%d\",&n,&m);int u,v,o;\n\tfp(i,2,n)scanf(\"%d%d\",&u,&v),add(u,v),add(v,u);\n\tfp(i,1,n)scanf(\"%d\",c+i),w[i]=c[i];dfs(1);dfs(1,1);\n\twhile(m--)\n\t\tscanf(\"%d%d\",&o,&u),\n\t\to==1?scanf(\"%d\",&v),v-=c[u],c[u]+=v,mdy(u,v):(void)printf(\"%lld\\n\",qry(u));\nreturn 0;\n}\n```\n\nLCT\n```\n#include<bits/stdc++.h>\n#define fp(i,a,b) for(int i=a,I=b;i<=I;++i)\n#define fd(i,a,b) for(int i=a,I=b;i>=I;--i)\n#define go(i,u) for(int i=fi[u],v=e[i].to;i;v=e[i=e[i].nx].to)\nusing namespace std;\nconst int N=2e5+5;\ntypedef int arr[N];\ntypedef long long ll;\nstruct eg{int nx,to;}e[N<<1];\nint n,m,ce;arr w,c,fi;ll ans;\nint top,ch[N][2];arr S,rev,sz,fa,tg;ll s[N];\n#define lc(u)(ch[u][0])\n#define rc(u)(ch[u][1])\ninline void down(int p){\n\tif(rev[p]){\n\t\trev[lc(p)]^=1,rev[rc(p)]^=1;\n\t\tswap(lc(p),rc(p)),rev[p]=0;\n\t}w[p]+=tg[p];\n\tfp(i,0,1){\n        int k=ch[p][i];\n        tg[k]+=tg[p];\n        s[k]+=tg[p]*sz[k];\n    }tg[p]=0;\n}\ninline void up(int p){\n\ts[p]=w[p]+s[lc(p)]+s[rc(p)];\n\tsz[p]=sz[lc(p)]+sz[rc(p)]+1;\n}\ninline bool gf(int u){return rc(fa[u])==u;}\ninline bool ir(int u){return lc(fa[u])!=u&&rc(fa[u])!=u;}\ninline void rot(int u){\n\tint p=fa[u],k=gf(u);\n\tif(!ir(p))ch[fa[p]][gf(p)]=u;\n\tif(ch[u][!k])fa[ch[u][!k]]=p;\n\tch[p][k]=ch[u][!k],ch[u][!k]=p;\n\tfa[u]=fa[p],fa[p]=u,up(p);\n}\nvoid splay(int u){\n\tS[top=1]=u;\n\tfor(int i=u;!ir(i);i=fa[i])S[++top]=fa[i];\n\tfd(i,top,1)down(S[i]);\n\tfor(int f=fa[u];!ir(u);rot(u),f=fa[u])\n\t\tif(!ir(f))rot(gf(u)==gf(f)?f:u);\n\tup(u);\n}\ninline void acc(int u){for(int v=0;u;u=fa[v=u])splay(u),ch[u][1]=v,up(u);}\ninline void mkrt(int u){acc(u),splay(u),rev[u]=1;}\ninline void close(int u,int v){mkrt(u),acc(v),splay(v);}\ninline void link(int u,int v){mkrt(u),fa[u]=v;}\nvoid dfs(int u){go(i,u)if(v^fa[u])fa[v]=u,dfs(v),w[u]+=w[v];ans+=1ll*w[u]*w[u];}\ninline ll qry(int u){return close(u,1),ans+w[1]*(1ll*(sz[1]+1)*w[1]-(s[1]<<1));}\ninline void mdy(int u,int x){close(u,1),ans+=x*(x*sz[1]+(s[1]<<1)),tg[1]+=x,s[1]+=sz[1]*x;}\ninline void add(int u,int v){e[++ce]=eg{fi[u],v};fi[u]=ce;}\nint main(){\n\tscanf(\"%d%d\",&n,&m);int u,v,o;\n\tfp(i,2,n)scanf(\"%d%d\",&u,&v),add(u,v),add(v,u);\n\tfp(i,1,n)scanf(\"%d\",c+i),w[i]=c[i];dfs(1);\n\twhile(m--)\n\t\tscanf(\"%d%d\",&o,&u),\n\t\to==1?scanf(\"%d\",&v),v-=c[u],c[u]+=v,mdy(u,v):(void)printf(\"%lld\\n\",qry(u));\nreturn 0;\n}\n```\n\n\u867d\u8bf4\u6811\u5256\u590d\u6742\u5ea6\u662f$O(n\\log^2n)$,$LCT$\u590d\u6742\u5ea6\u662f$O(n\\log n)$,\u4f46\u662f\u6211\u4e0d\u5f97\u4e0d\u611f\u53f9$LCT$\u5e38\u6570\u771f\u5927",
        "postTime": 1518955822,
        "uid": 20156,
        "name": "Kelin",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P3676 \u3010\u5c0f\u6e05\u65b0\u6570\u636e\u7ed3\u6784\u9898\u3011"
    },
    {
        "content": "[\u4f20\u9001\u95e8][1]\n\n#sol\n\u6211\u4eec\u8bbe$s_i$\u8868\u793a\u4ee5$p$\u4e3a\u6574\u68f5\u6811\u7684\u6839\u65f6\uff0c\u4ee5$i$\u4e3a\u6839\u7684\u5b50\u6811\u7684\u70b9\u6743\u548c\u3002\u8bbe$Sum$\u8868\u793a\u6240\u6709\u70b9\u7684\u70b9\u6743\u548c\uff0c\u5373$Sum=\\sum_{i=1}^{n}val_i$\u3002\n\n\u6240\u4ee5\u8fd9\u9053\u9898\u7ed9\u51fa$p$\uff0c\u5c31\u662f\u8981\u4f60\u6c42$\\sum_{i=1}^{n}s_i^2$\u3002\n\n\n\u6211\u4eec\u5148\u770b$\\sum_{i=1}^{n}s_i$\u600e\u4e48\u6c42\u3002\n\n\u8003\u8651\u6bcf\u4e2a\u70b9\u7684\u70b9\u6743\u5bf9$\\sum_{i=1}^{n}s_i$\u7684\u8d21\u732e\uff0c\u53ef\u4ee5\u53d1\u73b0\uff0c\u6bcf\u4e2a\u70b9\u88ab\u8ba1\u7b97\u4e86$dep_i+1$\u6b21\uff0c\u4e5f\u5c31\u662f\u8bf4$\\sum_{i=1}^{n}s_i=\\sum_{i=1}^{n}val_i(dep_i+1)=\\sum_{i=1}^{n}val_idep_i+Sum$\u3002\u524d\u9762\u90a3\u4e00\u5768\u662f\u4e0d\u662f\u6709\u70b9\u719f\u6089\uff1f[\u3010ZJOI2015\u3011\u5e7b\u60f3\u4e61\u6218\u7565\u6e38\u620f][2]\u3002\n\n\u4e0b\u6587\u4e2d\u4e3a\u4e86\u65b9\u4fbf\u63cf\u8ff0\uff0c\u4ee4$calc(p)$\u8868\u793a\u4ee5$p$\u4e3a\u6839\u65f6\u7684$\\sum_{i=1}^{n}val_idep_i$\n\n\n\u63a5\u4e0b\u6765\u6211\u4eec\u8003\u8651\u4e00\u4e0b\u8fd9\u4e2a\u4e1c\u897f\n\n$$\\sum_{i=1}^{n}\\sum_{j=1}^{n}val_ival_jdis(i,j)$$\n\n\u8fd9\u4e2a\u53ef\u4ee5\u5f62\u8c61\u5730\u7406\u89e3\u4e3a\uff0c\u5728\u6bcf\u4e00\u5bf9\u70b9\u5bf9$(i,j)$\u7684\u8def\u5f84\u4e0a\u6bcf\u4e00\u6761\u8fb9\uff08\u521a\u597d\u662f$dis(i,j)$\u6761\u8fb9\uff09\u4e0a\u90fd\u52a0\u4e0a$val_ival_j$\uff0c\u7136\u540e\u6c42\u6574\u68f5\u6811\u4e0a\u7684\u8fb9\u6743\u4e4b\u548c\u3002\n\n\n\u73b0\u5728\u6211\u4eec\u8003\u8651\u6bcf\u4e00\u6761\u8fb9\u4e0a\u7684\u6743\u503c\uff0c\u5b83\u5e94\u8be5\u7b49\u4e8e\u5b83\u4e24\u4fa7\u8fde\u63a5\u7684\u4e24\u5768\u6811\u7684\u70b9\u6743\u548c\u7684\u4e58\u79ef\u3002\u800c\u8fde\u63a5\u7684\u8fd9\u4e24\u5768\u6811\u4e2d\uff0c\u4e0d\u8bba\u53d6\u54ea\u4e2a$p$\u4e3a\u6839\uff0c\u90fd\u6709\u6709\u4e14\u4ec5\u6709\u4e00\u5768\u6811\u4f1a\u662f\u4e00\u68f5\u5b50\u6811\u3002\u6240\u4ee5\u8fd9\u4e2a\u6743\u503c\u4f1a\u7b49\u4e8e$s_i(Sum-s_i)$\u3002\u6240\u4ee5\n\n$$\\sum_{i=1}^{n}\\sum_{j=1}^{n}val_ival_jdis(i,j)=\\sum_{i=1}^{n}s_i(Sum-s_i)$$\n\n\u8fd9\u540c\u65f6\u4e5f\u8bc1\u660e\u4e86\u4e0d\u8bba\u53d6\u54ea\u4e2a$p$\u4f5c\u4e3a\u6839\uff0c$\\sum_{i=1}^{n}s_i(Sum-s_i)$\u90fd\u4e0d\u4f1a\u53d8\u3002\n\n\n\u4ee4$W=\\sum_{i=1}^{n}s_i(Sum-s_i)$\uff0c\u53ef\u4ee5\u5148$O(n)$\u5730$DP$\u51fa$W$\u7684\u521d\u503c\uff0c\u7136\u540e\u5c31\u53ea\u8981\u8003\u8651\u4e00\u4e2a\u70b9\u6743\u4fee\u6539\u5bf9$W$\u7684\u5f71\u54cd\u3002\n\n\u56e0\u4e3a$W=\\sum_{i=1}^{n}\\sum_{j=1}^{n}val_ival_jdis(i,j)$\uff0c\u82e5\u8282\u70b9$i$\u7684\u70b9\u6743\u7684\u53d8\u5316\u91cf\u4e3a$\\Delta v$\uff0c\u90a3\u4e48$\\Delta W=\\Delta v\\sum_{j=1}^{n}val_jdis(i,j)$\uff0c\u76f8\u5f53\u4e8e$\\Delta v*calc(i)$\uff0c\u6240\u4ee5\u8bf4\u4e00\u6837\u5730\u8ba1\u7b97\u5373\u53ef\u3002\n\n\u6240\u4ee5\u6700\u7ec8\u8be2\u95ee\u7684\u7b54\u6848\u5c31\u662f\uff1a\n\n$$\\sum_{i=1}^{n}s_i^2=Sum*\\sum_{i=1}^{n}s_i-W=Sum(calc(i)+Sum)-W$$\n\n##code\n```cpp\n#include<cstdio>\n#include<algorithm>\nusing namespace std;\n#define ll long long\nconst int N = 200005;\nint gi()\n{\n    int x=0,w=1;char ch=getchar();\n    while ((ch<'0'||ch>'9')&&ch!='-') ch=getchar();\n    if (ch=='-') w=0,ch=getchar();\n    while (ch>='0'&&ch<='9') x=(x<<3)+(x<<1)+ch-'0',ch=getchar();\n    return w?x:-x;\n}\nstruct edge{int to,next;}a[N<<1];\nint n,q,val[N],head[N],cnt,pa[N],dep[N],sz[N],son[N],top[N];\nvoid dfs1(int u,int f)\n{\n    pa[u]=f;dep[u]=dep[f]+1;sz[u]=1;\n    for (int e=head[u];e;e=a[e].next)\n    {\n        int v=a[e].to;if (v==f) continue;\n        dfs1(v,u);\n        sz[u]+=sz[v];if (sz[v]>sz[son[u]]) son[u]=v;\n    }\n}\nvoid dfs2(int u,int f)\n{\n    top[u]=f;\n    if (son[u]) dfs2(son[u],f);else return;\n    for (int e=head[u];e;e=a[e].next)\n        if (a[e].to!=pa[u]&&a[e].to!=son[u])\n            dfs2(a[e].to,a[e].to);\n}\nint lca(int u,int v)\n{\n    while (top[u]^top[v])\n    {\n        if (dep[top[u]]<dep[top[v]]) swap(u,v);\n        u=pa[top[u]];\n    }\n    return dep[u]<dep[v]?u:v;\n}\nint getdis(int u,int v){return dep[u]+dep[v]-(dep[lca(u,v)]<<1);}\nint tot,root,vis[N],w[N],fa[N];\nll sum[N],gather[N],tofa[N],sigma,omega,ans;\nvoid getroot(int u,int f)\n{\n    sz[u]=1;w[u]=0;\n    for (int e=head[u];e;e=a[e].next)\n    {\n        int v=a[e].to;if (v==f||vis[v]) continue;\n        getroot(v,u);\n        sz[u]+=sz[v];w[u]=max(w[u],sz[v]);\n    }\n    w[u]=max(w[u],tot-sz[u]);\n    if (w[u]<w[root]) root=u;\n}\nvoid solve(int u,int f)\n{\n    fa[u]=f;vis[u]=1;\n    for (int e=head[u];e;e=a[e].next)\n    {\n        int v=a[e].to;if (vis[v]) continue;\n        tot=sz[v];\n        root=0;\n        getroot(v,0);\n        solve(root,u);\n    }\n}\nvoid modify(int u,int v)\n{\n    sum[u]+=v;\n    for (int i=u;fa[i];i=fa[i])\n    {\n        int dist=getdis(u,fa[i]);\n        sum[fa[i]]+=v;\n        gather[fa[i]]+=dist*v;\n        tofa[i]+=dist*v;\n    }\n}\nll calc(int u)\n{\n    ll res=gather[u];\n    for (int i=u;fa[i];i=fa[i])\n    {\n        int dist=getdis(u,fa[i]);\n        res+=(ll)dist*(sum[fa[i]]-sum[i]);\n        res+=gather[fa[i]]-tofa[i];\n    }\n    return res;\n}\nvoid DP(int u)\n{\n    sz[u]=val[u];\n    for (int e=head[u];e;e=a[e].next)\n    {\n        int v=a[e].to;if (v==pa[u]) continue;\n        DP(v);sz[u]+=sz[v];\n    }\n    omega+=1ll*sz[u]*(sigma-sz[u]);\n}\nint main()\n{\n    n=gi();q=gi();\n    for (int i=1;i<n;i++)\n    {\n        int u=gi(),v=gi();\n        a[++cnt]=(edge){v,head[u]};head[u]=cnt;\n        a[++cnt]=(edge){u,head[v]};head[v]=cnt;\n    }\n    dfs1(1,0);dfs2(1,1);\n    tot=w[0]=n;\n    getroot(1,0);\n    solve(root,0);\n    for (int i=1;i<=n;i++)\n        val[i]=gi(),modify(i,val[i]),sigma+=val[i];\n    DP(1);\n    while (q--)\n    {\n        int opt=gi(),x=gi();\n        if (opt==1)\n        {\n            int y=gi();\n            modify(x,y-val[x]);sigma+=y-val[x];\n            omega+=(y-val[x])*calc(x);\n            val[x]=y;\n        }\n        else printf(\"%lld\\n\",(calc(x)+sigma)*sigma-omega);\n    }\n    return 0;\n}\n```\n\n\n  [1]: http://www.cnblogs.com/zhoushuyu/p/8309410.html\n\n[2]: http://www.cnblogs.com/zhoushuyu/p/8277944.html\n",
        "postTime": 1516247774,
        "uid": 47654,
        "name": "\u79df\u9165\u96e8",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P3676 \u3010\u5c0f\u6e05\u65b0\u6570\u636e\u7ed3\u6784\u9898\u3011"
    },
    {
        "content": "\u9996\u5148\u6211\u4eec\u8981\u53d1\u73b0\u4e00\u4e2a\u6027\u8d28\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u68f5\u6811\uff0c\u6211\u4eec\u6362\u4e86\u4e00\u4e2a\u6839\uff08\u628a\u539f\u672c\u6839\u7684\u67d0\u4e2a\u513f\u5b50$v_1$\u8bb0\u6210\u65b0\u7684\u6839\uff09\n\n\u6211\u4eec\u8bb0\u8fd9\u4e2a\u6811\u7684\u6743\u503c\u548c\u4e3asum\uff0c\u6bcf\u4e2a\u5b50\u6811\u7684\u6743\u503c\u548c\u4e3a$S[i]$\uff0c\u5bf9\u4e8e\u6bcf\u6b21\u6362\u6839\uff0c\u53d7\u5f71\u54cd\u7684$S[i]$\u53ea\u6709\u6839\u672c\u8eab\u548c$v_1$\uff0c\u5e76\u4e14\u6ee1\u8db3\uff1a$S[rt]->sum - S[v_1]$, $S[v_1] -> S[rt]$\n\n\u4e8e\u662f\u6211\u4eec\u80fd\u60ca\u4eba\u7684\u53d1\u73b0\uff1a$\\sum (sum - S[i]) * S[i]$\u662f\u4e00\u4e2a\u5b9a\u503c\uff01\uff01\uff01\n\n\u628a\u4ed6\u62c6\u5f00\uff1a$sum * \\sum S[i] - \\sum S[i] ^ 2$\n\n\u800c\u6211\u4eec\u8981\u6c42\u7684\u6b63\u662f$\\sum S[i] ^ 2$\uff0c\u4e8e\u662f\u6211\u4eec\u53ea\u8981\u7ef4\u62a4$sum * \\sum S[i]$\n\n\u56e0\u4e3a\u6211\u4eec\u4f1a\u4fee\u6539\u6743\u503c\uff0c\u53d1\u73b0$sum$\u503c\u5f88\u597d\u7ef4\u62a4\uff0c\u4e8e\u662f\u6211\u4eec\u53ea\u9700\u8981\u7ef4\u62a4$\\sum S[i]$\u5373\u53ef\n\n\u6211\u4eec\u5047\u8bbe\u4ee5x\u4e3a\u6839\uff0c\u90a3\u4e48$\\sum S[i] = \\sum (dep[i] + 1) * val[i] = sum + \\sum dep[i] * val[i]$\n\n\u82e5\u6211\u4eec\u4e0d\u7528\u91cd\u65b0\u6c42$dep$\uff0c\u67ff\u5b50\u5373\u5316\u4e3a\uff1a$\\sum S[i] = sum + \\sum val[i] * dis(i, x) $\n\n\u8fd9\u4e2a\u5f0f\u5b50\u5c31\u662f\u52a8\u6001\u70b9\u5206\u6cbb\u7684\u6a21\u677f\u4e86\uff0c\u4f46\u662f\u6211\u4eec\u5176\u5b9e\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\uff1a\u5c31\u662f\u6211\u4eec\u7684\u90a3\u4e2a\u5b9a\u503c\uff08$\\sum (sum - S[i]) * S[i]$\uff09\u8981\u600e\u4e48\u6c42\u5462\uff1f\n\n\u6211\u4eec\u8fd8\u662f\u5bf9\u6bcf\u4e2a\u70b9\u5206\u5f00\u8003\u8651\uff1a\u4e0a\u8ff0\u67ff\u5b50\u7684\u610f\u4e49\u5b9e\u9645\u4e0a\u662f\u6c42\u51fa\u6240\u6709\u70b9\u7684\u5b50\u6811\u548c * (\u603b\u7684\u5b50\u6811\u548c - \u8be5\u70b9\u5b50\u6811\u548c)\n\n\u6211\u4eec\u5206\u5f00\u8003\u8651\u6bcf\u4e00\u5bf9\u70b9$(i, j)$\u7684\u8d21\u732e\uff0c\u5373\u4e24\u4e2a\u70b9\u88ab\u5206\u5728\u4e0d\u540c\u96c6\u5408\u7684\u4e2a\u6570*\u6743\u503c\u4e4b\u79ef\n\n\u4e8e\u662f\u8fd9\u4e2a\u5f0f\u5b50\u5176\u5b9e\u53ef\u4ee5\u8f6c\u5316\u4e3a$\\sum_{i = 1}^n\\sum_{j = i+ 1}^nval[i] * val[j] * dis(i, j)$\n\n\u628a$val[i]$\u63d0\u524d\uff0c\u6211\u4eec\u5f97\u5230\uff1a$\\sum_{i = 1} ^ n val[i] * \\sum_{j = i + 1} ^ n val[j] * dis(i, j)$\n\n\u6240\u4ee5\u6bcf\u4e00\u6b21\u4fee\u6539($a[x] \\to y$)\uff0c\u53d8\u5316\u91cf\u5373\u4e3a$(y - a[x]) *\\sum val[j] * dis(j, i)$\n\n\u8fd9\u4e0d\u5c31\u662f$\\sum S[i]$\u5417\uff1f\uff1f\uff1f\n\n\u4e8e\u662f\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5f97\u5230\uff1a\n$$\\sum (sum - S[i]) * S[i] = sum * \\sum S[i] - \\sum S[i] ^ 2$$\n\n$$\\sum S[i] ^ 2 = sum * \\sum S[i] - \\sum (sum - S[i]) * S[i]$$\n\n$sum - 1$\u76f4\u63a5\u7ef4\u62a4\uff0c$\\sum S[i]$\u7528\u52a8\u6001\u70b9\u5206\u6cbb\u6765\u7ef4\u62a4\uff0c\u540e\u9762\u90a3\u4e00\u5806\u6211\u4eec\u53ef\u4ee5\u6839\u636e$\\sum S[i]$\u6765\u7ef4\u62a4\uff0c\u4e8e\u662f\u6211\u4eec\u5c31\u505a\u5b8c\u4e86\u3002\n\n\u7ec8\u4e8e\u628a\u5495\u4e86\u4e00\u5e74\u591a\u7684\u4ee3\u7801\u8865\u4e0a\u4e86\u3002\n```cpp\n/* This code is written by Nemlit */\n#include<bits/stdc++.h>\nusing namespace std;\n#define il inline\n#define re register\n#define rep(i, a, b) for(re int i = (a); i <= (b); ++ i)\n#define Next(i, u) for(re int i = head[u]; i; i = e[i].next)\n#define int long long\nil int read() {\n    re int x = 0, f = 1; re char c = getchar();\n    while(c < '0' || c > '9') { if(c == '-') f = -1; c = getchar();}\n    while(c >= '0' && c <= '9') x = x * 10 + c - 48, c = getchar();\n    return x * f;\n}\n#define maxn 200005\nint head[maxn], cnt, n, m, rt, N, A[maxn], vis[maxn], S, temp, R, a[maxn], w[maxn], f[maxn], Fa[maxn], g[maxn], dp[maxn];\nint son[maxn], fa[maxn], dep[maxn], size[maxn], top[maxn];\nstruct edge { int v, next; }e[maxn << 1];\nil void add(int u, int v) { e[++ cnt] = (edge){v, head[u]}, head[u] = cnt; }\nil int LCA(int u, int v) {\n\twhile(top[u] != top[v]) dep[top[u]] > dep[top[v]] ? u = fa[top[u]] : v = fa[top[v]];\n\treturn dep[u] > dep[v] ? v : u;\n}\nil void dfs1(int u, int fr) {\n\tsize[u] = 1, fa[u] = fr, dep[u] = dep[fr] + 1;\n\tNext(i, u) {\n\t\tint v = e[i].v;\n\t\tif(v == fr) continue;\n\t\tdfs1(v, u), size[u] += size[v];\n\t\tif(size[son[u]] < size[v]) son[u] = v;\n\t}\n}\nil void dfs2(int u, int fr) {\n\ttop[u] = fr;\n\tif(son[u]) dfs2(son[u], fr);\n\tNext(i, u) {\n\t\tint v = e[i].v;\n\t\tif(v == fa[u] || v == son[u]) continue;\n\t\tdfs2(v, v);\n\t}\n}\nil int dist(int u, int v) {\n\treturn dep[u] + dep[v] - 2 * dep[LCA(u, v)];\n}\nil void get_rt(int u, int fr) {\n\tdp[u] = 0, size[u] = 1;\n\tNext(i, u) {\n\t\tint v = e[i].v;\n\t\tif(vis[v] || v == fr) continue;\n\t\tget_rt(v, u), size[u] += size[v], dp[u] = max(dp[u], size[v]);\n\t}\n\tdp[u] = max(dp[u], N - size[u]);\n\tif(dp[u] < dp[rt]) rt = u;\n}\nil void build(int u) {\n\tvis[u] = 1;\n\tNext(i, u) if(!vis[e[i].v]) dp[rt = 0] = n, N = size[e[i].v], get_rt(e[i].v, u), Fa[rt] = u, build(rt);\n}\nil int query(int x) {\n\tint ans = f[x], now = x;\n\twhile(now != R) ans += (f[Fa[now]] - g[now]) + (w[Fa[now]] - w[now]) * dist(x, Fa[now]), now = Fa[now];\n\treturn ans;\n}\nil void insert(int x, int o) {\n\tint now = x, pax = o; o = A[x] - o, A[x] = pax;\n\twhile(now != R) w[now] += o, f[now] += o * dist(x, now), g[now] += o * dist(x, Fa[now]), now = Fa[now]; \n\tw[R] += o, f[R] += o * dist(x, R), temp += 2 * query(x) * o, S += o;\n}\nsigned main() {\n\tn = read(), m = read();\n\trep(i, 2, n) {\n\t\tint u = read(), v = read();\n\t\tadd(u, v), add(v, u);\n\t}\n\tdfs1(1, 0), dfs2(1, 1), dp[rt = 0] = N = n, get_rt(1, 0), R = rt, build(rt);\n\trep(i, 1, n) insert(i, read());\n\trep(i, 1, m) {\n\t\tint opt = read(), x = read();\n\t\tif(opt == 1) insert(x, read());\n\t\telse printf(\"%lld\\n\", (S + query(x)) * S - temp / 2);\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1569326090,
        "uid": 57014,
        "name": "Nemlit",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3676 \u3010\u5c0f\u6e05\u65b0\u6570\u636e\u7ed3\u6784\u9898\u3011"
    },
    {
        "content": "\n\u4e00\u9053\u6570\u5b66\u516c\u5f0f\u5316\u7b80\u9898\uff1f\n\n\u6211\u4eec\u8003\u8651\u6811\u5256\u53bb\u7ef4\u62a4\u6bcf\u6b21\u66f4\u65b0\u548c\u8be2\u95ee\n\n\u90a3\u4e48\u6211\u4eec\u8003\u8651\u7ef4\u62a4\u4ec0\u4e48\u503c\uff1a\n\n~~\u65e2\u7136\u9898\u76ee\u8981\u6c42\u7ef4\u62a4\u5b50\u6811\u548c\u90a3\u5f53\u7136\u662f\u7ef4\u62a4\u5b50\u6811\u548c\u5566~~\n\n\n\u6211\u4eec\u5148\u6765\u5f3a\u884c\u63a8\u4e00\u6ce2\uff08\u611f\u89c9\u63a8\u5f97\u5f88\u7384\u5b66 emmm... \uff09\n\n\n# query\n\n\n\u9996\u5148\u6211\u4eec\u4ee4$w_i$ \u4e3a\u70b9\u6743\uff0c $s_i$ \u4e3a $i$ \u53f7\u70b9\u7684\u5b50\u6811\u548c\uff0c$ans_i$ \u4e3a $i$ \u53f7\u70b9\u4e3a\u6839\u65f6\u5019\u7684\u7b54\u6848\uff0c\u90a3\u4e48\u6709\uff1a\n\n\n$$ans_u=ans_1-\\sum_{i=1}^{k-1} s_i ^{~ 2} +\\sum_{i=1}^{k-1}(s_1-s_{i+1})^{~ 2} - s_k^{~ 2} + s_1^{~2}$$\n\n\n\u4e5f\u5c31\u662f\uff1a\n\n$$ans_u=ans_1-\\sum_{i=2}^{k} s_i ^{~ 2} +\\sum_{i=1}^{k-1}(s_1-s_{i+1})^{~ 2} $$\n\n\u4e0a\u9762\u7684 1~k \u4e2a\u8282\u70b9\u4e3a\u4ece 1 \u5230 u \u7684\u7b80\u5355\u8def\u5f84\u4e0a\u987a\u5e8f\u7684\u70b9\n\n\u90a3\u4e48\u628a\u8fd9\u4e2a\u5f0f\u5b50\u5316\u7b80\u4e00\u4e0b\uff1a\n\n$$ans_u=ans_1-\\sum_{i=2}^{k} s_i ^{~ 2} +\\sum_{i=2}^{k} s_i^{~ 2} + k \u00b7s_1^{~ 2} - 2 \u00b7s_1\\sum_{i=2}^{k}s_i$$\n\n\uff08\u5c31\u53ea\u8981\u5c55\u5f00\u5c31\u597d\u5566~\uff09\n\u7136\u540e\u6211\u4eec\u6d88\u6389 $s_i^{~2}$\uff1a\n\n$$ans_u=ans_1 + s_{1}(k\u00b7s_1-2\u00b7\\sum_{i=2}^ks_i) $$\n\n\n\u7ee7\u7eed\u53d8\u5f97\u66f4\u5bb9\u6613\u5904\u7406\uff1a\n\n$$ans_u=ans_1 + s_{1}((k+1)\u00b7s_1-2\u00b7\\sum_{i=1}^ks_i) $$\n\n\n\u8fd9\u6837\u7684\u8bdd\u6211\u4eec\u6811\u5256\u7ef4\u62a4\u4e00\u6761\u94fe\u4e0a\u7684\u4fe1\u606f\u5c31\u80fd\u56de\u7b54\u8be2\u95ee\u4e86\uff0c\u590d\u6742\u5ea6 $log^2~ n$\n\n# update\n\n\u7136\u540e\u6211\u4eec\u8003\u8651\u66f4\u65b0\n\n\u90a3\u4e48\u66f4\u65b0\u7684\u8bdd\u9996\u5148 1~k \u7684\u8282\u70b9\u7684 $s_k$ \u80af\u5b9a\u8981\u52a0\u4e0a $w_k$ \u7684\u589e\uff08\u52a0\uff09\u91cf x\n\n\u7136\u540e\u6211\u4eec\u8003\u8651\u51cf\u53bb\u8fd9\u4e9b\u8282\u70b9\u539f\u6765\u7684\u8d21\u732e\uff0c\u8ba9\u8fd9\u4e9b\u8282\u70b9\u52a0\u4e0a\u8fd9\u4e9b\u589e\u91cf\uff0c\u7136\u540e\u518d\u628a\u8d21\u732e\u52a0\u56de\u53bb\n\n\u90a3\u4e48\u8fd9\u4e9b\u8282\u70b9\u52a0\u4e0a x \u540e\u6bd4\u539f\u6765\u591a\u4e86\u591a\u5c11\u8d21\u732e\uff1f\n\n\u6211\u4eec\u8003\u8651\uff1a\n\n$$\\sum_{i=1}^{k}(s_i+x)^{~2}-\\sum_{i=1}^{k}s_i^{~2}=x(k\u00b7x +  2 \\sum_{i=1}^k s_i )$$\n\n\u90a3\u4e48\u6211\u4eec\u8003\u8651\u53bb\u6811\u5256\u5904\u7406\u540e\u9762\u90a3\u4e2a\u94fe\u7684\u4fe1\u606f\u5c31\u597d\u4e86\uff0c\u7136\u540e\u5728\u628a\u8d21\u732e\u52a0\u5230\u94fe\u4e0a\n\n\n\n\n# code\n\n\n\n\u6211\u4eec\u8003\u8651\u4e0d\u538b\u884c\uff08\u4e2a\u9b3c\uff09\uff0c\u4e8e\u662f\u4ee3\u7801\u5c31\u957f\u8fd9\u6837\uff1a\n\n\n\n```cpp\n//by Judge\n#include<cstdio>\n#include<iostream>\n#define fp(i,a,b) for(int i=(a),I=(b)+1;i<I;++i)\n#define go(G,u) for(int i=G.head[u],v=G.e[i].to;i;v=G.e[i=G.e[i].nxt].to)\n#define ll long long\nusing namespace std;\nconst int M=2e5+3;\ntypedef int arr[M];\n#ifndef Judge\n#define getchar() (p1==p2&&(p2=(p1=buf)+fread(buf,1,1<<21,stdin),p1==p2)?EOF:*p1++)\n#endif\nchar buf[1<<21],*p1=buf,*p2=buf;\ninline bool cmax(int& a,int b){return a<b?a=b,1:0;}\ninline bool cmin(int& a,int b){return a>b?a=b,1:0;}\ninline int read(){ int x=0,f=1; char c=getchar();\n\tfor(;!isdigit(c);c=getchar()) if(c=='-') f=-1;\n\tfor(;isdigit(c);c=getchar()) x=x*10+c-'0'; return x*f;\n} char sr[1<<21],z[20];int C=-1,Z;\ninline void Ot(){fwrite(sr,1,C+1,stdout),C=-1;}\ninline void print(ll x,char chr='\\n'){\n    if(C>1<<20)Ot();if(x<0)sr[++C]=45,x=-x;\n    while(z[++Z]=x%10+48,x/=10);\n    while(sr[++C]=z[Z],--Z);sr[++C]=chr;\n} int n,m,tim; ll ans;\narr w,c,fa,son,siz,dep,top,dfn,id;\nstruct Gr{ int pat,head[M];\n\tstruct Edge{ int to,nxt; }e[M<<1];\n\tinline void add(int u,int v){\n\t\te[++pat]={v,head[u]},head[u]=pat;\n\t\te[++pat]={u,head[v]},head[v]=pat;\n\t}\n}G;\nnamespace BIT{ ll f1[M],f2[M];\n\t#define lowbit(x) (x&-x)\n\tinline void add(int x,ll v){\n\t\tfor(int i=x;i<=n;i+=lowbit(i))\n\t\t\tf1[i]+=v,f2[i]+=x*v;\n\t}\n\tinline int ask(int x,ll s=0){\n\t\tfor(int i=x;i;i^=lowbit(i))\n\t\t\ts+=(x+1)*f1[i]-f2[i]; return s;\n\t}\n} using namespace BIT;\nvoid dfs(int u,int f){\n\tdep[u]=dep[f]+1,siz[u]=1;\n\tgo(G,u) if(v^f){ fa[v]=u,dfs(v,u);\n\t\tw[u]+=w[v],siz[u]+=siz[v];\n\t\tif(siz[v]>siz[son[u]]) son[u]=v;\n\t} ans+=1ll*w[u]*w[u];\n}\nvoid dfs(int u){ if(!top[u]) top[u]=u;\n\tid[dfn[u]=++tim]=u,add(dfn[u],w[u]-w[id[tim-1]]);\n\tif(son[u]) top[son[u]]=top[u],dfs(son[u]);\n\tgo(G,u) if(v^fa[u]&&v^son[u]) dfs(v);\n}\ninline ll query(int u){\n\tint k=0,x=ask(1); ll s=0;\n\tfor(;u;u=fa[top[u]])\n\t\tk+=dfn[u]-dfn[top[u]]+1,\n\t\ts+=ask(dfn[u])-ask(dfn[top[u]]-1);\n\treturn ans+x*(1ll*(k+1)*x-(s<<1));\n}\ninline void update(int u,int x){\n\tint k=0; ll s=0;\n\tfor(;u;u=fa[top[u]])\n\t\tk+=dfn[u]-dfn[top[u]]+1,\n\t\ts+=ask(dfn[u])-ask(dfn[top[u]]-1),\n\t\tadd(dfn[top[u]],x),add(dfn[u]+1,-x);\n\tans+=x*(1ll*x*k+(s<<1));\n}\nint main(){ n=read(),m=read(); int op,x,y;\n\tfp(i,2,n) x=read(),y=read(),G.add(x,y);\n\tfp(i,1,n) w[i]=c[i]=read(); dfs(1,0),dfs(1);\n\tfp(T,1,m){ op=read(),x=read();\n\t\tif(op&1) y=read()-c[x],c[x]+=y,update(x,y);\n\t\telse print(query(x));\n\t} return Ot(),0;\n}\n```\n\n",
        "postTime": 1553001420,
        "uid": 38576,
        "name": "J\u03bcdge",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3676 \u3010\u5c0f\u6e05\u65b0\u6570\u636e\u7ed3\u6784\u9898\u3011"
    },
    {
        "content": "- \u5148\u8f6c\u5316\u4e00\u4e0b\u95ee\u9898\n\n- \u6bcf\u68f5\u5b50\u6811\u7684\u6743\u503c\u548c\u7684\u5e73\u65b9\u548c\uff0c\u76f8\u5f53\u4e8e\u7b2c\u4e00\u6b21\u9009\u4e00\u4e2a\u70b9 $x$ \uff0c\u7b2c\u4e8c\u6b21\u518d\u9009\u4e00\u4e2a\u70b9 $y$ \uff0c\u8d21\u732e\u4e3a $a_x\\times a_y\\times dep[LCA(x,y)]$\n\n- \u5176\u4e2d $a_x$ \u4e3a\u70b9 $x$ \u7684\u6743\uff0c $dep[x]$ \u4e3a\u70b9 $x$ \u7684\u6df1\u5ea6\n\n- \u540c\u65f6\uff0c\u53c8\u6709 $dist(x,y)=dep[x]+dep[y]-dep[LCA(x,y)]\\times2$\n\n- \u4e8e\u662f $dep[LCA(x,y)]=\\frac{dep[x]+dep[y]-dist(x,y)}2$\n\n- $dist(x,y)$ \u4e3a $x$ \u5230 $y$ \u7684\u8ddd\u79bb\n\n- \u4e8e\u662f\u6bcf\u68f5\u5b50\u6811\u7684\u6743\u503c\u548c\u7684\u5e73\u65b9\u548c\u7b49\u4e8e\n\n- $$\\frac 12\\sum_x\\sum_ya_x\\times a_y\\times(dep[x]+dep[y]-dist(x,y))$$\n\n- $$=\\frac 12(2(\\sum_xa_x\\times dep[x])(\\sum_xa_x)-\\sum_x\\sum_ya_x\\times a_y\\times dist(x,y))$$\n\n- \u5982\u679c\u8981\u8be2\u95ee\u4ee5 $r$ \u4e3a\u6839\u65f6\u6bcf\u68f5\u5b50\u6811\u7684\u6743\u503c\u548c\u7684\u5e73\u65b9\u548c\uff0c\u90a3\u4e48 $dep[x]$ \u5b9e\u9645\u4e0a\u5c31\u662f $x$ \u5230 $r$ \u7684\u8ddd\u79bb\u52a0\u4e00\u3002\u4fee\u6539\u65f6 $\\sum_xa_x$ \u5f88\u597d\u7ef4\u62a4\uff0c\u800c\u6211\u4eec\u7684\u8be2\u95ee\u7684\u5173\u952e\u4e5f\u5c31\u662f\u67e5\u8be2\n\n- $$\\sum_xa_x\\times dist(x,r)$$\n\n- \u53ef\u4ee5\u4f7f\u7528\u52a8\u6001\u70b9\u5206\u6cbb\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u548c [[LNOI2014]LCA](https://www.luogu.org/problemnew/show/P4211) \u4e00\u6837\u7684\u505a\u6cd5\n\n- \u800c\u81f3\u4e8e $\\sum_x\\sum_ya_x\\times a_y\\times dist(x,y)$ \uff0c\u5f53 $a_u$ \u52a0\u4e0a $v$ \u4e4b\u540e\u8fd9\u4e2a\u5f0f\u5b50\u7684\u503c\u4f1a\u52a0\u4e0a $2v\\sum_xa_x\\times dist(x,u)$ \uff0c\u4e5f\u53ef\u4ee5\u7ef4\u62a4\n\n- \u590d\u6742\u5ea6 $O(n\\log n)$ \uff08\u52a8\u6001\u70b9\u5206\u6cbb\uff09 $O(n\\log^2n)$ \uff08\u6811\u5256\uff09\n\n- \u4ee3\u7801\uff1a\n\n```cpp\n#include <cmath>\n#include <cstdio>\n#include <cstring>\n#include <iostream>\n#include <algorithm>\n#define p2 p << 1\n#define p3 p << 1 | 1\n\ninline int read()\n{\n\tint res = 0; bool bo = 0; char c;\n\twhile (((c = getchar()) < '0' || c > '9') && c != '-');\n\tif (c == '-') bo = 1; else res = c - 48;\n\twhile ((c = getchar()) >= '0' && c <= '9')\n\t\tres = (res << 3) + (res << 1) + (c - 48);\n\treturn bo ? ~res + 1 : res;\n}\n\ntemplate <class T>\ninline void Swap(T &a, T &b) {T t = a; a = b; b = t;}\n\ntypedef long long ll;\n\nconst int N = 2e5 + 5, M = N << 1, L = M << 1;\n\nint n, q, ecnt, nxt[M], adj[N], go[M], a[N], fa[N], dep[N], sze[N], son[N],\ntop[N], pos[N], ToT, suma;\nll sum[L], add[L], sumad, sumdis;\n\nvoid down(int p)\n{\n\tadd[p2] += add[p]; add[p3] += add[p];\n\tadd[p] = 0;\n}\n\nvoid upt(int l, int r, int p)\n{\n\tint mid = l + r >> 1;\n\tsum[p] = sum[p2] + sum[p3] +\n\t\tadd[p2] * (mid - l + 1) + add[p3] * (r - mid);\n}\n\nvoid change(int l, int r, int s, int e, int v, int p)\n{\n\tif (l == s && r == e) return (void) (add[p] += v);\n\tint mid = l + r >> 1; down(p);\n\tif (e <= mid) change(l, mid, s, e, v, p2);\n\telse if (s > mid) change(mid + 1, r, s, e, v, p3);\n\telse change(l, mid, s, mid, v, p2),\n\t\tchange(mid + 1, r, mid + 1, e, v, p3);\n\tupt(l, r, p);\n}\n\nvoid change(int u, int v, int w)\n{\n\twhile (top[u] != top[v])\n\t{\n\t\tif (dep[top[u]] < dep[top[v]]) Swap(u, v);\n\t\tchange(1, n, pos[top[u]], pos[u], w, 1);\n\t\tu = fa[top[u]];\n\t}\n\tif (dep[u] > dep[v]) Swap(u, v);\n\tchange(1, n, pos[u], pos[v], w, 1);\n}\n\nll ask(int l, int r, int s, int  e, int p)\n{\n\tif (l == s && r == e) return sum[p] + add[p] * (r - l + 1);\n\tint mid = l + r >> 1; down(p); ll res;\n\tif (e <= mid) res = ask(l, mid, s, e, p2);\n\telse if (s > mid) res = ask(mid + 1, r, s, e, p3);\n\telse res = ask(l, mid, s, mid, p2) + ask(mid + 1, r, mid + 1, e, p3);\n\treturn upt(l, r, p), res;\n}\n\nll ask(int u, int v)\n{\n\tll res = 0;\n\twhile (top[u] != top[v])\n\t{\n\t\tif (dep[top[u]] < dep[top[v]]) Swap(u, v);\n\t\tres += ask(1, n, pos[top[u]], pos[u], 1);\n\t\tu = fa[top[u]];\n\t}\n\tif (dep[u] > dep[v]) Swap(u, v);\n\treturn res + ask(1, n, pos[u], pos[v], 1);\n}\n\nvoid add_edge(int u, int v)\n{\n\tnxt[++ecnt] = adj[u]; adj[u] = ecnt; go[ecnt] = v;\n\tnxt[++ecnt] = adj[v]; adj[v] = ecnt; go[ecnt] = u;\n}\n\nvoid dfs1(int u, int fu)\n{\n\tdep[u] = dep[fa[u] = fu] + (sze[u] = 1);\n\tsumad += 1ll * a[u] * dep[u];\n\tfor (int e = adj[u], v; e; e = nxt[e])\n\t{\n\t\tif ((v = go[e]) == fu) continue;\n\t\tdfs1(v, u); sze[u] += sze[v];\n\t\tif (sze[v] > sze[son[u]]) son[u] = v;\n\t}\n}\n\nvoid dfs2(int u, int fu)\n{\n\tif (son[u])\n\t{\n\t\ttop[son[u]] = top[u];\n\t\tpos[son[u]] = ++ToT;\n\t\tdfs2(son[u], u);\n\t}\n\tfor (int e = adj[u], v; e; e = nxt[e])\n\t\tif ((v = go[e]) != fu && v != son[u])\n\t\t\tpos[top[v] = v] = ++ToT, dfs2(v, u);\n}\n\nll weighted_dis(int rt)\n{\n\treturn sumad + 1ll * suma * dep[rt] - (ask(1, rt) << 1);\n}\n\nvoid init()\n{\n\tpos[1] = top[1] = ToT = 1;\n\tdfs1(1, 0); dfs2(1, 0);\n\tfor (int i = 1; i <= n; i++) change(1, i, a[i]);\n\tfor (int i = 1; i <= n; i++)\n\t\tsumdis += weighted_dis(i) * a[i];\n}\n\nint main()\n{\n\tint x, y, op;\n\tn = read(); q = read();\n\tfor (int i = 1; i < n; i++)\n\t\tx = read(), y = read(), add_edge(x, y);\n\tfor (int i = 1; i <= n; i++) suma += (a[i] = read());\n\tinit();\n\twhile (q--)\n\t{\n\t\top = read(); x = read();\n\t\tif (op == 1)\n\t\t{\n\t\t\ty = read();\n\t\t\tchange(1, x, y - a[x]);\n\t\t\tsuma += y - a[x];\n\t\t\tsumad += 1ll * (y - a[x]) * dep[x];\n\t\t\tsumdis += 2ll * (y - a[x]) * weighted_dis(x);\n\t\t\ta[x] = y;\n\t\t}\n\t\telse printf(\"%lld\\n\", (2ll * suma * weighted_dis(x)\n\t\t\t- sumdis >> 1) + 1ll * suma * suma);\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1550373160,
        "uid": 29936,
        "name": "xyz32768",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3676 \u3010\u5c0f\u6e05\u65b0\u6570\u636e\u7ed3\u6784\u9898\u3011"
    },
    {
        "content": "\u611f\u89c9\u96be\u5ea6\u865a\u9ad8.\n\n\u9996\u5148\u6839\u5168\u662f$1$\u7684\u60c5\u51b5\u5f88\u597d\u505a\uff0c\u76f4\u63a5\u9884\u5904\u7406\u5c31\u597d\u4e86.\u5bf9\u4e8e\u4fee\u6539\u70b9\u6743\u53ef\u4ee5\u53d8\u6210\u52a0\uff0c\u7136\u540e\u5bf9\u4e8e\u5b50\u6811\u548c\u76f8\u5f53\u4e8e\u662f\u4e00\u6761\u94fe\u52a0\uff0c\u6811\u5256\uff0c\u7136\u540e$(s[i]+a)^2=s[i]^2+2as[i]+a^2$\uff0c\u62ff\u7ebf\u6bb5\u6811\u7ef4\u62a4\u4e00\u4e0b\u533a\u95f4\u548c\u5c31\u597d\u4e86.\n\n\u73b0\u5728\u8003\u8651\u6362\u6839.\u8fd9\u91cc\u501f\u52a9\u6811\u5f62dp\u7684\u601d\u60f3\uff0c\u6362\u6839\u4e4b\u540e\u7684\u7b54\u6848\u53ea\u6709\u8be2\u95ee\u70b9\u5230\u6839\u8fd9\u4e00\u6761\u94fe\u4e0a\u7684\u5b50\u6811\u5927\u5c0f\u6709\u53d8\u5316.\u8bb0$S$\u662f\u8fd9\u6761\u94fe\u4e0a\u7684\u70b9\u7684\u96c6\u5408\uff0c$son[u]$\u662f$u$\u5728\u8fd9\u6761\u94fe\u4e0a\u7684\u513f\u5b50\uff0c\u8be2\u95ee\u70b9\u4e3a$x$\uff0c\u90a3\u4e48\u65b0\u7684\u7b54\u6848\u5c31\u662f\n\n$ans'=ans-\\sum\\limits_{u\\in S}s[u]^2+\\sum\\limits_{u\\in S,u\\neq x}(s[1]-s[son[u]])^2+s[1]^2$\n\n\u5c31\u662f\u51cf\u6389\u539f\u6765\u7684\u8d21\u732e\u52a0\u4e0a\u65b0\u7684\u8d21\u732e\uff0c\u65b0\u7684\u5b50\u6811\u70b9\u6743\u548c\u5c31\u662f\u6574\u68f5\u6811\u7684\u70b9\u6743\u548c\u51cf\u53bb\u513f\u5b50\u7684\u70b9\u6743\u548c.\n\n\u7136\u540e\u53ef\u4ee5\u7b80\u5355\u5730\u5316\u4e00\u5316\u5f0f\u5b50.\n\n$\\begin{aligned}\\text{\u539f\u5f0f}&=ans-\\sum\\limits_{u\\in S}s[u]^2+\\sum\\limits_{u\\in S,u\\neq 1}s[u]^2+|S|s[1]^2-2s[1]\\sum\\limits_{u\\in S,u\\neq 1}s[u]\\\\&=(|S|-1)s[1]^2-2s[1]\\sum\\limits_{u\\in S,u\\neq 1}s[u]\\end{aligned}$\n\n\u4e8e\u662f\u53ea\u9700\u8981\u7ef4\u62a4$s[1]$\uff0c\u533a\u95f4\u548c\uff0c\u987a\u4fbf\u7ef4\u62a4\u4e0b$ans$\u5373\u53ef.\n\n\u4e0d\u77e5\u9053\u4e3a\u4ec0\u4e48\u5f00O2\u4f1a\u8d1f\u4f18\u5316emm\n\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<cstring>\nusing namespace std;\nconst int N=2e6;\nlong long s1[N],s[N],ans=0;\nint size[N],dep[N],son[N],w[N],f[N],id[N],tw[N],nxt[N],fst[N],to[N],n,q,tp[N],dfs_cnt,tag[N],mm;\nvoid ade(int u,int v){to[++mm]=v;nxt[mm]=fst[u],fst[u]=mm;}\nvoid dfs1(int u,int fa)\n{\n\tf[u]=fa;dep[u]=dep[fa]+1;size[u]=1;s[u]=w[u];\n\tint mx=0;\n\tfor(int i=fst[u];i;i=nxt[i])\n\t{\n\t\tint v=to[i];if(v==fa)continue;\n\t\tdfs1(v,u);size[u]+=size[v],s[u]+=s[v];\n\t\tif(size[v]>mx)mx=size[v],son[u]=v;\n\t}\n\tans+=s[u]*s[u];\n}\nvoid dfs2(int u,int top)\n{\n\ttp[u]=top;id[u]=++dfs_cnt;tw[dfs_cnt]=s[u];\n\tif(son[u])dfs2(son[u],top);\n\tfor(int i=fst[u];i;i=nxt[i])\n\t\tif(to[i]!=f[u]&&to[i]!=son[u])\n\t\t\tdfs2(to[i],to[i]);\n}\nvoid pushup(int rot){s1[rot]=s1[rot<<1]+s1[rot<<1|1];}\nvoid build(int rot,int lt,int rt)\n{\n\ttag[rot]=0;\n\tif(lt==rt){s1[rot]=tw[lt];return;}\n\tint mid=(lt+rt)>>1;\n\tbuild(rot<<1,lt,mid),build(rot<<1|1,mid+1,rt);\n\tpushup(rot);\n}\nvoid upd(int rot,int lt,int rt,long long w)\n{\n\tint len=rt-lt+1;s1[rot]+=len*w;tag[rot]+=w;\n}\nvoid pushdown(int rot,int lt,int rt)\n{\n\tif(tag[rot])\n\t{\n\t\tint mid=(lt+rt)>>1;long long t=tag[rot];tag[rot]=0;\n\t\tupd(rot<<1,lt,mid,t),upd(rot<<1|1,mid+1,rt,t);\n\t}\n}\nvoid update(int rot,int lt,int rt,int lq,int rq,int w)\n{\n\tif(lt>=lq&&rt<=rq){ans+=2*w*s1[rot]+(rt-lt+1)*w*w;upd(rot,lt,rt,w);return;}\n\tint mid=(lt+rt)>>1;pushdown(rot,lt,rt);\n\tif(lq<=mid)update(rot<<1,lt,mid,lq,rq,w);\n\tif(rq>mid)update(rot<<1|1,mid+1,rt,lq,rq,w);\n\tpushup(rot);\n}\nvoid update(int u,int w)\n{\n\twhile(tp[u]!=1)\n\t{\n\t\tupdate(1,1,n,id[tp[u]],id[u],w);\n\t\tu=f[tp[u]];\n\t}\n\tupdate(1,1,n,1,id[u],w);s[1]+=w;\n}\nlong long query(int rot,int lt,int rt,int lq,int rq)\n{\n\tif(lt>=lq&&rt<=rq)return s1[rot];\n\tint mid=(lt+rt)>>1;pushdown(rot,lt,rt);\n\tlong long ans=0;\n\tif(lq<=mid)ans+=query(rot<<1,lt,mid,lq,rq);\n\tif(rq>mid)ans+=query(rot<<1|1,mid+1,rt,lq,rq);\n\treturn ans;\n}\nlong long query(int u)\n{\n\tlong long ans=0;\n\twhile(tp[u]!=1)\n\t{\n\t\tans+=query(1,1,n,id[tp[u]],id[u]);\n\t\tu=f[tp[u]];\n\t}\n\tif(u!=1)ans+=query(1,1,n,2,id[u]);\n\treturn ans;\n}\nint main()\n{\n\tscanf(\"%d%d\",&n,&q);\n\tfor(int i=1,u,v;i<n;i++){scanf(\"%d%d\",&u,&v);ade(u,v),ade(v,u);}\n\tfor(int i=1;i<=n;i++)scanf(\"%d\",w+i);\n\tdfs1(1,0),dfs2(1,1);\n\tbuild(1,1,n);\n\tfor(int i=1;i<=q;i++)\n\t{\n\t\tint opt,x,y;\n\t\tscanf(\"%d%d\",&opt,&x);\n\t\tif(opt==1)\n\t\t{\n\t\t\tscanf(\"%d\",&y);\n\t\t\tupdate(x,-w[x]),update(x,w[x]=y);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tint len=dep[x];\n\t\t\tprintf(\"%lld\\n\",ans+(len-1)*s[1]*s[1]-2*s[1]*query(x));\n\t\t}\n\t}\n}\n```",
        "postTime": 1562654637,
        "uid": 22136,
        "name": "qwaszx",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P3676 \u3010\u5c0f\u6e05\u65b0\u6570\u636e\u7ed3\u6784\u9898\u3011"
    },
    {
        "content": "\u9996\u5148\u6211\u4eec\u8003\u8651\u5982\u679c\u9898\u76ee\u8981\u6c42\u7684\u4e0d\u662f\u5b50\u6811\u5e73\u65b9\u548c\u800c\u662f\u5b50\u6811\u548c\uff0c\u4e5f\u5c31\u662f$\\sum_{i=1}^{n}siz[i]$\uff0c\u90a3\u4e48\u6bcf\u4e2a\u70b9\u7684\u8d21\u732e\u5c31\u662f\u4ed6\u5230\u6839\u7684\u8ddd\u79bb\u52a0\u4e00\uff0c\u6240\u4ee5\u7b54\u6848\u4e5f\u53ef\u4ee5\u5199\u6210\uff1a\n$\\sum_{i=1}^{n}a[i] \\times dis(i,p)+Sum$\uff08\u5176\u4e2d$p$\u8868\u793a\u5f53\u524d\u7684\u6839\uff0c$a[i]$\u8868\u793a\u70b9$i$\u7684\u70b9\u6743\uff0c$Sum=\\sum a[i]$\uff09\u3002\n\u6211\u4eec\u53d1\u73b0\u8fd9\u4e2a\u4e1c\u897f\u5176\u5b9e\u5c31\u662f[P3345 [ZJOI2015]\u5e7b\u60f3\u4e61\u6218\u7565\u6e38\u620f](https://www.luogu.com.cn/problem/P3345)\u8fd9\u4e2a\u9898\uff0c\u4e3a\u4e86\u540e\u6587\u67ff\u5b50\u7684\u8868\u8fbe\u65b9\u4fbf\uff0c\u6211\u4eec\u8bb0\n$calc(p)=\\sum_{i=1}^{n}a[i] \\times dis(i,p)$\n\n\u7136\u540e\u8fd9\u4e2a\u5e73\u65b9\u5f88\u4e0d\u597d\u5904\u7406\u3002\u9996\u5148\u7ed9\u51fa\u4e00\u4e2a\u7ed3\u8bba\uff0c\u65e0\u8bba\u6839\u5728\u54ea\u91cc\uff0c$\\sum_{i=1}^{n}siz[i] \\times (Sum-siz[i])$\u7684\u503c\u6052\u5b9a\uff08\u8bb0\u8fd9\u4e2a\u5e38\u91cf\u4e3a$W$\uff09\u3002\n\n\u600e\u4e48\u8bc1\u660e\u5462\uff0c\u53d1\u73b0\u4efb\u610f\u4e24\u70b9$i,j$\u5bf9\u4e0a\u8ff0\u5f0f\u5b50\u7684\u8d21\u732e\u662f$a[i] \\times a[j] \\times dis(i,j)$\uff0c\u8fd9\u4e2a\u4e1c\u897f\u65e0\u8bba\u6839\u5728\u54ea\u91cc\u90fd\u4e0d\u4f1a\u53d8\u7684\u3002\n\n\u7136\u540e\u7a0d\u5fae\u53d8\u5f62\u4e00\u4e0b\u5c31\u80fd\u63a8\u51fa$\\sum siz[i]^2=Sum \\times (calc(p)+Sum) - W$\u3002\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5728\u6839\u4e3a$1$\u7684\u65f6\u5019\u6c42\u51fa$W$\u7136\u540e\u52a8\u6001\u70b9\u5206\u6cbb\u7ef4\u62a4$calc(p)$\u5c31\u597d\u4e86\u3002\n\n\u73b0\u5728\u7684\u95ee\u9898\u5c31\u662f\u5982\u4f55\u7ef4\u62a4\u3002\u9664\u4e86$W$\u4ee5\u5916\u5176\u4ed6\u90fd\u662f\u975e\u5e38\u597d\u7ef4\u62a4\u7684\uff0c\u6211\u4eec\u53d1\u73b0\u4e00\u4e2a\u8282\u70b9$k$\u5bf9$W$\u7684\u8d21\u732e\u4e3a\n$a[k] \\times \\sum_{i=1}^{n}a[i] \\times dis(i,k)=a[k] \\times calc(k)$\uff0c\u7136\u540e\u5bf9\u4e8e\u600e\u4e48\u7ef4\u62a4$W$\u5c31\u4e0d\u7528\u591a\u8bf4\u4e86\u5427\u3002\u3002\u3002\n\n\u4ee3\u7801\uff1a\n\n```\n#pragma GCC optimize(2)\n#include<cstdio>\n#include<iostream>\n#include<cstring>\n#include<algorithm>\n#define rint int\n\nusing namespace std;\n\ntypedef long long LL;\nconst int N=1000009;\nint n,Q,root,head[N],cnt,F[N],log[N],a[N];\nLL dis1[N],dis2[N],sum[N],W,Sum;\nstruct Edge\n{\n\tint nxt,to,w;\n}g[N*2];\nstruct G\n{\n\tint head[N],cnt,f[N][30],dep[N],del[N],siz[N],Euler[N],Fst[N],Index;\n\tstruct Edge\n\t{\n\t\tint nxt,to;\n\t}g[N*2];\n\t\n\tvoid add(int from,int to)\n\t{\n\t\tg[++cnt].nxt=head[from];\n\t\tg[cnt].to=to;\n\t\thead[from]=cnt;\n\t}\n\tint LCA(int x,int y)\n\t{\n\t\tif(Fst[x]>Fst[y])\n\t\t\tswap(x,y);\n\t\tx=Fst[x],y=Fst[y];\n\t\tint k=log[y-x+1];\n\t\treturn dep[f[x][k]]<dep[f[y-(1<<k)+1][k]]?f[x][k]:f[y-(1<<k)+1][k];\n\t}\n\tvoid dfs(int x,int fa)\n\t{\n\t\tEuler[++Index]=x,Fst[x]=Index,f[Index][0]=x;\n\t\tfor (rint i=head[x];i;i=g[i].nxt)\n\t\t{\n\t\t\tint v=g[i].to;\n\t\t\tif(v==fa)\n\t\t\t\tcontinue;\n\t\t\tdep[v]=dep[x]+1;\n\t\t\tdfs(v,x);\n\t\t\tEuler[++Index]=x,f[Index][0]=x;\n\t\t}\n\t}\n\tint Get_dis(int x,int y)\n\t{\n\t\treturn dep[x]+dep[y]-2*dep[LCA(x,y)];\n\t}\n\tvoid DFS(int x,int fa)\n\t{\n\t\tsiz[x]=1;\n\t\tfor (rint i=head[x];i;i=g[i].nxt)\n\t\t{\n\t\t\tint v=g[i].to;\n\t\t\tif(v==fa||del[v])\n\t\t\t\tcontinue;\n\t\t\tDFS(v,x);\n\t\t\tsiz[x]+=siz[v];\n\t\t}\n\t}\n\tint Get_Weight(int x)\n\t{\n\t\tDFS(x,-1);\n\t\tint k=siz[x]/2,fa=-1;\n\t\twhile(1)\n\t\t{\n\t\t\tint tmp=0;\n\t\t\tfor (rint i=head[x];i;i=g[i].nxt)\n\t\t\t{\n\t\t\t\tint v=g[i].to;\n\t\t\t\tif(v==fa||del[v])\n\t\t\t\t\tcontinue;\n\t\t\t\tif(siz[v]>siz[tmp])\n\t\t\t\t\ttmp=v;\n\t\t\t}\n\t\t\tif(siz[tmp]<=k)\n\t\t\t\treturn x;\n\t\t\tfa=x,x=tmp;\n\t\t}\n\t}\n\tvoid work()\n\t{\n\t\tdfs(1,-1);\n\t\tfor (int j=1;1<<j<=Index;j++)\n\t\t\tfor (int i=1;i+(1<<j)-1<=Index;i++)\n\t\t\t\tif(dep[f[i][j-1]]<dep[f[i+(1<<j-1)][j-1]])\n\t\t\t\t\tf[i][j]=f[i][j-1];\n\t\t\t\telse\n\t\t\t\t\tf[i][j]=f[i+(1<<j-1)][j-1];\n\t}\n\tvoid dfs_1(int x,int fa)\n\t{\n\t\tsiz[x]=a[x];\n\t\tfor (int i=head[x];i;i=g[i].nxt)\n\t\t{\n\t\t\tint v=g[i].to;\n\t\t\tif(v==fa)\n\t\t\t\tcontinue;\n\t\t\tdfs_1(v,x);\n\t\t\tsiz[x]+=siz[v];\n\t\t}\n\t}\n}T;\n\nvoid add(int from,int to,int w)\n{\n\tg[++cnt].nxt=head[from];\n\tg[cnt].to=to;\n\tg[cnt].w=w;\n\thead[from]=cnt;\n}\n\nint read()\n{\n\tchar c=getchar();\n\tint x=0,f=1;\n\twhile(c<'0'||c>'9')\n\t{\n\t\tif(c=='-')\n\t\t\tf=-1;\n\t\tc=getchar();\n\t}\n\twhile(c>='0'&&c<='9')\n\t\tx=x*10+c-'0',c=getchar();\n\treturn x*f;\n}\n\nvoid init()\n{\n\tlog[0]=-1;\n\tfor (int i=1;i<=N-9;i++)\n\t\tlog[i]=log[i>>1]+1;\n\tn=read(),Q=read();\n\tfor (rint i=1;i<n;i++)\n\t{\n\t\tint x,y;\n\t\tx=read(),y=read();\n\t\tT.add(x,y),T.add(y,x);\n\t}\n\tT.work();\n}\n\nvoid build(int fa)\n{\n\tT.del[fa]=1;\n\tfor (rint i=T.head[fa];i;i=T.g[i].nxt)\n\t{\n\t\tint v=T.g[i].to;\n\t\tif(T.del[v]||v==fa)\n\t\t\tcontinue;\n\t\tint w=T.Get_Weight(v);\n\t\tF[w]=fa,add(fa,w,v),add(w,fa,v);\n\t\tbuild(w);\n\t}\n}\n\nvoid Modify(int x,int y)\n{\n\tfor (rint i=x;i;i=F[i])\n\t{\n\t\tsum[i]+=y;\n\t\tif(i!=root)\n\t\t{\n\t\t\tLL fuck=1LL*T.Get_dis(x,F[i])*y;\n\t\t\tdis1[F[i]]+=fuck,dis2[i]+=fuck;\n\t\t}\n\t}\n}\n\nLL calc(int x)\n{\n\tLL ans=dis1[x];\n\tfor (rint i=x;F[i];i=F[i])\n\t{\n\t\tans+=dis1[F[i]]-dis2[i];\n\t\tans+=(sum[F[i]]-sum[i])*T.Get_dis(x,F[i]);\n\t}\n\treturn ans;\n}\n\nvoid work()\n{\n\troot=T.Get_Weight(1);\n\tbuild(root);\n\tfor (int i=1;i<=n;i++)\n\t\tscanf(\"%d\",&a[i]),Modify(i,a[i]),Sum+=a[i];\n\tT.dfs_1(1,-1);\n\tfor (int i=1;i<=n;i++)\n\t\tW+=(Sum-T.siz[i])*T.siz[i];\n\tfor (rint _=1;_<=Q;_++)\n\t{\n\t\tint x,y,opt;\n\t\topt=read();\n\t\tif(opt==1)\n\t\t{\n\t\t\tx=read(),y=read();\n\t\t\tint delx=y-a[x];\n\t\t\tW+=calc(x)*delx,Sum+=delx;\n\t\t\tModify(x,delx);\n\t\t\ta[x]=y;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tx=read();\n\t\t\tprintf(\"%lld\\n\",Sum*(Sum+calc(x))-W);\n\t\t}\n\t}\n}\n\nint main()\n{\n\tinit();\n\twork();\n\treturn 0;\n}\n```\n",
        "postTime": 1587598226,
        "uid": 31646,
        "name": "\u67f3\u6697\u82b1\u660e",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P3676 \u3010\u5c0f\u6e05\u65b0\u6570\u636e\u7ed3\u6784\u9898\u3011"
    },
    {
        "content": "\u8fd9\u662f\u4e00\u9053\u6811\u5256\u9898\uff0c\u6211\u4eec\u53ea\u7ef4\u62a4\u6839\u4e3a1\u7684\u7b54\u6848\uff0c\u7136\u540e\u8003\u8651\u80fd\u4e0d\u80fd\u7528\u8fd9\u4e2a\u7b54\u6848\u8f6c\u6362\u4e3a\u6839\u4e3a\u5176\u4ed6\u503c\u7684\u7b54\u6848\u3002\uff08\u5176\u5b9e\u53ea\u8981\u7279\u5f81\u503c\u5177\u6709\u53ef\u52a0\u51cf\u6027\u6811\u5256\u5c31\u65e0\u60e7\u6362\u6839\uff09\n\n\u8bbe$s[x]$\u8868\u793a\u4ee51\u4e3a\u6839\u65f6\uff0cx\u7684\u5b50\u6811\u6743\u503c\u548c.\n\n\u6709\u4e24\u4e2a\u64cd\u4f5c\uff1a\n\n1. \u4fee\u6539x\u7684\u503c\uff08\u8bbe\u589e\u52a0y)\u3002\u90a3\u4e48\u53ea\u6709x\u7684\u7956\u5b97\u7684\u5b50\u6811\u6743\u503c\u548c(\u5176\u5b9e\u4e5f\u5305\u62ec\u81ea\u5df1)\u4f1a\u53d8\u5316\u30021~x\u7684\u8def\u5f84\u5f88\u660e\u663e\u53ea\u6709$dep[x]$\u4e2a\u70b9\uff0c\u90a3\u4e48\n\n$ans'=ans+(\\sum_{i\\in path(1,x}(s[i]+y)^2)-(\\sum_{i\\in path(1,x)}s[i]^2)$\n\n$~~~~~~~~~=ans+dep[x]*y^2+2y*(\\sum_{i\\in path(1,x)}s[i])$\n\n$~~~~~~~~~=ans+y*(dep[x]*y+(\\sum_{i\\in path(1,x)}s[i])*2)$\n1. \u6362\u6839\u3002\uff08\u5176\u5b9e\u6811\u5256\u7684\u6839\u4e00\u76f4\u4e3a1\uff09\u6362\u6839\u5176\u5b9e\u53ea\u5bf9$path(1,x)$\u7684\u70b9\u7684s\u53d1\u751f\u6539\u53d8\u3002\n\u6211\u4eec\u8bbe$path(1,x)$\u4e2d\u70b9\u7684s\u5206\u522b\u4e3a$a_1,a_2,\u2026\u2026a_{dep[x]}$,\u6362\u6839\u540e\u5373\u4e3a$b_1,b_2\u2026\u2026b_{dep[x]}$\n(\u6ce8\uff1a$a_1$,\u4e3a1\u53f7\u70b9\u7684s,$b_1$\u4e3a1\u53f7\u70b9\u6362\u6839\u540e\u7684s\uff0c\u4e0b\u6807\u4e0edep\u76f8\u7b49)\n\u5219\u6709\uff1a$a_{i+1}+b_i=s_1$ \n\n$ans'=ans-\\sum_{i\\in path(1,x)}a_i^2+\\sum_{i\\in path(1,x)}b_i^2$\n\n$~~~~~~~~~=ans-\\sum_{i\\in path(1,x)}a_i^2+\\sum_{i=1}^{dep[x]-1}(s_1-a_{i+1})^2-b_{dep[x]}^2$\n\n$~~~~~~~~~=ans-\\sum_{i=2}^{dep[x]}a_i^2+\\sum_{i=1}^{dep[x]-1}(s_1-a_{i+1})^2$\n\n$~~~~~~~~~=ans-(dep[x]-1)*s_1^2-2*s_1*\\sum_{i=2}^{dep[x]}a_i^2$\n\n$~~~~~~~~~=ans-(dep[x]+1)*s_1-2*s_1*\\sum_{i=1}^{dep[x]}a_i^2$\n\n$~~~~~~~~~=ans-s1*((dep[x]+1)-2*\\sum_{i=1}^{dep[x]} a_i^2)$\n\n\u5177\u4f53\u7528[\u6811\u72b6\u6570\u7ec4\u7ef4\u62a4\u5dee\u5206\u6570\u7ec4](https://blog.csdn.net/qq_42886072/article/details/96845636)\uff0c\u5b9e\u73b0\u533a\u95f4\u52a0\uff0c\u533a\u95f4\u6c42\u548c\u3002~~\uff08\u5176\u5b9e\u7528\u7ebf\u6bb5\u6811\u66f4\u597d\u7406\u89e3\uff09~~\n\n\u4ee3\u7801\uff1a\n```cpp\n#include<cstdio>\n#include<cctype>\n#include<cstring>\n#include<algorithm>\n#define g getchar()\nusing namespace std;\ntypedef long long ll;\nconst int N=2e5+10;\nstruct edge{int y,next;}a[N<<1];int len,last[N];\nvoid ins(int x,int y){a[++len]=(edge){y,last[x]};last[x]=len;}\nint n,m,fa[N],dep[N],son[N],tot[N],sum[N],d[N]; ll ans;\nvoid dfs1(int x) {\n\ttot[x]=1;son[x]=0;\n\tfor(int k=last[x];k;k=a[k].next) {\n\t\tint y=a[k].y;if(y==fa[x])continue;\n\t\tdep[y]=dep[x]+1;fa[y]=x;dfs1(y);sum[x]+=sum[y];\n\t\ttot[x]+=tot[y];if(tot[y]>tot[son[x]])son[x]=y;\n\t}\n\tans+=1LL*sum[x]*sum[x];//2e6*2e6=\u7206int\n}\nll c1[N],c2[N];//\u6811\u72b6\u6570\u7ec4\u7ef4\u62a4\u533a\u95f4\u52a0\u3001\u533a\u95f4\u6c42\u548c \nvoid up(int x,ll d){for(ll y=x*d;x<=n;x+=x&-x)c1[x]+=d,c2[x]+=y;}\nll down(int x){ll s=0;for(ll y=x+1;x;x-=x&-x)s+=y*c1[x]-c2[x];return s;}\nint z,ys[N],yss[N],top[N];\nvoid dfs2(int x,int tp) {\n\tyss[ys[x]=++z]=x;top[x]=tp;\n\tup(z,sum[x]-sum[yss[z-1]]);\n\tif(son[x])dfs2(son[x],tp);\n\tfor(int k=last[x];k;k=a[k].next) {\n\t\tint y=a[k].y;\n\t\tif(y!=fa[x]&&y!=son[x])dfs2(y,y);\n\t}\n}\nvoid add(int x,int y) {\n\tint k=dep[x];ll s=0;\n\tfor(int tx=top[x];x;tx=top[x=fa[tx]]) {\n\t\ts+=down(ys[x])-down(ys[tx]-1);\n\t\tup(ys[tx],y);up(ys[x]+1,-y);//\u7ef4\u62a4\u5dee\u5206\n\t}\n\tans+=y*((s<<1)+k*y);\n}\nll query(int x) {\n\tint k=dep[x]+1;ll w=down(1),s=0;\n\tfor(int tx=top[x];x;tx=top[x=fa[tx]])\n\t\ts+=down(ys[x])-down(ys[tx]-1);\n\treturn ans+w*(w*k-(s<<1));\n}\nvoid qr(int &x) {\n\tchar c=g;int f=1;x=0;\n\twhile(!isdigit(c)){if(c=='-')f=-1;c=g;}\n\twhile(isdigit(c))x=x*10+c-48,c=g;\n\tx*=f;\n}\nvoid write(ll x) {\n\tif(x/10)write(x/10);\n\tputchar(x%10+'0');\n}\nvoid pri(ll x) {\n\tif(x<0)putchar('-'),x=-x;\n\twrite(x);puts(\"\");\n}\nint main() {\n\tqr(n);qr(m); int x,y,op;\n\tfor(int i=1;i<n;i++)qr(x),qr(y),ins(x,y),ins(y,x);\n\tfor(int i=1;i<=n;i++)qr(sum[i]),d[i]=sum[i];\n\tdep[1]=1;fa[1]=0;dfs1(1);\n\tz=0;dfs2(1,1);\n\twhile(m--) {\n\t\tqr(op);qr(x);\n\t\tswitch(op) {\n\t\t\tcase 1:qr(y);add(x,y-d[x]);d[x]=y;break;\n\t\t\tcase 2:pri(query(x));break;\n\t\t}\n\t}\n\treturn 0;\n}\n```\n\n",
        "postTime": 1565263651,
        "uid": 118826,
        "name": "2018LZY",
        "ccfLevel": 7,
        "title": "\u3010\u5c0f\u6e05\u65b0\u6570\u636e\u7ed3\u6784\u9898\u3011"
    },
    {
        "content": "[$$\\large \\color{purple} My\\; Blog$$](https://www.cnblogs.com/p-b-p-b/p/10498351.html)\n\n----------------\n\n## \u601d\u8def\n\n\u8fd9\u601d\u8def\u597d\u5999\u554a\uff01\n\n\u9996\u5148\u5f88\u591a\u4eba\u90fd\u4f1a\u60f3\u5230\u63a8\u5f0f\u5b50\u4e4b\u540e\u6811\u94fe\u5256\u5206+\u7ebf\u6bb5\u6811\uff0c\u4f46\u8fd9\u6837\u4e0d\u591f\u4f18\u7f8e\uff0c\u4e0d\u559c\u6b22\u3002\n\n\u8111\u6d1e\u5927\u5f00\u60f3\u5230\u8fd9\u6837\u4e00\u4e2a\u5f0f\u5b50\uff1a\n$$\n\\sum_{x} sum_x(All-sum_x)\n$$\n\u5176\u4e2d$sum_x$\u8868\u793a$x$\u5b50\u6811\u548c\uff0c$All$\u8868\u793a\u6240\u6709\u70b9\u7684\u6743\u503c\u548c\u3002\n\n\u53d1\u73b0\u4e0d\u7ba1\u54ea\u4e2a\u70b9\u4e3a\u6839\uff0c\u53ea\u8981\u6bcf\u4e2a\u70b9\u7684\u6743\u503c\u4e0d\u53d8\uff0c\u8fd9\u4e2a\u5f0f\u5b50\u7684\u503c\u5c31\u4e0d\u53d8\u3002\n\n\u8bc1\u660e\uff1a\u5bf9\u4e8e\u70b9\u5bf9$(u,v)$\uff0c$w_u\\times w_v$\u88ab\u7b97\u4e86$dis(u,v)$\u6b21\uff0c\u56e0\u4e3a\u6bcf\u4e2a\u5728\u8def\u5f84\u4e0a\u7684$x$\u90fd\u4f1a\u7b97\u4e00\u6b21\u3002\n\n\u4e8e\u662f\u5c31\u6709\n\n$$W=\\sum_x sum_x(All-sum_x)=All\\sum_x sum_x -\\sum_x sum_x^2$$\n$$\\sum_{x} sum_x^2=All\\sum_x sum_x-W$$\n\n$W$\u600e\u4e48\u7edf\u8ba1\u5462\uff1f$w_x+=\\Delta w$\u65f6$W+=\\Delta w\\sum_u w_udis(u,x)$\uff0c\u540e\u9762\u7684\u53ef\u4ee5\u52a8\u6001\u70b9\u5206\u6cbb\u3002\n\n\u4ee5$root$\u4e3a\u6839\u65f6$\\sum_x sum_x$\u7b49\u4ef7\u4e8e$\\sum_x w_x(dis(x,root)+1)=All+\\sum_x w_xdis(x,root)$\uff0c\u540c\u6837\u53ef\u4ee5\u52a8\u6001\u70b9\u5206\u6cbb\u3002\n\n\u70b9\u5206\u6cbb\u7684\u5177\u4f53\u505a\u6cd5\u53c2\u89c1[\u5e7b\u60f3\u4e61\u6218\u7565\u6e38\u620f](https://www.cnblogs.com/p-b-p-b/p/10357577.html)\uff0c\u5f0f\u5b50\u57fa\u672c\u4e00\u6837\uff0c\u4f46\u90a3\u91cc\u7684\u4ee3\u7801\u5f88\u7e41\u7410\uff0c\u5efa\u8bae\u4ee3\u7801\u770b\u8fd9\u91cc\u3002\n\n\u90a3\u4e48\u5c31\u505a\u5b8c\u5566\uff01\n\n-------------------------\n\n## \u4ee3\u7801\n\n```cpp\n#include<bits/stdc++.h>\nclock_t t=clock();\nnamespace my_std{\n    using namespace std;\n    #define pil pair<int,ll>\n    #define fir first\n    #define sec second\n    #define MP make_pair\n    #define rep(i,x,y) for (int i=(x);i<=(y);i++)\n    #define drep(i,x,y) for (int i=(x);i>=(y);i--)\n    #define go(x) for (int i=head[x];i;i=edge[i].nxt)\n    #define templ template<typename T>\n    #define sz 202020\n    typedef long long ll;\n    typedef double db;\n    mt19937 rng(chrono::steady_clock::now().time_since_epoch().count());\n    templ inline T rnd(T l,T r) {return uniform_int_distribution<T>(l,r)(rng);}\n    templ inline bool chkmax(T &x,T y){return x<y?x=y,1:0;}\n    templ inline bool chkmin(T &x,T y){return x>y?x=y,1:0;}\n    templ inline void read(T& t)\n    {\n        t=0;char f=0,ch=getchar();double d=0.1;\n        while(ch>'9'||ch<'0') f|=(ch=='-'),ch=getchar();\n        while(ch<='9'&&ch>='0') t=t*10+ch-48,ch=getchar();\n        if(ch=='.'){ch=getchar();while(ch<='9'&&ch>='0') t+=d*(ch^48),d*=0.1,ch=getchar();}\n        t=(f?-t:t);\n    }\n    template<typename T,typename... Args>inline void read(T& t,Args&... args){read(t); read(args...);}\n    char sr[1<<21],z[20];int C=-1,Z=0;\n    inline void Ot(){fwrite(sr,1,C+1,stdout),C=-1;}\n    inline void print(register int x)\n    {\n    \tif(C>1<<20)Ot();if(x<0)sr[++C]='-',x=-x;\n    \twhile(z[++Z]=x%10+48,x/=10);\n    \twhile(sr[++C]=z[Z],--Z);sr[++C]='\\n';\n    }\n    void file()\n    {\n        #ifndef ONLINE_JUDGE\n        freopen(\"a.txt\",\"r\",stdin);\n        #endif\n    }\n    inline void chktime()\n    {\n        #ifndef ONLINE_JUDGE\n        cout<<(clock()-t)/1000.0<<'\\n';\n        #endif\n    }\n    #ifdef mod\n    ll ksm(ll x,int y){ll ret=1;for (;y;y>>=1,x=x*x%mod) if (y&1) ret=ret*x%mod;return ret;}\n    ll inv(ll x){return ksm(x,mod-2);}\n    #else\n    ll ksm(ll x,int y){ll ret=1;for (;y;y>>=1,x=x*x) if (y&1) ret=ret*x;return ret;}\n    #endif\n//\tinline ll mul(ll a,ll b){ll d=(ll)(a*(double)b/mod+0.5);ll ret=a*b-d*mod;if (ret<0) ret+=mod;return ret;}\n}\nusing namespace my_std;\n\nint n,m;\nll val[sz];\nstruct hh{int t,nxt;}edge[sz<<1];\nint head[sz],ecnt;\nvoid make_edge(int f,int t)\n{\n\tedge[++ecnt]=(hh){t,head[f]};\n\thead[f]=ecnt;\n\tedge[++ecnt]=(hh){f,head[t]};\n\thead[t]=ecnt;\n}\n\nbool vis[sz];\nint size[sz],mn,root,tot;\n#define v edge[i].t \nvoid findroot(int x,int fa)\n{\n\tint S=-1;\n\tsize[x]=1;\n\tgo(x) if (v!=fa&&!vis[v])\n\t{\n\t\tfindroot(v,x);\n\t\tchkmax(S,size[v]);\n\t\tsize[x]+=size[v];\n\t}\n\tchkmax(S,tot-size[x]);\n\tif (chkmin(mn,S)) root=x;\n}\nvector<int>fa[sz],disf[sz];\nll sum[sz]; // \\sum val[v]\nll Sum[sz]; // \\sum val[v]*dis(x,v)\nll sumF[sz]; // \\sum val[v]*dis(fa[x],v)\nvoid dfs(int x,int par,int u,int d)\n{\n\tfa[x].push_back(u);disf[x].push_back(d);\n\tgo(x) if (v!=par&&!vis[v]) dfs(v,x,u,d+1);\n}\nvoid build(int x)\n{\n\tvis[x]=1;dfs(x,0,x,0);\n\tint all=tot;\n\tgo(x) if (!vis[v])\n\t{\n\t\ttot=size[v];if (tot>size[x]) tot=all-size[x];mn=1e9;\n\t\tfindroot(v,0);\n\t\tbuild(root);\n\t}\n}\n#undef v\nvoid add(int x,ll w)\n{\n\tdrep(i,(int)fa[x].size()-1,1)\n\t{\n\t\tint u=fa[x][i];\n\t\tll d=disf[x][i],dd=disf[x][i-1];\n\t\tsum[u]+=w;Sum[u]+=w*d;sumF[u]+=w*dd;\n\t}\n\tint u=fa[x][0],d=disf[x][0];\n\tsum[u]+=w;Sum[u]+=w*d;\n}\nll query(int x)\n{\n\tll ret=Sum[x];\n\tdrep(i,(int)fa[x].size()-2,0)\n\t{\n\t\tint u=fa[x][i],uu=fa[x][i+1];\n\t\tll d=disf[x][i];\n\t\tret+=Sum[u]-sumF[uu]+d*(sum[u]-sum[uu]);\n\t}\n\treturn ret;\n}\n\nll W,All;\nvoid Add(int x,ll w)\n{\n\tW+=w*query(x);All+=w;\n\tadd(x,w);\n\tval[x]+=w;\n}\nll Query(int x){return All*(query(x)+All)-W;}\n\nint main()\n{\n\tfile();\n\tread(n,m);\n\tint x,y,z;\n\trep(i,1,n-1) read(x,y),make_edge(x,y);\n\ttot=n;mn=1e9;findroot(1,0);build(root);\n\trep(i,1,n) read(x),Add(i,x);\n\twhile (m--)\n\t{\n\t\tread(z);\n\t\tif (z==1) read(x,y),Add(x,y-val[x]);\n\t\telse read(x),printf(\"%lld\\n\",Query(x));\n\t}\n\treturn 0;\n}\n```\n\n",
        "postTime": 1552051730,
        "uid": 76481,
        "name": "p_b_p_b",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3676 \u3010\u5c0f\u6e05\u65b0\u6570\u636e\u7ed3\u6784\u9898\u3011"
    },
    {
        "content": "\u601d\u8def\u5c31\u662f\u697c\u4e0bzzq\u5927\u795e\u7684\u601d\u8def\uff0c\u7136\u540e\u8fd9\u91cc\u662f\u4ee3\u7801\u5b9e\u73b0\u3002\n\n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n```cpp\n    #include<bits/stdc++.h>\n    using namespace std;\n    #define ll long long\n    const ll MAXN=4e5+5;\n    ll n,q,w[MAXN];\n    ll esum=0,ww[MAXN];\n    struct edge{\n        ll to,next,w;\n    }e[MAXN<<1];\n    ll head[MAXN],cnt=0;\n    inline void add(ll u,ll v,ll w){    \n        e[++cnt]=(edge){v,head[u],w},head[u]=cnt;\n        e[++cnt]=(edge){u,head[v],w},head[v]=cnt;\n    }\n    ll fa[MAXN],size[MAXN],hson[MAXN],dep[MAXN],dis[MAXN];\n    void dfs1(ll u,ll father){\n        dep[u]=dep[father]+1;\n        fa[u]=father;\n        size[u]=1;\n        for(ll i=head[u];i;i=e[i].next){\n            ll v=e[i].to,w=e[i].w;\n            if(v==father)continue;\n            dis[v]=dis[u]+w;\n            dfs1(v,u);\n            size[u]+=size[v];\n            if(size[v]>size[hson[u]]||!hson[u])hson[u]=v;\n        }\n    }\n    ll top[MAXN];\n    void dfs2(ll u,ll tp){\n        top[u]=tp;\n        if(hson[u])dfs2(hson[u],tp);\n        for(ll i=head[u];i;i=e[i].next){\n            ll v=e[i].to;\n            if(v==fa[u]||v==hson[u])continue;\n            dfs2(v,v);\n        }\n    }\n    inline ll lca(ll x,ll y){\n        ll tx=top[x],ty=top[y];\n        while(tx!=ty){\n            if(dep[tx]>dep[ty]) x=fa[tx];\n            else y=fa[ty];\n            tx=top[x],ty=top[y];\n        }\n        if(dep[x]>dep[y])swap(x,y);\n        return x;\n    }\n    ll rsize[MAXN],f[MAXN],sum,rt,par[MAXN],sub[MAXN],subfa[MAXN];\n    ll sumw[MAXN],sumwfa[MAXN];\n    bool vis[MAXN];\n    void getrt(ll u,ll fa){\n        rsize[u]=1;\n        f[u]=0;\n        for(ll i=head[u];i;i=e[i].next){\n            ll v=e[i].to,w=e[i].w;\n            if(v==fa||vis[v])continue;\n            getrt(v,u);\n            rsize[u]+=rsize[v];\n            f[u]=max(f[u],rsize[v]);\n        }\n        if(f[u]<sum-rsize[u])f[u]=sum-rsize[u];\n        if(f[u]<f[rt])rt=u;\n    }\n    void getsz(ll u,ll fa){\n        rsize[u]=1;\n        for(ll i=head[u];i;i=e[i].next){\n            ll v=e[i].to;\n            if(v==fa||vis[v])continue;\n            getrt(v,u);\n            rsize[u]+=rsize[v];\n        }\n    }\n    void solve(ll u,ll fa){\n        vis[u]=1;par[u]=fa;\n        for(ll i=head[u];i;i=e[i].next){\n            ll v=e[i].to;\n            if(v==fa||vis[v])continue;\n            getsz(v,0);\n            f[0]=sum=rsize[v];\n            getrt(v,rt=0);\n            solve(rt,u);\n        }\n    }\n    inline ll getdis(ll x,ll y){\n        return dis[x]+dis[y]-(dis[lca(x,y)]<<1);\n    }\n    void memfz(){//sub\u4e3acost \n        for(ll u=1;u<=n;u++){\n            sumw[u]+=w[u]; \n            for(ll i=u;par[i];i=par[i]){\n                ll dist=getdis(u,par[i]);\n                sumw[par[i]]+=w[u];\n                sumwfa[i]+=w[u];\n                sub[par[i]]+=dist*w[u];\n                subfa[i]+=dist*w[u];\n            }\n        }\n    }\n    ll calc(ll u){\n        ll ans=sub[u];\n        for(ll i=u;par[i];i=par[i]){\n            ll dist=getdis(par[i],u);\n            ans+=sub[par[i]]-subfa[i];\n            ans+=dist*(sumw[par[i]]-sumwfa[i]);\n        }\n        return ans+esum;\n    }\n    struct rt1tree{\n        #define lson (o<<1)\n        #define rson (o<<1|1)\n        ll size[MAXN],dep[MAXN],fa[MAXN],hson[MAXN];\n        void dfs1(ll u,ll father){\n            size[u]=1;\n            dep[u]=dep[father]+1;\n            fa[u]=father;\n            for(ll i=head[u];i;i=e[i].next){\n                ll v=e[i].to;\n                if(v==father)continue;\n                dfs1(v,u);\n                ww[u]+=ww[v];\n                size[u]+=size[v];\n                if(!hson[u]||size[v]>size[hson[u]])hson[u]=v;\n            } \n        }\n        ll id[MAXN],top[MAXN],real1[MAXN];\n        ll num;\n        void dfs2(ll u,ll tp){\n            top[u]=tp;\n            id[u]=++num;\n            real1[num]=u;\n            if(hson[u])dfs2(hson[u],tp);\n            for(ll i=head[u];i;i=e[i].next){\n                ll v=e[i].to;\n                if(v==fa[u]||v==hson[u])continue;\n                dfs2(v,v);\n            } \n        }\n        ll sumv[MAXN<<2],lzt[MAXN<<2];\n        inline void pushdown(ll o,ll l,ll r){\n            if(lzt[o]){\n                ll mid=(l+r)>>1;\n                lzt[lson]+=lzt[o];sumv[lson]+=(mid-l+1)*lzt[o];\n                lzt[rson]+=lzt[o];sumv[rson]+=(r-mid)*lzt[o];\n                lzt[o]=0;\n            }\n        }\n        inline void pushup(ll o){sumv[o]=sumv[lson]+sumv[rson];}\n        void build(ll o,ll l,ll r){\n            lzt[o]=0;\n            if(l==r){sumv[o]=ww[real1[l]];return;}\n            ll mid=(l+r)>>1;\n            build(lson,l,mid);\n            build(rson,mid+1,r);\n            pushup(o);\n        }\n        void change(ll o,ll l,ll r,ll ql,ll qr,ll w){\n            if(ql<=l&&qr>=r){sumv[o]+=(r-l+1)*w;lzt[o]+=w;return;}\n            ll mid=(l+r)>>1;\n            pushdown(o,l,r);\n            if(ql<=mid)change(lson,l,mid,ql,qr,w);\n            if(qr>mid)change(rson,mid+1,r,ql,qr,w);\n            pushup(o);\n        }\n        ll query(ll o,ll l,ll r,ll ql,ll qr){\n            if(ql<=l&&qr>=r){return sumv[o];}\n            ll mid=(l+r)>>1,ans=0;\n            pushdown(o,l,r);\n            if(ql<=mid)ans+=query(lson,l,mid,ql,qr);\n            if(qr>mid)ans+=query(rson,mid+1,r,ql,qr);\n            return ans;\n        }\n        inline void chain_change(ll x,ll y,ll w){\n            ll tx=top[x],ty=top[y];\n            while(tx!=ty){\n                if(dep[tx]>dep[ty]){\n                    change(1,1,n,id[tx],id[x],w);\n                    x=fa[tx];\n                }\n                else {\n                    change(1,1,n,id[ty],id[y],w);\n                    y=fa[ty];\n                }\n                tx=top[x],ty=top[y];\n            }\n            if(dep[x]<dep[y])swap(x,y);\n            change(1,1,n,id[y],id[x],w);\n        }\n        inline ll chain_query(ll x,ll y){\n            ll tx=top[x],ty=top[y];\n            ll ans=0;\n            while(tx!=ty){\n                if(dep[tx]>dep[ty]){\n                    ans+=query(1,1,n,id[tx],id[x]);\n                    x=fa[tx];\n                }\n                else {\n                    ans+=query(1,1,n,id[ty],id[y]);\n                    y=fa[ty];\n                }\n                tx=top[x],ty=top[y];\n            }\n            if(dep[x]<dep[y])swap(x,y);\n            ans+=query(1,1,n,id[y],id[x]);\n            return ans;\n        }\n        inline ll querysub(ll p){\n            return query(1,1,n,id[p],id[p]+size[p]-1);\n        }\n    }T;\n    inline void dianfen_change(ll p,ll q){\n        sumw[p]+=q;\n        for(ll i=p;par[i];i=par[i]){\n            ll dist=getdis(p,par[i]);\n            ll cost=q*dist;\n            sumw[par[i]]+=q;\n            sumwfa[i]+=q;\n            sub[par[i]]+=cost;\n            subfa[i]+=cost;\n        }\n    }\n    int main(){\n        ll oldrt,wfang=0;\n        T.num=0;\n        memset(vis,0,sizeof(vis));\n        scanf(\"%lld%lld\",&n,&q);\n        for(ll i=1;i<n;i++){\n            ll tem1,tem2;\n            scanf(\"%lld%lld\",&tem1,&tem2);\n            add(tem1,tem2,1);\n        }\n        for(ll i=1;i<=n;i++){\n            scanf(\"%lld\",&w[i]);\n            ww[i]=w[i];\n            esum+=w[i];\n        }\n        sum=f[0]=n;\n        getrt(1,rt=0);\n        oldrt=rt;\n        solve(rt,0);\n        dfs1(oldrt,oldrt);\n        dfs2(oldrt,oldrt);    \n        memfz();\n        T.dfs1(1,1);\n        T.dfs2(1,1);\n        T.build(1,1,n);\n        for(ll i=1;i<=n;i++)wfang+=T.chain_query(i,i)*T.chain_query(i,i);\n        for(ll i=1;i<=q;i++){\n            ll tem1,tem2,tem3;\n            scanf(\"%lld%lld\",&tem1,&tem2);\n            if(tem1==1){\n                scanf(\"%lld\",&tem3);\n                ll q=tem3-w[tem2];\n                esum+=q;\n                w[tem2]=tem3;\n                ll p=T.chain_query(1,tem2);\n                wfang+=((p*q)<<1)+(getdis(1,tem2)+1)*q*q;\n                T.chain_change(1,tem2,q);\n                dianfen_change(tem2,q);\n            }\n            else {\n                ll g=calc(1);\n                g*=esum;\n                g-=wfang;\n                ll ww=calc(tem2);\n                ww*=esum;\n                ww-=g;\n                printf(\"%lld\\n\",ww);\n            }\n        }\n        return 0;\n    }\n\n```",
        "postTime": 1513586665,
        "uid": 55704,
        "name": "luoyue123",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P3676 \u3010\u5c0f\u6e05\u65b0\u6570\u636e\u7ed3\u6784\u9898\u3011"
    },
    {
        "content": "# \u5c0f\u6e05\u65b0\u6570\u636e\u7ed3\u6784\u9898\n\n\u52a8\u6001\u70b9\u5206\u6cbb\uff01\n\n## \u9898\u76ee\u53d9\u8ff0\n\n\u6709\u4e00\u68f5$n$\u4e2a\u70b9\u7684\u6811\uff0c\u6bcf\u4e2a\u70b9\u6709\u4e00\u4e2a\u70b9\u6743\u3002\u73b0\u5728\u6709$q$\u6b21\u64cd\u4f5c\uff0c\u6bcf\u6b21\u64cd\u4f5c\u662f\u4fee\u6539\u4e00\u4e2a\u70b9\u7684\u70b9\u6743\u6216\u6307\u5b9a\u4e00\u4e2a\u70b9\uff0c\u8be2\u95ee\u4ee5\u8fd9\u4e2a\u70b9\u4e3a\u6839\u65f6\u6bcf\u68f5\u5b50\u6811\u70b9\u6743\u548c\u7684\u5e73\u65b9\u548c\u3002\n\n## \u60f3\u6cd5\n\n+ \u8fd9\u6839\u672c\u4e0d\u662f\u8def\u5f84\u95ee\u9898\u554a\uff0c\u8fd9\u662f\u5b50\u6811\u7684\u95ee\u9898\uff01\u70b9\u5206\u6cbb\u65e0\u6cd5\u89e3\u51b3\uff01\u6240\u4ee5\uff0c\u5982\u4f55\u53d8\u6210\u8def\u5f84\u95ee\u9898\uff1f\n\n+ \u8fd9\u4e2a\u5176\u5b9e\u76f8\u5f53\u4e8e$\\sum_{i=1}^n\\sum_{j=1}^nv_iv_j\\operatorname {dep}(\\operatorname{lca}(i,j))$\u3002\n\n+ \u90a3\u4e48\uff0c\u5927\u6982\u628a\u4e00\u4e2a\u70b9\u5f53\u6210`LCA`\u8ba1\u7b97\u4f4e\u4e0b\u7684\u70b9\u7684\u8d21\u732e\u548c\uff1f\u8fd9\u597d\u50cf\u4e0d\u592a\u9760\u8c31\uff0c\u56e0\u4e3a\u65e0\u6cd5\u5e26\u4fee\u6539\u3002\n\n+ \u8003\u8651\u5316\u7b80\u8fd9\u4e2a\u5f0f\u5b50\uff1a\n\n  + $$\n    \\begin{aligned}\n    \\sum_{i=1}^n\\sum_{j=1}^nv_iv_j\\operatorname {dep}(\\operatorname{lca}(i,j)) &= \\frac{1}{2}\\sum_{i=1}^n\\sum_{j=1}^nv_iv_j(\\operatorname {dep}(i)+\\operatorname {dep}(j)-2\\operatorname {dis}(i,j))\n    \\end{aligned}\n    $$\n\n  + \u53ef\u4ee5\u628a\u5f0f\u5b50\u62c6\u6210\u4e24\u4e2a\u90e8\u5206\uff1a\n\n    + $$\n      2\\sum_{i=1}^n\\sum_{j=1}^nv_iv_j\\operatorname{dep}(j)=2(\\sum_{i=1}^nv_i)(\\sum_{i=1}^nv_j\\operatorname{dep}(j))\n      $$\n\n    + $$\n      \\sum_{i=1}^n\\sum_{j=1}^n2v_iv_j\\operatorname{dis}(i,j)\n      $$\n\n  + \u5bf9\u4e8e\u7b2c\u4e00\u4e2a\uff0c\u53ef\u4ee5\u628a$\\operatorname{dep}(i)$\u770b\u4f5c\u5230\u6839\u8282\u70b9\u7684\u8ddd\u79bb\u3002\n\n  + \u4e8e\u662f\u53ef\u4ee5\u53d1\u73b0\u7b2c\u4e8c\u4e2a\u548c\u7b2c\u4e00\u4e2a\u90fd\u662f\u7c7b\u4f3c\u4e8e$\\sum_{j=1}^n\\operatorname{dis}(i,j)v_j$\u8fd9\u6837\u7684\u5f0f\u5b50\u3002\n\n  + \u8003\u8651\u52a8\u6001\u70b9\u5206\u6cbb\u7ef4\u62a4\u3002\n\n## \u4ee3\u7801\n\n```cpp\n#include <cstdio>\n#include <vector>\nusing namespace std;\nconst int maxNode = 2e5 + 5;\ntypedef long long ll;\nint nbNode, nbQry, up[maxNode], size[maxNode], maxPart[maxNode], val[maxNode];\nll inDis[maxNode], faDis[maxNode], inSum[maxNode], sum, nodeSum;\nbool vis[maxNode];\nstruct Graph {\n\tvector<int> G[maxNode];\n\tint st[maxNode * 2][20], Lg[maxNode * 2], oula[maxNode], dep[maxNode], tail;\n\tvoid Add(int u, int v) {\n\t\tG[u].push_back(v);\n\t\tG[v].push_back(u);\n\t}\n\tvoid Dfs(int now, int from) {\n\t\tdep[now] = dep[from] + 1;\n\t\tst[++tail][0] = dep[now];\n\t\toula[now] = tail;\n\t\tfor (int to : G[now]) {\n\t\t\tif (to == from)\n\t\t\t\tcontinue ;\n\t\t\tDfs(to, now);\n\t\t\tst[++tail][0] = dep[now];\n\t\t}\n\t}\n\tvoid BuildSt() {\n\t\tfor (int num = 2; num <= tail; ++num)\n\t\t\tLg[num] = Lg[num / 2] + 1;\n\t\tfor (int lift = 1; lift <= Lg[tail]; ++lift)\n\t\t\tfor (int pos = 1; pos + (1 << lift) - 1 <= tail; ++pos)\n\t\t\t\tst[pos][lift] = min(st[pos][lift - 1], st[pos + (1 << (lift - 1))][lift - 1]);\n\t}\n\tint Dis(int uNd, int vNd) {\n\t\tif (oula[uNd] > oula[vNd])\n\t\t\tswap(uNd, vNd);\n\t\tint l = Lg[oula[vNd] - oula[uNd] + 1];\n\t\tint lca = min(st[oula[uNd]][l], st[oula[vNd] - (1 << l) + 1][l]);\n\t\treturn dep[uNd] + dep[vNd] - lca * 2;\n\t}\n} tree;\nint GetRoot(int now, int from, int all) {\n\tsize[now] = 1;\n\tmaxPart[now] = 0;\n\tint ret = 0;\n\tfor (int to : tree.G[now]) {\n\t\tif (to == from || vis[to])\n\t\t\tcontinue ;\n\t\tint sonRoot = GetRoot(to, now, all);\n\t\tsize[now] += size[to];\n\t\tmaxPart[now] = max(maxPart[now], size[to]);\n\t\tif (maxPart[ret] > maxPart[sonRoot])\n\t\t\tret = sonRoot;\n\t}\n\tmaxPart[now] = max(maxPart[now], all - size[now]);\n\tif (maxPart[ret] > maxPart[now])\n\t\tret = now;\n\treturn ret;\n}\nvoid Divide(int now, int all) {\n\tvis[now] = 1;\n\tfor (int to : tree.G[now]) {\n\t\tif (vis[to])\n\t\t\tcontinue ;\n\t\tint sonSize = (size[to] < size[now]) ? (size[to]) : (all - size[now]);\n\t\tint rt = GetRoot(to, -1, sonSize);\n\t\tup[rt] = now;\n\t\tDivide(rt, sonSize);\n\t}\n}\nint Cal(int node) {\n\tll ret = inDis[node];\n\tfor (int now = node; up[now]; now = up[now]) {\n\t\tint dis = tree.Dis(node, up[now]);\n\t\tret += inDis[up[now]] - faDis[now];\n\t\tret += 1ll * dis * (inSum[up[now]] - inSum[now]);\n\t}\n\treturn ret;\n}\nvoid Modify(int node, int val) {\n\tsum += 1ll * Cal(node) * val;\n\tinSum[node] += val;\n\tfor (int now = node; up[now]; now = up[now]) {\n\t\tint dis = tree.Dis(node, up[now]);\n\t\tinSum[up[now]] += val;\n\t\tinDis[up[now]] += 1ll * dis * val;\n\t\tfaDis[now] += 1ll * dis * val;\n\t}\n}\nint main() {\n\tscanf(\"%d%d\", &nbNode, &nbQry);\n\tfor (int edge = 1; edge < nbNode; ++edge) {\n\t\tint uNd, vNd;\n\t\tscanf(\"%d%d\", &uNd, &vNd);\n\t\ttree.Add(uNd, vNd);\n\t}\n\ttree.Dfs(1, 0);\n\ttree.BuildSt();\n\tmaxPart[0] = 0x3f3f3f3f;\n\tDivide(GetRoot(1, -1, nbNode), nbNode);\n\tfor (int i = 1; i <= nbNode; ++i) {\n\t\tscanf(\"%d\", &val[i]);\n\t\tnodeSum += val[i];\n\t\tModify(i, val[i]);\n\t}\n\twhile (nbQry--) {\n\t\tint opt;\n\t\tscanf(\"%d\", &opt);\n\t\tif (opt == 1) {\n\t\t\tint node, newVal;\n\t\t\tscanf(\"%d%d\", &node, &newVal);\n\t\t\tModify(node, newVal - val[node]);\n\t\t\tnodeSum += newVal - val[node];\n\t\t\tval[node] = newVal;\n\t\t} else {\n\t\t\tint rt;\n\t\t\tscanf(\"%d\", &rt);\n\t\t\tprintf(\"%lld\\n\", 1ll * Cal(rt) * nodeSum - sum + 1ll * nodeSum * nodeSum);\n\t\t}\n\t}\n\treturn 0;\n}\n```\n\n\n\n## \u77e5\u8bc6\u70b9\n\n+ \u5982\u4f55\u7ef4\u62a4\u7ecf\u5178\u5f0f\u5b50$\\sum_{j=1}^n\\operatorname{dis}(i,j)v_j$\u3002\n+ \u6ce8\u610f\u63a8\u5f0f\u5b50\u3002\n+ \u8003\u8651\u628a\u5b50\u6811\u7684\u95ee\u9898\u8f6c\u5316\u4e3a\u8def\u5f84\u4e0a\u7684\u95ee\u9898\uff0c\u7528\u52a8\u6001\u70b9\u5206\u6cbb\u3002",
        "postTime": 1583591348,
        "uid": 75715,
        "name": "KokiNiwa",
        "ccfLevel": 0,
        "title": "\u5c0f\u6e05\u65b0\u6570\u636e\u7ed3\u6784\u9898\uff08\u52a8\u6001\u70b9\u5206\u6cbb\uff09"
    },
    {
        "content": "\n\u8bbe $m=\\sum_{i=1}^n w_i$\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u8bbe $A,S$ \u4e24\u4e2a\u53d8\u91cf\uff0c\u5176\u4e2d\uff1a\n\n$$A=m\\sum \\textrm{size}(x)$$\n\n$$S=\\sum \\textrm{size}(x)\\cdot (m-\\textrm{size}(x))$$\n\n\u90a3\u4e48\uff1a$A-S$ \u5373\u4e3a\u7b54\u6848\u3002\n\n\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u53ef\u4ee5\u89c2\u5bdf\u5230\uff0c$S$ \u662f\u4e00\u4e2a\u4e0e\u6839\u7684\u9009\u53d6\u65e0\u5173\u7684\u5b9a\u503c\uff0c\u4e0d\u96be\u6ce8\u610f\u5230 $S$ \u7684\u8ba1\u7b97\u53ef\u4ee5\u62c6\u5f00\u6bcf\u6761\u8fb9\u5e76\u8003\u8651\u8d21\u732e\u3002\n\n\u4e8e\u662f\u6211\u4eec\u53ea\u9700\u8981\uff1a\n\n1. \u652f\u6301\u4fee\u6539\uff0c\u5e76\u7ef4\u62a4 $S$\n2. \u652f\u6301\u67e5\u8be2\u67d0\u4e2a\u6839\u7684 $A$\n\n\u7b2c\u4e8c\u95ee\u662f\u4e00\u4e2a\u7ecf\u5178\u95ee\u9898\u4e86\uff08\u6362\u6839\u5e76\u67e5\u8be2\u8ddd\u79bb\u4e58\u4ee5\u6743\u503c\u548c\uff09\n\n\u7b2c\u4e00\u95ee\u6211\u4eec\u53d1\u73b0\u7ec4\u5408\u610f\u4e49\u4e4b\u540e\uff0c\u53ef\u4ee5\u8fdb\u4e00\u6b65\u8003\u8651\uff0c\u4e0d\u96be\u6ce8\u610f\u5230\u5176\u4e3a\uff1a\n\n$$\\sum \\sum[u<v] w_u\\times w_v\\times \\textrm{dist}(u,v)$$\n\n\u679a\u4e3e $u$\uff0c\u53d1\u73b0\u7edf\u8ba1\u7684\u8d21\u732e\u53c8\u662f\u7b2c\u4e8c\u95ee\u4e86\uff0c\u6bcf\u6b21\u4fee\u6539\u5f71\u54cd\u4e14\u4ec5\u5f71\u54cd\u4e00\u4e2a\u70b9\u7684\u8d21\u732e\uff0c\u8ba1\u7b97\u65b9\u6cd5\u540c\u7b2c\u4e8c\u95ee\u3002\n\n\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std ;\n#define Next( i, x ) for( register int i = head[x]; i; i = e[i].next )\n#define rep( i, s, t ) for( register int i = s; i <= t; ++ i )\n#define re register\n#define int long long\ninline int gi() {\n    char cc = getchar() ; int cn = 0, flus = 1 ; \n    while( cc > '9' || cc < '0' ) { if( cc == '-' ) flus = - flus ; cc = getchar() ; }\n    while( cc <= '9' && cc >= '0' ) cn = cn * 10 + cc - '0', cc = getchar() ; \n    return cn * flus ; \n}\nconst int N = 2e5 + 5 ; \nint n, q, head[N], w[N], dp[N], vis[N], RS ; \nint d[N], f[N], g[N], fa[N], cnt, rt, root, sum, S ; \nint Fa[N], sz[N], Top[N], Son[N], dep[N], sw[N] ; \nstruct E {\n\tint to, next ; \n} e[N * 2] ;\ninline void add( int x, int y ) {\n\te[++ cnt] = (E){ y, head[x] }, head[x] = cnt ,\n\te[++ cnt] = (E){ x, head[y] }, head[y] = cnt ; \n}\ninline void dfs1( int x, int ff ) {\n\tdep[x] = dep[ff] + 1, sz[x] = 1, Fa[x] = ff, sw[x] = w[x] ; \n\tNext( i, x ) {\n\t\tint v = e[i].to ; if( v == ff ) continue ; \n\t\tdfs1( v, x ), sz[x] += sz[v], sw[x] += sw[v], d[x] += d[v] ; \n\t\tif( sz[v] > sz[Son[x]] ) Son[x] = v ;  \n\t}\n\tS += ( RS - sw[x] ) * sw[x] ; \n}\ninline void dfs2( int x, int ff ) {\n\tTop[x] = ff ; \n\tif( Son[x] ) dfs2( Son[x], ff ) ;\n\tNext( i, x ) {\n\t\tint v = e[i].to ; if( v == Fa[x] || v == Son[x] ) continue ;\n\t\tdfs2( v, v ) ;  \n\t} \n}\nint LCA( int x, int y ) {\n\twhile( Top[x] != Top[y] ) {\n\t\tif( dep[Top[x]] < dep[Top[y]] ) swap( x, y ) ;\n\t\tx = Fa[Top[x]] ; \n\t}\n\treturn ( dep[x] > dep[y] ) ? y : x ; \n}\ninline void get_rt( int x, int ff ) {\n\tsz[x] = 1, dp[x] = 0 ; \n\tNext( i, x ) {\n\t\tint v = e[i].to ; if( v == ff || vis[v] ) continue ; \n\t\tget_rt( v, x ), sz[x] += sz[v] ;\n\t\tdp[x] = max( sz[v], dp[x] ) ;\n\t}\n\tdp[x] = max( dp[x], sum - sz[x] ) ;\n\tif( dp[x] <= dp[rt] ) rt = x ; \n}\ninline void solve( int x ) {\n\tvis[x] = 1 ; \n\tNext( i, x ) {\n\t\tint v = e[i].to ; if( vis[v] ) continue ; \n\t\trt = 0, dp[0] = sum = sz[v], get_rt( v, x ),\n\t\tfa[rt] = x, solve( rt ) ;\n\t}\n}\ninline int dist( int x, int y ) {\n\treturn dep[x] + dep[y] - 2 * dep[LCA(x, y)] ; \n}\nvoid Init( int x ) {\n\trep( i, 1, n ) {\n\t\tint u = i, fr ; d[i] += w[i] ;\n\t\twhile( fa[u] ) {\n\t\t\tfr = dist( i, fa[u] ), f[fa[u]] += fr * w[i], \n\t\t\td[fa[u]] += w[i], g[u] += fr * w[i], u = fa[u] ;\n\t\t}\n\t}\n}\nint Query( int x ) {\n\tint Ans = f[x], u = x ; \n\twhile( fa[u] ) {\n\t\tAns += ( f[fa[u]] - g[u] ) ;\n\t\tAns += ( d[fa[u]] - d[u] ) * dist( fa[u], x ) ;\n\t\tu = fa[u] ; \n\t}\n\treturn Ans ; \n}\nvoid Update( int x, int p ) {\n\tint u = x, fr, y = p - w[x] ; \n\tint ru = Query( x ) ;\n\tS += ru * y, d[x] += y, RS += y ; ;\n\twhile( fa[u] ) {\n\t\tfr = dist( x, fa[u] ), f[fa[u]] += fr * y, \n\t\td[fa[u]] += y, g[u] += fr * y, u = fa[u] ;\n\t}\n\tw[x] = p ; \n}\nsigned main() {\n    sum = n = gi(), q = gi(), rt = 0, dp[0] = n + 1 ; int opt, x, y ; \n    rep( i, 2, n ) x = gi(), y = gi(), add( x, y ) ;\n    rep( i, 1, n ) w[i] = gi(), RS += w[i] ; \n    dfs1( 1, 1 ), dfs2( 1, 1 ), get_rt( 1, 1 ), \n\troot = rt, solve( rt ), Init(root) ; \n\twhile( q-- ) {\n\t\topt = gi(), x = gi() ;\n\t\tif( opt == 1 ) y = gi(), Update( x, y ) ; \n\t\telse printf(\"%lld\\n\", ( Query( x ) + RS ) * RS - S ) ;\n\t}\n\treturn 0 ; \n}\n```",
        "postTime": 1569413559,
        "uid": 30036,
        "name": "Soulist",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3676 \u3010\u5c0f\u6e05\u65b0\u6570\u636e\u7ed3\u6784\u9898\u3011"
    },
    {
        "content": "\u5176\u5b9e\u8fd9\u9053\u6570\u636e\u7ed3\u6784\u5e76\u4e0d\u592a\u96be\u5199\n\n\u5173\u952e\u8981\u60f3\u5230\u505a\u6cd5\n\n\u5bf9\u4e8e\u7ebf\u6bb5\u6811\u7684\u6bcf\u4e2a\u8282\u70b9\uff0c\u8bb0\u5f55\u8fd9\u6bb5\u533a\u95f4\u7684\u548c\uff0c\u548c*sum\u7684\u4e2a\u6570\uff0c\u503c\u4e3a0\u7684\u4e2a\u6570,\n\n\u6b64\u5916\uff0c\u8fd8\u8981\u7ef4\u62a4\u4e24\u4e2a\u61d2\u60f0\u6807\u8bb0\n\n\u5f53\u7136\u4e5f\u53ef\u4ee5\u76f4\u63a5\u6811\u72b6\u6570\u7ec4\n\n\u7136\u540elog2\n\n\u5176\u5b9e\u5e76\u4e0d\u662f\u4ec0\u4e48\u70b9\u5206\u6cbb\n\n\u4ee3\u7801\uff1a\n\n```cpp\n// luogu-judger-enable-o2\n#include<bits/stdc++.h>\n#define N 500005\n#define ll long long\nusing namespace std;\nstruct Info{int nu,ne;}a[N];\nll w[N],c[N],c1[N],c2[N],ans;\nint n,m,num,cnt,b[N],si[N],f[N],son[N],pos[N],top[N],dfn[N];\nvoid jb(int x,int y){a[++num].nu=y;a[num].ne=b[x];b[x]=num;}\nint lowbit(int x){return x&-x;}\nvoid gai(int x,ll w){for(int i=x;i<=n;i+=lowbit(i))c1[i]+=w,c2[i]+=(ll)x*w;}\nll cha(int x){ll w=0;for(int i=x;i;i-=lowbit(i))w+=1ll*(x+1)*c1[i]-c2[i];return w;}\nvoid dfs1(int x,int fa){\n\tsi[x]=1;f[x]=fa;\n\tfor (int y=b[x];y;y=a[y].ne){\n\t\tint v=a[y].nu;if (v==fa)continue;\n\t\tdfs1(v,x);w[x]+=w[v];si[x]+=si[v];\n\t\tif (si[v]>si[son[x]])son[x]=v;\n\t}\n\tans+=1ll*w[x]*w[x];\n}\nvoid dfs2(int x,int t){\n\ttop[x]=t;pos[dfn[x]=++cnt]=x;\n\tgai(dfn[x],w[x]-w[pos[cnt-1]]);\n\tif (son[x])dfs2(son[x],t);\n\tfor (int y=b[x];y;y=a[y].ne)if (a[y].nu!=f[x]&&a[y].nu!=son[x])dfs2(a[y].nu,a[y].nu);\n}\nll query(int x){\n\tint k=0;ll s=0,t=cha(1);\n\tfor (;x;x=f[top[x]]){\n\t\tk+=dfn[x]-dfn[top[x]]+1;s+=cha(dfn[x])-cha(dfn[top[x]]-1);\n\t}\n\treturn ans+t*(t*(k+1)-s*2);\n}\nvoid modify(int x,ll y){\n\tint k=0;ll s=0;\n\tfor (;x;x=f[top[x]]){\n\t\tk+=dfn[x]-dfn[top[x]]+1;s+=cha(dfn[x])-cha(dfn[top[x]]-1);\n\t\tgai(dfn[top[x]],y);gai(dfn[x]+1,-y);\n\t}\n\tans+=y*(y*k+s*2);\n}\nint main(){\n\tscanf(\"%d%d\",&n,&m);\n\tfor (int i=1;i<n;i++){\n\t\tint x,y;scanf(\"%d%d\",&x,&y);\n\t\tjb(x,y);jb(y,x);\n\t}\n\tfor (int i=1;i<=n;i++)scanf(\"%lld\",&c[i]),w[i]=c[i];\n\tdfs1(1,0);dfs2(1,1);\n\twhile (m--){\n\t\tint opt,x;ll y;\n\t\tscanf(\"%d%d\",&opt,&x);\n\t\tif (opt==1){\n\t\t\tscanf(\"%lld\",&y);y-=c[x];c[x]+=y;modify(x,y);\n\t\t}else printf(\"%lld\\n\",query(x));\n\t}\n\treturn 0;\n}\n\n```\n",
        "postTime": 1553335948,
        "uid": 30817,
        "name": "muller",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3676 \u3010\u5c0f\u6e05\u65b0\u6570\u636e\u7ed3\u6784\u9898\u3011"
    }
]