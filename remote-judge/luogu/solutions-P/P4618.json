[
    {
        "content": "SDOI2018\u5168\u90e8\u505a\u5b8c\u4e00\u904d\u796d\n\n\u611f\u89c9\u662fR2\u516d\u9053\u9898\u4e2d\u6700\u7cbe\u795e\u6c61\u67d3\u7684\u4e00\u9053\u2026\u2026\n\n\u6162\u6162\u809d\u5427\u2026\u2026\n\nclaris\u7684\u6811\u72b6\u6570\u7ec4\u9898\u89e3\u592a\u795e\u5566\u6ca1\u6709\u770b\u61c2\u2026\u2026\n\n\u6240\u4ee5\u6211\u4eec\u8fd9\u91cc\u4ecb\u7ecd\u4e00\u4e2a\u7b80(chao)\u5355(ji)\u6613(nan)\u61c2(xie)\u7684\u4e3b\u5e2d\u6811\u505a\u6cd5\n\n___________________________\n\n### \u524d\u7f6e\u829d\u58eb:\u4e3b\u5e2d\u6811(\u53ef\u6301\u4e45\u5316\u7ebf\u6bb5\u6811,\u53ef\u6301\u4e45\u5316\u6570\u7ec4)\n\n\u4ec0\u4e48\u6562\u521aSD\u4e8c\u8f6e\u9898\u4e0d\u4f1a\u4e3b\u5e2d\u6811?\n\n\u51fa\u95e8\u5de6\u8f6cluogu\u819c\u677f\u533a\n\n# \u672c\u9898\u9898\u89e3\n\n\u9898\u76ee\u7b80\u5355\u6613\u61c2,\u6811\u4e0a\u6570\u989c\u8272\n\n\u5982\u679c\u53ea\u6709\u64cd\u4f5c1\u7684\u663e\u7136\u53ef\u4ee5\u6811\u4e0a\u83ab\u961f\u83bd\u8fc7\u53bb\n\n\u4f46\u662f\u6211\u4eec\u6709\u53ef\u7231\u7684\u64cd\u4f5c2\u6b64\u65f6\u7684\u64cd\u4f5c\u5c31\u7565\u663e\u8fa3\u624b\u4e86\n\n\u4f46\u662f\u4f60\u4ed4\u7ec6\u770b\u4e00\u773c\u4f1a\u53d1\u73b0\u6570\u636e\u662fran\u51fa\u6765\u7684!\n\n\u8fd9\u610f\u5473\u7740\u4e00\u4ef6\u4e8b\u60c5,\u4efb\u610f\u4e00\u4e2a\u70b9\u5230\u4e3b\u94fe\u7684\u8ddd\u79bb\u5747\u662fO(logn)\u7ea7\u522b\u7684\n\n\u53e6\u5916\u4e00\u4ef6\u4e8b\u60c5\u5c31\u662f\u6bcf\u79cd\u989c\u8272\u7684\u79cd\u7c7b\u662fO(1)\u7ea7\u522b\u7684\n\n\u56e0\u6b64\u6211\u4eec\u7684\u601d\u8def\u5c31\u662f\u628a\u8fd9\u4e2a\u6811\u4e0a\u95ee\u9898\u53d8\u6210\u5e8f\u5217\u95ee\u9898\uff0c\u62bd\u53d6\u8def\u5f84\u7684\u4e0a\u7684\u4e00\u6761\u957f\u94fe\u7528\u5e8f\u5217\u4e0a\u7684\u6570\u636e\u7ed3\u6784\u8fdb\u884c\u7ef4\u62a4\n\n\u5269\u4f59\u7684O(logn)\u4e2a\u6563\u70b9\u66b4\u529b\u63d2\u5165\uff0c\u8fd9\u6837\u7684\u8bdd\u6211\u4eec\u6700\u540e\u7684\u590d\u6742\u5ea6\u662f$O(nlog^2n)$\u7684\n\n\u6240\u4ee5\u8ba9\u6211\u4eec\u5148\u6765\u8003\u8651\u4e00\u4e0b\u5e8f\u5217\u4e0a\u7684\u95ee\u9898~\n\n## \u5e8f\u5217\u95ee\u9898\n\n### \u64cd\u4f5c1\n\n\u5f53\u7136\u4f60\u53ef\u4ee5\u76f4\u63a5\u83ab\u961f\u83bd\u8fc7\u53bb\n\n\u4f46\u662f\u8fd9\u662f\u5e8f\u5217\uff0c\u6211\u4eec\u8003\u8651\u4e00\u4e2a\u4f18\u96c5\u4e00\u70b9\u7684log\u505a\u6cd5\n\n\u8fd9\u91cc\u6709\u4e00\u4e2a\u5341\u5206\u7ecf\u5178\u7684\u5957\u8def\u53eb\u53ea\u6570\u6bcf\u4e2a\u989c\u8272\u5de6\u4fa7\u7b2c\u4e00\u4e2a\u70b9\n\n\u4e3a\u6b64\u6211\u4eec\u8bb0$pre_{i}$\u8868\u793ai\u5de6\u4fa7\u7b2c\u4e00\u4e2a\u548c\u5b83\u540c\u8272\u70b9\u7684\u4f4d\u7f6e,\u5982\u679c\u8fd9\u6837\u7684\u70b9\u4e0d\u5b58\u5728\u7684\u8bdd$pre_{i}=0$\n\n\u90a3\u4e48\u4e00\u4e2a\u70b9i\u662f$[l,r]$\u4e2d\u7684\u5de6\u4fa7\u7b2c\u4e00\u4e2a\u70b9\u5f53\u4e14\u4ec5\u5f53$pre_{i}<l$\n\n\u95ee\u9898\u53d8\u6210\u4e86\u67e5\u8be2\u533a\u95f4\u4e2d$pre_{i}<l$\u7684\u70b9\u7684\u4e2a\u6570\n\n\u4e3b\u5e2d\u6811\u7ecf\u5178\u95ee\u9898,\u4e00\u4e2a\u4e3b\u5e2d\u6811\u5373\u53ef\u89e3\u51b3\u4e86\n\n### \u64cd\u4f5c2\n\n\u5728\u5e8f\u5217\u4e0a\u64cd\u4f5c2\u7684\u9650\u5236\u53d8\u6210\u4e86\u8981\u6c42x\u5728[1,A]\u4e4b\u95f4,y\u5728[1,B]\u4e4b\u95f4\u4e86\n\n\u8bb2\u4e00\u53e5\u5f88\u4e0d\u8981\u8138\u7684\u8bdd,\u6211\u4eec\u8003\u8651\u8d21\u732e(\u56e0\u4e3a\u5927\u90e8\u5206\u65f6\u5019\u4f60\u90fd\u662f\u4e0d\u77e5\u9053\u600e\u4e48\u8003\u8651\u7684)!\n\n\u539f\u6765\u662f\u679a\u4e3e\u6bcf\u4e00\u4e2a\u8be2\u95ee\u8003\u8651\u6709\u591a\u5c11\u4e2a\u70b9\u5bf9\u8fd9\u4e2a\u8be2\u95ee\u4ea7\u751f\u4e86\u8d21\u732e\n\n\u73b0\u5728\u6211\u4eec\u662f\u679a\u4e3e\u6bcf\u4e00\u4e2a\u70b9\u770b\u6709\u591a\u5c11\u4e2a\u6709\u6548\u8be2\u95ee\u8986\u76d6\u5b83\n\n\u7136\u540e\u5206\u4e24\u79cd\u60c5\u51b5\u8ba8\u8bba\n\n#### case1:i\u5728(A,B]\u4e4b\u95f4\n\n\u6b64\u65f6\u6211\u4eec\u53d1\u73b0i\u4ea7\u751f\u4e86\u8d21\u732e\u7684\u8be2\u95ee\u5fc5\u987b\u6ee1\u8db33\u4e2a\u6761\u4ef6\n\n1.$pre_{i}<A$\n\n2.\u5de6\u7aef\u70b9\u5728$(pre_{i},A]$\u4e4b\u95f4\n\n3.\u53f3\u7aef\u70b9\u5728$[i,B]$\u4e4b\u95f4\n\n\u6240\u4ee5\u8fd9\u6837\u7684\u8be2\u95ee\u4e00\u5171\u6709$(A-pre_{i})(B-i+1)$\u79cd\n\n\u62c6\u4e00\u4e0b\u5f0f\u5b50\u5c31\u662f\u70b9i\u7684\u8d21\u732e\u662f$[pre_{i}<A](A(B+1)-pre_{i}(B+1)-Ai+ipre_{i})$\n\n#### case2:i\u5728[1,A]\u4e4b\u95f4\n\n##### case 2.1:\u5de6\u7aef\u70b9\u662fx\n\n\u6b64\u65f6\u6211\u4eec\u53d1\u73b0i\u4ea7\u751f\u4e86\u8d21\u732e\u7684\u8be2\u95ee\u5fc5\u987b\u6ee1\u8db3\u4e24\u4e2a\u6761\u4ef6\n\n1.\u5de6\u7aef\u70b9\u5728$(pre_{i},i)$\u4e4b\u95f4\n\n2.\u53f3\u7aef\u70b9\u5728$[i,B]$\u4e4b\u95f4\n\n\u6240\u4ee5\u8fd9\u6837\u7684\u8be2\u95ee\u6709$(i-pre_{i})(B-i+1)$\u79cd\n\n##### case 2.2:\u5de6\u7aef\u70b9\u662fy\n\n\u6b64\u65f6\u6211\u4eec\u53d1\u73b0i\u4ea7\u751f\u4e86\u8d21\u732e\u7684\u8be2\u95ee\u5fc5\u987b\u6ee1\u8db3\u4e24\u4e2a\u6761\u4ef6\n\n1.\u5de6\u7aef\u70b9\u5728$(pre_{i},i)$\u4e4b\u95f4\n\n2.\u5de6\u7aef\u70b9\u5728$[i,A]$\u4e4b\u95f4\n\n\u6240\u4ee5\u8fd9\u6837\u7684\u8be2\u95ee\u4e00\u5171\u6709$(i-pre_{i})(B-i+1)$\u79cd\n\n\u90a3\u4e48\u6211\u4eec\u628a\u4e24\u4e2a\u70b9\u7684\u8d21\u732e\u52a0\u8d77\u6765\u70b9i\u7684\u8d21\u732e\u5c31\u662f\n\n$(i-pre_{i})(A+B)+(i-pre_{i})(-2i+2)-1$\u51cf1\u662f\u4e3a\u4e86\u907f\u514d\u91cd\u590d\u8ba1\u7b97$(i,i)$\u8fd9\u4e2a\u8be2\u95ee\n\n\u90a3\u4e48\u6211\u4eec\u53d1\u73b0case2\u7684\u8d21\u732e\u53ef\u4ee5\u8f7b\u6613\u7684\u4f7f\u7528\u524d\u7f00\u548cO(1)\u7684\u8fdb\u884c\u7ef4\u62a4\n\n\u800ccase1\u7684\u8d21\u732e\u53ef\u4ee5\u4f7f\u7528\u4e3b\u5e2d\u6811\u7ef4\u62a4$(1,i,pre_{i},ipre_{i})$\u7684\u548c\u6765\u8fdb\u884c\u7ef4\u62a4\n\n\u90a3\u4e48\u6211\u4eec\u7684\u64cd\u4f5c2\u5c31\u89e3\u51b3\u5566~\n\n_____________________\n\n## \u5e8f\u5217\u4e0a\u6811\n\n### \u64cd\u4f5c1\n\n\u6211\u4eec\u53d1\u73b0\u4e00\u4e2a\u975e\u5e38\u795e\u5947\u7684\u6027\u8d28\uff0c\u8fd9\u68f5\u6811\u4efb\u610f\u4e24\u70b9\u95f4\u7684\u8def\u5f84\uff0c\u4ed6\u4eec\u7684lca\u603b\u662f\u79bb\u4e00\u4e2a\u70b9\u7279\u522b\u8fd1\uff0c\u8fd1\u5230\u4e86$O(logn)$\u7684\u7ea7\u522b\n\n\u5047\u8bbe\u6211\u4eec\u5904\u7406\u4e00\u4e2a$(x,y)$\u7684\u8be2\u95ee(\u5047\u8bbelca\u79bbx\u66f4\u8fd1)\uff0c\u90a3\u4e48\u6211\u4eec\u5148\u5efa\u4e00\u4e2a\u6811\u5f62\u4e3b\u5e2d\u6811\uff0c\u7136\u540e\u8fd9\u6837\u5c31\u53ef\u4ee5\u5feb\u901f\u67e5\u51fa(lca,y)\u7684\u989c\u8272\u79cd\u7c7b\u6570\uff0c\u8fd9\u91cc\u7684pre\u4f60\u53ef\u4ee5\u6bcf\u79cd\u989c\u8272\u5f00\u4e00\u4e2a\u6808\u5728dfs\u7684\u65f6\u5019\u987a\u624b\u7ef4\u62a4\u4e00\u4e0b\n\n\u6b64\u65f6\u6211\u4eec\u679a\u4e3e(x,lca)\u8def\u5f84\u4e0a\u7684\u70b9\uff0c\u67e5\u8be2\u8fd9\u79cd\u989c\u8272\u662f\u5426\u5728(lca\u5230y)\u4e0a\u51fa\u73b0\u8fc7\n\n\u95ee\u9898\u6765\u4e86\u600e\u4e48\u67e5\u8be2\uff1f\n\n\u4f60\u5f53\u7136\u53ef\u4ee5\u628a\u8fd9\u95ee\u9898\u8f6c\u5316\u4e3a\u4e00\u4e2a\u67e5\u8be2\u533a\u95f4\u91cc\u67d0\u79cd\u989c\u8272\u51fa\u73b0\u591a\u5c11\u6b21\uff0c\u7136\u540e\u6811\u5f62\u4e3b\u5e2d\u6811\u5927\u529b\u7ef4\u62a4\u5373\u53ef\n\n\u53ef\u662f\u6211\u4eec\u7684\u64cd\u4f5c2\u8fd8\u9700\u8981\u4e00\u4e9b\u5947\u5947\u602a\u602a\u7684\u4fe1\u606f\u6765\u7ef4\u62a4\uff0c\u56e0\u6b64\u6211\u4eec\u8003\u8651\u53e6\u4e00\u79cd\u65b9\u6cd5\u6765\u8fdb\u884c\u67e5\u8be2\u5de5\u4f5c\n\n\u6211\u4eec\u5efa\u4e00\u4e2a\u6811\u5f62\u7684\u53ef\u6301\u4e45\u5316\u6570\u7ec4(\u5176\u5b9e\u8fd8\u662f\u4e3b\u5e2d\u6811)\uff0c\u6bcf\u7ecf\u8fc7\u4e00\u4e2a\u70b9i\uff0c\u8fdb\u884c\u4e00\u4e2a\u8d4b\u503c\u64cd\u4f5c\uff0c\u5c06\u4e0b\u6807\u4e3a$a_{i}$\u7684\u4f4d\u7f6e\u8d4b\u503c\u4e3ai\n\n\u90a3\u4e48\u6211\u4eec\u5728\u67d0\u4e00\u4e2a\u70b9x\u7684\u6570\u7ec4\u5386\u53f2\u7248\u672c\u5bf9\u5e94\u7684\u5c31\u662fx\u52301\u8def\u5f84\u4e0a\u67d0\u4e2a\u989c\u8272\u6700\u540e\u4e00\u6b21\u51fa\u73b0\u7684\u70b9\u7684\u7f16\u53f7\n\n\u90a3\u4e48\u6211\u4eec\u67e5\u8be2(lca,y)\u8def\u5f84\u4e0a\u662f\u5426\u51fa\u73b0\u4e86\u67d0\u79cd\u989c\u8272x\u5176\u5b9e\u5c31\u662f\u67e5\u8be2y\u8fd9\u4e2a\u5386\u53f2\u7248\u672c\u7684\u6570\u7ec4\u7684\u7b2cx\u9879\u7684\u6df1\u5ea6\u662f\u5426\u5927\u4e8e\u7b49\u4e8elca\u7684\u6df1\u5ea6\uff0c\u5982\u679c\u5927\u4e8e\u7b49\u4e8e\u7684\u8bdd\u8bc1\u660e\u989c\u8272x\u6700\u540e\u4e00\u6b21\u51fa\u73b0\u7684\u4f4d\u7f6e\u5728\u94fe\u4e0a\uff0c\u56e0\u6b64x\u5c31\u5728\u8def\u5f84\u91cc\u51fa\u73b0\u4e86\n\n\u8fd9\u6837\u7684\u8bdd\u6211\u4eec\u53ef\u4ee5$O(log^2n)$\u7684\u89e3\u51b3\u64cd\u4f5c1\n\n### \u64cd\u4f5c2\n\n\u6211\u4eec\u5148\u5904\u7406\u76f4\u8def\u5f84\u7684\u90e8\u5206\uff0c\u56e0\u4e3a\u8fd9\u4e00\u90e8\u5206\u53ef\u4ee5\u76f4\u63a5\u5957\u7528\u5e8f\u5217\u95ee\u9898\u7684\u4ee3\u7801\uff0c\u53ea\u662f\u9700\u8981\u628a\u5e8f\u5217\u7684\u666e\u901a\u4e3b\u5e2d\u6811\u6539\u6210\u6811\u4e0a\u4e3b\u5e2d\u6811\uff0c\u53ef\u80fd\u9700\u8981\u6ce8\u610f\u7684\u4e00\u70b9\u662f\uff0c\u4e3b\u5e2d\u6811\u4e2d\u7684\u4e0b\u6807\u5e94\u8be5\u662f\u6df1\u5ea6\n\n\u6240\u4ee5\u6211\u4eec\u5148\u8ba1\u7b97\u8fd93\u90e8\u5206\u64cd\u4f5c2\u7684\u7b54\u6848\n\n1.x\u5728(1,lca),y\u5728(1,B)\n\n2.y\u5728(1,lca),x\u5728(1,A)\n\n3.\u7136\u540e\u53d1\u73b0 (1,lca) ,(1,lca)\u7684\u8def\u5f84\u88ab\u91cd\u590d\u8ba1\u6570\u4e86\uff0c\u56e0\u6b64\u51cf\u53bb\u8fd9\u4e00\u90e8\u5206\u7684\u7b54\u6848\n\n\u4e0a\u8ff03\u90e8\u5206\u5168\u90e8\u53ef\u4ee5\u76f4\u63a5\u5957\u7528\u5e8f\u5217\u95ee\u9898\u7684\u4ee3\u7801\uff0c\u4e0d\u518d\u8d58\u8ff0\n\n\u597d\u4e86\u4e0b\u9762\u6211\u4eec\u8981\u8003\u8651 x\u5728(lca,A],y\u5728(lca,B]\u7684\u90e8\u5206\u4e86\n\n\u6211\u4eec\u8fd8\u662f\u7ee7\u7eed\u7edf\u8ba1\u8d21\u732e\n\n\u9996\u5148\u5148\u7279\u5224\u6389lca\u7684\u8d21\u732e\uff0c\u56e0\u4e3a\u6211\u4eec\u7684x\u548cy\u90fd\u4e0d\u80fd\u53d6\u5230lca\u4f46\u662flca\u4e00\u5b9a\u51fa\u73b0\u5728\u8fd9\u90e8\u5206\u8def\u5f84\u4e0a\n\n\u663e\u7136lca\u4e00\u5b9a\u4f1a\u88ab\u6570\u5230\u6240\u4ee5lca\u7684\u8d21\u732e\u662f$(dep_{A}-dep_{lca})(dep_{B}-dep_{lca})$\n\n\u7136\u540e\u6211\u4eec\u8003\u8651\u4f60\u5728\u64cd\u4f5c1\u7684\u65f6\u5019\u662f\u5982\u4f55\u5904\u7406\u8fd9\u79cd\u5f2f\u7684\u8def\u5f84\u7684\n\n\u663e\u7136\u662f\u5148\u67e5\u4e86\u4e00\u4e2a\u957f\u94fe\u7136\u540e\u5411\u957f\u94fe\u91cc\u66b4\u529b\u63d2\u70b9\u5bf9\u5427\n\n\u6240\u4ee5\u4e24\u79cd\u70b9\u7684\u8d21\u732e\u65b9\u5f0f\u5b8c\u5168\u4e0d\u540c\uff0c\u5206\u60c5\u51b5\u8003\u8651\u4e00\u4e0b\u8d21\u732e\n\n### case 1:\u957f\u94fe\u4e2d\u70b9\u7684\u8d21\u732e\n\n\u90a3\u4e48\u6211\u4eec\u5728\u957f\u94fe\u4e0a\u8dd1\u7684\u662f\u666e\u901a\u7684\u533a\u95f4\u6570\u989c\u8272\n\n\u65e0\u8bba\u5982\u4f55y\u7684\u4e2a\u6570\u90fd\u662f$(dep_{B}-dep_{lca})$\u4e2a\n\n\u65e0\u8bba\u5982\u4f55x\u7684\u4e2a\u6570\u90fd\u662f$(dep{A}-dep_{i}+1)$\u4e2a\n\n\u53ea\u9700\u8981\u8003\u8651\u8fd9\u4e2a\u70b9\u5230\u5e95\u662f\u4e0d\u662f\u94fe\u4e0a\u7684\u7b2c\u4e00\u4e2a\u989c\u8272\u70b9\u5c31\u884c\u4e86\n\n\u6240\u4ee5\u52a0\u4e0a\u4e00\u4e2a\u9650\u5236$dep_{pre_{i}}<dep_{lca}$\n\n\u7136\u540e\u628a\u5e8f\u5217\u4e0a\u7684\u4e3b\u5e2d\u6811\u642c\u8fc7\u6765\u4e4b\u540e\u5c31\u53ef\u4ee5\u5229\u7528\u4e3b\u5e2d\u6811\u67e5\u8d21\u732e\u5c55\u5f00\u5f0f\u7684\u5404\u79cd\u9879\u76f8\u52a0\u5c31\u597d\u4e86\n\n### case2:\u77ed\u94fe\u4e2d\u70b9\u7684\u8d21\u732e\n\n\u5e94\u8be5\u662f\u6700\u96be\u7684\u90e8\u5206\u4e86\n\n\u6211\u4eec\u53d1\u73b0\u64cd\u4f5c1\u4e2d\u6211\u4eec\u76f4\u63a5\u5bf9\u77ed\u94fe\u8fdb\u884c\u66b4\u529b\u4e86\uff0c\u56e0\u6b64\u6211\u4eec\u4ece\u8fd9\u4e2a\u66b4\u529b\u4ec0\u4e48\u65f6\u5019\u4f1a\u8ba9\u7b54\u6848+1\u7684\u89d2\u5ea6\u8003\u8651\u77ed\u94fe\u4e2d\u70b9\u7684\u8d21\u732e\n\n\u9996\u5148\u5982\u679c\u8fd9\u4e2a\u70b9i\u7684pre\u7684\u6df1\u5ea6\u5927\u4e8e\u7b49\u4e8elca\u7684\u6df1\u5ea6\u662f\u4e0d\u4f1a\u4ea7\u751f\u8d21\u732e\u7684\uff0c\u56e0\u4e3a\u65e0\u8bba\u600e\u4e48\u53d6\u4ed6\u90fd\u4e0d\u662f\u7b2c\u4e00\u4e2a\u70b9\n\n\u4e4b\u540e\u6211\u4eec\u8003\u8651\u67e5\u8fd9\u4e2a\u70b9\u7684\u989c\u8272\u662f\u5426\u5728(lca,A)\u4e2d\u51fa\u73b0\u8fc7\uff0c\u5982\u679c\u6ca1\u6709\u51fa\u73b0\u7684\u8bddy\u53ef\u80fd\u7684\u53d6\u503c\u5171\u6709$(dep_{B}-dep_{i}+1)$\u79cd\uff0c\u800c\u6b64\u65f6x\u662f\u53ef\u4ee5\u968f\u4fbf\u53d6\u7684\u56e0\u6b64\u53ef\u80fd\u7684\u53d6\u503c\u5171\u6709$(dep_{A}-dep_{lca})$\u79cd\uff0c\u6240\u4ee5\u8d21\u732e\u5c31\u662f\u4e8c\u8005\u76f8\u4e58\u4e86\n\n\u63a5\u4e0b\u6765\u5982\u679c\u51fa\u73b0\u8fc7\u7684\u8bdd\u6211\u4eec\u662f\u9700\u8981\u627e\u4e00\u4e2a\u8fd9\u6837\u7684\u70b9\uff0c\u4ecelca\u51fa\u53d1\u5411A\u7684\u65b9\u5411\u5f80\u4e0b\u8d70\uff0c\u7b2c\u4e00\u4e2a\u51fa\u73b0\u7684\u548ci\u540c\u8272\u7684\u70b9pr\uff0c\u5982\u679cx\u5728pr\u548clca\u4e4b\u95f4\u7684\u8bdd\u6211\u4eec\u5c31\u8fd8\u662f\u53ef\u4ee5\u66b4\u529b\u63d2\u70b9\u6210\u529f\u7684\n\n\u95ee\u9898\u6765\u4e86\u600e\u4e48\u6c42\u8fd9\u4e2a\u73a9\u610f\uff1f\n\n\u6211\u4eec\u7684\u53ef\u6301\u4e45\u5316\u6570\u7ec4\u53ea\u80fd\u544a\u8bc9\u6211\u4eec\u6bcf\u79cd\u989c\u8272\u6700\u540e\u4e00\u6b21\u51fa\u73b0\u7684\u70b9\u662f\u4ec0\u4e48\uff0c\u4f46\u662f\u6211\u4eec\u5148\u662f\u8981\u6c42\u67d0\u79cd\u989c\u8272\u7b2c\u4e00\u6b21\u51fa\u73b0\u7684\u4f4d\u7f6e\n\n\u8fd8\u8bb0\u5f97\u5417\uff1f\u6bcf\u79cd\u989c\u8272\u7684\u4e2a\u6570\u662f\u671f\u671b$O(1)$\u7684\n\n\u6240\u4ee5\u6211\u4eec\u6c42\u51fa\u8fd9\u4e2a\u989c\u8272\u6700\u540e\u4e00\u6b21\u51fa\u73b0\u7684\u4f4d\u7f6e\u4e4b\u540e\u76f4\u63a5\u987a\u7740\u4ed6\u7684pre\u5f00\u59cb\u8df3\uff0c\u76f4\u5230\u6211\u4eec\u8981\u8df3\u51fa\u4e86lca\u4f4d\u7f6e\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u627e\u5230\u4e86\u8fd9\u4e2a\u989c\u8272\u7b2c\u4e00\u6b21\u51fa\u73b0\u7684\u4f4d\u7f6e\uff0c\u671f\u671b\u8fdb\u884cO(1)\u6b21\u8df3\u8dc3\n\n\u90a3\u4e48\u6b64\u65f6\u70b9y\u53ef\u80fd\u7684\u53d6\u503c\u8fd8\u662f\u6709$dep_{B}-dep_{i}+1$\u4e2d\uff0c\u800cx\u53ef\u80fd\u51fa\u73b0\u7684\u53d6\u503c\u6709$(dep_{pr}-dep_{lca}-1)$\u79cd\uff0c\u70b9i\u7684\u8d21\u732e\u5c31\u662f\u662f\u4e8c\u8005\u76f8\u4e58\u4e86\n\n\u5206\u6790\u4e0b\u590d\u6742\u5ea6\u4f1a\u53d1\u73b0\u590d\u6742\u5ea6\u662f\u671f\u671b$O(log^2n)$\u7684\n\n\u8fd9\u6837\u6211\u4eec\u6210\u529f\u89e3\u51b3\u4e86\u64cd\u4f5c2\u5c31\u53ef\u4ee5\u5199\u8fd9\u9053\u9898\u4e86\n\n_____________________\n\n\u5f53\u7136\u4e0d\u7528\u6211\u591a\u8bf4\u4e5f\u77e5\u9053\u8fd9\u9053\u9898\u6709\u591a\u96be\u5199\u4e86\u5427\u2026\u2026(\u7136\u800c\u8dd1\u7684\u98de\u8d77\uff0c\u6240\u6709\u70b9\u90fd\u57282s\u5185\u8dd1\u5b8c\u4e86)\n\n\u5982\u679c\u80e1\u5199\u4e71\u5199\u57fa\u672c\u8c03\u8bd5\u4e0d\u51fa\u6765\uff0c\u8bf7\u6ce8\u610f\u4ee3\u7801\u98ce\u683c\n\n\u5f53\u7136\u8fd9\u91cc\u7684\u4ee3\u7801\u57fa\u672c\u5c31\u4e0d\u80fd\u770b\u4e86\uff0c\u4ec5\u4f9b\u53c2\u8003\n\n\u4e0a\u4ee3\u7801~\n\n```C\n// luogu-judger-enable-o2\n#include<cstdio>\n#include<algorithm>\n#include<stack>\nusing namespace std;const int N=1e5+10;const int E=20*N;typedef long long ll;typedef unsigned int uit;\nint n;int m;int p;int v[2*N];int x[2*N];int ct;int al[N];int pre[N];int dep[N];int a[N];bool book[N];\nstack <int> s[N];int fa[N];int T;\nstruct data//\u4e3b\u5e2d\u6811\u5f3a\u884c\u7ef4\u62a4\u4fe1\u606f\n{\n    int v0;ll v1;ll v2;ll v3;data(int a=0,ll b=0,ll c=0,ll d=0){v0=a;v1=b;v2=c;v3=d;}\n    friend data operator +(data a,data b){return data(a.v0+b.v0,a.v1+b.v1,a.v2+b.v2,a.v3+b.v3);}\n    friend data operator -(data a,data b){return data(a.v0-b.v0,a.v1-b.v1,a.v2-b.v2,a.v3-b.v3);}\n};\nstruct answ//\u6811\u4e0a\u524d\u7f00\u548c\n{\n    ll v1;ll v2;answ(ll a=0,ll b=0){v1=a;v2=b;}\n    friend answ operator +(answ a,answ b){return answ(a.v1+b.v1,a.v2+b.v2);}\n    friend answ operator -(answ a,answ b){return answ(a.v1-b.v1,a.v2-b.v2);}\n}val[N];\nstruct per_linetree//\u4e3b\u5e2d\u6811\u7684\u677f\u5b50\n{\n    data v[E];int s[E][2];int root[N];int ct;\n    inline void modify(int p1,int p2,int l,int r,const int& pos,const data& pl)\n    {\n        v[p2]=v[p1]+pl;if(r-l==1){s[p2][0]=0;s[p2][1]=0;return;}int mid=(l+r)/2;\n        if(pos<=mid){s[p2][1]=s[p1][1];modify(s[p1][0],s[p2][0]=++ct,l,mid,pos,pl);}\n        else {s[p2][0]=s[p1][0];modify(s[p1][1],s[p2][1]=++ct,mid,r,pos,pl);}\n    }\n    inline data query(int p,int l,int r,int dl,int dr)\n    {\n        if(p==0||dl==l&&dr==r){return v[p];}int mid=(l+r)/2;data ret;\n        if(dl<mid)ret=ret+query(s[p][0],l,mid,dl,min(dr,mid));\n        if(mid<dr)ret=ret+query(s[p][1],mid,r,max(dl,mid),dr);return ret;\n    }\n    inline void cmodify(int p1,int p2,int pos,const data& pl)\n    {modify(root[p1],root[p2]=++ct,0,n+1,pos+1,pl);}\n    inline data cquery(int p1,int p2,int l,int r)\n    {return query(root[p2],0,n+1,l+1,r+1)-query(root[p1],0,n+1,l+1,r+1);}\n    inline void clear(){ct=1;}\n}plt;\nstruct per_array//\u53ef\u6301\u4e45\u5316\u6570\u7ec4\uff0c\u8fd8\u662f\u4e3b\u5e2d\u6811\u7684\u677f\u5b50\n{\n    int v[E];int s[E][2];int root[N];int ct;\n    inline void modify(int p1,int p2,int l,int r,const int& pos,const int & pl)\n    {\n        v[p2]=pl;if(r-l==1){s[p2][0]=0;s[p2][1]=0;return;}int mid=(l+r)/2;\n        if(pos<=mid){s[p2][1]=s[p1][1];modify(s[p1][0],s[p2][0]=++ct,l,mid,pos,pl);}\n        else {s[p2][0]=s[p1][0];modify(s[p1][1],s[p2][1]=++ct,mid,r,pos,pl);}\n    }\n    inline int query(int p,int l,int r,int pos)\n    {\n        if(p==0||r-l==1){return v[p];}int mid=(l+r)/2;\n        if(pos<=mid){return query(s[p][0],l,mid,pos);}\n        else {return query(s[p][1],mid,r,pos);}\n    }\n    inline void cmodify(int p1,int p2,const int& pos,const int& pl)\n    {modify(root[p1],root[p2]=++ct,0,n+1,pos+1,pl);}\n    inline int cquery(int p,int pos){return query(root[p],0,n+1,pos+1);}\n    inline void clear(){ct=1;}\n}pa;\ninline void add(int u,int V){v[++ct]=V;x[ct]=al[u];al[u]=ct;}\ninline void dfs(int u,int f)//dfs\u5efa\u6811\u5f62\u4e3b\u5e2d\u6811\uff0c\u987a\u624b\u5904\u7406\u51fapre\u548c\u6811\u4e0a\u524d\u7f00\u548c\n{\n    pre[u]=s[a[u]].empty()?0:s[a[u]].top();s[a[u]].push(u);int dp=dep[pre[u]];\n    plt.cmodify(f,u,dp,data(1,dep[u],dp,(ll)dp*dep[u]));\n    pa.cmodify(f,u,a[u],u);fa[u]=f;\n    val[u]=val[f]+answ(dep[u]-dp,(ll)(dep[u]-dp)*(-2*dep[u]+2)-1);\n    for(int i=al[u];i;i=x[i]){dep[v[i]]=dep[u]+1;dfs(v[i],u);}\n    s[a[u]].pop();\n}\ninline int query1(int u,int v)\n{\n    if(dep[u]>dep[v])swap(u,v);int lc=u;int lc1=v;//\u66b4\u529b\u627elca\n    for(;lc1>p;lc1=fa[lc1])book[lc1]=true;\n    for(;lc>p;lc=fa[lc])if(book[lc])goto ed1;\n    lc=(dep[lc]<dep[lc1])?lc:lc1;ed1:;\n    for(int x=v;x>p;x=fa[x])book[x]=false;\n    int ans=plt.cquery(fa[lc],v,-1,dep[lc]-1).v0;//\u63d0\u53d6\u957f\u94fe\u4fe1\u606f\n    for(int x=u;x!=lc;x=fa[x])\n        if(dep[pre[x]]<dep[lc]&&dep[pa.cquery(v,a[x])]<dep[lc])ans++;//\u66b4\u529b\u63d2\u5165\u77ed\u94fe\n    return ans;\n}\ninline ll subquery(int l,int r)//\u64cd\u4f5c2\u7684\u5e8f\u5217\u95ee\u9898\n{\n    ll L=dep[l];ll R=dep[r];data ret=(l!=r)?plt.cquery(l,r,-1,dep[l]):data();//\u65e0\u8111\u8003\u8651\u8d21\u732e\u5373\u53ef\n    return val[l].v1*(L+R)+val[l].v2+ret.v0*L*(R+1)-L*ret.v1-(R+1)*ret.v2+ret.v3;\n}\ninline ll query2(int u,int v)//\u64cd\u4f5c2\n{\n    if(dep[u]>dep[v])swap(u,v);int lc=u;int lc1=v;//\u8fd8\u662f\u66b4\u529b\u627elca\n    for(;lc1>p;lc1=fa[lc1])book[lc1]=true;\n    for(;lc>p;lc=fa[lc])if(book[lc])goto ed1;\n    lc=(dep[lc]<dep[lc1])?lc:lc1;ed1:;\n    for(int x=v;x>p;x=fa[x])book[x]=false;\n    ll ret=subquery(lc,v)+subquery(lc,u)-subquery(lc,lc);//\u5904\u7406\u76f4\u8def\u5f84\n    if(lc==u)return ret;data tr=plt.cquery(lc,v,-1,dep[lc]-1);//\u5f2f\u8def\u5f84\u7684\u957f\u94fe\u8d21\u732e,\u4e3b\u5e2d\u6811\u67e5\u4e00\u53d1\u5373\u53ef\n    ret+=(dep[u]-dep[lc])*((ll)tr.v0*(dep[v]+1)-tr.v1)+(ll)(dep[v]-dep[lc])*(dep[u]-dep[lc]);//\u8bb0\u5f97\u52a0\u4e0alca\n    for(int x=u;x!=lc;x=fa[x])\n    {\n        if(dep[pre[x]]>=dep[lc]){continue;}//\u5982\u679c\u6570\u4e0d\u5230\u8fd9\u4e2a\u70b9\u5c31\u8df3\u8fc7\n        int pr=pa.cquery(v,a[x]);\n        if(dep[pr]<dep[lc]){ret+=(ll)(dep[v]-dep[lc])*(dep[u]-dep[x]+1);continue;}//\u5982\u679c\u4e00\u5b9a\u53ef\u4ee5\u63d2\u5165\u6210\u529f\u5c31\u76f4\u63a5\u7b97\u8d21\u732e\n        for(;dep[pre[pr]]>=dep[lc];pr=pre[pr]);if(dep[pr]==dep[lc])continue;//\u8df3pre\u627e\u7b2c\u4e00\u6b21\u51fa\u73b0\u7684\u70b9\n        ret+=(ll)(dep[pr]-dep[lc]-1)*(dep[u]-dep[x]+1);//\u8ba1\u7b97\u8d21\u732e\n    }return ret;\n}\nnamespace Maker//\u751f\u6210\u5668\u4ee3\u7801,\u76f4\u63a5\u7c98\u5c31\u884c\u4e86\n{\n    uit SA,SB,SC;\n    uit rng61(){SA^=SA<<16;SA^=SA>>5;SA^=SA<<1;uit t=SA;SA=SB;SB=SC;SC^=t^SA;return SC;}\n    void gen()\n    {\n    \tscanf(\"%d%d%u%u%u\",&n,&p,&SA,&SB,&SC);\n    \tfor(int i=2;i<=p;i++)add(i-1,i);\n    \tfor(int i=p+1;i<=n;i++)add(rng61()%(i-1)+1,i);\n    \tfor(int i=1;i<=n;i++)a[i]=rng61()%n+1;\n    }\n}\ninline void solve()\n{\n    Maker::gen();scanf(\"%d\",&m);dep[1]=1;dfs(1,0);\n    for(int i=1,t,l,r;i<=m;i++)\n    {scanf(\"%d%d%d\",&t,&l,&r);printf(\"%lld\\n\",(t==1)?query1(l,r):query2(l,r));}\n}\ninline void clear(){plt.clear();pa.clear();for(int i=1;i<=n;i++)al[i]=0;ct=0;}\nint main(){scanf(\"%d\",&T);for(int z=1;z<=T;z++){solve();clear();}return 0;}//\u62dc\u62dc\u7a0b\u5e8f~\n```\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",
        "postTime": 1528005962,
        "uid": 56384,
        "name": "shadowice1984",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P4618 \u3010[SDOI2018]\u539f\u9898\u8bc6\u522b\u3011"
    },
    {
        "content": "## P4618 \u9898\u89e3\n\n\u4e00\u9053\u5bf9\u7b14\u8005\u672c\u4eba\u6765\u8bf4\u8f83\u96be\u7684\u6570\u636e\u7ed3\u6784\u9898\u3002\n\n\u7ed9\u4e00\u4e2a\u6bd4\u8f83\u597d\u5199\u7684\u9633\u95f4\u505a\u6cd5\uff0c\u5982\u6709\u9519\u8bef\u6216\u7b14\u8bef\u656c\u8bf7\u6307\u51fa\uff0c\u7b14\u8005\u5c06\u4e0d\u80dc\u611f\u6fc0\u3002\n\n**\u9898\u610f**\uff1a\n\n\u7ed9\u4e00\u68f5\u8282\u70b9\u4e0a\u6709\u989c\u8272\u7684\u6709\u6839\u6811\uff0c\u8981\u6c42\u652f\u6301\u4e24\u79cd\u8be2\u95ee\uff0c\u5206\u522b\u662f\u7ed9 $u,v$\uff0c\u6c42 $u,v$ \u95f4\u8def\u5f84\u7684\u989c\u8272\u6570 $f(u,v)$\uff0c\n\n\u548c\u7ed9 $A,B$\uff0c\u6c42 $\\sum\\limits_{u\\in S(A)}\\sum\\limits_{v\\in S(B)}f(u,v)$\uff0c\u5176\u4e2d $S(A)$ \u662f\u70b9 $A$ \u5230\u6839\u7684\u8def\u5f84\u4e0a\u7684\u6240\u6709\u70b9\u5f62\u6210\u7684\u70b9\u96c6\u3002\n\n\u4fdd\u8bc1\u6811\u7684\u5f62\u6001\uff0c\u662f\u4e00\u6761\u957f\u94fe\u52a0\u82e5\u5e72\u4e2a\u6df1\u5ea6\u4e0d\u8d85\u8fc7 $\\log n$ \u7684\u5b50\u6811\u63a5\u5728\u94fe\u4e0a\uff0c\u4fdd\u8bc1\u989c\u8272\u968f\u673a\u3002\n\n**\u505a\u6cd5**\uff1a\n\n\u6211\u4eec\u5bf9\u6811\u8fdb\u884c `dfs`\uff0c\u5e76\u540c\u65f6\u7ef4\u62a4\u4e00\u4e2a\u65f6\u523b $t$\uff0c\u6bcf\u5f53\u7b2c\u4e00\u6b21\u8bbf\u95ee\u67d0\u4e2a\u8282\u70b9\uff0c\u6216\u4e00\u4e2a\u8282\u70b9\u5bf9\u5e94\u5b50\u6811\u7684\u8bbf\u95ee\u7ed3\u675f\u540e\uff0c\n\n\u90fd\u5c06\u65f6\u523b\u52a0\u4e00\uff0c\u5e76\u8bb0\u5f55\uff1a\u6bcf\u4e2a\u8282\u70b9\u88ab\u7b2c\u4e00\u6b21\u8bbf\u95ee\u65f6\u7684\u65f6\u523b\uff0c\u4ee5\u53ca\u6bcf\u4e2a\u8282\u70b9\u5bf9\u5e94\u5b50\u6811\u7684\u8bbf\u95ee\u5b8c\u5168\u7ed3\u675f\u540e\u7684\u65f6\u523b\u3002\n\n\u8bb0\u8282\u70b9 $u$ \u88ab\u7b2c\u4e00\u6b21\u8bbf\u95ee\u65f6\u7684\u65f6\u523b\u662f $st_u$\uff0c\u5176\u5b50\u6811\u5185\u6240\u6709\u8282\u70b9\u90fd\u8bbf\u95ee\u540e\u65f6\u523b\u4e3a $en_u$\u3002\n\n\u540c\u65f6\uff0c\u4e3a\u4e86\u65b9\u4fbf\u4e0b\u6587\u63cf\u8ff0\uff0c\u6211\u4eec\u79f0 $st_u$ \u4e3a $u$ \u7684\u5165\u6808\u65f6\u523b\uff0c\u79f0 $en_u$ \u4e3a $u$ \u7684\u51fa\u6808\u65f6\u523b\u3002\n\n\u90a3\u8003\u8651\u4ee5\u6574\u68f5\u6811\u7684\u8bbf\u95ee\u65f6\u523b\u4e3a\u4e0b\u6807\uff0c\u5199\u51fa\u4e00\u4e2a $2n\\times 2n$ \u7684\u77e9\u9635 $W$\uff0c\u8fd9\u4e2a\u77e9\u9635\u7684\u6bcf\u4e2a\u70b9\u7684\u6743\u5bf9\u5e94\u4e00\u6761\u8def\u5f84\u7684\u7b54\u6848\u3002\n\n\u5176\u4e2d\uff0c\u5bf9\u4e8e\u6bcf\u5bf9\u70b9 $(u,v)$\uff0c\u8bb0 $(u,v)$ \u8def\u5f84\u4e0a\u7684\u989c\u8272\u6570\u4e3a $f(u,v)$\uff0c\u5219\u5728\u77e9\u9635\u4e0a\u6709 $4$ \u4e2a\u70b9\u7684\u6743\u503c\u4e0e\u4e4b\u5bf9\u5e94\uff0c\u5206\u522b\u662f\uff1a\n\n$W_{st_u,st_v}=W_{en_u,en_v}=f(u,v),W_{st_u,en_v}=W_{en_u,st_v}=-f(u,v)$\uff0c\u5176\u4e2d $W_{x,y}$ \u662f\u77e9\u9635 $W$ \u4e2d\u70b9 $(x,y)$ \u7684\u6743\u503c\u3002\n\n\u8003\u8651\u6784\u5efa\u77e9\u9635 $W$ \u7684\u597d\u5904\uff0c\u5373\u5bf9\u4e8e\u8be2\u95ee $X(A,B)=\\sum\\limits_{u\\in S(A)}\\sum\\limits_{v\\in S(B)}f(u,v)$ \u7684\u503c\uff0c\u5176\u7b54\u6848\u53ef\u4ee5\u5728\u77e9\u9635\u4e0a\u627e\u5230\uff0c\n\n\u5177\u4f53\u7684\uff0c$X(A,B)$ \u7684\u503c\u4e00\u5b9a\u7b49\u4e8e $\\sum\\limits_{1\\le i\\le st_A}\\sum\\limits_{1\\le j\\le st_B}W_{i,j}$\uff0c\u6211\u4eec\u53ef\u4ee5\u5229\u7528 $st$ \u548c $en$ \u7684\u6027\u8d28\u6765\u8bc1\u660e\u8fd9\u4e00\u70b9\uff0c\u5373\uff1a\n\n\u8003\u8651\u5bf9\u4e8e\u4efb\u610f\u4e00\u70b9 $u$\uff0c\u4e0d\u96be\u8bc1\u660e\uff1a\u70b9 $v\\in S(u)$ \u7b49\u4ef7\u4e8e $st_v<st_u<en_v$\uff0c\u90a3\u4e48\u8003\u8651\u8be2\u95ee $X(A,B)$\uff0c\n\n\u6211\u4eec\u8003\u8651\u8bc1\u660e\uff0c\u6240\u6709 $f(u,v)$ \u5bf9 $X(A,B)$ \u7684\u8d21\u732e\u548c\u5176\u5bf9 $\\sum\\limits_{1\\le i\\le st_A}\\sum\\limits_{1\\le j\\le st_B}W_{i,j}$ \u7684\u8d21\u732e\u662f\u4e00\u81f4\u7684\uff0c\n\n\u4ece\u800c\u8bc1\u660e $X(A,B)=\\sum\\limits_{1\\le i\\le st_A}\\sum\\limits_{1\\le j\\le st_B}W_{i,j}$\u3002\u4ee5\u4e0b\u5c06\u4f1a\u628a $f(u,v)$ \u5206\u6210\u56db\u79cd\u60c5\u51b5\u8ba8\u8bba\u3002\n\n\u7b2c\u4e00\u79cd\u662f $u\\in S(A),v\\in S(B)$\uff0c\u663e\u7136\u6b64\u65f6 $f(u,v)$ \u7ed9 $X(A,B)$ \u63d0\u4f9b\u4e86\u6070 $1$ \u6b21\u8d21\u732e\uff0c\n\n\u800c\u7531\u6761\u4ef6\u53ef\u5f97 $st_u<st_A<en_u,st_v<st_B<en_v$\uff0c\n\n\u6545 $f(u,v)$ \u5728 $\\sum\\limits_{1\\le i\\le st_A}\\sum\\limits_{1\\le j\\le st_B}W_{i,j}$ \u4e2d\u6070\u597d\u88ab\u7d2f\u52a0\u4e86\u4e00\u6b21\u3002\n\n\u7b2c\u4e8c\u79cd\u662f $u\\in S(A),v\\notin S(B)$\uff0c\u663e\u7136\u6b64\u65f6 $f(u,v)$ \u4e0d\u4f1a\u7ed9 $X(A,B)$ \u63d0\u4f9b\u8d21\u732e\uff0c\n\n\u800c\u7531\u6761\u4ef6\u53ef\u5f97 $st_u<st_A<en_u$\uff0c\u4ee5\u53ca\uff1a$st_B<st_v$ \u6216 $st_B>en_v$ \u7684\u4e24\u8005\u4e4b\u4e00\u6210\u7acb\uff0c\n\n\u82e5 $st_B<st_v$ \u6210\u7acb\uff0c\u5219 $f(u,v)$ \u5728 $\\sum\\limits_{1\\le i\\le st_A}\\sum\\limits_{1\\le j\\le st_B}W_{i,j}$ \u4e2d\u663e\u7136\u6ca1\u6709\u88ab\u7d2f\u52a0\uff0c\u5373\u8d21\u732e\u4e3a $0$\uff1b\n\n\u82e5 $st_B>en_v$ \u6210\u7acb\uff0c\u5219\u5728 $\\sum\\limits_{1\\le i\\le st_A}\\sum\\limits_{1\\le j\\le st_B}W_{i,j}$ \u4e2d\uff0c\u6709 $W_{st_u,st_v}=f(u,v),W_{st_u,en_v}=-f(u,v)$\uff0c\u603b\u8d21\u732e\u4e5f\u4e3a $0$\u3002\n\n\u7b2c\u4e09\u79cd\u662f $u\\notin S(A),v\\in S(B)$\uff0c\u8fd9\u79cd\u60c5\u51b5\u548c\u7b2c\u4e8c\u79cd\u60c5\u51b5\u7c7b\u4f3c\uff0c\u5c31\u4e0d\u518d\u8d58\u8ff0\uff1b\n\n\u7b2c\u56db\u79cd\u662f $u\\notin S(A),v\\notin S(B)$\uff0c\u663e\u7136\u6b64\u65f6 $f(u,v)$ \u4e0d\u4f1a\u7ed9 $X(A,B)$ \u63d0\u4f9b\u8d21\u732e\uff0c\n\n\u800c\u7531\u6761\u4ef6\u53ef\u5f97\uff0c$st_B<st_u$ \u6216 $st_B>en_u$ \u7684\u4e24\u8005\u4e4b\u4e00\u6210\u7acb\uff0c\u4ee5\u53ca $st_B<st_v$ \u6216 $st_B>en_v$ \u7684\u4e24\u8005\u4e4b\u4e00\u6210\u7acb\uff0c\n\n\u5bf9\u56db\u79cd\u5c0f\u60c5\u51b5\u5206\u522b\u8ba8\u8bba\u4e00\u4e0b\uff0c\u4e5f\u80fd\u8bc1\u660e $f(u,v)$ \u5728 $\\sum\\limits_{1\\le i\\le st_A}\\sum\\limits_{1\\le j\\le st_B}W_{i,j}$ \u4e2d\u7684\u8d21\u732e\u662f\u6b63\u786e\u7684\uff0c\u8fd9\u91cc\u5c31\u4e5f\u4e0d\u8d58\u8ff0\u4e86\u3002\n\n\u7ecf\u8fc7\u4e86\u6f2b\u957f~~\u800c\u6076\u5fc3~~\u7684\u5206\u7c7b\u8ba8\u8bba\uff0c\u6211\u4eec\u8bc1\u660e\u4e86 $X(A,B)=\\sum\\limits_{1\\le i\\le st_A}\\sum\\limits_{1\\le j\\le st_B}W_{i,j}$\uff0c\n\n\u6545\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5feb\u901f\u67e5\u8be2\u77e9\u9635 $W$ \u7684\u4e8c\u7ef4\u524d\u7f00\u548c\uff0c\u6765\u56de\u7b54\u5f62\u5982 $X(A,B)=\\sum\\limits_{u\\in S(A)}\\sum\\limits_{v\\in S(B)}f(u,v)$ \u7684\u8be2\u95ee\u3002\n\n\u4e3a\u4e86\u67e5\u8be2\u524d\u7f00\u548c\uff0c\u6211\u4eec\u8003\u8651\u7ef4\u62a4\u6bcf\u79cd\u989c\u8272\u7684\u70b9\u5bf9 $W$ \u7684\u8d21\u732e\uff0c\u5373\u8003\u8651\u8be5\u989c\u8272\u5bf9 $W$ \u4e2d\u54ea\u4e9b\u4f4d\u7f6e\u7684\u503c\u9020\u6210\u4e86\u5f71\u54cd\u3002\n\n\u6ce8\u610f\uff0c$W_{a,b}$ \u53d7\u989c\u8272 $c$ \u5f71\u54cd\uff0c\u5f53\u4e14\u4ec5\u5f53\uff1a\u5b58\u5728 $x$\uff0c\u6ee1\u8db3\u70b9 $x$ \u7684\u989c\u8272\u4e3a $c$\uff0c\u4e14 $W_{a,b}$ \u53d7\u70b9 $x$ \u5f71\u54cd\uff0c\n\n\u800c $W_{a,b}$ \u53d7\u70b9 $x$ \u5f71\u54cd\uff0c\u5f53\u4e14\u4ec5\u5f53\uff1a\n\n\u5bf9\u4e8e\u6ee1\u8db3 $W_{a,b}=\\pm f(s,t)$ \u7684\u65e0\u5e8f\u70b9\u5bf9 $(s,t)$\uff08\u663e\u7136\u8fd9\u6837\u7684\u70b9\u5bf9\u552f\u4e00\uff09\uff0c\u8def\u5f84 $(s,t)$ \u5305\u542b\u70b9 $x$\u3002\n\n\u8fd9\u6837\u5b9a\u4e49\u7684\u539f\u56e0\u4e5f\u662f\u597d\u7406\u89e3\u7684\uff0c\u5373\u82e5 $W_{a,b}$ \u53d7\u989c\u8272 $c$ \u5f71\u54cd\uff0c\u5219 $W_{a,b}$ \u7684\u6743\u503c\u672c\u8eab\u4e00\u5b9a\u53d7\u5230\u4e86\u989c\u8272 $c$ \u7684\u8d21\u732e\u3002\n\n\u90a3\u4e48\uff0c\u5bf9\u4e8e\u6bcf\u79cd\u989c\u8272 $c$\uff0c\u6211\u4eec\u5e0c\u671b\u80fd\u523b\u753b\u51fa\uff1a$W$ \u4e2d\u6240\u6709\u88ab\u989c\u8272 $c$ \u5f71\u54cd\u7684\u4f4d\u7f6e\u6240\u5171\u6709\u7684\u7279\u5f81\uff0c\n\n\u4ee5\u4fbf\u4e8e\u7ef4\u62a4\u51fa\uff0c\u989c\u8272 $c$ \u7ed9 $W$ \u7684\u6743\u503c\u6240\u5e26\u6765\u7684\u8d21\u732e\u3002\n\n\u56e0\u4e3a\u989c\u8272 $c$ \u7684\u5f71\u54cd\u5373\u4e3a\u6240\u6709\u989c\u8272\u4e3a $c$ \u7684\u70b9\u7684\u5f71\u54cd\u7684\u7d2f\u52a0\uff0c\u6545\u5148\u8003\u8651\u523b\u753b\u51fa $W$ \u4e2d\u6240\u6709\u88ab\u70b9 $x$ \u5f71\u54cd\u7684\u4f4d\u7f6e\u7684\u7279\u5f81\u3002\n\n\u5177\u4f53\u7684\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u70b9 $x$\uff0c\u6211\u4eec\u8003\u8651\u4e00\u4e2a\u6240\u6709\u5305\u542b\u8be5\u70b9\u7684\u8def\u5f84 $(u,v)$ \u6240\u5171\u6709\u7684\u6027\u8d28\uff0c\u5373\uff1a\n\n$u,v$ \u4e2d\u81f3\u5c11\u6709\u4e00\u4e2a\u70b9\u5728 $x$ \u5b50\u6811\u5185\uff0c\u4e14\u5bf9 $x$ \u7684\u6bcf\u4e2a\u513f\u5b50 $y$\uff0c\u90fd\u6ee1\u8db3 $u,v$ \u4e0d\u540c\u65f6\u5728 $y$ \u5b50\u6811\u5185\u3002\n\n\u5bb9\u6613\u53d1\u73b0\uff0c\u8fd9\u4e2a\u6027\u8d28\u8db3\u591f\u5145\u5206\uff0c\u5373\u6ee1\u8db3\u8be5\u7279\u70b9\u7684\u8def\u5f84\u90fd\u5305\u542b\u70b9 $x$\u3002\n\n\u8003\u8651\u7528\u6bcf\u4e2a\u70b9\u7684\u5165\u6808\u65f6\u523b\u548c\u51fa\u6808\u65f6\u523b\u6765\u4e66\u5199\u8fd9\u4e2a\u6027\u8d28\uff0c\u5373\uff1a\n\n1. $st_x<st_u<en_u<en_x$ \u548c $st_x<st_v<en_v<en_x$\uff0c\u4e24\u8005\u4e2d\u81f3\u5c11\u6ee1\u8db3\u4e00\u4e2a\uff1b\n\n2. \u5bf9 $x$ \u7684\u6bcf\u4e2a\u513f\u5b50 $y$\uff0c$st_y<st_u<en_u<en_y$ \u548c $st_y<st_v<en_v<en_y$\uff0c\u4e24\u8005\u6700\u591a\u6ee1\u8db3\u4e00\u4e2a\u3002\n\n\u663e\u7136\uff0c\u8fd9\u4e24\u6761\u9650\u5236\u540c\u65f6\u6ee1\u8db3\uff0c\u4e0e\u8def\u5f84 $(u,v)$ \u5305\u542b\u70b9 $x$ \u7b49\u4ef7\uff0c\u4e5f\u5c31\u4e0e $W_{st_u/en_u,st_v/en_v}$ \u53d7\u70b9 $x$ \u5f71\u54cd\u7b49\u4ef7\uff0c\n\n\u800c\u8fd9\u4e24\u6761\u9650\u5236\u52fe\u52d2\u51fa\u7684\u53d7\u5f71\u54cd\u4f4d\u7f6e\u96c6\uff0c\u5728\u77e9\u9635 $W$ \u4e2d\u6709\u76f4\u89c2\u7684\u8868\u8fbe\u65b9\u5f0f\uff0c\u5373\uff1a\n\n\u7b2c\u4e00\u4e2a\u9650\u5236\uff0c\u5f62\u5982\u5728 $W$ \u4e2d\u6846\u51fa\u4e24\u4e2a\u957f\u65b9\u5f62\uff0c\u5206\u522b\u662f $[1,2n]\\times [st_x,en_x]$ \u548c $[st_x,en_x]\\times[1,2n]$\uff0c\n\n\u8868\u793a\u53d7\u5f71\u54cd\u4f4d\u7f6e\u4e0d\u5728\u8fd9\u4e24\u4e2a\u957f\u65b9\u5f62\u5916\uff0c\u5176\u4e2d $[a,b]\\times[c,d]$\uff0c\u662f\u5de6\u4e0b\u89d2\u4e3a $(a,c)$\uff0c\u53f3\u4e0a\u89d2\u4e3a $(b,d)$ \u7684\u957f\u65b9\u5f62\uff1b\n\n\u7b2c\u4e8c\u4e2a\u9650\u5236\uff0c\u5f62\u5982\u5728 $W$ \u4e2d\u6846\u51fa\u82e5\u5e72\u4e2a\u6b63\u65b9\u5f62\uff0c\u5176\u4e2d\u5bf9 $x$ \u7684\u6bcf\u4e2a\u513f\u5b50 $y$\uff0c\u90fd\u6846\u51fa $[st_y,en_y]\\times[st_y,en_y]$\uff0c\n\n\u8868\u793a\u53d7\u5f71\u54cd\u533a\u57df\u4e0d\u5728\u8fd9\u4e9b\u6b63\u65b9\u5f62\u5185\u3002\u90a3\u4e48\uff0c\u5728\u6392\u9664\u4e86\u8fd9\u4e9b\u4e0d\u5728\u7684\u533a\u57df\u540e\uff0c\u5269\u4e0b\u7684\u6240\u6709\u533a\u57df\u5c31\u662f\u8be5\u70b9\u7684\u5f71\u54cd\u533a\u57df\uff0c\n\n\u800c\u4e00\u4e2a\u989c\u8272\u7684\u5f71\u54cd\u533a\u57df\uff0c\u5c31\u7b49\u4e8e\u6240\u6709\u8be5\u989c\u8272\u7684\u70b9\u7684\u5f71\u54cd\u533a\u57df\u53d6\u5e76\uff0c\n\n\u800c\u6211\u4eec\u73b0\u5728\u9700\u8981\u505a\u7684\uff0c\u5c31\u662f\u7ed9\u8fd9\u4e9b\u5f71\u54cd\u533a\u57df\u7684\u5e76\u533a\u57df\uff0c\u6dfb\u52a0\u4e0a\u5f53\u524d\u989c\u8272\u5e26\u6765\u7684 $1$ \u7684\u8d21\u732e\u3002\n\n\u8003\u8651\u53d6\u5e76\u7684\u9ebb\u70e6\u4e4b\u5904\u5728\u4e8e\uff0c\u67d0\u4e2a\u70b9\u7684\u4e0d\u53ef\u884c\u533a\u57df\u53ef\u80fd\u662f\u53e6\u5916\u4e00\u4e2a\u70b9\u7684\u53ef\u884c\u533a\u57df\uff0c\u8fd9\u5bfc\u81f4\u4e86\u5224\u65ad\u53ef\u884c\u7684\u56f0\u96be\u6027\uff0c\n\n\u4f46\u5b9e\u9645\u4e0a\u6211\u4eec\u53d1\u73b0\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u56fa\u5b9a\u7684\u70b9 $x$ \u548c\u5176\u4efb\u610f\u513f\u5b50 $y$\uff0c\u4ee5\u4e0b\u5173\u7cfb\u6c38\u8fdc\u6210\u7acb\uff1a\n\n$([st_y,en_y]\\times[st_y,en_y])\\subseteq ([1,2n]\\times [st_x,en_x])\\cap([st_x,en_x]\\times[1,2n])$\uff1b\n\n\u540c\u65f6\uff0c\u5bf9 $x$ \u7684\u4e24\u4e2a\u513f\u5b50 $y_1,y_2$\uff0c\u4ee5\u4e0b\u5173\u7cfb\u6c38\u8fdc\u6210\u7acb\uff1a\n\n$[st_{y_1},en_{y_1}]\\times[st_{y_1},en_{y_1}]\\cap[st_{y_1},en_{y_1}]\\times[st_{y_1},en_{y_1}]=\\varnothing$\u3002\n\n\u8fd9\u4e24\u6761\u5173\u7cfb\u5229\u7528 $x,y_1,y_2$ \u5728\u6811\u4e0a\u7684\u5173\u7cfb\u5c31\u4e0d\u96be\u8bc1\u660e\uff0c\u800c\u8fd9\u8bf4\u660e\u4e86\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u70b9\u5f71\u54cd\u533a\u57df\u7684\u4e24\u79cd\u9650\u5236\u4e2d\uff0c\n\n\u7b2c\u4e8c\u79cd\u9650\u5236\u7684\u6240\u6709\u7981\u6b62\u533a\u57df\u4e00\u5b9a\u5728\u7b2c\u4e00\u79cd\u9650\u5236\u7684\u4e24\u4e2a\u5141\u8bb8\u533a\u57df\u7684\u4ea4\u4e4b\u5185\uff0c\u4e14\u4efb\u610f\u4e24\u4e2a\u7b2c\u4e8c\u79cd\u9650\u5236\u7684\u7981\u6b62\u533a\u57df\u65e0\u4ea4\u3002\n\n\u90a3\u4e48\uff0c\u8bb0\u72b6\u6001 $S(x)_{i,j}$ \u4ee3\u8868 $W_{i,j}$ \u662f\u5426\u53d7\u70b9 $x$ \u5f71\u54cd\uff0c\u6211\u4eec\u5bf9\u4e0b\u6807\u5728 $[1,2n]\\times [st_x,en_x]$ \u4e2d\u7684 $S(x)$ \u503c\u5168\u90e8\u52a0\u4e00\uff0c\n\n\u5bf9\u4e0b\u6807\u5728 $[st_x,en_x]\\times[1,2n]$ \u4e2d\u7684 $S(x)$ \u503c\u5168\u90e8\u52a0\u4e00\uff0c\u4ee5\u53ca $x$ \u7684\u6bcf\u4e2a\u513f\u5b50 $y$\uff0c\n\n\u5bf9 $[st_y,en_y]\\times[st_y,en_y]$ \u4e2d\u7684 $S(x)$ \u503c\u5168\u90e8\u51cf\u4e8c\uff0c\u90a3\u4e48 $W_{i,j}$ \u53d7 $x$ \u5f71\u54cd\uff0c\u5f53\u4e14\u4ec5\u5f53\u8fd9\u6837\u64cd\u4f5c\u540e\uff0c$S(x)_{i,j}>0$\u3002\n\n\u4e0a\u9762\u7684\u65ad\u8a00\uff0c\u7528\u6211\u4eec\u53d1\u73b0\u7684\u4e24\u6761\u5173\u7cfb\u5c31\u4e0d\u96be\u8bc1\u660e\uff0c\u4e14\u6211\u4eec\u53d1\u73b0\uff0c\u8fd9\u79cd\u65b9\u6cd5\u5728\u5bf9\u591a\u4e2a\u70b9\u7684\u5f71\u54cd\u53d6\u5e76\u65f6\u4e5f\u540c\u6837\u9002\u7528\uff0c\n\n\u5177\u4f53\u7684\uff0c\u5bf9\u6bcf\u79cd\u989c\u8272 $c$ \u8bb0 $S'(c)_{i,j}=\\sum\\limits_{color(x)=c}S(x)_{i,j}$\uff0c\u5219\u989c\u8272 $c$ \u5bf9 $W_{i,j}$ \u6709\u5f71\u54cd\uff0c\u5f53\u4e14\u4ec5\u5f53 $S'(c)_{i,j}>0$\u3002\n\n\u90a3\u4e48\uff0c\u6211\u4eec\u5c06\u627e $W$ \u4e2d\u6240\u6709\u53d7\u989c\u8272 $c$ \u5f71\u54cd\u7684\u4f4d\u7f6e\uff0c\u8f6c\u5316\u4e3a\u4e86\u627e $S'(c)$ \u4e2d\u6240\u6709\u503c\u5927\u4e8e $0$ \u7684\u4f4d\u7f6e\uff0c\n\n\u4e14 $S'(c)$ \u7684\u6784\u9020\u65b9\u5f0f\u662f\uff0c\u4ece\u7a7a\u77e9\u9635\u5f00\u59cb\uff0c\u5bf9\u82e5\u5e72\u4e2a\u77e9\u5f62\u505a\u533a\u95f4\u52a0 / \u51cf\u64cd\u4f5c\uff0c\n\n\u4e14\u8fd9\u6837\u7684\u533a\u95f4\u52a0 / \u51cf\u64cd\u4f5c\u6b21\u6570\u4e00\u5b9a\u4e0d\u591a\uff0c\u56e0\u4e3a\u6811\u7531\u4e00\u6761\u957f\u94fe\u52a0\u82e5\u5e72\u4e2a\u968f\u673a\u6811\u62fc\u63a5\u800c\u6210\uff0c\u6545\u6bcf\u4e2a\u70b9\u7684\u513f\u5b50\u6570\u8f83\u5c0f\uff0c\n\n\u540c\u65f6\u6bcf\u4e2a\u8282\u70b9\u7684\u989c\u8272\u4e5f\u662f\u968f\u673a\u7684\uff0c\u6545\u540c\u989c\u8272\u7684\u8282\u70b9\u6570\u4e5f\u8f83\u5c0f\uff0c\n\n\u6545\u6211\u4eec\u53ef\u4ee5\u628a\u6240\u6709\u533a\u95f4\u52a0 / \u51cf\u5bf9\u5e94\u77e9\u5f62\u7684\u6a2a\u7eb5\u5750\u6807\u79bb\u6563\u5316\uff0c\u518d\u5bf9\u79bb\u6563\u5316\u540e\u7684 $S'(c)$ \u66b4\u529b\u7684\u7ef4\u62a4\u4fee\u6539\u64cd\u4f5c\uff0c\n\n\u6700\u540e\u679a\u4e3e\u6bcf\u4e2a\u79bb\u6563\u5316\u540e\u7684\u4f4d\u7f6e $S'(c)_{i,j}$\uff0c\u82e5\u5176\u503c\u5927\u4e8e $0$\uff0c\u5219\u5176\u79bb\u6563\u5316\u524d\u5bf9\u5e94\u7684\u77e9\u5f62\u4e2d\u7684\u6240\u6709\u4f4d\u7f6e $(i,j)$\uff0c\n\n\u90fd\u6ee1\u8db3 $W_{i,j}$ \u53d7\u989c\u8272 $c$ \u5f71\u54cd\u3002\n\n\u90a3\u4e48\uff0c\u73b0\u5728\u5269\u4e0b\u7684\u6700\u540e\u4e00\u4e2a\u95ee\u9898\u5c31\u662f\uff0c\u5bf9\u4e8e\u989c\u8272 $c$ \u548c $W$ \u4e2d\u7684\u67d0\u4e2a\u5168\u53d7\u989c\u8272 $c$ \u5f71\u54cd\u7684\u77e9\u5f62\u533a\u57df $[l_1,r_1]\\times[l_2,r_2]$\uff0c\n\n\u6211\u4eec\u5982\u4f55\u5feb\u901f\u4e3a\u8fd9\u4e2a\u77e9\u5f62\u533a\u57df\u4e2d\u7684\u6240\u6709\u503c\uff0c\u6dfb\u52a0\u4e0a\u989c\u8272 $c$ \u5e26\u6765\u7684\u8d21\u732e\uff0c\n\n\u4e14\u5728\u82e5\u5e72\u6b21\u8fd9\u6837\u7684\u64cd\u4f5c\u540e\uff0c\u6211\u4eec\u9700\u8981\u80fd\u5feb\u901f\u67e5\u8be2 $W$ \u7684\u4e8c\u7ef4\u524d\u7f00\u548c\u3002\n\n\u6ce8\u610f\uff0c\u8fd9\u91cc\u7684\u6dfb\u52a0\u8d21\u732e\uff0c\u4e0d\u662f\u6307\u5168\u90e8\u52a0\uff0c\u800c\u662f\u6709\u4e9b\u4f4d\u7f6e\u52a0\uff0c\u6709\u4e9b\u4f4d\u7f6e\u51cf\uff0c\n\n\u539f\u56e0\u662f $W$ \u7684\u5b9a\u4e49\uff0c\u5373\u67d0\u4e9b $W_{i,j}$ \u503c\u7b49\u4e8e $f(u,v)$\uff0c\u800c\u53e6\u5916\u4e00\u4e9b $W_{i,j}$ \u503c\u7b49\u4e8e $-f(u,v)$\uff0c\u5177\u4f53\u5728\u4e0b\u6587\u6709\u63d0\u5230\u3002\n\n\u8fd9\u4e2a\u95ee\u9898\u7684\u96be\u70b9\u5728\u4e8e\uff0c\u5bf9\u4e8e\u53d7\u5f71\u54cd\u533a\u57df $[l_1,r_1]\\times[l_2,r_2]$ \u4e2d\u7684\u6240\u6709\u4f4d\u7f6e\u4e2d\uff0c\u6709\u4e9b\u4f4d\u7f6e\u9700\u8981\u52a0\u4e00\uff0c\u6709\u4e9b\u9700\u8981\u51cf\u4e00\uff0c\n\n\u800c\u4e0d\u662f\u5168\u90e8\u52a0\u6216\u5168\u90e8\u51cf\uff0c\u6240\u4ee5\u76f4\u63a5\u5bf9\u4e00\u4e2a\u77e9\u5f62\u6dfb\u52a0\u8d21\u732e\u662f\u96be\u505a\u7684\uff0c\u4f46\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u6bcf\u6b21\u6dfb\u52a0\u8d21\u732e\u5bf9\u67e5\u8be2\u7684\u5f71\u54cd\u3002\n\n\u5177\u4f53\u7684\uff0c\u7531\u4e8e\u8d21\u732e\u7684\u53ef\u51cf\u6027\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u5bf9\u4e00\u4e2a\u77e9\u5f62\u52a0\u8d21\u732e\uff0c\u8f6c\u5316\u4e3a\u5bf9 $4$ \u4e2a\u524d\u7f00\u77e9\u5f62\u52a0 / \u51cf\u8d21\u732e\uff0c\n\n\u90a3\u4e48\u95ee\u9898\u8f6c\u5316\u4e3a\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u8be2\u95ee\uff0c\u7ef4\u62a4\u6240\u6709\u524d\u7f00\u6dfb\u52a0 $v$\uff08$v$ \u53ef\u4ee5\u4e3a\u8d1f\uff09\u8d21\u732e\u7684\u64cd\u4f5c\uff0c\u5bf9\u8be5\u8be2\u95ee\u7684\u5f71\u54cd\u3002\n\n\u8003\u8651\u5bf9\u4e8e\u4e00\u4e2a\u524d\u7f00\u6dfb\u52a0 $v$ \u8d21\u732e\u7684\u64cd\u4f5c\uff0c\u54ea\u4e9b\u4f4d\u7f6e $(i,j)$ \u7684 $W_{i,j}$ \u7684\u503c\u5b9e\u9645\u4e0a\u9700\u8981\u51cf $v$\uff0c\n\n\u6211\u4eec\u53d1\u73b0\uff0c\u5f53\u4e14\u4ec5\u5f53 $i,j$ \u4e2d\u6070\u6709\u4e00\u4e2a\u6570\uff0c\u5728\u6574\u68f5\u6811\u7684\u8bbf\u95ee\u65f6\u523b\u4e2d\u662f\u67d0\u4e2a\u70b9\u7684\u51fa\u6808\u65f6\u523b\u65f6\uff0c\n\n$W_{i,j}$ \u7684\u503c\u5b9e\u9645\u4e0a\u9700\u8981\u51cf $v$\uff0c\u5176\u4ed6\u7684 $W_{i,j}$ \u7684\u503c\u5b9e\u9645\u4e0a\u90fd\u9700\u8981\u52a0 $v$\u3002\n\n\u4e5f\u5c31\u662f\u8bf4\uff0c\u5bf9\u4e8e\u4e00\u6b21\u67e5\u8be2 $W$ \u4e2d\u524d\u7f00\u77e9\u5f62 $[1,a]\\times[1,b]$ \u7684\u524d\u7f00\u548c\u7684\u8be2\u95ee\uff0c\n\n\u4ee5\u53ca\u4e00\u6b21\u5bf9 $W$ \u4e2d\u524d\u7f00 $[1,i]\\times[1,j]$ \u6dfb\u52a0 $v$ \u8d21\u732e\u7684\u64cd\u4f5c\uff0c\n\n\u4ec5\u5f53 $i\\le a$ \u4e14 $j\\le b$ \u65f6\uff0c\u8be5\u6b21\u6dfb\u52a0\u8d21\u732e\u7684\u64cd\u4f5c\u5bf9\u8be5\u6b21\u8be2\u95ee\u6709\u5f71\u54cd\u3002\n\n\u73b0\u5728\u7ee7\u7eed\u8ba8\u8bba\u5f71\u54cd\u7684\u5177\u4f53\u503c\uff0c\u5176\u4e2d\uff1a\u8bbe\u5728\u65f6\u523b\u533a\u95f4 $[i,a]$ \u4e2d\u6709 $p$ \u4e2a\u65f6\u523b\u662f\u67d0\u4e2a\u70b9\u7684\u5165\u6808\u65f6\u523b\uff0c\n\n\u6709 $q$ \u4e2a\u65f6\u523b\u662f\u67d0\u4e2a\u70b9\u7684\u51fa\u6808\u65f6\u523b\uff1b\u540c\u65f6\uff0c\u8bbe\u5728\u65f6\u523b\u533a\u95f4 $[j,b]$ \u4e2d\u6709 $r$ \u4e2a\u65f6\u523b\u662f\u67d0\u4e2a\u70b9\u7684\u5165\u6808\u65f6\u523b\uff0c\n\n\u6709 $w$ \u4e2a\u65f6\u523b\u662f\u67d0\u4e2a\u70b9\u7684\u51fa\u6218\u65f6\u523b\uff0c\u5219\u8be5\u6b21\u6dfb\u52a0\u8d21\u732e\u7684\u64cd\u4f5c\uff0c\u5bf9\u5f53\u524d\u8be2\u95ee\u7684\u8d21\u732e\u5c31\u662f\uff1a$(pr-pw-qr+qw)v$\u3002\n\n\u4e0a\u9762\u7684\u65ad\u8a00\u4e0d\u96be\u8bc1\u660e\uff0c\u5229\u7528\u6211\u4eec\u5bf9\u6dfb\u8d21\u732e\u64cd\u4f5c\u4e2d\uff0c\u5177\u4f53\u54ea\u4e9b\u4f4d\u7f6e\u52a0\uff0c\u5177\u4f53\u54ea\u4e9b\u4f4d\u7f6e\u51cf\u7684\u5206\u6790\u5373\u53ef\u8bc1\u660e\u5176\u6b63\u786e\u6027\uff0c\n\n\u800c\u6ce8\u610f\u5230\u8d21\u732e\u7684\u5f0f\u5b50\u5b9e\u9645\u4e0a\u7b49\u4e8e $(p-q)(r-w)v$\uff0c\u800c $p-q$ \u4ec5\u4e0e $i,a$ \u6709\u5173\uff0c$r-w$ \u4ec5\u4e0e $j,b$ \u6709\u5173\uff0c\n\n\u4e14\u4e24\u8005\u90fd\u5177\u6709\u533a\u95f4\u53ef\u51cf\u6027\uff0c\u6545\u6211\u4eec\u53ef\u4ee5\u5c06\u4e24\u8005\u5206\u522b\u8868\u793a\u6210 $s(a)-s(i-1)$\uff0c$s(b)-s(j-1)$ \u7684\u5f62\u5f0f\uff0c\n\n\u5176\u4e2d $s(x)$ \u4ee3\u8868\u65f6\u523b $x$ \u4e4b\u524d\u7684\u6240\u6709\u65f6\u523b\u4e2d\uff0c\u5165\u6808\u65f6\u523b\u7684\u6570\u91cf\u4e0e\u51fa\u6808\u65f6\u523b\u6570\u91cf\u7684\u5dee\u3002\n\n\u6240\u4ee5\uff0c\u4e0a\u9762\u7684\u8d21\u732e\u5f0f\u4e5f\u5c31\u7b49\u4e8e $(s(a)-s(i-1))(s(b)-s(j-1))v$\uff0c\u8fd9\u65f6\u518d\u5c06\u5f0f\u5b50\u4e2d\u7684\u62ec\u53f7\u62c6\u5f00\uff0c\u5c31\u662f\uff1a\n\n$s(a)s(b)v-s(a)s(i-1)v-s(j-1)s(b)v+s(i-1)s(j-1)v$\u3002\n\n\u90a3\u4e48\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u8be2\u95ee $[1,a]\\times[1,b]$\uff0c\u5176\u7b54\u6848\u5c31\u662f\u6240\u6709\u6dfb\u52a0\u8d21\u732e\u7684\u64cd\u4f5c\u5bf9\u5176\u7684\u5f71\u54cd\u548c\uff0c\u5373\uff1a\n\n$answer=\\sum\\limits_{([1,i]\\times[1,j],v)\\in Modify}(s(a)s(b)v-s(a)s(i-1)v-s(j-1)s(b)v+s(i-1)s(j-1)v)$\uff0c\n\n\u5176\u4e2d $([1,i]\\times[1,j],v)\\in Modify$ \u7684\u542b\u4e49\u662f\uff0c\u5b58\u5728\u4e00\u6b21\u5bf9\u524d\u7f00 $[1,i]\\times[1,j]$ \u6dfb\u52a0 $v$ \u8d21\u732e\u7684\u64cd\u4f5c\uff0c\n\n\u7531\u4e8e\u957f\u5ea6\u9650\u5236\uff0c\u4e0b\u6587\u7528 $01$ \u53d8\u91cf $M$\uff0c\u6765\u4ee3\u66ff $([1,i]\\times[1,j],v)\\in Modify$ \u7684\u503c\uff0c\n\n\u4e5f\u7528\u4e8c\u5143\u7ec4 $([1,i]\\times [1,j],v)$\uff0c\u6765\u4ee3\u66ff\u4e00\u6b21\u5bf9\u524d\u7f00 $[1,i]\\times[1,j]$ \u6dfb\u52a0 $v$ \u8d21\u732e\u7684\u64cd\u4f5c\u3002\n\n\u90a3\u4e48\uff0c\u6211\u4eec\u5c06\u4e0a\u9762\u5f0f\u5b50\u7684\u6bcf\u4e00\u9879\u62c6\u5f00\uff0c\u5373\uff1a\n\n$answer=\\sum\\limits_{M}(s(a)s(b)v)-\\sum\\limits_M(s(a)s(i-1)v)-\\sum\\limits_M(s(j-1)s(b)v)+\\sum\\limits_M(s(i-1)s(j-1)v)$\uff0c\n\n\u6709\u4e86\u8fd9\u4e2a\u5f0f\u5b50\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5c06\u6240\u6709\u8be2\u95ee\u64cd\u4f5c\u548c\u6dfb\u52a0\u8d21\u732e\u64cd\u4f5c\u90fd\u79bb\u7ebf\u4e0b\u6765\uff0c\u518d\u7528\u626b\u63cf\u7ebf\u6811\u72b6\u6570\u7ec4\u7ef4\u62a4\u5373\u53ef\u3002\n\n\u5177\u4f53\u7684\uff0c\u6211\u4eec\u4ee5 $-\\sum\\limits_Ms(a)s(i-1)v$ \u8fd9\u4e00\u9879\u7684\u7ef4\u62a4\u65b9\u6cd5\u4e3a\u4f8b\uff0c\n\n\u6ce8\u610f\u5230 $s(a)$ \u7684\u503c\u4e0d\u968f\u64cd\u4f5c $([1,i]\\times[1,j],v)$ \u7684\u53d8\u5316\u800c\u6539\u53d8\uff0c\u6545\u53ef\u4ee5\u5c06\u5f0f\u5b50\u5199\u6210 $-s(a)\\sum\\limits_Ms(i-1)v$\uff0c\n\n\u800c $\\sum\\limits_Ms(i-1)v$ \u7684\u503c\u5c31\u5bb9\u6613\u7ef4\u62a4\u4e86\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u5176\u7406\u89e3\u4e3a\uff0c\u5728\u5e73\u9762\u4e0a\u6709\u82e5\u5e72\u4e2a\u5e26\u6743\u7684\u70b9\uff0c\u5176\u4e2d\uff1a\n\n\u70b9 $(i,j)$ \u5b58\u5728\uff0c\u5f53\u4e14\u4ec5\u5f53\u5b58\u5728\u64cd\u4f5c $([1,i]\\times[1,j],v)$\uff0c\u800c\u82e5\u5b58\u5728\u7684\u8bdd\uff0c\u6b64\u65f6\u8be5\u70b9\u6743\u503c\u5c31\u662f $s(i-1)v$\uff0c\n\n\u90a3\u4e48 $\\sum\\limits_Ms(i-1)v$ \u7684\u503c\uff0c\u5c31\u7b49\u4e8e\u5e73\u9762\u4e2d $[1,a]\\times[1,b]$ \u8fd9\u7247\u533a\u57df\u91cc\uff0c\u6240\u6709\u70b9\u70b9\u6743\u7684\u548c\uff0c\n\n\u76f8\u4fe1\u770b\u5230\u8fd9\u91cc\u7684\u4eba\u80af\u5b9a\u90fd\u4f1a\u505a\u4e86\uff0c\u800c\u5176\u4ed6\u4e09\u9879\u7684\u7ef4\u62a4\u65b9\u6cd5\uff0c\u4e5f\u548c\u8fd9\u4e2a\u7c7b\u4f3c\u3002\n\n\u8fd9\u9053\u9898\u5c31\u505a\u5b8c\u4e86\uff0c\u65f6\u95f4\u590d\u6742\u5ea6\u662f $O(n\\log n)$\uff0c\u4f46\u6211\u4e0d\u592a\u4f1a\u8bc1\uff0c\u60f3\u8981\u4e86\u89e3\u7684\u8bdd\u53ef\u4ee5\u770b `Claris` \u7684[\u9898\u89e3](https://files.cnblogs.com/files/clrs97/old-solution.pdf)\u3002\n\n\u4ee3\u7801\u8f83\u5176\u4ed6\u505a\u6cd5\u6765\u8bf4\u8fd8\u7b97\u597d\u5199\uff0c\u5c31\u4e0d\u5168\u8d34\u5728\u8fd9\u91cc\u4e86\uff0c\u60f3\u770b\u7684\u8bdd\u53ef\u4ee5[\u70b9\u51fb\u94fe\u63a5](https://www.luogu.com.cn/paste/xr98dvr4)\u3002\n\n**\u53c2\u8003\u6587\u7ae0**\uff1a\n\n`Claris` \u7684\u9898\u89e3\uff0c\u94fe\u63a5\u5728\u4e0a\u9762\u3002\n\n",
        "postTime": 1649724144,
        "uid": 100091,
        "name": "GaryH",
        "ccfLevel": 6,
        "title": "P4618 \u9898\u89e3"
    },
    {
        "content": "# \u6b64\u505a\u6cd5\u80fd\u8fc7 suwakow \u51fa\u7684\u6539\u7248\uff08\u4e0d\u4f9d\u8d56\u6570\u636e\u751f\u6210\u5668\u4e14\u7a7a\u95f4\u7ebf\u6027\uff09\u3002\n\n# [Link](https://www.luogu.com.cn/problem/P5669)\n\n\u4e0d\u6127\u662f SDOI2018 Round 2\uff01\u505a\u8fd9\u9898\u53d7\u5230\u4e86\u6781\u5927\u7684\u7cbe\u795e\u6c61\u67d3\u3002\n\n# \u9898\u89e3\n\n\u9996\u5148\u6811\u4e0a\u94fe\u6570\u989c\u8272\u95ee\u9898\u6700\u5feb\u4e5f\u53ea\u80fd\u505a\u5230\u6839\u53f7\u590d\u6742\u5ea6\uff0c\u4e00\u822c\u6211\u4eec\u7528\u6811\u4e0a\u83ab\u961f\u6765\u89e3\u51b3\u3002\n\n\u800c\u76f4\u89c9\u544a\u8bc9\u6211\u4eec\u5982\u679c\u8be2\u95ee $1$ \u80fd\u505a\u90a3\u4e48\u8be2\u95ee $2$ \u4e5f\u6ca1\u5565\u95ee\u9898\uff08\u83ab\u961f\u662f\u8fd9\u6837\u7684\uff09\uff0c\u6240\u4ee5\u6b64\u9898\u505a\u6cd5\u5e94\u4e3a\u6811\u4e0a\u83ab\u961f\uff0c\u5b83\u4e5f\u6ee1\u8db3\u4e86\u7a7a\u95f4\u7ebf\u6027\uff0c\u4e0d\u4f9d\u8d56\u4e8e\u7279\u6b8a\u6027\u8d28\u7684\u8981\u6c42\u3002\n\n\u73b0\u5728\u7684\u95ee\u9898\u662f\u5982\u4f55\u8bbe\u8ba1\u89e3\u6cd5\u3002\n\n\u5047\u8bbe\u6211\u4eec\u5df2\u7ecf\u6c42\u51fa\u4e86 $(a,b)$ \u5728\u8be2\u95ee $1,2$ \u4e0b\u7684\u7b54\u6848\uff0c\u5e76\u8bbe\u8be2\u95ee $2$ \u4e0b\u7684\u7b54\u6848\u4e3a $ans$\uff0c\u73b0\u5728\u5c06 $a$ \u5728\u6811\u4e0a\u4efb\u8d70\u4e00\u6b65\u8d70\u5230 $a'$\uff0c\u76ee\u6807\u662f\u6c42\u51fa $(a',b)$ \u5728\u8be2\u95ee $1,2$ \u4e0b\u7684\u7b54\u6848\u3002\n\n\u8bbe $col_i$ \u4e3a\u7b2c $i$ \u4e2a\u70b9\u7684\u989c\u8272\uff0c$lca=\\text{LCA}(a,b)$\uff0c\u50cf\u8fd9\u79cd\u95ee\u9898\u6211\u4eec\u5f88\u96be\u4e0d\u8fdb\u884c\u5927\u5206\u8ba8\uff0c\u8fd9\u4e5f\u5c31\u662f\u672c\u9898\u7684\u6bd2\u7624\u4e4b\u5904\uff08\u63d2\u4e00\u5634\uff0c\u6c42 LCA \u8bf7\u4f7f\u7528\u6811\u5256\uff0c\u56e0\u4e3a\u7a7a\u95f4\u8981\u6c42\u7ebf\u6027\uff09\u3002\n\n\u65b0\u5f00\u4e09\u4e2a\u5e8f\u5217\uff1a $s_{lca}$ \u5305\u542b $lca\\rightarrow 1$ \u7684\u8def\u5f84\u4e0a\u4f9d\u6b21\u8d70\u8fc7\u7684\u6240\u6709\u70b9\uff08\u542b $lca$\uff09\uff0c$s_a$ \u5305\u542b $lca\\rightarrow a$ \u7684\u8def\u5f84\u4e0a\u4f9d\u6b21\u8d70\u8fc7\u7684\u6240\u6709\u70b9\uff08\u4e0d\u542b $lca$\uff09\uff0c$s_b$ \u5305\u542b $lca\\rightarrow b$ \u7684\u8def\u5f84\u4e0a\u4f9d\u6b21\u8d70\u8fc7\u7684\u6240\u6709\u70b9\uff08\u4e0d\u542b $lca$\uff09\u3002\n\n\u5e76\u65b0\u5f00\u4e24\u4e2a\u53d8\u91cf $sum_a,sum_b$\uff0c$sum_a$ \u4ee3\u8868\u5bf9\u4e8e\u6240\u6709\u7684 $c\\in(b\\leftrightarrow 1)$\uff0c$a\\leftrightarrow c$ \u7684\u8def\u5f84\u989c\u8272\u6570\u4e4b\u548c\uff0c$sum_b$ \u540c\u7406\u3002\n\n\u6211\u4eec\u80af\u5b9a\u8fd8\u8981\u5bf9 $a$ \u5f80\u4e0a\u8fd8\u662f\u5f80\u4e0b\u8d70\u8fdb\u884c\u5206\u8ba8\u3002\n\n## $1$\u3001$a$ \u5f80\u4e0a\u8d70\n\n\u76f8\u5f53\u4e8e\u53bb\u6389\u4e00\u4e2a\u989c\u8272\uff0c\u9996\u5148\u8981\u5c06 $ans\\leftarrow ans-sum_a$\u3002\n\n\u4e4b\u540e\u8981\u8003\u8651 $a\u2019\\leftrightarrow (c\\in (b\\leftrightarrow 1))$ \u7684\u6240\u6709\u8def\u5f84\u4e2d\u4e0d\u5b58\u5728 $col_d$ \u7684\u6761\u6570\uff0c\u5e76\u6539\u53d8 $sum_a$\uff0c$sum_b$ \u76f4\u63a5\u51cf\u53bb $a\\leftrightarrow b$ \u8def\u5f84\u4e0a\u7684\u989c\u8272\u6570\u3002\n\n\u5982\u679c $\\text{LCA}(a',b)\\not=lca$ \u8fd8\u9700\u8981\u6539\u53d8\u4e00\u4e0b $lca$ \u4ee5\u53ca\u90a3\u4e09\u4e2a\u5e8f\u5217\uff0c\u663e\u7136\u6539\u53d8\u8fd9\u4e09\u4e2a\u5e8f\u5217\u548c $a$ \u79fb\u52a8\u4e00\u4e2a\u590d\u6742\u5ea6\u3002\n\n\u9996\u5148 $a'\\leftrightarrow lca$ \u90e8\u5206\u80af\u5b9a\u5b58\u5728\uff0c\u5982\u679c\u5305\u542b\u4e86 $col_d$ \u76f4\u63a5 break \u5c31\u884c\u4e86\u3002\n\n\u5426\u5219\uff0c\u9700\u8981\u8003\u8651 $lca$ \u5411\u4e0a\u548c\u5411\u4e0b\u8fd9\u4e24\u90e8\u5206\uff0c\u6211\u4eec\u53ea\u9700\u8981\u5411\u4e0a\u5411\u4e0b\u5206\u522b\u627e\u5230\u6700\u8fd1\u7684\u989c\u8272\u4e3a $col_d$ \u7684\u4e24\u4e2a\u70b9\uff08\u663e\u7136\u5f00\u4e2a\u8f85\u52a9\u6570\u7ec4\u53ef\u4ee5\u505a\u5230 $O(1)$ \u67e5\u8be2\uff09\uff0c\u8fd9\u6837\u4e0d\u5305\u542b $col_d$ \u7684\u8def\u5f84\u6570\u5c31\u662f\u4e24\u4e2a\u70b9\u7684\u6df1\u5ea6\u4e4b\u5dee $-1$\uff0c\u628a $sum_a$ \u66f4\u65b0\u4e00\u4e0b\u5373\u53ef\u3002\n\n## $2$\u3001$a$ \u5f80\u4e0b\u8d70\n\n\u76f8\u5f53\u4e8e\u52a0\u4e0a\u4e00\u4e2a\u989c\u8272\u3002\n\n\u8003\u8651 $a'\\leftrightarrow (c\\in (b\\leftrightarrow 1))$ \u7684\u6240\u6709\u8def\u5f84\u4e2d\u4e0d\u5b58\u5728 $col_d$ \u7684\u6761\u6570\uff0c\u5e76\u6539\u53d8 $sum_a$\uff0c$sum_b$ \u76f4\u63a5\u52a0\u4e0a $a'\\leftrightarrow b$ \u8def\u5f84\u4e0a\u7684\u989c\u8272\u6570\u3002\n\n\u9996\u5148 $a\\leftrightarrow lca$ \u90e8\u5206\u80af\u5b9a\u5b58\u5728\uff0c\u5982\u679c\u5305\u542b\u4e86 $col_d$ \u76f4\u63a5 break \u5c31\u884c\u4e86\u3002\n\n\u5426\u5219\uff0c\u548c\u4e0a\u9762\u5904\u7406\u65b9\u6cd5\u4e00\u6837\uff0c$sum_a$ \u66f4\u65b0\u5b8c\u8fd8\u9700\u8981\u628a $ans\\leftarrow ans+sum_a$\uff0c\n\n\u6700\u540e\u6539\u53d8\u4e00\u4e0b $lca$ \u548c\u90a3\u4e09\u4e2a\u5e8f\u5217\u5c31\u884c\u4e86\u3002\n\n\u4e0d\u8fc7\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\uff0c\u5c31\u662f\u5982\u679c $a=lca$\uff0c\u90a3\u4e48\u4e0a\u9762\u4e24\u4e2a\u505a\u6cd5\u53ef\u80fd\u4e0d\u6210\u7acb\uff0c\u6240\u4ee5\u9700\u8981\u65b0\u5f00\u4e00\u4e2a\u8ba8\u8bba\u3002\n\n## $3$\u3001$a=lca$\n\n\u5982\u679c $a$ \u5f80\u4e0a\u8d70\u4e86\uff0c\u90a3\u4e48\u5b83\u4f1a\u5c06\u6240\u6709\u6ee1\u8db3 $dep_c>dep_a\\wedge c\\in (b\\leftrightarrow1)$ \u7684\u6240\u6709 $a\\leftarrow c$ \u7684\u8def\u5f84\u989c\u8272\u6570\u90fd\u589e\u52a0\uff0c\u53cd\u4e4b\u5219\u51cf\u5c11\u3002\n\n\u8fd9\u65f6\u5019\u9700\u8981\u5bf9 $a$ \u4e0b\u9762\u548c\u4e0a\u9762\u7684\u60c5\u51b5\u5206\u522b\u67e5\u5206\u522b\u8ba1\u7b97\u5c31\u884c\u3002\n\n\u5982\u679c\u5f80\u4e0b\u8fd8\u5f97\u5206\u4e24\u79cd\u60c5\u51b5\uff1a\n\n### $1$\u3001$a'$ \u4f9d\u65e7\u662f $b$ \u7684\u7956\u5148\n\n\u8fd9\u4e2a\u8ddf $a$ \u5f80\u4e0a\u8d70\u6ca1\u591a\u5927\u533a\u522b\uff0c\u5c31\u662f\u4f1a\u5c06\u6240\u6709\u6ee1\u8db3 $dep_c>dep_a\\wedge c\\in (b\\leftrightarrow1)$ \u7684\u6240\u6709 $a\\leftarrow c$ \u7684\u8def\u5f84\u989c\u8272\u6570\u90fd\u51cf\u5c11\uff0c\u53cd\u4e4b\u5219\u589e\u52a0\u3002\n\n### $2$\u3001$a'$ \u4e0d\u662f $b$ \u7684\u7956\u5148\n\n\u8ddf\u4e4b\u524d $a$ \u5f80\u4e0b\u8d70\u4e14 $a\\not=lca$ \u7684\u505a\u6cd5\u662f\u4e00\u6837\u7684\uff0c\u628a\u8fd9\u4e2a\u505a\u6cd5\u7167\u642c\u8fc7\u6765\u5c31\u884c\u3002\n\n$b$ \u540c\u7406\uff0c\u8fd9\u91cc\u4e0d\u518d\u53d9\u8ff0\u3002\n\n\u7ec6\u8282\u7e41\u591a\uff0c\u96be\u5199\u7684\u8981\u6b7b\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a$O(m\\log m+m\\log n +n\\sqrt m)$\uff0c\u7a7a\u95f4\u590d\u6742\u5ea6\uff1a$O(n+m)$\n\n# AC Code\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nusing ll=long long;\n#define endl '\\n'\n#define eb emplace_back\n#define me(x,y) memset(x,y,sizeof(x))\n#define block 447\nstruct ask{\n\tbool op;int l,r,id;\n\tbool operator <(const ask &a)const{\n\t\tif(l/block^a.l/block) return l<a.l;\n\t\tif(l/block&1) return r>a.r;return r<a.r;\n\t}\n}q[200001];\nint ans1,lca,dep[100001],mp[200001],a[100001],fa[100001],son[100001],top[100001],tim,depth,st[100001],ed[100001],siz[100001];\nll ans2,sum[2],ans[200001];\nvector<int> edge[100001];\nint s[3][100001],up[2][100001],down[3][100001],pre[3][100001],nxt[2][100001],zz[3];\nvoid dfs1(int u,int f){\n\tsiz[u]=1,fa[u]=f,dep[u]=dep[f]+1;\n\tfor(int v:edge[u]) if(v^f){\n\t\tdfs1(v,u),siz[u]+=siz[v];\n\t\tif(siz[v]>siz[son[u]]) son[u]=v;\n\t}\n}\nvoid dfs2(int u,int f){\n\tmp[st[u]=++tim]=u;\n\tif(son[u]) top[son[u]]=top[u],dfs2(son[u],u),mp[++tim]=u;\n\tfor(int v:edge[u]) if(v^f&&v^son[u]) top[v]=v,dfs2(v,u),mp[++tim]=u;\n\ted[u]=tim;\n}\ninline int qlca(int u,int v){\n\twhile(top[u]^top[v]){\n\t\tif(dep[top[u]]<dep[top[v]]) swap(u,v);\n\t\tu=fa[top[u]];\n\t}\n\tif(dep[u]<dep[v]) return u;return v;\n}\nint p[2];\ninline void add(bool op,int x,int xx,int type){\n\tint col;\n\tif(~type){\n\t\tans2-=sum[op],sum[!op]-=ans1;\n\t\tif(mp[x]^lca){\n\t\t\tcol=a[mp[x]];\n\t\t\tif(!pre[op][dep[mp[x]]]&&a[lca]^col){\n\t\t\t\tint diff;\n\t\t\t\tif(up[!op][col]) diff=up[!op][col];else diff=dep[mp[p[!op]]]+1,ans1--;\n\t\t\t\tsum[op]-=diff-down[2][col]-1;\n\t\t\t}\n\t\t\tnxt[op][down[op][col]=pre[op][zz[op]]]=0;\n\t\t\tpre[op][zz[op]--]=0;\n\t\t\tif(!down[op][col]) up[op][col]=0;\n\t\t}\n\t\telse{\n\t\t\tcol=a[lca],sum[op]-=dep[lca]-1-pre[2][dep[lca]];\n\t\t\tcol=a[mp[xx]];\n\t\t\tif(col^a[lca]){\n\t\t\t\tif(up[!op][col]) sum[op]+=up[!op][col]-dep[lca];\n\t\t\t\telse sum[op]+=dep[mp[p[!op]]]-dep[mp[xx]],ans1++;\n\t\t\t}\n\t\t\tzz[op]--;\n\t\t\tcol=a[mp[x]],lca=mp[xx];\n\t\t\tdown[2][col]=pre[2][zz[2]];\n\t\t\ts[!op][zz[2]]=mp[x];\n\t\t\tpre[!op][up[!op][col]]=zz[2];\n\t\t\tnxt[!op][zz[2]]=up[!op][col],up[!op][col]=zz[2]--;\n\t\t\tif(!down[!op][col]) down[!op][col]=up[!op][col];\n\t\t}\n\t}\n\telse{\n\t\tif(mp[x]^lca){\n\t\t\tcol=a[mp[xx]];\n\t\t\tif(!up[op][col]&&a[lca]^col){\n\t\t\t\tint diff;\n\t\t\t\tif(up[!op][col]) diff=up[!op][col];else diff=dep[mp[p[!op]]]+1,ans1++;\n\t\t\t\tsum[op]+=diff-down[2][col]-1;\n\t\t\t}\n\t\t\ts[op][++zz[op]]=mp[xx];\n\t\t\tnxt[op][down[op][col]]=zz[op];\n\t\t\tpre[op][zz[op]]=down[op][col],down[op][col]=zz[op];\n\t\t\tif(!up[op][col]) up[op][col]=down[op][col];\n\t\t}\n\t\telse{\n\t\t\tcol=a[lca];\n\t\t\tif(mp[p[0]]==mp[p[1]]||s[!op][zz[2]+1]^mp[xx]){\n\t\t\t\tcol=a[mp[xx]];\n\t\t\t\tif(col^a[lca]){\n\t\t\t\t\tif(up[!op][col]) sum[op]+=up[!op][col]-dep[lca];\n\t\t\t\t\telse sum[op]+=zz[!op]-dep[lca]+1,ans1++;\n\t\t\t\t\tsum[op]+=dep[lca]-down[2][col]-1;\n\t\t\t\t}\n\t\t\t\ts[op][++zz[op]]=mp[xx];\n\t\t\t\tnxt[op][down[op][col]]=zz[op];\n\t\t\t\tpre[op][zz[op]]=down[op][col],down[op][col]=zz[op];\n\t\t\t\tif(!up[op][col]) up[op][col]=down[op][col];\n\t\t\t}\n\t\t\telse{\n\t\t\t\tif(up[!op][col]) sum[op]-=up[!op][col]-dep[lca]-1;\n\t\t\t\telse{\n\t\t\t\t\tsum[op]-=dep[mp[p[!op]]]-dep[lca];\n\t\t\t\t\tif(mp[p[0]]^mp[p[1]]) ans1--;\n\t\t\t\t}\n\t\t\t\tcol=a[mp[xx]],sum[op]+=dep[lca]-down[2][col];\n\t\t\t\ts[2][++zz[2]]=lca=mp[xx];\n\t\t\t\tpre[2][zz[2]]=down[2][col],down[2][col]=zz[2];\n\t\t\t\tpre[!op][up[!op][col]=nxt[!op][zz[2]]]=0;\n\t\t\t\tnxt[!op][zz[2]]=0;\n\t\t\t\tif(!up[!op][col]) down[!op][col]=0;\n\t\t\t\tzz[op]++;\n\t\t\t}\n\t\t}\n\t\tans2+=sum[op],sum[!op]+=ans1;\n\t}\n}\nunsigned int SA, SB, SC;\ninline unsigned int rng61(){\n\tSA ^= SA << 16;\n\tSA ^= SA >> 5;\n\tSA ^= SA << 1;\n\tunsigned int t = SA;\n\tSA = SB;\n\tSB = SC;\n\tSC ^= t ^ SA;\n\treturn SC;\n}\nvoid solve(){\n\tint n,P;cin>>n>>P>>SA>>SB>>SC;\n\tme(son,0),tim=0;\n\tfor(int i=1;i<=n;i++) vector<int>().swap(edge[i]);\n\tfor(int i = 2; i <= P; i++) edge[i].eb(i-1),edge[i-1].eb(i);\n\tfor(int i = P + 1; i <= n; i++){\n\t\tint x=rng61()%(i-1)+1;\n\t\tedge[x].eb(i),edge[i].eb(x);\n\t}\n\tfor(int i = 1; i <= n; i++) a[i]=rng61()%n+1;\n\tdfs1(1,0),dfs2(1,0);\n\tint m;cin>>m;\n\tfor(int i=1;i<=m;i++){\n\t\tint op,x,y;cin>>op>>x>>y;\n\t\tif(st[x]>st[y]) swap(x,y);\n\t\tq[i].r=st[y];\n\t\tif(qlca(x,y)^x) q[i].l=ed[x];else q[i].l=st[x];\n\t\tq[i].id=i,q[i].op=--op;\n\t}\n\tsort(q+1,q+m+1);\n\tme(up,0),me(down,0),me(pre,0),me(nxt,0);\n\ts[2][1]=p[0]=p[1]=lca=ans1=ans2=zz[0]=down[2][a[1]]=sum[0]=sum[1]=zz[1]=zz[2]=1;\n\tfor(int i=1;i<=m;i++){\n\t\twhile(p[0]>q[i].l) add(0,p[0],p[0]-1,dep[mp[p[0]]]-dep[mp[p[0]-1]]),p[0]--;\n\t\twhile(p[1]<q[i].r) add(1,p[1],p[1]+1,dep[mp[p[1]]]-dep[mp[p[1]+1]]),p[1]++;\n\t\twhile(p[0]<q[i].l) add(0,p[0],p[0]+1,dep[mp[p[0]]]-dep[mp[p[0]+1]]),p[0]++;\n\t\twhile(p[1]>q[i].r) add(1,p[1],p[1]-1,dep[mp[p[1]]]-dep[mp[p[1]-1]]),p[1]--;\n\t\tif(q[i].op) ans[q[i].id]=ans2;else ans[q[i].id]=ans1;\n\t}\n\tfor(int i=1;i<=m;i++) cout<<ans[i]<<endl;\n}\nint main(){\n\tios::sync_with_stdio(0),cin.tie(0);\n\ttop[1]=1;\n\tint t;cin>>t;\n\twhile(t--) solve();\n\treturn 0;\n}\n```",
        "postTime": 1670992410,
        "uid": 80614,
        "name": "ZCPB",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P4618 [SDOI2018]\u539f\u9898\u8bc6\u522b"
    },
    {
        "content": "## \u94fe\u4e0a\u7684\u60c5\u51b5\n\n### \u60c5\u51b5\u4e00\n\n\u8bb0\u5f55\u6bcf\u4e2a\u70b9$i$\u524d\u4e00\u4e2a\u4e0e\u5b83\u4e00\u6837\u7684\u4f4d\u7f6e$pre_i$,\n\n\u90a3\u4e48\u533a\u95f4$[l,r]$\u5185\u4e0d\u540c\u7684\u4e2a\u6570\u4e5f\u5c31\u662f$[l,r]$\u4e2d$pre_i<l$\u7684\u4e2a\u6570\n\n\u4e3b\u5e2d\u6811\u7edf\u8ba1\u5373\u53ef\n\n### \u60c5\u51b5\u4e8c\n\n\u8003\u8651\u6bcf\u4e2a\u70b9\u5bf9\u7b54\u6848\u7684\u8d21\u732e,\u5206\u7c7b\u8ba8\u8bba\n\n1. $i\\in [1,A]$\n   \n   \u90a3\u4e48\u6ee1\u8db3\u7684$y\\in (pre_i,i],x\\in [i,A]$\n   \n   \u6216$x\\in (pre_i,i],y\\in [i,B]$\n\n   \u603b\u8d21\u732e\u4e3a$\\sum (i-pre_i)\\times(A+B-2i+2)-1$\n   \n   ($-1$\u4e3a\u4e86\u907f\u514d$[i,i]$\u88ab\u91cd\u590d\u8ba1\u7b97)\n\n   \u62c6\u4e0b\u5f0f\u5b50: $(A+B+2)(\\sum i-pre_i)-2(\\sum i(i-pre_i))-\\sum 1$\n\n   \u53ef\u4ee5\u53d1\u73b0\u8fd9\u79cd\u60c5\u51b5\u53ef\u4ee5\u76f4\u63a5\u524d\u7f00\u548c\u7ef4\u62a4\n\n2. $i\\in (A,B]$,\u6ee1\u8db3$pre_i<A$\n   \n   \u90a3\u4e48\u6ee1\u8db3\u7684$x\\in (pre_i,A],y\\in [i,B]$\n\n   \u603b\u8d21\u732e\u4e3a$\\sum (A-pre_i)\\times(B-i+1)$\n\n   \u62c6\u4e0b\u5f0f\u5b50$(A\\sum 1-\\sum pre_i)(B+1)-A\\sum i+\\sum ipre_i$\n\n   \u53ef\u4ee5\u53d1\u73b0\u8fd9\u79cd\u60c5\u51b5\u53ef\u4ee5\u7528\u4e3b\u5e2d\u6811\u7ef4\u62a4\n\n## \u6811\u4e0a\u60c5\u51b5\n\n\u89c2\u5bdf\u6570\u636e\u5f62\u6210\u65b9\u5f0f:\n\n- \u524d$p$\u4e2a\u70b9\u5f62\u6210\u4e00\u6761\u4e3b\u94fe,\u5176\u4ed6\u70b9\u968f\u673a\u5411\u4e3b\u94fe\u8fde\u8fb9  \n  \u6240\u4ee5\u6811\u4e0a\u4efb\u610f\u70b9\u5bf9\u7684$\\texttt{lca}$\u8ddd\u79bb\u4ed6\u4eec\u671f\u671b\u4e3a$\\mathcal O(\\log n)$\n- \u6bcf\u4e2a\u70b9\u7684\u989c\u8272\u5728$[1,n]$\u4e2d\u968f\u673a,\u6bcf\u79cd\u989c\u8272\u6570\u76ee\u671f\u671b\u4e3a$1$\n\n\u4ee4$pre_i$\u4e3a$i$\u7684\u7956\u5148\u4e2d\u989c\u8272\u4e0e$i$\u76f8\u540c\u7684\u6df1\u5ea6\u6700\u5927\u7684\u70b9\n\n### \u7b2c\u4e00\u95ee\n\n\u8bbe$x$\u4e0e$y$\u4e2d$x$\u79bb$\\texttt{lca}(x,y)$\u66f4\u8fd1\n\n\u9996\u5148\u6c42\u51fa$y$\u5230$\\texttt{lca}$\u94fe\u4e0a\u7684\u989c\u8272\u603b\u6570,\n\n\u7136\u540e\u518d\u66b4\u529b\u679a\u4e3e$x$\u5230$\\texttt{lca}$\u94fe\u4e0a\u7684\u989c\u8272\u66f4\u65b0\u7b54\u6848\n\n### \u7b2c\u4e8c\u95ee\n\n\u8bbe$A$\u4e0e$B$\u4e2d$A$\u79bb$\\texttt{lca}(A,B)$\u66f4\u8fd1\n\n\u5206\u7c7b\u8ba8\u8bba:\n\n1. $x\\in [1,\\texttt{lca}],y\\in [1,B]$,\u4e0e\u94fe\u4e0a\u7684\u60c5\u51b5\u76f8\u540c\n2. $x\\in [\\texttt{lca},A],y\\in [1,\\texttt{lca}]$\n   \n   \u7528$x\\in [1,A],y\\in [1,\\texttt{lca}]$\u7684\u7b54\u6848\u51cf\u53bb\n   \n   $x,y\\in [1,\\texttt{lca})$\u7684\u7b54\u6848$\\sum (2(i-pre_i)(\\texttt{lca}-i)-1)$\n\n   \u62c6\u4e0b\u5f0f\u5b50: $2\\texttt{lca}\\sum (i-pre_i) - 2\\sum i(i-pre_i)-\\sum 1$\n\n3. $x\\in [\\texttt{lca},A],y\\in [\\texttt{lca},B]$\n   \n   \u5148\u6c42\u51fa$i\\in [\\texttt{lca,B}]$\u7684\u8d21\u732e$\\sum (B-i+1)(A-\\texttt{lca}+1)$\n\n   \u62c6\u4e0b\u5f0f\u5b50: $(A-\\texttt{lca}+1)(\\sum B+1 - \\sum i)$\n\n   \u7136\u540e\u7528$i\\in (\\texttt{lca},A]$\u66f4\u65b0\n\n   $pre_i\\le\\texttt{lca}$,\u8bbe$j$\u4e3a$[\\texttt{lca},B]$\u4e2d\u7b2c\u4e00\u4e2a\u4e0e\u5b83\u989c\u8272\u76f8\u540c\u7684\u70b9\n\n   \u8d21\u732e: $(A-i+1)(j-\\texttt{lca})$\n\n\u5b9e\u73b0\u8fc7\u7a0b\u8be6\u89c1\u4ee3\u7801\n\n```cpp\n#include<bits/stdc++.h>\nusing std::list;\ntypedef long long ll;\nconst int N=100011;\nint n,a[N];list<int>vec[N],e[N];\nint RT[N];\nstruct node{\n    ll v,pd,d,pdxd;// \u03a31,\u03a3dep[pre],\u03a3dep[i],\u03a3dep[pre]\u00d7dep[i]\n    node operator+(const node&t){return node{v+t.v,pd+t.pd,d+t.d,pdxd+t.pdxd};}\n    node operator-(const node&t){return node{v-t.v,pd-t.pd,d-t.d,pdxd-t.pdxd};}\n};\nstruct prt{\n\nint sz,ls[N*20],rs[N*20];\nnode s[N*20];\nvoid build(int&x,int l,int r){\n    s[x=++sz]=node{0,0,0,0};\n    if(l==r)return;\n    int m=l+r>>1;\n    build(ls[x],l,m);build(rs[x],m+1,r);\n}\nvoid ins(int&x,int pre,int p,int l,int r,node v){\n    s[x=++sz]=s[pre]+v;\n    if(l==r)return;\n    ls[x]=ls[pre],rs[x]=rs[pre];\n    int m=l+r>>1;\n    if(p<=m)ins(ls[x],ls[pre],p,l,m,v);\n    else ins(rs[x],rs[pre],p,m+1,r,v);\n}\nnode ask(int x,int y,int R,int l,int r){\n    if(r<=R)return s[y]-s[x];\n    int m=l+r>>1;\n    node ans=ask(ls[x],ls[y],R,l,m);\n    return R>m?ans+ask(rs[x],rs[y],R,m+1,r):ans;\n}\n\n}T;\nint L[N],R[N],dfn,st[20][N*2];\nint f[N],d[N],pre[N],b[N];ll sum[N][2];\nvoid dfs(int x){\n    st[0][L[x]=++dfn]=x;\n    pre[x]=b[a[x]],b[a[x]]=x;\n    T.ins(RT[x],RT[f[x]],pre[x],0,n,node{\n        1,d[pre[x]],d[x],1ll*d[pre[x]]*d[x]\n    });\n    sum[x][0]=d[x]-d[pre[x]]+sum[f[x]][0];\n    sum[x][1]=1ll*(d[x]-d[pre[x]])*d[x]+sum[f[x]][1];\n\n    for(int to:e[x])d[to]=d[x]+1,dfs(to),st[0][++dfn]=x;\n    R[x]=dfn;\n    b[a[x]]=pre[x];\n}\nint gmd(int x,int y){return d[x]<d[y]?x:y;}\nvoid ST(){\n    for(int k=1;(1<<k)<=dfn;++k)\n        for(int i=1;i<=dfn-(1<<k)+1;++i)\n            st[k][i]=gmd(st[k-1][i],st[k-1][i+(1<<k-1)]);\n}\nvoid swap(int&x,int&y){int t=x;x=y;y=t;}\nint lca(int x,int y){\n    int l=L[x],r=L[y];\n    if(l>r)swap(l,r);\n    int k=log2(r-l+1);\n    return gmd(st[k][l],st[k][r-(1<<k)+1]);\n}\nint v[N],ti;\nbool chk(int x,int y,int p){\n    return L[x]<=L[p]&&L[p]<=R[x]&&L[p]<=L[y]&&L[y]<=R[p];\n}\nll ask1(int x,int y){\n    if(d[x]>d[y])swap(x,y);\n    int F=lca(x,y);\n    ll ans=T.ask(RT[f[F]],RT[y],d[F]-1,0,n).v;\n    ++ti;\n    for(int i=x;i!=F;i=f[i])if(v[a[i]]!=ti){\n        v[a[i]]=ti;\n        bool ff=1;\n        for(int j:vec[a[i]])\n            if(chk(F,y,j)){ff=0;break;}\n        ans+=ff;\n    }\n    return ans;\n}\nll calc(int A,int B,node t){// i\u2208[1,A],i\u2208(A,B]\n    return (d[A]+d[B]+2)*sum[A][0]-2*sum[A][1]-d[A]+\n        (d[A]*t.v-t.pd)*(d[B]+1)-d[A]*t.d+t.pdxd;\n}\nll ask2(int A,int B){\n    if(d[A]>d[B])swap(A,B);\n    int F=lca(A,B);\n    node FA=T.ask(RT[f[F]],RT[A],d[F]-1,0,n),\n        FB=T.ask(RT[f[F]],RT[B],d[F]-1,0,n);\n    ll ans=calc(f[F],B,FB) // x\u2208[1,lca],y\u2208[1,B]\n        +calc(f[F],A,FA);  // x\u2208[1,A],y\u2208[1,lca]\n    ans-=2*(d[F]*sum[f[F]][0]-sum[f[F]][1])-(d[F]-1);// - x,y\u2208[1,lca)\n    ans+=(d[A]-d[F]+1)*((d[B]+1)*FB.v-FB.d);// i\u2208[lca,B]\n    list<int>sta;\n    for(int i=A;i!=F;i=f[i])sta.push_back(i);\n    ++ti;\n    while(!sta.empty()){// i\u2208(lca,A]\n        int i=sta.back();sta.pop_back();\n        if(v[a[i]]!=ti){\n            v[a[i]]=ti;\n            int mi=d[B]+1;\n            for(int j:vec[a[i]])\n                if(chk(F,B,j)&&d[j]<mi)mi=d[j];\n            ans+=ll(d[A]-d[i]+1)*(mi-d[F]);\n        }\n    }\n    return ans;\n}\nunsigned int SA,SB,SC;\nunsigned int rng61(){SA^=SA<<16;SA^=SA>>5;SA^=SA<<1;unsigned int t=SA;SA=SB;SB=SC;SC^=t^SA;return SC;}\nvoid solve(){\n    int q,p,x,y;\n    scanf(\"%d%d%u%u%u%d\",&n,&p,&SA,&SB,&SC,&q);\n    for(int i=2;i<=n;++i)\n        e[f[i]=i>p?rng61()%(i-1)+1:i-1].push_back(i);\n    for(int i=1;i<=n;++i)vec[a[i]=rng61()%n+1].push_back(i);\n    T.build(RT[0],0,n);\n    d[1]=1,dfs(1);ST();\n    while(q--)\n        scanf(\"%d%d%d\",&p,&x,&y),\n        printf(\"%lld\\n\",p==1?ask1(x,y):ask2(x,y));\n    dfn=T.sz=0;\n    for(int i=1;i<=n;++i)\n        vec[i].clear(),e[i].clear(),\n        RT[i]=v[i]=b[i]=0;\n}\nint main(){\n    int T;scanf(\"%d\",&T);\n    while(T--)solve();\n}\n```",
        "postTime": 1600818087,
        "uid": 36532,
        "name": "localhost",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P4618 \u3010[SDOI2018]\u539f\u9898\u8bc6\u522b\u3011"
    }
]