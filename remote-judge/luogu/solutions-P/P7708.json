[
    {
        "content": "> *X. [P7708\u300cWdsr-2.7\u300d\u516b\u4e91\u84dd\u81ea\u52a8\u673a\u2160](https://www.luogu.com.cn/problem/P7708)\u3002\n>\n> \u6458\u81ea [\u6839\u53f7\u7b97\u6cd5](https://www.cnblogs.com/alex-wei/p/sqrt_algorithms.html) Part.3 \u83ab\u961f \u4f8b\u9898 *X.*\n\n\u4e00\u9053\u83ab\u961f\u597d\u9898\u3002\u672c\u9898\u6700\u6709\u4ef7\u503c\u7684\u5730\u65b9\u5728\u4e8e\u5bf9\u5355\u70b9\u4fee\u6539\u7684\u8f6c\u5316\uff0c\u4ee5\u53ca\u5bf9\u4ea4\u6362\u4e24\u4e2a\u6570\u7684\u5904\u7406\uff1a\u7ef4\u62a4\u539f\u6765\u6bcf\u4e2a\u4f4d\u7f6e\u73b0\u5728\u7684\u4f4d\u7f6e\uff0c\u4ee5\u53ca\u73b0\u5728\u6bcf\u4e2a\u4f4d\u7f6e\u539f\u6765\u7684\u4f4d\u7f6e\u3002\n\n\u6ce8\u610f\u5230\u5355\u70b9\u4fee\u6539\u5e76\u4e0d\u65b9\u4fbf\u5b9e\u73b0\uff0c\u5c06\u5176\u8f6c\u5316\u4e3a\u4ea4\u6362\u4e24\u4e2a\u6570\u3002\u5bf9\u4e8e $a_x\\gets k$\uff0c\u6211\u4eec\u65b0\u5efa $a_c = k$\uff0c\u5e76\u5c06\u5176\u770b\u505a $a_x$ \u4e0e $a_c$ \u4ea4\u6362\u3002\u8fd9\u4e00\u6b65\u975e\u5e38\u5de7\u5999\uff0c\u56e0\u4e3a\u5b83\u6d88\u706d\u4e86\u5355\u70b9\u4fee\u6539\u8fd9\u4e00\u7c7b\u9ebb\u70e6\u7684\u64cd\u4f5c\u3002\n\n\u591a\u6b21\u8be2\u95ee\u4e00\u6bb5\u533a\u95f4\u7684\u64cd\u4f5c\u7ed3\u679c\uff0c\u4e00\u822c\u4f7f\u7528\u83ab\u961f\u5b9e\u73b0\u3002\u56e0\u6b64\uff0c\u8003\u8651\u533a\u95f4\u5728\u4f38\u7f29\u65f6\u9700\u8981\u7ef4\u62a4\u54ea\u4e9b\u4fe1\u606f\u3002\u4e3a\u4e86\u652f\u6301\u5728\u64cd\u4f5c\u5e8f\u5217\u6700\u524d\u9762\u52a0\u5165\u4ea4\u6362\u4e24\u4e2a\u6570\u7684\u64cd\u4f5c\uff0c\u53ef\u4ee5\u60f3\u5230\u7ef4\u62a4\uff1a\n\n- \u5e8f\u5217 $a$ \u5728\u64cd\u4f5c\u540e\u7684\u5f62\u6001\u3002\n- $pos_i$ \u8868\u793a **\u539f** \u4f4d\u7f6e $i$ \u7684 **\u73b0** \u4f4d\u7f6e\u3002\n- $rev_i$ \u8868\u793a **\u73b0** \u4f4d\u7f6e $i$ \u7684 **\u539f** \u4f4d\u7f6e\u3002\n- $add_i$ \u8868\u793a **\u73b0** \u4f4d\u7f6e $i$ \u4e0a\u7684\u6570\u88ab\u67e5\u8be2\u4e86\u591a\u5c11\u6b21\u3002\n- \u5f53\u53f3\u7aef\u70b9\u53f3\u79fb $r - 1\\to r$ \u65f6\uff1a\n    - \u82e5\u7b2c $r$ \u4e2a\u64cd\u4f5c\u662f\u4ea4\u6362 $x, y$\uff0c\u5219\u4ea4\u6362 $a_x$ \u548c $a_y$\uff0c$rev_x$ \u548c $rev_y$\uff0c$pos_{rev_x}$ \u548c $pos_{rev_y}$\u3002\n    - \u82e5\u7b2c $r$ \u4e2a\u64cd\u4f5c\u662f\u67e5\u8be2 $x$\uff0c\u5219\u4ee4 $ans\\gets ans + a_x$\uff0c$add_x\\gets add_x + 1$\u3002\n- \u5f53\u5de6\u7aef\u70b9\u5de6\u79fb $l+1\\to l$ \u65f6\uff1a\n    - \u82e5\u7b2c $l$ \u4e2a\u64cd\u4f5c\u662f\u4ea4\u6362 $x,y$\uff0c\u6ce8\u610f\u6211\u4eec\u76f8\u5f53\u4e8e **\u4ea4\u6362\u539f\u4f4d\u7f6e** \u4e0a\u7684\u4e24\u4e2a\u6570\uff0c\u56e0\u6b64\u5bf9\u7b54\u6848\u6709\u5f71\u54cd\u3002\u5148\u4ea4\u6362 $a_{pos_x}$ \u548c $a_{pos_y}$\uff0c$rev_{pos_x}$ \u548c $rev_{pos_y}$\uff0c$pos_x$ \u548c $pos_y$\u3002\u7531\u4e8e\u4ea4\u6362\u539f\u4f4d\u7f6e\u4e0a\u7684\u4e24\u4e2a\u6570\u5e76\u4e0d\u5f71\u54cd\u73b0\u4f4d\u7f6e\u88ab\u67e5\u8be2\u7684\u6570\u7684\u6b21\u6570\uff08\u56e0\u4e3a\u6211\u4eec\u5df2\u7ecf\u4ea4\u6362\u4e86 $a_{pos_x}$ \u548c $a_{pos_y}$\uff0c\u6216\u8005\u8bf4 $a$ \u548c $add$ \u5f53\u4e2d\u53ea\u8981\u4ea4\u6362\u4e00\u4e2a\u5373\u53ef\u63cf\u8ff0\u672c\u6b21\u64cd\u4f5c\uff0c\u591a\u4ea4\u6362\u53cd\u800c\u4f1a\u8ba9\u7b54\u6848\u9519\u8bef\uff09\uff0c\u56e0\u6b64\u7b54\u6848\u52a0\u4e0a **\u4ea4\u6362\u540e** \u7684 $(a_{pos_x} - a_{pos_y})(add_{pos_x} - add_{pos_y})$\uff0c\u76f8\u5f53\u4e8e\u628a\u6bcf\u4e2a\u6570\u539f\u6765\u7684\u8d21\u732e\u51cf\u6389\uff0c\u52a0\u4e0a\u65b0\u7684\u8d21\u732e\u3002\n    - \u82e5\u7b2c $l$ \u4e2a\u64cd\u4f5c\u662f\u67e5\u8be2 $x$\uff0c\u5219\u4ee4 $ans\\gets ans + a_{pos_x}$\uff0c$add_{pos_x} \\gets add_{pos_x} + 1$\u3002\n\n\u53f3\u7aef\u70b9\u5de6\u79fb\u548c\u5de6\u7aef\u70b9\u53f3\u79fb\u7684\u60c5\u51b5\u5206\u522b\u4e0e\u4e0a\u8ff0\u4e24\u79cd\u60c5\u51b5\u76f8\u4f3c\uff0c\u4ec5\u662f\u7b26\u53f7\u76f8\u53cd\uff0c\u6b64\u5904\u4e0d\u518d\u8d58\u8ff0\u3002\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(n\\sqrt n)$\u3002\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n\n#define uint unsigned int\nconst int N = 4e5 + 5, B = 444;\nint n, m, q, op[N], x[N], y[N], a[N];\nuint cur, ans[N], add[N], pos[N], rev[N];\nstruct query {\n\tint l, r, blk, id;\n\tbool operator < (const query &v) const {\n\t\treturn blk != v.blk ? blk < v.blk : blk & 1 ? r > v.r : r < v.r;\n\t}\n} c[N];\nint main() {\n\tcin >> n >> m;\n\tfor(int i = 1; i <= n; i++) scanf(\"%d\", &a[i]);\n\tfor(int i = 1; i <= m; i++) {\n\t\tscanf(\"%d %d\", &op[i], &x[i]);\n\t\tif(op[i] == 1) scanf(\"%d\", &a[++n]), y[i] = n, op[i] = 2;\n\t\telse if(op[i] == 2) scanf(\"%d\", &y[i]);\n\t}\n\tfor(int i = 1; i <= n; i++) pos[i] = rev[i] = i;\n\tcin >> q;\n\tfor(int i = 1; i <= q; i++) {\n\t\tscanf(\"%d %d\", &c[i].l, &c[i].r);\n\t\tc[i].blk = c[i].l / B, c[i].id = i;\n\t}\n\tsort(c + 1, c + q + 1);\n\tfor(int i = 1, l = 1, r = 0; i <= q; i++) {\n\t\twhile(r < c[i].r) {\n\t\t\tr++;\n\t\t\tif(op[r] == 2) {\n\t\t\t\tswap(a[x[r]], a[y[r]]);\n\t\t\t\tswap(rev[x[r]], rev[y[r]]);\n\t\t\t\tswap(add[x[r]], add[y[r]]);\n\t\t\t\tswap(pos[rev[x[r]]], pos[rev[y[r]]]);\n\t\t\t} else add[x[r]]++, cur += a[x[r]];\n\t\t}\n\t\twhile(l > c[i].l) {\n\t\t\tl--;\n\t\t\tif(op[l] == 2) {\n\t\t\t\tswap(pos[x[l]], pos[y[l]]);\n\t\t\t\tswap(a[pos[x[l]]], a[pos[y[l]]]);\n\t\t\t\tswap(rev[pos[x[l]]], rev[pos[y[l]]]);\n\t\t\t\tcur += add[pos[x[l]]] * (a[pos[x[l]]] - a[pos[y[l]]]);\n\t\t\t\tcur += add[pos[y[l]]] * (a[pos[y[l]]] - a[pos[x[l]]]);\n\t\t\t} else add[pos[x[l]]]++, cur += a[pos[x[l]]];\n\t\t}\n\t\twhile(r > c[i].r) {\n\t\t\tif(op[r] == 2) {\n\t\t\t\tswap(a[x[r]], a[y[r]]);\n\t\t\t\tswap(rev[x[r]], rev[y[r]]);\n\t\t\t\tswap(add[x[r]], add[y[r]]);\n\t\t\t\tswap(pos[rev[x[r]]], pos[rev[y[r]]]);\n\t\t\t} else add[x[r]]--, cur -= a[x[r]];\n\t\t\tr--;\n\t\t}\n\t\twhile(l < c[i].l) {\n\t\t\tif(op[l] == 2) {\n\t\t\t\tcur -= add[pos[x[l]]] * (a[pos[x[l]]] - a[pos[y[l]]]);\n\t\t\t\tcur -= add[pos[y[l]]] * (a[pos[y[l]]] - a[pos[x[l]]]);\n\t\t\t\tswap(pos[x[l]], pos[y[l]]);\n\t\t\t\tswap(a[pos[x[l]]], a[pos[y[l]]]);\n\t\t\t\tswap(rev[pos[x[l]]], rev[pos[y[l]]]);\n\t\t\t} else add[pos[x[l]]]--, cur -= a[pos[x[l]]];\n\t\t\tl++;\n\t\t}\n\t\tans[c[i].id] = cur;\n\t}\n\tfor(int i = 1; i <= q; i++) printf(\"%u\\n\", ans[i]);\n\treturn 0;\n}\n```",
        "postTime": 1633280249,
        "uid": 123294,
        "name": "Alex_Wei",
        "ccfLevel": 10,
        "title": "P7708\u300cWdsr-2.7\u300d\u516b\u4e91\u84dd\u81ea\u52a8\u673a \u2160"
    },
    {
        "content": "\u84dd\u7684\u4e00\u4e9b\u8bdd\uff1a\n\n\u84dd\u7684\u672c\u7bc7\u9898\u89e3\u4ec5\u8bb2\u8ff0 \u516b\u4e91\u84dd\u81ea\u52a8\u673a\u2160 \u83ab\u961f\u89e3\u6cd5\uff0c\u4e0d\u8bb2\u8ff0 \u516b\u4e91\u84dd\u81ea\u52a8\u673a\u2161 \u6b63\u89e3\u4ee5\u53ca \u516b\u4e91\u84dd\u81ea\u52a8\u673a\u2160 \u90e8\u5206\u5206\u505a\u6cd5\u3002\n\n\u9996\u5148\u73c2\u4ee5\u53d1\u73b0\u64cd\u4f5c1\u548c\u64cd\u4f5c2\u540c\u65f6\u5b58\u5728\u5f88\u96be\u5904\u7406\uff0c\u8003\u8651\u4e00\u4e2a\u7b80\u5355\u7684\u8f6c\u5316\uff1a\u5c06\u6240\u6709\u64cd\u4f5c1\uff0c\u5373\u8d4b\u503c\u64cd\u4f5c\u8f6c\u5316\u4e3a\u64cd\u4f5c2\u3002\u8003\u8651\u5728\u6570\u7ec4\u4e2d\u5efa\u7acb\u4e00\u4e9b\u989d\u5916\u7684\u9879\uff0c\u5bf9\u4e8e `1 x k` \u64cd\u4f5c\uff0c\u6211\u4eec\u73c2\u4ee5\u63d0\u524d\u5efa\u7acb\u4e00\u4e2a\u503c\u4e3a $k$ \u7684\u9879 $a_y$\uff0c\u7136\u540e\u5c06\u4fee\u6539\u64cd\u4f5c\u8f6c\u5316\u6210 `2 x y`\uff0c\u5bb9\u6613\u8bc1\u660e\u8fd9\u4e24\u4e2a\u64cd\u4f5c\u662f\u5b8c\u5168\u7b49\u4ef7\u7684\u3002\u8fd9\u6837\u5c31\u53ea\u6709\u4ea4\u6362\u64cd\u4f5c\u548c\u5355\u70b9\u8be2\u95ee\u5566\u3002\n\n\u63a5\u4e0b\u6765\u8003\u8651\u83ab\u961f\uff08\u76f8\u4fe1\u5927\u5bb6\u90fd\u5df2\u7ecf\u719f\u7ec3\u638c\u63e1\u8fd9\u4e2a\u7b97\u6cd5\u5566\uff09\u3002\u5047\u8bbe\u73b0\u5728\u626b\u5230\u7684\u662f\u533a\u95f4 $[l,r]$\uff0c\u6211\u4eec\u7ef4\u62a4\u533a\u95f4 $[l,r]$ \u6240\u6709\u8be2\u95ee\u5f97\u5230\u7684\u7b54\u6848\u4e4b\u548c $ans$\uff0c\u4ee4\u4ea4\u6362\u540e\u7684\u5e8f\u5217\u4e3a $a'$\uff0c\u7ef4\u62a4\u5e8f\u5217 $b$ \u6ee1\u8db3 $a'_i=a_{b_i}$\uff0c\u7ef4\u62a4\u5e8f\u5217 $id$ \u6ee1\u8db3 $a'_{id_i}=a_i$\uff0c\u7ef4\u62a4\u5e8f\u5217 $c$ \u6ee1\u8db3 $c_i$ \u4e3a\u533a\u95f4 $[l,r]$ \u8be2\u95ee\u539f\u5e8f\u5217 $a_i$ \u7684\u8be2\u95ee\u6570\uff08\u4f8b\u5982\u4ea4\u6362 $a_2$ \u4e0e $a_3$\uff0c\u8be2\u95ee $a_3$\uff0c\u5373\u4e3a\u8be2\u95ee\u539f\u5e8f\u5217 $a_2$\uff09\u3002\u5e76\u5bf9\u4e8e\u7aef\u70b9\u7684\u632a\u52a8\u8fdb\u884c\u5206\u7c7b\u8ba8\u8bba\uff1a\n\n1. \u5de6\u7aef\u70b9\u5de6\u632a\uff0c\u5373\u626b\u5230\u7684\u533a\u95f4\u53d8\u6210\u4e86 $[l-1,r]$\uff0c\u8fd9\u65f6\u6709\u4e24\u79cd\u53ef\u80fd\uff1a\u52a0\u5165\u8be2\u95ee\u64cd\u4f5c\uff0c\u8bbe\u52a0\u5165\u7684\u8be2\u95ee\u64cd\u4f5c\u4e3a `3 x`\uff0c\u5c06 $ans$ \u52a0\u4e0a $a_x$\uff0c\u5e76\u5c06 $c_x$ \u52a0\u4e00\uff1b\u52a0\u5165\u4ea4\u6362\u64cd\u4f5c\uff0c\u8bbe\u52a0\u5165\u7684\u4ea4\u6362\u64cd\u4f5c\u4e3a `2 x y`\uff0c\u5c06 $b_{id_x}$ \u548c $b_{id_y}$ \u4ea4\u6362\uff0c\u4ea4\u6362 $id_x$ \u548c $id_y$\uff0c\u66f4\u65b0\u7b54\u6848\uff08\u4ee4\u539f\u7b54\u6848\u4e3a $ans$\uff0c\u65b0\u7684\u7b54\u6848\u4e3a $ans-c_x\\times a_x-c_y\\times a_y+c_x\\times a_y+c_y\\times a_x$\uff09\uff0c\u5e76\u5c06 $c_x$ \u4e0e $c_y$ \u4ea4\u6362\u3002\n\n2. \u5de6\u7aef\u70b9\u53f3\u632a\uff0c\u5373\u626b\u5230\u7684\u533a\u95f4\u53d8\u6210\u4e86 $[l+1,r]$\uff0c\u8fd9\u65f6\u6709\u4e24\u79cd\u53ef\u80fd\uff1a\u64a4\u9500\u8be2\u95ee\u64cd\u4f5c\uff0c\u8bbe\u64a4\u9500\u7684\u8be2\u95ee\u64cd\u4f5c\u4e3a `3 x`\uff0c\u5c06 $ans$ \u51cf\u53bb $a_x$ \u5373\u53ef\uff1b\u64a4\u9500\u4ea4\u6362\u64cd\u4f5c\uff0c\u7531\u4e8e\u5c06\u4e24\u4e2a\u6570\u8fdb\u884c\u4e24\u6b21\u4ea4\u6362\u64cd\u4f5c\u76f8\u5f53\u4e8e\u6ca1\u6709\u8fdb\u884c\u4ea4\u6362\u64cd\u4f5c\uff0c\u6240\u4ee5\u8bbe\u64a4\u9500\u7684\u4ea4\u6362\u64cd\u4f5c\u4e3a `2 x y`\uff0c\u5c06 $b_{id_x}$ \u548c $b_{id_y}$ \u4ea4\u6362\uff0c\u4ea4\u6362 $id_x$ \u548c $id_y$\uff0c\u66f4\u65b0\u7b54\u6848\uff08\u67ff\u5b50\u548c\u4e0a\u9762\u7684\u4e00\u6837\uff09\uff0c\u7136\u540e\u4ea4\u6362 $c_x$ \u4e0e $c_y$ \u7684\u503c\u5373\u53ef\u3002\n\n3. \u53f3\u7aef\u70b9\u53f3\u632a\uff0c\u5373\u626b\u5230\u7684\u533a\u95f4\u53d8\u6210\u4e86 $[l,r+1]$\uff0c\u4ea4\u6362\u64cd\u4f5c\u76f8\u4fe1\u5927\u5bb6\u90fd\u4f1a\uff08\u6ce8\u610f\u8981\u4ea4\u6362 $id_{b_x}$ \u548c $id_{b_y}$\uff09\uff0c\u8003\u8651\u52a0\u5165\u8be2\u95ee\u64cd\u4f5c\uff0c\u8bbe\u52a0\u5165\u7684\u8be2\u95ee\u64cd\u4f5c\u4e3a `3 x`\uff0c\u7531\u4e8e\u6211\u4eec\u7ef4\u62a4\u4e86\u5e8f\u5217 $b$ \uff0c\u53ea\u8981\u5c06 $ans$ \u52a0\u4e0a $a_{b_x}$\uff0c\u7136\u540e\u5c06 $c_{b_x}$ \u52a0\u4e00\u5c31\u884c\u5566\u3002\n\n4. \u53f3\u7aef\u70b9\u5de6\u632a\uff0c\u5373\u626b\u5230\u7684\u533a\u95f4\u53d8\u6210\u4e86 $[l,r-1]$\uff0c\u76f8\u4fe1\u5230\u8fd9\u91cc\u5927\u5bb6\u90fd\u4f1a\u4e86\uff0c\u51cf\u4e00\u51cf\u6216\u662f\u4ea4\u6362\u4e00\u4e0b\u5373\u53ef\uff0c\u4e0d\u518d\u8d58\u8ff0\u3002\n\n\u7136\u540e\u8fd9\u9053\u9898\u5c31\u505a\u5b8c\u5566\uff08\u6492\u82b1\uff09\uff0c\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n+m+q \\sqrt{m})$\uff0c\u56e0\u4e3a $n,m,q$ \u540c\u7ea7\uff0c\u6240\u4ee5\u4e8b $O(m\\sqrt{m})$ \u7684\uff08\u73c2\u4ee5\u6ce8\u610f\u5230 $n$ \u80fd\u5f00\u5230 $10^7$\uff0c\u4f46\u662f\u6ca1\u4ec0\u4e48\u610f\u4e49\uff09\u3002\n\n",
        "postTime": 1622962863,
        "uid": 330759,
        "name": "\u56e7\u4ed9",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 \u3010SR2.7-T4\u3011\u3010\u516b\u4e91\u84dd\u81ea\u52a8\u673a\u2160\u3011"
    },
    {
        "content": "\u6bd4\u8f83\u57fa\u7840\u7684\u9898\uff0c\u8003\u5bdf\u7ec6\u8282\u7684\u5904\u7406\u3002\n\n1 \u64cd\u4f5c\u663e\u7136\u53ef\u4ee5\u76f4\u63a5\u8f6c\u5316\u4e3a 2 \u64cd\u4f5c\uff0c\u8fd9\u6837\u65b9\u4fbf\u5f88\u591a\u3002\n\n\u8003\u8651\u83ab\u961f\uff0c\u4ee4 $p_x$ \u4e3a $x$ \u5bf9\u5e94\u4e4b\u524d\u54ea\u4e2a\u4f4d\u7f6e\uff0c$q_x$ \u4e3a\u4e4b\u524d\u4f4d\u7f6e\u4e3a $x$ \u7684\u4f4d\u7f6e\u73b0\u5728\u79fb\u52a8\u5230\u4e86\u54ea\u91cc\uff0c$t_x$ \u4e3a\u76ee\u524d\u7684 $x$ \u4f4d\u7f6e\u88ab\u8be2\u95ee\u8fc7\u591a\u5c11\u6b21\u3002\n\n\u79fb\u52a8\u5de6\u7aef\u70b9\uff0c\u64cd\u4f5c\u662f\u4ea4\u6362\uff1a\n\n- \u4ea4\u6362\u4e4b\u524d\u4f4d\u7f6e\u4e3a $x,y$ \u7684\u4e24\u4e2a\u4f4d\u7f6e\u7684\u6743\u503c\uff0c\u66f4\u65b0\u8fd9\u4e24\u4e2a\u4f4d\u7f6e\u7684 $p,q$\uff0c\u5373\uff1a\n\n`swap(a[q[x]],a[q[y]]);\nswap(p[q[x]],p[q[y]]);\nswap(q[x],q[y]);`\n\n- \u7edf\u8ba1\u56e0\u4e3a\u4ea4\u6362\u800c\u9020\u6210\u7684\u7b54\u6848\u53d8\u5316\u91cf\uff1a\n\n`res+=(a[q[x]]-a[q[y]])*(t[q[x]]-t[q[y]]);`\n\n\uff08\u5982\u679c\u662f\u5220\u9664\u8981\u628a\u987a\u5e8f\u6362\u4e00\u4e0b\uff09\n\n\u79fb\u52a8\u5de6\u7aef\u70b9\uff0c\u64cd\u4f5c\u662f\u67e5\u8be2\uff1a\n\n- \u7edf\u8ba1\u7b54\u6848\uff0c\u66f4\u65b0\u8be5\u70b9\u88ab\u8be2\u95ee\u7684\u6b21\u6570\uff1a\n\n`res+=a[q[x]];\ntot[q[x]+=1/-1;`\n\n\u79fb\u52a8\u53f3\u7aef\u70b9\uff0c\u64cd\u4f5c\u662f\u4ea4\u6362\uff1a\n\n`swap(a[x],a[y]);\nswap(p[x],p[y]);\nswap(q[p[x]],q[p[y]]);\nswap(tot[x],tot[y]);`\n\n\u79fb\u52a8\u53f3\u7aef\u70b9\uff0c\u64cd\u4f5c\u662f\u67e5\u8be2\uff1a\n\n`res+=a[x];\ntot[x]+=1/-1;`\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\sqrt n)$\u3002\n\n```\n#include<stdio.h>\n#include<algorithm>\nusing namespace std;\nconst int maxn=200005,S=450;\nint n,m,Q,T;\nint a[maxn<<1],oo[maxn],xx[maxn],yy[maxn],bel[maxn],bl[maxn],br[maxn],p[maxn<<1],q[maxn<<1],tot[maxn<<1];\n//p nowpos->oldpos q oldpos->nowpos\nunsigned int now;\nunsigned int ans[maxn];\nstruct node {\n\tint x,y,id;\n} c[maxn];\ninline int cmp(node a,node b) {\n\treturn bel[a.x]^bel[b.x]? a.x<b.x:a.y<b.y;\n}\nvoid lmodify(int t,int v) {\n\tint o=oo[t],x=xx[t],y=yy[t];\n\tif(o==2) {\n\t\tif(v==1)\n\t\t\tswap(a[q[x]],a[q[y]]),swap(p[q[x]],p[q[y]]),swap(q[x],q[y]);\n\t\tnow+=(unsigned int)v*(a[q[x]]-a[q[y]])*(tot[q[x]]-tot[q[y]]);\n\t\tif(v==-1)\n\t\t\tswap(a[q[x]],a[q[y]]),swap(p[q[x]],p[q[y]]),swap(q[x],q[y]);\n\t}\n\tif(o==3)\n\t\tnow+=v*a[q[x]],tot[q[x]]+=v;\n}\nvoid rmodify(int t,int v) {\n\tint o=oo[t],x=xx[t],y=yy[t];\n\tif(o==2)\n\t\tswap(a[x],a[y]),swap(p[x],p[y]),swap(q[p[x]],q[p[y]]),swap(tot[x],tot[y]);\n\tif(o==3)\n\t\tnow+=v*a[x],tot[x]+=v;\n}\nint main() {\n\tscanf(\"%d%d\",&n,&m),T=m/S;\n\tfor(int i=1; i<=T; i++)\n\t\tbl[i]=br[i-1]+1,br[i]=i*S;\n\tif(br[T]<m)\n\t\tT++,bl[T]=br[T-1]+1,br[T]=m;\n\tfor(int i=1; i<=T; i++)\n\t\tfor(int j=bl[i]; j<=br[i]; j++)\n\t\t\tbel[j]=i;\n\tfor(int i=1; i<=n; i++)\n\t\tscanf(\"%d\",&a[i]),p[i]=q[i]=i;\n\tfor(int i=1; i<=m; i++) {\n\t\tscanf(\"%d%d\",&oo[i],&xx[i]);\n\t\tif(oo[i]!=3)\n\t\t\tscanf(\"%d\",&yy[i]);\n\t\tif(oo[i]==1)\n\t\t\tn++,p[n]=q[n]=n,a[n]=yy[i],oo[i]=2,yy[i]=n;\n\t}\n\tscanf(\"%d\",&Q);\n\tfor(int i=1; i<=Q; i++)\n\t\tscanf(\"%d%d\",&c[i].x,&c[i].y),c[i].id=i;\n\tsort(c+1,c+1+Q,cmp);\n\tint x=1,y=0;\n\tfor(int i=1; i<=Q; i++) {\n\t\tint qx=c[i].x,qy=c[i].y,qid=c[i].id;\n\t\twhile(x>qx)\n\t\t\tx--,lmodify(x,1);\n\t\twhile(y<qy)\n\t\t\ty++,rmodify(y,1);\n\t\twhile(x<qx)\n\t\t\tlmodify(x,-1),x++;\n\t\twhile(y>qy)\n\t\t\trmodify(y,-1),y--;\n\t\tans[qid]=now;\n\t}\n\tfor(int i=1; i<=Q; i++)\n\t\tprintf(\"%u\\n\",ans[i]);\n\treturn 0;\n}\n```",
        "postTime": 1651992825,
        "uid": 105611,
        "name": "IdnadRev",
        "ccfLevel": 0,
        "title": "\u3010DS\u8bb0\u5f55\u3011P7708 \u300cWdsr-2.7\u300d\u516b\u4e91\u84dd\u81ea\u52a8\u673a \u2160"
    }
]