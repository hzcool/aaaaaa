[
    {
        "content": "# \u5e73\u8861\u6811\u677f\u5b50\n\n\u9898\u76ee\u8981\u6c42\u7ef4\u62a4\u5f88\u591a\u6761\u94fe\uff0c\u4e0d\u96be\u60f3\u5230\u7528\u5e73\u8861\u6811\uff0c\u4e2a\u4eba\u7528\u7684\u662f fhq treap \u3002\n\n\u5c06\u8fb9\u5316\u6210\u70b9\uff0c\u6bcf\u4e00\u68f5 treap \u90fd\u4ee5\u70b9\u8fb9\u70b9\u7684\u987a\u5e8f\u5b58\u4e86\u4e00\u6761\u94fe\uff0c\u4ee3\u8868\u8fb9\u7684\u70b9\u6743\u503c\u4e3a\u8fb9\u6743\uff0c\u4ee3\u8868\u70b9\u7684\u70b9\u6743\u503c\u4e3a  $0$  \u3002\n\n## \u64cd\u4f5c\u4e00\n\n\u52a0\u8fb9\u64cd\u4f5c\uff0c\u5408\u6cd5\u7684\u6761\u4ef6\u662f\uff1a\n\n- \u4e0d\u5728\u540c\u4e00\u68f5\u5b50\u6811\u3002\n\n- \u4e24\u4e2a\u70b9\u90fd\u5728\u94fe\u5934\u6216\u94fe\u5c3e\uff0c\u5373\u4e2d\u5e8f\u904d\u5386\u6700\u5927\u6216\u6700\u5c0f\u3002\n\n\u5982\u679c  $x,y$  \u540c\u65f6\u5728\u94fe\u5934\u6216\u540c\u65f6\u5728\u94fe\u5c3e\u8fd8\u8981\u7ffb\u8f6c\u4e00\u4e0b treap \u3002\n\n\u7136\u540e\u628a  $x$  \u653e\u6700\u540e\uff0c  $y$  \u653e\u6700\u524d\uff0c\u4e24\u68f5\u6811\u4e4b\u95f4\u63d2\u5165\u8fb9\u6743\u4e3a  $z$  \u7684\u4e00\u4e2a\u4ee3\u8868\u8fb9\u7684\u70b9\uff0c\u5408\u8d77\u6765\u5c31\u884c\u3002\n\n## \u64cd\u4f5c\u4e8c\n\n\u5220\u8fb9\u64cd\u4f5c\uff0c\u5408\u6cd5\u7684\u6761\u4ef6\u662f\uff1a\n\n- \u5728\u540c\u4e00\u68f5\u5b50\u6811\n\n- \u4e24\u4e2a\u70b9\u4e4b\u95f4\u53ea\u9694\u4e86\u4e00\u4e2a\u4ee3\u8868\u8fb9\u7684\u70b9\u3002\n\n\u6ee1\u8db3\u6761\u4ef6\u5c31\u76f4\u63a5\u628a\u90a3\u4e2a\u4ee3\u8868\u8fb9\u7684\u70b9\u62c6\u6389\u5c31\u884c\u3002\n\n## \u64cd\u4f5c\u4e09\n\n\u672c\u8d28\u4e0a\u4e0e\u4e0a\u9762\u4e24\u4e2a\u4e00\u6837\uff0c\u8bfb\u8005\u81ea\u884c\u7406\u89e3\u3002\n\n## \u64cd\u4f5c\u56db\n\n\u5224\u65ad\u4e00\u4e0b\u6839\u662f\u5426\u76f8\u7b49\u5c31\u597d\u3002\n\n## \u64cd\u4f5c\u4e94\n\n\u9996\u5148\u8fd8\u662f\u5224\u65ad  $x,y$  \u662f\u5426\u540c\u6839\uff0c\u4e0d\u540c\u6839\u76f4\u63a5\u8fd4\u56de\u3002\n\n\u7136\u540e\u6bd4\u8f83\u4e00\u4e0b  $x,y$  \u5728 treap \u4e2d\u6392\u540d\u7684\u5927\u5c0f\uff0c\u4e0d\u59a8\u8bbe\u4e3a  $rx,ry$  \u3002\n\n- \u5982\u679c  $rx<ry$  \uff0c\u8981\u5f80\u53f3\u8fb9\u8d70\uff0c\u4e8e\u662f\u7ec8\u70b9\u5c31\u662f\u6700\u53f3\u7aef\u7684\u70b9\uff0c\u65f6\u95f4\u4e3a  $x$  \u8282\u70b9\u540e\u7684\u8fb9\u6743\u548c\u3002\n\n\n- \u5982\u679c  $rx>ry$  \uff0c\u8981\u5f80\u5de6\u8fb9\u8d70\uff0c\u4e8e\u662f\u7ec8\u70b9\u5c31\u662f\u6700\u5de6\u7aef\u7684\u70b9\uff0c\u65f6\u95f4\u4e3a  $x$  \u8282\u70b9\u524d\u7684\u8fb9\u6743\u548c\u3002\n\n## \u5b9e\u73b0\u7ec6\u8282\n\n\u6709\u51e0\u4e2a\u5751\u70b9\u63d0\u4e00\u4e0b\uff1a\n\n- \u67e5\u8be2\u6839\u548c\u6392\u540d\u9700\u8981\u7ef4\u62a4\u8282\u70b9\u7236\u4eb2\uff0c\u7136\u540e\u4ece\u5f53\u524d\u8282\u70b9\u5f80\u4e0a\u8df3\u7edf\u8ba1\u7b54\u6848\u3002\n\n- \u67e5\u8be2\u6392\u540d\u65f6\u4e00\u5b9a\u8981\u91ca\u653e\u4ece\u6839\u5230\u5b83\u7684\u6240\u6709\u7ffb\u8f6c\u6807\u8bb0\u3002\n\n## \u4ee3\u7801\n\n```\n#include<cstdio>\n#include<cstdlib>\n#define rep(a,b,c) for(int c=(a);c<=(b);++c)\n#define drep(a,b,c) for(int c=(a);c>=(b);--c)\ninline int read()\n{\n\tint res=0;char ch=getchar();while(ch<'0'||ch>'9')ch=getchar();\n\twhile(ch<='9'&&ch>='0')res=res*10+(ch^48),ch=getchar();return res;\n}\ninline int Get()\n{\n\tchar ch;do ch=getchar();while(ch<'a'||ch>'z');switch(ch)\n\t{\n\t\tcase 'a': return 1;case 'c': return 3;case 'r': return 4;\n\t\tcase 'd': getchar();return getchar()=='l'?2:5;\n\t}return 0;\n}\ninline void print(const int &p){if(p>9)print(p/10);putchar(p%10+'0');}\ninline void pt(const int &p,const char &ch='\\n'){print(p<0?putchar('-'),-p:p);putchar(ch);}\ntemplate<typename T> inline void Swap(T&x,T&y){T tmp=x;x=y;y=tmp;}\nconst int N=1e5+10;int T1,T2,T3,n,cgt;\nstruct FHQ{int l,r,siz,vl,sm,fa;bool tg;short key;inline FHQ(){key=rand();siz=1;}}t[N<<2];\ninline void Rev(int x){Swap(t[x].l,t[x].r);t[x].tg^=1;}\ninline void pushdown(int x){if(t[x].tg)Rev(t[x].l),Rev(t[x].r),t[x].tg=false;}\ninline void update(int x)\n{\n\tt[x].siz=t[t[x].l].siz+t[t[x].r].siz+1;\n\tt[x].sm=t[t[x].l].sm+t[t[x].r].sm+t[x].vl;\n\tt[t[x].l].fa=t[t[x].r].fa=x;t[x].fa=0;\n}\ninline void split(int cur,int k,int &x,int &y)\n{\n\tif(!cur){x=y=0;return;}pushdown(cur);\n\tif(t[t[cur].l].siz>=k){y=cur;split(t[cur].l,k,x,t[cur].l);update(y);return;}\n\tx=cur;split(t[cur].r,k-t[t[cur].l].siz-1,t[cur].r,y),update(x);\n}\ninline int merge(int x,int y)\n{\n\tif(!x||!y)return x|y;pushdown(x);pushdown(y);\n\tif(t[x].key<t[y].key){t[x].r=merge(t[x].r,y);update(x);return x;}\n\tt[y].l=merge(x,t[y].l);update(y);return y;\n}\ninline int fnd(int x){while(t[x].fa)x=t[x].fa;return x;}\ninline void pushall(int x){if(t[x].fa)pushall(t[x].fa);pushdown(x);}\ninline int rnk(int k){pushall(k);int r=t[t[k].l].siz;while(t[k].fa){r+=(k==t[t[k].fa].r)?t[t[t[k].fa].l].siz+1:0;k=t[k].fa;}return r+1;}\ninline void add(int x,int y,int z)\n{\n\tint fx=fnd(x),fy=fnd(y);\n\tif(fx==fy)return puts(\"ERROR\"),void();\n\tint rx=rnk(x),ry=rnk(y);\n\tif((rx==1||rx==t[fx].siz)&&(ry==1||ry==t[fy].siz))\n\t{\n\t\tif(rx==1)Swap(x,y),Swap(fx,fy),Swap(rx,ry);\n\t\tif(rx==1)Rev(fx);if(ry==t[fy].siz)Rev(fy);\n\t\tt[++cgt].siz=1;t[cgt].vl=t[cgt].sm=z;merge(merge(fx,cgt),fy);puts(\"OK\");\n\t}\n\telse puts(\"ERROR\");\n}\ninline void del(int x,int y)\n{\n\tint fx=fnd(x),fy=fnd(y);if(fx!=fy)return puts(\"ERROR\"),void();\n\tint rx=rnk(x),ry=rnk(y);if(rx>ry)Swap(rx,ry),Swap(fx,fy),Swap(x,y);\n\tif(ry!=rx+2)puts(\"ERROR\");else{split(fx,rx,T1,T2);split(T2,1,T1,T3);puts(\"OK\");}\n}\ninline void chg(int x,int y,int z)\n{\n\tint fx=fnd(x),fy=fnd(y);if(fx!=fy)return puts(\"ERROR\"),void();\n\tint rx=rnk(x),ry=rnk(y);if(rx>ry)Swap(rx,ry),Swap(fx,fy),Swap(x,y);\n\tif(ry!=rx+2)return puts(\"ERROR\"),void();\n\tsplit(fx,rx,T1,T2);split(T2,1,T2,T3);t[T2].sm=t[T2].vl=z;\n\tmerge(merge(T1,T2),T3);puts(\"OK\");\n}\ninline void qry(int x,int y)\n{\n\tint fx=fnd(x),fy=fnd(y);if(fx!=fy)return puts(\"ERROR\"),void();\n\tint rx=rnk(x),ry=rnk(y);if(rx<ry)\n\t{\n\t\tint c=fx;while(t[c].r)pushdown(c),c=t[c].r,pushdown(c);pt(c,' ');\n\t\tsplit(fx,rx,T1,T2);pt(t[T2].sm);merge(T1,T2);\n\t}\n\telse\n\t{\n\t\tint c=fx;while(t[c].l)pushdown(c),c=t[c].l,pushdown(c);pt(c,' ');\n\t\tsplit(fx,rx,T1,T2);pt(t[T1].sm);merge(T1,T2);\n\t}\n}\nint main()\n{\n\tt[0].siz=0;cgt=n=read();int Q=read();rep(1,Q,i)\n\t{\n\t\tint opt=Get(),x=read(),y=read();\n\t\tswitch(opt)\n\t\t{\n\t\t\tcase 4: puts(fnd(x)==fnd(y)?\"YES\":\"NO\");break;\n\t\t\tcase 1: add(x,y,read());break;case 2: del(x,y);break;\n\t\t\tcase 3: chg(x,y,read());break;case 5: qry(x,y);break; \n\t\t}\n\t}\n}\n```",
        "postTime": 1642069104,
        "uid": 191281,
        "name": "Jr_Zlw",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 [JSOI2013]\u516c\u4ea4\u7cfb\u7edf"
    }
]