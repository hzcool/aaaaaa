[
    {
        "content": "\u6211\u4eec\u53d1\u73b0\u7b97\u65b9\u6848\u6570\u5f88\u9ebb\u70e6\uff0c\u4e8e\u662f\u8003\u8651\u8ba1\u7b97\u8282\u70b9 $0$ \u7684\u503c\u4e3a $1$ \u7684\u6982\u7387\u3002\u8bbe $f_{i,j}$ \u8868\u793a\u4ee5 $i$ \u4e3a\u6839\u7684\u5b50\u6811\uff0c$i$ \u7684\u4f4d\u7f6e\u53c2\u6570\u4e3a $j$ \u65f6\uff0c$i$ \u7684\u503c\u4e3a $1$ \u7684\u6982\u7387\u3002\n\n\u4f46\u8fd9\u6837\u663e\u7136\u662f\u8fc7\u4e0d\u53bb\u7684\uff0c\u8003\u8651\u8bb0 $c_i$ \u8868\u793a $i$ \u7684\u513f\u5b50\u6570\uff0c$g_x=\\dfrac{1}{c_x}\\sum\\limits_{i=1}^{c_x}f_{x,i}$\uff0c\u6211\u4eec\u53d1\u73b0\u6211\u4eec\u53ea\u5173\u5fc3 $g_x$ \u7684\u503c\uff0c\u8003\u8651\u5316\u7b80\u3002\n\n\u4e3a\u4e86\u65b9\u4fbf\uff0c\u8bb0 $x$ \u7684\u513f\u5b50\u4f9d\u6b21\u4e3a $a_1,a_2,a_3,\\dots,a_{c_x}$\uff0c\u8bb0 $p_1=\\sum\\limits_{i=1}^{c_x} g_{a_i}$\uff0c$p_2=\\sum\\limits_{i<j}g_{a_i}\\times g_{a_j}$\uff0c\u4ee5\u4e0b\u4ee5\u6b64\u7c7b\u63a8\u3002\u90a3\u4e48\u6839\u636e\u5bb9\u65a5\u539f\u7406\uff0c\u6709\uff1a\n\n$$f_{x,1}=p_1-p_2+p_3-p_4+p_5\\dots$$\n\n$$f_{x,2}=p_2-2p_3+3p_4-4p_5\\dots$$\n\n$$f_{x,3}=p_3-3p_4\\dots+6p_5$$\n\n$$f_{x,4}=p_4-4p_5\\dots$$\n\n\u901a\u8fc7\u89c2\u5bdf\u6211\u4eec\u53d1\u73b0\u540e\u9762\u51e0\u9879\u5728\u52a0\u8d77\u6765\u7684\u65f6\u5019\u90fd\u80fd\u88ab\u6d88\u6389\uff0c\u4e8e\u662f\u6709 $g_x=\\dfrac{1}{c_x}p_1=\\sum\\limits_{i=1}^{c_x}g_{a_i}$\u3002\n\n\u90a3\u4e48\u4e00\u4e2a\u53f6\u5b50\u8282\u70b9\u5bf9\u6982\u7387\u7684\u8d21\u732e\u5c31\u662f\u81ea\u8eab\u7684\u521d\u59cb\u503c\u9664\u4ee5**\u6240\u6709\u5728\u8fd9\u4e2a\u53f6\u5b50\u8282\u70b9\u5230\u6839\u7684\u8def\u5f84\u4e0a\u7684\u8282\u70b9\u7684\u513f\u5b50\u6570\u7684\u79ef**\u3002\u7531\u4e8e\u7b54\u6848\u8fd8\u8981\u4e58\u4e0a $\\prod\\limits_{i=0}^{n+m-1}c_i$\uff0c\u6240\u4ee5\u4e00\u4e2a\u8282\u70b9\u7684\u8d21\u732e\u5c31\u662f\u6240\u6709\u4e0d\u5728\u8fd9\u4e2a\u53f6\u5b50\u8282\u70b9\u5230\u6839\u7684\u8def\u5f84\u4e0a\u7684\u8282\u70b9\u7684\u513f\u5b50\u6570\u7684\u79ef\u4e58\u4e0a\u81ea\u8eab\u521d\u59cb\u6743\u503c\u3002\u8fd9\u4e2a\u53ef\u4ee5\u5728 dfs \u65f6\u987a\u4fbf\u6c42\u51fa\u3002\n\n\u81f3\u4e8e\u533a\u95f4\u7ffb\u8f6c\uff0c\u5728\u7ebf\u6bb5\u6811\u4e0a\u7ef4\u62a4\u4e24\u4e2a\u503c $s_0$\uff0c$s_1$ \u8868\u793a\u533a\u95f4\u5185\u6743\u503c\u4e3a $0$ \u7684\u8d21\u732e\u548c\u4ee5\u53ca\u6743\u503c\u4e3a $1$ \u7684\u8d21\u732e\u548c\u5373\u53ef\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a$\\Theta(n+m+q\\log m)$\n\nCode:\n\n```cpp\n#include <cstdio>\n#include <algorithm>\n#include <vector>\n#include \"circuit.h\"\nusing namespace std ;\nconst int MAXN = 2e5 + 10 , mod = 1000002022 ;\ntypedef long long ll ;\ntypedef vector<int> vi ;\nint n , m , a[MAXN] , fir[MAXN] , tot , id[MAXN] , f[MAXN] ;\nll mul[MAXN] , w[MAXN] , pre[MAXN] , suf[MAXN] ;\nstruct edge {int to , nxt ;} e[MAXN] ;\nvoid add (int u , int v) {\n\te[++tot].to = v ; e[tot].nxt = fir[u] ; fir[u] = tot ;\n}\nvoid dfs1 (int x) {\n\tint cnt = 0 ; \n\tfor (int i = fir[x] ; i ; i = e[i].nxt) cnt++ ;\n\tif (!fir[x]) mul[x] = 1 ;\n\telse mul[x] = cnt ;\n\tfor (int i = fir[x] ; i ; i = e[i].nxt)\n\t\tdfs1 (e[i].to) , mul[x] = mul[x] * mul[e[i].to] % mod ;\n}\nvoid dfs2 (int x) {\n\tif (!fir[x]) return ;\n\tint cnt = 0 ; \n\tfor (int i = fir[x] ; i ; i = e[i].nxt)\n\t\tid[e[i].to] = ++cnt , pre[cnt] = suf[cnt] = mul[e[i].to] ;\n\tpre[0] = suf[cnt + 1] = 1 ;\n\tfor (int i = 2 ; i <= cnt ; i++) pre[i] = pre[i - 1] * pre[i] % mod ;\n\tfor (int i = cnt - 1 ; i ; i--) suf[i] = suf[i + 1] * suf[i] % mod ;\n\tfor (int i = fir[x] ; i ; i = e[i].nxt) {\n\t\tint v = e[i].to ;\n\t\tw[v] = w[x] * pre[id[v] - 1] % mod * suf[id[v] + 1] % mod ;\n\t}\n\tfor (int i = fir[x] ; i ; i = e[i].nxt) dfs2 (e[i].to) ;\n}\n#define lc (o << 1)\n#define rc (o << 1 | 1)\n#define mid ((l + r) >> 1)\nll s0[MAXN << 2] , s1[MAXN << 2] ;\nint lz[MAXN << 2] ;\nvoid build (int o , int l , int r) {\n\tif (l == r) {f[l] ? (s1[o] = w[l + n - 1]) : (s0[o] = w[l + n - 1]) ; return ;}\n\tbuild (lc , l , mid) , build (rc , mid + 1 , r) ;\n\ts0[o] = (s0[lc] + s0[rc]) % mod , s1[o] = (s1[lc] + s1[rc]) % mod ;\n}\nvoid pushdown (int o) {\n\tif (!o || !lz[o]) return ;\n\tswap (s0[lc] , s1[lc]) , swap (s0[rc] , s1[rc]) , lz[lc] ^= 1 , lz[rc] ^= 1 , lz[o] = 0 ;\n}\nvoid upd (int o , int l , int r , int x , int y) {\n\tif (x <= l && r <= y) {lz[o] ^= 1 , swap (s0[o] , s1[o]) ; return ;}\n\tpushdown (o) ;\n\tif (x <= mid) upd (lc , l , mid , x , y) ;\n\tif (mid < y) upd (rc , mid + 1 , r , x , y) ;\n\ts0[o] = (s0[lc] + s0[rc]) % mod , s1[o] = (s1[lc] + s1[rc]) % mod ;\n}\nvoid init (int N , int M , vi p , vi a) {\n\tn = N , m = M ;\n\tfor (int i = 1 ; i < n + m ; i++) add (p[i] , i) ;\n\tfor (int i = 0 ; i < m ; i++) f[i + 1] = a[i] ;\n\tdfs1 (0) , w[0] = 1 , dfs2 (0) ;\n\tbuild (1 , 1 , m) ;\n}\nint count_ways (int x , int y) {\n\tupd (1 , 1 , m , x - n + 1 , y - n + 1) ;\n\treturn s1[1] ;\n}\n```",
        "postTime": 1661952180,
        "uid": 122641,
        "name": "GIFBMP",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P8493 [IOI2022]\u6570\u5b57\u7535\u8def"
    },
    {
        "content": "\u7ed9\u4e2a\u751f\u8349\u63a8\u6cd5\u3002\n\n\u4ee4 $f_u$ \u4e3a\u53ea\u8003\u8651 $u$ \u5b50\u6811\uff0c\u4f7f\u5f97 $u$ \u4e3a $1$ \u7684\u5408\u6cd5\u65b9\u6848\u6570\uff1b$s_u$ \u4e3a $u$ \u5b50\u6811\u7684\u603b\u65b9\u6848\u6570\u3002$s$ \u5bb9\u6613\u8ba1\u7b97\uff0c\u8003\u8651\u5982\u4f55\u4ece $u$ \u513f\u5b50\u7684 $f$ \u5f97\u5230 $f_u$\u3002\u53d1\u73b0\u76f8\u5f53\u4e8e\u5bf9\u6bcf\u79cd\u9009 $i$ \u4e2a\u4e3a $1$ \u7684\u513f\u5b50\u7684\u65b9\u6848\uff0c\u628a\u5b83\u4eec\u7684 $f$ \u548c\u5176\u4ed6\u513f\u5b50\u7684 $s-f$ \u4e58\u8d77\u6765\uff0c\u7136\u540e\u518d\u4e58\u4e0a $i$\uff0c\u8fd9\u662f\u8fd9\u79cd\u65b9\u6848\u7684\u8d21\u732e\u3002\n\n\u2014\u2014\u8fd9\u53ef\u4ee5\u7528\u751f\u6210\u51fd\u6570\u63cf\u8ff0\u3002\u8bb0 $F_u(x)=f_ux+s_u-f_u$\uff0c$C_u$ \u4e3a $u$ \u7684\u513f\u5b50\u96c6\u5408\uff0c$P_u(x)=\\prod\\limits_{v\\in C_u}F_v(x)$\uff0c\u5219 $f_u=P_u'(1)$\u3002\u8981\u6c42\u51fa $P_u'(1)$\uff0c\u6211\u4eec\u53ea\u5173\u5fc3\u6bcf\u4e2a $v$ \u7684 $F_v(1)$ \u548c $F_v'(1)$\uff0c\u5373 $s_v$ \u548c $f_v$\u3002\n\n\u90a3\u4e48\u6839\u636e\u4e58\u6cd5\u6c42\u5bfc\u6cd5\u5219\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\uff1a\n$$f_u=\\sum_{v\\in C_u}f_v\\prod_{w\\in C_u,w\\ne v}s_w$$\n\u8fd9\u4e2a\u5f62\u5f0f\u5c31\u5f88\u6f02\u4eae\u4e86\u3002\u63a5\u4e0b\u6765\u5c31\u987a\u7406\u6210\u7ae0\uff0c\u53d1\u73b0\u6bcf\u4e2a\u53f6\u5b50\u5bf9 $f_0$ \u7684\u8d21\u732e\u90fd\u662f\u7ebf\u6027\uff0c\u7cfb\u6570\u53ef\u4ee5 dfs \u6c42\u51fa\u6765\uff0c\u7ebf\u6bb5\u6811\u7ef4\u62a4\u5373\u53ef\u3002\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nusing ll=long long;\nconst int maxn=1e5+5;\nint n,m;\nvector<int> g[maxn];\nbool a[maxn];\nconst ll mod=1e9+2022;\nll s[maxn*2];\nvoid dfs1(int u){\n\tif(u>=n){\n\t\ts[u]=1;\n\t\treturn;\n\t}\n\ts[u]=g[u].size();\n\tfor(int v:g[u]){\n\t\tdfs1(v);\n\t\ts[u]=s[u]*s[v]%mod;\n\t}\n}\nll b[maxn*2];\nvoid dfs2(int u){\n\tif(u>=n) return;\n\tvector<ll> s1(g[u].size()+1),s2(g[u].size()+1);\n\ts1[0]=1;\n\tfor(int i=0;i<(int)g[u].size();i++) s1[i+1]=s1[i]*s[g[u][i]]%mod;\n\ts2[g[u].size()]=1;\n\tfor(int i=(int)g[u].size()-1;i>=0;i--) s2[i]=s2[i+1]*s[g[u][i]]%mod;\n\tfor(int i=0;i<(int)g[u].size();i++){\n\t\tint v=g[u][i];\n\t\tb[v]=b[u]*s1[i]%mod*s2[i+1]%mod;\n\t\tdfs2(v);\n\t}\n}\nstruct node{\n\tint l,r;\n\tnode* ch[2];\n\tll s1,s2;\n\tbool flip=0;\n\tvoid pushup(){\n\t\ts1=(ch[0]->s1+ch[1]->s1)%mod;\n\t\ts2=(ch[0]->s2+ch[1]->s2)%mod;\n\t}\n\tnode(int l,int r):l(l),r(r){\n\t\tif(l==r){\n\t\t\ts1=a[r]?b[n+r]:0;\n\t\t\ts2=a[r]?0:b[n+r];\n\t\t\treturn;\n\t\t}\n\t\tint mid=l+(r-l)/2;\n\t\tch[0]=new node(l,mid);\n\t\tch[1]=new node(mid+1,r);\n\t\tpushup();\n\t}\n\tvoid pushtag(){\n\t\tswap(s1,s2);\n\t\tflip^=1;\n\t}\n\tvoid pushdown(){\n\t\tif(flip){\n\t\t\tch[0]->pushtag();\n\t\t\tch[1]->pushtag();\n\t\t\tflip=0;\n\t\t}\n\t}\n\tvoid modify(int ql,int qr){\n\t\tif(ql>r||qr<l) return;\n\t\tif(ql<=l&&qr>=r){\n\t\t\tpushtag();\n\t\t\treturn;\n\t\t}\n\t\tpushdown();\n\t\tch[0]->modify(ql,qr);\n\t\tch[1]->modify(ql,qr);\n\t\tpushup();\n\t}\n}*rt;\nvoid init(int _n,int _m,vector<int> fa,vector<int> _a){\n\tn=_n;\n\tm=_m;\n\tfor(int i=0;i<m;i++) a[i]=_a[i];\n\tfor(int i=1;i<n+m;i++) g[fa[i]].push_back(i);\n\tdfs1(0);\n\tb[0]=1;\n\tdfs2(0);\n\trt=new node(0,m-1);\n}\nint count_ways(int l,int r){\n\trt->modify(l-n,r-n);\n\treturn rt->s1;\n}\n```",
        "postTime": 1663034072,
        "uid": 174045,
        "name": "FZzzz",
        "ccfLevel": 0,
        "title": "P8493 [IOI2022] \u6570\u5b57\u7535\u8def"
    },
    {
        "content": "# P8493 \u9898\u89e3\n\n\n\n## \u601d\u8def\u5206\u6790\n\n\u9996\u5148\uff0c\u6211\u4eec\u628a\u8ba1\u6570\u95ee\u9898\u8f6c\u6210\u6982\u7387\u95ee\u9898\uff0c\u5047\u8bbe\u6bcf\u4e2a\u70b9\u7684\u9608\u503c\u662f\u5bf9\u5e94\u8303\u56f4\u5185\u7684\u4e00\u4e2a\u968f\u673a\u6574\u6570\uff0c\u7528 $f_u$ \u8868\u793a\u6b64\u65f6 $u$ \u7684\u503c\u4e3a $1$ \u7684\u6982\u7387\u3002\n\n\u8003\u8651 $u$ \u7684\u6240\u6709\u513f\u5b50 $v\\in\\operatorname{son}(u)$\uff0c\u6211\u4eec\u80fd\u6c42\u51fa $\\operatorname{son}(u)$ \u4e2d $1$ \u7684\u671f\u671b\u6570\u91cf\uff0c\u8bbe $c_u$ \u8868\u793a $\\operatorname{son}(u)$ \u4e2d $1$ \u7684\u4e2a\u6570\uff0c\u90a3\u4e48\uff1a$E(c_u)=\\sum_{v\\in\\operatorname{son}(v)}f_v$\u3002\n\n\u63a5\u4e0b\u6765\u8003\u8651\u5982\u4f55\u901a\u8fc7 $E(c_u)$ \u63a8\u51fa $f_u$\uff0c\u6211\u4eec\u53ef\u4ee5\u628a $E(c_u)$ \u6309\u5b9a\u4e49\u5bf9\u4e8e\u4e0d\u540c\u7684 $c_u$ \u7ed9\u62c6\u5f00\uff0c\u5373\u4ee4 $g_{u,i}$ \u8868\u793a $\\operatorname{son}(u)$ \u4e2d\u51fa\u73b0\u6070\u597d $i$ \u4e2a $1$ \u7684\u6982\u7387\uff0c\u8bbe $|\\operatorname{son}(u)|=s_u$\uff0c\u90a3\u4e48\u6211\u4eec\u6709 $\\sum_{i=1}^{s_u} i\\times g_{u,i}=E(c_u)$\uff0c\u8fd9\u662f\u6839\u636e\u671f\u671b\u7684\u5b9a\u4e49\u63a8\u51fa\u7684\u3002\n\n\u663e\u7136\uff0c\u4e3a\u4e86\u6c42\u51fa $f_u$\uff0c\u6211\u4eec\u53ea\u9700\u5bf9\u4e8e\u6bcf\u4e2a $i\\in[1,s_u]$ \u6c42\u51fa\uff1a\u5f53 $\\operatorname{son}(u)$ \u4e2d\u6709\u6070\u597d $i$ \u4e2a $1$ \u65f6\uff0c$u$ \u7684\u503c\u4e3a $1$ \u7684\u6982\u7387\uff0c\u663e\u7136\uff0c\u6b64\u65f6\u9608\u503c\u5e94\u8be5 $\\le i$\uff0c\u800c\u9608\u503c\u7684\u603b\u53d6\u503c\u5171\u6709 $s_u$ \u79cd\uff0c\u56e0\u6b64\u6b64\u65f6\u6709 $\\dfrac i{s_u}$ \u7684\u6982\u7387\u4f7f\u5f97 $u$ \u7684\u503c\u4e3a $1$\uff0c\u5c06\u5bf9\u5e94\u7684 $i$ \u7684\u8d21\u732e\u76f8\u52a0\u5f97\u5230\uff1a$f_u=\\sum_{i=1}^{s_u}\\dfrac i{s_u}\\times g_{u,i}$\u3002\n\n\u8054\u7acb\u4e24\u5f0f\uff0c\u6211\u4eec\u77e5\u9053 $f_u=\\dfrac1{s_u}\\sum_{i=1}^{s_u} i\\times g_{u,i}=\\dfrac{E(c_u)}{s_u}=\\dfrac 1{s_u}\\sum_{v\\in\\operatorname{son}(v)}f_v$\uff0c\u56e0\u6b64\u6211\u4eec\u5f97\u5230\u4e86 $f_u$ \u7684\u8f6c\u79fb\u3002\n\n\u6ce8\u610f\u5230 $f_u$ \u7684\u8f6c\u79fb\u5f62\u5f0f\u662f\u7ebf\u6027\u7684\uff0c\u56e0\u6b64\u6bcf\u4e2a\u53f6\u5b50\u7ed3\u70b9\u5bf9 $f_0$ \u7684\u8d21\u732e\u4e5f\u662f\u7ebf\u6027\u7684\uff0c\u51c6\u786e\u6765\u8bf4\uff1a\u67d0\u4e2a\u53f6\u5b50 $v$ \u5bf9 $f_0$ \u7684\u8d21\u732e\u662f $\\prod_{u\\in\\operatorname{path}(v,0)} \\dfrac{1}{s_u}$\uff08\u5ffd\u7565 $s_u=0$ \u7684\u9879\uff0c\u5373\u4e0d\u8003\u8651\u53f6\u5b50\u7ed3\u70b9\u7684\u8d21\u732e\uff09\u3002\n\n\u56de\u5230\u539f\u6765\u7684\u8ba1\u6570\u95ee\u9898\u4e0a\uff0c\u67d0\u4e2a\u53f6\u5b50 $v$ \u5bf9\u7b54\u6848\u7684\u8d21\u732e\u5c31\u662f $\\prod_{u\\not\\in\\operatorname{path}(v,0)} s_u$\uff0c\u76f4\u63a5\u9884\u5904\u7406\u51fa\u6bcf\u4e2a\u53f6\u5b50\u5bf9\u7b54\u6848\u7684\u8d21\u732e\uff0c\u6ce8\u610f\u5230\u53ea\u6709\u503c\u4e3a $1$ \u7684\u53f6\u5b50\u5bf9\u7b54\u6848\u6709\u8d21\u732e\uff0c\u56e0\u6b64\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u533a\u95f4\u53cd\u8f6c\uff0c\u7edf\u8ba1\uff08\u6709\u8d21\u732e\u7684\u53f6\u5b50\u7684\uff09\u6574\u4f53\u548c\u7684\u64cd\u4f5c\u5373\u53ef\u3002\n\n\u6ce8\u610f\u9898\u76ee\u7ed9\u51fa\u7684\u6a21\u6570\u4e0d\u652f\u6301\u6c42\u9006\u5143\uff0c\u56e0\u6b64\u53ef\u80fd\u8981\u9884\u5904\u7406\u5b50\u6811\u5185\u7684 $s_u$ \u79ef\uff0c\u518d\u7528 dfs \u9010\u4e2a\u8f6c\u79fb\u51fa\u6bcf\u4e2a\u53f6\u5b50\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\Theta((m+q)\\log m)$\u3002\n\n## \u4ee3\u7801\u5448\u73b0\n\n```cpp\n#include<bits/stdc++.h>\n#define ll long long\nusing namespace std;\nconst int MAXN=2e5+1,MOD=1e9+2022;\nclass SegmentTree {\n\tprivate:\n\t\tstruct node {\n\t\t\tint rev,sum[2];\n\t\t\tnode() { rev=0,sum[0]=sum[1]=0; }\n\t\t}\ttree[MAXN<<2];\n\t\tinline int left(int x) { return x<<1; }\n\t\tinline int right(int x) { return x<<1|1; }\n\t\tinline void pushup(int pos) {\n\t\t\ttree[pos].sum[0]=(tree[left(pos)].sum[0]+tree[right(pos)].sum[0])%MOD;\n\t\t\ttree[pos].sum[1]=(tree[left(pos)].sum[1]+tree[right(pos)].sum[1])%MOD;\n\t\t}\n\t\tinline void reverse(int pos) {\n\t\t\ttree[pos].rev^=1;\n\t\t\tswap(tree[pos].sum[0],tree[pos].sum[1]);\n\t\t}\n\t\tinline void pushdown(int pos) {\n\t\t\tif(tree[pos].rev) {\n\t\t\t\treverse(left(pos));\n\t\t\t\treverse(right(pos));\n\t\t\t\ttree[pos].rev=0;\n\t\t\t}\n\t\t}\n\tpublic:\n\t\tinline void Insert(int u,int s,int k,int l,int r,int pos)  {\n\t\t\ttree[pos]=node();\n\t\t\tif(l==r) {\n\t\t\t\ttree[pos].sum[s]=k;\n\t\t\t\treturn ;\n\t\t\t}\n\t\t\tint mid=(l+r)>>1;\n\t\t\tif(u<=mid) Insert(u,s,k,l,mid,left(pos));\n\t\t\tif(mid<u) Insert(u,s,k,mid+1,r,right(pos));\n\t\t\tpushup(pos);\n\t\t}\n\t\tinline void Modify(int ul,int ur,int l,int r,int pos) {\n\t\t\tif(ul<=l&&r<=ur) {\n\t\t\t\treverse(pos);\n\t\t\t\treturn ;\n\t\t\t}\n\t\t\tint mid=(l+r)>>1;\n\t\t\tpushdown(pos);\n\t\t\tif(ul<=mid) Modify(ul,ur,l,mid,left(pos));\n\t\t\tif(mid<ur) Modify(ul,ur,mid+1,r,right(pos));\n\t\t\tpushup(pos);\n\t\t}\n\t\tinline int Query() { return tree[1].sum[1]; }\n}\tS;\nvector <int> G[MAXN];\nint n,m,siz[MAXN],coef[MAXN],prod[MAXN];\ninline void dfs1(int u) {\n\tif(!siz[u]) {\n\t\tprod[u]=1;\n\t\treturn ;\n\t}\n\tprod[u]=siz[u];\n\tfor(int v:G[u]) {\n\t\tdfs1(v);\n\t\tprod[u]=(ll)prod[v]*(ll)prod[u]%MOD;\n\t}\n}\ninline void dfs2(int u,int k) {\n\tcoef[u]=k;\n\tif(!siz[u]) return ;\n\tvector <int> pre(siz[u]),suf(siz[u]);\n\tpre[0]=prod[G[u][0]];\n\tfor(int i=1;i<=siz[u]-1;++i) pre[i]=(ll)prod[G[u][i]]*(ll)pre[i-1]%MOD;\n\tsuf[siz[u]-1]=prod[G[u][siz[u]-1]];\n\tfor(int i=siz[u]-2;i>=0;--i) suf[i]=(ll)prod[G[u][i]]*(ll)suf[i+1]%MOD;\n\tfor(int i=0;i<=siz[u]-1;++i) {\n\t\tint tmp=k;\n\t\tif(i>0) tmp=(ll)tmp*(ll)pre[i-1]%MOD;\n\t\tif(i<siz[u]-1) tmp=(ll)tmp*(ll)suf[i+1]%MOD;\n\t\tdfs2(G[u][i],tmp);\n\t}\n}\nvoid init(int N,int M,vector <int> P,vector <int> A) {\n\tn=N,m=M;\n\tfor(int i=1;i<n+m;++i) G[P[i]].push_back(i);\n\tfor(int i=0;i<n+m;++i) siz[i]=G[i].size();\n\tdfs1(0),dfs2(0,1);\n\tfor(int i=0;i<m;++i) S.Insert(i+1,A[i],coef[n+i],1,m,1);\n}\nint count_ways(int L,int R) {\n\tS.Modify(L-n+1,R-n+1,1,m,1);\n\treturn S.Query();\n}\n```\n\n",
        "postTime": 1676077483,
        "uid": 539618,
        "name": "DaiRuiChen007",
        "ccfLevel": 6,
        "title": "P8493 \u9898\u89e3"
    }
]