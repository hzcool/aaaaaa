[
    {
        "content": "\u5b9e\u9645\u4e0a\u9664\u4e86\u5c01\u9501\u64cd\u4f5c\u4ee5\u5916\u90fd\u662f[\u6a21\u677f\u9898](https://www.luogu.com.cn/problem/P3373)\u7684\u5185\u5bb9\uff0c\u6240\u4ee5\u6211\u4eec\u76f4\u63a5\u8003\u8651\u5982\u4f55\u5904\u7406\u64cd\u4f5c 3\u3002\n\n\u8003\u8651\u5c06\u6240\u6709\u7684\u5c01\u9501\u64cd\u4f5c\u62c6\u6210\u4e24\u4e2a\u64cd\u4f5c\uff08\u7b2c $k$ \u6b21\u7684\u5c01\u9501\u64cd\u4f5c\u4ee5\u53ca\u7b2c $k+x$ \u6b21\u64cd\u4f5c\u540e\u7684\u89e3\u9664\u5c01\u9501\u64cd\u4f5c\uff09\u3002\u540c\u65f6\u5bf9\u4e8e\u7ebf\u6bb5\u6811\u7684\u6bcf\u4e2a\u8282\u70b9\uff0c\u6211\u4eec\u5c06\u539f\u6765\u7684\u7ef4\u62a4\u533a\u95f4\u548c\u6539\u4e3a\u7ef4\u62a4\u533a\u95f4\u5185**\u6240\u6709\u672a\u5c01\u9501\u4f4d\u7f6e\u7684\u548c**\u4ee5\u53ca**\u5c01\u9501\u4f4d\u7f6e\u7684\u548c**\uff0c\u53e6\u5916\u518d\u7ef4\u62a4\u533a\u95f4\u5185**\u672a\u5c01\u9501\u4f4d\u7f6e\u4e2a\u6570**\u4ee5\u53ca**\u8fd9\u6574\u4e2a\u533a\u95f4\u662f\u5426\u88ab\u5c01\u9501**\uff08\u7c7b\u4f3c\u4e8e\u626b\u63cf\u7ebf\uff09\u3002\u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u5b9e\u65f6\u7ef4\u62a4\u51fa\u6bcf\u4e2a\u4f4d\u7f6e\u662f\u5426\u88ab\u5c01\u9501\uff0c\u5e76\u636e\u6b64\u6765\u8fdb\u884c\u52a0\u6cd5\u548c\u4e58\u6cd5\u64cd\u4f5c\u7684\u4fee\u6539\u3002\n\n\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u4e00\u4e9b\u7ec6\u8282\uff0c\u5c31\u662f\u5728\u6240\u6709\u7684\u52a0\u6cd5\u548c\u4e58\u6cd5\u7684\u64cd\u4f5c\u4ee5\u53ca\u76f8\u5e94\u6807\u8bb0\u4e0b\u4f20\u65f6\uff0c\u5982\u679c\u76f8\u5e94\u8282\u70b9\u6574\u6bb5\u533a\u95f4\u88ab\u6807\u8bb0\u4e3a\u5c01\u9501\uff0c\u90a3\u4e48\u5c31**\u4e0d\u5e94\u8be5\u5bf9\u533a\u95f4\u548c\u4ee5\u53ca\u6807\u8bb0\u8fdb\u884c\u4fee\u6539**\uff0c\u800c\u5728\u5176\u4ed6\u60c5\u51b5\u4e0b\u5219**\u9700\u8981\u8fdb\u884c\u76f8\u5e94\u7684\u533a\u95f4\u548c\u4ee5\u53ca\u6807\u8bb0\u7684\u4fee\u6539**\u3002\u4ee5\u53ca\u5177\u4f53\u8fdb\u884c\u5c01\u9501\u548c\u89e3\u9664\u5c01\u9501\u65f6\u9700\u8981\u6839\u636e\u76f8\u5e94\u60c5\u51b5\u8fdb\u884c\u7ef4\u62a4\uff08\u6bd4\u5982\u5728\u89e3\u9664\u5c01\u9501\u90e8\u5206\uff0c\u53f6\u8282\u70b9\u548c\u975e\u53f6\u8282\u70b9\u7684\u7ef4\u62a4\u5c31\u4e0d\u540c\uff0c\u4ee5\u53ca\u5bf9\u76f8\u5e94\u8282\u70b9\u5c01\u9501\u65f6\u9700\u8981\u4e0b\u4f20\u6807\u8bb0\u4ee5\u4fdd\u8bc1\u89e3\u9664\u5c01\u9501\u65f6\u7ef4\u62a4\u7684\u6b63\u786e\u6027\uff09\u3002\n\n\u663e\u7136\u6b64\u65f6\u590d\u6742\u5ea6\u5bb9\u6613\u8bc1\u660e\u8fd8\u662f $O(n\\log n)$\uff08$n,m$ \u540c\u9636\uff09\uff0c\u8003\u8651\u5982\u4f55\u8bc1\u660e\u6b63\u786e\u6027\u3002\n\n\u53ef\u4ee5\u53d1\u73b0**\u5728\u5c01\u9501\u64cd\u4f5c\u6267\u884c\u524d\uff0c\u6240\u6709\u76f8\u5e94\u9700\u8981\u5c01\u9501\u7684\u8282\u70b9\u7684\u7956\u5148\u6807\u8bb0\u5747\u5df2\u4e0b\u4f20**\uff0c\u56e0\u6b64\u5728\u6b64\u4e4b\u524d\u7684\u64cd\u4f5c\u5185\u5bb9\u5df2\u7ecf\u5168\u90e8\u4f20\u5230\u8fd9\u4e2a\u8282\u70b9\uff0c\u53ea\u9700\u8981\u518d\u8fdb\u884c\u6807\u8bb0\u5373\u53ef\u3002\u800c\u5bf9\u4e8e\u6240\u6709\u7684\u89e3\u9664\u5c01\u9501\u64cd\u4f5c\uff0c\u5728\u76f8\u5e94\u65f6\u6bb5\u5185\u7684\u6240\u6709\u64cd\u4f5c\u7684\u6807\u8bb0\u4e5f\u5df2\u7ecf\u4e0b\u4f20\uff0c\u800c\u6839\u636e\u6211\u4eec\u5bf9\u6807\u8bb0\u4e0b\u4f20\u90e8\u5206\u7684\u4fee\u6539\uff0c\u76f8\u5e94\u7684\u6548\u679c**\u4e0d\u4f1a\u88ab\u4f20\u5230\u8be5\u8282\u70b9**\uff08\u76f8\u5f53\u4e8e\u6d88\u53bb\u4e86\u8fd9\u4e2a\u65f6\u6bb5\u5185\u52a0\u6cd5\u548c\u4e58\u6cd5\u64cd\u4f5c\u5bf9\u8fd9\u4e2a\u533a\u95f4\u7684\u5f71\u54cd\uff09\u3002\u7531\u6b64\u6211\u4eec\u8bc1\u660e\u4e86\u8fd9\u4e2a\u505a\u6cd5\u7684\u6b63\u786e\u6027\u3002\n\n```cpp\n#include<bits/stdc++.h>\n#define p 1000000007\nusing namespace std;\nint lw[200005],la[200005];\nint fl[200005],fr[200005];\nint n,m,a[200005];\nstruct xds{\n\tint x,fx,len,bj[2],f;\n};\n#define ls(w) (w<<1)\n#define rs(w) (ls(w)^1)\nxds tree[800005];\nint dr()\n{\n\tint xx=0;char ch=getchar();\n\twhile(ch<'0'||ch>'9')ch=getchar();\n\twhile(ch>='0'&&ch<='9')xx=(xx<<1)+(xx<<3)+ch-'0',ch=getchar();\n\treturn xx;\n}\nvoid u(int w)\n{\n\tif(tree[w].f==0)\n\t{\n\t\ttree[w].x=(tree[ls(w)].x+tree[rs(w)].x)%p,tree[w].fx=(tree[ls(w)].fx+tree[rs(w)].fx)%p;\n\t\ttree[w].len=tree[ls(w)].len+tree[rs(w)].len;\n\t}\n}\nvoid d(int w)\n{\n\tif(tree[w].bj[1]!=1)\n\t{\n\t\tint x=tree[w].bj[1];tree[w].bj[1]=1;\n\t\ttree[ls(w)].x=1ll*tree[ls(w)].x*x%p,tree[rs(w)].x=1ll*tree[rs(w)].x*x%p;\n\t\tif(tree[ls(w)].f==0)tree[ls(w)].bj[0]=1ll*tree[ls(w)].bj[0]*x%p,tree[ls(w)].bj[1]=1ll*tree[ls(w)].bj[1]*x%p;\n\t\tif(tree[rs(w)].f==0)tree[rs(w)].bj[0]=1ll*tree[rs(w)].bj[0]*x%p,tree[rs(w)].bj[1]=1ll*tree[rs(w)].bj[1]*x%p;\n\t}\n\tif(tree[w].bj[0]!=0)\n\t{\n\t\tint x=tree[w].bj[0];tree[w].bj[0]=0;\n\t\ttree[ls(w)].x=(tree[ls(w)].x+1ll*tree[ls(w)].len*x)%p,tree[rs(w)].x=(tree[rs(w)].x+1ll*tree[rs(w)].len*x)%p;\n\t\tif(tree[ls(w)].f==0)tree[ls(w)].bj[0]=(tree[ls(w)].bj[0]+x)%p;\n\t\tif(tree[rs(w)].f==0)tree[rs(w)].bj[0]=(tree[rs(w)].bj[0]+x)%p;\n\t}\n}\nvoid csh(int w,int l,int r)\n{\n\ttree[w].bj[1]=1;\n\tif(l==r)\n\t{\n\t\ttree[w].x=a[l],tree[w].len=1;\n\t\treturn;\n\t}\n\tint mid=(l+r)>>1;\n\tcsh(ls(w),l,mid),csh(rs(w),mid+1,r);\n\tu(w);\n}\nvoid xg_1(int w,int L,int R,int l,int r,int x)\n{\n\tif(tree[w].f)return;\n\tif(L<=l&&r<=R)\n\t{\n\t\ttree[w].x=(tree[w].x+1ll*tree[w].len*x)%p;\n\t\ttree[w].bj[0]=(tree[w].bj[0]+x)%p;\n\t\treturn;\n\t}\n\td(w);\n\tint mid=(l+r)>>1;\n\tif(L<=mid)xg_1(ls(w),L,R,l,mid,x);\n\tif(R>mid)xg_1(rs(w),L,R,mid+1,r,x);\n\tu(w);\n}\nvoid xg_2(int w,int L,int R,int l,int r,int x)\n{\n\tif(tree[w].f)return;\n\tif(L<=l&&r<=R)\n\t{\n\t\ttree[w].x=1ll*tree[w].x*x%p;\n\t\ttree[w].bj[0]=1ll*tree[w].bj[0]*x%p,tree[w].bj[1]=1ll*tree[w].bj[1]*x%p;\n\t\treturn;\n\t}\n\td(w);\n\tint mid=(l+r)>>1;\n\tif(L<=mid)xg_2(ls(w),L,R,l,mid,x);\n\tif(R>mid)xg_2(rs(w),L,R,mid+1,r,x);\n\tu(w);\n}\nvoid xg_3(int w,int L,int R,int l,int r)\n{\n\tif(L<=l&&r<=R)\n\t{\n\t\tif(l!=r)d(w);\n\t\tif(tree[w].f==0)tree[w].fx=(tree[w].fx+tree[w].x)%p,tree[w].x=0,tree[w].len=0;\n\t\t++tree[w].f;\n\t\treturn;\n\t}\n\td(w);\n\tint mid=(l+r)>>1;\n\tif(L<=mid)xg_3(ls(w),L,R,l,mid);\n\tif(R>mid)xg_3(rs(w),L,R,mid+1,r);\n\tu(w);\n}\nvoid xg_4(int w,int L,int R,int l,int r)\n{\n\tif(L<=l&&r<=R)\n\t{\n\t\t--tree[w].f;\n\t\tif(tree[w].f==0)\n\t\t{\n\t\t\tif(l==r)swap(tree[w].x,tree[w].fx),tree[w].len=1;\n\t\t\telse u(w);\n\t\t}\n\t\treturn;\n\t}\n\td(w);\n\tint mid=(l+r)>>1;\n\tif(L<=mid)xg_4(ls(w),L,R,l,mid);\n\tif(R>mid)xg_4(rs(w),L,R,mid+1,r);\n\tu(w);\n}\nint cx(int w,int L,int R,int l,int r)\n{\n\tif(L<=l&&r<=R)return (tree[w].x+tree[w].fx)%p;\n\td(w);\n\tint mid=(l+r)>>1,x=0;\n\tif(L<=mid)x+=cx(ls(w),L,R,l,mid);\n\tif(R>mid)x+=cx(rs(w),L,R,mid+1,r);\n\treturn x%p;\n}\nint main()\n{\n\tn=dr(),m=dr();\n\tfor(int i=1;i<=n;i++)a[i]=dr();\n\tcsh(1,1,n);\n\tfor(int i=1;i<=m;i++)\n\t{\n\t\tint opt=dr(),l=dr(),r=dr();\n\t\tif(opt<=3)\n\t\t{\n\t\t\tint x=dr();\n\t\t\tif(opt==1)xg_1(1,l,r,1,n,x);\n\t\t\tif(opt==2)xg_2(1,l,r,1,n,x);\n\t\t\tif(opt==3)\n\t\t\t{\n\t\t\t\txg_3(1,fl[i]=l,fr[i]=r,1,n);\n\t\t\t\tint k=i+x;la[i]=lw[k],lw[k]=i;\n\t\t\t}\n\t\t}\n\t\telse printf(\"%d\\n\",cx(1,l,r,1,n));\n\t\tfor(int j=lw[i];j;j=la[j])xg_4(1,fl[j],fr[j],1,n);\n\t}\n}\n```\n",
        "postTime": 1612610873,
        "uid": 104581,
        "name": "kkk\u7684\u5c0f\u8214\u72d7",
        "ccfLevel": 8,
        "title": "\u56db\u65b9\u559d\u5f69 \u9898\u89e3"
    }
]