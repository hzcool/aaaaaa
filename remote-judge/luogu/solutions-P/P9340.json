[
    {
        "content": "\n### \u524d\u8a00\uff1a\u770b\u5230\u6768\u8001\u5e08\u7684 $O(n\\log^2 n)$ \u505a\u6cd5\uff0c\u6240\u4ee5\u6765\u5199\u4e00\u4e2a $O(n\\sqrt n)$ \u505a\u6cd5\u3002\n\n## \u9898\u610f\n\n\u591a\u6b21\u67e5\u8be2\u5305\u542b\u533a\u95f4\u4e2d\u6240\u6709\u70b9\u7684\u8fde\u901a\u5757\u6700\u5c0f\u5927\u5c0f\u3002\n\n## \u505a\u6cd5\n\n\u533a\u95f4\u67e5\u8be2\uff0c\u53ef\u4ee5\u79bb\u7ebf\uff0c\u4e00\u773c\u9274\u5b9a\u4e3a\u83ab\u961f\u3002\n\n\u5305\u542b\u6240\u6709\u5173\u952e\u70b9\u7684\u8fde\u901a\u5757\u6700\u5c0f\u5927\u5c0f\u662f\u7ecf\u5178\u95ee\u9898\uff0c\u865a\u6811\u4e2d\u8fb9\u7684\u6570\u91cf\u7b49\u4e8e\u6309 dfs \u6392\u5e8f\u540e\u4e24\u4e24\u76f8\u90bb\u7684\u70b9\u7684\u8ddd\u79bb\u4e4b\u548c\u3002\uff08\u7b2c\u4e00\u4e2a\u548c\u6700\u540e\u4e00\u4e2a\u4e5f\u76f8\u90bb\uff09\n\n\u8fd9\u6837\u5c31\u83b7\u5f97\u4e86 $O(n\\sqrt n\\log n)$ \u7684\u505a\u6cd5\uff0c\u76f4\u63a5\u83ab\u961f\uff0c\u8bb0\u5f55\u6bcf\u4e2a\u70b9\u7684\u51fa\u73b0\u6570\u91cf\uff0c\u5982\u679c\u5220\u5230\u4e86 $0$ \u5c31\u4ece\u70b9\u96c6\u4e2d\u53bb\u6389\uff0c\u7528 set \u52a8\u6001\u7ef4\u62a4\u524d\u9a71\u540e\u7ee7\uff0c\u540c\u65f6\u7ef4\u62a4\u865a\u6811\u5927\u5c0f\u3002\n\n\u56e0\u4e3a\u61d2\u5f97\u5199\u56de\u6eda\u83ab\u961f\uff0c\u5148\u5199\u4e86 set\uff0c\u6709 $28$ \u5206\u7684\u9ad8\u5206\u3002\n\n\u53d1\u73b0\u53ea\u5220\u7684\u524d\u9a71\u540e\u7ee7\u53ef\u4ee5\u7528\u94fe\u8868\u7ef4\u62a4\uff0c\u5957\u4e00\u4e2a\u53ea\u5220\u4e0d\u52a0\u7684\u56de\u6eda\u83ab\u961f\uff0c\u53f3\u7aef\u70b9\u4ece\u53f3\u5230\u5de6\u6392\u5e8f\uff0c\u540c\u65f6\u7528 $O(1)$ lca \u6c42\u4e24\u4e2a\u70b9\u95f4\u7684\u8ddd\u79bb\uff0c\u7528\u7684\u662f dfs \u5e8f lca\uff0c\u8fd9\u6837\u5e38\u6570\u5c0f\uff0c\u8fd8\u4e0d\u7528\u591a\u8bb0\u4e00\u4e2a\u6b27\u62c9\u5e8f\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\sqrt n)$\u3002\n\n## \u4ee3\u7801\n\n```cpp\nconst int N=1e5+5;\nint n,m,k,len,res;\nint a[N],ans[N];\nint num[N],lg[N];\nvector<int> e[N];\nint id[N],rk[N],dep[N];\nint st[20][N],cnt;\ninline void dfs(int u,int fa){\n\tdep[u]=dep[fa]+1;\n\tid[u]=++cnt;rk[cnt]=u;\n\tst[0][cnt]=fa;\n\tfor(int v:e[u]) if(v!=fa) dfs(v,u);\n}\ninline int Min(int x,int y){return dep[x]<dep[y]?x:y;}\ninline void init(){\n\tF(i,2,n) lg[i]=lg[i>>1]+1;\n\tF(j,1,19) F(i,1,cnt-(1<<j)+1) st[j][i]=Min(st[j-1][i],st[j-1][i+(1<<(j-1))]);\n}\ninline int lca(int l,int r){\n\tif(l==r) return rk[l];\n\tif(l>r) swap(l,r);\n\t++l;int k=lg[r-l+1];\n\treturn Min(st[k][l],st[k][r-(1<<k)+1]);\n}\ninline int dis(int x,int y){return dep[rk[x]]+dep[rk[y]]-2*dep[lca(x,y)];}\nstruct md{\n\tint l,r,bid,id;\n\tinline bool operator < (const md &x)const{return bid!=x.bid?l<x.l:r>x.r;}\n}q[N];\nint pre[N],nxt[N];\nstruct node{\n\tint pre,nxt,id;\n\tnode(){}\n\tnode(int pre,int nxt,int id):pre(pre),nxt(nxt),id(id){}\n};\nvector<node> s;\ninline void Del(int x){\n\t--num[x];\n\tif(!num[x]){\n\t\tres-=dis(pre[x],x)+dis(x,nxt[x]);\n\t\tres+=dis(pre[x],nxt[x]);\n\t\tpre[nxt[x]]=pre[x];nxt[pre[x]]=nxt[x];\n\t}\n}\ninline void del(int x){\n\ts.emplace_back(pre[x],nxt[x],x);\n\t--num[x];\n\tif(!num[x]){\n\t\tres-=dis(pre[x],x)+dis(x,nxt[x]);\n\t\tres+=dis(pre[x],nxt[x]);\n\t\tpre[nxt[x]]=pre[x];nxt[pre[x]]=nxt[x];\n\t}\n}\ninline void solve(){\n\tint l=1,r=0;\n\tF(i,1,m){\n\t\tif(q[i].bid!=q[i-1].bid){\n\t\t\tmemset(num,0,sizeof num);\n\t\t\tF(j,(q[i].bid-1)*len+1,k) ++num[id[a[j]]];\n\t\t\tint lst=0;F(j,1,n){\n\t\t\t\tpre[j]=lst;\n\t\t\t\tif(num[j]) lst=j;\n\t\t\t}\n\t\t\tF(j,1,n) if(!pre[j]) pre[j]=lst;\n\t\t\tlst=0;UF(j,n,1){\n\t\t\t\tnxt[j]=lst;\n\t\t\t\tif(num[j]) lst=j;\n\t\t\t}\n\t\t\tUF(j,n,1) if(!nxt[j]) nxt[j]=lst;\n\t\t\tres=0;\n\t\t\tF(j,1,n) if(num[j]) res+=dis(pre[j],j);\n\t\t\tr=k;\n\t\t}\n\t\tl=(q[i].bid-1)*len+1;\n\t\twhile(r>q[i].r) Del(id[a[r--]]);\n\t\tint now=res;\n\t\twhile(l<q[i].l) del(id[a[l++]]);\n\t\tans[q[i].id]=res/2+1;\n\t\tres=now;\n\t\twhile(!s.empty()){\n\t\t\tnode tmp=s.back();s.pop_back();\n\t\t\tif(!num[tmp.id]) nxt[tmp.pre]=tmp.id,pre[tmp.nxt]=tmp.id;\n\t\t\t++num[tmp.id];\n\t\t}\n\t}\n}\nbool M2;\nint main(){\n\tint Time=clock();\n\tlook_memory;\n\tn=read();k=read();m=read();\n\tlen=sqrt(k);\n\tF(i,1,n-1){\n\t\tint u=read(),v=read();\n\t\te[u].emplace_back(v);\n\t\te[v].emplace_back(u);\n\t}\n\tdfs(1,0);init();\n\tF(i,1,k) a[i]=read();\n\tF(i,1,m) q[i].l=read(),q[i].r=read(),q[i].bid=(q[i].l-1)/len+1,q[i].id=i;\n\tsort(q+1,q+m+1);\n\tsolve();\n\tF(i,1,m) cout<<ans[i]<<'\\n';\n\tlook_time;\n\treturn 0;\n}\n```",
        "postTime": 1685449067,
        "uid": 406832,
        "name": "Mikefeng",
        "ccfLevel": 7,
        "title": "P9340"
    },
    {
        "content": "**\u4f20\u9001\u95e8\uff1a[P9340](https://www.luogu.com.cn/problem/P9340)**\n\n----------------------\n\n**\u9898\u76ee\u5927\u610f\uff1a**\n\n\u7ed9\u5b9a\u4e00\u68f5 $n$ \u4e2a\u70b9\u7684\u6811\u4ee5\u53ca\u4e00\u4e2a\u5e8f\u5217 $a_{1,\\dots,m}$\uff0c$q$ \u6b21\u8be2\u95ee\u5305\u542b $a_{l,\\dots,r}$ \u4e2d\u6240\u6709\u70b9\u7684\u6700\u5c0f\u8fde\u901a\u5757\u5927\u5c0f\u3002\n\n----------------------\n\n\u56de\u6eda\u83ab\u961f\u4e00\u70b9\u4e5f\u4e0d\u4f18\u7f8e\uff0c\u6240\u4ee5\u8fd9\u91cc\u662f $O(n \\log^2 n)$ \u89e3\u6cd5\u3002\n\n**step1**\n\n\u4e0d\u59a8\u5c06\u6811\u7684\u6839\u5b9a\u4e3a $1$ \u53f7\u7ed3\u70b9\u3002\n\n\u4e0d\u96be\u770b\u51fa\u9898\u76ee\u5c31\u662f\u6c42\u533a\u95f4\u6240\u6709\u70b9\u6784\u6210\u7684\u865a\u6811\u5927\u5c0f\uff0c\u5c06\u5728\u533a\u95f4 $[l,r]$ \u4e2d\u51fa\u73b0\u8fc7\u7684\u70b9\u67d3\u9ed1\uff0c\u5176\u5b83\u70b9\u67d3\u767d\uff0c\u53ef\u4ee5\u5c06\u865a\u6811\u5927\u5c0f\u8f6c\u5316\u6210\u4e24\u90e8\u5206\uff1a\n\n1. \u52a0\u4e0a\u6240\u6709\u70b9 $u$ \u7684\u4e2a\u6570\uff0c\u6ee1\u8db3 $u$ \u7684\u5b50\u6811\u4e2d\u5b58\u5728**\u81f3\u5c11**\u4e00\u4e2a\u9ed1\u70b9\n2. \u51cf\u53bb\u6240\u6709\u70b9 $u$ \u7684\u4e2a\u6570\uff0c\u6ee1\u8db3 $u$ \u7684\u5b50\u6811\u4e4b\u5916\uff08\u5305\u62ec $u$\uff09**\u5168\u90e8**\u4e3a\u767d\u70b9\n\n\u7b2c\u4e8c\u90e8\u5206\u5b9e\u9645\u4e0a\u5c31\u662f\u865a\u6811\u7684\u6839\u7684\u6df1\u5ea6\uff0c\u8fd9\u662f\u597d\u7b97\u7684\uff0c\u865a\u6811\u7684\u6839\u5c31\u662f\u533a\u95f4 $[l,r]$ \u4e2d dfn \u6700\u5c0f\u7684\u7ed3\u70b9\u548c dfn \u6700\u5927\u7684\u7ed3\u70b9\u7684 lca\u3002\n\n**step2**\n\n\u96be\u70b9\u5728\u4e8e\u7b2c\u4e00\u90e8\u5206\u3002\n\n\u73b0\u5728\u6765\u5206\u6790\u53f3\u7aef\u70b9\u56fa\u5b9a\u4e3a $r$ \u65f6\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u7ed3\u70b9 $u$\uff0c\u5de6\u7aef\u70b9 $l$ \u53d6\u5230\u4f55\u503c\u4f1a\u8ba9 $u$ \u5bf9\u7b2c\u4e00\u90e8\u5206\u6709\u8d21\u732e\u3002\u8bb0 $mn_u$ \u8868\u793a $u$ \u7684\u5b50\u6811\u4e2d\u5728\u524d\u7f00 $[1,r]$ \u4e2d**\u6700\u540e\u4e00\u6b21\u51fa\u73b0\u65f6\u95f4\u6700\u5c0f**\u7684\u70b9\u7684\u6700\u540e\u4e00\u6b21\u51fa\u73b0\u4f4d\u7f6e\uff0c\u5bb9\u6613\u53d1\u73b0\u5f53 $l \\in [1,mn_u]$ \u65f6\uff0c$u$ \u5b50\u6811\u4e2d\u7684\u70b9 $a_{mn_u}$ \u5fc5\u7136\u4e3a\u9ed1\u70b9\uff0c\u5f53 $l \\in [mn_u + 1, r]$ \u65f6\uff0c$u$ \u5b50\u6811\u4e2d\u5fc5\u7136\u4e0d\u5b58\u5728\u9ed1\u70b9\uff1b\u6240\u4ee5 $u$ \u4f1a\u4e14\u4ec5\u4f1a\u5bf9\u533a\u95f4 $[1,mn_u]$ \u6709 $+1$ \u7684\u8d21\u732e\u3002\n\n\u8003\u8651\u626b\u63cf\u7ebf\uff1a\u679a\u4e3e $r$\uff0c\u52a8\u6001\u7ef4\u62a4 $mn_u$ \u4ee5\u53ca\u6240\u6709\u5de6\u7aef\u70b9\u7684\u7b54\u6848\uff0c\u521d\u59cb\u6709 $mn_u = 0$\u3002\u89c2\u5bdf\u4ece $r-1$ \u679a\u4e3e\u5230 $r$ \u65f6 $a_r$ \u4f1a\u5bf9 $mn_u$ \u9020\u6210\u4ec0\u4e48\u5f71\u54cd\uff1a\u5c31\u662f**\u5c06 $a_r$ \u5230 $1$ \u7684\u8def\u5f84\u4e0a\u7684\u6240\u6709\u70b9\u7684 $mn_u$ \u8d4b\u503c\u4e3a $i$** \u3002\u8fd9\u5f88\u5bb9\u6613\u8054\u60f3\u5230 LCT \u7684 access \u64cd\u4f5c\uff0c\u4e5f\u5c31\u662f\u8bf4\uff0c\u5982\u679c\u66b4\u529b\u5bf9\u4e8e\u4ece $a_r$ \u5230 $1$ \u7684\u8def\u5f84\u4e0a\u7684 $mn_u$ \u76f8\u540c\u7684\u8fde\u7eed\u6bb5\u5206\u522b\u4fee\u6539\u7684\u8bdd\uff0c\u6839\u636e access \u7684\u590d\u6742\u5ea6\u5206\u6790\uff0c\u8fd9\u662f**\u5747\u644a\u5355\u6b21 $O(\\log n)$ \u7684**\u3002\u5728\u6574\u6761\u94fe $mn_u$ \u76f8\u540c\u7684\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u53ea\u9700\u8981\u77e5\u9053\u8fd9\u6761\u94fe\u7684\u70b9\u6570\u5373\u53ef\u7528 BIT \u5feb\u901f\u4fee\u6539\u3002\n\n\u8fd9\u4e2a\u8fc7\u7a0b\u7528 LCT \u5373\u53ef\u975e\u5e38\u65b9\u4fbf\u5730\u6a21\u62df\uff0c\u603b\u590d\u6742\u5ea6 $O(n \\log^2 n)$\u3002\n\n\u4ee3\u7801\uff1a\n```cpp\n//\u533a\u95f4\u865a\u6811\n#include <bits/stdc++.h>\n#define lowbit(x) (x & -x)\n#define eb emplace_back\n#define pb push_back\n#define mp make_pair\nusing namespace std;\n\ninline int read() {\n\tint x = 0; char c = getchar();\n\twhile (c < '0' || c > '9') c = getchar();\n\twhile (c >= '0' && c <= '9') x = x * 10 + c - '0', c = getchar();\n\treturn x;\n}\n\ntypedef long long ll;\nconst int N = 1e5+5;\n\nint n, m, q, c[N], ans[N];\nint siz[N], dep[N], hs[N], f[N];\nint ct[N], dfn[N], nfd[N];\nint mn[N][17], mx[N][17], lg2[N];\n\nvector<int> T[N];\nvector<pair<int, int> > Q[N];\n\nvoid dfs1(int x, int fa) {\n\tf[x] = fa;\n\tdep[x] = dep[fa] + 1;\n\tsiz[x] = 1;\n\tfor (auto son : T[x]) {\n\t\tif (son == fa) continue;\n\t\tdfs1(son, x);\n\t\tsiz[x] += siz[son];\n\t\tif (siz[son] > siz[hs[x]]) hs[x] = son;\n\t}\n}\n\nvoid dfs2(int x, int ctop) {\n\tct[x] = ctop;\n\tnfd[dfn[x] = ++dfn[0]] = x;\n\tif (hs[x]) dfs2(hs[x], ctop);\n\tfor (auto son : T[x]) {\n\t\tif (son == f[x] || son == hs[x]) continue;\n\t\tdfs2(son, son);\n\t}\n}\n\ninline int LCA(int x, int y) {\n\twhile (ct[x] != ct[y]) {\n\t\tif (dep[ct[x]] < dep[ct[y]]) swap(x, y);\n\t\tx = f[ct[x]];\n\t}\n\treturn dep[x] < dep[y] ? x : y;\n}\n\nint BIT[N];\ninline void upd(int x, int k) { for (; x <= m; x += lowbit(x)) BIT[x] += k; }\ninline void upd(int l, int r, int k) { upd(l, k), upd(r + 1, -k); }\ninline int qry(int x) { int ret = 0; for (; x; x -= lowbit(x)) ret += BIT[x]; return ret; } \n\nnamespace LCT {\n\tstruct node {\n\t\tint son[2], fa;\n\t\tint cov, col;\n\t} T[N];\n\n\t#define son(x, s) T[x].son[s]\n\t#define f(x) T[x].fa\n\n\tinline void cov(int x, int k) { if (x) T[x].cov = T[x].col = k; }\n\tinline void push_down(int x) { if (int &t = T[x].cov) cov(son(x, 0), t), cov(son(x, 1), t), t = 0; }\n\tinline void cct(int x, int y, bool loc) { son(x, loc) = y, f(y) = x; }\n\tinline bool get_son(int x) { return son(f(x), 1) == x; }\n\tinline bool isRt(int x) { return son(f(x), 0) != x && son(f(x), 1) != x; }\n\n\tinline void rotate(int x) {\n\t\tint y = f(x);\n\t\tbool loc = get_son(x);\n\t\tf(x) = f(y);\n\t\tif (!isRt(y)) {\n\t\t\tson(f(y), get_son(y)) = x;\n\t\t}\n\t\tcct(y, son(x, loc ^ 1), loc);\n\t\tcct(x, y, loc ^ 1);\n\t}\n\n\tint stk[N], top;\n\n\tinline void splay(int x) {\n\t\tint y = x;\n\t\tstk[top = 1] = y;\n\t\twhile (!isRt(y)) stk[++top] = y = f(y);\n\t\twhile (top) push_down(stk[top--]);\n\t\tfor (y = f(x); !isRt(x); rotate(x), y = f(x))\n\t\t\tif (!isRt(y))\n\t\t\t\trotate(get_son(x) == get_son(y) ? y : x);\n\t}\n\n\tinline void access(int x, int t) {\n\t\tint y = 0;\n\t\tfor (; x; x = f(y = x)) {\n\t\t\tif (y) upd(T[y].col + 1, t, dep[y] - dep[x]);\n\t\t\tsplay(x), son(x, 1) = y;\n\t\t}\n\t\tupd(T[y].col + 1, t, dep[y]);\n\t\tcov(y, t);\n\t}\n\n\t#undef son\n\t#undef f\n}\n\nint main() {\n\tn = read(), m = read(), q = read();\n\tfor (int i = 1; i < n; i++) {\n\t\tint u = read(), v = read();\n\t\tT[u].pb(v);\n\t\tT[v].pb(u);\n\t}\n\n\tdfs1(1, 0);\n\tdfs2(1, 1);\n\tfor (int i = 2; i <= n; i++) LCT::T[i].fa = f[i];\n\t\n\tlg2[0] = -1;\n\tfor (int i = 1; i <= m; i++) {\n\t\tc[i] = read();\n\t\tlg2[i] = lg2[i >> 1] + 1;\n\t\tmn[i][0] = mx[i][0] = dfn[c[i]];\n\t\tfor (int j = 1; j <= lg2[i]; j++) {\n\t\t\tmn[i][j] = min(mn[i][j - 1], mn[i - (1 << j - 1)][j - 1]);\n\t\t\tmx[i][j] = max(mx[i][j - 1], mx[i - (1 << j - 1)][j - 1]);\n\t\t}\n\t}\n\n\tfor (int i = 1; i <= q; i++) {\n\t\tint l = read(), r = read();\n\t\tQ[r].eb(l, i);\n\t}\n\t\n\tfor (int i = 1; i <= m; i++) {\n\t\tLCT::access(c[i], i);\n\t\tfor (auto j : Q[i]) {\n\t\t\tint L = j.first, R = i, len = lg2[R - L + 1];\n\t\t\tans[j.second] = qry(L);\n\t\t\tint mnd = min(mn[R][len], mn[L + (1 << len) - 1][len]);\n\t\t\tint mxd = max(mx[R][len], mx[L + (1 << len) - 1][len]);\n\t\t\tans[j.second] -= dep[LCA(nfd[mnd], nfd[mxd])] - 1;\n\t\t}\n\t}\n\n\tfor (int i = 1; i <= q; i++) printf(\"%d\\n\", ans[i]);\n\treturn 0;\n}\n```",
        "postTime": 1684831081,
        "uid": 261935,
        "name": "Unique_Hanpi",
        "ccfLevel": 0,
        "title": "P9340 JOISC2023 D3T3 \u9898\u89e3"
    }
]