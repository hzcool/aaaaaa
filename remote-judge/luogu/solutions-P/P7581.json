[
    {
        "content": "### 20pts  \n\u76f4\u63a5\u7528 vector \u5b58 u \u7684 k-son\uff0c\u6bcf\u6b21\u8be2\u95ee\u66b4\u529b\u5373\u53ef\u3002  \n### 50pts\n\u8003\u8651 $O(n^2)$ \u7684\u52a8\u6001\u89c4\u5212\uff1a\u4e00\u4e2a\u70b9\u7684\u8d21\u732e\u7b49\u4e8e\u4ee5\u5b83\u4e3a LCA \u7684\u8d21\u732e\u52a0\u4e0a\u5b83\u5b50\u6811\u4e3a LCA \u7684\u8d21\u732e\u3002  \n\u6211\u4eec\u60f3\u5230\u8bbe $f[u][k]$ \u4e3a $u$ \u6df1\u5ea6\u4e3a $k$ \u7684\u7b54\u6848\u3002\u9996\u5148 $f[u][k]=\\sum\\limits_{v\\in u} f[v][k-1]$\u3002\u8fd9\u4e9b\u5c31\u662f\u5b50\u6811\u4e3a LCA \u7684\u8d21\u732e\uff0c\u63a5\u4e0b\u6765\u8003\u8651\u5982\u4f55\u8ba1\u7b97\u5b83\u4e3a LCA \u7684\u8d21\u732e\u3002  \n\u5047\u8bbe\u4ee5 $u$ \u4e3a\u6839\uff0c\u8ba1\u7b97\u4e24\u4e2a\u513f\u5b50 $v$ \u4e0e $w$ \u4e4b\u95f4\u8d21\u732e\uff0c\u5219\u4ea7\u751f\u8d21\u732e\u7684\u8fb9\u4e3a\u7ea2\u8272\u3002  \n![](https://cdn.luogu.com.cn/upload/image_hosting/7wsg394a.png)  \n\u6211\u4eec\u9700\u8981\u4e24\u4e2a\u8f85\u52a9\u6570\u7ec4 $g,h$\uff0c\u5176\u4e2d $g[u][k]$ \u4ee3\u8868 $u$ \u7684 $k-son$ \u5230\u5176\u8ddd\u79bb\u548c\uff0c$h[u][k]$ \u4ee3\u8868 $u$ \u6709\u591a\u5c11\u4e2a $k-son$\u3002  \n\u8fd9\u4e24\u4e2a\u7684\u8f6c\u79fb\u65b9\u7a0b\u663e\u800c\u6613\u89c1\uff1a$g[u][k]=\\sum\\limits_{v\\in u}g[v][k-1]+w(u,v)\\times h[v][k-1],h[u][k]=\\sum\\limits_{v\\in u}h[v][k-1],h[u][0]=1$\uff0c\u5176\u4e2d $w(u,v)$ \u4ee3\u8868\u8fb9\u6743\u3002  \n\u8f6c\u79fb\u5b8c $g,h$ \u540e\uff0c\u6211\u4eec\u53d1\u73b0\u5bf9\u4e8e\u4e00\u4e2a\u65b0\u7684\u5b50\u6811 $w$\uff0c\u524d\u9762\u7684\u6240\u6709\u5b50\u6811 $v$ \u4ea7\u751f\u7684\u8d21\u732e\u662f $g[u][k]\\times h[w][k-1]$\uff08\u5047\u8bbe $g[u][k]$ \u5df2\u88ab\u524d\u9762\u7684\u6240\u6709 $v$ \u66f4\u65b0\uff09\uff0c\u800c $v$ \u5bf9 $w$ \u7684\u8d21\u732e\u662f $h[u][k]\\times (g[w][k-1]+h[w][k-1]\\times w(u,w))$\u3002  \n\u6574\u5408\u4e00\u4e0b\uff0c$f[u][k]=\\sum\\limits_{v\\in u}f[v][k-1]+g[u][k]\\times h[v][k-1]+h[u][k]\\times (g[v][k-1]+h[v][k-1]\\times w(u,v))$\uff0c\u6ce8\u610f\u4e09\u4e2a\u5fc5\u987b\u4e00\u8d77\u8f6c\u79fb\u3002  \n### 80pts  \n\u4f3c\u4e4e\u53ef\u4ee5\u6709 ODTREE\u738b\u5b50 \u7684\u7ebf\u6bb5\u6811\u5408\u5e76\u548c Time_Tears \u7684\u795e\u5947 DSU+\u6811\u72b6\u6570\u7ec4\u89e3\u6cd5\u3002\u7b2c\u4e00\u79cd\u505a\u6cd5\u672c\u6765\u80fd\u8fc7\u73b0\u5728\u5df2\u7ecf MLE \u4e86\u3002\n## 100pts\n\u56e0\u4e3a dp \u6570\u7ec4\u7b2c\u4e8c\u7ef4\u662f\u4ee5\u6df1\u5ea6\u4e3a\u4e0b\u6807\uff0c\u4f3c\u4e4e\u53ef\u4ee5\u957f\u94fe\u5256\u5206\u3002  \n\u4f46 $g$ \u6570\u7ec4\u7684\u8f6c\u79fb\u5f62\u5f0f\u4e0d\u5229\u4e8e\u957f\u5256\u3002  \n\u8003\u8651\u5c06 $g$ \u6570\u7ec4\u7528\u6811\u4e0a\u5dee\u5206\u8fdb\u884c\u8f6c\u79fb\uff0c\u8bbe $dis[u]$ \u4e3a $u$ \u5230\u6839\u8ddd\u79bb\u3002\u5219 $g$ \u8f6c\u79fb\u6539\u4e3a $g[u][k]=\\sum\\limits_{v\\in u}g[v][k-1],g[u][0]=dis[u]$\uff0c\u6240\u6709\u503c\u8c03\u7528\u65f6\u9700\u8981\u51cf\u53bb $dis[u]\\times h[u][k]$\u3002  \n\u5219 $f$ \u6570\u7ec4\u8f6c\u79fb\u6539\u4e3a $f[u][k]=\\sum\\limits_{v\\in u}f[v][k-1]+(g[u][k]-dis[u]\\times h[u][k])\\times h[v][k-1]+h[u][k]\\times (g[v][k-1]-dis[u]\\times h[v][k-1])$\u3002  \n\u65f6\u95f4\u590d\u6742\u5ea6 $O(n)$\u3002  \n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nconst int maxn=1e6+5,mod=1e9+7;\ntypedef long long ll;\nchar __buf[1<<21],*__p1,*__p2;\n#define getchar() (__p1==__p2?(__p2=__buf+fread(__p1=__buf,1,1<<21,stdin),__p1==__p2?EOF:*__p1++):*__p1++)\ninline int read() {\n\tint __x=0,__f=1;\n\tchar __c=getchar();\n\twhile(__c<'0'||__c>'9') {\n\t\tif(__c=='-')__f=-1;\n\t\t__c=getchar();\n\t}\n\twhile(__c>='0'&&__c<='9') {\n\t\t__x=__x*10+__c-'0';\n\t\t__c=getchar();\n\t}\n\treturn __x*__f;\n}\ninline char pc(char ch,bool bj) {\n\tstatic char buf[1<<18],*p1=buf,*p2=buf+(1<<18);\n\treturn ((bj)||(*p1++=ch)&&p1==p2)&&fwrite(p1=buf,1,p1-buf,stdout),0;\n}\nvoid print(ll x) {\n\tif(x>9)print(x/10);\n\tpc(x%10^48,false);\n}\ninline void printnum(ll x,int ch) {\n\tprint(x),pc(ch,false);\n}\nstruct edge {\n\tint next,to,v;\n} e[maxn];\nint n,m,son[maxn],len[maxn],maxd[maxn];\nll tmp[maxn*3],*f[maxn],*g[maxn],*h[maxn],*id=tmp,ans[maxn],dis[maxn],hd[maxn],cnt;//\u6ce8\u610f\u4e00\u4e9b\u6570\u7ec4\u9700\u8981\u5f00 long long\nvector<int> q[maxn],qi[maxn];\nvoid addedge(int x,int y,int z) {\n\te[++cnt].next=hd[x];\n\te[cnt].to=y;\n\te[cnt].v=z;\n\thd[x]=cnt;\n}\nvoid dfs(int u,int fa) {\n\tfor(register int i=hd[u]; i; i=e[i].next) {\n\t\tint j=e[i].to;\n\t\tdis[j]=dis[u]+e[i].v;\n\t\tdfs(j);\n\t\tif(maxd[j]>maxd[son[u]])son[u]=j;\n\t}\n\tmaxd[u]=maxd[son[u]]+1;\n}\nvoid dp(int u) {\n\tif(son[u])f[son[u]]=f[u]+1,g[son[u]]=g[u]+1,h[son[u]]=h[u]+1,dp(son[u]);//\u5148\u8d70\u957f\u513f\u5b50\n\tg[u][0]=dis[u],h[u][0]=1;\n\tfor(register int i=hd[u]; i ; i=e[i].next) {\n\t\tint j=e[i].to;\n\t\tif(j==son[u])continue;\n\t\tf[j]=id,id+=maxd[j],g[j]=id,id+=maxd[j],h[j]=id,id+=maxd[j];\n\t\tdp(j);\n\t\tfor(register int k=1; k<=maxd[j]; k++) {\n\t\t\tf[u][k]=(f[u][k]+f[j][k-1]+(g[u][k]-dis[u]*h[u][k]%mod+mod)%mod*h[j][k-1]%mod+h[u][k]*(g[j][k-1]-dis[u]*h[j][k-1]%mod+mod)%mod)%mod;\n\t\t\tg[u][k]=(g[u][k]+g[j][k-1])%mod;\n\t\t\th[u][k]=(h[u][k]+h[j][k-1])%mod;//\u5c06\u8f7b\u513f\u5b50\u7684\u4fe1\u606f\u5408\u5e76\u4e0a\u53bb\n\t\t}\n\t}\n\tfor(register int i=0; i<q[u].size(); i++)if(q[u][i]<maxd[u])ans[qi[u][i]]=f[u][q[u][i]];//\u957f\u5256\u5fc5\u987b\u79bb\u7ebf\u6c42\u7b54\u6848\n}\nint main() {\n\tint x,y,z;\n\tn=read(),m=read();\n\tfor(register int i=1; i<n; i++) {\n\t\tx=read(),y=read(),z=read();\n\t\taddedge(x,y,z);\n\t}\n\tdfs(1);\n\tfor(register int i=1; i<=m; i++) {\n\t\tx=read(),y=read();\n\t\tq[x].push_back(y),qi[x].push_back(i);\n\t}\n\tf[1]=id,id+=maxd[1],g[1]=id,id+=maxd[1],h[1]=id,id+=maxd[1];\n\tdp(1);\n\tfor(register int i=1; i<=m; i++)printnum(ans[i],'\\n');\n\tpc(0,1);\n\treturn 0;\n}\n```",
        "postTime": 1617889777,
        "uid": 104324,
        "name": "abruce",
        "ccfLevel": 7,
        "title": "\u9898\u89e3--\u8def\u5f84\u6743\u503c"
    },
    {
        "content": "\u51fa\u9898\u4eba\u60f3\u8ba9\u6211\u4eec\u5199\u957f\u94fe\u5256\u5206\uff0c\u6240\u4ee5\u6211\u4eec\u5c31\u4e0d\u5199\u957f\u94fe\u5256\u5206\u3002\u6211\u4eec\u5199\u6811\u4e0a\u542f\u53d1\u5f0f\u5408\u5e76\u3002  \n\n\u8003\u8651\u6bcf\u4e2a\u70b9\u5f00\u4e00\u4e2a\u7c7b\u4f3c\u6570\u7ec4\u7684\u4e1c\u897f\uff0c\u8bb0\u8be5\u70b9\u7684\u5b50\u6811\u5bf9\u4e8e\u6bcf\u4e2a $dep$ \u7684 $(sum=\\sum dis),tot,ans$\u3002\n\n\u90a3\u4e48\u5408\u5e76\u4e24\u4e2a\u5b50\u6811\u65f6,\u5bf9\u4e8e\u4efb\u610f\u4e24\u4e2a\u70b9 $x,y$\uff0c$dis(x,y)=dis_x+dis_y-2dis_{lca}$\u3002\n\n\u8bbe\u6211\u4eec\u5408\u5e76 $u$ \u548c\u5176\u513f\u5b50 $v$ \u6240\u5728\u5b50\u6811\uff0c\u5219\u5bf9\u4e8e\u6bcf\u4e2a $dep$\uff0c\n$$\\begin{aligned}\nans_u&=ans_u+ans_v+\\sum_{x\\in u}\\sum_{y\\in v}dis(x,y)\\\\\n&=ans_u+ans_v+\\sum_{x\\in u}\\sum_{y\\in v}dis_x+dis_y-2dis_u\\\\\n&=ans_u+ans_v+\\sum_{x\\in u}dis_x\\sum_{y\\in v}1+\\sum_{y\\in v}dis_y\\sum_{x\\in u}1-2dis_u\\sum_{x\\in u}\\sum_{y\\in v}1\\\\\n&=ans_u+ans_v+sum_utot_v+sum_vtot_u-2tot_utot_vdis_u\n\\end{aligned}$$\n\n\u73b0\u5728\u7684\u95ee\u9898\u662f\u5bf9\u4e8e\u6bcf\u4e00\u4e2a $dep$ \u90fd\u8fdb\u884c\u4e00\u6b21\u5408\u5e76\u3002\u6211\u4eec\u9009\u62e9\u4f7f\u7528 `set`\uff0c\u7136\u540e\u542f\u53d1\u5f0f\u5408\u5e76\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathbf O(n\\log n)$\uff0c\u7a7a\u95f4\u590d\u6742\u5ea6 $\\mathbf O(n)$\u3002\n\n\u81f3\u4e8e\u4e3a\u4ec0\u4e48\u542f\u53d1\u5f0f\u5408\u5e76 `set` \u662f $\\mathbf O(n\\log n)$ \u7684\uff0c\u9996\u5148\u904d\u5386 `set` \u662f $\\mathbf O(n)$ \u7684\uff0c\u7136\u540e\u6309\u987a\u5e8f\u63d2\u5165\u4e5f\u662f $\\mathbf O(n)$ \u7684\uff0c\u6240\u4ee5\u644a\u4e0b\u6765\u590d\u6742\u5ea6\u5c31\u662f\u5bf9\u7684\u3002\n\n\u800c\u7a7a\u95f4\u590d\u6742\u5ea6\u662f $\\mathbf O(n)$ \u7684\u539f\u56e0\u662f\u6211\u4eec\u53ef\u4ee5\u6bcf\u6b21\u5408\u5e76\u540e\u628a\u90a3\u4e2a\u6ca1\u7528\u7684 `set` \u6e05\u7a7a\uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1\u540c\u4e00\u65f6\u523b\u6240\u6709 `set` \u4e2d\u4ec5\u6709 $\\mathbf O(n)$ \u4e2a\u8282\u70b9\u3002\n\n\u5bf9\u4e8e\u6bcf\u4e2a\u8be2\u95ee\uff0c\u628a\u5b83\u6302\u5230\u5bf9\u5e94\u8282\u70b9\u4e0a\uff0c\u67e5\u8fd9\u4e2a\u70b9 $dep+k$ \u7684\u7b54\u6848\u5c31\u597d\u3002\n\n\u4ee3\u7801\n\n```cpp\n#include<cstdio>\n#include<set>\n#include<vector>\n#include<algorithm>\nconst int N=1e6+10,logN=30,p=1e9+7;\nint n,m,rt[N],ans[N],dep[N],dis[N];\nstruct edge\n{\n\tint v,w,la;\n\tinline void set(int _v,int _w,int _la){v=_v;w=_w;la=_la;}\n}e[N<<1];\nstruct node\n{\n\tint val,tot,sum,ans;\n\tbool operator< (const node &x) const {return val<x.val;}\n};\nint la[N],cnt;\ninline void add(int u,int v,int w){e[++cnt].set(v,w,la[u]);la[u]=cnt;}\ninline void add(){int a,b,c;scanf(\"%d%d%d\",&a,&b,&c);add(a,b,c);add(b,a,c);}\nstd::vector<std::pair<int,int> >qu[N];\nstd::set<node>c[N];\nint merge(int x,int y,int z)\n{\n\tif(c[x].size()<c[y].size())x^=y^=x^=y;\n\tstd::set<node>::iterator it,i;node tmp;\n\tfor(i=c[y].begin();i!=c[y].end();++i)\n\t{\n\t\tit=c[x].find(*i);\n\t\tif(it==c[x].end()){c[x].insert(*i);continue;}\n\t\ttmp=*it;c[x].erase(it);\n\t\ttmp.ans=(tmp.ans+i->ans+1ll*tmp.sum*i->tot%p+1ll*tmp.tot*i->sum%p-2ll*tmp.tot*i->tot%p*z%p+p)%p;\n\t\ttmp.sum=(tmp.sum+i->sum)%p;\n\t\ttmp.tot=(tmp.tot+i->tot)%p;\n\t\tc[x].insert(tmp);\n\t}\n\tc[y].clear();return x;\n}\nvoid dfs(int u,int f)\n{\n\tdep[u]=dep[f]+1;c[rt[u]=u].insert((node){dep[u],1,dis[u],0});\n\tfor(int i=la[u];i;i=e[i].la)\n\tif(e[i].v!=f)dis[e[i].v]=(dis[u]+e[i].w)%p,\n\tdfs(e[i].v,u),rt[u]=merge(rt[u],rt[e[i].v],dis[u]);\n\tint i,n=qu[u].size();\n\tstd::set<node>::iterator it;\n\tfor(i=0;i<n;i++)\n\t{\n\t\tit=c[rt[u]].find((node){dep[u]+qu[u][i].first,0,0,0});\n\t\tif(it!=c[rt[u]].end())ans[qu[u][i].second]=it->ans;\n\t}\n}\nint main()\n{\n\tint i,x,y;scanf(\"%d%d\",&n,&m);\n\tfor(i=1;i<n;i++)add();\n\tfor(i=1;i<=m;i++)scanf(\"%d%d\",&x,&y),qu[x].push_back(std::make_pair(y,i));\n\tdfs(1,0);\n\tfor(i=1;i<=m;i++)printf(\"%d\\n\",ans[i]);\n\treturn 0;\n}\n```",
        "postTime": 1622198948,
        "uid": 35137,
        "name": "a___",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P7581 \u300cRdOI R2\u300d\u8def\u5f84\u6743\u503c(distance)"
    },
    {
        "content": "\u7784\u4e86\u773c\u51fa\u9898\u4eba\u7684\u9898\u89e3\uff0c\u7ebf\u6bb5\u6811\u5408\u5e76\u88ab\u5361\u6210 MLE \u4e86\u3002\n\n\u4f46\u662f\u6211\u53c8\u5361\u56de\u53bb\u4e86\u3002\n\n## \u9898\u76ee\u94fe\u63a5\n\n[$Link$](https://www.luogu.com.cn/problem/P7581)\n\n## \u9898\u76ee\u5927\u610f\n\n\u7ed9\u5b9a\u4e00\u68f5\u6811\uff0c\u591a\u6b21\u67e5\u8be2\u4e00\u4e2a\u8282\u70b9 $u$ \u7684\u6240\u6709\u5b50\u8282\u70b9\u4e2d\uff0c\u6240\u6709\u8ddd\u79bb $u$ \u7684\u5927\u5c0f\u4e3a $k$ \u7684\u8282\u70b9\u7684\u4e24\u4e24\u8ddd\u79bb\u548c\u3002\n\n## \u9898\u76ee\u5206\u6790\n\n\u50cf\u8fd9\u79cd\u5b50\u6811\u7b54\u6848\u4ec5\u5728\u81ea\u8eab\u6709\u7528\uff0c\u67e5\u8be2\u5b8c\u4fbf\u65e0\u7528\u7684\u9898\u76ee\uff0c\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u7528\u7ebf\u6bb5\u6811\u5408\u5e76\u7ef4\u62a4\u7b54\u6848\uff0c\u5e76\u5728\u904d\u5386\u6811\u7684\u65f6\u5019\u5c06\u5b50\u6811\u7684\u7b54\u6848\u7d2f\u8ba1\u4e0a\u53bb\u3002\n\n\u6240\u4ee5\uff0c\u6211\u4eec\u76f4\u63a5\u7528\u7ebf\u6bb5\u6811\u5408\u5e76\uff0c\u4e0b\u6807\u4e3a\u5bf9\u5e94\u8282\u70b9\u7684\u6df1\u5ea6\u7ef4\u62a4\u5373\u53ef\u3002\n\n\u6211\u4eec\u73b0\u5728\u8003\u8651\u5982\u4f55\u5c06\u4e00\u68f5\u5b50\u6811\u7684\u8d21\u732e\u5408\u5e76\u5230\u6839\u8282\u70b9\u4e0a\u3002\u611f\u89c9\u8fd9\u4e2a\u5f0f\u5b50\u8fd8\u662f\u5f88\u597d\u63a8\u7684\uff0c\u5148\u8bbe\u5f53\u524d\u8282\u70b9\u4e3a $u$\uff0c\u5f53\u524d\u8981\u5408\u5e76\u7684\u5b50\u6811\u4e3a $v$\u3002\n\n\u90a3\u4e48 $v$ \u7684\u5b50\u6811\u5185\u7684\u8ddd\u79bb\u548c\u662f\u4e0d\u4f1a\u6709\u5f71\u54cd\u7684\uff0c\u540c\u7406\u4e4b\u524d\u5df2\u7ecf\u5408\u5e76\u7684\u4e5f\u4e0d\u4f1a\u3002\u8fd9\u90e8\u5206\u7684\u8d21\u732e\u76f4\u63a5\u7d2f\u52a0\u4e0a\u5373\u53ef\uff0c\u73b0\u5728\u7684\u95ee\u9898\u5728\u4e8e\u5982\u4f55\u7edf\u8ba1\u8de8\u5b50\u6811\u7684\u8d21\u732e\u3002\n\n\u6211\u4eec\u8bbe $dis_i$ \u8868\u793a $i$ \u5230\u6839\u8282\u70b9\u7684\u8def\u5f84\u548c\uff0c\u8bbe\u5f53\u524d\u5df2\u7ecf\u88ab\u7edf\u8ba1\u8d21\u732e\u7684\u5b50\u6811\u96c6\u5408\u4e3a $S$\uff0c$v$ \u5b50\u6811\u96c6\u5408\u4e3a $T$\u3002\n\n\u90a3\u4e48\u8de8\u5b50\u6811\u7684\u8d21\u732e\u5373\u4e3a $\\sum\\limits_{x\\in S}\\sum\\limits_{y\\in T} dis_x+dis_y-2\\times dis_u$\uff0c\u6ce8\u610f\u5230 $2\\times dis_u$ \u662f\u4e2a\u5b9a\u503c\uff0c\u6240\u4ee5\u628a\u5b83\u53d6\u51fa\u6765\uff0c\u51cf\u53bb\u7684\u6b21\u6570\u662f\u8fd9\u4e24\u4e2a\u96c6\u5408\u7684\u5927\u5c0f\u4e4b\u79ef\u3002\n\n\u800c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a $dis_x$ \u90fd\u88ab\u8ba1\u7b97\u4e86 $T$ \u96c6\u5408\u5927\u5c0f\u6b21\uff0c$dis_y$ \u8ba1\u7b97\u4e86 $S$ \u96c6\u5408\u5927\u5c0f\u6b21\uff0c\u6240\u4ee5\u5408\u5e76\u7684\u8d21\u732e\u5c31\u88ab\u8f6c\u6362\u6210\u4e86\u5982\u4e0b\u7684\u5f0f\u5b50\u3002\n\n$ans_u = ans_S+ans_T+(\\sum\\limits_{x\\in S}dis_x)\\times |T|+(\\sum\\limits_{y\\in T}dis_y)\\times |S|-2\\times dis_u\\times |S||T|$\u3002\n\n\u8fd9\u4e2a\u5f0f\u5b50\u6211\u4eec\u76f4\u63a5\u7ef4\u62a4 $S$ \u548c $T$ \u7684\u5927\u5c0f\u3001\u8ddd\u79bb\u548c\u4ee5\u53ca\u7b54\u6848\u5373\u53ef\u3002\n\n\u67e5\u8be2\u7684\u8bdd\u5bf9\u4e8e\u6bcf\u4e2a\u8282\u70b9\u5f00\u4e00\u4e2a vector\uff0c\u76f4\u63a5\u626b\u4e00\u904d\uff0c\u7136\u540e\u5728\u7ebf\u6bb5\u6811\u4e0a\u67e5\u8be2\u7b54\u6848\u5373\u53ef\u3002\n\n## \u4ee3\u7801\u7ec6\u8282\n\n\u5176\u5b9e\u8fd9\u91cc\u624d\u662f\u8fd9\u7bc7\u535a\u5ba2\u6700\u7279\u6b8a\u7684\u5730\u65b9\uff0c\u51fa\u9898\u4eba\u628a\u7a7a\u95f4\u5361\u6389\u4e86\uff0c\u6211\u4eec\u9700\u8981\u5bf9\u7ebf\u6bb5\u6811\u5408\u5e76\u8fdb\u884c\u4f18\u5316\u3002\n\n\u7b2c\u4e00\u4e2a\u4f18\u5316\uff0c\u5e9f\u70b9\u56de\u6536\uff0c\u5c06\u4e0d\u7528\u7684\u70b9\u8bb0\u5f55\u4e0b\u6765\uff0c\u5faa\u73af\u4f7f\u7528\uff0c\u7406\u8bba\u4e0a\u7a7a\u95f4\u5df2\u7ecf\u88ab\u964d\u5230 $O(n)$ \u4e86\uff0c\u4f46\u662f\u53ef\u4ee5\u88ab\u7279\u6b8a\u6784\u9020\u5361\u6389\u3002\n\n\u7b2c\u4e8c\u4e2a\u4f18\u5316\uff0c\u5148\u8003\u8651\u6211\u4eec\u5e73\u65f6\u7684\u7ebf\u6bb5\u6811\u5408\u5e76\u600e\u4e48\u5199\u7684\uff1f\n\n```cpp\nbuild(rt[u],1,maxn,dep[u],dis[u]);\nfor(int i=head[u];i;i=edge[i].nxt){\n\tint now = edge[i].to;\n\tif(now==f){\n\t\tcontinue;\n\t}\n\tdis[now] = (dis[u]+edge[i].val)%Mod;\n\tdfs(now,u);\n\trt[u] = merge(rt[u],rt[now],1,maxn,u);\n}\n```\n\n\u8fd9\u91cc\u6709\u54ea\u91cc\u53ef\u4ee5\u4f18\u5316\u5462\uff1f\u6211\u4eec\u53d1\u73b0\u5f53\u524d\u67e5\u8be2\u4e00\u5b9a\u4e0d\u4e0e\u5f53\u524d\u8282\u70b9\u6240\u5728\u6df1\u5ea6\u6709\u5173\uff0c\u4f46\u662f\u6211\u4eec\u65b0\u5efa\u7248\u672c\u7684\u65f6\u5019\u5c31\u987a\u624b\u628a\u5176\u63d2\u5165\u5230\u4e86\u7ebf\u6bb5\u6811\u4e0a\uff0c\u867d\u7136\u67e5\u8be2\u4e0d\u4f1a\u6536\u5230\u5f71\u54cd\uff0c\u4f46\u662f\u7ebf\u6bb5\u6811\u5408\u5e76\u7684\u8fc7\u7a0b\u4e2d\uff0c\u5c31\u4e00\u5b9a\u4f1a\u591a\u51fa\u4e00\u90e8\u5206\u65e0\u610f\u4e49\u7684\u8282\u70b9\uff0c\u4f60\u6bcf\u6b21\u90fd\u8981\u53bb\u9012\u5f52\uff0c\u5c06\u5176\u5408\u5e76\u4e0a\u53bb\u3002\n\n\u8fd9\u6837\u5c31\u5bfc\u81f4\u9012\u5f52\u6b21\u6570\u591a\u7206\u6808\uff0c\u800c\u4e14\u7531\u4e8e\u662f\u5148\u5efa\u6811\u518d\u5408\u5e76\uff0c\u5728\u4e00\u6761\u94fe\u4e0a\u5e9f\u70b9\u56de\u6536\u8fd8\u6ca1\u5f00\u59cb\u5de5\u4f5c\u5462\uff0c\u6211\u4eec\u5c31\u4e00\u76f4\u5728\u65b0\u5efa\u8282\u70b9\u4e86\uff0c\u6240\u4ee5\u4f1a\u628a\u5e9f\u70b9\u56de\u6536\u7684\u7a7a\u95f4\u4f18\u5316\u5361\u6389\uff0c\u4e8b\u5b9e\u4e0a\uff0c\u7ecf\u5e38\u6709\u7ebf\u6bb5\u6811\u5408\u5e76\u7684\u9898\u653e\u4e00\u6761\u94fe\u5b50\uff0c\u4e13\u95e8\u5361\u8fd9\u79cd\u5199\u6cd5\u3002\n\n\u600e\u4e48\u529e\u5462\uff1f\u65e2\u7136\u5f53\u524d\u8282\u70b9\u7684\u8d21\u732e\u4e0d\u5f71\u54cd\u67e5\u8be2\uff0c\u90a3\u6211\u7b49\u4e00\u5207\u90fd\u67e5\u5b8c\u4e86\uff0c\u90fd\u5408\u5e76\u5b8c\u4e86\uff0c\u518d\u5c06\u8d21\u732e\u7d2f\u52a0\u8fdb\u53bb\u4e0d\u5c31\u597d\u4e86\u5417\uff0c\u8fd9\u6837\u5c31\u4fdd\u8bc1\u4e86\u590d\u6742\u5ea6\u3002\n\n\u7ef4\u62a4\u6df1\u5ea6\u7684\u7ebf\u6bb5\u6811\u5408\u5e76\uff0c\u6211\u8bb0\u5f97\u65f6\u95f4\u6ca1\u529e\u6cd5\u5361\u5230 $n^2$\uff0c\u6240\u4ee5\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n\\log n)$\uff0c\u7a7a\u95f4\u5982\u679c\u6211\u6ca1\u60f3\u9519\u7684\u8bdd\uff0c\u53ea\u8981\u52a0\u4e0a\u7b2c\u4e8c\u4e2a\u4f18\u5316\uff0c\u5e9f\u70b9\u56de\u6536\u5c31\u662f\u6b63\u5e38\u7684\u7a7a\u95f4\u590d\u6742\u5ea6\u4e3a\u7ebf\u6027\u3002\n\n## Code\n\n\u8fd9\u56de\u662f\u771f\u7684\u4ee3\u7801\u529b\u3002\n\n```cpp\n#include <iostream>\n#include <cstdio>\n#include <cstring>\n#include <cmath>\n#include <algorithm>\n#include <queue>\nusing namespace std;\nint read(){\n\tint x=0,f=1;char ch=getchar();\n\twhile(ch<'0'||ch>'9'){if(ch=='-')f=-1;ch=getchar();}\n\twhile(ch>='0'&&ch<='9'){x=x*10+ch-'0';ch=getchar();}\n\treturn x*f;\n}\nconst int N = 1e6+10;\nint Mod = 1e9+7;\nstruct aa{\n\tint nxt,to,val;\n}edge[N*2];\nint head[N],tote;\nvoid add(int u,int v,int w){\n\tedge[++tote].nxt = head[u];edge[tote].to = v;head[u] = tote;edge[tote].val = w;\n}\nstruct nod{\n\tint k,id;\n}nod[N];\nint ans[N],dis[N],dep[N],des[N],rt[N],n;\nvector<int>vec[N];\nstruct bb{\n\tint lc,rc,siz,ans,sum;\n\tvoid clear(){\n\t\tlc=rc=siz=ans=sum=0;\n\t}\n}node[N*4];\nint st[N*30],top,tot;\nint newnode(){\n\tif(top){\n\t\tnode[st[top]].clear();\n\t\treturn st[top--];\n\t}else{\n\t\treturn ++tot;\n\t}\n}\nvoid pushup(int u){\n\tnode[u].siz = node[node[u].lc].siz+node[node[u].rc].siz;\n}\nvoid build(int &u,int l,int r,int x,int y){\n\tif(!u){\n\t\tu = newnode();\n\t}\n\tnode[u].siz++;\n\tif(l==r){\n\t\tnode[u].siz = 1;node[u].sum = y%Mod;\n\t\treturn;\n\t}\n\tint mid = (l+r)/2;\n\tif(x<=mid){\n\t\tbuild(node[u].lc,l,mid,x,y);\n\t}else{\n\t\tbuild(node[u].rc,mid+1,r,x,y);\n\t}\n}\nint merge(int u,int v,int l,int r,int x){\n\tif(!u||!v){\n\t\treturn u+v;\n\t}\n\tif(l==r){\n\t\tlong long res = ((1ll*node[u].ans+1ll*node[v].ans%Mod)%Mod+(1ll*node[v].siz%Mod*(1ll*node[u].sum%Mod))%Mod+(1ll*node[u].siz%Mod*(1ll*node[v].sum%Mod))%Mod-(1ll*node[u].siz*node[v].siz%Mod*(2ll*dis[x]%Mod))%Mod+Mod)%Mod;\n\t\tnode[u].ans = int(res);\n\t\tnode[u].sum = (node[u].sum+node[v].sum)%Mod;\n\t\tnode[u].siz = (node[u].siz+node[v].siz)%Mod;\n\t\tst[++top] = v;\n\t\treturn u;\n\t}\n\tint mid = (l+r)/2;\n\tnode[u].lc = merge(node[u].lc,node[v].lc,l,mid,x);\n\tnode[u].rc = merge(node[u].rc,node[v].rc,mid+1,r,x);\n\tst[++top] = v;\n\tpushup(u);\n\treturn u;\n}\nint query(int u,int l,int r,int pla){\n\tif(!u||!node[u].siz){\n\t\treturn 0;\n\t} \n\tif(l==r){\n\t\treturn node[u].ans;\n\t}\n\tint mid = (l+r)/2;\n\tif(pla<=mid){\n\t\treturn query(node[u].lc,l,mid,pla);\n\t}else{\n\t\treturn query(node[u].rc,mid+1,r,pla);\n\t}\n}\nint maxn = 0;\nvoid dfs(int u,int f){\n\tfor(int i=head[u];i;i=edge[i].nxt){\n\t\tint now = edge[i].to;\n\t\tif(now==f){\n\t\t\tcontinue;\n\t\t}\n\t\tdis[now] = (dis[u]+edge[i].val)%Mod;\n\t\tdfs(now,u);\n\t\trt[u] = merge(rt[u],rt[now],1,maxn,u);\n\t}\n\tint siz = vec[u].size();\n\tfor(int i=0;i<siz;i++){\n\t\tint k = nod[vec[u][i]].k;\n\t\tif(dep[u]+k>des[u]){\n\t\t\tans[nod[vec[u][i]].id] = 0;\n\t\t}else{\n\t\t\tans[nod[vec[u][i]].id] = query(rt[u],1,maxn,dep[u]+k);\n\t\t}\n\t}\n\tbuild(rt[u],1,maxn,dep[u],dis[u]);\n} \nvoid fc(int u,int f){\n\tdep[u] = dep[f]+1;\n\tdes[u] = dep[u];\n\tmaxn = max(maxn,dep[u]);\n\tfor(int i=head[u];i;i=edge[i].nxt){\n\t\tint now = edge[i].to;\n\t\tif(now==f){\n\t\t\tcontinue;\n\t\t}\n\t\tfc(now,u);\n\t\tdes[u] = max(des[u],des[now]);\n\t}\n}\nint main(){\n\tint m,u,v,w;\n\tn = read();m = read();\n\tfor(int i=1;i<n;i++){\n\t\tu = read();v = read();w = read();\n\t\tadd(u,v,w);add(v,u,w);\n\t}\n\tfor(int i=1;i<=m;i++){\n\t\tu = read();v = read();\n\t\tnod[i].id = i;nod[i].k = v;\n\t\tvec[u].push_back(i);\n\t}\n\tfc(1,0);\n\tdfs(1,0);\n\tfor(int i=1;i<=m;i++){\n\t\tcout<<ans[i]<<\"\\n\";\n\t}\n\treturn 0;\n}\n```\n## \u66f4\u65b0\n\n\u51fa\u9898\u4eba\u8ddf\u6211\u8bf4\u8fd9\u9053\u9898\u7ebf\u6bb5\u6811\u5408\u5e76\u6211\u8fc7\u4e86\u662f\u56e0\u4e3a\u6ca1\u5361\uff0c\u7136\u540e\u544a\u8bc9\u6211\u600e\u4e48\u505a\u5230\u771f\u6b63\u610f\u4e49\u4e0a\u7684\u7ebf\u6027\u7ebf\u6bb5\u6811\u5408\u5e76\u3002\n\n\u7b80\u5355\u6765\u8bf4\u5c31\u662f\u5148\u8dd1\u4e00\u904d\u91cd\u5256\uff0c\u6211\u4eec\u6bcf\u6b21\u5408\u5e76\u7684\u65f6\u5019\u4f18\u5148\u5408\u5e76\u91cd\u513f\u5b50\u5373\u53ef\u3002\n\n\u590d\u6742\u5ea6\u4e5f\u4e0d\u4f1a\u53d8\uff0c\u53ea\u662f\u4f18\u5316\u5230\u4e0d\u88ab\u5361\u4e86\u3002\u653e\u4e00\u4e0b\u8fd9\u90e8\u5206\u7684[\u53c2\u8003\u6587\u7ae0](https://www.luogu.com.cn/blog/DPair2005/post-on-kong-jian-xian-duan-shu-ge-bing-post)\u3002\n\n\u6570\u5b66\u5f0f\u5b50\u8981\u662f\u54ea\u91cc\u5199\u9519\u4e86\uff0c\u90a3\u5c31\u8bf7\u5927\u5bb6\u5ffd\u89c6\u5427\uff0c\u4e3b\u8981\u662f\u60f3\u5ba3\u4f20\u4e00\u4e0b\u7ebf\u6bb5\u6811\u5408\u5e76\u505a\u6cd5\u3002",
        "postTime": 1673506658,
        "uid": 369399,
        "name": "yizhiming",
        "ccfLevel": 0,
        "title": "\u9898\u89e3\u3010P7581 \u300cRdOI R2\u300d\u8def\u5f84\u6743\u503c(distance)\u3011"
    },
    {
        "content": "[$\\huge\\texttt{P7581}$](https://www.luogu.com.cn/problem/P7581)\n\n[$\\texttt{My cnblogs}$](https://www.cnblogs.com/RedreamMer/p/14732487.html)\n\n## \u524d\u8a00\n\n\u521a\u5b66\u4e86\u957f\u5256\uff0c\u6bd4\u8d5b\u5feb\u7ed3\u675f\u7684\u65f6\u5019\u8fdb\u6765\u770b\u4e86\u4e00\u773c\uff0c\u53e3\u80e1\u79d2\u4e86\uff0c\u5199\u7684\u65f6\u5019\u53d1\u73b0\u5de8\u5927\u591a\u7ec6\u8282\uff0c~~\u53e3\u80e1\u4e0d\u884c~~\u3002\n\n\u957f\u5256\u6c38\u5b58\uff0c\u7a7a\u95f4\u5361\u7684\u597d\u554a\uff01\n\n## \u9898\u610f\n\n\u4e0d\u505a\u8d58\u8ff0\u3002\n\n## \u601d\u8def\n\n\u9996\u5148\u770b\u5230\u8fd9\u662f\u4e00\u9053\u548c\u6df1\u5ea6\u6709\u6781\u5927\u7684\u5173\u7cfb\uff0c\u81ea\u7136\u8054\u60f3\u5230\u5efa\u51e0\u4e2a\u4ee5\u6df1\u5ea6\u4e3a\u4e0b\u6807\u7684\u6570\u7ec4\u901a\u8fc7 DFS \u904d\u5386\u5e76\u52a8\u6001\u4fee\u6539\u89e3\u51b3\u95ee\u9898\uff0c\u800c\u4e14\u53ef\u4ee5\u7528\u542f\u53d1\u5f0f\u5408\u5e76\u7684\u7c7b\u4f3c\u601d\u8def\u5408\u5e76\u5b50\u6811\u4fe1\u606f\uff0c\u56e0\u6b64\u80fd\u8054\u60f3\u5230\u7528\u957f\u94fe\u5256\u5206\u89e3\u51b3\u95ee\u9898\u3002\n\n\u4f46\u662f\u957f\u94fe\u5256\u5206\u5bf9\u6570\u7ec4\u7a7a\u95f4\u548c\u5bf9\u5b50\u6811\u4fe1\u606f\u7ee7\u627f\u5173\u7cfb\u8981\u6c42\u6bd4\u8f83\u82db\u523b\uff0c\u6bd4\u5982\u4e00\u5f00\u59cb\u6211\u662f\u8fd9\u4e48\u60f3\u7684\uff1a\n\n+ \u8bb0\u5f55 $val[u][i]$ \u8868\u793a\u4ee5 $u$ \u4e3a\u6839\u7684\u5b50\u6811\u6240\u6709\u6df1\u5ea6\u4e3a $i$ \u7684\u8282\u70b9\u5230 $u$ \u7684\u8def\u5f84\u957f\u5ea6\u4e4b\u548c\u3002\n+ \u8bb0\u5f55 $dis[u][i]$ \u8868\u793a\u4ee5 $u$ \u4e3a\u6839\u7684\u5b50\u6811\u6240\u6709\u6df1\u5ea6\u4e3a $i$ \u7684\u8282\u70b9\u4e4b\u95f4\u7684\u8ddd\u79bb\u4e4b\u548c\u3002\n+ \u8bb0\u5f55 $siz[u][i]$ \u8868\u793a\u4ee5 $u$ \u4e3a\u6839\u7684\u5b50\u6811\u6240\u6709\u6df1\u5ea6\u4e3a $i$ \u7684\u8282\u70b9\u7684\u4e2a\u6570\u3002\n\n$dis[u]$ \u548c $siz[u]$ \u7684\u8f6c\u79fb\u90fd\u5f88\u597d\u5199\uff1a\n\n$$\ndis[u][i]=\\sum_{v\\in son(u)}dis[v][i-1]+(siz[u][i]-siz[v][i-1])*(val[v][i-1]+siz[v][i-1]*w(u,v))\n$$\n\n\uff08\u4e0a\u9762\u7684\u516c\u5f0f\u5728\u4ee3\u7801\u4e2d\u4e3a\u4e86\u65b9\u4fbf\u5e76\u4e0d\u662f\u5982\u6b64\u4e00\u6a21\u4e00\u6837\u5b9e\u73b0\uff09\n\n$$\nsiz[u][i]=[i==0]+\\sum_{v\\in son(n)}siz[v][i-1]\n$$\n\n\u4f46\u662f\u5bf9\u4e8e $val[u]$ \u7684\u8f6c\u79fb\u5c31\u51fa\u4e86\u95ee\u9898\uff0c\u56e0\u4e3a $val[u]$ \u7684\u503c\u548c $u$ \u8fd9\u4e2a\u70b9\u6709\u5173\uff0c\u4e5f\u5c31\u662f\u8bf4\u4ece\u91cd\u513f\u5b50\u8f6c\u79fb\u8fc7\u6765\u7684\u8fd8\u8981\u52a0\u4e0a\u4e00\u4e2a\u503c\uff08\u8fd8\u548c $siz[maxson(u)][i]$ \u6709\u5173\uff09\uff0c\u4e0d\u80fd\u76f4\u63a5\u7ee7\u627f\uff0c\u800c\u66b4\u529b\u518d\u679a\u4e3e\u4e00\u904d\u91cd\u513f\u5b50\u7684\u6df1\u5ea6\u518d\u52a0\u663e\u7136\u590d\u6742\u5ea6\u9519\u8bef\u3002\n\n\u4ee5\u4e0b\u4e0e\u51fa\u9898\u4eba\u601d\u8def\u4e0d\u540c\u3002\n\n\u4f46\u662f\u8fd8\u662f\u53ef\u4ee5\u4f18\u5316\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u518d\u5efa\u4e00\u4e2a $tag[u]$ \u6570\u7ec4\uff0c\u5373\u61d2\u6807\u8bb0\u4f18\u5316\uff0c\u6bcf\u6b21 $u$ \u8282\u70b9\u5408\u5e76\u524d\uff0c\u56e0\u4e3a\u5148\u7ee7\u627f\u4e86\u91cd\u513f\u5b50\u7684 $val[u]$ \u6570\u7ec4\uff0c\u6211\u4eec\u9700\u8981\u5728 $tag[u][1]$ \u52a0\u4e0a\u4e00\u4e2a $w(u,maxson(u))$\uff0c\u5f53\u8981\u8bbf\u95ee $val[u][i]$ \u7684\u65f6\u5019\uff0c\u6211\u4eec\u8981\u5148\u8bbf\u95ee\u61d2\u6807\u8bb0\uff0c\u66f4\u65b0\u5e76\u4e0b\u4f20\uff0c\u56e0\u4e3a\u4e0b\u7a7f\u61d2\u6807\u8bb0\u5728\u66f4\u65b0 $val[u][i]$ \u548c $siz[u][i]$ \u524d\uff0c\u6240\u4ee5\u4e0d\u4f1a\u8bbf\u95ee\u5230 $dis[u][i]$\uff0c\u6240\u4ee5\u52a0\u503c\u5ef6\u8fdf\u4e0d\u4f1a\u5f71\u54cd\u6700\u7ec8\u5927\u5c0f\u3002\n\n\n\n## \u4ee3\u7801\n\n\u611f\u89c9\u8fd9\u6837\u53e3\u80e1\u8fd8\u662f\u6709\u70b9\u96be\u61c2QwQ\u3002\n\n\u76ee\u524d\u9664\u51fa\u9898\u4eba\u5916\u7684\u6700\u4f18\u89e3\uff0c\uff08~~rk1\u662f\u6570\u636e\u6539\u4e4b\u524d\u4ea4\u7684~~\uff09\u3002\n\n```cpp\nint a, b, mx[N + 5],\n    son[N + 5][2];\nLL op[N * 8 + 5], *tag[N + 5], ans[N + 5], *dis[N + 5], *val[N + 5], *tmp = op, *siz[N + 5];\nvector<pii> st[N + 5], ask[N + 5];\n\nvoid ins(int n, int len) {\n    val[n] = tmp;\n    tmp += len + 1;\n    dis[n] = tmp;\n    tmp += len + 1;\n    siz[n] = tmp;\n    tmp += len + 1;\n    tag[n] = tmp;\n    tmp += len + 1;\n}\nvoid add(int n, int i) {\n    (tag[n][i + 1] += tag[n][i]) %= mod;\n    (val[n][i] += tag[n][i] * siz[n][i] % mod) %= mod;\n    tag[n][i] = 0;\n}\nvoid dfs(int n, int fa) {\n    mx[n] = 1;\n    rep(i, 0, siz(st[n]) - 1) {\n        int v = st[n][i].fi;\n        if (v == fa) continue;\n        dfs(v, n);\n        if (mx[v] > mx[son[n][0]]) son[n][0] = v, son[n][1] = st[n][i].se;\n    }\n    mx[n] = mx[son[n][0]] + 1;\n}\nvoid Dfs(int n, int fa) {\n    if (son[n][0]) {\n        val[son[n][0]] = val[n] + 1;\n        dis[son[n][0]] = dis[n] + 1;\n        siz[son[n][0]] = siz[n] + 1;\n        tag[son[n][0]] = tag[n] + 1;\n        Dfs(son[n][0], n);\n    }\n    siz[n][0] = 1;\n    tag[n][1] = son[n][1];\n    rep(i, 0, siz(st[n]) - 1) {\n        int v = st[n][i].fi, p = st[n][i].se;\n        if (v == fa || v == son[n][0]) continue;\n        ins(v, mx[v]);\n        Dfs(v, n);\n        rep(j, 1, mx[v]) {\n            if (j != mx[v]) add(v, j);\n            add(n, j);\n            (dis[n][j] += val[n][j] * siz[v][j - 1] % mod +\n                          (val[v][j - 1] + p * siz[v][j - 1] % mod) *\n                          siz[n][j] % mod + dis[v][j - 1]) %= mod;\n            (val[n][j] += val[v][j - 1] + p * siz[v][j - 1] % mod) %= mod;\n            (siz[n][j] += siz[v][j - 1]) %= mod;\n        }\n    }\n    rep(i, 0, siz(ask[n]) - 1) {\n        int x = ask[n][i].fi;\n        ans[ask[n][i].se] = dis[n][x];\n    }\n}\n\nsigned main() {\n    // freopen(\"in1.in\", \"r\", stdin);\n    // freopen(\"out.out\", \"w\", stdout);\n    a = read();\n    b = read();\n    int x, y, z;\n    rep(i, 1, a - 1) {\n        x = read();\n        y = read();\n        z = read();\n        st[x].PB(MP(y, z));\n        st[y].PB(MP(x, z));\n    }\n    dfs(1, 0);\n    rep(i, 1, b) {\n        x = read();\n        y = read();\n        if (y <= mx[x] - 1)\n            ask[x].PB(MP(y, i));\n    }\n    ins(1, mx[1]);\n    Dfs(1, 0);\n    rep(i, 1, b) printf(\"%lld\\n\", ans[i]);\n    return 0;\n}\n```\n\n",
        "postTime": 1620213922,
        "uid": 184549,
        "name": "RedreamMer",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P7581 \u3010\u300cRdOI R2\u300d\u8def\u5f84\u6743\u503c(distance)\u3011"
    },
    {
        "content": "### [\u300cRdOI R2\u300d\u8def\u5f84\u6743\u503c(distance)](https://www.luogu.com.cn/problem/P7581)\n\n\u8be2\u95ee $i$ \u7684 $k$ \u7ea7\u5b69\u5b50\u7684\u4e92\u76f8\u4e4b\u95f4\u7684\u8ddd\u79bb\u548c\u3002\n\n\u5bb9\u6613\u53d1\u73b0\u6211\u4eec\u53ef\u4ee5\u79bb\u7ebf\u901a\u8fc7\u7ebf\u6bb5\u6811\u5408\u5e76\u6c42\u51fa\u67d0\u4e2a\u70b9\u7684 $k-th$ \u5b69\u5b50\uff0c\u4e5f\u53ef\u4ee5\u6c42\u51fa $k-th$ \u5b69\u5b50\u5230\u4ed6\u7684\u8ddd\u79bb\u603b\u548c\u3002\n\n\u6211\u4eec\u5efa\u7acb\u4e00\u68f5\u7ebf\u6bb5\u6811\uff0c\u6309\u7167**\u6df1\u5ea6**\u4f5c\u4e3a\u4e0b\u6807\u3002\n\n\u91cc\u9762\u6709 $3$ \u4e2a\u53d8\u91cf\u3002\n\n$sum_{i,j}$ \u5b58\u50a8\u7684\u662f $i$ \u7684\u5b50\u6811\u4e2d\uff0c\u6df1\u5ea6\u4e3a $j$ \u7684\u70b9\u4e92\u76f8\u5230\u8fbe\u7684\u8ddd\u79bb\u603b\u548c\u3002\n\n$dis_{i,j}$ \u5b58\u50a8\u7684\u662f $i$ \u7684\u5b50\u6811\u4e2d\uff0c\u6df1\u5ea6\u4e3a $j$ \u7684\u70b9\u5230 $i$ \u7684\u8ddd\u79bb\u548c\u3002\n\n$num_{i,j}$ \u5b58\u50a8\u7684\u662f $i$ \u7684\u5b50\u6811\u4e2d\uff0c\u6df1\u5ea6\u4e3a $j$ \u7684\u70b9\u7684\u6570\u91cf\u3002\n\n\u4ee5\u4e0a\u53ea\u662f\u65b9\u4fbf\u8868\u8fbe\uff0c\u5bf9\u4e8e\u67d0\u4e00\u4e2a\u503c\u5982 $num_{i,j}$\uff0c\n\n\u6211\u4eec\u662f\u8981\u901a\u8fc7\u7ebf\u6bb5\u6811\u67e5\u8be2\u51fa\u6765\u7684\u3002\n\n\u5047\u5982\u6211\u4eec\u8981\u5c06 $i$ \u7684\u7ebf\u6bb5\u6811\u7b97\u51fa\u6765\uff0c\u6211\u4eec\u5c31\u8981\u5c06 ${j\\in son_i}$ \u5168\u90e8\u5408\u5e76\u4e0a\u6765\u3002\n\n\u5047\u5982\u6211\u4eec\u73b0\u5728\u5408\u5e76\u5230\u4e86 $j$\uff0c\u5e94\u8be5\u5c06\u6df1\u5ea6\u4e3a $k$ \u5408\u5e76\u4e0a\u6765\u3002\n\n- $num$\n\n\t![](https://cdn.luogu.com.cn/upload/image_hosting/4dy601yj.png)\n\n\t\u5047\u5982 $i=1,j=3,k=3$ \u6211\u4eec\u5408\u5e76\u5b8c $2$ \u540e\uff0c $num_{1,3}=2$\uff0c\u6211\u4eec\u76f4\u63a5\u5c06 $num_{1,3}$ \u52a0\u4e0a $num_{3,3}$ \u5373\u53ef\u3002\n\t\n- $dis$\n\n\t![](https://cdn.luogu.com.cn/upload/image_hosting/z3myugw9.png)\n\n\t\u6211\u4eec\u5df2\u7ecf\u5408\u5e76\u5b8c\u4e86 $2$ \u6b64\u65f6 $dis_{1,3}=1+3+1+4=9$\uff0c\u73b0\u5728\u6211\u4eec\u8981\u5c06 $dis_{3,3}$ \u4e5f\u5408\u5e76\u4e0a\u6765\uff0c\u8003\u8651\u6240\u6709\u5728 $j$ \u7684\u5b50\u6811\u4e2d\u6df1\u5ea6\u4e3a $k$ \u7684\u70b9\u5230 $i$ \u7684\u8ddd\u79bb\u548c\u5230 $j$ \u7684\u8ddd\u79bb\u7684\u5dee\u522b\uff0c\u5bb9\u6613\u53d1\u73b0\u53ea\u662f\u591a\u4e86\u4e00\u6761\u8fb9 $w_{1,3}$\uff0c\u6bcf\u4e00\u4e2a\u8fd9\u6837\u7684\u70b9\u90fd\u4f1a\u591a\u4e00\u6b21 $w_{1,3}$\uff0c\u800c\u8fd9\u6837\u7684\u70b9\u6709 $num_{3,3}$ \u4e2a\uff0c\u6240\u4ee5\u6211\u4eec\u7684 $dis_{1,3}$ \u52a0\u4e0a $dis_{3,3}+num_{3,3}\\times w_{1,3}$.\n    \n- $sum$\n\n\t\u8003\u8651\u5339\u914d\u7684\u5b9e\u9645\u610f\u4e49\uff0c\u9996\u5148\uff0c$j$ \u5b50\u6811\u5185\u7684\u70b9\u7684\u4e92\u76f8\u95f4\u7684\u8ddd\u79bb\u5c31\u662f $sum_{j,k}$\uff0c\u8fd9\u4e2a\u4e0d\u7528\u518d\u7b97\uff0c\u9700\u8981\u989d\u5916\u8ba1\u7b97\u7684\u662f\u4e0d\u540c\u5b50\u6811\u4e4b\u95f4\u7684\u6bd4\u5982 $5\\to 7$ \u4e4b\u95f4\u7684\u8ddd\u79bb\u3002\n    \n    ![](https://cdn.luogu.com.cn/upload/image_hosting/az397iaq.png)\n    \n    \u800c\u8fd9\u6761\u8def\u5f84\u53c8\u88ab\u5206\u4e3a\u4e24\u90e8\u5206\uff0c\u4e00\u90e8\u5206\u662f\u5df2\u7ecf\u88ab\u5408\u5e76\u7684\u70b9\u5230\u6839\u8282\u70b9\u7684\u8ddd\u79bb\uff0c\u4e00\u90e8\u5206\u662f\u672a\u5408\u5e76\u7684\u70b9\u5230\u6839\u8282\u70b9\u7684\u8ddd\u79bb\u3002\n    \u8003\u8651\u6bcf\u4e00\u4e2a\u662f $j$ \u7684\u5b50\u6811\u4e2d\u4e14\u6df1\u5ea6\u4e3a $k$ \u7684\u70b9 $p$\u3002\n    \n    \u90a3\u4e48\u6240\u6709\u9700\u8981\u548c $p$ \u5339\u914d\u7684\u70b9\u5c31\u662f\u5df2\u7ecf\u548c $i$ \u5408\u5e76\u7684\u4e14\u6df1\u5ea6\u4e3a $k$ \u7684\u70b9\uff0c\u6211\u4eec\u53ef\u4ee5\u5f88\u5bb9\u6613\u7684\u7b97\u51fa\u7eff\u8272\u8def\u5f84\u7684\u6743\u503c\uff0c\u5176\u5b9e\u5c31\u662f $dis_{i,k}$ \u56e0\u4e3a\u6bcf\u4e00\u4e2a\u90fd\u8981\u548c $p$ \u5339\u914d\uff0c\u800c\u8fd9\u6837\u7684 $p$ \u53c8\u6709 $num_{j,k}$ \u4e2a\uff0c\u6240\u4ee5 $sum_{i,k}$ \u52a0\u4e0a $dis_{i,k}\\times num_{j,k}$\u3002\n    \n    \u73b0\u5728\u6211\u4eec\u8003\u8651\u84dd\u7ebf\u7684\u8d21\u732e\uff0c\u8fd9\u65f6\u5019\u53ef\u4ee5\u53cd\u8fc7\u6765\u601d\u8003\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u5df2\u7ecf\u88ab\u5408\u5e76\u5230 $i$ \u4e14\u6df1\u5ea6\u4e3a $k$ \u7684\u70b9 $p$\uff0c\u4ed6\u4f1a\u548c $num_{j,k}$ \u4e2a\u70b9\u5339\u914d\uff0c\u800c\u8fd9\u4e9b\u70b9\u7684 $dis$ \u548c\u6709\u6070\u597d\u662f $dis_{j,k}$\uff0c\u8fd9\u6837\u7684\u70b9 $p$ \u6709 $num_{i,k}$ \u4e2a\uff0c\u6240\u4ee5   $sum_{i,k}=sum_{i,k}+dis_{j,k}\\times num_{i,k}$\u3002\uff08\u8fd9\u91cc\u7684 $dis_{j,k}$ \u4e00\u5b9a\u8981\u662f\u589e\u52a0\u4e86 $w_{i,j}$ \u7684 $dis_{j,k}$\uff09\n    \n\u8fd9\u5c31\u662f\u6240\u6709\u7684\u5408\u5e76\u4e86\uff0c\u4f46\u662f\u9700\u8981\u6ce8\u610f\u987a\u5e8f\uff0c\u6211\u4eec\u8981\u5148\u4fee\u6539 $dis$ \u7136\u540e\u4fee\u6539 $sum$\uff0c\u6700\u540e\u4fee\u6539 $num$\uff0c\u56e0\u4e3a $sum$ \u4f1a\u7528\u5230\u6ca1\u6709\u5408\u5e76 $j$ \u7684 $num_{i,k}$\uff0c\u548c\u5408\u5e76\u540e\u7684 $dis$\u3002\n\n\u5904\u7406\u8be2\u95ee\u5bf9\u6bcf\u4e00\u4e2a\u70b9\u5efa\u7acb `vector` \u5b58\u50a8\u5373\u53ef\u3002\n\n\u5bf9\u4e8e\u4fee\u6539 $dis$\uff0c\u9700\u8981\u4e00\u4e2a\u61d2\u6807\u8bb0\u6765\u8bb0\u5f55\u3002\n\n\u770b\u4ee3\u7801\uff01\n\n### $\\text{CODE}$\n\n```cpp\n#include<bits/stdc++.h>\n#define N 1000006\n#define lc tr[now].ls\n#define rc tr[now].rs\n#define mod 1000000007\nusing namespace std;\nint read()\n{\n\tint x=0,f=1;char ch=getchar();\n\twhile(ch<'0'||ch>'9'){if(ch=='-')f=-1;ch=getchar();}\n\twhile(ch>='0'&&ch<='9'){x=x*10+ch-'0';ch=getchar();}\n\treturn x*f;\n}\nint n,m,ans[N],rt[N],dep[N],d;\nstruct fig\n{\n\tint to,next,val;\n}k[N*2];int head[N],tot;\nvoid add(int from,int to,int val)\n{\n\tk[++tot].to=to;\n\tk[tot].next=head[from];\n\tk[tot].val=val;\n\thead[from]=tot;\n}\nvector<pair<int,int> >v[N];\nstruct node\n{\n\tint sum,num,dis;\n}kl[N*4];int cwc;\nstruct tree\n{\n\tint ls,rs,lz,id;\n\tvoid clear(){id=ls=rs=lz=0;}\n}tr[N*8];int cnt;\nqueue<int> q;\nint news(int l,int r)\n{\n\tint now;\n\tif(q.size())now=q.front(),q.pop();\n\telse now=++cnt;\n\ttr[now].clear();\n\tif(l==r)tr[now].id=++cwc;\n\treturn now;\n}\nvoid add(int &a,int b)\n{\n\ta%=mod;b%=mod;\n\ta=(1ll*a+b)%mod;\n}\nvoid down(int now)\n{\n\tif(tr[now].lz)\n\t{\n\t\tadd(kl[tr[lc].id].dis,1ll*kl[tr[lc].id].num*tr[now].lz%mod);\n\t\tadd(kl[tr[rc].id].dis,1ll*kl[tr[rc].id].num*tr[now].lz%mod);\n\t\tadd(tr[rc].lz,tr[now].lz);\n\t\tadd(tr[lc].lz,tr[now].lz);\n\t\ttr[now].lz=0;\n\t}\n}\nint merge(int x,int y,int l,int r,int val)\n{\n\tif(!x)\n\t{\n\t\ttr[y].lz+=val;\n\t\tadd(kl[tr[y].id].dis,1ll*kl[tr[y].id].num*val%mod);\n\t\treturn y;\n\t}\n\tif(!y)return x;\n\tdown(x);down(y);\n\tif(l==r)\n\t{\n\t\tadd(kl[tr[y].id].dis,1ll*kl[tr[y].id].num*val%mod);\n\t\tadd(kl[tr[x].id].sum,1ll*kl[tr[x].id].dis*kl[tr[y].id].num%mod);\n\t\tadd(kl[tr[x].id].sum,1ll*kl[tr[x].id].num*kl[tr[y].id].dis%mod);\n\t\tadd(kl[tr[x].id].sum,kl[tr[y].id].sum);\n\t\tadd(kl[tr[x].id].dis,kl[tr[y].id].dis);\n\t\tadd(kl[tr[x].id].num,kl[tr[y].id].num);\n\t\tq.push(y);\n\t\treturn x;\n\t}\n\tint mid=(l+r)>>1;\n\ttr[x].ls=merge(tr[x].ls,tr[y].ls,l,mid,val);\n\ttr[x].rs=merge(tr[x].rs,tr[y].rs,mid+1,r,val);\n\tq.push(y);\n\treturn x;\n}\nint que(int now,int l,int r,int x)\n{\n\tif(!now)return 0;\n\tif(l==r)return kl[tr[now].id].sum;\n\tdown(now);int mid=(l+r)>>1;\n\tif(mid>=x)return que(lc,l,mid,x);\n\treturn que(rc,mid+1,r,x);\n}\nvoid add(int now,int l,int r,int x)\n{\n\tif(l==r)\n\t{\n\t\tkl[tr[now].id].num++;\n\t\treturn;\n\t}\n\tdown(now);\n\tint mid=(l+r)>>1;\n\tif(mid>=x)\n\t{\n\t\tif(!lc)lc=news(l,mid);\n\t\tadd(lc,l,mid,x);\n\t}\n\telse \n\t{\n\t\tif(!rc)rc=news(mid+1,r);\n\t\tadd(rc,mid+1,r,x);\n\t}\n}\nvoid pf(int now,int fa)\n{\n\tdep[now]=dep[fa]+1;d=max(d,dep[now]);\n\tfor(int i=head[now];i;i=k[i].next)\n\t{\n\t\tif(k[i].to==fa)continue;\n\t\tpf(k[i].to,now);\n\t}\n}\nvoid dfs(int now,int fa)\n{\n\trt[now]=++cnt;\n\tfor(int i=head[now];i;i=k[i].next)\n\t{\n\t\tif(k[i].to==fa)continue;\n\t\tdfs(k[i].to,now);\n\t\trt[now]=merge(rt[now],rt[k[i].to],1,d,k[i].val);\n\t}\n\tadd(rt[now],1,d,dep[now]);\n\tfor(int i=0;i<(int)v[now].size();i++)\n\t{\n\t\tif(v[now][i].first+dep[now]>d)continue;\n\t\tans[v[now][i].second]=que(rt[now],1,d,v[now][i].first+dep[now]);\n\t}\n}\nint main()\n{\n\tn=read();m=read();\n\tfor(int i=1,u,v,w;i<n;i++)\n\t{\n\t\tu=read();v=read();w=read();\n\t\tadd(u,v,w);add(v,u,w);\n\t}\n\tfor(int i=1,u,k;i<=m;i++)\n\t{\n\t\tu=read();k=read();\n\t\tv[u].push_back(make_pair(k,i));\n\t}\n\tpf(1,0);\n\tdfs(1,0);\n\tfor(int i=1;i<=m;i++)cout<<ans[i]<<\"\\n\";\n\treturn 0;\n}\n```",
        "postTime": 1677885148,
        "uid": 331947,
        "name": "hegm",
        "ccfLevel": 0,
        "title": "P7581 \u300cRdOI R2\u300d\u8def\u5f84\u6743\u503c(distance) \u9898\u89e3"
    }
]