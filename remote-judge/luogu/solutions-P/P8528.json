[
    {
        "content": "\u9996\u5148\u8003\u8651\u626b\u63cf\u7ebf\uff0c\u626b\u63cf\u53f3\u7aef\u70b9\u3002\n\n\u8003\u8651\u4e00\u5bf9\u70b9\u5bf9 $a,b(a<b)$ \u4e0e\u5176 LCA $c$\uff0c\u4f1a\u5bfc\u51fa\u4ec0\u4e48\u9650\u5236\u3002\n\n\u5982\u679c $a<c<b$\uff0c\u5219\u6ca1\u6709\u4efb\u4f55\u9650\u5236\u3002\n\n\u5982\u679c $a<b<c$\uff0c\u90a3\u4e48\u53f3\u7aef\u70b9\u626b\u5230 $b$ \u65f6\u4f1a ban \u6389 $[1,a]$ \u8fd9\u4e2a\u5de6\u7aef\u70b9\u533a\u95f4\uff0c\u626b\u5230 $c$ \u65f6\u4e0d\u518d\u7981\u6b62 $[1,a]$ \u8fd9\u4e2a\u5de6\u7aef\u70b9\u533a\u95f4\u3002\n\n\u5982\u679c $c<a<b$\uff0c\u90a3\u4e48\u53f3\u7aef\u70b9\u626b\u5230 $b$ \u65f6\u4f1a ban \u6389 $[c+1,a]$ \u8fd9\u4e2a\u5de6\u7aef\u70b9\u533a\u95f4\u3002\n\n\u8be2\u95ee\u662f\u4e8c\u7ef4\u6570\u70b9\uff0c\u53ea\u8981\u7ef4\u62a4\u4e00\u68f5\u7ebf\u6bb5\u6811\uff0c\u652f\u6301\u533a\u95f4\u52a0\u3001\u51cf ban \u7684\u6807\u8bb0\u4e2a\u6570\uff0c\u533a\u95f4\u7ed9\u7981\u6b62\u6807\u8bb0\u4e3a 0 \u7684\u70b9\u7b54\u6848\u52a0\u4e0a 1\uff0c\u533a\u95f4\u8be2\u95ee\u7b54\u6848\u7684\u548c\u3002\u8fd9\u662f\u597d\u7ef4\u62a4\u7684\u3002\n\n\u4f46\u73b0\u5728\u8fd8\u6709 $n^2$ \u4e2a\u9650\u5236\u6761\u4ef6\uff0c\u8003\u8651\u4f18\u5316\u3002\n\n\u5bf9\u4e8e\u4e24\u4e2a\u9650\u5236\u6761\u4ef6 $([a,b],c)$ \u548c $([d,e],c)$\uff0c\u5982\u679c $[a,b]$ \u88ab $[d,e]$ \u5305\u542b\u5c31\u53ef\u4ee5\u4e22\u6389\u9650\u5236 $([d,e],c)$\u3002\u628a\u4fdd\u7559\u4e0b\u6765\u7684\u79f0\u4e3a\u6709\u7528\u70b9\u5bf9\u3002\n\n\u56e0\u6b64\u5bf9\u4e8e\u67d0\u4e2a\u7956\u5148 $c$\uff0c\u4e00\u4e2a\u70b9 $a$ \u80fd\u4f5c\u4e3a\u6709\u7528\u70b9\u5bf9\uff0c\u627e\u7684\u53e6\u4e00\u4e2a\u70b9 $b$ \u4e00\u5b9a\u662f $c$ \u5176\u4ed6\u5b50\u6811\u4e2d $a$ \u7684\u524d\u9a71\u540e\u7ee7\u3002\n\n\u8003\u8651 dsu on tree \u7684\u8fc7\u7a0b\u3002\u628a\u5f53\u524d $c$ \u7684\u82e5\u5e72\u4e2a\u5b50\u6811\u7684\u70b9\u52a0\u8fdb set \u91cc\uff0c\u5728\u52a0\u5165\u4e00\u4e2a\u65b0\u5b50\u6811\u65f6\uff0c\u5bf9\u5f53\u524d set \u91cc\u67e5\u524d\u9a71\u540e\u7ee7\u5c31\u53ef\u4ee5\u5f97\u5230\u6240\u6709\u6709\u7528\u70b9\u5bf9\u3002\n\n\u6309\u7167\u8fd9\u79cd\u65b9\u6cd5\uff0c\u6709\u7528\u70b9\u5bf9\u7684\u4e2a\u6570\u5c31\u662f dsu on tree \u7684\u590d\u6742\u5ea6\uff0c\u4e3a $n\\log n$ \u4e2a\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log^2 n+q\\log n)$\u3002\n\n```cpp\n#define For(i,a,b) for(int i=(a);i<=(b);++i)\n#define Rep(i,a,b) for(int i=(a);i>=(b);--i)\n#define ll long long\nusing namespace std;\n\n#define fi first\n#define se second\n#define pb push_back\n#define mkp make_pair\ntypedef pair<int,int>pii;\ntypedef vector<int>vi;\n\n#define maxn 500005\n#define inf 0x3f3f3f3f\n\nint n,m;\nvi e[maxn];\n\nvector<pii>vec[maxn];\nvoid add(int a,int b,int c){\n\tassert(a<b);\n\tif(a<c && c<b) return;\n\tif(b<c) vec[b].pb(mkp(1,a)),vec[c].pb(mkp(-1,-a)); \n\telse vec[b].pb(mkp(c+1,a));\n}\n\nint fa[maxn],son[maxn],sz[maxn];\nint dfn[maxn],out[maxn],idx,que[maxn]; \nvoid dfs(int u,int pa){\n\tsz[u]=1;\n\tdfn[u]=++idx,que[idx]=u;\n\tfor(auto v:e[u]){\n\t\tif(v==pa)continue;\n\t\tfa[v]=u,dfs(v,u),sz[u]+=sz[v];\n\t\tif(sz[v]>sz[son[u]])son[u]=v;\n\t}out[u]=idx;\n}\n\nint up;\nset<int>s;\nvoid make(int u){\n\tauto it=s.lower_bound(u);\n\tif(it!=s.end()) add(u,*it,up);\n\tif(it!=s.begin()) add(*prev(it),u,up);\n}\n\nvoid ins(int u){\n\tFor(i,dfn[u],out[u])\n\t\ts.insert(que[i]);\n}\nvoid del(int u){\n\tFor(i,dfn[u],out[u])\n\t\ts.erase(que[i]);\n}\nvoid query(int u){\n\tFor(i,dfn[u],out[u])\n\t\tmake(que[i]);\n}\n\nvoid solve(int u)\n{\n\tfor(auto v:e[u]){\n\t\tif(v==son[u]||v==fa[u])continue;\n\t\tsolve(v),del(v);\n\t}\n\tif(son[u])solve(son[u]);\n\tfor(auto v:e[u]){\n\t\tif(v==son[u]||v==fa[u])continue;\n\t\tup=u,query(v),ins(v);\n\t}\n\ts.insert(u);\n}\n\nint p[maxn];\nll res[maxn];\nvector<pii>q[maxn];\n\nnamespace T{\n\nll sum[maxn<<2];\nint mn[maxn<<2],tag1[maxn<<2],tag2[maxn<<2],cnt[maxn<<2];\nvoid up(int p){\n\tsum[p]=sum[p<<1]+sum[p<<1|1];\n\tmn[p]=min(mn[p<<1],mn[p<<1|1]);\n\tcnt[p]=cnt[p<<1]*(mn[p]==mn[p<<1])+cnt[p<<1|1]*(mn[p]==mn[p<<1|1]); \n}\nvoid pt1(int p,int v){tag1[p]+=v,mn[p]+=v;}\nvoid pt2(int p,int v){tag2[p]+=v,sum[p]+=1ll*cnt[p]*v;}\nvoid down(int p){\n\tif(tag1[p])pt1(p<<1,tag1[p]),pt1(p<<1|1,tag1[p]);\n\tif(tag2[p]){\n\t\tif(mn[p<<1]<=mn[p<<1|1]) pt2(p<<1,tag2[p]);\n\t\tif(mn[p<<1|1]<=mn[p<<1]) pt2(p<<1|1,tag2[p]); \n\t}\n\ttag1[p]=tag2[p]=0;\n}\nvoid build(int p,int l,int r){\n\tcnt[p]=r-l+1;\n\tif(l==r)return;\n\tint mid=l+r>>1;\n\tbuild(p<<1,l,mid),build(p<<1|1,mid+1,r);\n}\n\nvoid mdf1(int p,int l,int r,int nl,int nr,int v){\n\tif(nl>nr)return; \n\tif(l>=nl&&r<=nr)return pt1(p,v);\n\tint mid=l+r>>1; down(p);\n\tif(nl<=mid)mdf1(p<<1,l,mid,nl,nr,v);\n\tif(nr>mid)mdf1(p<<1|1,mid+1,r,nl,nr,v); up(p);\n}\nvoid mdf2(int p,int l,int r,int nl,int nr,int v){\n\tif(nl>nr||mn[p]>0)return; \n\tif(l>=nl&&r<=nr)return pt2(p,v);\n\tint mid=l+r>>1; down(p);\n\tif(nl<=mid)mdf2(p<<1,l,mid,nl,nr,v);\n\tif(nr>mid)mdf2(p<<1|1,mid+1,r,nl,nr,v); up(p);\n}\nll ask(int p,int l,int r,int ql,int qr){\n\tif(l>=ql&&r<=qr)return sum[p];\n\tint mid=l+r>>1; ll res=0; down(p);\n\tif(ql<=mid)res+=ask(p<<1,l,mid,ql,qr);\n\tif(qr>mid)res+=ask(p<<1|1,mid+1,r,ql,qr);\n\treturn res;\n}\n\n}\n\nsigned main()\n{\n\tn=read(),m=read();\n\tFor(i,1,n)p[i]=read();\n\tFor(i,2,n){\n\t\tint v=read(),u=p[i]; v=p[v];\n\t\te[u].pb(v),e[v].pb(u);\n\t}\n\tdfs(p[1],0);\n\tsolve(p[1]);\n\tFor(i,1,m){\n\t\tint l=read(),r=read();\n\t\tq[r].pb(mkp(l,i));\n\t}\n\tT::build(1,1,n);\n\tFor(i,1,n){\n\t\tfor(auto it:vec[i]){\n\t\t\tif(it.fi>0) T::mdf1(1,1,n,it.fi,it.se,1);\n\t\t\telse T::mdf1(1,1,n,-it.fi,-it.se,-1);\n\t\t}\n\t\tT::mdf2(1,1,n,1,i,1);\n\t\tfor(auto it:q[i]) res[it.se]=T::ask(1,1,n,it.fi,i);\n\t//\tFor(j,1,i)cout<<T::ask(1,1,n,j,i)<<\" \";puts(\"\"); \n\t}\n\tFor(i,1,m)printf(\"%lld\\n\",res[i]);\n\treturn 0;\n}\n\n/*\n5 5\n2 5 1 3 4\n1 1 2 2\n1 1\n1 4\n3 3\n2 2\n1 1\n*/\n```",
        "postTime": 1676190739,
        "uid": 151935,
        "name": "Rainbow_qwq",
        "ccfLevel": 0,
        "title": "P8528 \u662f\u865a\u6811\u7684\u533a\u95f4\u4e2a\u6570"
    },
    {
        "content": "\u4ee5 $l$ \u4e3a $x$ \u8f74\uff0c\u4ee5 $r$ \u4e3a $y$ \u8f74\u3002\u4e00\u4e2a\u8be2\u95ee $[l,r]$ \u7684\u7b54\u6848\u5c31\u662f $([l,+\\infin],[1,r])$ \u4e2d\u5408\u6cd5\u70b9\u5bf9\u7684\u6570\u91cf\u3002\r\n\r\n\u8003\u5bdf\u4e00\u4e2a\u70b9\u5bf9 $a,b(a<b)$ \u548c\u4ed6\u4eec\u7684\u6700\u8fd1\u516c\u5171\u7956\u5148 $c$\uff1a\r\n\r\n1. $a<c<b$\uff0c\u6ca1\u6709\u4ea7\u751f\u65b0\u7684\u4e0d\u5408\u6cd5\u7684\u70b9\u3002\r\n2. $a<b<c$\uff0c\u6240\u6709\u5305\u542b $a,b$ \u4f46\u4e0d\u5305\u542b $c$ \u7684\u70b9\u4f1a\u88ab\u5e72\u6389\uff0c\u5373\u6ee1\u8db3 $([1,a],[b,c))$ \u7684\u70b9\u5bf9\u4f1a\u88ab\u5e72\u6389\u3002\r\n3. $c<a<b$\uff0c\u6ee1\u8db3 $((c,a],[b,+\\infin))$ \u7684\u70b9\u4f1a\u88ab\u5e72\u6389\u3002\r\n\r\n\u7136\u540e\uff0c\u6211\u4eec\u8003\u8651\u7ed9\u88ab\u5e72\u6389\u7684\u533a\u95f4 $+1$\uff0c\u5012\u7740\u626b\u63cf\u7ebf\u5c31\u662f\u4e00\u4e2a\u533a\u95f4\u5386\u53f2\u6700\u503c\u548c\u95ee\u9898\uff0c\u8fd9\u4e2a\u7ebf\u6bb5\u6811\u53ef\u4ee5\u89e3\u51b3\u3002\r\n\r\n\u4f46\u662f\u95ee\u9898\u6765\u4e86\uff0c\u679a\u4e3e $a,b$ \u7684\u4ee3\u4ef7\u662f $\\mathcal{O}(n^2)$\uff0c\u8fd9\u662f\u6211\u4eec\u4e0d\u80fd\u63a5\u53d7\u7684\u3002\r\n\r\n\u4e8b\u5b9e\u4e0a\uff0c\u5bf9\u4e8e\u4e00\u4e2a $c$\uff0c\u5e76\u975e\u6240\u6709\u7684 $a,b$ \u90fd\u9700\u8981\u8d21\u732e\uff0c\u5982\u679c\u6ee1\u8db3 $[a_1,b_1]\\sub [a_2,b_2]$\uff0c\u90a3\u4e48 $a_2,b_2$ \u662f\u6beb\u65e0\u7528\u5904\u7684\u3002\r\n\r\n\u8003\u8651\u542f\u53d1\u5f0f\u5408\u5e76\uff0c\u6bcf\u6b21\u628a $c$ \u7684\u5b50\u6811\u5185\u7684\u82e5\u5e72\u4e2a\u5b50\u6811\u7684\u70b9\u52a0\u5165\u96c6\u5408\uff0c\u6bcf\u6b21\u6bcf\u4e2a\u70b9\u4ea7\u751f\u7684\u8d21\u732e\u5c31\u662f\u4e0d\u5728\u4e00\u68f5\u5b50\u6811\u5185\u7684\u524d\u9a71\u540e\u7ee7\u3002\r\n\r\n\u90a3\u4e48\u6709\u7528\u7684\u70b9\u5bf9\u5c31\u662f $\\mathcal{O}(n\\log n)$ \u4e2a\u3002\r\n\r\n\u7efc\u5408\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(n\\log ^2 n+q\\log n)$\u3002",
        "postTime": 1676465850,
        "uid": 183026,
        "name": "Cocoly1990",
        "ccfLevel": 0,
        "title": "P8528 [Ynoi2003] \u94c3\u539f\u9732\u9732 \u9898\u89e3\u62a5\u544a"
    },
    {
        "content": "~~lxl\uff1a\u8fd9\u79cd\u9898\u51fa\u51fa\u6765\u548c\u505a\u7684\u65f6\u5019\u90fd\u4e0d\u7528\u52a8\u8111\u5b50\u7684 \u5168\u662f\u5957\u8def\u4e16\u754c\u5927\u6218~~\n\n\u8003\u8651\u4e00\u5bf9 $(x,y)$\uff0c\u4e0d\u59a8\u8bbe $a_x<a_y$\uff0c$\\text{LCA}(x,y)=z$\uff0c\u53d1\u73b0\u5982\u679c $a_{z}\\in[a_x,a_y]$\uff0c\u90a3\u4e48\u8fd9\u4e00\u5bf9 $(x,y)$ \u65e0\u6cd5\u5bf9\u4efb\u4f55 $L,R$ \u9020\u6210\u7ea6\u675f\uff1b\u5426\u5219\uff0c\u4e0d\u59a8\u8bbe $a_z>a_y>a_x$\uff0c\u90a3\u4e48\u6240\u6709 $1\\le L\\le a_x,a_y\\le R<a_z$ \u7684 $(L,R)$ \u5747\u4e0d\u5408\u6cd5\u3002\n\n\u8003\u8651 dsu on tree\uff0c\u94a6\u5b9a $x,y$ \u7684 $\\text{LCA}$ \u4e4b\u540e\uff0c\u53d1\u73b0\u5bf9\u4e8e\u6bcf\u4e2a $x$\uff0c\u5c0f\u4e8e $a_x$ \u7684\u90e8\u5206\u53ea\u6709\u6700\u5927\u7684\u90a3\u4e2a $a_y$ \u6709\u6548\uff0c\u5927\u4e8e\u4ed6\u7684\u90e8\u5206\u53ea\u6709\u6700\u5c0f\u7684\u90a3\u4e2a $a_y$ \u6709\u6548\uff0c\u8fd9\u6837\u5c31\u628a\u603b\u5171\u6709\u6548\u7684 $(x,y)$ \u6570\u91cf\u964d\u4f4e\u81f3 $O(n\\log n)$\u3002\n\n\u53d1\u73b0\u4e00\u4e2a $(x,y)$ \u76f8\u5f53\u4e8e\u8986\u76d6\u6389\u4e8c\u7ef4\u5e73\u9762\u4e0a\u7684\u4e00\u4e2a\u77e9\u5f62\uff0c\u6bcf\u6b21\u67e5\u8be2\u65f6\u9700\u8981\u8fdb\u884c\u77e9\u5f62\u6c42\u548c\u3002\u8003\u8651\u79bb\u7ebf\u505a\u626b\u63cf\u7ebf\uff0c\u5219\u53ea\u9700\u8981\u7ef4\u62a4\u533a\u95f4\u52a0\uff0c\u533a\u95f4 $\\min$ \u4ee5\u53ca $\\min$ \u7684\u4e2a\u6570\uff0c\u5386\u53f2 $\\min$ \u4ee5\u53ca\u5386\u53f2 $\\min$ \u4e2a\u6570\u3002\n\n\u7ebf\u6bb5\u6811\u76f4\u63a5\u505a\u5c31\u884c\u4e86\uff0c\u590d\u6742\u5ea6 $O(n\\log^2n)$\u3002",
        "postTime": 1679538773,
        "uid": 307453,
        "name": "\u4e91\u6d45\u77e5\u5904",
        "ccfLevel": 6,
        "title": "P8528"
    },
    {
        "content": "### Part1 \u524d\u8a00\n\n\u66fe\u7ecf\u7684\u201c\u94c3\u539f\u9732\u9732\u201d\u4e0d\u662f\u8fd9\u6837\u7684\uff01\u4e0d\u8fc7\u8fd9\u4e2a\u8fd8\u662f\u5f88\u6709\u610f\u601d\u7684\u3002\n\n\u533a\u95f4 $[l,r]$ \u6ee1\u8db3\u8981\u6c42\u5f53\u4e14\u4ec5\u5f53 $\\forall a_x,a_y\\in[l,r],a_{\\operatorname{lca}(x,y)}\\in[l,r]$\u3002\n\n\u9898\u610f\u8981\u6c42\u4e00\u4e2a\u533a\u95f4\u5185\u6ee1\u8db3\u8981\u6c42\u7684\u5b50\u533a\u95f4\u4e2a\u6570\u3002\n\n### Part2 \u601d\u8def\u8f6c\u6362\n\n\u6c42 LCA \u6ee1\u8db3\u6027\u8d28\u7684\u65b9\u5f0f\u5c31\u662f dsu on tree \u5f62\u5f0f\u7684\u652f\u914d\u70b9\u5bf9\uff0c\u4e0e\u8ddd\u79bb\u76f8\u5173\u7684\u5219\u662f\u66f4\u5e38\u7528\u70b9\u5206\u6cbb\uff0c\u672c\u9898\u81ea\u7136\u662f\u4f7f\u7528 dsu on tree\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u5148\u53ea\u5224\u65ad\u5355\u4e2a\u533a\u95f4\u662f\u5426\u6ee1\u8db3\u8981\u6c42\uff0c\u8fd9\u65f6\u53ef\u4ee5\u5c1d\u8bd5\u4f7f\u7528\u626b\u63cf\u7ebf\uff0c\u626b\u53f3\u7aef\u70b9\u3002\n\n\u8003\u8651\u4e00\u4e2a\u70b9\u5bf9 $(x,y,z)$ \u5176\u4e2d $z=\\operatorname{lca}(x,y),a_x\\le a_y$\uff1a\n\n1. $a_z<a_x$\uff0c\u90a3\u4e48\u5bf9\u4e8e $r\\ge a_y,l\\in(a_z,a_x]$ \u7684\u533a\u95f4\u4e0d\u5408\u6cd5\u3002\n\n2. $a_z>a_y$\uff0c\u90a3\u4e48\u5bf9\u4e8e $r\\in[a_y,a_z),l\\in[1,a_x]$ \u7684\u533a\u95f4\u4e0d\u5408\u6cd5\u3002\n\n3. $a_z\\in[a_x,a_y]$\uff0c\u5bf9\u7b54\u6848\u6ca1\u6709\u5f71\u54cd\u3002\n\n\u7136\u800c\uff0c\u4e0d\u5408\u6cd5\u7684\u533a\u95f4\u4e00\u5b9a\u662f\u5f62\u5982\u5305\u542b $a_x,a_y$ \u800c\u4e0d\u5305\u542b $a_z$ \u7684\uff0c\u6240\u4ee5\uff0c\u6211\u4eec\u5728 dsu on tree \u65f6\u53ea\u9700\u8981\u8003\u8651\u5bfb\u627e $a_x$ \u7684\u524d\u9a71\u540e\u7ee7\uff0c\u5bb9\u6613\u53d1\u73b0\uff0c\u8fd9\u6837\u53ea\u4f1a\u5f62\u6210 $O(n\\log n)$ \u4e2a\u652f\u914d\u70b9\u5bf9\u3002\n\n### Part3 \u5177\u4f53\u5b9e\u73b0\n\n\u672c\u9898\u5f62\u5982[\u3010\u6a21\u677f\u3011\u626b\u63cf\u7ebf](https://www.luogu.com.cn/problem/P5490)\u4e2d\u7684\u7ebf\u6bb5\u6811\uff0c\u9700\u8981\u533a\u95f4\u52a0\u6c42\u4e3a\u96f6\u7684\u6570\u5b57\u4e2a\u6570\u3002\n\n\u5f53\u7136\uff0c\u5b50\u533a\u95f4\u5c31\u662f\u5355\u7eaf\u7684\u5386\u53f2\u548c\u5957\u8def\u3002\n\n\u4e8e\u662f\u95ee\u9898\u53d8\u4e3a\u4e86\u533a\u95f4\u52a0\u533a\u95f4\u5386\u53f2\u4e3a\u96f6\u6570\u548c\u3002\n\n\u5177\u4f53\u5730\uff0c\u7ebf\u6bb5\u6811\u4e0a\u6bcf\u4e00\u4e2a\u8282\u70b9\u7ef4\u62a4\u533a\u95f4\u6700\u5c0f\u503c\u548c\u6700\u5c0f\u503c\u7684\u51fa\u73b0\u6b21\u6570\u3002\n\n\u5728\u52a0\u5386\u53f2\u548c\u6807\u8bb0\u65f6\u53ea\u6709\u5f53\u8282\u70b9\u6700\u5c0f\u503c\u4e3a $0$ \u65f6\u624d\u4f1a\u7ed9\u6700\u5c0f\u503c\u6253\u6807\u8bb0\uff0c\u4e0b\u4f20\u65f6\u4e5f\u53ea\u4f1a\u4f20\u7ed9\u6700\u5c0f\u503c\u76f8\u540c\u7684\uff0c\u6b64\u5904\u5f62\u4f3c\u7ebf\u6bb5\u6811 3\u3002\n\n\u4e0d\u77e5\u9053\u4e3a\u4ec0\u4e48\uff0c\u7a81\u7136\u60f3\u8981\u7ed9\u4ee3\u7801\uff0cHNOI2022 Hope Rank High\uff01\n\n```cpp\nstruct dat{int l,r;};\nvector<dat>gs[N],qr[N];\nvoid add(int a,int b,int c){\n    if(!(a&&b&&c))return;\n    if(a>b)swap(a,b);\n    if(c>b){\n        gs[b].push_back({1,a});\n        gs[c].push_back({-1,a});\n    }if(c<a)\n        gs[b].push_back({c+1,a});\n}\nvoid dfs(int x){\n    rev[dfn[x]=++dlt]=x;\n    for(int y=hd[x];y;y=to[y])dfs(y);\n    low[x]=dlt;\n}\nvoid dfs(int x,int tp){\n    int i,y,z;\n    if(lc[x]){\n        for(int p=hd[x];p;p=to[p])\n            if(p!=lc[x])dfs(p,1);\n        dfs(lc[x],0);\n        for(int p=hd[x];p;p=to[p])\n            if(p!=lc[x]){\n                for(i=dfn[p];i<=low[p];++i){\n                    y=a[rev[i]];\n                    z=G.pre(y),add(y,z,a[x]);\n                    z=G.nxt(y),add(y,z,a[x]);\n                }for(i=dfn[p];i<=low[p];++i)\n                    G.insert(a[rev[i]]);\n            }\n    }\n    if(tp)for(i=dfn[x]+1;i<=low[x];++i)G.erase(a[rev[i]]);\n    else G.insert(a[x]);\n}\n#define ls x<<1\n#define rs x<<1|1\nconst int T=567890;\nint mn[T],t1[T],t2[T],ct[T];\nll sm[T],ans[N];\nvoid build(int x,int l,int r){\n    ct[x]=r-l+1;\n    if(l<r){\n        int md=l+r>>1;\n        build(ls,l,md);\n        build(rs,md+1,r);\n    }\n}\nvoid at1(int x,int d){t1[x]+=d,mn[x]+=d;}\nvoid at2(int x,int d){\n    sm[x]+=ll(d)*ct[x],t2[x]+=d;\n}\nvoid pd(int x){\n    if(t1[x])at1(ls,t1[x]),at1(rs,t1[x]),t1[x]=0;\n    if(t2[x]){\n        if(mn[x]==mn[ls])at2(ls,t2[x]);\n        if(mn[x]==mn[rs])at2(rs,t2[x]);t2[x]=0;\n    }\n}void pp(int x){\n    mn[x]=mn[ls]<mn[rs]?mn[ls]:mn[rs],sm[x]=sm[ls]+sm[rs];\n    ct[x]=(mn[x]==mn[ls]?ct[ls]:0)+(mn[x]==mn[rs]?ct[rs]:0);\n}\nvoid cg1(int x,int l,int r,int L,int R,int d){\n    if(l>=L&&r<=R)return at1(x,d);\n    int md=l+r>>1;pd(x);\n    if(L<=md)cg1(ls,l,md,L,R,d);\n    if(md<R)cg1(rs,md+1,r,L,R,d);pp(x);\n}\nvoid cg2(int x,int l,int r,int L,int R,int d){\n    if(l>=L&&r<=R){\n        if(!mn[x])at2(x,d);return;\n    }int md=l+r>>1;pd(x);\n    if(L<=md)cg2(ls,l,md,L,R,d);\n    if(md<R)cg2(rs,md+1,r,L,R,d);pp(x);\n}\nll qry(int x,int l,int r,int L,int R){\n    if(l>=L&&r<=R)return sm[x];pd(x);\n    int md=l+r>>1;ll res=0;\n    if(L<=md)res+=qry(ls,l,md,L,R);\n    if(md<R)res+=qry(rs,md+1,r,L,R);\n    return res;\n}\nint main(){\n    ios::sync_with_stdio(false);\n    cin>>n>>m;\n    int i,j,k,l,r,x,y;\n    for(x=1;x<=n;++x)cin>>a[x],sz[x]=1;\n    for(x=2;x<=n;++x)cin>>f[x];\n    for(x=n;x>1;--x){\n        sz[f[x]]+=sz[x];\n        sz[lc[f[x]]]<sz[x]&&(lc[f[x]]=x);\n        to[x]=hd[f[x]],hd[f[x]]=x;\n    }dfs(1),dfs(1,1);\n    for(i=1;i<=m;++i)\n        cin>>l>>r,qr[r].push_back({l,i});\n    build(1,1,n);\n    for(x=1;x<=n;++x){\n        for(dat at:gs[x])\n            if(at.l>0)cg1(1,1,n,at.l,at.r,1);\n            else cg1(1,1,n,-at.l,at.r,-1);\n        cg2(1,1,n,1,x,1);\n        for(dat at:qr[x])\n            ans[at.r]=qry(1,1,n,at.l,x);\n    }\n    for(i=1;i<=m;++i)\n        printf(\"%lld\\n\",ans[i]);\n    return 0;\n}\n```",
        "postTime": 1679492745,
        "uid": 502410,
        "name": "EnofTaiPeople",
        "ccfLevel": 0,
        "title": "\u652f\u914d\u70b9\u5bf9\u5c0f\u8bb0"
    }
]