[
    {
        "content": "### Subtask $1$\n\u524d\u7f6e\u829d\u58eb\uff1a[\u5927\u6b65\u5c0f\u6b65\u7b97\u6cd5\uff08BSGS\uff09](https://www.luogu.com.cn/blog/ButterflyDew/solution-p4195)\n\n\u7531\u9ad8\u5fb7\u7eb3\u7bad\u53f7\u8868\u793a\u6cd5\u7684\u5b9a\u4e49\u53ef\u5f97\uff1a$a \\uparrow b = a^b$\u3002\u53c8\u7531\u4e8e Subtask $1$ \u7684\u4fdd\u8bc1 $p$ \u4e3a\u8d28\u6570\uff0c\u6240\u4ee5\u6211\u4eec\u4f7f\u7528 BSGS \u6c42\u89e3\u539f\u65b9\u7a0b\u5373\u53ef\u3002\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(T \\sqrt{p} \\log p)$\u3002\n### Subtask $2$\n\u524d\u7f6e\u829d\u58eb\uff1a[\u6269\u5c55\u6b27\u62c9\u5b9a\u7406\uff08exEuler\uff09](https://www.cnblogs.com/yifusuyi/p/9997009.html)\n\n\u6211\u4eec\u9996\u5148\u6765\u5316\u7b80 $a \\uparrow \\uparrow b$\u3002\n\n$a \\uparrow \\uparrow b = a \\uparrow (a \\uparrow \\uparrow (b - 1))$\n\n$ = a^{a \\uparrow \\uparrow (b - 1)}$\n\n$ = a^{a^{a \\uparrow \\uparrow (b - 2)}}$\n\n$ = \\cdots$\n\n$ = a^{a^{.^{.^{.^a}}}}$\uff08\u5171 $b$ \u4e2a $a$\uff09\n\n\u9884\u5904\u7406\u6b27\u62c9\u51fd\u6570\u7684\u503c\uff0c\u7136\u540e\u4ece $0$ \u5f00\u59cb\u679a\u4e3e $x$ \u7684\u503c\u5e76\u5224\u65ad\u5373\u53ef\u3002\u8bbe $k_1$ \u8868\u793a\u4f7f\u6b27\u62c9\u51fd\u6570\u53d8\u4e3a $1$ \u7684\u6700\u5c11\u5d4c\u5957\u5c42\u6570 $+ 1$\uff0c\u5219 $x$ \u7684\u679a\u4e3e\u4e0a\u754c\u4e3a $k_1$\u3002\n\n\u8fd9\u91cc\u8ba1\u7b97 $a \\uparrow \\uparrow b$ \u65f6\u9700\u8981\u7528\u5230\u6269\u5c55\u6b27\u62c9\u5b9a\u7406\u3002\u4f46\u662f\uff0c\u7531\u4e8e\u6211\u4eec\u5728\u8ba1\u7b97 $a^b \\bmod p$ \u4e4b\u7c7b\u7684\u5f0f\u5b50\u65f6\uff0c\u9700\u8981\u5224\u65ad $b$ \u4e0e $\\varphi(p)$ \u4e4b\u95f4\u7684\u5927\u5c0f\u5173\u7cfb\uff0c\u6240\u4ee5\u6211\u4f7f\u7528\u4e86\u4e00\u4e2a\u540d\u4e3a Node \u7684\u7ed3\u6784\u4f53\u6765\u4fdd\u5b58\u8fd0\u7b97\u7ed3\u679c\u53d6\u6a21\u540e\u7684\u503c\u548c\u8fd9\u4e2a\u7ed3\u679c\u53d6\u6a21\u524d\u662f\u5426\u5927\u4e8e $\\varphi(p)$\u3002\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(T \\sqrt{p} \\log p)$\u3002\n### Subtask $3$\n\u6211\u4eec\u9996\u5148\u6765\u5316\u7b80 $a \\uparrow^3 b$\u3002\n\n$a \\uparrow^3 b = a \\uparrow \\uparrow (a \\uparrow^3 (b - 1))$\n\n\u7531\u4e8e\u6b27\u62c9\u51fd\u6570\u5d4c\u5957\u591a\u5c42\u540e\u5176\u503c\u4f1a\u53d8\u4e3a $1$\uff0c\u6240\u4ee5\u5982\u679c\u6211\u4eec\u8981\u7b97\u51fa $a \\uparrow^3 b \\bmod p$ \u7684\u503c\uff0c\u53ea\u8981\u7b97\u51fa $a \\uparrow \\uparrow \\min(a \\uparrow^3 (b - 1), k_1) \\bmod p$ \u5373\u53ef\u3002\u56e0\u6b64\uff0c$a \\uparrow^3 b$ \u53ef\u4ee5\u9012\u5f52\u8ba1\u7b97\u3002\n\n\u9884\u5904\u7406\u6b27\u62c9\u51fd\u6570\u7684\u503c\uff0c\u7136\u540e\u4ece $0$ \u5f00\u59cb\u679a\u4e3e $x$ \u7684\u503c\u5e76\u5224\u65ad\u5373\u53ef\u3002$x$ \u7684\u679a\u4e3e\u4e0a\u754c\u4e3a\u6ee1\u8db3 $a \\uparrow \\uparrow (k_2 - 1) \\geq k_1$ \u7684\u6700\u5c0f $k_2$\u3002\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(T \\sqrt{p} \\log p)$\u3002\n\n\u5177\u4f53\u7ec6\u8282\u89c1\u4ee3\u7801\u6ce8\u91ca\u3002\n\n\u4ee3\u7801\uff1a\n```cpp\n#include <iostream>\n#include <map>\n#include <cmath>\n\nusing namespace std;\n\ntypedef long long ll;\n\ntypedef struct {\n\tll val;\n\tbool flag;\n} Node;\n\nint phi[37];\nmap<ll, int> mp;\n\ninline Node new_node(ll val, bool flag){\n\tNode ans;\n\tans.val = val;\n\tans.flag = flag;\n\treturn ans;\n}\n\ninline Node quick_pow(ll x, ll p, ll mod){\n\tNode ans;\n\tans.val = 1;\n\tans.flag = false;\n\twhile (p){\n\t\tif (p & 1){\n\t\t\tans.val *= x;\n\t\t\tif (ans.val >= mod){\n\t\t\t\tans.val %= mod;\n\t\t\t\tans.flag = true;\n\t\t\t}\n\t\t}\n\t\tp >>= 1;\n\t\tif (p == 0) break;\n\t\tx *= x;\n\t\tif (x >= mod){\n\t\t\tx %= mod;\n\t\t\tans.flag = true;\n\t\t}\n\t}\n\treturn ans;\n}\n\ninline int bsgs(int a, int b, int p){\n\tif (p == 1) return 0;\n\ta %= p;\n\tb %= p;\n\tif (b == 1) return 0;\n\tint m = ceil(sqrt(p)), i = 0;\n\tll t = quick_pow(a, m, p).val;\n\tmp.clear();\n\tfor (register ll j = b; i < m; i++, j = j * a % p){\n\t\tmp[j] = i;\n\t}\n\ti = 1;\n\tfor (register ll j = t; i <= m; i++, j = j * t % p){\n\t\tif (mp.count(j)) return i * m - mp[j];\n\t}\n\treturn -1;\n}\n\ninline int euler(int n){\n\tint ans = n;\n\tfor (register int i = 2; i * i <= n; i++){\n\t\tif (n % i == 0){\n\t\t\tans -= ans / i;\n\t\t\twhile (n % i == 0){\n\t\t\t\tn /= i;\n\t\t\t}\n\t\t}\n\t}\n\tif (n > 1) ans -= ans / n;\n\treturn ans;\n}\n\nNode tetration(int a, int n, int index){\n\tif (phi[index] == 1) return new_node(0, true);\n\tif (n == 0) return new_node(1, false);\n\tint next_index = index + 1;\n\tNode x = tetration(a, n - 1, next_index);\n\tif (x.flag) x.val += phi[next_index];\n\treturn quick_pow(a, x.val, phi[index]);\n}\n\ninline int f(int a){\n\tif (a == 1) return 0;\n\tfor (register int i = 0; ; i++){\n\t\tif (tetration(a, i, 0).flag) return i + 1;\n\t}\n}\n\ninline ll quick_pow_with_max_val(ll x, ll p, ll max_val){\n\tll ans = 1;\n\twhile (p){\n\t\tif (x >= max_val){\n\t\t\treturn max_val;\n\t\t}\n\t\tif (p & 1){\n\t\t\tans *= x;\n\t\t\tif (ans >= max_val){\n\t\t\t\treturn max_val;\n\t\t\t}\n\t\t}\n\t\tx *= x;\n\t\tp >>= 1;\n\t}\n\treturn ans;\n}\n\nll tetration_with_max_val(ll a, ll n, int max_val){\n\tif (n == 0 || a == 1) return 1;\n\tll x = tetration_with_max_val(a, n - 1, max_val);\n\tif (x == max_val) return max_val;\n\treturn quick_pow_with_max_val(a, x, max_val);\n}\n\nll pentation_with_max_val(ll a, ll n, int max_val){\n\tif (n == 0 || a == 1) return 1;\n\tll x = pentation_with_max_val(a, n - 1, max_val);\n\tif (x == max_val) return max_val;\n\treturn tetration_with_max_val(a, x, max_val);\n}\n\ninline ll pentation(ll a, ll n, int max_val, ll mod){\n\tif (mod == 1) return 0;\n\tif (n == 0) return 1;\n\treturn tetration(a, pentation_with_max_val(a, n - 1, max_val), 0).val % mod;\n}\n\nint main(){\n\tint t;\n\tcin >> t;\n\tfor (register int i = 1; i <= t; i++){\n\t\tint a, n, b, p;\n\t\tcin >> a >> n >> b >> p;\n\t\tif (n == 1){\n\t\t\tcout << bsgs(a, b, p) << endl;\n\t\t} else {\n\t\t\tint maxx_2 = 0, ans = -1;\n\t\t\tfor (register int j = p; j != 1; j = euler(j)){\n\t\t\t\tphi[maxx_2++] = j;\n\t\t\t}\n\t\t\tphi[maxx_2] = 1;\n\t\t\tif (n == 2){\n\t\t\t\tfor (register int j = 0; j <= maxx_2; j++){\n\t\t\t\t\tif (tetration(a, j, 0).val == b){\n\t\t\t\t\t\tans = j;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tint maxx_3 = f(a);\n\t\t\t\tfor (register int j = 0; j <= maxx_3; j++){\n\t\t\t\t\tif (pentation(a, j, maxx_2, p) == b){\n\t\t\t\t\t\tans = j;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tcout << ans << endl;\n\t\t}\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1594899193,
        "uid": 201007,
        "name": "Leasier",
        "ccfLevel": 8,
        "title": "\u300cWdsr-2\u300d\u767d\u6cfd\u6559\u80b2-\u9898\u89e3"
    },
    {
        "content": "\u8fd9\u9898\u7684\u96be\u5ea6\u5927\uff0c\u4e14\u7ec6\u8282\u5f88\u591a\uff0c\u5bfc\u81f4\u6709\u8db3\u8db35\u9875\u7684\u7ea2\u8272\u63d0\u4ea4\uff0c\u90fd\u662f0\u5206/15\u5206\n\n~~\u5bfc\u81f4\u6211\u4e00\u5f00\u59cb\u8fd8\u6000\u7591\u662f\u5426\u662f\u6570\u636e\u7684\u95ee\u9898~~ \n\n\u672c\u9898\u7684\u6570\u636e\u662f\u6ca1\u6709\u95ee\u9898\u7684qwq\n\n\u672c\u7bc7\u9898\u89e3\u4f1a\u7a0d\u5fae\u8bb2\u4e00\u4e0b\u6709\u54ea\u4e9b\u9700\u8981\u6ce8\u610f\u7684\u7ec6\u8282\n\n## Subtask 1\n\n\u6a21\u677f BSGS \uff08\u522b\u5199\u6302\u4e86\uff09\n\n\u590d\u6742\u5ea6\uff1a$O(\\sqrt{p})$\uff08\u54c8\u5e0c\u8868\uff09/ $O(\\sqrt{p}\\log(p))$ \uff08map\uff09\n\n## Subtask 2\n\n\u8fd9\u662f\u4e00\u4e2a\u5e42\u5854\u3002\u6211\u4eec\u77e5\u9053\uff0c\u6bcf\u5c42\u7684\u5e42\u8981\u6a21\u4e00\u4e2a $p,\\varphi(p),\\varphi(\\varphi(p))...$\u3002\u5bf9\u4e00\u4e2a\u6570\u4e0d\u65ad\u7684\u53d6 $\\varphi$\uff0c\u5dee\u4e0d\u591a $2\\log x$ \u6b65\u5c31\u53d6\u5230 $1$ \u4e86\u3002\n\n\u56e0\u6b64\uff0c\u5c42\u6570\u5927\u4e8e $O(\\log(p))$ \u4e4b\u540e\uff0c\u7b54\u6848\u90fd\u4e00\u6837\u4e86\u3002\u6240\u4ee5\u6211\u4eec\u66b4\u529b\u679a\u4e3e\u5c42\u6570\uff0c\u8ba1\u7b97\u51fa\u5e42\u5854\uff0c\u5c31\u53ef\u4ee5\u4e86\u3002\n\n\u6709\u4e00\u70b9\u9700\u8981\u6ce8\u610f\uff0c\u6b27\u62c9\u964d\u5e42\u516c\u5f0f\u5982\u4e0b\uff1a\n\n$$\na^b\\equiv\n\\begin{cases} % euler power\na^b (b\\le \\varphi(p))\\\\\na^{b\\mod \\varphi(p)+\\varphi(p)} (b>\\varphi(p))\\\\\n\\end{cases}\n$$\n\n\u56e0\u6b64\u6211\u4eec\u9700\u8981\u5224\u65ad $b$ \u4e0e $\\varphi(p)$ \u7684\u5927\u5c0f\u5173\u7cfb\u3002\u53ef\u4ee5\u53c2\u8003\u6807\u7a0b\u7684\u5b9e\u73b0\uff0c\u7528\u4e00\u4e2a `struct`\uff0c\u91cc\u9762\u4e00\u4e2aint\u4e00\u4e2abool\u8868\u793a\u503c\uff0c\u4ee5\u53ca\u5b83\u662f\u5426\u8d85\u8fc7\u4e86\u5b83\u5bf9\u5e94\u7684\u6a21\u6570\u3002\u7136\u540e\u5982\u679c\u53d1\u73b0\u4e0a\u4e00\u5c42\u8d85\u8fc7\u6a21\u6570\u4e86\uff0c\u5c31\u6a21\u4e00\u4e2a $\\varphi(p)$\uff0c\u7136\u540e\u518d\u52a0\u4e00\u4e2a $\\varphi(p)$\u3002\n\n> \u6709\u4e9b\u540c\u5b66\u53ef\u80fd\u6709\u7591\u95ee\uff1a\u4f1a\u4e0d\u4f1a\u6709\u8fd9\u79cd\u60c5\u51b5\u5c31\u662f\uff0c\u4e0a\u4e00\u5c42\u6ca1\u8d85\u8fc7mod\uff0c\u4f46\u662f\u8fd9\u4e00\u5c42\u8d85\u8fc7\u4e86mod\uff1f\n> \n> \u8fd8\u771f\u6709\uff01\u4f46\u662f\u4ec5\u4ec5\u53d1\u751f\u5728 $mod=2,4,6$\uff0c\u4e14 $a=2$ \u7684\u65f6\u5019\u3002\u9996\u5148\uff0c\u5982\u679c $a>2$\uff0c\u90a3\u4e48\u5f88\u5bb9\u6613\u5c31\u4f1a\u8d85\u8fc7 $mod$\uff0c\u56e0\u6b64\u53ef\u4ee5\u9a8c\u8bc1\uff0c\u751a\u81f3\u8bc1\u660e\uff0c $a>2$ \u4e0d\u4f1a\u6709\u8fd9\u4e2a\u60c5\u51b5\uff1b\u800c $a=2$ \u7684\u65f6\u5019\uff0c\u786e\u5b9e\u5728 $2,4,6$ \u4e0a\u4f1a\u6709\u8fd9\u4e2a\u53cd\u4f8b\uff0c\u4f46\u53ef\u4ee5\u8bc1\u660e\uff0c\u5b83\u4eec\u5168\u90fd\u4e0d\u4f1a\u5f71\u54cd\u3002\n> \n> \u7efc\u4e0a\uff0c\u8fd9\u4e2a\u505a\u6cd5\u6ca1\u95ee\u9898\u3002\n\n\u590d\u6742\u5ea6\uff1a$O(\\log(p)\\sqrt{p}+\\log^2(p))$ \uff08\u524d\u8005\u662f\u6c42\u6bcf\u4e00\u5c42phi\u7684\u590d\u6742\u5ea6\uff09\n\n\u5982\u679c\u60a8\u9009\u62e9\u5148\u7b5b\u8d28\u6570\uff0c\u90a3\u53ef\u4ee5 $O(\\dfrac{\\sqrt{p}}{\\ln(p)})$ \u7684\u5206\u89e3\u8d28\u56e0\u6570\uff0c\u4ece\u800c\u505a\u5230 $O(\\sqrt{p}+\\log^2(p))$\n\n## subtask 3\n\n\u51fa\u9898\u4eba\u5199\u7684\u6bd4\u8f83\u590d\u6742\uff0c\u5199\u4e86\u597d\u51e0\u4e2a\u51fd\u6570\u3002\n\n\u8fd9\u91cc\u63d0\u4f9b\u4e00\u4e2a\u7a0d\u5fae\u7b80\u6d01\u7684\u529e\u6cd5\u3002\u4f46\u6709\u4e2a\u89c2\u5bdf\u662f\u5fc5\u8981\u7684\uff0c\u6ce8\u610f\u5230 $a\\uparrow^2 x$\uff0c\u5f53 $x$ \u975e\u5e38\u5927\u7684\u65f6\u5019\uff0c\u90fd\u662f\u4e00\u6837\u7684 \uff08\u4e0a\u4e00\u4e2asubtask\u7684\u7ed3\u8bba\uff09\n\n\u6211\u4eec\u7279\u5224 $a=2$\u3002\u7136\u540e\u6211\u4eec\u53d1\u73b0\uff1a$3\\uparrow^3 2=3\\uparrow^2 3=3^{3^{3}}=3^{27}$\uff0c\u662f\u4e00\u4e2a\u5de8\u5927\u7684\u6570\u5b57\u3002\u800c $a>3$ \u7684\u65f6\u5019\uff0c$a\\uparrow^3 2$ \u5c31\u66f4\u52a0\u5de8\u5927\u4e86\u3002\n\n\u7136\u540e\uff0c$a\\uparrow^3 3=a\\uparrow^2 (a\\uparrow^3 2)$\u3002\u540e\u9762\u7684\u90a3\u4e2a $(a\\uparrow^3 2)$ \u5de8\u5927\u65e0\u6bd4\uff0c\u6839\u636e $\\uparrow^2$ \u7684\u6027\u8d28\uff0c\u76f4\u63a5\u628a\u5b83\u5f53\u6210 $100$ \u7b97\u5c31\u597d\u4e86\uff0c\u56e0\u4e3a $100$ \u5df2\u7ecf\u8fdc\u5927\u4e8e $\\log(mod)$ \u4e86\u3002\n\n\u4e5f\u5c31\u662f\u8bf4\uff0c\u5f53 $a>2$ \u7684\u65f6\u5019\uff0c\u5224\u4e00\u4e0b $a\\uparrow^3 2$ \u548c $a\\uparrow^3 3$ \u5c31\u884c\u4e86\u3002\u5176\u4e2d $a\\uparrow^3 2=a\\uparrow^2 a$\uff0c$a\\uparrow^3 3=a\\uparrow^2 100$\u3002\n\n\u590d\u6742\u5ea6\u540c\u4e0a\u3002\n\n## \u5751\u70b9&\u6ce8\u610f\n\n- \u53ef\u4ee5\u9996\u5148\u5904\u7406\u4e00\u4e9b $mod=1,b=1,b=a$ \u4e4b\u7c7b\u7684 trivial \u60c5\u51b5\u3002\u8fd9\u4e9b\u6709\u4e9b\u662f\u4e0d\u5fc5\u8981\u7684\uff0c\u4f46\u5904\u7406\u4e86\u603b\u5f52\u6ca1\u95ee\u9898\u3002\n\n- \u8bfb\u8fdb\u6765\u7684 $a$ \u5343\u4e07\u4e0d\u8981\u5148\u6a21\u4e00\u4e2a $p$\u3002\u56e0\u4e3a\u7b97\u5e42\u5854\u7684\u65f6\u5019, \u4e0a\u9762\u6a21\u7684\u53ef\u4e0d\u662f $p$\uff0c\u662f $\\varphi(p)$\u3002\n\n- \u5982\u679c\u60a8\u5199\u7684\u4e11, \u90a3phi\u90a3\u8fb9\u53ef\u80fd\u4f1a\u6709\u70b9\u5361\uff1b\u53ef\u4ee5\u9009\u62e9\u4f7f\u7528\u66f4\u4f18\u7684\u90a3\u4e2a\u590d\u6742\u5ea6\u3002\n\n## \u4ee3\u7801\n\n\u5176\u5b9e\u4e0d\u957f\uff0c\u56e0\u4e3a\u6211\u7684\u67d0\u4e9b\u4e60\u60ef\uff0c\u6240\u4ee5\u770b\u8d77\u6765\u884c\u591a\u3002\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\nnamespace Flandre_Scarlet\n{\n    #define int long long\n    #define N 1000006\n    #define F(i,l,r) for(int i=l;i<=r;++i)\n    #define D(i,r,l) for(int i=r;i>=l;--i)\n    #define Tra(i,u) for(int i=G.h[u],v=G.to(i);~i;i=G.nx(i),v=G.to(i)) if (i>=0)\n    #define MEM(a,x) memset(a,x,sizeof(a))\n    #define FK(a) MEM(a,0)\n    #define sz(x) ((int)x.size())\n    #define all(x) x.begin(),x.end()\n    #define p_b push_back\n    #define pii pair<int,int>\n    #define fir first\n    #define sec second\n    int I() {char c=getchar(); int x=0; int f=1; while(c<'0' or c>'9') f=(c=='-')?-1:1,c=getchar(); while(c>='0' and c<='9') x=(x<<1)+(x<<3)+(c^48),c=getchar(); return ((f==1)?x:-x);}\n    template <typename T> void Rd(T& arg){arg=I();}\n    template <typename T,typename...Types> void Rd(T& arg,Types&...args){arg=I(); Rd(args...);}\n    void RA(int *p,int n) {F(i,1,n) *p=I(),++p;}\n    int pr[N]; bool notp[N];\n    int phi[N];\n    void Init()\n    {\n        int n=1000000; int&c=pr[0]; notp[1]=1;\n        phi[1]=1;\n        F(i,2,n)\n        {\n            if (!notp[i])\n            {\n                pr[++c]=i;\n                phi[i]=i-1;\n            }\n            for(int j=1;j<=c and i*pr[j]<=n;++j)\n            {\n                notp[i*pr[j]]=1;\n                if (i%pr[j]==0)\n                {\n                    phi[i*pr[j]]=phi[i]*pr[j];\n                    break;\n                }\n                else\n                {\n                    phi[i*pr[j]]=phi[i]*(pr[j]-1);\n                }\n            }\n        }\n    }\n    int a,n,b,p;\n    void Input()\n    {\n        Rd(a,n,b,p);\n    }\n\n    struct node{int x;bool o;};\n    map<int,int>rec;\n    int qpow(int a,int b,int m) {a=(a%m+m)%m; int r=1; while(b) {if (b&1) r=r*a%m; a=a*a%m,b>>=1;} return r;}\n    int BSGS(int a,int b,int p)\n    {\n        rec.clear();\n        int sn=sqrt(p)+1;\n        int pw=1;\n        F(i,0,sn-1)\n        {\n            rec[pw]=i;\n            pw=(pw*a)%p;\n        }\n        if (rec.count(b)) {return rec[b];}\n        int a_sn=pw; // a_sn=a^sn\n        F(i,1,sn)\n        {\n            int iv=qpow(pw,p-2,p);\n            int tmp=b*iv%p; \n            if (rec.count(tmp))\n            {\n                return rec[tmp]+i*sn;\n            }\n            pw=pw*a_sn%p;\n        }\n        return -1;\n    }\n    // n=1\n\n    int gphi(int x) // sqrt/log \u7684\u5206\u89e3\u8d28\u56e0\u6570\u6c42phi\n    {\n        int ans=x,u;\n        for(int i=1;(u=pr[i])<=x/u and i<=pr[0];++i) if (x%u==0)\n        {\n            ans-=ans/u;\n            while(x%u==0) x/=u;\n        }\n        if (x>1) ans-=ans/x;\n        return ans;\n    }\n    node rqpow(int a,int b,int m) // \u8bb0\u5f55\u662f\u5426\u6ea2\u51fa\u7684qpow\n    {\n        int r=1; bool o=0;\n        if (a>=m) {o=1; a%=m;}\n        while(b)\n        {\n            if (b&1)\n            {\n                r=r*a; if (r>=m) o=1,r%=m;\n            }\n            b>>=1; if (!b) break;\n            a=a*a; if (a>=m) o=1,a%=m;\n        }\n        return (node){r,o};\n    }\n    int mods[200];\n    node ptower(int a,int n,int id) // \u5e42\u5854\n    {\n        int m=mods[id],pm=mods[id+1];\n        if (m==1) return (node){0,1};\n        if (n==0) return (node){1,0};\n        node tmp=ptower(a,n-1,id+1);\n        if (tmp.o) tmp.x+=pm;\n        node ans=rqpow(a,tmp.x,m);\n        return ans;\n    }\n    void Sakuya()\n    {\n        if (b==1 or p==1)\n        {\n            puts(\"0\");\n            return;\n        }\n        b%=p; // \u6ce8\u610f\u4e0d\u80fda%=p\n        if (n==1)\n        {\n            printf(\"%lld\\n\",BSGS(a,b,p));\n            return;\n        }\n        mods[1]=p; int tot=1;\n        while(1)\n        {\n            ++tot;\n            mods[tot]=gphi(mods[tot-1]);\n            if (mods[tot]==1) {break;}\n        }\n        if (n==2)\n        {\n            F(x,0,tot+1)\n            {\n                int pt=ptower(a,x,1).x;\n                if (pt==b)\n                {\n                    printf(\"%lld\\n\",x);\n                    return;\n                }\n            }\n            puts(\"-1\");\n        }\n        if (n==3)\n        {\n            if (a==1) {puts(\"-1\"); return;}\n            if (b==a%p) {puts(\"1\"); return;} \n            if (a==2)\n            {\n                if (b==4%p) {puts(\"2\");}\n                else if (b==65536%p) {puts(\"3\");}\n                else if (b==ptower(a,100,1).x%p) {puts(\"4\");}\n                else puts(\"-1\");\n                return;\n            }\n            // \u5f53a>=3\u65f6, a^^^2=a^^a \u5c31\u662f\u5929\u6587\u6570\u5b57\u4e86, \u56e0\u6b64 a^^(a^^(a^^...))\uff0c\u76f4\u63a5\u770b\u505a a^^100 \u5904\u7406\n            if (b==ptower(a,a,1).x) {puts(\"2\");}\n            else if (b==ptower(a,100,1).x) {puts(\"3\");}\n            else puts(\"-1\");\n        }\n    }\n    void IsMyWife()\n    {\n        Init();\n        int t=I();\n        while(t-->0)\n        {\n            Input();\n            Sakuya();\n        }\n    }\n}\n#undef int //long long\nint main()\n{\n    Flandre_Scarlet::IsMyWife();\n    return 0;\n}\n```",
        "postTime": 1634348754,
        "uid": 106252,
        "name": "LightningUZ",
        "ccfLevel": 0,
        "title": "P6736 \u9898\u89e3"
    },
    {
        "content": "### Subtask 1\n\n$a\\uparrow{b}=a^b$\uff0c\u800c\u6a21\u6570\u662f\u8d28\u6570\uff0c\u6240\u4ee5\u5c31\u662f\u88f8\u7684 [BSGS](https://www.luogu.com.cn/problem/P3846)\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\u662f $O\\left(T\\sqrt{p}\\right)$ \u6216 $O\\left(T\\sqrt{p}\\log{p}\\right)$\uff0c\u6709\u6ca1\u6709 $\\log$ \u53d6\u51b3\u4e8e\u7528\u7684\u662f\u54c8\u5e0c\u8868\u6216 map\u3002\n\n### Subtask 2\n\n\u6211\u4eec\u5148\u8bd5\u7740\u63a8\u4e00\u4e0b\u5f0f\u5b50\uff1a\n\n$$\\begin{aligned}a\\uparrow^2{b}&=a^{a\\uparrow^2{(b-1)}}\\\\&=a^{a^{a\\uparrow^2(b-2)}}\\\\&=\\cdots\\\\&=a^{a^{\\cdot^{\\cdot^{\\cdot^{a}}}}}&\\color{pink}\\text{\u5171 }b\\text{ \u4e2a }a\\end{aligned}$$\n\n\u8fd9\u662f\u4ec0\u4e48\uff1f\u5e42\u5854\uff01\n\n\u8fd9\u4ee4\u6211\u4eec\u60f3\u8d77\u4e86 **\u6269\u5c55\u6b27\u62c9\u5b9a\u7406**\u3002\n\n\u6839\u636e\u6269\u5c55\u6b27\u62c9\u5b9a\u7406\uff0c\u6211\u4eec\u77e5\u9053\u6bcf\u4e00\u5c42\u7684\u5e42\u8981 $\\bmod$ \u4e00\u4e2a $p,\\varphi\\left(p\\right),\\varphi\\left(\\varphi\\left(p\\right)\\right),\\ldots$ \uff0c\u8fd9\u662f\u4e00\u4e2a $\\varphi$ \u5957\u4e00\u4e2a $\\varphi$ \u7684\u4e1c\u897f\u3002\n\n\u6839\u636e  [P3747 \u76f8\u9022\u662f\u95ee\u5019](https://www.luogu.com.cn/problem/P3747) \u7684\u7ed3\u8bba\uff0c$O\\left(\\log{p}\\right)$ \u5c42\u4ee5\u540e\u5b83\u7684\u503c\u5c31\u662f $1$ \u4e86\u3002\n\n> \u8bc1\u660e\uff1a\u82e5 $p$ \u662f\u5076\u6570\uff0c\u5219 $p\\gets\\varphi(p)$ \u81f3\u5c11\u4f1a\u5c11\u4e00\u4e2a\u8d28\u56e0\u6570 $2$\uff0c\u4e5f\u5c31\u662f\u5c11\u4e86 $\\dfrac12$\u3002\u82e5 $p$ \u662f\u5947\u6570\u4e14\u4e3a\u8d28\u6570\uff0c\u5219 $\\varphi(p)=\\dfrac{q-1}{q}\\cdot{p}$\uff0c\u5176\u4e2d $q$ \u662f $p$ \u7684\u6700\u5c0f\u8d28\u56e0\u6570\uff0c\u5219 $2\\mid{q-1}$\uff0c$\\varphi(p)$ \u6210\u4e86\u5076\u6570\u3002\u6240\u4ee5\u6700\u591a $2\\log_2p$ \u6b21\u540e\u53d8\u6210 $1$\u3002\n\n\u663e\u7136\uff0c\u6211\u4eec\u76f4\u63a5\u679a\u4e3e $b$ \u5c31\u53ef\u4ee5\u4e86\u3002\n\n### Subtask 3\n\n\u6211\u4eec\u8fd8\u662f\u8bd5\u7740\u63a8\u4e00\u4e0b\u5f0f\u5b50\uff1a\n\n$$\\begin{aligned}a\\uparrow^3b&=a\\uparrow^2\\left(a\\uparrow^3\\left(b-1\\right)\\right)\\end{aligned}$$\n\n\u600e\u4e48\u529e\uff0c\u597d\u5927\u554a\uff01\n\n\u8fd9\u5c31\u542f\u793a\u6211\u4eec\u770b\u5c0f\u4e00\u70b9\u7684\u60c5\u51b5\u3002\n\n\u5f53 $a=3,b=3$ \u65f6\uff0c$3\\uparrow^33=3\\uparrow^2\\left(3\\uparrow^32\\right)=3\\uparrow^2\\left(3\\uparrow^2\\left(3\\uparrow^31\\right)\\right)=3\\uparrow^2\\left(3\\uparrow^23\\right)=3\\uparrow^23^{27}$\u3002\u6ce8\u610f\u5230 $2\\log_210^9+7<100$\uff0c\u800c $3^{27}$ \u5219\u5de8\u5927\u65e0\u6bd4\uff0c\u662f\u4e00\u4e2a $13$ \u4f4d\u6570\uff0c\u53ef\u60f3\u800c\u77e5\uff0c$a,b$ \u66f4\u5927\u4f1a\u600e\u4e48\u6837\u3002\n\n\u6240\u4ee5\u6211\u4eec\u53ea\u9700\u8981\u7279\u5224 $a=2$ \u7684\u60c5\u51b5\uff0c\u7136\u540e $a>2$ \u65f6\uff0c\u7b97 $a\\uparrow^32,a\\uparrow^33$ \u5c31\u53ef\u4ee5\u4e86\uff0c\u5176\u4e2d $a\\uparrow^33=a\\uparrow^2\\left(a\\uparrow^3{2}\\right)$ \u91cc\u7684 $a\\uparrow^32$ \u6839\u636e\u524d\u9762\u7684\u8ba8\u8bba\uff0c\u53ef\u4ee5\u76f4\u63a5\u5f53\u4f5c\u4e00\u4e2a\u5927\u4e8e $2\\log_2{p}$ \u7684\u6570\u5c31\u53ef\u4ee5\u4e86\u3002\n\n### \u4ee3\u7801\n\n```cpp\n//Sparks Fly.\n//I don't think you should wait.\n//i think u should SpeakNow. \n#include<bits/stdc++.h>\n#define int long long\nusing namespace std;\nint prime[10005],phi[50005],cnt;\nbitset<50005> used;\ninline void sieve(int n)\n{\n\tphi[1]=1;\n\tfor(int i=2;i<=n;i++)\n\t{\n\t\tif(!used[i])\tprime[++cnt]=i,phi[i]=i-1;\n\t\tfor(int j=1;j<=cnt&&i*prime[j]<=n;j++)\n\t\t{\n\t\t\tused[i*prime[j]]=1;\n\t\t\tphi[i*prime[j]]=phi[i]*(prime[j]-1);\n\t\t\tif(i%prime[j]==0){phi[i*prime[j]]=phi[i]*prime[j];break;}\n\t\t}\n\t}\n}\nint a,n,b,p;\ninline int BSGS(int a,int b,int mod)\n{\n\tif(b==1)\treturn 0;\n\tint t=ceil(sqrt(mod));\n\tunordered_map<int,int> mp;\n\tint z=1;\n\tfor(int i=0;i<t;i++)\n\t\tmp[1ll*b*z%mod]=i,z=1ll*z*a%mod;\n\tint p=1;\n\tfor(int i=1;i<=t;i++)\n\t{\n\t\tp=1ll*z*p%mod;\n\t\tif(mp.count(p))\treturn i*t-mp[p];\n\t}\n\treturn -1;\n}\nint getphi(int x)//\n{\n    int vl=x;\n    for(int i=1;i<=cnt&&1ll*prime[i]*prime[i]<=x;i++)\n\t\tif(x%prime[i]==0)\n\t    {\n\t        vl-=vl/prime[i];\n\t        while(x%prime[i]==0) x/=prime[i];\n\t    }\n    if(x>1) vl-=vl/x;\n    return vl;\n}\nstruct point{\n\tint x;bool ov;\n};\npoint qp(int a,int b,int mod)\n{\n    int res=1;bool flg=false;\n    if(a>=mod)\tflg=true,a%=mod;\n    while(b)\n    {\n        if(b&1){res=res*a;if(res>=mod) flg=true,res%=mod;}\n        b>>=1;if(!b)\tbreak;\n        a=a*a;if(a>=mod)\tflg=true,a%=mod;\n    }\n    return (point){res,flg};\n}\nint Phi[202];\npoint ptower(int a,int n,int id)\n{\n    int m=Phi[id],pm=Phi[id+1];\n    if(m==1)\treturn(point){0,true};\n    if(n==0)\treturn(point){1,false};\n    point tmp=ptower(a,n-1,id+1);\n    if(tmp.ov)\ttmp.x+=pm;\n    point ans=qp(a,tmp.x,m);\n    return ans;\n}\nvoid solve()\n{\n    if(b==1||p==1){puts(\"0\");return;}\n    b%=p;\n    if(n==1){printf(\"%lld\\n\",BSGS(a,b,p));return;}\n    Phi[1]=p;int tot=1;\n    while(true)//\n    {\n        tot++;\n        if(Phi[tot-1]>50000)Phi[tot]=getphi(Phi[tot-1]);\n        else    Phi[tot]=phi[Phi[tot-1]];\n        if(Phi[tot]==1)\tbreak;\n    }\n    if(n==2)\n    {\n        for(int i=1;i<=tot;i++)\n        {\n            int pt=ptower(a,i,1).x;\n            if(pt==b){printf(\"%lld\\n\",i);return;}\n        }\n        puts(\"-1\");\n    }\n    if(n==3)\n    {\n        if(a==1){puts(\"-1\");return;}\n        if(b==a%p){puts(\"1\");return;} \n        if(a==2)\n        {\n            if(b==4%p)\tputs(\"2\");\n            else if(b==65536%p)\tputs(\"3\");\n            else if(b==ptower(a,60,1).x%p)\tputs(\"4\");\n            else puts(\"-1\");\n            return;\n        }\n        if(b==ptower(a,a,1).x)puts(\"2\");\n        else if(b==ptower(a,60,1).x)puts(\"3\");\n        else puts(\"-1\");\n    }\n}\ninline int read()\n{\n\tint x=0,f=1;char c=getchar();\n\twhile(c<'0'||c>'9'){if(c=='-')f=-f;c=getchar();}\n\twhile(c>='0'&&c<='9'){x=x*10+c-'0';c=getchar();}\n\treturn x*f;\n}\nsigned main()\n{\n\tsieve(50000);\n    int tc=read();\n    while(tc--)\n    {\n    \ta=read(),n=read(),b=read(),p=read();\n    \tsolve();\n\t}\n    return 0;\n}//Yuki\n```",
        "postTime": 1657625909,
        "uid": 181775,
        "name": "_Fontainebleau_",
        "ccfLevel": 0,
        "title": "\u300cSparks Fly.\u300d"
    },
    {
        "content": "\u597d\u50cf\u633a\u7b80\u5355\u7684\u3002\n\n$n=1$ \u5c31\u662f\u840c\u840c BSGS\u3002\n\n$n=2$ \u4f60\u624b\u52a8\u753b\u51fa\u6765\u5c31\u662f\u4e00\u4e2a\u5e42\u5854 $a^{a^{a^{a^{\\cdots}}}}$\uff08\u5171 $n$ \u4e2a $a$\uff09\uff0c\u4f60\u89e3\u4e00\u5c42\u4e4b\u540e\u54e6 BSGS \u6a21\u6570\u5c31\u4f1a\u53d8\u4e3a\u5b83\u7684\u6b27\u62c9\u51fd\u6570\u503c\uff0c\u4e5f\u5c31\u662f\u5d4c\u5957\u5c42\u6570\u4e0d\u8d85\u8fc7 $O(\\log n)$\u3002\n\n\u5b9e\u9645\u4e0a\u53ea\u9700\u8981\u66b4\u529b\u679a\u4e3e\u7b54\u6848\u7136\u540e\u5224\u65ad\u5373\u53ef\u3002\n\n$n=3$ \u7684\u505a\u6cd5\u662f\u7c7b\u4f3c\u7684\uff0c\u4f60\u89e3\u4e00\u5c42\u5e42\u5854\u4e4b\u540e\u6a21\u6570\u4e5f\u4f1a\u53d8\u6210\u6b27\u62c9\u51fd\u6570\uff0c\u6240\u4ee5\u66b4\u529b\u679a\u4e3e\u7b54\u6848\u968f\u4fbf\u7b97\u7b97\u5c31\u597d\u4e86\u3002\n\n\u8fd8\u6709\u4e00\u79cd\u505a\u6cd5\uff0c\u5c31\u662f\u56e0\u4e3a\u5e42\u5854\u7684\u9ad8\u5ea6\u9ad8\u4e8e $2\\log p$ \u5c31\u6ca1\u6709\u610f\u4e49\u4e86\uff0c\u800c\u66b4\u529b\u5c55\u5f00\u4e00\u5c42\u53ef\u4ee5\u53d1\u73b0\u540e\u9762\u7684\u6570\u5b57\u5de8\u5927\uff0c\u6240\u4ee5\u5bf9\u4e8e $b>3$ \u90fd\u6ee1\u8db3 $a\\uparrow^3 b=a \\uparrow^3 3$\u3002\n\n\u66b4\u529b\u7b97 $a\\uparrow^3 2$ \u4e0e $a\\uparrow^3 3$ \u5373\u53ef\u3002\n\n\u4e0d\u592a\u60f3\u5199\u4ee3\u7801\u554a QAQ\u3002\n\n\u590d\u6742\u5ea6 $O(T\\sqrt p\\log p)$\u3002",
        "postTime": 1652000426,
        "uid": 105611,
        "name": "IdnadRev",
        "ccfLevel": 0,
        "title": "\u3010\u6570\u5b66\u8bb0\u5f55\u3011P6736 \u300cWdsr-2\u300d\u767d\u6cfd\u6559\u80b2"
    }
]