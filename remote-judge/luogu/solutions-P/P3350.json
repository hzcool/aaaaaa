[
    {
        "content": "\u8003\u8651\u5206\u6cbb\uff0c\u5f53\u524d\u95ee\u9898\u662f\u5728$x\\in[1,n],y\\in[1,m]$\u7684\u77e9\u5f62\u4e2d\u89e3\u51b3\u7f16\u53f7\u5728$[1,q]$\u7684\u8be2\u95ee\uff0c\u53ef\u4ee5\u8003\u8651\u628a\u77e9\u5f62\u7684\u957f\u8fb9\u5207\u5f00\uff0c\u53d8\u6210\u4e24\u4e2a\u76f8\u5bf9\u5747\u5300\u7684\u5c0f\u77e9\u5f62\uff08\u7c7b\u4f3cKD-tree\uff09\u3002\n\n\u5047\u8bbe\u76f4\u7ebf$x=mid$\u7ad6\u76f4\u5207\u5f00\u4e86\u5f53\u524d\u77e9\u5f62\uff0c\u90a3\u4e48\u6211\u4eec\u8981\u5904\u7406\u7684\u662f\u6240\u6709\u7ecf\u8fc7\u8fd9\u6761\u76f4\u7ebf\u7684\u8be2\u95ee\uff0c\u679a\u4e3e\u8fd9\u6761\u76f4\u7ebf\u4e0a\u7684\u70b9\uff0c\u5bf9\u6bcf\u4e2a\u70b9\u505a\u4e00\u904d\u5355\u6e90\u6700\u77ed\u8def\u66f4\u65b0\u7b54\u6848\u3002\u5bf9\u4e8e\u4e0d\u7ecf\u8fc7\u76f4\u7ebf\u7684\u8be2\u95ee\u628a\u5b83\u5206\u5230\u4e24\u4e2a\u5b50\u95ee\u9898\u4e2d\u3002\n\n\u4e4b\u540e\u590d\u6742\u5ea6\u8bc1\u660e\u4e5f\u7c7b\u4f3cKD-tree\uff0c\u5176\u4e2d\u8ddfKD-tree\u6700\u76f8\u4f3c\u7684\u5730\u65b9\u5c31\u662f\u6211\u90fd\u4e0d\u4f1a\u8bc1\u590d\u6742\u5ea6\u3002\n\n```c++\n#include<queue>\n#include<cstdio>\n#include<cstring>\n#include<iostream>\nusing namespace std;\nstruct que{\n\tint x1,x2,y1,y2,h;\n}q[100010],tmp[100010];\nstruct sbfa{\n\tint x,y,z;\n};\npriority_queue<sbfa> tm;\nbool operator < (sbfa c,sbfa d){return c.z>d.z;}\nint dx[4]={0,-1,0,1},dy[4]={-1,0,1,0},ans[100010];\nint o[20010],dis[20010];\nint n,m,s,w[20010][4],d[20010],c[20010];\ninline int id(int x,int y){return (x-1)*m+y;}\ninline void dij(int x,int y,int x1,int y1,int x2,int y2,int l,int r){\n\tsbfa u;\n\tu.x=x,u.y=y,u.z=0;\n\ttm.push(u);\n\tfor (int i=x1; i<=x2; i++)\n\t\tfor (int j=y1; j<=y2; j++)\n\t\t\tdis[id(i,j)]=2e9;\n\tdis[id(x,y)]=0;\n\twhile (!tm.empty()){\n\t\tu=tm.top(); tm.pop();\n\t\tx=u.x,y=u.y;\n\t\tint a=id(x,y),b;\n\t\tif (dis[a]!=u.z) continue;\n\t\tfor (int i=0; i<4; i++){\n\t\t\tif (x+dx[i]<x1||x+dx[i]>x2) continue;\n\t\t\tif (y+dy[i]<y1||y+dy[i]>y2) continue;\n\t\t\tb=id(x+dx[i],y+dy[i]);\n\t\t\tif (dis[b]>dis[a]+w[a][i]){\n\t\t\t\tdis[b]=dis[a]+w[a][i];\n\t\t\t\tu.x=x+dx[i],u.y=y+dy[i],u.z=dis[b];\n\t\t\t\ttm.push(u);\n\t\t\t}\n\t\t}\n\t}\n\tfor (int i=l; i<=r; i++)\n\t\tans[q[i].h]=min(ans[q[i].h],dis[id(q[i].x1,q[i].y1)]+dis[id(q[i].x2,q[i].y2)]);\n}\nvoid solve(int x1,int x2,int y1,int y2,int l,int r){\n\tif (x2-x1>=y2-y1){\n\t\tint mid=(x1+x2)>>1;\n\t\tfor (int i=y1; i<=y2; i++)\n\t\t\tdij(mid,i,x1,y1,x2,y2,l,r);\n\t\tint lp=l-1,rp=r+1;\n\t\tfor (int i=l; i<=r; i++) tmp[i]=q[i];\n\t\tfor (int i=l; i<=r; i++){\n\t\t\tif (tmp[i].x1<mid&&tmp[i].x2<mid)\n\t\t\t\tq[++lp]=tmp[i];\n\t\t\tif (tmp[i].x1>mid&&tmp[i].x2>mid)\n\t\t\t\tq[--rp]=tmp[i];\n\t\t}\n\t\tif (lp>=l) solve(x1,mid-1,y1,y2,l,lp);\n\t\tif (r>=rp) solve(mid+1,x2,y1,y2,rp,r);\n\t}\n\telse{\n\t\tint mid=(y1+y2)>>1;\n\t\tfor (int i=x1; i<=x2; i++) dij(i,mid,x1,y1,x2,y2,l,r);\n\t\tint lp=l-1,rp=r+1;\n\t\tfor (int i=l; i<=r; i++) tmp[i]=q[i];\n\t\tfor (int i=l; i<=r; i++){\n\t\t\tif (tmp[i].y1<mid&&tmp[i].y2<mid)\n\t\t\t\tq[++lp]=tmp[i];\n\t\t\tif (tmp[i].y1>mid&&tmp[i].y2>mid)\n\t\t\t\tq[--rp]=tmp[i];\n\t\t}\n\t\tif (lp>=l) solve(x1,x2,y1,mid-1,l,lp);\n\t\tif (r>=rp) solve(x1,x2,mid+1,y2,rp,r);\n\t}\n}\nint main(){\n\tscanf(\"%d%d\",&n,&m);\n\tfor (int i=1; i<=n; i++)\n\t\tfor (int j=1; j<m; j++)\n\t\t\tscanf(\"%d\",&d[id(i,j)]);\n\tfor (int i=1; i<n; i++)\n\t\tfor (int j=1; j<=m; j++)\n\t\t\tscanf(\"%d\",&c[id(i,j)]);\n\tfor (int i=1; i<=n; i++)\n\t\tfor (int j=1; j<=m; j++){\n\t\t\tint x=id(i,j);\n\t\t\tfor (int k=0; k<4; k++){\n\t\t\t\tif (i+dx[k]<1||i+dx[k]>n) continue;\n\t\t\t\tif (j+dy[k]<1||j+dy[k]>m) continue;\n\t\t\t\tif (k==0) w[x][k]=d[id(i,j-1)];\n\t\t\t\tif (k==1) w[x][k]=c[id(i-1,j)];\n\t\t\t\tif (k==2) w[x][k]=d[id(i,j)];\n\t\t\t\tif (k==3) w[x][k]=c[id(i,j)];\n\t\t\t}\n\t\t}\n\tscanf(\"%d\",&s);\n\tfor (int i=1; i<=s; i++){\n\t\tscanf(\"%d%d%d%d\",&q[i].x1,&q[i].y1,&q[i].x2,&q[i].y2);\n\t\tq[i].h=i;\n\t}\n\tmemset(ans,10,sizeof(ans));\n\tsolve(1,n,1,m,1,s);\n\tfor (int i=1; i<=s; i++) printf(\"%d\\n\",ans[i]);\n\treturn 0;\n}\n```\n\n",
        "postTime": 1570711098,
        "uid": 63661,
        "name": "Taduro",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3350 \u3010[ZJOI2016]\u65c5\u884c\u8005\u3011"
    },
    {
        "content": "\u672c\u9898\u8003\u5bdf\u4e86\u6700\u77ed\u8def\u548c\u5206\u6cbb\u3002\n\n\u5c06\u8be2\u95ee\u79bb\u7ebf\u4e0b\u6765\uff0c\u50cf\u6574\u4f53\u4e8c\u5206\u4e00\u6837\u5904\u7406\u3002\n\n\u5c06\u77e9\u5f62\u6cbf\u7740\u957f\u8fb9\u5207\u5f00\u9012\u5f52\u53ea\u9700\u8981\u4f20\u4e0a\u4e0b\u5de6\u53f3\u56db\u4e2a\u8fb9\u754c\u3002\n\u6ce8\u610f\u8fd9\u91cc\u4e0d\u9700\u8981\u65cb\u8f6c\u4ec0\u4e48\u7684\uff0c\u53ea\u9700\u8981\u4e8c\u5206\u4e00\u4e2a\u4e2d\u95f4\u503c\u5c31\u597d\u4e86\u3002\n\n\u5bf9\u6bcf\u6b21\u9012\u5f52\u5230\u8fbe\u7684\u72b6\u6001\uff0c\u90fd\u5728\u8fd9\u4e2a\u77e9\u9635\u91cc\u4e2d\u7ebf\u4e0a\u7684\u6bcf\u4e2a\u70b9\u4e3a\u8d77\u70b9\u6c42\u6700\u77ed\u8def\uff0c\u4e0d\u7528\u5bb3\u6015\u7b97\u91cd\uff0c\u6700\u77ed\u8def\u6570\u7ec4\u5728\u540c\u4e00\u77e9\u9635\u65f6\u65e0\u9700\u6e05\u96f6\uff0c\u53ea\u9700\u8981\u5c06\u6bcf\u4e2a\u70b9\u7684\u521d\u59cb\u6700\u77ed\u8def\u5b9a\u4e49\u4e3a\u4e0a\u4e00\u6b21\u7684\u6700\u77ed\u8def\u52a0\u4e0a\u4e0a\u6b21\u8d77\u70b9\u5230\u8fd9\u6b21\u8d77\u70b9\u7684\u6700\u77ed\u8def\u5c31\u597d\u4e86\uff0c\u6700\u4f18\u5316\u51cf\u679d\uff0c\u540c\u65f6\u4e5f\u4e0d\u7528\u5bb3\u6015\u7206\u6574\u578b\uff0c\u56e0\u4e3a\u6bcf\u4e2a\u70b9\u90fd\u662f\u4e00\u5b9a\u53ef\u8fbe\u7684\u3002\n\n\u7136\u540e\u5c06\u6700\u77ed\u8def\u7684\u6570\u7ec4\u5f52\u4f4d\uff0c\u540c\u65f6\u7edf\u8ba1\u7b54\u6848\uff0c\u7b54\u6848\u4e3amid\u4e0a\u7684\u70b9\u5230\u8d77\u70b9\u7684\u8ddd\u79bb\u52a0\u4e0a\u4e2d\u7ebf\u4e0a\u7684\u70b9\u5230\u7ec8\u70b9\u7684\u8ddd\u79bb\uff0c\u518d\u5c06\u8d77\u70b9\u548c\u7ec8\u70b9\u5728\u540c\u4e00\u4fa7\u7684\u9012\u5f52\u4e0b\u53bb\u7edf\u8ba1\u7b54\u6848\u5c31\u597d\u4e86\u3002\n\n\u672c\u9898\u9700\u8981\u5361\u5e38\u3002\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<cstdlib>\n#include<cstring>\n#include<queue>\n#include<algorithm>\n#define inline  __inline__ __attribute__((always_inline)) \nusing namespace std;\nint n,m,p,a,b,c,d,ans,vis[20001],f[20001],head[20001],numedge,vis1[20001],q[20000001],qhead,qtail;\ninline int read(){\n\tint x=0;char ch=getchar();\n\twhile(ch<'0'||ch>'9')ch=getchar();\n\twhile(ch>='0'&&ch<='9')x=x*10+ch-'0',ch=getchar();\n\treturn x;\n}\nstruct op{\n\tint a,b,c,d,id,ans;\n}opt[200001],q1[200001],q2[200001],q3[200001];\ninline bool cmp(const op &a,const op &b){return a.id<b.id;}\nstruct edge{int next,to,data;}ed[80001];\ninline void addedge(register int x,register int y,register int z){ed[++numedge]=(edge){head[x],y,z};head[x]=numedge;}\ninline void spfa(register int l1,register int l2,register int r1,register int r2,register int x){\n\tif(f[x]!=0){\n\t\tfor(register int i=l1;i<=r1;i++){\n\t\t\tfor(register int j=l2;j<=r2;j++){\n\t\t\t\tif((i-1)*m+j!=x)f[(i-1)*m+j]+=f[x];\n\t\t\t\tvis[(i-1)*m+j]=0;\n\t\t\t}\n\t\t}\n\t}\n\telse{\n\t\t for(register int i=l1;i<=r1;i++){\n\t\t \tfor(register int j=l2;j<=r2;j++){\n\t\t \t\tf[(i-1)*m+j]=0x3fffffff;\n\t\t \t\tvis[(i-1)*m+j]=0;\n\t\t\t }\n\t\t }\n\t}\n\tf[x]=0;qhead=qtail=0;q[qtail++]=x;\n\twhile(qhead<qtail){\n\t\tregister int x=q[qhead];qhead++;vis[x]=0;\n\t\tfor(register int i=head[x];i;i=ed[i].next){\n\t\t\tif(f[x]+ed[i].data<f[ed[i].to]&&vis1[ed[i].to]){\n\t\t\t\tf[ed[i].to]=f[x]+ed[i].data;\n\t\t\t\tif(!vis[ed[i].to])vis[ed[i].to]=1,q[qtail++]=ed[i].to;\n\t\t\t}\n\t\t} \n\t}\n}\nvoid dfs(register int l1,register int l2,register int r1,register int r2,register int l,register int r){\n\tif(l1==r1&&l2==r2||l>r)return;\n\tif(r1-l1>r2-l2){\n\t\tregister int mid=(l1+r1)/2;\n\t\tfor(register int i=l1;i<=r1;i++)for(register int j=l2;j<=r2;j++)vis1[(i-1)*m+j]=1; \n\t\tfor(register int i=l2;i<=r2;i++){\n\t\t\tspfa(l1,l2,r1,r2,(mid-1)*m+i);\n\t\t\tfor(register int j=l;j<=r;j++){\n\t\t\t\topt[j].ans=min(opt[j].ans,f[(opt[j].a-1)*m+opt[j].b]+f[(opt[j].c-1)*m+opt[j].d]);\n\t\t\t}\n\t\t}\n\t\tfor(register int i=l1;i<=r1;i++)for(register int j=l2;j<=r2;j++)f[(i-1)*m+j]=vis1[(i-1)*m+j]=0;\n\t\tint q1top=0,q2top=0,q3top=0;\n\t\tfor(register int i=l;i<=r;i++){\n\t\t\tif(opt[i].a<=mid&&opt[i].c<=mid)q1[++q1top]=opt[i];\n\t\t\telse if(opt[i].a>mid&&opt[i].c>mid)q2[++q2top]=opt[i];\n\t\t\telse q3[++q3top]=opt[i];\n\t\t}\n\t\tfor(register int i=l;i<=l+q1top-1;i++)opt[i]=q1[i-l+1];\n\t\tfor(register int i=l+q1top;i<=l+q1top+q2top-1;i++)opt[i]=q2[i-l-q1top+1];\n\t\tfor(register int i=l+q1top+q2top;i<=r;i++)opt[i]=q3[i-l-q1top-q2top+1];\n\t\tdfs(l1,l2,mid,r2,l,l+q1top-1);\n\t\tdfs(mid+1,l2,r1,r2,l+q1top,l+q1top+q2top-1);\n\t}\n\telse{\n\t\tregister int mid=(l2+r2)/2;\n\t\tfor(register int i=l1;i<=r1;i++)for(register int j=l2;j<=r2;j++)vis1[(i-1)*m+j]=1;\n\t\tfor(register int i=l1;i<=r1;i++){\n\t\t\tspfa(l1,l2,r1,r2,(i-1)*m+mid);\n\t\t\tfor(register int j=l;j<=r;j++){\n\t\t\t\topt[j].ans=min(opt[j].ans,f[(opt[j].a-1)*m+opt[j].b]+f[(opt[j].c-1)*m+opt[j].d]);\n\t\t\t}\n\t\t}\n\t\tfor(register int i=l1;i<=r1;i++)for(register int j=l2;j<=r2;j++)f[(i-1)*m+j]=vis1[(i-1)*m+j]=0;\n\t\tregister int q1top=0,q2top=0,q3top=0;\n\t\tfor(register int i=l;i<=r;i++){\n\t\t\tif(opt[i].b<=mid&&opt[i].d<=mid)q1[++q1top]=opt[i];\n\t\t\telse if(opt[i].b>mid&&opt[i].d>mid)q2[++q2top]=opt[i];\n\t\t\telse q3[++q3top]=opt[i];\n\t\t}\n\t\tfor(register int i=l;i<=l+q1top-1;i++)opt[i]=q1[i-l+1];\n\t\tfor(register int i=l+q1top;i<=l+q1top+q2top-1;i++)opt[i]=q2[i-l-q1top+1];\n\t\tfor(register int i=l+q1top+q2top;i<=r;i++)opt[i]=q3[i-l-q1top-q2top+1];\n\t\tdfs(l1,l2,r1,mid,l,l+q1top-1);dfs(l1,mid+1,r1,r2,l+q1top,l+q1top+q2top-1);\n\t}\n}\nint main(){\n\tn=read();m=read();\n\tfor(register int i=1;i<=n;i++)\n\t  for(register int j=1;j<m;j++){\n\t\tregister int x;x=read();\n\t\taddedge((i-1)*m+j,(i-1)*m+j+1,x);\n\t    addedge((i-1)*m+j+1,(i-1)*m+j,x);\n\t}\n\tfor(register int i=1;i<n;i++)\n\t   for(register int j=1;j<=m;j++){\n\t   \tregister int x;x=read();\n\t   \taddedge((i-1)*m+j,i*m+j,x);\n\t   \taddedge(i*m+j,(i-1)*m+j,x);\n\t   }\n\tp=read();\n\tfor(register int i=1;i<=p;i++)opt[i]=(op){read(),read(),read(),read(),i,0x7fffffff};\n\tdfs(1,1,n,m,1,p);\n\tsort(opt+1,opt+p+1,cmp);\n\tfor(register int i=1;i<=p;i++){\n\t\tprintf(\"%d\\n\",opt[i].ans);\n\t}\n}\n```",
        "postTime": 1598782580,
        "uid": 157571,
        "name": "anda",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 P3350 \u3010[ZJOI2016]\u65c5\u884c\u8005\u3011"
    },
    {
        "content": "\u5206\u6cbb\u3002\n\n\u5728\u5f53\u524d\u77e9\u5f62\u5185\uff0c\u6309\u957f\u8fb9\u5207\u5f00\u3002\n\n\u5bfb\u627e\u4e24\u7aef\u90fd\u5728\u5f53\u524d\u77e9\u5f62\u5185\u90e8\u7684\u70b9\u5bf9\u7ecf\u8fc7\u4e2d\u7ebf\u4e14\u4e0d\u8d85\u51fa\u77e9\u5f62\u7684\u6700\u77ed\u8def\u3002\n\n\u5982\u679c\u4e00\u4e2a\u70b9\u5bf9\u7684\u4e24\u4e2a\u70b9\u90fd\u5728\u4e2d\u7ebf\u7684\u540c\u4e00\u8fb9\uff0c\u5c31\u7ee7\u7eed\u9012\u5f52\u89e3\u51b3\u3002\n\n\u627e\u6700\u77ed\u8def\u65f6\u4ece\u4e2d\u7ebf\u4e0a\u7684\u6bcf\u4e00\u4e2a\u70b9\u4e3a\u8d77\u70b9\u5206\u522b\u505a\u6700\u77ed\u8def\u4f1aT\u3002\n\n\u6709\u4e00\u4e2a\u4f18\u5316\u662f\u628a\u6700\u77ed\u8def\u7684\u521d\u59cb\u503c\u8d4b\u4e3a\u4e0a\u6b21\u6700\u77ed\u8def\u7684\u503c\u52a0\u4e0a\u4e00\u4e2a\u8d77\u70b9\u5230\u8fd9\u4e2a\u8d77\u70b9\u7684\u8ddd\u79bb\u3002\n\n\u6570\u636e\u6ca1\u5361$spfa$\uff0c\u6bd4$dijkstra$\u5feb\u4e0d\u6b62\u4e00\u70b9\u3002\n\n\u590d\u6742\u5ea6O(\u80fd\u8fc7)\uff0c[\u8fd9\u7bc7\u535a\u5ba2](https://blog.csdn.net/neither_nor/article/details/51733997)\u8bc1\u660e\u662f$O(S\\sqrt{S}log{S})$\n\n```cpp\n#include <queue>\n#include <cstdio>\n#include <cctype>\n#include <cstring>\n#include <iostream>\n#include <algorithm>\nusing namespace std;\nint read()\n{\n    int x = 0, f = 1; char ch = getchar();\n    while (!isdigit(ch)) { if (ch == '-') f = -1; ch = getchar(); }\n    while (isdigit(ch)) { x = x * 10 + ch - '0'; ch = getchar(); }\n    return x * f;\n}\nconst int MAX = 200033;\nconst int inf = 100000000;\n#define id(i, j) ((i - 1) * m + (j))\nint n, m, cnte, Q, cntid;\nint invx[20033], invy[20033];\nint fir[20033];\nstruct Query\n{\n    int x, y, xx, yy, id;\n} q[100033], tmp[100033];\nstruct edge\n{\n    int to, nxt, w;\n    edge() {}\n    edge(int a, int b, int c)\n    {\n        to = a, nxt = b, w = c;\n    }\n} e[200033];\nvoid addedge(int u, int v, int w)\n{\n    e[++cnte] = edge(v, fir[u], w), fir[u] = cnte;\n    e[++cnte] = edge(u, fir[v], w), fir[v] = cnte;\n}\nint ans[100033], dis[20033];\nint que[2000033];\nbool inq[20033];\nvoid dijkstra(int s, int xl, int xr, int yl, int yr, int h)\n{\n\tint d = dis[s];\n\tfor (int i = xl; i <= xr; i++)\n        for (int j = yl; j <= yr; j++)\n            dis[id(i, j)] = h ? dis[id(i, j)] + d : inf;\n    dis[s] = 0;\n    inq[s] = 1; \n\tint l = 10000, r = 10000;\n\tque[r++] = s;\n\twhile (l != r)\n\t{\n\t\tint u = que[l++];\n\t\tinq[u] = 0;\n\t\tfor (int i = fir[u]; i; i = e[i].nxt)\n\t\t{\n\t\t\tint v = e[i].to;\n\t\t\tint vy = invy[v], vx = invx[v];\n\t\t\tif (vx >= xl && vx <= xr && vy >= yl && vy <= yr)\n                if (dis[v] > dis[u] + e[i].w)\n                {\n                \tdis[v] = dis[u] + e[i].w;\n                \tif (!inq[v])\n                \t{\n                \t\tif (dis[v] <= dis[que[l]])\n                \t\t\tque[--l] = v;\n                \t\telse que[r++] = v;\n                \t\tinq[v] = 1;\n                \t}\n                }\n\t\t}\n\t}\n}\nvoid solve(int xl, int xr, int yl, int yr, int ql, int qr)\n{\n    if (ql > qr) return;\n    if (xr - xl > yr - yl)\n    {\n        int mid = (xl + xr) >> 1;\n        for (int i = yl; i <= yr; i++)\n        {\n            dijkstra(id(mid, i), xl, xr, yl, yr, i - yl);\n            for (int j = ql; j <= qr; j++)\n                ans[q[j].id] = min(ans[q[j].id], dis[id(q[j].x, q[j].y)] + dis[id(q[j].xx, q[j].yy)]);\n        }\n        int l = ql - 1, r = qr + 1;\n        for (int i = ql; i <= qr; i++)\n        {\n            if (q[i].x < mid && q[i].xx < mid)\n                tmp[++l] = q[i];\n            else if (q[i].x > mid && q[i].xx > mid)\n                tmp[--r] = q[i];\n        }\n        for (int i = ql; i <= l; i++)\n            q[i] = tmp[i];\n        for (int i = r; i <= qr; i++)\n            q[i] = tmp[i];\n        solve(xl, mid - 1, yl, yr, ql, l);\n        solve(mid + 1, xr, yl, yr, r, qr);\n    }\n    else\n    {\n        int mid = (yl + yr) >> 1;\n        for (int i = xl; i <= xr; i++)\n        {\n            dijkstra(id(i, mid), xl, xr, yl, yr, i - xl);\n            for (int j = ql; j <= qr; j++)\n                ans[q[j].id] = min(ans[q[j].id], dis[id(q[j].x, q[j].y)] + dis[id(q[j].xx, q[j].yy)]);\n        }\n        int l = ql - 1, r = qr + 1;\n        for (int i = ql; i <= qr; i++)\n        {\n            if (q[i].y < mid && q[i].yy < mid)\n                tmp[++l] = q[i];\n            else if (q[i].y > mid && q[i].yy > mid)\n                tmp[--r] = q[i];\n        }\n        for (int i = ql; i <= l; i++)\n            q[i] = tmp[i];\n        for (int i = r; i <= qr; i++)\n            q[i] = tmp[i];\n        solve(xl, xr, yl, mid - 1, ql, l);\n        solve(xl, xr, mid + 1, yr, r, qr);\n    }\n}\nint main()\n{\n    memset(ans, 63, sizeof ans);\n    n = read(), m = read();\n    for (int i = 1; i <= n; i++)\n    \tfor (int j = 1; j <= m; j++)\n    \t{\n    \t\tcntid++;\n    \t\tinvx[cntid] = i, invy[cntid] = j;\n    \t}\n    for (int i = 1; i <= n; i++)\n        for (int j = 1; j < m; j++)\n            addedge(id(i, j), id(i, j + 1), read());\n    for (int i = 1; i < n; i++)\n        for (int j = 1; j <= m; j++)\n            addedge(id(i, j), id(i + 1, j), read());\n    Q = read();\n    for (int i = 1; i <= Q; i++)\n    {\n        q[i].x = read(), q[i].y = read();\n        q[i].xx = read(), q[i].yy = read();\n        q[i].id = i;\n    }\n    solve(1, n, 1, m, 1, Q);\n\tfor (int i = 1; i <= Q; i++)\n        printf(\"%d\\n\", ans[i]);\n    return 0;\n}\n```",
        "postTime": 1522804453,
        "uid": 37070,
        "name": "Ameyax",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3350 \u3010[ZJOI2016]\u65c5\u884c\u8005\u3011"
    },
    {
        "content": "\u4e00\u9053\u725b\u903c\u9898\n\n## \u9898\u76ee\u5927\u610f\n\n\u7ed9\u5b9a\u4e00\u5f20$n*m$\u7684\u7f51\u683c\u56fe$(n*m\\le 2\\times10^4)$,$Q(Q\\le2\\times10^5)$\u6b21\u67e5\u8be2\uff0c\u8be2\u95ee\u4e24\u70b9\u4e4b\u95f4\u7684\u8ddd\u79bb\u3002\n\n[\u4f20\u9001\u95e81](https://www.luogu.org/problem/P3350)\n\n[\u4f20\u9001\u95e82](https://darkbzoj.tk/problem/4456)\n\n[\u4f20\u9001\u95e83](https://loj.ac/problem/2090)\n\n[\u4f20\u9001\u95e84](http://uoj.ac/problem/184)\n\n## \u9898\u76ee\u89e3\u6cd5\n\n\u6b22\u8fce\u6765\u6211\u535a\u5ba2[pmt2018](https://www.cnblogs.com/pmt2018/p/11644666.html)\u67e5\u770b\n\n\u6709\u8001\u54e5\u8bf4\u770b\u5230\u7f51\u683c\u56fe\u5c31\u60f3\u5230\u5206\u6cbb\uff0c\u53cd\u6b63\u6211\u662f\u542c\u4e86\u9898\u89e3\u624d\u4f1a\u7684\u3002\n\n\u505a\u6cd5\u662f\u5bf9\u6bcf\u6b21\u5bf9\u7f51\u683c\u56fe\u7684\u957f\u8fb9\u4e00\u5207\u4e3a\u4e8c\uff0c\u8003\u8651\u4e24\u79cd\u60c5\u51b5\n\n1. \u4e24\u70b9\u4e0d\u8de8\u8fc7\u4e2d\u7ebf\uff0c\u8fd9\u65f6\u4e24\u70b9\u7684\u6700\u77ed\u8def\u6709\u4e24\u79cd\u60c5\u51b5\uff0c\u8981\u4e48\u4e0d\u8de8\u8fc7\u4e2d\u7ebf\uff0c\u6211\u4eec\u8fd9\u65f6\u679a\u4e3e\u4e2d\u7ebf\u4e0a\u7684\u70b9\u7528\u6700\u77ed\u8def\u5c06\u5176\u66f4\u65b0\uff0c\u8981\u4e48\u8de8\u8fc7\u4e2d\u7ebf\uff0c\u8fd9\u65f6\u6211\u4eec\u5c06\u5176\u5206\u6cbb\u4e0b\u53bb\u7ee7\u7eed\u505a\u3002\n\n2. \u4e24\u70b9\u8de8\u8fc7\u4e2d\u7ebf\uff0c\u8fd9\u65f6\u5206\u6cbb\u4e0b\u53bb\u4e5f\u6ca1\u5565\u7528\u4e86\u3002\n\n\u6240\u4ee5\u6211\u4eec\u628a\u6240\u6709\u8be2\u95ee\u79bb\u7ebf\u4e0b\u6765\uff0c\u50cf\u6574\u4f53\u4e8c\u5206\u4e00\u6837\u7684\u5904\u7406\u5c31\u597d\u4e86\u3002\n\n\u6b63\u786e\u6027\u663e\u7136\uff0c\u542c\u8bf4\u590d\u6742\u5ea6\u662f$O(S\\sqrt S\\ log_2S)$\u7684\uff0c\u4f46\u662f\u6211\u4e0d\u4f1a\u8bc1\u660e\u3002\n\n\u4ee3\u7801\u5982\u4e0b\n\n```cpp\n#include<bits/stdc++.h>\n#define mp make_pair\n#define pb push_back\n#define fi first\n#define se second\n\n#define y0 pmt\n#define y1 pmtpmt\n#define x0 pmtQAQ\n#define x1 pmtQwQ\n\nusing namespace std;\ntypedef long long ll;\ntypedef unsigned long long ull;\ntypedef vector<int > vi;\ntypedef pair<int ,int > pii;\nconst int INF=0x3f3f3f3f, maxn=100007, MOD=1e9+7;\nconst ll LINF=0x3f3f3f3f3f3f3f3fLL;\nconst ll P=19260817;\nint n,m;\nint Q;\nstruct Point{\n\tint x,y;\n\tPoint(){}\n\tPoint(int _x,int _y){x=_x,y=_y;}\n\tfriend bool operator < (const Point &x,const Point &y){\n\t\tif(x.x!=y.x)return x.x<y.x;\n\t\treturn x.y<y.y;\n\t}\n};\nint id(Point x){return (x.x-1)*m+x.y;}\nbool in(Point x,int lx,int rx,int ly,int ry){\n\treturn lx<=x.x&&x.x<=rx&&ly<=x.y&&x.y<=ry;\n}\nstruct edge{\n\tint nxt,w;\n\tPoint to;\n}e[maxn<<2];\nint head[maxn],tot;\nvoid addedge(Point u,Point v,int w){\n\te[++tot].to=v;\n\te[tot].w=w;\n\te[tot].nxt=head[id(u)];\n\thead[id(u)]=tot;\n}\nstruct query{\n\tPoint x,y;\n\tint id;\n}q[maxn<<2],q1[maxn<<1],q2[maxn<<1];\nint ans[maxn];\npriority_queue<pair<int ,Point >,vector<pair<int ,Point > >,greater<pair<int ,Point > > > pq;\nint dis[maxn];\nint vis[maxn];\nvoid dij(int lx,int rx,int ly,int ry,int x,int y){//\u6700\u77ed\u8def\uff0c\u5904\u7406(x,y)\u5230(lx~rx,ly~ry)\u77e9\u5f62\u91cc\u7684\u6700\u77ed\u8def\n\tfor(int i=lx;i<=rx;i++)for(int j=ly;j<=ry;j++)dis[id(Point(i,j))]=INF,vis[id(Point(i,j))]=0;\n\tdis[id(Point(x,y))]=0;\n\tpq.push(mp(0,Point(x,y)));\n\twhile(!pq.empty()){\n\t\tPoint u=pq.top().se;int d=pq.top().fi;pq.pop();\n\t\tif(d!=dis[id(u)]||vis[id(u)])continue;\n\t\tvis[id(u)]=true;\n\t\tfor(int i=head[id(u)];i;i=e[i].nxt){\n\t\t\tPoint v=e[i].to;\n\t\t\tif(in(v,lx,rx,ly,ry)&&dis[id(u)]+e[i].w<dis[id(v)]){\n\t\t\t\tdis[id(v)]=dis[id(u)]+e[i].w;\n\t\t\t\tpq.push(mp(dis[id(v)],v));\n\t\t\t}\n\t\t}\n\t}\n}\nvoid solve(int lx,int rx,int ly,int ry,int l,int r){//(lx~rx,ly~ry)\u8868\u793a\u5f53\u524d\u5904\u7406\u7684\u77e9\u5f62\uff0cx~y\u8868\u793a\u6211\u4eec\u5f53\u524d\u5904\u7406\u7684\u8be2\u95ee\u7684\u8303\u56f4\n\tif(lx==rx&&ly==ry){\n\t\tfor(int i=l;i<=r;i++)ans[q[i].id]=0;\n\t\treturn ;\n\t}\n\tif(l>r)return;\n\tif(rx-lx>=ry-ly){//\u6211\u4eec\u9009\u62e9\u5207\u77e9\u5f62\u8f83\u957f\u7684\u4e00\u8fb9\n\t\tint mid=(lx+rx)>>1;\n\t\tfor(int i=ly;i<=ry;i++){//\u679a\u4e3e\u4e2d\u7ebf\u4e0a\u7684\u70b9\n\t\t\tdij(lx,rx,ly,ry,mid,i);\n\t\t\tfor(int j=l;j<=r;j++)ans[q[j].id]=min(ans[q[j].id],dis[id(q[j].x)]+dis[id(q[j].y)]);//\u66f4\u65b0\u7b54\u6848\n\t\t}\n\t\tint top1=0,top2=0;\n\t\tfor(int i=l;i<=r;i++){\n            //\u5c06\u4e0d\u8de8\u8fc7\u4e2d\u7ebf\u7684\u70b9\u5206\u6cbb\u5904\u7406\n\t\t\tif(in(q[i].x,lx,mid,ly,ry)&&in(q[i].y,lx,mid,ly,ry))q1[++top1]=q[i];\n\t\t\tif(in(q[i].x,mid+1,rx,ly,ry)&&in(q[i].y,mid+1,rx,ly,ry))q2[++top2]=q[i];\n\t\t}\n\t\tfor(int i=l;i<=l+top1-1;i++)q[i]=q1[i-l+1];\n\t\tfor(int i=l+top1;i<=l+top1+top2-1;i++)q[i]=q2[i-l-top1+1];\n        //\u5206\u6cbb\u5207\u5f00\u7684\u4e24\u4e2a\u77e9\u5f62\n\t\tsolve(lx,mid,ly,ry,l,l+top1-1);solve(mid+1,rx,ly,ry,l+top1,l+top1+top2-1);\n\t}else{\n        //\u4e0e\u4e0a\u9762\u540c\u7406\n\t\tint mid=(ly+ry)>>1;\n\t\tfor(int i=lx;i<=rx;i++){\n\t\t\tdij(lx,rx,ly,ry,i,mid);\n\t\t\tfor(int j=l;j<=r;j++)ans[q[j].id]=min(ans[q[j].id],dis[id(q[j].x)]+dis[id(q[j].y)]);\n\t\t}\n\t\tint top1=0,top2=0;\n\t\tfor(int i=l;i<=r;i++){\n\t\t\tif(in(q[i].x,lx,rx,ly,mid)&&in(q[i].y,lx,rx,ly,mid))q1[++top1]=q[i];\n\t\t\tif(in(q[i].x,lx,rx,mid+1,ry)&&in(q[i].y,lx,rx,mid+1,ry))q2[++top2]=q[i];\n\t\t}\n\t\tfor(int i=l;i<=l+top1-1;i++)q[i]=q1[i-l+1];\n\t\tfor(int i=l+top1;i<=l+top1+top2-1;i++)q[i]=q2[i-l-top1+1];\n\t\tsolve(lx,rx,ly,mid,l,l+top1-1);solve(lx,rx,mid+1,ry,l+top1,l+top1+top2-1);\n\t}\n}\nint main(){\n\t//freopen(\".in\",\"r\",stdin);\n\t//freopen(\".out\",\"w\",stdout);\n\tscanf(\"%d%d\",&n,&m);\n\tfor(int i=1;i<=n;i++){\n\t\tfor(int j=1;j<m;j++){\n\t\t\tint x;scanf(\"%d\",&x);\n\t\t\taddedge(Point(i,j),Point(i,j+1),x);\n\t\t\taddedge(Point(i,j+1),Point(i,j),x);\n\t\t\t\n\t\t}\n\t}\t\n\tfor(int i=1;i<n;i++){\n\t\tfor(int j=1;j<=m;j++){\n\t\t\tint x;scanf(\"%d\",&x);\n\t\t\taddedge(Point(i,j),Point(i+1,j),x);\n\t\t\taddedge(Point(i+1,j),Point(i,j),x);\n\t\t}\n\t}\t\n\tscanf(\"%d\",&Q);\n\tfor(int i=1;i<=Q;i++){\n\t\tPoint x,y;\n\t\tscanf(\"%d%d%d%d\",&x.x,&x.y,&y.x,&y.y);\n\t\tq[i].x=x,q[i].y=y,q[i].id=i;\n\t}\n\tmemset(ans,0x3f,sizeof(ans));\n\tsolve(1,n,1,m,1,Q);\n\tfor(int i=1;i<=Q;i++)printf(\"%d\\n\",ans[i]);\n\treturn 0;\n}\n```\n\n",
        "postTime": 1570629407,
        "uid": 58532,
        "name": "pmt2018",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P3350 \u3010[ZJOI2016]\u65c5\u884c\u8005\u3011"
    },
    {
        "content": "**\u542b\u590d\u6742\u5ea6\u8bc1\u660e\u7684\u9898\u89e3**\n\n### \u601d\u8def\u7b80\u8ff0\n\n\u5982\u679c\u53ea\u6709\u4e00\u7ec4\u8be2\u95ee\uff1atoo simple\n\n\u4f46\u662f\u6709 $Q$ \u7ec4\u8be2\u95ee\uff0c\u76f4\u63a5\u50bb\u4e86\u3002\n\n\u77aa\u9898\u610f\u53d1\u73b0\u53ef\u4ee5\u79bb\u7ebf\uff0c\u5e76\u4e14\u56fe\u5f88\u89c4\u6574... \u8003\u8651\u5206\u6cbb\uff01\n\n\u60f3\u5230\u8fd9\u91cc\u4e4b\u540e\u5c31\u5f88\u7b80\u5355\u4e86\u3002\u5148\u628a\u56fe\u4ece\u4e2d\u95f4\u5207\u5f00\uff0c\u7136\u540e\u9012\u5f52\u5904\u7406\u5de6\u53f3\u4e24\u8fb9\u7684\u5185\u90e8\u7684\u3002\u679a\u4e3e\u4e2d\u95f4\u7684\u70b9\uff0c\u4ee5\u5b83\u4e3a\u6e90\u70b9\u8dd1\u6700\u77ed\u8def\uff0c\u4e24\u8fb9\u4e00\u62fc\u6c42\u51fa\u8de8\u8fc7\u4e2d\u7ebf\u7684\u7b54\u6848\u3002\n\n\u5982\u4f55\u5904\u7406\u8be2\u95ee\u5462\uff1f\u6211\u4eec\u4fdd\u8bc1\u6bcf\u6b21\u9012\u5f52\u7684\u65f6\u5019\uff0c\u624b\u4e0a\u62ff\u7684\u8be2\u95ee\u90fd\u662f\u5728\u6574\u4e2a\u533a\u95f4\u5185\u7684\uff0c\u7136\u540e\u8fd9\u6837\u5c31\u53ef\u4ee5\u5224\u65ad\u5b83\u5c5e\u4e8e\u5de6\u534a\u8fd8\u662f\u53f3\u534a\u3002\n\n\u7136\u540e\u7c7b\u4f3c\u6574\u4f53\u4e8c\u5206\uff0c\u6211\u4eec\u628a\u8be2\u95ee\u91cd\u6392\u4e00\u4e0b\uff0c\u628a\u5de6\u534a\u653e\u5230\u5de6\u8fb9\uff0c\u53f3\u534a\u653e\u5230\u53f3\u8fb9\uff0c\u8fd9\u6837\u6bcf\u6b21\u8bb0\u4e00\u4e2a\u8be2\u95ee\u4e2d\u7684\u533a\u95f4 $[q_l,q_r]$ \u5c31\u53ef\u4ee5\u77e5\u9053\u5f53\u524d\u5728\u6211\u4eec\u9012\u5f52\u5230\u7684\u5b50\u77e9\u5f62\u91cc\u7684\u8be2\u95ee\u662f\u54ea\u4e9b\u4e86\u3002\n\n### \u590d\u6742\u5ea6\u7684\u8bc1\u660e\n\n\u9996\u5148\u4e00\u4e2a\u663e\u7136\u7684\u7ed3\u8bba\uff0c\u82e5 $a\\times b=K$\uff0c\u90a3\u4e48 $min(a,b)\\le \\sqrt{K}$\n\n\u7136\u540e\u6211\u4eec\u7684\u4ee3\u7801\u505a\u4e00\u4e2a\u5c0f\u4f18\u5316\uff1a\u5bf9\u4e8e\u6bcf\u6b21\u9012\u5f52\u5230\u7684\u77e9\u5f62\uff0c\u5207\u7684\u90a3\u4e00\u5200\u5207\u5728\u957f\u8fb9\u4e0a\u3002\u8fd9\u6837\u4e2d\u7ebf\u7684\u957f\u5ea6\u5c31\u4e0d\u4f1a\u8d85\u8fc7\u9762\u79ef\u7684\u6839\u53f7\u3002\n\n\u8bbe $T(n)$ \u8868\u793a\u77e9\u5f62\u9762\u79ef\u4e3a $n$ \u7684\u6c42\u89e3\u590d\u6742\u5ea6\n\n\u8003\u8651\u6700\u574f\u60c5\u51b5\uff0c\u6bcf\u6b21\u5207\u7684\u90a3\u4e00\u5200\u7684\u4e2d\u7ebf\u957f\u5ea6\u90fd\u5361\u5728\u77e9\u5f62\u7684\u9762\u79ef\u7684\u6839\u53f7\u90a3\u91cc\u3002\n\n$T(n)=2T(n/2)+\\sqrt{n}\\times n$\n\n\u6839\u636e\u4e3b\u5b9a\u7406\u5b83\u7684\u590d\u6742\u5ea6\u5c31\u662f $n\\times \\sqrt{n} \\times \\log(n)$\n\n\u7136\u540e\u8003\u8651\u8be2\u95ee\u3002\u6bcf\u4e00\u4e2a\u8be2\u95ee\u90fd\u4e00\u5b9a\u4f1a\u5728\u67d0\u4e00\u5c42\u88ab\u8003\u8651\u5230\uff0c\u8ba1\u7b97\u5f97\u6700\u77ed\u8def\u3002\u7c7b\u4f3c\u4e0a\u9762\u7684\u63a8\u5bfc\uff0c\u590d\u6742\u5ea6\u5e94\u8be5\u662f $n\\times \\sqrt{n} \\times log(q)$\n\n\u4e8e\u662f\u590d\u6742\u5ea6\u662f $O(n\\sqrt{n}(\\log(n)+\\log(q)))$\n\n\u5176\u4e2d $n$ \u6307\u7684\u662f\u77e9\u5f62\u7684\u9762\u79ef\uff0c\u5728\u9898\u76ee\u4e2d\u5176\u5b9e\u662f $n\\times m$\u3002\n\n\u7531\u4e8e $n\\times m\\le 2e4$\uff0c\u6240\u4ee5\u8fd9\u4e2a\u590d\u6742\u5ea6\u6760\u6760\u7684\u80fd\u8fc7\u3002\n\n### \u4ee3\u7801\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\nnamespace Flandre_Scarlet\n{\n    #define N 114514\n    #define int long long\n    #define INF 0x3f3f3f3f3f3f3f3fll\n    #define F(i,l,r) for(int i=l;i<=r;++i)\n    #define D(i,r,l) for(int i=r;i>=l;--i)\n    #define Fs(i,l,r,c) for(int i=l;i<=r;c)\n    #define Ds(i,r,l,c) for(int i=r;i>=l;c)\n    #define MEM(x,a) memset(x,a,sizeof(x))\n    #define FK(x) MEM(x,0)\n    #define Tra(i,u) for(int i=G.Start(u),v=G.To(i);~i;i=G.Next(i),v=G.To(i))\n    #define p_b push_back\n    #define sz(a) ((int)a.size())\n    #define all(a) a.begin(),a.end()\n    #define iter(a,p) (a.begin()+p)\n    int I() {char c=getchar(); int x=0; int f=1; while(c<'0' or c>'9') f=(c=='-')?-1:1,c=getchar(); while(c>='0' and c<='9') x=(x<<1)+(x<<3)+(c^48),c=getchar(); return ((f==1)?x:-x);}\n    template <typename T> void Rd(T& arg){arg=I();}\n    template <typename T,typename...Types> void Rd(T& arg,Types&...args){arg=I(); Rd(args...);}\n    void RA(int *p,int n) {F(i,1,n) *p=I(),++p;}\n    class Graph\n    {\n    public:\n        int head[N];\n        struct Edge{int v,w,nex;} E[N<<1]; int Ecnt=-1;\n        void clear() {MEM(head,-1); MEM(E,-1); Ecnt=-1;}\n        void AddEdge(int u,int v,int w=1) {E[++Ecnt]=(Edge){v,w,head[u]}; head[u]=Ecnt;}\n        void Add2(int u,int v,int w=1) \n        {\n            AddEdge(u,v,w); AddEdge(v,u,w);\n        }\n        void Read(int m,int t=2) {clear(); F(i,1,m) {int u=I(),v=I(),w=I(); (t==1)?AddEdge(u,v,w):Add2(u,v,w);}} \n        int  To(int i) {return E[i].v;} int Label(int i) {return E[i].w;} int Next(int i) {return E[i].nex;} int Start(int u){return head[u];}\n    }G;\n    int n,m,q;\n    struct point // \u4e00\u4e2a\u70b9, \u7531\u4e8e\u4e0d\u597d\u5f00\u6570\u7ec4, \u6211\u4eec\u628a\u70b9\u7f16\u53f7, \u7136\u540e\u4fe1\u606f\u5b58\u5728\u4e00\u7ef4\u6570\u7ec4\u91cc\n    {\n        int x,y;\n        point() {x=y=0;}\n        point(int val) {x=val/m+1; y=val%m; if (y==0) y=m,x--;}\n        // \u6ce8\u610f\u8fd9\u4e2a\u7279\u5224\n        point(int xx,int yy) {x=xx; y=yy;}\n    };\n    int id(point x) {return (x.x-1)*m+x.y;}\n    // \u5c01\u88c5\u4e86\u4ece\u70b9\u5230\u7f16\u53f7, \u548c\u7f16\u53f7\u5230\u70b9\n    struct query{point s,t; int id;} Q[N]; \n    void Input()\n    {\n        Rd(n,m); G.clear();\n        F(i,1,n) F(j,1,m-1)\n        {\n            point cur=(point){i,j};\n            int x=I();\n            G.Add2(id(cur),id(cur)+1,x);\n        }\n        F(i,1,n-1) F(j,1,m)\n        {\n            point cur=(point){i,j};\n            int x=I();\n            G.Add2(id(cur),id(cur)+m,x);\n        }\n        // \u8bfb\u8fdb\u6765\u76f4\u63a5\u5efa\u56fe\u597d\u4e86\n        q=I();\n        F(i,1,q) Q[i]=(query){(point){I(),I()},(point){I(),I()},i};\n    }\n    bool in(point x,int xl,int xr,int yl,int yr)\n    {\n        return (xl<=x.x and x.x<=xr) and (yl<=x.y and x.y<=yr);\n    }\n    namespace Min_Path // \u63a7\u5236\u5b50\u77e9\u5f62\u533a\u95f4\u7684\u6700\u77ed\u8def\n    {\n        struct dnode{point v; int w;};\n        bool operator<(dnode a,dnode b) {return a.w>b.w;}\n        int dis[N]; bool vis[N]; priority_queue<dnode> Q;\n        void Dijkstra(point s,int xl,int xr,int yl,int yr)\n        {\n            F(i,xl,xr) F(j,yl,yr) \n            {\n                point cur=(point){i,j};\n                dis[id(cur)]=INF; vis[id(cur)]=0;\n            }\n            while(!Q.empty()) Q.pop();\n            Q.push((dnode){id(s),0}); dis[id(s)]=0;\n\n            while(!Q.empty())\n            {\n                dnode Min=Q.top(); Q.pop();\n                int u=id(Min.v);\n\n                if (vis[u]) continue;\n                vis[u]=1;\n                Tra(i,u) \n                {\n                    point tmp(v);\n                    if (dis[u]+G.Label(i)<dis[v] and in(tmp,xl,xr,yl,yr) and !vis[v])\n                    // \u4e0e\u5e38\u89c4\u6700\u77ed\u8def\u7684\u552f\u4e00\u533a\u522b\u5c31\u662f\u8fd9\u91cc\u65b0\u8fdb\u6765\u7684\u70b9\u8981\u5224\u4e00\u4e0b\u662f\u5426\u5728\u9650\u5b9a\u533a\u95f4\u5185\n                    {\n                        dis[v]=dis[u]+G.Label(i);\n                        Q.push((dnode){tmp,dis[v]});\n                    }\n                }\n            }\n        }\n    }\n    using Min_Path::dis;\n\n    int ans[N];\n    query tmp[N];\n    void calc(int xl,int xr,int yl,int yr,int ql,int qr)\n    {\n        if (ql>qr) return;\n        if (xl==xr and yl==yr)\n        {\n            F(i,ql,qr) ans[Q[i].id]=0;\n            return;\n        }\n        // \u4fe9\u663e\u7136\u7684\u8fb9\u754c\n        if (xr-xl>yr-yl)\n        {\n            int mid=(xl+xr)>>1;\n            F(i,yl,yr)\n            {\n                Min_Path::Dijkstra((point){mid,i},xl,xr,yl,yr);\n                F(j,ql,qr) ans[Q[j].id]=min(ans[Q[j].id],dis[id(Q[j].s)]+dis[id(Q[j].t)]);\n                // \u8dd1\u6700\u77ed\u8def, \u4e24\u8fb9\u4e00\u62fc\u66f4\u65b0\u7b54\u6848\n            }\n            int pos=ql-1;\n            F(i,ql,qr) if (in(Q[i].s,xl,mid,yl,yr) and in(Q[i].t,xl,mid,yl,yr)) tmp[++pos]=Q[i];\n            int qmid=pos;\n            F(i,ql,qr) if (in(Q[i].s,mid+1,xr,yl,yr) and in(Q[i].t,mid+1,xr,yl,yr)) tmp[++pos]=Q[i];\n            F(i,ql,pos) Q[i]=tmp[i];\n            // \u91cd\u6392\u4e00\u4e0b\u8be2\u95ee\u533a\u95f4\n\n            calc(xl,mid,yl,yr,ql,qmid);\n            calc(mid+1,xr,yl,yr,qmid+1,pos); \n        }\n        else // \u8fd9\u4fe9\u540c\u7406\n        {\n            int mid=(yl+yr)>>1;\n            F(i,xl,xr)\n            {\n                Min_Path::Dijkstra((point){i,mid},xl,xr,yl,yr);\n                F(j,ql,qr) \n                {\n                    ans[Q[j].id]=min(ans[Q[j].id],dis[id(Q[j].s)]+dis[id(Q[j].t)]);\n                }\n            }\n            int pos=ql-1;\n            F(i,ql,qr) if (in(Q[i].s,xl,xr,yl,mid) and in(Q[i].t,xl,xr,yl,mid)) tmp[++pos]=Q[i];\n            int qmid=pos;\n            F(i,ql,qr) if (in(Q[i].s,xl,xr,mid+1,yr) and in(Q[i].t,xl,xr,mid+1,yr)) tmp[++pos]=Q[i];\n            F(i,ql,pos) Q[i]=tmp[i];\n            calc(xl,xr,yl,mid,ql,qmid);\n            calc(xl,xr,mid+1,yr,qmid+1,pos);\n        }\n    }\n    void Soviet()\n    {\n        MEM(ans,INF);\n        calc(1,n,1,m,1,q);\n        F(i,1,q) printf(\"%lld\\n\",ans[i]);\n    }\n    void IsMyWife()\n    {\n        Input();\n        Soviet();\n    }\n}\n#undef int //long long\nint main()\n{\n    Flandre_Scarlet::IsMyWife();\n    getchar();\n    return 0;\n}\n```",
        "postTime": 1603819772,
        "uid": 106252,
        "name": "LightningUZ",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3350 \u3010[ZJOI2016]\u65c5\u884c\u8005\u3011"
    },
    {
        "content": "-  \u5bf9\u4e8e\u524d20%\u7684\u505a\u6cd5\uff1a\u76f4\u63a5\u66b4\u529b\u6700\u77ed\u8def(\u2299o\u2299)\u3002\n\n\t\u590d\u6742\u5ea6 Qnmlog(nm)\n\n- \u5bf9\u4e8e\u4e2d\u95f4\u768430%\uff1a\u77e9\u5f62\u7684\u77ed\u8fb9\u4e0d\u8d85\u8fc74\uff0c\u53ef\u4ee5\u5728\u957f\u8fb9\u4e0a\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u4e00\u4e2a\u9ad8\u4e3a4\u7684\u77e9\u5f62\u5185\u7684\u6700\u77ed\u8def\uff0c\u8be2\u95ee\u65f6\u540c\u65f6\u628a\u8be2\u95ee\u77e9\u5f62\u4e24\u8fb9\u4e5f\u66f4\u65b0\u8fdb\u53bb\u3002\u6709\u70b9\u50cfSHOI2008 traffic\u3002\n\n\t\u590d\u6742\u5ea6 Qlog(n)\n\n- \u5bf9\u4e8e100%\u7684\u505a\u6cd5\uff1a\u7531\u4e8e\u8fd9\u662f\u4e00\u4e2a\u77e9\u5f62\uff0c\u6839\u636e\u5957\u8def\uff0c\u8003\u8651\u5206\u6cbb\u3002\u5047\u8bbe\u5206\u6cbb\u5230\u5f53\u524d\u77e9\u5f62(u,d,l,r)\uff0c\u5e76\u4e14\u6709\u4e00\u4e9b\u8be2\u95ee\uff0c\u6ee1\u8db3\u8fd9\u4e9b\u8be2\u95ee\u7684\u6700\u77ed\u8def\u5f84\u90fd\u4e0d\u4f1a\u8d85\u51fa\u5f53\u524d\u77e9\u5f62\u7684\u8303\u56f4\u3002\u6211\u4eec\u6309\u77ed\u8fb9\u5c06\u8fd9\u4e2a\u77e9\u5f62\u5206\u6210\u4e24\u90e8\u5206\uff08\u5373\u5c3d\u91cf\u65b9\u6b63\uff09\u3002\u5728\u8fd9\u4e9b\u8be2\u95ee\u4e2d\uff0c\u8981\u4e48\u7b54\u6848\u662f\u7ecf\u8fc7\u8fd9\u6761\u5206\u754c\u7ebf\u7684\uff0c\u8981\u4e48\u4e0d\u662f\u3002\u5f88\u663e\u7136\uff0c\u5982\u679c\u8be2\u95ee\u7684\u4e24\u4e2a\u70b9\u5728\u5206\u754c\u7ebf\u4e24\u4fa7\uff0c\u90a3\u4e00\u5b9a\u5c5e\u4e8e\u524d\u8005\u3002\u6211\u4eec\u5bf9\u4e8e\u5206\u754c\u7ebf\u4e0a\u7684\u6bcf\u4e00\u4e2a\u70b9\uff0c\u4ee5\u8be5\u70b9\u4e3a\u8d77\u70b9\u90fd\u505a\u4e00\u904d\u5173\u4e8e\u5f53\u524d\u77e9\u5f62\u4e2d\u7684\u70b9\u7684\u6700\u77ed\u8def\uff0c\u4ee5\u5b83\u5230\u4e24\u70b9\u7684\u8ddd\u79bb\u548c\u66f4\u65b0\u6bcf\u4e00\u4e2a\u8be2\u95ee\u7684\u7b54\u6848\u3002\u5bf9\u4e8e\u4e24\u4e2a\u70b9\u90fd\u5728\u5206\u754c\u7ebf\u7684\u540c\u4e00\u4fa7\u7684\u8be2\u95ee\uff0c\u7b54\u6848\u7684\u8def\u5f84\u53ef\u80fd\u4e0d\u4e00\u5b9a\u7ecf\u8fc7\u5206\u754c\u7ebf\uff0c\u90a3\u4e48\u5c31\u5206\u6cbb\u4e0b\u53bb\u3002\n\n\t\u7531\u4e8e\u6bcf\u4e00\u4e2a\u8be2\u95ee\u6700\u591a\u5b58\u5728\u4e8elog(nm)\u4e2a\u77e9\u5f62\u4e2d\u6240\u4ee5\u5173\u4e8e\u8be2\u95ee\u7684\u590d\u6742\u5ea6\u662fQlog(nm)\u7684\uff0c\u5206\u6cbb\u6700\u591alog(nm)\u5c42\uff0c\u6bcf\u5c42nmlog(nm),\u6240\u4ee5\u6700\u7ec8\u590d\u6742\u5ea6\u662f Qlog(nm)+nmlog2(nm)",
        "postTime": 1520135417,
        "uid": 20360,
        "name": "zj\u4f59\u80fd",
        "ccfLevel": 9,
        "title": "\u3010ZJOI 2016\u3011\u65c5\u884c\u8005"
    },
    {
        "content": "[\u8fd9\u9898\u6b63\u5e38\u7684\u9898\u9762\u8bf7\u770b\u8fd9\u91cc](https://www.luogu.com.cn/problem/U115970)  \n[\u535a\u5ba2\u98df\u7528\u6548\u679c\u66f4\u4f73](https://www.cnblogs.com/HN-wrp/p/12835841.html)  \n~~\u7531\u5927\u4f6c\u4e4b\u8a00\u53ef\u77e5\uff0c\u770b\u89c1\u7f51\u683c\u56fe\u60f3\u5206\u6cbb~~\u3000\u3000\n\u6240\u4ee5\u8fd9\u9898\u8003\u8651\u5206\u6cbb\u3002\u3000\u3000\n\u8003\u8651\u628a\u68cb\u76d8\u5206\u6210\u4e24\u534a\uff0c\u90a3\u6240\u6709\u70b9\u5c31\u4f1a\u6709\u4e24\u79cd\u60c5\u51b5\uff1a\n+ \u5728\u5b8c\u6574\u7684\u4e00\u534a\u4ee5\u5185\n+ \u8de8\u8d8a\u4e24\u534a\n  \n\u8003\u8651\u5728\u6211\u4eec\u5206\u6210\u4e24\u534a\u7684\u90a3\u6761\u4e2d\u7ebf\u7684\u6240\u6709\u70b9\u8dd1\u6700\u77ed\u8def\u6765\u66f4\u65b0\u6240\u6709\u70b9\u7684\u7b54\u6848\u3002\u7136\u540e\u5bf9\u4e8e\u8de8\u8d8a\u4e86\u4e24\u534a\u7684\u70b9\u5c31\u76f4\u63a5\u4fdd\u5b58\u7b54\u6848\uff0c\u5728\u540c\u4e00\u5757\u7684\u70b9\u5c31\u7c7b\u4f3c\u6574\u4f53\u4e8c\u5206\u7684\u505a\u6cd5\uff0c\u5206\u6210\u4e24\u4e2a\u90e8\u5206\u9012\u5f52\u4e0b\u53bb\u505a\u3002\u3000\u663e\u7136\u6211\u4eec\u5e0c\u671b\u8fd9\u4e2a\u8dd1\u6700\u77ed\u8def\u7684\u6b21\u6570\u5c11\u4e00\u70b9\uff0c\u6240\u4ee5\u5c31\u6bcf\u6b21\u9009\u957f\u5ea6\u5927\u7684\u90a3\u4e00\u6761\u8fb9\u5207\u5f00\u3002\u3000\n\u90a3\u4e48\u590d\u6742\u5ea6\u662f\u591a\u5c11\u5462\uff1f\u3000\u3000\n~~\u6211\u4e0d\u77e5\u9053~~\n\u53cd\u6b63\u6bcf\u6b21\u6700\u957f\u7684\u8fb9\u9664\u4ee5\u4e86$2$\u3002\u5047\u8bbe\u4e00\u5f00\u59cb$n=m=\\sqrt{N}$,\u90a3\u7b2c\u4e00\u6b21\u5c31\u8981\u8dd1$\\sqrt{N}*dijskra(N)$\u6b21\u3002\u7136\u540e\u6709  \n$T(N)=2T(N/2)+\\sqrt{N}*dijskra(N)=2T(N/2)+\\sqrt{N}*Nlog_2N$\u3002  \n~~\u6211\u4eec\u4ee3\u51e0\u4e2a\u6570\u7b97\u4e00\u4e0b~~  \n\u90a3\u4e48\u7b97\u51fa\u6765\u600e\u4e48\u6837\u5462\uff1f\n$T(100)=15057$\n$T(1000)=816853$\n$T(20000)=114708913$\n\u663e\u7136\u5f53\u8fd9\u6bd4\u8f83\u5927\u7684\u65f6\u5019\u6211\u4eec\u5e76\u4e0d\u80fd\u8dd1\u8fc7\u53bb\u3002\u4f46\u662f\u4e00\u4e9b\u95ee\u9898\u8ba9\u6211\u4eec\u53c8\u53ef\u4ee5\u6210\u529f\u8dd1\u8fc7\u53bb\u3002\n+ \u8be2\u95ee\u5206\u5e03\u4e0d\u5747\u5300\u4ee5\u81f3\u4e8e\u6211\u4eec\u5f88\u591a\u70b9\u4e0d\u7528\u8dd1\u3002\n+ \u5982\u679c\u4e0d\u4f7f\u7528$dijskra$\u7684\u8bdd\u4f7f\u7528$spfa$,\u867d\u7136\u8fd9\u662f\u7f51\u683c\u56fe\uff0c\u4f46\u662f\u7531\u4e8e\u6bcf\u6b21\u6700\u77ed\u8def\u662f\u5728\u4e00\u6761\u7ebf\u4e0a\u4f9d\u6b21\u8fdb\u884c\u7684\uff0c\u53ef\u4ee5\u4f9d\u9760\u4e0a\u4e00\u6b21$spfa$\u7684\u7ed3\u679c\u8d4b\u4e00\u4e2a\u6bd4\u8f83\u597d\u7684\u521d\u59cb\u89e3\u3002~~\u7136\u540e\u8dd1\u5f97\u98de\u5feb\uff1f~~\n+ $spfa$\u7684$SLF$\u4f18\u5316\u3002\n+ \u624b\u5199\u53cc\u7aef\u961f\u5217\n  \n\u90a3\u4e48\u5982\u679c\u628a$spfa$\u7684\u590d\u6742\u5ea6\u770b\u6210$n^2/20$\u7684\u8bdd\uff0c$T(20000)=40001872$ ,$2s$\u663e\u7136\u53ef\u4ee5\u8dd1\u8fc7\u53bb\u3002\u3000\u3000\n\u6240\u4ee5\u8fd9\u9898\u5c31\u4e71\u641e\u8fc7\u53bb\u4e86.....  \n~~\u5b9e\u5728\u4e0d\u884c\u53ef\u4ee5\u5361\u5e38~~\n~~\u81ea\u8ba4\u4e3a\u5b9e\u73b0\u8fd8\u6bd4\u8f83\u4f18\u7f8e~~\n```cpp\n#include <cstdio>\n#include <cstring>\nusing namespace std;\n\n#define R register\nconst int MAXN=1e5+10;\nconst int inf=0x3f3f3f3f;\n\ninline int read() {\n\tint x=0,f=1; char a=getchar();\n\tfor(;a>'9'||a<'0';a=getchar()) if(a=='-') f=-1;\n\tfor(;a>='0'&&a<='9';a=getchar()) x=x*10+a-'0';\n\treturn x*f;\n}\n\ninline int max(int x,int y) { return x > y ? x : y; }\ninline int min(int x,int y) { return x < y ? x : y; }\n\ntemplate<typename T>\nclass deque {\n\tprivate:\n\t\tT que[MAXN*100]; int l,r;\n\tpublic:\n\t\tdeque() { l=1,r=0; }\n\t\tinline void push_back(int x) { que[++r]=x; }\n\t\tinline void push_front(int x) { que[--l]=x; }\n\t\tinline void pop_back() { r--; }\n\t\tinline void pop_front() { l++;; }\n\t\tinline int front() { return que[l]; }\n\t\tinline int back() { return que[r]; }\n\t\tinline int size() { return r-l+1; }\n\t\tinline void clear() { l=MAXN*50,r=l-1; }\n};\n\nint n,m,qn;\nint cnt,head[MAXN];\nstruct Edge { int to,w,next; } e[MAXN<<1];\nint Ans[MAXN];\nstruct Ques { int x1,y1,x2,y2,id; } que[MAXN],tmp[MAXN];\n\n#define id(x,y) ((x-1)*m+y)\ninline void add(int x,int y,int z) { e[++cnt]= { y, z, head[x] }; head[x]=cnt; }\n\ndeque<int> q;\nint vis[MAXN],dis[MAXN];\n\ninline void Init();\ninline void Spfa(int u,int up,int dwn,int lft,int rht,int ok);\ninline void Div1(int st,int ed,int up,int dwn,int lft,int rht);\ninline void Div2(int st,int ed,int up,int dwn,int lft,int rht);\ninline void Solve(int st,int ed,int up,int dwn,int lft,int rht);\n\nint main() {\n\t//freopen(\"a.in\",\"r\",stdin);\n\t//freopen(\"a.out\",\"w\",stdout);\n\tInit();\n\tSolve(1,qn,1,n,1,m);\n\tfor(R int i=1;i<=qn;i++) printf(\"%d\\n\",Ans[i]);\n\treturn 0;\n}\n\ninline void Init() {\n\tn=read(); m=read(); \n\tfor(R int i=1;i<=n;i++) \n\t\tfor(R int j=1;j<=m-1;j++) {\n\t\t\tint w=read();\n\t\t\tadd(id(i,j),id(i,j+1),w);\n\t\t\tadd(id(i,j+1),id(i,j),w);\n\t\t}\n\tfor(R int i=1;i<=n-1;i++)\n\t\tfor(R int j=1;j<=m;j++) {\n\t\t\tint w=read();\n\t\t\tadd(id(i,j),id(i+1,j),w);\n\t\t\tadd(id(i+1,j),id(i,j),w);\n\t\t}\n\tqn=read();\n\tfor(R int i=1;i<=qn;i++) {\n\t\tque[i].x1=read();\n\t\tque[i].y1=read();\n\t\tque[i].x2=read();\n\t\tque[i].y2=read();\n\t\tque[i].id=i;\n\t}\n\tmemset(Ans,inf,sizeof(Ans));\n}\n\ninline void Spfa(int u,int up,int dwn,int lft,int rht,int ok) {\n\tR int delta=dis[u];\n\tfor(R int i=up;i<=dwn;i++) \n\t\tfor(R int j=lft;j<=rht;j++)\n\t\t\tdis[id(i,j)]=ok?dis[id(i,j)]+delta:inf;\n\tdis[u]=0;\n\tq.clear(); q.push_back(u);\n\twhile(q.size()) {\n\t\tint x=q.front(); q.pop_front();\n\t\tvis[x]=0;\n\t\tfor(R int i=head[x];i;i=e[i].next) {\n\t\t\tint y=e[i].to;\n\t\t\tif(dis[y]>dis[x]+e[i].w) {\n\t\t\t\tdis[y]=dis[x]+e[i].w;\n\t\t\t\tif(!vis[y]) {\n\t\t\t\t\tif(!q.size()) q.push_back(y);\n\t\t\t\t\telse {\n\t\t\t\t\t\tif(dis[q.front()]>dis[y]) q.push_front(y);\n\t\t\t\t\t\telse q.push_back(y);\n\t\t\t\t\t}\n\t\t\t\t\tvis[y]=1;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\ninline void Solve(int st,int ed,int up,int dwn,int lft,int rht) {\n\tif(st>ed) return ;\n\tif(up>dwn||lft>rht) return ;\n\tif(up==dwn&&lft==rht) {\n\t\tfor(R int i=st;i<=ed;i++)\n\t\t\tAns[que[i].id]=0;\n\t\treturn ;\n\t}\n\tint len1=dwn-up+1,len2=rht-lft+1;\n\tif(len1>=len2) Div1(st,ed,up,dwn,lft,rht);\n\telse Div2(st,ed,up,dwn,lft,rht);\n}\n\ninline void Div1(int st,int ed,int up,int dwn,int lft,int rht) {\n\tint mid=(up+dwn)/2;\n\tfor(R int i=lft;i<=rht;i++) {\n\t\tSpfa(id(mid,i),up,dwn,lft,rht,i!=lft);\n\t\tfor(R int j=st;j<=ed;j++) {\n\t\t\tint fr=id(que[j].x1,que[j].y1);\n\t\t\tint to=id(que[j].x2,que[j].y2);\n\t\t\tint loc=que[j].id;\n\t\t\tAns[loc]=min(Ans[loc],dis[fr]+dis[to]);\n\t\t}\n\t}\n\tR int l=st,r=ed;\n\tfor(R int i=st;i<=ed;i++) {\n\t\tif(que[i].x1<mid&&que[i].x2<mid)\n\t\t\ttmp[l++]=que[i];\n\t\tif(que[i].x1>mid&&que[i].x2>mid)\n\t\t\ttmp[r--]=que[i];\n\t}\n\tl--; r++;\n\tfor(R int i=st;i<=l;i++) que[i]=tmp[i];\n\tfor(R int i=r;i<=ed;i++) que[i]=tmp[i];\n\tSolve(st,l,up,mid-1,lft,rht);\n\tSolve(r,ed,mid+1,dwn,lft,rht);\n}\n\ninline void Div2(int st,int ed,int up,int dwn,int lft,int rht) {\n\tint mid=(lft+rht)/2;\n\tfor(R int i=up;i<=dwn;i++) {\n\t\tSpfa(id(i,mid),up,dwn,lft,rht,i!=up);\n\t\tfor(R int j=st;j<=ed;j++) {\n\t\t\tint fr=id(que[j].x1,que[j].y1);\n\t\t\tint to=id(que[j].x2,que[j].y2);\n\t\t\tint loc=que[j].id;\n\t\t\tAns[loc]=min(Ans[loc],dis[fr]+dis[to]);\n\t\t}\n\t}\n\tR int l=st,r=ed;\n\tfor(R int i=st;i<=ed;i++) {\n\t\tif(que[i].y1<mid&&que[i].y2<mid)\n\t\t\ttmp[l++]=que[i];\n\t\tif(que[i].y1>mid&&que[i].y2>mid)\n\t\t\ttmp[r--]=que[i];\n\t}\n\tl--; r++;\n\tfor(R int i=st;i<=l;i++) que[i]=tmp[i];\n\tfor(R int i=r;i<=ed;i++) que[i]=tmp[i];\n\tSolve(st,l,up,dwn,lft,mid-1);\n\tSolve(r,ed,up,dwn,mid+1,rht);\n}\n```",
        "postTime": 1588743238,
        "uid": 139012,
        "name": "______OvO______",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P3350 \u3010[ZJOI2016]\u65c5\u884c\u8005\u3011"
    },
    {
        "content": "[\u6d1b\u8c37\u9898\u9762\u4f20\u9001\u95e8](https://www.luogu.com.cn/problem/P3350)\n\n\u80bf\u4e48\u6ca1\u6709\u4eba\u8bc1\u660e\u590d\u6742\u5ea6\uff0c\u90a3\u6211\u6765\u8bc1\u4e00\u4e2a\u3002\n\n\u8003\u8651\u5206\u6cbb\uff0c\u6bcf\u6b21\u50cf\u732b\u6811\u90a3\u6837\u5904\u7406\u4e00\u4e2a\u5206\u6cbb\u533a\u95f4 $[l_x,r_x],[l_y,r_y]$ \u8868\u793a\u5f53\u524d\u5904\u7406 $x_1,x_2\\in[l_x,r_x]$\uff0c$y_1,y_2\\in[l_y,r_y]$ \u8303\u56f4\u5185\u7684\u6240\u6709\u8be2\u95ee\u3002\u5904\u7406\u5f53\u524d\u5c42\u7684\u8be2\u95ee\u662f\u597d\u529e\u7684\uff0c\u8003\u8651\u4ee4 $mid=\\lfloor\\dfrac{l_x+r_x}{2}\\rfloor$\uff0c\u90a3\u4e48\u6211\u4eec\u5bf9\u4e8e $y\\in[l_y,r_y]$\uff0c\u6211\u4eec\u4e00\u904d dijkstra \u6c42\u51fa $(mid,y)$ \u5230\u6240\u6709 $(X,Y)$ \u7684\u6700\u77ed\u8ddd\u79bb\uff08$X\\in[l_x,r_x],Y\\in[l_y,r_y]$\uff09\uff0c\u7136\u540e\u5bf9\u4e8e\u6240\u6709\u8be2\u95ee $(x_1,y_1,x_2,y_2)$ \u6211\u4eec\u7528 $dis_{x_1,y_1}+dis_{x_2,y_2}$ \u66f4\u65b0\u7b54\u6848\u3002\u7136\u540e\u9012\u5f52\u5904\u7406\u5269\u4f59\u8be2\u95ee\u2014\u2014\u8de8\u4e2d\u7ebf\u7684\u8be2\u95ee\u5c31\u6254\u4e86\u4e0d\u7ba1\u4e86\uff0c\u5168\u5728\u5de6\u90e8\u7684\u8be2\u95ee\u5c31\u6254\u5230\u5de6\u8fb9\uff0c\u5168\u5728\u53f3\u90e8\u7684\u8be2\u95ee\u5c31\u6254\u5230\u53f3\u8fb9\u4f9d\u6b21\u9012\u5f52\u3002\n\n\u5982\u679c\u6bcf\u6b21\u90fd\u5288 $[l_x,r_x]$ \u7684\u8bdd\u590d\u6742\u5ea6\u663e\u7136\u662f\u9519\u8bef\u7684\uff0c\u8003\u8651\u4e00\u4e2a\u6d45\u663e\u7684\u4f18\u5316\uff1a\u6bcf\u6b21\u50cf KDT \u90a3\u6837\u53d6\u533a\u95f4\u957f\u5ea6\u8f83\u5927\u7684\u90a3\u4e00\u7ef4\u5288\u5f00\u3002\u5982\u679c\u4f60\u5c1d\u8bd5\u5b9e\u73b0\u8fd9\u6837\u7684\u66b4\u529b\u4f60\u4f1a\u53d1\u73b0\u4f60\u83b7\u5f97\u4e86 100 \u5206\u7684\u597d\u6210\u7ee9\u3002\u8fd9\u662f\u4e3a\u4ec0\u4e48\u5462\uff1f\u9996\u5148\u6b63\u786e\u6027\u663e\u7136\uff0c\u8de8\u4e2d\u7ebf\u7684\u8be2\u95ee\u663e\u7136\u5fc5\u987b\u7ecf\u8fc7\u67d0\u4e2a $(mid,y)$\uff0c\u56e0\u6b64\u6b64\u8f6e\u66f4\u65b0\u5df2\u7ecf\u5305\u542b\u4e86\u6240\u6709\u7684\u60c5\u51b5\uff0c\u4e0d\u7528\u8fdb\u4e00\u6b65\u9012\u5f52\u3002\u800c\u5168\u5728\u5de6\u90e8\u7684\u8be2\u95ee\uff0c\u6211\u4eec\u5df2\u7ecf\u6c42\u51fa\u4e86\u5b83\u5230\u4e2d\u95f4\u67d0\u4e2a\u70b9\u7136\u540e\u6298\u8fd4\u7684\u6700\u5c0f\u4ee3\u4ef7\uff0c\u6b64\u65f6\u5982\u679c\u5b83\u7ed5\u5230\u53f3\u90e8\uff0c\u90a3\u4e48\u5b83\u5fc5\u7136\u7ecf\u8fc7\u4e2d\u7ebf\uff0c\u8fd9\u79cd\u60c5\u51b5\u6211\u4eec\u4e5f\u5df2\u7ecf\u8ba1\u7b97\u8fc7\u4e86\uff0c\u6545\u8be5\u7b97\u6cd5\u7684\u6b63\u786e\u6027\u662f\u6ca1\u6709\u95ee\u9898\u7684\u3002\n\n\u63a5\u4e0b\u6765\u8003\u8651\u590d\u6742\u5ea6\uff0c\u6ce8\u610f\u5230\u4e00\u8f6e\u66f4\u65b0\u7684\u590d\u6742\u5ea6\u662f $nm\\min(n,m)\\log nm+\\min(n,m)\u00b7Q$\uff0c\u7531\u4e8e\u8fd9\u4e2a $\\min$ \u7684\u5b58\u5728\uff0c\u4f7f\u590d\u6742\u5ea6\u8fbe\u5230\u6700\u5927\u503c\u7684\u56fe\u5f62\u5f62\u72b6\u80af\u5b9a\u5f62\u5982\u4e00\u4e2a\u6b63\u65b9\u5f62\uff08\u6216\u8005\u4e00\u4e2a\u957f\u5bbd\u6bd4\u4e3a $1:\\sqrt{2}$ \u7684\u77e9\u5f62\u61d2\u5f97\u7ba1\u4e86\uff0c\u603b\u4e4b\u5927\u6982\u5c31\u8fd9\u4e2a\u91cf\u7ea7\u7684\uff0c\u4e0d\u4f1a\u957f\u5bbd\u76f8\u5dee\u8fc7\u4e8e\u60ac\u6b8a\uff0c\u4e0b\u9762\u5206\u6790\u5c31\u4ee5\u6b63\u65b9\u5f62\u6765\u63a8\uff09\uff0c\u800c\u540e\u9762\u7684 $\\min(n,m)\u00b7Q$ \u53ea\u4e0e\u8be2\u95ee\u9012\u5f52\u7684\u6df1\u5ea6\u6709\u5173\uff0c\u56e0\u6b64\u6700\u52a3\u60c5\u51b5\u80af\u5b9a\u662f\u8be2\u95ee\u9012\u5f52\u5230\u5e95\uff0c\u4e0b\u9762\u5c31\u7528\u8fd9\u79cd\u60c5\u51b5\u6765\u5206\u6790\u590d\u6742\u5ea6\u3002\n\n\u8bbe $T(n,Q)$ \u8868\u793a\u8fb9\u957f\u4e3a $n$ \u7684\u6b63\u65b9\u5f62\u6709 $Q$ \u4e2a\u8be2\u95ee\u7684\u590d\u6742\u5ea6\uff0c$T(n,m,Q)$ \u8868\u793a $n\\times m$ \u7684\u77e9\u5f62\u6709 $Q$ \u4e2a\u8be2\u95ee\u7684\u590d\u6742\u5ea6\uff0c\u90a3\u4e48\u6709\n$$\nT(n,Q)=n^3\\log(n^2)+nq+T(\\dfrac{n}{2},n,Q)\n$$\n\n$$\nT(n,Q)=n^3\\log(n^2)+nq+((\\dfrac{n}{2})^2\u00b7n\u00b7\\log(n^2)+\\dfrac{n}{2}\u00b7Q)\\times 2+4T(\\dfrac{n}{2},\\dfrac{Q}{4})\n$$\n\n$$\nT(n,Q)=\\dfrac{3}{2}n^3\\log(n^2)+2nQ+4T(\\dfrac{n}{2},\\dfrac{Q}{4})\n$$\n\n$$\nT(n,Q)=\\sum\\limits_{i=0}^{\\log(n^2)}\\dfrac{3}{2}\u00b7(\\dfrac{n}{2^i})^3\u00b74^i\\log(n^2)+2\u00b7\\dfrac{n}{2^i}\u00b7\\dfrac{Q}{4^i}\u00b74^i\n$$\n\n$$\nT(n,Q)=\\sum\\limits_{i=0}^{\\log(n^2)}\\dfrac{3}{2}\u00b7\\dfrac{n^3}{2^i}\u00b7\\log(n^2)+2\u00b7\\dfrac{n}{2^i}\u00b7Q\n$$\n\n\u663e\u7136 $T(n,Q)=n^3\\log(n^2)+nQ=A\\sqrt{A}\\log A+\\sqrt{A}\u00b7Q$\u3002\n\n\u5176\u4e2d $A=\\max\\{nm\\}$\u3002\n\n```cpp\nconst int MAXV = 2e4;\nconst int MAXQ = 1e5;\nconst int INF = 0x3f3f3f3f;\nint n, m, qu, res[MAXQ + 5]; pii rid[MAXV + 5];\nstruct qry {int x1, y1, x2, y2;} q[MAXQ + 5];\nint hd[MAXV + 5], to[MAXV * 4 + 5], nxt[MAXV * 4 + 5], val[MAXV * 4 + 5], ec = 0;\nint getid(int x, int y) {return (x - 1) * m + y;}\nvoid adde(int u, int v, int w) {to[++ec] = v; val[ec] = w; nxt[ec] = hd[u]; hd[u] = ec;}\nint dis[MAXV + 5];\nvoid dijkstra(int l1, int r1, int l2, int r2, int X, int Y) {\n\tif (dis[getid(X, Y)] != INF) {\n\t\tfor (int i = l1; i <= r1; i++) for (int j = l2; j <= r2; j++)\n\t\t\tif (i != X || j != Y) dis[getid(i, j)] += dis[getid(X, Y)];\n\t}\n\tdis[getid(X, Y)] = 0;\n\tpriority_queue<pii, vector<pii>, greater<pii> > q;\n\tq.push(mp(0, getid(X, Y)));\n\twhile (!q.empty()) {\n\t\tpii p = q.top(); q.pop(); int x = p.se;\n\t\tfor (int e = hd[x]; e; e = nxt[e]) {\n\t\t\tint y = to[e], z = val[e];\n\t\t\tif (l1 <= rid[y].fi && rid[y].fi <= r1 && l2 <= rid[y].se && rid[y].se <= r2) {\n\t\t\t\tif (dis[y] > dis[x] + z) dis[y] = dis[x] + z, q.push(mp(dis[y], y));\n\t\t\t}\n\t\t}\n\t}\n}\nvoid solve(int l1, int r1, int l2, int r2, vector<int> cd) {\n\tif (l1 == r1 && l2 == r2) {\n\t\tfor (int id : cd) res[id] = 0;\n\t\treturn; \n\t}\n\tif (r1 - l1 + 1 > r2 - l2 + 1) {\n\t\tint mid = l1 + r1 >> 1;\n\t\tfor (int i = l1; i <= r1; i++) for (int j = l2; j <= r2; j++) dis[getid(i, j)] = INF;\n\t\tfor (int i = l2; i <= r2; i++) {\n\t\t\tdijkstra(l1, r1, l2, r2, mid, i);\n\t\t\tfor (int id : cd) chkmin(res[id], dis[getid(q[id].x1, q[id].y1)] + dis[getid(q[id].x2, q[id].y2)]);\n\t\t}\n\t\tvector<int> L, R;\n\t\tfor (int id : cd) {\n\t\t\tif (max(q[id].x1, q[id].x2) <= mid) L.pb(id);\n\t\t\tif (min(q[id].x1, q[id].x2) > mid) R.pb(id);\n\t\t}\n\t\tsolve(l1, mid, l2, r2, L); solve(mid + 1, r1, l2, r2, R);\n\t} else {\n\t\tint mid = l2 + r2 >> 1;\n\t\tfor (int i = l1; i <= r1; i++) for (int j = l2; j <= r2; j++) dis[getid(i, j)] = INF;\n\t\tfor (int i = l1; i <= r1; i++) {\n\t\t\tdijkstra(l1, r1, l2, r2, i, mid);\n\t\t\tfor (int id : cd) chkmin(res[id], dis[getid(q[id].x1, q[id].y1)] + dis[getid(q[id].x2, q[id].y2)]);\n\t\t}\n\t\tvector<int> L, R;\n\t\tfor (int id : cd) {\n\t\t\tif (max(q[id].y1, q[id].y2) <= mid) L.pb(id);\n\t\t\tif (min(q[id].y1, q[id].y2) > mid) R.pb(id);\n\t\t}\n\t\tsolve(l1, r1, l2, mid, L); solve(l1, r1, mid + 1, r2, R);\n\t}\n}\nint main() {\n\tscanf(\"%d%d\", &n, &m);\n\tfor (int i = 1; i <= n; i++) for (int j = 1; j <= m; j++)\n\t\trid[getid(i, j)] = mp(i, j);\n\tfor (int i = 1; i <= n; i++) for (int j = 1; j < m; j++) {\n\t\tint x; scanf(\"%d\", &x);\n\t\tadde(getid(i, j), getid(i, j + 1), x);\n\t\tadde(getid(i, j + 1), getid(i, j), x);\n\t}\n\tfor (int i = 1; i < n; i++) for (int j = 1; j <= m; j++) {\n\t\tint x; scanf(\"%d\", &x);\n\t\tadde(getid(i, j), getid(i + 1, j), x);\n\t\tadde(getid(i + 1, j), getid(i, j), x);\n\t}\n\tscanf(\"%d\", &qu); memset(res, 63, sizeof(res));\n\tfor (int i = 1; i <= qu; i++) scanf(\"%d%d%d%d\", &q[i].x1, &q[i].y1, &q[i].x2, &q[i].y2);\n\tvector<int> all; for (int i = 1; i <= qu; i++) all.pb(i);\n\tsolve(1, n, 1, m, all);\n\tfor (int i = 1; i <= qu; i++) printf(\"%d\\n\", res[i]);\n\treturn 0;\n}\n```\n\n",
        "postTime": 1657175506,
        "uid": 115194,
        "name": "lTgMFePRoeZ",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3350 [ZJOI2016]\u65c5\u884c\u8005"
    },
    {
        "content": "\u7384\u5b66\u526a\u679d KD-tree \u5f0f\u590d\u6742\u5ea6\u6ca1\u770b\u61c2\uff0c\u4f46\u662f\u8fd9\u9898\u5176\u5b9e\u6709\u4e2a\u590d\u6742\u5ea6\u6b63\u5e38\u7684\u7ecf\u5178\u5206\u6cbb\u505a\u6cd5\u3002\n\n\u9996\u5148\u6709\u4e2a\u5927\u6982\u7684\u601d\u8def\uff0c\u5982\u679c\u957f\u5c0f\u4e8e\u5bbd\u5c31\u65cb\u8f6c\u4e00\u4e0b\u8fd9\u4e2a\u56fe\uff0c\u7136\u540e\u5e73\u9762\u56fe\u5206\u6cbb\u8dd1\u6700\u77ed\u8def\u3002\n\n\u7136\u800c\u4ed4\u7ec6\u4e00\u60f3\u53d1\u73b0\u4e0d\u884c\uff0c\u5982\u679c\u4e00\u4e2a\u8be2\u95ee\u53ea\u5728\u8de8\u8d8a\u4e86\u7684\u90a3\u4e00\u5c42\u5904\u7406\uff0c\u4e3a\u4e86\u627e\u6700\u77ed\u8def\u5176\u5b9e\u662f\u9700\u8981\u8003\u8651\u5206\u6cbb\u8303\u56f4\u5916\u7684\u70b9\u7684\uff0c\u7136\u540e\u590d\u6742\u5ea6\u5c31\u70b8\u4e86\u3002\n\n\u4f46\u662f\u6709\u4e2a\u89c2\u5bdf\uff1a\u5bf9\u4e8e\u4e00\u4e2a\u8be2\u95ee\uff0c\u603b\u662f\u5b58\u5728\u4e00\u5c42\u5206\u6cbb\uff0c\u6ee1\u8db3\u5206\u6cbb\u4e2d\u5fc3\u7a7f\u8fc7\u6700\u77ed\u8def\u4e14\u5206\u6cbb\u8303\u56f4\u80fd\u5c06\u6574\u4e2a\u6700\u77ed\u8def\u5305\u62ec\u8fdb\u53bb\u3002\n\n\u8003\u8651\u53cd\u8bc1\u6cd5\u3002\u53d6\u5206\u6cbb\u8303\u56f4\u6700\u5c0f\u4f46\u662f\u53c8\u80fd\u591f\u5c06\u6574\u4e2a\u6700\u77ed\u8def\u5305\u62ec\u8fdb\u53bb\u7684\u5206\u6cbb\u5c42\uff0c\u5982\u679c\u4e2d\u7ebf\u4e0d\u7a7f\u8fc7\u6700\u77ed\u8def\uff0c\u67d0\u4e00\u4fa7\u7684\u5b50\u5206\u6cbb\u5c31\u4f1a\u53d8\u6210\u5206\u6cbb\u8303\u56f4\u6700\u5c0f\u7684\u4e14\u80fd\u5305\u62ec\u6574\u4e2a\u6700\u77ed\u8def\u7684\uff0c\u4e0e\u5b9a\u4e49\u77db\u76fe\u3002\n\n\u6240\u4ee5\u53ea\u8981\u5728\u539f\u672c\u7684\u9519\u8bef\u505a\u6cd5\u4e0a\u52a0\u4e00\u70b9\u5c0f\u5c0f\u7684\u6539\u52a8\uff1a\u6700\u77ed\u8def\u5728\u5206\u6cbb\u8303\u56f4\u5185\u6b63\u5e38\u8dd1\uff0c\u6bcf\u4e2a\u8be2\u95ee\u90fd\u5728\u6bcf\u4e00\u4e2a\u80fd\u5c06\u5176\u5305\u62ec\u8fdb\u53bb\u7684\u5206\u6cbb\u5c42\u67e5\u8be2\u4e00\u6b21\u5c31\u597d\u4e86\u3002\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\ntypedef long long ll;\nconst int INF=0x3f3f3f3f;\nconst int N=155,NM=2e4+5,Q=1e5+5;\n\ntemplate<class type> type read(type ret=0,int w=0,char ch=getchar()){\n    while(!isdigit(ch)) w=ch=='-',ch=getchar();\n    while(isdigit(ch)) ret=ret*10+ch-'0',ch=getchar();\n    return w?-ret:ret;\n}\ntemplate<class type> void write(type x){\n    if(x<0) return putchar('-'),write(-x);\n    if(x>9) write(x/10);\n    putchar('0'+x%10);\n}\ntemplate<class type> void write_n(type x){write(x),putchar('\\n');}\n\nint n,m,q,ans[Q],head[NM],cntedg=1;\nstruct query{struct{int x,y;}l,r;int id;};\nstruct edge{int to,nxt,w;}edg[NM<<3];\nstruct policy{\n    int u,w;\n    friend bool operator <(policy x,policy y){return x.w>y.w;}\n};\nvector<query> qry;\n\nvoid add(int u,int v,int w){edg[++cntedg]={v,head[u],w},head[u]=cntedg;}\n\ninline int id(int x,int y){return (x-1)*m+y;}\n\nvoid dijsktra(int l,int r,int st,int dis[]){\n    static bool vis[NM];static priority_queue<policy> q;\n    for(int i=1;i<=n;++i)\n\t    for(int j=l,k=id(i,j);j<=r;++j,++k) dis[k]=INF,vis[k]=0;\n    dis[st]=0,q.push({st,0});\n    while(!q.empty()){\n        int u=q.top().u;q.pop();\n        if(vis[u]==1) continue;vis[u]=1;\n        for(int i=head[u];i;i=edg[i].nxt){\n            int v=edg[i].to,w=edg[i].w;\n            if((v-1)%m+1>=l&&(v-1)%m+1<=r&&dis[v]>dis[u]+w) dis[v]=dis[u]+w,q.push({v,dis[v]});\n        }\n    }\n}\n\nvoid solve(int l,int r,vector<query> qry){\n    if(l>r) return;\n    int mid=(l+r)>>1;vector<query> lqry,rqry;\n    static int dis[N][NM];\n    for(int i=1;i<=n;++i) dijsktra(l,r,id(i,mid),dis[i]);\n    for(query i:qry)\n        for(int j=1;j<=n;++j)\n            ans[i.id]=min(ans[i.id],dis[j][id(i.l.x,i.l.y)]+dis[j][id(i.r.x,i.r.y)]);\n    for(query i:qry){\n        if(i.r.y<mid) lqry.push_back(i);\n        else if(i.l.y>mid) rqry.push_back(i);\n    }    \n    solve(l,mid-1,lqry),solve(mid+1,r,rqry);    \n}\n\nsigned main(){\n    n=read<int>(),m=read<int>();\n    if(n<=m){\n        for(int i=1;i<=n;++i)\n            for(int j=1,w;j<m;++j)\n                w=read<int>(),add(id(i,j),id(i,j+1),w),add(id(i,j+1),id(i,j),w);\n        for(int i=1;i<n;++i)\n            for(int j=1,w;j<=m;++j)\t    \n                w=read<int>(),add(id(i,j),id(i+1,j),w),add(id(i+1,j),id(i,j),w);\n        q=read<int>();\n        for(int i=1;i<=q;++i)\n            qry.push_back({{read<int>(),read<int>()},{read<int>(),read<int>()},i}),ans[i]=INF;\n        for(query &i:qry)\n            if(i.l.y>i.r.y) swap(i.l,i.r);\t\n    }\n    else{\n        swap(n,m);\n        for(int j=m;j;--j)\n            for(int i=1,w;i<n;++i)\n                w=read<int>(),add(id(i,j),id(i+1,j),w),add(id(i+1,j),id(i,j),w);\n        for(int j=m-1;j;--j)\n            for(int i=1,w;i<=n;++i)\n                w=read<int>(),add(id(i,j),id(i,j+1),w),add(id(i,j+1),id(i,j),w);\n        q=read<int>();\n        for(int i=1;i<=q;++i)\n            qry.push_back({{read<int>(),read<int>()},{read<int>(),read<int>()},i}),ans[i]=INF;\n        for(int tmp;query &i:qry){\n            tmp=i.l.x,i.l.x=i.l.y,i.l.y=m-tmp+1;\n            tmp=i.r.x,i.r.x=i.r.y,i.r.y=m-tmp+1;\n            if(i.l.y>i.r.y) swap(i.l,i.r);\n        }\n    }\n    solve(1,m,qry);\n    for(int i=1;i<=q;++i) write_n(ans[i]);\n    return 0;\n}\n\n//~kawaii~\n```",
        "postTime": 1653223000,
        "uid": 372708,
        "name": "Yahbim",
        "ccfLevel": 0,
        "title": "P3350 [ZJOI2016]\u65c5\u884c\u8005 \u9898\u89e3"
    },
    {
        "content": "\u5148\u628a\u8be2\u95ee\u79bb\u7ebf\u3002\n\n\u4e0eKDTree\u7c7b\u4f3c\uff0c\u6bcf\u6b21\u5c06\u77e9\u9635\u5212\u5206\u4e3a\u4e24\u4e2a\u90e8\u5206\uff0c\u5904\u7406\u5de6\u4e0a\u7aef\u70b9\u4e3a$(lx,ly)$\uff0c\u53f3\u4e0b\u7aef\u70b9\u4e3a$(rx,ry)$\u7684\u77e9\u5f62\u4e14\u8be2\u95ee\u7684\u70b9\u90fd\u5728\u8303\u56f4\u5185\u7684\u8be2\u95ee\u3002\u7136\u540e\u5c06\u77e9\u5f62\u4ece\u4e2d\u95f4\u5207\u5f00\uff0c\u5bf9\u4e8e\u5f53\u524d\u77e9\u5f62\u4e2d\u6240\u6709\u7684\u8be2\u95ee\u53ef\u4ee5\u5206\u4e3a\u4e24\u79cd\uff0c\u7ecf\u8fc7\u4e2d\u548c\u4e0d\u7ecf\u8fc7\u4e2d\u7ebf\u3002\n\n\u5bf9\u4e8e\u524d\u8005\uff0c\u6211\u4eec\u66b4\u529b\u8ba1\u7b97\u662f\u5426\u7ecf\u8fc7\u4e2d\u7ebf\u4e0a\u70b9\u7684\u7b54\u6848\u6bd4\u5f53\u524d\u7b54\u6848\u66f4\u4f18\u3002\u5bf9\u4e8e\u540e\u8005\u7ee7\u7eed\u9012\u5f52\u5206\u6cbb\u3002\n\n\u9700\u8981\u6ce8\u610f\u7684\u662f\u6bcf\u6b21\u5c06\u77e9\u9635\u8f83\u957f\u8fb9\u5207\u5f00\uff0c\u5426\u5219\u590d\u6742\u5ea6\u663e\u7136\u662f\u9519\u7684\u3002\n\n\u4ee5\u53ca\u7531\u4e8e\u662f\u7f51\u683c\u56fe\uff0c\u5b9e\u9645\u5e76\u4e0d\u7528\u771f\u7684\u5c06\u56fe\u5efa\u51fa\u6765\uff0c\u6bcf\u6b21\u4e0a\u4e0b\u5de6\u53f3\u8dd1\u5c31\u662f\u4e86(\n\n```cpp\nstruct ques\n{\n\tint sx,sy,tx,ty,id;\n}qs[M],qa[M],qb[M];\nint n,m,k,e[N][4];\nint ans[M],dis[N];\nstruct node\n{\n\tint val,pos;\n\tinline bool operator <(const node a)const{\n\t\treturn val>a.val;\n\t}\n};\npriority_queue<node>q;\n\ninline int gkd(int x,int y){\n\treturn (x-1)*m+y;\n}\nvoid dij(int sx,int sy,int tx,int ty,int s)\n{\n\tR(i,sx,tx) R(j,sy,ty) dis[gkd(i,j)]=inf;\n\tdis[s]=0;\n\tq.push((node){0,s});\n\twhile(q.size()>0)\n\t{\n\t\tnode qwq=q.top();q.pop();\n\t\tif(dis[qwq.pos]!=qwq.val) continue;\n\t\tint ux=(qwq.pos-1)/m+1,uy=(qwq.pos-1)\t%m+1;\n\t\tint vx=ux+1,vy=uy;\n\t\tif(sx<=vx&&vx<=tx&&sy<=vy&&vy<=ty)\n\t\t{\n\t\t\tif(dis[gkd(vx,vy)]>dis[gkd(ux,uy)]+e[gkd(ux,uy)][0]) \n\t\t\t\tdis[gkd(vx,vy)]=dis[gkd(ux,uy)]+e[gkd(ux,uy)][0],q.push((node){dis[gkd(vx,vy)],gkd(vx,vy)});\n\t\t}\n\t\tvx=ux-1,vy=uy;\n\t\tif(sx<=vx&&vx<=tx&&sy<=vy&&vy<=ty)\n\t\t{\n\t\t\tif(dis[gkd(vx,vy)]>dis[gkd(ux,uy)]+e[gkd(ux,uy)][1]) \n\t\t\t\tdis[gkd(vx,vy)]=dis[gkd(ux,uy)]+e[gkd(ux,uy)][1],q.push((node){dis[gkd(vx,vy)],gkd(vx,vy)});\n\t\t}\n\t\tvx=ux,vy=uy+1;\n\t\tif(sx<=vx&&vx<=tx&&sy<=vy&&vy<=ty)\n\t\t{\n\t\t\tif(dis[gkd(vx,vy)]>dis[gkd(ux,uy)]+e[gkd(ux,uy)][2]) \n\t\t\t\tdis[gkd(vx,vy)]=dis[gkd(ux,uy)]+e[gkd(ux,uy)][2],q.push((node){dis[gkd(vx,vy)],gkd(vx,vy)});\n\t\t}\n\t\tvx=ux,vy=uy-1;\n\t\tif(sx<=vx&&vx<=tx&&sy<=vy&&vy<=ty)\n\t\t{\n\t\t\tif(dis[gkd(vx,vy)]>dis[gkd(ux,uy)]+e[gkd(ux,uy)][3]) \n\t\t\t\tdis[gkd(vx,vy)]=dis[gkd(ux,uy)]+e[gkd(ux,uy)][3],q.push((node){dis[gkd(vx,vy)],gkd(vx,vy)});\n\t\t}\n\t}\n} \nvoid solve(int lx,int ly,int rx,int ry,int l,int r)\n{\n\tif(lx>rx||ly>ry||l>r) return ;\n\tif(l==r)\n\t{\n\t\tdij(lx,ly,rx,ry,gkd(qs[l].sx,qs[l].sy));\n\t\tans[qs[l].id]=min(ans[qs[l].id],dis[gkd(qs[l].tx,qs[l].ty)]);\n\t\treturn;\n\t}\n\tif(rx-lx<=ry-ly)\n\t{\n\t\tint mid=(ly+ry)>>1;\n\t\tR(i,lx,rx) {\n\t\t\tdij(lx,ly,rx,ry,gkd(i,mid));\n\t\t\tR(j,l,r) ans[qs[j].id]=min(ans[qs[j].id],dis[gkd(qs[j].sx,qs[j].sy)]+dis[gkd(qs[j].tx,qs[j].ty)]);\n\t\t}\n\t\tint tota=0,totb=0;\n\t\tR(i,l,r)\n\t\t{\n\t\t\tif(qs[i].sy<=mid&&qs[i].ty<=mid) qa[++tota]=qs[i];\n\t\t\tif(qs[i].sy>mid&&qs[i].ty>mid) qb[++totb]=qs[i];\n\t\t}\n\t\tR(i,1,tota) qs[i+l-1]=qa[i];\n\t\tR(i,1,totb) qs[r-i+1]=qb[i];\t\t\n\t\tif(ly==ry) return;\n\t\tsolve(lx,ly,rx,mid,l,l+tota-1),solve(lx,mid+1,rx,ry,r-totb+1,r);\t\t\n\t}\n\telse\n\t{\n\t\tint mid=(lx+rx)>>1;\n\t\tR(i,ly,ry) {\n\t\t\tdij(lx,ly,rx,ry,gkd(mid,i));\n\t\t\tR(j,l,r) ans[qs[j].id]=min(ans[qs[j].id],dis[gkd(qs[j].sx,qs[j].sy)]+dis[gkd(qs[j].tx,qs[j].ty)]);\n\t\t}\n\t\tint tota=0,totb=0;\n\t\tR(i,l,r) {\n\t\t\tif(qs[i].sx<=mid&&qs[i].tx<=mid) qa[++tota]=qs[i];\n\t\t\tif(qs[i].sx>mid&&qs[i].tx>mid) qb[++totb]=qs[i];\n\t\t}\n\t\tR(i,1,tota) qs[i+l-1]=qa[i];\n\t\tR(i,1,totb) qs[r-i+1]=qb[i];\n\t\tif(lx==rx) return;\t\t\n\t\tsolve(lx,ly,mid,ry,l,l+tota-1),solve(mid+1,ly,rx,ry,r-totb+1,r);\n\t}\n}\nsigned main()\n{\n\tn=read(),m=read();\n\tR(i,1,n) R(j,1,m-1) e[gkd(i,j)][2]=e[gkd(i,j+1)][3]=read();\n\tR(i,1,n-1) R(j,1,m) e[gkd(i,j)][0]=e[gkd(i+1,j)][1]=read();\n\tk=read();\n\tR(i,1,k)\n\t\tans[i]=inf,qs[i].sx=read(),qs[i].sy=read(),qs[i].tx=read(),qs[i].ty=read(),qs[i].id=i;\n\tsolve(1,1,n,m,1,k);\n\tR(i,1,k) printf(\"%d\\n\",ans[i]);\n}\n```\n",
        "postTime": 1611311407,
        "uid": 115779,
        "name": "\u6781\u5bd2\u795e\u51b0",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3350 \u3010[ZJOI2016]\u65c5\u884c\u8005\u3011"
    }
]