[
    {
        "content": "[\u9898\u76ee\u94fe\u63a5](https://www.luogu.com.cn/problem/P6043)\n\n> \u9898\u610f\uff1a  \n\u8bbe $\\displaystyle f(n,m)\\!=\\!\\sum_{i=0}^{m}\\sqrt{\\sum_{j=0}^{i}\\binom{i}{j}^2\\binom{n+2i-j}{2i}}\\dfrac{n!}{(n-i)!}\\dfrac{n!}{(n+i)!}$  \n$T$ \u6b21\u8be2\u95ee\uff0c\u6bcf\u6b21\u7ed9\u51fa $n,m$\uff0c\u6c42 $f(n,m)$\u3002  \n$T\\leq 100$\uff0c$n,m\\leq 9\\times 10^8$\u3002\n\n\u4e8b\u5b9e\u4e0a\u80fd\u591f\u53d1\u73b0 $\\displaystyle \\sum_{j=0}^{i}\\binom{i}{j}^2\\binom{n+2i-j}{2i}=\\binom{n+i}{i}^2$\u3002\n\n\u8bc1\u660e\u53ef\u4ee5\u901a\u8fc7 $\\text{Zeilberger}$ \u7b97\u6cd5\uff0c\u6709\u5174\u8da3\u7684\u53ef\u4ee5\u770b[\u8fd9\u91cc](https://www.luogu.com.cn/paste/0jgy8czj)\u3002\n\n\u6709\u8fd9\u4e2a\u5f0f\u5b50\u4e5f\u80fd\u63a8\u51fa\u4e00\u4e2a\u6709\u610f\u601d\u7684\u4e8b\u60c5\uff1a\n\n$$\\displaystyle \\sum_{n\\geq 0}\\binom{n+k}{k}^2x^n=\\dfrac{1}{(1-x)^{2k+1}}\\sum_{r}\\binom{k}{r}^2x^r$$\n\n\u56de\u5230\u672c\u9898\uff0c$\\displaystyle f(n,m)=\\sum_{i=0}^{m}\\binom{n+i}{i}\\dfrac{n!^2}{(n-i)!(n+i)!}=\\sum_{i=0}^{m}\\binom{n}{i}$\u3002\n\n\u90a3\u5269\u4e0b\u7684\u5c31\u662f[\u8fd9\u9898](https://loj.ac/p/6386)\u4e86\u3002\n\n\u4ee5\u4e0b\u601d\u8def\u53ef\u53c2\u89c1[\u8be5\u63d0\u793a](https://loj.ac/d/501)\uff0c\u5927\u4f53\u6cbf\u7528[\u5feb\u901f\u9636\u4e58\u7b97\u6cd5](https://www.cnblogs.com/zzqsblog/p/8408691.html)\u4ee5\u53ca[\u8c03\u548c\u7ea7\u6570\u6c42\u548c](https://www.luogu.com.cn/problem/P5702)\u3002\n\n$\\displaystyle \\sum_{k=0}^m\\binom{n}{k}=\\dfrac{1}{m!}\\sum_{k=0}^{m}\\left(\\prod_{j=i+1}^mj\\right)\\left(\\prod_{j=0}^{i-1}n\\!-\\!j\\right)$\u3002\n\n\u8bbe $\\displaystyle S_{d}(x)=\\sum_{i=0}^{d-1}\\left(\\prod_{j=i+1}^{d}j+x\\right)\\left(\\prod_{j=0}^{i-1}n\\!\\!-\\!j\\!-\\!x\\right)$\n\n\u518d\u8bbe $\\displaystyle P_d(x)=\\prod_{i=1}^di\\!+\\!x,Q_d(x)=\\prod_{j=0}^{d-1}n\\!-\\!j\\!-\\!x$\n\n\u4ee4 $v$ \u4e3a\u6ee1\u8db3 $v^2\\!+\\!v\\!\\leq\\!m$ \u7684\u6700\u5927\u6570\uff0c\u5219\u5e0c\u671b\u6c42\u51fa $S_{v}(0),S_v(1)\\cdots S_{v}(v^2)$\uff0c$P,Q$ \u540c\u7406\u3002\n\n\u90a3\u5bf9\u4e8e\u6c42\u7b54\u6848\u65f6\uff0c$d\\!=\\!v$\uff0c\u6709\n\n$$m!\\!\\sum_{k=x}^{x+d-1}\\binom{n}{k}=\\sum_{i=x}^{d+x-1}\\left(\\prod_{j=i+1}^{m}j\\right)\\left(\\prod_{j=0}^{i-1}n\\!-\\!j\\right)$$\n\n$$=\\sum_{i=0}^{d-1}\\left(\\prod_{j=i+x+1}^{m}j\\right)\\left(\\prod_{j=0}^{i+x-1}n\\!-\\!j\\right)$$\n\n$$=\\sum_{i=0}^{d-1}\\left(\\prod_{j=i+1}^{d}j\\!+\\!x\\prod_{j=d+1}^{m-x}j\\!+\\!x\\right)\\left(\\prod_{j=0}^{x-1}n\\!-\\!j\\prod_{j=0}^{i-1}n\\!-\\!j\\!-\\!x\\right)$$\n\n$$=S_{d}(x)\\left(\\prod_{j=d+x+1}^{m}j\\right)\\left(\\prod_{j=0}^{x-1}n-j\\right)$$\n\n\u800c\u5728\u6709 $P_{d}(x),Q_d(x)$ \u7684\u60c5\u51b5\u4e0b\uff0c$m!$ \u5bb9\u6613\u5f97\u5230\u3002\n\n\u800c\u540e\u4e24\u4e2a\u62ec\u53f7\u51e0\u4e4e\u5c31\u662f $P_{d}(x)$ \u7684\u540e\u7f00\u79ef\u4e0e $Q_{d}(x)$ \u7684\u524d\u7f00\u79ef\u3002\n\n\u73b0\u5728\u4e3b\u8981\u95ee\u9898\u662f\u5982\u4f55\u6c42 $S,P,Q$\uff0c\u4e0b\u9762\u5177\u4f53\u8bf4\u660e\u3002\n\n\u6700\u5f00\u59cb\u65f6 $S_{1}(x)\\!=\\!x\\!+\\!1,P_1(x)\\!=\\!x\\!+\\!1,Q_1(x)\\!=\\!n\\!-\\!x$\n\n\u8bbe\u5f53\u524d\u5df2\u6c42\u51fa $S_d(0),S_d(v)\\cdots S_d(dv)$\u3002\n\n## $\\text{Step 1: }S_d(x)\\rightarrow S_{2d}(x)$\n\n$$S_{2d}(x)=\\sum_{i=0}^{2d-1}\\left(\\prod_{j=i+1}^{2d}j\\!+\\!x\\right)\\left(\\prod_{j=0}^{i-1}n\\!-\\!j\\!-\\!x\\right)$$\n\n$$=\\sum_{i=0}^{d-1}\\left(\\prod_{j=i+ 1}^{2d}j\\!+\\!x\\right)\\left(\\prod_{j=0}^{i-1}n\\!-\\!j\\!-\\!x\\right)\\!+\\!\\sum_{i=d}^{2d-1}\\left(\\prod_{j=i+1}^{2d}j\\!+\\!x\\right)\\left(\\prod_{j=0}^{i-1}n\\!-\\!j\\!-\\!x\\right)$$\n\n$$=\\left(\\prod_{j=d+1}^{2d}j\\!+\\!x\\right)\\sum_{i=0}^{d-1}\\left(\\prod_{j=i+1}^{d}j\\!+\\!x\\right)\\left(\\prod_{j=0}^{i-1}n\\!-\\!j\\!-\\!x\\right)\\!+\\!\\left(\\prod_{j=0}^{d-1}j\\!+\\!x\\right)\\sum_{i=d}^{2d-1}\\left(\\prod_{j=i+1}^{2d}j\\!+\\!x\\right)\\left(\\prod_{j=d}^{i-1}n\\!-\\!j\\!-\\!x\\right)$$\n\n$$=P_d(x\\!+\\!d)S_d(x)\\!+\\!Q_d(x)S_d(x\\!+\\!d)$$\n\n\u800c $P_{2d}(x)=P_d(x)P_d(x\\!+\\!d),Q_{2d}(x)=Q_d(x)Q_d(x\\!+\\!d)$\n\n\u7136\u540e\u901a\u8fc7\u70b9\u503c\u5e73\u79fb\uff0c\u5c31\u53ef\u4ee5\u5f97\u5230 $S_{2d}(0),S_{2d}(v)\\cdots S_{2d}(2dv)$\uff0c$P_{2d}$ \u4e0e $Q_{2d}$ \u4e5f\u80fd\u540c\u65f6\u7ef4\u62a4\u3002\n\n\u8fd9\u90e8\u5206\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(d\\log d)$\u3002\n\n## $\\text{Step 2: }S_{d}(x)\\rightarrow S_{d+1}(x)$\n\n$$S_{d+1}(x)=\\sum_{i=0}^{d}\\left(\\prod_{j=i+1}^{d+1}j\\!+\\!x\\right)\\left(\\prod_{j=0}^{i-1}n\\!-\\!j\\!-\\!x\\right)$$\n\n$$=(d\\!+\\!x\\!+\\!1)\\sum_{i=0}^{d-1}\\left(\\prod_{j=i+1}^{d}j\\!+\\!x\\right)\\left(\\prod_{j=0}^{i-1}n\\!-\\!j\\!-\\!x\\right)\\!+\\!(d\\!+\\!x\\!+\\!1)\\prod_{j=0}^{d-1}n\\!-\\!j\\!-\\!x$$\n\n$$=(d\\!+\\!x\\!+\\!1)\\left(S_{d}(x)\\!+\\!Q_d(x)\\right)$$\n\n\u800c $P_{d+1}(x)=(d\\!+\\!1\\!+\\!x)P_d(x),Q_{d+1}(x)=(n\\!-\\!d\\!-\\!x)Q_{d}(x)$\n\n\u8fd9\u53ef\u4ee5\u5f97\u51fa $S_{d+1}(0),S_{d+1}(v)\\cdots S_{d+1}(dv)$\uff0c$P_{d+1},Q_{d+1}$ \u540c\u7406\u3002\n\n\u800c\u5bf9\u4e8e $\\displaystyle x=(d\\!+\\!1)v,P_d(x)=\\prod_{i=1}^{d+1}i\\!+\\!x,Q_d(x)=\\prod_{j=0}^{d}n\\!-\\!j\\!-\\!x$\u3002\n\n$\\displaystyle S_{d+1}(x)=\\sum_{i=0}^{d}\\left(\\prod_{j=i+1}^{d+1}j\\!+\\!x\\right)\\left(\\prod_{j=0}^{i-1}n\\!-\\!j\\!-\\!x\\right)$\n\n\u7686\u53ef\u4ee5 $O(d)$ \u6c42\u51fa\uff0c\u8fd9\u90e8\u5206\u65f6\u95f4\u590d\u6742\u5ea6\u4e5f\u4e3a $O(d)$\u3002\n\n\u603b\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(\\sqrt m\\log m)$\u3002\n\n### $\\texttt{Code:}$\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nconst int _=2e6+10;\nconst int mod=998244353,g=3;\nchar ch;int T,ans,N;\nint n,k,m,nn,n_,x,y,res,wn,v;\nint n1,len;int invn,w;\nint a[_],b[_],nt[_],suf[_];\nint rev[_],inv[_],fac[_],ifac[_];\ninline void read(int &x){\n\tx=0;ch=getchar();while(ch<47)ch=getchar();\n\twhile(ch>47)x=(x<<1)+(x<<3)+(ch^48),ch=getchar();\n}\nvoid write(int x){if(x>9)write(x/10);putchar(48|x%10);}\ninline void swap(int &x,int &y){x^=y^=x^=y;}\nvoid qpow(int x,int k){\n\tres=1;\n\twhile(k){\n\t\tif(k&1)res=1ll*res*x%mod;\n\t\tx=1ll*x*x%mod;k>>=1;\n\t}\n}\nvoid getinv(int n){\n\tregister int i;\n\tfor(inv[1]=1,i=2;i^n;++i)inv[i]=1ll*(mod-mod/i)*inv[mod%i]%mod;\n}\nvoid getinv(int n,int *f,int *g){\n\tstatic int i;\n\tfor(suf[n]=1,i=n-1;~i;--i)suf[i]=1ll*suf[i+1]*f[i]%mod;\n\tqpow(suf[0],mod-2);g[0]=res;\n\tfor(i=0;i^n;++i)g[i+1]=1ll*g[i]*f[i]%mod;\n\tfor(i=0;i^n;++i)g[i]=1ll*g[i]*suf[i+1]%mod;\n}\nvoid getfac(int n){\n\tregister int i;\n\tfor(ifac[0]=1,i=1;i^n;++i)ifac[i]=1ll*ifac[i-1]*inv[i]%mod;\n\tfor(fac[0]=1,i=1;i^n;++i)fac[i]=1ll*fac[i-1]*i%mod;\n}\nvoid getrev(int n){\n\tstatic int i;\n\tn1=1;len=-1;while(n1<(n<<1))n1<<=1,++len;\n\tfor(i=0;i^n1;++i)rev[i]=(rev[i>>1]>>1)|((i&1)<<len);\n}\nvoid ntt_init(int n){\n\tregister int i,mid,j;n<<=1;\n\tfor(mid=1;mid<n;mid<<=1){\n\t\tqpow(g,(mod-1)/(mid<<1));\n\t\twn=res;nt[mid]=1;j=(mid<<1);\n\t\tfor(i=mid+1;i<j;++i)nt[i]=1ll*nt[i-1]*wn%mod;\n\t}\n}\ninline void reverse(int *a,int n){\n\tstatic int i,nn;nn=n>>1;\n\tfor(i=0;i^nn;++i)swap(a[i],a[n-i-1]);\n}\ninline int add(int x,int y){return x+y>mod?x+y-mod:x+y;}\ninline int sub(int x,int y){return x>y?x-y:x-y+mod;}\nvoid ntt(int n,int *a,bool t){\n\tstatic int i,mid,j,k;\n\tfor(i=0;i^n;++i)if(i<rev[i])swap(a[i],a[rev[i]]);\n\tfor(mid=1;mid<n;mid<<=1){\n\t\tfor(j=0;j<n;j+=(mid<<1)){\n\t\t\tfor(k=0;k<mid;++k){\n\t\t\t\tx=a[j+k],y=1ll*nt[mid+k]*a[j+k+mid]%mod;\n\t\t\t\ta[j+k]=add(x,y);\n\t\t\t\ta[j+k+mid]=sub(x,y);\n\t\t\t}\n\t\t}\n\t}\n\tif(t){\n\t\treverse(a+1,n-1);\n\t\tfor(invn=inv[n],i=0;i^n;++i)a[i]=1ll*a[i]*invn%mod;\n\t}\n}\nint wrk[_],wrk_[_],trn[_];\nvoid pre_trans(int n,int m){\n\tstatic int i;\n\tfor(i=0;i^nn;++i)wrk[i]=i+m-n;\n\tgetinv(nn,wrk,wrk_);\n\tfor(i=0;i^nn;++i)wrk[i]=wrk_[i];\n\tfor(i=nn+1;i^n1;++i)wrk[i]=0;ntt(n1,wrk,0);\n\tfor(w=1,i=0;i<=n;++i)w=1ll*w*(m-i)%mod;trn[0]=w;\n\tfor(i=1;i<=n;++i)trn[i]=1ll*trn[i-1]*(m+i)%mod*wrk_[i-1]%mod;\n}\nvoid trans_from(int n,int *f){\n\tstatic int i;\n\tfor(i=0;i<=n;++i)f[i]=1ll*f[i]*ifac[i]%mod;\n\tfor(i=0;i<=n;++i)f[i]=1ll*f[i]*(n-i&1?mod-ifac[n-i]:ifac[n-i])%mod;\n\tfor(i=n+1;i^n1;++i)f[i]=0;ntt(n1,f,0);\n}\nvoid trans_to(int n,int *f,int *g){\n\tstatic int i;\n\tfor(i=0;i^n1;++i)g[i]=1ll*f[i]*wrk[i]%mod;\n\tntt(n1,g,1);for(i=0;i<=n;++i)g[i]=g[n+i];\n\tfor(i=0;i<=n;++i)g[i]=1ll*g[i]*trn[i]%mod;\n}\nvoid trans_to(int n,int *f){\n\tstatic int i;\n\tfor(i=0;i^n1;++i)f[i]=1ll*f[i]*wrk[i]%mod;\n\tntt(n1,f,1);for(i=0;i<=n;++i)f[i]=f[n+i];\n\tfor(i=0;i<=n;++i)f[i]=1ll*f[i]*trn[i]%mod;\n}\nint p[_],pp[_],q[_],qq[_],s[_],ss[_];\nint tp[_],tpp[_],tq[_],tqq[_],ts[_],tss[_];\nvoid iterate(int n){\n\tstatic int i,m;\n\tnn=(n<<1)+1,getrev(nn);\n\tm=1ll*n*inv[v]%mod;pre_trans(n,m);\n\tfor(i=0;i<=n;++i)ss[i]=ts[i]=s[i];\n\tfor(i=0;i<=n;++i)pp[i]=tp[i]=p[i];\n\tfor(i=0;i<=n;++i)qq[i]=tq[i]=q[i];\n\ttrans_from(n,s),trans_to(n,s,tss);\n\ttrans_from(n,p),trans_to(n,p,tpp);\n\ttrans_from(n,q),trans_to(n,q,tqq);\n\tfor(i=0;i<=n;++i)ss[i]=tss[i];\n\tfor(i=0;i<=n;++i)pp[i]=tpp[i];\n\tfor(i=0;i<=n;++i)qq[i]=tqq[i];\n\tm=n+1;pre_trans(n,m);\n\ttrans_to(n,s);trans_from(n,ss);trans_to(n,ss);\n\ttrans_to(n,p);trans_from(n,pp);trans_to(n,pp);\n\ttrans_to(n,q);trans_from(n,qq);trans_to(n,qq);\n\tfor(i=0;i^n;++i)s[n+i+1]=s[i],ss[n+i+1]=ss[i];\n\tfor(i=0;i^n;++i)p[n+i+1]=p[i],pp[n+i+1]=pp[i];\n\tfor(i=0;i^n;++i)q[n+i+1]=q[i],qq[n+i+1]=qq[i];\n\tfor(i=0;i<=n;++i)s[i]=ts[i],ss[i]=tss[i];\n\tfor(i=0;i<=n;++i)p[i]=tp[i],pp[i]=tpp[i];\n\tfor(i=0;i<=n;++i)q[i]=tq[i],qq[i]=tqq[i];\n\tn<<=1;\n\tfor(i=0;i<=n;++i)s[i]=add(1ll*s[i]*pp[i]%mod,1ll*q[i]*ss[i]%mod);\n\tfor(i=0;i<=n;++i)p[i]=1ll*p[i]*pp[i]%mod;\n\tfor(i=0;i<=n;++i)q[i]=1ll*q[i]*qq[i]%mod;\n}\nvoid shift(int n){\n\tstatic int i;\n\tfor(i=0;i^n;++i)s[i]=1ll*add(s[i],q[i])*(n+i*v)%mod;\n\tfor(i=0;i^n;++i)p[i]=1ll*p[i]*(n+i*v)%mod;\n\tnn=N-n+1;for(i=0;i^n;++i)q[i]=1ll*q[i]*(nn-i*v)%mod;\n\tfor(nn=n*v,w=1,i=n;i;--i)w=1ll*w*(nn+i)%mod,ss[i]=w;p[n]=w;\n\tfor(nn=N-nn,w=1,i=1;i<=n;++i)ts[i]=w,w=1ll*w*(nn-i+1)%mod;q[n]=w;\n\tfor(w=0,i=1;i<=n;++i)w=add(w,1ll*ss[i]*ts[i]%mod);s[n]=w;\n}\nvoid solve(int n){\n\tif(n==1){\n\t\ts[0]=1,s[1]=v+1;\n\t\tp[0]=1,p[1]=v+1;\n\t\tq[0]=N,q[1]=N-v;\n\t}\n\telse {\n\t\tsolve(n>>1);iterate(n>>1);\n\t\tif(n&1)shift(n);\n\t}\n}\ninline int min(int a,int b){return a<b?a:b;}\ninline int max(int a,int b){return a>b?a:b;}\nint inqn[110],inqm[110];bool inqb;\nmain(){\n\tread(T);\n\tregister int i,facm,mn;\n\tfor(i=0;i^T;++i)read(inqn[i]),read(inqm[i]),nn=max(nn,inqm[i]);\n\tv=1;while(v*v+v<=nn)++v;--v;\n\tgetinv(v<<4);ntt_init(v<<2);getfac(v<<1);\n\tfor(int zt=0;zt^T;++zt){\n\t\tN=inqn[zt],m=inqm[zt];inqb=0;\n\t\tif(m>=N){qpow(2,N);write(res);putchar('\\n');continue;}\n\t\tif(N==1){write(m+1);putchar('\\n');continue;}\n\t\tif(N-m-1<m)inqb=1,m=N-m-1;\n\t\tif(m==0)ans=1;\n\t\telse if(m==1)ans=N+1;\n\t\telse if(m==2)ans=add(N+1,1ll*N*(N-1)%mod*inv[2]%mod);\n\t\telse {\n\t\t\tv=1;while(v*v+v<m)++v;--v;\n\t\t\tsolve(v);nn=v*v+v;\n\t\t\tfor(w=1,i=nn+1;i<=m;++i)w=1ll*w*i%mod;p[v+1]=w;\n\t\t\tfor(mn=1,i=nn;i^m;++i)mn=1ll*mn*(N-i)%mod;\n\t\t\tfor(i=v;~i;--i)p[i]=1ll*p[i]*p[i+1]%mod;\n\t\t\tfacm=p[0];for(i=0;i<=v;++i)p[i]=p[i+1];\n\t\t\tfor(i=1;i<=v;++i)q[i]=1ll*q[i-1]*q[i]%mod;\n\t\t\tmn=1ll*mn*q[v]%mod;for(i=v+1;i;--i)q[i]=q[i-1];q[0]=1;\n\t\t\tfor(i=0;i<=v;++i)ans=add(ans,1ll*p[i]%mod*q[i]%mod*s[i]%mod);\n\t\t\tans=add(ans,mn);nn=m-nn;\n\t\t\tfor(i=0;i^nn;++i)ss[i]=N-(m-i-1);getinv(nn,ss,ts);\n\t\t\tfor(i=0;i^nn;++i)mn=1ll*mn*ts[i]%mod*(m-i)%mod,ans=add(ans,mn);\n\t\t\tqpow(facm,mod-2);ans=1ll*ans*res%mod;\n\t\t}\n\t\tif(inqb)qpow(2,N),ans=sub(res,ans);\n\t\twrite(ans);putchar('\\n');ans=0;\n\t}\n}\n```",
        "postTime": 1640178461,
        "uid": 334380,
        "name": "Y_B_X",
        "ccfLevel": 7,
        "title": "\u9898\u89e3[P6043 \u4fee\u5b66\u65c5\u884c]"
    }
]