[
    {
        "content": "5.7 update \uff1a\u73b0\u5728\u516c\u5f0f\u4f3c\u4e4e\u4e0d\u4f1a\u51fa\u9505\u4e86\uff1f\n\n\n\u5f15\u4f8b\uff1a$n$ \u79cd\u989c\u8272\u7684\u7403\u5206\u522b $a_i$ \u4e2a\uff0c\u76f8\u90bb\u4e0d\u540c\u8272\uff0c\u6392\u5217\uff0c\u65b9\u6848\u6570\u3002\n\n$m=\\sum a_i\\le 10^5$\n\n\u9996\u5148\u8003\u8651\u9898\u76ee\u4e2d\u7684\u9650\u5236\u6761\u4ef6\u662f\u4ec0\u4e48\uff0c\u5bf9\u4e8e\u5355\u79cd\u989c\u8272\u7684\u7403\u4ece\u5de6\u5f80\u53f3\u770b\uff0c\u7b2c $i$ \u4e2a\u8ddf\u7b2c $i+1$ \u4e2a\u4e0d\u76f8\u90bb\uff0c\u90a3\u4e48\u8be5\u989c\u8272\u5c31\u5bf9\u5e94\u7740 $a_i-1$ \u4e2a\u9650\u5236\u3002\n\n\u666e\u901a\u5bb9\u65a5\uff0c\u4e5f\u5c31\u662f\u679a\u4e3e\u6253\u7834\u591a\u5c11\u9650\u5236\n$$\n\\sum_{b_1\\sim b_n,b_i\\in[0,a_i-1]} \\prod_{i=1}^n(-1)^{b_i}{a_i-1\\choose b_i}\\times {(\\sum a_i-b_i)!\\over \\prod_{i=1}^n (a_i-b_i)!}\n$$\n\u6362\u6210\u679a\u4e3e $c_i=a_i-b_i$\uff0c\u7136\u540e $c_i$ \u7684\u610f\u4e49\u662f\u8bf4\u7b2c $i$ \u4e2a\u989c\u8272\u5f3a\u5236\u7f29\u6210\u8fd9\u4e48\u591a\u4e2a\u6bb5\u3002\n$$\n\\sum_{c_1\\sim c_n,c_i\\in [1,a_i]} (\\sum c_i)!\\prod_{i=1}^n(-1)^{a_i-c_i}{(a_i-1)!\\over (a_i-c_i)!(c_i-1)!}{1\\over c_i!}\n$$\n\u6ce8\u610f\u5230\u53ef\u4ee5\u6309 $\\sum c_i$ \u7edf\u8ba1\u7b54\u6848\uff0c\u90a3\u4e48\u6784\u9020\u5173\u4e8e\u540e\u5f0f\u7684\u666e\u901a\u751f\u6210\u51fd\u6570\n$$\nF_i(x)=\\sum_{j=1}^{a_i}(-1)^{a_i-j}{(a_i-1)!\\over (a_i-j)!(j-1)!j!}x^j\n$$\n\u7528\u5206\u6cbb ntt \u5377\u79ef\u4ee5\u540e\u7edf\u8ba1\u7b54\u6848\u5373\u53ef\uff0c\u590d\u6742\u5ea6 $O(m\\log^2m)$\u3002\n\n\u5f53\u7136\u8fd9\u4e2a\u662f\u5e26\u6807\u53f7\u7403\u7684\u62fc\u63a5\uff0c\u663e\u7136\u53ef\u4ee5\u76f4\u63a5\u7528\u6307\u6570\u751f\u6210\u51fd\u6570\u6765\u7406\u89e3\uff0c\u672c\u8d28\u662f\u4e00\u6837\u7684\u3002\n\n## \u56de\u5230\u672c\u9898\n\n\u7ed9\u5b9a $n$ \u79cd\u989c\u8272\u7684\u7403\uff0c\u7b2c $i$ \u79cd\u989c\u8272\u7684\u7403\u6570\u91cf\u4e3a $r_i$ \uff0c\u5bf9\u4e8e\u4e00\u79cd\u6392\u5217\u65b9\u5f0f\uff0c\u8d21\u732e\u53ef\u4ee5\u5982\u4e0b\u8ba1\u7b97\uff1a\u5148\u628a\u8fd9\u4e2a\u5e8f\u5217\u9996\u5c3e\u76f8\u8fde\uff0c\u7136\u540e\u628a\u6240\u6709\u76f8\u90bb\u4e14\u989c\u8272\u76f8\u540c\u7684\u6bb5\u62ff\u51fa\u6765\uff0c\u8d21\u732e\u4e3a\u4ed6\u4eec\u7684\u957f\u5ea6\u4e4b\u79ef\uff0c\u6c42\u6240\u6709\u8d21\u732e\u548c\u3002\n$(1,2,1,2)$ \u548c $(2,1,2,1)$ \u8d21\u732e\u76f8\u540c\u4f46\u6392\u5217\u65b9\u5f0f\u4e0d\u540c\uff0c\u8981\u5206\u522b\u8ba1\u7b97\u3002\n\n$\\sum r_i\\le 2\\times 10^5$\n\n\u6211\u4eec\u9996\u5148\u8003\u8651\u4e0d\u6210\u73af\u7684\u60c5\u51b5\u3002\n\n#### Step 1\n\n\u679a\u4e3e\u628a\u989c\u8272 $i$ \u5207\u6210 $a_i$ \u6bb5\uff0c\u8bbe $f(x,y)$ \u8868\u793a $x$ \u6709\u5e8f\u7684\u5207\u6210 $y$ \u6bb5\u7684\u6240\u6709\u65b9\u6848\uff0c\u6bcf\u6bb5\u957f\u5ea6\u4e58\u79ef\u4e4b\u548c\u3002\n\n\u95ee\u9898\u8f6c\u6362\u4e3a\u4ea4\u9519\u6392\u5217\uff0c\u76f4\u63a5\u5957\u7528\u4e0a\u9898\u7684\u5f0f\u5b50\uff0c\u90a3\u4e48\u6709\uff1a\n$$\n\\sum_{a_1\\sim a_n,a_i\\in[1,r_i]}f(r_i,a_i)\\sum_{c_1\\sim c_n,c_i\\in [1,a_i]} (\\sum c_i)!\\prod_{i=1}^n(-1)^{a_i-c_i}{(a_i-1)!\\over (a_i-c_i)!(c_i-1)!}{1\\over c_i!}\n$$\n\u628a $c_i$ \u6574\u5230\u524d\u9762\u6765\u5f97\u5230\n$$\n\\sum_{c_1\\sim c_n,c_i\\in [1,r_i]} (\\sum c_i)!\\sum_{c_i\\le a_i\\le r_i}f(r_i,a_i)\\prod_{i=1}^n(-1)^{a_i-c_i}{(a_i-1)!\\over (a_i-c_i)!(c_i-1)!}{1\\over c_i!}\n$$\n\u90a3\u4e48\u7ef4\u62a4\u751f\u6210\u51fd\u6570\n$$\nF_i(x)=\\sum_{j=1}^{r_i}\\sum_{j\\le a_i\\le r_i}f(r_i,a_i)(-1)^{a_i-j}{(a_i-1)!\\over (a_i-j)!(j-1)!j!}x^j\n$$\n#### Step 2\n\n\u8003\u8651\u7b97\u8fd9\u4e2a $F_i(x)$ \u6709 $f(x,y)={x+y-1\\choose 2y-1}$ \uff0c\u53ef\u4ee5\u7ed3\u5408\u7ec4\u5408\u610f\u4e49\u7406\u89e3\uff0c\u8003\u8651\u63d2\u677f\u51fa\u4e00\u4e2a\u65b9\u6848\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u8fde\u7eed\u6bb5\u8fd8\u8981\u9009\u51fa\u4e00\u4e2a\u4f4d\u7f6e\uff0c\u76f8\u5f53\u4e8e $x+y-1$ \u4e2a\u4f4d\u7f6e\u9009\u51fa $2y-1$ \u4e2a\u4f4d\u7f6e\u3002\n\n\u4e8e\u662f\u8ba1\u7b97 $F_i(x)$ \u662f\u4e00\u4e2a\u5377\u79ef\u5f62\u5f0f\u3002\n\n#### Step 3\n\n\u5206\u6cbb ntt \u8ba1\u7b97\u6bcf\u79cd\u7403\u7684\u751f\u6210\u51fd\u6570\u7684\u4e58\u79ef\uff0c\u590d\u6742\u5ea6 $O(m\\log^2 m)$\u3002\n\n#### Step 4\n\n\u8981\u505a\u73af\u4e0a\u7684\u60c5\u51b5\uff0c\u6211\u4eec\u94a6\u5b9a\u989c\u8272 1 \u5728\u5e8f\u5217\u6700\u524d\u5934\u5e76\u4e14\u7ed3\u5c3e\u4e0d\u662f 1\uff0c\u90a3\u4e48\u7528\u5f00\u5934\u662f 1 \u7684 - \u5f00\u5934\u7ed3\u5c3e\u90fd\u662f 1 \u7684\u3002\n\n\uff08\u94a6\u5b9a $t$ \u4e2a\u4f4d\u7f6e\u4e3a 1 \u76f8\u5f53\u4e8e\u628a $F_1(x)$ \u591a\u9879\u5f0f\u5f80\u5de6\u5e73\u79fb $t$ \u4f4d\u3002\uff09\n\n\u8fd9\u6837\u7684\u4e00\u79cd\u65b9\u6848\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4efb\u610f\u65cb\u8f6c\u7684\u65b9\u5f0f\u904d\u5386\u6240\u6709\u53ef\u884c\u65b9\u6848\uff0c\u90a3\u4e48\u6211\u4eec\u6700\u7ec8\u628a\u7b54\u6848\u4e58\u4ee5 $m=\\sum r_i$ \u5373\u53ef\u3002\n\n#### Step 5\n\n\u7136\u540e\u4f60\u53d1\u73b0\u8fd9\u6837\u4f1a\u7b97\u91cd\uff0c\u5177\u4f53\u7684\uff0c\u4e00\u4e2a\u65b9\u6848\u6709 $j$ \u6bb5\u989c\u8272 1\uff0c\u4f1a\u88ab\u6bcf\u4e2a 1 \u904d\u5386\u4e00\u904d\uff0c\u6240\u4ee5\u7b97\u91cd $j$ \u904d\uff0c\u90a3\u4e48\u53ef\u4ee5\u5728\u989c\u8272 1 \u7684\u751f\u6210\u51fd\u6570\u4e2d\u5e26\u4e0a $1\\over j$ \u7684\u7cfb\u6570\u6765\u62b5\u6d88\u6389\uff0c\u95ee\u9898\u624d\u6700\u7ec8\u89e3\u51b3\u3002\n\n### \u53e6\u5916\u4e00\u79cd\u672a\u77e5\u539f\u7406\u7684\u65b9\u6cd5\n\n\u8003\u8651\u8ba1\u7b97\u5173\u4e8e\u5e8f\u5217\u7684\u751f\u6210\u51fd\u6570 $f(x)$, \u5219 $ans=m\\sum_{j=1}^m (j-1)![x^j]f(x)$\u3002\n\n\u76ee\u524d\u6211\u4e0d\u592a\u6e05\u695a\u4e3a\u4ec0\u4e48\uff0c\u77e5\u9053\u539f\u7406\u7684\u5927\u4f6c\u8bf7\u8bc4\u8bba\u533a\u7559\u8a00\u6216\u8005\u79c1\u4fe1\uff0c\u8c22\u8c22\uff01",
        "postTime": 1583048261,
        "uid": 13052,
        "name": "iostream",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P6151 \u3010[\u96c6\u8bad\u961f\u4f5c\u4e1a2019] \u9752\u6625\u732a\u5934\u5c11\u5e74\u4e0d\u4f1a\u68a6\u5230\u5154\u5973\u90ce\u5b66\u59d0\u3011"
    },
    {
        "content": "\u5982\u679c\u516c\u5f0f\u6302\u4e86\u8bf7\u5728[\u6211\u7684\u535a\u5ba2](https://zhongyuwei.github.io/2020/04/22/luogu-P6151-%E9%9B%86%E8%AE%AD%E9%98%9F%E4%BD%9C%E4%B8%9A2019-%E9%9D%92%E6%98%A5%E7%8C%AA%E5%A4%B4%E5%B0%91%E5%B9%B4%E4%B8%8D%E4%BC%9A%E6%A2%A6%E5%88%B0%E5%85%94%E5%A5%B3%E9%83%8E%E5%AD%A6%E5%A7%90/)\u6216\u8005[\u6211\u7684\u6d1b\u8c37\u535a\u5ba2](https://www.luogu.com.cn/blog/zhongyuwei/solution-p6151)\u4e2d\u67e5\u770b\n\n## Sol\n\n\u5b9a\u4e49\u4e00\u4e2a\u5e8f\u5217\u662f\u597d\u7684\uff0c\u5f53\u4e14\u4ec5\u5f53\u5b83\u4ee5 $1$ \u5f00\u59cb\u4e14\u4e0d\u4ee5 $1$ \u7ed3\u5c3e\u3002\n\n\u4efb\u610f\u4e00\u4e2a\u5e8f\u5217 $S$\uff0c\u5047\u8bbe\u5b83\u5bf9\u5e94\u7684\u5706\u6392\u5217\u4e2d\u6709 $c(S)$ \u6bb5 $1$\uff0c\u90a3\u4e48\u5b83\u7684\u5faa\u73af\u79fb\u4f4d\u4e2d\u6709 $c(S)$ \u4e2a\u597d\u7684\u5e8f\u5217\uff08\u8fd9\u5176\u4e2d\u53ef\u80fd\u6709\u76f8\u540c\u7684\u597d\u5e8f\u5217\uff09\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u6240\u6709\u7684\u597d\u5e8f\u5217\u7684\u3001\u7b49\u4e8e $S$ \u7684\u5faa\u73af\u79fb\u4f4d\u7684\u6570\u91cf\u4e3a $c(S)$\u3002\n\n\u8bbe $val(S)$ \u4e3a\u5e8f\u5217 $S$ \u7684\u6743\u503c\uff08\u4e0e\u9898\u76ee\u4e2d\u7684\u5b9a\u4e49\u76f8\u540c\uff09\uff0c\u90a3\u4e48\n\n\n$\n\\begin{gathered}\nAns\\\\\n= \\sum_{\\text{S\u4e3a\u7b26\u5408\u9898\u610f\u7684\u5e8f\u5217}} val(S) \\\\\n= \\sum_{\\text{S\u4e3a\u7b26\u5408\u9898\u610f\u7684\u5e8f\u5217}} \\frac{1}{c(S)}\\sum_{\\text{P\u662fS\u7684\u5faa\u73af\u79fb\u4f4d\u4e14P\u662f\u597d\u5e8f\u5217}} val(P)\\\\\n= \\sum_{\\text{S\u4e3a\u7b26\u5408\u9898\u610f\u7684\u5e8f\u5217}} \\sum_{\\text{P\u662fS\u7684\u5faa\u73af\u79fb\u4f4d\u4e14P\u662f\u597d\u5e8f\u5217}} \\frac{1}{c(P)} val(P)\\\\\n= \\sum_{\\text{P \u662f\u7b26\u5408\u9898\u610f\u7684\u597d\u5e8f\u5217}} \\frac{ val(P)}{c(P)} \\sum_{\\text{S \u662f P \u7684\u5faa\u73af\u79fb\u4f4d}} 1\\\\\n= \\sum_{\\text{P \u662f\u7b26\u5408\u9898\u610f\u7684\u597d\u5e8f\u5217}} \\frac{val(P)}{c(P)} |P|\n\\end{gathered}\n$\n\n\u56e0\u4e3a\u5e8f\u5217\u7684\u957f\u5ea6\u662f\u56fa\u5b9a\u7684\uff0c\u6211\u4eec\u53ea\u9700\u8981\u7edf\u8ba1 $\\sum_{\\text{P\u662f\u7b26\u5408\u9898\u610f\u7684\u597d\u5e8f\u5217}} \\frac{val(P)}{c(P)}$ \u5c31\u80fd\u5f97\u5230\u7b54\u6848\u3002\n\n\u5c06 $a$ \u4e2a\u76f8\u540c\u7684\u6570\u5b57\u5212\u5206\u6210 $b$ \u6bb5\u7684\u6240\u6709\u65b9\u6848\u7684\u6743\u503c\u548c\u4e3a\n\n$\n\\begin{gathered}\n\\sum_{x_i \\ge 1, x_1+x_2+\\cdots x_b = a} \\prod_{i=1}^b x_i\n\\end{gathered}\n$\n\n\u8003\u8651\u5230 $\\prod_i x_i$ \u7684\u7ec4\u5408\u610f\u4e49\u76f8\u5f53\u4e8e\u662f\u4ece\u6bcf\u6bb5\u91cc\u9762\u518d\u9009\u51fa\u4e00\u4e2a\u7403\uff0c\u628a\u9009\u7684\u8fd9\u4e2a\u7403\u5f53\u6210\u677f\u5b50\uff0c\u53ef\u4ee5\u5f97\u5230\u4e0a\u5f0f\u7b49\u4ef7\u4e8e\n\n$\n\\begin{gathered}\n\\sum_{x_i \\ge 0, x_1+x_2+\\cdots x_{2b} = a-b} 1\\\\\n= \\binom{a+b-1}{2b-1}\n\\end{gathered}\n$\n\n\u5148\u679a\u4e3e\u6bcf\u79cd\u6570\u5b57\u5728\u6700\u7ec8\u7684\u5e8f\u5217\u4e2d\u5f62\u6210\u4e86\u591a\u5c11\u6bb5\uff0c\u7136\u540e\u7531\u4e8e\u8981\u6c42\u540c\u79cd\u6570\u5b57\u7684\u6bb5\u4e0d\u80fd\u76f8\u90bb\uff0c\u6240\u4ee5\u518d\u679a\u4e3e\u540c\u79cd\u6570\u5b57\u7684\u54ea\u4e9b\u6bb5\u88ab\u7c98\u5728\u4e86\u4e00\u8d77\uff08\u5bb9\u65a5\uff09\u3002\u4e0d\u4e3a $1$ \u7684\u6570\u5b57\uff0c\u5b83\u7684 EGF \u4e3a\uff08\u5047\u8bbe\u8fd9\u79cd\u6570\u5b57\u5171\u6709 $a$ \u4e2a\uff09\n\n$\n\\begin{gathered}\n\\sum_{b=1}^a \\binom{a+b-1}{2b-1} \\sum_{j=1}^b (-1)^{b-j} \\binom{b-1}{j-1} \\frac{x^j}{j!}\\\\\n= \\sum_{j=1}^a \\frac{x^j}{j!(j-1)!} (-1)^j \\sum_{b=j}^a \\frac{(b-1)!}{(b-j)!} (-1)^b \\binom{a+b-1}{2b-1}\n\\end{gathered}\n$\n\n\u53ef\u4ee5\u4e00\u6b21 FFT \u7b97\u51fa\u6765\u3002\n\n\u800c\u5bf9\u4e8e\u6570\u5b57 $1$\uff0c\u5bb9\u65a5\u7684\u65f6\u5019\u9664\u4e86\u53ef\u4ee5\u628a\u76f8\u90bb\u7684\u6bb5\u7c98\u5728\u4e00\u8d77\uff0c\u8fd8\u53ef\u4ee5\u628a\u6700\u540e\u4e00\u6bb5\u548c\u7ed3\u5c3e\u7c98\u5728\u4e00\u8d77\uff0c\u5e76\u4e14\u7b2c\u4e00\u6bb5\u5728\u5e8f\u5217\u4e2d\u7684\u4f4d\u7f6e\u662f\u786e\u5b9a\u4e86\u7684\uff0c\u4e0d\u53c2\u4e0e\u6392\u5217\uff0c\u6240\u4ee5\u5b83\u7684 EGF \u4e3a\uff08\u4ecd\u7136\u8bbe $a=c_1$\uff09\n\n$\n\\begin{gathered}\n\\sum_{b=1}^a \\frac{1}{b} \\binom{a+b-1}{2b-1} \\sum_{j=0}^{b-1} \\binom{b}{b-1-j} (-1)^{b-1-j} \\frac{x^j}{j!}\\\\\n= \\sum_{j=0}^{a-1} \\frac{x^j}{j!(j+1)!} (-1)^j \\sum_{b=j+1}^a \\frac{b!}{(b-j-1)!}(-1)^{b-1} \\frac{1}{b} \\binom{a+b-1}{2b-1}\n\\end{gathered}\n$\n\n\u4e5f\u53ef\u4ee5\u4e00\u6b21 FFT \u7b97\u51fa\u6765\u3002\n\n\u6700\u540e\u6211\u4eec\u9700\u8981\u7b97\u7684\u662f\u6bcf\u4e2a\u6570\u5b57\u7684 EGF \u7684\u4e58\u79ef\uff0c\u5206\u6cbb FFT \u5373\u53ef\u3002\n\n## Code\n\n``` cpp\n#include <cstdio>\n#include <iostream>\n#include <cstring>\n#include <algorithm>\n#include <vector>\n#define PB push_back\n#define MP make_pair\n#define PII pair<int,int>\n#define FIR first\n#define SEC second\n#define ll long long\nusing namespace std;\ntemplate <class T>\ninline void rd(T &x) {\n\tx=0; char c=getchar(); int f=1;\n\twhile(!isdigit(c)) { if(c=='-') f=-1; c=getchar(); }\n\twhile(isdigit(c)) x=x*10-'0'+c,c=getchar(); x*=f;\n}\nconst int mod=998244353;\nconst int N=2e5+10;\nll Pow(ll x,int y) { ll res=1; for(;y;y>>=1,x=x*x%mod) if(y&1) res=res*x%mod; return res; }\n\nnamespace Poly {\n\tconst int N=(1<<18)+10;\n    int wn[2][N],rev[N];\n    void getwn(int l) {\n        for(int i=1;i<(1<<l);i<<=1) {\n            int w0=Pow(3,(mod-1)/(i<<1)),w1=Pow(3,mod-1-(mod-1)/(i<<1));\n            wn[0][i]=wn[1][i]=1;\n            for(int j=1;j<i;++j)\n                wn[0][i+j]=wn[0][i+j-1]*(ll)w0%mod,\n                wn[1][i+j]=wn[1][i+j-1]*(ll)w1%mod;\n        }\n    }\n    void getr(int len) { for(int i=1;i<len;++i) rev[i]=(rev[i>>1]>>1)|((i&1)*(len>>1)); }\n    void FFT(int *A,int len,int f) {\n        for(int i=0;i<len;++i) if(rev[i]<i) swap(A[i],A[rev[i]]);\n        for(int l=1;l<len;l<<=1)\n            for(int i=0;i<len;i+=l<<1)\n                for(int j=0;j<l;++j) {\n                    int t0=A[i+j],t1=A[i+l+j]*(ll)wn[f][l+j]%mod;\n                    A[i+j]=(t0+t1)%mod,A[i+l+j]=(t0-t1)%mod;\n                }\n        if(f==1) {\n            int Inv=Pow(len,mod-2);\n            for(int i=0;i<len;++i) A[i]=A[i]*(ll)Inv%mod;\n        }\n    }  \n\tvoid Mul(int *A,int *B,int *C,int n,int m,int l3) {\n        static int a[N],b[N];\n        int len=1; while(len<n+m-1||len<l3) len<<=1; getr(len);\n        for(int i=0;i<len;++i) a[i]=b[i]=0;\n        for(int i=0;i<n;++i) a[i]=A[i];\n        for(int i=0;i<m;++i) b[i]=B[i];\n        FFT(a,len,0),FFT(b,len,0); for(int i=0;i<len;++i) a[i]=a[i]*(ll)b[i]%mod; FFT(a,len,1);\n        for(int i=0;i<l3;++i) C[i]=a[i];\n    }\n    void Mul(int *A,int *B,int *C,int n,int m) { Mul(A,B,C,n,m,n+m-1); }\n    inline void Mul(vector<int> &A,vector<int> &B,vector<int> &C) {\n    \tstatic int a[N],b[N];\n        int len=1; while(len<A.size()+B.size()-1) len<<=1; getr(len);\n        for(int i=0;i<len;++i) a[i]=b[i]=0;\n        for(int i=0;i<A.size();++i) a[i]=A[i];\n        for(int i=0;i<B.size();++i) b[i]=B[i];\n        FFT(a,len,0),FFT(b,len,0); for(int i=0;i<len;++i) a[i]=a[i]*(ll)b[i]%mod; FFT(a,len,1);\n        C.resize(A.size()+B.size()-1);\n        for(int i=0;i<C.size();++i) C[i]=a[i];\n    }\n}\n\nvector<int> g[N],s[N<<2];\ninline void solve(int l,int r,int c) {\n\tif(l==r) return (void)(s[c]=g[l]);\n\tint mid=l+r>>1;\n\tsolve(l,mid,c<<1),solve(mid+1,r,c<<1|1);\n\tPoly::Mul(s[c<<1],s[c<<1|1],s[c]);\n\ts[c<<1].clear();\n\ts[c<<1|1].clear();\n}\nll fac[N<<1],inv[N<<1];\n// ll A[N],B[N],C[N];\nint A[N],B[N],C[N];\nll f[N];\n//ll sum[N],tmp[N];\n//int len;\ninline void getfac(int n) {\n\tfac[0]=1; for(int i=1;i<=n;++i) fac[i]=fac[i-1]*i%mod;\n\tinv[n]=Pow(fac[n],mod-2); for(int i=n;i>=1;--i) inv[i-1]=inv[i]*i%mod;\n}\ninline ll binom(int n,int m) { return fac[n]*inv[m]%mod*inv[n-m]%mod; }\nint ra[N];\nint main() {\n\tint m; rd(m);\n\tgetfac(400000);\n\tPoly::getwn(18);\n//\tsum[0]=1;\n\tint coe=0;\n\tfor(int now=1,a;now<=m;++now) {\n\t\trd(a),coe+=a;\n\t\tfor(int i=0;i<=a;++i) A[i]=B[i]=0;\n\t\tif(now==1) {\n\t\t\tfor(int i=1;i<=a;++i) A[i]=binom(a+i-1,2*i-1)*fac[i-1]%mod*(i&1?1:-1);\n\t\t\tfor(int i=1;i<=a;++i) B[a-i]=inv[i-1];\n\t\t\tPoly::Mul(A,B,C,a+1,a+1);\n\t\t\tfor(int i=0;i<a;++i) f[i]=C[i+a]*inv[i]%mod*inv[i+1]%mod*(i&1?-1:1);\n\t\t\t\n//\t\t\tfor(int i=1;i<=a;++i) B[i]=inv[i-1];\n//\t\t\tfor(int i=1;i<=a;++i) for(int j=1;j<=i;++j) (C[i-j]+=A[i]*B[j]%mod)%=mod;\n//\t\t\tfor(int i=0;i<a;++i) f[i]=C[i]*inv[i]%mod*inv[i+1]%mod*(i&1?-1:1),C[i]=0;\n\t\t}\n\t\telse {\n\t\t\tfor(int i=1;i<=a;++i) A[i]=binom(a+i-1,2*i-1)*fac[i-1]%mod*(i&1?-1:1);\n\t\t\tfor(int i=0;i<a;++i) B[a-i]=inv[i];\n\t\t\tPoly::Mul(A,B,C,a+1,a+1);\n\t\t\tfor(int i=1;i<=a;++i) f[i]=C[i+a]*inv[i]%mod*inv[i-1]%mod*(i&1?-1:1);\n//\t\t\tfor(int i=0;i<a;++i) B[i]=inv[i];\n//\t\t\tfor(int i=1;i<=a;++i) for(int j=0;j<i;++j) (C[i-j]+=A[i]*B[j]%mod)%=mod;\n//\t\t\tfor(int i=1;i<=a;++i) f[i]=C[i]*inv[i]%mod*inv[i-1]%mod*(i&1?-1:1),C[i]=0;\n\t\t}\n\t\tfor(int i=0;i<=a;++i) g[now].PB(f[i]),f[i]=0;\n//\t\tfor(int i=0;i<=a;++i)\n//\t\tfor(int j=0;j<=len;++j)\n//\t\t\t(tmp[i+j]+=f[i]*sum[j]%mod)%=mod;\n//\t\tlen+=a;\n//\t\tfor(int i=0;i<=len;++i) sum[i]=tmp[i],tmp[i]=0;\n//\t\tfor(int i=0;i<=a;++i) f[i]=0;\n\t}\n\tsolve(1,m,1);\n\tint ans=0;\n//\tfor(int i=0;i<=len;++i) (ans+=sum[i]*fac[i]%mod)%=mod;\n\tfor(int i=0;i<s[1].size();++i) (ans+=s[1][i]*fac[i]%mod)%=mod;\n\tans=1ll*ans*coe%mod;\n\tprintf(\"%d\",(ans+mod)%mod);\n\treturn 0;\n}\n```",
        "postTime": 1587526856,
        "uid": 40534,
        "name": "zhongyuwei",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P6151 \u3010[\u96c6\u8bad\u961f\u4f5c\u4e1a2019] \u9752\u6625\u732a\u5934\u5c11\u5e74\u4e0d\u4f1a\u68a6\u5230\u5154\u5973\u90ce\u5b66\u59d0\u3011"
    },
    {
        "content": "```\nwhile(1)ORZ(iostream);\n```\n\n[\u9898\u9762](https://www.luogu.com.cn/problem/P6151)\n\n\u4ecb\u4e8e\u6d1b\u8c37\u4e0a\u73b0\u5728\u8fd8\u6ca1\u6709\u8fd9\u9053\u9898\u7684\u4ee3\u7801\uff0c\u5c31\u8ba9\u672c\u849f\u84bb\u6765\u63d0\u4f9b\u4e00\u7bc7\u3002(\u62b5\u5236\u65e0\u8111\u590d\u5236\u7c98\u8d34\uff0c\u4ece\u6211\u505a\u8d77)\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n\n//\u5c31\u6682\u4e14\u8fd9\u4e48\u8ba4\u4e3a\u5427\ntypedef long long int64;\nconst int mod = 998244353 , g = 3;\nnamespace SYT_POLY\n{\n\nint _[1<<19] , w0[1<<19] , w1[1<<19];//\u5907\u7528\u7684\u6570\u7ec4\n\nint qpow(int x , int y = mod - 2)\n{\n    int res = 1;\n    for(; y ; y >>= 1 , x = 1ll * x * x % mod)\n        if(y & 1) res = 1ll * res * x % mod;\n    return res; \n} \n\nstruct Poly : public vector<int>\n{\n    int degree() {return (int)size() - 1;}\n    void set(int deg) {resize(deg + 1);}\n    int val(int x)//\u5355\u70b9\u6c42\u503c\n    {\n        int res = 0;\n        for(int i = degree() ; ~i ; i--)\n            res = (1ll * res * x + this->at(i)) % mod;\n        return res;\n    }\n};\n\n//\u52a0\u6cd5\nPoly operator + (Poly a , Poly b)\n{\n    a.set(max(a.degree() , b.degree()));\n    for(int i = 0 ; i <= b.degree() ; i ++) a[i] = (a[i] + b[i]) % mod;\n    return a;\n}\n//\u51cf\u6cd5\nPoly operator - (Poly a , Poly b)\n{\n    a.set(max(a.degree() , b.degree()));\n    for(int i = 0 ; i <= b.degree() ; i ++) a[i] = (a[i] - b[i] + mod) % mod;\n    return a;\n}\n\n//\u51c6\u5907\u5907\u7528\u6570\u7ec4\uff0c\u8ba1\u7b97limit\nint ntt_prepare(int deg)\n{\n    int limit = 1;\n    while(limit <= deg) limit <<= 1;\n    for(int i = 1 ; i < limit ; i++)\n    {\n        _[i] = _[i >> 1] >> 1;\n        if(i&1) _[i] |= (limit >> 1);\n    }\n    w0[0] = w1[0] = 1;\n    int wn = qpow(g , (mod-1) / limit);\n    for(int i = 1 ; i < limit ; i++) \n        w0[limit - i] = w1[i] = 1ll * w1[i-1] * wn % mod;\n    return limit;\n}\n//NTT\nvoid NTT(Poly& x , bool type , int limit)\n{\n    x.set(limit - 1);\n    for(int i = 0 ; i < limit ; i ++)\n        if(i < _[i]) swap(x[i] , x[_[i]]);\n    for(int mid = 1 ; mid < limit ; mid <<= 1)\n        for(int j = 0 , i = limit/(2*mid); j < limit ; j += mid*2)\n            for(int k = 0 ; k < mid ; k++)\n            {\n                int a = x[j + k] , b = 1ll * x[j + k + mid] * (type?w1[i*k]:w0[i*k]) % mod;\n                x[j + k] = (a + b) % mod;\n                x[j + k + mid] = (a - b + mod) % mod;                \n            }\n    if(type) return ;\n    int64 inv = qpow(limit);\n    for(int i = 0 ; i < limit ; i ++) x[i] = x[i] * inv % mod;\n}\n//\u4e58\u6cd5\nPoly operator * (Poly a , Poly b)\n{\n    if(a.empty()) return a ; if(b.empty()) return b;\n    int tot = a.degree()+b.degree();\n    int limit = ntt_prepare(tot);\n    NTT(a , 1 , limit) , NTT(b , 1 , limit);\n    for(int i = 0 ; i < limit ; i ++) a[i] = 1ll*a[i]*b[i]%mod;\n    NTT(a , 0 , limit) , a.set(tot);\n    return a;\n}\n}\nusing namespace SYT_POLY;\n\nconst int N = 200020;\nint fac[2*N] , ifac[2*N];\nvoid C_init(int len)\n{\n    fac[0] = 1;\n    for(int i = 1 ; i <= len ; i ++) fac[i] = 1ll * fac[i - 1] * i % mod;\n    ifac[len] = qpow(fac[len]);\n    for(int i = len-1 ; ~i ; i --) ifac[i] = ifac[i + 1] * (i + 1ll) % mod;\n}\n\nint C(int x , int y) {\n    if(y < 0 || y > x) return 0;\n    return 1ll * fac[x] * ifac[y] % mod * ifac[x - y] % mod;\n}\ninline int read() {\n    int x = 0 ; char c = getchar(); bool f = 0;\n    while(c < '0' || c > '9') f |= (c=='-') , c = getchar();\n    while(c >= '0' && c <= '9') x = x * 10 + (c^48) , c = getchar();\n    return f ? -x : x;\n}\n\nint n , m , ans;\n\nPoly move(Poly a , int w) {\n    if(w > a.degree()) {a.clear() ; return a;}\n    for(int i = w ; i <= a.degree() ; ++i)\n        a[i - w] = a[i];\n    a.set(a.degree() - w);\n    return a;\n}\n\n//EGF\nPoly f[N];\nPoly calc(int l , int r) {\n    if(l == r) {\n        Poly g = f[l];\n        for(int i = 0 ; i <= g.degree() ; ++i)\n            g[i] = 1LL * g[i] * ifac[i] % mod;\n        return g;\n    }\n    int mid = (l + r) >> 1;\n    return calc(l , mid) * calc(mid + 1 , r);\n}\ninline int sgn(int i) { return (i&1) ? mod - 1 : 1; }\n\nint main() {\n    C_init(400010);\n    n = read();\n    \n    for(int i = 1 ; i <= n ; ++i) {\n        Poly A , B , &F = f[i];\n        A.clear() , B.clear();\n        int a = read(); m += a;\n        A.set(a) , B.set(a);\n\n        for(int j = 1 ; j <= a ; ++j)\n            A[j] = 1LL * fac[j - 1] * C(a + j - 1 , a - j) % mod;\n        if(i == 1) {\n            for(int j = 1 ; j <= a ; ++j)\n                A[j] = 1LL * A[j] * qpow(j) % mod;\n        }\n        for(int j = 0 ; j <= a ; ++j)\n            B[a - j] = 1LL * sgn(j) * ifac[j] % mod;\n        F = move(A * B , a);\n        for(int j = 1 ; j <= a ; ++j)\n            F[j] = 1LL * F[j] * ifac[j - 1] % mod;\n        F[0] = 0;\n    }\n    Poly _2__n = calc(2 , n) , res;\n    f[1] = move(f[1] , 1);\n    res = calc(1 , 1) * _2__n;\n    f[1] = move(f[1] , 1);\n    res = res - calc(1 , 1) * _2__n;\n    for(int i = 1 ; i <= res.degree() ; ++i)\n        ans = (ans + 1LL * res[i] * fac[i]) % mod;\n    ans = 1LL * ans * m % mod;\n    printf(\"%d\\n\" , ans);\n    return 0;\n}\n```\n\niostream\u5df2\u7ecf\u6709\u795e\u4ed9\u89e3\u91ca\u4e86\uff0c\u6211\u8fd8\u662f\u518d\u590d\u8bfb\u51e0\u53e5\u5427\u3002\u3002\u3002\n\n\n\u9996\u5148\u8003\u8651\u5982\u679c\u6709$a$\u4e2a\u7403\uff0c\u5212\u5206\u4e3a$b$\u6bb5\uff0c\u8ba1\u7b97\u6240\u6709\u65b9\u6848\u603b\u8d21\u732e\uff1f\n\n$$\nw(a,b)=\\binom{a+b-1}{a-b}\n$$\n\n\u4e3a\u4ec0\u4e48\u5462\uff1f\u6211\u4eec\u5728$a$\u4e2a\u6570\u4e2d\u63d2\u5165$b-1$\u4e2a\u677f\uff0c\u7136\u540e\u5728\u6253\u4e0a$b$\u4e2a\u6807\u8bb0\u3002\u6211\u4eec\u7684\u64cd\u4f5c\u987a\u5e8f\u662f[\u6807\u8bb0\uff0c\u677f\uff0c\u6807\u8bb0\uff0c\u677f]....\u7b49\u4ef7\u4e8e\u4ece$a+b-1$\u4e2a\u6570\u91cc\u9009$2b-1$\u4e2a\u6570\u3002\n\n\u6211\u4eec\u5148\u8003\u8651\u4e00\u4e0b\u8fd9\u4e2a\u95ee\u9898\u7684\u4e00\u4e2a\u7b80\u5316\u677f\uff0c\u5373**\u5728\u5e8f\u5217\u4e0a\u7684\u60c5\u51b5**\u3002\n\n\u600e\u4e48\u505a\uff1f~~\u770b\u6807\u7b7e~~\uff0c\u5bb9\u65a5\uff01\n\n\u8bbe$b_i$\u8868\u793a\u6bcf\u4e00\u79cd\u989c\u8272\u9009\u51e0\u6bb5\uff0c$c_i$\u8868\u793a\u6bcf\u4e00\u79cd\u989c\u8272\u81f3\u5c11\u4fdd\u5b58\u51e0\u6bb5\u3002\n\n\u6240\u4ee5\u7b54\u6848\u5c31\u662f\n\n$$\n(\\sum\\limits_b \\sum\\limits_c \\prod\\limits_{i=1}^n w(a_i,b_i) \\binom{b_i-1}{c_i-1}(-1)^{b_i-c_i})*\\frac{(\\sum{c_i})!}{(\\sum{c_i!})}\n$$\n\n\u610f\u4e49\u5c31\u662f\u679a\u4e3e$b,c$\uff0c\u7136\u540e\u9009\u51fa\u81f3\u5c11\u4fdd\u5b58\u7684\u4f4d\u7f6e\uff0c\u518d\u4e58\u4e0a\u5bb9\u65a5\u7cfb\u6570\uff0c\u6700\u540e\u8981\u4e58\u4e0a\u591a\u91cd\u96c6\u6392\u5217\u6570\u3002\n\n\u770b\u5230\u540e\u8fb9\u7684\u5f0f\u5b50\uff0c\u6211\u4eec\u4e0d\u7531\u5f97\u60f3\u5230\u4e86`EGF`\u7684\u5377\u79ef\u3002\n\n\u7ed9\u6bcf\u4e00\u79cd\u989c\u8272\u6765\u4e2a`EGF`\n\n$$\nF_i=\\sum\\limits_c \\frac{x^c}{c!}\\sum\\limits_bw(a_i,b)\\binom{b-1}{c-1}(-1)^{b-c}\n$$\n\n\u53ef\u4ee5\u5377\u79ef\uff0c\u5206\u6cbbFFT\u5c31\u53ef\u4ee5\u6c42\u539f\u6765\u7684\u7b54\u6848\u3002\n\n\u63a8\u5f0f\u5b50\u5230\u73b0\u5728\uff0c\u60a8\u7684\u671f\u671b\u5f97\u5206$\\color{red}{0}$.\u8fd8\u6709\u4e24\u4e2a\u81f3\u5173\u91cd\u8981\u7684\u95ee\u9898\u5c1a\u672a\u89e3\u51b3\u3002\n\n### 1:\u5982\u4f55\u628a\u5e8f\u5217\u95ee\u9898\u8fc1\u79fb\u5230\u73af\u4e0a\uff1f\n\n\u94a6\u5b9a1\u53f7\u989c\u8272\u7684\u4e00\u6bb5\u7684\u5934\u90e8\u4e3a\u8d77\u59cb\u7684\u4f4d\u7f6e\u3002\u6211\u4eec\u6709\u5982\u4e0b\u5bb9\u65a5\uff1a\n\nEGF(\u8d77\u59cb\u4f4d\u7f6e\u4e3a1\uff0c\u7ec8\u6b62\u4f4d\u7f6e\u4efb\u610f)-EGF(\u8d77\u59cb\u4f4d\u7f6e\uff0c\u7ec8\u6b62\u4f4d\u7f6e\u5747\u4e3a1)\n\n\u76f8\u5f53\u4e8e\u5206\u522b\u94a6\u5b9a\u4e861\u6bb5\uff0c2\u6bb5\u4e3a1\u53f7\u989c\u8272.\u6211\u4eec\u628a1\u53f7\u989c\u8272\u7684`EGF`\u5206\u522b\u5411\u5de6\u79fb1\uff0c2\u4f4d\u5c31\u53ef\u4ee5\u4e86\u3002~~\u751f\u6210\u51fd\u6570\u771f\u662f\u5947\u5999\u554a~~\n\n\n### 2:\u5982\u4f55\u89e3\u51b3\u91cd\u590d\u548c\u6f0f\u6570\u7684\u95ee\u9898\uff1f\n\n\u9996\u5148\uff0c\u6211\u4eec\u6f0f\u6570\u4e86\u3002\u9898\u76ee\u4e2d\u8981\u6c42\u5faa\u73af\u79fb\u4f4d\u7b97\u4e0d\u540c\u65b9\u6848\uff0c\u6240\u4ee5\u6700\u7ec8\u7684\u7b54\u6848\u8981\u4e58\u4e0a\u4e00\u4e2a$\\sum a$.\n\n\u7136\u540e\uff0c\u6211\u4eec\u53c8\u6570\u591a\u4e86\u3002\u56e0\u4e3a\u5982\u679c\u989c\u82721\u51fa\u73b0\u4e86$b$\u6b21\uff0c\u6211\u4eec\u5c31\u4f1a\u591a\u6570$b$\u6b21\uff0c\u89e3\u51b3\u65b9\u6cd5\u5c31\u662f\u5728\u6c42$F_1$\u7684\u65f6\u4faf\uff0c\u6bcf\u4e2a$f(a_i,b_i)$\u4e2d\u9664\u4ee5\u4e2a$b_i$\u5c31\u505a\u5230\u4e86\u53bb\u91cd\u3002\n\n\u6700\u540e\uff0c\u522b\u5fd8EGF\u5377\u8d77\u6765\u540e\u8fd8\u8981\u4e58\u4e00\u4e2a\u9636\u4e58\u3002\u8fd9\u6837\u5c31OK\u8fa3\uff01",
        "postTime": 1586268142,
        "uid": 138511,
        "name": "GreenDay",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P6151 \u3010[\u96c6\u8bad\u961f\u4f5c\u4e1a2019] \u9752\u6625\u732a\u5934\u5c11\u5e74\u4e0d\u4f1a\u68a6\u5230\u5154\u5973\u90ce\u5b66\u59d0\u3011"
    },
    {
        "content": "[\u539f\u9898\u94fe\u63a5](https://www.luogu.com.cn/problem/P6151)\n\n\u8fd9\u91cc\u7ed9\u51fa\u4e00\u79cd\u901a\u6cd5\uff0c\u4e0d\u4f9d\u8d56\u4e8e\u6bcf\u4e2a\u989c\u8272\u6bb5\u7684\u8d21\u732e\u4e00\u5b9a\u662f\u5176\u957f\u5ea6\u3002\n\n>\u7ed9\u5b9a\u51fa $t$ \u79cd\u989c\u8272\uff0c\u6bcf\u79cd\u6709 $c_i$ \u4e2a\uff0c$\\displaystyle n=\\sum_{i=1}^tc_i$   \n\u73b0\u5728\u5c06\u4e00\u4e2a\u957f\u5ea6\u4e3a $n$ \u7684\u5e8f\u5217\u67d3\u8272\uff0c\u9996\u5c3e\u76f8\u63a5\u5f62\u6210\u4e00\u4e2a\u73af\u3002  \n\u5bf9\u4e8e\u4e00\u4e2a\u73af\u7684\u6240\u6709\u6781\u957f\u8fde\u7eed\u989c\u8272\u6bb5 $l_1,l_2\\cdots l_s$ \u5b9a\u4e49\u6743\u503c\u4e3a $\\displaystyle \\prod_{i=1}^sf(l_i)$  \n\u6c42\u6bcf\u79cd\u67d3\u8272\u65b9\u6848\u7684\u6743\u503c\u4e4b\u548c\uff0c\u6ce8\u610f\u4e24\u79cd\u65b9\u6848\u4e0d\u540c\u7531\u67d3\u6210\u7684\u5e8f\u5217\u51b3\u5b9a\u3002  \n\n## $\\text{Step 1}$\n\n\u7531\u4e8e\u6781\u957f\u8fde\u7eed\u6bb5\u4e0d\u597d\u5904\u7406\uff0c\u8003\u8651\u76f8\u540c\u7684\u4e00\u6bb5\u5f53\u6210\u51e0\u6bb5\u6765\u7b97\u7684\u65b9\u6848\u3002\n\n\u8bbe\u8fd9\u6837\u7b97\u4e00\u4e2a\u76f8\u540c\u989c\u8272\u6bb5\u957f\u5ea6\u4e3a $l$ \u65f6\u8ba1\u5165\u7684\u662f $a_l$\uff0c\u8bbe $\\displaystyle A(x)=\\sum_{n\\geq 1}a_nx^n$\u3002\n\n\u90a3 $\\displaystyle \\sum_{k\\geq 1}\\sum_{\\sum\\limits_{i=1}^kn_i=l}\\prod_{i=1}^{k}a_{n_i}=f(l)$\uff0c\u7b2c\u4e00\u4e2a $k$ \u679a\u4e3e\u5206\u6210\u51e0\u6bb5\uff0c\u540e\u9762\u7684 $n_i$ \u4ee3\u8868\u5206\u6210\u7684\u6bcf\u4e00\u6bb5\u3002\n\n\u7531\u4e8e\u662f\u6392\u6210\u4e00\u6bb5\uff0c\u6240\u4ee5\u8fd9\u91cc\u8981**\u533a\u5206\u5148\u540e**\u7684 $n_i$ \u679a\u4e3e\u987a\u5e8f\u3002\n\n\u5bf9\u4e24\u8fb9\u5173\u4e8e $l$ \u751f\u6210\u6709 $\\displaystyle \\sum_{k\\geq 1}A^k(x)=\\sum_{l\\geq 1}f(l)x^l$\uff0c\u6240\u4ee5 $\\dfrac{A(x)}{1-A(x)}=F(x)$\n\n\u63a5\u4e0b\u6765\u5148\u5bf9\u6bcf\u4e2a\u989c\u8272\u5355\u72ec\u8003\u8651\uff0c\u4e4b\u540e\u518d\u60f3\u5982\u4f55\u5408\u5e76\u3002\n\n\u8bbe\u8be5\u989c\u8272\u4e3a $p,m\\!=\\!c_{p}$\n\n## $\\text{Step 2.1}$\n\n\u5148\u8003\u8651\u4e00\u4e2a\u5e8f\u5217\u800c\u975e\u73af\u3002\n\n\u8bbe\u8fd9\u4e2a\u989c\u8272\u989c\u8272\u88ab\u5206\u6210\u4e86 $k$ \u6bb5\uff0c\u8fd9 $k$ \u4e2a\u90e8\u5206**\u4e0d\u533a\u5206\u5148\u540e\u987a\u5e8f**\u3002\n\n\u90a3\u8d21\u732e\u5c31\u662f $\\dfrac{\\left[x^m\\right]A^k(x)}{k!}$\uff0c\u540e\u9762\u9664\u7684\u9636\u4e58\u5c31\u662f\u4e0d\u533a\u5206\u987a\u5e8f\u3002\n\n\u518d\u8bbe $\\displaystyle F_P(x)=\\sum_{k\\geq 1}\\dfrac{\\left[x^m\\right]A^{k}(x)}{k!}y^k$\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u5173\u4e8e\u6bb5\u6570\u7684 $\\text{OGF}$\u3002\n\n\u5173\u4e8e\u6bb5\u6570\u662f\u4e3a\u4e86\u6700\u7ec8\u6bcf\u4e00\u6bb5\u7684\u987a\u5e8f\u533a\u5206\uff0c\u800c\u4e00\u4e2a\u989c\u8272\u6bb5\u7684\u5185\u90e8\u6807\u53f7\u5fc5\u5b9a\u8fde\u7eed\uff0c\u53ea\u9700\u6d89\u53ca $\\text{OGF}$ \u3002\n\n## $\\text{Step 2.2}$\n\n\u73b0\u5728\u518d\u8003\u8651\u73af\u3002\n\n\u94a6\u5b9a\u73af\u8d77\u59cb\u7684\u7b2c\u4e00\u6bb5\u662f\u8be5\u989c\u8272 $p$ \u7684\u6bb5\uff0c\u957f\u5ea6\u4e3a $l$\u3002\n\n\u90a3\u8fd9\u4e2a\u73af\u5c31\u80fd\u88ab\u7b97\u5165 $l$ \u6b21\u3002\n\n\u9664\u4e86\u5f00\u5934\u7684\u7b2c\u4e00\u6bb5\uff0c\u800c\u5176\u4ed6\u6bb5\u4f9d\u7136**\u4e0d\u533a\u5206\u5148\u540e\u987a\u5e8f**\u3002\n\n\u56e0\u6b64\u8fd9\u4e2a\u989c\u8272\u6709 $k$ \u6bb5\u65f6\u8d21\u732e\u662f $\\dfrac{\\left[x^m\\right]A^{k-1}(x)\\ xA'(x)}{(k-1)!}$\u3002\n\n\u53ef\u4ee5\u7406\u89e3\u4e3a\u5148\u7b97\u7b2c\u4e00\u4e2a\u6bb5\uff0c$xA'(x)$ \u5c31\u662f\u5bf9\u5e94\u7cfb\u6570\u4e58\u4e86 $l$\uff0c\u540e\u9762 $k\\!-\\!1$ \u6bb5\u4ecd\u8981\u9664\u53bb\u987a\u5e8f\u3002\n\n\u5c1d\u8bd5\u5316\u7b80\u4e00\u4e0b\u4e0a\u5f0f\u7684\u53d6\u7cfb\u6570\uff1a\n\n$$\\left[x^m\\right]A^{k-1}(x)\\ xA'(x)=\\left[x^{m-1}\\right]\\dfrac{1}{k}\\left(A^{k}(x)\\right)'=\\dfrac{m}{k}\\left[x^m\\right]A^k(x)$$\n\n\u6b64\u65f6\u4ee5\u989c\u8272 $p$ \u4e3a\u8d77\u59cb\uff0c\u73af\u4e0a\u7684 $\\text{OGF}$ \u8bbe\u4e3a $\\displaystyle T_p(x)=\\sum_{k\\geq 1}\\dfrac{\\left[x^m\\right]A^{k-1}(x)\\ xA'(x)}{(k-1)!}y^k$\u3002\n\n\u4ee3\u5165\u4e0a\u9762\u7684\u5316\u7b80\u5f97\u5230 $\\displaystyle T_p(x)=\\sum_{k\\geq 1}\\dfrac{\\left[x^m\\right]A^k(x)}{(k-1)!}\\dfrac{m}{k}y^k=m\\sum_{k\\geq 1}\\left[x^m\\right]A^k(x)\\dfrac{y^k}{k!}=mF_p(x)$\n\n## $\\text{Step 3}$\n\n\u5148\u5728\u9700\u8981\u628a\u6240\u6709\u7684\u989c\u8272\u62fc\u8d77\u6765\u3002\n\n\u8fd9\u6837\u8bbe $g_i$ \u4e3a\u8f6c\u5316\u540e\uff08\u6bcf\u4e00\u6bb5\u4e0d\u4e00\u5b9a\u662f\u6781\u957f\u989c\u8272\u6bb5\uff09\u4e00\u5171\u6709 $i$ \u6bb5\u7684\u6743\u503c\u4e4b\u548c\u3002\n\n\u5148\u4e0d\u8003\u8651\u989c\u8272\u6bb5\u7684\u6392\u5217\uff0c\u90a3\u6709 $\\displaystyle G(x)=\\sum_{i=1}^tT_i(x)\\prod_{1\\leq j\\leq t,i\\neq j}F_j(x)$\n\n\u6240\u4ee5 $\\displaystyle G(x)=\\prod_{i=1}^tF_j(x)\\left(\\sum_{i=1}^tc_i\\right)=n\\prod_{i=1}^tF_j(x)$\u3002\n\n\u53ef\u4ee5\u7406\u89e3\u4e3a $i$ \u8fd9\u4e2a\u989c\u8272\u72ec\u5360\u73af\u7684\u8d77\u59cb\u4f4d\u7f6e\uff0c\u540e\u9762\u7684\u989c\u8272\u53d8\u6210\u5e8f\u5217\u4e0a\u7684\u3002\n\n\u4f46\u662f\u8fd9\u4e9b\u7ec4\u6210\u7684\u6bb5\u8fd8\u53ef\u4ee5\u5404\u81ea\u4ea4\u6362\uff0c\u6210\u4e3a\u4e00\u4e2a\u73af\u6392\u5217\u7684\u4e2a\u6570\u3002\n\n\u6240\u4ee5\u7b54\u6848\u662f $\\displaystyle \\sum_{i=1}^n(i-1)!\\left[x^i\\right]G(x)$\n\n## $\\text{Step 4}$\n\n\u8fd9\u90e8\u5206\u7740\u91cd\u8bb2\u8ff0\u5982\u4f55\u5b9e\u73b0\u3002\n\n\u5728\u6c42\u51fa\u4e86 $F_p(x)$ \u4e4b\u540e\u53ea\u9700\u5206\u6cbb $\\text{NTT}$ \u5373\u53ef\u6c42\u51fa $G(x)$\u3002\n\n\u800c\u4e3a\u4e86\u6c42 $F_p(x)$ \u9700\u8981\u5bf9 $k\\!=1,\\cdots ,n$ \u77e5\u9053 $\\left[x^n \\right]A^k(x)$\u3002\n\n\u901a\u8fc7\u62c9\u683c\u6717\u65e5\u53cd\u6f14\u5f97\u5230\uff1a\n\n$$\\left[x^n\\right]A^k(x)\\!=\\!\\dfrac{1}{n}\\left[x^{n-1}\\right]kx^{k-1}\\left(\\dfrac{x}{B(x)}\\right)^n=\\dfrac{k}{n}\\left[x^{n-k}\\right]\\left(\\dfrac{x}{B(x)}\\right)^n$$\n\n\u5176\u4e2d $B(A(x))\\!=\\!x$\uff0c\u5373 $A(x)$ \u7684\u590d\u5408\u9006\u3002\n\n\u4e00\u822c\u60c5\u51b5\u4e0b\u901a\u8fc7\u4e4b\u524d\u63a8\u5bfc\u7684 $\\dfrac{A(x)}{1-A(x)}=F(x)$\uff0c\u5373\u53ef\u7b97\u51fa $B(x)$\u3002\n\n\u56de\u5230\u672c\u9898\u4e2d\uff0c$\\displaystyle f_l=l,F(x)=\\sum_{l\\geq 1}lx^l=\\dfrac{x}{(1-x)^2}$\n\n\u6240\u4ee5 $\\dfrac{A(x)}{1-A(x)}=\\dfrac{x}{(1-x)^2}$\uff0c\u56e0\u6b64 $\\dfrac{x}{1-x}=\\dfrac{B(x)}{(1-B(x))^2}$\n\n\u5316\u7b80\u4e00\u4e0b\u6709 $x+xB(x)^2=B(x)-xB(x)$\uff0c\u5df2\u7ecf\u80fd\u5206\u6cbb $\\text{FFT}$ \u6c42\u4e86\u3002\n\n\u5177\u4f53\u6765\u8bf4\u53ef\u4ee5\u8bbe $B(x)=xC(x)$\uff0c\u6709 $\\displaystyle \\sum_{i=0}^nc_ic_{n-i}=c_{n+1}+c_{n+2},c_0=1$\n\n\u4e8e\u662f\u53ef\u4ee5\u5728 $O(n\\log^2n)$ \u7684\u65f6\u95f4\u5185\u89e3\u51b3\u672c\u9898\uff0c\u74f6\u9888\u5728\u4e8e\u5206\u6cbb $\\text{FFT}$ \u4ee5\u53ca\u5206\u6cbb $\\text{NTT}$\u3002\n\n\u6ce8\u610f\u5230 $F_p(x)$ \u5e38\u6570\u9879\u4e3a $0$\uff0c\u6240\u4ee5\u53ef\u4ee5\u5148\u8ba1\u7b97 $\\dfrac{F_p(x)}{x}$ \u80fd\u7701\u4e00\u5b9a\u65f6\u95f4\uff0c\u4e5f\u65b9\u4fbf\u5199\u3002\n\n\u4ee3\u7801\uff1a\uff08\u4ec5\u4f9b\u53c2\u8003,~~\u5b9e\u9645\u63d0\u4ea4\u7684\u4ee3\u7801\u6bd4\u8fd9\u4efd\u4f18\u5316\u591a\u591a\u4e86~~\uff09\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nconst int N=2e6+10;\nconst int mod=998244353;\nconst int inv2=(mod+1)/2;\nchar ch;int T,ans;\nint n,k,m,nn,n_,x,y,res,wn,v;\nint n1;int invn,w,lgn;\nint nt[N],a[N],b[N],f[N],c[N];\nint rev[N],inv[N],fac[N],ifac[N];\nint invt[N],lnt[N],expt[N];\nint cdqa[N],cdqb[N],ab[N];\nint *q[N],_q[N<<1],*qq=_q;\nint *t[N<<1],_t[N<<4],*tt=_t,len[N<<1];\nint *pf[20],_pf[N<<1],*ppf=_pf;\ninline void read(int &x){\n\tx=0;ch=getchar();while(ch<47)ch=getchar();\n\twhile(ch>47)x=(x<<1)+(x<<3)+(ch^48),ch=getchar();\n}\nvoid write(int x){if(x>9)write(x/10);putchar(48|x%10);}\ninline void swap(int &x,int &y){x^=y^=x^=y;}\nvoid qpow(int x,int k){\n\tres=1;\n\twhile(k){\n\t\tif(k&1)res=1ll*res*x%mod;\n\t\tx=1ll*x*x%mod;k>>=1;\n\t}\n}\nvoid getinv(int n){\n\tregister int i;inv[0]=inv[1]=1;\n\tfor(i=2;i^n;++i)inv[i]=1ll*(mod-mod/i)*inv[mod%i]%mod;\n}\nvoid getfac(int n){\n\tregister int i;\n\tfor(ifac[0]=1,i=1;i^n;++i)ifac[i]=1ll*ifac[i-1]*inv[i]%mod;\n\tfor(fac[0]=1,i=1;i^n;++i)fac[i]=1ll*fac[i-1]*i%mod;\n}\nvoid getrev(int n){\n\tstatic int i;\n\tn1=1;while(n1<(n<<1))n1<<=1;w=n1>>1;\n\tfor(i=0;i^n1;++i)rev[i]=(rev[i>>1]>>1)|((i&1)?w:0);\n}\nvoid ntt_init(int n){\n\tregister int i,mid,j;n<<=1;\n\tfor(mid=1;mid<n;mid<<=1){\n\t\tqpow(3,(mod-1)/(mid<<1));\n\t\twn=res;nt[mid]=1;j=(mid<<1);\n\t\tfor(i=mid+1;i<j;++i)nt[i]=1ll*nt[i-1]*wn%mod;\n\t}\n}\ninline int add(int x,int y){return x+y>mod?x+y-mod:x+y;}\ninline int sub(int x,int y){return x>y?x-y:x-y+mod;}\nvoid ntt(int n,int *a,bool t){\n\tstatic int i,mid,j,k;\n\tfor(i=0;i^n;++i)if(i<rev[i])swap(a[i],a[rev[i]]);\n\tfor(mid=1;mid<n;mid<<=1){\n\t\tfor(j=0;j<n;j+=(mid<<1)){\n\t\t\tfor(k=0;k<mid;++k){\n\t\t\t\ty=1ll*nt[mid+k]*a[j+k+mid]%mod;\n\t\t\t\ta[j+k+mid]=sub(a[j+k],y);\n\t\t\t\ta[j+k]=add(a[j+k],y);\n\t\t\t}\n\t\t}\n\t}\n\tif(t){\n\t\tinvn=n+1>>1;for(i=1;i^invn;++i)swap(a[i],a[n-i]);\n\t\tfor(invn=inv[n],i=0;i^n;++i)a[i]=1ll*a[i]*invn%mod;\n\t}\n}\nvoid polyinv(int n,int *f,int *g){\n\tstatic int i;\n\tif(n==1)qpow(f[0],mod-2),g[0]=res;\n\telse {\n\t\tpolyinv(n+1>>1,f,g);\n\t\tgetrev(n);\n\t\tfor(i=0;i^n;++i)invt[i]=f[i];\n\t\tfor(i=n;i^n1;++i)invt[i]=0;\n\t\tntt(n1,invt,0);ntt(n1,g,0);\n\t\tfor(i=0;i^n1;++i)g[i]=1ll*sub(2,1ll*invt[i]*g[i]%mod)*g[i]%mod;\n\t\tntt(n1,g,1);for(i=n;i^n1;++i)g[i]=0;\n\t}\n}\nvoid polyln(int n,int *f,int *g){\n\tstatic int i;\n\tgetrev(n);\n\tfor(i=0;i^n;++i)lnt[i]=f[i],g[i]=0;\n\tfor(i=n;i^n1;++i)lnt[i]=g[i]=0;\n\tpolyinv(n,f,g);lnt[n-1]=0;\n\tfor(i=0;i<n;++i)lnt[i-1]=1ll*f[i]*i%mod;\n\tntt(n1,g,0);ntt(n1,lnt,0);\n\tfor(i=0;i<n1;++i)lnt[i]=1ll*lnt[i]*g[i]%mod;\n\tntt(n1,lnt,1);g[0]=0;\n\tfor(i=1;i<n;++i)g[i]=1ll*lnt[i-1]*inv[i]%mod;\n\tfor(i=n;i<n1;++i)g[i]=0;\n}\nvoid polyexp(int n,int *f,int *g){\n\tstatic int i;\n\tif(n==1)g[0]=1;\n\telse {\n\t\tpolyexp(n+1>>1,f,g);\n\t\tpolyln(n,g,expt);\n\t\tfor(i=0;i<n;++i)expt[i]=sub(f[i],expt[i]);\n\t\texpt[0]=add(expt[0],1);\n\t\tntt(n1,g,0);\n\t\tntt(n1,expt,0);\n\t\tfor(i=0;i<n1;++i)g[i]=1ll*g[i]*expt[i]%mod;\n\t\tntt(n1,g,1);\n\t\tfor(i=n;i<n1;++i)g[i]=0;\n\t}\n}\nvoid cdq(int l,int r,int d){\n\tstatic int i,n;\n\tif(l+1^r){\n\t\tint mid=(l+r)>>1;\n\t\tcdq(l,mid,d-1);\n\t\tn=r-l;\n\t\tif(l){\n\t\t\tfor(i=l;i^mid;++i)cdqa[i-l]=f[i];\n\t\t\tfor(i=0;i^n;++i)cdqb[i]=f[i];\n\t\t\tgetrev(n>>1);ntt(n1,cdqa,0);ntt(n1,cdqb,0);\n\t\t\tfor(i=0;i^n;++i)cdqa[i]=1ll*cdqa[i]*cdqb[i]%mod;\n\t\t\tntt(n1,cdqa,1);\n\t\t\tfor(i=mid;i^r;++i)f[i+1]=add(f[i+1],cdqa[i-l-1]*2%mod);\n\t\t\tfor(i=0;i^n;++i)cdqa[i]=cdqb[i]=0;\n\t\t}\n\t\telse {\n\t\t\tfor(i=0;i^mid;++i)cdqa[i]=cdqb[i]=f[i];\n\t\t\tgetrev(n>>1);\n\t\t\tntt(n1,cdqa,0);ntt(n1,cdqb,0);\n\t\t\tfor(i=0;i^n;++i)cdqa[i]=1ll*cdqa[i]*cdqb[i]%mod;\n\t\t\tntt(n1,cdqa,1);\n\t\t\tfor(i=mid;i^r;++i)f[i+1]=add(f[i+1],cdqa[i-1]);\n\t\t\tfor(i=0;i^n;++i)cdqa[i]=cdqb[i]=0;\n\t\t}\n\t\tcdq(mid,r,d-1);\n\t}\n\telse if(l)f[l]=sub(f[l],f[l-1]);\n}\nvoid work(int j){\n\tstatic int i;\n\tnn=c[j];q[j]=qq,qq+=nn;\n\tfor(i=0;i^nn;++i)a[i]=1ll*f[i]*nn%mod;\n\tpolyexp(nn,a,b);\n\tw=inv[nn];\n\tfor(i=0;i^nn;++i)q[j][i]=1ll*b[nn-i-1]*ifac[i]%mod*w%mod;\n\tfor(i=0;i^nn;++i)a[i]=b[i]=0;\n}\n#define ls k<<1\n#define rs k<<1|1\nvoid pre_solve(int l,int r,int k){\n\tif(l^r){\n\t\tint mid=(l+r)>>1;\n\t\tlen[k]=b[r]-b[l-1]+1;\n\t\tt[k]=tt,tt+=len[k];\n\t\tpre_solve(l,mid,ls);\n\t\tpre_solve(mid+1,r,rs);\n\t}\n\telse t[k]=q[l],len[k]=b[l]-b[l-1]+1;\n}\nvoid solve(int l,int r,int k){\n\tif(l^r){\n\t\tstatic int i;\n\t\tint mid=(l+r)>>1;\n\t\tsolve(l,mid,ls);\n\t\tsolve(mid+1,r,rs);\n\t\tfor(i=0;i^len[ls];++i)a[i]=t[ls][i];\n\t\tfor(i=0;i^len[rs];++i)b[i]=t[rs][i];\n\t\tgetrev(len[k]+1>>1);\n\t\tntt(n1,a,0);ntt(n1,b,0);\n\t\tfor(i=0;i^n1;++i)a[i]=1ll*a[i]*b[i]%mod,b[i]=0;\n\t\tntt(n1,a,1);for(i=len[k];i^n1;++i)a[i]=0;\n\t\tfor(i=0;i^len[k];++i)t[k][i]=a[i];\n\t\tfor(i=0;i^len[k];++i)a[i]=b[i]=0;\n\t}\n}\nmain(){\n\tread(m);register int i;\n\tfor(i=1;i<=m;++i)read(c[i]),n+=c[i];\n\tgetinv(n<<2);ntt_init(n<<1);\n\tn=0;for(i=1;i<=m;++i)n=max(n,c[i]);\n\tnn=1;lgn=0;while(nn<n)nn<<=1,++lgn;\n\tf[0]=1;cdq(0,nn,lgn);\n\tfor(i=n;i^nn;++i)f[i]=0;\n\tpolyln(n,f,a);\n\tf[0]=0;for(i=1;i^n;++i)f[i]=sub(0,a[i]),a[i]=0;\n\tn=0;for(i=1;i<=m;++i)n+=c[i];getfac(n);\n\tfor(i=1;i<=m;++i)work(i);\n\tfor(i=1;i<=m;++i)b[i]=c[i]-1,b[i]+=b[i-1];\n\tpre_solve(1,m,1);\n\tfor(i=0;i<=n;++i)a[i]=b[i]=0;\n\tsolve(1,m,1);\n\tfor(i=m;i<=n;++i)ans=add(ans,1ll*_t[i-m]*fac[i-1]%mod);\n\twrite(1ll*ans*n%mod);\n}\n```",
        "postTime": 1642507707,
        "uid": 334380,
        "name": "Y_B_X",
        "ccfLevel": 7,
        "title": "\u9898\u89e3[P6151\u9752\u6625\u732a\u5934\u5c11\u5e74\u4e0d\u4f1a\u68a6\u5230\u5154\u5973\u90ce\u5b66\u59d0]"
    }
]