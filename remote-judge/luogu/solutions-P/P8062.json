[
    {
        "content": "> \u7ed9\u5b9a $n$ \u548c\u957f\u5ea6\u4e3a $n$ \u7684\u6392\u5217 $p$\uff0c\u548c $m$ \u4e2a\u957f\u5ea6\u4e3a $2$ \u7684\u4e32\uff0c\u548c\u4e00\u4e2a\u5e8f\u5217 $s$\uff0c\u6c42\u6709\u591a\u5c11\u957f\u5ea6\u4e3a $n$ \u7684\u5e8f\u5217 $a$\uff0c\u4f7f\u5f97 $a_i \\in \\{1,2,3\\}$\uff0c$a$ \u4e2d\u4e0d\u5b58\u5728 $m$ \u4e2a\u5b50\u4e32\uff0c\u5e76\u4e14\u6c42\u51fa\u5e8f\u5217 $b$ \u4f7f\u5f97 $b_i = a_{p_i}$\uff0c\u6ee1\u8db3 $b$ \u7684\u5b57\u5178\u5e8f\u5c0f\u4e8e $s$\u3002\u5bf9 $10 ^ 9 + 7$ \u53d6\u6a21\u3002\n\n\u5bf9\u4e8e\u5b50\u4e32\u7684\u9650\u5236\uff0c\u6211\u4eec\u4ece $1\\to n$ \u4f9d\u6b21\u586b\u6570\uff0c\u7b80\u5355 DP \u5373\u53ef\u89e3\u51b3\u95ee\u9898\u3002\n\n\u5bf9\u4e8e\u5b57\u5178\u5e8f\u9650\u5236\uff0c\u6211\u4eec\u6309 $p$ \u4f9d\u6b21\u586b\u6570\uff0c\u7b80\u5355 DP \u5373\u53ef\u89e3\u51b3\u95ee\u9898\u3002\n\n\u73b0\u5728\u540c\u65f6\u8003\u8651\u4e24\u4e2a\u9650\u5236\u3002\u6211\u4eec\u8003\u8651\u8f6c\u5316\u4e00\u4e0b\u5b57\u5178\u5e8f\u9650\u5236\u3002\u6211\u4eec\u679a\u4e3e\u7b2c\u4e00\u4e2a $<s$ \u7684\u4f4d $k$\uff0c\u90a3\u4e48 $<k$ \u7684\u4f4d\u7f6e\u90fd\u5fc5\u987b\u7b49\u4e8e $s$\uff0c\u7b49\u4e8e $k$ \u7684\u4f4d\u7f6e\u5fc5\u987b\u5c0f\u4e8e $s$\uff0c\u5176\u4f59\u4f4d\u7f6e\u53ef\u4ee5\u968f\u4fbf\u586b\u3002\n\n\u90a3\u4e48\u6211\u4eec\u4f9d\u6b21\u679a\u4e3e $k$\uff0c\u6bcf\u6b21\u53ea\u4f1a\u6709\u4e24\u4e2a\u4f4d\u7f6e\u7684\u9650\u5236\u53d1\u751f\u53d8\u5316\u3002\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u7b80\u5355\u7ebf\u6bb5\u6811\u7ef4\u62a4\u77e9\u9635\u4f18\u5316 DP \u5373\u53ef\u3002\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(27N\\log N)$\u3002\n\n```cpp\n#define N 400005\nint p[N], n, m; char s[N];\nstruct mat{\n\tint a[3][3];\n\tmat(){memset(a, 0, sizeof(a));}\n\tvoid init(){\n\t\tmemset(a, 0, sizeof(a));\n\t\ta[0][0] = a[1][1] = a[2][2] = 1;\n\t}\n\tvoid out(){\n\t\tel;\n\t\trep(i, 0, 2){rep(j, 0, 2)printf(\"%d \", a[i][j]); el;}\n\t}\n}b;\nmat operator*(mat a, mat b){\n\tmat c;\n\trep(i, 0, 2)rep(k, 0, 2)rep(j, 0, 2)c.a[i][j] = (c.a[i][j] + a.a[i][k] * (LL)b.a[k][j]) % P;\n\treturn c;\n};\nmat a[N << 2], u[N];\n#define ls (x << 1)\n#define rs (ls | 1)\nvoid build(int x,int l,int r){\n\tif(l == r)a[x] = u[l];\n\telse{\n\t\tint mid = (l + r) >> 1;\n\t\tbuild(ls, l, mid), build(rs, mid + 1, r);\n\t\ta[x] = a[ls] * a[rs];\n\t}\n}\nvoid ins(int x,int l,int r,int pos,mat w){\n\tif(l == r)a[x] = w;\n\telse{\n\t\tint mid = (l + r) >> 1;\n\t\tif(mid >= pos)ins(ls, l, mid, pos, w);\n\t\telse ins(rs, mid + 1, r, pos, w);\n\t\ta[x] = a[ls] * a[rs];\n\t}\n}\nint ans;\nvoid calc(int i){\n\tif(i > 1){\n\t\tint x = p[i - 1], op = s[x] - '1'; mat c = u[x];\n\t\trep(l, 0, 2)rep(r, 0, 2)if(r != op)c.a[l][r] = 0;\n\t\tins(1, 1, n, x, c);\n\t}\n\tint x = p[i], op = s[x] - '1'; mat c = u[x];\n\trep(l, 0, 2)rep(r, 0, 2)if(r >= op)c.a[l][r] = 0;\n\tins(1, 1, n, x, c);\n\trep(r, 0, 2)ad(ans, a[1].a[0][r]);\n}\nint main() {\n\tread(n);\n\trp(i, n)read(p[i]);\n\tread(m);\n\trep(i, 0, 2)rep(j, 0, 2)b.a[i][j] = 1;\n\tu[1] = b;\n\trp(i, m){\n\t\tchar op[5];\n\t\tscanf(\"%s\", op);\n\t\tb.a[op[0] - '1'][op[1] - '1'] = 0;\n\t}\n\trep(i, 2, n)u[i] = b;\n\tscanf(\"%s\", s + 1);\n\tbuild(1, 1, n);\n\trp(i, n)calc(i);\n\tad(ans, 1);\n\tprintf(\"%d\\n\", ans);\n\treturn 0;\n}\n```\n\n",
        "postTime": 1658214804,
        "uid": 119261,
        "name": "7KByte",
        "ccfLevel": 0,
        "title": "\u3010\u9898\u89e3\u3011[BalkanOI 2012] handsome"
    }
]