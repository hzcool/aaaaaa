[
    {
        "content": "\u6211\u4eec\u8003\u8651\u5982\u4f55\u8ba1\u7b97\u4e00\u4e2a\u96c6\u5408 $S$ \u7684 $W$ \u503c\uff0c\u4efb\u9009\u4e00\u6839\uff0c\u6211\u4eec\u8bb0 $a(x)$ \u4e3a $x$ \u5b50\u6811\u5185\u8def\u5f84\u80fd\u8fbe\u5230\u7684\u6700\u5927 $W$ \u503c\uff0c\u8f6c\u79fb\u662f\n\n$$a(x) = \\max \\left\\{\\sum_{y\\in \\mathrm{child}(x)} a(y)\\right\\} \\cup \\left\\{ w + \\sum_{z | \\mathrm{parent}(z) \\in \\mathrm{path}(u, v) \\wedge z \\notin \\mathrm{path}(u,v)} \\middle| (u, v, w) \\in S \\wedge \\mathrm{lca}(u, v) = x\\right\\} $$\n\n\u8fd9\u592a\u9ebb\u70e6\u4e86\uff0c\u8003\u8651\u5dee\u5206 $b(x) = a(x) - \\sum_{y\\in \\mathrm{child}(x)} a(y)$\uff0c\u4e0d\u96be\u5f97\u5230\u8f6c\u79fb\u4e3a\n\n$$ b(x) = \\max \\{0\\} \\cup \\left\\{w - \\sum_{z | z\\in \\mathrm{path}(u, v) \\backslash \\{x\\}} b(z) \\middle| (u, v, w)\\in S \\wedge \\mathrm{lca}(u, v) = x \\right\\} $$\n\n\u800c $a(x) = \\sum_{y\\in \\mathrm{subtree}(x)} b(y)$\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6811\u72b6\u6570\u7ec4\u7ef4\u62a4\u5728 $\\Theta((n + m)\\log n)$ \u65f6\u95f4\u5185\u8ba1\u7b97\u51fa $b(x)$ \u7684\u6240\u6709\u503c\u3002\u800c $W(S) = a(\\mathrm{root}) = \\sum_{x=1}^n b(x)$\u3002\n\n\u6ce8\u610f\u5230\u5982\u679c $(u, v)$ \u7ecf\u8fc7\u6839\uff0c\u90a3\u4e48 $f(u, v) = \\sum_{x\\in \\mathrm{path}(u, v)} b(x)$\u3002\n\n\u73b0\u5728\u6211\u4eec\u5f97\u5230\u4e86\u4e00\u4e2a $\\Theta(n^2\\log n)$ \u7684\u7b97\u6cd5\u3002\n\n\u63a5\u4e0b\u6765\u8003\u8651\u6362\u6839\u65f6\u6bcf\u4e2a DP \u503c\u7684\u53d8\u5316\uff0c\u6ce8\u610f\u5230\u6bcf\u4e2a\u70b9 $x$ \u7684 DP \u503c\u6709 $\\deg(x) + 1$ \u79cd\u60c5\u51b5\uff0c\u5373\uff1a\u4ed6\u662f\u6839\u6216\u8005\u6839\u5728\u5b83\u67d0\u4e2a\u5b69\u5b50\u65b9\u5411\u7684\u5b50\u6811\u91cc\u3002\n\n\u6211\u4eec\u7528 $c(x)$ \u8868\u793a $x$ \u7684\u5f53\u524d\u6839\u60c5\u51b5\u4e0b\u7684\u7236\u4eb2\u5728\u6839\u6362\u5230 $x$ \u7684\u5b50\u6811\u91cc\u65f6\u5019 $x$ \u7684\u7236\u4eb2\u7684 DP \u503c\u3002\u7528 $d(x)$ \u8868\u793a $x$ \u4f5c\u4e3a\u6839\u7684\u65f6\u5019\u7684 DP \u503c\u3002\n\n\u9996\u5148\u8003\u8651 $c,d$ \u503c\u5c06\u4f1a\u5982\u4f55\u88ab\u8ba1\u7b97\uff1a\n\n\u6211\u4eec\u81ea\u9876\u5411\u4e0b\u7ef4\u62a4\u6bcf\u4e2a\u8282\u70b9\u7684 $c$ \u503c\uff0c\u6bcf\u6761\u7a7f\u8fc7 $x$ \u7684\u7236\u4eb2\u800c\u4e0d\u7a7f\u8fc7 $x$ \u7684\u8282\u70b9\u4f1a\u5bf9 $c(x)$ \u6709\u8d21\u732e\uff0c\u5177\u4f53\u8d21\u732e\u662f\uff1a\u5728\u4ece $x$ \u7684\u7236\u4eb2\u5411\u4e0b\u8d70\u7684\u90e8\u5206\u53d6\u90a3\u4e9b\u8282\u70b9\u7684 $b$ \u503c\uff0c\u5411\u4e0a\u8d70\u7684\u90e8\u5206\u53d6 $c$ \u503c\uff08\u7531\u4e8e\u662f\u81ea\u9876\u5411\u4e0b\u7ef4\u62a4\uff0c\u8fd9\u4e2a\u65f6\u5019\u7956\u5148\u7684 $c$ \u5747\u5df2\u7ecf\u88ab\u8ba1\u7b97\u51fa\uff09\uff0c\u5728 $\\mathrm{lca}$ \u4f4d\u7f6e\u53d1\u751f\u62d0\u5f2f\u540e\u518d\u5411\u4e0b\u8d70\u7684\u5730\u65b9\u8fd8\u662f\u53d6 $b$ \u503c\u3002$d$ \u503c\u7684\u8ba1\u7b97\u65b9\u6cd5\u4e0e $c$ \u503c\u7c7b\u4f3c\uff0c\u4f46\u662f\u662f\u8003\u8651\u6240\u6709\u7a7f\u8fc7 $x$ \u7684\u8def\u5f84\u3002\n\n\u7531\u4e8e\u4e00\u6761\u8def\u5f84\u4f1a\u7a7f\u8fc7\u5f88\u591a\u70b9\uff0c\u66b4\u529b\u679a\u4e3e\u7a7f\u8fc7\u7684\u70b9\u5e76\u4e0d\u5408\u7406\u3002\u6211\u4eec\u8003\u8651\u901a\u8fc7\u6811\u7684\u91cd\u94fe\u5256\u5206\u7ed9\u7a7f\u8fc7\u7684\u8def\u5f84\u5206\u7c7b\u3002\u7531\u4e8e\u4e00\u6761\u8def\u5f84\u53ea\u4f1a\u7a7f\u8fc7 $O(\\log n)$ \u6761\u8f7b\u8fb9\uff0c\u6211\u4eec\u8003\u8651\u6bcf\u6b21\u6309\u7167\u81ea\u9876\u5411\u4e0b\u626b\u63cf\u6bcf\u4e00\u6761\u91cd\u8fb9\u7684\u987a\u5e8f\u8ba1\u7b97 $c,d$ \u503c\uff0c\u5728\u94fe\u4e0a\u6807\u8bb0\u65f6\u95f4\u6233\u8868\u793a\u6bcf\u6761\u4e0e\u8fd9\u6761\u91cd\u94fe\u6709\u4ea4\u7684\u8def\u5f84\u5728\u4ec0\u4e48\u65f6\u5019\u5f00\u59cb\u6216\u505c\u6b62\u8d21\u732e\uff0c\u6211\u4eec\u7528\u4e00\u4e2a\u5806\u6765\u7ef4\u62a4\u5f53\u524d\u7684\u6240\u6709\u8d21\u732e\uff0c\u6ce8\u610f\u5230\u5728\u91cd\u94fe\u4e0a\u5411\u4e0b\u8d70\u7684\u65f6\u5019\u6bcf\u6761\u8def\u5f84\u7684\u8d21\u732e\u4f1a\u96c6\u4f53\u51cf\u53bb\u4e0a\u4e00\u4e2a $b$ \u503c\u52a0\u4e0a\u4e0b\u4e00\u4e2a $c$ \u503c\uff0c\u6253\u4e00\u4e2a lazy \u5373\u53ef\u3002\u5bf9\u4e8e\u6bcf\u4e2a\u8def\u5f84\u8d70\u5411\u8f7b\u8fb9\u7684\u4f4d\u7f6e\uff0c\u628a\u8f7b\u513f\u5b50\u6392\u6210\u4e00\u884c\u540e\u6253\u6807\u673a\u7ef4\u62a4\u524d\u7f00\u540e\u7f00 $\\max$ \u5373\u53ef\uff0c\u4f46\u662f\u6bcf\u4e2a\u8def\u5f84\u7684 $\\mathrm{lca}$ \u4f4d\u7f6e\u53ef\u80fd\u662f\u3002\u65f6\u95f4\u590d\u6742\u5ea6 $\\Theta(m\\log^2 n)$\u3002\n\n\u8003\u8651\u5230\u4e00\u6761\u8def\u5f84\u5728\u9664\u4e86\u4e00\u6761\u91cd\u94fe\u4e0a\u662f\u5f71\u54cd\u4e3a\u65e0\u7279\u6b8a\u73b0\u5728\u7684\u533a\u95f4\uff0c\u5176\u4ed6\u5747\u4e3a\u94fe\u7684\u4e00\u4e2a\u524d\u7f00\uff0c\u5728\u524d\u7f00\u4e0a\u4ec5\u6807\u8bb0\u505a\u4e00\u904d\u540e\u7f00 $\\max$ \u5373\u53ef\u5c06\u8fd9\u90e8\u5206\u907f\u514d\u4f7f\u7528\u5806\u3002\u65f6\u95f4\u590d\u6742\u5ea6 $\\Theta(m\\log n)$\u3002\n\n\u5f97\u5230\u6240\u6709\u7684 $b, c, d$ \u503c\u540e\uff0c\u5f88\u5bb9\u6613\u4ee5\u6b64\u7b97\u51fa\u7b54\u6848\u3002\n",
        "postTime": 1573385196,
        "uid": 21423,
        "name": "Elegia",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P5642 \u3010\u4eba\u9020\u60c5\u611f\uff08emotion\uff09\u3011"
    },
    {
        "content": "### \u9898\u9762\n\n\u200b\t\u7ed9\u4f60\u4e00\u9897$ n $\u4e2a\u8282\u70b9\u7684\u6811\uff0c\u4ee5\u53ca$ m$\u6761\u8def\u5f84$ (u, v, w)$\uff0c\u5176\u4e2d$w$\u53ef\u4ee5\u8ba4\u4e3a\u662f$(u, v)$\u8fd9\u6761\u8def\u5f84\u7684\u6743\u503c\u3002\u4e00\u4e2a\u8def\u5f84\u96c6\u5408$S$\u7684\u6743\u503c$ W(S)$\u8bb0\u4e3a\uff1a\u627e\u51fa$ S$\u7684\u4e00\u4e2a\u6743\u503c\u4e4b\u548c\u6700\u5927\u7684\u5b50\u96c6\uff0c\u8be5\u5b50\u96c6\u6ee1\u8db3\u4efb\u4f55\u4e24\u6761\u8def\u5f84\u6ca1\u6709\u516c\u5171\u70b9\uff0c\u8fd9\u4e2a\u5b50\u96c6\u7684\u6240\u6709\u8def\u5f84\u6743\u503c\u4e4b\u548c\u5c31\u662f$ W(S)$\u3002\n\n\u200b\t\u8bb0$ F(u, v) = w$\u4e3a\u6700\u5c0f\u7684\u975e\u8d1f\u6574\u6570$ w$\uff0c\u4f7f\u5f97\u5bf9\u4e8e\u7ed9\u5b9a\u7684$ m$\u6761\u8fb9\u7ec4\u6210\u7684\u8def\u5f84\u96c6\u5408$ U$\uff0c$W(U \\cup \\{(u, v, w + 1)\\}) > W(U)$\u3002\n\n\u8bf7\u4f60\u8ba1\u7b97\u4e0b\u5f0f\uff0c\u5bf9$998244353$\u53d6\u6a21\u3002\n\n$$\n\\sum_{u=1}^n \\sum_{v=1}^n F(u, v)\n$$\n\n### \u9898\u89e3\n\n\u200b\t\u9996\u5148\u8981\u6c42\u51fa$W(U)$\uff0c\u6211\u4eec\u8bbe\n\n* $f_i$\u8868\u793a$i$\u53f7\u8282\u70b9**\u53ef\u7528\u53ef\u4e0d\u7528**\uff0c\u53ea\u5305\u542b$i$\u5b50\u6811\u5185\u7684\u70b9\u7684\u60c5\u51b5\u4e0b\u6700\u5927\u6743\u503c\u3002\n* $g_i$\u8868\u793a$i$\u53f7\u8282\u70b9**\u4e00\u5b9a\u4e0d\u7528**\uff0c\u53ea\u5305\u542b$i$\u5b50\u6811\u5185\u7684\u70b9\u7684\u60c5\u51b5\u4e0b\u6700\u5927\u6743\u503c\u3002\n* $c_i=g_i-f_i$\uff0c\u8868\u793a\u5728\u53ea\u5305\u542b$i$\u5b50\u6811\u5185\u7684\u70b9\u7684\u60c5\u51b5\u4e0b\uff0c\u5c06$i$\u53f7\u70b9\u7a7a\u51fa\u6765\u4e4b\u540e\u5e26\u6765\u7684\u8d21\u732e\u3002\n\n\u200b\t\u5c06\u6bcf\u6761\u8def\u5f84\u5b58\u5230$lca(u,v)$\u4e4b\u540e\uff0c\u6709\u8f6c\u79fb\uff1a\n$$\ng_x=\\sum_{y\\in son[x]}f_y\\\\\nf_x=g_x+max\\{w_j+\\sum_{k\\in path(u_j,v_j)}c_k\\}\\cup\\{0\\}\n$$\n\u200b\t\u53ef\u4ee5\u7528\u6811\u72b6\u6570\u7ec4\u7ef4\u62a4$\\sum_{k\\in path(u_j,v_j)}c_k$\uff0c\u800c\u4e0d\u662f\u6811\u5256\u3002\u5177\u4f53\u65b9\u6cd5\u662f\u5c06\u4e00\u6761\u8def\u5f84$(x,y)$\u5dee\u5206\u4e3a$(x,rt)+(y,rt)-(lca_{x,y},rt)-(fa_{lca_{x,y}})$\uff0c\u7136\u540e\u5c06\u5355\u70b9\u52a0\u5165\u6539\u4e3a\u5b50\u6811\u4fee\u6539\uff0c\u67e5\u8be2\u5230\u6839\u7684\u8def\u5f84\u6539\u4e3a\u5355\u70b9\u67e5\u8be2\u3002\u5f53\u7136\uff0c\u6ce8\u610f\u5230\u6b64\u65f6$(lca_{x,y},rt),(fa_{lca_{x,y}})$\u662f\u6ca1\u6709\u503c\u7684\uff0c\u53ef\u4ee5\u4f18\u5316\u6389\u3002\n\n\u200b\t\u6700\u540e$f_1$\u5c31\u662f$W(U)$\u3002\n\n\u200b\t\u4e4b\u540e\u8003\u8651\u5bf9\u6bcf\u4e00\u5bf9$(i,j)$\u6c42$F(i,j)$\u3002\u518d\u8bbe\n\n* $h_i$\u8868\u793a\u5728\u6ca1\u6709\u8def\u5f84\u4ece$i$\u7684\u7236\u4eb2\u63d2\u5165\u5230$i$\u7684\u60c5\u51b5\u4e0b\uff0c\u8003\u8651**\u6574\u68f5\u6811**\u7684\u70b9\u7684\u6700\u5c0f\u503c\u3002\n\n\u200b\t\u6b64\u65f6$F(i,j)=f_1-h_{lca_{i,j}}+\\sum_{k\\in path(i,j)}c_k$\uff0c\u8981\u7406\u89e3\u53ef\u4ee5\u5c06\u5f0f\u5b50\u6362\u4e00\u4e0b\uff1a$f_1=h_{lca_{i,j}}+F(i,j)-\\sum_{k\\in path(u_j,v_j)}c_k$\uff0c\u5373\u5982\u679c\u6211\u4eec\u8981\u8ba9\u8fd9\u6761\u8fb9\u5f3a\u5236\u88ab\u9009\uff0c\u90a3\u4e48\u5c31\u8981\u4fdd\u8bc1$(i,j)$\u8fd9\u6761\u8def\u5f84\u7a7a\u51fa\u6765\uff0c\u770b\u4f3c\u53ea\u9700\u8981\u7ba1$\\sum_{k\\in path(u_j,v_j)}c_k$\uff0c\u4f46\u5b9e\u9645\u4e0a\u6211\u4eec\u5728\u6c42$f_1$\u7684\u65f6\u5019\u662f\u53ef\u80fd\u5305\u542b\u90a3\u79cd\u4ece\u7236\u4eb2\u5230\u63d2\u4e0b\u6765\u7684\u8def\u5f84\uff0c\u800c$\\sum_{k\\in path(u_j,v_j)}c_k$\u662f\u4e0d\u5305\u542b\u8fd9\u79cd\u60c5\u51b5\u7684($f_i,g_i$\u90fd\u662f\u53ea\u5305\u542b\u4ee5$i$\u4e3a\u6839\u7684\u5b50\u6811)\uff0c\u6240\u4ee5\u5c31\u9700\u8981\u6c42\u51fa$h_{lca_{x,y}}$\n\n\u200b\t\u7136\u540e\u8003\u8651\u6c42$h_i$\uff0c\u6709\u4e24\u79cd\u8f6c\u79fb\u65b9\u6cd5\uff1a\n\n* $h_y=\\max\\{h_x+c_x\\}(y\\in son[x])$\n* \u5bf9\u4e8e\u4e00\u6761\u4ee5$x$\u4f5c\u4e3alca\u7684\u8def\u5f84$(u_j,v_j,w_j)$\uff0c\u5bf9\u4e8e\u8282\u70b9$y$\u6ee1\u8db3$fa_y\\in path(u_j,v_j)$\u4e14$y\\notin path(u_j,v_j)$\u7684\uff0c$h_y=\\max\\{h_x-\\sum_{k\\in path(u_j,v_j)}c_k+w_j\\}$\n\n\u200b\t\u89e3\u91ca\uff1a\n\n* \u5bf9\u4e8e\u7b2c\u4e00\u79cd\u8f6c\u79fb\uff0c\u8003\u8651\u5982\u679c$c_x$\u5c0f\u4e8e$0$\uff0c\u90a3\u5c31\u8868\u793a\u4e00\u5b9a\u6709\u4ee5$x$\u4e3alca\u7684\u8def\u5f84\u4ea7\u751f\u4e86\u8d21\u732e\uff0c\u800c\u4e00\u65e6\u4ea7\u751f\u4e86\u8d21\u732e\uff0c\u90a3\u4e48\u5bf9\u4e8ex\u7684\u513f\u5b50\u4e2d\u5728\u8be5\u8def\u5f84\u91cc\u7684(\u53ef\u80fd\u4e24\u4e2a\uff0c\u4e00\u4e2a\u6216\u8005\u6ca1\u6709)\uff0c\u7531\u4e8e\u4e0d\u80fd\u9009\u8fd9\u4e00\u6761\u8fb9\uff0c\u5176\u5bf9\u5e94\u8d21\u732e\u5c31\u8981$+c_x$\u3002\u4f46\u7531\u4e8e\u6211\u4eec\u4e0d\u77e5\u9053\u54ea\u4e9b\u513f\u5b50\u4f1a\u88ab$+c_x$\uff0c\u6211\u4eec\u5c31\u5e72\u8106\u7ed9\u6240\u6709\u513f\u5b50\u4fee\u6539\uff0c\u54ea\u4e9b\u88ab\u9519\u8bef\u4fee\u6539\u7684\u70b9\u76f8\u6bd4\u4e8e\u7b2c\u4e8c\u79cd\u8f6c\u79fb\u4e00\u5b9a\u4e0d\u4f18\uff0c\u6240\u4ee5\u6ca1\u6709\u5f71\u54cd\u3002\n* \u7b2c\u4e8c\u79cd\u8f6c\u79fb\uff0c\u5bf9\u4e8e\u4e00\u6761\u8def\u5f84\uff0c\u5f53\u6211\u4eec\u5f3a\u5236\u8fd9\u6761\u8def\u5f84\u88ab\u9009\u65f6\uff0c\u90a3\u4e9b\u7236\u4eb2\u5728\u8def\u5f84\u4e2d\u800c\u81ea\u5df1\u4e0d\u5728\u7684\u70b9\uff0c\u5176\u5b9e\u662f\u53ef\u4ee5\u4fdd\u8bc1\u6ca1\u6709\u8def\u5f84\u4ece\u4ed6\u7684\u7236\u4eb2\u63d2\u5165\u4ed6\u7684(\u5982\u679c\u6709\u5c31\u4e0d\u6ee1\u8db3\u8def\u5f84\u4e0d\u4ea4\u4e86)\u3002\u6b64\u65f6\u6211\u4eec\u5c31\u53ef\u4ee5\u66f4\u65b0$h_y$\n\n\u200b\t\u8003\u8651\u4f18\u5316\u7b2c\u4e8c\u79cd\u8f6c\u79fb\uff0c\u53d1\u73b0\u8fd9\u4e2a\u95ee\u9898\u548c[NOI2021] \u8f7b\u91cd\u8fb9]\u7684\u5904\u7406\u65b9\u6cd5\u5f88\u50cf\uff08\u5f53\u7136\u4e0d\u662f\u90a3\u4e9b\u6709\u7279\u5f02\u6027\u7684\u65b9\u6cd5\uff09\u8fd9\u91cc\u53d6\u5176\u4e2d\u4e00\u79cd\u7ed9\u4e00\u6761\u91cd\u94fe\u4e2d\u8f7b\u513f\u5b50\u8fde\u7eed\u6807\u53f7\u7684\u65b9\u6cd5\u3002\n\n\u200b\t\u5177\u4f53\u6765\u8bf4\u5c31\u662f\u5728\u7ed9\u4e00\u6761\u91cd\u94fe\u6807\u53f7\u4e4b\u540e\uff0c\u4ece\u4e0a\u5012\u4e0b\uff0c\u518d\u7ed9\u6bcf\u4e00\u4e2a\u91cd\u94fe\u4e0a\u7684\u70b9\u7684\u6240\u6709\u8f7b\u513f\u5b50\u6807\u4e2a\u53f7\u3002\u4f53\u73b0\u5728\u4ee3\u7801\u4e0a\u662f\u8fd9\u6837\uff1a\n\n```cpp\nvoid chuli(int x){\n\tint xx=x;\n\tif(x^1)x=son[x];\n\twhile(x){\n\t\tdfs2[x]=++dfss2,x=son[x];\n\t}\n\tx=xx;\n\twhile(x){\n\t\tst[x]=dfss2+1;\n\t\tfor(int i=h[x];i;i=a[i].ne){\n\t\t\tint y=a[i].y;\n\t\t\tif(y==fa[x]||y==son[x])continue;\n\t\t\tdfs2[y]=++dfss2;\n\t\t}\n\t\ten[x]=dfss2;\n\t\tx=son[x];\n\t}\n}\nvoid sous2(int x,int to){\n\tdfs1[x]=++dfss1;\n\ttop[x]=to;\n\tif(x==to)chuli(x);\n\tif(son[x])sous2(son[x],to);\n\tfor(int i=h[x];i;i=a[i].ne){\n\t\tint y=a[i].y;\n\t\tif(y==fa[x]||y==son[x])continue;\n\t\tsous2(y,y);\n\t}\n}\n```\n\n\u200b\t\u8fd9\u6837\u7684\u5904\u7406\u4e4b\u540e\uff0c\u53d1\u73b0\u91cd\u94fe\u4e0a\u8fde\u7eed\u4e00\u6bb5\u7684\u70b9\u7684\u8f7b\u513f\u5b50\u7684\u7f16\u53f7\u90fd\u662f\u8fde\u7eed\u7684\uff0c\u53ea\u6709\u91cd\u94fe\u7684\u94fe\u9876\u4e0d\u4f1a\u548c\u4e0b\u9762\u7684\u70b9\u7f16\u53f7\u8fde\u7eed\uff08\u5f53\u7136\u8fd9\u91cc\u4e0d\u9700\u8981\uff0c\u56e0\u4e3a\u5e76\u6ca1\u6709\u8981\u6211\u4eec\u5904\u7406\u91cd\u94fe\u4e0a\u7684\u70b9\uff09\u3002\n\n\u200b\t\u4e4b\u540e\u5c31\u662f\u5bf9\u4e00\u6761\u94fe\u8fdb\u884c\u5904\u7406\uff0c\u6709\u633a\u591a\u7ec6\u8282\u7684\uff1a\n\n* \u4ece\u4e00\u6761\u91cd\u94fe\u8df3\u5230\u4e0a\u9762\u7684\u91cd\u94fe\u4e4b\u540e\uff0c\u8be5\u94fe\u9876\u4e0d\u80fd\u88ab\u4e0a\u9762\u7684\u91cd\u94fe\u4fee\u6539\u8f7b\u513f\u5b50\u65f6\u4fee\u6539\u3002\n* \u4ece\u4e00\u6761\u91cd\u94fe\u8df3\u5230\u4e0a\u9762\u7684\u91cd\u94fe\u4e4b\u540e\uff0c\u8fd8\u8981\u4fee\u6539\u8df3\u91cd\u94fe\u4e4b\u540e\u7684\u90a3\u4e2a\u70b9\u7684\u91cd\u513f\u5b50\u3002\n\n\u200b\t\u6700\u540e\u5728\u6c42\u51fa$h_x$\u540e\uff0c\u53ea\u9700\u8981\u8003\u8651\u6709\u591a\u5c11\u5bf9$(i,j)$\uff0c\u6ee1\u8db3$lca_{i,j}=x$\uff0c\u5f53\u7136\uff0c\u8fd8\u8981\u7edf\u8ba1$c_i$\u4ea7\u751f\u7684\u8d21\u732e\uff0c\u9700\u8ba1\u7b97\u6709\u591a\u5c11\u5bf9$(i,j)$\uff0c\u6ee1\u8db3$(i,j)$\u8fd9\u6761\u8def\u5f84\u7ecf\u8fc7$x$\u3002\n\n```cpp\nvoid chuli2(int l,int mi1,int mi2,int r,ll z){\n\tif(l>r)return;\n\tif(mi2<mi1)swap(mi1,mi2);\n\tmi1=max(min(mi1,r+1),l-1);\n\tmi2=max(min(mi2,r+1),l-1);\n\tif(l<mi1)xds::change2(1,l,mi1-1,z,1,dfss2);\n\tif(mi1<mi2-1)xds::change2(1,mi1+1,mi2-1,z,1,dfss2);\n\tif(mi2<r)xds::change2(1,mi2+1,r,z,1,dfss2);\n}\nvoid chuli(int x,int y,ll z){\n\tint prx=0,pry=0;\n\twhile(top[x]^top[y]){\n\t\tif(de[top[x]]<de[top[y]])swap(x,y),swap(prx,pry);\n\t\tint fx=top[x];\n\t\tchuli2(st[fx],0,prx,en[x],z);\n\t\tprx=dfs2[fx];\n\t\tif(son[x])\n\t\t\txds::change2(1,dfs2[son[x]],dfs2[son[x]],z,1,dfss2);\n\t\tx=fa[fx];\n\t}\n\tif(de[x]>de[y])swap(x,y);\n\tchuli2(st[x],prx,pry,en[y],z);\n\tif(son[y])\n\t\txds::change2(1,dfs2[son[y]],dfs2[son[y]],z,1,dfss2);\n}\n```\n\n\u590d\u6742\u5ea6\u662f$O(m\\log^2n)$\u7684\u4f46\u51fa\u9898\u4eba\u6ca1\u6709\u5361\u6811\u5256\uff08\u5927\u6982\uff09\uff0c\u6240\u4ee5\u8fd8\u8dd1\u7684\u633a\u5feb\u7684\u3002",
        "postTime": 1635500928,
        "uid": 104696,
        "name": "\u51c9\u57ce\u7121\u611b",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P5642 \u4eba\u9020\u60c5\u611f\uff08emotion\uff09"
    },
    {
        "content": "\u819c\u62dc EI \u9e3d\u9e3d\uff01/\u5d07\u62dc\n\n\u7ed9\u4e00\u4e2a $O(m \\log^2n)$ \u7684\u6811\u5256\u505a\u6cd5\uff0c\u4e0d\u8fc7\u8dd1\u5f97\u597d\u50cf\u6bd4\u4e00\u4e9b 1log \u7684\u8981\u5feb\u4e00\u4e9b\uff08\u5927\u96fe\uff09\u3002\n\n\u8003\u8651\u5bf9\u4e8e\u7ed9\u5b9a\u7684\u96c6\u5408 $S$ \u6211\u4eec\u5982\u4f55\u6c42\u51fa $W(S)$\u3002\u8fd9\u5176\u5b9e\u662f\u4e00\u4e2a\u7ecf\u5178\u7684\u95ee\u9898\uff0c\u8fd9\u91cc\u5c31\u76f4\u63a5\u7ed9\u51fa\u505a\u6cd5\u4e86\u3002\u6211\u4eec\u8bbe\uff1a\n\n- $f_i$ \u8868\u793a\u53ea\u5305\u542b $i$ \u7684\u5b50\u6811\u5185\u7684\u70b9\u548c\u8def\u5f84\u65f6\u80fd\u5f97\u5230\u7684\u6700\u5927\u6743\u503c\uff1b\n\n- $g_i$ \u8868\u793a\u4e0d\u9009\u7ecf\u8fc7 $i$ \u7684\u8def\u5f84\u7684\u60c5\u51b5\u4e0b\uff0c\u53ea\u5305\u542b $i$ \u7684\u5b50\u6811\u5185\u7684\u70b9\u548c\u8def\u5f84\u65f6\u80fd\u5f97\u5230\u7684\u6700\u5927\u6743\u503c\uff1b\n\n- $c_i = g_i - f_i$\uff0c\u8fd9\u53ef\u4ee5\u7406\u89e3\u4e3a\u5c06 $i$ \u53f7\u70b9\u7a7a\u51fa\u6240\u9700\u7684\u4ee3\u4ef7\uff0c\u663e\u7136 $c_i \\leq 0$\u3002\n\n\u5bf9\u4e8e\u8def\u5f84 $(u,v)$ \u6211\u4eec\u5c06\u5b83\u5b58\u5230 $\\mathrm{lca}(u,v)$ \u5bf9\u5e94\u7684 vector \u91cc\uff0c\u6709\u8f6c\u79fb\uff1a\n\n$$g_u = \\sum_{v \\in son_u} f_v$$\n\n$$f_u = g_u + \\max\\{w_i + \\sum_{j \\in \\mathrm{path}(u_i,v_i)} c_j\\} \\ \\cup \\ \\{0\\}$$\n\n\u5bf9\u4e8e $\\sum_{j \\in \\mathrm{path}(u_i,v_i)} c_j$ \u53ef\u4ee5\u4f7f\u7528\u6811\u72b6\u6570\u7ec4\u4f18\u5316\uff0c\u5177\u4f53\u6765\u8bf4\u53ef\u4ee5\u5c06\u94fe\u6c42\u548c\u5dee\u5206\u6210\u70b9\u5230\u6839\u6c42\u548c\uff0c\u5355\u70b9\u52a0\u3001\u70b9\u5230\u6839\u6c42\u548c\u76f8\u5f53\u4e8e\u5b50\u6811\u52a0\u3001\u5355\u70b9\u6c42\u503c\uff0c\u53ef\u4ee5\u76f4\u63a5\u6811\u72b6\u6570\u7ec4\u3002\u5bf9\u521d\u59cb\u7684\u8def\u5f84\u96c6\u5408 $U$ \u505a\u4e00\u904d\u8fd9\u4e2a DP\uff0c\u90a3\u4e48 $W(U)$ \u7684\u503c\u5373\u4e3a $f_1$\u3002\n\n\u63a5\u7740\uff0c\u6211\u4eec\u8003\u8651\u5982\u4f55\u6c42\u51fa $W(U \\ \\cup \\ \\{u,v,w+1\\})$\u3002\u663e\u7136\uff0c\u82e5 $\\mathrm{lca}(u,v) = 1$\uff0c\u90a3\u4e48\u7b54\u6848\u5373\u4e3a $f_1 +\\sum_{j \\in \\mathrm{path}(u_,v_)} c_j\\ + (w+1)$\u3002\u4f46\u5982\u679c $\\mathrm{lca}(u,v)$ \u4e0d\u4e3a $1$\uff0c\u90a3\u4e48 $f_1$ \u6240\u5bf9\u5e94\u7684\u8def\u5f84\u96c6\u5408\u4e2d\u53ef\u80fd\u5b58\u5728\u67d0\u6761\u8def\u5f84\u4ece\u4e0a\u9762\u7a7f\u8fc7\u4e86 $\\mathrm{lca}(u,v)$\uff0c\u6211\u4eec\u5fc5\u987b\u60f3\u529e\u6cd5\u6d88\u9664\u6b64\u7c7b\u8def\u5f84\u5bf9\u7b54\u6848\u9020\u6210\u7684\u5f71\u54cd\u3002\u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u53e6\u8bbe $h_u$ \u8868\u793a\u4e0d\u5b58\u5728\u4e00\u6761\u8def\u5f84\u7ecf\u8fc7 $(u,fa_u)$ \u7684\u60c5\u51b5\u4e0b $f_1$ \u7684\u6700\u5927\u503c\u3002\u90a3\u4e48\u6709\u8f6c\u79fb\uff1a\n\n$$\n\\begin{cases}\nh_v \\leftarrow h_u + c_u, & \\text{$v \\in son_u$}\\\\\nh_v \\leftarrow h_u + \\sum_{j \\in \\mathrm{path}(u_i,v_i)} c_j + w_i,& \\text{$\\mathrm{lca}(u_i,v_i) = u, v \\notin \\mathrm{path}(u_i,v_i),fa_v \\in \\mathrm{path}(u_i,v_i)$}\n\\end{cases}\n\n$$\n\n\u5bf9\u8fd9\u4e24\u79cd\u8f6c\u79fb\u7684\u89e3\u91ca\uff1a\n\n- \u5bf9\u4e8e\u7b2c\u4e00\u79cd\u8f6c\u79fb\uff0c\u8003\u8651\u4ec0\u4e48\u65f6\u5019 $c_u <0$\uff0c\u663e\u7136\u8fd9\u610f\u5473\u7740\u6709\u67d0\u6761\u7a7f\u8fc7 $u$ \u7684\u8def\u5f84\u9020\u6210\u4e86\u8d21\u732e\u3002\u5047\u8bbe\u8fd9\u6761\u8def\u5f84\u5f80\u4e0b\u8d70\u5230\u4e86\u67d0\u4e2a\u513f\u5b50 $v$\uff0c\u90a3\u4e48\u5bf9\u4e8e $v$ \u6765\u8bf4\uff0c\u7531\u4e8e\u65ad\u6389\u4e86 $(u,v)$ \u8fd9\u6761\u8fb9\uff0c\u4e8e\u662f\u53ea\u597d\u8ba9 $u$ \u7a7a\u51fa\uff08\u8fd9\u9700\u8981\u4ed8\u51fa $c_u$ \u7684\u4ee3\u4ef7\uff09\u3002\u4f46\u5b9e\u9645\u4e0a\u6211\u4eec\u5e76\u4e0d\u77e5\u9053\u6709\u54ea\u4e9b\u513f\u5b50\u9700\u8981\u4ed8\u51fa\u8fd9\u4e2a\u4ee3\u4ef7\uff0c\u6211\u4eec\u4e0d\u59a8\u5bf9\u6240\u6709\u513f\u5b50\u90fd\u8fdb\u884c\u8fd9\u4e2a\u8f6c\u79fb\uff0c\u5bf9\u4e8e\u9519\u8bef\u8f6c\u79fb\u5230\u7684\u90a3\u4e9b\u70b9\u4e00\u5b9a\u4e0d\u4f1a\u4f18\u4e8e\u7b2c\u4e8c\u79cd\u8f6c\u79fb\uff0c\u6240\u4ee5\u5bf9\u7b54\u6848\u5e76\u6ca1\u6709\u5f71\u54cd\u3002\n\n- \u7b2c\u4e8c\u79cd\u8f6c\u79fb\u663e\u7136\u6ee1\u8db3\u8def\u5f84\u4e0d\u4ea4\uff0c\u6240\u4ee5\u4e00\u5b9a\u662f\u5408\u6cd5\u7684\u3002\n\n\u7b2c\u4e00\u79cd\u8f6c\u79fb\u76f4\u63a5\u505a\u5373\u53ef\uff1b\u4f46\u5bf9\u4e8e\u7b2c\u4e8c\u79cd\u8f6c\u79fb\uff0c\u5982\u679c\u6211\u4eec\u66b4\u529b\u679a\u4e3e\u6240\u6709\u8def\u5f84\u8fdb\u884c\u5224\u65ad\uff0c\u65f6\u95f4\u590d\u6742\u5ea6\u5c31\u8fbe\u5230\u4e86\u60ca\u4eba\u7684 $O(nm \\log n)$\uff0c\u56e0\u6b64\u6211\u4eec\u5e0c\u671b\u8f6c\u79fb\u7684\u8fc7\u7a0b\u4e2d\u4e0d\u4f1a\u679a\u4e3e\u5230\u4e0d\u5408\u6cd5\u7684\u8def\u5f84\u3002\u8003\u8651\u67d0\u4e00\u6761\u8def\u5f84 $(u_i,v_i)$\uff0c\u6211\u4eec\u53ef\u4ee5\u5728 $\\mathrm{lca}(u_i,v_i) = u$ \u5904\u7ed9 $(u_i,v_i)$ \u4e0a\u7684\u6240\u6709\u70b9\u6253\u4e0a $h_u + \\sum_{j \\in \\mathrm{path}(u_i,v_i)} c_j + w_i$ \u7684 tag\uff0c\u8f6c\u79fb\u7684\u65f6\u5019\u5c31\u76f4\u63a5\u628a tag \u4e0b\u4f20\u5230\u513f\u5b50\u53d6 $\\max$\uff0c\u4f46\u540c\u65f6\u4e0d\u80fd\u4f20\u5230\u8def\u5f84\u4e0a\u7684\u70b9\u3002\n\n\u5148\u8003\u8651\u4e00\u4e2a\u66b4\u529b\u7684\u7ef4\u62a4\uff0c\u6211\u4eec\u5bf9\u6bcf\u4e00\u4e2a\u70b9\u5f00\u4e00\u4e2a vector \u7ef4\u62a4\u5728\u5b83\u8eab\u4e0a\u7684 tag\uff0c\u6bcf\u4e2a tag \u90fd\u662f\u4e00\u4e2a\u5f62\u5982 $(w,a,b)$ \u7684\u4e09\u5143\u7ec4\uff0c\u8868\u793a\u6743\u503c\u4e3a $w$\uff0c\u5e76\u4e14\u4e0d\u80fd\u4f20\u5230 $a,b$ \u4e24\u4e2a\u513f\u5b50\uff08\u5982\u679c\u4e0d\u5b58\u5728\u8fd9\u4e48\u591a\u9650\u5236\u5c31\u5c06\u5269\u4e0b\u7684\u4f4d\u7f6e\u8d4b\u503c\u4e3a $0$\uff0c\u663e\u7136\u53ea\u6709\u5728 $\\mathrm{lca}$ \u5904 $a,b$ \u624d\u53ef\u80fd\u90fd\u4e0d\u4e3a $0$\uff09\u3002\u4e0b\u4f20\u6807\u8bb0\u65f6\u5148\u628a\u6240\u6709 tag \u6309\u6743\u503c\u4ece\u5927\u5230\u5c0f\u6392\u5e8f\uff0c\u5bf9\u4e8e\u6bcf\u4e2a\u513f\u5b50\u627e\u5230\u7b2c\u4e00\u4e2a\u53ef\u4ee5\u8f6c\u79fb\u7684 tag \u8fdb\u884c\u8f6c\u79fb\uff0c\u663e\u7136\u6bcf\u4e2a tag \u6700\u591a\u53ea\u4f1a\u88ab\u626b\u5230 $2$ \u904d\uff0c\u56e0\u6b64\u590d\u6742\u5ea6\u4e3a $O(\u6807\u8bb0\u6570)$\u3002\n\n\u4f46\u53ef\u60dc\u7684\u662f\uff0c\u5373\u4f7f\u907f\u514d\u4e86\u591a\u4f59\u7684\u679a\u4e3e\uff0c\u6807\u8bb0\u6570\u91cf\u4ecd\u7136\u53ef\u80fd\u5f88\u591a\uff0c\u65f6\u95f4\u590d\u6742\u5ea6\u5e76\u6ca1\u6709\u5b9e\u8d28\u4e0a\u7684\u4f18\u5316\u3002\u8fd8\u80fd\u518d\u7ed9\u529b\u70b9\u5417\uff1f\n\n\u5bf9\u7ed9\u5b9a\u7684\u6811\u8fdb\u884c\u8f7b\u91cd\u94fe\u5256\u5206\uff0c\u8fd9\u65f6\u6211\u4eec\u4f1a\u60ca\u559c\u5730\u53d1\u73b0\uff0c\u5927\u591a\u6570 tag \u90fd\u5f62\u5982 $(w,son_u,0)$ \uff08$son_u$ \u8868\u793a $u$ \u7684\u91cd\u513f\u5b50\uff09\uff0c\u53ea\u6709\u5728\u91cd\u94fe\u94fe\u5e95\uff0c\u5373\u8f7b\u91cd\u94fe\u5207\u6362\u7684\u5730\u65b9\u9700\u8981\u5355\u72ec\u8003\u8651\u3002\u5f53\u7136\uff0c\u8def\u5f84\u7aef\u70b9\u548c $\\mathrm{lca}$ \u4e0a\u7684 tag \u4e5f\u662f\u7279\u6b8a\u7684\u3002\u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u7ef4\u62a4\u6bcf\u4e2a\u70b9\u4e0a $(w,son_u,0)$ \u7684 tag \u7684\u6700\u5927 $w$ \u503c\uff0c\u8fd9\u53ea\u9700\u8981\u4f7f\u7528\u7ebf\u6bb5\u6811\u652f\u6301\u533a\u95f4\u53d6 $\\max$\uff0c\u5355\u70b9\u67e5\u8be2\u3002\u800c\u5bf9\u4e8e\u7279\u6b8a\u7684 tag \u5c31\u6309\u66b4\u529b\u7684\u65b9\u5f0f\u8fdb\u884c\u7ef4\u62a4\u5373\u53ef\u3002\u6bcf\u6761\u8def\u5f84\u81f3\u591a\u8d21\u732e $O(\\log n)$ \u4e2a tag\uff0c\u56e0\u6b64 tag \u603b\u6570\u662f $O(m \\log n)$ \u7684\u3002\n\n\u6c42\u51fa $h_u$ \u540e\uff0c\u663e\u7136\u6709 $f(u,v) = f_1 - h_{\\mathrm{lca}(u,v)} - \\sum_{j \\in \\mathrm{path}(u,v)} c_j$\u3002\u8003\u8651\u5982\u4f55\u5bf9\u6240\u6709 $f(u,v)$ \u6c42\u548c\uff0c\u663e\u7136\u6211\u4eec\u53ea\u9700\u8ba1\u7b97\u6bcf\u4e00\u9879\u7684\u8d21\u732e\uff0c\u5373\u5bf9\u6bcf\u4e2a\u70b9 $u$ \u6c42\u51fa\u6709\u591a\u5c11\u8def\u5f84\u7684 $\\mathrm{lca}$ \u6070\u4e3a $u$\uff0c\u4ee5\u53ca\u6709\u591a\u5c11\u8def\u5f84\u7a7f\u8fc7 $u$\uff0c\u7b80\u5355\u5bb9\u65a5\u5373\u53ef\u3002\n\n\u6ce8\u610f\u64cd\u4f5c\u987a\u5e8f\uff0c\u5148\u6253 tag \u540e\u8f6c\u79fb\u3002\u4ee3\u7801\u5199\u5f97\u6709\u70b9\u4e11\uff0c\u8c03\u8bd5\u61d2\u5f97\u5220\u4e86\u5c31\u8fd9\u6837\u5c06\u5c31\u770b\u770b\uff1f\n\n```cpp\nconst int MN = 4e5 + 5;\nconst int Mod = 998244353;\n\n// #define dbg\n\nint N, M, ans;\nvector <int> G[MN];\n\nstruct BIT {\n    int c[MN];\n    inline int lowbit(int x) {\n        return x & (-x);\n    }\n    inline void Modify(int x, int k) {\n        for (int i = x; i <= N; i += lowbit(i))\n            c[i] += k;\n    }\n    inline void Modify(int l, int r, int k) {\n        Modify(l, k), Modify(r + 1, -k);\n    }\n    inline int Query(int x) {\n        if (!x)\n            return 0;\n        int res = 0;\n        for (int i = x; i; i -= lowbit(i))\n            res += c[i];\n        return res;\n    }\n} T;\n\nint siz[MN], son[MN], dep[MN], fa[MN], fat[MN][25];\ninline void DFS0(int u, int pr) {\n    siz[u] = 1, fat[u][0] = pr;\n    dep[u] = dep[fa[u] = pr] + 1;\n    for (int i = 1; i <= 20; i++)\n        fat[u][i] = fat[fat[u][i - 1]][i - 1];\n    for (int v : G[u]) \n        if (v != pr) {\n            DFS0(v, u);\n            siz[u] += siz[v];\n            if (siz[v] > siz[son[u]])\n                son[u] = v;\n        }\n}\nint top[MN], dfn[MN], dfc, st[MN], ed[MN];\ninline void DFS1(int u, int tp) {\n    top[u] = tp;\n    dfn[u] = st[u] = ++dfc;\n    if (son[u]) {\n        DFS1(son[u], tp);\n        for (int v : G[u])\n            if (v != fa[u] && v != son[u]) \n                DFS1(v, v);\n    }\n    ed[u] = dfc;\n}\ninline int LCA(int x, int y) {\n    while (top[x] != top[y]) {\n        if (dep[top[x]] < dep[top[y]]) swap(x, y);\n        x = fa[top[x]];\n    }\n    if (dep[x] > dep[y]) swap(x, y);\n    return x;\n}\ninline int climb(int x, int y) {\n    for (int i = 20; ~i; i--)\n        if (dep[fat[x][i]] > dep[y]) x = fat[x][i];\n    return x;\n}\n\n#define PI3 pair < pii, int >\n#define mp3(x, y, z) mp(mp(x, y), z)\n\nint f[MN], g[MN], c[MN];\nvector <PI3> vr[MN];\ninline int Qry(int x, int y, int r) {\n    return T.Query(st[x]) + T.Query(st[y]) - T.Query(st[fa[r]]) - T.Query(st[r]);\n}\ninline void DFS2(int u) {\n    for (int v : G[u])\n        if (v != fa[u]) \n            DFS2(v), g[u] += f[v];\n    int del = 0;\n    for (auto [p, w] : vr[u]) {\n        del = max(del, Qry(p.fi, p.se, u) + w);\n#ifdef dbg\n        printf(\"Qry(%lld %lld) = %lld\\n\", p.fi, p.se, Qry(p.fi, p.se, u));\n#endif\n    }\n    f[u] = g[u] + del;\n    c[u] = g[u] - f[u];\n    T.Modify(st[u], ed[u], c[u]);\n}\n\nconst int MS = MN << 2;\n#define ls o << 1\n#define rs o << 1 | 1\n#define mid ((l + r) >> 1)\n#define LS ls, l, mid\n#define RS rs, mid + 1, r\nint tr[MS], tg[MS];\ninline void Mdf(int o, int l, int r, int L, int R, int v) {\n    if (r < L || l > R || L > R) return;\n    if (L <= l && R >= r) return tg[o] = max(tg[o], v), void();\n    Mdf(LS, L, R, v), Mdf(RS, L, R, v);\n}   \ninline int Qry(int o, int l, int r, int p) {\n    if (l == r) return tg[o];\n    return max(tg[o], p <= mid ? Qry(LS, p) : Qry(RS, p));\n}\n\nstruct Dat {\n    int w, a, b;\n    Dat() {}\n    Dat(int W, int X, int Y) : w(W), a(X), b(Y) {}\n    inline bool operator < (const Dat &p) const {\n        return w > p.w;\n    }\n};\nint h[MN];\nvector <Dat> tag[MN];\ninline void Cov(int x, int y, int w, int r) {\n    int u = x, v = y;\n    if (dep[x] < dep[y])\n        swap(x, y);\n    tag[x].pb(Dat(w, 0, 0));\n    if (y != r)\n        tag[y].pb(Dat(w, 0, 0));\n    while (top[x] != top[y]) {\n        if (dep[top[x]] < dep[top[y]]) \n            swap(x, y);\n        Mdf(1, 1, N, dfn[top[x]], dfn[fa[x]], w);\n        if (fa[top[x]] != r)\n            tag[fa[top[x]]].pb(Dat(w, top[x], 0));\n        x = fa[top[x]];\n    }\n    u = climb(u, r);\n    v = climb(v, r);\n    tag[r].pb(Dat(w, u, v));\n    if (x == y)\n        return;\n    if (dep[x] < dep[y]) \n        swap(x, y);\n    int p = climb(x, y);\n    Mdf(1, 1, N, dfn[p], dfn[fa[x]], w);\n}\ninline void DFS3(int u) {\n    for (auto [p, w] : vr[u]) {\n        int x = p.fi, y = p.se;\n        Cov(x, y, h[u] + Qry(x, y, u) + w, u);\n#ifdef dbg\n        printf(\"%lld : pushtag (%lld, %lld, %lld)\\n\", u, x, y, h[u] + Qry(x, y, u) + w);\n#endif\n    }\n    sort(tag[u].begin(), tag[u].end());\n    int w = Qry(1, 1, N, dfn[u]);\n    for (int v : G[u]) \n        if (v != fa[u]) {\n            h[v] = max(h[u] + c[u], 0);\n            if (v != son[u]) \n                h[v] = max(h[v], w);\n            for (auto tg : tag[u])\n                if (tg.a != v && tg.b != v) {\n                    h[v] = max(h[v], tg.w);\n                    break;\n                }\n            DFS3(v);\n        }\n}\n\nsigned main(void) {\n    N = read(), M = read();\n    for (int i = 1; i < N; i++) {\n        int u = read(), v = read();\n        G[u].pb(v), G[v].pb(u);\n    }\n    DFS0(1, 0);\n    DFS1(1, 1);\n    for (int i = 1; i <= M; i++) {\n        int x = read(), y = read(), w = read();\n        int r = LCA(x, y);\n#ifdef dbg\n    printf(\"LCA(%lld, %lld) = %lld\\n\", x, y, r);\n#endif\n        vr[r].pb(mp3(x, y, w));\n    }\n    DFS2(1);\n    h[1] = f[1];\n#ifdef dbg\n    puts(\"----------------\");\n#endif\n    DFS3(1);\n#ifdef dbg\n    puts(\"----------------\");\n    printf(\"maxW(U) = %lld\\n\", f[1]);\n    for (int i = 1; i <= N; i++)\n        printf(\"%lld : f = %lld, g = %lld, c = %lld, h = %lld\\n\", i, f[i], g[i], c[i], h[i]);\n    puts(\"----------------\");\n#endif\n    ans = f[1] % Mod * N % Mod * N % Mod;\n    for (int i = 1; i <= N; i++)\n        c[i] = Mod + c[i] % Mod, h[i] %= Mod;\n    for (int u = 1; u <= N; u++) {\n        int Coef = N * N % Mod;\n        Dec(Coef, (N - siz[u]) * (N - siz[u]) % Mod);\n        int w = 0;\n        for (int v : G[u])  \n            if (v != fa[u]) Add(w, siz[v] * siz[v] % Mod);\n        Dec(Coef, w);\n        Dec(ans, Coef * c[u] % Mod);\n        Coef = siz[u] * siz[u] % Mod;\n        Dec(Coef, w);\n        Dec(ans, Coef * h[u] % Mod);\n    }\n    printf(\"%lld\\n\", ans);\n    return 0; \n}\n```\n",
        "postTime": 1650942972,
        "uid": 246019,
        "name": "_came11ia_",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P5642 \u3010 \u4eba\u9020\u60c5\u611f\uff08emotion\uff09\u3011"
    },
    {
        "content": "\u6a21\u62df\u8d5b\u8003\u4e86\uff0c\u5bf9\u5c31\u662f\u8ba8\u8bba\u533a\u91cc\u5cf0\u5de8\u90a3\u4e2a\u3002\u4e3a\u4e86\u8ba2\u8fd9\u9898\u88ab\u521b\u4e86\u4e09\u5929\uff0c\u8ba2\u51fa\u6765\u4e86\u5199\u7bc7\u9898\u89e3\u56de\u9988\u793e\u4f1a\u3002\u819c\u62dc\u8bb2\u9898\u4eba [275307894a](/user/181766) /bx\u3002\n\n\u7701\u6d41\uff1a\u672c\u9898 $n,m$ \u540c\u9636\uff0c\u6b64\u6cd5\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal O(n\\log n)$\u3002**\u8bf7\u6ce8\u610f\u672c\u9898\u89e3\u4e2d\u90e8\u5206\u5b57\u6bcd\u7684\u542b\u4e49\u4e0e\u9898\u9762\u4e2d\u4e0d\u540c\u3002**\n\n------------\n\n\u9996\u5148\u8003\u8651\u5982\u4f55\u6c42 $W(U)$\u3002\u4e0d\u77e5\u9053\u8fd9\u7b97\u4e0d\u7b97\u7ecf\u5178\u95ee\u9898~~\u4f46\u4e0a\u6b21\u89c1\u5230\u662f\u5728\u6a21\u62df\u8d5b T2~~\u3002\n\n\u5bf9\u4e8e\u8def\u5f84 $(x,y,w)$\uff0c\u6211\u4eec\u628a\u5b83\u6302\u5728 $u=lca(x,y)$ \u4e0a\u3002\u8bbe $f_u$ \u8868\u793a\u4ec5\u8003\u8651 $u$ \u5b50\u6811\u4ee5\u5185\u6240\u5f97\u7684\u6700\u5927\u503c\uff0c$s_u=\\sum\\limits_{v\\in son_u}f_v$ \u8868\u793a\u4ec5\u8003\u8651 $u$ \u5b50\u6811\u4ee5\u5185\u4e14\u94a6\u5b9a $u$ \u4e0d\u88ab\u5360\u7528\u6240\u5f97\u7684\u6700\u5927\u503c\u3002\n\n\u5728 $f_v$ \u7684\u57fa\u7840\u4e0a $s_u$ \u663e\u7136\u6613\u6c42\uff0c\u8003\u8651\u5982\u4f55\u6c42 $f_u$\u3002\u82e5 $u$ \u4e0d\u88ab\u5360\u7528\u5219 $f_u=s_u$\uff0c\u82e5 $u$ \u88ab\u5360\u7528\uff0c\u7531\u4e8e\u4ec5\u8003\u8651 $u$ \u5b50\u6811\u5185\uff0c\u6240\u4ee5\u5360\u7528 $u$ \u7684\u8def\u5f84\u4e00\u5b9a\u6709 $lca(x,y)=u$\uff0c\u800c\u6211\u4eec\u5df2\u7ecf\u628a\u8fd9\u6837\u7684\u8def\u5f84\u6302\u5728\u4e86 $u$ \u4e0a\u3002\u82e5\u8981\u9009\u62e9\u8fd9\u4e00\u6761\u8def\u5f84\uff0c\u5219\u5bf9\u4e8e\u6bcf\u4e2a\u5728 $(x,y)$ \u8def\u5f84\u4e0a\u7684\u70b9 $z$\uff0c\u90fd\u4e8b\u5148\u4e0d\u80fd\u88ab\u5360\u7528\uff0c\u5426\u5219\u5c06\u4f1a\u5728\u8fd9\u91cc\u4ea7\u751f\u4e00\u4e2a\u4ea4\u3002\u6240\u4ee5\u6b64\u65f6\u6709 $f_u=w+s_u-\\sum\\limits_{z\\in path(x,y)}(f_z-s_z)$\u3002$f_u$ \u5728\u6240\u6709\u60c5\u51b5\u4e2d\u53d6 $\\max$ \u5373\u53ef\u3002\n\n\u8003\u8651\u5982\u4f55\u7ef4\u62a4\u4e0a\u5f0f\u4e2d\u7684\u548c\u53f7\u3002~~\u4f7f\u7528\u6811\u5256\u5957\u6570\u636e\u7ed3\u6784\u53ef\u4ee5\u505a\u5230 $\\mathcal O(n\\log^2n)$\uff08~~ \u4e8b\u5b9e\u4e0a\u5bf9\u4e8e\u6811\u4e0a\u7684{\u5355\u70b9/\u5b50\u6811/\u94fe}{\u52a0/\u6c42\u548c}\uff0c\u9664\u53bb\u5e73\u51e1\u7684\u5355\u70b9\u52a0\u5355\u70b9\u6c42\u503c\u3001\u975e\u5e73\u51e1\u7684\u94fe\u52a0\u94fe\u6c42\u548c\uff0c\u5176\u4f59\u60c5\u51b5\u90fd\u53ef\u4ee5\u76f4\u63a5\u6216\u95f4\u63a5\u5730\u7528\u6811\u72b6\u6570\u7ec4\u4ee5 $\\mathcal O(n\\log n)$ \u89e3\u51b3\u3002\u5177\u4f53\u5230\u672c\u9898\uff0c\u5c06\u548c\u53f7\u5185\u7684 $f_u-s_u$ \u89c6\u4f5c\u5355\u70b9\u52a0\u7684\u503c\u6765\u7ef4\u62a4\u5373\u53ef\u3002\u7531\u4e8e\u5728\u8ba1\u7b97 $f_u$ \u65f6 $u$ \u53ca $u$ \u7684\u7956\u5148\u5747\u672a\u88ab\u8ba1\u7b97\uff0c\u6240\u4ee5\u94fe\u6c42\u548c\u65f6\u65e0\u9700\u8003\u8651\u8fd9\u4e9b\u90e8\u5206\uff0c\u53ef\u4ee5\u6709\u6240\u7b80\u5316\u3002\n\n------------\n\n\u73b0\u5728 $f_1$ \u5373\u4e3a $W(U)$\uff0c\u53e6\u5916\u5728\u8ba1\u7b97 $f$ \u6570\u7ec4\u65f6\uff0c\u6211\u4eec\u628a\u8def\u5f84\u6743\u503c $w$ \u66f4\u65b0\u4e3a $w+s_u-\\sum\\limits_{z\\in path(x,y)}(f_z-s_z)$\uff0c\u6b64\u65f6\u5b83\u8868\u793a\u5728\u9009\u62e9\u8fd9\u6761\u8def\u5f84\u7684\u60c5\u51b5\u4e0b\uff0c\u4ec5\u8003\u8651 $u$ \u5b50\u6811\u4ee5\u5185\u6240\u5f97\u7684\u6700\u5927\u503c\u3002\n\n\u6211\u4eec\u518d\u8bbe $g_u$ \u8868\u793a\u4ec5\u8003\u8651 $u$ \u5b50\u6811\u7684\u8865\uff08\u5373\u6574\u68f5\u6811\u53bb\u6389 $u$ \u5b50\u6811\u7684\u90e8\u5206\uff09\u6240\u5f97\u7684\u6700\u5927\u503c\u3002\u663e\u7136 $g_1=0$\u3002\u5728\u8ba1\u7b97 $u$ \u7684\u513f\u5b50\u7684 $g$ \u503c\u4e4b\u524d\uff0c\u5148\u4ee4\u6302\u5728 $u$ \u4e0a\u7684\u8def\u5f84\u7684\u6743\u503c $w\\gets w+g_u$\uff0c\u6b64\u65f6\u8fd9\u4e00\u6743\u503c\u8868\u793a\u5728\u9009\u62e9\u8fd9\u6761\u8def\u5f84\u7684\u60c5\u51b5\u4e0b\u7684\u5168\u5c40\u6700\u5927\u503c\u3002\n\n\u8003\u8651\u5982\u4f55\u7531\u7236\u4eb2 $u$ \u5411\u513f\u5b50 $v$ \u9012\u63a8\u3002\u6839\u636e\u6240\u6c42\u7684\u5b9a\u4e49\uff0c$v$ \u7684\u5b50\u6811\u5185\u5916\u88ab\u4eba\u4e3a\u5206\u5272\uff0c\u6545\u6c42 $g_v$ \u65f6\u8fb9 $(u,v)$ \u4e0d\u80fd\u88ab\u5360\u7528\uff0c\u4e5f\u5373\u4e0d\u80fd\u6709\u8def\u5f84\u540c\u65f6\u5360\u7528 $v$ \u548c\u5b83\u7684\u7236\u4eb2\u3002 \u6545\u6709\u5982\u4e0b\u51e0\u79cd\u60c5\u51b5\uff1a\n\n- $u$ \u672a\u88ab\u5360\u7528\uff0c\u5219 $g_v=g_u+s_u-f_v$\uff1b\n\n- $u$ \u4e0e\u5b83\u7684\u7236\u4eb2\u4e00\u540c\u88ab\u5360\u7528\uff0c\u5219\u8fd9\u6761\u5360\u7528\u5b83\u4eec\u7684\u8def\u5f84\u6ee1\u8db3 $lca(x,y)$ \u662f $u$ \u7684\u7956\u5148\uff0c$x$ \u6216 $y$ \u662f $u$ \u7684\u540e\u4ee3\u4f46\u4e0d\u662f $v$ \u7684\u540e\u4ee3\u3002\u7531\u4e8e\u4e0a\u9762\u5df2\u7ecf\u66f4\u65b0\u4e86\u8def\u5f84\u6743\u503c\uff0c\u6240\u4ee5\u5728\u6ee1\u8db3\u5982\u4e0a\u8981\u6c42\u7684\u8def\u5f84\u4e2d\u627e\u51fa\u6700\u5927\u7684\u6743\u503c\uff0c\u51cf\u53bb $f_v$ \u5373\u53ef\uff1b\n\n- $u$ \u4e0e\u5b83\u7684\u513f\u5b50\u4e00\u540c\u88ab\u5360\u7528\uff0c\u5219\u6839\u636e\u6240\u6c42\u5b9a\u4e49\uff0c$v$ \u4e0d\u80fd\u4f5c\u4e3a\u8fd9\u6837\u7684\u513f\u5b50\u3002\u4e8b\u5148\u5c06\u6302\u5728 $u$ \u4e0a\u7684\u8def\u5f84\u6309\u6743\u503c\u4ece\u5927\u5230\u5c0f\u6392\u5e8f\uff0c\u904d\u5386\u627e\u5230\u7b2c\u4e00\u6761\u6ee1\u8db3 $x,y$ \u5747\u4e0d\u662f $v$ \u540e\u4ee3\u7684\u8def\u5f84\uff0c\u8fd9\u6837\u7684\u8def\u5f84\u4e0d\u4f1a\u5360\u7528 $v$\uff0c\u7528\u5b83\u7684\u6743\u503c\u51cf\u53bb $f_v$ \u66f4\u65b0\u7b54\u6848\u3002\n\n\u6211\u4eec\u5206\u6790\u4e00\u4e0b\u4e0a\u9762\u7b2c\u4e09\u79cd\u60c5\u51b5\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u3002\u79f0\u4e00\u6b21\u8282\u70b9\u5bf9\u8def\u5f84\u7684\u8bbf\u95ee\u6709\u6548\u7b49\u4ef7\u4e8e\u8fd9\u6b21\u8bbf\u95ee\u66f4\u65b0\u4e86\u7b54\u6848\uff0c\u56e0\u4e3a\u4e00\u6761\u8def\u5f84\u6700\u591a\u4f1a\u5360\u7528 $u$ \u7684\u4e24\u4e2a\u513f\u5b50\uff0c\u6240\u4ee5\u6bcf\u6761\u8def\u5f84\u88ab\u201c\u65e0\u6548\u8bbf\u95ee\u201d\u7684\u6b21\u6570\u6700\u591a\u4e3a $2$\uff0c\u800c\u6839\u636e\u4e0a\u8ff0\u6d41\u7a0b\uff0c\u6bcf\u4e2a $v$ \u6700\u591a\u4f1a\u8fdb\u884c\u4e00\u6b21\u201c\u6709\u6548\u8bbf\u95ee\u201d\uff0c\u6240\u4ee5\u8fd9\u91cc\u5bf9\u8def\u5f84\u7684\u603b\u8bbf\u95ee\u6b21\u6570\u662f\u7ebf\u6027\u7684\uff0c\u6240\u4ee5\u5bf9\u4e8e\u6240\u6709\u7684 $u$\uff0c\u8fd9\u6b65\u7684\u603b\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a\u6392\u5e8f\u6240\u9700\u7684 $\\mathcal O(m\\log m)$\u3002\n\n\u5728\u8ba1\u7b97\u51fa $g_v$ \u4e4b\u540e\u5411\u4e0b\u9012\u5f52\u4e4b\u524d\uff0c\u5c06\u6302\u5728 $u$ \u4e0a\u7684\u8def\u5f84\u6743\u503c\u6309\u7167\u7aef\u70b9\u63d2\u5165\u5230\u4ee5 dfs \u5e8f\u4e3a\u4e0b\u6807\u7684\u7ebf\u6bb5\u6811\u4e0a\uff0c\u8fd9\u6837\u5c31\u80fd\u4ee5\u5355\u70b9\u63d2\u5165\u533a\u95f4\u6c42\u6700\u5927\u503c\u7684\u7ebf\u6bb5\u6811\u5b9e\u73b0\u4e0a\u9762\u7b2c\u4e8c\u79cd\u60c5\u51b5\u7684\u9700\u6c42\u3002\n\n------------\n\n\u73b0\u5728\u6211\u4eec\u6c42\u51fa\u4e86\u4e00\u8f66 dp \u503c\uff0c\u56de\u5934\u770b\u770b\u9898\u4e2d\u5b9a\u4e49\u7684 $f(u,v)$\u3002\u9898\u76ee\u8981\u6c42\u5728\u8def\u5f84\u96c6\u5408 $U$ \u4e2d\u52a0\u5165 $(u,v,f(u,v))$ \u540e\uff0c$W(U)$ \u521a\u597d\u4e0d\u80fd\u88ab\u66f4\u65b0\u3002\u8003\u8651\u5728\u539f\u6811\u4e0a\u5220\u9664\u8def\u5f84 $(u,v)$ \u4e0a\u7684\u6240\u6709\u70b9\u548c\u4e0e\u8fd9\u4e9b\u70b9\u76f8\u90bb\u7684\u6240\u6709\u8fb9\uff0c\u5bf9\u5f62\u6210\u7684\u82e5\u5e72\u5b50\u6811\u7684 dp \u503c\u6c42\u548c\uff0c\u5219 $f(u,v)$ \u5373\u4e3a $W(U)$ \u51cf\u53bb\u8fd9\u4e2a\u548c\u3002\u6211\u4eec\u7684\u76ee\u6807\u5373\u4e3a\u6c42\u51fa\u8fd9\u4e2a\u548c\u3002\n\n\u8003\u8651\u4e0a\u9762\u6240\u8bf4\u201c\u5f62\u6210\u7684\u82e5\u5e72\u5b50\u6811\u201d\uff0c\u5728\u539f\u6811\u4ee5 $1$ \u4e3a\u6839\u65f6\uff0c\u8fd9\u4e9b\u5b50\u6811\u8981\u4e48\u4ecd\u662f\u4e00\u4e2a\u5b50\u6811\uff0c\u8981\u4e48\u662f\u67d0\u4e2a\u5b50\u6811\u7684\u8865\uff0c\u5b83\u4eec\u7684 dp \u503c\u5373\u4e3a\u4e0a\u9762\u6c42\u51fa\u7684 $f_u$ \u548c $g_u$\u3002\u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u8f6c\u800c\u8003\u8651\u6bcf\u4e2a $f_u$ \u6216 $g_u$ \u5bf9\u7b54\u6848\u4ea7\u751f\u7684\u8d21\u732e\u3002$f_u$ \u4f1a\u4ea7\u751f\u8d21\u732e\u5f53\u4e14\u4ec5\u5f53\u65b0\u589e\u7684\u8def\u5f84\u4e0d\u7ecf\u8fc7 $u$ \u800c\u7ecf\u8fc7\u5b83\u7684\u7236\u4eb2\uff0c$g_u$ \u4f1a\u4ea7\u751f\u8d21\u732e\u5f53\u4e14\u4ec5\u5f53\u65b0\u589e\u7684\u8def\u5f84\u7ecf\u8fc7 $u$ \u800c\u4e0d\u7ecf\u8fc7\u5b83\u7684\u7236\u4eb2\uff0c\u7b80\u5355\u5bb9\u65a5\u5373\u53ef\u6c42\u51fa\u8d21\u732e\u6b21\u6570\u3002\n\n\u6574\u4e2a\u6d41\u7a0b\u4e2d\uff0c\u6c42 lca\u3001\u6811\u72b6\u6570\u7ec4\u3001\u6392\u5e8f\u3001\u7ebf\u6bb5\u6811\u5747\u4e3a\u5355 $\\log$\uff0c\u5728\u672c\u9898 $n,m$ \u540c\u9636\u7684\u60c5\u51b5\u4e0b\uff0c\u603b\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $\\mathcal O(n\\log n)$\u3002\n\n\u4ee3\u7801\u89c1[\u8bc4\u6d4b\u8bb0\u5f55](/record/103495053)\uff0c\u76ee\u524d\u662f\u65e0\u6c27\u6700\u4f18\u89e3\u3002\n\nupd:\u540c\u4e00\u4efd\u4ee3\u7801[\u5438\u4e86\u4e0b\u6c27](/record/104028662)\uff0c\u76ee\u524d\u662f\u6700\u4f18\u89e3\u3002\n\n------------\n\n\u95f2\u8bdd\uff1a\u5f53\u4e8b\u6a21\u62df\u8d5b\uff0c\u5f00\u8d5b\u4e0d\u4e45 T4 \u88ab\u6307\u51fa\u662f\u91cd\u9898\uff0c\u4e8e\u662f\u4ece P3772 \u6362\u6210\u4e86\u8fd9\u9053\uff08\n\n\u53e6\u5916\u611f\u8c22\u5cf0\u53d1\u5e16\u5efa\u8bae\u8fd9\u9898\u7d2b\u5347\u9ed1\uff0c\u8fd9\u4e0b\u9ed1\u9898\u559c\u52a0\u4e00\u4e86\u3002",
        "postTime": 1677828597,
        "uid": 128570,
        "name": "StarLbright40",
        "ccfLevel": 9,
        "title": "P5642 \u9898\u89e3"
    }
]