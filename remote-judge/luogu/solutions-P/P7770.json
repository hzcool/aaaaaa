[
    {
        "content": "[\u4f20\u9001\u95e8](https://www.luogu.com.cn/problem/P7770)\uff0c~~\u662f\u5212\u6c34\u65f6\u53e3\u80e1\u7684\u4e00\u9053\u5927\u6c34\u9898~~\n\n#### \u524d\u7f6e\u77e5\u8bc6\uff1a\n\n\u53ef\u6301\u4e45\u5316\u7ebf\u6bb5\u6811\u3002\n\n#### \u9898\u610f\uff1a\n\n- \u7ed9\u51fa\u4e00\u4e2a\u957f\u5ea6\u4e3a $n$ \u7684\u6570\u5217 $a_i$\u3002\n\n- $m$ \u6b21\u5728\u7ebf\u8be2\u95ee\uff0c\u6bcf\u6b21\u8be2\u95ee\u6c42\u51fa $\\sum\\limits_{i=l}^{r-1}|x-a_i|\\times|x-a_{i+1}|$\u3002\n\n- $n,m\\le3\\times10^5$\u3002\n\n\u4e3a\u4e86\u7b80\u6d01\uff0c\u8bbe $f_{x,i}=|x-a_i|\\times|x-a_{i+1}|$\u3002\n\n#### \u5206\u6790\uff1a\n\n\u8fd9\u9898\u9898\u9762\u770b\u8d77\u6765\u5c31\u50cf\u7ebf\u6bb5\u6811\uff0c\u4f46\u6ce8\u610f\u5230\u5bf9\u4e8e\u6bcf\u4e2a $x$\uff0c$f_{x,i}$ \u90fd\u4e0d\u76f8\u540c\uff0c\u6211\u4eec\u4e5f\u5f00\u4e0d\u4e0b $10^9$ \u68f5\u7ebf\u6bb5\u6811\uff0c\u6240\u4ee5\u6682\u65f6\u5e76\u4e0d\u884c\u3002\uff08\u5bf9\u4e8e $10\\%$ \u7684 $x\\le10$ \u7684\u6570\u636e\uff0c\u8fd9\u4e00\u65b9\u6cd5\u5c31\u975e\u5e38\u53ef\u884c\uff09\n\n\u4e0d\u8fc7\u79bb\u6563\u5316\u540e\uff0c\u6211\u4eec\u53ef\u80fd\u53ea\u9700\u8981\u5f00 $3\\times10^5$ \u68f5\u6811\uff0c\u8fd9\u63d0\u793a\u6211\u4eec\u5f80\u53ef\u6301\u4e45\u5316\u7ebf\u6bb5\u6811\u7684\u65b9\u5411\u601d\u8003\u3002\n\n\u6839\u636e\u7edd\u5bf9\u503c\u7684\u5b9a\u4e49\uff0c\u6709\uff1a\n\n$$|x-a|=\\begin{cases}x-a&x\\ge a\\\\-x+a &x<a\\end{cases}$$\n\n\u90a3\u4e48\uff1a\n\n$$f_{x,i}=\\begin{cases}x^2-(a_i+a_{i+1})x+a_ia_{i+1}&x\\ge\\max(a_i,a_{i+1})\\text{ \u6216 }x<\\min(a_i,a_{i+1})\\\\-x^2+(a_i+a_{i+1})x-a_ia_{i+1}&\\min(a_i,a_{i+1})\\le x<\\max(a_i,a_{i+1})\\end{cases}$$\n\n\u53ea\u8981 $x$ \u4e0e $a_i$\uff0c$a_{i+1}$ \u7684\u5173\u7cfb\u786e\u5b9a\u540e\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u9009\u62e9\u4e0a\u8ff0\u5f0f\u5b50\u6765\u6c42\u51fa\u7b54\u6848\uff0c\u800c\u4e0d\u9700\u8981\u786e\u5b9a $x$ \u7684\u5177\u4f53\u503c\u3002\n\n\u5177\u4f53\u5730\uff0c\u5047\u8bbe $f_{x,i}=bx^2+cx+d$\uff0c\u5219\u6709 $\\sum f_{x,i}=x^2\\sum b+x\\sum c+\\sum d$\uff0c\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4 $\\sum b$\uff0c$\\sum c$ \u548c $\\sum d$\uff0c\u8fd9\u6837\u7ebf\u6bb5\u6811\u5c31\u4e0e $x$ \u7684\u5177\u4f53\u503c\u65e0\u5173\u4e86\u3002\n\n\u6ce8\u610f\u5230\u5f53 $x$ \u589e\u5927\u7684\u8fc7\u7a0b\u4e2d\uff0c$x$ \u4e0e $a_i$ \u7684\u5173\u7cfb\u6700\u591a\u6539\u53d8\u4e00\u6b21\uff08\u4ece $x\\le a_i$ \u5230 $x>a_i$\uff09\uff0c\u5e76\u4e14\u603b\u662f\u5f53 $x$ \u8d85\u8fc7 $a_i$ \u7684\u65f6\u5019\uff0c$f_{x,i}$\uff0c$f_{x,i-1}$ \u4f1a\u6539\u53d8\u3002\u56e0\u6b64\u5bf9\u4e8e\u6bcf\u4e2a $a_i$ \u5efa\u4e00\u68f5\u7ebf\u6bb5\u6811\uff0c\u5e76\u4f7f\u7528\u53ef\u6301\u4e45\u5316\u7ebf\u6bb5\u6811\u7ef4\u62a4\u8fd9 $n$ \u68f5\u6811\u3002\u6bcf\u6b21 $x$ \u8d85\u8fc7 $a_i$ \u65f6\uff0c\u5728\u4e0a\u4e00\u68f5\u6811\u7684\u57fa\u7840\u4e0a\u4fee\u6539 $f_{x,i-1}$ \u548c $f_{x,i}$\uff0c\u5c31\u53ef\u4ee5\u89e3\u51b3\u95ee\u9898\u4e86\u3002\n\n#### \u601d\u8def\uff1a\n\n1. \u5bf9\u6bcf\u4e00\u4e2a $a_i$ \u5f00\u4e00\u68f5\u7ebf\u6bb5\u6811\uff0c\u5e76\u4f7f\u7528\u53ef\u6301\u4e45\u5316\u7ebf\u6bb5\u6811\u7ef4\u62a4\u3002\n\n2. \u5bf9\u6bcf\u4e2a\u67e5\u8be2\u4e8c\u5206\u67e5\u627e\u5e94\u8be5\u67e5\u8be2\u54ea\u4e00\u68f5\u7ebf\u6bb5\u6811\uff0c\u76f4\u63a5\u67e5\u8be2\u5373\u53ef\u3002\n\n---\n\n\u6280\u5de7\u4e0d\u591a\uff0c\u76f4\u63a5\u4e0a\u4ee3\u7801\u3002\n\n```cpp\n#include <bits/stdc++.h>\n#define rep(i, l, r) for(register int i=l; i<=r; ++i)\n#define rrep(i, r, l) for(register int i=r; i>=l; --i)\n#define lfor(i, x) for(int i=head[x]; i; i=nxt[i])\n#define ll long long\nusing namespace std;\ninline ll read() {\n\tll ret=0, k=1; char c; do if((c=getchar())=='-') k=-1; while(c<'0' || c>'9');\n\twhile(c>='0' && c<='9') ret=(ret<<1)+(ret<<3)+(c^48), c=getchar(); return k*ret;\n}\nconst int mN=3e5+100, mS=42*mN, mod=1e9+7;\nint n, m, a[mN];\nint ork, rk[mN];\nint oe, head[mN], ver[mN], nxt[mN];\ninline void add(int x, int y) {nxt[++oe]=head[x], ver[oe]=y, head[x]=oe;}\n\nnamespace Segment_Tree {\n#define lc tree[p].son[0]\n#define rc tree[p].son[1]\n\tint on, rt[mN];\n\tstruct node {int son[2]; int b, c, d;} tree[mS];\t//b c d \u5c31\u662f\u9898\u89e3\u4e2d\u63d0\u5230\u7684\u4e09\u4e2a\u7cfb\u6570 \n\tinline void push_up(int p) {\n\t\ttree[p].b=(tree[lc].b+tree[rc].b)%mod;\n\t\ttree[p].c=(tree[lc].c+tree[rc].c)%mod;\n\t\ttree[p].d=(tree[lc].d+tree[rc].d)%mod;\n\t}\n\tvoid build(int &p, int l, int r) {\n\t\tp=++on;\n\t\tif(l==r) {\n\t\t\tif(1<=l && l<=n) tree[p].b=1, tree[p].c=(-a[l]-a[l+1])%mod, tree[p].d=(ll) a[l]*a[l+1]%mod;\n\t\t\telse tree[p].b=tree[p].c=tree[p].d=0;\n\t\t} else build(lc, l, l+r>>1), build(rc, (l+r>>1)+1, r), push_up(p);\n\t}\n\tvoid modify(int lp, int &p, int l, int r, int i) {\t//\u4fee\u6539 f(x,i) \u7684\u5f0f\u5b50 \n\t\tif(p==lp || !p) p=++on, tree[p]=tree[lp];\n\t\tif(l==r) tree[p].b=-tree[p].b, tree[p].c=-tree[p].c, tree[p].d=-tree[p].d;\t//\u53d6\u76f8\u53cd\u6570\u5373\u53ef \n\t\telse {\n\t\t\tif(i<=(l+r>>1)) modify(tree[lp].son[0], lc, l, l+r>>1, i);\n\t\t\telse modify(tree[lp].son[1], rc, (l+r>>1)+1, r, i);\n\t\t\tpush_up(p);\n\t\t}\n\t}\n\tint query(int p, int l, int r, int x, int y, int z) {\n\t\tif(x<=l && r<=y) return ((ll) tree[p].b*z%mod*z+(ll) tree[p].c*z+tree[p].d)%mod;\t//\u5373\u6c42 bz^2+cz+d \n\t\treturn ((lc&&x<=(l+r>>1)?query(lc, l, l+r>>1, x, y, z):0)\n\t\t       +(rc&&(l+r>>1)<y?query(rc, (l+r>>1)+1, r, x, y, z):0))%mod;\n\t}\n#undef lc\n#undef rc\n}\nusing namespace Segment_Tree;\n\npair <int, int> tmp[mN];\nvoid getrk() {\t//\u53bb\u91cd\uff0c\u5199\u5f97\u6709\u70b9\u4e11\uff08\n\trep(i, 1, n) tmp[i]=make_pair(a[i], i);\n\tsort(tmp+1, tmp+n+1);\n\trep(i, 1, n) {\n\t\tif(tmp[i].first!=tmp[i-1].first) ++ork;\n\t\trk[ork]=tmp[i].first, add(ork, tmp[i].second);\n\t}\n}\nint main() {\n\tn=read(), m=read();\n\trep(i, 1, n) a[i]=read();\n\tgetrk(), build(rt[0], 0, n);\n\trep(i, 1, ork) lfor(t, i) modify(rt[i-1], rt[i], 0, n, ver[t]-1), modify(rt[i-1], rt[i], 0, n, ver[t]);\n\t//f(x, ver[t]) \u548c f(x, ver[t]-1) \u5728 a[ver[t]] \u53d8\u5316\u65f6\u5747\u9700\u4fee\u6539\n\t//\u56e0\u4e3a\u4fee\u6539\u65f6\u4e0d\u60f3\u7279\u5224 ver[t]==1\uff0c\u6240\u4ee5\u4e0b\u6807\u4ece 0 \u5230 n\n\tint ans=0, x, l, r;\n\twhile(m--) {\n\t\tx=read()^ans, l=read()^ans, r=read()^ans;\n\t\tprintf(\"%d\\n\", ans=(query(rt[upper_bound(rk, rk+ork+1, x)-rk-1], 0, n, l, r-1, x)+mod)%mod);\n\t\t//upper_bound-rk-1 \u627e\u7b2c\u4e00\u4e2a\u5c0f\u4e8e\u7b49\u4e8e x \u7684\u6570 \n\t}\n\treturn 0;\n}\n```\n\n~~\u672c\u4eba\u4ee3\u7801\u5e38\u6570\u5de8\u5927\uff0c\u6b22\u8fce\u5404\u8def\u795e\u4ed9\u540a\u6253\u3002~~\n\n\u8fd9\u91cc\u653e\u4e0a [Push_Y](https://www.luogu.com.cn/user/135485) \u7684\u5199\u6cd5\uff0c\u4ee5\u4f9b\u53c2\u8003\u3002\n\n```cpp\n#include <bits/stdc++.h>\n#define int long long\nusing namespace std;\ninline int gin(){\n\tint s=0,f=1;\n\tchar c=getchar();\n\twhile(c<'0' || c>'9'){\n\t\tif(c=='-') f=-1;\n\t\tc=getchar();\n\t}\n\twhile(c>='0'&&c<='9'){\n\t\ts=(s<<3)+(s<<1)+(c^48);\n\t\tc=getchar();\n\t}\n\treturn s*f;\n}\n\nconst int N=3e5+5,M=41,mod=1e9+7;\nint n,m,idx,len;\nint a[N],b[N],rt[N];\nint lc[N*M],rc[N*M];\nvector<int> pos[N];\n\nstruct node{\n\tint a,b,c;\n\tinline void qf(){a=-a,b=-b,c=-c;}\n\tinline int ans(int x){return (a*x%mod*x+b*x%mod+c+mod)%mod;}\n}e[N*M];\n\ninline int getid(int x){return lower_bound(b+1,b+len+1,x)-b;}\n\ninline void pushup(int x){\n\te[x].a=(e[lc[x]].a+e[rc[x]].a)%mod;\n\te[x].b=(e[lc[x]].b+e[rc[x]].b)%mod;\n\te[x].c=(e[lc[x]].c+e[rc[x]].c)%mod;\n}\n\nint build(int l,int r){\n\tint x=++idx;\n\tif(l==r){\n\t\tif(l!=0) e[x]=(node){1,(-a[l]-a[l+1])%mod,a[l]*a[l+1]%mod};\n\t\treturn x;\n\t}\n\tint mid=l+r>>1;\n\tlc[x]=build(l,mid);\n\trc[x]=build(mid+1,r);\n\tpushup(x);\n\treturn x;\n}\n\nint upd(int x,int root,int l,int r,int v){\n\tif(x==root || !x) x=++idx,e[x]=e[root],lc[x]=lc[root],rc[x]=rc[root];\n\tif(l==r){\n\t\te[x].qf();\n\t\treturn x;\n\t}\n\tint mid=l+r>>1;\n\tif(v<=mid) lc[x]=upd(lc[x],lc[root],l,mid,v);\n\telse rc[x]=upd(rc[x],rc[root],mid+1,r,v);\n\tpushup(x);\n\treturn x;\n}\n\nint query(int x,int l,int r,int L,int R,int X){\n\tif(L<=l && r<=R) return e[x].ans(X);\n\tint mid=l+r>>1,res=0;\n\tif(lc[x] && L<=mid) res+=query(lc[x],l,mid,L,R,X);\n\tif(rc[x] && mid<R ) res+=query(rc[x],mid+1,r,L,R,X);\n\treturn res%mod;\n}\n\nsigned main(){\n\tn=gin(),m=gin();\n\tfor(int i=1;i<=n;i++)\n\t\ta[i]=b[i]=gin();\n\tsort(b+1,b+n+1);\t\n\tlen=unique(b+1,b+n+1)-b-1;\n\tfor(int i=1;i<=n;i++)\n\t\tpos[getid(a[i])].push_back(i);\n\trt[1]=build(0,n);\n\tfor(int i=2;i<=len+1;i++)\n\t\tfor(int j=0;j<pos[i-1].size();j++){\n\t\t\tint v=pos[i-1][j];\n\t\t\trt[i]=upd(rt[i],rt[i-1],0,n,v-1);\n\t\t\trt[i]=upd(rt[i],rt[i-1],0,n,v);\n\t\t}\n\tint last=0;\n\twhile(m--){\n\t\tint x=gin()^last,l=gin()^last,r=gin()^last;\n\t\tlast=(query(rt[lower_bound(b+1,b+len+1,x)-b],0,n,l,r-1,x)+mod)%mod;\n\t\tprintf(\"%lld\\n\",last);\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1624692607,
        "uid": 364963,
        "name": "\u963f\u4e11",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P7770 \u4e11\u56fd\u4f20\u8bf4 \u00b7 \u4e11\u56fd\u65c5\u6e38\uff08En:Travel To The Ugly\uff09"
    }
]