[
    {
        "content": "\u5982\u679c\u628a\u6bcf\u4e2a\u6570\u5411\u524d\u9762\u7b2c\u4e00\u4e2a\u6bd4\u4ed6\u5927\u7684\u6570\u8fde\u8fb9\uff0c\u90a3\u4e48\u6784\u6210\u4e00\u4e2a\u6811\u5f62\u7ed3\u6784\n\n\u53ef\u4ee5\u53d1\u73b0\u5bf9\u4e8e\u4e00\u4e2a $x$ \u4e00\u76f4\u5230\u4e0b\u4e00\u4e2a\u5927\u4e8e\u7b49\u4e8e\u4ed6\u7684\u6570\u4e4b\u524d\u7684\u533a\u95f4\u90fd\u4f1a\u88ab\u4ed6\u6240\u5f71\u54cd\uff0c\u5373\u90fd\u662f\u4ed6\u7684\u5b50\u6811\uff0c\u90a3\u4e48\u4e5f\u5c31\u662f\u8bf4\u6bcf\u4e2a\u7ed3\u70b9\u7684\u5b50\u6811\u662f\u4e00\u4e2a\u8fde\u7eed\u533a\u95f4\n\n\u56e0\u4e3a\u662f\u8fde\u7eed\u533a\u95f4\uff0c\u6240\u4ee5\u4ed6\u4eec\u88ab\u6539\u53d8\u7684\u65f6\u95f4\u4e5f\u662f\u8fde\u7eed\u7684\uff0c\u6211\u4eec\u8003\u8651\u7ef4\u62a4\u968f\u65f6\u95f4\u53d8\u5316\u7684\u589e\u91cf\n\n\u5728\u8fd9\u4e2a\u6811\u5f62\u7ed3\u6784\u4e2d\u4ed6\u7684\u7236\u4eb2\u6bd4\u4ed6\u7684\u7236\u4eb2\u7684\u7236\u4eb2\u5148\u5f71\u54cd\u5230\u4ed6\uff0c\u6240\u4ee5\u6211\u4eec\u7ef4\u62a4\u513f\u5b50\u4e0e\u7236\u4eb2\u7684\u589e\u91cf\u5373\u53ef\n\n\u5176\u5b9e\u4e0a\u9762\u8fd9\u4e9b\u5e9f\u8bdd\u53ea\u662f\u544a\u8bc9\u6211\u4eec\u53ef\u4ee5\u5bf9\u6bcf\u4e2a\u4f4d\u7f6e\u5f97\u5230\u4e00\u4e2a\u56db\u5143\u7ec4 $(t_0, l, r, d)$\n\n\u8868\u793a\u5728 $[l,r]$ \u533a\u95f4, \u4ece $t_0$ \u65f6\u523b\u5f00\u59cb\uff0c \u6309\u7167\u4ece\u5de6\u5230\u53f3\u7684\u4f4d\u7f6e\u987a\u5e8f\u6bcf\u4e2a\u65f6\u523b\u90fd\u4f1a\u5728\u5bf9\u5e94\u4f4d\u7f6e\u591a $d$ \u7684\u8d21\u732e\n\n\u6211\u4eec\u628a\u8be2\u95ee\u62c6\u6210\u67e5\u8be2\u4e24\u4e2a\u524d\u7f00\u76f8\u51cf\u7684\u5f62\u5f0f $ans_r - ans_{l - 1}$ \uff0c\u7136\u540e\u6309\u7167\u5bf9\u65f6\u95f4\u8fdb\u884c\u626b\u63cf\u7ebf\uff0c\u8fd9\u6837\u6bcf\u4e2a\u56db\u5143\u7ec4\u7684\u8d21\u732e\u5927\u6982\u5c31\u662f\u4e0b\u9762\u8fd9\u6837\n\n~~\u56fe\u6709\u70b9\u4e11\uff0c\u5c06\u5c31\u770b\u5427~~\n\n\n\u53d1\u73b0\u53ef\u4ee5\u5199\u6210\u4e24\u4e2a\u76f4\u89d2\u4e09\u89d2\u5f62\u5dee\u5206\u7684\u5f62\u5f0f\uff0c\u5982\u4e0b\u4e0b\u56fe\n\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/1pzfjjxt.png)\n\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/gwk77zpr.png)\n\n\u7eff\u8272\u51cf\u53bb\u7d2b\u8272\n\n\u6240\u4ee5\u56db\u5143\u7ec4\u53d8\u6210\u4e86\u4e24\u4e2a\u4e09\u5143\u7ec4\uff0c\u5c31\u80fd\u591f\u5904\u7406\u4e86\n\n\u4e09\u5143\u7ec4 $(t_0, l, d)$ \u8868\u793a $l$ \u4f4d\u7f6e\u4ece $t_0$ \u65f6\u523b\u5f00\u59cb\u6bcf\u65f6\u523b\u5411\u540e\u9762\u6709 $d$ \u7684\u589e\u91cf\n\n\u8003\u8651\u5bf9\u4e00\u4e2a\u524d\u7f00 $p$ \u8fdb\u884c $t$ \u65f6\u523b\u7684\u8be2\u95ee\uff0c \u4ed6\u7684\u8d21\u732e\u53ef\u4ee5\u5199\u6210 $(min(p, l + t - t_0) - min(p, l - 1)) \\times d$\n\n\u8fd9\u6837\u5bf9\u4e8e $p < l$ \u6211\u4eec\u4e5f\u4e0d\u9700\u8981\u7279\u6b8a\u5904\u7406\uff0c\u56e0\u4e3a\u4e00\u51cf\u5c31\u53d8\u6210 $0$ \u4e86\n\n\u4e5f\u5c31\u662f $(t + min(p - t, l - t_0) - min(p, l - 1)) \\times d$\n\n\u90a3\u4e48\u6211\u4eec\u5f00\u56db\u68f5\u7ebf\u6bb5\u6811\u5206\u522b\u7ef4\u62a4\n\n1. \u5728 $l$ \u4f4d\u7f6e\u7ef4\u62a4 $l \\times d$\n\n2. \u5728 $l - t_0$ \u4f4d\u7f6e\u7ef4\u62a4 $(l - t_0) \\times d$\n\n3. \u5728 $l$ \u4f4d\u7f6e\u7ef4\u62a4 $d$\n\n4. \u5728 $l - t_0$ \u4f4d\u7f6e\u7ef4\u62a4 $d$\n\n\u8be2\u95ee\u5bf9 $min$ \u53d6\u7684\u662f\u54ea\u4e2a\u503c\u5206\u5f00\u8ba8\u8bba\u5373\u53ef\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\ntypedef long long ll;\ntypedef unsigned long long ull;\nconst int maxn = 200005;\ninline int read(){\n\tint x = 0; char c = getchar();\n\twhile(c < '0' || c > '9')c = getchar();\n\tdo{x = (x << 3) + (x << 1) + (c ^ 48); c = getchar();}while(c <= '9' && c >= '0');\n\treturn x;\n}\nint n, q, a[maxn];\nint sta[maxn], fa[maxn], r[maxn];\nstruct que{\n\tint p, t, id, opt;\n\tfriend bool operator < (const que &x, const que &y){\n\t\treturn x.t < y.t;\n\t}\n}ask[maxn + maxn];\nstruct opt{\n\tint t0, l, d;\n\tfriend bool operator < (const opt &x, const opt &y){\n\t\treturn x.t0 < y.t0;\n\t}\n}o[maxn + maxn];\nll ans[maxn];\nstruct tree{\n\tstruct node{ll val, tag;}t[maxn << 3 | 1];\n\tvoid push_up(int x){\n\t\tt[x].val = t[x << 1].val + t[x << 1 | 1].val;\n\t}\n\tvoid modify(int x, int l, int r, int pos, ll val){\n\t\tif(l == r){\n\t\t\tt[x].val += val;\n\t\t\treturn;\n\t\t}\n\t\tint mid = (l + r) >> 1;\n\t\tif(pos <= mid)modify(x << 1, l, mid, pos, val);\n\t\telse modify(x << 1 | 1, mid + 1, r, pos, val);\n\t\tpush_up(x);\n\t}\n\tll query(int x, int l, int r, int L, int R){\n\t\tif(L <= l && r <= R)return t[x].val;\n\t\tint mid = (l + r) >> 1; ll ans = 0;\n\t\tif(L <= mid)ans += query(x << 1, l,  mid, L, R);\n\t\tif(R > mid)ans += query(x << 1 | 1, mid + 1, r, L, R);\n\t\treturn ans;\n\t}\n}t[4];\nll sum[maxn];\nint main(){\n\tn = read(), q = read();\n\tfor(int i = 1; i <= n; ++i)a[i] = read();\n\tfor(int i = 1; i <= n; ++i)sum[i] = sum[i - 1] + a[i];\n\tfor(int i = 1; i <= q; ++i){\n\t\tint t = read(), l = read(), r = read();\n\t\task[i + i - 1].id = ask[i + i].id = i;\n\t\task[i + i - 1].t = ask[i + i].t = t;\n\t\task[i + i - 1].p = l - 1, ask[i + i - 1].opt = -1;\n\t\task[i + i].p = r, ask[i + i].opt = 1;\n\t}\n\tint top = 0;\n\tfor(int i = 1; i <= n; ++i){\n\t\twhile(top && a[sta[top]] < a[i])r[sta[top]] = i, --top;\n\t\tfa[i] = sta[top]; sta[++top] = i;\n\t}\n\twhile(top)r[sta[top--]] = n + 1;\n\tsort(ask + 1, ask + q + q + 1);\n\tint cnt = 0;\n\tfor(int i = 1; i <= n; ++i)if(fa[i]){\n\t\to[++cnt].d = a[fa[i]] - a[i];\n\t\to[cnt].l = i; o[cnt].t0 = i - fa[i];\n\t\tif(r[i]){\n\t\t\to[++cnt].d = a[i] - a[fa[i]];\n\t\t\to[cnt].l = r[i]; o[cnt].t0 = r[i] - fa[i];\n\t\t} \n\t}\n\tsort(o + 1, o + cnt + 1);\n\tint op = 1;\n\tfor(int i = 1; i <= q + q; ++i){\n\t\twhile(op <= cnt && o[op].t0 <= ask[i].t){\n\t\t\tt[0].modify(1, 0, n, o[op].l - 1, 1ll * (o[op].l - 1) * o[op].d);\n\t\t\tt[1].modify(1, 0, n + n, o[op].l - o[op].t0 + n, 1ll * (o[op].l - o[op].t0) * o[op].d);\n\t\t\tt[2].modify(1, 0, n, o[op].l - 1, o[op].d);\n\t\t\tt[3].modify(1, 0, n + n, o[op].l - o[op].t0 + n, o[op].d);\n\t\t\t++op;\n\t\t}\n\t\tll nans = 0;\n\t\tif(ask[i].p == 0)nans = 0;\n\t\telse{\n\t\t\tnans = ask[i].t * t[2].query(1, 0, n, 1, n);\n\t\t\tnans = nans + t[1].query(1, 0, n + n, 1, ask[i].p - ask[i].t + n);\n\t\t\tnans = nans + t[3].query(1, 0, n + n, ask[i].p - ask[i].t + n + 1, n + n) * (0ll + ask[i].p - ask[i].t);\n\t\t\tnans = nans - t[0].query(1, 0, n, 1, ask[i].p);\n\t\t\tnans = nans - t[2].query(1, 0, n, ask[i].p + 1, n) * 1ll * ask[i].p;\n\t\t\tnans = nans + sum[ask[i].p];\n\t\t}\n\t\tans[ask[i].id] += nans * ask[i].opt;\n\t}\n\tfor(int i = 1; i <= q; ++i)printf(\"%lld\\n\", ans[i]);\n\treturn 0;\n}\n```\n",
        "postTime": 1663317493,
        "uid": 291408,
        "name": "Chen_jr",
        "ccfLevel": 7,
        "title": "P6881 [JOI 2020 Final] \u706b\u4e8b \u9898\u89e3"
    },
    {
        "content": "\u6570\u636e\u7ed3\u6784\u597d\u9898\u3002\n\n------------\n\n\u6211\u4eec\u8003\u8651\u753b\u51fa\u6bcf\u4e00\u65f6\u523b\u6240\u6709\u4f4d\u7f6e\u7684\u503c\uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/qmgzwyrw.png)\n\n\u8fd9\u5176\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u627e\u5230\u6700\u6807\u51c6\u7684\u60c5\u5f62\uff1a\u91cc\u9762\u7684\u5143\u7d20 $\\color{cyan}{7}$\u3002\u53ef\u4ee5\u770b\u5230\uff0c\u968f\u7740\u65f6\u95f4\u589e\u52a0\uff0c\u5b83\u5448\u73b0\u4e00\u4e2a\u5e73\u884c\u56db\u8fb9\u5f62\u3002\n\n\u90a3\u4e48\u8fd9\u4e2a\u5e73\u884c\u56db\u8fb9\u5f62\u7531\u4e0a\u9762\u6784\u6210\u5462\uff1f\u6211\u4eec\u8003\u8651\u7528\u5355\u8c03\u6808\u627e\u51fa\u6bcf\u4e2a\u4f4d\u7f6e\u5411\u5de6\u5411\u53f3\u7b2c\u4e00\u4e2a\u6bd4\u5b83\u5927\u7684\u4f4d\u7f6e $l_i,r_i$\u3002\u5219\u6211\u4eec\u4f1a\u53d1\u73b0\uff0c\u5e73\u884c\u56db\u8fb9\u5f62\u7684\u56db\u4e2a\u9876\u70b9\u662f $(i,0),(r_i-1,r_i-i-1),(r_i-1,r_i-l_i-2),(i,i-l_i-1)$\u3002\n\n\u6211\u4eec\u8003\u8651\u6b64\u65f6\u7684\u8be2\u95ee\uff0c\u5728\u5750\u6807\u7cfb\u4e0a\uff0c\u5c31\u6210\u4e3a\u4e86\u4e00\u6bb5\u6c34\u5e73\u7ebf\u6bb5\u3002\u8003\u8651\u5dee\u5206\u4e00\u4e0b\uff0c\u5c31\u53d8\u6210\u4e86\u4e24\u6761\u6cbf $x$ \u8f74\u8d1f\u65b9\u5411\u7684\u7684\u5c04\u7ebf\u3002\n\n\u8003\u8651\u628a\u4e00\u4e2a\u5e73\u884c\u56db\u8fb9\u5f62\u62c6\u6210\u4e09\u4e2a\u4e09\u89d2\u5f62\uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/75of4m75.png)\n\n\u5982\u56fe\uff0c\u7eff\u8272\u5e73\u884c\u56db\u8fb9\u5f62=\u5927\u4e09\u89d2\u5f62-\u84dd\u4e09\u89d2\u5f62-\u7d2b\u4e09\u89d2\u5f62\u3002\n\n\u7136\u540e\u6211\u4eec\u53d1\u73b0\uff0c\u6bcf\u4e2a\u4e09\u89d2\u5f62\u7684\u5f62\u72b6\u90fd\u662f\u4e00\u6837\u7684\uff0c\u5e76\u4e14\u90fd\u6709\u4e00\u6761\u8170\u5728 $x$ \u8f74\u4e0a\u3002\u6545\u6211\u4eec\u53ef\u4ee5\u7528\u5176\u4e0a\u65b9\u9876\u70b9\u6765\u552f\u4e00\u786e\u5b9a\u4e00\u4e2a\u4e09\u89d2\u5f62\u3002\u5219\u6709\u5927\u4e09\u89d2\u5f62\u9876\u70b9 $(r_i-1,r_i-l_i-2)$\uff0c\u84dd\u4e09\u89d2\u5f62\u9876\u70b9 $(i-1,i-l_i-2)$\uff0c\u7d2b\u4e09\u89d2\u5f62\u9876\u70b9 $(r_i-1,r_i-i-2)$\u3002\n\n\u6211\u4eec\u8003\u8651\u4e00\u6761\u6cbf $x$ \u8f74\u8d1f\u65b9\u5411\u7684\u5c04\u7ebf\u4e0e\u4e09\u89d2\u5f62\u7684\u4ea4\u7ebf\u6bb5\u957f\u5ea6\uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/35jshr42.png)\n\n\u5982\u56fe\uff0c\u5982\u679c\u8be5\u5c04\u7ebf\u662f\u7eff\u7ebf\uff08\u539f\u70b9\u5728\u4e09\u89d2\u5f62\u5185\uff09\uff0c\u53ef\u4ee5\u5c06\u5176\u5e73\u79fb\u81f3\u7d2b\u7ebf\u4f4d\u7f6e\uff0c\u7136\u540e\u5c31\u53ef\u4ee5\u62c6\u62ec\u53f7\u8ba1\u7b97\u4e86\u3002\u5982\u679c\u8be5\u76f4\u7ebf\u662f\u68d5\u7ebf\uff0c\u5219\u4e5f\u53ef\u4ee5\u7b80\u5355\u8ba1\u7b97\u3002\n\n\u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u7528\u626b\u63cf\u7ebf\u7ef4\u62a4\u5bf9\u4e8e\u9012\u589e\u7684\u5c04\u7ebf\u539f\u70b9\u7684 $x$ \u5750\u6807\uff0c\u76f8\u5e94\u7684\u4f4d\u4e8e\u5176\u5de6\u4fa7\u7684\u4e09\u89d2\u5f62\u4eec\u548c\u4f4d\u4e8e\u5176\u53f3\u4fa7\u7684\u4e09\u89d2\u5f62\u4eec\uff0c\u7136\u540e\u5206\u522b\u8f6c\u79fb\u5373\u53ef\u3002\n\n\u81f3\u4e8e\u5982\u4f55\u8f6c\u79fb\uff0c\u53ef\u4ee5\u5404\u901a\u8fc7\u4e24\u68f5\u6811\u72b6\u6570\u7ec4\uff0c\u4e00\u68f5\u7ef4\u62a4\u7cfb\u6570\u548c\uff0c\u4e00\u68f5\u7ef4\u62a4\u5e26\u6743\u5750\u6807\u548c\uff0c\u7136\u540e\u5206\u522b\u8f6c\u79fb\u5373\u53ef\u3002\u5171\u9700\u56db\u68f5\u6811\u72b6\u6570\u7ec4\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log n)$\u3002\n\n\u4ee3\u7801\uff1a\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\ntypedef long long ll;\nint n,m,a[200100],l[200100],r[200100],stk[200100],tp,lim,mil;\nll res[200100];\nnamespace BIT1{//a BIT for triangular summary.\n\tll t1[600100],t2[600100];//t1 for weighted sum, t2 for common sum.\n\tvoid ADD(int x,int y){\n\t\tx--;\n\t\tll tmp=1ll*y*x;\n\t\tfor(int i=x+n+1;i<=3*n;i+=i&-i)t1[i]+=tmp,t2[i]+=y;\n\t}\n\tll SUM(int x){\n\t\tll ret=0;\n\t\tfor(int i=x+n+1;i;i-=i&-i)ret-=t1[i],ret+=t2[i]*x;\n\t\treturn ret;\n\t}\n}\nnamespace BIT2{\n\tll t1[600100],t2[600100];\n\tvoid ADD(int x,int y){\n\t\tx++;\n\t\tll tmp=1ll*y*x;\n\t\tfor(int i=x+n+1;i;i-=i&-i)t1[i]+=tmp,t2[i]+=y;\n\t}\n\tll SUM(int x){\n\t\tll ret=0;\n\t\tfor(int i=x+n+1;i<=3*n;i+=i&-i)ret+=t1[i],ret-=t2[i]*x;\n\t\treturn ret;\n\t} \n}\nvoid ADD1(int x,int y,int z){BIT1::ADD(x-y,z);}\nvoid ADD2(int x,int y,int z){BIT2::ADD(y,z);}\nstruct Query{\n\tint x,y,id;\n\tQuery(int u=0,int v=0,int w=0){x=u,y=v,id=w;}\n\tfriend bool operator <(const Query &x,const Query &y){return x.x<y.x;}\n}q[400100];\nstruct Tri{\n\tint x,y,a;\n\tTri(int u=0,int v=0,int w=0){x=u,y=v,a=w;}\n\tfriend bool operator <(const Tri &x,const Tri &y){return x.x<y.x;}\n}p[800100];\nint main(){\n\tscanf(\"%d%d\",&n,&m);\n\tfor(int i=1;i<=n;i++)scanf(\"%d\",&a[i]);\n\tfor(int i=n;i>=1;i--){\n\t\twhile(tp&&a[i]>a[stk[tp]])l[stk[tp--]]=i;\n\t\tstk[++tp]=i;\n\t}\n\twhile(tp)l[stk[tp]]=stk[tp]-n-1,tp--;\n\tfor(int i=1;i<=n;i++){\n\t\twhile(tp&&a[stk[tp]]<=a[i])r[stk[tp--]]=i;\n\t\tstk[++tp]=i;\n\t}\n\twhile(tp)r[stk[tp--]]=n+1;\n\tfor(int i=1;i<=n;i++){\n\t\tp[++lim]=Tri(i-1,i-l[i]-2,-a[i]);\n\t\tp[++lim]=Tri(r[i]-1,r[i]-l[i]-2,a[i]);\n\t\tp[++lim]=Tri(r[i]-1,r[i]-i-2,-a[i]);\n\t}\n\tfor(int i=1;i<=lim;i++)ADD1(p[i].x,p[i].y,p[i].a);\n\tsort(p+1,p+lim+1);\n\tfor(int i=1,t,l,r;i<=m;i++){\n\t\tscanf(\"%d%d%d\",&t,&l,&r);\n\t\tq[++mil]=Query(l-1,t,-i);\n\t\tq[++mil]=Query(r,t,i);\n\t}\n\tsort(q+1,q+mil+1);\n\tfor(int i=1,j=1;i<=mil;i++){\n\t\twhile(j<=lim&&p[j].x<q[i].x)ADD1(p[j].x,p[j].y,-p[j].a),ADD2(p[j].x,p[j].y,p[j].a),j++;\n\t\tint lambda=(q[i].id>0?1:-1);q[i].id=abs(q[i].id);\n\t\tres[q[i].id]+=(BIT1::SUM(q[i].x-q[i].y)+BIT2::SUM(q[i].y))*lambda;\n\t}\n\tfor(int i=1;i<=m;i++)printf(\"%lld\\n\",res[i]);\n//\tfor(int i=1;i<=n;i++)printf(\"%d %d\\n\",l[i],r[i]);\n\treturn 0;\n} \n```",
        "postTime": 1606961319,
        "uid": 123369,
        "name": "xtx1092515503",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P6881 \u3010[JOI 2020 Final] \u706b\u4e8b\u3011"
    },
    {
        "content": "- \u9898\u610f: $mx[l][r]$ \u8868\u793a\u533a\u95f4 $(l,r)$ \u7684\u6700\u5927\u503c\uff0c\u8be2\u95ee  $\\sum_{i=L}^{R}max[i-T][i]$ \n\n------------\n\n\u968f\u7740\u65f6\u95f4\u7684\u63a8\u79fb\uff0c\u5927\u6570\u5b57\u4f1a\u8986\u76d6\u540e\u9762\u7684\u5c0f\u6570\u5b57\uff0c\u5bf9\u4e8e\u8986\u76d6\u6765\u8bb2\uff0c\u6bcf\u4e00\u4e2a\u6570\u5b57\u7684\u5f71\u54cd\u8303\u56f4\u9700\u8981\u8ba8\u8bba\u7684\u60c5\u51b5\u5c31\u8f83\u591a\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u5bf9\u4e8e\u6240\u6709\u7684\u201c\u8986\u76d6\u64cd\u4f5c\u201d\u5dee\u5206\u8f6c\u4e3a\u52a0\u51cf\u64cd\u4f5c\u3002\u90a3\u4e48\u6bcf\u4e00\u4e2a\u5dee\u5206\u540e\u6570\u5b57\u7684\u5f71\u54cd\u533a\u95f4\u5c31\u5982\u4e0b\u56fe\u3002\n![](https://cdn.luogu.com.cn/upload/image_hosting/ofkdhosz.png)\n\u4ece\u81ea\u5df1\u5f00\u59cb\u6269\u5c55\uff0c\u5230\u8fbe $r[i]-1$ \u540e\u505c\u6b62\u3002\n\n------------\n\n\u4e8e\u662f\u6211\u4eec\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u6570\u636e\u7ed3\u6784\u7ef4\u62a4\u3002\u6211\u4eec\u5c31\u662f\u8ba1\u7b97\u9762\u79ef\u4e2d\u7684\u6743\u503c\uff0c\u80fd\u60f3\u5230\u5dee\u5206\u3002\u79bb\u7ebf\u8be2\u95ee\u5c06\u7ad6\u76f4\u6bb5\u7ebf\u548c\u659c\u7ebf\u6bb5\u5206\u5f00\u5904\u7406\u5373\u53ef\u3002\n\n```\n#include<bits/stdc++.h>\nusing namespace std;\nlong long p1=1000000,p2=0;\nchar buf[1000005],wb[1000005];\n//long long gc() {\n//\tif(p1>=1000000)fread(buf,1,1000000,stdin),p1=0;\n//\treturn buf[p1++];\n//}\n#define gc getchar\nlong long getint() {\n\tlong long ret=0,flag=1;\n\tchar c=gc();\n\twhile(c<'0'||c>'9') {\n\t\tif(c=='-')flag=-1;\n\t\tc=gc();\n\t}\n\twhile(c<='9'&&c>='0') {\n\t\tret=(ret<<3)+(ret<<1)+c-'0';\n\t\tc=gc();\n\t}\n\treturn ret*flag;\n}\nvoid pc(char x) {\n\tif(p2>=1000000)fwrite(wb,1,1000000,stdout),p2=0;\n\twb[p2++]=x;\n}\nvoid wrt(long long x) {\n\tif(x<0)pc('-'),x=-x;\n\tlong long c[24]= {0};\n\tif(!x)return pc('0'),void();\n\twhile(x)c[++c[0]]=x%10,x/=10;\n\twhile(c[0])pc(c[c[0]--]+'0');\n}\nint n,Q;\nint s[200005],l[200005],r[200005];\nlong long a[200005],sum[200005];\nlong long ans[200005];\nstruct opr {\n\tint place;\n\tlong long val;\n};\nvector<opr> vec[200005];\nstruct que {\n\tint l,r,id;\n};\nvector<que> q[200005];\nstruct Segment_tree {\n\tstruct node {\n\t\tint l,r,len;\n\t\tlong long stag1,stag2;\n\t\tlong long val1,val2;\n\t} v[1200005];\n\tvoid push_sum1(int rt,long long val) {\n\t\tv[rt].stag1+=val;\n\t\tv[rt].val1+=val*v[rt].len;\n\t}\n\tvoid push_sum2(int rt,long long val) {\n\t\tv[rt].stag2+=val;\n\t\tv[rt].val2+=val*v[rt].len;\n\t}\n\tvoid push_down(int rt) {\n\t\tif(v[rt].stag1) {\n\t\t\tpush_sum1(rt<<1,v[rt].stag1);\n\t\t\tpush_sum1(rt<<1|1,v[rt].stag1);\n\t\t\tv[rt].stag1=0;\n\t\t}\n\t\tif(v[rt].stag2) {\n\t\t\tpush_sum2(rt<<1,v[rt].stag2);\n\t\t\tpush_sum2(rt<<1|1,v[rt].stag2);\n\t\t\tv[rt].stag2=0;\n\t\t}\n\t}\n\tvoid push_up(int rt) {\n\t\tv[rt].val1=v[rt<<1].val1+v[rt<<1|1].val1;\n\t\tv[rt].val2=v[rt<<1].val2+v[rt<<1|1].val2;\n\t}\n\tvoid build(int rt,int l,int r) {\n\t\tv[rt].l=l,v[rt].r=r,v[rt].len=v[rt].r-v[rt].l+1;\n\t\tif(l==r) {\n\t\t\tv[rt].val1=0,v[rt].val1=0;\n\t\t\treturn;\n\t\t}\n\t\tint mid=(l+r)>>1;\n\t\tbuild(rt<<1,l,mid);\n\t\tbuild(rt<<1|1,mid+1,r);\n\t\tpush_up(rt);\n\t}\n\tvoid add1(int rt,int l,int r,long long val) {\n\t\tif(l<=v[rt].l&&v[rt].r<=r) {\n\t\t\tpush_sum1(rt,val);\n\t\t\treturn;\n\t\t}\n\t\tint mid=(v[rt<<1].r);\n\t\tpush_down(rt);\n\t\tif(l<=mid)add1(rt<<1,l,r,val);\n\t\tif(mid<r)add1(rt<<1|1,l,r,val);\n\t\tpush_up(rt);\n\t}\n\tvoid add2(int rt,int l,int r,long long val) {\n\t\tif(l<=v[rt].l&&v[rt].r<=r) {\n\t\t\tpush_sum2(rt,val);\n\t\t\treturn;\n\t\t}\n\t\tint mid=(v[rt<<1].r);\n\t\tpush_down(rt);\n\t\tif(l<=mid)add2(rt<<1,l,r,val);\n\t\tif(mid<r)add2(rt<<1|1,l,r,val);\n\t\tpush_up(rt);\n\t}\n\tlong long ask1(int rt,int l,int r) {\n\t\tif(l<=v[rt].l&&v[rt].r<=r)return v[rt].val1;\n\t\tpush_down(rt);\n\t\tint mid=(v[rt<<1].r);\n\t\tif(r<=mid)return ask1(rt<<1,l,r);\n\t\tif(mid<l)return ask1(rt<<1|1,l,r);\n\t\treturn ask1(rt<<1,l,r)+ask1(rt<<1|1,l,r);\n\t}\n\tlong long ask2(int rt,int l,int r) {\n\t\tif(l<=v[rt].l&&v[rt].r<=r)return v[rt].val2;\n\t\tpush_down(rt);\n\t\tint mid=(v[rt<<1].r);\n\t\tif(r<=mid)return ask2(rt<<1,l,r);\n\t\tif(mid<l)return ask2(rt<<1|1,l,r);\n\t\treturn ask2(rt<<1,l,r)+ask2(rt<<1|1,l,r);\n\t}\n} S;\nint main() {\n\tn=getint();\n\tQ=getint();\n\tfor(int i=1; i<=n; i++)a[i]=getint(),sum[i]=sum[i-1]+a[i];\n\tfor(int i=1; i<=Q; i++) {\n\t\tint t=getint(),l=getint(),r=getint();\n\t\tans[i]=sum[r]-sum[l-1];\n\t\tq[t].push_back({l,r,i});\n\t}\n\tfor(int i=1; i<=n; ++i) {\n\t\twhile(s[0]&&a[i]>=a[s[s[0]]])r[s[s[0]--]]=i;\n\t\tl[i]=s[s[0]],s[++s[0]]=i;\n\t}\n\tfor(int i=1; i<=n; ++i) {\n\t\tif(l[i]) {\n\t\t\tvec[i-l[i]].push_back({i,a[l[i]]-a[i]});\n\t\t\tif(r[i])vec[r[i]-l[i]].push_back({r[i],a[i]-a[l[i]]});\n\t\t}\n\t}\n\tS.build(1,-n,n);\n\tfor(int i=1; i<=n; i++) {\n\t\tint vsz=vec[i].size(),qsz=q[i].size();\n\t\tfor(int j=0; j<vsz; j++)S.add1(1,-n,vec[i][j].place-i,vec[i][j].val),S.add2(1,-n,vec[i][j].place-1,vec[i][j].val);\n\t\tfor(int j=0; j<qsz; j++)ans[q[i][j].id]+=S.ask1(1,q[i][j].l-i,q[i][j].r-i)-S.ask2(1,q[i][j].l,q[i][j].r);\n\t}\n\tfor(int i=1; i<=Q; i++)wrt(ans[i]),pc('\\n');\n\tfwrite(wb,1,p2,stdout);\n\treturn 0;\n}\n```",
        "postTime": 1603708898,
        "uid": 27338,
        "name": "jerry3128",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P6881 \u3010[JOI 2020 Final] \u706b\u4e8b\u3011"
    },
    {
        "content": "\u7ed9\u5b9a $a_{1\\cdots n}$\uff0c\u8bb0 $[a_i]^T=\\max_{j=\\max(1,i-T)}^i\\{a_j\\}$\uff0c$q$ \u6b21\u8be2\u95ee\u7ed9\u5b9a $T,l,r$\uff0c\u6c42 $\\sum_{i=l}^r [a_i]^T$\u3002\n\n$n,q\\leq 2\\times 10^5$\uff0c$1\\leq a_i\\leq 10^9$\u3002\n\n\u4ee5\u589e\u91cf\u7684\u5f62\u5f0f\u63cf\u8ff0\u6bcf\u4e2a\u70b9\u5411\u53f3\u8986\u76d6\u5e26\u6765\u7684\u5f71\u54cd\u3002\u5bf9\u4e8e\u6bcf\u4e2a\u70b9\u627e\u5230\u5176\u5de6\u8fb9\u7b2c\u4e00\u4e2a\u6bd4\u81ea\u5df1\u4e25\u683c\u5927\u7684\u70b9\u4f5c\u4e3a\u7236\u4eb2\uff0c\u5219 $i$ \u7684\u5b50\u6811\u662f\u4e00\u4e2a\u533a\u95f4 $[i,r_i]$\uff0c\u6ee1\u8db3 $r_i+1$ \u662f\u4e00\u4e2a\u6bd4\u81ea\u5df1\u5927\u7684\u4f4d\u7f6e\uff0c\u610f\u4e49\u662f\u6bcf\u4e2a\u70b9\u4f1a\u5f71\u54cd\u5230\u81ea\u5df1\u7684\u5b50\u6811\uff0c\u6bcf\u4e2a\u70b9\u4e0a\u7684\u503c\uff0c\u4f1a\u4f9d\u6b21\u88ab\u81ea\u5df1\u7956\u5148\u5f71\u54cd\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u5bf9\u4e8e\u5b58\u5728\u7236\u4eb2\u7684\u70b9 $l$\uff0c$[l,r_l]$ \u4e2d\u7684\u70b9\u4f1a\u4ece\u65f6\u523b $t=l-fa_l$ \u5f00\u59cb\uff0c\u9010\u6b65\u52a0\u4e0a $d=a_{fa_l}-a_l$\uff0c\u5373\u5728 $t+i$\uff08$i\\ge 0$\uff09\u65f6\u523b\uff0c$a_{l+i}$ \u4f1a\u52a0\u4e0a $d$\u3002\n\n\u5bf9\u4e8e\u8fd9\u6837\u4e00\u4e2a\u56db\u5143\u7ec4 $(t,l,r,d)$\uff0c\u6211\u4eec\u628a\u5b83\u62c6\u6210\u6ca1\u6709\u53f3\u7aef\u70b9\u7684 $(t,l,d)$ \u4e0e $(t+r-l+1,r+1,-d)$\uff0c\u8fd9\u6837\u5c31\u662f\u6709 $O(n)$ \u4e2a\u4e09\u5143\u7ec4 $(t,l,d)$\uff0c\u8868\u793a\u4ece $t$ \u65f6\u523b\u5f00\u59cb\uff0c$l$ \u4f4d\u7f6e\u5f00\u59cb\u7684\u5143\u7d20\u4f1a\u4f9d\u6b21\u52a0\u4e0a $d$\u3002\n\n\u8be2\u95ee\u62c6\u6210\u524d\u7f00\u4e4b\u540e\u5c31\u5f62\u5982 $(T,x)$\uff0c\u8868\u793a\u8be2\u95ee $T$ \u65f6\u523b\u524d\u7f00 $[1,x]$ \u7684\u548c\u3002\u8003\u8651\u589e\u91cf\u4e09\u5143\u7ec4 $(t,l,d)$ \u5bf9\u8be2\u95ee $(T,x)$ \u7684\u8d21\u732e\uff1a\u5982\u679c $x\\ge l$ \u4e14 $T\\ge t$\uff0c\u5219\u4f1a\u8d21\u732e $d\\times \\min(x-l+1,T-t+1)$\u3002\n\n\u4f60\u53d1\u73b0\u94a6\u5b9a $\\min$ \u4e5f\u6709\u4e09\u4e2a\u504f\u5e8f\u5173\u7cfb\uff0c\u4f46\u662f\u522b\u6025\u3002\u5047\u8bbe\u94a6\u5b9a $x-l+1\\leq T-t+1$\uff0c\u79fb\u9879\u53d8\u4e3a $x-T\\leq l-t$\uff0c\u5219\u6b64\u65f6\u5982\u679c\u6ee1\u8db3 $x\\ge l$ \u4e14 $x-l+1\\leq T-t+1$\uff0c\u5219 $T-t+1\\ge (x-l)+1\\ge 1$\uff0c\u5929\u7136\u6ee1\u8db3 $T\\ge t$\u3002\n\n\u4e8e\u662f\u79bb\u7ebf\u6309\u7167 $x,l$ \u53cc\u6307\u9488\uff0c$l-t$ \u4e3a\u4e0b\u6807\u653e\u5165\u6811\u72b6\u6570\u7ec4\u7ef4\u62a4 $\\sum d$ \u548c $\\sum td$\u3002\u53e6\u4e00\u90e8\u5206\u540c\u7406\u3002\n\n$O(n\\log n)$\u3002\n\n```cpp\n#include<bits/stdc++.h>\n#define For(i,a,b) for(int i=(a),i##END=(b);i<=i##END;i++)\n#define Rof(i,b,a) for(int i=(b),i##END=(a);i>=i##END;i--)\n#define go(u) for(int i=head[u];i;i=nxt[i])\n#define int long long\nusing namespace std;\ninline int read(){\n    int x=0,f=1;\n    char ch=getchar();\n    while(ch<'0'||ch>'9'){if(ch=='-')f=-1;ch=getchar();}\n    while(ch>='0'&&ch<='9'){x=(x<<1)+(x<<3)+(ch^48);ch=getchar();}\n    return x*f;\n}\nconst int N=4e5+10,D=2e5+1; \nint n,q,m,o,a[N],s[N],ans[N];\nstruct mdf{int t,l,d;}b[N];\nbool cmp1(mdf a,mdf b){return a.t<b.t;}\nbool cmp2(mdf a,mdf b){return a.l<b.l;}\nstruct qry{\n\tqry(){}\n\tqry(int tt,int xx,int mm,int ii){T=tt,x=xx,mul=mm,id=ii;}\n\tint T,x,mul,id;\n}z[N];\nbool CMP1(qry a,qry b){return a.T<b.T;}\nbool CMP2(qry a,qry b){return a.x<b.x;}\nvoid ADD(int t,int l,int r,int d){b[++m]=(mdf){t,l,d},b[++m]=(mdf){t+r-l+1,r+1,-d};}\nint fa[N],R[N],stk[N],tp;\nstruct BIT{\n\t#define lowbit(x) (x&-x)\n\tint c[N],sum;\n\tvoid init(){memset(c,0,sizeof c),sum=0;}\n\tvoid add(int u,int x){sum+=x,u+=D;for(int i=u;i<N;i+=lowbit(i))c[i]+=x;}\n\tint ask(int u,int s=0){u+=D;for(int i=u;i;i-=lowbit(i))s+=c[i];return s;}//<=u\n\tint ASK(int u){return sum-ask(u);}//>u\n}c1,c2;\nsigned main(){\n\tn=read(),q=read();For(i,1,n)a[i]=read(),s[i]=s[i-1]+a[i];\n\tRof(i,n,1){while(tp&&a[i]>a[stk[tp]])fa[stk[tp--]]=i;stk[++tp]=i,R[i]=i;}\n\tFor(i,1,n)if(fa[i])R[fa[i]]=i;Rof(i,n,1)R[fa[i]]=max(R[fa[i]],R[i]);\n\tFor(l,1,n){int r=R[l];if(fa[l])ADD(l-fa[l],l,r,a[fa[l]]-a[l]);}\n\tFor(i,1,q){\n\t\tint t=read(),l=read(),r=read();\n\t\tz[++o]=qry(t,r,1,i);\n\t\tz[++o]=qry(t,l-1,-1,i);\n\t\tans[i]=s[r]-s[l-1];\n\t}sort(b+1,b+1+m,cmp2),sort(z+1,z+1+o,CMP2);//l<=x\n\tfor(int i=1,j=1;i<=o;i++){\n\t\tint T=z[i].T,x=z[i].x,mul=z[i].mul,id=z[i].id;\n\t\twhile(j<=m&&b[j].l<=z[i].x){\n\t\t\tint t=b[j].t,l=b[j].l,d=b[j].d;j++;\n\t\t\tc1.add(l-t,d),c2.add(l-t,l*d);\n\t\t}ans[id]+=mul*((x+1)*c1.ASK(x-T-1)-c2.ASK(x-T-1));\n\t}\n\tc1.init(),c2.init();\n\tsort(b+1,b+1+m,cmp1),sort(z+1,z+1+o,CMP1);//t<=T\n\tfor(int i=1,j=1;i<=o;i++){\n\t\tint T=z[i].T,x=z[i].x,mul=z[i].mul,id=z[i].id;\n\t\twhile(j<=m&&b[j].t<=z[i].T){\n\t\t\tint t=b[j].t,l=b[j].l,d=b[j].d;j++;\n\t\t\tc1.add(l-t,d),c2.add(l-t,t*d);\n\t\t}ans[id]+=mul*((T+1)*c1.ask(x-T-1)-c2.ask(x-T-1));\n\t}For(i,1,q)printf(\"%lld\\n\",ans[i]);\n\treturn 0;\n}\n```\n\n",
        "postTime": 1666269314,
        "uid": 447750,
        "name": "luogubot",
        "ccfLevel": 0,
        "title": "P6881"
    },
    {
        "content": "\u6211\u4eec\u8003\u8651\u7ef4\u62a4\u589e\u91cf\uff0c\u5c06\u6bcf\u4e00\u4e2a\u4f4d\u7f6e\u4e0e\u524d\u8fb9\u7b2c\u4e00\u4e2a\u5927\u4e8e\u5b83\u7684\u4f4d\u7f6e\u8fde\u8fb9\uff0c\u8fb9\u7684\u6743\u503c\u4e3a\u5927\u51cf\u5c0f\uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u4e00\u4e2a\u68ee\u6797\uff0c\u53d1\u73b0\u65f6\u95f4\u7ebf\u6bcf\u589e\u52a0\u4e00\uff0c\u5c31\u662f\u5728\u6811\u4e0a\u5c06\u6bcf\u6761\u8fb9\u7684\u6743\u503c\u5411\u4e0b\u4f20\u9012\u4e00\u6b21\uff0c\u6216\u8005\u53ef\u4ee5\u7406\u89e3\u4e3a\u6bcf\u6761\u8fb9\u5bf9\u5e94\u7740\u4e00\u4e2a\u4e00\u6b21\u51fd\u6570\uff0c\u8fd9\u4e2a\u4e00\u6b21\u51fd\u6570\u5728\u67d0\u4e2a\u4f4d\u7f6e\uff0c\u5e76\u4e14\u6709\u9650\u5236\u7684\u5b9a\u4e49\u57df\u3002\u4e00\u6761\u8fb9\u80fd\u8d21\u732e\u7684\u4f4d\u7f6e\u4e00\u5b9a\u662f\u8fde\u7eed\u7684\u4e00\u6bb5\uff0c\u6211\u4eec\u628a\u6bcf\u6761\u8fb9\u7684\u8d21\u732e\u79bb\u7ebf\u4e0b\u6765\uff0c\u7136\u540e\u6309\u7167\u65f6\u95f4\u8f74\u626b\u3002\n\n\u8bbe\u4e00\u6761\u8fb9\u7684\u8d21\u732e\u4e3a\u4e00\u4e2a\u56db\u5143\u7ec4\u7684\u5f62\u5f0f $(p,t,te,d)$ \u8868\u793a\u8fd9\u6761\u8fb9\u4ece\u7b2c $p$ \u4e2a\u4f4d\u7f6e\uff0c\u7b2c $t$ \u79d2\u5f00\u59cb \u4ea7\u751f\u8d21\u732e\uff0c\u7b2c $te$ \u79d2\u65f6\u5c31\u6ca1\u6709\u4e86\u8d21\u732e\u3002\u4e8e\u662f\u4e00\u6b21\u67e5\u8be2\u5b9e\u9645\u4e0a\u5c31\u662f\u67e5\u8be2\u6240\u6709\u7684\u8fb9\u5bf9\u67e5\u8be2\u7684\u4f4d\u7f6e\u9020\u6210\u7684\u8d21\u732e\uff0c\u8003\u8651\u628a\u8be2\u95ee\u5dee\u5206\u6210\u6c42 $l-1$ \u548c $r$ \u4e24\u4e2a\u524d\u7f00\uff0c\u8fd9\u6837\u5c31\u5c11\u4e86\u4e00\u4e2a\u8fb9\u754c\u9650\u5236\u3002\u4e8e\u662f\u5bf9\u4e8e\u4e00\u4e2a\u8be2\u95ee $(x,i)$\uff0c\u5373\u8be2\u95ee\u7b2ci\u79d2\u65f6x\u4f4d\u7f6e\u7684\u524d\u7f00\u548c\uff0c\u4e00\u6761\u8fb9\u7684\u8d21\u732e\u5c31\u662f\n\n$$\nd \\times (\\min(p+i-t,x)-\\min(p,x))\n$$\n(\u76ee\u524d\u8fd9\u4e2a\u5f0f\u5b50\u662f\u4e0d\u4e25\u8c28\u7684\uff0c\u540e\u9762\u4f1a\u8bf4\u4e00\u70b9\u7ec6\u8282)  \n\n\u5f0f\u5b50\u7684\u610f\u4e49\u5c31\u662f\u8003\u8651\u5f53\u524d\u8fd9\u6761\u8fb9\u5df2\u7ecf\u6269\u5c55\u5230\u4e86\u54ea\u4e2a\u4f4d\u7f6e\uff0c\u7ec8\u70b9\u4e0e\u8d77\u70b9\u4f5c\u5dee\u7b97\u51fa\u6765\u6269\u5c55\u4e86\u591a\u5c11\u4e2a\u4f4d\u7f6e\uff0c\u53d6 $\\min$ \u662f\u53bb\u6389\u4e00\u4e9b\u4e0d\u5408\u6cd5\u7684\u8fb9\u3002  \n\n\u9996\u5148\uff0c\u8fd9\u4e2a\u5f0f\u5b50\u53ea\u5bf9\u8fd8\u4e3a\u7ec8\u6b62\u8d21\u732e\u7684\u8fb9\u6709\u6548\uff0c\u4e5f\u5c31\u662f $te$ \u5927\u4e8e\u5f53\u524d\u65f6\u95f4\u7684\u8fb9\uff0c\u5982\u679c\u4e00\u6761\u8fb9\u5df2\u7ecf\u7ec8\u6b62\u8d21\u732e\uff0c\u90a3\u4e48\u5176\u7684\u8d21\u732e\u5f62\u5f0f\u5c31\u53d8\u6210\u4e86\u4e00\u4e2a\u5e38\u51fd\u6570\uff0c\u76f4\u63a5\u628a\u5b83\u533a\u95f4\u52a0\u5230\u5e8f\u5217\u4e0a\u5c31\u884c\u3002  \n\n\u5176\u6b21\uff0c\u5bf9\u4e8e\u4e0a\u8fb9\u8fd9\u4e2a\u5f0f\u5b50\uff0c\u6211\u4eec\u5f88\u5b8c\u7f8e\u7684\u628a\u4e0d\u5408\u6cd5\u7684\u90e8\u5206\u53bb\u6389\uff0c\u4f46\u662f\u5de6\u8fb9\u7684 $\\min$ \u662f\u7ec8\u70b9\uff0c\u53f3\u8fb9\u7684 $\\min$ \u662f\u8d77\u70b9\uff0c\u5bf9\u4e8e\u5408\u6cd5\u7684\u8fb9\uff0c\u6211\u4eec\u7b97\u533a\u95f4\u957f\u5ea6\u65f6\u5e76\u6ca1\u6709\u52a0\u4e00\uff0c\u4e8e\u662f\u9700\u8981\u7279\u6b8a\u8003\u8651\u4e00\u4e0b\u3002\n\n\u5bf9\u4e8e\u4e0a\u8fb9\u8fd9\u4e2a\u5f0f\u5b50\uff0c\u6211\u4eec\u628a\u5de6\u8fb9\u7684 $\\min$ \u91cc\u7684 $i$ \u63d0\u51fa\u6765\uff0c\u53d8\u6210\n$$\nd \\times (i+\\min(p-t,x-i)-\\min(p,x))\n$$\n\n\u8fd9\u6837\u8be2\u95ee\u7684\u65f6\u95f4\u5c31\u4e0e\u8fb9\u65e0\u5173\u4e86\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u9759\u6001\u7684\u7ef4\u62a4\u4e00\u4e9b\u4e1c\u897f\u3002\u7531\u4e8e\u53d6 $\\min$\u5e76\u4e0d\u592a\u597d\u641e\uff0c\u4e8e\u662f\u6211\u4eec\u8003\u8651\u5206\u60c5\u51b5\u8ba8\u8bba $\\min$ \u5230\u5e95\u53d6\u4e86\u8c01\uff0c\u7528\u4e24\u68f5\u7ebf\u6bb5\u6811\u7ef4\u62a4 $(p-t) \\times d$\uff0c$p \\times d$\uff0c\u7ebf\u6bb5\u6811\u7684\u4e0b\u6807\u5c31\u5206\u522b\u662f $p$ \u548c $p-t$\uff0c\u7136\u540e\u5bf9\u4e8e\u4e24\u79cd\u4e0b\u6807\uff0c\u518d\u5f00\u4e24\u68f5\u7ebf\u6bb5\u6811\u7ef4\u62a4\u6bcf\u4e2a\u4f4d\u7f6e\u4e0a\u7684 $d$\uff0c\u7136\u540e\u6211\u4eec\u5c31\u53ef\u4ee5\u8ba8\u8bba $\\min$ \u53d6\u54ea\u4e00\u9879\uff0c\u7136\u540e\u53d6\u51fa\u5bf9\u5e94\u7684\u6811\u4e0a\u7684\u4fe1\u606f\u7b97\u5c31\u884c\uff0c\u6ce8\u610f\u5f53\u4e00\u6761\u8fb9\u5408\u6cd5\u7684\u65f6\u5019\uff0c\u8fd8\u9700\u8981\u7ef4\u62a4 $d$ \u7684\u4e0b\u6807\u4e3a $p-t$ \u90a3\u68f5\u6811\u7684\u5408\u6cd5\u7684\u90a3\u4e00\u90e8\u5206\u518d\u52a0\u4e00\u6b21\uff0c\u4e5f\u5c31\u662f\u7b97\u533a\u95f4\u957f\u5ea6\u65f6\u7684\u90a3\u4e2a\u52a0\u4e00\u3002\n\n\u7eaf\u6587\u5b57\u63cf\u8ff0\u6bd4\u8f83\u4e4f\u529b\uff0c\u4e0d\u61c2\u53ef\u4ee5\u770b\u4ee3\u7801\u3002\n\n## code\n\n```cpp\n\n\n#include <bits/stdc++.h>\ntypedef long long ll;typedef unsigned long long ull; typedef double db;typedef long double ldb;\n#define fre(x) freopen(#x \".in\",\"r\",stdin),freopen(#x \".out\",\"w\",stdout)\n#define Rep(i,a,b) for(int i=a;i<=b;++i) \n#define Dwn(i,a,b) for(int i=a;i>=b;--i)\n#define pii pair<int,int>\n#define mair make_pair\n#define fir first\n#define sec second\n#define int ll\nusing namespace std;\n\nconst int maxn=5e5+10,LN=-maxn+8,RN=maxn-8,INF=1e9+20051107; \n\n#define gc if(++ip==ie)fread(ip=buf,1,SZ,stdin)\nconst int SZ=1<<21;char buf[SZ],*ie=buf+SZ,*ip=ie-1;\ninline int read(){ gc;while(*ip<'-')gc; bool f=*ip=='-';if(f)gc; int x=*ip&15;gc; while(*ip>'-'){x*=10;x+=*ip&15;gc;} return f ? -x : x; }\nstruct Seg{\n\tll tr[maxn<<2],lazy[maxn<<2];\n\tvoid Pushup(int rt){tr[rt]=tr[rt<<1]+tr[rt<<1|1];}\n\tvoid Update(int rt,int l,int r,ll w){ tr[rt]+=(r-l+1)*w;lazy[rt]+=w; }\n\tvoid Pushdown(int rt,int l,int r){\n\t\tint mid=(l+r)>>1;\n\t\tUpdate(rt<<1,l,mid,lazy[rt]),Update(rt<<1|1,mid+1,r,lazy[rt]),lazy[rt]=0;\n\t}\n\tvoid Modify(int rt,int l,int r,int s,int t,ll w){\n\t\tif(s<=l && t>=r)return Update(rt,l,r,w);\n\t\tint mid=(l+r)>>1;\n\t\tif(lazy[rt])Pushdown(rt,l,r);\n\t\tif(s<=mid)Modify(rt<<1,l,mid,s,t,w);\n\t\tif(t>mid)Modify(rt<<1|1,mid+1,r,s,t,w);\n\t\tPushup(rt);\n\t}\n\tint Query(int rt,int l,int r,int s,int t){\n\t\tif(!tr[rt])return 0;\n\t\tif(s<=l && t>=r)return tr[rt];\n\t\tint mid=(l+r)>>1,res=0;\n\t\tif(lazy[rt])Pushdown(rt,l,r);\t\n\t\tif(s<=mid)res+=Query(rt<<1,l,mid,s,t);\n\t\tif(t>mid)res+=Query(rt<<1|1,mid+1,r,s,t);\n\t\treturn res;\n\t}\n}KA,KB,KxA,KxB,C;\n\nint n,q;ll a[maxn>>1],ans[maxn>>1];\nint L[maxn>>1],R[maxn>>1];\n\nstruct Ver{ int opt,p,t,d; };\n\nvector<pii>Q[maxn>>1];\nvector<Ver>Op[maxn>>1];\n\nint st[maxn>>1],top;\n\nvoid Sol(int Tim){\n\tfor(auto it : Op[Tim]){\n\t\tif(it.opt==1){\n\t\t\tKxA.Modify(1,LN,RN,it.p,it.p,it.d);\n\t\t\tKxB.Modify(1,LN,RN,it.p-it.t,it.p-it.t,it.d);\n\t\t\tKA.Modify(1,LN,RN,it.p,it.p,it.p*it.d);\n\t\t\tKB.Modify(1,LN,RN,it.p-it.t,it.p-it.t,(it.p-it.t)*it.d);\n\t\t}else{\n\t\t\tKxA.Modify(1,LN,RN,it.p,it.p,-it.d);\n\t\t\tKxB.Modify(1,LN,RN,it.p-it.t,it.p-it.t,-it.d);\n\t\t\tKA.Modify(1,LN,RN,it.p,it.p,-it.p*it.d);\n\t\t\tKB.Modify(1,LN,RN,it.p-it.t,it.p-it.t,-(it.p-it.t)*it.d);\n\t\t\tC.Modify(1,1,n,it.p,it.p+Tim-it.t-1,it.d);\n\t\t}\n\t}\n\tfor(auto it : Q[Tim]){\n\t\tint x=it.fir;if(x==0)continue;\n\t\tll res=Tim*KxA.tr[1]+a[x];\n\t\tres+=KB.Query(1,LN,RN,LN,x-Tim);\n\t\tres+=KxA.Query(1,LN,RN,LN,x);\n\t\tres-=KA.Query(1,LN,RN,LN,x);\n\t\tres+=KxB.Query(1,LN,RN,x-Tim+1,RN)*(x-Tim);\n\t\tres-=KxA.Query(1,LN,RN,x+1,RN)*x;\n\t\tres+=C.Query(1,1,n,1,x);\n\t\tif(it.sec>0)ans[it.sec]+=res;\n\t\telse ans[-it.sec]-=res;\n\t}\n}\n\nvoid solve(){//fre(o);\n\tn=read(),q=read();\n\tRep(i,1,n)a[i]=read();\n\tRep(i,1,n){\n\t\twhile(top && a[i]>=a[st[top]])R[st[top--]]=i;\n\t\tL[i]=st[top];\n\t\tst[++top]=i;\n\t}\n\twhile(top)R[st[top--]]=n+1;\n\tRep(i,1,n)if(L[i]){\n\t\tint t=i-L[i],d=a[L[i]]-a[i],tx=R[i]-i;\n\t\tOp[t].push_back(Ver{1,i,t,d});\n\t\tOp[t+tx].push_back(Ver{-1,i,t,d});\n\t}\n\tRep(i,1,q){\n\t\tint t,l,r;\n\t\tt=read(),l=read(),r=read();\n\t\tQ[t].push_back(mair(l-1,-i));\n\t\tQ[t].push_back(mair(r,i));\n\t}\n\tRep(i,1,n)a[i]+=a[i-1];\n\tRep(i,1,n)Sol(i);\n\tRep(i,1,q)printf(\"%lld\\n\",ans[i]);\n}\n\n#undef int \nint main (){ return solve(),0; }\n\n\n```",
        "postTime": 1663315770,
        "uid": 277792,
        "name": "Delov",
        "ccfLevel": 7,
        "title": "P6881\u9898\u89e3"
    },
    {
        "content": "## [\u9898\u76ee\u4f20\u9001\u95e8](https://www.luogu.com.cn/problem/P6881)\n\u6211\u4eec\u9996\u5148\u6765\u5eb7\u4e00\u5eb7\u9898\u76ee ~~(\u6709\u70b9\u7cca\u4e86)~~\uff1a\n![](https://cdn.luogu.com.cn/upload/image_hosting/18e30h03.png)\n~~\u4e4d\u4e00\u770b\uff0c\u5c31\u662f\u4e00\u9053\u7ebf\u6bb5\u6811\uff0c\u53ef\u5b9e\u9645\u4e0a\u5462\uff0c\u4e5f\u5c31\u662f\u4e00\u9053\u7ebf\u6bb5\u6811\u3002~~\n\n\u597d\u4e86\u597d\u4e86\uff0c\u5207\u5165\u6b63\u9898\u3002\n\n---\n\u8fd9\u9053\u9898\u6709\u4e24\u79cd\u601d\u8def\uff1a\n\n**\u7b2c\u4e00\u79cd\uff1a**\n- \u5148\u4ee5\u4f4d\u7f6e\u4e3a\u6a2a\u8f74,\u65f6\u523b\u4e3a\u6570\u8f74,\u5199\u51fa\u4e00\u4e2a\u77e9\u9635,\u6bcf\u4e00\u4f4d\u5206\u522b\u5bf9\u5e94\u6bcf\u4e2a\u65f6\u523b\u6bcf\u4e2a\u4f4d\u7f6e\u7684\u6743\u503c.\u7136\u540e\u8003\u8651\u6bcf\u4e2a\u4f4d\u7f6e\u5bf9\u8fd9\u91cc\u6743\u503c\u53d8\u5316\u7684\u8d21\u732e\u3002\n- \u5bf9\u4e8e\u4e00\u4e2a\u4f4d\u7f6e $i$ ,\u5b83\u53ef\u4ee5\u5728\u4e4b\u540e\u7684\u4e00\u6bb5\u65f6\u95f4\u5185\u8986\u76d6\u540e\u9762\u4e00\u6bb5\u6743\u503c\u66f4\u5c0f\u7684\u4f4d\u7f6e,\u76f4\u5230\u78b0\u5230\u6743\u503c $\u2265$ \u5b83\u7684\u4f4d\u7f6e\u540e\u505c\u6b62,\u8bbe\u8fd9\u4e2a\u505c\u6b62\u4f4d\u7f6e\u4e3a $nti$ (\u8fd9\u4e2a\u4f4d\u7f6e\u663e\u7136\u662f $i$ \u540e\u9762\u7b2c\u4e00\u4e2a\u6743\u503c\u4e0d\u5c0f\u4e8e $i$ \u7684\u4f4d\u7f6e),\u90a3\u4e48\u5728  $t\u2208[1,nti\u2212i)$ \u65f6\u523b\u7b2c $i+t$ \u4f4d\u7f6e\u7684\u6743\u503c\u4f1a\u88ab\u8986\u76d6\u4e3a $si$ .\u6211\u4eec\u628a\u4e0a\u8ff0\u7684\u8986\u76d6\u770b\u505a\u662f\u5148\u51cf\u53bb\u539f\u6765\u7684\u503c,\u7136\u540e\u52a0\u4e0a\u73b0\u5728\u7684\u503c,\u90a3\u4e48\u4e5f\u5c31\u662f $i$ \u53f7\u4f4d\u4f1a\u5728 $t$ \u65f6\u523b\u7ed9 $i+t$ \u53f7\u4f4d\u52a0\u4e0a $si$ \u3002\n\n- \u7136\u540e\u8003\u8651\u51cf\u6743\u503c\u90e8\u5206.\u4e00\u4e2a\u4f4d\u7f6e\u7684\u6743\u503c\u663e\u7136\u662f\u88ab\u5f80\u524d\u8d70\u7b2c\u4e00\u4e2a\u6743\u503c\u66f4\u5927\u7684\u4f4d\u7f6e\u8986\u76d6,\u8bb0\u6b64\u4f4d\u7f6e\u4e3a $fti$ ,\u90a3\u4e48\u4ece $fti$ \u4e0a\u7684\u6743\u503c\u8986\u76d6\u5230 $i$ \u5f00\u59cb,\u4e4b\u540e\u4e00\u6bb5\u65f6\u95f4\u8fd8\u4f1a\u53bb\u4f9d\u6b21\u8986\u76d6\u540e\u9762\u7684\u4e00\u4e9b\u4f4d\u7f6e,\u76f4\u5230\u5230 $nti$ \u8fd9\u4e00\u4f4d\u6ca1\u6709 $i$ \u8986\u76d6\u7684\u8d21\u732e.\u5f62\u5f0f\u5316\u7684\u8bb2,\u5c31\u662f\u5728 $t\u2208[i\u2212fti,nti\u2212fti)$ \u65f6\u523b,\u7b2c $i+t\u2212(i\u2212fti)$ \u4f4d\u4f1a\u51cf\u53bb\u539f\u6709\u6743\u503c,\u5373 $si$ \u3002\n- \u53ef\u4ee5\u53d1\u73b0\u4e0a\u8ff0\u7684\u8d21\u732e\u603b\u6570\u662f\u5728 $O(n)$ \u7ea7\u522b\u7684.\u5bf9\u4e8e\u4e00\u4e2a\u8be2\u95ee $(t,l,r)$ ,\u5148\u5957\u8def\u7684\u62c6\u6210\u662f $(t,1,r)\u2212(t,1,l\u22121)$ .\u7136\u540e\u73b0\u5728\u4e00\u4e2a $(t,1,i)$ \u5c31\u662f\u5728\u7eb5\u5750\u6807\u4e3a $t$ \u7684\u4e00\u6392\u91cc\u524d $i$ \u4f4d\u7684\u548c.\u73b0\u5728\u6211\u4eec\u628a\u539f\u6765\u7684\u5bf9\u5e94\u6bcf\u4e2a\u65f6\u523b\u6bcf\u4e2a\u4f4d\u7f6e\u7684\u6743\u503c\u7684\u77e9\u9635\u7684\u76f8\u90bb\u4e24\u884c\u5dee\u5206,\u5c31\u53ef\u4ee5\u5dee\u5206\u77e9\u9635\u4e3a\u524d\u9762\u8ba8\u8bba\u5230\u7684\u6240\u6709\u8d21\u732e\u7684\u53e0\u52a0,\u5176\u4e2d\u4e00\u79cd\u8d21\u732e\u5728\u5dee\u5206\u540e\u7684\u77e9\u9635\u4e0a\u662f\u4e00\u6bb5\u659c\u7740\u7684\u7ebf\u6bb5.\u53e6\u5916\u73b0\u5728\u7684\u6bcf\u4e2a\u8be2\u95ee\u4e5f\u5c31\u662f\u5bf9\u5e94\u533a\u95f4\u7684\u521d\u503c\u52a0\u4e00\u4e2a\u524d\u7f00\u7684\u77e9\u9635\u7684\u548c\n- \u5bf9\u4e8e\u4e00\u4e2a\u659c\u7684\u7ebf\u6bb5,\u8d77\u59cb\u70b9\u548c\u7ec8\u6b62\u70b9\u5206\u522b\u4e3a $(x,y),(x\u2032,y\u2032)$ ,\u6211\u4eec\u53ef\u4ee5\u770b\u6210\u662f\u4e00\u4e2a\u6b63\u8d21\u732e\u70b9 $(x,y)$ \u548c\u4e00\u4e2a\u8d1f\u8d21\u732e\u70b9 $(x\u2032+1,y\u2032+1)$ \u5f80\u53f3\u4e0a\u65b9\u7684\u8d21\u732e\n- \u5bf9\u4e00\u4e2a\u8d21\u732e\u70b9 $(x,y)$ ,\u8bbe\u5176\u6743\u503c\u4e3a $w$ ,\u5bf9\u8be2\u95ee $(t,1,i)(i\u2265x,t\u2265y)$ \u7684\u8d21\u732e\u4e3a $w\u2217min(t\u2212y+1,i\u2212x+1)$ .\u90a3\u4e48\u53ef\u4ee5\u53d1\u73b0\u53d6\u51fa $(i,t)$ \u70b9\u6240\u5728\u7684\u5de6\u4e0b-\u53f3\u4e0a\u5bf9\u89d2\u7ebf\u540e,\u53d6\u5230 $t\u2212y+1$ \u8fd9\u4e00\u90e8\u5206\u7684\u8d21\u732e\u70b9\u5168\u5728\u5bf9\u89d2\u7ebf\u4e0a\u65b9,\u53cd\u4e4b\u5168\u5728\u5bf9\u89d2\u7ebf\u4e0b\u65b9.\u6240\u4ee5\u5bf9\u4e8e\u5bf9\u89d2\u7ebf\u8fdb\u884c\u626b\u63cf\u7ebf,\u5148\u628a\u6240\u6709\u8d21\u732e\u70b9\u653e\u5728\u5bf9\u89d2\u7ebf\u4e0b\u65b9\u7684\u8d21\u732e\u91cc,\u7136\u540e\u626b\u5230\u5f53\u524d\u5bf9\u89d2\u7ebf\u540e\u628a\u7ebf\u4e0a\u7684\u8d21\u732e\u70b9\u8d21\u732e\u4e00\u5230\u5bf9\u89d2\u7ebf\u4e0a\u65b9\u7684\u8d21\u732e\u91cc;\u5bf9\u4e8e\u7aef\u70b9\u7ecf\u8fc7\u5f53\u524d\u5bf9\u89d2\u7ebf\u7684\u8be2\u95ee,\u53ea\u8981\u67e5\u8be2\u524d\u7f00 $i$ \u7684\u4e0b\u65b9\u8d21\u732e\u4ee5\u53ca\u524d\u7f00 $t$ \u7684\u4e0a\u65b9\u8d21\u732e\u5373\u53ef.\u6211\u4eec\u628a\u8d21\u732e\u8bb0\u5728\u6811\u72b6\u6570\u7ec4\u91cc,\u5982\u679c\u6811\u72b6\u6570\u7ec4\u4e0a\u7b2c $i$ \u4e3a\u6743\u503c\u4e3a $wi$ ,\u90a3\u4e48\u5bf9\u8be2\u95ee\u524d\u7f00 $n$ \u7684\u8d21\u732e\u4e3a $(n\u2212i+1)wi$ ,\u628a\u8d21\u732e\u62c6\u4e3a $(n+1)wi$ \u548c $\u2212iwi$ \u4e24\u90e8\u5206,\u90a3\u4e48\u6811\u72b6\u6570\u7ec4\u5206\u522b\u7ef4\u62a4 $\u2211wi$ , $\u2211iwi$ \u5373\u53ef\n\n---\n\u6700\u540e\uff0c\u4ee3\u7801\uff1a\n```cpp\n#include <bits/stdc++.h>\n#define ll long long\nusing namespace std;\nconst int MAXN = 200010;\nstruct Query {\n    int l, r, t, id;\n    ll ans;\n} q[MAXN];\nstruct Event {\n    int pos, k, b, t;\n    Event(int u = 0, int v = 0, int w = 0, int z = 0) {\n        pos = u, k = v, b = w, t = z;\n    }\n} e[MAXN * 4];\nint n, qu, cnt, a[MAXN], lg[MAXN], pre[MAXN], nx[MAXN], st[MAXN][20];\nll sum[2][MAXN * 4];\nstack <int> s;\nbool cmp1(Query a, Query b) {\n    return a.t < b.t;\n}\nbool cmp2(Query a, Query b) {\n    return a.id < b.id;\n}\nbool cmp3(Event a, Event b) {\n    return a.t < b.t;\n}\nint query(int l, int r) {\n    l = max(l, 1);\n    int k = lg[r - l + 1];\n    return (a[st[l][k]] > a[st[r - (1 << k) + 1][k]] ? st[l][k] : st[r - (1 << k) + 1][k]);\n}\nvoid modify(int p, int l, int r, int pos, ll v, int k) {\n    if (l == r) {\n        sum[k][p] = v;\n        return;\n    }\n\n    int mid = (l + r) >> 1;\n\n    if (pos <= mid) {\n        modify(p << 1, l, mid, pos, v, k);\n    } else {\n        modify((p << 1) | 1, mid + 1, r, pos, v, k);\n    }\n\n    sum[k][p] = sum[k][p << 1] + sum[k][(p << 1) | 1];\n    return;\n}\nll query(int p, int l, int r, int xl, int xr, int k) {\n    if (xr < l || r < xl) {\n        return 0;\n    }\n\n    if (xl <= l && r <= xr) {\n        return sum[k][p];\n    }\n\n    int mid = (l + r) >> 1;\n    return query(p << 1, l, mid, xl, xr, k) + query((p << 1) | 1, mid + 1, r, xl, xr, k);\n}\nint main() {\n    scanf(\"%d%d\", &n, &qu);\n    lg[0] = -1;\n\n    for (int i = 1; i <= n; i++) {\n        scanf(\"%d\", &a[i]);\n        lg[i] = lg[i >> 1] + 1, st[i][0] = i;\n    }\n\n    for (int i = 1; i <= 18; i++) {\n        for (int j = 1; j + (1 << i) - 1 <= n; j++) {\n            st[j][i] = (a[st[j][i - 1]] > a[st[j + (1 << (i - 1))][i - 1]]\n                        ? st[j][i - 1] : st[j + (1 << (i - 1))][i - 1]);\n        }\n    }\n\n    for (int i = 1; i <= n; i++) {\n        while (s.size() && a[i] >= a[s.top()]) {\n            nx[s.top()] = i;\n            s.pop();\n        }\n\n        pre[i] = (s.size() ? s.top() : 0);\n        s.push(i);\n    }\n\n    for (int i = 1; i <= n; i++) {\n        if (nx[i] == 0) {\n            nx[i] = n + 1;\n        }\n\n        if (pre[i] == 0) {\n            e[++cnt] = Event(i, 1, 1, 0);\n            e[++cnt] = Event(i, 0, nx[i] - i, nx[i] - i);\n        } else {\n            e[++cnt] = Event(i, 1, 1, 0);\n\n            if (i - pre[i] > nx[i] - i) {\n                e[++cnt] = Event(i, 0, nx[i] - i, nx[i] - i);\n                e[++cnt] = Event(i, -1, nx[i] - pre[i] - 1, i - pre[i]);\n            } else if (i - pre[i] == nx[i] - i) {\n                e[++cnt] = Event(i, -1, nx[i] - pre[i] - 1, i - pre[i]);\n            } else {\n                e[++cnt] = Event(i, 0, i - pre[i], i - pre[i]);\n                e[++cnt] = Event(i, -1, nx[i] - pre[i] - 1, nx[i] - i);\n            }\n\n            e[++cnt] = Event(i, 0, 0, nx[i] - pre[i]);\n        }\n    }\n\n    for (int i = 1; i <= qu; i++) {\n        scanf(\"%d%d%d\", &q[i].t, &q[i].l, &q[i].r);\n        q[i].id = i;\n    }\n\n    sort(q + 1, q + qu + 1, cmp1);\n    sort(e + 1, e + cnt + 1, cmp3);\n    int cura = 1, curb = 1;\n\n    for (int i = 0; i <= n; i++) {\n        while (cura <= cnt && e[cura].t == i) {\n            int tmp = e[cura].pos;\n            modify(1, 1, n, tmp, 1ll * e[cura].k * a[tmp], 0);\n            modify(1, 1, n, tmp, 1ll * e[cura].b * a[tmp], 1);\n            cura++;\n        }\n\n        while (curb <= qu && q[curb].t == i) {\n            int tmp = query(q[curb].r - i, q[curb].r);\n            int nl = max(tmp, pre[tmp] == 0 ? 0 : pre[tmp] + i + 1);\n            q[curb].ans += 1ll * (q[curb].r - nl + 1) * a[tmp];\n            q[curb].ans += 1ll * query(1, 1, n, 1, tmp - 1, 0) * i + query(1, 1, n, 1, tmp - 1, 1);\n\n            if (q[curb].l == 1) {\n                curb++;\n                continue;\n            }\n\n            q[curb].r = q[curb].l - 1;\n            tmp = query(q[curb].r - i, q[curb].r);\n            nl = max(tmp, pre[tmp] == 0 ? 0 : pre[tmp] + i + 1);\n            q[curb].ans -= 1ll * (q[curb].r - nl + 1) * a[tmp];\n            q[curb].ans -= 1ll * query(1, 1, n, 1, tmp - 1, 0) * i + query(1, 1, n, 1, tmp - 1, 1);\n            curb++;\n        }\n    }\n\n    sort(q + 1, q + qu + 1, cmp2);\n\n    for (int i = 1; i <= qu; i++) {\n        printf(\"%lld\\n\", q[i].ans);\n    }\n\n    return 0;\n}\n\n\n```\n",
        "postTime": 1645280642,
        "uid": 403727,
        "name": "stjp",
        "ccfLevel": 0,
        "title": "[JOI 2020 Final] \u706b\u4e8b-\u9898\u89e3"
    },
    {
        "content": "\u8fd9\u9898\u770b\u8d77\u6765\u4eba\u755c\u65e0\u5bb3\uff0c\u975e\u5e38\u5c0f\u6e05\u65b0\u7684 DS \u9898\uff0c\u4f46\u5199\u8d77\u6765\u5c31\u4e0d\u4f1a\u8fd9\u4e48\u60f3\u4e86\u3002\n\n\u9898\u76ee\u5927\u610f\uff0c\u7ed9\u5b9a\u4e00\u4e2a\u957f\u5ea6\u4e3a $N$ \u7684\u5e8f\u5217 $S$ \uff0c\u9700\u8981\u56de\u7b54 $Q$ \u6b21\u8be2\u95ee\uff0c\u6bcf\u6b21\u8be2\u95ee $\\sum\\limits_{L\\le i\\le R}\\max\\limits_{i-T\\le j\\le i}\\{S_j\\}$ \u3002\n\n\u5b50\u4efb\u52a1 $1$ \uff0c\u76f4\u63a5\u6a21\u62df\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}(QN^2)$ \u3002\n\n\u5b50\u4efb\u52a1 $2$ \uff0c$T_i$ \u76f8\u7b49\uff0c\u76f4\u63a5\u7b97\u51fa $T$ \u65f6\u523b\u7684\u5e8f\u5217\uff0c\u7136\u540e\u6c42\u4e00\u4e2a\u524d\u7f00\u548c\u5373\u53ef\u3002\u8ba1\u7b97\u5e8f\u5217\u65f6\u53ef\u4ee5\u5355\u8c03\u961f\u5217\u505a\u5230 $\\mathcal{O}(N)$ \u3002\n\n\u5b50\u4efb\u52a1 $3$ \uff0c$L_i=R_i$ \uff0c\u5355\u70b9\u8be2\u95ee\uff0c\u76f4\u63a5\u8ba1\u7b97 $\\max\\limits_{L-T\\le i\\le L}\\{S_i\\}$ \uff0cST \u8868\u53ef\u4ee5\u505a\u5230 $\\mathcal{O}(N\\log N+Q)$ \u3002\n\n\u5b50\u4efb\u52a1 $4$\uff0c$1\\le S_i\\le 2$ \u3002\n\n\u6211\u4eec\u4e0d\u59a8\u5217\u51fa\u4e00\u4e2a\u8868\u683c\uff0c$S_{i,j}$ \u8868\u793a\u65f6\u523b $i$ \uff0c\u5e8f\u5217\u7b2c $j$ \u4f4d\u7684\u662f $1$ \u8fd8\u662f $2$ \u3002\n\n\u5148\u5c06\u6574\u4e2a\u8868\u683c\u7528 $1$ \u586b\u5145\uff0c\u7136\u540e\u53d1\u73b0\u5982\u679c\u7b2c $i$ \u4f4d\u4e3a $2$ \uff0c\u90a3\u4e48\u8868\u683c\u4e2d\u4f4d\u4e8e\u76f4\u7ebf $y=x-i$ \u659c\u4e0a\u65b9\uff08\u5305\u62ec\uff09\u7684\u4e14\u4f4d\u7f6e $\\ge i$ \u7684\u6240\u6709\u683c\u5b50\u90fd\u88ab\u586b\u4e0a $2$ \u3002\n\n\u8fd9\u5c31\u662f\u626b\u63cf\u7ebf\u6a21\u677f\uff0c\u5dee\u5206\u4e00\u4e0b\u53ef\u4ee5\u505a\u5230 $\\mathcal{O}(N+Q\\log N)$ \u3002\n\n\u5bf9\u4e8e\u6ee1\u5206\u505a\u6cd5\uff0c\u6211\u4eec\u8003\u8651\u5ef6\u7eed\u524d\u9762\u7684\u601d\u8def\u3002\n\n\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u4f4d\u7f6e $i$ \u4e0a\u7684\u6570\uff0c\u5982\u679c\u524d\u9762\u6709\u6bd4\u5b83\u5927\u7684\u6570\uff0c\u90a3\u4e48\u5b83\u5728\u8868\u683c\u4e2d\u586b\u5145\u7684\u90e8\u5206\u4e00\u5b9a\u662f\u5e73\u884c\u56db\u8fb9\u5f62\uff0c\u5426\u5219\u4e00\u5b9a\u662f\u4e00\u4e2a\u76f4\u89d2\u68af\u5f62\u3002\n\n\u5bf9\u4e8e\u4e00\u4e2a\u5e73\u884c\u56db\u8fb9\u5f62\uff0c\u6211\u4eec\u62c6\u6210\u4e09\u4e2a\u5728 $x$ \u8f74\u4e0a\u7684\u7b49\u8170\u76f4\u89d2\u4e09\u89d2\u5f62\u3002\n\n\u73b0\u5728\u53ea\u7528\u8003\u8651\u4e09\u89d2\u5f62\u7684\u60c5\u51b5\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u7528\u4e00\u6761\u659c\u7387\u4e3a $1$ \u7684\u76f4\u7ebf\u548c $x$ \u8f74\u5207\u51fa\u4e00\u4e2a\u7b49\u8170\u76f4\u89d2\u4e09\u89d2\u5f62\u7684\u4e00\u4e2a\u89d2\u3002\n\n\u5bf9\u4e8e\u8fd9\u4e2a\u89d2\u7684\u5bf9\u8fb9\uff0c\u6211\u4eec\u518d\u62c6\u6210\u4e00\u4e2a\u7b49\u8170\u76f4\u89d2\u4e09\u89d2\u5f62\u548c\u4e00\u4e2a\u957f\u65b9\u5f62\u3002\n\n\u957f\u65b9\u5f62\u5df2\u7ecf\u53ef\u4ee5\u76f4\u63a5\u505a\u4e86\uff0c\u8fd9\u4e24\u4e2a\u7b49\u8170\u76f4\u89d2\u4e09\u89d2\u5f62\u90fd\u5177\u6709\u53ef\u4ee5\u5411\u53f3\u65e0\u9650\u6269\u5c55\u7684\u7279\u70b9\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u4e24\u6761\u76f4\u7ebf\u8868\u793a\uff0c\u5728\u5f62\u5982 $y=x+b$ \u7684\u76f4\u7ebf\u534f\u4e0b\u65b9\uff0c\u5728\u5f62\u5982 $y=a$ \u7684\u76f4\u7ebf\u4e0a\u65b9\u3002\n\n\u8f6c\u5316\u4e3a\u5dee\u5206\uff0c\u6211\u4eec\u9700\u8981\u652f\u6301\u533a\u95f4\u52a0\u548c\u533a\u95f4\u6c42\u548c\u3002\u53ef\u4ee5\u6811\u72b6\u6570\u7ec4\u518d\u505a\u4e00\u6b21\u5dee\u5206\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u7ebf\u6bb5\u6811\u3002\n\n\u7531\u4e8e\u7b14\u8005\u5199\u6cd5\u6bd4\u8f83\u4e11\u9700\u8981\u8d1f\u6570\u4e0b\u6807\uff0c\u6240\u4ee5\u4f7f\u7528\u4e86\u7ebf\u6bb5\u6811\u3002\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}((N+Q)\\log N)$ \u3002\n\n```cpp\n#include<bits/stdc++.h>\n#define rep(i,a,b) for(int i=a;i<=b;i++)\n#define pre(i,a,b) for(int i=a;i>=b;i--)\n#define N 500005\n#define int long long\nusing namespace std;\nint n,m,s[N],sta[N],pre[N],nxt[N],ans[N],top;\ntypedef pair<int,int> Pr;\nvector<Pr>c[N],d[N];\nstruct seg{\n\tstruct node{\n\t\tint l,r,tag,sum;\n\t}a[N<<2];\n\t#define L a[x].l\n\t#define R a[x].r\n\t#define ls (x<<1)\n\t#define rs (ls|1)\n\t#define T a[x].tag\n\t#define S a[x].sum\n\tinline int g(int l,int r){return l+(r-l)/2;}\n\tvoid build(int x,int l,int r){\n\t\tL=l;R=r;S=T=0;\n\t\tif(l==r)return ;\n\t\tint mid=g(l,r);\n\t\tbuild(ls,l,mid);\n\t\tbuild(rs,mid+1,r);\n\t}\n\tvoid pushup(int x,int val){T+=val;S+=(R-L+1)*val;}\n\tvoid down(int x){if(T)pushup(ls,T),pushup(rs,T),T=0;}\n\tvoid change(int x,int l,int r,int val){\n\t\tif(L>=l&&R<=r)pushup(x,val);\n\t\telse{\n\t\t\tdown(x);int mid=g(L,R);\n\t\t\tif(mid>=l)change(ls,l,r,val);\n\t\t\tif(mid<r)change(rs,l,r,val);\n\t\t\tS=a[ls].sum+a[rs].sum;\n\t\t}\n\t}\n\tint ask(int x,int l,int r){\n\t\tif(L>=l&&R<=r)return S;\n\t\tdown(x);int sum=0,mid=g(L,R);\n\t\tif(mid>=l)sum+=ask(ls,l,r);\n\t\tif(mid<r)sum+=ask(rs,l,r);\n\t\treturn sum;\n\t}\n}p,q;\nvoid tri(int l,int r,int val){\n\t//cout<<\"cc \"<<l<<\" \"<<r<<\" \"<<val<<endl;\n\tif(l>r)return;\n\tc[0].push_back(make_pair(l,val));\n\tc[r-l+1].push_back(make_pair(l,-val));\n\td[0].push_back(make_pair(r+1,-val));\n\td[r-l+1].push_back(make_pair(r+1,val));\n}\nvoid par(int l,int r,int len,int val){\n\tint st=l-len+1;\n\ttri(st,r,val);tri(st,l-1,-val);tri(l+1,r,-val);\n}\nstruct node{int t,l,r,op;bool operator<(const node o)const{return t<o.t;}}u[N];\nsigned main(){\n\tscanf(\"%lld%lld\",&n,&m);int ll=-n-5,rr=n+5;\n\trep(i,1,n)scanf(\"%lld\",&s[i]);\n\trep(i,1,n){\n\t\twhile(top&&s[sta[top]]<=s[i])nxt[sta[top]]=i,top--;\n\t\tif(top)pre[i]=sta[top];else pre[i]=-n-2;\n\t\tsta[++top]=i;\n\t}\n\trep(i,1,n)if(!nxt[i])nxt[i]=n+1;\n\t//rep(i,1,n)printf(\"ss %lld %lld \\n\",pre[i],nxt[i]);\n\trep(i,1,n)par(i,nxt[i]-1,i-pre[i],s[i]);\n\trep(i,1,m)scanf(\"%lld%lld%lld\",&u[i].t,&u[i].l,&u[i].r),u[i].op=i;\n\tsort(u+1,u+m+1);int j=1;\n\tp.build(1,ll,rr);q.build(1,ll,rr);\n\trep(t,0,n){\n\t\t//cout<<\"st \"<<t<<endl;\n\t\tfor(int i=0;i<(int)c[t].size();i++){\n\t\t\tp.change(1,c[t][i].first,rr,c[t][i].second);\n\t\t\t//cout<<\"Add A  \"<<c[t][i].first<<\" \"<<c[t][i].second<<endl;\n\t\t}\n\t\tfor(int i=0;i<(int)d[t].size();i++){\n\t\t\tq.change(1,d[t][i].first,rr,d[t][i].second);\n\t\t\t//cout<<\"Add B  \"<<d[t][i].first<<\" \"<<d[t][i].second<<endl; \n\t\t}\n\t\twhile(j<=m&&u[j].t==t){\n\t\t\tans[u[j].op]=q.ask(1,u[j].l,u[j].r)+p.ask(1,u[j].l-t,u[j].r-t);\n\t\t\tj++;\n\t\t}\n\t}\n\trep(i,1,m)printf(\"%lld\\n\",ans[i]);\n\treturn 0;\n}\n```\n\n",
        "postTime": 1623159506,
        "uid": 119261,
        "name": "7KByte",
        "ccfLevel": 0,
        "title": "\u3010\u9898\u89e3\u3011[JOI 2020 Final] \u706b\u4e8b"
    },
    {
        "content": ">\u7ed9\u5b9a\u4e00\u4e2a\u521d\u59cb\u5e8f\u5217 $\\{a_i\\}$ ,\u5b9a\u4e49 $\\displaystyle a^{[T]}_{i}=\\max_{j=\\max\\{1,i-T+1\\}}^i\\{a_i\\}$\n\u591a\u6b21\u8be2\u95ee$\\displaystyle \\sum_{i=l}^ra^{[T]}_{i}$\n\n\u8003\u8651\u6211\u4eec\u4e0d\u770b\u4f4d\u7f6e\u800c\u662f\u770b\u503c\u88ab\u8c01\u8986\u76d6\u4e86\n\n\u6216\u8005\u8fd9\u6837\u8bf4\u6211\u4eec\u5728\u65f6\u95f4\u8f74\u4e0a\u5982\u679c$T$\u65f6\u523b\u5185$i$\u4f4d\u7f6e**\u5b58\u5728\u4e00\u4e2a\u65f6\u523b\u503c**\u4ece$a$\u53d8\u6210\u4e86$b$\u90a3\u4e48\u5728$t-v$\u56fe\u50cf\u4e0a\u5c31\u5728$(T,i)$\u521d\u52a0\u4e0a\u4e00\u4e2a$b-a$\n\n\u8bbe$L_i=\\max\\{j|j<i,a_{j}>a_i\\}$,$R_i=\\min\\{j|j>i,a_{j}>a_i\\}$\n\n\u5219\u4ee5$i$\u4e3a\u53f3\u7aef\u70b9\u7684\u533a\u95f4\u5f53\u5de6\u7aef\u70b9$\\in[i,R_i)$\u65f6$a_i$\u4f1a\u53d8\u6210$a_{L_i}$\n\n\u56fe\u53ef\u4ee5\u81ea\u5df1\u753b\u4e0b\n\n\u5316\u7b80\u7b54\u6848\uff0c\u8003\u8651\u6bcf\u4e2a\u4f4d\u7f6e\uff0c\u5bf9$i$\u4f4d\u7f6e\u8d21\u732e\u5206\u522b\u8003\u8651\u8be2\u95ee\u5dee\u5206\u540e\u7684\u60c5\u51b5$(t,[1,x])$\u4e3a$(a_{L_i}-a_i)(\\min\\{x,L_i+t\\}-\\min\\{x,i-1\\})$\n\n\u7136\u540e\u5316\u6cd5\u5c31\u5343\u5947\u767e\u602a\u4e86\uff0c\u539f\u5219\u662f\u628a\u8be2\u95ee\u548c\u4f4d\u7f6e\u72ec\u7acb\uff0c\u8be2\u95ee\u548c\u8be2\u95ee\u5206\u7c7b(\u6307\u53bb\u6389$\\min\\{\\}$)\n\n\u56e0\u4e3a\u6211\u61d2\u5f97\u628a\u5316\u7b80\u7ed3\u679c\u5199\u5b8c\u5c31\u4e0d\u653e\u4ee3\u7801\u4e86",
        "postTime": 1603638339,
        "uid": 40629,
        "name": "zzw4257",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P6881 \u3010[JOI 2020 Final] \u706b\u4e8b\u3011"
    }
]