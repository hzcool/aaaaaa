[
    {
        "content": "\u770b\u5230\u597d\u50cf\u6ca1\u4ec0\u4e48\u4eba\u662f\u548c\u6211\u601d\u8def\u7c7b\u4f3c\u7684\u5355 $\\log$ \u505a\u6cd5\uff0c\u6211\u5c31\u6765\u6c34\u4e00\u7bc7 blog \u4e86\u3002\n\n\u5bf9\u4e8e\u4e00\u6761\u8be2\u95ee\u8def\u5f84 $s_i\\rightarrow t_i$ \u62c6\u6210 $s_i\\rightarrow x_i$ \u548c $y_i\\rightarrow t_i$\uff0c\u5176\u4e2d $y_i$ \u662f $s_i,t_i$ \u7684 LCA\uff0c$x_i$ \u662f $y_i$ \u7684\u513f\u5b50\u3002\n\n\u5bf9\u4e8e $s_i\\rightarrow x_i$ \u7684\u90e8\u5206\uff0c\u6211\u4eec\u76f4\u63a5\u5904\u7406\u51fa\u8fd9\u4e00\u6bb5\u6700\u591a\u53ef\u4ee5\u83b7\u5f97\u591a\u5c11\u5b9d\u77f3\uff0c\u5e76\u628a\u4e0b\u4e00\u4e2a\u5b9d\u77f3\u7684\u79cd\u7c7b\u8bb0\u4e3a $c_i$\uff0c\u7136\u540e\u628a\u4e8c\u5143\u7ec4 $(c_i,i)$ \u6302\u5230\u8282\u70b9 $y_i$ \u4e0a\uff0c\u5e76\u5728\u8282\u70b9 $t_i$ \u4e0a\u6302\u4e00\u4e2a\u7ed3\u675f\u6807\u8bb0 $i$\u3002\n\n\u8fd9\u4e2a\u90e8\u5206\u53ef\u4ee5\u7528\u6811\u4e0a\u500d\u589e\u8fdb\u884c\u5904\u7406\u3002\n\n\u73b0\u5728\u53ea\u9700\u8981\u5bf9\u6811\u8fdb\u884c\u4e00\u904d dfs\uff0c\u5e76\u5bf9\u6bcf\u4e2a\u5b9d\u77f3\u7684\u79cd\u7c7b $i$ \u7ef4\u62a4\u4e00\u4e2a\u5bb9\u5668 $d_i$\uff0c\u652f\u6301\uff1a\n1. \u8fdb\u5165\u70b9 $k$ \u65f6\uff0c\u5bf9\u4e8e\u6302\u5728 $k$ \u4e0a\u7684\u6240\u6709\u4e8c\u5143\u7ec4 $(i,x)$\uff0c\u628a $x$ \u63d2\u5165\u5bb9\u5668 $d_i$\u3002\n2. \u4ee4\u70b9 $k$ \u4e0a\u7684\u5b9d\u77f3\u79cd\u7c7b $w$ \u5728\u5b9d\u77f3\u5e8f\u5217\u4e2d\u7684\u540e\u7ee7\u4e3a $r$\uff0c\u5219\u628a $d_{w}$ \u5408\u5e76\u5230 $d_{r}$ \u4e2d\u3002\n3. \u5bf9\u4e8e\u6302\u5728 $k$ \u4e0a\u7684\u6240\u6709\u7ed3\u675f\u6807\u8bb0 $x$\uff0c\u67e5\u8be2 $x$ \u6240\u5728\u7684\u5bb9\u5668\u7f16\u53f7\u3002\n4. \u9000\u51fa\u70b9 $k$ \u65f6\uff0c\u64a4\u9500\u8fdb\u5165\u70b9 $k$ \u65f6\u8fdb\u884c\u7684\u64cd\u4f5c\uff08\u5305\u62ec\u63d2\u5165\u4e0e\u5408\u5e76\uff09\u3002\n\n\u6211\u4eec\u53d1\u73b0\u7528\u5e26\u64a4\u9500\u5e76\u67e5\u96c6\u53ef\u4ee5\u5f88\u597d\u7684\u5b9e\u73b0\u8fd9\u4e2a\u5bb9\u5668\u3002\n\n\u4e8e\u662f\u5c31\u505a\u5b8c\u4e86\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $O((n+q)\\log n)$\u3002\n\n\u4ee3\u7801\u5982\u4e0b\uff1a\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n\nconst int N=500000,C=21;\n\nint Ri(){\n  int x=0,y=1;\n  char c=getchar();\n  for (;c<'0'||c>'9';c=getchar()) if (c=='-') y=-1;\n  for (;c<='9'&&c>='0';c=getchar()) x=x*10+c-'0';\n  return x*y;\n}\n\nint n,m,sk,a[N+9],pre[N+9],suf[N+9],pos[N+9];\nstruct side{\n  int y,next;\n}e[N+9];\nint lin[N+9],cs;\n\nvoid Ins(int x,int y){e[++cs].y=y;e[cs].next=lin[x];lin[x]=cs;}\nvoid Ins2(int x,int y){Ins(x,y);Ins(y,x);}\n\nint fa[N+9],son[N+9],dep[N+9],siz[N+9],top[N+9];\nint fir,up1[N+9],up[N+9][C],now[N+9];\n\nvoid Dfs_ord0(int k,int fat){\n  if (now[suf[a[k]]]) up[k][0]=now[suf[a[k]]];\n  for (int i=1;i<C;++i) up[k][i]=up[up[k][i-1]][i-1];\n  int t=now[a[k]];\n  now[a[k]]=k;\n  if (now[fir]) up1[k]=now[fir];\n  fa[k]=fat;\n  dep[k]=dep[fat]+1;\n  siz[k]=1;\n  for (int i=lin[k];i;i=e[i].next)\n    if (e[i].y^fat){\n      Dfs_ord0(e[i].y,k);\n      siz[k]+=siz[e[i].y];\n      if (siz[e[i].y]>siz[son[k]]) son[k]=e[i].y;\n    }\n  now[a[k]]=t;\n}\n\nvoid Dfs_ord1(int k,int t){\n  top[k]=t;\n  if (son[k]) Dfs_ord1(son[k],t);\n  for (int i=lin[k];i;i=e[i].next)\n    if (e[i].y^fa[k]&&e[i].y^son[k]) Dfs_ord1(e[i].y,e[i].y);\n}\n\nint Query_lca(int x,int y){\n  for (;top[x]^top[y];x=fa[top[x]])\n    if (dep[top[x]]<dep[top[y]]) swap(x,y);\n  return dep[x]<dep[y]?x:y;\n}\n\nint cq,ans[N+9];\nvector<int>qc[N+9],qid[N+9],q[N+9];\n\nvoid into(){\n  n=Ri();m=Ri();sk=Ri();\n  for (int i=1;i<=sk;++i) a[i]=Ri();\n  fir=a[1];\n  for (int i=1;i<=sk;++i){\n    pre[a[i]]=a[i-1];\n    suf[a[i]]=a[i+1];\n    pos[a[i]]=i;\n  }\n  for (int i=1;i<=n;++i) a[i]=Ri();\n  for (int i=1;i<n;++i){\n    int x,y;\n    x=Ri();y=Ri();\n    Ins2(x,y);\n  }\n  Dfs_ord0(1,0);\n  Dfs_ord1(1,1);\n  cq=Ri();\n  for (int i=1;i<=cq;++i){\n    int x,y,z;\n    x=Ri();y=Ri();\n    z=Query_lca(x,y);\n    if (dep[up1[x]]<=dep[z]){\n      qc[z].push_back(fir);\n      qid[z].push_back(i);\n      q[y].push_back(i);\n    }else{\n      int t=up1[x];\n      for (int j=C-1;j>=0;--j)\n        if (dep[up[t][j]]>dep[z]) t=up[t][j];\n      t=a[t];\n      if (suf[t]){\n        qc[z].push_back(suf[t]);\n        qid[z].push_back(i);\n        q[y].push_back(i);\n      }else ans[i]=m;\n    }\n  }\n}\n\nint uni[N+9],sz[N+9],col[N+9],rot[N+9];\n\nint Query_uni(int k){return k==uni[k]?k:Query_uni(uni[k]);}\n\nvoid Dfs_ans(int k){\n  for (int vs=qc[k].size(),i=0;i<vs;++i){\n    int c=qc[k][i],t=qid[k][i];\n    uni[t]=t;sz[t]=1;col[t]=c;\n    rot[c]?(uni[t]=rot[c],++sz[rot[c]]):rot[c]=t;\n  }\n  int x=rot[a[k]];\n  rot[a[k]]=0;\n  int c=suf[a[k]],y=rot[c];\n  if (x){\n    if (!y) rot[c]=x,col[x]=c;\n    else if (sz[x]<sz[y]){\n      uni[x]=y;\n      sz[y]+=sz[x];\n    }else{\n      uni[y]=rot[c]=x;\n      sz[x]+=sz[y];\n      col[x]=c;\n    }\n  }\n  for (int vs=q[k].size(),i=0;i<vs;++i){\n    int t=col[Query_uni(q[k][i])];\n    ans[q[k][i]]=t?pos[t]-1:sk;\n  }\n  for (int i=lin[k];i;i=e[i].next)\n    if (e[i].y^fa[k]) Dfs_ans(e[i].y);\n  if (x){\n    if (!y) rot[c]=0,col[x]=a[k];\n    else if (rot[c]==y){\n      uni[x]=x;\n      sz[y]-=sz[x];\n    }else{\n      uni[y]=rot[c]=y;\n      sz[x]-=sz[y];\n      col[x]=a[k];\n    }\n  }\n  rot[a[k]]=x;\n  for (int vs=qc[k].size(),i=0;i<vs;++i){\n    int c=qc[k][i],t=qid[k][i];\n    rot[c]==t?rot[c]=0:--sz[uni[t]];\n  }\n}\n\nvoid work(){\n  Dfs_ans(1);\n}\n\nvoid outo(){\n  for (int i=1;i<=cq;++i)\n    printf(\"%d\\n\",ans[i]);\n}\n\nint main(){\n  into();\n  work();\n  outo();\n  return 0;\n}\n```",
        "postTime": 1618492413,
        "uid": 32331,
        "name": "hezlik",
        "ccfLevel": 9,
        "title": "\u8054\u5408\u7701\u9009 2021 \u5b9d\u77f3 \u9898\u89e3"
    },
    {
        "content": "### **\u9898\u9762\uff1a**\n-----------\n[\u9898\u76ee\u94fe\u63a5](https://www.luogu.com.cn/problem/P7518)\n\n### **\u9898\u89e3\uff1a**\n-----------\n\u63d0\u4f9b\u8d5b\u65f6\u601d\u8def\uff0c\u6bd4\u8f83\u6e05\u771f\uff0c\u53ea\u8981\u4e3b\u5e2d\u6811\u52a0\u500d\u589e\u5c31\u884c\u4e86\n\n\u6211\u4eec\u8003\u8651\u5bf9\u7ed9\u8fdb\u6765\u7684 $P_i$ \u91cd\u6807\u53f7\u4e00\u4e0b\uff0c\u4f7f\u4e4b\u6210\u4e3a $1\\sim c$ \u7684\u5e8f\u5217\uff0c\u540c\u65f6\u5bf9\u6bcf\u4e2a $i$ \u7684 $w$ \u503c\u4e5f\u8fdb\u884c\u5bf9\u5e94\u7684\u91cd\u6807 \n\n\u90a3\u4e48\u9898\u610f\u53ef\u4ee5\u8f6c\u5316\u4e3a\u6c42\u4e00\u6761\u8def\u5f84\u4e0a $u\\rightarrow v$ \u7684\u6700\u5927\u7684 $cnt$ \uff0c\u6ee1\u8db3 $cnt\\le c$ \u4e14 $1\\sim cnt$ \u5728\u8fd9\u6761\u8def\u5f84\u4e0a\u4f9d\u6b21\u51fa\u73b0\n\n\u663e\u7136\u5728\u8fd9\u6761\u8def\u5f84\u4e0a\uff0c\u6bcf\u4e2a\u6743\u503c\u5c3d\u91cf\u65e9\u7684\u51fa\u73b0\u6700\u4f18\n\n\u5bf9\u4e8e\u4e00\u6761\u8def\u5f84\uff0c\u53ef\u4ee5\u62c6\u5206\u4e00\u6761\u4e0a\u94fe\u548c\u4e00\u6761\u4e0b\u94fe\n\n\u90a3\u4e48\u6211\u4eec\u5bf9\u4e8e\u6bcf\u4e2a\u70b9 $u$ \u53ef\u4ee5\u500d\u589e\u9884\u5904\u7406 $f_1[u][i]$ \u8868\u793a\u5728 $u$ \u5230\u6839\u7684\u94fe\u4e0a\u6743\u503c\u4e3a $w[u]+2^i$ \u7684\u8282\u70b9\u6700\u8fd1\u5728\u54ea\u91cc\n\n\u548c $f_2[u][i]$ \u8868\u793a\u5728 $u$ \u5230\u6839\u7684\u94fe\u4e0a\u6743\u503c\u4e3a $w[u]-2^i$ \u7684\u8282\u70b9\u6700\u8fd1\u5728\u54ea\u91cc\uff08\u4e3a\u4e86\u5904\u7406\u4e0b\u94fe\uff09\n\n\u5bf9\u4e8e\u4e0a\u94fe\u53ef\u4ee5\u76f4\u63a5\u6c42\u51fa\u6743\u503c\u4e3a $1$ \u7684\u8282\u70b9\u5728\u54ea\u91cc\uff08\u56e0\u4e3a\u5fc5\u987b\u4ece $1$ \u5f00\u59cb\u8d77\u8df3\uff0c\u600e\u4e48\u67e5\u627e\u4ece $u$ \u5230\u6839\u7684\u94fe\u4e0a\u6743\u503c\u4e3a $x$ \u7684\u8282\u70b9\u5f85\u4f1a\u8bb2\uff09\uff0c\u5e76\u4ece $1$ \u5f00\u59cb\u8d77\u8df3\uff0c\u4e00\u76f4\u8df3\u5230\u6df1\u5ea6\u4e0d\u5c0f\u4e8e $lca$ \u7684\u8282\u70b9 \n\n\u8fd9\u6837\u6211\u4eec\u5c31\u5f97\u5230\u4e86\u4e0a\u94fe\u6700\u5927\u80fd\u5339\u914d\u5230\u54ea\u91cc\uff0c\u4e0d\u59a8\u8bbe\u4e3a $x$\n\n\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u5728\u4e0b\u94fe\u4e0a\u4e8c\u5206\u7b54\u6848\uff0c\u4e0b\u754c\u4e3a $x+1$ \uff0c\u4e0a\u754c\u4e3a $c$\uff0c\u5728 $v$ \u5230\u6839\u7684\u94fe\u4e0a\u67e5\u627e\u6743\u503c\u4e3a $mid$ \u7684\u70b9\uff0c\u5e76\u5229\u7528 $f_2$ \u4e0d\u65ad\u5f80\u4e0a\u8df3\uff0c\u627e\u5230\u6700\u5927\u80fd\u5339\u914d\u7684\u540e\u7f00\uff0c\u770b\u770b\u662f\u5426\u80fd\u548c\u524d $1\\sim x$ \u62fc\u63a5\u5728\u4e00\u8d77\n\n\uff08\u7b54\u6848\u663e\u7136\u5177\u6709\u5355\u8c03\u6027\u7684\uff0c\u56e0\u4e3a\u5982\u679c\u6743\u503c\u8f83\u5927\u7684\u70b9\u80fd\u548c\u4e0a\u94fe\u62fc\u63a5\u5728\u4e00\u8d77\uff0c\u90a3\u4e48\u6743\u503c\u8f83\u5c0f\u7684\u70b9\u66f4\u52a0\u53ef\u4ee5\u548c\u4e0a\u94fe\u62fc\u5728\u4e00\u8d77\u4e86\uff09\n\n\u81f3\u4e8e\u4e8c\u5206\u7684\u4e0b\u754c\u662f $x+1$ \u7684\u539f\u56e0\u662f $x$ \u662f\u5728\u4e0a\u94fe\u4e0a\u51fa\u73b0\u7684\uff0c\u4e0d\u4fdd\u8bc1\u5728\u4e0b\u94fe\u4e0a\u4e5f\u5b58\u5728 $x$ \n\n\u81f3\u4e8e\u5982\u4f55\u5728\u7ebf\u6c42\u4e00\u6761\u5230\u6839\u7684\u94fe\u4e0a\u6743\u503c\u4e3a $p$ \u7684\u70b9\u6700\u6df1\u5728\u54ea\u91cc\u53ef\u4ee5\u4e3b\u5e2d\u6811\u4e00\u4e0b\uff0c\u5c31\u662f\u6bcf\u4e2a\u5b69\u5b50\u5728\u4ed6\u7236\u4eb2\u7684\u7ebf\u6bb5\u6811\u4e0a\u66f4\u6539\u4e00\u6761\u94fe\u5c31\u884c\u4e86\uff08\u53ef\u80fd\u6709\u70b9\u8868\u8ff0\u4e0d\u6e05\uff0c\u53ef\u4ee5\u770b\u4ee3\u7801\uff09\n\n\u590d\u6742\u5ea6 $O(n\\log^2n)$ \uff0c\u5e38\u6570\u53ef\u80fd\u6709\u70b9\u5927\uff0c\u56e0\u4e3a\u500d\u589e\u7684 $\\log$ \u662f\u8981\u8dd1\u6ee1\u7684\uff0c\u4e0d\u8fc7\u5e94\u8be5\u80fd\u8fc7\u9898\n\n\u8bf4\u53e5\u9898\u5916\u8bdd\uff0c\u8003\u8bd5\u7684\u65f6\u5019\u6ca1\u6ce8\u610f\u5230\u4e8c\u5206\u7684\u4e0b\u754c\u662f $x+1$ \uff0c\u5bfc\u81f4\u4ee3\u7801\u51fa\u9519\u4e86\n\n\u5176\u5b9e\u5982\u679c\u6d4b\u6700\u5927\u7684\u90a3\u4e2a\u6837\u4f8b\u5e94\u8be5\u662f\u53ef\u4ee5\u6d4b\u51fa\u6765\u7684\uff0c\u4f46\u662f\u6211\u4e0d\u4f1a\u624b\u52a8\u5f00\u5927 Windows \u7684\u6808\u7a7a\u95f4\uff0c\u4e00\u4e2a dfs \u5c31\u8dd1\u4e0d\u51fa\u6765\uff0c\u8fd8\u4ee5\u4e3a\u601d\u8def\u9519\u4e86\uff0c\u60f3\u4e86\u534a\u5929\n\n\u8fd9\u91cc\u8bb0\u5f55\u4e0b Windows \u4e0b\u624b\u52a8\u5f00\u5927\u6808\u7a7a\u95f4\u7684\u65b9\u6cd5\n\n\u5728 dev \u7684\u5de5\u5177\u90a3\u4e00\u680f\u7684\u7f16\u8bd1\u9009\u9879\uff0c\u5728\u201c\u7f16\u8bd1\u65f6\u52a0\u5165\u4ee5\u4e0b\u547d\u4ee4\u201d\u90a3\u4e2a\u5730\u65b9\u52a0\u4e0a\n\n`-Wl,--stack=1024000000`\n\n\u6240\u6709\u5c40\u90e8\u53d8\u91cf\u548c\u51fd\u6570\u90fd\u662f\u7b97\u5728\u6808\u7a7a\u95f4\u5185\u7684\uff0c\u4e0a\u9762\u90a3\u4e2a `=` \u53f7\u540e\u9762\u7684\u4e1c\u897f\u662f\u4ee5 `B` \u4e3a\u5355\u4f4d\u7684\n\n\u4e00\u822c\u6765\u8bf4\u662f\u9012\u5f52\u6df1\u5ea6\u8fc7\u5927\u5bfc\u81f4\u7206\u6808\u7684\n\n\u548c Ubuntu \u7684\n\n\u7f16\u8bd1\u524d\u5728\u7ec8\u7aef\u52a0\u4e0a `ulimit -s 1024000`\n\n\u8fd9\u4e2a\u662f\u4ee5 `KB` \u4e3a\u5355\u4f4d\u7684\n### **Code\uff1a**\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define ls(x) t[x].ch[0]\n#define rs(x) t[x].ch[1]\nconst int N = 2e5+9;\nint read(){\n\tint f=1,x=0;char ch=getchar();\n\twhile(ch<'0'||ch>'9'){if(ch=='-') f=-1;ch=getchar();}\n\twhile(ch>='0'&&ch<='9'){x=(x<<3)+(x<<1)+ch-'0';ch=getchar();}\n\treturn f*x;\n}\n\nint n,m,c,q,p[N],w[N],vt[N];\nint head[N],tot;\nstruct pp{int nxt,to;}g[N<<1];\nvoid add(int u,int v){g[++tot].nxt=head[u],g[tot].to=v,head[u]=tot;}\nint pa[N],dep[N],f[N][21];\n\nvoid dfs1(int u,int fa){\n\tpa[u]=fa,dep[u]=dep[fa]+1,f[u][0]=fa;\n\tfor(int i=head[u];i!=-1;i=g[i].nxt){\n\t\tint v=g[i].to;if(v==fa) continue;dfs1(v,u);\n\t}\n\treturn ;\n}\n\nint lca(int u,int v){\n\tif(dep[u]<dep[v]) swap(u,v);\n\tfor(int i=20;i>=0;i--) if(dep[f[u][i]]>=dep[v]) u=f[u][i];\n\tif(u==v) return u;\n\tfor(int i=20;i>=0;i--) if(f[u][i]!=f[v][i]) u=f[u][i],v=f[v][i];\n\treturn f[u][0];\n}\n\nint col[N];\nint f1[N][21],f2[N][21];\nvoid dfs2(int u,int fa){\n\tint hy=col[w[u]];\n\tcol[w[u]]=u;\n\tf1[u][0]=col[w[u]+1],f2[u][0]=col[w[u]-1];\n\tfor(int i=head[u];i!=-1;i=g[i].nxt){\n\t\tint v=g[i].to;if(v==fa) continue;dfs2(v,u);\n\t}\n\tcol[w[u]]=hy;\n\treturn ;\n}\n\n\nint rt[N],cnt;\nstruct seg{int ch[2],pos;}t[N*64];\nint New(){++cnt;ls(cnt)=rs(cnt)=0,t[cnt].pos=0;return cnt;}\nvoid modify(int &c,int pt,int l,int r,int x,int y){\n\tif(!c) c=New();if(l==r){t[c].pos=y;return ;}int mid=(l+r)>>1;\n\tif(x<=mid) rs(c)=rs(pt),modify(ls(c),ls(pt),l,mid,x,y);\n\tif(x>mid) ls(c)=ls(pt),modify(rs(c),rs(pt),mid+1,r,x,y);return ;\n}\nint query(int c,int l,int r,int x){\n\tif(!c) return 0;if(l==r) return t[c].pos;\n\tint mid=(l+r)>>1;if(x<=mid) return query(ls(c),l,mid,x);\n\tif(x>mid) return query(rs(c),mid+1,r,x);\n}\n\nvoid dfs3(int u,int fa){\n\tmodify(rt[u],rt[fa],1,n,w[u],u);\n\tfor(int i=head[u];i!=-1;i=g[i].nxt){\n\t\tint v=g[i].to;if(v==fa) continue;dfs3(v,u);\n\t}\t\n\treturn ;\n}\n\nint jump(int u,int d){\n\tif(dep[u]<d) return 0;\n\tfor(int i=20;i>=0;i--) if(dep[f1[u][i]]>=d) u=f1[u][i];\n\treturn w[u];\n}\n\nint jump2(int u,int d){\n\tfor(int i=20;i>=0;i--) if(dep[f2[u][i]]>=d) u=f2[u][i];\n\treturn w[u];\n}\n\nint check(int v,int x,int d,int se){\n\tint u=query(rt[v],1,n,x);\n\tif(dep[u]<d) return 0;\n\tint st=jump2(u,d);\n\treturn (st<=(se+1));\n}\n\n\nint main(){\n\tmemset(head,-1,sizeof(head));tot=0;\n\tn=read(),m=read(),c=read();\n\tfor(int i=1;i<=c;i++) p[i]=read();\n\tfor(int i=1;i<=n;i++) w[i]=read();\n\tfor(int i=1;i<n;i++){int u=read(),v=read();add(u,v);add(v,u);}\n\tmemset(vt,0,sizeof(vt));\n\tint kt=c;\n\tfor(int i=1;i<=c;i++) vt[p[i]]=i;\n\tfor(int i=1;i<=n;i++){if(!vt[w[i]]) vt[w[i]]=++kt;w[i]=vt[w[i]];}\n\tdfs1(1,0);\n\tfor(int j=1;j<=20;j++) for(int i=1;i<=n;i++) f[i][j]=f[f[i][j-1]][j-1];\n\tq=read();\n\tmemset(rt,0,sizeof(rt));memset(col,0,sizeof(col));\n\tdfs2(1,0);\n\tfor(int j=1;j<=20;j++) for(int i=1;i<=n;i++) f1[i][j]=f1[f1[i][j-1]][j-1],f2[i][j]=f2[f2[i][j-1]][j-1];\n\tcnt=0;dfs3(1,0);\n\tfor(int i=1;i<=q;i++){\n\t\tint u=read(),v=read();int pt=lca(u,v);\n\t\tint fi=query(rt[u],1,n,1);\n\t\tint se=min(jump(fi,dep[pt]),c);\n\t\tint l=se+1,r=c,ans=se;\n\t\twhile(l<=r){\n\t\t\tint mid=(l+r)>>1;\n\t\t\tif(check(v,mid,dep[pt],se)) l=mid+1,ans=mid;\n\t\t\telse r=mid-1;\n\t\t}\n\t\tprintf(\"%d\\n\",ans);\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1618190444,
        "uid": 81274,
        "name": "wuhao2005",
        "ccfLevel": 7,
        "title": "[\u7701\u9009\u8054\u8003 2021 A/B \u5377] \u5b9d\u77f3"
    },
    {
        "content": "Updated 2021/4/13\uff1a\u66f4\u65b0\u4e86\u4ee3\u7801\uff08\u539f\u4ee3\u7801\u53ef\u80fd\u65e0\u6cd5\u5904\u7406 $s=o$ \u5e76\u4e14 $W_o=1$ \u7684\u60c5\u51b5\uff09\uff0c\u4ee5\u53ca\u52a0\u4e86\u4e00\u4e9b\u7ec6\u8282\u8bf4\u660e\u3002\n\n### Description\n\n\u7ed9\u5b9a\u4e00\u68f5\u6811\uff0c$n$ \u4e2a\u9876\u70b9\uff0c\u6bcf\u4e2a\u70b9\u6709\u4e00\u4e2a\u5b9d\u77f3\uff0c\u7c7b\u578b\u4e3a $W_i$\uff0c\u7ea6\u5b9a $W_i\\in [1,m]$\u3002\u4f60\u6709\u4e00\u4e2a\u6536\u96c6\u5668\uff0c\u53ef\u4ee5\u6536\u96c6\u81f3\u591a $c$ \u4e2a\u5b9d\u77f3\uff0c\u5e76\u4e14\u6536\u96c6\u987a\u5e8f\u5fc5\u987b\u4e3a $P_1,P_2,\\cdots, P_c$\uff0c\u5176\u4e2d $P_1\\sim P_c$ \u4e92\u4e0d\u76f8\u540c\u3002\u5148\u6709 $q$ \u6b21\u8be2\u95ee\uff0c\u6bcf\u6b21\u8be2\u95ee\u4e00\u6761\u6709\u5411\u8def\u5f84 $s_i\\to t_i$\uff0c\u6c42\u4f9d\u6b21\u6700\u591a\u53ef\u4ee5\u6536\u96c6\u591a\u5c11\u5b9d\u77f3\u3002\n\n### Hint\n\n$1\\le n, q\\le 2\\times 10^5$\uff0c$1\\le c\\le m\\le 5\\times 10^4$\n\n### Solution\n\n\u4e0d\u77e5\u9053\u4e3a\u4ec0\u4e48\uff0c\u6211\u9047\u89c1\u8fd9\u79cd\u6811\u4e0a\u8def\u5f84\u95ee\u9898\u5c31\u5f88\u81ea\u7136\u7684\u60f3\u5230\u70b9\u5206\u6cbb\uff0c\u4e8e\u662f\u8003\u573a\u4e0a\u5c31\u6709\u4e86\u8fd9\u4e2a\u795e\u5947\u505a\u6cd5\u3002\n\n\u4e3a\u65b9\u4fbf\uff0c\u5c06 $W_x$ \u7684\u542b\u4e49\u6539\u4e3a\u539f $W_x$ \u5728 $P$ \u4e2d\u7684\u4e0b\u6807\uff0c\u6362\u53e5\u8bdd\u8bf4\uff0c\u5373\u201c\u6392\u540d\u201d\u3002\n\n\u9996\u5148\u79bb\u7ebf\u8be2\u95ee\uff0c\u5bf9\u4e8e\u5f53\u524d\u5206\u6cbb\u7684\u8fde\u901a\u5757\uff0c\u5904\u7406\u51fa\u6240\u6709\u5305\u542b\u4e8e\u5757\u5185\u3001\u7ecf\u8fc7\u5206\u6cbb\u4e2d\u5fc3\u7684\u8be2\u95ee\u7684\u7b54\u6848\u3002\u6ce8\u610f\u5230\u5c06\u8def\u5f84\u6309\u5206\u6cbb\u4e2d\u5fc3 $o$ \u5206\u4e3a\u4e24\u90e8\u5206\u540e\uff0c\u4e24\u90e8\u5206\u672c\u8d28\u4e0d\u76f8\u540c\uff08\u663e\u7136\u5427\uff09\uff0c\u56e0\u6b64\u5206\u522b\u8003\u8651 $s\\to o,o\\to t$ \u4e24\u90e8\u5206\u3002\n\n\u5bf9\u4e8e $s\\to o$ \u90e8\u5206\uff0c\u6211\u4eec\u5e0c\u671b\u9009\u51fa\u7684\u5b9d\u77f3\u5c3d\u53ef\u80fd\u591a\uff0c\u7406\u7531\u4e0d\u4ec5\u4ec5\u662f\u6700\u5927\u5316\u7b54\u6848\uff0c\u8fd8\u56e0\u4e3a\u6211\u4eec\u53ef\u4ee5\u6709\u4f59\u5730\u53bb\u548c $o\\to t$ \u90e8\u5206\u5bf9\u63a5\u3002\u90a3\u4e48\u4e0d\u96be\u5bf9\u6bcf\u4e2a\u70b9\u6c42\u51fa\u5176\u5230 $o$ \u7684\u8def\u5f84\u4e0a\u6700\u591a\u9009\u591a\u5c11\u5b9d\u77f3\uff0c\u5177\u4f53\u7684\uff0c\u6c42\u51fa\u8def\u5f84\u4e0a\u7b2c\u4e00\u4e2a $P_1$ \u51fa\u73b0\u7684\u4f4d\u7f6e\uff0c\u5bf9\u4e8e\u6bcf\u4e2a $x$ \u6c42 $W_x +1$ \u5bf9\u5e94\u7684\u7b2c\u4e00\u4e2a\u4f4d\u7f6e\u5373\u53ef\u3002\n\n\u5bf9\u4e8e $o\\to t$ \u90e8\u5206\uff0c\u6211\u4eec\u5e0c\u671b\u53ef\u4ee5\u4e0e\u524d\u4e00\u90e8\u5206\u5bf9\u63a5\uff0c\u90a3\u5fc5\u7136\u662f\u4ece $t$ \u5f00\u59cb\uff0c\u9009\u9010\u6e10\u9012\u51cf\u7684\u51e0\u4e2a\uff0c\u5e76\u4e14\u6700\u540e\u90a3\u4e2a\u5c3d\u53ef\u80fd\u5c0f\u3002\u7528\u7c7b\u4f3c\u4e0a\u9762\u7684\u65b9\u6cd5\u4e5f\u53ef\u4ee5\u6c42\u51fa\uff0c\u6ce8\u610f\u5982\u679c\u4e0a\u9762\u5305\u542b\u4e86 $o$ \u8fd9\u91cc\u5c31\u6700\u597d\u523b\u610f\u907f\u5f00\u3002\n\n\u6700\u540e\u8003\u8651\u5728\u540e\u534a\u90e8\u5206\u4e2d\u4efb\u4f55\u5904\u7406\u8be2\u95ee\u3002\u5f88\u663e\u7136\u7b54\u6848\u6709\u53ef\u4e8c\u5206\u6027\uff0c\u8003\u8651\u4e8c\u5206\u7b54\u6848\u3002\u5982\u4f55\u68c0\u9a8c\u4e00\u4e2a $mid$ \u662f\u5426\u53ef\u8fbe\uff1f\u4e0d\u59a8\u5148\u5728 $t\\to o$ \u7684\u8def\u5f84\u4e0a\u627e\u5230\u7b2c\u4e00\u4e2a $mid$ \u7684\u4f4d\u7f6e\uff08\u5982\u679c\u627e\u4e0d\u5230\u5f53\u7136\u722a\u5df4\u4e86\uff09\uff0c\u7136\u540e\u5728\u8fd9\u4e2a\u4f4d\u7f6e\u5f80\u4e0a\u9012\u51cf\uff08\u6bcf\u6b21\u51cf\u4e00\uff09\u5730\u8df3\uff0c\u770b\u770b\u80fd\u8df3\u5230\u591a\u5c0f\uff0c\u8bb0\u5176\u4e3a $y$\u3002\u4ee4 $s\\to o$ \u8def\u5f84\u4e0a\u6700\u591a\u9009\u51fa $x$ \u4e2a\uff0c\u90a3\u4e48\u82e5 $x+1\\ge y$\uff0c\u8bf4\u660e\u80fd\u63a5\u4e0a\uff0c\u5f53\u524d\u8fd9\u4e2a $mid$ \u662f\u53ef\u884c\u7684\u3002\n\n\u6700\u540e\u590d\u6742\u5ea6 $O(n\\log n+q\\log m)$\uff0c\u70b9\u5206\u4e00\u53ea $\\log$\uff0c\u540e\u9762\u5bf9\u4e8e\u6bcf\u4e2a\u8be2\u95ee\u505a\u4e00\u6b21 $O(\\log m)$ \u7684\u4e8c\u5206\u7b54\u6848\u3002\n\n### Implementation\n\n\u4e3a\u4ec0\u4e48\u8fd9\u8981\u4e00\u4e2a\u5355\u72ec\u8bf4\u660e\u5462\uff1f\u56e0\u4e3a\u6211\u5728\u8003\u573a\u4e0a\u7ec6\u8282\u6ca1\u60f3\u6e05\u695a\uff0c\u5bfc\u81f4\u5199\u7684\u5f88\u8c14\u8c14\uff08\u7edd\u5bf9\u6ca1\u6709\u4e0b\u9762\u4ee3\u7801\u90a3\u4e48\u7b80\u6d01\uff09\uff0c\u82b1\u4e86 3 \u4e2a\u591a\u5c0f\u65f6\uff0c\u6240\u4ee5\u6e05\u6670\u7684\u5b9e\u73b0\u601d\u8def\u540c\u7b97\u6cd5\u4e00\u6837\u91cd\u8981\u3002\n\n\u4e0b\u9762\u662f\u6211\u7684\u5b9e\u73b0\uff0c\u4e0d\u4e00\u5b9a\u662f\u6700\u7b80\u6d01\u7684\u3002\n\n\u9996\u5148\u662f\u4f20\u8be2\u95ee\uff1a\u6bcf\u4e00\u6b21\u5206\u6cbb\u4e2d\u90fd\u8981\u5bf9\u8be2\u95ee\u5206\u7c7b\uff1a\u8de8\u8d8a\u5206\u6cbb\u4e2d\u5fc3 $o$ \u4e0e\u5426\u3002\u67d3\u8272\u6cd5\u662f\u4e00\u4e2a\u597d\u4e1c\u897f\uff1a\u6211\u4eec\u5bf9\u5206\u6cbb\u5757\u4e2d\u6bcf\u68f5\u5b50\u6811\u67d3\u4e0a\u4e0d\u540c\u7684\u989c\u8272\uff0c\u5982\u679c $s,t$ \u7684\u989c\u8272\u76f8\u540c\uff0c\u90a3\u5c31\u662f\u4e0b\u4e00\u5c42\u9012\u5f52\u8be5\u5e72\u7684\u4e8b\u60c5\u4e86\uff08\u6ce8\u610f\u7279\u5224 $s=t=o$\u3002\u7279\u522b\u662f $s=o$\uff0c\u9700\u8981\u52a0\u5224\u65ad $W_o$ \u662f\u5426 $=1$\uff09\u3002\n\n\u7136\u540e\u662f\u6c42\u51fa\u4e00\u6761 $x\\to o$ \u7684\u8def\u5f84\u6c42\u51fa\u6700\u591a\u9009\u51e0\u4e2a\u5b9d\u77f3\u3002\u4e00\u6ce2 Dfs \u6c42\u51fa\u4e0a\u9762\u7b2c\u4e00\u4e2a $1$ \u7684\u4f4d\u7f6e\uff0c\u7b2c\u4e00\u4e2a $W_x+1$ \u7684\u4f4d\u7f6e\uff08\u53ef\u4ee5\u501f\u52a9\u53ef\u64a4\u9500\u6570\u7ec4\u5b8c\u6210\uff09\uff0c\u901a\u8fc7\u8fd9\u4e24\u4e2a\u518d\u4e00\u6ce2 Dfs \u6c42\u51fa\u6bcf\u4e2a\u70b9\u5411\u4e0a\u9009\u51fa\u4e00\u4e2a\u503c\u57df\u8fde\u7eed\u6bb5\uff08\u4e0d\u4e00\u5b9a\u4ece\u4e00\u5f00\u59cb\uff09\u7684\u957f\u5ea6\u5373\u53ef\uff0c\u5148\u5f80\u4e0a\u627e\u5230\u4e00\u4e2a $1$\uff0c\u7136\u540e\u8fde\u7740\u8d70\u540e\u7ee7\u3002\n\n$o\\to t$ \u90e8\u5206\u5f02\u66f2\u540c\u5de5\uff0c\u6ce8\u610f\u6700\u540e\u4e8c\u5206\u7b54\u6848\u7684\u521d\u59cb\u5de6\u8fb9\u754c\u4e3a\uff0c\u524d\u534a\u90e8\u5206\u7684\u7b54\u6848 $+1$\u3002\u4e0d $+1$ \u8fc7\u4e0d\u4e86\u5927\u6837\u4f8b\uff1f\u8fd9\u4e2a\u6211\u4e5f\u4e0d\u6e05\u695a\u3002\n\n### Code\n\n```cpp\n#include <algorithm>\n#include <cctype>\n#include <cstdio>\n#include <vector>\n\ninline int read() {\n  int x = 0; char c; while (!isdigit(c = getchar()));\n  do x = (x << 1) + (x << 3) + c - '0'; while (isdigit(c = getchar()));\n  return x;\n}\n\nconst int N = 2e5 + 5;\nconst int M = 5e4 + 5;\n\nint n, m, c, W[N];\nint rank[N];\nstd::vector<int> adj[N];\n\nstruct revArray {\n  int dat[M];\n  std::vector<std::pair<int, int> > his;\n\n  inline void edit(int x, int v) {\n    his.emplace_back(x, dat[x]);\n    dat[x] = v;\n  }\n  inline int operator [] (const int& x) const {\n    return dat[x];\n  }\n  inline void back() {\n    auto last = his.back();\n    dat[last.first] = last.second;\n    his.pop_back();\n  }\n} rec;\n\nint q, ans[N];\nstruct request {\n  int s, t, idx;\n};\n\nint maxp[N], siz[N], root;\nbool centr[N];\n\nint get_size(int x, int f) {\n  siz[x] = 1;\n  for (auto y : adj[x]) if (y != f && !centr[y])\n    siz[x] += get_size(y, x);\n  return siz[x];\n}\nvoid get_centr(int x, int f, int t) {\n  maxp[x] = 0;\n  for (auto y : adj[x]) if (y != f && !centr[y])\n    get_centr(y, x, t), maxp[x] = std::max(maxp[x], siz[y]);\n  maxp[x] = std::max(maxp[x], t - siz[x]);\n  if (maxp[x] < maxp[root]) root = x;\n}\n\nint color[N];\nvoid set_color(int x, int f, int c) {\n  color[x] = c;\n  for (auto y : adj[x]) if (y != f && !centr[y])\n    set_color(y, x, c);\n}\n\nint nxt[N], fir[N], pre[N], inc[N], dec[N];\nvoid get_nxt_fir(int x, int f) {\n  rec.edit(W[x], x);\n  nxt[x] = rec[W[x] + 1], fir[x] = rec[1];\n  for (auto y : adj[x]) if (y != f && !centr[y])\n    get_nxt_fir(y, x);\n  rec.back();\n}\nvoid get_inc(int x, int f) {\n  inc[x] = nxt[x] ? inc[nxt[x]] : W[x];\n  for (auto y : adj[x]) if (y != f && !centr[y])\n    get_inc(y, x);\n}\nvoid get_pre(int x, int f) {\n  rec.edit(W[x], x);\n  if (W[x]) pre[x] = rec[W[x] - 1];\n  for (auto y : adj[x]) if (y != f && !centr[y])\n    get_pre(y, x);\n  rec.back();\n}\nvoid get_dec(int x, int f) {\n  dec[x] = pre[x] ? dec[pre[x]] : W[x];\n  for (auto y : adj[x]) if (y != f && !centr[y])\n    get_dec(y, x);\n}\n\nstd::vector<request> subreq[N];\nstd::vector<request> tosol[N];\nvoid get_ans(int x, int f) {\n  if (x != f) rec.edit(W[x], x);\n  for (auto qry : tosol[x]) {\n    int worst = fir[qry.s] ? inc[fir[qry.s]] : 0;\n    int lb = worst + 1, ub = c;\n    while (lb <= ub) {\n      int mid = (lb + ub) >> 1;\n      if (!rec[mid] || dec[rec[mid]] - 1 > worst) ub = mid - 1;\n      else lb = mid + 1, ans[qry.idx] = mid;\n    }\n    ans[qry.idx] = std::max(ans[qry.idx], worst);\n  }\n  for (auto y : adj[x]) if (y != f && !centr[y])\n    get_ans(y, x);\n  if (x != f) rec.back();\n}\nvoid clear_all(int x, int f) {\n  pre[x] = nxt[x] = fir[x] = 0;\n  color[x] = inc[x] = dec[x] = 0;\n  tosol[x].clear();\n  for (auto y : adj[x]) if (y != f && !centr[y])\n    clear_all(y, x);\n}\n\nvoid solve(int x, std::vector<request>& req) {\n  if (req.empty()) return;\n\n  maxp[root = 0] = N;\n  get_centr(x, 0, get_size(x, 0));\n  centr[root] = 1;\n\n  std::vector<request> cur;\n  for (auto y : adj[root]) if (!centr[y])\n    set_color(y, root, y);\n  for (auto qry : req)\n    if (color[qry.s] == color[qry.t]) {\n      if (!color[qry.s]) ans[qry.idx] = (W[root] == 1);\n      else subreq[color[qry.s]].push_back(qry);\n    } else cur.push_back(qry);\n  \n  rec.edit(W[root], root);\n  fir[root] = W[root] == 1 ? root : 0;\n  for (auto y : adj[root]) if (!centr[y])\n    get_nxt_fir(y, root);\n  rec.back();\n\n  inc[root] = W[root];\n  for (auto y : adj[root]) if (!centr[y])\n    get_inc(y, root);\n  \n  for (auto y : adj[root]) if (!centr[y])\n    get_pre(y, root);\n  \n  for (auto y : adj[root]) if (!centr[y])\n    get_dec(y, root);\n  \n  for (auto qry : cur)\n    tosol[qry.t].push_back(qry);\n  get_ans(root, root);\n\n  clear_all(root, 0);\n  std::vector<std::vector<request> > copy;\n  for (auto y : adj[root]) if (!centr[y])\n    copy.push_back(subreq[y]), subreq[y].clear();\n  auto it = copy.begin();\n  for (auto y : adj[root]) if (!centr[y])\n    solve(y, *it), ++it;\n}\n\nsigned main() {\n  n = read(), m = read(), c = read();\n\n  for (int i = 1; i <= c; i++) rank[read()] = i;\n  for (int i = 1; i <= n; i++) W[i] = rank[read()];\n\n  for (int i = 1; i < n; i++) {\n    int u = read(), v = read();\n    adj[u].push_back(v), adj[v].push_back(u);\n  }\n\n  std::vector<request> req(q = read());\n  for (int i = 0; i < q; i++)\n    req[i].s = read(), req[i].t = read(), req[i].idx = i + 1;\n  solve(1, req);\n\n  for (int i = 1; i <= q; i++)\n    printf(\"%d\\n\", ans[i]);\n  return 0;\n}\n```",
        "postTime": 1618188743,
        "uid": 61430,
        "name": "_Wallace_",
        "ccfLevel": 5,
        "title": "\u9898\u89e3 P7518 \u3010[\u7701\u9009\u8054\u8003 2021 A/B \u5377] \u5b9d\u77f3\u3011"
    },
    {
        "content": "## \uff08\u3007\uff09\u8003\u573a\u4e0a\u7684\u4e00\u4e9bideas\n\n> \u5176\u5b9e\u8fd9\u90e8\u5206\u5df2\u7ecf\u662f\u6b63\u89e3\u4e86\u3002\n\n##### \u7b2c\u4e00\u6863\u90e8\u5206\u5206\uff1a\n\n\u5f00\u80035min\uff1a\n\n\u4e00\u4e2a\u5f88\u663e\u7136\u7684\u66b4\u529b\uff1a\u5bf9\u4e8e\u6bcf\u6b21\u8be2\u95ee\u90fd\u4ece $u$ \u627e\u5230 $v$\uff0c ```25pts```gets\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6$\\Theta(nq)$\n\n##### \u7b2c\u4e8c\u6863\u90e8\u5206\u5206\uff08$m \\leq 300$\uff09\uff1a\n\n\u5f00\u800310min:\n\n\u9996\u5148\u4e00\u4e2a\u5904\u7406\u6811\u4e0a\u8def\u5f84\u95ee\u9898\u7684\u5957\u8def\uff1a\u5c06 $(u,v)$ \u62c6\u6210 $(u, lca)$\uff0c $(lca, v)$\n\n\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u8282\u70b9\uff0c\u5047\u8bbe\u5f53\u524d\u8282\u70b9\u7684\u989c\u8272\u5728\u6392\u5217\u4e2d\u662f\u7b2c $i$ \u4e2a\u3002\n\n\u8003\u8651\u7528 $f(i, j)=x$ \u8868\u793a $i$ \u6cbf\u7740\u7236\u8fb9\u5411\u4e0a\u8d70\u9047\u5230\u4e86\u8fde\u7eed $j$ \u4e2a\u6392\u5217\u7684\u672b\u7aef\u8282\u70b9\u662f $x$\u3002\n\n\u5bf9\u4e8e\u6bcf\u4e2a\u8282\u70b9\u7684 $f$ \u90fd\u53ef\u4ee5 $\\Theta(m)$ \u66b4\u529b\u6c42\u89e3\uff08\u6bcf\u4e2a\u8282\u70b9\u90fd\u4e00\u6b65\u6b65\u5411\u4e0a\u8df3\uff0c\u8bb0\u5f55\u5f53\u524d\u9047\u5230\u4e86\u8fde\u7eed\u591a\u5c11\u4e2a\u6392\u5217\uff09\u3002\n\n\u6ce8\u610f\uff1a \u7531\u4e8e\u8def\u5f84 $(u, lca)$ \u4e0e\u8def\u5f84 $(lca, v)$ \u5728\u6811\u4e0a\u7684\u65b9\u5411\u662f\u76f8\u53cd\u7684\uff08\u4e00\u4e2a\u5411\u6839\u8d70\uff0c \u53e6\u4e00\u4e2a\u5411\u53f6\u5b50\u8d70\uff09\uff0c \u56e0\u6b64\u9700\u8981\u5904\u7406 $f_1$ \u548c $f_2$ \u5206\u522b\u8868\u793a\u5411\u4e0a\u8d70\u6216\u8005\u5411\u4e0b\u8d70\u3002\n\n\u5bf9\u4e8e\u6bcf\u4e2a\u8be2\u95ee\uff0c \u53ef\u4ee5\u6811\u5256\u67e5\u8be2\uff0c\u7136\u540e\u4e8c\u5206\u67e5\u627e\u6700\u957f\u8def\u5f84\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a$\\Theta(nm+q\\log n\\log m)$\n\n##### \u7b2c\u4e09\u6863\u90e8\u5206\u5206 \uff08$u_i=i,v_i=i+1$\uff09\uff1a\n\n\u5f00\u800330min\uff1a\n\n\u8fd9\u662f\u94fe\u7684\u60c5\u51b5\uff0c \u53ea\u9700\u8981\u8003\u8651\u5e8f\u5217\u4e0a\u5982\u4f55\u505a\u3002\n\n\u7531\u4e8e\u7b2c\u4e8c\u6863\u90e8\u5206\u5206 $m\\leq 300$ \u7ed9\u6211\u4eec\u7684\u542f\u793a\uff0c \u6211\u4eec\u53ef\u4ee5\u7528 $f(i, j)=x$ \u8bb0\u5f55\u7b2c $i$ \u4e2a\u4f4d\u7f6e\u7684\u540e\u8fde\u7eed $j$ \u4e2a\u6392\u5217\u672b\u7aef\u6240\u5728\u7684\u4f4d\u7f6e\u662f $x$\u3002\n\n\u4f46\u662f\uff0c\u7531\u4e8e$m\\leq 2\\times 10^5$\uff0c \u5f00\u4e0d\u4e0b\u90a3\u4e48\u5927\u7684\u7a7a\u95f4\u3002\n\n\u53d7\u5230\u7b2c\u4e8c\u6863\u90e8\u5206\u5206\u7684\u542f\u53d1\uff0c \u53ef\u4ee5\u8003\u8651\u5206\u5757[^1]\u3002\uff08\u901a\u4fd7\u7684\u8bf4\uff0c\u5c31\u662f\u7528\u65f6\u95f4\u6362\u7a7a\u95f4\uff09\n\n\u65e2\u7136\u6211\u65e0\u6cd5\u628a\u540e\u9762\u7684\u8fde\u7eed $m$ \u4e2a\u6392\u5217\u7684\u4f4d\u7f6e\u5168\u90e8\u8bb0\u4e0b\u6765\uff0c \u90a3\u6211\u5c31\u53ea\u8bb0\u540e\u9762\u8fde\u7eed\u7684 $\\sqrt m$ \u4e2a\u6392\u5217\u7684\u4f4d\u7f6e\u3002\n\n\u6bcf\u6b21\u67e5\u8be2\uff0c \u90fd\u5c3d\u53ef\u80fd\u7684\u5f80\u6700\u8fdc\u5904\u8df3\uff0c \u6700\u591a\u53ea\u7528\u8df3 $\\sqrt m$ \u6b21\u3002\n\n\u8fd9\u6837\u4e00\u6765\uff0c \u5c31\u7684\u5230\u4e86\u4e00\u4e2a\u5341\u5206\u201c\u4f18\u79c0\u201d\u7684\u7b97\u6cd5\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a $\\Theta (n\\sqrt m+q\\sqrt m)$\n\n##### \u7b2c\u56db\u6863\u90e8\u5206\u5206\uff08\u6b63\u89e3\uff09\uff1a\n\n\u5f00\u800345min\uff1a\n\n\u5b9e\u9645\u4e0a\uff0c\u53ea\u9700\u8981\u5c06\u4ee5\u4e0a\u4e24\u6863\u90e8\u5206\u5206\u7ed3\u5408\u8d77\u6765\u5c31\u662f\u6b63\u89e3\u4e86\u3002\n\n\u6b63\u89e3\u5305\u542b\u4e86\u4e24\u6863\u90e8\u5206\u5206\u4e2d\u6700\u9ebb\u70e6\u7684\u90e8\u5206\u3002\n\n\u4f17\u6240\u5468\u77e5\uff0c \u6811\u5256\u5c31\u662f\u5c06\u6811\u4e0a\u7684\u95ee\u9898\u8f6c\u5316\u4e3a\u5e8f\u5217\u4e0a\u7684\u95ee\u9898\u3002\n\n\u65e2\u7136\u53ef\u4ee5\u5e8f\u5217\u4e0a\u5bf9\u989c\u8272\u5206\u5757\uff0c \u90a3\u4e48\u662f\u5426\u4e5f\u53ef\u4ee5\u5728\u6811\u4e0a\u5bf9\u989c\u8272\u5206\u5757\u5462\uff1f \u7b54\u6848\u662f\u80af\u5b9a\u7684\u3002\n\n\u5177\u4f53\u5b9e\u73b0\u53ea\u9700\u8981\u7528\u6811\u5256\u5c06\u8be2\u95ee\u8f6c\u5316\u4e3a\u5e8f\u5217\u4e0a\u4e00\u6bb5\u6bb5\u7684\u533a\u95f4\uff0c \u7136\u540e\u518d\u5957\u7528\u5e8f\u5217\u4e0a\u95ee\u9898\u7684\u505a\u6cd5\u5373\u53ef\u3002\uff08\u6ce8\u610f\u540c\u6837\u8981\u7ef4\u62a4\u6811\u4e0a\u5411\u4e0a\u6216\u662f\u5411\u4e0b\u7684\u8def\u5f84\uff09\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a$\\Theta(n\\sqrt m+q\\sqrt m\\log n)$\n\n> \u63a5\u4e0b\u6765\u662f\u6211\u7262\u9a9a\u65f6\u523b\uff0c \u5efa\u8bae\u8df3\u8fc7\n\n\u54a6\uff0c t1 just this? \u4e8e\u662f\u518d\u5199\u6b63\u89e3\u7684\u8def\u4e0a\u72c2\u5954\u3002\n\n\u5f00\u80031h\uff1a\n\n\u6b63\u89e3\u600e\u4e48\u8fd9\u4e48\u96be\u5199\u5440\uff01(coding...)\n\n\u5f00\u80031.5h\uff1a\n\n\u600e\u4e48\u7ec6\u8282\u8fd9\u4e48\u591a\u5440\uff01\uff01\uff08debugging...\uff09\n\n\u5f00\u80032h\uff1a\n\n\u7ec8\u4e8e\u8c03\u5bf9\u4e86\uff0c \u6d4b $gem2.in$\uff0c \u55ef\uff0c \u627e\u4e0d\u5230\u5dee\u5f02\u3002\n\n\u6d4b $gem3.in$\uff0c ****\uff0c \u600e\u4e48\u7206\u6808\u4e86\uff0c \u600e\u4e48\u5f00\u6808\uff08\u65e0\u80fd\u72c2\u6012\uff09\n\n\u95ee\u76d1\u8003\u5458\uff0c \u76d1\u8003\u5458\uff1a\u6211\u597d\u4e45\u6ca1\u7528 windows \u4e86\u3002\uff08\u6211\u4e5f\u4e0d\u77e5\u9053\u600e\u4e48\u5f00\u6808\uff09\n\n> \u6b64\u65f6 God\u306efather \u4e0d\u77e5\u9053\uff0c \u4ed6\u5c06\u5b58\u989c\u8272\u7684\u6570\u7ec4\u5f00\u5c0f\u4e86\uff0c \u8fd9\u662f\u4ed6\u5669\u68a6\u7684\u5f00\u59cb\u3002\n\n\u8003\u573a\u4ee3\u7801\u5206\u6570\uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/pdo31gos.png)\n\n\u66f4\u6539\u6570\u7ec4\u5927\u5c0f\u540e\u5206\u6570\uff08\u7531\u4e8e\u8003\u573a\u4e0a\u4e0d\u77e5\u6240\u63aa\uff0c \u65f6\u95f4\u590d\u6742\u5ea6\u4e5f\u5199\u5047\u4e86\uff09\uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/3b14xkx4.png)\n\n## \uff08\u4e00\uff09\u5173\u4e8e\u6b63\u89e3\n\n> \u4e5f\u8bb8\u8c03\u6574\u4e00\u4e0b\u5757\u957f\u5206\u5757\u5c31\u80fd\u8fc7\u4e86\u5462\uff1f\n\n\u4e8b\u5b9e\u4e0a\uff0c \u6211\u4eec\u5e76\u4e0d\u9700\u8981\u5206\u5757\uff08\u6765\u81ea\u4e00\u540d\u88ab $m\\leq 300$ \u8bef\u5bfc\uff0c \u8ba4\u4e3a\u662f\u5206\u5757\u7684\u83dc\u9e21\uff09\u3002\n\n\u500d\u589e\u53ef\u4ee5\u8fbe\u5230\u5206\u5757\u540c\u6837\u7684\u6548\u679c\u3002\uff08\u5e76\u4e14\u5e38\u6570\u66f4\u5c0f\uff0c \u4ee3\u7801\u66f4\u77ed\uff09\n\n\uff08\u6b64\u65f6\u5df2\u7ecf\u901a\u8fc7\u6811\u5256\u5c06\u6811\u4e0a\u7684\u95ee\u9898\u8f6c\u5316\u4e3a\u4e86\u5e8f\u5217\u4e0a\u7684\u95ee\u9898\uff09\u5177\u4f53\u505a\u6cd5\u662f\uff0c $f(i, j)=x$ \u8868\u793a\u4f4d\u7f6e $i$ \u540e\u8fde\u7eed $2^j$ \u4e2a\u6392\u5217\u7684\u4f4d\u7f6e\u662f $x$ \u3002\n\n\u81f3\u4e8e\u67e5\u8be2\uff0c \u7c7b\u4f3c\u4e8e\u500d\u589e\u6cd5\u6c42 $lca$ \uff0c \u5148\u8df3\u5927\u6b65\uff0c \u518d\u8df3\u5c0f\u6b65\u903c\u8fd1\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\u964d\u5230\u4e86\uff1a$\\Theta(n\\log m+q\\log m\\log n)$\n\ncode\uff08\u5206\u5757\uff09\uff1a\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\ninline int read(){\n\tint w = 0, f = 1; char ch = getchar();\n\twhile(ch < '0' or ch > '9') {if(ch == '-') f = -f; ch = getchar();}\n\twhile(ch >= '0' and ch <= '9') w = w*10 + ch - '0', ch = getchar();\n\treturn w*f;\n}\nconst int maxm = 5e4 + 5, maxn = 2e5 + 5;\nint N, M, c, P[maxn], w[maxn], head[maxn], Next[maxn<<1], ver[maxn<<1], tot, p[maxm], blen;\nvoid add(int x, int y){\n\tver[++tot] = y, Next[tot] = head[x], head[x] = tot;\n}\nint d[maxn], f[maxn], son[maxn], siz[maxn], top[maxn], id[maxn], cnt;\npair<int, int> nw[maxn];\nint nxt[maxn][305][2], num, len[maxn][2];\nvector<int> col[maxm];\nstruct node{\n\tint l, r; bool res;\n}ask[1005];\nvoid dfs1(int x, int fa){\n\tf[x] = fa, siz[x] = 1, d[x] = d[fa] + 1;\n\tfor(int i=head[x]; i; i=Next[i]){\n\t\tint y = ver[i];\n\t\tif(y == fa) continue;\n\t\tdfs1(y, x);\n\t\tsiz[x] += siz[y];\n\t\tif(siz[y] > siz[son[x]]) son[x] = y;\n\t}\n}\nvoid dfs2(int x, int TOP){\n\ttop[x] = TOP, id[x] = ++cnt;\n\tif(!son[x]) return ;\n\tdfs2(son[x], TOP);\n\tfor(int i=head[x]; i; i=Next[i]){\n\t\tint y = ver[i];\n\t\tif(y == f[x] or y == son[x]) continue;\n\t\tdfs2(y, y);\n\t}\n}\nint lca(int x, int y){\n\twhile(top[x] != top[y]){\n\t\tif(d[top[x]] < d[top[y]]) swap(x, y);\n\t\tx = f[top[x]];\n\t}\n\tif(d[x] > d[y]) swap(x, y);\n\treturn x;\n}\nvoid get_up(int x, int y){\n\twhile(top[x] != top[y]){\n\t\task[++num] = (node){id[top[x]], id[x], 1};\n\t\tx = f[top[x]];\n\t}\n\tif(id[y] != id[x]) ask[++num] = (node){id[y], id[x], 1};\n}\nvoid get_down(int x, int y){\n\tint s = num;\n\twhile(top[x] != top[y]){\n\t\task[++num] = (node){id[top[x]], id[x], 0};\n\t\tx = f[top[x]];\n\t}\n\task[++num] = (node){id[y], id[x], 0};\n\tfor(int i=1; i<=(num-s)/2; i++){\n\t\tswap(ask[s+i], ask[num-i+1]);\n\t}\n}\nint Find1(int x, int l){//\u8fd9\u662f\u6211\u8003\u573a\u4e0a\u65f6\u95f4\u590d\u6742\u5ea6\u5199\u5047\u7684\u90e8\u5206, \u591a\u4e861\u4e2alog\n\tif(x < l or x == 0) return 0;\n\tint L = 0, R = len[x][1];\n\twhile(L <= R){\n\t\tint mid = (L+R)>>1;\n\t\tif(nxt[x][mid][1] >= l) L = mid + 1;\n\t\telse R = mid-1;\n\t}\n\tint sum = R;\n\tif(R != 0) sum += Find1(nxt[x][R][1], l);\n\treturn sum;\n}\nint Find2(int x, int r){//\u540c\u4e0a\n\tif(x > r or x == 0) return 0;\n\tint L = 0, R = len[x][0];\n\twhile(L <= R){\n\t\tint mid = (L+R)>>1;\n\t\tif(nxt[x][mid][0] <= r) L = mid + 1;\n\t\telse R = mid - 1;\n\t}\n\tint sum = R;\n\tif(R != 0) sum += Find2(nxt[x][R][0], r);\n\treturn sum;\n}\nint main(){\n\tN = read(), M = read(), c = read();\n\tfor(int i=1; i<=M; i++) P[i] = read(), p[P[i]] = i;\n\tfor(int i=1; i<=N; i++) w[i] = read();\n\tfor(int i=1; i<N; i++){\n\t\tint x = read(), y = read();\n\t\tadd(x, y), add(y, x);\n\t}\n\tdfs1(1, 0);//\u6811\u5256\n\tdfs2(1, 1);\n\tfor(int i=1; i<=N; i++) nw[i] = make_pair(id[i], w[i]);\n\tsort(nw+1, nw+N+1); //\u6811\u4e0a\u95ee\u9898\u8f6c\u5e8f\u5217\u4e0a\u95ee\u9898\uff08\u6839\u636edfs\u5e8f)\n\tblen = 300;//\u5757\u957f\n\tfor(int i=1; i<=N; i++) col[nw[i].second].push_back(nw[i].first);\n\tfor(int i=1; i<=N; i++){//\u5206\u5757\uff1a\u5411\u4e0b\u7684\u8def\u5f84\n\t\tnxt[i][0][0] = i;\n\t\tint s = p[nw[i].second];\n\t\tfor(int j=1; j<=min(blen, M); j++){\n\t\t\tvector<int>::iterator it = lower_bound(col[P[s+j]].begin(), col[P[s+j]].end(), nxt[i][j-1][0]);\n\t\t\tif(it != col[P[s+j]].end()) nxt[i][j][0] = *it, len[i][0] = j;\n\t\t\telse break;\n\t\t}\n\t}\n\tfor(int i=N; i>=1; i--){//\u5206\u5757\uff1a \u5411\u4e0a\u7684\u8def\u5f84\n\t\tnxt[i][0][1] = i;\n\t\tint s = p[nw[i].second];\n\t\tfor(int j=1; j<=min(blen, M); j++){\n\t\t\tvector<int>::iterator it = lower_bound(col[P[s+j]].begin(), col[P[s+j]].end(), nxt[i][j-1][1]);\n\t\t\tif(it != col[P[s+j]].begin()) nxt[i][j][1] = *(--it), len[i][1] = j;\n\t\t\telse break;\n\t\t}\n\t}\n\tint q = read();\n\twhile(q--){\n\t\tint u = read(), v = read();\n\t\tint LCA = lca(u, v);\n\t\tnum = 0;\n\t\tget_up(u, LCA);//\u8bb0\u5f55\u8def\u5f84\u4e0a\u5212\u5206\u51fa\u6765\u7684\u533a\u95f4\n\t\tget_down(v, LCA);\n\t\tint cnt = 1;\n\t\tfor(int i=1; i<=num; i++){\n\t\t\tif(cnt == M+1) break;\n\t\t\tint l = ask[i].l, r = ask[i].r; bool res = ask[i].res;\n\t\t\tif(res){//\u5224\u65ad\u8be5\u533a\u95f4\u5728\u6811\u4e0a\u662f\u5411\u4e0a\u8fd8\u662f\u5411\u4e0b\n\t\t\t\tvector<int>::iterator it = upper_bound(col[P[cnt]].begin(), col[P[cnt]].end(), r);\n\t\t\t\tif(it == col[P[cnt]].begin()) continue;\n\t\t\t\tint s = *(--it);\n\t\t\t\tif(s < l) continue;\n\t\t\t\tcnt += Find1(s, l) + 1;\n\t\t\t}\n\t\t\telse{\n\t\t\t\tvector<int>::iterator it = lower_bound(col[P[cnt]].begin(), col[P[cnt]].end(), l);\n\t\t\t\tif(it == col[P[cnt]].end()) continue;\n\t\t\t\tint s = *it;\n\t\t\t\tif(s > r) continue;\n\t\t\t\tcnt += Find2(s, r) + 1;\n\t\t\t}\n\t\t}\n\t\tprintf(\"%d\\n\", cnt - 1);\n\t}\n\treturn 0;\n} \n```\n\ncode(\u500d\u589e)\uff08\u53ea\u6539\u52a8\u4e86\u4e00\u70b9\uff09\uff1a\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\ninline int read(){\n\tint w = 0, f = 1; char ch = getchar();\n\twhile(ch < '0' or ch > '9') {if(ch == '-') f = -f; ch = getchar();}\n\twhile(ch >= '0' and ch <= '9') w = w*10 + ch - '0', ch = getchar();\n\treturn w*f;\n}\nconst int maxm = 5e4 + 5, maxn = 2e5 + 5;\nint N, M, c, P[maxn], w[maxn], head[maxn], Next[maxn<<1], ver[maxn<<1], tot, p[maxm], blen;\nvoid add(int x, int y){\n\tver[++tot] = y, Next[tot] = head[x], head[x] = tot;\n}\nint d[maxn], f[maxn], son[maxn], siz[maxn], top[maxn], id[maxn], cnt;\npair<int, int> nw[maxn];\nint nxt[maxn][20][2], num, len[maxn][2];\nvector<int> col[maxm];\nstruct node{\n\tint l, r; bool res;\n}ask[100005];\nvoid dfs1(int x, int fa){\n\tf[x] = fa, siz[x] = 1, d[x] = d[fa] + 1;\n\tfor(int i=head[x]; i; i=Next[i]){\n\t\tint y = ver[i];\n\t\tif(y == fa) continue;\n\t\tdfs1(y, x);\n\t\tsiz[x] += siz[y];\n\t\tif(siz[y] > siz[son[x]]) son[x] = y;\n\t}\n}\nvoid dfs2(int x, int TOP){\n\ttop[x] = TOP, id[x] = ++cnt;\n\tif(!son[x]) return ;\n\tdfs2(son[x], TOP);\n\tfor(int i=head[x]; i; i=Next[i]){\n\t\tint y = ver[i];\n\t\tif(y == f[x] or y == son[x]) continue;\n\t\tdfs2(y, y);\n\t}\n}\nint lca(int x, int y){\n\twhile(top[x] != top[y]){\n\t\tif(d[top[x]] < d[top[y]]) swap(x, y);\n\t\tx = f[top[x]];\n\t}\n\tif(d[x] > d[y]) swap(x, y);\n\treturn x;\n}\nvoid get_up(int x, int y){\n\twhile(top[x] != top[y]){\n\t\task[++num] = (node){id[top[x]], id[x], 1};\n\t\tx = f[top[x]];\n\t}\n\tif(id[y] != id[x]) ask[++num] = (node){id[y], id[x], 1};\n}\nvoid get_down(int x, int y){\n\tint s = num;\n\twhile(top[x] != top[y]){\n\t\task[++num] = (node){id[top[x]], id[x], 0};\n\t\tx = f[top[x]];\n\t}\n\task[++num] = (node){id[y], id[x], 0};\n\tfor(int i=1; i<=(num-s)/2; i++){\n\t\tswap(ask[s+i], ask[num-i+1]);\n\t}\n}\nint Find1(int x, int l){// \u6539\u52a8\uff1a \u500d\u589e\u5148\u8df3\u5927\u6b65\uff0c \u518d\u8df3\u5c0f\u6b65\n\tint sum = 0;\n\tfor(int i=15; i>=0; i--){\n\t\tif(nxt[x][i][1] == 0) continue;\n\t\tif(nxt[x][i][1] >= l){\n\t\t\tx = nxt[x][i][1];\n\t\t\tsum += (1<<i);\n\t\t}\n\t}\n\treturn sum;\n}\nint Find2(int x, int r){//\u540c\u4e0a\n\tint sum = 0;\n\tfor(int i=15; i>=0; i--){\n\t\tif(nxt[x][i][0] == 0) continue;\n\t\tif(nxt[x][i][0] <= r){\n\t\t\tx = nxt[x][i][0];\n\t\t\tsum += (1<<i);\n\t\t}\n\t}\n\treturn sum;\n}\nint main(){\n\tN = read(), M = read(), c = read();\n\tfor(int i=1; i<=M; i++) P[i] = read(), p[P[i]] = i;\n\tfor(int i=1; i<=N; i++) w[i] = read();\n\tfor(int i=1; i<N; i++){\n\t\tint x = read(), y = read();\n\t\tadd(x, y), add(y, x);\n\t}\n\tdfs1(1, 0);\n\tdfs2(1, 1);\n\tfor(int i=1; i<=N; i++) nw[i] = make_pair(id[i], w[i]);\n\tsort(nw+1, nw+N+1);\n\tfor(int i=1; i<=N; i++) col[nw[i].second].push_back(nw[i].first);\n\tfor(int i=N; i>=1; i--){//\u6539\u52a8\uff1a \u6362\u6210\u4e86\u500d\u589e\n\t\tint s = p[nw[i].second];\n\t\tvector<int>::iterator it = upper_bound(col[P[s+1]].begin(), col[P[s+1]].end(), i);\n\t\tif(it != col[P[s+1]].end()){\n\t\t\tnxt[i][0][0] = *it;\n\t\t\tfor(int j=1; j<=15; j++) nxt[i][j][0] = nxt[nxt[i][j-1][0]][j-1][0];\n\t\t}\n\t}\n\tfor(int i=1; i<=N; i++){\n\t\tint s = p[nw[i].second];\n\t\tvector<int>::iterator it = upper_bound(col[P[s+1]].begin(), col[P[s+1]].end(), i);\n\t\tif(it != col[P[s+1]].begin()){\n\t\t\tnxt[i][0][1] = *(--it);\n\t\t\tfor(int j=1; j<=15; j++) nxt[i][j][1] = nxt[nxt[i][j-1][1]][j-1][1];\n\t\t}\n\t}\n\tint q = read();\n\twhile(q--){\n\t\tint u = read(), v = read();\n\t\tint LCA = lca(u, v);\n\t\tnum = 0;\n\t\tget_up(u, LCA);\n\t\tget_down(v, LCA);\n\t\tint cnt = 1;\n\t\tfor(int i=1; i<=num; i++){\n\t\t\tif(cnt == M+1) break;\n\t\t\tint l = ask[i].l, r = ask[i].r; bool res = ask[i].res;\n\t\t\tif(res){\n\t\t\t\tvector<int>::iterator it = upper_bound(col[P[cnt]].begin(), col[P[cnt]].end(), r);\n\t\t\t\tif(it == col[P[cnt]].begin()) continue;\n\t\t\t\tint s = *(--it);\n\t\t\t\tif(s < l) continue;\n\t\t\t\tcnt += Find1(s, l) + 1;\n\t\t\t}\n\t\t\telse{\n\t\t\t\tvector<int>::iterator it = lower_bound(col[P[cnt]].begin(), col[P[cnt]].end(), l);\n\t\t\t\tif(it == col[P[cnt]].end()) continue;\n\t\t\t\tint s = *it;\n\t\t\t\tif(s > r) continue;\n\t\t\t\tcnt += Find2(s, r) + 1;\n\t\t\t}\n\t\t}\n\t\tprintf(\"%d\\n\", cnt - 1);\n\t}\n\treturn 0;\n} \n```\n\n## (\u4e09)\u7ed3\u675f\u8bed\n\nGDOI 2021\u5c31\u8fd9\u6837\u8349\u8349\u7ed3\u675f\u4e86\u3002 \u79bb\u522b\u662f\u5982\u6b64\u7a81\u7136\u3002\n\nzhendelan \u53d1\u6325\u8f83\u4e3a\u6b63\u5e38\uff08day1\u6709\u8f83\u5927\u7684\u5931\u8bef\uff09\uff0c \u4f46\u6700\u7ec8\u8fd8\u662f\u4e0e\u7701\u961f\u5931\u4e4b\u4ea4\u81c2\u3002\n\nMCAdam Day1\u6302\u4e86\u5f88\u591a\u5206\uff0c \u4e0e\u9884\u671f\u76f8\u5dee\u8bb8\u591a\u3002\n\n\u603b\u800c\u8a00\u4e4b\uff0c \u5e0c\u671b\u4e24\u4f4d\u5b66\u957f\u80fd\u591f\u5728\u6587\u5316\u8bfe\u4e0a\u62ab\u8346\u65a9\u68d8\uff0c \u5f25\u8865\u672a\u80fd\u8fdb\u961f\u7684\u9057\u61be\u5427\u3002\n\n\u8fd8\u6709\u5b66\u957f lrw04, Conless, \n\n\u6ca1\u6709\u4f60\u4eec\uff0c \u4e5f\u5c31\u6ca1\u6709\u6211\u4e00\u5e74\u6765\u5728 ss \u5b66\u4e60 OI \u7684\u7f8e\u597d\u65f6\u5149\u3002\n\n> \u65e0\u8bba\u63a5\u4e0b\u6765\u662f\u8d70\u662f\u7559\uff0c \n\n> \u65e0\u8bba\u5979\u5e26\u7ed9\u4e86\u6211\u591a\u5c11\u6cea\u6c34\uff0c\n\n> \u6211\u4ece\u672a\u540e\u6094\u3002\n\n--END--\n\n\n[^1]:\u5b9e\u9645\u4e0a\uff0c\u53ef\u4ee5\u901a\u8fc7\u500d\u589e\u8fbe\u5230 $\\Theta(\\log m)$ \u7684\u590d\u6742\u5ea6\uff0c \u540e\u6587\u4f1a\u5177\u4f53\u9610\u8ff0\u3002",
        "postTime": 1618492509,
        "uid": 76228,
        "name": "God\u306efather",
        "ccfLevel": 7,
        "title": "\u9898\u89e3\uff1a[\u7701\u9009\u8054\u8003 2021 A/B \u5377] \u5b9d\u77f3"
    },
    {
        "content": "\u8003\u573a\u4e0a D1T1 \u5199\u6302\u4e86\uff0c\u8fd9\u9898\u53ef\u80fd\u662f\u6211\u8fd9\u6b21\u7701\u9009\u552f\u4e00\u80fd\u8fc7\u7684\u9898\u4e86\u2026\u2026\n\n---\n\n\u8003\u8651\u5c06\u4e00\u4e2a\u8be2\u95ee\u62c6\u6210\u4e24\u90e8\u5206\u5904\u7406\uff1a$s_i$ \u5230 $\\operatorname{lca}$ \u7684\u94fe\uff0c$lca$ \u5230 $t_i$ \u7684\u94fe\u3002\n\n\u524d\u4e00\u90e8\u5206\u663e\u7136\u53ef\u4ee5\u76f4\u63a5\u9884\u5904\u7406\u6bcf\u4e2a\u8282\u70b9\u5411\u4e0a\u6700\u8fd1\u7684 $P_1$ \u79cd\u5b9d\u77f3\u7684\u4f4d\u7f6e\uff0c\u548c\u5230\u6bcf\u4e2a\u8282\u70b9\u540e\u4e0b\u4e00\u4e2a\u5e94\u8be5\u6536\u96c6\u7684\u5b9d\u77f3\u5728\u8fd9\u4e2a\u8282\u70b9\u7956\u5148\u4e2d\u79bb\u4ed6\u6700\u8fd1\u7684\u4f4d\u7f6e\u3002\u7136\u540e\u5c31\u53ef\u4ee5\u76f4\u63a5\u6811\u4e0a\u500d\u589e\u5f97\u5230\u524d\u4e00\u90e8\u5206\u6700\u591a\u80fd\u6536\u96c6\u591a\u5c11\u5b9d\u77f3\u3002\n\n\u540e\u4e00\u90e8\u5206\u5c31\u4f1a\u6709\u70b9\u9ebb\u70e6\uff0c\u56e0\u4e3a\u4ece $\\operatorname{lca}$ \u8df3\u5230 $t_i$ \u662f\u5411\u513f\u5b50\u8df3\u7684\uff0c\u4e0d\u80fd\u7528\u500d\u589e\u5904\u7406\u3002\n\n\u90a3\u4e48\u53ef\u4ee5\u8003\u8651\u4e8c\u5206\u7b54\u6848\uff0c\u7136\u540e\u4ece $t_i$ \u8df3\u5230 $\\operatorname{lca}$\uff0c\u5728 $P$ \u5e8f\u5217\u4e2d\u5012\u5e8f\u5339\u914d\u3002\u8fd9\u6837\u5c31\u8ddf\u4e0a\u4e00\u90e8\u5206\u4e00\u6837\u4e86\u3002\n\n\u4f46\u662f\u6709\u4e2a\u95ee\u9898\uff0c\u5047\u8bbe\u5f53\u524d\u4e8c\u5206\u5230\u7684\u4f4d\u7f6e\u662f $mid$\uff0c\u90a3\u4e48\u6211\u4eec\u9700\u8981\u77e5\u9053 $P_{mid}$ \u8fd9\u4e2a\u5b9d\u77f3\u5728 $t_i$ \u7684\u7956\u5148\u4e2d\u79bb\u4ed6\u6700\u8fd1\u7684\u51fa\u73b0\u7684\u4f4d\u7f6e\u3002\n\n\u8003\u573a\u4e0a\u6211\u60f3\u5230\u7684\u662f\u7528**\u6574\u4f53\u4e8c\u5206**\u6765\u5904\u7406\uff08\u5982\u679c\u4e0d\u60f3\u5199\u6574\u4f53\u4e8c\u5206\u53ef\u4ee5\u770b\u4e0b\u9762\u7684 dfs \u7248\u672c\uff09\uff0c\u56e0\u4e3a\u8fd9\u6837\u7684\u8bdd\u6240\u6709 $mid$ \u76f8\u540c\u7684\u8be2\u95ee\u90fd\u4f1a\u653e\u5230\u4e00\u8d77\u5904\u7406\uff0c\u90a3\u4e48\u5c31\u5f88\u597d\u505a\u4e86\u3002\n\n\u53ef\u4ee5\u627e\u5230\u5f53\u524d\u6240\u6709\u51fa\u552e\u7b2c $P_{mid}$ \u79cd\u5b9d\u77f3\u7684\u8282\u70b9\uff0c\u7136\u540e\u76f8\u5f53\u4e8e\u8981\u5bf9\u6bcf\u4e2a\u8282\u70b9\u7684\u5b50\u6811\u8fdb\u884c\u4e00\u4e2a\u53d6 $\\max$ \u7684\u64cd\u4f5c\uff08\u7ef4\u62a4\u7684\u6700\u8fd1\u8282\u70b9\u7684\u6df1\u5ea6\u548c\u5f53\u524d\u8282\u70b9\u53d6 $\\max$\uff09\n\n\u53ef\u4ee5\u5c06\u8fd9\u4e9b\u8282\u70b9\u6309\u6df1\u5ea6\u5347\u5e8f\u6392\u5e8f\uff0c\u5904\u7406\u51fa dfs \u5e8f\uff0c\u7136\u540e\u5c31\u53d8\u6210\u533a\u95f4\u8986\u76d6\u64cd\u4f5c\uff0c\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811\u76f4\u63a5\u7ef4\u62a4\u3002\u6216\u8005\u548c\u6211\u8003\u573a\u4ee3\u7801\u4e00\u6837\u6309\u964d\u5e8f\u6392\u5e8f\uff0c\u7136\u540e\u53d8\u6210\u533a\u95f4\u5185\u6ca1\u6709\u8986\u76d6\u8fc7\u7684\u5143\u7d20\u8d4b\u503c\uff0c\u7136\u540e\u7528\u5e76\u67e5\u96c6\u7ef4\u62a4\u94fe\u8868\u5b9e\u73b0\u3002\n\n\u56e0\u4e3a\u6bcf\u79cd\u5b9d\u77f3\u53ea\u9700\u8981\u5904\u7406\u4e00\u6b21\uff0c\u6240\u4ee5\u6bcf\u4e2a\u8282\u70b9\u53ea\u4f1a\u505a\u4e00\u6b21\uff0c\u8fd9\u90e8\u5206\u590d\u6742\u5ea6\u662f $\\mathcal O(n\\log n)$ \u7684\u3002\n\n\u8fd9\u6837\u5904\u7406\u51fa\u7b2c\u4e00\u6b21\u8df3\u7684\u8282\u70b9\u540e\u5c31\u53ef\u4ee5\u76f4\u63a5\u500d\u589e check \u4e86\uff01\u7136\u540e\u5c31\u662f\u6574\u4f53\u4e8c\u5206\u7684\u4e8b\u4e86\u3002\n\n\u603b\u590d\u6742\u5ea6 $\\mathcal O(n\\log^2 n)$\uff0c\u74f6\u9888\u5728\u4e8e\u6574\u4f53\u4e8c\u5206\u5185\u7684 sort \u548c\u500d\u589e\uff0c\u5e38\u6570\u5f88\u5c0f\uff0c\u5e94\u8be5\u53ef\u4ee5\u8f7b\u677e\u901a\u8fc7\u3002\n\n------------\n\n\u540e\u6765\u7ecf\u8fc7\u673a\u623f\u91cc\u7684 AK \u7237\u63d0\u9192\uff0c\u53d1\u73b0\u8fd9\u4e2a\u6574\u4f53\u4e8c\u5206\u53ef\u4ee5\u7528 dfs \u4ee3\u66ff\u3002\n\n\u4e5f\u5c31\u662f\u8bf4\u5728 dfs \u65f6\u8bb0\u5f55\u6bcf\u79cd\u5b9d\u77f3\u5728\u5f53\u524d\u70b9\u5230\u6839\u7684\u8def\u5f84\u4e0a\u51fa\u73b0\u7684\u6df1\u5ea6\u6700\u5927\u7684\u4f4d\u7f6e\uff0c\u7136\u540e\u5904\u7406\u6240\u6709\u7ec8\u70b9\u5728\u5f53\u524d\u70b9\u7684\u8be2\u95ee\u3002\n\n\u8fd9\u6837\u53ef\u4ee5\u7701\u53bb\u6574\u4f53\u4e8c\u5206\uff0c\u4ee3\u7801\u611f\u89c9\u4e0a\u5c31\u597d\u5199\u591a\u4e86\u3002\n\n------------\n\n\u6574\u4f53\u4e8c\u5206\u7248\u7684\u4ee3\u7801\uff1a\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nconst int N=2e5+5;\n\nint read()\n{\n\tint s=0;\n\tchar c=getchar(),lc='+';\n\twhile (c<'0'||'9'<c) lc=c,c=getchar();\n\twhile ('0'<=c&&c<='9') s=s*10+c-'0',c=getchar();\n\treturn lc=='-'?-s:s;\n}\nvoid write(int x)\n{\n\tif (x<0)\n\t{\n\t\tputchar('-');\n\t\tx=-x;\n\t}\n\tif (x<10) putchar(x+'0');\n\telse\n\t{\n\t\twrite(x/10);\n\t\tputchar(x%10+'0');\n\t}\n}\nvoid print(int x,char c='\\n')\n{\n\twrite(x);\n\tputchar(c);\n}\nstruct edge\n{\n\tint to,nxt;\n}e[N*2];\nint head[N],cnte=0;\nvoid add_edge(int u,int v)\n{\n\te[++cnte].to=v;\n\te[cnte].nxt=head[u];\n\thead[u]=cnte;\n}\nnamespace LCA\n{\n\tint fa[N],dfn[N],siz[N],son[N],deep[N],top[N],cntdfn=0;\n\tvoid dfs0(int now,int father)\n\t{\n\t\tfa[now]=father;\n\t\tdfn[now]=++cntdfn;\n\t\tsiz[now]=1;\n\t\tson[now]=0;\n\t\tdeep[now]=deep[father]+1;\n\t\tfor (int i=head[now];i;i=e[i].nxt)\n\t\t{\n\t\t\tint to=e[i].to;\n\t\t\tif (to==father) continue;\n\t\t\tdfs0(to,now);\n\t\t\tsiz[now]+=siz[to];\n\t\t\tif (siz[son[now]]<siz[to]) son[now]=to;\n\t\t}\n\t}\n\tvoid dfs1(int now,int father,int Top)\n\t{\n\t\ttop[now]=Top;\n\t\tif (son[now]) dfs1(son[now],now,Top);\n\t\tfor (int i=head[now];i;i=e[i].nxt)\n\t\t{\n\t\t\tint to=e[i].to;\n\t\t\tif (to==father||to==son[now]) continue;\n\t\t\tdfs1(to,now,to);\n\t\t}\n\t}\n\tvoid build()\n\t{\n\t\tdfs0(1,0);\n\t\tdfs1(1,0,1);\n\t}\n\tint find(int x,int y)\n\t{\n\t\twhile (top[x]!=top[y])\n\t\t{\n\t\t\tif (deep[top[x]]<deep[top[y]]) swap(x,y);\n\t\t\tx=fa[top[x]];\n\t\t}\n\t\tif (deep[x]<deep[y]) swap(x,y);\n\t\treturn y;\n\t}\n}\nusing LCA::dfn;\nusing LCA::siz;\nusing LCA::deep;\nstruct Query\n{\n\tint id,x,y,lca,ans0;\n}q[N],tmp[N];\nint Q,np[N],p[N],a[N],ans[N];\nvector<int>v[N];\nbool cmp_deep(int x,int y)\n{\n\treturn deep[x]>deep[y];\n}\nbool cmp_dfn(Query u,Query v)\n{\n\treturn dfn[u.y]<dfn[v.y];\n}\nnamespace A\n{\n\tint up[N],fa[N][20],last[N];\n\tvoid dfs(int now,int father)\n\t{\n\t\tint tmp=last[a[now]];\n\t\tlast[a[now]]=now;\n\t\tup[now]=last[p[1]];\n\t\tfa[now][0]=last[p[np[a[now]]+1]];\n\t\tfor (int i=head[now];i;i=e[i].nxt)\n\t\t{\n\t\t\tint to=e[i].to;\n\t\t\tif (to==father) continue;\n\t\t\tdfs(to,now);\n\t\t}\n\t\tlast[a[now]]=tmp;\n\t}\n\tvoid solve(int n,int m)\n\t{\n\t\tdfs(1,0);\n\t\tfor (int j=1;j<20;j++)\n\t\tfor (int i=1;i<=n;i++) fa[i][j]=fa[fa[i][j-1]][j-1];\n\t\tfor (int i=1;i<=Q;i++)\n\t\t{\n\t\t\tint now=up[q[i].x],u=q[i].lca;\n\t\t\tif (deep[now]<deep[u]) continue;\n\t\t\tfor (int j=19;j>=0;j--)\n\t\t\tif (deep[fa[now][j]]>=deep[u]) now=fa[now][j];\n\t\t\tq[i].ans0=np[a[now]];\n\t\t}\n\t}\n}\nnamespace B\n{\n\tint up[N],fa[N][20],last[N];\n\tvoid dfs(int now,int father)\n\t{\n\t\tint tmp=last[a[now]];\n\t\tlast[a[now]]=now;\n\t\tfa[now][0]=last[p[np[a[now]]-1]];\n\t\tfor (int i=head[now];i;i=e[i].nxt)\n\t\t{\n\t\t\tint to=e[i].to;\n\t\t\tif (to==father) continue;\n\t\t\tdfs(to,now);\n\t\t}\n\t\tlast[a[now]]=tmp;\n\t}\n\tstruct dsu\n\t{\n\t\tint fa[N],deep[N];\n\t\tvoid YSGS(int l,int r)\n\t\t{\n\t\t\tfor (int i=l;i<=r;i++) deep[i]=0;\n\t\t\tfor (int i=l;i<=r;i++) fa[i]=i;\n\t\t}\n\t\tint find(int x)\n\t\t{\n\t\t\treturn x==fa[x]?x:fa[x]=find(fa[x]);\n\t\t}\n\t\tvoid merge(int x,int y)\n\t\t{\n\t\t\tx=find(x),y=find(y);\n\t\t\tif (x==y) return;\n\t\t\tif (deep[x]>deep[y]) swap(x,y);\n\t\t\tfa[x]=y;\n\t\t\tif (deep[x]==deep[y]) deep[y]++;\n\t\t}\n\t}d;\n\tbool used[N];\n\tint tmpdfn[N];\n\tvoid binary_solve(int l,int r,int ql,int qr)//\u6574\u4f53\u4e8c\u5206\n\t{\n\t\tif (ql>qr) return;\n\t\tif (l==r)\n\t\t{\n\t\t\tfor (int i=ql;i<=qr;i++) ans[q[i].id]=l;\n\t\t\treturn;\n\t\t}\n\t\tint mid=(l+r+1)/2;\n\t\tsort(q+ql,q+qr+1,cmp_dfn);\n\t\td.YSGS(ql,qr);\n\t\tfor (int i=ql;i<=qr;i++) used[i]=0;\n\t\tfor (int i=ql;i<=qr;i++) tmpdfn[i]=dfn[q[i].y];\n        //\u5904\u7406\u51faup\uff0cup[i]\u8868\u793a\u7b2ci\u4e2a\u8282\u70b9\u5411\u4e0a\u7b2c\u4e00\u4e2a\u51fa\u552e\u7b2cP[mid]\u79cd\u5b9d\u77f3\u7684\u8282\u70b9\u7684\u4f4d\u7f6e\n\t\tfor (int i=0;i<(int)v[p[mid]].size();i++)\n\t\t{\n\t\t\tint now=v[p[mid]][i];\n\t\t\tint L=lower_bound(tmpdfn+ql,tmpdfn+qr+1,dfn[now])-tmpdfn;\n\t\t\tint R=lower_bound(tmpdfn+ql,tmpdfn+qr+1,dfn[now]+siz[now])-tmpdfn-1;\n\t\t\tint j=L;\n\t\t\tif (used[j]) j=d.find(j)+1;\n\t\t\twhile (j<=R)\n\t\t\t{\n\t\t\t\tup[q[j].y]=now;\n\t\t\t\td.fa[j-1]=d.find(j);\n\t\t\t\tused[j]=1;\n\t\t\t\tj=d.find(j)+1;\n\t\t\t}\n\t\t}\n\t\tfor (int j=ql;j<=qr;j++) if (!used[j]) up[q[j].y]=0;\n\t\tint n1=ql-1,n2=qr+1;\n\t\tfor (int i=ql;i<=qr;i++)\n\t\t{\n\t\t\tint now=up[q[i].y],u=q[i].lca,final=mid+1;\n\t\t\tif (deep[now]>=deep[u])\n\t\t\t{\n\t\t\t\tfor (int j=19;j>=0;j--)\n\t\t\t\tif (deep[fa[now][j]]>=deep[u]) now=fa[now][j];\n\t\t\t\tfinal=np[a[now]];\n\t\t\t}\n\t\t\tif (final<=q[i].ans0+1) tmp[++n1]=q[i];\n\t\t\t\t\t\t\t   else tmp[--n2]=q[i];\n\t\t}\n\t\tfor (int i=ql;i<=qr;i++) q[i]=tmp[i];\n\t\tbinary_solve(l,mid-1,n2,qr);\n\t\tbinary_solve(mid,r,ql,n1);\n\t}\n\tvoid solve(int n,int m)\n\t{\n\t\tdfs(1,0);\n\t\tfor (int j=1;j<20;j++)\n\t\tfor (int i=1;i<=n;i++) fa[i][j]=fa[fa[i][j-1]][j-1];\n\t\tbinary_solve(0,m,1,Q);\n\t}\n}\n\nsigned main()\n{\n\tfreopen(\"gem.in\",\"r\",stdin);\n\tfreopen(\"gem.out\",\"w\",stdout);\n\t\n\tint n=read(),m=read(),c=read();\n\tfor (int i=1;i<=c;i++) np[p[i]=read()]=i;\n\tfor (int i=1;i<=n;i++) a[i]=read();\n\tfor (int i=1;i<n;i++)\n\t{\n\t\tint u=read(),v=read();\n\t\tadd_edge(u,v);\n\t\tadd_edge(v,u);\n\t}\n\tLCA::build();\n\tfor (int i=1;i<=n;i++) v[a[i]].push_back(i);\n\tfor (int i=1;i<=m;i++) sort(v[i].begin(),v[i].end(),cmp_deep);\n\tQ=read();\n\tfor (int i=1;i<=Q;i++)\n\t{\n\t\tq[i].id=i;\n\t\tq[i].ans0=0;\n\t\tq[i].x=read();\n\t\tq[i].y=read();\n\t\tq[i].lca=LCA::find(q[i].x,q[i].y);\n\t}\n\tA::solve(n,c);\n\tB::solve(n,c);\n\tfor (int i=1;i<=Q;i++) print(ans[i]);\n\t\n\treturn 0;\n}\n```",
        "postTime": 1618371227,
        "uid": 61120,
        "name": "QwQcOrZ",
        "ccfLevel": 9,
        "title": "[\u7701\u9009\u8054\u8003 2021 A/B \u5377] \u5b9d\u77f3 \u9898\u89e3"
    },
    {
        "content": "\u8003\u573a\u4e0a\u79bb\u6b63\u89e3\u6700\u8fd1\u7684\u4e00\u9053\u9898 >_<\n\n\n------------\n\u5bf9\u4e8e\u8be2\u95ee $x,y$\uff0c\u8bbe $k=lca(x,y)$\uff0c\u90a3\u4e48 $x$ \u5230 $y$ \u8fd9\u6bb5\u5c31\u53ef\u4ee5\u5206\u6210 $x$ \u5230 $k$\u3001$k$ \u5230 $y$\u3002\u4e5f\u5c31\u662f\u5148\u5411\u4e0a\u8d70\uff08\u7b2c\u4e00\u6bb5\uff09\u518d\u5411\u4e0b\u8d70\uff08\u7b2c\u4e8c\u6bb5\uff09\u3002\u7531\u4e8e\u5411\u4e0b\u8d70\u59cb\u7ec8\u6bd4\u5411\u4e0a\u8d70\u96be\u5904\u7406\uff0c\u6240\u4ee5\u9700\u8981\u5148\u4e8c\u5206\u7b54\u6848\u3002\u8bbe\u7b54\u6848\u4e3a $ans$\uff0c\u90a3\u4e48\u5411\u4e0b\u8d70\u5c31\u53d8\u4e3a\u4e86\u4ece $y$ \u5f00\u59cb\uff0c\u5411\u4e0a\u8d70\u5230\u7b2c\u4e00\u4e2a\u62e5\u6709\u5b9d\u77f3 $P_{ans}$ \u7684\u70b9 $y_1$\uff1b\u518d\u4ece $y_1$ \u5f00\u59cb\uff0c\u5411\u4e0a\u8d70\u5230\u7b2c\u4e00\u4e2a\u62e5\u6709\u5b9d\u77f3 $P_{ans-1}$ \u7684\u70b9 $y_2$ \u2026\u2026\u4ee5\u6b64\u7c7b\u63a8\uff0c\u76f4\u5230\u8d70\u5230 $k$\u3002\u8fd9\u6837\u5c31\u628a\u4e00\u6bb5\u5411\u4e0a\u4e00\u6bb5\u5411\u4e0b\u8f6c\u5316\u6210\u4e86\u4e24\u6bb5\u5411\u4e0a\uff0c\u6545\u6211\u4eec\u53ea\u9700\u8981\u7ef4\u62a4\u5411\u4e0a\u8d70\u7684\u8fc7\u7a0b\u3002\n\n\u6700\u76f4\u63a5\u7684\u60f3\u6cd5\u662f\u5728\u539f\u6811\u4e0a\u4e00\u6b65\u6b65\u5730\u8d70\uff0c\u6bcf\u6b21\u8d70\u5411\u5f53\u524d\u7ed3\u70b9\u7684\u7236\u4eb2\u7136\u540e\u66f4\u65b0\u7b54\u6848\u3002\u8fd9\u6837\u505a\u662f $O(n)$ \u7684\u3002\u80fd\u5426\u66f4\u8fdb\u4e00\u6b65\u5462\uff1f\u4ed4\u7ec6\u89c2\u5bdf\u8fd9\u4e2a\u8fc7\u7a0b\uff0c\u5b83\u7684\u5b9e\u8d28\u662f**\u4ece\u5f53\u524d\u7ed3\u70b9\u5411\u4e0a\u8df3\u5230\u7b2c\u4e00\u4e2a\u62e5\u6709\u67d0\u79cd\u5b9d\u77f3\u7684\u70b9**\uff0c\u7136\u540e\u91cd\u590d\u8fd9\u4e2a\u8fc7\u7a0b\u76f4\u5230\u8df3\u8fc7\u4e86 $k$\u3002\u5f88\u5bb9\u6613\u8054\u60f3\u5230\u5b50\u5e8f\u5217\u81ea\u52a8\u673a\uff0c\u501f\u9274\u4e00\u4e0b\uff0c\u4ee4 $up_{i,j}$ \u8868\u793a $i$ \u53ca $i$ \u7684\u7956\u5148\u4e2d\u79bb $i$ \u6700\u8fd1\u7684\u62e5\u6709\u5b9d\u77f3 $j$ \u7684\u70b9\u662f\u54ea\u4e2a\uff0c\u5148 $O(nm)$ \u5730\u9884\u5904\u7406\u51fa $up$ \u6570\u7ec4\uff0c\u67e5\u8be2\u65f6\u5728 $up$ \u6570\u7ec4\u4e0a\u66b4\u529b\u8df3\uff0c\u603b\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(nm)+O(q\\log(m)m)$\u3002\n\n\u8fd8\u80fd\u4e0d\u80fd\u66f4\u8fdb\u4e00\u6b65\u5462\uff1f\u4ee5\u7b2c\u4e00\u6bb5\u4e3a\u4f8b\uff0c\u5728 $up$ \u6570\u7ec4\u4e0a\u8df3\u7684\u5168\u8fc7\u7a0b\u662f\u8fd9\u6837\u7684\uff1a$x\\rightarrow (x_1=up_{x,P_1})\\rightarrow (x_2=up_{x_1,P_2})\\rightarrow (x_3=up_{x_2,P_3})\\cdots$\u3002\u8bb0\u4e00\u6b65\u8868\u793a\u4ece\u70b9 $x$ \u8df3\u5230 $up_{x,w_x+1}$\uff0c\u8bb0\u5f55\u4ece\u70b9 $x$ \u8df3 $2^0,2^1,2^2,\\cdots$ \u6b65\u4f1a\u8df3\u5230\u54ea\u91cc\u3002\u5982\u679c\u5ffd\u7565\u6700\u5f00\u59cb\u4ece $x$ \u8df3\u5230 $up_{x,1}$\uff0c\u7b2c\u4e00\u6bb5\u5c31\u53ef\u4ee5\u7528\u500d\u589e\u6765\u7ef4\u62a4\u4e86\uff0c\u7b2c\u4e8c\u6bb5\u540c\u7406\u3002\n\n\u4f46\u600e\u4e48\u89e3\u51b3\u6700\u5f00\u59cb\u7684\u90a3\u4e00\u6b65\u5462\uff1f\u6362\u53e5\u8bdd\u8bf4\uff0c\u600e\u4e48\u4f18\u96c5\u5730\u7ef4\u62a4 $up$ \u6570\u7ec4\uff1f\u6ce8\u610f\u5230 $i$ \u6240\u5bf9\u5e94\u7684 $up$ \u6570\u7ec4\u4e0e\u5b83\u7236\u4eb2\u7684 $up$ \u6570\u7ec4\u53ea\u6709\u4e00\u5904\u4e0d\u540c\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u628a\u67e5\u8be2\u64cd\u4f5c\u79bb\u7ebf\u4e0b\u6765\u3002\u5148\u8dd1\u4e00\u904d dfs \u6c42\u51fa\u6bcf\u4e00\u4e2a\u7ed3\u70b9 $i$ \u7684 $up_{i,1}$ \u7684\u503c\u662f\u591a\u5c11\uff0c\u7136\u540e\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u7ed3\u70b9 $i$\uff0c\u8bb0\u5f55\u6240\u6709\u4ee5 $i$ \u4e3a\u7ec8\u70b9\u7684\u67e5\u8be2\u64cd\u4f5c\uff0c\u968f\u540e\u518d\u5728\u6811\u4e0a\u8dd1\u4e00\u904d dfs\uff0c\u8fb9\u56de\u7b54\u8be2\u95ee\u8fb9\u66f4\u65b0\u5f53\u524d\u7ed3\u70b9\u7684 $up$ \u6570\u7ec4\u3002\u603b\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n\\log{n}+q\\log^2{m})$\u3002\n\n\u4ee3\u7801\u5982\u4e0b\uff1a\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<cmath>\n#include<cstring>\n#include<algorithm>\n#include<vector>\n#define fo(i,x,y) for(int i=x;i<=y;++i)\n#define go(i,x,y) for(int i=x;i>=y;--i)\nusing namespace std;\n\ninline int read(){\n\tint x=0,f=1;\n\tchar ch=getchar();\n\twhile(!isdigit(ch)){\n\t\tif(ch=='-') f=-1;\n\t\tch=getchar();\n\t}\n\twhile(isdigit(ch)){\n\t\tx=(x<<1)+(x<<3)+(ch^48);\n\t\tch=getchar();\n\t}\n\treturn x*f;\n}\n\nvoid file(){\n\tfreopen(\"gem.in\",\"r\",stdin);\n\tfreopen(\"gem.out\",\"w\",stdout);\n}\n\nconst int N=2e5+5,M=305;\nstruct Edge{\n\tint to,next;\n}e[N<<1];\nint head[N],tot,w[N],P[N],fa[N][20],dep[N],n,m,c,lgn,lgm,up1[N][20],up2[N][20],U[N],rk[N],up[N];\nint X[N],Y[N],Ans[N];\nvector<int> g[N]; \n//int fl[N],block[205][M],T,top,pos[N];\n//up[i]\u8868\u793ai\u53cai\u7684\u7956\u5148\u4e2d\u79bbi\u6700\u8fd1\u7684\u62e5\u6709\u5b9d\u77f3P[1]\u7684\u70b9\n//up1[i][j]\u8868\u793ai\u53cai\u7684\u7956\u5148\u4e2d\u79bbi\u6700\u8fd1\u7684\u62e5\u6709\u5b9d\u77f3P[rk[w[i]]+(1<<j)]\u7684\u70b9 \n\nvoid connect(int x,int y){\n\te[++tot]=(Edge){y,head[x]};\n\thead[x]=tot; \n}\n\nvoid dfs(int x,int fr){\n\tint t=U[w[x]];\n\tU[w[x]]=x;\n\tfa[x][0]=fr;\n\tdep[x]=dep[fr]+1;\n\tup[x]=U[P[1]];\n\tup1[x][0]=U[P[rk[w[x]]+1]];\n\tup2[x][0]=U[P[rk[w[x]]-1]];\n\tfor(int i=head[x];i;i=e[i].next){\n\t\tint p=e[i].to;\n\t\tif(p==fr) continue;\n\t\tdfs(p,x);\n\t}\n\tU[w[x]]=t;\n}\n\nvoid bz(){\n\tfo(j,1,lgn)\n\t\tfo(i,1,n) fa[i][j]=fa[fa[i][j-1]][j-1];\n\tfo(j,1,lgm)\n\t\tfo(i,1,n) up1[i][j]=up1[up1[i][j-1]][j-1],up2[i][j]=up2[up2[i][j-1]][j-1];\n}\n\nint lca(int x,int y){\n\tif(dep[x]<dep[y]) swap(x,y);\n\tgo(i,lgn,0) if(dep[fa[x][i]]>=dep[y]) x=fa[x][i];\n\tif(x==y) return x;\n\tgo(i,lgn,0) if(fa[x][i]!=fa[y][i]) x=fa[x][i],y=fa[y][i];\n\treturn fa[x][0];\n}\n\nint solve(int x,int y){\n\t//printf(\"solve(%d,%d)\\n\",x,y);\n\tint k=lca(x,y),now=0,_now;\n\tif(dep[up[x]]>=dep[k]){\n\t\tx=up[x];\n\t\tgo(i,lgm,0) if(dep[up1[x][i]]>=dep[k]) x=up1[x][i];\n\t\tnow=rk[w[x]];\n\t}\n\t//printf(\"x=%d now=%d\\n\",x,now);\n\tint L=now+1,R=m,mid,ans=now;\n\twhile(L<=R){\n\t\tmid=(L+R)>>1;\n\t\t_now=mid+1;\n\t\tif(dep[U[P[mid]]]>dep[k]){\n\t\t\ty=U[P[mid]];\n\t\t\tgo(i,lgm,0) if(dep[up2[y][i]]>dep[k]) y=up2[y][i];\n\t\t\t_now=rk[w[y]];\n\t\t}\n\t\t//printf(\"y=%d _now=%d mid=%d\\n\",y,_now,mid);\n\t\tif(_now-now<=1) L=mid+1,ans=mid;\n\t\telse R=mid-1;\n\t}\n\t//printf(\"ans=%d\\n\",ans);\n\treturn ans;\n}\n\nvoid _dfs(int x,int fr){\n\tint t=U[w[x]];\n\tU[w[x]]=x;\n\tint si=g[x].size();\n\tfo(i,0,si-1) Ans[g[x][i]]=solve(X[g[x][i]],Y[g[x][i]]);\n\tfor(int i=head[x];i;i=e[i].next){\n\t\tint p=e[i].to;\n\t\tif(p==fr) continue;\n\t\t_dfs(p,x);\n\t}\n\tU[w[x]]=t;\n}\n\nint main(){\n\t//file();\n\tcin>>n>>m>>c;lgn=log(n)/log(2);lgm=log(m)/log(2);\n\tfo(i,1,c) P[i]=read(),rk[P[i]]=i;\n\tfo(i,1,n) w[i]=read();\n\tfo(i,1,n-1){\n\t\tint x=read(),y=read();\n\t\tconnect(x,y);\n\t\tconnect(y,x);\n\t}\n\tdfs(1,0);\n\tbz();\n\t/*fo(i,1,n){\n\t\tprintf(\"%d,%d:\\n\",i,up[i]);\n\t\tfo(j,0,lgm) printf(\"%d \",up1[i][j]);puts(\"\");\n\t\tfo(j,0,lgm) printf(\"%d \",up2[i][j]);puts(\"\");\n\t}*/\n\tint q=read();\n\tfo(i,1,q){\n\t\tX[i]=read(),Y[i]=read();\n\t\tg[Y[i]].push_back(i); \n\t}\n\t_dfs(1,0);\n\tfo(i,1,q) printf(\"%d\\n\",Ans[i]);\n\treturn 0;\n}\n/*\n7 3 3\n2 3 1\n2 1 3 3 2 1 3\n1 2\n2 3\n1 4\n4 5\n4 6\n6 7\n5\n3 5\n1 3\n7 3\n5 7\n7 5\n--------------------------------\n2\n2\n2\n3\n1\n*/\n```\n",
        "postTime": 1618364659,
        "uid": 238408,
        "name": "vectorwyx",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P7518 [\u7701\u9009\u8054\u8003 2021 A/B \u5377] \u5b9d\u77f3"
    },
    {
        "content": "[\u6b22\u8fce\u6765\u535a\u5ba2\u56ed\u67e5\u770b](https://www.cnblogs.com/juruo-pigstd/p/14668348.html)\u3002\n\n\u4e0b\u6587\u4e2d\u4ee4 $n,m,q,c$ \u540c\u9636\u3002\n\n\u9996\u5148\u4ee4 $t_{p_i}=i,a_i=t_{a_i}$\uff0c\u90a3\u4e48\u5c31\u76f8\u5f53\u4e8e\u627e\u4e00\u4e2a $1-ans$ \u7684\u5b50\u5e8f\u5217\u3002\n\n\u9996\u5148\u8003\u8651\u4e00\u4e2a\u94fe\u4e0a\u7684\u60c5\u51b5\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u8be2\u95ee $(u,v)$\uff0c\u4e0d\u59a8\u4ee4 $u \\le v$\uff0c\u90a3\u4e48\u663e\u7136\u5bf9\u4e8e\u6bcf\u4e2a\u70b9 $i$\uff0c\u5b83\u9700\u8981\u8df3\u5230\u5b83\u4e4b\u540e\u7684\u7b2c\u4e00\u4e2a $j$ \u6ee1\u8db3 $a_j=a_i+1$\uff0c\u8fd9\u90e8\u5206\u53ef\u4ee5\u7528\u6876\u89e3\u51b3\uff0c\u7136\u540e\u7528\u500d\u589e $f1_{i,j}$ \u8868\u793a\u70b9 $i$ \u8df3 $2^j$ \u6b21\u4e4b\u540e\u7684\u7ed3\u679c\u3002\u5bf9\u4e8e\u6bcf\u6b21\u8be2\u95ee $(u,v)$\uff0c\u627e\u5230 $u$ \u4e4b\u540e\u7b2c\u4e00\u4e2a\u4e3a $1$ \u7684\u8282\u70b9\u7136\u540e\u4ece\u8fd9\u4e2a\u70b9\u5f00\u59cb\u8df3\uff0c\u5c31\u53ef\u4ee5\u5728 $O(n\\log n)$ \u7684\u65f6\u95f4\u590d\u6742\u5ea6\u5185\u6c42\u51fa\u7b54\u6848\u3002\n\n\u8003\u8651\u4e0a\u6811\u3002\u5bf9\u4e8e\u4e00\u4e2a\u8be2\u95ee $(u,v)$\uff0c\u53ef\u4ee5\u5c06\u5176\u62c6\u6210 $u \\to lca$ \u7684\u4e0a\u884c\u8def\u5f84\u548c $lca \\to v$ \u7684\u4e0b\u884c\u8def\u5f84\u3002\u4e0a\u884c\u8def\u5f84\u76f4\u63a5\u53ef\u4ee5\u901a\u8fc7\u4e0a\u8ff0\u7684\u65b9\u6cd5\u89e3\u51b3\uff0c\u8bb0\u6b64\u65f6\u7684\u7b54\u6848\u662f $ans$\uff0c\u7136\u800c\u4e0b\u884c\u8def\u5f84\u5462\uff1f\u76f4\u63a5\u8003\u8651 $lca \\to v$ \u662f\u6bd4\u8f83\u56f0\u96be\u7684\uff0c\u8003\u8651\u4e8c\u5206\u7b54\u6848\u3002\n\n\u4e0d\u96be\u53d1\u73b0\uff0c\u6bcf\u6b21 $lca \\to v$ \u9700\u8981\u8ba9\u5f53\u524d\u7b54\u6848\u9012\u589e\uff0c\u90a3\u4e48\u53cd\u7740\u8003\u8651\uff0c\u7b49\u4ef7\u4e8e $v \\to lca$ \u8ba9\u5f53\u524d\u7b54\u6848\u9012\u51cf\uff0c\u7c7b\u4f3c\u7684\uff0c\u8bbe\u4e00\u4e2a $f2_{i,j}$ \u4e3a\u70b9 $i$ \u8df3 $2^j$ \u6b21\u7684\u7ed3\u679c\uff0c\u6bcf\u6b21\u8df3\u5230\u5b83\u7956\u5148\u4e2d\u7684\u6700\u6df1\u7684 $j$ \u6ee1\u8db3 $a_j = a_i-1$\uff0c\u7136\u540e\u5bf9\u4e8e\u6bcf\u4e00\u4e2a $mid$\uff0c`check` \u7684\u8fc7\u7a0b\u5c31\u662f\u8ba9\u5b83\u5f80\u524d\u8df3\u7136\u540e\u770b\u80fd\u5426\u8df3\u5230 $ans+1$ \u8fd9\u4e2a\u8282\u70b9\uff0c\u8fd9\u6837\u5c31\u5b8c\u6210\u4e86\u2026\u2026\u5417\uff1f\n\n\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\uff1a\u5bf9\u4e8e\u6bcf\u4e2a $mid$\uff0c\u4f60\u8981\u5728 $u$ \u7684\u7956\u5148\u4e2d\u627e\u5230\u7b2c\u4e00\u4e2a $a_i=mid$ \u7684\u70b9 $i$\uff0c\u7136\u540e\u8fd9\u6837\u5b50\u65f6\u95f4\u590d\u6742\u5ea6\u5c31\u7206\u70b8\u4e86\u2026\u2026\n\n\u8003\u8bd5\u7684\u65f6\u5019\u6211\u60f3\u5230\u8fd9\u91cc\u5c31\u4e0d\u4f1a\u4e86\uff0c\u6700\u7ec8\u53ea\u6253\u4e86\u66b4\u529b+\u94fe\u7684\u5206\u3002\u5b9e\u9645\u4e0a\u6709\u4e2a\u975e\u5e38\u7b80\u5355\u7684\u65b9\u6cd5\uff0c\u628a\u6240\u6709\u8be2\u95ee\u79bb\u7ebf\u4e0b\u6765\u7136\u540e\u518d `dfs` \u7684\u8fc7\u7a0b\u4e2d\uff0c\u7528\u4e00\u4e2a\u6876 $t$\uff0c$t_i$ \u8868\u793a\u5f53\u65f6\u7684\u8282\u70b9\u7956\u5148\u4e2d\u7b2c\u4e00\u4e2a $a_j=i$ \u7684 $j$\uff0c\u4e00\u8fb9 dfs \u4e00\u8fb9\u8be2\u95ee\uff0c\u5c31\u53ef\u4ee5\u505a\u5230 $O(n \\log^2 n)$ \u7684\u65f6\u95f4\u590d\u6742\u5ea6\u3002\n\n\u4ee3\u7801\u4e5f\u86ee\u597d\u5199\u7684\uff0c\u8fd9\u79cd\u65b9\u6cd5\u53ef\u80fd\u662f\u6700\u597d\u5199\u7684\uff08\u76f8\u6bd4\u4e8e\u6811\u5256\u548c\u70b9\u5206\u6cbb\uff09\uff0c\u800c\u4e14\u8dd1\u7684\u4e5f\u86ee\u5feb\uff0c\u53ef\u60dc\u8003\u8bd5\u7684\u65f6\u5019\u5dee\u4e86\u6700\u540e\u4e00\u6b65\u2026\u2026\n\n\n```cpp\n#include<bits/stdc++.h>\n#define int long long\n#define pb push_back\n#define mp make_pair\n#define x first\n#define y second\nusing namespace std;\n\ninline int read()\n{\n    char c=getchar();int x=0;bool f=0;\n    for(;!isdigit(c);c=getchar())f^=!(c^45);\n    for(;isdigit(c);c=getchar())x=(x<<1)+(x<<3)+(c^48);\n    if(f)x=-x;return x;\n}\n\nconst int M=2e5+10;\nint n,m,c,a[M],p1[M],pos1[M],pos2[M],pos3[M],ans[M],q;\nint de[M],ff[M][25],f1[M][25],f2[M][25];\nvector<int>e[M];vector<pair<int,int> >qt[M];\n\nvoid dp()\n{\n\tfor (int j=1;j<=20;j++)\n\t\tfor (int i=1;i<=n;i++)\n\t\t\tff[i][j]=ff[ff[i][j-1]][j-1],\n\t\t\tf1[i][j]=f1[f1[i][j-1]][j-1],\n\t\t\tf2[i][j]=f2[f2[i][j-1]][j-1];\n}\nint LCA(int x,int y)\n{\n\tif (de[x]<de[y])swap(x,y);\n\tfor (int i=20;i>=0;i--)\n\t\tif (de[ff[x][i]]>=de[y])x=ff[x][i];\n\tif (x==y)return x;\n\tfor (int i=20;i>=0;i--)\n\t\tif (ff[x][i]!=ff[y][i])\n\t\t\tx=ff[x][i],y=ff[y][i];\n\treturn ff[x][0];\n}\nvoid dfs1(int u,int fa)\n{\n\tif (a[u]==1)pos1[u]=u;else pos1[u]=pos1[fa];\n\tint x1=pos2[a[u]],x2=pos3[a[u]];\n\tpos2[a[u]]=u,pos3[a[u]]=u;\n\tf1[u][0]=pos2[a[u]+1],f2[u][0]=pos3[a[u]-1];\n\tde[u]=de[fa]+1,ff[u][0]=fa;\n\tfor (int i=0;i<e[u].size();i++)\n\t{\n\t\tint to=e[u][i];if (to==fa)continue;\n\t\tdfs1(to,u);\n\t}\n\tpos2[a[u]]=x1,pos3[a[u]]=x2;\n}\nbool check(int x,int lca,int v,int pg)\n{\n\tv=pos2[x];if (de[v]<de[lca])return 0;\n\tint now=x;\n\tfor (int i=20;i>=0;i--)\n\t\tif (de[f2[v][i]]>=de[lca])\n\t\t\tnow-=1<<i,v=f2[v][i];\n\treturn now<=pg;\n}\nvoid dfs2(int u,int fa)\n{\n\tint x=pos2[a[u]];pos2[a[u]]=u;\n\tfor (int i=0;i<qt[u].size();i++)\n\t{\n\t\tint id=qt[u][i].x,s=qt[u][i].y;\n\t\tint anss=0,lca=LCA(s,u);\n\t\ts=pos1[s];if (de[s]>=de[lca])\n\t\t{\n\t\t\tfor (int i=20;i>=0;i--)\n\t\t\t\tif (de[f1[s][i]]>=de[lca])\n\t\t\t\t\ts=f1[s][i];\n\t\t\tanss=a[s];\n\t\t}//cout<<anss<<endl;\n\t\tint tl=anss+1,tr=c,p=anss;\n\t\twhile(tl<=tr)\n\t\t{\n\t\t\tint Mid=(tl+tr)>>1;\n\t\t\tif (check(Mid,lca,u,anss+1))\n\t\t\t\ttl=Mid+1,p=Mid;\n\t\t\telse tr=Mid-1;\n\t\t}\n\t\tans[id]=p;\n\t}\n\tfor (int i=0;i<e[u].size();i++)\n\t\tif (e[u][i]!=fa)dfs2(e[u][i],u);\n\tpos2[a[u]]=x;\n}\n\nsigned main()\n{\n\tn=read(),m=read(),c=read();\n\tfor (int i=1;i<=c;i++)p1[read()]=i;\n\tfor (int i=1;i<=n;i++)a[i]=p1[read()];\n\tfor (int i=1;i<n;i++)\n\t{\n\t\tint u=read(),v=read();\n\t\te[u].pb(v),e[v].pb(u);\n\t}\n\tdfs1(1,0),dp();\n\tq=read();\n\tfor (int i=1;i<=q;i++)\n\t{\n\t\tint u=read(),v=read();\n\t\tqt[v].pb(mp(i,u));\n\t}dfs2(1,0);\n\tfor (int i=1;i<=q;i++)\n\t\tcout<<ans[i]<<endl;\n\treturn 0;\n}\n```",
        "postTime": 1618569467,
        "uid": 141179,
        "name": "pigstd",
        "ccfLevel": 9,
        "title": "[\u7701\u9009\u8054\u8003 2021 A/B \u5377] \u5b9d\u77f3\u9898\u89e3"
    },
    {
        "content": "\u6211\u4e0d\u4f1a\u70b9\u5206\u6cbb\uff0c\u60f3\u4e0d\u51fa\u4e3b\u5e2d\u6811\u7684\u505a\u6cd5\uff0c\u8d5b\u573a\u679c\u65ad\u6811\u5256+\u500d\u589e\u3002\n\n\u770b\u5230\u94fe\u7684\u90e8\u5206\u5206\u5df2\u7ecf\u5f88\u660e\u786e\u4e86\uff0c\u5c31\u662f\u5728\u94fe\u7684\u57fa\u7840\u4e0a\u591a\u7528\u4e00\u4e2a\u6811\u5256\u591a\u4e2a log \u5c31\u884c\u3002\n\n\u9884\u5904\u7406\u90e8\u5206\uff1a\n\n\u5b9a\u4e49\u989c\u8272 $a$ \u80fd\u63a5\u4e0a\u989c\u8272 $b$\uff1a\u5b58\u5728 $1<x<c$\uff0c\u4f7f\u5f97 $p_x=a,p_{x+1}=b$\u3002\n\n\u5206\u522b\u8bb0\u5f55 $pref_a$ \u8868\u793a\u4e00\u4e2a\u8282\u70b9\u5728\u6811\u5256\u7684 dfs \u5e8f\u4e4b\u524d\uff08\u4ece\u540e\u5f80\u524d\u6811\uff09\u7b2c\u4e00\u4e2a $a$ \u80fd\u63a5\u4e0a\u7684\u8282\u70b9\u7684 dfs \u5e8f\u503c\u3002$nxtf$ \u540c\u7406\u3002\u7136\u540e\u5904\u7406\u500d\u589e\u6570\u7ec4\uff0c$pf_{i,j}=pf_{pf_{i,j-1},j-1}$\uff0c$nf$ \u540c\u7406\u3002\u590d\u6742\u5ea6\u662f $nlogn$\u3002\n\n\u67e5\u8be2\u90e8\u5206\uff1a\n\n\u628a\u4e00\u4e2a\u8def\u5f84\u770b\u6210\u5411\u4e0a\u722c\u548c\u5411\u4e0b\u8dd1\u4e24\u4e2a\u90e8\u5206\uff0c\u5206\u522b\u62c6\u6210\u82e5\u5e72\u6bb5\u91cd\u94fe\u3002\u5bf9\u4e8e\u5411\u4e0a\u7684\u6bcf\u4e00\u6bb5\uff0c\u4e8c\u5206\u6c42\u51fa\u7b2c\u4e00\u4e2a\u73b0\u5728\u7684\u989c\u8272\u80fd\u63a5\u4e0a\u7684\u8282\u70b9\uff0c\u7136\u540e\u500d\u589e\u5f97\u5230\u8fd9\u6bb5\u91cd\u94fe\u7684\u6700\u540e\u8fde\u7740\u63a5\u4e0a\u7684\u989c\u8272\uff0c\u5411\u4e0b\u8dd1\u628a $pf$ \u6362\u6210 $nf$ \u4e4b\u540e\u4e5f\u5dee\u4e0d\u591a\uff0c\u7528 $Qlog^2n$ \u7684\u901f\u5ea6\u89e3\u51b3\u3002\n\n\u4ee3\u7801\uff1a\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nint w[200005],p[200005],nxt[200005],dep[200005],fa[200005],ffa[200005],sz[200005],bg[200005],gb[200005],tot=0;\nint nxtf[21][200005],pref[21][200005],q1[200005],q2[200005],bzf[21][200005];\nvector<int>g[200005],d[200005];\nvoid dfs1(int x,int la)\n{\n\tsz[x]=1;\n\tfor(int i=0;i<g[x].size();i++)\n\t{\n\t\tint cu=g[x][i];\n\t\tif(cu==la)continue;\n\t\tdep[cu]=dep[x]+1,fa[cu]=bzf[0][cu]=x;\n\t\tdfs1(cu,x);\n\t\tsz[x]+=sz[cu];\n\t}\n}\nvoid dfs2(int x,int la)\n{\n\tbg[x]=++tot,gb[bg[x]]=x;\n\tif(sz[x]==1)return;\n\tint ans=0,w;\n\tfor(int i=0;i<g[x].size();i++)\n\t{\n\t\tint cu=g[x][i];\n\t\tif(cu==la)continue;\n\t\tif(ans<sz[cu])ans=sz[cu],w=cu;\n\t}\n\tffa[w]=ffa[x],dfs2(w,x);\n\tfor(int i=0;i<g[x].size();i++)\n\t{\n\t\tint cu=g[x][i];\n\t\tif(cu==la||cu==w)continue;\n\t\tffa[cu]=cu,dfs2(cu,x);\n\t}\n}\nint lca(int x,int y)\n{\n\tif(dep[x]<dep[y])swap(x,y);\n\tfor(int i=20;i>=0;i--)if(dep[x]-dep[y]>=(1<<i))x=bzf[i][x];\n\tif(x==y)return x;\n\tfor(int i=20;i>=0;i--)if(bzf[i][x]!=bzf[i][y])x=bzf[i][x],y=bzf[i][y];\n\treturn fa[x];\n}\ninline int read()\n{\n\tchar c=getchar();\n\twhile(c<'0'||c>'9')c=getchar();\n\tint ff=0;\n\twhile(c>='0'&&c<='9')ff=ff*10+(c-'0'),c=getchar();\n\treturn ff;\n}\nint main()\n{\n\tint n=read(),m=read(),c=read();\n\tfor(int i=1;i<=c;i++)p[i]=read();\n\tfor(int i=2;i<=c;i++)nxt[p[i-1]]=p[i];\n\tfor(int i=1;i<=n;i++)w[i]=read();\n\tfor(int i=1;i<n;i++)\n\t{\n\t\tint u=read(),v=read();\n\t\tg[u].push_back(v);\n\t\tg[v].push_back(u);\n\t}\n\tdep[1]=1,dfs1(1,0);\n\tffa[1]=1,dfs2(1,0);\n\tfor(int i=1;i<=n;i++)d[w[gb[i]]].push_back(i);\n\tfor(int i=1;i<=n;i++)\n\t{\n\t\tint gg=nxt[w[gb[i]]],ww;\n\t\tif(!gg)continue;\n\t\tww=lower_bound(d[gg].begin(),d[gg].end(),i)-d[gg].begin();\n\t\tif(ww!=0)pref[0][i]=d[gg][ww-1];\n\t\tif(ww!=d[gg].size())nxtf[0][i]=d[gg][ww];\n\t}\n\tfor(int j=1;j<=20;j++)for(int i=1;i<=n;i++)\n\t{\n\t\tnxtf[j][i]=nxtf[j-1][nxtf[j-1][i]];\n\t\tpref[j][i]=pref[j-1][pref[j-1][i]];\n\t\tbzf[j][i]=bzf[j-1][bzf[j-1][i]];\n\t}\n\tint q=read();\n\twhile(q--)\n\t{\n\t\tint s=read(),t=read();\n\t\tint lc=lca(s,t),gd=0,flag=0;\n\t\twhile(dep[s]>=dep[lc])\n\t\t{\n\t\t\tif(gd==c||!(d[p[gd+1]].size()))\n\t\t\t{\n\t\t\t\tprintf(\"%d\\n\",gd);\n\t\t\t\tflag=1;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tint tttt=upper_bound(d[p[gd+1]].begin(),d[p[gd+1]].end(),bg[s])-d[p[gd+1]].begin()-1,fff=ffa[s];\n\t\t\tif(ffa[s]==ffa[lc])fff=lc;\n\t\t\tif(tttt==-1||d[p[gd+1]][tttt]<bg[fff])\n\t\t\t{\n\t\t\t\ts=fa[ffa[s]];\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tint wz=d[p[gd+1]][tttt];\n\t\t\tgd++;\n\t\t\tfor(int i=20;i>=0;i--)if(pref[i][wz]>=bg[fff])gd+=1<<i,wz=pref[i][wz];\n\t\t\ts=fa[ffa[s]];\n\t\t}\n\t\tif(flag)continue;\n\t\tint ott=0;\n\t\twhile(ffa[t]!=ffa[lc])\n\t\t{\n\t\t\tott++;\n\t\t\tq1[ott]=bg[ffa[t]],q2[ott]=bg[t];\n\t\t\tt=fa[ffa[t]];\n\t\t}\n\t\tif(t!=lc)\n\t\t{\n\t\t\tint tt=t;\n\t\t\tfor(int i=20;i>=0;i--)if(dep[tt]-dep[lc]>(1<<i))tt=bzf[i][tt];\n\t\t\tott++;\n\t\t\tq1[ott]=bg[tt],q2[ott]=bg[t];\n\t\t}\n\t\tfor(int i=ott;i>=1;i--)\n\t\t{\n\t\t\tif(gd==c||!(d[p[gd+1]].size()))\n\t\t\t{\n\t\t\t\tprintf(\"%d\\n\",gd);\n\t\t\t\tflag=1;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tint tttt=lower_bound(d[p[gd+1]].begin(),d[p[gd+1]].end(),q1[i])-d[p[gd+1]].begin();\n\t\t\tif(tttt==d[p[gd+1]].size()||d[p[gd+1]][tttt]>q2[i])continue;\n\t\t\tint wz=d[p[gd+1]][tttt];\n\t\t\tgd++;\n\t\t\tfor(int j=20;j>=0;j--)if(nxtf[j][wz]>0&&nxtf[j][wz]<=q2[i])gd+=1<<j,wz=nxtf[j][wz];\n\t\t}\n\t\tif(flag)continue;\n\t\tprintf(\"%d\\n\",gd);\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1618296485,
        "uid": 107484,
        "name": "wmy_goes_to_thu",
        "ccfLevel": 8,
        "title": "P7518 \u9898\u89e3"
    },
    {
        "content": "## \u524d\u8a00\n\u8003\u573a\u4e0a\u62ff\u5230\u9898\u89c9\u5f97\u5f88\u53ef\u505a\u3002\n\n\u540e\u6765\u6539\u7740\u6539\u7740\u5c31\u4e0d\u4f1a\u505a\u4e86\u3002\n\n\u56de\u6765\u665a\u81ea\u4e60\u4e00\u6fc0\u7075\u4f1a\u505a\u4e86\u3002\n\n## \u63cf\u8ff0\n\u7a0d\u52a0\u8f6c\u5316\uff0c\u53ef\u53d8\u4e3a\u6c42\u6811\u4e0a $u,v$ \u95f4\u8def\u5f84\u4e0a\u6700\u957f\u4ece $1$ \u5f00\u59cb\u516c\u5dee\u4e3a $1$ \u7684\u5b50\u7b49\u5dee\u5e8f\u5217\u957f\u5ea6\u3002\n\n## \u5206\u6790\n\u5957\u8def\u5730\u5c06\u8be2\u95ee\u79bb\u7ebf\u5230\u4e24\u7aef\u70b9\uff0c\u62c6\u6210\u4e0a\u884c\u4e0e\u4e0b\u884c\u4e24\u6761\u8def\u5f84\u3002\n\n\u4e0a\u884c\u662f\u6c42\u4ece $u$ \u5f00\u59cb\u5230 $u,v$ \u7684 LCA \u7684\u8def\u5f84\u4e0a\u7684\u6700\u957f\u5b50\u5e8f\u5217\u957f\u5ea6\uff1b\u4e0b\u884c\u65f6\u6c42\u4ece LCA \u5f00\u59cb\u5230 $v$ \u7684\u8def\u5f84\u4e0a\u4ece\u4e0a\u884c\u6240\u5f97\u7b54\u6848\u5f00\u59cb\u7684\u516c\u5dee\u4e3a $1$ \u7684\u6700\u957f\u5b50\u5e8f\u5217\u957f\u5ea6\u3002\n\n\u5bb9\u6613\u53d1\u73b0\uff0c\u4e0a\u884c\u53ea\u9700\u8981\u8bb0\u5f55\u6bcf\u4e2a\u7ed3\u70b9\u7956\u5148\u4e2d\u6700\u8fd1\u7684\u540e\u7ee7\uff0c\u5bf9\u6bcf\u4e2a\u8be2\u95ee\u4ece\u79bb\u5f53\u524d $u$ \u6700\u8fd1\u7684 $1$ \u5f00\u59cb\u901a\u8fc7\u8be5\u8bb0\u5f55\u500d\u589e\u5373\u53ef\u3002\n\n\u8003\u8651\u4e0b\u884c\u3002\u6734\u7d20\u7684\u60f3\u6cd5\u662f\u8bb0\u5f55\u6bcf\u4e2a\u7ed3\u70b9\u7956\u5148\u4e2d\u6700\u8fd1\u7684\u524d\u9a71\uff0c\u5bf9 LCA \u548c $v$ \u4e2d\u6bcf\u4e2a\u7ed3\u70b9\u90fd\u901a\u8fc7\u8be5\u8bb0\u5f55\u5411\u4e0a\u500d\u589e\uff0c\u68c0\u9a8c\u500d\u589e\u5230\u4e0a\u884c\u7b54\u6848\u65f6\u6df1\u5ea6\u662f\u5426\u5927\u4e8e LCA \u6df1\u5ea6\uff0c\u82e5\u5927\u4e8e\u5219\u4e3a\u4e00\u7ec4\u53ef\u884c\u89e3\u3002 \n\n\u8003\u573a\u601d\u8003\u8fdb\u884c\u5230\u8fd9\u4e00\u5730\u6b65\u3002\n\n\u540e\u6765\u56de\u5b66\u6821\u665a\u81ea\u4e60\u7075\u5149\u4e00\u73b0\uff0c\u53d1\u73b0\u5355\u8c03\u6027\uff0c\u5373\u53ef\u4ee5\u4e8c\u5206\u4e0b\u884c\u500d\u589e\u8d77\u70b9\u7684\u503c\u3002\u4e8e\u662f\u5c31\u505a\u5b8c\u4e86\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $\\operatorname{O}(n\\log^2 n)$\n\n## \u4ee3\u7801\n\u6c11\u95f4\u6570\u636e\u81ea\u6d4b\u901a\u8fc7\u3002\n\n```cpp\n#include<cctype>\n#include<cstdio>\n#include<vector>\nusing namespace std;\nconst int maxn=2e5,maxlog=18;\nint n,m,c,u,v,tot,q,lastpos[maxn+1],p[maxn+1],no[maxn+1],w[maxn+1],head[maxn+1],suc[maxn<<1|1],to[maxn<<1|1],pos[maxn+1],depth[maxn+1],res[maxn+1],parent[maxn+1][maxlog+1],upsuc[maxn+1][maxlog+1];\nvector<int> up[maxn+1],down[maxn+1];\ninline void read(int &x)\n{\n\tx=0;\n\tchar t=getchar();\n\twhile(!isdigit(t))\n\t\tt=getchar();\n\twhile(isdigit(t))\n\t{\n\t\tx=x*10+t-'0';\n\t\tt=getchar();\n\t}\n\treturn;\n}\ninline void add_edge(int x,int y)\n{\n\tsuc[++tot]=head[x];\n\thead[x]=tot;\n\tto[tot]=y;\n\treturn;\n}\nvoid dfs1(int now)\n{\n\tdepth[now]=depth[parent[now][0]]+1;\n\tfor(int i=head[now];i;i=suc[i])\n\t\tif(to[i]!=parent[now][0])\n\t\t{\n\t\t\tparent[to[i]][0]=now;\n\t\t\tfor(int j=1;j<=maxlog;++j)\n\t\t\t\tparent[to[i]][j]=parent[parent[to[i]][j-1]][j-1];\n\t\t\tdfs1(to[i]);\n\t\t}\n\treturn;\n}\nint LCA(int x,int y)\n{\n\tif(depth[x]<depth[y])\n\t\tx^=y^=x^=y;\n\tfor(int i=maxlog;~i;--i)\n\t\tif(depth[parent[x][i]]>=depth[y])\n\t\t\tx=parent[x][i];\n\tif(x==y)\n\t\treturn x;\n\tfor(int i=maxlog;~i;--i)\n\t\tif(parent[x][i]!=parent[y][i])\n\t\t{\n\t\t\tx=parent[x][i];\n\t\t\ty=parent[y][i];\n\t\t}\n\treturn parent[x][0];\n}\nvoid dfs2(int now)\n{\n\tint t=lastpos[w[now]];\n\tlastpos[w[now]]=depth[now];\n\tupsuc[depth[now]][0]=lastpos[w[now]+1];\n\tfor(int i=1;i<=maxlog;++i)\n\t\tupsuc[depth[now]][i]=upsuc[upsuc[depth[now]][i-1]][i-1];\n\tfor(int i=0;i<up[now].size();++i)\n\t{\n\t\tint thistime=lastpos[1];\n\t\tif(thistime<depth[pos[up[now][i]]])\n\t\t\tcontinue;\n\t\t++res[up[now][i]];\n\t\tfor(int j=maxlog;~j;--j)\n\t\t\tif(upsuc[thistime][j]>=depth[pos[up[now][i]]])\n\t\t\t{\n\t\t\t\tres[up[now][i]]+=(1<<j);\n\t\t\t\tthistime=upsuc[thistime][j];\n\t\t\t}\t\n\t}\n\tfor(int i=head[now];i;i=suc[i])\n\t\tif(to[i]!=parent[now][0])\n\t\t\tdfs2(to[i]);\n\tlastpos[w[now]]=t;\n\treturn;\n}\nvoid dfs3(int now)\n{\n\tint t=lastpos[w[now]];\n\tlastpos[w[now]]=depth[now];\n\tupsuc[depth[now]][0]=lastpos[w[now]-1];\n\tfor(int i=1;i<=maxlog;++i)\n\t\tupsuc[depth[now]][i]=upsuc[upsuc[depth[now]][i-1]][i-1];\n\tfor(int i=0;i<down[now].size();++i)\n\t{\n\t\tint l=res[down[now][i]]+1,r=c,tres=l-1;\n\t\twhile(l<=r)\n\t\t{\n\t\t\tint mid=(l+r)>>1,thistime=lastpos[mid],cnt=mid-res[down[now][i]]-1;\n\t\t\tfor(int k=maxlog;~k;--k)\n\t\t\t\tif((1<<k)&cnt)\n\t\t\t\t\tthistime=upsuc[thistime][k];\n\t\t\tif(thistime>depth[pos[down[now][i]]])\n\t\t\t{\n\t\t\t\ttres=mid;\n\t\t\t\tl=mid+1;\n\t\t\t}\n\t\t\telse r=mid-1;\n\t\t}\n\t\tres[down[now][i]]=tres;\n\t}\n\tfor(int i=head[now];i;i=suc[i])\n\t\tif(to[i]!=parent[now][0])\n\t\t\tdfs3(to[i]);\n\tlastpos[w[now]]=t;\n\treturn;\n}\nint main()\n{\n\tread(n);\n\tread(m);\n\tread(c);\n\tfor(int i=1;i<=c;++i)\n\t{\n\t\tread(p[i]);\n\t\tno[p[i]]=i;\n\t}\n\tfor(int i=1;i<=n;++i)\n\t{\n\t\tread(w[i]);\n\t\tw[i]=no[w[i]];\n\t}\n\tfor(int i=1;i<n;++i)\n\t{\n\t\tread(u);\n\t\tread(v);\n\t\tadd_edge(u,v);\n\t\tadd_edge(v,u);\n\t}\n\tdfs1(1);\n\tread(q);\n\tfor(int i=1;i<=q;++i)\n\t{\n\t\tread(u);\n\t\tread(v);\n\t\tpos[i]=LCA(u,v);\n\t\tup[u].push_back(i);\n\t\tdown[v].push_back(i);\n\t}\n\tdfs2(1);\n\tdfs3(1);\n\tfor(int i=1;i<=q;++i)\n\t\tprintf(\"%d\\n\",res[i]);\n\treturn 0;\n}\n```",
        "postTime": 1618308393,
        "uid": 67952,
        "name": "\u767d\u9c9f",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P7518 [\u7701\u9009\u8054\u8003 2021 A/B \u5377] \u5b9d\u77f3"
    },
    {
        "content": "[P7518 [\u7701\u9009\u8054\u8003 2021 A/B \u5377] \u5b9d\u77f3](https://www.luogu.com.cn/problem/P7518)\u89e3\u9898\u62a5\u544a\uff1a\n\n[\u66f4\u597d\u7684\u9605\u8bfb\u4f53\u9a8c](https://zybuluo.com/xiaoziyao/note/1791149)\n\n## \u9898\u610f\n\n\u7ed9\u5b9a\u4e00\u9897$n$\u4e2a\u70b9\u7684\u5e26\u70b9\u6743\u7684\u6811\uff0c\u4ee5\u53ca\u4e00\u4e2a\u957f\u5ea6\u4e3a$c$\u7684\u5339\u914d\u5e8f\u5217\uff0c\uff08\u70b9\u6743\u4e0e\u5e8f\u5217\u7684\u503c\u57df\u4e3a$[1,m]$\uff09\uff0c$q$\u6b21\u8be2\u95ee\uff0c\u6bcf\u6b21\u8be2\u95ee$x$\u5230$y$\u7684\u6709\u5411\u8def\u5f84\u4e0e\u5339\u914d\u5e8f\u5217\u5339\u914d\u7684\u6700\u957f\u524d\u7f00\u7684\u957f\u5ea6\u3002\n\n$1\\leqslant n,q\\leqslant 2\\times 10^5,1\\leqslant c\\leqslant m\\leqslant 5\\times 10^4$\u3002\n\n## \u5206\u6790\n\n\u8003\u573a\u5199\u4e86\u4e00\u4e2a5k\u7684\u6811\u5206\u5757$O((n+q+m\\alpha(n))\\sqrt{n})$\u7684\u505a\u6cd5\uff0c\u7136\u540e\u88ab\u5361\u5e38\u5361\u6210$35pts$\u5c31\u5f88\u79bb\u8c31\u3002\n\n> \n\uff08\u8be5\u90e8\u5206\u53ef\u7565\u8fc7\uff09\n\u5728\u6811\u4e0a\u6492$\\sqrt{n}$\u4e2a\u5173\u952e\u70b9\uff0c\u6bcf\u4e2a\u70b9\u4e0e\u5176\u7956\u5148\u91cc\u7684\u5173\u952e\u70b9\u8ddd\u79bb\u4e3a$\\sqrt{n}$\uff0c\u7136\u540e\u53d1\u73b0\u53ef\u4ee5\u628a\u8be2\u95ee\u7684\u8def\u5f84\u5206\u6210$4$\u4e2a\u6563\u5757\u548c$2$\u4e2a\u6574\u5757\uff0c\u6563\u5757\u66b4\u529b\u8df3\uff08\u8bb0\u5f97\u628a$lca$\u5230\u53e6\u4e00\u7aef\u7684\u8def\u5f84\u53cd\u5411\uff0c\u6211\u56e0\u4e3a\u53cd\u5411\u8c03\u4e86\u4e00\u4e2a\u591a\u5c0f\u65f6\uff09\uff0c\u6574\u5757\u53ef\u4ee5\u9884\u5904\u7406\u7b2c$i$\u4e2a\u5173\u952e\u70b9\u8df3\u5230\u7956\u5148\u5173\u952e\u70b9\u8fd9\u4e00\u6761\u94fe\uff0c\u4ece\u4f4d\u7f6e$j$\u5f00\u59cb\u5339\u914d\u80fd\u5339\u914d\u5230\u54ea\u91cc\uff0c\u4e0d\u96be\u53d1\u73b0\uff08\u6211\u60f3\u4e86\u5341\u51e0\u5206\u949f\uff09\u53ef\u4ee5\u7528\u5e76\u67e5\u96c6\u7ef4\u62a4\u6240\u6709\u4f4d\u7f6e\u540c\u65f6\u8fdb\u884c\u5339\u914d\uff0c\u540c\u6837\u8fd8\u8981\u53cd\u8fc7\u6765\u505a\u4e00\u904d\u3002\n\u5177\u4f53\u5730\uff0c\u53ef\u4ee5\u628a\u6574\u5757\u5bf9\u5e94\u7684\u94fe\u4e0a\u6743\u503c\u5e8f\u5217\u5f53\u6210\u4e00\u4e2a\u666e\u901a\u7684\u5e8f\u5217\uff0c\u4e0e\u957f\u5ea6\u4e3am\u7684\u4e32\u8fdb\u884c\u5339\u914d\uff0c\u7136\u540e\u5bf9\u4e8e\u6bcf\u4e2a\u4f4d\u7f6e\u53ef\u4ee5\u7ef4\u62a4\u5b83\u5728\u5339\u914d\u7684\u8fc7\u7a0b\u4e2d\u5230\u4e86\u54ea\u4e00\u4e2a\u4f4d\u7f6e\uff0c\u4e0d\u96be\u53d1\u73b0\u628a\u76f8\u540c\u7684\u4f4d\u7f6e\u5728\u5339\u914d\u7684\u8fc7\u7a0b\u4e2d\u4f1a\u4e0d\u65ad\u5408\u5e76\uff0c\u90a3\u4e48\u76f4\u63a5\u4e0a\u5e76\u67e5\u96c6\u5c31\u597d\u4e86\u3002\n\n\u7136\u540e\u53d1\u73b0$O(n\\log n+q\\log n\\log m)$\u7684\u6811\u4e0a\u500d\u589e\u597d\u60f3\u597d\u5199\u7684\u4e00\u6279\u3002\n\n\u9996\u5148\u8fdb\u884c\u4e00\u6b21\u8f6c\u5316\uff0c\u628a\u70b9\u6743\u8f6c\u5316\u4e3a\u5728\u5e8f\u5217\u4e2d\u7684\u4f4d\u7f6e\uff0c\u8fd9\u6837\u597d\u505a\u4e00\u4e9b\u3002\n\n\u8003\u8651\u9884\u5904\u7406$x$\u5411\u4e0a\u8df3\u7b2c\u4e00\u4e2a\u70b9\u6743\u4e3a$c$\u7684\u70b9\u7684\u4f4d\u7f6e\uff0c\u8fd9\u662f\u4e00\u4e2a\u7ecf\u5178\u95ee\u9898\uff0c\u5728\u6811\u4e0a\u7528\u4e3b\u5e2d\u6811\u5b8c\u6210\u5c31\u597d\u4e86\uff0c\u65f6\u7a7a\u590d\u6742\u5ea6\u5747\u4e3a$O(n\\log m)$\u3002\n\n\u7136\u540e\u518d\u6309\u7167\u6811\u4e0a\u500d\u589e\u7684\u5957\u8def\u9884\u5904\u7406\u4e00\u4e2a$inc_{x,k}$\u8868\u793a$x$\u5411\u4e0a\u8df3\uff0c\u4ece\u5f53\u524d\u70b9\u6743$w_x$\u5339\u914d\u5230$w_x+2^k$\u7684\u4f4d\u7f6e\uff0c\u4ee5\u53ca$dec_{x,k}$\u8868\u793a$x$\u5411\u4e0a\u8df3\uff0c\u4ece\u5f53\u524d\u70b9\u6743$w_x$\u53cd\u5411\u5339\u914d\u5230$w_x-2^k$\u7684\u4f4d\u7f6e\u3002\u6211\u4eec\u9996\u5148\u7528\u4e3b\u5e2d\u6811\u5e2e\u5fd9\u5904\u7406\u51fa$inc_{x,0}$\u4e0e$dec_{x,0}$\uff0c\u7136\u540e\u76f4\u63a5\u5408\u5e76\u5c31\u597d\u4e86\u3002\n\n\u5bf9\u4e8e\u8be2\u95ee$(x,y)$\uff0c\u8bbe$z=lca(x,y)$\uff0c\u8003\u8651\u8ba9$x$\u8df3\u5230\u7b2c\u4e00\u4e2a\u70b9\u6743\u4e3a$1$\u7684\u70b9\u5f00\u59cb\u5339\u914d\uff08\u9700\u8981\u7279\u5224\u4e00\u4e0b\u8df3\u51fa$x\\rightarrow z$\u8fd9\u4e00\u6761\u94fe\u7684\u60c5\u51b5\uff09\uff0c\u7136\u540e\u7528\u6811\u4e0a\u500d\u589e\u66b4\u529b\u8df3$inc$\u6570\u7ec4\u76f4\u5230\u8df3\u51fa$x\\rightarrow z$\u8fd9\u4e00\u6761\u94fe\u3002\n\n\u4e4b\u540e\uff0c\u6211\u4eec\u53d1\u73b0$y$\u4e0d\u80fd\u8fdb\u884c\u7c7b\u4f3c\u7684\u64cd\u4f5c\uff0c\u56e0\u4e3a\u6211\u4eec\u4e0d\u77e5\u9053\u7ed3\u5c3e\u7684\u70b9\u6743\u4e3a\u591a\u5c11\uff0c\u4e0d\u96be\u53d1\u73b0\u7b54\u6848\u5177\u6709\u53ef\u4e8c\u5206\u6027\uff0c\u76f4\u63a5\u4e8c\u5206\u6700\u540e\u7684\u4f4d\u7f6e\uff0c\u7136\u540e\u6309\u7167\u4e0a\u9762\u7684\u65b9\u6cd5\u8df3$dec$\u5c31\u597d\u4e86\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a$O(n\\log n+q\\log n\\log m)$\u3002\n\n## \u4ee3\u7801\n\u5e38\u6570\u4f3c\u4e4e\u5f88\u5927\u3002\n```\n#include<stdio.h>\nconst int maxm=50005,maxn=200005,maxe=maxn<<1,maxk=25;\nint n,m,c,e,q,tot;\nint p[maxm],w[maxn],start[maxn],to[maxe],then[maxe],fore[maxn][maxk],dep[maxn],pos[maxm];\nint lc[maxn*maxk],rc[maxn*maxk],res[maxn*maxk],rt[maxn],inc[maxn][maxk],dec[maxn][maxk];\ninline void add(int x,int y){\n\tthen[++e]=start[x],start[x]=e,to[e]=y;\n}\nvoid build(int l,int r,int &now){\n\tif(now==0)\n\t\tnow=++tot;\n\tif(l==r){\n\t\tres[now]=-1;\n\t\treturn ;\n\t}\n\tint mid=(l+r)>>1;\n\tbuild(l,mid,lc[now]),build(mid+1,r,rc[now]);\n}\ninline int newnode(int x){\n\ttot++,lc[tot]=lc[x],rc[tot]=rc[x],res[tot]=res[x];\n\treturn tot;\n}\nvoid update(int l,int r,int &now,int pos,int v){\n\tnow=newnode(now);\n\tif(l==r){\n\t\tres[now]=v;\n\t\treturn ;\n\t}\n\tint mid=(l+r)>>1;\n\tif(pos<=mid)\n\t\tupdate(l,mid,lc[now],pos,v);\n\telse update(mid+1,r,rc[now],pos,v);\n}\nint query(int l,int r,int now,int pos){\n\tif(l==r)\n\t\treturn res[now];\n\tint mid=(l+r)>>1;\n\tif(pos<=mid)\n\t\treturn query(l,mid,lc[now],pos);\n\treturn query(mid+1,r,rc[now],pos);\n}\nvoid dfs(int x,int last){\n\tdep[x]=dep[last]+1,fore[x][0]=last,rt[x]=rt[last];\n\tif(w[x]!=-1)\n\t\tupdate(1,c,rt[x],w[x],x);\n\tinc[x][0]=(w[x]==-1||w[x]==c)? -1:query(1,c,rt[x],w[x]+1);\n\tdec[x][0]=(w[x]==-1||w[x]==1)? -1:query(1,c,rt[x],w[x]-1);\n\tfor(int i=1;i<=20;i++){\n\t\tfore[x][i]=fore[fore[x][i-1]][i-1];\n\t\tinc[x][i]=inc[x][i-1]==-1? -1:inc[inc[x][i-1]][i-1];\n\t\tdec[x][i]=dec[x][i-1]==-1? -1:dec[dec[x][i-1]][i-1];\n\t}\n\tfor(int i=start[x];i;i=then[i]){\n\t\tint y=to[i];\n\t\tif(y==last)\n\t\t\tcontinue;\n\t\tdfs(y,x);\n\t}\n}\nint lca(int a,int b){\n\tif(dep[a]<dep[b])\n\t\ta+=b,b=a-b,a-=b;\n\tfor(int i=20;i>=0;i--)\n\t\tif(dep[fore[a][i]]>=dep[b])\n\t\t\ta=fore[a][i];\n\tif(a==b)\n\t\treturn a;\n\tfor(int i=20;i>=0;i--)\n\t\tif(fore[a][i]!=fore[b][i])\n\t\t\ta=fore[a][i],b=fore[b][i];\n\treturn fore[a][0];\n}\nint check(int x,int z,int now,int goal){\n\tx=query(1,c,rt[x],goal);\n\tif(x==-1||dep[x]<dep[z])\n\t\treturn 0;\n\tfor(int i=20;i>=0;i--)\n\t\tif(dec[x][i]!=-1&&dep[dec[x][i]]>dep[z])\n\t\t\tx=dec[x][i];\n\treturn w[x]<=now;\n}\nint main(){\n\tscanf(\"%d%d%d\",&n,&m,&c);\n\tfor(int i=1;i<=m;i++)\n\t\tpos[i]=-1;\n\tfor(int i=1;i<=c;i++)\n\t\tscanf(\"%d\",&p[i]),pos[p[i]]=i;\n\tfor(int i=1;i<=n;i++)\n\t\tscanf(\"%d\",&w[i]),w[i]=pos[w[i]];\n\tfor(int i=1;i<n;i++){\n\t\tint x,y;\n\t\tscanf(\"%d%d\",&x,&y);\n\t\tadd(x,y),add(y,x);\n\t}\n\tbuild(1,c,rt[0]),dfs(1,0);\n\tscanf(\"%d\",&q);\n\twhile(q--){\n\t\tint x,y,z,res=0;\n\t\tscanf(\"%d%d\",&x,&y),z=lca(x,y);\n\t\tx=query(1,c,rt[x],1);\n\t\tif(x!=-1&&dep[x]>=dep[z]){\n\t\t\tfor(int i=20;i>=0;i--)\n\t\t\t\tif(inc[x][i]!=-1&&dep[inc[x][i]]>=dep[z])\n\t\t\t\t\tx=inc[x][i];\n\t\t\tres=w[x];\n\t\t}\n\t\tint L=res,R=c+1;\n\t\twhile(L+1<R){\n\t\t\tint mid=(L+R)>>1;\n\t\t\tif(check(y,z,res+1,mid))\n\t\t\t\tL=mid;\n\t\t\telse R=mid;\n\t\t}\n\t\tprintf(\"%d\\n\",L);\n\t}\n\treturn 0;\n}\n```\n\n\u7701\u9009\u8054\u8003A\u5377\u5168\u90e8\u9898\u89e3\u53ef\u89c1\uff1a[2021\u7701\u9009\u8054\u8003A\u5377\u89e3\u9898\u62a5\u544a](https://zybuluo.com/xiaoziyao/note/1791034)",
        "postTime": 1618913112,
        "uid": 35754,
        "name": "Verdandi",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P7518\u3010[\u7701\u9009\u8054\u8003 2021 A/B \u5377] \u5b9d\u77f3\u3011"
    },
    {
        "content": "\u8003\u8bd5\u7684\u65f6\u5019\u5341\u5206\u50bb\u903c\uff0c\u8ddd\u79bb\u6b63\u89e3\u53ea\u6709\u4e00\u6b65\u2026\u2026\n\n\u9996\u5148\u53ef\u4ee5\u60f3\u5230\u500d\u589e\uff0c\u5c06\u7b54\u6848\u5206\u4e3a\u4e24\u6bb5\uff0c\u5206\u522b\u4ece x \u8df3\u5230 lca \u548c\u4ece lca \u8df3\u5230 y\u3002\n\n\u7136\u540e\u5bf9\u4e8e\u500d\u589e\u6570\u7ec4\u7684\u9884\u5904\u7406\uff0c\u5c31\u662f\u9996\u5148\u505a\u4e00\u6b21 dfs\uff0c\u7136\u540e\u7528\u4e00\u4e2a\u6876\u8bb0\u5f55\u4e00\u4e0b\u5f80\u4e0a\u8d70\u5230\u4efb\u610f\u5b9d\u77f3\u7684\u6700\u8fd1\u7684\u4f4d\u7f6e(\u6211\u4eec\u4e0d\u77e5\u9053\u4e0a\u4e00\u4e2a\u8981\u8df3\u5230\u54ea)\uff0c\u7136\u540e\u6211\u5c31\u53d1\u73b0\u6570\u7ec4\u5b58\u4e0d\u4e0b\u4e86\u3002\n\n\u8fd9\u65f6\u5019\u6211\u4eec\u5c31\u9700\u8981\u8f6c\u5316\u9898\u610f\uff0c\u8003\u8bd5\u7684\u65f6\u5019\u6211\u4e00\u76f4\u5728\u60f3\uff0c\u4fdd\u8bc1p\u6570\u7ec4\u4e0d\u91cd\u590d\u7a76\u7adf\u6709\u4ec0\u4e48\u7528\uff0c\u539f\u6765\u662f\u53ef\u4ee5\u628a\u5b9d\u77f3\u8f6c\u5316\u4e3a\u8981\u53d6\u7684\u7b2c\u51e0\u4e2a\u5b9d\u77f3\uff0c\u90a3\u6211\u4eec\u53d6\u7684\u5b9d\u77f3\u5c31\u53d8\u6210\u4e86\u4e00\u4e2a 1~ans \u7684\u5e8f\u5217\uff0c\u8fd9\u6837\u6211\u4eec\u7684\u500d\u589e\u5c31\u53ef\u4ee5\u76f4\u63a5\u8bb0\u5f55\u4e0b\u4e00\u79cd\u5b9d\u77f3\u8981\u8df3\u5230\u54ea\u91cc\u4e86\uff0c\u5c31\u4e0d\u9700\u8981\u8bb0\u5f55\u6240\u6709\u5b9d\u77f3\u7684\u4e86\u3002\n\n\u7136\u540e\u8003\u573a\u5f88\u50bb\u903c\uff0c\u6ca1\u6709\u505a\u500d\u589e\uff0c\u76f4\u63a5\u66b4\u529b\u8df3\uff0c\u4e8e\u662f\u5c31\u6709\u4e86\u6700\u521d\u8bb0\u5f55\u6240\u6709\u5b9d\u77f3\u7684\u60f3\u6cd5\u2026\u2026\n\n\u7136\u540e\u6211\u4eec\u5c31\u5f88\u81ea\u7136\u7684\u53d1\u73b0\u5de6\u8fb9\u90a3\u6bb5\u89e3\u51b3\u4e86\uff0c\u53f3\u8fb9\u90a3\u6bb5\u6211\u8003\u8bd5\u7684\u65f6\u5019\u4e5f\u60f3\u51fa\u6765\u4e8c\u5206\u679a\u4e3e\u4e00\u4e0b\u7b54\u6848\uff0c\u7136\u540e\u8df3\u4e0a\u53bb\u770b\u770b\u5408\u4e0d\u5408\u6cd5\u5c31\u884c\u4e86\uff0c\u8d77\u70b9\u501f\u52a9\u4e00\u5f00\u59cb\u7684\u6876\u5c31\u884c\u4e86\u3002\n\n\u7136\u540e\u53d1\u73b0\u628a\u8be2\u95ee\u6302\u5728\u8282\u70b9\u4e0a\u53ef\u4ee5\u51cf\u5c11\u65f6\u95f4\u590d\u6742\u5ea6\u3002\n\n~~\u6ca1\u60f3\u5230\u500d\u589e\u7684\u6211\u53ef\u4ee5\u9000\u5f79\u4e86~~\n```cpp\n#include<cstdio>\n#include<vector>\n#include<algorithm>\nusing namespace std;\nstruct node{int last,en,next;} e[400010];\nint n,m,c,p[50010],w[200010],x,y,tot,f[200010][18],f1[200010][18],f2[200010][18];\nint ans[200010],dep[200010],t1[50010],t2[50010],start[200010],q;\nvector<pair<int,int> >ask[200010];\nvoid add(int x,int y)\n{\n\te[++tot].en=y;\n\te[tot].next=e[x].last;\n\te[x].last=tot;\n}\nint lca(int x,int y)\n{\n\tif (dep[x]<dep[y]) swap(x,y);\n\tfor (int i=17;i>=0;i--)\n\t\tif (dep[f[x][i]]>=dep[y]) x=f[x][i];\n\tif (x==y) return x;\n\tfor (int i=17;i>=0;i--)\n\t\tif (f[x][i]!=f[y][i]) x=f[x][i],y=f[y][i];\n\treturn f[x][0];\n}\nvoid dfs1(int x,int fa)\n{\n\tif (w[x]==1) start[x]=x;else start[x]=start[fa];\n\tdep[x]=dep[fa]+1;f[x][0]=fa;\n\tint u=t1[w[x]],v=t2[w[x]];\n\tt1[w[x]]=t2[w[x]]=x;\n\tf1[x][0]=t1[w[x]+1];f2[x][0]=t2[w[x]-1];\n\tfor (int i=e[x].last;i;i=e[i].next)\n\t\tif (e[i].en!=fa) dfs1(e[i].en,x);\n\tt1[w[x]]=u;t2[w[x]]=v;\n}\nbool pd(int x,int c,int z,int tail)\n{\n\tx=t1[c];\n\tif (dep[x]<dep[z])return 0;\n\tfor (int i=17;i>=0;i--)\n\t\tif (dep[f2[x][i]]>=dep[z]) c-=1<<i,x=f2[x][i];\n\treturn c<=tail;\n}\nvoid dfs2(int x,int fa)\n{\n\tint u=t1[w[x]];t1[w[x]]=x;\n\tfor (int i=0;i<ask[x].size();i++)\n\t{\n\t\tint y=ask[x][i].first,id=ask[x][i].second;\n\t\tint z=lca(x,y);int ret=0;\n\t\ty=start[y];\n\t\tif (dep[y]>=dep[z])\n\t\t{\n\t\t\tfor (int i=17;i>=0;i--)\n\t\t\t\tif (dep[f1[y][i]]>=dep[z])\n\t\t\t\t\ty=f1[y][i];\n\t\t\tret=w[y];\n\t\t}\n\t\tint l=ret+1,r=c,mid,p=ret;\n\t\twhile (l<=r)\n\t\t{\n\t\t\tmid=(l+r)>>1;\n\t\t\tif (pd(x,mid,z,p+1)) l=mid+1,ret=mid;\n\t\t\telse r=mid-1;\n\t\t}\n\t\tans[id]=ret;\n\t}\n\tfor (int i=e[x].last;i;i=e[i].next)\n\t\tif (e[i].en!=fa) dfs2(e[i].en,x);\n\tt1[w[x]]=u;\n}\nint main()\n{\n\tscanf(\"%d%d%d\",&n,&m,&c);\n\tfor (int i=1;i<=c;i++)\n\t\tscanf(\"%d\",&x),p[x]=i;\n\tfor (int i=1;i<=n;i++)\n\t\tscanf(\"%d\",&x),w[i]=p[x];\n\tfor (int i=1;i<n;i++)\n\t\tscanf(\"%d%d\",&x,&y),add(x,y),add(y,x);\n\tdfs1(1,0);\n\tfor (int j=1;j<=17;j++)\n\t\tfor (int i=1;i<=n;i++)\n\t\t{\n\t\t\tf[i][j]=f[f[i][j-1]][j-1];\n\t\t\tf1[i][j]=f1[f1[i][j-1]][j-1];\n\t\t\tf2[i][j]=f2[f2[i][j-1]][j-1];\n\t\t}\n\tscanf(\"%d\",&q);\n\tfor (int i=1;i<=q;i++)\n\t{\n\t\tscanf(\"%d%d\",&x,&y);\n\t\task[y].push_back(make_pair(x,i));\n\t}\n\tdfs2(1,0);\n\tfor (int i=1;i<=q;i++)\n\t\tprintf(\"%d\\n\",ans[i]);\n\treturn 0;\n}\n```\n",
        "postTime": 1618650611,
        "uid": 157857,
        "name": "ImmortalWatcher",
        "ccfLevel": 6,
        "title": "[\u7701\u9009\u8054\u8003 2021 A/B \u5377] \u5b9d\u77f3\u9898\u89e3"
    },
    {
        "content": "\u8003\u573a\u4e0a\u60f3\u5230\u7684\u4e0d\u5999\u5e73\u8861\u6811\u505a\u6cd5\uff0c\u672c\u8d28\u5c31\u662f\u628a\u5176\u5b83\u9898\u89e3\u4e2d\u7684\u500d\u589e/\u4e8c\u5206\u6362\u6210\u5e73\u8861\u6811\uff0c\u5e38\u6570\u8f83\u5927\uff0c\u4f46\u8003\u573a\u4eb2\u6d4b\u4e0d\u5361\u5e38\u80fd\u8fc7\uff0c\u9002\u5408\u7801\u529b\u60ca\u4eba\u7684\u9009\u624b\u3002\uff08\u8003\u573a\u4e0a\u56e0\u4e3a\u6570\u7ec4\u5f00\u5c0f\u70b8\u4e86\u94fe\u7684\u90e8\u5206\u5206\uff09\n\n\u672c\u9898\u79bb\u7ebf\u5230\u6811\u5256\u91cd\u513f\u5b50\u4e0a\u7684\u601d\u60f3\u503c\u5f97\u501f\u9274\u3002\n\n\u9898\u76ee\u4fdd\u8bc1 $P_i$ \u4e92\u4e0d\u76f8\u540c\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4ee4 $P_i=i$ \uff0c\u5e76\u4f9d\u6b64\u8c03\u6574\u6811\u4e0a\u5b9d\u77f3\u7684\u989c\u8272\u3002\n\n#### \u94fe\u4e0a\u505a\u6cd5\n\n\u9996\u5148\u8003\u8651\u94fe\u4e0a\u7684\u89e3\u6cd5\uff0c\u8fd9\u4e00\u90e8\u5206\u7684\u505a\u6cd5\u4e5f\u662f\u672c\u9898\u89e3\u548c\u5176\u5b83\u6811\u5256+\u500d\u589e/\u4e8c\u5206\u505a\u6cd5\u7684\u6700\u5927\u4e0d\u540c\u4e4b\u5904\u3002\n\n\u8003\u8651\u66b4\u529b\u7684\u89e3\u6cd5\u3002\u5bf9\u4e8e\u5355\u4e2a\u7684\u8be2\u95ee $u,v$ \uff0c\u521d\u59cb\u65f6\u5339\u914d\u957f\u5ea6\u4e3a $0$ \uff0c\u904d\u5386\u6811\u4e0a $u$ \u5230 $v$ \u7684\u7b80\u5355\u8def\u5f84\uff0c\u5982\u679c\u5f53\u524d\u7ed3\u70b9\u5b9d\u77f3\u7f16\u53f7\u4e3a $i$ \u4e14\u5f53\u524d\u5339\u914d\u957f\u5ea6\u4e3a $i-1$ \uff0c\u5c06\u5f53\u524d\u5339\u914d\u957f\u5ea6\u6539\u4e3a $i$ \u3002\n\n\u8003\u8651\u540c\u65f6\u5904\u7406\u591a\u4e2a\u8be2\u95ee\u3002\u4e0d\u59a8\u8bbe $u_i\\le v_i$ \uff0c\u82e5 $u_i>v_i$ \u53ef\u4ee5\u5c06\u94fe\u53cd\u8fc7\u6765\u518d\u505a\u4e00\u904d\u3002\u8003\u8651\u901a\u8fc7\u67d0\u79cd\u6570\u636e\u7ed3\u6784\u540c\u65f6\u7ef4\u62a4\u6240\u6709\u7684\u5339\u914d\u957f\u5ea6\u3002\u4ece $1$ \u5230 $n$ \u904d\u5386\u6bcf\u4e2a\u70b9\uff0c\u82e5\u5f53\u524d\u7ed3\u70b9\u7f16\u53f7\u4e3a $x$ \uff0c\u5b9d\u77f3\u7f16\u53f7\u4e3a $i$ \uff0c\u5219\u5c06\u6240\u6709 $u_j\\le x\\le v_j$ \u4e14\u5f53\u524d\u5339\u914d\u957f\u5ea6\u4e3a $i-1$ \u7684\u8be2\u95ee\u7684\u5339\u914d\u957f\u5ea6\u53d8\u4e3a $i$ \u3002\n\n\u5bf9\u5e94\u5230\u5177\u4f53\u7684\u64cd\u4f5c\u4e0a\uff0c\u5c31\u662f\uff1a\n\n1. \u63d2\u5165\u4e00\u4e2a\u4e8c\u5143\u7ec4 $x,id$ \u3002\n\n2. \u7ed9\u5b9a $i$ \uff0c\u5c06\u6240\u6709 $x=i-1$ \u7684\u4e8c\u5143\u7ec4\u6539\u4e3a $x=i$ \u3002\n\n3. \u67e5\u8be2 $id$ \u5bf9\u5e94\u7684 $x$ \u503c\u3002\n\n\u8fd9\u4e2a\u53ef\u4ee5\u7528\u5e73\u8861\u6811\u5982 FHQ Treap \u4ece\u5c0f\u5230\u5927\u7ef4\u62a4 $x$ \u89e3\u51b3\u3002\u5355\u6b21\u64cd\u4f5c\u65f6\u95f4\u590d\u6742\u5ea6 $O(\\log n)$ \u3002\n\n\u53ea\u9700\u6b63\u53cd\u5404\u505a\u4e00\u6b21\u5e73\u8861\u6811\uff0c\u5c31\u53ef\u4ee5\u89e3\u51b3\u94fe\u4e0a\u95ee\u9898\u4e86\u3002\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log n)$ \u3002\n\n### \u6811\u4e0a\u95ee\u9898\n\n\u94fe\u4e0a\u95ee\u9898\u8f6c\u5316\u4e3a\u6811\u4e0a\u95ee\u9898\uff0c\u7b2c\u4e00\u4e2a\u60f3\u5230\u7684\u5c31\u662f\u6811\u94fe\u5256\u5206\uff0c\u5c06\u8be2\u95ee\u79bb\u7ebf\u62c6\u5206\u5230\u82e5\u5e72\u91cd\u94fe\u4e0a\u3002\u6839\u636e\u6811\u5256\u7684\u76f8\u5173\u77e5\u8bc6\uff0c\u4e00\u4e2a\u8be2\u95ee\u6700\u591a\u88ab\u62c6\u5206\u5230 $O(\\log n)$ \u6761\u91cd\u94fe\u4e0a\u3002\n\n\u79bb\u7ebf\u540e\u5148\u4ece\u53f6\u5b50\u5411\u6839\u5904\u7406\u8df3\u7684\u8fb9\uff0c\u518d\u4ece\u6839\u5411\u53f6\u5b50\u5904\u7406\u8df3\u7684\u8fb9\uff0c\u8fd9\u6837\u4fdd\u8bc1\u6240\u6709\u8be2\u95ee\u67e5\u8be2\u7ed3\u70b9\u7684\u987a\u5e8f\u662f\u6b63\u786e\u7684\u3002\n\n\u5728\u91cd\u94fe\u4e0a\u7684\u90e8\u5206\u548c\u94fe\u7684\u60c5\u51b5\u540c\u7b49\u5904\u7406\u5373\u53ef\u3002\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log^2 n)$ \uff0c\u7a7a\u95f4\u590d\u6742\u5ea6 $O(n\\log n)$ \u3002\n\n### \u53c2\u8003\u4ee3\u7801\n\n\u7ea6\u7b49\u4e8e\u8003\u573a\u4ee3\u7801\uff0c\u53ea\u6709\u6570\u7ec4\u5f00\u5927\u4e86\u3002\n\n```cpp\n#include<cstdio>\n#include<cstring>\n#include<algorithm>\n#include<vector>\n#include<cstdlib>\n#include<queue>\nusing namespace std;\nconst int maxn=600010;\nint n,m,c,P[maxn],rnk[maxn],w[maxn],u,v,q,ans[maxn];\nint cur,h[maxn],nxt[maxn],p[maxn];\nvoid add_edge(int x,int y)\n{\n\tcur++;\n\tnxt[cur]=h[x];\n\th[x]=cur;\n\tp[cur]=y;\n}\nint fa[maxn],dep[maxn],siz[maxn],son[maxn];\nint clk,dfn[maxn],top[maxn];\nvoid dfs1(int x)\n{\n\tsiz[x]=1;\n\tfor(int j=h[x];j;j=nxt[j])if(p[j]!=fa[x])\n\t{\n\t\tfa[p[j]]=x;dep[p[j]]=dep[x]+1;\n\t\tdfs1(p[j]);siz[x]+=siz[p[j]];\n\t\tif(siz[p[j]]>siz[son[x]])son[x]=p[j];\n\t}\n}\nvoid dfs2(int x,int t)\n{\n\tdfn[x]=++clk;rnk[clk]=x;top[x]=t;\n\tif(son[x])dfs2(son[x],t);\n\tfor(int j=h[x];j;j=nxt[j]){if(p[j]!=fa[x]&&p[j]!=son[x])dfs2(p[j],p[j]);}\n}\nstruct node{int l,r,id,op;};\nvector<node>g[maxn];\nstruct oper{int op,id,v,t;}s[maxn];\nbool cmp1(oper x,oper y){return x.t==y.t?x.op<y.op:x.t>y.t;}\nbool cmp2(oper x,oper y){return x.t==y.t?x.op<y.op:x.t<y.t;}\nint cnt;\n/* \nstruct FHQ\n{\n\tint a[maxn];\n\tvoid clear(){for(int i=1;i<=n;i++)a[i]=0;}\n\tvoid insert(int x,int v){a[x]=v;}\n\tvoid update(int v){for(int i=1;i<=n;i++)if(a[i]==v-1)a[i]=v;}\n\tint query(int x){return a[x];}\n}st;*/\nqueue<int>pl;\nstruct FHQ\n{\n\tint rt,v[maxn],tag[maxn],siz[maxn],lc[maxn],rc[maxn],fa[maxn];\n\tvoid clear(){rt=0;while(!pl.empty()){int x=pl.front();pl.pop();v[x]=tag[x]=siz[x]=lc[x]=rc[x]=fa[x]=0;maintain(x);}}\n\tvoid maintain(int x)\n\t{\n\t\tsiz[x]=siz[lc[x]]+siz[rc[x]]+1;\n\t}\n\tvoid pushdown(int x)\n\t{\n\t\tif(lc[x])v[lc[x]]+=tag[x],tag[lc[x]]+=tag[x];\n\t\tif(rc[x])v[rc[x]]+=tag[x],tag[rc[x]]+=tag[x];\n\t\ttag[x]=0;\n\t}\n\tint merge(int x,int y)\n\t{\n\t\t//printf(\"merge %d %d\\n\",x,y);\n\t\tif(!x||!y)return x+y;\n\t\tif(rand()%(siz[x]+siz[y])<siz[x])\n\t\t{\n\t\t\tpushdown(x);rc[x]=merge(rc[x],y);maintain(x);fa[rc[x]]=x;return x;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tpushdown(y);lc[y]=merge(x,lc[y]);maintain(y);fa[lc[y]]=y;return y;\n\t\t}\n\t}\n\tvoid split(int o,int val,int&x,int&y)\n\t{\n\t\t//printf(\"split %d %d %d %d\\n\",o,val,x,y);\n\t\tif(!o){x=y=0;return;}\n\t\tpushdown(o);\n\t\tif(v[o]<=val){x=o,split(rc[o],val,rc[x],y);if(rc[x])fa[rc[x]]=x;fa[y]=0;maintain(x);}\n\t\telse {y=o,split(lc[o],val,x,lc[y]);if(lc[y])fa[lc[y]]=y;fa[x]=0;maintain(y);}\n\t}\n\tvoid pushall(int x)\n\t{\n\t\tif(fa[x])pushall(fa[x]);\n\t\tpushdown(x);\n\t}\n\tint query(int x){pushall(x);return v[x];}\n\tvoid insert(int x,int val)\n\t{\n\t\tpl.push(x);\n\t\tv[x]=val;maintain(x);\n\t\tint a=0,b=0;\n\t\tsplit(rt,val,a,b);\n\t\trt=merge(merge(a,x),b);\n\t}\n\tvoid update(int val)\n\t{\n\t\tint a=0,b=0,c=0;\n\t\tsplit(rt,val-2,a,b);\n\t\tsplit(b,val-1,b,c);\n\t\tv[b]++;tag[b]++;\n\t\trt=merge(merge(a,b),c);\n\t}\n}st;\nvoid solveup(int x)\n{\n\tfor(int j=h[x];j;j=nxt[j])if(p[j]!=fa[x])solveup(p[j]);\n\tif(top[x]==x)\n\t{\n\t\tcnt=0;\n\t\tfor(int i=0;i<(int)g[x].size();i++)if(g[x][i].op==0)\n\t\ts[++cnt]=(oper){1,g[x][i].id,ans[g[x][i].id],g[x][i].l},s[++cnt]=(oper){3,g[x][i].id,0,g[x][i].r};\n\t\tfor(int i=dfn[x];top[rnk[i]]==x;i++)s[++cnt]=(oper){2,0,w[rnk[i]],i};\n\t\tsort(s+1,s+cnt+1,cmp1);st.clear();\n\t\tfor(int i=1;i<=cnt;i++)\n\t\t{\n\t\t\tif(s[i].op==1)st.insert(s[i].id,s[i].v);\n\t\t\tif(s[i].op==2)st.update(s[i].v);\n\t\t\tif(s[i].op==3)ans[s[i].id]=st.query(s[i].id);\n\t\t}\n\t}\n}\nvoid solvedown(int x)\n{\n\tif(top[x]==x)\n\t{\n\t\t//printf(\"solvedown %d\\n\",x);\n\t\tcnt=0;\n\t\tfor(int i=0;i<(int)g[x].size();i++)if(g[x][i].op==1)\n\t\ts[++cnt]=(oper){1,g[x][i].id,ans[g[x][i].id],g[x][i].l},s[++cnt]=(oper){3,g[x][i].id,0,g[x][i].r};\n\t\tfor(int i=dfn[x];top[rnk[i]]==x;i++)s[++cnt]=(oper){2,0,w[rnk[i]],i};\n\t\tsort(s+1,s+cnt+1,cmp2);st.clear();\n\t\tfor(int i=1;i<=cnt;i++)\n\t\t{\n\t\t\t//printf(\"ontopof %d , %d %d %d %d\\n\",x,s[i].op,s[i].id,s[i].v,s[i].t);\n\t\t\tif(s[i].op==1)st.insert(s[i].id,s[i].v);\n\t\t\tif(s[i].op==2)st.update(s[i].v);\n\t\t\tif(s[i].op==3)ans[s[i].id]=st.query(s[i].id);\n\t\t\t//printf(\"st : \");st.print(st.rt);printf(\"\\n\");\n\t\t}\n\t}\n\tfor(int j=h[x];j;j=nxt[j])if(p[j]!=fa[x])solvedown(p[j]);\n} \nint main()\n{\n\tscanf(\"%d%d%d\",&n,&m,&c);\n\tfor(int i=1;i<=m;i++)rnk[i]=c+2;\n\tfor(int i=1;i<=c;i++)scanf(\"%d\",P+i),rnk[P[i]]=i;\n\tfor(int i=1;i<=n;i++)scanf(\"%d\",w+i),w[i]=rnk[w[i]];\n\tfor(int i=1;i<n;i++)scanf(\"%d%d\",&u,&v),add_edge(u,v),add_edge(v,u);\n\tdep[1]=1;dfs1(1);dfs2(1,1);\n\t//for(int i=1;i<=n;i++)printf(\"%d \",dfn[i]);printf(\"\\n\");\n\tscanf(\"%d\",&q);\n\tfor(int i=1;i<=q;i++)\n\t{\n\t\tscanf(\"%d%d\",&u,&v);\n\t\twhile(top[u]!=top[v])\n\t\t{\n\t\t\tif(dep[top[u]]>dep[top[v]])g[top[u]].push_back((node){dfn[u],dfn[top[u]],i,0}),u=fa[top[u]];\n\t\t\telse g[top[v]].push_back((node){dfn[top[v]],dfn[v],i,1}),v=fa[top[v]];\n\t\t}\n\t\tif(dfn[u]>=dfn[v])g[top[u]].push_back((node){dfn[u],dfn[v],i,0});\n\t\telse g[top[u]].push_back((node){dfn[u],dfn[v],i,1});\n\t}\n\tsolveup(1);\n\tsolvedown(1);\n\tfor(int i=1;i<=q;i++)printf(\"%d\\n\",ans[i]);\n\treturn 0;\n} \n```",
        "postTime": 1618626252,
        "uid": 43486,
        "name": "hsfzLZH1",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P7468 \u3010[\u7701\u9009\u8054\u8003 2021 A/B \u5377] \u5b9d\u77f3\u3011"
    },
    {
        "content": "## P7518 [\u7701\u9009\u8054\u8003 2021 A/B \u5377] \u5b9d\u77f3\n\n\u9996\u5148\uff0c\u7531\u4e8e $P$ \u5404\u4e0d\u76f8\u540c\uff0c\u4e00\u4e2a\u8282\u70b9\u4f1a\u5bf9\u5e94 $P$ \u4e0a\u7684\u552f\u4e00\u4f4d\u7f6e\uff0c\u4ee4 $u$ \u8282\u70b9\u7684\u989c\u8272\u7684\u4f4d\u7f6e\u4e3a $match_u$\u3002\u90a3\u4e48\u6211\u4eec\u5c31\u6709\u4e00\u4e2a\u666e\u901a\u7684\u500d\u589e\u60f3\u6cd5\uff1a\u4ee4 $f_{u,i}$ \u8868\u793a\u4ece $u$ \u5f00\u59cb\uff0c\u5411\u6839\u8d70\uff0c\u4ece $match_u$ \u5339\u914d\u5230 $match_u + 2^i$ \u7ed3\u675f\u7684\u6811\u4e0a\u8282\u70b9\u3002\n\n\u8003\u8651\u5982\u4f55\u5904\u7406 $f_{u,0}$\uff0c\u5373\u5230\u6839\u7b2c\u4e00\u4e2a $match=match_u+1$ \u7684\u4f4d\u7f6e\uff0c\u53ef\u4ee5\u901a\u8fc7 dfs \u65f6\u8bb0\u5f55\u6700\u8fd1\u7684\u5404\u79cd\u989c\u8272\u5e76\u56de\u6eaf\u89e3\u51b3\u3002\n\n\u8fd9\u6837\u6211\u4eec\u5c31\u5b8c\u6210\u4e86\u4e00\u6b21\u8be2\u95ee $u\\rightarrow LCA$ \u7684\u90e8\u5206\uff0c\u63a5\u4e0b\u6765\u8003\u8651 $LCA\\rightarrow v$\uff0c\u5012\u7740\u500d\u589e\u4e0d\u597d\u5904\u7406\uff0c\u8003\u8651\u4e8c\u5206\u7b54\u6848\u5411\u4e0a\u8df3\uff0c\u4ee4 $g_{u,i}$ \u8868\u793a $u$ \u4ece $match_u$ \u8df3\u5230 $match_u - 2^i$ \u4f1a\u8df3\u5230\u54ea\u3002\n\n\u4e8c\u5206\u4e00\u4e2a\u7b54\u6848 $mid$\uff0c\u5e76\u4ece $match=mid$ \u5f00\u59cb\u8df3\uff0c\u5982\u679c $s\\rightarrow LCA$ \u548c $LCA\\rightarrow t$ \u5982\u679c\u5e76\u8d77\u6765\u5927\u4e8e\u5f53\u524d\u4e8c\u5206\u7684\u7b54\u6848\uff0c\u5219\u5408\u6cd5\u3002\n\n\u95ee\u9898\u5c31\u53d8\u6210\u4e86\u5982\u679c\u5bf9\u4e8c\u5206\u7684\u4e00\u4e2a $mid$ \u627e\u51fa $v$ \u7956\u5148\u7684\u7b2c\u4e00\u4e2a\u4f4d\u7f6e\u6ee1\u8db3 $match=mid$\uff0c\u53ef\u4ee5\u7528\u548c $f_{u,0}$ \u540c\u6837\u7684\u65b9\u5f0f\uff0c\u628a\u64cd\u4f5c\u79bb\u7ebf\uff0c\u6302\u5728 $t$ \u4e0a\uff0c\u518d dfs \u56de\u6eaf\u4e00\u904d\u5373\u53ef\uff0c\u603b\u590d\u6742\u5ea6 $O(n\\log n+q\\log^2n)$\uff0c\u5f53\u7136\u4e0d\u79bb\u7ebf\u7684\u8bdd\u53ef\u4ee5\u4e3b\u5e2d\u6811\uff0c\u590d\u6742\u5ea6\u662f\u4e00\u6837\u7684\n\n\u653e\u4e00\u4e0b\u8003\u573a\u4ee3\u7801\uff0c\u62cd\u4e86\u4e24\u4e07\u7ec4\uff0c\u6240\u6709\u6c11\u95f4\u6570\u636e\u90fd\u8fc7\u4e86\uff08\n```cpp\n#include <bits/stdc++.h>\n\nusing namespace std;\n\ntypedef long long ll;\n#define rg register\n#define rep(i, s, t) for(rg int i = (s); i <= (t); i++)\n#define per(i, s, t) for(rg int i = (t); i >= (s); i--)\n#define mp make_pair\n#define pb push_back\n#define fi first\n#define se second\n\nconst int N = 2e5 + 5;\nconst int M = 2e5 + 5;\n\nint anc[N][21], f[N][21], g[N][21], dep[N], last1[N], last2[N], lastpos[N];\nint head[N], nxt[N<<1], to[N<<1], tot;\nint match[N], pos[N];\nint n, m, c;\nint w[N], p[N];\nint ans[N];\nvector<pair<int, int> > qry[N];\n\ninline void addedge(int u, int v) {\n  nxt[++tot] = head[u];\n  to[tot] = v;\n  head[u] = tot;\n}\n\ninline void dfs1(int u, int fat) {\n  dep[u] = dep[fat] + 1;\n  last1[u] = p[1] == w[u] ? u : last1[fat];\n  last2[u] = p[c] == w[u] ? u : last2[fat];\n  anc[u][0] = fat;\n\n  f[u][0] = lastpos[match[u]+1];\n  g[u][0] = lastpos[match[u]-1];\n\n  rep(i, 1, 20) anc[u][i] = anc[anc[u][i-1]][i-1];\n  rep(i, 1, 20) f[u][i] = f[f[u][i-1]][i-1];\n  rep(i, 1, 20) g[u][i] = g[g[u][i-1]][i-1];\n\n  int x = lastpos[match[u]];\n  lastpos[match[u]] = u;\n\n  for(rg int e = head[u]; e; e = nxt[e]) {\n    rg int v = to[e];\n    if(v != fat) {\n      dfs1(v, u);\n    }\n  }\n\n  lastpos[match[u]] = x;\n}\n\ninline int LCA(int x, int y) {\n  if(dep[x] < dep[y]) swap(x, y);\n  per(i, 0, 20) if(dep[anc[x][i]] >= dep[y]) x = anc[x][i];\n  if(x == y) return x;\n  per(i, 0, 20) if(anc[x][i] != anc[y][i]) x = anc[x][i], y = anc[y][i];\n  return anc[x][0];\n}\n\ninline bool check(int u, int x, int y, int lca) {\n  int res = 0;\n  if(dep[lastpos[x]] >= dep[lca]) {\n    u = lastpos[x];\n    res = 1;\n    per(i, 0, 20) {\n      if(dep[g[u][i]] >= dep[lca]) {\n\tres += (1<<i);\n\tu = g[u][i];\n      }\n    }\n  }\n  return res + y >= x;\n}\n\ninline int solve(int s, int t) {\n  int lca = LCA(s, t);\n  int k = 0, s0 = s, t0 = t;\n  if(dep[last1[s]] >= dep[lca]) {\n    k = 1;\n    s = last1[s];\n    per(i, 0, 20) {\n      if(dep[f[s][i]] >= dep[lca]) {\n\tk += (1<<i);\n\ts = f[s][i];\n      }\n    }\n  } else {\n    s = -1;\n  }\n  int L = k+1, R = m;\n  int res = k;\n  while(L <= R) {\n    rg int mid = L + R >> 1;\n    if(check(t, mid, k, lca)) {\n      res = mid;\n      L = mid + 1;\n    } else {\n      R = mid - 1;\n    }\n  }\n  return res;\n}\n\ninline void dfs2(int u, int fat) {\n  int x = lastpos[match[u]];\n  lastpos[match[u]] = u;\n  rep(i, 0, (int)qry[u].size()-1) {\n    ans[qry[u][i].fi] = solve(qry[u][i].se, u);\n  }\n  for(rg int e = head[u]; e; e = nxt[e]) {\n    rg int v = to[e];\n    if(v != fat) {\n      dfs2(v, u);\n    }\n  }\n  lastpos[match[u]] = x;\n}\n\nint main() {\n  freopen(\"gem.in\", \"r\", stdin);\n  freopen(\"gem.out\", \"w\", stdout);\n  scanf(\"%d%d%d\", &n, &m, &c);\n  rep(i, 1, c) {\n    scanf(\"%d\", &p[i]);\n    pos[p[i]] = i;\n  }\n  rep(i, 1, n) scanf(\"%d\", &w[i]);\n  rep(i, 1, n) match[i] = pos[w[i]];\n  rep(i, 1, n-1) {\n    int u, v;\n    scanf(\"%d%d\", &u, &v);\n    addedge(u, v);\n    addedge(v, u);\n  }\n  dfs1(1, 0);\n  int q; scanf(\"%d\", &q);\n  rep(i, 1, q) {\n    int s, t;\n    scanf(\"%d%d\", &s, &t);\n    qry[t].pb(mp(i, s));\n  }\n  dfs2(1, 0);\n  rep(i, 1, q) printf(\"%d\\n\", ans[i]);\n  fclose(stdin);\n  fclose(stdout);\n  return 0;\n}\n```",
        "postTime": 1618301200,
        "uid": 95103,
        "name": "KellyFrog",
        "ccfLevel": 9,
        "title": "P7518 [\u7701\u9009\u8054\u8003 2021 A/B \u5377] \u5b9d\u77f3"
    },
    {
        "content": "\u8003\u573a\u4e0a\u5c31\u6253\u4e86 $70pts$ \u7684\u66b4\u529b\uff0c\u56de\u5934\u518d\u770b\u8fd8\u662f\u6bd4\u8f83\u7b80\u5355\u7684\n\n\u9488\u5bf9 $m\\leq 300$ \u7684\u6570\u636e\uff0c\u8003\u573a\u4e0a\u5199\u4e86\u4e2a $\\Theta (qm\\log m)$ \u7684\u505a\u6cd5\n\n\u5927\u6982\u601d\u8def\u662f\uff0c\u9488\u5bf9\u6bcf\u6b21\u8be2\u95ee\uff0c\u9996\u5148\u6c42\u51fa $u$ \u548c $v$ \u7684 $lca$\n\n\u5148\u8003\u8651\u4ece $u$ \u5f80\u4e0a\u8dd1\u5230 $lca$ \u7684\u8fd9\u6bb5\u8def\u7a0b\uff0c\u6211\u4eec\u53ef\u4ee5\u9884\u5904\u7406\u51fa\u6bcf\u4e2a\u8282\u70b9\u5f80\u4e0a\uff0c\u8ddd\u79bb\u5b83\u6700\u8fd1\u7684\u6bcf\u4e2a\u989c\u8272\u7684\u8282\u70b9\u662f\u4ec0\u4e48\uff0c\u56e0\u4e3a $m\\leq 300$\uff0c\u6240\u4ee5\u53ef\u4ee5\u76f4\u63a5\u5f00\u4e2a\u6570\u7ec4\u5b58\u4e0b\u6765\uff0c$DFS$ \u65f6\u4ece\u7236\u4eb2\u7ee7\u627f\u4e0b\u6765\u5373\u53ef\uff0c\u7136\u540e\u8be2\u95ee\u65f6\u76f4\u63a5\u7528\u8fd9\u4e2a\u6570\u7ec4\u66b4\u8df3\u5373\u53ef\uff0c\u76f4\u5230\u8df3\u5230\u8ddd $lca$ \u6700\u8fd1\u7684\u8282\u70b9\uff0c\u8fd9\u6837\u53ef\u4ee5\u6c42\u51fa\u4e00\u534a\u7684\u7b54\u6848 $ans$\n\n\u7136\u540e\u8003\u8651\u4ece $lca$ \u5f80\u4e0b\u8dd1\u5230 $v$ \u7684\u8fd9\u6bb5\u8def\u7a0b\uff0c\u7136\u800c\u9884\u5904\u7406\u51fa\u5411\u4e0b\u7684\u6570\u7ec4\u4e0d\u662f\u5f88\u597d\u5b9e\u73b0\uff0c\u4e0d\u59a8\u4e8c\u5206\u4e00\u4e2a\u503c $mid$\uff0c\u6bcf\u6b21\u4ece $v$ \u5f80\u4e0a\u66b4\u8df3\uff0c\u5224\u65ad\u662f\u5426\u80fd\u8df3\u5230\u4e0a\u9762\u6c42\u51fa\u7684\u7b54\u6848 $ans$\uff0c\u5982\u679c\u8df3\u4e0d\u5230\uff0c\u7b54\u6848\u663e\u7136\u6bd4 $mid$ \u5c0f\uff0c\u5426\u5219\u6bd4 $mid$ \u5927\n\n\u4e0d\u8fc7\u590d\u6742\u5ea6\u597d\u50cf\u5f88\u5371\uff0c$m\\leq 300$ \u5e76\u4e0d\u80fd\u62ff\u5168\n\n\u4e0d\u59a8\u4e00\u6b65\u6b65\u4f18\u5316\u4e0a\u9762\u90a3\u4e2a\u505a\u6cd5\n\n* \u9884\u5904\u7406\u5f80\u4e0a\u6700\u8fd1\u7684\u6bcf\u4e2a\u989c\u8272\u7684\u8282\u70b9\n\n$m\\leq 300$ \u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u5f00\u6570\u7ec4\u8bb0\u4e0b\u6765\uff0c\u4f46\u662f\u73b0\u5728 $m$ \u5f88\u5927\uff0c\u6570\u7ec4\u5f00\u4e0d\u4e0b\uff0c\u53ef\u4ee5\u7528\u6811\u4e0a\u4e3b\u5e2d\u6811\u4ee3\u66ff\u8fd9\u4e2a\u6570\u7ec4\uff0c\u65f6\u7a7a\u590d\u6742\u5ea6\u5c31\u5f88\u6b63\u786e\u4e86\n\n* \u66b4\u8df3\n\n$m$ \u548c $c$ \u90fd\u5f88\u5927\u4e86\uff0c\u66b4\u8df3\u590d\u6742\u5ea6\u5c31\u4e0d\u5bf9\u4e86\n\n\u4e0d\u59a8\u501f\u7528\u500d\u589e $lca$ \u7684\u601d\u8def\uff0c\u5b9a\u4e49 $f0[u][i]$ \u8868\u793a $u$ \u5411\u4e0a\u8df3\uff0c\u989c\u8272\u5e8f\u5217\u589e\u52a0 $2^i$ \u6240\u5230\u7684\u8282\u70b9\uff0c$f1[u][i]$ \u8868\u793a $u$ \u5411\u4e0a\u8df3\uff0c\u989c\u8272\u5e8f\u5217\u51cf\u5c11 $2^i$ \u6240\u5230\u7684\u8282\u70b9\n\n\u8fd9\u6837\u4ece $u$ \u5f80\u4e0a\u8dd1\u548c\u4ece $lca$ \u5f80\u4e0b\u8dd1\u90fd\u53ef\u4ee5\u500d\u589e\u89e3\u51b3\u4e86\n\n\u6700\u540e\u590d\u6742\u5ea6\u662f $\\Theta (n\\log n+q\\log n\\log m)$ \u7684\n\n## \u4ee3\u7801\n\n```c++\n#include <cstdio>\n#include <cstring>\n#include <iostream>\n#include <algorithm>\n\nusing namespace std;\n\nconst int maxn = 2e5 + 50, INF = 0x3f3f3f3f;\n\ninline int read () {\n\tregister int x = 0, w = 1;\n\tregister char ch = getchar ();\n\tfor (; ch < '0' || ch > '9'; ch = getchar ()) if (ch == '-') w = -1;\n\tfor (; ch >= '0' && ch <= '9'; ch = getchar ()) x = x * 10 + ch - '0';\n\treturn x * w;\n}\n\nint n, m, q, c, nodecnt;\nint mp[maxn], col[maxn], root[maxn], f0[maxn][21], f1[maxn][21];\nint f[maxn], size[maxn], son[maxn], deep[maxn], top[maxn];\n\nstruct Tree {\n\tint lch, rch, pos;\n} tree[maxn * 36];\n\ninline void Build (register int &rt, register int l, register int r) {\n\ttree[++ nodecnt] = tree[rt], rt = nodecnt;\n\tif (l == r) return tree[rt].pos = -1, void ();\n\tregister int mid = (l + r) >> 1;\n\tBuild (tree[rt].lch, l, mid), Build (tree[rt].rch, mid + 1, r);\n}\n\ninline void Modify (register int &rt, register int l, register int r, register int x, register int pos) {\n\ttree[++ nodecnt] = tree[rt], rt = nodecnt;\n\tif (l == r) return tree[rt].pos = pos, void ();\n\tregister int mid = (l + r) >> 1;\n\tif (x <= mid) Modify (tree[rt].lch, l, mid, x, pos);\n\telse Modify (tree[rt].rch, mid + 1, r, x, pos);\n}\n\ninline int Query (register int rt, register int l, register int r, register int x) {\n\tif (l == r) return tree[rt].pos;\n\tregister int mid = (l + r) >> 1;\n\tif (x <= mid) return Query (tree[rt].lch, l, mid, x);\n\telse return Query (tree[rt].rch, mid + 1, r, x);\n}\n\nstruct Edge {\n\tint to, next;\n} e[maxn << 1];\n\nint tot, head[maxn];\n\ninline void Add (register int u, register int v) {\n\te[++ tot].to = v;\n\te[tot].next = head[u];\n\thead[u] = tot;\n}\n\ninline void DFS0 (register int u, register int fa) {\n\tdeep[u] = deep[fa] + 1, size[u] = 1, root[u] = root[fa];\n\tif (col[u] != -1) Modify (root[u], 1, c, col[u], u);\n\tif (col[u] == -1 || col[u] == c) f0[u][0] = -1;\n\telse f0[u][0] = Query (root[u], 1, c, col[u] + 1);\n\tif (col[u] == -1 || col[u] == 1) f1[u][0] = -1;\n\telse f1[u][0] = Query (root[u], 1, c, col[u] - 1);\n\tfor (register int i = 1; (1 << i) <= c - col[u]; i ++) f0[u][i] = f0[f0[u][i - 1]][i - 1];\n\tfor (register int i = 1; (1 << i) <= col[u] - 1; i ++) f1[u][i] = f1[f1[u][i - 1]][i - 1];\n\tfor (register int i = head[u]; i; i = e[i].next) {\n\t\tregister int v = e[i].to;\n\t\tif (v == fa) continue;\n\t\tf[v] = u, DFS0 (v, u), size[u] += size[v];\n\t\tif (size[son[u]] < size[v]) son[u] = v;\n\t}\n}\n\ninline void DFS1 (register int u, register int t) {\n\ttop[u] = t;\n\tif (son[u]) DFS1 (son[u], t);\n\tfor (register int i = head[u]; i; i = e[i].next) {\n\t\tregister int v = e[i].to;\n\t\tif (v == f[u] || v == son[u]) continue;\n\t\tDFS1 (v, v);\n\t}\n}\n\ninline int LCA (register int u, register int v) {\n\twhile (top[u] != top[v]) {\n\t\tif (deep[top[u]] < deep[top[v]]) swap (u, v);\n\t\tu = f[top[u]];\n\t}\n\treturn deep[u] < deep[v] ? u : v;\n}\n\ninline bool Check (register int u, register int fa, register int lim, register int l) {\n\tu = Query (root[u], 1, c, lim);\n\tif (u == -1 || deep[u] < deep[fa]) return 0;\n\tfor (register int i = 20; i >= 0; i --) \n\t\tif (f1[u][i] != -1 && deep[f1[u][i]] > deep[fa]) u = f1[u][i];\n\treturn col[u] <= l;\n}\n\nint main () {\n\tn = read(), m = read(), c = read(), memset (mp, -1, sizeof mp);\n\tfor (register int i = 1; i <= c; i ++) mp[read()] = i;\n\tfor (register int i = 1; i <= n; i ++) col[i] = mp[read()];\n\tfor (register int i = 1, u, v; i <= n - 1; i ++) u = read(), v = read(), Add (u, v), Add (v, u);\n\tBuild (root[0], 1, c), DFS0 (1, 0), DFS1 (1, 1), q = read();\n\twhile (q --) {\n\t\tregister int u = read(), v = read(), lca = LCA (u, v), ans = 0;\n\t\tu = Query (root[u], 1, c, 1);\n\t\tif (u != -1 && deep[u] >= deep[lca]) {\n\t\t\tfor (register int i = 20; i >= 0; i --) \n\t\t\t\tif (f0[u][i] != -1 && deep[f0[u][i]] >= deep[lca]) u = f0[u][i];\n\t\t\tans = col[u];\n\t\t} else ans = 0;\n\t\tregister int l = ans + 1, r = c;\n\t\twhile (l <= r) {\n\t\t\tregister int mid = (l + r) >> 1;\n\t\t\tif (Check (v, lca, mid, ans + 1)) l = mid + 1;\n\t\t\telse r = mid - 1;\n\t\t}\n\t\tprintf (\"%d\\n\", l - 1);\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1618837879,
        "uid": 335193,
        "name": "Rubyonly",
        "ccfLevel": 8,
        "title": "[\u7701\u9009\u8054\u8003 2021 A/B \u5377] \u5b9d\u77f3"
    },
    {
        "content": "[\u6d1b\u8c37\u9898\u9762\u4f20\u9001\u95e8](https://www.luogu.com.cn/problem/P7518)\u3002\n\n\u9898\u610f\uff1a\n\n* \u7ed9\u5b9a $n, m, c$\u3001\u4e00\u4e2a\u957f\u4e3a $c$ \u7684\u5e8f\u5217 $p_i$ \u548c \u4e00\u68f5\u70b9\u6743\u5206\u522b\u4e3a $w_i$ \u7684\u4e00\u68f5\u6811\uff0c\u5176\u4e2d $p_i \\le m$ \u4e14\u4e92\u4e0d\u76f8\u540c\u3002\n\n* $q$ \u7ec4\u8be2\u95ee\uff0c\u6bcf\u6b21\u7ed9\u5b9a $s, t$\uff0c\u5bfb\u95ee\u6811\u4e0a $s$ \u5230 $t$ \u7684\u8def\u5f84\u7684 $w_i$ \u7ec4\u6210\u7684\u4e00\u6761\u5e8f\u5217\u4e0e $p$ \u5e8f\u5217\u4ece\u5934\u5f00\u59cb\u6700\u957f\u5339\u914d\u5b50\u5e8f\u5217\u957f\u5ea6\u4e3a\u591a\u5c11\u3002\n\n* $n, q \\le 2\\times 10^5$\uff0c$c\\le m \\le 5\\times 10^4$\u3002\n\n\u4e2a\u4eba\u8ba4\u4e3a\u7b97\u662f\u7701\u9009\u5f53\u4e2d\u7b2c\u4e8c\u7b80\u5355\u7684\u9898\u4e86\uff0c\u4e0d\u8fc7\u6709\u4e9b\u7801\u519c\uff08\n\n---\n\n### Solution\uff1a\n\n\u6211\u4eec\u4e0d\u59a8\u8003\u8651\u5c06\u6bcf\u4e2a\u5e8f\u5217\u62c6\u6210 $s\\rightarrow lca$ \u548c $lca\\rightarrow t$ \u4e24\u6761\u94fe\u3002\n\n\u5bf9\u4e8e $s\\rightarrow lca$\uff1a\n\n\u6211\u4eec\u5bf9\u6bcf\u79cd\u6743\u503c\u7ef4\u62a4\u4e00\u4e2a\u6808\uff0c\u6808\u91cc\u8868\u793a\u6839\u5230\u5f53\u524d\u70b9\u4e0a\u6bcf\u79cd\u6743\u503c\u6709\u54ea\u4e9b\u70b9\uff0c\u4ece\u6839\u8282\u70b9\u5f00\u59cb\u641c\u7d22\uff0c\u5f53\u641c\u5230\u4e00\u4e2a\u70b9 $u$ \u7684\u65f6\u5019\u5c31\u67e5\u627e\u5b83\u7684\u6743\u503c\u5728 $p$ \u5e8f\u5217\u4e2d\u5bf9\u5e94\u7684\u662f\u54ea\u4e00\u4e2a\u4f4d\u7f6e\uff0c\u5e76\u627e\u51fa\u8fd9\u4e2a\u5bf9\u5e94\u4f4d\u7f6e\u4e0b\u4e00\u4e2a\u4f4d\u7f6e\u7684\u4e0a\u7684\u6743\u503c\u7684\u6808\u9876\u4e0a\u7684\u70b9\uff0c\u5e76\u5c06\u5176\u8bb0\u4e3a $suf_u$\uff0c\u5982\u679c\u6ca1\u6709\u5219 $suf_u = 0$\u3002\n\n\u4e0d\u59a8\u4e3e\u4e00\u4e2a\u4f8b\u5b50\uff08\u5176\u5b9e\u662f\u6837\u4f8b\uff09\uff0c\u6bcf\u4e2a\u70b9\u62ec\u53f7\u5185\u7684\u6570\u8868\u793a\u5b83\u7684\u6743\u503c\uff0c$\\{q_i\\} = \\{2, 3, 1\\}$\uff1a\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/2bjq6d6n.png)\n\n\u5728\u8fd9\u5e45\u56fe\u4e2d\uff0c\u70b9 $3$ \u7684\u6743\u503c\u4e3a $3$\uff0c\u5728 $q$ \u5e8f\u5217\u4e2d\u7b2c $2$ \u4e2a\u4f4d\u7f6e\uff0c\u4e8e\u662f\u6211\u4eec\u67e5\u627e\u7b2c\u4e09\u4e2a\u4f4d\u7f6e\u7684\u6743\u503c\u7684\u6808\u9876\uff0c\u5373\u6743\u503c $1$ \u7684\u6808\u9876\uff0c\u53d1\u73b0\u662f $2$\uff0c\u4e8e\u662f $suf_3 = 2$\u3002\n\n\u540c\u7406\u6709 $suf_1 = 0, suf_2 = 0, suf_4 = 0, suf_5 = 4, suf_6 = 0, suf_7 = 6$\u3002\n\n\u540c\u65f6\uff0c\u6211\u4eec\u8bb0\u5f55\u5f53\u524d\u6808\u4e2d\u6743\u503c $p_1$ \u6808\u9876\u7684\u70b9\uff0c\u8bb0\u4e3a $fir_u$\uff0c\u6bd4\u5982\u5728\u4e0a\u56fe\u4e2d\uff0c\u6709 $fir_1 = 1, fir_2 = 1, fir_3 = 1, fir_4 = 1, fir_5 = 5, fir_6 = 1, fir_7 = 1$\u3002\n\n\u90a3\u4e48\uff0c\u6211\u4eec\u5efa\u4e00\u68f5\u65b0\u7684\u6811\uff0c\u5176\u4e2d\u5bf9\u4e8e\u6bcf\u4e00\u7ec4 $(u, suf_u)$\uff0c\u6709\u8fde\u8fb9 $suf_u \\rightarrow u$\u3002\n\n\u90a3\u4e48\uff0c\u5bf9\u4e8e\u8d77\u70b9 $s$\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5148\u8ba9 $s$ \u8d70\u5230 $fir_s$\uff0c\u7136\u540e\u5728\u65b0\u7684\u6811\u4e0a\u4e00\u76f4\u5411\u4e0a\u722c\uff0c\u722c\u5230\u5b83\u7684\u6df1\u5ea6\u4f4e\u4e8e\u4e86 $lca$ \u4e3a\u6b62\u3002\u800c\u8fd9\u4e2a\u722c\u7684\u5b9e\u73b0\u5c31\u662f\u500d\u589e\u9884\u5904\u7406\u65b0\u6811\u4e0a $2^k$ \u7ea7\u7956\u5148\u3002\u8fd9\u6837 $s\\rightarrow lca$ \u5c31\u641e\u5b9a\u4e86\u3002\n\n\u5bf9\u4e8e $lca \\rightarrow t$\uff1a\n\n\u6211\u4eec\u8003\u8651\u628a\u6240\u6709 $lca \\rightarrow t$ \u7684\u8be2\u95ee\u79bb\u7ebf\u4e0b\u6765\uff0c\u4ee5 $t$ \u4e3a\u5173\u952e\u503c\u6765\u5206\u7c7b\u6240\u6709\u7684\u8be2\u95ee\u3002\u6211\u4eec\u4ece\u6839\u8282\u70b9\u51fa\u53d1\uff0c\u7167\u6837\u7ef4\u62a4\u6bcf\u79cd\u6743\u503c\u7684\u4e00\u4e2a\u6808\uff0c\u53ea\u4e0d\u8fc7\u6211\u4eec\u8981\u8bb0\u5f55\u7684\u5219\u662f\u5f53\u524d\u8282\u70b9 $u$ \u6240\u5728 $p$ \u5e8f\u5217\u4f4d\u7f6e\u7684\u4e0a\u4e00\u4e2a\u4f4d\u7f6e\u7684\u6743\u503c\u7684\u6808\u9876\u8282\u70b9\uff0c\u8bb0\u4e3a $pre_u$\uff0c\u6ca1\u6709\u5219\u4ecd\u7136\u6709 $pre_u = 0$\u3002\n\n\u6bd4\u5982\u5728\u4e0a\u9762\u90a3\u4e2a\u4f8b\u5b50\u4e2d\uff0c\u6709 $pre_1 = 0, pre_2 = 0, pre_3 = 1, pre_4 = 1, pre_5 = 0, pre_6 = 4, pre_7 = 1$\u3002\n\n\u540c\u6837\uff0c\u6211\u4eec\u518d\u5efa\u4e00\u68f5\u65b0\u7684\u6811\uff0c\u5176\u4e2d\u5bf9\u4e8e\u6bcf\u4e00\u7ec4 $(u, pre_u)$\uff0c\u6709\u8fde\u8fb9 $pre_u \\rightarrow u$\u3002\n\n\u8003\u8651\u4e8c\u5206\u7b54\u6848\uff0c\u4e8c\u5206\u5f53\u524d\u80fd\u8d70\u5230 $p$ \u5e8f\u5217\u4e0a\u7684\u4f4d\u7f6e $mid$\u3002\u9996\u5148\u6211\u4eec\u4ece $t$ \u8df3\u5230\u6743\u503c $p_{mid}$ \u7684\u6808\u9876\u3002\u7136\u540e\u50cf\u521a\u624d\u4e00\u6837\u5728\u65b0\u6811\u4e0a\u500d\u589e\u8df3\u7956\u5148\uff0c\u76f4\u5230\u8df3\u5230 $s\\rightarrow lca$ \u65f6\u6700\u8fdc\u80fd\u8df3\u5230\u7684\u4f4d\u7f6e\u3002\u5982\u679c\u8fd9\u4e2a\u70b9\u6df1\u5ea6\u6bd4 $lca$ \u5c0f\uff0c\u90a3\u5c31\u4e0d\u884c\uff0c\u5426\u5219\u53ef\u4ee5\u3002\n\n\u6700\u540e\u7684\u7b54\u6848\u5c31\u662f\u4e24\u90e8\u5206\u76f8\u52a0\u3002\n\n\u5f53\u7136\u8fd8\u6709\u53e6\u5916\u4e00\u79cd\u505a\u6cd5\uff0c\u8003\u8651\u5e8f\u5217\u4e0a\u7684\u600e\u4e48\u505a\uff0c\u5c31\u662f\u50cf\u521a\u624d\u90a3\u6837\u627e $pre$ \u548c $suf$\uff0c\u63a5\u7740\u6811\u5256\u628a\u4e00\u4e2a\u94fe\u5256\u6210 $\\log n$ \u4e2a\u533a\u95f4\uff0c\u6bcf\u4e2a\u533a\u95f4\u5355\u72ec\u500d\u589e\u5904\u7406\u5c31\u884c\u3002\n\nover\uff0c\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n\\log n\\log m)$\uff0c\u9ed8\u8ba4 $n, q$ \u540c\u9636\uff0c$m, c$ \u540c\u9636\u3002\n\n---\n\n### Code\uff1a\n\n\u5b9e\u73b0\u7684\u65f6\u5019\u591a\u6ce8\u610f\u7ec6\u8282\uff0c\u56e0\u4e3a\u4e2a\u4eba\u5199\u5f97\u6709\u4e9b\u7801\u519c\u3002\n\n```cpp\n#include <iostream>\n#include <cstdio>\n#include <algorithm>\n#include <cstring>\n#include <cmath>\n#include <vector>\n#include <queue>\n#include <map>\n#include <set>\nusing namespace std;\n#define ll long long\n#define ull unsigned long long\n#define fi first\n#define se second\n#define dingyi int mid = l + r >> 1, ls = p << 1, rs = p << 1 | 1\n#define y0 y_csyakioi_0\n#define y1 y_csyakioi_1\n#define rep(i, x, y) for(int i = x; i <= y; ++i)\n#define per(i, x, y) for(int i = x; i >= y; --i)\n#define repg(i, u) for(int i = head[u]; i; i = e[i].nxt)\ninline int read(){\n\tint x = 0, f = 1; char ch = getchar();\n\twhile(ch < '0' || ch > '9'){ if(ch == '-') f = -1; ch = getchar(); }\n\twhile(ch >= '0' && ch <= '9'){ x = x * 10 + (ch ^ 48); ch = getchar(); }\n\treturn x * f;\n}\nconst int N = 200010, M = 50010;\nstruct edge{\n\tint v, nxt;\n}e[N << 1], e2[N << 1];\nstruct node{\n\tint u, v, lca;\n\tnode(int a = 0, int b = 0, int c = 0){\n\t\tu = a; v = b; lca = c;\n\t}\n}Q[N];\nint head[N], head2[N], cnt, cnt2, n, m, k, q, p[N], c[N], x, y, z;\nint dep[N], posp[N], suf1[N], suf2[N], f[N][20], R[N], f2[N][20], ans[N];\nbool canbe[N], vis[N];\nvector <int> pos[N], ask[N];\ninline void add(int u, int v){\n\te[++cnt].v = v;\n\te[cnt].nxt = head[u];\n\thead[u] = cnt;\n}\ninline void add2(int u, int v){\n\te2[++cnt2].v = v;\n\te2[cnt2].nxt = head2[u];\n\thead2[u] = cnt2;\n}\ninline void dfs1(int u, int fa){\n\tdep[u] = dep[fa] + 1; f[u][0] = fa;\n\trep(i, 1, 17) f[u][i] = f[f[u][i - 1]][i - 1];\n\tpos[c[u]].push_back(u);\n\tif((int)pos[p[1]].size()) suf1[u] = (*(--pos[p[1]].end()));\n\tif(posp[c[u]] != n && (int)pos[p[posp[c[u]] + 1]].size()) suf2[u] = (*(--pos[p[posp[c[u]] + 1]].end()));\n\tif(suf2[u]){\n\t\tf2[u][0] = suf2[u];\n\t\trep(i, 1, 17) f2[u][i] = f2[f2[u][i - 1]][i - 1];\n\t}\n\trepg(i, u){\n\t\tint v = e[i].v; if(v == fa) continue;\n\t\tdfs1(v, u);\n\t}\n\tpos[c[u]].pop_back();\n}\ninline int lca(int x, int y){\n\tif(dep[x] < dep[y]) swap(x, y);\n\tper(i, 17, 0) if(dep[f[x][i]] >= dep[y]) x = f[x][i];\n\tif(x == y) return x;\n\tper(i, 17, 0) if(f[x][i] != f[y][i]) x = f[x][i], y = f[y][i];\n\treturn f[x][0];\n}\ninline void work(int idx){\n\tif(canbe[idx]){ R[idx] = 1; return; }\n\tint x = Q[idx].u, z = Q[idx].lca;\n\tint ans = 1;\n\tper(i, 17, 0) if(dep[f2[x][i]] >= dep[z]) x = f2[x][i], ans += (1 << i);\n\tR[idx] = ans + 1; return;\n}\ninline bool check(int idx, int mid){\n\tint y = Q[idx].v, z = Q[idx].lca, cur = y;\n\t//printf(\"%d %d %d %d\\n\", idx, y, z, mid);\n\tif(!(int)pos[p[mid]].size()) return 0;\n\tint x = (*(--pos[p[mid]].end()));\n\t//printf(\"%d\\n\", x);\n\tif(dep[x] < dep[z]) return 0; cur = x;\n\tint num = mid - R[idx];\n\tper(i, 17, 0) if(num >> i & 1) cur = f2[cur][i];\n\tif(!cur || dep[cur] < dep[z]) return 0;\n\treturn 1;\n}\ninline void dfs3(int u, int fa){\n\tpos[c[u]].push_back(u);\n\tif(posp[c[u]] != 1 && (int)pos[p[posp[c[u]] - 1]].size()) suf2[u] = (*(--pos[p[posp[c[u]] - 1]].end()));\n\tif(suf2[u]){\n\t\t//printf(\"%d %d\\n\", u, suf2[u]);\n\t\tf2[u][0] = suf2[u];\n\t\trep(i, 1, 17) f2[u][i] = f2[f2[u][i - 1]][i - 1];\n\t}\n\tif((int)ask[u].size()) rep(t, 0, (int)ask[u].size() - 1){\n\t\tint idx = ask[u][t];\n\t\tint l = R[idx], r = k, Ans = 0;\n\t\twhile(l <= r){\n\t\t\tint mid = l + r >> 1;\n\t\t\tif(check(idx, mid)) Ans = mid, l = mid + 1;\n\t\t\telse r = mid - 1;\n\t\t}\n\t\tans[idx] = Ans;\n\t}\n\trepg(i, u){\n\t\tint v = e[i].v; if(v == fa) continue;\n\t\tdfs3(v, u);\n\t}\n\tpos[c[u]].pop_back();\n}\ninline void mian(){\n\tn = read(); m = read(); k = read();\n\trep(i, 1, k) p[i] = read();\n\trep(i, 1, n) c[i] = read();\n\trep(i, 1, n - 1){\n\t\tx = read(); y = read();\n\t\tadd(x, y); add(y, x);\n\t}\n\trep(i, 1, k) posp[p[i]] = i;\n\tdfs1(1, 0); q = read();\n\t//rep(i, 1, n) printf(\"%d %d %d\\n\", i, suf1[i], suf2[i]);\n\trep(i, 1, q){\n\t\tx = read(); y = read(); z = lca(x, y);\n\t\tx = suf1[x]; if(dep[x] < dep[z]) canbe[i] = 1, x = z;\n\t\t//printf(\"xcy %d %d %d\\n\", x, y, z);\n\t\tQ[i] = node(x, y, z);\n\t}\n\trep(i, 1, q) work(i);\n\trep(i, 1, q) ask[Q[i].v].push_back(i);\n\t//rep(i, 1, q) printf(\"%d\\n\", R[i]);\n\trep(i, 0, n) rep(j, 0, 17) f2[i][j] = 0;\n\trep(i, 0, n) suf1[i] = suf2[i] = 0;\n\tdfs3(1, 0);\n\trep(i, 1, q){\n\t\tif(!ans[i]) ans[i] = R[i] - 1;\n\t\tprintf(\"%d\\n\", ans[i]);\n\t}\n}\nint main(){ int qwq = 1; while(qwq--) mian(); return 0; }\n```\n",
        "postTime": 1618663971,
        "uid": 147999,
        "name": "Warriors_Cat",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P7518\u3010[\u7701\u9009\u8054\u8003 2021 A/B \u5377] \u5b9d\u77f3\u3011"
    },
    {
        "content": "[\u5b89\u5229\u4e2a\u4ebablog](https://www.cnblogs.com/Guts/p/14653041.html)\n\n\n\n------------\n\n\u611f\u89c9\u7b97\u662f\u6700\u7b80\u5355\u7684\u51e0\u79cd\u5199\u6cd5\u4e4b\u4e00\u4e86\uff0c\u53ea\u9700\u8981\u5206\u5757+\u6811\u5256\u3002  \n\u5982\u679c\u662f\u5728\u5e8f\u5217\u4e0a\uff0c\u8bb0\u5f55\u4e00\u4e2a\u6570\u7ec4 $nxt[i][j]$ \uff0c\u8868\u793a\u5728\u5757 $i$ \u7684\u5934\u4e0a\u4ee5\u6536\u96c6\u5668\u4e2d\u7b2c $j$ \u4e2a\u989c\u8272\u51fa\u53d1\uff0c\u79bb\u5f00\u5757\u5c3e\u4e4b\u540e\u7684\u6700\u591a\u80fd\u5230\u6536\u96c6\u5668\u4e2d\u7684\u7b2c\u51e0\u4e2a\u989c\u8272\u3002\uff08\u4e3a\u65b9\u4fbf\uff0c\u540e\u9762\u7684\u989c\u8272\u5c31\u76f4\u63a5\u6307\u7684\u662f\u5728\u6536\u96c6\u5668\u4e2d\u5bf9\u5e94\u7684\u4f4d\u7f6e\uff09    \n\n----------------\n\u8003\u8651\u5982\u4f55\u7ef4\u62a4\u8fd9\u4e2a\u4e1c\u897f\u3002\n\u7b49\u4ef7\u4e8e\u7ef4\u62a4\u4e00\u4e2a\u5757\u5185\u6700\u957f\u7684\u5f62\u5982 $x,x+1\\dots x+l$ \u5e8f\u5217\u7684\u6700\u957f\u957f\u5ea6\u662f\u591a\u5c11\u3002  \n\u4e0d\u96be\u53d1\u73b0\u53ef\u4ee5\u628a\u8fd9\u4e2a\u5e8f\u5217\u62c6\u6210 $x$ \u548c $x+1,x+2\\dots x+l$\u3002  \n\u56e0\u6b64\u8003\u8651\u5012\u8fc7\u6765\u505a\uff0c\u4ece\u540e\u5f80\u524d\u679a\u4e3e\u5f53\u524d\u7684\u4e0b\u6807\uff0c\u5982\u679c\u5f53\u524d\u7684\u989c\u8272\u662f $c_i$\uff0c\u5f53\u524d\u4ee5 $c_i$ \u5f00\u5934\u7684\u6700\u957f\u5e8f\u5217\u662f $S$ \u90a3\u4e48\u5c31\u770b $c_{i-1}+S$ \u662f\u4e0d\u662f\u6bd4\u5f53\u524d $c_{i-1}$ \u5f00\u5934\u7684\u5e8f\u5217\u66f4\u957f\u3002  \n\u540c\u65f6\uff0c\u56e0\u4e3a\u8fd8\u6709\u53ef\u80fd\u662f\u53cd\u8fc7\u6765\u8d70\u7684\uff0c\u6240\u4ee5\u8fd8\u8981\u8bb0\u5f55\u4e00\u4e0b\u53cd\u8fc7\u6765\u7684\u6570\u7ec4 $pre[i][j]$\u3002     \n\u5177\u4f53\u7684\u5b9e\u73b0\u53ef\u4ee5\u770b\u6700\u4e0b\u9762\u7684\u4ee3\u7801\u4e2d\u7684init\u51fd\u6570\u3002\n\n------------\n\u6811\u5256\u5b9e\u9645\u4e0a\u662f\u628a\u6811\u4e0a\u95ee\u9898\u8f6c\u6362\u6210\u5e8f\u5217\u95ee\u9898\uff0c\u5728\u6bcf\u4e00\u6761\u91cd\u94fe\u4e0a\u7684\u8be2\u95ee\u90fd\u53ef\u4ee5\u770b\u4f5c\u662f\u4e00\u4e2a\u4e09\u5143\u7ec4 $(l,r,c)$ \uff0c\u8868\u793a\u4ece $l$ \u5230 $r$ \u51fa\u53d1\uff0c\u521d\u59cb\u989c\u8272\u662f $c$ \u3002  \n\u8df3\u5230 $lca$ \u5904\u6700\u591a\u7ecf\u8fc7 $\\log n$ \u6761\u91cd\u94fe\uff0c\u6240\u4ee5\u6709\u4e00\u6b21\u8be2\u95ee\u7684\u590d\u6742\u5ea6  $\n\\left \\{\n\\begin{aligned}\n&\tO(T)=\\sum^{t}_{i=1}\\sqrt{a_i}\\\\\n&\t\\sum^{t}_{i=1}a_i \\leq n\\\\\n&\tt\\leq \\log n\\\\\n\\end{aligned}\n\\right.\n$ \n\n\u4e0d\u96be\u5f97\u5230\u4e0a\u9762\u7684\u6700\u52a3\u60c5\u51b5\u590d\u6742\u5ea6$\nO(T)=t\\sqrt{\\frac{n}{t}}=\\sqrt{nt}  \n$\u3002\n\n\u6240\u4ee5\u8fd9\u6837\u5b50\u7684\u603b\u590d\u6742\u5ea6\u662f$O(n\\sqrt{n}+q\\sqrt{n\\log n})$\uff0c\u800c\u4e14\u51e0\u4e4e\u8dd1\u4e0d\u6ee1\uff0c\u5728\u968f\u673a\u6570\u636e\u4e0b\u8dd1\u5f97\u8fd8\u633a\u5feb\uff0c\u6781\u9650\u6570\u636e\u5927\u6982\u8dd1$0.3 - 0.5s$\u3002  \n\u5b9e\u9645\u4e0a\uff0c\u8fd9\u4e2a\u8fd8\u53ef\u4ee5\u7ee7\u7eed\u4f18\u5316\u3002  \n\u8003\u8651\u6bcf\u4e00\u6761\u91cd\u94fe\uff0c\u5728\u94fe\u9876\u548c\u94fe\u5c3e\u4e5f\u50cf\u4e4b\u524d\u5206\u5757\u8fd9\u6837\u7ef4\u62a4\u6570\u7ec4 $nxt$ \u548c $pre$ \uff0c\u65f6\u7a7a\u590d\u6742\u5ea6\u5747\u4e3a $O(n\\log n)$\uff08\u8fd9\u91cc\u89c6 $n$ \uff0c$m$ \u540c\u9636\uff09\u3002  \n\u8fd9\u6837\uff0c\u6bcf\u6b21\u9700\u8981\u5728\u94fe\u4e0a\u66b4\u529b\u5206\u5757\u7684\u53ea\u5269\u4e0b\u4e86\u5f00\u5934\u548c\u7ed3\u5c3e\u4e24\u6839\uff0c\u5269\u4e0b\u7684\u90fd\u53ef\u4ee5 $O(1)$ \u8f6c\u79fb\uff0c\u603b\u590d\u6742\u5ea6\u4f18\u5316\u5230\u4e86 $O(n\\log n+q(\\sqrt{n}+\\log n))$  \n\u4e0d\u8fc7\u8003\u573a\u4e0a\u89c9\u5f97\u7b2c\u4e8c\u79cd\u592a\u9ebb\u70e6\u4e86\uff0c\u800c\u4e14\u7b2c\u4e00\u4e2a\u770b\u8d77\u6765\u80fd\u8fc7\uff0c\u518d\u52a0\u4e0a\u65f6\u95f4\u4e0d\u591f\uff0c\u5c31\u6ca1\u53bb\u4f18\u5316\u3002  \n\n\u4e0b\u9762\u8fd9\u4efd\u4ee3\u7801\u662f\u8003\u573a\u4e0a\u5199\u7684\uff0c\u7406\u8bba\u590d\u6742\u5ea6\u662f\u6709\u4e9b\u95ee\u9898\u7684\uff0c\u6b63\u786e\u7684\u5206\u5757\u9884\u5904\u7406\u65b9\u5f0f\u5e94\u8be5\u662f\u5bf9\u4e8e\u6bcf\u4e00\u6761\u91cd\u94fe\u90fd\u4ee5\u8be5\u91cd\u94fe\u7684\u957f\u5ea6\u7684\u6839\u53f7\u4e3a\u5757\u957f\u5206\u5757\u624d\u80fd\u4fdd\u8bc1\u5355\u6b21\u8be2\u95ee$O(\\sqrt {n \\log n})$\u3002  \n\u56fe\u4e00\u4e2a\u65b9\u4fbf\uff0c\u518d\u52a0\u4e0a\u5b9e\u9645\u8fd0\u884c\u6548\u7387\u5dee\u4e0d\u591a\uff0c\u751a\u81f3\u66f4\u4f18\u79c0\uff0c\u5c31\u76f4\u63a5\u4ee5512\u4e3a\u5757\u957f\u4e86\u3002  \n\n\n\n_Code_\n------------\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define il inline \n#define ll long long\n#define ri register int \nil ll read(){\n\tll x=0;\n\tchar ch=getchar(),f=1;\n\tfor(;ch<'0'||ch>'9';ch=getchar()) \n\t\tif(ch=='-') f=0;\n\tfor(;ch>='0'&&ch<='9';ch=getchar())\n\t\tx=x*10+ch-'0';\n\tif(f) return x;\n\treturn -x;\n}\nil void write(ll x){\n\tif(x>9) write(x/10);\n\tputchar(x%10+'0');\n}\nil ll max(ll x,ll y){return x>y?x:y;}\nil ll min(ll x,ll y){return x<y?x:y;}\nil void print(ll x){\n\tif(x<0) putchar('-'),x=-x;\n\twrite(x);\n\tputchar('\\n');\n}\n/*\nfor pai\n*/\nint n,m,c;\nconst int MAXN=2e5+7;\nconst int MAXM=1e5+7;\nint p[MAXN],w[MAXN],id[MAXN];//\u6536\u96c6\u5668\u4e2d\u7684\u989c\u8272\uff0c\u5f53\u524d\u70b9\u7684\u989c\u8272\uff0c\u989c\u8272\u5728\u6536\u96c6\u5668\u4e2d\u5bf9\u5e94\u7684\u4e0b\u6807\nvector<int> g[MAXN];\nint fa[MAXN],top[MAXN],dfn[MAXN],siz[MAXN],dep[MAXN],son[MAXN],idfn[MAXN],dson[MAXN],ddep[MAXN];\n#define B 512\nvoid dfs1(int u,int f,int deep){\n\tfa[u]=f;\n\tddep[u]=dep[u]=deep;\n\tsiz[u]=1;\n\tint mx=-1;\n\tfor(ri i=0;i<g[u].size();++i){\n\t\tint v=g[u][i];\n\t\tif(v==f) continue;\n\t\tdfs1(v,u,deep+1);\n\t\tsiz[u]+=siz[v];\n\t\tif(siz[v]>mx){\n\t\t\tson[u]=v;\n\t\t\tmx=siz[v];\n\t\t}\n\t}\n}\nint cnt;\nvoid dfs2(int u,int f,int topf){\n\tdson[topf]=u;\n\tdfn[u]=++cnt;\n\tidfn[cnt]=u;\n\ttop[u]=topf;\n\tif(son[u]) dfs2(son[u],u,topf);\n\tfor(ri i=0;i<g[u].size();++i){\n\t\tint v=g[u][i];\n\t\tif(v==son[u]||v==f) continue;\n\t\tdfs2(v,u,v);\n\t}\n}\nint bpre[B][MAXM],bnxt[B][MAXM];\nint solve_1(int l,int r,int now,int flag){\n\t//printf(\"%d %d %d %d\\n\",l,r,flag,now);\n\tif(flag){\n\t\tfor(ri i=l;i<=r;++i){\n\t\t\tint u=idfn[i];\n\t\t\tif(now<c&&p[now+1]==w[u]){\n\t\t\t\t++now;\n\t\t\t}\n\t\t}\n\t}\n\telse{\n\t\tfor(ri i=r;i>=l;--i){\n\t\t\tint u=idfn[i];\n\t\t\t//print(u);\n\t\t\tif(now<c&&p[now+1]==w[u]) ++now;\n\t\t}\n\t}\n\t//print(now);\n\treturn now;\n}\n\nint solve_2(int l,int r,int now,int flag){\n\tif(l/B==r/B) return solve_1(l,r,now,flag);\n\tif(flag){\n\t\t//puts(\"fuck\");\n\t\tnow=solve_1(l,l/B*B+B-1,now,flag);\n\t\tfor(ri i=l/B+1;i<r/B;++i) now=bnxt[i][now];\n\t\tnow=solve_1(r/B*B,r,now,flag);\n\t}\n\telse{\n\t\t//puts(\"fuck\");\n\t\tnow=solve_1(r/B*B,r,now,flag);\n\t\tfor(ri i=r/B-1;i>l/B;--i) now=bpre[i][now];\n\t\tnow=solve_1(l,l/B*B+B-1,now,flag);\n\t}\n\treturn now;\n}\nint LCA(int u,int v){\n\twhile(top[u]!=top[v]){\n\t\tif(dep[top[u]]<dep[top[v]]) swap(u,v);\n\t\tu=fa[top[u]];\n\t}\n\tif(dep[u]<dep[v]) swap(u,v);\n\treturn v;\n}\nint vec[MAXN],head;\nint solve_3(int u,int v){\n\tint now=0;\n\thead=0;\n\tint lca=LCA(u,v);\n\twhile(top[u]!=top[lca]){\n\t\tvec[++head]=u;\n\t\tu=fa[top[u]];\n\t}\n\tfor(ri i=1;i<=head;++i){\n\t\tnow=solve_2(dfn[top[vec[i]]],dfn[vec[i]],now,0);\n\t}\n\tnow=solve_2(dfn[lca],dfn[u],now,0);\n\thead=0;\n\twhile(top[v]!=top[lca]){\n\t\tvec[++head]=v;\n\t\tv=fa[top[v]];\n\t}\n\tnow=solve_2(dfn[lca],dfn[v],now,1);\n\tfor(ri i=head;i;--i){\n\t\tnow=solve_2(dfn[top[vec[i]]],dfn[vec[i]],now,1);\n\t}\n\treturn now;\n}\nvoid init(){\n\tfor(ri i=0;i<=n/B;++i){\n\t\tint l=i*B,r=min(n,l+B-1);\n\t\tfor(ri j=0;j<=c;++j) bpre[i][j]=j;\n\t\tfor(ri j=l;j<=r;++j){\n\t\t\tint v=w[idfn[j]];\n\t\t\tif(!id[v]) continue;\n\t\t\tbpre[i][id[v]-1]=max(bpre[i][id[v]-1],bpre[i][id[v]]);\n\t\t}\n\t\tfor(ri j=0;j<=c;++j) bnxt[i][j]=j;\n\t\tfor(ri j=r;j>=l;--j){\n\t\t\tint v=w[idfn[j]];\n\t\t\tif(!id[v]) continue;\n\t\t\tbnxt[i][id[v]-1]=max(bnxt[i][id[v]-1],bnxt[i][id[v]]);\n\t\t}\n\t}\n}\nint main(){\n\t//freopen(\"gem.in\",\"r\",stdin);\n\t//freopen(\"gem.out\",\"w\",stdout);\n\tn=read(),m=read(),c=read();\n\tfor(ri i=1;i<=c;++i) p[i]=read(),id[p[i]]=i;\n\tfor(ri i=1;i<=n;++i) w[i]=read();\n\tfor(ri i=1;i<n;++i){\n\t\tint u=read(),v=read();\n\t\tg[u].push_back(v);\n\t\tg[v].push_back(u);\n\t}\n\tdfs1(1,0,1);\n\tdfs2(1,0,1);\n\tinit();\n\tfor(ri t=read();t;--t){\n\t\tint u=read(),v=read();\n\t\tprint(solve_3(u,v));\n\t}\n}\n```",
        "postTime": 1618301462,
        "uid": 206998,
        "name": "Krimson",
        "ccfLevel": 0,
        "title": "P7518 [\u7701\u9009\u8054\u8003 2021 A/B \u5377] \u5b9d\u77f3"
    },
    {
        "content": "\u7531\u4e8e\u6211\u8111\u56de\u8def\u6bd4\u8f83\u6e05\u5947\u60f3\u4e0d\u5230\u4e8c\u5206\u5565\u7684\uff0c\u6240\u4ee5\u770b\u5230\u8def\u5f84\u5c31\u60f3\u7740\u70b9\u5206\u6cbb\u505a\uff0c\u7ed3\u679c\u8fd8\u771f\u80fd\u505a\uff0c\u5c31\u6765\u6c34\u4e00\u53d1\u9898\u89e3\u3002\n\n\u9996\u5148\u5bf9\u539f\u6811\u5efa\u70b9\u5206\u6811\uff0c\u66b4\u529b\u8df3\u7aef\u70b9\u628a\u8be2\u95ee\u6302\u5728\u4e00\u4e2a\u70b9\u4e0b\u9762\u4f7f\u5f97\u8def\u5f84\u8fc7\u6839\u4e14\u5728\u5b50\u6811\u5185\u3002\u5bf9\u4e8e\u6bcf\u4e00\u5c42\u7684\u6811\uff0c\u9700\u8981\u5904\u7406\u4ee5\u4e0b\u4fe1\u606f\uff1a\n\n- $f_x$ \u8868\u793a\u4ece $x$ \u5f00\u59cb\u8d70\u5230\u6839\uff0c**\u4e0b\u4e00\u4e2a**\u9700\u8981\u6536\u96c6\u7684\u662f\u7b2c\u51e0\u4e2a\u3002\n- $g_{x,i}$ \u8868\u793a\u5728\u6839\u65f6**\u4e0b\u4e00\u4e2a**\u8981\u6536\u96c6\u7684\u662f $i$\uff0c\u8d70\u5230 $x$ \u65f6**\u4e0b\u4e00\u4e2a**\u662f\u7b2c\u51e0\u4e2a\u3002\n\n\u8fd9\u6837\uff0c\u5bf9\u4e8e\u4e00\u7ec4\u8be2\u95ee $s,t$\uff0c\u6211\u4eec\u7684\u7b54\u6848\u5c31\u662f $g_{t,f_s}-1$\u3002\n\n$f_x$ \u5355\u72ec\u62ff\u51fa\u6765\u4e0d\u597d\u5904\u7406\uff0c\u6211\u4eec\u6269\u5c55\u4e00\u4e2a\u7ef4\u5ea6\uff0c\u8bbe $h_{x,i}$ \u4e3a\u5230 $x$ \u8fd9\u4e2a\u70b9\u65f6\u8981\u6536\u96c6\u7684\u662f $i$\uff0c\u8d70\u5230\u6839\u65f6\u4e0b\u4e00\u4e2a\u6536\u96c6\u54ea\u4e2a\u3002\n\n\u90a3\u4e48\u6709\u8f6c\u79fb\uff1a\n$$h_{x,i}=h_{fa,i+[w_x=p_i]}$$\n\u6211\u4eec\u53d1\u73b0\uff0c\u6bcf\u4e2a\u70b9\u4e0e\u7236\u4eb2\u7684 $h$ \u6570\u7ec4\u53ea\u6709\u4e00\u4e2a\u4f4d\u7f6e\u4e0d\u540c\uff0c\u4e00\u8fb9 dfs \u4e00\u8fb9\u7ef4\u62a4\u6570\u7ec4\u5373\u53ef\u6c42\u51fa\u6240\u6709 $f_x$\u3002\n\n\u5904\u7406\u5b8c $f_x$\uff0c\u6211\u4eec\u6765\u5904\u7406 $g$\uff0c\u8fd9\u4e2a $g$ \u660e\u663e\u66f4ex\u4e00\u4e9b\uff0c\u53ef\u4ee5\u7528\u4e3b\u5e2d\u6811\uff0c\u4f46\u6709\u66f4\u7b80\u4fbf\u7684\u65b9\u6cd5\uff1a\n\n$$g_{x,i}=g_{fa,i}+[g_{fa,i}=w_x]$$\n\n\u5bb9\u6613\u53d1\u73b0\uff0c\u6bcf\u6b21\u53ea\u4f1a\u5c06\u4e00\u79cd\u6307\u5b9a\u7684\u503c\u53d8\u4e3a\u53e6\u4e00\u79cd\uff0c\u53ef\u4ee5\u7528\u5e76\u67e5\u96c6\u7ef4\u62a4\uff0c\u4e0d\u8fc7\u56e0\u4e3a\u4e0d\u6b62\u4e00\u79cd\u5408\u5e76\u8def\u7ebf\uff0c\u6240\u4ee5\u9700\u8981\u652f\u6301\u64a4\u9500\u64cd\u4f5c\uff0c\u7528\u53ef\u64a4\u9500\u5e76\u67e5\u96c6\u5373\u53ef\u3002\n\n\u590d\u6742\u5ea6 $O(n\\log^2n)$\u3002\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\nconst int N=2e5+5;\nint n,m,c,q,w[N],p[N],hd[N],nxt[N<<1],to[N<<1],tot,s[N],t[N],ans[N],id[N];\nint sz[N],fa[N],dep[N];bool vst[N];vector<int> Q[N],qq[N];\nvoid add(int x,int y){to[++tot]=y,nxt[tot]=hd[x],hd[x]=tot;}\nvoid dfs(int x,int Fa){\n\tsz[x]=1;\n\tfor(int i=hd[x],y;i;i=nxt[i])\n\t\tif(!vst[y=to[i]]&&y!=Fa)dfs(y,x),sz[x]+=sz[y];\n}\nint getg(int x,int Fa,int Sz){\n\tfor(int i=hd[x],y,t;i;i=nxt[i])\n\t\tif(!vst[y=to[i]]&&y!=Fa){if(t=getg(y,x,Sz))return t;}\n\treturn sz[x]>(Sz>>1)?x:0;\n}\nvoid build(int x,int Fa){\n\tdfs(x,0);int g=getg(x,0,sz[x]);fa[g]=Fa,dep[g]=dep[Fa]+1,vst[g]=1,dfs(g,0);\n\tfor(int i=hd[g],y;i;i=nxt[i])if(!vst[y=to[i]])build(y,g);\n}\nvoid clear(int x,int Fa){\n\tqq[x].clear();\n\tfor(int i=hd[x],y;i;i=nxt[i])\n\t\tif(!vst[y=to[i]]&&y!=Fa)clear(y,x);\n}\nint f[N],tmpf[N],g[N],rt[N],pp[N],depp[N];\nvoid dfs2(int x,int Fa){\n\tif(Fa==0){for(int i=1;i<=sz[x]+1;i++)tmpf[i]=i+(p[i]==w[x]);}\n\tf[x]=tmpf[1];\n\tfor(int i=hd[x],y,tc,tw;i;i=nxt[i])if(!vst[y=to[i]]&&y!=Fa){\n\t\ttc=id[w[y]];if(~tc)tw=tmpf[tc],tmpf[tc]=tmpf[tc+1];\n\t\tdfs2(y,x);\n\t\tif(~tc)tmpf[tc]=tw;\n\t}\n}\nint fnd(int x){return pp[x]==x?x:fnd(pp[x]);}\nvoid dfs3(int x,int Fa){\n\tif(Fa==0){for(int i=1;i<=sz[x]+1;i++)rt[i]=g[i]=pp[i]=i,depp[i]=1;}\n\tfor(int i=0;i<qq[x].size();i++)ans[qq[x][i]]=g[fnd(f[s[qq[x][i]]])]-1;\n\tfor(int i=hd[x],y,tc,trt,nrt;i;i=nxt[i])if(!vst[y=to[i]]&&y!=Fa){\n\t\ttc=id[w[y]];bool fuck=0,swaped=0;\n\t\tif(~tc){\n\t\t\ttrt=rt[tc];\n\t\t\tif(!rt[tc+1])rt[tc+1]=trt,rt[tc]=0,g[trt]++,fuck=1;\n\t\t\telse if(depp[trt]<depp[rt[tc+1]])pp[trt]=rt[tc+1],rt[tc]=0;\n\t\t\telse if(depp[trt]==depp[rt[tc+1]])pp[trt]=rt[tc+1],rt[tc]=0,depp[rt[tc+1]]++;\n\t\t\telse pp[nrt=rt[tc+1]]=trt,rt[tc]=0,swap(g[nrt],g[trt]),rt[tc+1]=trt,swaped=1;\n\t\t}\n\t\tdfs3(y,x);\n\t\tif(~tc){\n\t\t\tif(fuck)rt[tc]=trt,rt[tc+1]=0,g[trt]--;\n\t\t\telse if(!swaped)pp[trt]=trt,rt[tc]=trt;\n\t\t\telse rt[tc]=trt,pp[nrt]=nrt,rt[tc+1]=nrt,swap(g[nrt],g[trt]);\n\t\t}\n\t}\n}\nvoid solve(int x){\n\tdfs(x,0);int g=getg(x,0,sz[x]);vst[g]=1,dfs(g,0),clear(g,0);\n\tfor(int i=0;i<Q[g].size();i++)qq[t[Q[g][i]]].push_back(Q[g][i]);\n\tdfs2(g,0),dfs3(g,0);\n\tfor(int i=hd[g],y;i;i=nxt[i])if(!vst[y=to[i]])solve(y);\n}\nint main(){\n\tscanf(\"%d%d%d\",&n,&m,&c);\n\tfill(id,id+c+1,-1);\n\tfor(int i=1;i<=c;i++)scanf(\"%d\",&p[i]),id[p[i]]=i;\n\tfor(int i=1;i<=n;i++)scanf(\"%d\",&w[i]);\n\tfor(int i=1,x,y;i<n;i++)scanf(\"%d%d\",&x,&y),add(x,y),add(y,x);\n\tbuild(1,0);\n\tscanf(\"%d\",&q);\n\tfor(int i=1,j,k;i<=q;i++){\n\t\tscanf(\"%d%d\",&s[i],&t[i]);\n\t\tfor(j=s[i],k=t[i];j!=k;j=fa[j])\n\t\t\tif(dep[j]<dep[k])swap(j,k);\n\t\tQ[j].push_back(i);\n\t}\n\tfill(vst,vst+n+1,0);\n\tsolve(1);\n\tfor(int i=1;i<=q;i++)printf(\"%d\\n\",ans[i]);\n\treturn 0;\n}\n```",
        "postTime": 1618725299,
        "uid": 77174,
        "name": "FunnyCreatress",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P7518 \u3010[\u7701\u9009\u8054\u8003 2021 A/B \u5377] \u5b9d\u77f3\u3011"
    },
    {
        "content": "\u5199\u4e00\u4e0b\u6211\u5728\u8003\u573a\u4e0a\u7684\u601d\u8003\u8fc7\u7a0b\u5427\u3002\n\n\u9996\u5148\uff0c\u5bf9\u4e8e\u6d4b\u8bd5\u70b9 $1\u223c5$ \u6211\u4eec\u53ef\u4ee5\u4e00\u6b65\u4e00\u6b65\u8d70 $s_i$ \u81f3 $t_i$ \u7684\u8def\u5f84\uff0c\u6c42\u51fa\u6700\u591a\u80fd\u653e\u591a\u5c11\u5757\u5b9d\u77f3\u3002\n\n\u5bf9\u4e8e\u6d4b\u8bd5\u70b9 $6\u223c10$ \uff0c\u6211\u4eec\u53d1\u73b0 $m$ \u5f88\u5c0f\uff0c\u56e0\u6b64\u6211\u4eec\u53ef\u4ee5\u7528\u8fd9\u6837\u4e00\u79cd\u601d\u8def\u6765\u89e3\u51b3\u8fd9\u4e2a\u90e8\u5206\u5206\uff1a\u6c42\u51fa $s_i$ \u5230 $t_i$ \u8def\u5f84\u4e0a\u6700\u9760\u8fd1 $s_i$ \u7684 $P_1$ \uff0c\u5047\u8bbe\u8fd9\u4e2a $P_1$ \u5b9d\u77f3\u6240\u5728\u7684\u70b9\u4e3a $v_1$ \uff0c\u7ee7\u7eed\u5728 $v_1$ \u5230 $t_i$ \u7684\u8def\u5f84\u4e0a\u627e\u6700\u9760\u8fd1 $v_1$ \u7684 $P_2$ \u2026\u2026\u4ee5\u6b64\u7c7b\u63a8\u3002\u4e0a\u8ff0\u601d\u8def\u53ef\u4ee5\u7528**\u91cd\u94fe\u5256\u5206**\u6765\u5b9e\u73b0\u3002\u5047\u8bbe\u5f53\u524d\u8981\u5728 $v_j$ \u5230 $t_i$ \u7684\u8def\u5f84\u4e0a\u627e $P_{j+1}$ \uff0c $v_j$ \u6240\u5728\u7684\u91cd\u94fe\u7684\u9876\u90e8\u4e3a $u_j$ ,\u56e0\u4e3a\u91cd\u94fe\u4e0a\u70b9\u7684 $dfs$ \u5e8f\u662f\u8fde\u7eed\u7684\uff0c\u6240\u4ee5\u5728\u77e5\u9053\u6240\u6709 $P_{j+1}$ \u7684\u70b9\u7684 $dfs$ \u5e8f\u7684\u60c5\u51b5\u4e0b\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u4e8c\u5206\u5224\u65ad $v_j$ \u81f3 $u_j$ \u95f4\u662f\u5426\u6709 $P_{j+1}$ \u7684\u70b9\uff0c\u4ee5\u53ca\u5982\u679c\u6709\u7684\u60c5\u51b5\u4e0b\u6700\u9760\u8fd1 $v_j$ \u6216\u6700\u9760\u8fd1 $u_j$ \u7684\u662f\u54ea\u4e2a\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u4f9d\u6b21\u5728 $s_i$ \u5230 $lca$ \uff08 $s_i$ \u4e0e $t_i$ \u7684 $lca$ \uff09\uff0c $lca$ \u5230 $t_i$ \u7684\u91cd\u94fe\u4e0a\u5c3d\u53ef\u80fd\u7684\u9009\u62e9\u53ef\u9009\u4e14\u9760\u524d\u7684\u5b9d\u77f3\u653e\u5165\u3002\u5bf9\u4e8e\u62e5\u6709\u5b9d\u77f3 $P_i$ \u7684\u70b9\u6211\u4eec\u53ef\u4ee5\u5f00\u4e00\u4e2a $vector$ \u6765\u5b58\u50a8\uff0c\u6309 $dfs$ \u5e8f\u904d\u5386\u65f6\u4f9d\u6b21\u653e\u5165\u3002\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a  $O(qmlog_2n+qlog_2^2n)$ \u3002\uff08\u6ca1\u5199\u8fc7\uff0c\u4e0d\u77e5\u9053\u80fd\u4e0d\u80fd\u8fc7\uff09\n\n\u5bf9\u4e8e\u6d4b\u8bd5\u70b9 $11\u223c14$ \uff0c\u5373\u6811\u9000\u5316\u4e3a\u94fe\u7684\u6d4b\u8bd5\u70b9\uff0c\u7531\u4e8e\u5e8f\u5217 $P$ \u4e2d\u7684\u6570\u5404\u4e0d\u76f8\u540c\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u500d\u589e\u7684\u65b9\u6cd5\u6765\u5904\u7406\u3002\u4e0b\u9762\u4ee5 $s_i$ \u5230 $t_i$ \u4ece\u5de6\u81f3\u53f3\u8003\u8651\uff08\u53cd\u8fc7\u6765\u540c\u7406\uff09\uff0c\u6240\u6709\u7684\u70b9\u4e0a\u7684\u5b9d\u77f3\u90fd\u51fa\u73b0\u5728\u5e8f\u5217 $P$ \u4e2d\uff08\u4e0d\u5b58\u5728\u7684\u4e0d\u5f71\u54cd\uff09\u3002\u8bbe $v_j$ \u4e0a\u7684\u5b9d\u77f3\u4e3a $P_i$ \uff0c\u8bbe\u5728 $v_j$ \u53f3\u4fa7\u7684\u6700\u8fd1\u7684\u5b9d\u77f3 $P_{i+1}$ \u4e3a $u$ \uff0c\u8bbe $fa_{v_j,0}$ \u4e3a $u$ \uff0c\u8868\u793a $v_j$ \u5bf9\u5e94\u5728 $P$ \u4e0a\u7684\u4f4d\u7f6e\u524d\u8fdb $1$ (\u5373 $2^0$ )\u6b65\uff08\u5728\u653e\u5165 $P_i$ \u540e\u518d\u653e\u5165\u4e00\u9897\u5b9d\u77f3 $P_{i+1}$ )\u9700\u8981\u5728\u94fe\u4e0a\u5230\u8fbe\u7684\u6700\u8fd1\u7684\u70b9\u3002\u6211\u4eec\u53ef\u4ee5\u500d\u589e\u6c42\u51fa $fa_{i,1},fa_{i,2}....$ \u7136\u540e\u5355\u6b21 $O(log_2n)$ \u7684\u67e5\u8be2\u5373\u53ef\u3002\u590d\u6742\u5ea6\u4e3a $O((n+q)log_2n)$ \u3002\n\n\u73b0\u5728\u8003\u8651\u505a\u6389\u8fd9\u9053\u9898\u3002\u5bf9\u4e8e\u4ece $s_i$ \u5230 $lca$ \u7684\u8def\u5f84\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u6d4b\u8bd5\u70b9 $6\u223c10$ \u7684\u91cd\u94fe\u5256\u5206\u4e0a\u4f18\u5316\u3002\u6211\u4eec\u53ef\u4ee5\u5728\u6bcf\u6761\u91cd\u94fe\u4e0a\u4f7f\u7528\u500d\u589e\uff0c\u5224\u65ad\u5728\u8fd9\u6761\u91cd\u94fe\u4e0a\u6700\u591a\u8fd8\u80fd\u653e\u591a\u5c11\u5b9d\u77f3\u3002\u5bf9\u4e8e\u4ece $lca$ \u5230 $t_i$ \u7684\u8def\u5f84\uff0c\u6211\u4eec\u53ef\u4ee5\u7528\u7c7b\u4f3c\u7684\u65b9\u6cd5\u5904\u7406\uff0c\u4e0d\u8fc7\u73b0\u5728\u8981\u6539\u4e3a\u4ece\u4e0a\u81f3\u4e0b\u7684\u500d\u589e\uff0c\u5373\u6cbf\u7740\u8fd9\u6761\u91cd\u94fe\uff08\u4ece\u9ad8\u5230\u4f4e\uff09\u4ece $v$ \u8df3 $2^i$ \u6b65\u6700\u8fd1\u80fd\u8df3\u5230\u54ea\u3002\n\n\u73b0\u5728\u6765\u8bf4\u660e\u5982\u4f55\u9884\u5904\u7406\u4ece\u4e0a\u81f3\u4e0b\u7684\u500d\u589e\u3002\u5728\u9884\u5904\u7406\u6811\u5256\u65f6\u6bcf\u6b21 $dfs$ \u5230\u4e00\u6761\u91cd\u94fe\u7684\u53f6\u5b50\u8282\u70b9\uff0c\u5c31\u628a\u8fd9\u6761\u91cd\u94fe\u62ff\u51fa\u6765\u7528\u6d4b\u8bd5\u70b9 $11\u223c14$ \u7684\u65b9\u6cd5\u5904\u7406\u3002\u6bcf\u4e2a\u70b9\u53ea\u4f1a\u5904\u7406\u4e00\u6b21\uff0c\u9884\u5904\u7406\u590d\u6742\u5ea6\u4e3a $O(nlog_2n)$ \n\n\u4e00\u4e2a\u70b9\u5230\u6839\u6700\u591a\u7ecf\u8fc7 $O(log_2n)$ \u6761\u91cd\u94fe\uff0c\u6bcf\u6761\u91cd\u94fe\u4e0a $O(log_2n)$ \u7684\u4e8c\u5206\u4e0e\u500d\u589e\uff0c\u56e0\u6b64\u603b\u7684\u590d\u6742\u5ea6\u4e3a $O(qlog_2^2n)$ \u3002\n\n\u8003\u573a\u4ee3\u7801(\u6b7b\u957f\u70c2\u957f\u8682\u8702\u5267\u6bd2)\uff1a\n\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<algorithm>\n#include<vector>\nusing namespace std;\nconst int MaxN=(int)2e5,MaxZs=18,MaxM=(int)5e4;\nint n,m,c,Numin,Pin,ug[MaxN+5][MaxZs],dg[MaxN+5][MaxZs],fa[MaxN+5],tp[MaxN+5],wson[MaxN+5],son[MaxN+5],dep[MaxN+5],q,P[MaxM+5],ge[MaxN+5];\nint Head[MaxN+5],EdgeNum,dy[MaxM+5],dfn[MaxN+5],nt,sta[MaxN+5],STP,lst[MaxM+5],cx[MaxM+5],cxtot,NowLca,st,l,r,mid,fd,pw[MaxZs];\nbool hap[MaxM+5];\nvector<int>v[MaxM+5];\nchar Ci;\nstruct EDGE\n{\n\tint to,nx;\n}e[2*MaxN+5];\nint Read()\n{\n\tNumin=0,Pin=1;Ci=0;\n\twhile(Ci<'0'||Ci>'9'){if(Ci=='-') Pin=-1;Ci=getchar();}\n\twhile(Ci>='0'&&Ci<='9'){Numin=Numin*10+Ci-'0';Ci=getchar();}\n\treturn Numin*Pin;\n}\nvoid Build(int from,int to)\n{\n\te[++EdgeNum].to=to;\n\te[EdgeNum].nx=Head[from];\n\tHead[from]=EdgeNum;\n}\nvoid dfs1(int node)\n{\n\tint mx;\n\tson[node]=1;\n\tif(fa[node] && dy[ge[node]]>0)\n\t{\n\t\tmx=v[P[dy[ge[node]]+1]].size();\n\t\tif(mx>0)\n\t\t{\n\t\t\tug[node][0]=v[P[dy[ge[node]]+1]][mx-1];\n\t\t\tfor(int i=1;i<MaxZs;i++)\n\t\t\t\tif(ug[ug[node][i-1]][i-1]>0)\n\t\t\t\t\tug[node][i]=ug[ug[node][i-1]][i-1];\n\t\t\t\telse\n\t\t\t\t\tbreak;\n\t\t}\n\t}\n\tmx=0;\n\tv[ge[node]].push_back(node);\n\tfor(int i=Head[node];i;i=e[i].nx)\n\t\tif(e[i].to!=fa[node])\n\t\t{\n\t\t\tdep[e[i].to]=dep[node]+1;fa[e[i].to]=node;\n\t\t\tdfs1(e[i].to);\n\t\t\tson[node]+=son[e[i].to];\n\t\t\tif(son[e[i].to]>mx)\n\t\t\t{\n\t\t\t\tmx=son[e[i].to];\n\t\t\t\twson[node]=e[i].to;\n\t\t\t}\n\t\t}\n\tv[ge[node]].pop_back();\n}\nvoid Calc(int From,int To)\n{\n\tSTP=1;\n\tsta[STP]=From;\n\tint Now=From;\n\twhile(Now!=To)\n\t{\n\t\tNow=fa[Now];\n\t\tsta[++STP]=Now;\n\t\tif(Now==To)\n\t\t\tbreak;\n\t}\n\tcxtot=0;\n\tfor(int i=1;i<=STP;i++)\n\t{\n\t\tNow=sta[i];\n\t\tif(hap[P[dy[ge[Now]]+1]] && dy[ge[Now]]>0)\n\t\t{\n\t\t\tdg[Now][0]=lst[P[dy[ge[Now]]+1]];\n\t\t\tfor(int j=1;j<=MaxZs;j++)\n\t\t\t\tif(dg[dg[Now][j-1]][j-1]>0)\n\t\t\t\t\tdg[Now][j]=dg[dg[Now][j-1]][j-1];\n\t\t\t\telse\n\t\t\t\t\tbreak;\n\t\t}\n\t\tlst[ge[Now]]=Now;\n\t\tif(!hap[ge[Now]])\n\t\t{\n\t\t\thap[ge[Now]]=true;\n\t\t\tcx[++cxtot]=ge[Now];\n\t\t}\n\t}\n\tfor(int j=1;j<=cxtot;j++)\n\t{\n\t\tNow=cx[j];\n\t\thap[cx[j]]=false;\n\t}\n}\nvoid dfs2(int node,int TOP)\n{\n\ttp[node]=TOP;dfn[node]=++nt;v[ge[node]].push_back(node);\n\tif(wson[node])\n\t\tdfs2(wson[node],TOP);\n\telse\n\t{\n\t\tCalc(node,TOP);\n\t\treturn ;\n\t}\n\tfor(int i=Head[node];i;i=e[i].nx)\n\t\tif(e[i].to!=fa[node] && e[i].to!=wson[node])\n\t\t\tdfs2(e[i].to,e[i].to);\n}\nvoid LCA(int n1,int n2)\n{\n\twhile(tp[n1]!=tp[n2])\n\t{\n\t\tif(dep[tp[n1]]<dep[tp[n2]])\n\t\t{\n\t\t\tn1^=n2;n2^=n1;n1^=n2;\n\t\t}\n\t\tn1=fa[tp[n1]];\n\t}\n\tif(dep[n1]<dep[n2])\n\t\tNowLca=n1;\n\telse\n\t\tNowLca=n2;\n}\nint check(int nl,int nr,int co)\n{\n\tl=0;r=v[co].size();r--;\n\tfd=-1;\n\twhile(l<=r)\n\t{\n\t\tmid=(l+r)>>1;\n\t\tif(dfn[v[co][mid]]>=nl && dfn[v[co][mid]]<=nr)\n\t\t{\n\t\t\tfd=v[co][mid];\n\t\t\tl=mid+1;\n\t\t}\n\t\telse if(dfn[v[co][mid]]>nr)\n\t\t\tr=mid-1;\n\t\telse\n\t\t\tl=mid+1;\n\t}\n\treturn fd;\n}\nint check1(int nl,int nr,int co)\n{\n\tl=0;r=v[co].size();r--;\n\tfd=-1;\n\twhile(l<=r)\n\t{\n\t\tmid=(l+r)>>1;\n\t\tif(dfn[v[co][mid]]>=nl && dfn[v[co][mid]]<=nr)\n\t\t{\n\t\t\tfd=v[co][mid];\n\t\t\tr=mid-1;\n\t\t}\n\t\telse if(dfn[v[co][mid]]>nr)\n\t\t\tr=mid-1;\n\t\telse\n\t\t\tl=mid+1;\n\t}\n\treturn fd;\n}\nvoid Calc_Up(int Now)\n{\n\tint nf=0,nn;\n\twhile(tp[Now]!=tp[NowLca])\n\t{\n\t\tnn=check(dfn[tp[Now]],dfn[Now],P[1]);\n\t\tif(nn>0)\n\t\t\tbreak;\n\t\tNow=fa[tp[Now]];\n\t}\n\tif(nn<=0)\n\t\tnn=check(dfn[NowLca],dfn[Now],P[1]);\n\tif(nn>0)\n\t{\n\t\tst=1;Now=nn;\n\t\tfor(int i=MaxZs-1;i>=0;i--)\n\t\t\tif(ug[Now][i] && dfn[ug[Now][i]]>=dfn[NowLca])\n\t\t\t{\n\t\t\t\tst+=pw[i];\n\t\t\t\tNow=ug[Now][i];\n\t\t\t}\n\t}\n}\nvoid Calc_Down(int From)\n{\n\tSTP=0;int Now=From,nn,Nx;\n\twhile(tp[Now]!=tp[NowLca])\n\t{\n\t\tsta[++STP]=tp[Now];\n\t\tNow=fa[tp[Now]];\n\t}\n\tif(!STP)\n\t{\n\t\tnn=check1(dfn[NowLca]+1,dfn[From],P[st+1]);\n\t\tif(nn>0)\n\t\t{\n\t\t\tst++;\n\t\t\tfor(int i=MaxZs-1;i>=0;i--)\n\t\t\t\tif(dg[nn][i] && dfn[dg[nn][i]]<=dfn[From])\n\t\t\t\t{\n\t\t\t\t\tst+=pw[i];\n\t\t\t\t\tnn=dg[nn][i];\n\t\t\t\t}\n\t\t}\n\t\treturn ;\n\t}\n\tnn=check1(dfn[NowLca]+1,dfn[fa[sta[STP]]],P[st+1]);\n\tif(nn>0)\n\t{\n\t\tst++;\n\t\tfor(int i=MaxZs-1;i>=0;i--)\n\t\t\tif(dg[nn][i] && dfn[dg[nn][i]]<=dfn[fa[sta[STP]]])\n\t\t\t{\n\t\t\t\tst+=pw[i];\n\t\t\t\tnn=dg[nn][i];\n\t\t\t}\n\t}\n\tfor(int i=STP;i>1;i--)\n\t{\n\t\tNow=sta[i];Nx=sta[i-1];\n\t\tnn=check1(dfn[Now],dfn[fa[Nx]],P[st+1]);\n\t\tif(nn>0)\n\t\t{\n\t\t\tst++;\n\t\t\tfor(int j=MaxZs-1;j>=0;j--)\n\t\t\t\tif(dg[nn][j] && dfn[dg[nn][j]]<=dfn[fa[Nx]])\n\t\t\t\t{\n\t\t\t\t\tst+=pw[j];\n\t\t\t\t\tnn=dg[nn][j];\n\t\t\t\t}\n\t\t}\n\t}\n\tif(STP)\n\t{\n\t\tNow=sta[1];Nx=From;\n\t\tnn=check1(dfn[Now],dfn[Nx],P[st+1]);\n\t\tif(nn>0)\n\t\t{\n\t\t\tst++;\n\t\t\tfor(int j=MaxZs-1;j>=0;j--)\n\t\t\t\tif(dg[nn][j] && dfn[dg[nn][j]]<=dfn[Nx])\n\t\t\t\t{\n\t\t\t\t\tst+=pw[j];\n\t\t\t\t\tnn=dg[nn][j];\n\t\t\t\t}\n\t\t}\n\t}\n}\nint main()\n{\n\tfreopen(\"gem.in\",\"r\",stdin);\n\tfreopen(\"gem.out\",\"w\",stdout);\n\tpw[0]=1;\n\tfor(int i=1;i<MaxZs;i++)\n\t\tpw[i]=pw[i-1]*2;\n\tn=Read();m=Read();c=Read();\n\tfor(int i=1;i<=c;i++)\n\t{\n\t\tP[i]=Read();\n\t\tdy[P[i]]=i;\n\t}\n\tP[c+1]=m+1;\n\tfor(int i=1;i<=n;i++)\n\t\tge[i]=Read();\n\tint a,b;\n\tfor(int i=1;i<n;i++)\n\t{\n\t\ta=Read();b=Read();\n\t\tBuild(a,b);\n\t\tBuild(b,a);\n\t}\n\tdfs1(1);\n\tdfs2(1,1);\n\tq=Read();\n\tfor(int i=1;i<=q;i++)\n\t{\n\t\ta=Read();b=Read();\n\t\tLCA(a,b);//LCA%%%\n\t\tst=0;\n\t\tCalc_Up(a);\n\t\tCalc_Down(b);\n\t\tprintf(\"%d\\n\",st);\n\t}\n\treturn 0;\n}\n\n\n```",
        "postTime": 1618667526,
        "uid": 128252,
        "name": "\u67d0\u79d1\u5b66\u7684\u849f\u84bb",
        "ccfLevel": 0,
        "title": "2021\u7701\u9009B\u5377 gem"
    },
    {
        "content": "\u8bf4\u5728\u524d\u9762\uff1a\u8fd9\u662f\u4e00\u7bc7\u975e\u6b63\u89e3\u3002\u672c\u9898\u89e3\u65f6\u95f4\u590d\u6742\u5ea6\uff08\u8ba4\u4e3a $n,q$ \u540c\u9636\uff09\u4e3a $O(n\\sqrt n + n \\log^2 n)$\u3002~~\u4f46\u662f\u6700\u5927\u70b9 400 ms\u2026\u2026\u6570\u636e\u4f30\u8ba1\u997a\u9020\u7684~~\n\n___\n\n\u7b80\u8981\u5206\u6790\u4e00\u4e0b\u9898\u76ee\uff1a\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u4e00\u4e2a\u5f88\u91cd\u8981\u7684\u6027\u8d28\uff1a \u5176\u4e2d $P_i$\n**\u4e92\u4e0d\u76f8\u7b49**\u3002\n\n\u8fd9\u7ed9\u4e88\u4e86\u6211\u4eec\u4e00\u4e2a\u91cd\u8981\u7684\u542f\u53d1\uff1a\u5982\u679c\u6211\u4eec\u94a6\u5b9a\u5728\u4e00\u4e2a\u70b9\u6536\u96c6\u6709\u7528\u7684\u5b9d\u77f3\uff0c\u90a3\u4e48\u6536\u96c6\u7684\u8fd9\u4e2a\u5b9d\u77f3\u5728\u5b9d\u77f3\u5e8f\u5217\u4e2d\u7684**\u4f4d\u7f6e\u552f\u4e00**\u3002\n\n\u7136\u540e\u5927\u591a\u6570\u4eba\u597d\u50cf\u5c31\u4ee5\u8fd9\u4e2a\u6027\u8d28 \u6811\u5256+\u500d\u589e\uff0c\u4f46\u662f**\u6839\u53f7\u5206\u6cbb**\u663e\u7136\u662f\u601d\u7ef4\u96be\u5ea6\u66f4\u5c0f\u7684\u9009\u62e9\u2014\u2014\u5728\u6811\u4e0a\u6bcf $\\sqrt n$ \u6b65\u5e76\u4e3a\u4e00\u6b65\u5730\u8df3\u5230\u76ee\u7684\u5730\u3002\u663e\u7136\u8fd9\u6837\u8df3\u7684\u6b21\u6570\u4e0e\u9884\u5904\u7406\u7684\u6b65\u6570\u90fd\u4e0d\u8d85\u8fc7 $O(\\sqrt n)$\uff0c\u4f7f\u5f97\u7a7a\u95f4\u548c\u65f6\u95f4\u90fd\u53ef\u4ee5\u63a5\u53d7\u3002\n\n\u63a5\u4e0b\u6765\u5c31\u662f\u5b9e\u73b0\u90e8\u5206\uff1a\n\n\u9996\u5148\u5c06\u8def\u5f84\u62c6\u5206\u4e3a $x\\rightarrow lca$ \u4e0e $lca \\rightarrow y$ \u4e24\u6bb5\uff0c\u8fd9\u6837\u505a\u6210\u76f4\u4e0a\u76f4\u4e0b\u7684\u8def\u5f84\u65b9\u4fbf\u5904\u7406\u3002\n\n\u5ef6\u7eed\u4e0a\u9762\u7684\u601d\u60f3\uff0c\u4e3a\u4e86\u907f\u514d\u8def\u5f84\u4e0a\u7684\u5206\u652f\uff0c\u6211\u4eec\u5c06\u539f\u6811\u91cd\u94fe\u5256\u5206\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u70b9\u9884\u5904\u7406 $\\text{jump}_{0/1,j} (j \\in [1,\\sqrt n])$ \uff0c\u8868\u793a\u4ee5\u8fd9\u4e2a\u70b9\u5728\u5b9d\u77f3\u5e8f\u5217\u4e2d\u7684\u4f4d\u7f6e\u4f5c\u4e3a\u5f00\u59cb\uff0c\u6cbf\u91cd\u94fe\u5411\u4e0a/\u4e0b\u518d\u6536\u96c6 $j$ \u4e2a\u5b9d\u77f3\u5230\u8fbe\u7684\u70b9\u3002\uff08\u5982\u679c\u5728\u8fd9\u6761\u91cd\u94fe\u4e0a\u65e0\u6cd5\u6536\u96c6\u8fd9\u4e48\u591a\u5b9d\u77f3\u6216\u8005\u8fd9\u4e2a\u70b9\u4e0a\u7684\u5b9d\u77f3\u4e0d\u5728\u5b9d\u77f3\u5e8f\u5217\u4e2d\u51fa\u73b0\uff0c\u5219\u4e3a 0\uff09\u3002\n\n\u8fd9\u4e2a\u6570\u7ec4\u7684\u9884\u5904\u7406\u53ef\u4ee5\u5728 $O(n\\sqrt n)$ \u7684\u65f6\u95f4\u5185\u89e3\u51b3\u3002\n\n\u56de\u7b54\u8be2\u95ee\u65f6\uff0c\u56e0\u4e3a\u6211\u4eec\u77e5\u9053\u5f53\u524d\u5373\u5c06\u8981\u6536\u96c6\u4ec0\u4e48\u5b9d\u77f3\uff0c\u6240\u4ee5\u5c31\u5e26\u6709\u65b9\u5411\u6027\u7684\u53bb\u627e\u7b2c\u4e00\u4e2a\u4e0b\u4e00\u4e2a\u9700\u8981\u7684\u5b9d\u77f3\uff0c\u7528\u5b83\u6240\u5728\u4f4d\u7f6e\u7684 $\\text{jump}$ \u6570\u7ec4\u5feb\u901f\u8df3\u8dc3\u5373\u53ef\u3002\n\n\u4f46\u662f\u6211\u4eec\u53d1\u73b0\u9700\u8981\u7ef4\u62a4\u4e00\u4e2a\u64cd\u4f5c\uff1a\u67e5\u8be2\u5728\u4e00\u6bb5\u91cd\u94fe\u4e0a \u7b2c\u4e00\u4e2a/\u6700\u540e\u4e00\u4e2a \u67d0\u4e00\u79cd\u989c\u8272\u3002\n\n\u7531\u4e8e\u91cd\u94fe\u5256\u5206\u7684\u826f\u597d\u6027\u8d28\uff0c\u4e00\u6761\u91cd\u94fe\u4e0a\u7684 dfn \u5e8f\u4e5f\u8fde\u7eed\uff0c\u6240\u4ee5\u6211\u4eec\u5bf9\u4e8e\u6bcf\u4e00\u79cd\u989c\u8272\uff0c\u7ef4\u62a4 dfn \u5e8f\u7684 vector\uff0c\u9700\u8981\u8be2\u95ee\u65f6\u5728\u4e0a\u9762\u4e8c\u5206\u67e5\u8be2\u5373\u53ef\u3002\n\n\u5bf9\u4e8e\u56de\u7b54\u8be2\u95ee\uff0c\u5355\u6b21\u590d\u6742\u5ea6\u81f3\u591a\u4e3a $O(\\sqrt n + \\log^2 n)$\uff08\u81f3\u591a $O(\\sqrt n)$ \u6b65\uff0c\u81f3\u591a $O(\\log n)$ \u6761\u91cd\u94fe\uff0c\u6bcf\u4e00\u6761\u91cd\u94fe\u4e0a\u90fd\u9700\u8981\u4e00\u6b21 $O(\\log n)$ \u7684\u4e8c\u5206\uff09\u3002\n\n___\n\n\u53e3\u80e1\u4e00\u822c\u6765\u8bf4\u662f\u591f\u4e86\uff0c\u8fd8\u6709\u4e0d\u61c2\u7684\u5c31\u770b\u4ee3\u7801\u5427\u3002\n\n\u672c\u5199\u6cd5\u7ec6\u8282\u8f83\u591a\uff0c\u8bf7\u6ce8\u610f\u7cbe\u7ec6\u5b9e\u73b0\u3002\uff08\u6bd4\u5982\u8bf4 vector \u4e0a\u8981\u8bbe\u54e8\u5175\uff09\u3002\n\n\u56e0\u4e3a\u662f\u8003\u573a\u4ee3\u7801\uff0c\u6240\u4ee5\u7801\u98ce\u50cf * \u4e00\u6837\uff0c\u4e0d\u559c\u52ff\u55b7\u3002\n\n```cpp\n#include <map>\n#include <cstdio>\n#include <vector>\n#include <algorithm>\ninline int re() {\n\tchar c;\n\tint w=1;\n\twhile((c=getchar())<'0'||c>'9')if(c=='-')w=-1;\n\tint res = c-'0';\n\twhile((c=getchar())>='0'&&c<='9')res = res*10+c-'0';\n\treturn res*w;\n}\ninline int max(int a,int b) {return a>b?a:b;}\nconst int maxn = 2e5+5;\nint n,m,c,q,nd[maxn],col[maxn];\nint head[maxn],tot;\nstruct Edge {\n\tint next,to;\n} e[maxn<<1];\nvoid add_edge(int x,int y) {\n\te[++tot].next = head[x];\n\te[tot].to = y,head[x] = tot;\n}\nnamespace Sol {\n\tconst int maxb = 205,B = 200;\n\tint colpos[maxn],pos[maxn];\n\tint fa[maxn],dep[maxn],siz[maxn],son[maxn],top[maxn],in[maxn],rnk[maxn],tim;\n\tstd :: vector <int> chain[maxn],colin[maxn],cols[maxn],tmp;\n\tint jumpu[maxn][maxb],jumpd[maxn][maxb];\n\tvoid dfs1(int u,int F) {\n\t\tfa[u] = F,siz[u] = 1,dep[u] = dep[F] + 1;\n\t\tfor(int i=head[u],v; v=e[i].to,i; i=e[i].next) {\n\t\t\tif(v == F)continue;\n\t\t\tdfs1(v,u);\n\t\t\tsiz[u] += siz[v];\n\t\t\tif(siz[v] > siz[son[u]])son[u] = v;\n\t\t}\n\t}\n\tvoid dfs2(int u,int T) {\n\t\ttop[u] = T,in[u] = ++tim,rnk[tim] = u;\n\t\tcolin[col[u]].push_back(in[u]);\n\t\tif(son[u])dfs2(son[u],T);\n\t\tfor(int i=head[u],v; v=e[i].to,i; i=e[i].next)\n\t\t\tif(v != fa[u] && v != son[u])\n\t\t\t\tdfs2(v,v);\n\t}\n\tstruct pair {\n\t\tint x,y;\n\t\tpair(int a=0,int b=0):x(a),y(b) {};\n\t\tbool operator <(pair b)const {return x==b.x?y<b.y:x<b.x;}\n\t};\n\tint LCA(int x,int y) {\n\t\twhile(top[x]^top[y]) {\n\t\t\tif(dep[top[x]]<dep[top[y]])x^=y^=x^=y;\n\t\t\tx = fa[top[x]];\n\t\t}\n\t\treturn dep[x]<dep[y]?x:y;\n\t}\n\tint upfir(int upb,int col){return *(--std::upper_bound(colin[col].begin(),colin[col].end(),upb));}\n\tint downfir(int lowb,int col) {return *std::lower_bound(colin[col].begin(),colin[col].end(),lowb);}\n\tint Query(int x,int y) {\n\t\tint lca = LCA(x,y),nowpos = 0;\n\t\twhile(top[x] ^ top[lca]) {\n\t\t\tint pos = upfir(in[x],nd[nowpos+1]);\n\t\t\tif(pos >= in[top[x]]) {\n\t\t\t\tx = rnk[pos],++nowpos;\n\t\t\t\twhile(jumpu[x][B])x = jumpu[x][B],nowpos += B;\n\t\t\t\tfor(int j=B-1; j; --j)\n\t\t\t\t\tif(jumpu[x][j]) {x = jumpu[x][j],nowpos += j;break;}\n\t\t\t}\n\t\t\tx = fa[top[x]];\n\t\t}\n\t\ttmp.clear();\n\t\twhile(top[y] ^ top[lca])\n\t\t\ttmp.push_back(y),y = fa[top[y]];\n\t\tif(x == lca) {\n\t\t\tint pos = downfir(in[x],nd[nowpos+1]);\n\t\t\tif(pos <= in[y]){\n\t\t\t\tx = rnk[pos],++nowpos;\n\t\t\t\twhile(jumpd[x][B] && dep[jumpd[x][B]] <= dep[y])x = jumpd[x][B],nowpos += B;\n\t\t\t\tfor(int j=B-1; j; --j)\n\t\t\t\t\tif(jumpd[x][j] && dep[jumpd[x][j]] <= dep[y]) {x = jumpd[x][j],nowpos += j;break;}\n\t\t\t}\n\t\t} else {\n\t\t\tint pos = upfir(in[x],nd[nowpos+1]);\n\t\t\tif(pos >= in[y]){\n\t\t\t\tx = rnk[pos],++nowpos;\n\t\t\t\twhile(jumpu[x][B] && dep[jumpu[x][B]] >= dep[y])x = jumpu[x][B],nowpos += B;\n\t\t\t\tfor(int j=B-1;j;--j)\n\t\t\t\t\tif(jumpu[x][j] && dep[jumpu[x][j]] >= dep[y]){x = jumpu[x][j],nowpos += j;break;}\n\t\t\t}\n\t\t}\n\t\tfor(int i=tmp.size()-1; ~i; --i) {\n\t\t\ty = tmp[i];\n\t\t\tint pos = downfir(in[top[y]],nd[nowpos+1]);\n\t\t\tif(pos <= in[y]) {\n\t\t\t\tint tmpy = rnk[pos];\n\t\t\t\t++nowpos;\n\t\t\t\twhile(jumpd[tmpy][B] && dep[jumpd[tmpy][B]] <= dep[y])tmpy = jumpd[tmpy][B],nowpos += B;\n\t\t\t\tfor(int j=B-1; j; --j)if(jumpd[tmpy][j] && dep[jumpd[tmpy][j]] <= dep[y]) {tmpy = jumpd[tmpy][j],nowpos += j;break;}\n\t\t\t}\n\t\t}\n\t\treturn nowpos;\n\t}\n\tvoid Solve() {\n\t\tfor(int i=1; i<=c; ++i)colpos[nd[i]] = i;\n\t\tfor(int i=1; i<=n; ++i)pos[i] = colpos[col[i]];\n\t\tfor(int i=0; i<=m; ++i)colin[i].push_back(0);\n\t\tdfs1(1,0),dfs2(1,1);\n\t\tfor(int i=0; i<=m; ++i)colin[i].push_back(n+1);\n\t\tfor(int i=1; i<=n; ++i) {\n\t\t\tif(i == top[i]) {\n\t\t\t\tint temp = i;\n\t\t\t\tdo{chain[i].push_back(temp),temp = son[temp];}while(temp);\n\t\t\t}\n\t\t}\n\t\tfor(int i=1; i<=n; ++i) {\n\t\t\tif(chain[i].size()) {\n\t\t\t\tfor(int j=0; j<chain[i].size(); ++j) {\n\t\t\t\t\tint id = chain[i][j];\n\t\t\t\t\tif(!pos[id])continue;\n\t\t\t\t\tif(cols[nd[pos[id]+1]].size()) {\n\t\t\t\t\t\tint preid = *(--cols[nd[pos[id]+1]].end());\n\t\t\t\t\t\tjumpu[id][1] = preid;\n\t\t\t\t\t\tfor(int k=2; k<=B; ++k)jumpu[id][k] = jumpu[preid][k-1];\n\t\t\t\t\t}\n\t\t\t\t\tcols[col[id]].push_back(id);\n\t\t\t\t}\n\t\t\t\tfor(int j=0; j<chain[i].size(); ++j)cols[col[chain[i][j]]].clear();\n\t\t\t\tfor(int j=chain[i].size()-1; ~j; --j) {\n\t\t\t\t\tint id = chain[i][j];\n\t\t\t\t\tif(!pos[id])continue;\n\t\t\t\t\tif(cols[nd[pos[id]+1]].size()) {\n\t\t\t\t\t\tint preid = *(--cols[nd[pos[id]+1]].end());\n\t\t\t\t\t\tjumpd[id][1] = preid;\n\t\t\t\t\t\tfor(int k=2; k<=B; ++k)jumpd[id][k] = jumpd[preid][k-1];\n\t\t\t\t\t}\n\t\t\t\t\tcols[col[id]].push_back(id);\n\t\t\t\t}\n\t\t\t\tfor(int j=0; j<chain[i].size(); ++j)cols[col[chain[i][j]]].clear();\n\t\t\t}\n\t\t}\n\t\tq = re();\n\t\tfor(int i=1,x,y; i<=q; ++i) {\n\t\t\tx = re(),y = re();\n\t\t\tprintf(\"%d\\n\",Query(x,y));\n\t\t}\n\t}\n}\nint main() {\n\tfreopen(\"gem.in\",\"r\",stdin);\n\tfreopen(\"gem.out\",\"w\",stdout);\n\tn = re(),m = re(),c = re();\n\tfor(int i=1; i<=c; ++i)nd[i] = re();\n\tfor(int i=1; i<=n; ++i)col[i] = re();\n\tfor(int i=1,x,y; i<n; ++i)x = re(),y = re(),add_edge(x,y),add_edge(y,x);\n\tSol::Solve();\n\treturn 0;\n}\n```\n\n~~\u957f\u5ea64888\uff0c\u975e\u5e38\u5409\u5229\uff08\u8bef\uff09~~",
        "postTime": 1618467150,
        "uid": 114153,
        "name": "Sali\u0435ri",
        "ccfLevel": 7,
        "title": "solution-p7518"
    },
    {
        "content": "\u597d\u50cf\u8fd9\u4e2a\u9898\u5f88\u4eba\u5747\uff0c~~\u867d\u7136\u6211\u8fde\u7701\u9009\u8d44\u683c\u90fd\u6ca1\u6709~~\u3002\u8fd8\u662f\u5168\u7a0b\u81ea\u5df1\u601d\u8003\u505a\u51fa\u6765\u7684\u4e00\u9053\u9898\u76ee\u3002\n\n\u8003\u8651\u94fe\u7684\u90e8\u5206\u5206\u3002\n\n\u4e3a\u4e86\u65b9\u4fbf\uff0c\u6211\u4eec\u8bb0 $\\mathtt {pos_x}$ \u8868\u793a\u503c $x$ \u5904\u5728 $p$ \u5e8f\u5217\u91cc\u7684\u4e0b\u6807\u3002\n\n\u6700\u521d\u6ca1\u6709\u601d\u8def\uff0c\u7136\u540e\u5728\u4e0a\u5b66\u8def\u4e0a\u60f3\u5230\u4e86\u4e00\u4e2a\u601d\u8def\u3002\u5927\u6982\u5c31\u662f NOIO \u4e0a\u9762\u53e3\u80e1\u51fa\u6765\u7684\u4e00\u4e2a\u5b66\u540d\u53eb\u5e8f\u5217\u81ea\u52a8\u673a\u7684\u4e1c\u897f\uff0c\u5927\u6982\u5c31\u662f\u8bb0\u5f55\u540e\u7f00\u3002\u4f46\u662f\u540e\u7f00\u81ea\u52a8\u673a\u9700\u8981\u5b58\u6574\u4e2a\u5b57\u7b26\u96c6\uff0c\u4f46\u662f\u8fd9\u91cc\u7531\u4e8e $p$ \u4e2d\u6bcf\u4e00\u4e2a\u6570\u90fd\u662f\u4e0d\u91cd\u590d\u3002\u6240\u4ee5\u76f4\u63a5\u8bb0\u4e00\u4e2a\u540e\u7ee7\u5373\u53ef\u3002\u4e5f\u5373 $\\mathtt{up_x}$ \u8868\u793a\u4ece\u8282\u70b9 $x$ \u5f80\u7956\u5148\u8d70\uff0c\u5230\u8fbe\u7684\u4e00\u4e2a\u6700\u6df1\u7684\u503c\u4e3a $\\mathtt{p_{pos_x+1}}$ \u7684\u70b9\u7684\u7f16\u53f7\uff0c\u7136\u540e\u6bcf\u6b21\u8be2\u95ee\u7684\u65f6\u5019\u66b4\u529b\u5730\u5f80\u4e0a\u8df3\uff0c\u590d\u6742\u5ea6\u662f $O(nq)$\u3002\u8003\u8651\u4f18\u5316\uff0c\u4f7f\u7528\u500d\u589e\u3002 $\\mathtt{up_{x,i}}$ \u8868\u793a\u4ece\u8282\u70b9 $x$ \u5f80\u7956\u5148\u8d70\uff0c\u5230\u8fbe\u7684\u4e00\u4e2a\u6700\u6df1\u7684\u503c\u4e3a $\\mathtt{p_{pos_x+2^i}}$ \u7684\u7f16\u53f7 \u4e14 $\\mathtt{[pos_x,pos_x+2^i]}$ \u95f4\u7684\u70b9\u90fd\u5df2\u7ecf\u5339\u914d\u597d\u4e86\u3002\u627e\u4e0d\u5230\u6216\u4e2d\u95f4\u6ca1\u5339\u914d\u597d\u90fd\u8d4b\u503c\u4e3a $0$ \u3002\u6bcf\u6b21\u76f4\u63a5\u5f80\u4e0a\u8df3\uff0c\u590d\u6742\u5ea6 $q\\log(n)$ \u3002\u6ce8\u610f\u6700\u5f00\u59cb\u7684\u4f4d\u7f6e\u9700\u8981\u627e\u5230\u7b2c\u4e00\u4e2a\u5339\u914d\u7684\u4f4d\u7f6e\uff0c\u4e5f\u5373\u533a\u95f4\u7b2c\u4e00\u6b21\u51fa\u73b0\u67d0\u4e2a\u6570\u7684\u4f4d\u7f6e\u76f4\u63a5\u6bcf\u79cd\u989c\u8272\u7ef4\u62a4 $\\mathtt {set}$ \u3002\n\n\u8003\u8651\u6811\u4e0a\u600e\u4e48\u505a\u3002\n\n\u7531\u4e8e\u6811\u4e0a\u53ef\u80fd\u4f1a\u6709\u62d0\u5f2f\u7684\u60c5\u51b5\u51fa\u73b0\u3002\u7b2c\u4e00\u6b21\u60f3\u7684\u662f\u518d\u7ef4\u62a4\u4e00\u4e2a\u5f80\u4e0b\u8d70\u7684 $\\mathtt{down} $ \u6570\u7ec4\uff0c\u4f46\u662f\u7531\u4e8e\u513f\u5b50\u4e0d\u552f\u4e00\uff0c\u6240\u4ee5\u8003\u8651\u6811\u94fe\u5256\u5206\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u94fe\u7ef4\u62a4\u500d\u589e\uff0c\u7136\u540e\u6bcf\u6b21\u628a\u7ecf\u8fc7\u7684\u94fe\u8bb0\u5f55\u4e0b\u6765\uff0c\u94fe\u4e0e\u94fe\u4e4b\u95f4\u5c31\u662f\u8df3\u533a\u95f4\u7b2c\u4e00\u6b21\u51fa\u73b0\u67d0\u4e2a\u6570\u7684\u4f4d\u7f6e\uff0c\u76f4\u63a5\u6bcf\u79cd\u989c\u8272\u7ef4\u62a4 $\\mathtt {set}$\u3002\n\n\u4ee3\u7801\u91cc\u6709\u6ce8\u91ca\u3002\n\n```cpp\n#include<bits/stdc++.h>\n#define N 200005\n#define M 50005\n#define pb push_back\n#define pii pair<int,int> \n#define mp make_pair\n#define fi first\n#define se second\n#define sit set<int> :: iterator\nusing namespace std;\nint n,m,c,q,p[N],a[N];\nint t[M],nxt[M];\nint head[N],idx;\nstruct edge{\n\tint v,next;\n}e[N<<1];\nvoid add(int u,int v){\n\te[++idx].v=v;\n\te[idx].next=head[u];\n\thead[u]=idx;\n}\nint cnt,top[N],size[N],son[N],fa[N],dep[N],dfn[N],rev[N];\nint up[N][20],down[N][20];\nset<int> s[M];\nvector<int> v[N];\nvoid dfs1(int x,int f){\n\tfa[x]=f;\n\tsize[x]=1;\n\tdep[x]=dep[f]+1;\n\tfor(int i=head[x];i;i=e[i].next){\n\t\tint y=e[i].v;\n\t\tif(y==f) continue;\n\t\tdfs1(y,x);\n\t\tsize[x]+=size[y];\n\t\tif(size[y]>size[son[x]]) son[x]=y;\n\t}\n}\nvoid dfs2(int x){\n\tif(x==son[fa[x]]) top[x]=top[fa[x]];\n\telse top[x]=x;\n\tdfn[x]=++cnt;\n\trev[cnt]=x;\n\ts[a[x]].insert(dfn[x]);//\u5bf9\u5e94\u989c\u8272\u63d2\u5165dfn\u5e8f \n\tv[top[x]].pb(x);//\u8bb0\u5f55\u6bcf\u4e00\u6761\u94fe\u4e2d\u7684\u5143\u7d20 \n\tif(son[x]) dfs2(son[x]);\n\tfor(int i=head[x];i;i=e[i].next){\n\t\tint y=e[i].v;\n\t\tif(y==fa[x]||y==son[x]) continue;\n\t\tdfs2(y);\n\t}\n}\nvector<pii > l1;\nstack<pii > l2;//\u56e0\u4e3a y->lca \u7684\u8def\u5f84\u4e0a\u662f\u4ece\u4e0a\u5230\u4e0b\uff0c\u6240\u4ee5\u8981\u7528\u6808 \nvoid LCA(int x,int y){\n\twhile(top[x]!=top[y]){\n\t\tif(dep[top[x]]>=dep[top[y]]){\n\t\t\tl1.pb(mp(dfn[top[x]],dfn[x]));\n\t\t\tx=fa[top[x]];\n\t\t}\n\t\telse{\n\t\t\tl2.push(mp(dfn[top[y]],dfn[y]));\n\t\t\ty=fa[top[y]];\n\t\t}\n\t}\n\tif(dep[x]>dep[y]) l1.pb(mp(dfn[y],dfn[x]));\n\telse l2.push(mp(dfn[x],dfn[y]));\n}\nint main(){\n\tscanf(\"%d%d%d\",&n,&m,&c);\n\tfor(int i=1;i<=c;i++){\n\t\tscanf(\"%d\",&p[i]);\n\t\tnxt[p[i-1]]=p[i];\n\t}\n\tfor(int i=1;i<=n;i++) scanf(\"%d\",&a[i]);\n\tfor(int i=1;i<n;i++){\n\t\tint u,v;\n\t\tscanf(\"%d%d\",&u,&v);\n\t\tadd(u,v);\n\t\tadd(v,u);\n\t}\n\tdfs1(1,0);\n\tdfs2(1);\n\tfor(int i=1;i<=n;i++){\n\t\tfor(int j=0;j<v[i].size();j++) t[a[v[i][j]]]=0,t[nxt[a[v[i][j]]]]=0;\n\t\tfor(int j=0;j<v[i].size();j++){\n\t\t\tint x=v[i][j];\n\t\t\tt[a[x]]=x;\n\t\t\tup[x][0]=t[nxt[a[x]]];\n\t\t\tfor(int k=1;k<=16;k++)\tup[x][k]=up[up[x][k-1]][k-1];//\u9884\u5904\u7406\u500d\u589e \n\t\t}\n\t\tfor(int j=0;j<v[i].size();j++) t[a[v[i][j]]]=0,t[nxt[a[v[i][j]]]]=0;\n\t\tfor(int j=v[i].size()-1;j>=0;j--){\n\t\t\tint x=v[i][j];\n\t\t\tt[a[x]]=x;\n\t\t\tdown[x][0]=t[nxt[a[x]]];\n\t\t\tfor(int k=1;k<=16;k++) down[x][k]=down[down[x][k-1]][k-1];\n\t\t}\n\t}\t\n\tscanf(\"%d\",&q);\n\twhile(q--){\n\t\tint u,v;\n\t\tscanf(\"%d%d\",&u,&v);\n\t\tl1.clear();\n\t\twhile(!l2.empty()) l2.pop();\n\t\tLCA(u,v);\n\t\tint now=0,ans=0;\n\t\tfor(int i=0;i<l1.size();i++){\n\t\t\tpii x=l1[i];\n\t\t\tint goal=nxt[a[now]];\n\t\t\tif(goal==0) break;\n\t\t\tif(s[goal].size()==0) break;\n\t\t\tsit it=s[goal].upper_bound(x.se);//\u627e\u4e0b\u7aef\u70b9\u7684\u524d\u9a71 \n\t\t\tint tmp;\n\t\t\tif(it==s[goal].end()) tmp=*s[goal].rbegin();\n\t\t\telse if(it==s[goal].begin()) continue;\n\t\t\telse tmp=*--it; \n\t\t\tif(tmp<=x.se&&tmp>=x.fi) ans++;//\u5224\u65ad\u662f\u4e0d\u662f\u5728\u94fe\u4e0a \n\t\t\telse continue;\n\t\t\tnow=rev[tmp];\n\t\t\tfor(int i=16;i>=0;i--) if(up[now][i]&&dep[up[now][i]]>=dep[rev[x.fi]]) now=up[now][i],ans+=(1<<i);//\u6ce8\u610f\u8df3\u4e5f\u53ea\u80fd\u5728\u6307\u5b9a\u533a\u57df\u8df3 \n\t\t}\n\t\twhile(!l2.empty()){\n\t\t\tpii x=l2.top();\n\t\t\tl2.pop();\n\t\t\tint goal=nxt[a[now]];\n\t\t\tif(s[goal].size()==0) break;\n\t\t\tif(goal==0) break;\n\t\t\tsit it=s[goal].lower_bound(x.fi);//\u627e\u540e\u7ee7 \n\t\t\tif(it==s[goal].end()) continue;\n\t\t\tint tmp=*it;\n\t\t\tif(tmp>=x.fi&&tmp<=x.se) ans++;\n\t\t\telse continue;\n\t\t\tnow=rev[tmp];\n\t\t\tfor(int i=16;i>=0;i--){\n\t\t\t\tif(down[now][i]&&dfn[down[now][i]]<=x.se) now=down[now][i],ans+=(1<<i);\n\t\t\t}\n\t\t}\n\t\tprintf(\"%d\\n\",ans);\n\t}\n\treturn 0;\n}\n```\n\n\n",
        "postTime": 1618569143,
        "uid": 128870,
        "name": "chen_qian",
        "ccfLevel": 7,
        "title": "P7518"
    }
]