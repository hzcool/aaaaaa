[
    {
        "content": "\u663e\u7136\u8fd9\u9898\u8981\u7528\u7ebf\u6bb5\u6811\u641e\u3002\n\n\u5e73\u5747\u6570\uff1f\n\n\u51fa\u95e8\u5de6\u62d0\u7ebf\u6bb5\u6811\u6a21\u677f\u4e00\u518d\u52a0\u4e2agcd\u5c31\u884c\u4e86\u3002\n\n\u65b9\u5dee\uff1f\n\n\u5148\u8bf4\u4e0b\u8fd9\u662f\u4e2a\u4ec0\u4e48\u4e1c\u897f\u3002\n\n\n$\\sum_{i=l}^{r}(a[i]-q)^2/(r-l+1)$ (q\u4e3a\u8fd9r-l+1\u4e2a\u6570\u7684\u5e73\u5747\u6570)\n\n\n\u5c31\u662f\u4e0a\u9762\u90a3\u4e2a\u5f0f\u5b50\u3002\n\n\u663e\u7136\u6211\u4eec\u4e0d\u80fd\u76f4\u63a5\u641e\u3002\n\n\u8003\u8651\u5316\u7b80\uff0c\u8fd0\u7528\u5b8c\u5168\u5e73\u65b9\u516c\u5f0f\u628a$(a[i]-q)^2$\u5316\u5f00\uff0c\u5f97\uff1a\n\n\n$\\sum_{i=l}^{r}(a[i]^2-2*q*a[i]+q^2)/(r-l+1)$ (q\u4e3a\u8fd9r-l+1\u4e2a\u6570\u7684\u5e73\u5747\u6570)\n\n\n\u90a3\u4e48\u6211\u4eec\u518d\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u4e0b\u533a\u95f4\u5e73\u65b9\u548c\u5c31\u884c\u4e86\u3002\n\n\u7136\u540e\u95ee\u9898\u662f\u5e73\u65b9\u548c\u533a\u95f4\u52a0\u600e\u4e48\u7ef4\u62a4\uff1f\n\n\u54ce\u54ce\u54ce\uff0c\u522b\u614c\u3002\u3002\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u518d\u7528\u5b8c\u5168\u5e73\u65b9\u516c\u5f0f\u628a$(a[i]+d)^2$\u5316\u5f00\u6765\uff0c\u5f97\uff1a\n\n\n$a[i]^2+2*a[i]*d+d^2$\n\n\na[i]\u5e73\u65b9\u5c31\u662f\u6211\u4eec**\u539f\u5148\u7684\u7b54\u6848**\uff0c\u7136\u540e\u5c31\u52a0\u4e0a **\u533a\u95f4\u548c\\*2\\*d** \u548c **\u533a\u95f4\u957f\u5ea6\\*d** \u5c31\u884c\u4e86\n\n\n\u5177\u4f53\u8fd8\u6709\u4e9b\u5c0f\u7ec6\u8282\uff0c\u6211\u5c31\u4e0d\u4e00\u4e00\u8bf4\u4e86\u3002\u3002\n\n\n\u7531\u4e8e\u4ee3\u7801\u662f\u5728\u592a\u957f(4K+)\u6211\u5c31\u4e0d\u5c55\u793a\u4e86\u3002\n\n![\u6211\u597d\u83dc\u554a](https://s1.ax1x.com/2018/01/11/p163Hs.jpg)\n",
        "postTime": 1515664568,
        "uid": 25355,
        "name": "\u590f\u8272\u796d",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P2122 \u3010\u8fd8\u6559\u5ba4\u3011"
    },
    {
        "content": "## \u7ebf\u6bb5\u6811\u795e\u9898\n\n\u4e00\u770b\u9898\u76ee\uff0c\u533a\u95f4\u5e73\u5747\u6570\uff0c\u533a\u95f4\u65b9\u5dee\uff0c\u5c31\u77e5\u9053\u8981\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u4e24\u4e2a\u53d8\u91cf\uff1a\n\n$1. $\n**\u533a\u95f4\u548c**\n\n$2.$\n**\u533a\u95f4\u5e73\u65b9\u548c**\n$\\sum_{i=l}^{r}a_i^2$\n\n\u533a\u95f4\u548c\u6ca1\u4ec0\u4e48\u597d\u8bf4\u7684\uff0c\u7ebf\u6bb5\u6811\u5e38\u89c4\u64cd\u4f5c\u3002\u6240\u4ee5\u503c\u5f97\u6ce8\u610f\u7684\u5c31\u662f\u533a\u95f4\u5e73\u65b9\u548c\u4e86\u3002\u5411\u4e0a$pushup$\u548c\u67e5\u8be2\u65f6\u4e0e\u533a\u95f4\u548c\u7684\u64cd\u4f5c\u51e0\u4e4e\u4e00\u6a21\u4e00\u6837\uff0c\u552f\u4e00\u4e0d\u540c\u7684\u662f\u533a\u95f4\u4fee\u6539\u3002\n\n\u521d\u4e8c\u53ca\u4ee5\u4e0a\u7684\u540c\u5b66\u4eec\u4e00\u5b9a\u5f88\u719f\u6089\u8fd9\u4e2a\u5f0f\u5b50\uff1a\n#### $(x+y)^2=x^2+2xy+y^2$\n\n\u90a3\u4e48\u6211\u4eec\u5c31\u7528\u8fd9\u4e2a\u5f0f\u5b50\u6765\u63a8\u51fa\u5982\u4f55\u8fdb\u884c\u61d2\u6807\u8bb0\u4e0b\u653e\u7684\u64cd\u4f5c\uff1a\n\n$\\sum_{i=l}^r(a_i+x)^2$\n\n$=\\sum_{i=l}^r(a_i^2+2a_ix+x^2)$\n\n$=\\sum_{i=l}^ra_i^2+2x\\sum_{i=l}^ra_i+\\sum_{i=l}^rx^2$\n\n\u6240\u4ee5\u4fee\u6539\u65f6\u8fd8\u8981\u7528\u5230\u533a\u95f4\u548c\uff0c\u56e0\u6b64\u4fee\u6539\u987a\u5e8f\u662f\u5148\u533a\u95f4\u5e73\u65b9\u548c\u518d\u533a\u95f4\u548c\u3002\n```cpp\ninline int len(int p) {return t[p].right-t[p].left+1;}\n\ninline void pushdown(int p)\n{\n\tif(t[p].tag)\n\t{\n\t\tint k=t[p].tag;\n\t\tt[p<<1].tag+=k;t[p<<1|1].tag+=k;\n\t\tt[p<<1].square+=2*k*t[p<<1].sum+1ll*len(p<<1)*k*k;\n\t\tt[p<<1|1].square+=2*k*t[p<<1|1].sum+1ll*len(p<<1|1)*k*k;\n\t\tt[p<<1].sum+=1ll*len(p<<1)*k;\n\t\tt[p<<1|1].sum+=1ll*len(p<<1|1)*k;\n\t\tt[p].tag=0;\n\t}\n}\n\nupdate:\nif(l<=t[p].left&&r>=t[p].right)\n\t{\n\t\tt[p].tag+=x;\n\t\tt[p].square+=2*x*t[p].sum+1ll*len(p)*x*x;\n\t\tt[p].sum+=1ll*x*len(p);\n\t\treturn;\n\t}\n```\n\u7ebf\u6bb5\u6811\u90e8\u5206\u6253\u5b8c\u4e86\uff0c\u63a5\u4e0b\u6765\u662f\u6700\u91cd\u8981\u7684\u5904\u7406\u8f93\u51fa\u4e86\u3002\n\u9898\u76ee\u8981\u6c42\u7528\u6700\u7b80\u5206\u6570\u6765\u8f93\u51fa\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u5c06\u8f93\u51fa\u7684\u5206\u6570\u5206\u6210\u5206\u5b50\u548c\u5206\u6bcd\u4e24\u90e8\u5206\u5206\u522b\u5904\u7406\u3002\u533a\u95f4\u5e73\u5747\u6570\u4e5f\u5f88\u7b80\u5355\uff0c\u5206\u6210\u533a\u95f4\u548c\u548c\u533a\u95f4\u5927\u5c0f\u5c31\u53ef\u4ee5\u4e86\u3002\u800c\u533a\u95f4\u65b9\u5dee\u5c31\u9700\u8981\u4e00\u4e9b\u5316\u7b80\u64cd\u4f5c\u4e86\u3002\n\n\u65b9\u5dee\u516c\u5f0f\u662f\u8fd9\u4e2a\uff1a\n#### $s^2=\\frac{1}{n}\\sum_{i=1}^n(a_i-\\overline{a})^2$\n\n\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u63a8\u51fa\uff1a\n\n$\\frac{\\sum(a_i-\\overline{a})^2}{n}$\n\n$=\\frac{\\sum(a_i^2-2\\overline{a}a_i+\\overline{a}^2)}{n}$\n\n$=\\frac{\\sum a_i^2-2\\frac{\\sum a_i}{n}\\sum a_i+n(\\frac{\\sum a_i}{n})^2}{n}$\n\n$=\\frac{\\sum a_i^2-\\frac{(\\sum a_i)^2}{n}}{n}$\n\n$=\\frac{n\\sum a_i^2-(\\sum a_i)^2}{n^2}$\n\n\u6240\u4ee5\u5c31\u7528\u6700\u540e\u8fd9\u4e2a\u5f0f\u5b50\u4f5c\u4e3a\u5206\u6570\u8f93\u51fa\u5c31\u884c\u4e86\u3002\n\n\u53e6\u5916\uff0c\u5343\u4e07\u4e0d\u8981\u5fd8\u8bb0\u5f00$long long$\u3002\n```cpp\n#include<iostream>\n#include<cmath>\n#include<cstring>\n#include<cstdio>\nusing namespace std;\nconst int N=100005;\ntypedef long long ll;\nstruct Segment_Tree\n{\n\tint left,right;\n\tll sum,tag,square;\n}t[N<<2];\nint n,m;\nll a[N];\ntemplate<class type>inline void read(type &k)\n{\n\tk=0;type t=1;char ch=getchar();\n\twhile(ch<'0'||ch>'9') {if(ch=='-') t=-1;ch=getchar();}\n\twhile(ch>='0'&&ch<='9') {k=k*10+ch-'0';ch=getchar();}\n\tk*=t;\n}\ninline ll gcd(ll x,ll y) {return y==0?x:gcd(y,x%y);}                              //\u5206\u6570\u5316\u7b80\u7528 \ninline void pushup(int p)\n{\n\tt[p].square=t[p<<1].square+t[p<<1|1].square;\n\tt[p].sum=t[p<<1].sum+t[p<<1|1].sum;\n}\ninline void build(int p,int l,int r)\n{\n\tt[p].left=l;t[p].right=r;\n\tif(l==r)\n\t{\n\t\tt[p].sum=a[l];t[p].square=a[l]*a[l];\n\t\treturn;\n\t}\n\tint mid=(l+r)>>1;\n\tbuild(p<<1,l,mid);\n\tbuild(p<<1|1,mid+1,r);\n\tpushup(p);\n}\ninline int len(int p) {return t[p].right-t[p].left+1;}\ninline void pushdown(int p)\n{\n\tif(t[p].tag)\n\t{\n\t\tint k=t[p].tag;\n\t\tt[p<<1].tag+=k;t[p<<1|1].tag+=k;\n\t\tt[p<<1].square+=2*k*t[p<<1].sum+1ll*len(p<<1)*k*k;\n\t\tt[p<<1|1].square+=2*k*t[p<<1|1].sum+1ll*len(p<<1|1)*k*k;\n\t\tt[p<<1].sum+=1ll*len(p<<1)*k;\n\t\tt[p<<1|1].sum+=1ll*len(p<<1|1)*k;\n\t\tt[p].tag=0;\n\t}\n}\ninline void update(int p,int l,int r,ll x)\n{\n\tif(l<=t[p].left&&r>=t[p].right)\n\t{\n\t\tt[p].tag+=x;\n\t\tt[p].square+=2*x*t[p].sum+1ll*len(p)*x*x;\n\t\tt[p].sum+=1ll*x*len(p);\n\t\treturn;\n\t}\n\tpushdown(p);\n\tint mid=(t[p].left+t[p].right)>>1;\n\tif(l<=mid) update(p<<1,l,r,x);\n\tif(r>mid) update(p<<1|1,l,r,x);\n\tpushup(p);\n}\ninline ll query1(int p,int l,int r)\n{\n\tif(l<=t[p].left&&r>=t[p].right) return t[p].sum;\n\tpushdown(p);\n\tint mid=(t[p].left+t[p].right)>>1;ll ans=0;\n\tif(l<=mid) ans+=query1(p<<1,l,r);\n\tif(r>mid) ans+=query1(p<<1|1,l,r);\n\treturn ans;\n}\ninline ll query2(int p,int l,int r)\n{\n\tif(l<=t[p].left&&r>=t[p].right) return t[p].square;\n\tpushdown(p);\n\tint mid=(t[p].left+t[p].right)>>1;ll ans=0;\n\tif(l<=mid) ans+=query2(p<<1,l,r);\n\tif(r>mid) ans+=query2(p<<1|1,l,r);\n\treturn ans;\n}\nint main()\n{\n\tint i,opt,x,y;\n\tll z;\n\tread(n);read(m);\n\tfor(i=1;i<=n;i++) read(a[i]);\n\tbuild(1,1,n);\n\twhile(m--)\n\t{\n\t\tread(opt);read(x);read(y);\n\t\tif(opt==1) read(z),update(1,x,y,z);\n\t\tif(opt==2)\n\t\t{\n\t\t\tll k=query1(1,x,y),t=gcd(k,y-x+1);\n\t\t\tprintf(\"%lld/%lld\\n\",k/t,1ll*(y-x+1)/t);\n\t\t}\n\t\tif(opt==3)\n\t\t{\n\t\t\tll k1=query1(1,x,y),k2=query2(1,x,y),ans1,ans2,t=(ll)y-x+1;          //k1\u4e3a\u533a\u95f4\u548c\uff0ck2\u4e3a\u533a\u95f4\u5e73\u65b9\u548c \n//\t\t\tcout<<k1<<\" \"<<k2<<endl;\n\t\t\tans1=t*k2-k1*k1;ans2=t*t;                                            //\u76f4\u63a5\u5957\u7528\u63a8\u51fa\u7684\u516c\u5f0f \n//\t\t\tcout<<ans1<<\" \"<<ans2<<endl;\n\t\t\tll k=gcd(ans1,ans2);\n\t\t\tprintf(\"%lld/%lld\\n\",ans1/k,ans2/k);\n\t\t}\n\t}\n\treturn 0;\n}\n```\n#### \u4e09\u500d\u7ecf\u9a8c\u9898\uff1a\n\n$1.$ [P1471 \u65b9\u5dee](https://www.luogu.org/problem/P1471)\n\u628a$long long$\u6539\u6210$double$\uff0c\u4e5f\u4e0d\u7528\u8fd9\u4e48\u9ebb\u70e6\u7b97\u5206\u6570\uff0c\u76f4\u63a5\u76f8\u9664\u5373\u53ef\u3002\n\n$2.$ [P5142 \u533a\u95f4\u65b9\u5dee](https://www.luogu.org/problem/P5142)\n\u9700\u8981\u6c42\u6700\u540e\u5206\u6570\u7684\u9006\u5143\u3002",
        "postTime": 1573538472,
        "uid": 59980,
        "name": "lianliangyu",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 P2122 \u3010\u8fd8\u6559\u5ba4\u3011"
    },
    {
        "content": "## \u9898\u610f\n\u7ed9\u5b9a\u4e00\u4e2a\u957f\u4e3a $n$ \u7684\u5e8f\u5217\uff0c\u8981\u5728\u8be5\u5e8f\u5217\u4e0a\u8fdb\u884c $m$ \u6b21\u64cd\u4f5c\uff0c\u6bcf\u6b21\u64cd\u4f5c\u5982\u4e0b\uff1a   \n```1 l r d``` \u5c06 $a_l\\sim a_r$ \u90fd\u52a0\u4e0a $d$\u3002    \n```2 l r``` \u6c42\u51fa $a_l\\sim a_r$ \u7684\u5e73\u5747\u6570\u3002  \n```3 l r``` \u6c42\u51fa $a_l\\sim a_r$ \u7684\u65b9\u5dee\u3002   \n\u5bf9\u4e8e\u6bcf\u4e2a\u8be2\u95ee\uff0c\u4ee5\u4e00\u4e2a\u6700\u7b80\u5206\u6570 ```a/b``` \u7684\u5f62\u5f0f\u8f93\u51fa\uff0c\u5f53 $a=0$ \u65f6\u8f93\u51fa ```0/1```\u3002\n## Solution\n\u96be\u5ea6\u4e3b\u8981\u5728\u63a8\u5f0f\u5b50\u4e0a\uff0c\u5269\u4e0b\u7684\u5c31\u662f\u4e2a\u7ebf\u6bb5\u6811\u7684\u677f\u5b50\u3002\n#### \u524d\u7f6e\u77e5\u8bc6\uff1a   \n\u7ebf\u6bb5\u6811\u521d\u6b65\uff08\u533a\u95f4\u6c42\u548c\uff0c\u533a\u95f4\u4fee\u6539\uff0c\u4e0d\u4f1a\u7684\u8bf7\u5148\u79fb\u6b65[P3372 \u3010\u6a21\u677f\u3011\u7ebf\u6bb5\u68111](https://www.luogu.com.cn/problem/P3372)\uff09\u3002   \n#### Step1\uff1a\u63a8\u51fa\u8ba1\u7b97\u516c\u5f0f\n\u5e73\u5747\u6570\u5c31\u4e0d\u7528\u8bf4\u4e86\uff0c\u672c\u6765\u5c31\u662f $\\frac{\\sum_{i=l}^ra_i}{r-l+1}$\uff0c\u76f4\u63a5\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u4e00\u4e2a\u533a\u95f4\u548c\uff0c\u4f46\u662f\u65b9\u5dee\u7684\u8bdd\u8fd8\u8981\u518d\u63a8\u4e00\u4e0b\u3002 \n\n\u89c2\u5bdf\u4e00\u4e0b\u65b9\u5dee\u7684\u8ba1\u7b97\u5f0f\u5b50: $s^2=\\frac{\\sum_{i=l}^r (a_i-\\bar a)^2}{r-l+1}$\u3002  \n\n\u5c55\u5f00\u4e00\u4e0b\u53ef\u4ee5\u5f97\u5230\uff1a $s^2=\\frac{\\sum_{i=l}^r (a_i^2+\\bar a^2-2\\times a_i\\times \\bar a)}{r-l+1}$\u3002\n\n\u518d\u5206\u5f00\u6c42\u548c\uff1a$s^2=\\frac{\\sum_{i=l}^r a_i^2+\\bar a\\times \\sum_{i=l}^r \\bar a-2\\times \\bar a\\times \\sum_{i=l}^r a_i}{r-l+1}$\u3002  \n\n\u4ee4 $sum=\\sum_{i=l}^r a_i,sum2=\\sum_{i=l}^r a_i^2$,\u56e0\u4e3a $\\sum_{i=l}^r \\bar a=sum$,\u6240\u4ee5\u539f\u5f0f\u53ef\u4ee5\u8fdb\u4e00\u6b65\u7b80\u5316\u4e3a $s^2=\\frac{sum2+\\bar a\\times  sum-2\\times \\bar a\\times sum}{r-l+1}$,\u6700\u7ec8\u5f97\u5230 $s^2=\\frac{sum2-\\bar a\\times  sum}{r-l+1}$\u3002   \n\u5f97\u5230\u8fd9\u4e2a\u5f0f\u5b50\u4e4b\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u77e5\uff0c\u8981\u7ef4\u62a4\u4e24\u6837\u4e1c\u897f\uff1a$sum$ \u548c $sum2$\u3002    \n~~\u606d\u559c\u4f60\u5b8c\u6210\u4e86\u4e09\u5206\u4e4b\u4e00~~\u3002\n#### Step2\uff1a\u63a8\u51fa\u4fee\u6539\u516c\u5f0f\n$sum$ \u7684\u4fee\u6539\u5c31\u4e0d\u8bf4\u4e86\uff0c~~\u542c\u6211\u7684\u8bdd\u5148\u505aP3372\u518d\u6765\u770b\u7684\u80af\u5b9a\u90fd\u4f1a\u4e86~~\uff0c\u4f46\u662f   $sum2$ \u7684\u4fee\u6539\u8fd8\u662f\u8981\u518d\u63a8\u4e00\u4e0b\u5f0f\u5b50\u3002   \n\u8bfb\u9898\uff0c\u53ef\u4ee5\u53d1\u73b0\uff0c\u9898\u76ee\u4e0a\u8bf4\u7684\u662f\u7ed9 $a_l\\sim a_r$ \u540c\u65f6\u52a0\u4e0a\u540c\u4e00\u4e2a\u6570 $d$ ,\u800c\u589e\u52a0\u7684\u603b\u91cf\u5c31\u662f $\\sum_{i=l}^r ((a_i+d)^2 -a_i^2))$\u3002   \n\u5c55\u5f00\u5f0f\u5b50\uff1a $\\sum_{i=l}^r (a_i^2+d^2 -a_i^2+2\\times a_i\\times d)$\u3002  \n\u6d88\u6389 $a_i^2$ \u5e76\u5206\u5f00\u6c42\u548c\uff1a $\\sum_{i=l}^r d^2 +2\\times d\\times \\sum_{i=l}^r a_i$\uff0c\u53ef\u4ee5\u53d1\u73b0\uff0c\u6700\u7ec8\u5f97\u5230\u7684\u7ed3\u679c\u5c31\u662f $d^2\\times (r-l+1)+2\\times d\\times sum$,\u63d0\u51fa\u4e00\u4e2a $d$ \u5f97\u5230  $d\\times ((r-l+1)\\times d+2\\times sum)$\u3002   \n\u6ce8\u610f\u4e00\u70b9\uff0c\u4e00\u5b9a\u8981\u5148\u4fee\u6539 $sum2$ \u518d\u4fee\u6539 $sum$\uff0c\u56e0\u4e3a\u4f60\u4fee\u6539 $sum2$ \u65f6\u7528\u7684\u662f\u4e4b\u524d\u7684\u533a\u95f4\u548c\uff0c\u5982\u679c\u5148\u6539 $sum$ \u7684\u8bdd\u533a\u95f4\u548c\u5c31\u53d8\u5927\u4e86\uff0c\u7b54\u6848\u5c31\u4f1a\u5927\u5f88\u591a\u3002   \n~~\u606d\u559c\u4f60\u5b8c\u6210\u4e86\u4e09\u5206\u4e4b\u4e8c~~\u3002\n#### Step3\uff1a\u63a8\u51fa\u67e5\u8be2\u516c\u5f0f  \n\u5b8c\u6210\u4e86\u4e0a\u9762\u4e24\u4e2a\u5f0f\u5b50\u7684\u63a8\u5bfc\u4e4b\u540e\uff0c\u5efa\u7ebf\u6bb5\u6811\u76f8\u4fe1\u5927\u5bb6\u90fd\u4f1a\uff0c\u4fee\u6539\u64cd\u4f5c\u5e94\u8be5\u4e5f\u90fd\u4f1a\uff0c\u5c31\u662f\u67e5\u8be2\u7684\u8bdd\u8fd8\u8981\u9ebb\u70e6\u4e00\u70b9\uff0c\u518d\u63a8\u51fa\u4e00\u4e2a\u5f0f\u5b50\u3002     \n\u5b9a\u4e49 $len=r-l+1$\u3002  \n\u5e73\u5747\u6570\u7684\u8bdd\u5e94\u8be5\u6ca1\u4eba\u4e0d\u4f1a\u5427\uff0c\u5c31\u662f $\\frac{sum}{len}$\uff0c\u7ea6\u5206\u4e00\u4e0b\u5c31\u597d\u3002 \n\n\u6839\u636e\u65b9\u5dee\u7684\u8ba1\u7b97\u516c\u5f0f\uff0c$s^2=\\frac{sum2-\\bar a\\times sum}{len}$\u3002  \n\u8fd9\u91cc\u7684\u5e73\u5747\u6570\u4e0d\u80fd\u76f4\u63a5\u7b97\u51fa\u6765\uff0c\u53ea\u80fd\u62ff $sum$ \u53bb\u7b97\uff0c\u53d8\u6210 $\\frac{sum^2}{len}$,\u5426\u5219\u4f1a\u6709\u8bef\u5dee\uff0c\u56e0\u4e3a\u6709\u603b\u548c\u4e0d\u4e3a\u533a\u95f4\u957f\u5ea6\u7684\u500d\u6570\u7684\u60c5\u51b5\u3002 \n\u7136\u540e\u5f0f\u5b50\u5c31\u53d8\u6210\u4e86 $s^2=\\frac{sum2-\\frac{sum^2}{len}}{len}$\uff0c\u5206\u5b50\u5206\u6bcd\u540c\u65f6\u4e58\u4ee5 $len$ \u5f97\u5230 $s^2=\\frac{len\\times sum2-sum^2}{len^2}$\u3002  \n\u7136\u540e\u5c31\u662f\u7b97\u51fa\u533a\u95f4\u957f\u5ea6\u7684\u5e73\u65b9\uff0c\u518d\u628a\u5206\u5b50\u7b97\u51fa\u6765\uff0c\u7ea6\u5206\u4e00\u4e0b\u5373\u53ef\u3002  \n\u8fd9\u91cc\u6709\u4e00\u4e2a\u5c0f\u6280\u5de7\uff0c\u5c31\u662f\u67e5\u8be2 $sum2$ \u7684\u65f6\u5019\u4f60\u53ef\u4ee5\u5f00\u4e00\u4e2a\u5168\u5c40\u53d8\u91cf\uff0c\u6bcf\u6b21\u67e5\u8be2\u524d\u8bbe\u4e3a 0\uff0c\u6bcf\u5f53\u7d2f\u52a0 $sum2$ \u7684\u65f6\u5019\u987a\u4fbf\u7ed9\u8fd9\u4e2a\u5168\u5c40\u53d8\u91cf\u4e5f\u7d2f\u52a0\u4e0a\u90a3\u4e2a\u8282\u70b9\u7684  $sum$\uff0c\u8fd9\u6837\u7684\u8bdd\u6700\u540e\u5c31\u4e0d\u7528\u518d\u6b21\u67e5\u8be2\uff0c\u80fd\u5feb\u4e00\u70b9\u3002    \n~~\u5b8c\u7ed3\u6492\u82b1~~\u3002\n## Code\n\u8dd1\u7684\u633a\u5feb\u7684\u3002\n```c\n#include <bits/stdc++.h>\nusing namespace std;\n#define ll long long\n#define rint register int\n#define gc getchar\nint n,m,tp,x,y;\nll a[100001],sum[400001],z,lazy[400001],sum2[400001],sm,sm2,gcd,len;\n//sum\u7ef4\u62a4\u533a\u95f4\u548c\uff0csum2\u7ef4\u62a4\u533a\u95f4\u6240\u6709\u6570\u7684\u5e73\u65b9\u4e4b\u548c\uff0csm\u5c31\u662f\u90a3\u4e2a\u5168\u5c40\u53d8\u91cf\ninline int read(){\n\tint x=0;\n\tchar ch=gc();\n\twhile(!isdigit(ch)) ch=gc();\n\twhile(isdigit(ch)) x=x*10+ch-48,ch=gc();\n\treturn x;\n}\ninline void push_down(int p,ll x,int l,int mid,int r){\n\tsum2[p<<1]+=x*(sum[p<<1]*2+x*(mid+1-l)),sum2[p<<1|1]+=x*(sum[p<<1|1]*2+x*(r-mid)),sum[p<<1]+=(mid+1-l)*x,sum[p<<1|1]+=(r-mid)*x,lazy[p<<1]+=x,lazy[p<<1|1]+=x;\n}\ninline void build(int p,int l,int r){\n\tif(!(l^r)){\n\t\tsum[p]=a[l],sum2[p]=a[l]*a[l];//\u521d\u59cb\u5316\u6bcf\u4e2a\u53f6\u5b50\u7ed3\u70b9\u7684sum,sum2\n\t\treturn;\n\t}int mid=l+r>>1;\n\tbuild(p<<1,l,mid),build(p<<1|1,mid+1,r),sum[p]=sum[p<<1]+sum[p<<1|1],sum2[p]=sum2[p<<1]+sum2[p<<1|1];//\u5efa\u6811\u5e76\u66f4\u65b0\u7236\u4eb2\u8282\u70b9\u7684\u548c\n}\ninline void change(int p,int l,int r,ll d,int x,int y){\n\tif(l<=x&&y<=r){\n\t\tsum2[p]+=d*(d*(y-x+1)+2*sum[p]),sum[p]+=(y-x+1)*d,lazy[p]+=d;\n\t\treturn;//\u6839\u636e\u516c\u5f0f\u8ba1\u7b97\n\t}int mid=x+y>>1;\n\tif(lazy[p]) push_down(p,lazy[p],x,mid,y),lazy[p]=0;//\u4e0b\u4f20\u6807\u8bb0\n\tif(l<=mid) change(p<<1,l,r,d,x,mid);\n\tif(mid<r) change(p<<1|1,l,r,d,mid+1,y);\n\tsum[p]=sum[p<<1]+sum[p<<1|1],sum2[p]=sum2[p<<1]+sum2[p<<1|1];\n}\ninline ll query_ave(int p,int l,int r,int x,int y){\n\tif(l<=x&&y<=r) return sum[p];\n\tint mid=x+y>>1;\n\tif(lazy[p]) push_down(p,lazy[p],x,mid,y),lazy[p]=0;\n\tll num=0;\n\tif(l<=mid) num+=query_ave(p<<1,l,r,x,mid);\n\tif(mid<r) num+=query_ave(p<<1|1,l,r,mid+1,y);\n\treturn num;\n}\ninline ll query_fc(int p,int l,int r,int x,int y){\n\tif(l<=x&&y<=r){\n\t\tsm+=sum[p];//\u7d2f\u52a0sum2\u65f6\u987a\u4fbf\u4e5f\u628asum\u7d2f\u52a0\u4e0a\n\t\treturn sum2[p];\n\t}int mid=x+y>>1;\n\tif(lazy[p]) push_down(p,lazy[p],x,mid,y),lazy[p]=0;\n\tll num=0;\n\tif(l<=mid) num+=query_fc(p<<1,l,r,x,mid);\n\tif(mid<r) num+=query_fc(p<<1|1,l,r,mid+1,y);\n\treturn num;\n}\nint main(){\n\tn=read(),m=read();\n\tfor(rint i=1;i<=n;i++) a[i]=read();\n\tbuild(1,1,n);\n\twhile(m--){\n\t\ttp=read(),x=read(),y=read();\n\t\tif(tp<2) z=read(),change(1,x,y,z,1,n);\n\t\telse{\n\t\t\tif(tp&1){\n\t\t\t\tlen=y-x+1,sm=0,sm2=query_fc(1,x,y,1,n)*len,len*=len,sm*=sm,sm2-=sm;\n\t\t\t\tif(!sm2) printf(\"0/1\\n\");//\u6ce8\u610f\u7279\u5224\n\t\t\t\telse gcd=__gcd(sm2,len),sm2/=gcd,len/=gcd,printf(\"%lld/%lld\\n\",sm2,len);//\u6708\u4efd\u540e\u8f93\u51fa\n\t\t\t}else{\n\t\t\t\tlen=y-x+1,sm=query_ave(1,x,y,1,n);\n\t\t\t\tif(!sm) printf(\"0/1\\n\");\n\t\t\t\telse gcd=__gcd(sm,len),sm/=gcd,len/=gcd,printf(\"%lld/%lld\\n\",sm,len);\n\t\t\t}\n\t\t} \n\t}return 0;\n}\n```\n",
        "postTime": 1639234905,
        "uid": 438168,
        "name": "OldVagrant",
        "ccfLevel": 6,
        "title": "P2122 \u9898\u89e3"
    },
    {
        "content": "\u7ebf\u6bb5\u6811\n\nbt\u5efa\u6811\uff1b\n\npushdown\u7ef4\u62a4;\n\nupdate\u64cd\u4f5c1\uff1b\n\ngetsum\u64cd\u4f5c2\uff1b\n\ngetmul\u64cd\u4f5c3\uff1b\n\n.c\u662f\u6743\u503c\u7684\u548c\uff1b\n\n.mul\u662f\u6743\u503c\u5e73\u65b9\u7684\u548c\uff1b\n\n.add\u4f20\u9012  \u589e\u52a0\u7684\u503c\uff0c\u7528\u6765\u7ef4\u62a4\uff1b\n\n\u4ee3\u7801\uff1b\n\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<cstring>\n#include<algorithm>\nusing namespace std;\nconst int maxn=100000+5;\ninline int read()\n{\n    int x=0,f=1; char ch=getchar();\n    while(ch<'0'||ch>'9'){if(ch=='-') f=-1; ch=getchar();}\n    while(ch>='0'&&ch<='9'){x=x*10+ch-'0'; ch=getchar();}\n    return x*f;\n}\nint n,m,len;\nint a[maxn];\nstruct node\n{\n    int l,r,lc,rc;\n    long long  c,mul,add;\n}tr[maxn<<1];\nvoid bt(int x,int y)\n{\n    len++; int now=len;\n    tr[now].l=x; tr[now].r=y;\n    tr[now].lc=tr[now].rc=0;\n    if(x==y) \n    { tr[now].c=a[x]; tr[now].mul=a[x]*a[x]; }\n    else\n    {\n        int mid=(x+y)>>1;\n        tr[now].lc=len+1; bt(x,mid);\n        tr[now].rc=len+1; bt(mid+1,y);\n        tr[now].c=tr[tr[now].lc].c+tr[tr[now].rc].c;\n        tr[now].mul=tr[tr[now].lc].mul+tr[tr[now].rc].mul;\n    }\n}\ninline void pushdown(int now)\n{\n    if(tr[now].l==tr[now].r||!tr[now].add) return;\n    int lc=tr[now].lc,rc=tr[now].rc;\n    tr[lc].mul=tr[lc].mul+2*tr[lc].c*tr[now].add+(tr[lc].r-tr[lc].l+1)*tr[now].add*tr[now].add;\n    tr[rc].mul=tr[rc].mul+2*tr[rc].c*tr[now].add+(tr[rc].r-tr[rc].l+1)*tr[now].add*tr[now].add;\n    tr[lc].c=tr[lc].c+(tr[lc].r-tr[lc].l+1)*tr[now].add;\n    tr[rc].c=tr[rc].c+(tr[rc].r-tr[rc].l+1)*tr[now].add;\n    tr[lc].add+=tr[now].add; tr[rc].add+=tr[now].add;\n    tr[now].add=0;\n}\nvoid update(int now,int x,int y,int d)\n{\n    if(tr[now].l==x&&tr[now].r==y)\n    {\n        tr[now].mul=tr[now].mul+2*tr[now].c*d+(tr[now].r-tr[now].l+1)*d*d;\n        tr[now].c=tr[now].c+(y-x+1)*d;\n        tr[now].add+=d;\n    }else\n    {\n        pushdown(now);\n        int lc=tr[now].lc,rc=tr[now].rc;\n        int mid=(tr[now].l+tr[now].r)>>1;\n        if(y<=mid) update(lc,x,y,d);\n        else if(x>=mid+1) update(rc,x,y,d);\n        else {  update(lc,x,mid,d); update(rc,mid+1,y,d); }\n        tr[now].c=tr[lc].c+tr[rc].c;\n        tr[now].mul=tr[lc].mul+tr[rc].mul;\n    }\n}\nlong long  getsum(int now,int x,int y)\n{\n    if(tr[now].l==x&&tr[now].r==y)\n        return tr[now].c;\n    else\n    {\n        pushdown(now);\n        int lc=tr[now].lc,rc=tr[now].rc;\n        int mid=(tr[now].l+tr[now].r)>>1;\n        if(y<=mid) return getsum(lc,x,y);\n        else if(x>=mid+1) return getsum(rc,x,y);\n        else return getsum(lc,x,mid)+getsum(rc,mid+1,y);\n    }\n}\nlong long  getmul(int now,int x,int y)\n{\n    if(tr[now].l==x&&tr[now].r==y)\n        return tr[now].mul;\n    else\n    {\n        pushdown(now);\n        int lc=tr[now].lc,rc=tr[now].rc;\n        int mid=(tr[now].l+tr[now].r)>>1;\n        if(y<=mid) return getmul(lc,x,y);\n        else if(x>=mid+1) return getmul(rc,x,y);\n        else return getmul(lc,x,mid)+getmul(rc,mid+1,y);\n    }\n}\nlong long  gcd(long long  a, long long  b)\n{\n    if(b==0) return a;\n    return gcd(b,a%b);\n}\nint main()\n{\n    //freopen(\"classroom.in\",\"r\",stdin);\n    //freopen(\"classroom.out\",\"w\",stdout);\n    n=read();m=read();\n    for(int i=1;i<=n;i++) a[i]=read();\n    bt(1,n);\n    for(int i=1;i<=m;i++)\n    {\n        int p,x,y,d;\n        p=read();\n        if(p==1)\n        {\n            x=read(); y=read(); d=read();\n            update(1,x,y,d);\n        }else\n        {\n            x=read(); y=read();\n            long long  sum,num,fz,fm,t;\n            sum=getsum(1,x,y); num=y-x+1;\n            if(!sum){cout<<0<<'/'<<1<<endl; continue;}\n            t=gcd(sum,num);\n            if(p==2) cout<<sum/t<<'/'<<num/t<<endl;\n            else if(p==3)\n            {\n                long long  mul=getmul(1,x,y);\n                fz=mul*num-sum*sum;\n                fm=num*num;\n                t=gcd(fz,fm);\n                cout<<fz/t<<'/'<<fm/t<<endl;\n            }\n        }\n    }\n    return 0;\n}\n\n```",
        "postTime": 1504083818,
        "uid": 36560,
        "name": "QSWei",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P2122 \u3010\u8fd8\u6559\u5ba4\u3011"
    },
    {
        "content": "#### \u9898\u76ee\u5927\u610f\n\n\n------------\n\u7ed9\u51fa\u4e00\u4e2a\u6570\u5217 $\\left \\{ a_n \\right \\} $\uff0c\u652f\u6301\u4e09\u79cd\u64cd\u4f5c\n\n- \u533a\u95f4\u52a0\n- \u67e5\u8be2\u4e00\u6bb5\u533a\u95f4\u7684\u5e73\u5747\u6570\n- \u67e5\u8be2\u4e00\u6bb5\u533a\u95f4\u7684\u65b9\u5dee\n\n#### \u601d\u8def\u5206\u6790\n\n\n------------\n\u65b9\u5dee\u7684\u516c\u5f0f\u4e3a $s^{2}=\\frac{1}{n} \\sum_{i=1}^{n}\\left(a_{i}-\\bar{a}\\right)^{2}$\n\n\u6839\u636e\u5b8c\u5168\u5e73\u65b9\u516c\u5f0f\u5c55\u5f00\u5f97\u5230 $s^{2}=\\frac{1}{n} \\sum_{i=1}^{n}(a_i^2-2a_i\\times\\bar{a}+\\bar{a}^2)$\n\n$\\therefore s^2 = \\frac{(a_1^2+a_2^2+\\cdots+a_n^2)+n \\times \\bar{a}^2-2 \\bar{a}\\times (a_1+a_2+\\cdots+a_n)}{n}$\n\n$\\because \\bar{a} = \\frac{1}{n}\\sum_{i=1}^na_i=\\frac{a_1+a_2+\\cdots+a_n}{n}$\n\n$\\therefore s^2 = \\frac{a_1^2+a_2^2+\\cdots+a_n^2}{n}+\\bar{a}^2 - 2\\bar{a}^2=\\frac{a_1^2+a_2^2+\\cdots+a_n^2}{n}-\\bar{a}^2$\n\n\u6240\u4ee5\u53ea\u9700\u7ef4\u62a4\u533a\u95f4\u548c\u3001\u533a\u95f4\u5e73\u65b9\u548c\u5373\u53ef\u3002\n\n\u5bf9\u4e00\u6bb5\u533a\u95f4\u52a0 $k$ \u7684\u65f6\u5019\uff1a\n\n$a_1^2 + a_2^2+\\cdots+a_n^2 \\to (a_1+k)^2+(a_2+k)^2+\\cdots+(a_n+k)^2$ \n\n$= \\sum_{i=1}^n(a_i^2+k^2+2a_i\\times k)$\n\n$= a_1^2+a_2^2+\\cdots+a_n^2+n\\times k^2 + 2k\\times(a_1+a_2+\\cdots+a_n)$\n\n\u6ce8\u610f\uff0c\u4e0b\u4f20\u61d2\u6807\u8bb0\u7684\u65f6\u5019\u9700\u8981\u5148\u66f4\u65b0\u533a\u95f4\u5e73\u65b9\u548c\u518d\u66f4\u65b0\u533a\u95f4\u548c\uff0c\u56e0\u4e3a\u66f4\u65b0\u533a\u95f4\u5e73\u65b9\u548c\u9700\u8981\u7528\u5230\u539f\u6765\u7684\u533a\u95f4\u548c\u3002\n\n#### \u4ee3\u7801\u5b9e\u73b0\n\n\n------------\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<cmath>\n#include<cstring>\n#include<cstdlib>\n#include<algorithm>\n#include<vector>\n#include<cctype>\n#include<ctime>\n#include<queue>\n#define int long long\nusing namespace std;\nconst int N = 2e5 + 10;\nconst int mod = 1e9 + 7;\ninline int read(){\n    int x=0,f=1;\n    char ch=getchar();\n    for(;!isdigit(ch);ch=getchar()) if(ch=='-') f=-1;\n    for(; isdigit(ch);ch=getchar()) x=(x<<3)+(x<<1)+(ch^48);\n    return x*f;\n}\nstruct Tree{\n\tint l,r,add;\n\tint sum,pfsum;\n}tree[N<<2];\nvoid push_up(int p){\n\ttree[p].sum = tree[p<<1].sum + tree[p<<1|1].sum;\n\ttree[p].pfsum = tree[p<<1].pfsum + tree[p<<1|1].pfsum;\n}\nint a[N];\nvoid build(int p,int l,int r){\n\ttree[p].l = l , tree[p].r = r;\n\tif(l == r){\n\t\ttree[p].sum = a[l];\n\t\ttree[p].pfsum = a[l] * a[l];\n\t\treturn;\n\t}\n\tint mid = l + r >> 1;\n\tbuild(p<<1,l,mid); build(p<<1|1,mid+1,r);\n\tpush_up(p);\n}\nvoid Add(int p,int k){\n\ttree[p].add += k;\n\ttree[p].pfsum += 2 * k * tree[p].sum + k * k * (tree[p].r - tree[p].l + 1);\n\ttree[p].sum += k * (tree[p].r - tree[p].l + 1);\n}\nvoid push_down(int p){\n\tif(tree[p].add != 0){\n\t\tAdd(p<<1,tree[p].add);\n\t\tAdd(p<<1|1,tree[p].add);\n\t\ttree[p].add = 0;\n\t}\n}\nvoid modify(int p,int l,int r,int k){\n\tif(l <= tree[p].l && tree[p].r <= r){\n\t\tAdd(p,k);\n\t\treturn;\n\t}\n\tpush_down(p);\n\tint mid = tree[p].l + tree[p].r >> 1;\n\tif(l <= mid) modify(p<<1,l,r,k);\n\tif(r >  mid) modify(p<<1|1,l,r,k);\n\tpush_up(p);\n}\nint query1(int p,int l,int r){\n\tif(l <= tree[p].l && tree[p].r <= r){\n\t\treturn tree[p].sum;\n\t}\n\tpush_down(p);\n\tint res = 0;\n\tint mid = tree[p].l + tree[p].r >> 1;\n\tif(l <= mid) res += query1(p<<1,l,r);\n\tif(r >  mid) res += query1(p<<1|1,l,r);\n\treturn res;\n}\nint query2(int p,int l,int r){\n\tif(l <= tree[p].l && tree[p].r <= r){\n\t\treturn tree[p].pfsum;\n\t}\n\tpush_down(p);\n\tint res = 0;\n\tint mid = tree[p].l + tree[p].r >> 1;\n\tif(l <= mid) res += query2(p<<1,l,r);\n\tif(r >  mid) res += query2(p<<1|1,l,r);\n\treturn res;\n}\nint gcd(int a,int b){\n\tif(b == 0) return a;\n\telse return gcd(b,a%b);\n}\nsigned main(){\n\tint n = read() , m = read();\n\tfor(int i=1;i<=n;i++) a[i] = read();\n\tbuild(1,1,n);\n\tfor(int i=1;i<=m;i++){\n\t\tint opt = read();\n\t\tif(opt == 1){\n\t\t\tint l = read() , r = read() , k = read();\n\t\t\tmodify(1,l,r,k);\n\t\t}\n\t\tif(opt == 2){\n\t\t\tint l = read() , r = read();\n\t\t\tint res1 = query1(1,l,r);\n\t\t\tif(res1 == 0){\n\t\t\t\tprintf(\"0/1\\n\");\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tint res2 = r - l + 1;\n\t\t\tint pos = gcd(res1,res2);\n\t\t\tprintf(\"%lld/%lld\\n\",res1/pos,res2/pos);\n\t\t}\n\t\tif(opt == 3){\n\t\t\tint l = read() , r = read();\n\t\t\tint sum = query1(1,l,r);\n\t\t\tint res1 = (r - l + 1) * query2(1,l,r) - sum * sum;\n\t\t\tif(res1 == 0){\n\t\t\t\tprintf(\"0/1\\n\");\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tint res2 = (r - l + 1) * (r - l + 1);\n\t\t\tint pos = gcd(res1,res2);\n\t\t\tif(res1 == 0) printf(\"0/1\\n\");\n\t\t\tprintf(\"%lld/%lld\\n\",res1/pos,res2/pos);\n\t\t}\n\t}\n\treturn 0;\n}\n```\n",
        "postTime": 1659864562,
        "uid": 335615,
        "name": "0xFF",
        "ccfLevel": 0,
        "title": "P2122"
    },
    {
        "content": "\u663e\u7136\u8fd9\u9898\u8981\u7528\u7ebf\u6bb5\u6811\u641e\u3002\n\n# \u601d\u8def\n\n\u5e73\u5747\u6570\u53ea\u9700\u8981\u6c42\u533a\u95f4\u548c\uff0c\u518d\u9664\u4ee5\u533a\u95f4\u957f\u5ea6\u5373\u53ef\u3002\n\n\u90a3\u4e48\u533a\u95f4\u65b9\u5dee\u600e\u4e48\u505a\u5462\uff1f\u4e0b\u9762\u5230\u4e86\u559c\u95fb\u4e50\u89c1\u7684\u63a8\u5f0f\u5b50\u73af\u8282\uff1a\n\n\u8bbe $x$ \u4e3a $[1,n]$ \u5e73\u5747\u6570\n\n\u65b9\u5dee\u516c\u5f0f\n\n$$\\frac{\\sum_{i=1}^n {(a_i-x)^2}}{n}$$\n\n\u5b8c\u5168\u5e73\u65b9\u516c\u5f0f\u5c55\u5f00\n\n$$\\frac{\\sum_{i=1}^n {(a_i^2+x^2-2a_ix)}}{n}$$\n\n\u5206\u6bcd\u62c9\u8fdb\u53bb\u5c55\u5f00\n\n$$\\sum_{i=1}^n {(\\frac{a_i^2}{n}+\\frac{x^2}{n}-\\frac{2a_ix}{n})}$$\n\n\u7b2c\u4e00\u9879\u62c9\u51fa\u6765\n\n$$\\frac{\\sum_{i=1}^n {a_i^2}}{n}+\\sum{_{i=1}^n{(\\frac{x^2}{n}-\\frac{2a_ix}{n})}}$$\n\n\u540e\u4e24\u9879\u5c55\u5f00\uff0c\u8bbe $sqr$ \u4e3a $[1,n]$ \u5e73\u65b9\u548c\uff0c$s$ \u4e3a $[1,n]$ \u7684\u548c\uff0c\u5219 $s=nx$\n\n$$\\frac{sqr}{n}+x^2-\\frac{2nx^2}{n}$$\n\n\u5408\u5e76\u540c\u7c7b\u9879\u53ef\u5f97\n\n$$\\frac{sqr}{n}-x^2$$ \n\n\u5c06 $x$ \u4ee3\u6362\u5f97\n\n$$\\frac{sqr}{n}-\\frac{s^2}{n^2}$$\n\n\u6240\u4ee5\u6211\u4eec\u53ea\u9700\u8981\u5206\u522b\u7ef4\u62a4\u533a\u95f4\u5e73\u65b9\u548c\u3001\u533a\u95f4\u548c\u503c\u5373\u53ef\u3002\n\n# \u4ee3\u7801\n\n```cpp\n#include <bits/stdc++.h>\n#define int long long\nusing namespace std;\nint n,m,x,y,op;\nint Tree1[400001],tag[400001],Tree2[400001],k;\ninline int gcd (int a,int b){\n\treturn !b?a:gcd (b,a%b); \n}\ninline void push_up (int u){\n\tTree1[u]=Tree1[u<<1]+Tree1[u<<1|1];\n\tTree2[u]=Tree2[u<<1]+Tree2[u<<1|1];\n}\ninline void build (int u,int l,int r){\n    tag[u]=0;\n    if (l==r){\n\t\tscanf (\"%lld\",&Tree1[u]);\n\t\tTree2[u]=Tree1[u]*Tree1[u];\n    \treturn ;\n\t}\n    int mid=l+r>>1;\n    build (u<<1,l,mid);\n    build (u<<1|1,mid+1,r);\n    push_up (u);\n}\ninline void push_down (int u,int l,int r){\n    if (l==r||!tag[u]) return;\n    int mid=l+r>>1;\n    tag[u<<1]+=tag[u];tag[u<<1|1]+=tag[u];\n    Tree2[u<<1]+=2*tag[u]*Tree1[u<<1]+tag[u]*tag[u]*(mid-l+1);\n\tTree2[u<<1|1]+=2*tag[u]*Tree1[u<<1|1]+tag[u]*tag[u]*(r-mid);\n    Tree1[u<<1]+=tag[u]*(mid-l+1);Tree1[u<<1|1]+=tag[u]*(r-mid);\n    tag[u]=0;\n}\ninline void update (int u,int l,int r){\n    if (x<=l&&r<=y){\n        tag[u]+=k;\n        Tree2[u]+=2*Tree1[u]*k+k*k*(r-l+1);\n        Tree1[u]+=k*(r-l+1);return ;\n    }\n    push_down (u,l,r);\n    int mid=l+r>>1;\n    if (x<=mid) update (u<<1,l,mid);\n    if (mid<y) update (u<<1|1,mid+1,r);\n    push_up (u);\n}\ninline int query_sum (int u,int l,int r){\n    if (x<=l&&r<=y) return Tree1[u];\n    push_down(u,l,r);\n    int mid=l+r>>1,ans=0;\n    if (x<=mid) ans=query_sum(u<<1,l,mid);\n    if (mid<y) ans+=query_sum(u<<1|1,mid+1,r);\n    return ans;\n}\ninline int query_sqr (int u,int l,int r){\n    if (x<=l&&r<=y) return Tree2[u];\n    push_down(u,l,r);\n    int mid=l+r>>1;int ans=0;\n    if (x<=mid) ans=query_sqr(u<<1,l,mid);\n    if (mid<y) ans+=query_sqr(u<<1|1,mid+1,r);\n    return ans;\n}\nsigned main(){\n    scanf (\"%lld%lld\",&n,&m);\n    build(1,1,n);\n    while(m--){\n        scanf(\"%d\",&op);\n        if (op==1){\n            scanf (\"%lld%lld%lld\",&x,&y,&k);\n            update(1,1,n);\n        }\n        if (op==2){\n            scanf (\"%lld%lld\",&x,&y);\n            int Ans=query_sum (1,1,n),len=y-x+1;\n            int g=gcd (Ans,len);Ans/=g;len/=g;\n            printf (\"%lld/%lld\\n\",Ans,len);\n        }\n        if (op==3){\n            scanf (\"%lld%lld\",&x,&y);\n            int len=y-x+1,ans1=query_sum(1,1,n),ans2=query_sqr(1,1,n);\n            int Ans1=ans1*ans1,Ans2=ans2*len,Len=len*len,ANS=Ans2-Ans1;\n            int g=gcd (ANS,Len);ANS/=g;Len/=g;\n            printf (\"%lld/%lld\\n\",ANS,Len);\n        }\n    }\n    return 0;\n}\n```\n\u53cc\u500d\u7ecf\u9a8c\uff1a[P1471 \u65b9\u5dee](https://www.luogu.com.cn/problem/P1471)\n\n\u516c\u5f0f\u7eaf\u624b\u6253\uff0c\u5e0c\u671b\u7ba1\u7406\u5927\u5927\u80fd\u7ed9\u8fc7\uff01",
        "postTime": 1653092982,
        "uid": 366254,
        "name": "dxy2020",
        "ccfLevel": 0,
        "title": "P2122"
    },
    {
        "content": "[\u9898\u76ee\u4f20\u9001\u95e8](https://www.luogu.com.cn/problem/P2122)\n\n\u9898\u76ee\u5927\u610f:\u7ed9\u5b9a\u4e00\u4e2a\u5e8f\u5217\uff0c\u652f\u6301\u533a\u95f4\u52a0\u6cd5\uff0c\u67e5\u8be2\u5e73\u5747\u6570\u548c\u65b9\u5dee\u3002\n\n\u533a\u95f4\u95ee\u9898\uff0c\u6700\u559c\u6b22\u7528\u7ebf\u6bb5\u6811\u6765\u89e3\u51b3\u3002\n\n\u9996\u5148\u6211\u4eec\u7531\u67e5\u8be2\u5e73\u5747\u6570\u77e5\u9053\u80af\u5b9a\u8981\u7ef4\u62a4\u533a\u95f4\u548c\uff0c\u4f46\u662f\u6211\u4eec\u8fd8\u8981\u652f\u6301\u67e5\u8be2\u65b9\u5dee\uff0c\u6240\u4ee5\u6211\u4eec\u8fd8\u9700\u8981\u7ef4\u62a4\u4e00\u4e9b\u5176\u5b83\u7684\u4e1c\u897f\uff0c\u628a\u65b9\u5dee\u516c\u5f0f\u5c55\u5f00\u5f97\u5230( $A_i$ \u8868\u793a\u5e8f\u5217\u7b2c $i$ \u9879\uff0c$\\overline A$ \u8868\u793a\u5e8f\u5217 $A$ \u7684\u5e73\u5747\u6570)\u3002\n\n$$\ns^2=\\frac{1}{n}\\sum_{i=1}^n(A_i-\\overline A)^2\n$$\n\n$$\ns^2=\\frac{1}{n}(A_1^2-2A_1\\overline A+\\overline A^2+A_2^2-2A_2\\overline A+\\overline A^2+\\cdots+A_n^2-2A_n\\overline A+\\overline A^2)\n$$\n\n$$\ns^2=\\frac{\\sum_{i=1}^nA_i^2}{n}-\\frac{2\\overline A\\sum_{i=1}^{n}A_i-n\\overline A^2}{n}\n$$\n\n$$\ns^2=\\frac{\\sum_{i=1}^nA_i^2}{n}-2\\overline A\\frac{\\sum_{i=1}^{n}A_i}{n} + \\overline A^2\n$$\n\n$$\ns^2=\\frac{\\sum_{i=1}^nA_i^2}{n}-2\\overline A^2+\\overline A^2\n$$\n\n$$\ns^2=\\frac{\\sum_{i=1}^nA_i^2}{n}-\\overline A^2\n$$\n\n\u6240\u4ee5\u6211\u4eec\u4e0d\u96be\u770b\u51fa\uff0c\u6211\u4eec\u8981\u7ef4\u62a4\u4e00\u4e2a\u533a\u95f4\u7684\u548c\u4e0e\u5e73\u65b9\u548c\uff0c\u90a3\u6211\u4eec\u5728\u533a\u95f4\u52a0\u4e4b\u540e\u4fee\u6539\u533a\u95f4\u7684\u5e73\u65b9\u548c\u6570\u636e\u5462\uff1f\n\n\u5047\u8bbe\u6211\u4eec\u8fd9\u6b21\u628a\u533a\u95f4\u5185\u7684\u6bcf\u4e2a\u6570\u52a0\u4e0a $k$ \uff0c\u90a3\u4e48\u6211\u4eec\u53ef\u4ee5\u5f97\u5230\u3002\n$$\n\\sum_{i=1}^{n}(A_i+k)^2=\\sum_{i=1}^{n}A_i^2+2k\\sum_{i=1}^{n}A_i+nk^2\n$$\n\u6240\u4ee5\u6211\u4eec\u5c31\u53ef\u5df2\u7528\u4e0a\u4e00\u8f6e\u7684\u5e73\u65b9\u548c\u4e0e\u533a\u95f4\u548c\u6570\u636e\u6765\u66f4\u65b0\u88ab\u4fee\u6539\u540e\u7684\u533a\u95f4\u5e73\u65b9\u548c\uff0c\u8fd9\u4e2a\u5f0f\u5b50\u4e5f\u544a\u8bc9\u6211\u4eec\u5728\u4fee\u6539\u65f6\uff0c\u8981\u5148\u4fee\u6539\u5e73\u65b9\u548c\uff0c\u518d\u4fee\u6539\u533a\u95f4\u548c\u3002\n\n\u4f46\u662f\u8fd9\u9053\u9898\u9898\u76ee\u8ba9\u6211\u4eec\u8f93\u51fa\u7684\u662f\u6700\u7b80\u5206\u6570\u7684\u5f62\u5f0f\uff0c\u6240\u4ee5\u6211\u4eec\u8fd8\u9700\u8981\u5bf9\u5e73\u5747\u6570\u5f0f\u5b50\u548c\u65b9\u5dee\u5f0f\u5b50\u8fdb\u884c\u8fdb\u4e00\u6b65\u7b80\u5316\u3002\n\n\u8bbe\u5f53\u524d\u533a\u95f4\u548c\u4e3a $sum$ \uff0c\u533a\u95f4\u5e73\u65b9\u548c\u4e3a $square$ \uff0c\u533a\u95f4\u957f\u5ea6\u4e3a $n$ \n\n\u90a3\u4e48\u6211\u4eec\u5c31\u53ef\u4ee5\u628a\u5e73\u5747\u6570\u5f0f\u5b50\u5199\u6210\u8fd9\u6837\uff1a\n$$\n\\frac{sum}{n}\n$$\n\u6240\u4ee5\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u7ea6\u53bb\u4e0a\u4e0b\u4e24\u5f0f\u7684\u6700\u5927\u516c\u56e0\u5f0f\u6765\u5f97\u5230\u5b83\u7684\u6700\u7b80\u5f62\u5f0f\u3002\n\n\u518d\u6765\u770b\u65b9\u5dee\n$$\n\\frac{square}{n}-(\\frac{sum}{n})^2\n$$\n\u5316\u7b80\u5f97\u5230\n$$\n\\frac{n\\cdot square - sum^2}{n^2} \n$$\n\u4e5f\u662f\u901a\u8fc7\u7ea6\u53bb\u4e0a\u4e0b\u7684\u6700\u7b80\u516c\u5206\u6bcd\u6765\u5f97\u5230\u6700\u7b80\u5f62\u5f0f\u3002\n\n\u4e8e\u662f\u6211\u4eec\u5c31\u505a\u5b8c\u4e86\u8fd9\u9053\u84dd\u9898\u3002\n\n## \u4ee3\u7801\n\n```c++\n#include <bits/stdc++.h>\n#define ll long long\n\nusing namespace std;\nconst int N = 1e5 + 10;\n\nstruct node\n{\n    int l, r;\n    ll sum, square, add;\n} t[N << 2];\nint a[N];\n\ninline ll gcd(ll a, ll b)\n{\n    return b ? gcd(b, a % b) : a;\n}\n\ninline void pushup(int p)\n{\n    t[p].sum = t[p << 1].sum + t[p << 1 | 1].sum;\n    t[p].square = t[p << 1].square + t[p << 1 | 1].square;\n}\n\ninline void pushdown(int p)\n{\n    node &u = t[p], &l = t[p << 1], &r = t[p << 1 | 1];\n\n    if (!u.add) return;\n\n    l.add += u.add;\n    r.add += u.add;\n\n    l.square += 2 * u.add * l.sum + (l.r - l.l + 1) * u.add * u.add; // \u5e73\u65b9\u548c\u5f0f\u5b50\n    r.square += 2 * u.add * r.sum + (r.r - r.l + 1) * u.add * u.add;\n    \n    l.sum += (l.r - l.l + 1) * u.add;\n    r.sum += (r.r - r.l + 1) * u.add;\n    \n    u.add = 0;\n}\n\ninline void build(int p, int l, int r)\n{\n    t[p].l = l, t[p].r = r;\n    if (l == r)\n    {\n        t[p].sum = a[l];\n        t[p].square = a[l] * a[l];\n        return;\n    }\n    int mid = (l + r) >> 1;\n    build(p << 1, l, mid);\n    build(p << 1 | 1, mid + 1, r);\n    pushup(p);\n}\n\ninline void modify(int p, int l, int r, int d) // \u533a\u95f4\u4fee\u6539\uff0c\u7ebf\u6bb5\u6811\u677f\u5b50\n{\n    if (l <= t[p].l && t[p].r <= r)\n    {\n        t[p].add += d;\n        t[p].square += 2 * d * t[p].sum + (t[p].r - t[p].l + 1) * d * d; // \u63a8\u5e73\u65b9\u548c\u7684\u5f0f\u5b50\n        t[p].sum += d * (t[p].r - t[p].l + 1);\n        return;\n    }\n    pushdown(p);\n    int mid = (t[p].l + t[p].r) >> 1;\n    if (l <= mid) modify(p << 1, l, r, d);\n    if (r > mid) modify(p << 1 | 1, l, r, d);\n    pushup(p);\n}\n\ninline ll get_sum(int p, int l, int r) // \u67e5\u8be2\u533a\u95f4\u548c\n{\n    if (l <= t[p].l && t[p].r <= r) return t[p].sum;\n    pushdown(p);\n    int mid = (t[p].l + t[p].r) >> 1;\n    ll res = 0;\n    if (l <= mid) res += get_sum(p << 1, l, r);\n    if (r > mid) res += get_sum(p << 1 | 1, l, r);\n    return res;\n}\n\ninline ll get_square(int p, int l, int r) // \u67e5\u8be2\u533a\u95f4\u5e73\u65b9\u548c\n{\n    if (l <= t[p].l && t[p].r <= r) return t[p].square;\n    pushdown(p);\n    int mid = (t[p].l + t[p].r) >> 1;\n    ll res = 0;\n    if (l <= mid) res += get_square(p << 1, l, r);\n    if (r > mid) res += get_square(p << 1 | 1, l, r);\n    return res;\n}\n\nint main()\n{\n    int n, m;\n    scanf(\"%d%d\", &n, &m);\n    for (int i = 1; i <= n; i++)\n        scanf(\"%d\", &a[i]);\n    build(1, 1, n); // \u5efa\u6811\n    while (m--)\n    {\n        int opt, l, r;\n        scanf(\"%d%d%d\", &opt, &l, &r);\n        if (opt == 1)\n        {\n            int d;\n            scanf(\"%d\", &d);\n            modify(1, l, r, d); // \u533a\u95f4\u52a0\n        }\n        else if (opt == 2)\n        {\n            ll sum = get_sum(1, l, r), length = r - l + 1;\n            if (sum == 0)\n            {\n                puts(\"0/1\");\n                continue;\n            }\n            ll d = gcd(sum, length);\n            printf(\"%lld/%lld\\n\", sum / d, length / d);\n        }\n        else if (opt == 3)\n        {\n            ll sum = get_sum(1, l, r), square = get_square(1, l, r), length = r - l + 1;\n            ll tmp = length * square - sum * sum; length *= length; // \u65b9\u5dee\u5f0f\u5b50\u4e2d\u7684\u5206\u6bcd\n            if (tmp == 0)\n            {\n                puts(\"0/1\");\n                continue;\n            }\n            ll d = gcd(tmp, length);\n            printf(\"%lld/%lld\\n\", tmp / d, length / d);\n        }\n    }\n    return 0;\n}\n```\n\n\n\n\n\n",
        "postTime": 1648466185,
        "uid": 587248,
        "name": "wcywcywcywcy",
        "ccfLevel": 0,
        "title": "\u3010\u9898\u89e3\u3011P2122\u8fd8\u6559\u5ba4"
    },
    {
        "content": "## \u9898\u89e3\n\n[\u4f20\u9001\u95e8](https://www.luogu.com.cn/problem/P2122)\n\n[~~\u5728\u535a\u5ba2\u91cc\u98df\u7528\u6548\u679c\u66f4\u4f73~~](https://www.luogu.com.cn/blog/yousa22/solution-p2122)\n\n\n### \u6b63\u6587\n\n\u9898\u76ee\u8981\u6c42\u533a\u95f4\u4fee\u6539\uff0c\u533a\u95f4\u6c42\u5e73\u5747\u6570\uff0c\u533a\u95f4\u6c42\u65b9\u5dee\uff0c\u524d\u9762\u4e24\u4e2a\u6bd4\u8f83\u7b80\u5355\u4e86\u5427\u3002\n\n$$\\overline{a}=\\frac{1}{n} \\sum_{i=1}^{n}a_i$$\n\n\u540e\u9762\u7684 $\\sum_{i=1}^{n}a_i$ \u5c31\u662f\u533a\u95f4\u548c\u4e86\u5427\uff0c\u5c31\u662f\u7ebf\u6bb5\u6811\u6a21\u677f\u3002\u8981\u6c42\u5206\u6570**\u5316\u7b80**\u540e\u8f93\u51fa\uff0c\u6211\u4eec\u76f4\u63a5\u540c\u65f6\u9664\u4e0a**\u4ed6\u4eec\u7684\u6700\u5927\u516c\u56e0\u6570**\u5373\u53ef\uff1a\n\n\u4ee4 $sum=\\sum_{i=1}^{n}a_i$ \u6700\u7ec8\u7b54\u6848\u4e3a\n\n$$ans=\\frac{sum \\times \\frac{1}{\\gcd(sum,n)}}{n \\times \\frac{1}{\\gcd(sum,n)}}$$\n\n\u6765\u770b\u533a\u95f4\u6c42\u65b9\u5dee\uff0c\u6211\u4eec\u77e5\u9053\u65b9\u5dee\u7684\u516c\u5f0f\u662f \n\n$$s^2=\\frac{1}{n} \\sum_{i=1}^n (a_i-\\overline{a})^2$$\n\n\u6839\u636e\u5e73\u65b9\u548c\u516c\u5f0f\n\n$$s^2=\\frac{1}{n} \\sum_{i=1}^n (a_i^2-2a_i\\overline{a}+\\overline{a}^2)$$\n\n\u540e\u9762\u7684 $\\overline{a}^2$ \u53ef\u4ee5\u63d0\u51fa\n\n$$s^2=\\frac{1}{n}( \\sum_{i=1}^n (a_i^2-2a_i\\overline{a})+n\\times\\overline{a}^2)$$\n\n\u5316\u7b80:\n\n$$s^2=\\frac{1}{n}\\sum_{i=1}^n (a_i^2-2a_i\\overline{a})+\\overline{a}^2$$\n\n\u6211\u4eec\u8fd8\u53ef\u4ee5\u628a $a_i^2-2a_i\\overline{a}$ \u5206\u522b\u63d0\u51fa\n\n$$s^2=\\frac{1}{n}\\sum_{i=1}^n a_i^2-\\frac{1}{n}\\sum_{i=1}^n 2a_i\\overline{a}+\\overline{a}^2$$\n\n\u6211\u4eec\u53d1\u73b0\u7b2c\u4e8c\u9879\u7684 $2,\\overline{a}$ \u53ef\u4ee5\u63d0\u5230\u5916\u9762\u53bb\n\n$$s^2=\\frac{1}{n}\\sum_{i=1}^n a_i^2-\\frac{1}{n}\\times2\\times\\overline{a}\\sum_{i=1}^n a_i+\\overline{a}^2$$\n\n\u6b64\u65f6\u7684 $\\frac{1}{n}\\sum_{i=1}^n a_i$ \u4e0d\u5c31\u662f $\\overline{a}$ \u5417\uff1f\n\n$$s^2=\\frac{1}{n}\\sum_{i=1}^n a_i^2-2\\overline{a}^2+\\overline{a}^2$$\n\n\u6700\u540e\u5c31\u662f \n\n$$s^2=\\frac{1}{n}\\sum_{i=1}^n a_i^2-\\overline{a}^2$$\n\n\u6b64\u65f6\u6211\u4eec\u5df2\u7ecf\u77e5\u9053\uff1a\u901a\u8fc7**\u7ef4\u62a4\u4e00\u4e2a\u533a\u95f4\u5e73\u65b9\u548c\u4e00\u4e2a\u533a\u95f4\u548c**(\u4e0a\u6587\u4e5f\u63d0\u5230\u4e86)\u5c31\u53ef\u4ee5\u7b97\u51fa\u65b9\u5dee\uff0c\u6211\u4eec\u5148\u4e0d\u6025\uff0c\u9898\u76ee\u8981\u6211\u4eec\u5199\u6210**\u5206\u6570\u5f62\u5f0f**\uff0c\u6211\u4eec\u518d\u5316\u7b80\u4e00\u4e0b\u3002\n\n$$s^2=\\frac{\\sum_{i=1}^n a_i^2-n\\times\\overline{a}^2}{n}$$\n\n$$s^2=\\frac{\\sum_{i=1}^n a_i^2-n\\times(\\frac{1}{n}\\sum_{i=1}^n{a_i})^2}{n}$$\n\n\u63d0\u51fa\u62ec\u53f7\u91cc\u9762\u7684 $n$\uff0c\u4e0e\u5916\u9762\u7684 $n$ \u6d88\u53bb\n\n$$s^2=\\frac{\\sum_{i=1}^n a_i^2-\\frac{1}{n}\\times(\\sum_{i=1}^n{a_i})^2}{n}$$\n\n\u5206\u5b50\u5206\u6bcd\u540c\u65f6\u4e58 $n$\n\n$$s^2=\\frac{n\\times\\sum_{i=1}^n a_i^2-(\\sum_{i=1}^n{a_i})^2}{n^2}$$\n\n\u63a5\u4e0b\u6765\u5f97\u5230**\u5206\u5b50\u5206\u6bcd\u7684 $\\gcd$ \u518d\u76f8\u9664**\u5373\u53ef\u3002\n\n\u6700\u7ec8\u7b54\u6848\u5df2\u7ecf\u786e\u5b9a\u4e86\uff0c\u73b0\u5728\u8fd8\u6709\u4e00\u4e2a\u95ee\u9898\uff0c\u5c31\u662f\u600e\u4e48\u7ef4\u62a4**\u533a\u95f4\u5e73\u65b9\u548c**\u3002\n\n\u539f\u6765\u7684\u5f0f\u5b50:\n\n$$\\sum_{i=1}^n a_i^2$$\n\n\u5047\u8bbe\u52a0\u4e0a\u4e86 $x$\n\n\u5219\u53d8\u4e3a:\n\n$$\\sum_{i=1}^n (a_i+x)^2$$\n\n\u6839\u636e\u5e73\u65b9\u548c\u516c\u5f0f\n\n$$\\sum_{i=1}^n (a_i^2+2a_ix+x^2)$$\n\n\u63d0\u51fa $x^2$\n\n$$\\sum_{i=1}^n (a_i^2+2a_ix)+n\\times x^2$$\n\n\u8fd8\u662f\u628a $(a_i^2+2a_ix)$ \u62c6\u5f00\n\n$$\\sum_{i=1}^n (a_i^2)+\\sum_{i=1}^n (2a_ix)+n\\times x^2$$\n\n\u628a $x,2$ \u63d0\u51fa\u62ec\u53f7\n\n$$\\sum_{i=1}^n (a_i^2)+n\\times 2x\\sum_{i=1}^n (a_i)+n\\times x^2$$\n\n\u6211\u4eec\u53d1\u73b0\u7b2c\u4e00\u9879\u548c\u7b2c\u4e09\u9879\u90fd\u662f\u76ee\u524d\u5df2\u77e5\u7684\uff0c\u7b2c\u4e8c\u4e2a\u662f\u533a\u95f4\u548c\uff0c\u6211\u4eec\u5df2\u7ecf\u7ef4\u62a4\u4e86\u3002\n\u6240\u4ee5\u7ef4\u62a4\u5c31\u5bb9\u6613\u4e86\u3002\n\n**\u6ce8\u610f\uff1a\u4e0a\u9762\u7684\u5f0f\u5b50\u7684 $1$ \u5c31\u662f\u533a\u95f4\u5de6\u6bb5\u70b9 $l$\uff0c$n$ \u5c31\u662f\u533a\u95f4\u53f3\u7aef\u70b9 $r$\uff0c\u6240\u4ee5 $\\frac{1}{n}$ \u5c31\u76f8\u5f53\u4e8e $\\frac{1}{r-l+1}$\uff0c$\\sum_{i=1}^n$ \u5c31\u76f8\u5f53\u4e8e $\\sum_{i=l}^r$\uff0c$n$ \u5c31\u662f $r-l+1$\u3002**\n\n\u6211\u5c31\u53ea\u653e\u90e8\u5206\u4ee3\u7801\u4e86\uff1a\n\n\u7ef4\u62a4\u533a\u95f4\u548c\u548c\u5e73\u65b9\u548c\n\n    inline void Add(int k,int l,int r,int v){\n    //add\u8868\u793a\u533a\u95f4\u8981\u52a0\u7684\u6570\u5b57\uff0c\u5c31\u662f lazytag\n        add[k]+=v;\n        //\u6309\u7167\u4e0a\u9762\u7684\u516c\u5f0f\u5199\n        pow_sum[k]=pow_sum[k]+sum[k]*2*v+(r-l+1)*v*v;\n        sum[k]+=(r-l+1)*v;\n    }\n    inline void pushdown(int k,int l,int r){\n        int mid=l+r>>1;\n        if(!add[k])return;\n        Add(ls,l,mid,add[k]);\n        Add(rs,mid+1,r,add[k]);\n        add[k]=0;\n    }\n    \n \n \u8f93\u51fa\uff1a\n \n ```cpp\n        else if(opt==2){\n            int ans1=query1(1,1,n,x,y);\n            int ans2=y-x+1;\n            int m=gcd(ans1,ans2);\n            ans1/=m;\n            ans2/=m;\n            printf(\"%lld/%lld\\n\",ans1,ans2);\n        }\n        else {\n        //query1\u662f\u67e5\u8be2\u533a\u95f4\u548c\n            int average=query1(1,1,n,x,y);\n            average*=average;\n        //query2\u662f\u67e5\u8be2\u533a\u95f4\u5e73\u65b9\u548c\n            int sum=query2(1,1,n,x,y)*(y-x+1);\n            int ans1=sum-average;\n            int ans2=(y-x+1)*(y-x+1);\n            int m=gcd(ans1,ans2);\n            ans1/=m;\n            ans2/=m;\n            printf(\"%lld/%lld\\n\",ans1,ans2);\n        }\n```\n",
        "postTime": 1634091288,
        "uid": 414386,
        "name": "Isshiki\u00b7Iroha",
        "ccfLevel": 6,
        "title": "P2122\u9898\u89e3"
    },
    {
        "content": "[P2122 \u8fd8\u6559\u5ba4](https://www.luogu.com.cn/problem/P2122)\n\n## \u9898\u610f\u7b80\u8ff0\n\n\u4e00\u4e2a\u533a\u95f4\uff0c\u4f60\u9700\u8981\u7ef4\u62a4\u533a\u95f4\u52a0\uff0c\u533a\u95f4\u5e73\u5747\u6570\uff0c\u533a\u95f4\u65b9\u5dee\u3002\n\n## Part 0 \u65b9\u5dee\n\n\u9996\u5148\u770b\u4e00\u4e0b\u65b9\u5dee\u516c\u5f0f\uff1a\n\n$a^2=\\frac{1}{n}\\sum_{i=1}^n(a_i-\\overline{a})^2$\n\n\u5176\u4e2d $a^2$ \u662f\u65b9\u5dee\uff0c $\\overline{a}$ \u662f\u533a\u95f4\u5e73\u5747\u6570\u3002\n\n\u8fd9\u4e1c\u897f\u548c\u6bcf\u4e2a\u6570\u5b57\u90fd\u6709\u5173\u7cfb\uff0c\u90a3\u4e48\u76f4\u63a5\u7528\u8fd9\u4e2a\u516c\u5f0f\u5c31\u975e\u5e38\u4e0d\u53ef\u505a\u3002\n\n\u8003\u8651\u5c55\u5f00\u3002\n\n$$a^2=\\frac{1}{n}\\sum_{i=1}^n(a_i-\\overline{a})^2$$\n\n$$\\Downarrow$$\n\n$$a^2=\\frac{1}{n}\\sum_{i=1}^na_i^2-2a_i\\overline{a}+\\overline{a}^2$$\n\n$$\\Downarrow$$\n\n$$a^2=\\frac{\\sum_{i=1}^na_i^2-2\\sum_{i=1}^na_i\\overline{a}+n\\overline{a}^2}{n}$$\n\n$$\\Downarrow$$\n\n$$a^2=\\frac{\\sum_{i=1}^na_i^2}{n}-2\\overline{a}^2+\\overline{a}^2$$\n\n$$\\Downarrow$$\n\n$$a^2=\\frac{\\sum_{i=1}^na_i^2}{n}-\\frac{(\\sum_{i=1}^na_i)^2}{n^2}$$\n\n$$\\Downarrow$$\n\n$$a^2=\\frac{n\\sum_{i=1}^na_i^2-(\\sum_{i=1}^na_i)^2}{n^2}$$\n\n\u6240\u4ee5\u6211\u4eec\u53ea\u9700\u8981\u7ef4\u62a4**\u533a\u95f4\u5e73\u65b9\u548c**\u548c**\u533a\u95f4\u548c**\u5373\u53ef\u3002\n\n## Part 1 \u533a\u95f4\u52a0\n\n\u8003\u8651\u8ba1\u7b97\u8d21\u732e\u3002\n\n\u533a\u95f4\u548c\u5f88\u5bb9\u6613\uff0c\u90a3\u533a\u95f4\u5e73\u65b9\u548c\u5462\uff1f\n\n\u8bbe\u533a\u95f4\u52a0 $k$ \uff0c\u5219\u5e73\u65b9\u548c\u52a0\u4e0a $\\sum_{i=1}^n(a_i+k)^2-\\sum_{i=1}^na_i^2=\\sum_{i=1}^n2\\times a_ik+k^2=2k\\sum_{i=1}^na_i+nk^2$\n\n\u6ce8\u610f\u8fd9\u4e2a\u533a\u95f4\u548c\u662f\u4ee5\u524d\u7684\u533a\u95f4\u548c\uff0c\u4e0b\u653e\u6807\u8bb0\u65f6\u5148\u5904\u7406\u533a\u95f4\u5e73\u65b9\u548c\u3002\n\n## Part 2 \u65e2\u7ea6\u5206\u6570\n\n\u5206\u5b50\u5206\u6bcd\u7ea6\u4e00\u4e2a $\\gcd$ \u5373\u53ef\u3002\n\n\u5410\u69fd\u4e00\u4e0b\u6570\u636e\u91cc\u6ca1\u6709\u7279\u6b8a\u60c5\u51b5\uff0c\u6211\u6ca1\u52a0\u7279\u5224\u8fc7\u4e86\u3002\n\n## Part 3 Code\n\n```cpp\n#include <cstdio>\n#include <algorithm>\n#include <iostream>\n#include <cmath>\n#include <cstdlib>\n\nusing namespace std;\n\n#define ls(o) o << 1\n#define rs(o) o << 1|1\n\ntypedef long long ll;\nconst int N=1e5+10;\nint n,m,a[N];\n\nstruct Segment_Tree\n{\n\tll sumv[N << 2],sump[N << 2],tag[N << 2],sz[N << 2];\n\tinline void pushup(int o) {sumv[o]=sumv[ls(o)]+sumv[rs(o)]; sump[o]=sump[ls(o)]+sump[rs(o)]; return ;}\n\tinline void pushdown(int o)\n\t{\n\t\ttag[ls(o)]+=tag[o]; tag[rs(o)]+=tag[o];\n\t\tsump[ls(o)]+=sz[ls(o)]*tag[o]*tag[o]+2*tag[o]*sumv[ls(o)];\n\t\tsump[rs(o)]+=sz[rs(o)]*tag[o]*tag[o]+2*tag[o]*sumv[rs(o)];\n\t\tsumv[ls(o)]+=sz[ls(o)]*tag[o]; sumv[rs(o)]+=sz[rs(o)]*tag[o];\n\t\ttag[o]=0;\n\t\treturn ;\n\t}\n\tvoid build(int o,int l,int r)\n\t{\n\t\tsz[o]=r-l+1; tag[o]=0;\n\t\tif(l == r) {sumv[o]=a[l]; sump[o]=a[l]*a[l]; return ;}\n\t\tint mid=(l+r) >> 1;\n\t\tbuild(ls(o),l,mid); build(rs(o),mid+1,r);\n\t\tpushup(o); return ;\n\t}\n\tvoid modify(int o,int l,int r,int nl,int nr,ll k)\n\t{\n\t\tif(nl <= l && r <= nr) {tag[o]+=k; sump[o]+=sz[o]*k*k+2*k*sumv[o]; sumv[o]+=sz[o]*k; return ;}\n\t\tint mid=(l+r) >> 1;\n\t\tpushdown(o);\n\t\tif(nl <= mid) modify(ls(o),l,mid,nl,nr,k);\n\t\tif(nr > mid) modify(rs(o),mid+1,r,nl,nr,k);\n\t\tpushup(o); return ;\n\t}\n\tll query(int o,int l,int r,int ql,int qr,bool f)\n\t{\n\t\tif(ql <= l && r <= qr) return f?sumv[o]:sump[o];\n\t\tint mid=(l+r) >> 1; ll res=0;\n\t\tpushdown(o);\n\t\tif(ql <= mid) res+=query(ls(o),l,mid,ql,qr,f);\n\t\tif(qr > mid) res+=query(rs(o),mid+1,r,ql,qr,f);\n\t\treturn res;\n\t}\n} tree;\n\nll gcd(ll x,ll y)\n{\n\tif(!y) return x;\n\treturn gcd(y,x%y);\n}\n\nint main()\n{\n// \tfreopen(\"work.in\",\"r\",stdin); freopen(\"work.out\",\"w\",stdout);\n\tscanf(\"%d%d\",&n,&m);\n\tfor(int i=1;i<=n;i++) scanf(\"%d\",&a[i]);\n\tint op,l,r,k; tree.build(1,1,n);\n\twhile(m--)\n\t{\n\t\tscanf(\"%d%d%d\",&op,&l,&r);\n\t\tif(op == 1) {scanf(\"%d\",&k); tree.modify(1,1,n,l,r,k);}\n\t\telse\n\t\t{\n\t\t\tll res=tree.query(1,1,n,l,r,true),siz=r-l+1;\n\t\t\tif(op == 2) {ll _gcd=gcd(res,siz); printf(\"%lld/%lld\\n\",res/_gcd,siz/_gcd);}\n\t\t\telse\n\t\t\t{\n\t\t\t\tll resp=tree.query(1,1,n,l,r,false)*siz-res*res;\n\t\t\t\tll _gcd=gcd(resp,siz*siz);\n\t\t\t\tprintf(\"%lld/%lld\\n\",resp/_gcd,siz*siz/_gcd);\n\t\t\t}\n\t\t}\n\t}\n// \tfclose(stdin); fclose(stdout);\n\treturn 0;\n}\n```\n\n\u989d\u5916\u7684\u7ecf\u9a8c\n\n1. [P1471 \u65b9\u5dee](https://www.luogu.com.cn/problem/P1471)\n2. [P5142 \u533a\u95f4\u65b9\u5dee](https://www.luogu.com.cn/problem/P5142) [\u9898\u89e3](https://www.luogu.com.cn/blog/nizhuan/solution-p5142)\n\n\u611f\u8c22\u60a8\u7684\u9605\u8bfb\uff01",
        "postTime": 1621043829,
        "uid": 240191,
        "name": "MY\uff08\u4e00\u540d\u849f\u84bb\uff09",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 P2122 \u3010\u8fd8\u6559\u5ba4\u3011"
    },
    {
        "content": "- ## P2122 \u8fd8\u6559\u5ba4\n\n\u8fd9\u719f\u6089\u7684\u9898\u9762\u4e0e\u8f93\u5165\n\n\u4e09\u79cd\u64cd\u4f5c\uff1a1\u4e2a\u4fee\u65392\u79cd\u67e5\u8be2\u3002\n\n\u8db3\u4ee5\u60f3\u5230\u6211\u4eec\u7684\u7ecf\u5178\u6570\u636e\u7ed3\u6784\u2014\u2014\u7ebf\u6bb5\u6811\u3002\n\n\u6ca1\u6709\u5b8c\u5168\u638c\u63e1\u6216\u8005\u4e0d\u4f1a\u7ebf\u6bb5\u6811\u7684\u540c\u5b66\u53ef\u4ee5\u5eb7\u5eb7\u6211\u7684[**\u5b66\u4e60\u7b14\u8bb0**](https://www.luogu.com.cn/blog/PandaStudioblog/SegmentTree)\u7136\u540eA\u4e86\u6a21\u677f\u518d\u6765\u770b\u8fd9\u9898\u54e6\n\n------------\n\n\u8fd9\u662f\u4e00\u9053\u57fa\u672c\u53ef\u4ee5\u8bf4\u662f\u6a21\u677f\u5f62\u5f0f\u7684\u7ebf\u6bb5\u6811\u9898\u76ee\uff0c\u4f46\u662f\u96be\u5ea6\u5374\u4e0d\u4f4e\u3002\n\n\u65e0\u975e\u662f\u7ed9\u5b9a\u5e8f\u5217\uff0c\u8ba9\u4f60**\u7ef4\u62a4\u533a\u95f4\u5e73\u5747\u503c\u4e0e\u65b9\u5dee**\u3002\n\n\u4f46\u662f\u8fd9\u9053\u9898\u76ee\u79bb\u8c31\u4e4b\u5904\u5728\u4e8e\uff1a\n\n- **\u8981\u6c42\u8f93\u51fa\u5206\u6570\u5f62\u5f0f**\n\n\u4e0d\u8fc7\u5982\u679c\u4e86\u89e3\u4e86\u601d\u8def\u4e0e\u505a\u6cd5\u540e\u4e5f\u5c31\u662f\u591a\u5bf9\u901a\u5206\u7ea6\u5206\u64cd\u4f5c\u8fdb\u884c\u4e86\u8981\u6c42\u3002\n\n------------\n\n- ### Prelude\n\n\u8fd9\u662f\u6211\u4eec\u673a\u623f\u6a21\u62df\u8d5b\u7684\u9898\u76ee\u3002\u6211\u5c31\u987a\u4fbf\u8bf4\u8bf4\u6211\u7684\u601d\u8def\u5386\u7a0b\u5427\u3002\n\n\u5176\u5b9e\u6700\u5f00\u59cb\u6211\u7684\u60f3\u6cd5\u662f\u7ebf\u6bb5\u6811\uff0c\u4f46\u662f\u6211\u60f3\u5f97\u5c31\u662f\u76f4\u63a5\u7ef4\u62a4\u65b9\u5dee\u5e73\u5747\u503c(\u6307\u7ebf\u6bb5\u6811\u5185\u5c31\u5b58\u65b9\u5dee\u548c\u5e73\u5747\u503c\uff0c~~\u6211\u662f\u4e2a\u72fc\u706d~~\uff09\u3002\n\n\u6211\u662f\u600e\u4e48\u60f3\u7684\u5462\uff0c\u6211\u5efa\u4e86\u5e94\u8be5\u5b50\u7ed3\u6784\u4f53\uff0c\u5b58\u50a8\u5206\u6570\u7684\u5206\u5b50\u5206\u6bcd\u3002\u987a\u4fbf\u5199\u4e86\u5206\u6570\u52a0\u5206\u6570\u4e58\u4ee5\u53ca\u7b80\u5316\u5206\u6570\u7684\u51fd\u6570\u3002\n\n\u6211\u4ed4\u7ec6\u5206\u6790\u590d\u6742\u5ea6\u4e0e\u5b9e\u73b0\u96be\u5ea6\uff0c\u70b8\u4e86\u3002\n\n\u7136\u540e\u6211\u8111\u4e2d\u5c31\u5f00\u59cb\u601d\u8003\u65b9\u5dee\u548c\u5e73\u5747\u503c\u7684\u5171\u6027\uff0c\u62ff\u51fa\u8349\u7a3f\u7eb8\u8ba1\u7b97\uff0c\u4e8e\u662f\u5f97\u51fa\u6b63\u89e3\u601d\u8def\u3002\u5982\u4e0b\u3002\n\n------------\n\n- ### Solution\n\n\u505a\u8fd9\u9898\u4f60\u9700\u8981\u4e00\u5b9a\u7684\u5c0f\u5b66(~~\u6216\u521d\u4e2d~~?)\u6570\u5b66\u77e5\u8bc6:\n\n\u9996\u5148\u533a\u95f4`[l,r]`\u7684\u5e73\u5747\u503c\u4e3a(\u4e0b\u6587\u8bbe\u4e3a$\\bar a$)\uff1a\n\n$$\n\n\\displaystyle \\frac{\\sum_{i=l}^ra_i}{r-l+1}\n\n$$\n\n\u65b9\u5dee\u5219\u662f\uff08\u4e0b\u6587\u8bbe\u4e3a$s^2$):\n\n$$\n\n\\displaystyle \\frac{\\sum_{i=l}^r(a_i-\\bar a)^2}{r-l+1}\n\n$$\n\n\u663e\u7136\uff0c\u5e73\u5747\u503c\u5f88\u597d\u7ef4\u62a4\uff0c\u6211\u4eec\u53ea\u9700\u8981\u7ef4\u62a4\u533a\u95f4\u548c\u518d\u5728\u8f93\u51fa\u65f6\u7528\u5206\u6570\u8868\u793a\u533a\u95f4\u548c\u9664\u4ee5\u533a\u95f4\u957f\u5ea6\u5c31\u884c\u3002\n\n\u90a3\u4e48\u6211\u4eec\u8fd8\u8981\u505a\u7684\u5176\u5b9e\u662f\u7528$\\bar a$\u63a8\u51fa$s^2$\u3002\n\n\u6211\u4eec\u5c55\u5f00\u5355\u72ec\u7684\n\n$$(a_i- \\bar a)^2$$\n\n$$\n\n=a_i^2-2a_i\\bar a+\\bar a^2\n\n$$\n\n\u5206\u522b\u5206\u6790$a_i^2$,$2a_i \\bar a$,\u548c $\\bar a^2$\n\n- \u5bf9\u4e8e$\\sum a_i^2$:\n\n\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u5355\u72ec\u7ef4\u62a4\uff0c\u5e76\u4e0d\u590d\u6742\uff0c\u4f46\u5bf9\u4e8e\u533a\u95f4$+x$\u7684\u64cd\u4f5c\u6211\u4eec\u53ef\u4ee5\u63a8\u51fa\u61d2\u60f0\u6807\u8bb0\u7684\u4e0b\u4f20\u516c\u5f0f\u662f:\n\n$$\n\n\\sum_{i=l}^r (a_i+x)^2\n\n$$\n\n$$\n\n=\\sum_{i=l}^r (a_i^2+2a_ix+x^2)\n\n$$\n\n$$\n\n=\\sum_{i=l}^r a_i^2+2x\\sum_{i=l}^r a_i+(r-l+1)x^2\n\n$$\n\n\u5728\u8fd9\u91cc\u6211\u4eec\u5c31\u5f88\u660e\u663e\u770b\u51fa\u6765\u6211\u4eec\u8981\u7ef4\u62a4\u7684\u5c31\u662f\u533a\u95f4\u548c($\\sum a_i$)\u4e0e\u5e73\u65b9\u548c($\\sum a_i^2$)\u4e86\u3002\n\n\u4f46\u662f\u6839\u636e\u4e0a\u9762\u5f0f\u5b50\uff0c\u6211\u4eec\u53ea\u9700\u8981\u7ef4\u62a4\u4e00\u4e2a\u61d2\u60f0\u6807\u8bb0\u3002\n\n- \u5bf9\u4e8e$\\sum 2a_i \\bar a$:\n\n\u5bf9\u4e8e\u6bcf\u4e2a\u533a\u95f4\u7684\u5e73\u5747\u503c\u6211\u4eec\u5df2\u7ecf\u6709\u4e86\u7ef4\u62a4\u65b9\u6cd5\uff0c\u6240\u4ee5\u5728\u8fd9\u6211\u4eec\u5c06\u5176\u89c6\u4e3a\u5b9a\u503c($\\frac{\\sum a_i}{r-l+1}$)\uff0c\u4e8e\u662f\u6211\u4eec\u5c06\u5f0f\u5b50\u8f6c\u6362\u6210:\n\n$$\n2 \\bar a \\sum a_i \n$$\n\n\n$$\n=\\frac{2\\sum a_i}{r-l+1} \\sum a_i\n$$\n\n$$\n=\\frac{2(\\sum a_i)^2}{r-l+1}\n$$\n- \u5bf9\u4e8e$\\sum \\bar a^2$\n\n\u663e\u7136\u6211\u4eec\u6709$\\sum \\bar a^2$=$(r-l+1)\\bar a^2$\n\n\n\u6211\u4eec\u518d\u50cf\u4e4b\u524d\u4e00\u6837\u4ee3\u5165$\\bar a$\n\n\u4e8e\u662f\u4e4e:\n$$\n\n\\sum \\bar a_i^2\n\n$$\n\n$$\n=(r-l+1)(\\frac{\\sum a_i}{r-l+1})^2\n$$\n\n$$\n=\\frac{(\\sum a_i)^2}{r-l+1}\n$$\n\n\u6211\u4eec\u53d1\u73b0\u53ef\u4ee5\u6d88\u4e86\uff0c\u4e8e\u662f\u5217\u51fa\u5168\u5f0f\uff1a\n\n$$\ns^2=\\frac{\\sum(a_i-\\bar a)^2}{r-l+1}\n$$\n\n$$\n\n=\\frac{\\sum a_i^2-\\sum2a_i\\bar a+\\sum \\bar a^2}{r-l+1}\n$$\n$$\n\n=\\frac{\\sum a_i^2-\\frac{2(\\sum a_i)^2}{r-l+1}+\\frac{(\\sum a_i)^2}{r-l+1}}{r-l+1}\n\n$$\n\n$$\n\n=\\frac{(r-l+1)\\sum a_i^2-{(\\sum a_i)^2}}{(r-l+1)^2}\n$$\n\n\u53ef\u80fd\u7565\u663e\u9ebb\u70e6\uff0c\u4f46\u662f\u6709\u7ed3\u679c\u5c31\u662f\u597d\u7684\u3002\n\n\u6240\u4ee5\u6211\u4eec\u5f97\u51fa\u4e86\u4e00\u4e2a\u53ea\u9700\u8981$\\sum a_i^2$\u548c$\\sum a_i$\u5c31\u53ef\u4ee5\u7ef4\u62a4\u533a\u95f4\u65b9\u5dee\u7684\u5f0f\u5b50\u3002\n\n\u6c42\u65b9\u5dee\u65f6\uff0c\u6700\u540e\u7ed3\u679c\u5c31\u5148\u67e5\u8be2\u533a\u95f4\u548c\u533a\u95f4\u5e73\u65b9\u548c\uff0c\u7136\u540e\u6309\u7167\u8fd9\u4e2a\u516c\u5f0f\u8f93\u51fa\u5c31\u53ef\u4ee5\u4e86\u3002\n\n------------\n\n- ### Code\n\n\u6709\u51e0\u4e2a\u6613\u9519\u70b9\u5728\u8fd9\u91cc\u8bf4\u4e00\u4e0b\u3002\n\n- \u8bb0\u5f97\u5f00`long long`\uff0c\u867d\u7136$a_i$\u548c$d$\u7684\u8303\u56f4\u5728\u4e24\u4f4d\u6570\u4ee5\u5185\uff0c\u4f46\u662f\u4e00\u65e6\u8981\u6c42\u8ba1\u7b97\u6210\u4e00\u4e2a$10^5$\u533a\u95f4\u7684\u5e73\u65b9\u548c\uff0c\u8fd9\u9898\u6ca1\u6709\u6a21\u6570\uff0c\u6240\u4ee5\u81ea\u7136\u9700\u8981`long long`\u3002\n\n- \u4e0b\u4f20\u6807\u8bb0\u548c\u66f4\u65b0\u8ba1\u7b97\u65f6\u5148\u66f4\u65b0\u5e73\u65b9\u548c\u518d\u66f4\u65b0\u533a\u95f4\u548c\uff0c\u6839\u636e\u4e0a\u9762\u5f0f\u5b50\u53ef\u77e5\u8981\u7684\u662f\u66f4\u65b0\u524d\u7684\u533a\u95f4\u548c\u6765\u66f4\u65b0\u5e73\u65b9\u548c\u3002\u5728Pushdown\u51fd\u6570\u4e2d\u6709\u4f53\u73b0\uff08\u6211\u7684\u662f`PD(int p)`)\n\n```cpp\n#include<cstdio>\n#include<cstring>\n#include<cmath> \n#include<iostream>\n#include<algorithm>\n\n#define N 100005\n#define ll long long \n\nusing namespace std;\n\nstruct Rey\n{\n\tint l,r;\n\tll s1,s2;\n\tll lazadd;\n}T[N<<2];\nint n,m;\nll a[N];\n\nll gcd(ll a,ll b)\n{\n\treturn !b?a:gcd(b,a%b);\n}\n\nll lcm(ll a,ll b)\n{\n\treturn (a*b)/gcd(a,b);\n}\n\nint LS(int p){return p<<1;}\nint RS(int p){return p<<1|1;}\n\nvoid UPDATE_sum(int p)\n{\n\tT[p].s1=T[LS(p)].s1+T[RS(p)].s1;\n\tT[p].s2=T[LS(p)].s2+T[RS(p)].s2;\n}\n\nvoid build(int p,int l,int r)\n{\n\tT[p].l=l,T[p].r=r;\n\tif(l==r){T[p].s1=a[l],T[p].s2=a[l]*a[l];return;}\n\tint mid=(l+r)>>1; \n\tbuild(LS(p),l,mid);\n\tbuild(RS(p),mid+1,r);\n\tUPDATE_sum(p);\n}\n\nvoid PD(int p)\n{\n\tint L,R;\n\tll ADD=T[p].lazadd;\n\tL=LS(p),R=RS(p);\n\tT[L].s2+=2*ADD*T[L].s1+(T[L].r-T[L].l+1)*ADD*ADD*1ll;\n\tT[R].s2+=2*ADD*T[R].s1+(T[R].r-T[R].l+1)*ADD*ADD*1ll;\n\tT[L].s1+=ADD*(T[L].r-T[L].l+1)*1ll;\n\tT[R].s1+=ADD*(T[R].r-T[R].l+1)*1ll;\n\tT[L].lazadd+=ADD;\n\tT[R].lazadd+=ADD;\n\tT[p].lazadd=0;\n}\n\nvoid FIX(int p,int l,int r,ll x)\n{\n\tif(l>T[p].r||T[p].l>r)return;\n\tif(T[p].l>=l&&T[p].r<=r)\n\t{\n\t\tT[p].lazadd+=x;\n\t\tT[p].s2+=T[p].s1*2*x+(T[p].r-T[p].l+1)*x*x*1ll;\n\t\tT[p].s1+=x*(T[p].r-T[p].l+1)*1ll; \n\t\treturn ;\n\t}\n\tif(T[p].lazadd)PD(p);\n\tFIX(LS(p),l,r,x);\n\tFIX(RS(p),l,r,x);\n\tUPDATE_sum(p);\n}\n\nll Vuq1(int p,int l,int r)//\u67e5\u8be2\u533a\u95f4\u548c\n{\n\tll res=0;\n\tif(l>T[p].r||T[p].l>r)return 0;\n\tif(T[p].l>=l&&T[p].r<=r)return T[p].s1;\n\tif(T[p].lazadd)PD(p);\n\tres+=Vuq1(LS(p),l,r);\n\tres+=Vuq1(RS(p),l,r);\n\treturn res; \n}\n\nll Vuq2(int p,int l,int r)//\u533a\u95f4\u5e73\u65b9\u548c\n{\n\tll res=0;\n\tif(l>T[p].r||T[p].l>r)return 0;\n\tif(T[p].l>=l&&T[p].r<=r)return T[p].s2;\n\tif(T[p].lazadd)PD(p);\n\tres+=Vuq2(LS(p),l,r);\n\tres+=Vuq2(RS(p),l,r);\n\treturn res; \n}\n\nint main()\n{\n\tscanf(\"%d %d\",&n,&m);\n\tfor(int i=1;i<=n;i++)scanf(\"%lld\",&a[i]);\n\tbuild(1,1,n);\n\twhile(m--)\n\t{\n\t\tint op;\n\t\tscanf(\"%d\",&op);\n\t\tif(op==1)\n\t\t{\n\t\t\tint x,y;\n\t\t\tll z;\n\t\t\tscanf(\"%d %d %lld\",&x,&y,&z);\n\t\t\tFIX(1,x,y,z);\n\t\t}\n\t\tif(op==2)\n\t\t{\n\t\t\tint x,y;\n\t\t\tscanf(\"%d %d\",&x,&y);\n\t\t\tll sum=Vuq1(1,x,y);\n\t\t\tll mu=y-x+1;\n\t\t\tll G=gcd(sum,mu);\n\t\t\tprintf(\"%lld/%lld\\n\",sum/G,mu/G); \n\t\t}\n\t\tif(op==3)\n\t\t{\n\t\t\tint x,y;\n\t\t\tscanf(\"%d %d\",&x,&y);\n\t\t\tll sum1=Vuq1(1,x,y);\n\t\t\tll sum2=Vuq2(1,x,y);\n\t\t\tll mu=(ll)(y-x+1);\n\t\t\tll sum=mu*sum2-sum1*sum1*1ll;\n\t\t\tmu=mu*mu;\n\t\t\tll G=gcd(sum,mu);\n\t\t\tprintf(\"%lld/%lld\\n\",sum/G,mu/G);\n            //\u8981\u6c42\u6700\u7b80\u5f62\u5f0f\u6240\u4ee5\u540c\u9664\u4ee5GCD\u7ea6\u5206\n\t\t\t \n\t\t}\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1604323191,
        "uid": 57273,
        "name": "Reywmp",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P2122 \u3010\u8fd8\u6559\u5ba4\u3011"
    },
    {
        "content": "\u533a\u95f4\u52a0\u533a\u95f4\u5e73\u5747\u6570\u533a\u95f4\u65b9\u5dee.\n\n\u8003\u8651\u7ebf\u6bb5\u6811.\n\n\u533a\u95f4\u5e73\u5747\u6570$\\bar{x}=\\frac{1}{n}\\sum_{k=1}^nx_k$.\n\n\u90a3\u4e48\u53ea\u9700\u8981\u7ef4\u62a4$\\sum_{k=1}^nx_k$, \u5373\u533a\u95f4\u548c\u5373\u53ef.\n\n\u8003\u8651\u533a\u95f4\u65b9\u5dee.\n\n$\\sigma^2=\\frac{1}{n}\\sum_{k=1}^n\\left(x_k-\\bar{x}\\right)^2$\n\n\u5c55\u5f00\u5e73\u65b9\u7136\u540e\u5206\u79bb\u5316\u7b80\u5f97\u5230\n\n$\\sigma^2=\\frac{1}{n}\\left(\\sum_{k=1}^nx_k^2-2\\bar{x}\\sum_{k=1}^n+n\\bar{x}^2\\right)$\n\n\u8bbe\u533a\u95f4\u548c$s_1=\\sum_{k=l}^ra_k$, \u5e73\u65b9\u548c$s_2=\\sum_{k=l}^ra_k^2$\n\n\u90a3\u4e48\u53ea\u9700\u8981\u4e00\u68f5\u7ebf\u6bb5\u6811\u7ef4\u62a4\u8fd9\u4e24\u4e2a\u4fe1\u606f.\n\n\u533a\u95f4\u52a0\u7684\u65f6\u5019\u66f4\u65b0\u548c\u4e0e\u5e73\u65b9\u548c.\n\n\u5176\u4e2d\u5bf9\u4e8e\u5e73\u65b9\u548c\u7684\u533a\u95f4\u52a0$x$\u7684\u7ef4\u62a4\u662f$s_2'=\\sum_{k=1}^n\\left(a_k+x\\right)^2=s_2+2s_1x+nx^2$.\n\n\u533a\u95f4\u5e73\u5747\u6570\u9700\u8981\u6c42\u51fa\u533a\u95f4\u548c\u7136\u540e\u9664\u4ee5\u533a\u95f4\u957f\u5ea6.\n\n\u533a\u95f4\u65b9\u5dee\u7684\u8bdd\u90a3\u4e48\u5c31\u662f$\\frac{ns_2-s_1^2}{n^2}$.\n\n\u4ec0\u4e48?\u4f60\u95ee\u6211\u65e2\u7ea6\u5206\u6570\u600e\u4e48\u5904\u7406?\n\n\u4f60\u6015\u662f\u4f20\u8bf4\u4e2d\u7684\u4e0d\u4f1agcd\u5c31\u5199\u7ebf\u6bb5\u6811\u7684\u795e\u4ed9.\n\n\u5f53\u7136\u5f88\u663e\u7136\u7ebf\u6bb5\u6811\u5df2\u7ecf\u6709\u5f88\u591a\u9898\u89e3\u5199\u8fc7\u4e86\u5e76\u4e14\u601d\u8def\u57fa\u672c\u5dee\u4e0d\u591a.\n\n\u6240\u4ee5\u8fd9\u91cc\u653e\u7684\u662f\u4e00\u4e2a\u6807\u8bb0\u6c38\u4e45\u5316\u7684\u7ebf\u6bb5\u6811.\n\n```cpp\n#include <cstdio>\n#include <algorithm>\ntypedef long long ll;\nstruct _ { //\u7ebf\u6bb5\u6811\u8282\u70b9\n    ll s1, s2; //\u533a\u95f4\u548c\uff0c\u5e73\u65b9\u548c.\n    _(const ll& s1 = 0, const ll& s2 = 0) : s1(s1), s2(s2) {}\n    _& operator=(const _& rhs) {s1 = rhs.s1, s2 = rhs.s2; return *this;}\n    _ operator+(const _& rhs) const {return _(s1 + rhs.s1, s2 + rhs.s2);}\n    _& operator+=(const _& rhs) {s1 += rhs.s1, s2 += rhs.s2; return *this;}\n    _ add(const ll& t, const ll& len) const {\n        return _(s1 + len * t, s2 + 2 * s1 * t + len * t * t);\n    } //\u5404\u79cd\u7ef4\u62a4\u4fe1\u606f\n} tree[400001]; //\u8fd9\u91cc\u7684tree[]\u7684\u5b9a\u4e49\u662f\u6267\u884c\u5f53\u524d\u8282\u70b9\u53ca\u5176\u5b50\u6811\u4e2d\u6240\u6709\u7684add\u64cd\u4f5c(tag)\u4e4b\u540e\u7684\u503c\nll tag[400001];\nvoid build(const int& h, const int& l, const int& r) {\n    if (l == r) {\n        scanf(\"%lld\", &tree[h].s1);\n        tree[h].s2 = tree[h].s1 * tree[h].s1;\n        return;\n    }\n    int mid = (l + r) >> 1;\n    build(h << 1, l, mid); build(h << 1 | 1, mid + 1, r);\n    tree[h] = tree[h << 1] + tree[h << 1 | 1];\n}\nvoid add(const int& h, const int& l, const int& r, const int& L, const int& R, const int& x) {\n    if (L <= l && r <= R) {\n        tag[h] += x;\n        tree[h] = tree[h].add(x, r - l + 1);\n        return;\n    }\n    int mid = (l + r) >> 1;\n    if (L <= mid) add(h << 1, l, mid, L, R, x);\n    if (mid < R) add(h << 1 | 1, mid + 1, r, L, R, x);\n    tree[h] = (tree[h << 1] + tree[h << 1 | 1]).add(tag[h], r - l + 1); //\u4e0d\u8981\u5fd8\u8bb0\u7ef4\u62a4\u7684\u65f6\u5019\u8981\u8003\u8651\u6807\u8bb0\n}\n_ sum(const int& h, const int& l, const int& r, const int& L, const int& R) {\n    if (L <= l && r <= R)\n        return tree[h];\n    _ ret;\n    int mid = (l + r) >> 1;\n    if (R <= mid) ret = sum(h << 1, l, mid, L, R);\n    else if (mid < L) ret = sum(h << 1 | 1, mid + 1, r, L, R);\n    else ret = sum(h << 1, l, mid, L, mid) + sum(h << 1 | 1, mid + 1, r, mid + 1, R); //\u6807\u8bb0\u6c38\u4e45\u5316\u53ef\u4ee5\u6709\u5f88\u591a\u79cd\u5199\u6cd5, \u8fd9\u91cc\u662f\u5176\u4e2d\u4e00\u79cd, \u591a\u5199\u4e00\u4e2aif.\n    return ret.add(tag[h], R - L + 1);\n}\ninline ll gcd(ll a, ll b) {\n    for (ll c; (c = a % b); a = b, b = c);\n    return b;\n}\nint n, m;\nint main() {\n    scanf(\"%d%d\", &n, &m);\n    build(1, 1, n);\n    while (m--) {\n        int opt, l, r, d;\n        scanf(\"%d%d%d\", &opt, &l, &r);\n        if (opt == 1) {\n            scanf(\"%d\", &d);\n            add(1, 1, n, l, r, d);\n        }\n        else if (opt == 2) {\n            ll s1 = sum(1, 1, n, l, r).s1;\n            int len = r - l + 1;\n            ll d = gcd(s1, len);\n            printf(\"%lld/%lld\\n\", s1 / d, len / d);\n        }\n        else if (opt == 3) {\n            _ temp = sum(1, 1, n, l, r);\n            int len = r - l + 1;\n            ll s1 = temp.s1, s2 = temp.s2;\n            ll a = s2 * len - s1 * s1, b = 1ll * len * len; //\u5947\u602a\u7684\u8ba1\u7b97\n            ll d = gcd(a, b);\n            printf(\"%lld/%lld\\n\", a / d, b / d);\n        }\n    }\n}\n```\n\n",
        "postTime": 1544275381,
        "uid": 22132,
        "name": "little_gift",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P2122 \u3010\u8fd8\u6559\u5ba4\u3011"
    },
    {
        "content": "\u4e09\u500d\u7ecf\u9a8c\uff1a[P1471](https://www.luogu.com.cn/problem/P1471) $\\;$[P5142](https://www.luogu.com.cn/problem/P5142)\n### \u5206\u6790\uff1a\n\n\u4e00\u770b\u9898\u610f\uff0c\u533a\u95f4\u52a0\uff0c\u6c42\u533a\u95f4\u5e73\u5747\u503c\uff0c\u6c42\u533a\u95f4\u5185\u7684\u65b9\u5dee\uff0c\u90fd\u662f\u533a\u95f4\u64cd\u4f5c\uff0c\u5f88\u5bb9\u6613\u60f3\u5230\u5230\u7528\u7ebf\u6bb5\u6811\u6765\u7ef4\u62a4\u3002\n\n\u533a\u95f4\u52a0\uff1a\u76f4\u63a5\u6253\u4e2a\u7ebf\u6bb5\u6811\u4e00\u7684\u677f\u5b50\u3002\n\n\u533a\u95f4\u6c42\u5e73\u5747\u503c\uff1a\u76f4\u63a5\u533a\u95f4\u6c42\u548c\uff0c\u7136\u540e\u9664\u4ee5\u533a\u95f4\u957f\u5ea6\u3002\n\n#### \u533a\u95f4\u65b9\u5dee\uff1a\n\u6b64\u9898\u6700\u5927\u7684\u96be\u70b9\u5c31\u662f\u6c42\u533a\u95f4\u7684\u65b9\u5dee\u3002\n\n\u5148\u6765\u770b\u4e00\u4e0b\u65b9\u5dee\u516c\u5f0f\uff1a\u5b9a\u4e49 $a$ \u4e3a\u533a\u95f4\u5e73\u5747\u503c\uff0c$l$ \u4e3a\u5de6\u7aef\u70b9\uff0c$r$ \u4e3a\u53f3\u7aef\u70b9\uff0c$n$ \u4e3a\u957f\u5ea6,\u5373 $r-l+1$\u3002\n\n$$\\frac{1}{n}\\sum\\limits^r_{i=l}(a_i-a)^2$$\n\u6211\u4eec\u53ef\u4ee5\u628a\u8fd9\u4e2a\u516c\u5f0f\u5316\u7b80\u4e00\u4e0b\u5f97\uff1a\n$$\\frac{na^2+(a_l^2+a_{l+1}^2+a_{l+2}^2\u2026+a_r^2)+2a(a_l+a_{l+1}+a_{l+2}+\u2026+a_r)}{n}$$\n\u8fd9\u6837\u53ea\u8981\u8bb0\u5f55\u4e0b\u5e8f\u5217\u7684\u548c $\\sum\\limits^r_{i=l}$ \u548c\u5e73\u65b9\u548c $\\sum\\limits^r_{i=l}a_i^2$\uff0c\u5c31\u53ef\u6c42\u51fa\u65b9\u5dee\u3002\n\n\u7136\u540e\u5c31\u662f\u8003\u8651\u61d2\u60f0\u6807\u8bb0\u600e\u6837\u4e0b\u4f20\uff0c\u6c42\u548c\u90e8\u5206\u61d2\u6807\u8bb0\u7684\u6839\u636e\u6a21\u677f\u6765\u5c31\u884c\uff0c\u4e3b\u8981\u5206\u6790\u4e00\u4e0b\u5e73\u65b9\u548c\u7684\u61d2\u6807\u8bb0\u600e\u6837\u4f20\u9012\u3002\n\n\u7531 \n$$a_l^2+a_{l+1}^2+\u2026+a_{r}^2$$\n\n\u53d8\u4e3a \n$$(a_l+x)^2+(a_{l+1}+x)^2+\u2026+(a_{r}+x)^2$$\n\n\u5316\u7b80\u5f97\uff1a\n$$(a_l^2+a_{l+1}^2+\u2026+a_{r}^2)+nx^2+(a_l+a_{l+1}+a_{l+2}+\u2026+a_r)$$ \n\u6240\u4ee5\u61d2\u6807\u8bb0\u5c31\u5904\u7406\u597d\u4e86\u3002\n\n\u8fd8\u6709\u6700\u540e\u7684\u5206\u5f0f\u5f62\u5f0f\u8f93\u51fa\uff0c\u6c42\u4e24\u6570\u6700\u5927\u516c\u7ea6\u6570\u5728\u5206\u522b\u9664\u3002\n\u8bdd\u8bf4\u6211\u5728\u8fd9\uff0c\u5361\u4e86\u534a\u5929\u3002\n\n## \u4ee3\u7801\uff1a\n```cpp\n#include<bits/stdc++.h>\n#define int long long\nusing namespace std;\ninline int read()\n{\n\tint x=0,f=1;char ch=getchar();\n\twhile (ch<'0'||ch>'9'){if (ch=='-') f=-1;ch=getchar();}\n\twhile (ch>='0'&&ch<='9'){x=x*10+ch-48;ch=getchar();}\n\treturn x*f;\n}\nconst int N=1e5+1;\nstruct a1\n{\n\tint l,r;\n\tint pow,he;\n}x[8000051];\nint d[8000051],j[8000051];\nvoid build(int p,int l,int r)//\u5efa\u6811\n{\n\tx[p].l=l;x[p].r=r;\n\tif(l==r)\n\t{\n\t\tx[p].he=d[l];\n\t\tx[p].pow=d[l]*d[l];\n\t\treturn ;\n\t}\n\tint mid=(l+r)>>1;\n\tbuild(p<<1,l,mid);\n\tbuild(p<<1|1,mid+1,r);\n\tx[p].he=x[p<<1].he+x[p<<1|1].he;\n\tx[p].pow=x[p<<1].pow+x[p<<1|1].pow;\n}\nvoid pushdown(int p)//\u91cd\u70b9\uff0c\u61d2\u6807\u8bb0\u3002\n{\n\tif(j[p]!=0)\n\t{\n\t\tj[p<<1]+=j[p];\n\t\tj[p<<1|1]+=j[p];\n\t\tx[p<<1].pow+=2*j[p]*x[p<<1].he+(int)(x[p<<1].r-x[p<<1].l+1)*j[p]*j[p];\n\t\tx[p<<1|1].pow+=2*j[p]*x[p<<1|1].he+(int)(x[p<<1|1].r-x[p<<1|1].l+1)*j[p]*j[p];\n\t\tx[p<<1].he+=(int)(x[p<<1].r-x[p<<1].l+1)*j[p];\n\t\tx[p<<1|1].he+=(int)(x[p<<1|1].r-x[p<<1|1].l+1)*j[p];\n\t\tj[p]=0;\n\t}\n}\nvoid jj(int p,int l,int r,int k)\n{\n\tif(x[p].l>=l&&x[p].r<=r)\n\t{\n\t\tx[p].pow+=2*k*x[p].he+(x[p].r-x[p].l+1)*k*k;\n\t\tx[p].he+=(x[p].r-x[p].l+1)*k;\n\t\tj[p]+=k;\n\t\treturn ;\n\t}\n\tpushdown(p);\n\tint mid=(x[p].l+x[p].r)>>1;\n\tif(mid>=l)\n\t{\n\t\tjj(p<<1,l,r,k);\n\t}\n\tif(mid<r)\n\t{\n\t\tjj(p<<1|1,l,r,k);\n\t}\n\tx[p].he=x[p<<1].he+x[p<<1|1].he;\n\tx[p].pow=x[p<<1].pow+x[p<<1|1].pow;\n}\nint getsum1(int p,int l,int r)\n{\n\tif(x[p].l>=l&&x[p].r<=r)\n\t{\n\t\treturn x[p].he;\n\t}\n\tpushdown(p);\n\tint mid=(x[p].l+x[p].r)>>1;\n\tint ans=0;\n\tif(mid>=l)ans+=getsum1(p<<1,l,r);\n\tif(mid<r)ans+=getsum1(p<<1|1,l,r);\n\treturn ans;\n}\nint getsum2(int p,int l,int r)\n{\n\tif(x[p].l>=l&&x[p].r<=r)\n\t{\n\t\treturn x[p].pow;\n\t}\n\tpushdown(p);\n\tint mid=(x[p].l+x[p].r)>>1;\n\tint ans=0;\n\tif(mid>=l)ans+=getsum2(p<<1,l,r);\n\tif(mid<r)ans+=getsum2(p<<1|1,l,r);\n\treturn ans;\n}\nsigned main()\n{\n\tint n,m;\n\tcin>>n>>m;\n\tfor(int q=1;q<=n;q++)cin>>d[q];\n\tbuild(1,1,n);\n\tfor(int q=1;q<=m;q++)\n\t{\n\t\tint a;\n\t\ta=read();\n\t\tif(a==1)\n\t\t{\n\t\t\tint x,y;\n\t\t\tint k;\n\t\t\tx=read();y=read();cin>>k;\n\t\t\tjj(1,x,y,k);\n\t\t}\n\t\telse if(a==2)\n\t\t{\n\t\t\tint x,y;\n\t\t\tx=read();y=read();\n\t\t\tint i=getsum1(1,x,y);\n\t\t\tint j=(y-x+1);\n\t\t\tif(j==0||i==0)\n\t\t\t{\n\t\t\t\tcout<<\"0/1\\n\";\n\t\t\t}\n\t\t\telse \n\t\t\t{\n\t\t\t\tint o=__gcd(i,j);\n\t\t\t    cout<<i/o<<\"/\"<<j/o<<endl;\n\t\t\t}\n\t\t}\n\t\telse \n\t\t{\n\t\t\tint x,y;\n\t\t\tx=read();y=read();\n\t\t\tint p=getsum1(1,x,y);\n\t\t\tint ans=p*p+getsum2(1,x,y)*(y-x+1)-2*p*p;\n            int i=ans;\n\t\t\tint j=(y-x+1)*(y-x+1);\n\t\t\tif(j==0||i==0)\n\t\t\t{\n\t\t\t\tcout<<\"0/1\\n\";\n\t\t\t}\n\t\t\telse \n\t\t\t{\n\t\t\t\tint o=__gcd(i,j);\n\t\t\t    cout<<i/o<<\"/\"<<j/o<<endl;\n\t\t\t}\n\t\t}\n\t}\n\treturn 0;\n} \n```\n\n",
        "postTime": 1665147127,
        "uid": 649108,
        "name": "Shanganze",
        "ccfLevel": 5,
        "title": "P2122"
    },
    {
        "content": "\u672c\u9898\u89e3\u5206\u4e3a $3$ \u90e8\u5206\uff1a\n\n---\n\n$1$.\u5206\u6570\u3002\u9898\u76ee\u65e2\u7136\u8981\u6c42\u6211\u4eec\u6c42\u5206\u6570\uff08\u8fd8\u8981\u7ea6\u5206\uff09\uff0c\u90a3\u4e48\u81ea\u7136\u5e94\u8be5\u5199\u4e00\u4e2a\u7ed3\u6784\u4f53\u3002\n\n\u7ea6\u5206\u65b9\u6cd5\uff1a\u5206\u5b50 $x$\u3001\u5206\u6bcd $y$ \u540c\u65f6\u9664\u4ee5 $\\gcd(x,y)$\u3002\uff08\u4e0d\u4f1a\u5427\uff0c\u5982\u679c\u8fd9\u90fd\u4e0d\u4f1a\u5efa\u8bae\u91cd\u8bfb\u5c0f\u5b66\uff09\u3002\n\n\u8fd9\u91cc\u6709\u4e00\u4e2a\u5206\u6570\u7ed3\u6784\u4f53\uff0c\u91cd\u8f7d\u4e86\u56db\u5219\u8fd0\u7b97\uff1a\n\n```cpp\ntypedef pair<LL, LL> PII;\n\nLL gcd(LL a, LL b) {\n\treturn (!b) ? (a) : (gcd(b, a % b));\n}\n\nstruct fra {\n\tLL x, y;\n\tvoid judge() {//\u7ea6\u5206\n\t\tLL gg = gcd(x, y);\n\t\tx /= gg;\n\t\ty /= gg;\n\t}\n\tfra operator =(pair<LL, LL> p) {//\u8d4b\u503c\n\t\tx = p.first;\n\t\ty = p.second;\n\t\tjudge();\n\t\treturn *this;\n\t}\n\tfra operator +(fra p) {//\u56db\u5219\u8fd0\u7b97\uff08\u81ea\u52a8\u7ea6\u5206\uff09\n\t\tLL ny = y * p.y;\n\t\tLL nx = (p.y * x) + (y * p.x);\n\t\tfra tmp = {nx, ny};\n\t\ttmp.judge();\n\t\treturn tmp;\n\t}\n\tfra operator -(fra p) {\n\t\tLL ny = y * p.y;\n\t\tLL nx = (p.y * x) - (y * p.x);\n\t\tfra tmp = {nx, ny};\n\t\ttmp.judge();\n\t\treturn tmp;\n\t}\n\tfra operator *(fra p) {\n\t\tLL nx = x * p.x;\n\t\tLL ny = y * p.y;\n\t\tfra tmp = {nx, ny};\n\t\ttmp.judge();\n\t\treturn tmp;\n\t}\n\tfra operator /(fra p) {\n\t\tfra tmp = {p.y, p.x};\n\t\treturn (*this) * tmp;\n\t}\n\tfra rec() {//\u5012\u6570\n\t\treturn {y, x};\n\t}\n};\n```\n\n$2$.\u516c\u5f0f\u63a8\u5bfc\u3002\u8fd9\u9898\u53ea\u8981\u6709\u4e86\u516c\u5f0f\u5c31\u5f88\u7b80\u5355\u4e86\u3002\n\n- \u5e73\u5747\u6570\uff1a\u8bbe\u603b\u548c\u4e3a $sum$\uff0c\u533a\u95f4\u957f\u5ea6\u4e3a $len$\uff0c\u5219\u5e73\u5747\u6570 $\\bar{a}$ \u4e3a $\\dfrac{sum}{len}$\u3002\n\n- \u65b9\u5dee\uff1a\u65b9\u5dee\u4e0d\u597d\u76f4\u63a5\u63a8\uff0c\u6211\u4eec\u8003\u8651\u7ef4\u62a4\u5e73\u65b9\u548c\u3002\n\n  case $1$\uff1a\u5f53\u533a\u95f4\u52a0 $d$ \u65f6\uff0c\u8bbe\u539f\u6765\u5e73\u65b9\u548c\u4e3a $fs$\uff0c\u7edf\u4e00\u52a0 $v$\uff0c\u4e14\u539f\u6765\u603b\u503c\u4e3a $sum$\u3002\n  \n  \n  \u5219\u73b0\u5728\u6709\uff1a$\\sum^{r}_{i=l} (a_i+v)^2$\uff1b\n  \n  \n  \u7528\u5b8c\u5168\u5e73\u65b9\u516c\u5f0f\u6253\u5f00\u5f97 $\\sum^{r}_{i=l} {a_i^2 + a_i \\times v \\times 2  + v^2}$\u3002\n  \n  \u7136\u540e\u5f97\uff1a$\\sum^{r}_{i=l} a_i^2 + 2\\times v \\times \\sum^{r}_{i=l} a_i + \\sum^{r}_{i=l} v^2$\u3002\n  \n  \u6211\u4eec\u7528 $fs$ \u66ff\u6362 $\\sum^{r}_{i=l}$\uff0c\u7136\u540e\u7528 $sum$ \u66ff\u6362 $\\sum^{r}_{i=l}$\u3002\n  \n  \u5f97\u73b0\u5728\u5e73\u65b9\u548c\u662f\uff1a$fs + 2 \\times v \\times sum + \\sum^{r}_{i=l} v^2$\u3002\n  \n  \u6211\u4eec\u53ea\u9700\u8981\u52a0 $2 \\times v \\times sum + \\sum^{r}_{i=l} v^2$ \u5c31\u53ef\u4ee5\u4e86\u3002\n  \n  ---\n  \n  case $2$\uff1a\u7528\u5e73\u65b9\u548c\u8ba1\u7b97\u51fa\u65b9\u5dee\u3002\u8fd9\u4e2a\u9ebb\u70e6\u4e00\u70b9\u3002\n  \n  \u539f\u5f0f $ = \\sum^{r}_{i = l} (a_i - \\bar{a})^2$\u3002\n  \n  \u7528\u5b8c\u5168\u5e73\u65b9\u516c\u5f0f\u6253\u5f00\u5f97 $\\sum^{r}_{i = l} a_i^2 - \\sum^{r}_{i=l}2 \\times \\bar{a} \\times a_i+ \\sum^{r}_{i=l}\\bar{a}^2$\u3002\n  \n  \u7136\u540e\u5f97\uff1a$fs - \\bar{a} \\times 2 \\times sum +  \\sum^{r}_{i=l} \\bar{a}^2$\u3002\n  \n  \u8fdb\u4e00\u6b65\u5f97\uff1a$fs - 2 \\times sum \\times \\bar{a} + \\dfrac{sum^2}{r-l+1}$\u3002\u5c31\u597d\u7b97\u4e86\u3002\n  \n  \u4e5f\u5c31\u662f\uff1a$fs - 2 \\times sum \\times \\dfrac{sum}{r - l + 1} + \\dfrac{sum^2}{r-l+1}$\u3002\n  \n  \u5f97\u51fa\uff1a$fs - 2 \\times \\dfrac{sum^2}{r - l + 1} + \\dfrac{sum^2}{r-l+1}$\u3002\n  \n  \u522b\u6025\uff0c\u9a6c\u4e0a\u5c31\u63a8\u597d\u4e86\uff01\n  \n  \u73b0\u5728\u6709\uff1a$fs - \\dfrac{2 \\times sum^2}{r-l+1} + \\dfrac{sum^2}{r-l+1}$\u3002\n  \n  \u4e3a\u4e86\u65b9\u4fbf\u6211\u4eec\u5199\u7a0b\u5e8f\uff0c\u8fd8\u53ef\u4ee5\u5316\u6210\uff1a$\\dfrac{(r-l+1) \\times fs - sum^2}{(r-l+1)^2}$\u3002\n  \n  \u73b0\u5728\u5f88\u65b9\u4fbf\uff0c\u4e0d\u662f\u5417\uff1f\n  \n  \n  ---\n  \n  $3$.\u4ee3\u7801\u65f6\u95f4\uff01\n  \n```cpp\n#include <bits/stdc++.h>\n#define R register\n#define inl inline\n#define fastios ios::sync_with_stdio(false),cin.tie(0),cout.tie(0);\n#pragma GCC target(\"sse,sse2,sse3,ssse3,sse4,popcnt,abm,mmx,avx,tune=native\")\n#define Debug(file) freopen(file\".in\",\"r\",stdin);freopen(file\".out\",\"w\",stdout);\nusing namespace std;\n#define L(u) (u << 1)\n#define R(u) ((u << 1) | 1)\ntypedef unsigned long long LL;\nLL f(LL x) {\n\treturn x * x;\n}\ntypedef pair<LL, LL> PII;\n\nLL gcd(LL a, LL b) {\n\treturn (!b) ? (a) : (gcd(b, a % b));\n}\n\nstruct fra {\n\tLL x, y;\n\tvoid judge() {\n\t\tLL gg = gcd(x, y);\n\t\tx /= gg;\n\t\ty /= gg;\n\t}\n\tfra operator =(pair<LL, LL> p) {\n\t\tx = p.first;\n\t\ty = p.second;\n\t\tjudge();\n\t\treturn *this;\n\t}\n\tfra operator +(fra p) {\n\t\tLL ny = y * p.y;\n\t\tLL nx = (p.y * x) + (y * p.x);\n\t\tfra tmp = {nx, ny};\n\t\ttmp.judge();\n\t\treturn tmp;\n\t}\n\tfra operator -(fra p) {\n\t\tLL ny = y * p.y;\n\t\tLL nx = (p.y * x) - (y * p.x);\n\t\tfra tmp = {nx, ny};\n\t\ttmp.judge();\n\t\treturn tmp;\n\t}\n\tfra operator *(fra p) {\n\t\tLL nx = x * p.x;\n\t\tLL ny = y * p.y;\n\t\tfra tmp = {nx, ny};\n\t\ttmp.judge();\n\t\treturn tmp;\n\t}\n\tfra operator /(fra p) {\n\t\tfra tmp = {p.y, p.x};\n\t\treturn (*this) * tmp;\n\t}\n\tfra rec() {\n\t\treturn {y, x};\n\t}\n};\n\nistream &operator >>(istream &i, fra &f) {\n\tscanf(\"%llu/%llu\", &f.x, &f.y);\n\treturn i;\n}\n\nostream &operator <<(ostream &o, fra f) {\n\tprintf(\"%llu/%llu\", f.x, f.y);\n\treturn o;\n}\n```\n\n\n```cpp\n/*----------FRACTION-----------PART------------*/\nconst int N = 1e5 + 5;\n\nstruct node {\n\tint l, r;\n\tLL ps, sum;\n\tLL add;\n} tr[N * 4];\nLL n, m, a[N];\n\nvoid pushup(int u) {\n\ttr[u].ps = tr[u << 1].ps + tr[u << 1 | 1].ps;\n\ttr[u].sum = tr[u << 1].sum + tr[u << 1 | 1].sum;\n}\n\nvoid pushdown(int u) {\t\n\tnode &l = tr[u << 1];\n\tnode &r = tr[u << 1 | 1];\n\tnode &now = tr[u];\n\tl.add += now.add;\n\tr.add += now.add;\n\tl.ps += (f(now.add) * (l.r - l.l + 1)) + (2ll * l.sum * now.add);\n\tr.ps += (f(now.add) * (r.r - r.l + 1)) + (2ll * r.sum * now.add);\n\tl.sum += (l.r - l.l + 1ll) * now.add;\n\tr.sum += (r.r - r.l + 1ll) * now.add;\n\tnow.add = 0;\n}\n\nvoid build(int u, int l, int r) {\n\tif (l == r)\n\t\ttr[u] = {l, r, f(a[l]), a[l],0};\n\telse {\n\t\tint mid = l + r >> 1;\n\t\ttr[u] = {l, r, 0, 0, 0};\n\t\tbuild(L(u), l, mid);\n\t\tbuild(R(u), mid + 1, r);\n\t\tpushup(u);\n\t}\n}\n\nvoid modify(int u, int l, int r, LL v) {\n\tif (l <= tr[u].l && tr[u].r <= r) {\n\t\ttr[u].add += v;\n\t\ttr[u].ps += (f(v) * (tr[u].r - tr[u].l + 1)) + (2ll * tr[u].sum * v);\n\t\ttr[u].sum += (tr[u].r - tr[u].l + 1) * v;\n\t} else {\n\t\tint mid = (tr[u].l + tr[u].r) >> 1;\n\t\tpushdown(u);\n\t\tif (l <= mid) {\n\t\t\tmodify(u << 1, l, r, v);\n\t\t}\n\t\tif (r > mid) {\n\t\t\tmodify(u << 1 | 1, l, r, v);\n\t\t}\n\t\tpushup(u);\n\t}\n}\n\nLL query_sum(int u, int l, int r) {\n\tif (l <= tr[u].l && tr[u].r <= r) {\n\t\treturn tr[u].sum;\n\t} else {\n\t\tpushdown(u);\n\t\tint mid = tr[u].l + tr[u].r >> 1;\n\t\tLL ans = 0;\n\t\tif (l <= mid)\n\t\t\tans = query_sum(u << 1, l, r);\n\t\tif (r > mid)\n\t\t\tans += query_sum(u << 1 | 1, l, r);\n\t\treturn ans;\n\t}\n}\n\nLL query_fs(int u, int l, int r) {\n\tif (l <= tr[u].l && tr[u].r <= r) {\n\t\treturn tr[u].ps;\n\t} else {\n\t\tpushdown(u);\n\t\tint mid = tr[u].l + tr[u].r >> 1;\n\t\tLL ans = 0;\n\t\tif (l <= mid)\n\t\t\tans += query_fs(u << 1, l, r);\n\t\tif (r > mid)\n\t\t\tans += query_fs(u << 1 | 1, l, r);\n\t\treturn ans;\n\t}\n}\n```\n\n\n```cpp\n/*----------SEGMENT----TREE----PART------------*/\nint main() {\n\tscanf(\"%d%d\", &n, &m);\n\tfor (int i = 1; i <= n; i ++)\n\t\tscanf(\"%llu\", &a[i]);\n\tbuild(1,1,n);\n\tfor (int i = 0; i < m; i ++) {\n\t\tint op, l, r;LL d;\n\t\tscanf(\"%d%d%d\", &op, &l, &r);\n\t\tif (op == 1) {\n\t\t\tscanf(\"%llu\", &d);\n\t\t\tmodify(1, l, r, d);\n\t\t}\n\t\tif (op == 2) {\n\t\t\tfra tmp = {query_sum(1, l, r), (r - l + 1)};\n\t\t\ttmp.judge();\n\t\t\tcout << tmp << endl;\n\t\t}\n\t\tif (op == 3) {\n\t\t\tLL sum = query_sum(1,l,r);\n\t\t\tLL pfs = query_fs(1,l,r);\n\t\t\tLL len = r-l+1;\n\t\t\t//printf(\"pfs:%llu sum:%llu\\n\",pfs,sum);\n\t\t\tfra ans = {len*pfs-sum*sum,len*len};\n\t\t\tans.judge();\n\t\t\tcout << ans << endl;\n\t\t}\n\t}\n\treturn 0;\n}\n```\n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  ",
        "postTime": 1644657612,
        "uid": 302394,
        "name": "dingshengyang",
        "ccfLevel": 4,
        "title": "\u7ebf\u6bb5\u6811\u5927\u6cd5\u597d\u554a\uff01"
    },
    {
        "content": "### \u80cc\u666f\n\n\u7eaa\u5ff5NOIP\u590d\u6d3b\u6240\u4f5c\n\n### \u5206\u6790\n\n\u9996\u5148\uff0c\u663e\u7136\uff0c\u672c\u9898\u4e00\u770b\u5c31\u77e5\u9053\u8981\u7528**\u7ebf\u6bb5\u6811**\u53bb\u505a\u3002\n\n\u5bf9\u4e8e\u7b2c\u4e00\u4e2a\u64cd\u4f5c\uff0c\u533a\u95f4\u4fee\u6539\u6ca1\u95ee\u9898\u3002 \n\n\u800c\u7b2c\u4e8c\u4e2a\u64cd\u4f5c\uff1a\u6c42\u5e73\u5747\u6570\uff0c\u5c31\u662f\u533a\u95f4\u6c42\u548c/\u533a\u95f4\u957f\u5ea6\u3002\n\n\u7b2c\u4e09\u4e2a\u64cd\u4f5c\u662f\u91cd\u70b9\u3002\u65b9\u5dee\uff0c\u51e1\u5b66\u8fc7\u521d\u4e8c\u4e0b\u7684\u6570\u5b66\u7edf\u8ba1\u7684\u540c\u5b66\u90fd\u77e5\u9053\uff0c\u5373\uff1a\u65b9\u5dee\n**b=((a[i]-c)\u00b2+(a[i+1]-c)\u00b2+(a[i+2]-c)\u00b2+\u2026+(a[j]-c)\u00b2)/(j-i+1)\uff08c\u4e3aa[i]\u5230a[j]\u7684\u5e73\u5747\u6570\uff09**\n\n\u770b\u4e0a\u53bb\u5b83\u4e0d\u80fd\u88ab\u62c6\u5206\u8fdb\u800c\u901a\u8fc7\u533a\u95f4\u67e5\u8be2\u89e3\u51b3\uff08\u56e0\u4e3ac\uff09\uff0c\u4f46\u6211\u4eec\u53ef\u4ee5\u7528\u5b8c\u5168\u5e73\u65b9\u5f0f\u5c06\u5b83\u53d8\u5f62\uff0c\u5982\u4e0b\uff1a(n=j-i+1)\n\n    b=(n*c\u00b2+(a[i]\u00b2+a[i+1]\u00b2+a[i+2]\u00b2+\u2026+a[j]\u00b2)-2c(a[i]+a[i+1]+a[i+2]+\u2026a[j]))/n\n     =((a[i]+a[i+1]+a[i+2]+\u2026a[j])\u00b2/n+(a[i]\u00b2+a[i+1]\u00b2+a[i+2]\u00b2+\u2026+a[j]\u00b2)-2(a[i]+a[i+1]+a[i+2]+\u2026a[j])\u00b2/n)/n\n     =((a[i]\u00b2+a[i+1]\u00b2+a[i+2]\u00b2+\u2026+a[j]\u00b2)-(a[i]+a[i+1]+a[i+2]+\u2026a[j])\u00b2/n)/n\n     =((a[i]\u00b2+a[i+1]\u00b2+a[i+2]\u00b2+\u2026+a[j]\u00b2)*n-(a[i]+a[i+1]+a[i+2]+\u2026a[j])\u00b2)/n\u00b2\n\u5176\u4e2d\uff0c(a[i]+a[i+1]+a[i+2]+\u2026a[j])\u00b2\u53ef\u4ee5\u7531\u533a\u95f4\u6c42\u548c\u518d\u5e73\u65b9\u5f97\u5230\uff0ca[i]\u00b2+a[i+1]\u00b2+a[i+2]\u00b2+\u2026+a[j]\u00b2\u53ef\u4ee5\u518d\u5efa\u4e00\u68f5\u7ebf\u6bb5\u6811\u3002\n\n\u4f46\u5bf9\u5b83\u533a\u95f4\u4fee\u6539(\u6bcf\u4e2a\u6570+z\uff09\u53c8\u662f\u4e00\u4e2a\u95ee\u9898\uff0c\u518d\u7b97\u4e00\u6ce2\uff1a(n=j-i+1)\n\n    x=a[i]\u00b2+a[i+1]\u00b2+a[i+2]\u00b2+\u2026+a[j]\u00b2;\n    y=(a[i]+z)\u00b2+(a[i+1]+z)\u00b2+(a[i+2]+z)\u00b2+\u2026+(a[j]+z)\u00b2\n     =x+n*z\u00b2+2*z*(a[i]+a[i+1]+a[i+2]+\u2026+a[j])\n\u4e8e\u662f\uff0c\u53c8\u5316\u4e3a\u4e86\u7b2c\u4e00\u68f5\u7ebf\u6bb5\u6811\u7684\u95ee\u9898\u3002\u6210\u529f\uff01\n\n\u65e2\u7ea6\u5206\u6570~~\u542c\u4e0a\u53bb\u597d\u602a~~\u5c31\u7528\u4e00\u4e0bgcd\u3002\n\n\u6700\u540e\uff0c\u5343\u4e07\u8bb0\u5f97\u8981\u7528****int64****\u3002\n\n### \u4ee3\u7801\n\n\u9644\u4e0a\u4ee3\u7801\uff1a\uff08\u8d85\u957fqwq\uff09\n```pascal\nvar a,lazy,a1:array[0..400005] of int64;\n  b:array[0..100005] of int64;\n  n,m,i,j,c,x,y,z,t:longint;\n  p,q,r:int64;\nfunction gcd(p,q:int64):int64;\nbegin\n  repeat\n    gcd:=p mod q;\n    p:=q;\n    q:=gcd;\n  until q=0;\n  gcd:=p;\nend;\nprocedure pushdown(l,r,mid,k:longint);\nbegin\n  a1[k*2]:=a1[k*2]+(mid-l+1)*lazy[k]*lazy[k]+2*lazy[k]*a[k*2];\n  a1[k*2+1]:=a1[k*2+1]+(r-mid)*lazy[k]*lazy[k]+2*lazy[k]*a[k*2+1];\n  a[k*2]:=a[k*2]+(mid-l+1)*lazy[k];\n  a[k*2+1]:=a[k*2+1]+(r-mid)*lazy[k];\n  inc(lazy[k*2],lazy[k]);inc(lazy[k*2+1],lazy[k]);lazy[k]:=0;\nend;\nprocedure build(l,r,k:longint);\nvar mid:longint;\nbegin\n  if l=r then begin a[k]:=b[l];a1[k]:=b[l]*b[l];exit;end;\n  mid:=(l+r) div 2;\n  build(l,mid,k*2);\n  build(mid+1,r,k*2+1);\n  a[k]:=a[k*2]+a[k*2+1];\n  a1[k]:=a1[k*2]+a1[k*2+1];\nend;\nfunction find(l,r,k:longint):int64;\nvar mid:longint;\n  s1,s2:int64;\nbegin\n  if(l>=x)and(r<=y)then exit(a[k]);\n  mid:=(l+r) div 2;\n  pushdown(l,r,mid,k);\n  if x<=mid then s1:=find(l,mid,k*2) else s1:=0;\n  if y>mid then s2:=find(mid+1,r,k*2+1) else s2:=0;\n  find:=s1+s2;\nend;\nfunction find1(l,r,k:longint):int64;\nvar mid:longint;\n  s1,s2:int64;\nbegin\n  if(l>=x)and(r<=y)then exit(a1[k]);\n  mid:=(l+r) div 2;\n  pushdown(l,r,mid,k);\n  if x<=mid then s1:=find1(l,mid,k*2) else s1:=0;\n  if y>mid then s2:=find1(mid+1,r,k*2+1) else s2:=0;\n  find1:=s1+s2;\nend;\nprocedure update(l,r,k,t:longint);\nvar mid:longint;\nbegin\n  if(l>=x)and(r<=y)then\n    begin\n      a1[k]:=a1[k]+(r-l+1)*t*t+2*t*a[k];\n      a[k]:=a[k]+t*(r-l+1);\n      lazy[k]:=t+lazy[k];\n      exit;\n    end;\n  mid:=(l+r) div 2;\n  pushdown(l,r,mid,k);\n  if y<=mid then update(l,mid,k*2,t)else\n  if x>mid then update(mid+1,r,k*2+1,t)else\n    begin\n      update(mid+1,r,k*2+1,t);update(l,mid,k*2,t);\n    end;\n  a[k]:=a[k*2]+a[k*2+1];\n  a1[k]:=a1[k*2]+a1[k*2+1];\nend;\nbegin\n  readln(n,m);\n  for i:= 1 to n do read(b[i]);\n  build(1,n,1);\n  for i:= 1 to m do\n    begin\n      read(Z);\n      case z of\n        1:begin\n            read(x,y,t);\n            update(1,n,1,t);\n          end;\n        2:begin\n            read(x,y);\n            p:=find(1,n,1);\n            q:=y-x+1;\n            r:=gcd(p,q);\n            p:=p div r;\n            q:=q div r;\n            writeln(p,'/',q);\n          end;\n        3:begin\n            read(x,y);\n            p:=find(1,n,1);\n            p:=(y-x+1)*find1(1,n,1)-p*p;\n            q:=(y-x+1)*(y-x+1);\n            r:=gcd(p,q);\n            p:=p div r;\n            q:=q div r;\n            writeln(p,'/',q);\n          end;\n      end;\n    end;\n  close(input);close(output);\nend.\n```\n\n\u672c\u849f\u84bbMarkdown\u4e0eLaTeX\u4e0d\u592a\u4f1a\u7528\u8bf7\u8c05\u89e3\u3002",
        "postTime": 1579607237,
        "uid": 112921,
        "name": "zhimao",
        "ccfLevel": 0,
        "title": "P2122\u9898\u89e3"
    },
    {
        "content": "\u5173\u4e8e\u672c\u9898\u7684\u89e3\u6cd5\u697c\u4e0a\u548c\u697c\u4e0b\u5df2\u7ecf\u8bf4\u7684\u975e\u5e38\u8be6\u7ec6\u4e86\uff0c\u5728\u8fd9\u91cc\u63d0\u4f9b\u4e00\u4efd\u975e\u7ed3\u6784\u4f53\u7ebf\u6bb5\u6811\u7684\u4ee3\u7801\u4f9b\u50cf\u6211\u4e00\u6837\u4e0d\u559c\u6b22\u5199\u7ed3\u6784\u4f53\u7ebf\u6bb5\u6811\u7684\u4eba\u53c2\u8003\u3002\n\n\u7ec6\u8282\u5728\u6ce8\u91ca\u91cc\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<cstring>\n#include<cmath>\n#include<algorithm>\n#define ll long long\nusing namespace std;\nconst int maxn=1e5;\nint n,m;\nll a[maxn];\nll ans[maxn<<2],tag[maxn<<2],sum[maxn<<2];//ans\u662f\u533a\u95f4\u548c\uff0ctag\u662f\u61d2\u60f0\u6807\u8bb0\uff0csum\u662f\u533a\u95f4\u5e73\u65b9\u548c\ninline int ls(ll p){return p<<1;}\ninline int rs(ll p){return p<<1|1;}\n//\u5de6\u53f3\u5b50\u6811\nvoid push_up(ll p){ans[p]=ans[ls(p)]+ans[rs(p)];sum[p]=sum[ls(p)]+sum[rs(p)];}\nvoid build(ll p,ll l, ll r)\n{\n\ttag[p]=0;\n\tif(l==r){ans[p]=a[l];sum[p]=a[l]*a[l];return ;}\n\tll mid =(l+r)>>1;\n\tbuild(ls(p),l,mid);\n\tbuild(rs(p),mid+1,r);\n\tpush_up(p);\n}\n//\u5efa\u6811\ninline void f(ll p,ll l, ll r ,ll k)\n{\n\ttag[p]+=k;\n\tsum[p]+=2*k*ans[p]+k*k*(r-l+1);\n\tans[p]+=k*(r-l+1);\n}\n//\u2191\u7528\u6765\u5904\u7406\u533a\u95f4\u52a0\u7684\u51fd\u6570\uff0c\u65b9\u4fbf\u7406\u6e05\u601d\u8def\ninline void push_down(ll p, ll l, ll r)\n{\n\tll mid=(l+r)>>1;\n\tf(ls(p),l,mid,tag[p]);\n\tf(rs(p),mid+1,r,tag[p]);\n\ttag[p]=0;\n}\n//\u4e0b\u4f20\u61d2\u60f0\u6807\u8bb0\uff0c\u8bb0\u5f97\u6e05\u96f6\ninline void update(ll nl,ll nr,ll l, ll r,ll p,ll k)\n{\n\tif(nl<=l&&nr>=r){f(p,l,r,k);return;}\n\tpush_down(p,l,r);\n\tll mid=(l+r)>>1;\n\tif(nl<=mid)update(nl,nr,l,mid,ls(p),k);\n\tif(nr>mid)update(nl,nr,mid+1,r,rs(p),k);\n\tpush_up(p);\n}\n//\u4e0d\u4f1a\u7684\u51fa\u95e8\u5de6\u8f6c\u7ebf\u6bb5\u6811\u6a21\u677f1\nll query(ll qx,ll qy,ll l,ll r,ll p)\n{\n\tll res=0;\n\tif(qx<=l&&qy>=r)return ans[p];\n\tll mid=(l+r)>>1;\n\tpush_down(p,l,r);\n\tif(qx<=mid)res+=query(qx,qy,l,mid,ls(p));\n\tif(qy>mid)res+=query(qx,qy,mid+1,r,rs(p));\n\treturn res;\n}\n//\u2191\u8ba1\u7b97\u533a\u95f4\u548c\nll query2(ll qx,ll qy,ll l,ll r,ll p)\n{\n\n\tll res=0;\n\tif(qx<=l&&qy>=r)return sum[p];\n\tll mid=(l+r)>>1;\n\tpush_down(p,l,r);\n\tif(qx<=mid)res+=query2(qx,qy,l,mid,ls(p));\n\tif(qy> mid)res+=query2(qx,qy,mid+1,r,rs(p));\n\treturn res;\n}\n//\u2191\u8ba1\u7b97\u533a\u95f4\u5e73\u65b9\u548c\nll gcd(ll a,ll b)\n{\n\tif(b==0) return a;\n\treturn gcd(b,a%b);\n}\n//\u2191gcd\uff08\u6ed1\u7a3d\uff09\nint main()\n{\n//\u2193cin\u6162\u7684\u4e00\u6279\n\t// cin>>n>>m;\n\tscanf(\"%lld%lld\",&n,&m);\n\tfor(int i=1;i<=n;i++) cin>>a[i];\n\tbuild(1,1,n);//\u5efa\u6811\n\tll x,l,r,d;\n\twhile(m--)\n\t{\n\t\tscanf(\"%lld\",&x);\n\t\t// cin>>x;\n\t\tif(x==1)\n\t\t{\n\t\t\tscanf(\"%lld%lld%lld\",&l,&r,&d);\n\t\t\t// cin>>l>>r>>d;\n\t\t\tupdate(l,r,1,n,1,d);\n\t\t}\n\t\tif(x==2)\n\t\t{\n\t\t\tscanf(\"%lld%lld\",&l,&r);\n\t\t\t// cin>>l>>r;\n\t\t\tll up=query(l,r,1,n,1);\n\t\t\tll down=r-l+1;\n\t\t\tll temp=gcd(up,down);\n\t\t\tup/=temp;\n\t\t\tdown/=temp;\n\t\t\tprintf(\"%lld/%lld\\n\",up,down);\n\t\t\t// cout<<up<<\"/\"<<down<<endl;\n\t\t}\n\t\tif(x==3)//\u628a\u65b9\u5dee\u5c55\u5f00\u540e\u624b\u63a8\u516c\u5f0f\u5f97\n\t\t{\n\t\t\tscanf(\"%lld%lld\",&l,&r);\n\t\t\t// cin>>l>>r;\n\t\t\tll sum=query(l,r,1,n,1);\n\t\t\tll fang=query2(l,r,1,n,1);\n\t\t\tll up=fang*(r-l+1)-sum*sum;\n\t\t\tll down=(r-l+1)*(r-l+1);\n\t\t\tll temp=gcd(up,down);\n\t\t\tup/=temp;\n\t\t\tdown/=temp;\n\t\t\tprintf(\"%lld/%lld\\n\",up,down);\n\t\t\t// cout<<up/temp<<\"/\"<<down/temp<<endl;\n\t\t}\n\t}\n}\n\n```\n",
        "postTime": 1540897661,
        "uid": 48943,
        "name": "AcRapper",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P2122 \u3010\u8fd8\u6559\u5ba4\u3011"
    },
    {
        "content": "\u8fd9\u79cd\u9898\u5f53\u7136\u8981\u62ff\u5206\u5757\u6c34\u8fc7\n\n\u6233[\u8fd9\u91cc](https://www.luogu.org/problemnew/show/P1471)\u83b7\u5f97\u53cc\u500d\u7ecf\u9a8c\n\n\u9996\u5148\u5047\u8bbe\u5206\u5757\u4f60\u4eec\u90fd\u4f1a\u4e86\n\n\u5982\u679c\u4e0d\u4f1a\u7684\u8bdd\u770b[\u8fd9\u91cc](http://hzwer.com/8053.html)\n\n\u7136\u540e\u5e73\u5747\u6570\u5c31\u7ef4\u62a4\u4e00\u4e2a\u533a\u95f4\u548c\n\n\u65b9\u5dee\u5c31\u662f\u8fd9\u4e2a\u4e1c\u897f:\n\n$\\frac{1}{n}\\sum_{i=1}^n(x_i-\\bar{x})$\n\n\u5176\u4e2d$\\bar{x}=\\frac{1}{n}\\sum_{i=1}^n x_i$\uff0c\u5373\u5e73\u5747\u503c\n\n\u90a3\u4e48\u6211\u4eec\u6765\u5316\u4e00\u5316\u5f0f\u5b50\n\n\u539f\u5f0f$=\\frac{1}{n}(\\sum_{i=1}^n(x_i^2-2\\bar{x}x_i+\\bar{x}^2))$\n\n\u3000\u3000$=\\frac{1}{n}(\\sum_{i=1}^nx_i^2-2\\bar{x}\\sum_{i=1}^nx_i+n\\bar{x}^2)$\n  \n\u3000\u3000$=\\frac{1}{n}(\\sum_{i=1}^nx_i^2-\\bar{x}(2\\sum_{i=1}^nx_i+n\\bar{x}))$\n\n\u3000\u3000\u4ee4$S=\\sum_{i=1}^n$\n\n\u3000\u3000$=\\frac{1}{n}(\\sum_{i=1}^nx_i^2-\\bar{x}S)$\n  \n\u4e5f\u5c31\u662f\u8bf4\u53ea\u8981\u7ef4\u62a4\u533a\u95f4\u548c\u4ee5\u53ca\u533a\u95f4\u5e73\u65b9\u548c\u5c31\u53ef\u4ee5\u7b97\u51fa\u65b9\u5dee\n\n\u533a\u95f4\u548c\u975e\u5e38\u5bb9\u6613\u7ef4\u62a4\uff0c\u90a3\u4e48\u533a\u95f4\u5e73\u65b9\u548c\u5982\u4f55\u7ef4\u62a4?\n\n$(x+a)^2=x^2+2ax+a^2=x^2+a(2x+a)$\n\n\u6240\u4ee5\u4e5f\u53ef\u4ee5\u76f4\u63a5\u7ef4\u62a4\n\n\u7136\u540e\u5c31\u662f\u653e\u4ee3\u7801\u4e86\n\n```cpp\n//\u5206\u5757\n#include<iostream>\n#include<cstdio>\n#include<cstring>\n#include<cmath>\nusing namespace std;\nlong long a[1000000],s1[1000000],s2[1000000],tag[1000000],fz,fm,fd;\nint blo,l,r,x,opt,n,m,bl[1000000],L[100000],R[100000];\nint getin()\n{\n\tint x=0;char ch=getchar();\n\twhile(ch<'0'||ch>'9')ch=getchar();\n\twhile(ch>='0'&&ch<='9')x=x*10+ch-48,ch=getchar();\n\treturn x;\n}\nint wt[30];\nvoid putout(long long x)\n{\n\tif(!x){putchar('0');return;}\n\tint l=0;\n\twhile(x)wt[++l]=x%10,x/=10;\n\twhile(l)putchar(wt[l--]+48);\n}\nlong long gcd(long long a,long long b)\n{\n\treturn b?gcd(b,a%b):a;\n}\nlong long query1(int l,int r)\n{\n\tlong long ans=0;\n\tint minn=min(r,R[l]);\n\tfor(int i=l;i<=minn;i++)ans+=a[i]+tag[bl[l]];\n\tif(bl[l]!=bl[r])for(int i=L[r];i<=r;i++)ans+=a[i]+tag[bl[r]];\n\tfor(int i=bl[l]+1;i<bl[r];i++)ans+=s1[i]+tag[i]*blo;\n\treturn ans;\n}\nlong long sqr(long long x)\n{\n\treturn x*x;\n}\nlong long query2(int l,int r)\n{\n\tlong long ans=0;\n\tint minn=min(r,R[l]);\n\tfor(int i=l;i<=minn;i++)ans+=sqr((a[i]+tag[bl[l]]));\n\tif(bl[l]!=bl[r])for(int i=L[r];i<=r;i++)ans+=sqr(a[i]+tag[bl[r]]);\n\tfor(int i=bl[l]+1;i<bl[r];i++)ans+=s2[i]+(s1[i]*tag[i]<<1)+blo*tag[i]*tag[i];\n\treturn ans;\n}\nvoid update(int l,int r,int w)\n{\n\tint minn=min(r,R[l]);\n\tlong long t=0;\n\tfor(int i=l;i<=minn;i++)\n\t\tt+=a[i],a[i]+=w;\n\ts1[bl[l]]+=(minn-l+1)*w;\n\ts2[bl[l]]+=w*((t<<1)+w*(minn-l+1));\n\tif(bl[l]!=bl[r])\n\t{\n\t\tt=0;\n\t\tfor(int i=L[r];i<=r;i++)\n\t\t\tt+=a[i],a[i]+=w;\n\t\ts1[bl[r]]+=(r-L[r]+1)*w;\n\t\ts2[bl[r]]+=w*((t<<1)+w*(r-L[r]+1));\n\t}\n\tfor(int i=bl[l]+1;i<bl[r];i++)tag[i]+=w;\n}\nint main()\n{\n\tn=getin(),m=getin();\n\tblo=sqrt(n);\n\tfor(int i=1;i<=n;i++)\n\t{\n\t\ta[i]=getin(),bl[i]=(i-1)/blo+1;\n\t\ts1[bl[i]]+=a[i],s2[bl[i]]+=a[i]*a[i];\n\t\tL[i]=(bl[i]-1)*blo+1,R[i]=bl[i]*blo;\n\t}\n\tfor(int i=1;i<=m;i++)\n\t{\n\t\topt=getin(),l=getin(),r=getin();\n\t\tif(opt==1)\n\t\t{\n\t\t\tx=getin();\n\t\t\tupdate(l,r,x);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tfz=query1(l,r),fm=r-l+1;\n\t\t\tif(opt==3)fz=query2(l,r)*fm-fz*fz,fm*=fm;\n\t\t\tif(fz==0)fm=1;\n\t\t\telse fd=gcd(fz,fm),fz/=fd,fm/=fd;\n\t\t\tputout(fz),putchar('/'),putout(fm),puts(\"\");\n\t\t}\n\t}\n}\n```\n\n```cpp\n//\u7ebf\u6bb5\u6811\n#include<iostream>\n#include<cstdio>\n#include<cstring>\n#define getin() it\n#define putout it.out\n#define putchar it.outc\nusing namespace std;\nstruct XDS\n{\n\tlong long tag,s1,s2;\n}a[2000000];\nint w[2000000],n,m,x,l,r,opt;\nlong long fz,fm,fd;\nvoid build(int rot,int lt,int rt)\n{\n\tif(lt==rt){a[rot].s1=w[lt],a[rot].s2=w[lt]*w[lt];return;}\n\tint mid=(lt+rt)>>1;\n\tbuild(rot<<1,lt,mid),build(rot<<1|1,mid+1,rt);\n\ta[rot].s1=a[rot<<1].s1+a[rot<<1|1].s1;\n\ta[rot].s2=a[rot<<1].s2+a[rot<<1|1].s2;\n}\nvoid pushdown(int rot,int lt,int rt)\n{\n\tif(a[rot].tag)\n\t{\n\t\tlong long t=a[rot].tag;a[rot].tag=0;\n\t\tint mid=(lt+rt)>>1;\n\t\ta[rot<<1].tag+=t,a[rot<<1].s2+=t*((mid-lt+1)*t+(a[rot<<1].s1<<1)),a[rot<<1].s1+=(mid-lt+1)*t;\n\t\ta[rot<<1|1].tag+=t,a[rot<<1|1].s2+=t*((rt-mid)*t+(a[rot<<1|1].s1<<1)),a[rot<<1|1].s1+=(rt-mid)*t;\n\t}\n}\nvoid update(int rot,int lt,int rt,int lq,int rq,int w)\n{\n\tif(lt>rq||rt<lq)return;\n\tif(lt>=lq&&rt<=rq)\n\t{\n\t\ta[rot].s2+=w*((rt-lt+1)*w+(a[rot].s1<<1));\n\t\ta[rot].s1+=(rt-lt+1)*w;\n\t\ta[rot].tag+=w;\n\t\treturn;\n\t}\n\tint mid=(lt+rt)>>1;\n\tpushdown(rot,lt,rt);\n\tupdate(rot<<1,lt,mid,lq,rq,w);\n\tupdate(rot<<1|1,mid+1,rt,lq,rq,w);\n\ta[rot].s1=a[rot<<1].s1+a[rot<<1|1].s1;\n\ta[rot].s2=a[rot<<1].s2+a[rot<<1|1].s2;\n}\nlong long query1(int rot,int lt,int rt,int lq,int rq)\n{\n\tif(lt>rq||rt<lq)return 0;\n\tif(lt>=lq&&rt<=rq)return a[rot].s1;\n\tint mid=(lt+rt)>>1;\n\tpushdown(rot,lt,rt);\n\treturn query1(rot<<1,lt,mid,lq,rq)+query1(rot<<1|1,mid+1,rt,lq,rq);\n}\nlong long query2(int rot,int lt,int rt,int lq,int rq)\n{\n\tif(lt>rq||rt<lq)return 0;\n\tif(lt>=lq&&rt<=rq)return a[rot].s2;\n\tint mid=(lt+rt)>>1;\n\tpushdown(rot,lt,rt);\n\treturn query2(rot<<1,lt,mid,lq,rq)+query2(rot<<1|1,mid+1,rt,lq,rq);\n}\nstruct buf\n{\n\tchar a[1<<25],*s;\n\tchar b[1<<25],*t;\n\tbuf():s(a),t(b){a[fread(a,1,sizeof(a),stdin)]=0;}\n\t~buf(){fwrite(b,1,t-b,stdout);}\n\toperator int()\n\t{\n\t\tint x=0;\n\t\twhile(*s<'0'||*s>'9')s++;\n\t\twhile(*s>='0'&&*s<='9')x=x*10+*s++-48;\n\t\treturn x;\n\t}\n\tvoid out(long long x)\n\t{\n\t\tstatic char ch[30];\n\t\tchar *i=ch;\n\t\tif(!x){*t++='0';return;}\n\t\twhile(x)*i++=x%10,x/=10;\n\t\twhile(i!=ch)*t++=*--i+48;\n\t}\n\tvoid outc(char ch){*t++=ch;}\n}it;\nlong long gcd(long long a,long long b)\n{\n\treturn b?gcd(b,a%b):a;\n}\nint main()\n{\n\tn=getin(),m=getin();\n\tfor(int i=1;i<=n;i++)w[i]=getin();\n\tbuild(1,1,n);\n\tfor(int i=1;i<=m;i++)\n\t{\n\t\topt=getin(),l=getin(),r=getin();\n\t\tif(opt==1)\n\t\t{\n\t\t\tx=getin();\n\t\t\tupdate(1,1,n,l,r,x);\n\t\t}\n\t\telse\n\t\t\tif(opt==2)\n\t\t\t{\n\t\t\t\tfz=query1(1,1,n,l,r),fm=r-l+1;\n\t\t\t\tif(fz==0)fm=1;\n\t\t\t\telse fd=gcd(fz,fm),fz/=fd,fm/=fd;\n\t\t\t\tputout(fz),putchar('/'),putout(fm),putchar(10);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tfz=query1(1,1,n,l,r),fm=r-l+1;\n\t\t\t\tfz=query2(1,1,n,l,r)*fm-fz*fz,fm*=fm;\n\t\t\t\tif(fz==0)fm=1;\n\t\t\t\telse fd=gcd(fz,fm),fz/=fd,fm/=fd;\n\t\t\t\tputout(fz),putchar('/'),putout(fm),putchar(10);\n\t\t\t}\n\t}\n}\n```",
        "postTime": 1534384224,
        "uid": 22136,
        "name": "qwaszx",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P2122 \u3010\u8fd8\u6559\u5ba4\u3011"
    }
]