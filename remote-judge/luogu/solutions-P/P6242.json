[
    {
        "content": "## [P6242 \u3010\u6a21\u677f\u3011\u7ebf\u6bb5\u6811 3](https://www.luogu.com.cn/problem/P6242)\n\n### \u9898\u76ee\u7b80\u4ecb\n\n\u7ed9\u4f60\u4e00\u4e2a\u957f\u5ea6\u4e3a $n$ \u7684\u5e8f\u5217 $a$\u3002\u6700\u5f00\u59cb\u4ee4\u5e8f\u5217 $b=a$\u3002\n\n\u73b0\u5728\u8fdb\u884c $m$ \u6b21\u64cd\u4f5c\uff0c\u5206\u4e3a $5$ \u79cd\uff1a\n\n- ```1 l r k```\uff1a\u5c06 $a_l\\sim a_r$ \u52a0\u4e0a $k$\u3002\n\n- ```2 l r v```\uff1a\u5c06 $a_l\\sim a_r$ \u5bf9 $v$ \u53d6\u6700\u5c0f\u503c\u3002\n\n- ```3 l r```\uff1a\u6c42 $a_l\\sim a_r$ \u7684\u548c\u3002\n\n- ```4 l r```\uff1a\u6c42 $a_l\\sim a_r$ \u7684\u6700\u5927\u503c\u3002\n\n- ```5 l r```\uff1a\u6c42 $b_l\\sim b_r$ \u7684\u6700\u5927\u503c\u3002\n\n\u6bcf\u6b21\u64cd\u4f5c\u540e\u4ee4 $b_{i}=\\max(b_{i},a_{i})$ \u3002\n\n------------\n\n### \u601d\u8def\n\n\u524d\u7f6e\u77e5\u8bc6\uff1a\u53ea\u8981\u4f1a\u5199\u7ebf\u6bb5\u6811 $1$\u3002\n\n\u5409\u53f8\u673a\u7ebf\u6bb5\u6811\u6a21\u7248\u9898\uff0c\u8003\u8651\u7528\u7ebf\u6bb5\u6811\u7ef4\u62a4\u3002\uff08\u5927\u96fe\uff09\n\n\u5148\u8bb2\u4e00\u4e9b\u57fa\u7840\u7684\u4e1c\u897f\uff0c\u4f1a\u7684\u53ef\u4ee5\u76f4\u63a5\u8df3\u5230\u540e\u9762\u3002\n\n\u6211\u4eec\u4ece\u7ebf\u6bb5\u6811 $1$ \u5f00\u59cb\u3002\u7ebf\u6bb5\u6811 $1$ \u7684\u64cd\u4f5c\u5c31\u662f\u64cd\u4f5c $1$ \u548c $3$\u3002\n\n\u5148\u8003\u8651\u89e3\u51b3\u64cd\u4f5c $4$\uff0c\u6c42\u533a\u95f4\u6700\u5927\u503c\u3002\n\n\u6bcf\u4e2a\u8282\u70b9\u7ef4\u62a4\u4e00\u4e2a $\\tt maxn$ \u8868\u793a\u8be5\u8282\u70b9\u8868\u793a\u7684\u533a\u95f4\u7684\u6700\u5927\u503c\u3002\n\n\u533a\u95f4\u52a0\u65f6\u5c31\u76f4\u63a5\u628a\u8fd9\u4e2a $\\tt maxn$ \u52a0\u4e0a $k$\u3002\u6807\u8bb0\u4e0b\u4f20\u7684\u65f6\u5019\u4e5f\u662f\u540c\u7406\u3002\u67e5\u8be2\u7684\u65f6\u5019\u5c31\u65b9\u4fbf\u4e86\u3002\n\n\u73b0\u5728\u6211\u4eec\u89e3\u51b3\u4e86\u64cd\u4f5c $1,3$ \u548c $4$\u3002\n\n\u63a5\u4e0b\u6765\u6211\u4eec\u5c1d\u8bd5\u89e3\u51b3\u64cd\u4f5c $5$\u3002\n\n\u5148\u5f15\u5165 $2$ \u4e2a\u6982\u5ff5\uff1a\n\n- $a_i$ \u7684\u5386\u53f2\u6700\uff08\u5c0f$/$\u5927\uff09\u503c\uff1a$a_{i}$ \u5b58\u653e\u8fc7\u7684\u6700\uff08\u5c0f$/$\u5927\uff09\u7684\u6570\u3002\n\n- \u533a\u95f4\u6700\uff08\u5c0f$/$\u5927\uff09\u503c\u64cd\u4f5c\uff1a\u5c06 $a_l\\sim a_r$ \u4e2d\u7684\u6570 $a_{i}$ \u53d8\u4e3a $\\min(a_i,v)$ \u6216 $\\max(a_i,v)$\u3002\n\n\u663e\u7136\u5728\u8fd9\u9898\u4e2d\uff0c$b_i$ \u5c31\u662f $a_i$ \u7684\u5386\u53f2\u6700\u5927\u503c\uff0c\u64cd\u4f5c $2$ \u5c31\u662f\u533a\u95f4\u6700\u5c0f\u503c\u64cd\u4f5c\uff0c\u64cd\u4f5c $5$ \u662f\u6c42\u533a\u95f4\u6700\u5927\u5386\u53f2\u6700\u5927\u503c\u3002\n\n\u770b\u5b8c\u4e0a\u9762\u7684\u5b9a\u4e49\u540e\uff0c\u518d\u6765\u5c1d\u8bd5\u89e3\u51b3\u4e00\u4e0b\u3002\n\n\u64cd\u4f5c $5$ \u7684\u74f6\u9888\u5728\u4e8e\u533a\u95f4\u52a0\u540e\u65e0\u6cd5\u5feb\u901f\u66f4\u65b0\u5e8f\u5217 $b$\u3002\n\n\u56e0\u4e3a\u4e00\u4e2a\u533a\u95f4\u603b\u80fd\u88ab\u82e5\u5e72\u4e2a\u70b9\u8868\u793a\uff0c\u6211\u4eec\u5148\u5c06\u4e00\u4e2a\u533a\u95f4\u5148\u7b80\u5316\u4e00\u4e2a\u8282\u70b9\u3002\n\n\u6211\u4eec\u5728\u533a\u95f4\u52a0\u65f6\uff0c\u4f1a\u5bf9\u4e00\u4e2a\u533a\u95f4\u52a0\u4e0a $k$\u3002\n\n\u82e5 $k>0$\uff0c\u5386\u53f2\u6700\u5927\u503c\u53ef\u80fd\u88ab\u66f4\u65b0\u3002\n\n\u5728 $k=0$\uff0c\u76f8\u5f53\u4e8e\u4ec0\u4e48\u4e5f\u6ca1\u505a\u3002\n\n\u82e5 $k<0$\uff0c\u5386\u53f2\u6700\u5927\u503c\u4e0d\u53ef\u80fd\u88ab\u66f4\u65b0\u3002\n\n\u60f3\u8c61\u4e00\u4e0b\u6211\u4eec\u6b63\u5728\u5bf9\u4e00\u4e2a\u8282\u70b9\uff08\u4e0d\u662f\u4efb\u610f\u533a\u95f4\uff09\u8fdb\u884c\u75af\u72c2\u7684\u533a\u95f4\u52a0\uff0c\u6b64\u65f6\u4e5f\u5c31\u662f\u8be5\u8282\u70b9\u7684 $\\tt tag$ \u5728\u4e00\u76f4\u88ab\u6539\u53d8\u3002\n\n\u7ecf\u8fc7\u4e00\u6b21\u52a0\u6cd5\uff0c\u8fd9\u4e2a $\\tt tag$ \u53ef\u80fd\u53d8\u5927\uff08$k>0$\uff09\uff0c\u4e5f\u53ef\u80fd\u53d8\u5c0f\uff08$k<0$\uff09\u3002\n\n\u4f46\u662f\u6211\u4eec\u6ce8\u610f\u5230\uff0c\u90a3\u4e48\u5728\u6807\u8bb0\u4e0b\u4f20\u524d\uff0c\u5f53\u524d\u8282\u70b9\u7684\u513f\u5b50\u7684\u503c\u662f\u4e0d\u4f1a\u53d8\u7684\u3002\n\n**\u90a3\u4e48\u663e\u7136\uff0c\u5f53 $\\tt tag$ \u8fbe\u5230\u6700\u5927\u65f6\uff0c\u4e0b\u4f20\u7684\u65f6\u5019\u624d\u53ef\u4ee5\u4f7f\u513f\u5b50\u8fbe\u5230\u5f53\u524d\u6700\u5927\u3002\u800c\u53ea\u6709\u5f53\u524d\u6700\u5927\u624d\u6709\u53ef\u80fd\u66f4\u65b0\u5386\u53f2\u6700\u5927\u3002**\n\n\u5047\u8bbe\u8fd9\u4e2a\u8fd9\u4e2a $\\tt tag$ \u4e3a $\\tt tag1$\u3002\n\n\u90a3\u4e48\uff0c\u6211\u4eec\u53ea\u9700\u8981\u518d\u8bbe\u4e00\u4e2a $\\tt tag2$ \u6765\u8868\u793a**\u6ca1\u4e0b\u4f20\u524d\u7684\u6700\u5927 $\\tt tag1$**\uff0c\u90a3\u4e48\u4e0b\u4f20\u66f4\u65b0\u5e8f\u5217 $b$ \u5c31\u5bb9\u6613\u4e86\u3002\n\n\u6ce8\u610f\u4e0b\u4f20\u65f6\u7684\u987a\u5e8f\uff0c\u8981\u5148\u66f4\u65b0 $\\tt maxb$ \u518d\u66f4\u65b0 $\\tt maxa$\uff0c\u5148\u66f4\u65b0 $\\tt tag2$ \u518d\u66f4\u65b0 $\\tt tag1$\u3002\n\n\u53ef\u4ee5\u8fc7\u6d4b\u8bd5\u70b9 $5$ \u548c $6$ \u7684[\u4ee3\u7801](https://www.luogu.com.cn/paste/0n5li3ba)\uff0c\u518d\u5f80\u4e0b\u5c31\u662f\u5b8c\u6574\u7684\u4ee3\u7801\u3002\n\n\u8fd9\u91cc\u4e00\u5b9a\u8981\u7406\u89e3\u900f\uff0c\u4e0d\u7136\u540e\u9762\u80af\u5b9a\u90fd\u770b\u4e0d\u61c2\u3002\n\n------------\n\u63a5\u4e0b\u6765\u8fdb\u5165\u6b63\u9898\uff0c\u5982\u4f55\u89e3\u51b3\u64cd\u4f5c $2$\u3002\n\n\u5bb9\u6613\u53d1\u73b0\u8fd9\u9053\u9898\u7684\u74f6\u9888\u5728\u4e8e\u8fdb\u884c\u64cd\u4f5c $2$ \u540e\uff0c\u65e0\u6cd5\u5feb\u901f\u66f4\u65b0\u4fe1\u606f\uff0c\u4e0d\u4ec5\u533a\u95f4\u5386\u53f2\u6700\u5927\u503c\u66f4\u65b0\u4e0d\u4e86\uff0c\u751a\u81f3\u8fde\u533a\u95f4\u548c\u90fd\u4e0d\u597d\u66f4\u65b0\u3002\u53ea\u80fd\u9012\u5f52\u5230\u53f6\u5b50\u8282\u70b9\uff0c\u7136\u540e\u5bf9\u5176\u53d6\u6700\u5c0f\u503c\uff0c\u7136\u540e\u8fd4\u56de\u3002\n\n\u8fd9\u6837\u5199\u5355\u6b21\u4fee\u6539\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u5c31\u4f1a\u8fbe\u5230\u60ca\u4eba\u7684 $\\mathcal{O}(n)$\u3002\n\n\u90a3\u600e\u4e48\u529e\u5462\uff1f\n\n\u7ebf\u6bb5\u6811\u663e\u7136\u4e0d\u80fd\u76f4\u63a5\u533a\u95f4\u53d6 $\\min$\u3002\n\n\u6211\u4eec\u53ef\u4ee5\u6362\u4e00\u4e2a\u601d\u8def\uff0c\u53ef\u4ee5**\u628a\u533a\u95f4\u5185\u5927\u4e8e $v$ \u7684\u6570\u90fd\u51cf\u53bb\u4e00\u4e2a\u6570\uff0c\u4f7f\u5f97\u8fd9\u4e9b\u6570\u90fd\u53d8\u4e3a $v$**\u3002\n\n\u56e0\u4e3a\u4e0d\u540c\u7684\u6570\u8981\u51cf\u53bb\u4e0d\u540c\u7684\u6570\u624d\u80fd\u7b49\u4e8e $v$\uff0c\u663e\u7136\u6211\u4eec\u4e0d\u80fd\u8bbe\u5f88\u591a $\\tt tag$ \u6765\u8868\u793a\u533a\u95f4\u5185\u4e0d\u540c\u7684\u6570\u8981\u51cf\u53bb\u7684\u6570\u3002\n\n\u90a3\u9000\u4e00\u6b65\u6765\u8bb2\uff0c\u82e5**\u533a\u95f4\u5185\u5927\u4e8e $v$ \u7684\u6570\u53ea\u6709\u4e00\u79cd**\uff0c\u6211\u4eec\u53ef\u4ee5\u600e\u4e48\u505a\u5462\uff1f\n\n\u53ea\u9700\u8981\u7ef4\u62a4\u4e00\u4e2a $\\tt tag$ \u5c31\u884c\u4e86\u3002\n\n\u90a3\u600e\u6837\u624d\u80fd\u4f7f\u5f97\u533a\u95f4\u5185\u5927\u4e8e $v$ \u7684\u6570\u53ea\u6709\u4e00\u79cd\u5462\uff1f\n\n\u53ea\u9700\u8981\u591a\u9012\u5f52\u51e0\u6b21\u5c31\u884c\u4e86\u3002\n\n\u6211\u4eec\u5728\u7ebf\u6bb5\u6811\u6bcf\u4e2a\u8282\u70b9\u8bbe\u4ee5\u4e0b $3$ \u4e2a\u53d8\u91cf\uff0c\u5206\u522b\u4e3a\uff1a\n\n- $\\tt maxn$\uff1a\u8be5\u533a\u95f4\u7684\u6700\u5927\u503c\u3002\n\n- $\\tt se$\uff1a\u8be5\u533a\u95f4\u7684\u4e25\u683c\u6b21\u5927\u503c\uff0c\u4e5f\u5c31\u662f\u6700\u5927\u7684\u6bd4\u6700\u5927\u503c\u5c0f\u7684\u503c\u3002\n\n- $\\tt cnt$\uff1a\u8be5\u533a\u95f4\u7684\u6700\u5927\u503c\u7684\u4e2a\u6570\u3002\n\n\u56e0\u4e3a\u53ea\u6709\u5728\u533a\u95f4\u53ea\u6709\u4e00\u79cd\u6570\u5927\u4e8e $k$ \u7684\u65f6\u5019\u6211\u4eec\u624d\u80fd\u5feb\u901f\u66f4\u65b0\uff0c\u5373\u53ea\u80fd\u5728\u6ee1\u8db3 $\\tt se$ $<k<$ $\\tt maxn$ \u7684\u8282\u70b9\u4e0a\u66f4\u65b0\u3002\n\n\u7efc\u4e0a\u6240\u8ff0\uff0c\u89e3\u51b3\u65b9\u6cd5\u5c31\u662f**\u5728\u7ebf\u6bb5\u6811\u4e2d\u9012\u5f52\uff0c\u76f4\u5230\u8be5\u533a\u95f4\u5927\u4e8e $v$ \u7684\u6570\u53ea\u6709\u4e00\u79cd\u5c31\u66f4\u65b0**\u3002\n\n\u8fd9\u6837\u505a\u603b\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $\\mathcal{O}(m\\log^2n)$\uff0c\u4f46\u6211\u4e0d\u4f1a\u8bc1\u3002\n\n\u56e0\u4e3a\u6709\u4eba\u8bf4\u53ea\u9700\u8981\u8bbe $3$ \u4e2a $\\tt tag$\uff0c\u8fd9\u663e\u7136\u662f\u4e0d\u884c\u7684~~\u5427~~\u3002\u6240\u4ee5\u518d\u6765\u8bf4\u660e\u4e00\u4e0b\u4e3a\u4ec0\u4e48\u9700\u8981\u8bbe $4$ \u4e2a $\\tt tag$\u3002\n\n\u5728\u6ca1\u6709\u64cd\u4f5c $2$ \u7684\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5c31\u8bbe\u4e86 $2$ \u4e2a $\\tt tag$\uff0c\u6765\u7ef4\u62a4\u6574\u4e2a\u533a\u95f4\u3002\n\n\u73b0\u5728\u52a0\u5165\u4e86\u533a\u95f4\u53d6 $\\min$ \u64cd\u4f5c\u3002\u800c\u533a\u95f4\u53d6 $\\min$ \u64cd\u4f5c\u53ea\u4f1a\u66f4\u65b0\u533a\u95f4\u6700\u5927\u503c\u3002\n\n\u90a3\u4e48\u6211\u4eec\u5c31\u9700\u8981\u628a\u6700\u5927\u503c\u548c\u975e\u6700\u5927\u503c\u5206\u5f00\u6765\u7ef4\u62a4\uff0c\u6545\u8981\u8bbe $4$ \u4e2a $\\tt tag$\u3002\n\n\u6362\u53e5\u8bdd\u8bf4\uff0c\u5982\u679c\u4e0d\u8bbe $4$ \u4e2a $\\tt tag$\uff0c\u5c31\u66f4\u65b0\u4e0d\u4e86\u975e\u6700\u5927\u5386\u53f2\u6700\u5927\u503c\u7684\u5386\u53f2\u6700\u5927\u503c\u4e86\u3002\n\n------------\n### \u4ee3\u7801\u53ca\u5176\u7406\u89e3\n\n\u9996\u5148\u8bf4\u660e\uff0c\u672c\u9898\u89e3\u4e3b\u8981\u4ee5\u4ee3\u7801\u4e3a\u4e3b\u3002\u4e2a\u4eba\u8ba4\u4e3a\u4ee3\u7801\u5199\u5f97\u5f88\u6e05\u6670\uff0c\u5982\u679c\u61c2\u5f97\u4e0a\u8ff0\u601d\u8def\u5c31\u4e00\u5b9a\u53ef\u4ee5\u770b\u61c2\u3002\n\n\u5148\u6765\u770b\u4e00\u4e0b\u7ebf\u6bb5\u6811\u6bcf\u4e2a\u8282\u70b9\u9700\u8981\u5b58\u4e9b\u4ec0\u4e48\u3002\n\n\u4ee5\u4e0b\u662f\u9700\u8981\u7ef4\u62a4\u7684 $\\tt tag$\uff1a\n\n- $\\tt add1$\uff1a**\u8be5\u533a\u95f4\u6700\u5927\u503c\u7684\u61d2\u6807\u8bb0**\u3002\n\n- $\\tt add2$\uff1a**\u8be5\u533a\u95f4\u975e\u6700\u5927\u503c\u7684\u61d2\u6807\u8bb0**\u3002\n\n- $\\tt add3$\uff1a**\u8be5\u533a\u95f4\u6700\u5927\u503c\u7684\u61d2\u6807\u8bb0\u7684\u6700\u5927\u503c**\u3002\n\n- $\\tt add4$\uff1a**\u8be5\u533a\u95f4\u975e\u6700\u5927\u7684\u503c\u7684\u61d2\u6807\u8bb0\u7684\u6700\u5927\u503c**\u3002\n\n**\u5177\u4f53\u5730\uff0c$\\tt add3$ \u662f\u5728\u672a\u4e0b\u4f20\u61d2\u6807\u8bb0\u524d\u6700\u5927\u7684 $\\tt add1$ \u7684\u503c\uff0c$\\tt add4$ \u662f\u5728\u672a\u4e0b\u4f20\u61d2\u6807\u8bb0\u524d\u6700\u5927\u7684 $\\tt add2$ \u7684\u503c\u3002**\n\n\u8fd9 $4$ \u4e2a $\\tt tag$ \u53ea\u8981\u7406\u89e3\u900f\u4e86\uff0c\u4ee3\u7801\u5c31\u4e00\u5b9a\u53ef\u4ee5\u770b\u5f97\u61c2\u3002\n\n\u5176\u4ed6\u5c31\u7b80\u5355\u4e86\uff0c\u5177\u4f53\u8be6\u89c1\u4ee3\u7801\u3002\n\n\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\uff0c\u4e00\u4e2a\u533a\u95f4\u53ef\u80fd\u53ea\u6709\u4e00\u79cd\u6570\uff0c\u8fd9\u6837\u5c31\u6ca1\u6709\u533a\u95f4\u4e25\u683c\u6b21\u5927\u503c\u3002\u8fd9\u65f6\u6211\u4eec\u9700\u8981\u7ed9 $\\tt se$ \u8d4b\u4e00\u4e2a\u6781\u5c0f\u503c\u3002\n\n\u5efa\u6811\u4ee3\u7801\u5982\u4e0b\uff1a\n\n```cpp\nstruct segment_tree{\n\tll sum;\n\tint l,r,maxa,cnt,se,maxb;\n\tint add1,add2,add3,add4;\n}s[2000005];\ninline void push_up(int p)\n{\n\ts[p].sum=s[p*2].sum+s[p*2+1].sum;\n\ts[p].maxa=max(s[p*2].maxa,s[p*2+1].maxa);\n\ts[p].maxb=max(s[p*2].maxb,s[p*2+1].maxb);\n\tif(s[p*2].maxa==s[p*2+1].maxa)\n\t{\n\t\ts[p].se=max(s[p*2].se,s[p*2+1].se);\n\t\ts[p].cnt=s[p*2].cnt+s[p*2+1].cnt;\n\t}\n\telse if(s[p*2].maxa>s[p*2+1].maxa)\n\t{\n\t\ts[p].se=max(s[p*2].se,s[p*2+1].maxa);\n\t\ts[p].cnt=s[p*2].cnt;\n\t}\n\telse\n\t{\n\t\ts[p].se=max(s[p*2].maxa,s[p*2+1].se);\n\t\ts[p].cnt=s[p*2+1].cnt;\n\t}\n}\nvoid build(int l,int r,int p)\n{\n\ts[p].l=l,s[p].r=r;\n\tif(l==r)\n\t{\n\t\ts[p].sum=s[p].maxa=s[p].maxb=read();\n\t\ts[p].cnt=1,s[p].se=-2e9;\n\t\treturn;\n\t}\n\tint mid=(l+r)/2;\n\tbuild(l,mid,p*2);\n\tbuild(mid+1,r,p*2+1);\n\tpush_up(p);\n}\n```\n------------\n\u67e5\u8be2\u4e0e\u666e\u901a\u7684\u7ebf\u6bb5\u6811\u65e0\u5f02\uff0c\u6ce8\u610f\u6c42\u548c\u8981\u5f00 ```long long```\u3002\n\n\u4ee3\u7801\u5982\u4e0b\uff1a\n\n```cpp\nll query_sum(int p)\n{\n\tif(l>s[p].r||r<s[p].l)return 0;\n\tif(l<=s[p].l&&s[p].r<=r)return s[p].sum;\n\tpush_down(p);\n\treturn query_sum(p*2)+query_sum(p*2+1);\n}\nint query_maxa(int p)\n{\n\tif(l>s[p].r||r<s[p].l)return -2e9;\n\tif(l<=s[p].l&&s[p].r<=r)return s[p].maxa;\n\tpush_down(p);\n\treturn max(query_maxa(p*2),query_maxa(p*2+1));\n}\nint query_maxb(int p)\n{\n\tif(l>s[p].r||r<s[p].l)return -2e9;\n\tif(l<=s[p].l&&s[p].r<=r)return s[p].maxb;\n\tpush_down(p);\n\treturn max(query_maxb(p*2),query_maxb(p*2+1));\n}\n```\n------------\n\u6211\u4eec\u5148\u6765\u770b\u4e00\u4e0b\u4fee\u6539\u65f6\u8981\u5982\u4f55\u7ef4\u62a4 $\\tt tag$ \u4ee5\u53ca\u5176\u4fe1\u606f\u3002\n\n\u5148\u662f\u533a\u95f4\u52a0\u4fee\u6539\u7684\u4ee3\u7801\uff1a\n```cpp\nvoid update_add(int p)\n{\n\tif(l>s[p].r||r<s[p].l)return;\n\tif(l<=s[p].l&&s[p].r<=r)\n\t{\n\t\ts[p].sum+=1ll*k*s[p].cnt+1ll*k*(s[p].r-s[p].l+1-s[p].cnt);\n\t\ts[p].maxa+=k;\n\t\ts[p].maxb=max(s[p].maxb,s[p].maxa);\n\t\tif(s[p].se!=-2e9)s[p].se+=k;\n\t\ts[p].add1+=k,s[p].add2+=k;\n\t\ts[p].add3=max(s[p].add3,s[p].add1);\n\t\ts[p].add4=max(s[p].add4,s[p].add2);\n\t\treturn;\n\t}\n\tpush_down(p);\n\tupdate_add(p*2),update_add(p*2+1);\n\tpush_up(p);\n}\n```\n\n\u6839\u636e $\\tt tag$ \u7684\u5b9a\u4e49\uff0c\u4e0d\u96be\u5199\u51fa\u4ee5\u4e0a\u4ee3\u7801\u3002\n\n\u5c31\u662f\u4e0d\u7ba1\u6700\u5927\u503c\u8fd8\u662f\u975e\u6700\u5927\u503c\uff0c\u90fd\u52a0\u4e0a $k$\uff0c\u7ef4\u62a4\u4e00\u4e0b\u533a\u95f4\u548c\u3002\n\n\u7136\u540e $\\tt tag$ \u4e5f\u4e0d\u9700\u8981\u7ba1\u662f\u5426\u4e3a\u6700\u5927\u503c\uff0c\u90fd\u52a0\u4e0a $k$\u3002\n\n\u6700\u540e\u8bb0\u5f55\u4e00\u4e0b\u672a\u4e0b\u4f20\u524d\u6700\u5927\u7684 $\\tt tag$ \u7684\u503c\u662f\u591a\u5c11\u3002\n\n\u63a5\u7740\u5c31\u662f\u533a\u95f4\u53d6 $\\min$ \u7684\u4ee3\u7801\uff1a\n\n```cpp\nvoid update_min(int p)\n{\n\tif(l>s[p].r||r<s[p].l||v>=s[p].maxa)return;\n\tif(l<=s[p].l&&s[p].r<=r&&s[p].se<v)\n\t{\n\t\tint k=s[p].maxa-v;\n\t\ts[p].sum-=1ll*s[p].cnt*k;\n\t\ts[p].maxa=v,s[p].add1-=k;\n\t\treturn;\n\t}\n\tpush_down(p);\n\tupdate_min(p*2),update_min(p*2+1);\n\tpush_up(p);\n}\n```\n\u4ee3\u7801\u505a\u7684\u4e8b\u5927\u81f4\u5c31\u662f\uff0c\u5148\u9012\u5f52\u5230\u4e00\u4e2a\u6ee1\u8db3 $\\tt se$ $<v<$ $\\tt maxa$ \u7684\u8282\u70b9\uff0c\u7136\u540e\u5c06\u533a\u95f4\u6700\u5927\u503c\u90fd\u53d8\u4e3a $v$\uff0c\u66f4\u65b0\u533a\u95f4\u548c\uff0c\u533a\u95f4\u6700\u5927\u503c\u4ee5\u53ca $\\tt tag$\u3002\n\n\u56e0\u4e3a\u53ea\u4fee\u6539\u6700\u5927\u503c\uff0c\u6240\u4ee5\u53ea\u7528\u66f4\u65b0 $\\tt add1$\u3002\u56e0\u4e3a\u662f\u53d6 $\\min$\uff0c\u6240\u4ee5\u80af\u5b9a\u4e0d\u4f1a\u66f4\u65b0\u5386\u53f2\u6700\u5927\u503c\u3002\n\n------------\n\u6700\u540e\u6765\u770b\u4e00\u4e0b\u672c\u9898\u7684\u96be\u70b9\uff0c```push_down``` \u662f\u5982\u4f55\u4e0b\u4f20\u61d2\u6807\u8bb0\u3002\n\n\u5148\u653e\u4e0a\u4ee3\u7801\uff1a\n\n```cpp\ninline void change(int k1,int k2,int k3,int k4,int p)\n{\n\ts[p].sum+=1ll*k1*s[p].cnt+1ll*k2*(s[p].r-s[p].l+1-s[p].cnt);\n\ts[p].maxb=max(s[p].maxb,s[p].maxa+k3);\n\ts[p].maxa+=k1;\n\tif(s[p].se!=-2e9)s[p].se+=k2;\n\ts[p].add3=max(s[p].add3,s[p].add1+k3);\n\ts[p].add4=max(s[p].add4,s[p].add2+k4);\n\ts[p].add1+=k1,s[p].add2+=k2;\n}\ninline void push_down(int p)\n{\n\tint maxn=max(s[p*2].maxa,s[p*2+1].maxa);\n\tif(s[p*2].maxa==maxn)\n\t    change(s[p].add1,s[p].add2,s[p].add3,s[p].add4,p*2);\n\telse change(s[p].add2,s[p].add2,s[p].add4,s[p].add4,p*2);\n\tif(s[p*2+1].maxa==maxn)\n\t\tchange(s[p].add1,s[p].add2,s[p].add3,s[p].add4,p*2+1);\n\telse change(s[p].add2,s[p].add2,s[p].add4,s[p].add4,p*2+1);\n\ts[p].add1=s[p].add2=s[p].add3=s[p].add4=0;\n}\n```\n\u770b\u7740\u5c31\u5f88\u6076\u5fc3\uff0c\u4f46\u5176\u5b9e\u4e5f\u4e0d\u96be\u3002\n\n```push_down``` \u4e2d\u662f\u5224\u65ad\u8be5\u533a\u95f4\u7684\u6700\u5927\u503c\u662f\u5426\u4f4d\u4e8e\u5de6\u533a\u95f4\u6216\u53f3\u533a\u95f4\uff0c\u662f\u5c31\u4e0b\u4f20\u6700\u5927\u503c\u7684 $\\tt tag$\uff0c\u5426\u5219\u5c31\u4e0b\u4f20\u975e\u6700\u5927\u503c\u7684 $\\tt tag$\u3002\n\n```change``` \u5c31\u662f\u4e0b\u4f20 $\\tt tag$ \u4ee5\u53ca\u66f4\u65b0\u513f\u5b50\u7684\u4fe1\u606f\u3002\u6839\u636e\u5404\u4e2a $\\tt tag$ \u7684\u5b9a\u4e49\u90fd\u4e0d\u96be\u5199\u51fa\u3002\n\n\u6ce8\u610f\u4e0b\u4f20\u7684\u987a\u5e8f\u3002\n\n\u6700\u540e\u8bb0\u5f97\u6e05\u7a7a $\\tt tag$\u3002\n\n\u5982\u679c\u770b\u4e0d\u61c2\uff0c\u5c31\u628a\u6d4b\u8bd5\u70b9 $5$ \u548c $6$ \u7684\u4ee3\u7801\u7406\u89e3\u900f\u5f7b\u4e86\u518d\u6765\u770b\u3002\n\n------------\n### \u6ce8\u610f\u4e8b\u9879&\u5e38\u6570\u4f18\u5316\n\n1. \u4f7f\u7528\u5feb\u8bfb\u548c\u5feb\u5199\u3002 \n\n2. \u6c42\u548c\u5f00 ```long long```\u3002\n\n3. \u53ea\u6709\u6c42\u548c\u624d\u5f00 ```long long```\uff0c\u5176\u4ed6\u7528 ```int```\u3002\u8fd9\u6837\u53ef\u4ee5\u6bd4\u5168\u7528 ```long long``` \u5feb\u534a\u79d2\u5de6\u53f3\u3002\n\n4. \u9012\u5f52\u7684\u65f6\u5019\u53c2\u6570\u5c3d\u91cf\u5c11\u3002\n\n5. \u7528\u4e00\u4e2a\u7ed3\u6784\u4f53\u6765\u50a8\u5b58\u6811\u7684\u5404\u79cd\u4fe1\u606f\uff0c\u8fd9\u6837\u7a7a\u95f4\u8bbf\u95ee\u8f83\u8fde\u7eed\uff0c\u901f\u5ea6\u8f83\u5feb\u3002\n\n6. \u5728\u5efa\u6811\u7684\u65f6\u5019\u8bfb\u5165\uff0c\u53ef\u4ee5\u4e00\u5b9a\u7684\u8282\u7701\u7a7a\u95f4\u548c\u65f6\u95f4\u3002\n\n7. \u52a0\u4e00\u4e9b\u51fd\u6570\u524d\u52a0 ```inline```\u3002\n\n8. \u4fee\u6539\u65f6\u7684\u66f4\u65b0\u53ef\u4ee5\u7528 ```change``` \u4ee3\u66ff\uff0c\u53ef\u4ee5\u51cf\u5c11\u5927\u91cf\u7801\u91cf\u3002\n\n9. \u6ce8\u610f\u66f4\u65b0\u987a\u5e8f\u3002\n\n------------\n### \u5176\u4ed6\n\n\u6700\u540e\u9644\u4e0a [AC Code](https://www.luogu.com.cn/paste/0n5li3ba)\uff0c\u5728\u7b2c\u4e00\u7bc7\u4ee3\u7801\u7684\u4e0b\u9762\u3002\n\n\u53c2\u8003\u8d44\u6599\uff1a\n\n- [\u7075\u68a6\u306e\u9898\u89e3](https://www.luogu.com.cn/blog/Hakurei-Reimu/solution-p6242)\u3002\n\n- [\u7075\u68a6\u306e\u6d1b\u8c37\u65e5\u62a5](https://www.luogu.com.cn/blog/Hakurei-Reimu/seg-beats)\u3002\n\n- [OI-Wiki](http://oi-wiki.com/ds/seg-beats/)\u3002\n\n$\\tt Updated\\;on\\;10.3,2020$\uff1a\u6574\u7bc7\u91cd\u5199\u3002\n\n$\\tt Updated\\;on\\;7.31,2021$\uff1a\u8865\u5145\u4e86\u4e4b\u524d\u5c11\u5199\u7684 ```update_add```\u3002\u5927\u9762\u79ef\u4fee\u6539\uff0c\u5220\u51cf\u3002\n\n$\\tt Updated\\;on\\;4.17,2022$\uff1a\u51e0\u4e4e\u6574\u7bc7\u91cd\u5199\u3002\n\n$\\tt Updated\\;on\\;8.14,2022$\uff1a\u4fee\u6539\u4e86\u4e00\u4e9b\u5c0f\u9519\u8bef\u3002\u91cd\u5199\u4e86\u534a\u7bc7\uff0c\u51cf\u5c11\u4e86\u6587\u5b57\u91cf\uff0c\u66f4\u65b0\u4e86\u4ee3\u7801\u3002\n\n$\\tt Updated\\;on\\;1.8,2023$\uff1a\u5220\u6539\u4e86\u5c0f\u90e8\u5206\u5185\u5bb9\uff0c\u6dfb\u52a0\u4e86\u90e8\u5206\u5185\u5bb9\uff0c\u6dfb\u52a0\u4e86\u6d4b\u8bd5\u70b9 $5$ \u548c $6$ \u7684\u4ee3\u7801\uff0c\u89e3\u91ca\u4e86\u4e3a\u4ec0\u4e48\u8981\u8bbe $4$ \u4e2a $\\tt tag$ \u6765\u7ef4\u62a4\u3002",
        "postTime": 1593151803,
        "uid": 306049,
        "name": "Utilokasteinn",
        "ccfLevel": 0,
        "title": "P6242 \u3010\u6a21\u677f\u3011\u7ebf\u6bb5\u6811 3"
    },
    {
        "content": "Update 3/29\uff1a\u4fee\u6b63\u4e86\u4e00\u4e9b\u7b14\u8bef\u548c\u53ef\u80fd\u4ee4\u4eba\u8bef\u89e3\u5730\u65b9\u3002\n\n\u5173\u4e8e\u7ebf\u6bb5\u6811\u7ef4\u62a4\u533a\u95f4\u6700\u503c\u64cd\u4f5c\u548c\u533a\u95f4\u5386\u53f2\u6700\u503c\u7684\u5b8c\u6574\u65b9\u6cd5\uff0c\u8bf7\u53c2\u9605\u5409\u5982\u4e00 2016 \u5e74\u7684\u56fd\u5bb6\u96c6\u8bad\u961f\u8bba\u6587 \u548c [\u6211\u7684\u6d1b\u8c37\u65e5\u62a5](https://www.luogu.com.cn/blog/Hakurei-Reimu/seg-beats)\u3002\u8fd9\u7bc7\u9898\u89e3\u5927\u90e8\u5206\u5185\u5bb9\u662f\u590d\u5236\u4e8e\u540e\u8005\u3002\u8c22\u8c22\u5927\u5bb6\u7ed9\u6211\u7684\u65e5\u62a5\u6367\u573a ^_^\n\n## \u6982\u8ff0 ##\n\n\u9996\u5148\u5047\u8bbe\u6211\u4eec\u6709\u4e00\u4e2a\u5e8f\u5217 $A$\u3002\u90a3\u4e48\uff0c\n\n- \u533a\u95f4\u6700\u503c\u64cd\u4f5c\u662f\u6307\uff0c\u7ed9\u5b9a $l,r,k$\uff0c\u5bf9\u4e8e\u6240\u6709 $i\\in[l,r]$ \uff0c\u5c06 $A_i$ \u53d8\u6210 $\\min(A_i,k)$ \u6216 $\\max(A_i,k)$ \u7684\u4e00\u79cd\u64cd\u4f5c\u3002\n\n- \u5bf9\u4e8e\u5e8f\u5217 $A$ \u7684\u67d0\u4e2a\u4f4d\u7f6e $i$\uff0c\u5b83\u7684\u5386\u53f2\u6700\u503c\u662f\u6307 $A_i$ \u4ece\u521d\u59cb\u5316\u5230\u5f53\u524d\u8fbe\u5230\u7684\u6700\u5927\u503c / \u6700\u5c0f\u503c\uff0c\u6216\u8005\u6bcf\u4e00\u6b21\u4fee\u6539\u64cd\u4f5c\u540e\u7684\u503c\u4e4b\u548c\u3002\u6211\u4eec\u628a\u8fd9\u4e09\u79cd\u5206\u522b\u79f0\u4f5c\u5386\u53f2\u6700\u5927\u503c\u3001\u5386\u53f2\u6700\u5c0f\u503c\u548c\u5386\u53f2\u7248\u672c\u548c\u3002\u800c\u533a\u95f4\u5386\u53f2\u6700\u503c\u5219\u662f\u6307\u6c42\u5e8f\u5217 $A$ \u7684\u5386\u53f2\u6700\u503c\u7684\u6700\u5927\u503c / \u6700\u5c0f\u503c\u6216\u8005\u4ee3\u6570\u548c\u7b49\u7684\u533a\u95f4\u95ee\u9898\u3002\n\n\u5728\u8fd9\u9053\u9898\u4e2d\uff0c\u64cd\u4f5c $2$ \u662f\u533a\u95f4\u6700\u5c0f\u503c\u64cd\u4f5c\uff0c\u64cd\u4f5c $5$ \u662f\u6c42\u5386\u53f2\u6700\u5927\u503c\u7684\u533a\u95f4\u6700\u5927\u503c\u3002\n\n## \u9898\u89e3 ##\n\n\u9996\u5148\uff0c\u8ba9\u6211\u4eec\u8003\u8651\u53ea\u6709\u64cd\u4f5c $2,3,4$ \u7684\u60c5\u51b5\u3002\u6211\u4eec\u53d1\u73b0\uff0c\u5173\u4e8e\u533a\u95f4\u6700\u5927\u503c\u7684\u8be2\u95ee\u662f\u53ef\u4ee5\u4f7f\u7528\u5e26\u61d2\u6807\u8bb0\u7684\u7ebf\u6bb5\u6811\u7ef4\u62a4\u7684\uff0c\u800c\u533a\u95f4\u548c\u5219\u4e0d\u662f\u5f88\u5bb9\u6613\u6c42\u51fa\uff0c\u56e0\u4e3a\u8fd9\u4e0d\u80fd\u5728\u4e0b\u4f20\u6807\u8bb0\u65f6\u5feb\u901f\u66f4\u65b0\u7b54\u6848\u3002\n\n\u8003\u8651\u5230\u533a\u95f4\u53d6 $\\min$ \u7684\u64cd\u4f5c\u53ea\u4f1a\u5bf9\u6700\u5927\u503c\u4e0d\u8d85\u8fc7 $k$ \u7684\u8282\u70b9\u4ea7\u751f\u5f71\u54cd\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u8fd9\u65b9\u9762\u4ea7\u751f\u601d\u8def\u3002\u4e3a\u4e86\u4f7f\u590d\u6742\u5ea6\u53d8\u5bf9\uff0c\u7ebf\u6bb5\u6811\u7684\u4e00\u4e2a\u8282\u70b9\u8981\u7ef4\u62a4\u4e09\u4e2a\u4fe1\u606f\uff1a\u533a\u95f4\u6700\u5927\u503c $mx$\uff0c\u533a\u95f4\u4e25\u683c\u6b21\u5927\u503c $se$ \u548c\u6700\u5927\u503c\u7684\u4e2a\u6570 $cnt$\u3002\u90a3\u4e48\uff0c\u4e00\u6b21\u533a\u95f4\u6700\u503c\u64cd\u4f5c\u4f5c\u7528\u5728\u8fd9\u4e2a\u8282\u70b9\u4e0a\u65f6\uff0c\u53ef\u4ee5\u88ab\u5206\u4e3a\u4ee5\u4e0b\u4e09\u79cd\u60c5\u51b5\uff1a\n\n- $k\\geq mx$\uff0c\u6b64\u65f6\u8be5\u64cd\u4f5c\u4e0d\u4f1a\u5bf9\u5f53\u524d\u8282\u70b9\u4ea7\u751f\u5f71\u54cd\uff0c\u76f4\u63a5\u9000\u51fa\uff1b\n- $se<k<mx$\uff0c\u6b64\u65f6\u8fd9\u4e2a\u8282\u70b9\u7ef4\u62a4\u7684\u533a\u95f4\u4e2d\u6240\u6709\u6700\u5927\u503c\u90fd\u4f1a\u88ab\u4fee\u6539\u4e3a $k$\uff0c\u800c\u6700\u5927\u503c\u4e2a\u6570\u4e0d\u53d8\u3002\u5c06\u533a\u95f4\u548c\u52a0\u4e0a $cnt\\cdot(k-mx)$ \uff0c\u6253\u4e0a\u61d2\u6807\u8bb0\uff0c\u7136\u540e\u9000\u51fa\u5373\u53ef\uff1b\n- $k\\leq se$\uff0c\u6b64\u65f6\u65e0\u6cd5\u5feb\u901f\u66f4\u65b0\u533a\u95f4\u4fe1\u606f\uff0c\u56e0\u6b64\u6211\u4eec\u9700\u8981\u7ee7\u7eed\u9012\u5f52\u5230\u5de6\u53f3\u5b50\u6811\u4e2d\uff0c\u56de\u6eaf\u65f6\u5408\u5e76\u4fe1\u606f\u3002\n\n\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u73b0\u5728\u8981\u4ee5 $k=2$ \u5bf9\u4e0b\u9762\u8fd9\u68f5\u7ebf\u6bb5\u6811\u7ef4\u62a4\u7684\u533a\u95f4\u53d6 $\\min$\u3002\u6bcf\u4e2a\u8282\u70b9\u5de6\u4fa7\u8868\u793a\u533a\u95f4\u6700\u5927\u503c\uff0c\u53f3\u4fa7\u8868\u793a\u4e25\u683c\u6b21\u5927\u503c\u3002\uff08\u5f88\u62b1\u6b49\u7528\u4e86\u5409\u8001\u5e08\u8bba\u6587\u91cc\u7684\u4f8b\u5b50\uff0c\u56e0\u4e3a\u6211\u5b9e\u5728\u627e\u4e0d\u51fa\u6bd4\u5b83\u66f4\u9002\u5408\u505a\u4f8b\u5b50\u7684\u4f8b\u5b50\u4e86\uff09\n\n![](https://cdn.luogu.com.cn/upload/image_hosting/2b77ype7.png)\n\n\u6309\u7167\u4e0a\u9762\u63cf\u8ff0\u7684\u64cd\u4f5c\uff0c\u6211\u4eec\u5e94\u8be5\u6cbf\u7740\u7ea2\u8272\u7684\u8fb9 DFS\uff0c\u6700\u540e\u5728\u7ea2\u8272\u7684\u8282\u70b9\u4e0a\u66f4\u65b0\u533a\u95f4\u548c\u5e76\u6253\u4e0a\u6807\u8bb0\u3002\n\n\u8fd9\u6837\u505a\u7684\u590d\u6742\u5ea6\u53ef\u4ee5\u8bc1\u660e\u662f $O(m\\log n)$ \u7684\u3002\u539f\u8bba\u6587\u7684\u8bc1\u660e\u4f7f\u7528\u4e86\u52bf\u80fd\u5206\u6790\uff0c\u8fd9\u91cc\u7ed9\u51fa\u4e00\u79cd\u66f4\u597d\u61c2\u7684 $O((n+m)\\log n)$ \u4e0b\u754c\u7684\u8bc1\u660e\uff1a\n\n>\u663e\u7136\u53ea\u6709\u66b4\u529b DFS \u7684\u8fc7\u7a0b\u4f1a\u5f71\u54cd\u590d\u6742\u5ea6\uff0c\u6211\u4eec\u8003\u8651\u4e00\u6b21\u533a\u95f4\u6700\u503c\u64cd\u4f5c\u4e2d\u54ea\u4e9b\u8282\u70b9\u4f1a\u88ab\u641c\u7d22\u5230\u3002\u53d1\u73b0\u5230\u8fbe\u7684\u8282\u70b9\u533a\u95f4\u4e2d\u4e0d\u540c\u7684\u6570\u7684\u4e2a\u6570\uff08\u4e0b\u79f0\u201c\u503c\u57df\u201d\uff09\u4e00\u5b9a\u4f1a\u51cf\u5c11\uff08\u56e0\u4e3a\u81f3\u5c11\u5c06\u6700\u5927\u503c\u4e0e\u6b21\u5927\u503c\u5408\u5e76\u4e86\uff09\u3002\u7ebf\u6bb5\u6811\u6bcf\u5c42\u8282\u70b9\u8868\u793a\u7684\u533a\u95f4\u7684\u503c\u57df\u4e00\u5171\u662f $O(n)$ \u7684\uff0c\u4e00\u5171 $\\log$ \u5c42\u52a0\u8d77\u6765\u5c31\u662f $O(n\\log n)$\u3002\u518d\u52a0\u4e0a\u6bcf\u6b21\u64cd\u4f5c\u7684\u590d\u6742\u5ea6\uff0c\u53ef\u4ee5\u5f97\u5230\u590d\u6742\u5ea6\u7684\u4e00\u4e2a\u4e0b\u754c\u4e3a $O((n+m)\\log n)$\u3002\n\n\u7136\u540e\uff0c\u6211\u4eec\u52a0\u5165\u533a\u95f4\u52a0\u51cf\u64cd\u4f5c\uff08\u64cd\u4f5c $1$\uff09\u3002\u53d1\u73b0\u4e0a\u9762\u65b9\u6cd5\u7684\u672c\u8d28\u662f\u628a\u7ebf\u6bb5\u6811\u4e0a\u6bcf\u4e2a\u8282\u70b9\u7ef4\u62a4\u7684\u5143\u7d20\u5206\u6210\u4e86**\u6700\u5927\u503c\u548c\u975e\u6700\u5927\u503c**\u8fd9\u4e24\u7c7b\uff0c\u5e76\u5bf9\u5b83\u4eec\u5206\u522b\u7ef4\u62a4\u3002\u533a\u95f4\u6700\u5927\u503c\u6807\u8bb0\u53ea\u4f1a\u6253\u5728 $se<v<mx$ \u7684\u8282\u70b9\u4e0a\uff0c\u53ef\u4ee5\u770b\u6210\u53ea\u9488\u5bf9\u6700\u5927\u503c\u7684\u52a0\u51cf\u64cd\u4f5c\uff1b\u800c\u533a\u95f4\u52a0\u64cd\u4f5c\u5bf9\u4e8e\u8fd9\u4e24\u7c7b\u503c\u90fd\u751f\u6548\u3002\u5206\u522b\u7ef4\u62a4\u533a\u95f4\u6700\u5927\u503c\u7684\u52a0\u51cf\u6807\u8bb0\u548c\u975e\u6700\u5927\u503c\u7684\u52a0\u51cf\u6807\u8bb0\uff0c\u4e0b\u4f20\u65f6\u5224\u65ad\u5f53\u524d\u8282\u70b9\u662f\u5426\u4e3a\u533a\u95f4\u6700\u5927\u503c\u5373\u53ef\u3002\n\n\u7531\u4e8e\u533a\u95f4\u52a0\u51cf\u64cd\u4f5c\uff0c\u67d0\u4e9b\u8282\u70b9\u7684\u503c\u57df\u4f1a\u589e\u5927\u3002\u4e00\u6b21\u533a\u95f4\u52a0\u51cf\u6700\u591a\u4f1a\u5f71\u54cd $O(\\log^2n)$ \u4e2a\u8282\u70b9\u7684\u503c\u57df\uff0c\u6240\u4ee5\u7528\u4e4b\u524d\u7684\u8bc1\u660e\u65b9\u6cd5\u53ef\u8bc1\u590d\u6742\u5ea6\u7684\u4e00\u4e2a\u4e0a\u754c\u4e3a $O(n\\log n+m\\log^2n)$\uff08\u8bba\u6587\u91cc\u7ed9\u7684\u662f $O(m\\log^2n)$\uff09\u3002\u800c\u5b9e\u9645\u5b9e\u73b0\u65f6\u4f1a\u53d1\u73b0\u8fd9\u4e2a\u4e0a\u754c\u5176\u5b9e\u5f80\u5f80\u662f\u8dd1\u4e0d\u6ee1\u7684\uff0c\u901f\u5ea6\u51e0\u4e4e\u4e0e\u5927\u5e38\u6570\u4e00\u4e2a $\\log$ \u63a5\u8fd1\u3002\n\n\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u5df2\u7ecf\u89e3\u51b3\u4e86\u6d4b\u8bd5\u70b9 $3,4$\u3002\u5728\u6b64\u603b\u7ed3\u4e00\u4e0b\uff0c\u4e0a\u9762\u7684\u8fd9\u79cd\u5904\u7406\u533a\u95f4\u6700\u503c\u7684\u65b9\u6cd5\u7684\u6838\u5fc3\u662f**\u6570\u57df\u7684\u5212\u5206**\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u6211\u4eec\u4ee5\u4e00\u4e2a $\\log$ \u7684\u4ee3\u4ef7\uff0c\u5c06\u533a\u95f4\u6700\u503c\u64cd\u4f5c\u8f6c\u5316\u6210\u4e86\u6700\u503c\u6570\u57df\u4e0a\u7684\u533a\u95f4\u52a0\u51cf\u64cd\u4f5c\u3002\n\n---\n\n\u73b0\u5728\u6211\u4eec\u518d\u8003\u8651\u53ea\u6709\u64cd\u4f5c $1,3,4,5$ \u7684\u60c5\u51b5\u3002\n\u6211\u4eec\u5728\u7ebf\u6bb5\u6811\u7684\u6bcf\u4e2a\u8282\u70b9\u4e0a\u7ef4\u62a4\u4e24\u4e2a\u503c\uff1a\u533a\u95f4\u5f53\u524d\u6700\u5927\u503c $mx$ \u548c\u5386\u53f2\u6700\u5927\u503c $mx'$\uff0c\u4ee5\u53ca\u4e24\u4e2a\u6807\u8bb0\uff1a\u533a\u95f4\u52a0\u6807\u8bb0 $add$ \u548c\u5386\u53f2\u6700\u5927\u52a0\u51cf\u6807\u8bb0 $add'$\u3002\u8fd9\u91cc\u552f\u4e00\u4e0d\u5bb9\u6613\u7406\u89e3\u7684\u5c31\u662f\u201c\u5386\u53f2\u6700\u5927\u52a0\u51cf\u6807\u8bb0\u201d\uff0c\u5b83\u8868\u793a\u7684\u662f**\u4ece\u4e0a\u4e00\u6b21\u4e0b\u4f20 $add$ \u5230\u73b0\u5728\uff0c\u533a\u95f4\u52a0\u6807\u8bb0\u8fbe\u5230\u7684\u6700\u5927\u503c**\u3002\n\n\u8003\u8651\u5386\u53f2\u6700\u503c\u6807\u8bb0\u7684\u5408\u5e76\u3002\u5f53\u8282\u70b9 $x$ \u4e0b\u4f20\u6807\u8bb0\u5230\u5b83\u7684\u513f\u5b50 $ch$ \u65f6\uff0c\u513f\u5b50\u5386\u53f2\u6700\u5927\u503c\u5e94\u4e0e\u5f53\u524d\u503c\u53d6 $\\max$\uff0c\u5199\u6210\u516c\u5f0f\u5c31\u662f\u4e0b\u9762\u7684\u6837\u5b50\uff1a\n\n$$add'_{ch}\\gets\\max(add'_{ch},add_{ch}+add'_x)$$\n\n$$mx'_{ch}\\gets\\max(mx'_{ch},mx_{ch}+add'_x)$$\n\n\u8fd9\u6837\u505a\u7684\u6b63\u786e\u6027\u662f\u663e\u7136\u7684\uff0c\u533a\u95f4\u548c\u53ef\u4ee5\u7528\u5e38\u89c4\u65b9\u6cd5\u7ef4\u62a4\uff0c\u590d\u6742\u5ea6\u4e3a $O(m\\log n)$\u3002\u4e8e\u662f\u6211\u4eec\u53c8\u89e3\u51b3\u4e86\u6d4b\u8bd5\u70b9 $5,6$\u3002\n\n---\n\n\u73b0\u5728\u8003\u8651\u5c06\u8fd9\u4e24\u90e8\u5206\u5408\u5e76\u8d77\u6765\uff0c\u5728\u8fd9\u91cc\u6211\u4eec\u5e94\u7528\u4e4b\u524d\u7684\u601d\u60f3\uff0c\u628a\u4e00\u4e2a\u533a\u95f4\u7684\u5143\u7d20\u5212\u5206\u6210\u6700\u5927\u503c\u548c\u975e\u6700\u5927\u503c\u4e24\u90e8\u5206\u3002\u90a3\u4e48\u533a\u95f4\u6700\u503c\u64cd\u4f5c\u53ef\u4ee5\u8f6c\u5316\u4e3a\u5bf9\u6700\u5927\u503c\u7684\u52a0\u51cf\u64cd\u4f5c\uff0c\u800c\u9898\u76ee\u4e2d\u7684\u533a\u95f4\u52a0\u51cf\u5219\u540c\u65f6\u4f5c\u7528\u4e8e\u8fd9\u4e24\u7c7b\u503c\u3002\u4e8e\u662f\u6211\u4eec\u4ee5\u4e00\u4e2a $\\log$ \u7684\u4ee3\u4ef7\u628a\u95ee\u9898\u5c31\u53d8\u6210\u4e86\u4e24\u4e2a\u6570\u57df\u4e0a\u7684\u533a\u95f4\u52a0\u51cf\u64cd\u4f5c\u548c\u5386\u53f2\u6700\u503c\u8be2\u95ee\u3002\u5177\u4f53\u5730\u8bf4\uff0c\u6211\u4eec\u9700\u8981\u7ef4\u62a4\u56db\u79cd\u6807\u8bb0\uff1a\n\n- \u6700\u5927\u503c\u52a0\u51cf\u6807\u8bb0\n- \u6700\u5927\u503c\u5386\u53f2\u6700\u5927\u7684\u52a0\u51cf\u6807\u8bb0\n- \u975e\u6700\u5927\u503c\u52a0\u51cf\u6807\u8bb0\n- \u975e\u6700\u5927\u503c\u5386\u53f2\u6700\u5927\u7684\u52a0\u51cf\u6807\u8bb0\n\n\u524d\u4e24\u4e2a\u6807\u8bb0\u662f\u53ea\u4fee\u6539\u6700\u5927\u503c\u7684\uff0c\u6240\u4ee5\u4e0b\u4f20\u65f6\u8981\u5224\u65ad\u5f53\u524d\u8282\u70b9\u662f\u5426\u5305\u542b\u533a\u95f4\u6700\u5927\u503c\u3002\u603b\u590d\u6742\u5ea6\u4e3a $O(m\\log^2 n)$\uff0c\u9700\u8981\u6ce8\u610f\u4e00\u4e0b\u5e38\u6570\u3002\n\n\u5982\u679c\u6709\u5730\u65b9\u4e0d\u592a\u7406\u89e3\u7684\u8bdd\uff0c\u53ef\u4ee5\u770b\u4e0b\u9762\u7684\u4ee3\u7801\uff1a\n\n```cpp\n#include <cstdio>\n#include <cctype>\n#include <algorithm>\nusing namespace std;\ntypedef long long ll;\nconst int MAXN=550000;\nconst int INF=2E9+233;\nint read()\n{\n\tint x=0, w=0; char ch=0;\n\twhile (!isdigit(ch)) w|=ch=='-', ch=getchar();\n\twhile (isdigit(ch)) x=(x<<3)+(x<<1)+(ch^48), ch=getchar();\n\treturn w?-x:x;\n}\nstruct SegmentTree\n{\n\tstruct Node\n\t{\n\t\tint l, r;\n\t\tint mx, mx_, se, cnt; ll sum;\n\t\tint add1, add1_, add2, add2_;\n\t} tr[4*MAXN];\n\t#define lc (o<<1)\n\t#define rc (o<<1|1)\n\tvoid pushup(int o)\n\t{\n\t\ttr[o].sum=tr[lc].sum+tr[rc].sum;\n\t\ttr[o].mx_=max(tr[lc].mx_, tr[rc].mx_);\n\t\tif (tr[lc].mx==tr[rc].mx)\n\t\t{\n\t\t\ttr[o].mx=tr[lc].mx;\n\t\t\ttr[o].se=max(tr[lc].se, tr[rc].se);\n\t\t\ttr[o].cnt=tr[lc].cnt+tr[rc].cnt;\n\t\t}\n\t\telse if (tr[lc].mx>tr[rc].mx)\n\t\t{\n\t\t\ttr[o].mx=tr[lc].mx;\n\t\t\ttr[o].se=max(tr[lc].se, tr[rc].mx);\n\t\t\ttr[o].cnt=tr[lc].cnt;\n\t\t}\n\t\telse\n\t\t{\n\t\t\ttr[o].mx=tr[rc].mx;\n\t\t\ttr[o].se=max(tr[lc].mx, tr[rc].se);\n\t\t\ttr[o].cnt=tr[rc].cnt;\n\t\t}\n\t}\n\tvoid update(int o, int k1, int k1_, int k2, int k2_)\n\t{\n\t\ttr[o].sum+=1ll*k1*tr[o].cnt+1ll*k2*(tr[o].r-tr[o].l+1-tr[o].cnt);\n\t\ttr[o].mx_=max(tr[o].mx_, tr[o].mx+k1_);\n\t\ttr[o].add1_=max(tr[o].add1_, tr[o].add1+k1_);\n\t\ttr[o].mx+=k1, tr[o].add1+=k1;\n\t\ttr[o].add2_=max(tr[o].add2_, tr[o].add2+k2_);\n\t\tif (tr[o].se!=-INF) tr[o].se+=k2;\n\t\ttr[o].add2+=k2;\n\t}\n\tvoid pushdown(int o)\n\t{\n\t\tint tmp=max(tr[lc].mx, tr[rc].mx);\n\t\tif (tr[lc].mx==tmp)\n\t\t\tupdate(lc, tr[o].add1, tr[o].add1_, tr[o].add2, tr[o].add2_);\n\t\telse update(lc, tr[o].add2, tr[o].add2_, tr[o].add2, tr[o].add2_);\n\t\tif (tr[rc].mx==tmp)\n\t\t\tupdate(rc, tr[o].add1, tr[o].add1_, tr[o].add2, tr[o].add2_);\n\t\telse update(rc, tr[o].add2, tr[o].add2_, tr[o].add2, tr[o].add2_);\n\t\ttr[o].add1=tr[o].add1_=tr[o].add2=tr[o].add2_=0;\n\t}\n\tvoid build(int o, int l, int r, int* a)\n\t{\n\t\ttr[o].l=l, tr[o].r=r;\n\t\ttr[o].add1=tr[o].add1_=tr[o].add2=tr[o].add2_=0;\n\t\tif (l==r)\n\t\t{\n\t\t\ttr[o].sum=tr[o].mx_=tr[o].mx=a[l];\n\t\t\ttr[o].se=-INF, tr[o].cnt=1;\n\t\t\treturn;\n\t\t}\n\t\tint mid=l+r>>1;\n\t\tbuild(lc, l, mid, a);\n\t\tbuild(rc, mid+1, r, a);\n\t\tpushup(o);\n\t}\n\tvoid modify1(int o, int l, int r, int k)\n\t{\n\t\tif (tr[o].l>r||tr[o].r<l) return;\n\t\tif (l<=tr[o].l&&tr[o].r<=r)\n\t\t\t{ update(o, k, k, k, k); return; }\n\t\tpushdown(o);\n\t\tmodify1(lc, l, r, k), modify1(rc, l, r, k);\n\t\tpushup(o);\n\t}\n\tvoid modify2(int o, int l, int r, int k)\n\t{\n\t\tif (tr[o].l>r||tr[o].r<l||k>=tr[o].mx) return;\n\t\tif (l<=tr[o].l&&tr[o].r<=r&&k>tr[o].se)\n\t\t\t{ update(o, k-tr[o].mx, k-tr[o].mx, 0, 0); return; }\n\t\tpushdown(o);\n\t\tmodify2(lc, l, r, k), modify2(rc, l, r, k);\n\t\tpushup(o);\n\t}\n\tll query3(int o, int l, int r)\n\t{\n\t\tif (tr[o].l>r||tr[o].r<l) return 0;\n\t\tif (l<=tr[o].l&&tr[o].r<=r) return tr[o].sum;\n\t\tpushdown(o);\n\t\treturn query3(lc, l, r)+query3(rc, l, r);\n\t}\n\tint query4(int o, int l, int r)\n\t{\n\t\tif (tr[o].l>r||tr[o].r<l) return -INF;\n\t\tif (l<=tr[o].l&&tr[o].r<=r) return tr[o].mx;\n\t\tpushdown(o);\n\t\treturn max(query4(lc, l, r), query4(rc, l, r));\n\t}\n\tint query5(int o, int l, int r)\n\t{\n\t\tif (tr[o].l>r||tr[o].r<l) return -INF;\n\t\tif (l<=tr[o].l&&tr[o].r<=r) return tr[o].mx_;\n\t\tpushdown(o);\n\t\treturn max(query5(lc, l, r), query5(rc, l, r));\n\t}\n\t#undef lc\n\t#undef rc\n} sgt;\nint a[MAXN];\nint main()\n{\n//\tfreopen(\"segbeats.in\", \"r\", stdin);\n//\tfreopen(\"segbeats.out\", \"w\", stdout);\n\tint n=read(), m=read();\n\tfor (int i=1; i<=n; i++) a[i]=read();\n\tsgt.build(1, 1, n, a);\n\twhile (m--)\n\t{\n\t\tint op=read(), l, r, k;\n\t\tswitch (op)\n\t\t{\n\t\t\tcase 1:\n\t\t\t\tl=read(), r=read(), k=read();\n\t\t\t\tsgt.modify1(1, l, r, k);\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\tl=read(), r=read(), k=read();\n\t\t\t\tsgt.modify2(1, l, r, k);\n\t\t\t\tbreak;\n\t\t\tcase 3:\n\t\t\t\tl=read(), r=read();\n\t\t\t\tprintf(\"%lld\\n\", sgt.query3(1, l, r));\n\t\t\t\tbreak;\n\t\t\tcase 4:\n\t\t\t\tl=read(), r=read();\n\t\t\t\tprintf(\"%d\\n\", sgt.query4(1, l, r));\n\t\t\t\tbreak;\n\t\t\tcase 5:\n\t\t\t\tl=read(), r=read();\n\t\t\t\tprintf(\"%d\\n\", sgt.query5(1, l, r));\n\t\t\t\tbreak;\n\t\t}\n\t}\n\treturn 0;\n}\n```\n\n",
        "postTime": 1585311712,
        "uid": 152449,
        "name": "\u7075\u68a6",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P6242 \u3010\u3010\u6a21\u677f\u3011\u7ebf\u6bb5\u68113\u3011"
    },
    {
        "content": "\u672c\u6587\u540c\u6b65\u5728[CSDN](https://blog.csdn.net/Miniqwq/article/details/119618123)\u4e0a\u8fdb\u884c\u53d1\u8868\u3002\n\n\u8fd9\u662f\u4e00\u7bc7\u521a\u5f00\u59cb\u5b66\u4e60\u7ebf\u6bb5\u6811\u7684\u5c0f\u767d\u90fd\u80fd\u770b\u61c2\u7684\u826f\u5fc3\u5b66\u4e60\u7b14\u8bb0\uff01\n\n\u524d\u7f6e\u77e5\u8bc6\uff1a\u542b\u6709\u61d2\u6807\u8bb0\u7684\u7ebf\u6bb5\u6811\uff08\u6ca1\u522b\u7684\u4e86\uff09\u3002\n\n### \u603b\u8ff0\n\n\u4ec0\u4e48\u662f\u5409\u53f8\u673a\u7ebf\u6bb5\u6811\uff1f\n\n\u5c31\u662f\u7ef4\u62a4\u533a\u95f4\u6700\u503c\u548c\u533a\u95f4\u5386\u53f2\u6700\u503c\u7684\u7ebf\u6bb5\u6811\uff0c\u5b83\u7684\u540d\u5b57\u6765\u6e90\u4e8e\u5409\u5982\u4e00\u8001\u5e08\uff0c\u4ed6\u5728 $2016$ \u5e74\u53d1\u8868\u4e86\u4e00\u7bc7[\u96c6\u8bad\u961f\u8bba\u6587](https://pan.baidu.com/s/1o7xSSQ2)\u3002\n\n\u4e0d\u8fc7\u4e3a\u5565\u8fd9\u4f4d\u8001\u5e08\u88ab\u79f0\u4e3a\u5409\u53f8\u673a\u6211\u4e5f\u4e0d\u77e5\u9053\u2026\u2026\n\n\u5e9f\u8bdd\u4e0d\u591a\u8bf4\uff0c\u9a6c\u4e0a\u8fdb\u5165\u6b63\u9898\u5427\u3002\n\n### \u6b63\u9898\n\n\u4f8b\u9898\uff1a[Luogu 6242](https://www.luogu.com.cn/problem/P6242)\n\n\u8bfb\u5b8c\u9898\u6211\u4eec\u53d1\u73b0\uff0c\u4e00\u822c\u7ebf\u6bb5\u6811\u9898\u76ee\u53ea\u9700\u8981\u7528\u5230\u4e00\u4e2a\u6570\u7ec4\uff0c\u800c\u8fd9\u9053\u9898\u7528\u4e86\u4e24\u4e2a\uff0c\u591a\u51fa\u6765\u4e86\u4e2a $B$ \u6570\u7ec4\uff0c\u662f\u4e0d\u662f\u8981\u62c6\u6210\u4e24\u68f5\u6811\uff1f\n\n\u901a\u8fc7\u5206\u6790\u5df2\u77e5\u7684\u6240\u6709\u5173\u4e8e $B$ \u6570\u7ec4\u7684\u6761\u4ef6\uff0c\u6211\u4eec\u627e\u51fa\u7684\u7b54\u6848\u662f\u4e0d\u7528\uff01\n\n1. $B$ \u6570\u7ec4\u6700\u521d\u548c $A$ \u6570\u7ec4\u5b8c\u5168\u76f8\u540c\n2. \u6bcf\u6b21\u64cd\u4f5c\u540e\uff0c\u5c06 $B$ \u6570\u7ec4\u66f4\u65b0\uff0c\u4f7f $B_i = \\max(B_i,A_i)$\n\n\u8fd9\u91cc\u6211\u7ed9\u51fa\u4e86\u4e24\u4e2a\u6761\u4ef6\uff0c\u6761\u4ef6 $1$ \u662f $B$ \u6570\u7ec4\u7684\u521d\u59cb\u5316\uff0c\u6761\u4ef6 $2$ \u662f $B$ \u6570\u7ec4\u7684\u66f4\u65b0\u3002\u663e\u7136\u53ef\u5f97\uff1a$B_i$ \u662f\u51fa\u73b0\u8fc7\u7684\u6240\u6709 $A_i$ \u7684\u6700\u5927\u503c\u3002\n\n\u5f97\u51fa\u7ed3\u8bba\uff1a$B$ \u6570\u7ec4\u7ef4\u62a4 $A$ \u6570\u7ec4\u7684\u5386\u53f2\u6700\u5927\u503c\uff0c**\u4e24\u8005\u516c\u7528\u4e00\u68f5\u7ebf\u6bb5\u6811**\u3002\n\n\u9898\u5e72\u5206\u6790\u5b8c\u4e4b\u540e\uff0c\u8ba9\u6211\u4eec\u6765\u5206\u6790\u4e00\u4e0b\u64cd\u4f5c\u3002\n\n| \u64cd\u4f5c\u53f7 | \u7b80\u8ff0 |\n| :----------: | :----------: |\n| $1$ | \u533a\u95f4\u52a0\u6cd5 |\n| $2$ | \u533a\u95f4\u4fee\u6539\u4e3a\u6700\u5c0f\u503c |\n| $3$ | \u533a\u95f4\u6c42\u548c |\n| $4$ | \u533a\u95f4\u67e5\u8be2\u6700\u5927\u503c |\n| $5$ | \u533a\u95f4\u67e5\u8be2\u5386\u53f2\u6700\u5927\u503c\u4e2d\u7684\u6700\u5927\u503c |\n\n\u63a5\u4e0b\u6765\uff0c\u6211\u4f1a\u5206\u6a21\u5757\u8bb2\u89e3\uff08\u4e00\u5b9a\u8981\u5f80\u4e0b\u770b\u54df\uff0c\u6709\u4ee3\u7801 /se\uff09\u3002\n\n\u5409\u53f8\u673a\u7ebf\u6bb5\u6811\u672c\u8d28\u4e0a\u5c31\u662f\u5e26\u61d2\u6807\u8bb0\u7684\u7ebf\u6bb5\u6811\uff0c\u6240\u4ee5\u4ee3\u7801\u548c\u7ebf\u6bb5\u6811\u7684\u524d\u4e24\u4e2a\u6a21\u677f\u9898\u4e5f\u662f\u5927\u540c\u5c0f\u5f02\u7684\u3002\n\n\u90fd\u6709\u5565\uff1f\n\n```cpp\nstruct SegTree {};\nvoid pushup()\nvoid build()\nvoid pushdown()\nvoid modify()\n// \u6b64\u5904\u7701\u7565N\u4e2amodify\u2026\u2026\nint query()\n// \u6b64\u5904\u7701\u7565N\u4e2aquery\u2026\u2026\n```\n\u770b\u7740\u5c31\u7801\u91cf\u60ca\u4eba\uff0c\u6240\u4ee5\u6211\u4eec\u8981\u5728\u4fdd\u8bc1\u4ee3\u7801\u53ef\u8bfb\u6027\u7684\u57fa\u7840\u4e0a\u5c1d\u8bd5\u51cf\u5c11\u7801\u91cf\uff0c\u539f\u56e0\u6709\u4e8c\uff1a\n\n1. \u4ee3\u7801\u76f8\u5bf9\u77ed\uff0c\u770b\u7740\u8212\u670d\uff08\u8981\u4e0d\u7136\u4f1a\u611f\u89c9\u50cf\u5728\u5199\u5927 % \u4f60\uff09\n2. \u7531\u4e8e\u8fd9\u9898\u4ee3\u7801\u4e0d\u53ef\u907f\u514d\u7684\u957f\uff08\u51fd\u6570\u591a\uff0c\u7ef4\u62a4\u64cd\u4f5c\u591a\uff09\uff0c\u6240\u4ee5\u51fa\u9519\u7684\u6982\u7387\u4e5f\u4f1a\u6bd4\u8f83\u9ad8\uff0c\u9519\u4e86\u4e4b\u540e\u8c03\u4ee3\u7801\u4f1a\u4ee4\u4eba\u5d29\u6e83\u3002\u4e3a\u4e86\u81ea\u5df1\u7684\u5fc3\u7406\u5065\u5eb7\u7740\u60f3\uff0c\u8fd8\u662f\u8981\u628a\u4ee3\u7801\u5199\u7684\u6f02\u4eae\u4e00\u70b9\u7684\u3002\n\n\u5177\u4f53\u600e\u6837\u51cf\u5c11\u7801\u91cf\uff0c\u6211\u4f1a\u5728\u540e\u6587\u8fdb\u884c\u8be6\u7ec6\u7684\u63cf\u8ff0\u3002\n\n#### \u7ebf\u6bb5\u6811\u7ed3\u6784\u4f53\n\n```cpp\nstruct SegTree\n{\n\tint sum, maxst, maxnd, maxhis, maxnum, l, r;\n\tint lazy1, lazy2, lazy3, lazy4;\n\tvoid clear() { lazy1 = lazy2 = lazy3 = lazy4 = 0; }\n} tree[NR << 2];\n```\n\n+ $sum$\uff1a\u533a\u95f4\u5185\u6240\u6709\u5143\u7d20\u7684\u548c\uff0c\u5728\u64cd\u4f5c $3$ \u65f6\u4f1a\u7528\u5230\u3002\n+ $maxst$\uff1a\u533a\u95f4\u5185\u7684\u6700\u5927\u503c\uff0c\u5728\u64cd\u4f5c $2$ \u548c\u64cd\u4f5c $4$ \u65f6\u4f1a\u7528\u5230\u3002\n+ $maxnd$\uff1a\u533a\u95f4\u5185\u7684**\u4e25\u683c**\u6b21\u5927\u503c\uff0c\u5728\u64cd\u4f5c $2$ \u65f6\u4f1a\u7528\u5230\u3002\n+ $maxhis$\uff1a\u533a\u95f4\u5185\u7684\u5386\u53f2\u6700\u5927\u503c\uff0c\u5728\u64cd\u4f5c $5$ \u65f6\u4f1a\u7528\u5230\u3002\n+ $maxnum$\uff1a\u533a\u95f4\u5185\u6700\u5927\u503c\u51fa\u73b0\u7684\u6b21\u6570\uff0c\u5728\u66f4\u65b0\u533a\u95f4\u548c\u65f6\u4f1a\u7528\u5230\u3002\n+ $l$\uff0c$r$\uff1a\u533a\u95f4\u5de6\u53f3\u7aef\u70b9\uff0c\u8bb0\u5f55\u53ef\u4ee5\u51cf\u5c11\u7801\u91cf\u3002\n+ $lazy1$\uff1a\u7ef4\u62a4 $A$ \u6570\u7ec4\u4e2d\u6700\u5927\u503c\u52a0\u6cd5**\u52a0\u7684\u6700\u591a\u7684\u90a3\u4e00\u6b21**\u7684\u61d2\u6807\u8bb0\u3002\n+ $lazy2$\uff1a\u7ef4\u62a4 $B$ \u6570\u7ec4\u4e2d\u6700\u5927\u503c\u52a0\u6cd5**\u52a0\u7684\u6700\u591a\u7684\u90a3\u4e00\u6b21**\u7684\u61d2\u6807\u8bb0\u3002\n+ $lazy3$\uff1a\u7ef4\u62a4 $A$ \u6570\u7ec4\u4e2d\u9664\u4e86\u6700\u5927\u503c\u4e4b\u5916\u6240\u6709\u5143\u7d20\u52a0\u6cd5**\u52a0\u7684\u6700\u591a\u7684\u90a3\u4e00\u6b21**\u7684\u61d2\u6807\u8bb0\u3002\n+ $lazy4$\uff1a\u7ef4\u62a4 $B$ \u6570\u7ec4\u4e2d\u9664\u4e86\u6700\u5927\u503c\u4e4b\u5916\u6240\u6709\u5143\u7d20\u52a0\u6cd5**\u52a0\u7684\u6700\u591a\u7684\u90a3\u4e00\u6b21**\u7684\u61d2\u6807\u8bb0\u3002\n+ $clear()$\uff1a\u6e05\u7a7a\u533a\u95f4\u5185\u7684\u61d2\u6807\u8bb0\uff0c\u4f7f\u4ee3\u7801\u6574\u4f53\u66f4\u52a0\u6a21\u5757\u5316\u3002\n\n\u6ce8\uff1a\n\n+ \u4e3a\u4e86\u65b9\u4fbf\uff0c\u63a5\u4e0b\u6765\u6211\u4f1a\u628a\u4e25\u683c\u6b21\u5927\u503c\u79f0\u4e3a\u6b21\u5927\u503c\uff0c\u4f46\u662f\u8bfb\u8005\u52ff\u5fd8\u5b83\u7684\u771f\u5b9e\u542b\u4e49\uff01\n+ \u6211\u540e\u6587\u4f1a\u5c06 $sum$\uff0c$maxst$\uff0c$maxnd$\uff0c$maxnum$ \u79f0\u4e3a\u56db\u5927\u5929\u738b\uff08\u8fd8\u662f\u60f3\u5077\u61d2\uff09\u3002\n\n\u6211\u4eec\u8fd0\u7528\u4e00\u4e9b `#define` \u6765\u51cf\u5c11\u7801\u91cf\u3002\n\n```cpp\n#define sum(p) tree[p].sum\n#define max1(p) tree[p].maxst\n#define max2(p) tree[p].maxnd\n#define maxhis(p) tree[p].maxhis\n#define cnt(p) tree[p].maxnum\n#define l(p) tree[p].l\n#define r(p) tree[p].r\n#define lzy1(p) tree[p].lazy1\n#define lzy2(p) tree[p].lazy2\n#define lzy3(p) tree[p].lazy3\n#define lzy4(p) tree[p].lazy4\n```\n\n\u770b\u7740\u611f\u89c9\u50cf\u5728\u589e\u52a0\u7801\u91cf\uff0c\u4e0d\u8fc7\u6211\u4fdd\u8bc1\uff0c\u6700\u7ec8\u7801\u91cf\u4e00\u5b9a\u4f1a\u51cf\u5c11\u7684qwq\uff01\n\n\u6211\u8bd5\u4e86\u8bd5\uff0c\u52a0\u4e86\u8fd9\u5768 `#define` \u603b\u7801\u91cf 3.54KB\uff0c\u4e0d\u52a0 3.95KB\u3002\n\n#### \u5efa\u6811\n\n\u9012\u5f52\u7684\u8fc7\u7a0b\u4e2d\uff0c\u8bb0\u5f55\u533a\u95f4\u5de6\u53f3\u7aef\u70b9\u3002\n\n\u5982\u679c\u9012\u5f52\u5230\u4e86\u53f6\u5b50\u7ed3\u70b9\uff08\u5373 $l = r$\uff09\uff0c\u521d\u59cb\u5316\u56db\u5927\u5929\u738b\u548c\u533a\u95f4\u6700\u5927\u503c\u7684\u4e2a\u6570\u3002\u7531\u4e8e\u533a\u95f4\u91cc\u53ea\u6709 $1$ \u4e2a\u5143\u7d20 $A_l$\uff0c\u6240\u4ee5\u628a\u533a\u95f4\u6700\u5927\u503c\u51fa\u73b0\u7684\u6b21\u6570\u8bbe\u4e3a $1$\u3002\u56db\u5927\u5929\u738b\u4e2d\u9664\u4e86\u533a\u95f4\u6b21\u5927\u503c\uff0c\u90fd\u521d\u59cb\u5316\u4e3a $A_l$\u3002\u7531\u4e8e\u6ca1\u6709\u7b2c\u4e8c\u4e2a\u6570\u4e86\uff0c\u5c31\u6682\u4e14\u5c06\u533a\u95f4\u6b21\u5927\u503c\u521d\u59cb\u5316\u4e3a $\\text{-INF}$\uff0c\u8fd9\u6837\u662f\u4e2a\u6570\u5c31\u80fd\u6bd4\u5b83\u5927\uff0c\u65b9\u4fbf\u66f4\u65b0\uff08\u5982\u679c\u521d\u59cb\u5316\u7684\u4e0d\u591f\u5c0f\uff0c\u6bd4 $A$ \u6570\u7ec4\u7684\u6700\u5c0f\u503c $-5 \\times 10^8$ \u5927\uff0c\u5c31\u4f1a\u9020\u6210\u65e0\u6cd5\u66f4\u65b0\u7684\u5c40\u9762\uff0c\u4e00\u5b9a\u8981\u6ce8\u610f\uff09\u3002\n\n```cpp\nvoid build(int p, int l, int r)\n{\n\tl(p) = l, r(p) = r;\n\tif(l == r) { sum(p) = max1(p) = maxhis(p) = a[l], max2(p) = -INF, cnt(p) = 1; return; }\n\tint mid = (l + r) >> 1; build(p << 1, l, mid), build(p << 1 | 1, mid + 1, r), pushup(p);\n}\n```\n\n#### \u5411\u4e0a\u66f4\u65b0\n\n`pushup()` \u4f1a\u66f4\u65b0\u56db\u5927\u5929\u738b\u53ca\u533a\u95f4\u6700\u5927\u503c\u7684\u51fa\u73b0\u6b21\u6570\u3002\n\n\u533a\u95f4\u6700\u5927\u503c\u80af\u5b9a\u662f\u4e24\u4e2a\u5b50\u533a\u95f4\u6700\u5927\u5143\u7d20\u4e2d\u5927\u7684\u90a3\u4e00\u4e2a\uff0c\u533a\u95f4\u5386\u53f2\u6700\u5927\u503c\u540c\u7406\u3002\n\n\u533a\u95f4\u548c\u662f\u4e24\u4e2a\u5b50\u533a\u95f4\u7684\u548c\u76f8\u52a0\u7684\u7ed3\u679c\u3002\n\n\u5bf9\u4e8e\u533a\u95f4\u6700\u5927\u503c\u7684\u51fa\u73b0\u6b21\u6570\uff1a\n\n+ \u5f53\u5de6\u5b50\u533a\u95f4\u6700\u5927\u5143\u7d20\u548c\u53f3\u5b50\u533a\u95f4\u6700\u5927\u5143\u7d20\u76f8\u7b49\u65f6\uff0c\u5b83\u4eec\u7236\u533a\u95f4\u7684\u6700\u5927\u5143\u7d20\u51fa\u73b0\u6b21\u6570\u5c31\u662f\u4e24\u4e2a\u5b50\u533a\u95f4\u76f8\u52a0\u7684\u7ed3\u679c\u3002\n\n+ \u5426\u5219\uff0c\u5b83\u4eec\u7236\u533a\u95f4\u7684\u6700\u5927\u5143\u7d20\u51fa\u73b0\u6b21\u6570\u7b49\u4e8e\u5de6\u53f3\u4e24\u4e2a\u5b50\u533a\u95f4\u4e2d\u533a\u95f4\u6700\u5927\u503c\u5927\u7684\u90a3\u4e2a\u533a\u95f4\u7684\u6700\u5927\u5143\u7d20\u51fa\u73b0\u6b21\u6570\u3002\n\n\u5bf9\u4e8e\u533a\u95f4\u6b21\u5927\u503c\uff1a\n\n+ \u5f53\u5de6\u5b50\u533a\u95f4\u6700\u5927\u5143\u7d20\u548c\u53f3\u5b50\u533a\u95f4\u6700\u5927\u5143\u7d20\u76f8\u7b49\u65f6\uff0c\u5b83\u4eec\u7236\u533a\u95f4\u7684\u6b21\u5927\u5143\u7d20\u7b49\u4e8e\u4e24\u4e2a\u5b50\u533a\u95f4\u6b21\u5927\u5143\u7d20\u4e2d\u5927\u7684\u90a3\u4e00\u4e2a\u3002\n\n+ \u5426\u5219\uff0c\u5b83\u4eec\u7236\u533a\u95f4\u7684\u6b21\u5927\u5143\u7d20\u7b49\u4e8e\u6700\u5927\u5143\u7d20\u5c0f\u7684\u90a3\u4e2a\u5b50\u533a\u95f4\u7684\u6700\u5927\u5143\u7d20\u548c\u53e6\u4e00\u4e2a\u5b50\u533a\u95f4\u7684\u6b21\u5927\u5143\u7d20\u4e2d\u7684\u6700\u5927\u503c\u3002\n\n```cpp\nvoid pushup(int p)\n{\n\tmax1(p) = max(max1(p << 1), max1(p << 1 | 1));\n\tmaxhis(p) = max(maxhis(p << 1), maxhis(p << 1 | 1));\n\tsum(p) = sum(p << 1) + sum(p << 1 | 1);\n\tif(max1(p << 1) == max1(p << 1 | 1)) max2(p) = max(max2(p << 1), max2(p << 1 | 1)), cnt(p) = cnt(p << 1) + cnt(p << 1 | 1);\n\tif(max1(p << 1) > max1(p << 1 | 1)) max2(p) = max(max1(p << 1 | 1), max2(p << 1)), cnt(p) = cnt(p << 1);\n\tif(max1(p << 1) < max1(p << 1 | 1)) max2(p) = max(max1(p << 1), max2(p << 1 | 1)), cnt(p) = cnt(p << 1 | 1);\n}\n```\n\n#### \u4e0b\u4f20\u61d2\u6807\u8bb0\n\n\u7531\u4e8e\u8fd9\u9053\u9898\u7ef4\u62a4\u4e86 $4$ \u4e2a\u61d2\u6807\u8bb0\uff0c\u4e0b\u4f20\u61d2\u6807\u8bb0\u65f6\u4f1a\u6bd4\u8f83\u590d\u6742\uff0c\u4e3a\u4e86\u65b9\u4fbf\u7406\u89e3\uff0c\u6211\u4eec\u628a\u4e0b\u4f20\u61d2\u6807\u8bb0\u7684\u64cd\u4f5c\u62c6\u6210 $2$ \u4e2a\u51fd\u6570\uff1a`update()` \u548c `pushdown()`\uff08\u5176\u5b9e\u8981\u8bba\u5173\u7cfb\uff0c`update()` \u5176\u5b9e\u662f `pushdown()` \u7684\u5b50\u51fd\u6570\uff09\u3002\n\n\u5148\u6765\u770b\u770b `update()`\u3002\n\n+ $l1$ \u662f\u533a\u95f4\u6700\u5927\u503c\u52a0\u4e0a\u7684\u6570\u3002\n+ $l2$ \u662f\u533a\u95f4\u5386\u53f2\u6700\u5927\u503c\u52a0\u4e0a\u7684\u6570\u3002\n+ $l3$ \u662f\u533a\u95f4\u975e\u6700\u5927\u503c\u52a0\u4e0a\u7684\u6570\u3002\n+ $l4$ \u662f\u533a\u95f4\u5386\u53f2\u975e\u6700\u5927\u503c\u52a0\u4e0a\u7684\u6570\u3002\n\n\u66f4\u65b0\u533a\u95f4\u548c\uff1a\u628a\u533a\u95f4\u91cc\u7684\u6700\u5927\u503c\u4e2a\u6570\u4e58\u4e0a $l1$\uff0c\u5176\u5b83\u6570\u7684\u4e2a\u6570\u4e58\u4e0a $l3$\uff0c\u5b83\u4eec\u7684\u548c\u5c31\u662f\u533a\u95f4\u548c\u65b0\u589e\u7684\u90e8\u5206\u3002\n\n\u66f4\u65b0\u533a\u95f4\u6b21\u5927\u503c\uff1a\u5982\u679c\u533a\u95f4\u4e0d\u540c\u503c\u4e2a\u6570\u5e76\u975e\u4e00\uff0c\u90a3\u4e48\u52a0\u4e0a $l3$\uff08\u5982\u679c\u4e0d\u540c\u503c\u4e2a\u6570\u4e3a\u4e00\uff0c\u5219\u4e0d\u5b58\u5728\u6b21\u5927\u503c\uff0c\u5373\u6b21\u5927\u503c\u4e3a $\\text{-INF}$\uff09\u3002\n\n\u63a5\u4e0b\u6765\u662f $4$ \u4e2a\u61d2\u6807\u8bb0\u7684\u66f4\u65b0\uff0c**\u6ce8\u610f\u66f4\u65b0\u7684\u987a\u5e8f\uff01**\n\n\u5176\u4f59\u53d8\u91cf\u548c\u4ee3\u7801\u4e00\u8d77\u7406\u89e3\uff0c\u4e5f\u5c31\u4e0d\u662f\u90a3\u4e48\u96be\u4e86\u3002\n\n```cpp\nvoid update(int p, int l1, int l2, int l3, int l4)\n{\n\tsum(p) += (l1 * cnt(p) + l3 * (rson(p) - lson(p) + 1 - cnt(p)));\n\tmaxhis(p) = max(maxhis(p), max1(p) + l2);\n\tmax1(p) += l1;\n\tif(max2(p) != -INF) max2(p) += l3;\n\tlzy2(p) = max(lzy2(p), lzy1(p) + l2), lzy1(p) += l1;\n\tlzy4(p) = max(lzy4(p), lzy3(p) + l4), lzy3(p) += l3;\n}\n```\n\n\u4e0b\u9762\u8be5\u8bb2 `pushdown()` \u4e86\uff1a\n\n\u5bf9\u4e8e\u8fd9\u9898\u7684 `pushdown()`\uff0c\u6211\u4eec\u9700\u8981\u5206\u4e24\u79cd\u60c5\u51b5\u8ba8\u8bba\u3002\n\n\u4f17\u6240\u5468\u77e5\uff0c\u4e00\u4e2a\u533a\u95f4\u53ef\u4ee5\u62c6\u6210\u4e24\u4e2a\u5b50\u533a\u95f4\uff08\u5de6\u53f3\u513f\u5b50\uff09\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u5b50\u533a\u95f4\uff0c\u5982\u679c\u5176\u5305\u542b\u7684\u6700\u5927\u5143\u7d20\u6bd4\u53e6\u4e00\u5b50\u533a\u95f4\u5305\u542b\u7684\u6700\u5927\u5143\u7d20\u5927\uff0c\u90a3\u4e48\u7236\u533a\u95f4\u8981\u4ee5\u66f4\u65b0\u6700\u5927\u503c\u7684\u793c\u4eea\u6765\u63a5\u5f85\u5b83\uff0c\u5426\u5219\u5c31\u6309\u7167\u66f4\u65b0\u975e\u6700\u5927\u503c\u7684\u793c\u4eea\u6765\u63a5\u5f85\u5b83\u3002\n\n\u8be6\u89c1\u4ee3\u7801\uff0c\u6ce8\u610f\u61d2\u6807\u8bb0\u7528\u8fc7\u4e4b\u540e\u8981\u6e05\u96f6\u3002\n\n```cpp\nvoid pushdown(int p)\n{\n\tint maxn = max(max1(p << 1), max1(p << 1 | 1));\n\tif(max1(p << 1) == maxn) update(p << 1, lzy1(p), lzy2(p), lzy3(p), lzy4(p));\n\telse update(p << 1, lzy3(p), lzy4(p), lzy3(p), lzy4(p));\n\tif(max1(p << 1 | 1) == maxn) update(p << 1 | 1, lzy1(p), lzy2(p), lzy3(p), lzy4(p));\n\telse update(p << 1 | 1, lzy3(p), lzy4(p), lzy3(p), lzy4(p));\n\ttree[p].clear();\n}\n```\n\n\u5751\u70b9\uff1a$maxn$ \u8981\u5728\u51fd\u6570\u6700\u5f00\u59cb\u8bb0\u5f55\uff01**\u4e0d\u80fd\u6bcf\u6b21\u5728\u5224\u65ad\u65f6\u6bd4\u8f83\u4e24\u4e2a\u5b50\u533a\u95f4\u5305\u542b\u7684\u6700\u5927\u5143\u7d20\u5927\u5c0f\uff01** \u6211\u56e0\u4e3a\u8fd9\u4e2a\uff0c\u4e00\u76f4 Unaccepted \u4e86\u4e00\u4e2a\u6708\uff0c\u82b1\u4e86\u4e24\u4e2a\u665a\u4e0a\u53bb\u98df\u5802\u5403\u996d\u7684\u65f6\u95f4\uff0c\u8fd8\u56e0\u6b64\u7626\u4e86 $2$ \u65a4 /kk\n\n#### \u64cd\u4f5c $1$\n\n\u6b63\u5e38 `modify()` \u64cd\u4f5c\uff0c\u5982\u679c\u533a\u95f4\u5728\u5f85\u66f4\u65b0\u7684\u8303\u56f4\u5185\uff0c\u90a3\u4e48\u628a\u6240\u6709\u6570\u90fd\u52a0\u4e0a $k$ \uff0c\u5373 `update(p, k, k, k, k)`\u3002\n\n```cpp\nvoid modify1(int p)\n{\n\tif(l(p) > y || r(p) < x) return;\n\tif(l(p) >= x && r(p) <= y) { update(p, k, k, k, k); return; }\n\tpushdown(p), modify1(p << 1), modify1(p << 1 | 1), pushup(p);\n}\n```\n\n#### \u64cd\u4f5c $2$\n\n\u5728\u64cd\u4f5c $1$ \u7684\u57fa\u7840\u4e0a\u6709\u4e00\u4e9b\u4fee\u6539\u3002\n\n\u5982\u679c\u533a\u95f4\u6700\u5927\u503c\u90fd\u6bd4 $k$ \u5c0f\uff0c\u90a3\u4e48\u65e0\u9700\u66f4\u65b0\uff0c\u76f4\u63a5 `return`\u3002\n\n\u5982\u679c\u5408\u6cd5\uff0c\u8fd8\u8981\u8fdb\u4e00\u6b65\u5206\u7c7b\u8ba8\u8bba\uff1a\n\n+ \u5982\u679c $max2 \\le k \\le max1$\uff0c\u5219\u53ea\u9700\u8981\u66f4\u65b0 $max1$\uff0c\u628a `update()` \u4e2d\u7684 $l1$ \u548c $l2$ \u90fd\u8bbe\u7f6e\u4e3a $k - max1(p)$\uff08\u56e0\u4e3a `update()` \u662f\u52a0\u6cd5\u64cd\u4f5c\uff0c\u6240\u4ee5\u52a0\u4e0a\u76f8\u53cd\u6570\u7b49\u4e8e\u51cf\u53bb\u8be5\u6570\uff0c\u6700\u7ec8\u5c31\u80fd\u8fbe\u5230\u66f4\u65b0\u4e3a $k$ \u7684\u6548\u679c\u4e86\uff09\u3002\n\n+ \u5426\u5219\uff0c\u8fd8\u9700\u8981\u5411\u4e0b\u63a8\u8fdb\uff0c\u76f4\u5230\u7b26\u5408\u4e0a\u9762\u7684\u90a3\u79cd\u60c5\u51b5\u624d\u505c\u6b62\u3002\n\n```cpp\nvoid modify2(int p)\n{\n\tif(l(p) > y || r(p) < x || max1(p) <= k) return;\n\tif(l(p) >= x && r(p) <= y && max2(p) < k) { update(p, k - max1(p), k - max1(p), 0, 0); return; }\n\tpushdown(p), modify2(p << 1), modify2(p << 1 | 1), pushup(p);\n}\n```\n\n#### \u8be2\u95ee\u64cd\u4f5c\n\n\u5f88\u5e38\u89c4\uff0c\u5c31\u4e0d\u653e\u4ee3\u7801\u4e86\u3002\n\n\u8fd9\u91cc\u8bf4\u51e0\u4e2a\u5176\u4e2d\u7684\u5751\u70b9\uff1a\n\n+ \u6c42\u6700\u5927\u503c\u65f6\u5224\u65ad\u975e\u6cd5\u60c5\u51b5\u4e00\u5b9a\u8981\u8fd4\u56de\u6781\u5c0f\u503c\uff01\n+ \u6c42\u548c\u64cd\u4f5c\u7684\u975e\u6cd5\u60c5\u51b5\u8fd4\u56de $0$\u3002\n\n### \u540e\u8bb0\n\n\u8fd9\u9898\u8981\u7528 `long long`\uff0c\u7ed9\u51fa\u7b80\u5355\u8bc1\u660e\uff1a\n\n\u56e0\u4e3a $1 \\le n,m \\le 5 \\times 10^5$\uff0c$-5 \\times 10^8 \\le A_i \\le 5 \\times 10^8$\uff0c\u6240\u4ee5\u5982\u679c\u64cd\u4f5c $3$ \u4e2d\u7684 $l=1,r=n$\uff0c\u90a3\u4e48\u7ed3\u679c\u7684\u53d6\u503c\u8303\u56f4\u662f $-2.5 \\times 10^{14} \\le ans \\le 2.5 \\times 10 ^ {14}$\uff0c\u663e\u7136\u9700\u8981\u7528\u5230\u957f\u6574\u578b\u3002\n\n\u4f46\u662f\u7ec6\u5fc3\u7684\u8bfb\u8005\u53ef\u80fd\u4f1a\u770b\u51fa\u6211\u7684\u6240\u6709\u4ee3\u7801\u90fd\u53ea\u6709 `int` \u7684\u8eab\u5f71\uff0c\u8fd9\u662f\u56e0\u4e3a\u6211\u592a\u61d2\uff0c\u76f4\u63a5 `#define int long long` \u4e86\u3002\u5927\u5bb6\u5199\u4ee3\u7801\u53ef\u4e0d\u8981\u88ab\u8ff7\u60d1\u4e86\u54e6\uff01\n\n---\n\n\u5176\u5b9e\uff0c\u8fd9\u7bc7\u6587\u7ae0\u53ef\u80fd\u4e0d\u4f1a\u5728\u8fd9\u4e2a\u65f6\u95f4\u51fa\u73b0\u2026\u2026\n\n\u4e00\u4e2a\u6708\u91cc\uff0cMini \u7684 P6242 \u4ee3\u7801\u4e00\u76f4\u5361\u5728 $40$ \u5206\u3002\u76f4\u5230\u6709\u4e00\u5929\uff0c\u4ed6\u95f2\u6765\u65e0\u4e8b\uff0c\u6765\u5230\u4e86\u5feb\u8981\u653e\u5f03\u7684\u8fd9\u9898\uff0c\u70b9\u5f00\u4e86\u63d0\u4ea4\u8bb0\u5f55\u3002\n\n\u5ffd\u7136\uff0c\u4ed6\u770b\u5230\u4e86\u6328\u7684\u5f88\u8fd1\u7684\u4e24\u6761\u63d0\u4ea4\u8bb0\u5f55\uff0c\u4f5c\u8005\u662f\u540c\u4e00\u4e2a\u4eba\uff0c\u4e00\u6b21\u662f $40$ \u5206\uff0c\u53e6\u4e00\u6b21\u662f $100$ \u5206\u3002\n\n\u4ed6\u6709\u4e9b\u597d\u5947\uff0c\u70b9\u5f00\u4e86 $40$ \u5206\u7684\u90a3\u6761\u63d0\u4ea4\u8bb0\u5f55\uff0c\u628a\u5149\u6807\u653e\u5728\u4e86 WA \u7684 $6$ \u4e2a\u6d4b\u8bd5\u70b9\u4e0a\u3002\u5ffd\u7136\uff0c\u4ed6\u60ca\u559c\u5730\u53d1\u73b0\uff0c\u8fd9\u4e2a\u63d0\u4ea4\u8bb0\u5f55\u6bcf\u4e2a\u6d4b\u8bd5\u70b9\u9996\u6b21\u9519\u8bef\u7684\u7684\u4f4d\u7f6e\u90fd\u548c\u4ed6\u7684\u5e9f\u5f03\u4ee3\u7801\u4e00\u6a21\u4e00\u6837\u3002\n\n\u4e8e\u662f\uff0c\u4ed6\u8fde\u5fd9\u7ed9\u8fd9\u4e24\u4efd\u63d0\u4ea4\u8bb0\u5f55\u7684\u4f5c\u8005\u53d1\u4e86\u79c1\u4fe1\uff0c\u95ee\u4e86\u4ed6\u8fd9\u9053\u9898\u5e94\u8be5\u600e\u4e48\u4fee\u6539\u3002\u5f88\u5feb\uff0c\u5bf9\u65b9\u5c31\u7ed9\u51fa\u4e86\u56de\u590d\uff1a\n\n> \u60a8\u7684 `pushdown()` \u51fd\u6570\u6709\u95ee\u9898\u3002\n\n\u5e76\u4e00\u9488\u89c1\u8840\u7684\u6307\u51fa\u4e86\u95ee\u9898\u6240\u5728\u3002\n\nMini \u5c06\u8fd9\u4e2a\u95ee\u9898\u6539\u5b8c\u4e4b\u540e\uff0c\u9a6c\u4e0a AC \u4e86\uff01\n\n\u5728\u6b64\uff0c\u6211\u7531\u8877\u611f\u8c22\u8fd9\u4f4d\u4e50\u4e8e\u52a9\u4eba\u7684\u5927\u4f6c @[zhimao](https://www.luogu.com.cn/user/112921) \uff01\n\n---\n\n\u5e0c\u671b\u6211\u7684\u6587\u7ae0\u80fd\u591f\u5e2e\u5230\u5927\u5bb6\uff01\n\n\u5982\u679c\u60a8\u89c9\u5f97\u8fd9\u7bc7\u6587\u7ae0\u5bf9\u60a8\u6709\u5e2e\u52a9\uff0c\u53ef\u4ee5\u7ed9\u4e2a\u8d5e\u561b qwq",
        "postTime": 1628587077,
        "uid": 476150,
        "name": "Mysterious_Mini",
        "ccfLevel": 0,
        "title": "\u3010\u5b66\u4e60\u7b14\u8bb0\u3011\u5409\u53f8\u673a\u7ebf\u6bb5\u6811"
    },
    {
        "content": "\u76f8\u4fe1\u4e0d\u5c11\u521d\u5b66\u8005\u5bf9\u4e8e \u533a\u95f4\u53d6 max/min \u63a5\u53d7\u5c1a\u53ef\uff0c\u800c\u5bf9\u4e8e \u533a\u95f4\u5386\u53f2\u6700\u503c \u4e00\u8138\u61f5\u903c\u3002\n> \u5982\u679c\u6211\u4eec\u4e0d\u6ee1\u8db3\u4e8e\u8ba4\u8bc6\u73b0\u6709\u7684\u7ed3\u679c\uff0c\u5c31\u8981\u53d1\u6398\u51fa\u95ee\u9898\u80cc\u540e\u7684\u8109\u7edc\uff0c  \n> \u8ba4\u8bc6\u5230\u770b\u8d77\u6765\u201c\u795e\u673a\u5999\u7b97\u201d\u7684\u8bc1\u660e\uff0c\u62c6\u6389\u4e4b\u524d\u7684**\u811a\u624b\u67b6**\u957f\u4ec0\u4e48\u6837\u3002\n> > Carl Friedrich Gauss: \u201c\u51e1\u662f\u6709\u81ea\u5c0a\u5fc3\u7684\u5efa\u7b51\u5e08\uff0c\u5728\u7470\u4e3d\u7684\u5927\u53a6\u5efa\u6210\u4e4b\u540e\uff0c\u51b3\u4e0d\u4f1a\u628a\u811a\u624b\u67b6\u7559\u5728\u90a3\u91cc\u3002\u201d  \n> \n> \uff08\u6458\u81ea EI's blog\uff09\n\n\u672c\u6587\u5c06\u6307\u51fa\uff0c\u770b\u4f3c\u795e\u673a\u5999\u7b97\u7684\u533a\u95f4\u5386\u53f2\u6700\u503c\uff0c\u5176\u5b9e\u662f\u4e2a\u7b80\u5355\u7684**\u7ebf\u6027\u4ee3\u6570**\u95ee\u9898\u3002\n\n-----------------------------\n\u9996\u5148\u6211\u4eec\u8981\u660e\u6670\u7ebf\u6bb5\u6811\u4e3a\u4ec0\u4e48\u80fd\u591f\u5b9e\u73b0\u533a\u95f4\u4fe1\u606f\u7684\u5feb\u901f\u7ef4\u62a4\u3002  \n\n\u5bf9\u4e8e [\u3010\u6a21\u677f\u3011\u7ebf\u6bb5\u6811 1](https://www.luogu.com.cn/problem/P3372)\uff1a\n> \u7ed9\u5b9a\u5e8f\u5217 $a$\uff0c$m$ \u6b21\u64cd\u4f5c\uff1a\n> - $\\forall i\\in[l,r],a_i\\leftarrow a_i+k$ \u3002\n> - \u6c42 $\\displaystyle\\sum_{i=l}^r a_i$ \u3002\n\n\u901a\u8fc7\u7ebf\u6bb5\u6811\u4e0a\u6bcf\u4e2a\u70b9\u5b58\u50a8 **\u6240\u8f96\u533a\u95f4\u7684 $a_i$ \u4e4b\u548c**\uff0c\u5373\u53ef\u5b9e\u73b0\u5feb\u901f\u67e5\u8be2\u3002  \n\n\u60f3\u4e00\u60f3\u4e3a\u4ec0\u4e48\u8fd9\u4e48\u505a\u662f\u5bf9\u7684\uff0c\u6613\u53d1\u73b0\u539f\u56e0\u662f **\u52a0\u6cd5\u6ee1\u8db3\u7ed3\u5408\u5f8b**\uff1a\n\n$$a_l+a_{l+1}+\\cdots+a_{mid}+a_{mid+1}+a_{mid+2}+\\cdots+a_r$$\n$$=(a_l+a_{l+1}+\\cdots+a_{mid})+(a_{mid+1}+a_{mid+2}+\\cdots+a_r)$$\n\n\u63a5\u4e0b\u6765\uff0c\u901a\u8fc7\u5728\u7ebf\u6bb5\u6811\u4e0a\u6253 **\u61d2\u6807\u8bb0** \uff0c\u5373\u53ef\u5b9e\u73b0\u5feb\u901f\u4fee\u6539\u3002\n\n\u540c\u6837\u7684\uff0c\u5176\u539f\u56e0\u662f **\u52a0\u6cd5\u6ee1\u8db3\u7ed3\u5408\u5f8b\u548c\u4ea4\u6362\u5f8b**\uff1a\n\n$$(a_i+k)+l=a_i+(k+l)$$\n\n$$(a_l+k)+(a_{l+1}+k)+\\cdots+(a_r+k)=(a_l+a_{l+1}+\\cdots+a_r)+(r-l+1)k$$\n\n\u5728\u6b64\u57fa\u7840\u4e0a\uff0c\u5bf9\u4e8e[\u3010\u6a21\u677f\u3011\u7ebf\u6bb5\u6811 2](https://www.luogu.com.cn/problem/P3372)\uff0c\u5206\u522b\u7ef4\u62a4\u52a0\u6cd5\u548c\u4e58\u6cd5\u6807\u8bb0\uff0c  \n\u91c7\u53d6 **\u5148\u4e58\u540e\u52a0** \u7684\u63a8\u6807\u8bb0\u65b9\u6cd5\uff0c\u5373\u53ef\u5b9e\u73b0\u5feb\u901f\u4fee\u6539\u3002  \n\u5176\u539f\u56e0\u662f **\u4e58\u6cd5\u6ee1\u8db3\u7ed3\u5408\u5f8b**\uff0c\u4e14**\u5bf9\u52a0\u6cd5\u6ee1\u8db3\u5206\u914d\u5f8b**\uff1a\n$$(a_i\\times k)\\times l=a_i\\times(k\\times l)$$\n$$a_l\\times k+a_{l+1}\\times k+\\cdots+a_r\\times k=(a_l+a_{l+1}+\\cdots+a_r)\\times k$$\n\n--------------------------------\n\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u770b\u770b\u6700\u57fa\u7840\u7684\u533a\u95f4\u5386\u53f2\u6700\u503c\u95ee\u9898\u3002\n\n> \u7ed9\u5b9a\u5e8f\u5217 $a,b$\uff0c\u521d\u59cb $a=b$\uff0c$m$ \u6b21\u64cd\u4f5c\uff1a\n> - $\\forall i\\in[l,r],a_i\\leftarrow a_i+k$ \u3002\n> - \u6c42 $\\displaystyle\\max_{i=l}^ra_i$ \u3002\n> - \u6c42 $\\displaystyle\\max_{i=l}^rb_i$ \u3002\n>   \n> \u6bcf\u6b21\u64cd\u4f5c\u540e\uff0c\u6211\u4eec\u90fd\u8fdb\u884c\u4e00\u6b21\u66f4\u65b0\uff0c\u8ba9 $b_i\\leftarrow \\max(b_i,a_i)$\u3002\n\n\u8fd9\u91cc\uff0c\u6211\u4eec\u53ea\u8981\u7ef4\u62a4 $+,\\max$ \u4e24\u79cd\u8fd0\u7b97\uff0c\u5b83\u4eec\u6ee1\u8db3\n\n- \u4ea4\u6362\u5f8b\uff1a$a+b=b+a,\\max(a,b)=\\max(b,a)$ \u3002\n- \u7ed3\u5408\u5f8b\uff1a$(a+b)+c=a+(b+c),\\max(\\max(a,b),c)=\\max(a,\\max(b,c))$ \u3002\n- \u5355\u4f4d\u5143\uff1a$a+0=0+a=a,\\max(a,-\\infty)=\\max(-\\infty,a)=a$ \u3002\n- \u52a0\u6cd5\u9006\u5143\uff08\u76f8\u53cd\u6570\uff09\uff1a$a+(-a)=(-a)+a=0$ \u3002\n- \u5206\u914d\u5f8b\uff1a$a+\\max(b,c)=\\max(a+b,a+c),\\max(a,b)+c=\\max(a+c,b+c)$ \u3002\n\n\u8fd9\u65f6\uff0c\u6211\u4eec\u53d1\u73b0\uff0c\u5982\u679c\u5c06 $\\max$ \u4f5c\u4e3a\u77e9\u9635\u5143\u7d20\u7684\u52a0\u6cd5\uff0c  \n$+$ \u4f5c\u4e3a\u77e9\u9635\u5143\u7d20\u7684\u4e58\u6cd5\uff0c\u5c31\u53ef\u7528\u77e9\u9635\u63cf\u8ff0\u4e0a\u9762\u7684\u64cd\u4f5c\uff1a\n\n> \u7ef4\u62a4\u5411\u91cf\u5e8f\u5217 $\\displaystyle\\left\\{{a_i\\brack b_i}\\right\\},m$ \u6b21\u64cd\u4f5c\uff1a\n> - $\\forall i\\in[l,r],\\displaystyle{a_i\\brack b_i}_{_{}}\\leftarrow\\begin{bmatrix}k&-\\infty\\\\ -\\infty&0\\end{bmatrix}{a_i\\brack b_i}$ \u3002\n> - \u6c42 $\\displaystyle {a_l\\brack b_l}+{a_{l+1}\\brack b_{l+1}}+\\cdots+{a_r\\brack b_r}$\uff0c$+$ \u4e3a\u5411\u91cf\u52a0\u6cd5\u3002  \n> \n> \u6bcf\u6b21\u64cd\u4f5c\u540e\uff0c\u4ee4 $\\displaystyle{a_i\\brack b_i}\\leftarrow\\begin{bmatrix}0&-\\infty\\\\ 0&0\\end{bmatrix}{a_i\\brack b_i}$ \u3002\n\n\n\u6839\u636e\u77e9\u9635\u7684\u8fd0\u7b97\u5f8b\uff0c\u76f8\u4fe1\u5927\u5bb6\u5df2\u7ecf\u53d1\u73b0\u4e86\u7ef4\u62a4\u7684\u65b9\u6cd5\uff1a  \n\u7ef4\u62a4 \u5411\u91cf\u4e4b\u548c \u4e0e \u77e9\u9635\u4e58\u6cd5\u6807\u8bb0 \u5373\u53ef\u3002\n\n\u4f46 \u77e9\u9635\u4e58\u6cd5\u6807\u8bb0 \u8fd8\u53ef\u4ee5\u518d\u7b80\u5316\uff0c\u56e0\u4e3a\n\n$$\\begin{bmatrix}a&-\\infty\\\\b&0\\end{bmatrix}+\\begin{bmatrix}c&-\\infty\\\\d&0\\end{bmatrix}=\\begin{bmatrix}\\max(a,c)&-\\infty\\\\\\max(b,d)&0\\end{bmatrix}$$\n\n$$\\begin{bmatrix}a&-\\infty\\\\b&0\\end{bmatrix}\\begin{bmatrix}c&-\\infty\\\\d&0\\end{bmatrix}=\\begin{bmatrix}a+c&-\\infty\\\\\\max(b+c,d)&0\\end{bmatrix}$$\n\n\u4e8e\u662f\u5bf9\u4e8e $\\begin{bmatrix}c&-\\infty\\\\d&0\\end{bmatrix}$ \u53ea\u8981\u7ef4\u62a4 $\\displaystyle{c\\brack d}$ \u5373\u53ef\u3002\n\n\u4e8b\u5b9e\u4e0a\uff0c$c,d$ \u5373\u5bf9\u5e94\u8bba\u6587\u4e2d\u7684 \u201c\u52a0\u51cf\u6807\u8bb0\u201d \u548c \u201c\u5386\u53f2\u6700\u5927\u52a0\u51cf\u6807\u8bb0\u201d\u3002\n\n----------------------------\n\u56de\u5230\u672c\u9898\uff0c\u672c\u9898\u5728\u4e0a\u9762\u7684\u57fa\u7840\u4e0a\u8fd8\u652f\u6301\u533a\u95f4\u53d6 $\\min$ \u548c\u533a\u95f4\u6c42\u548c\uff0c\u5373\n\n> - $\\forall i\\in[l,r],a_i\\leftarrow \\min(a_i,k)$ \u3002\n> - \u6c42 $\\displaystyle\\sum_{i=l}^r a_i$ \u3002\n\n\u56de\u60f3\u4e0b\u4e0d\u7ef4\u62a4\u533a\u95f4\u5386\u53f2\u6700\u503c\u65f6\u662f\u600e\u6837\u7ef4\u62a4\u533a\u95f4\u53d6 min \u7684\u3002\u5b9e\u9645\u4e0a\uff0c\u6211\u4eec\u662f\u901a\u8fc7\u644a\u8fd8\u5206\u6790\uff0c  \n\u5212\u5206\u6700\u5927\u503c\u4e0e\u6b21\u5927\u503c\uff0c\u5c06\u533a\u95f4\u53d6 min \u8f6c\u5316\u4e3a **\u5bf9\u6700\u5927\u503c\u7684\u533a\u95f4\u52a0\u51cf** \u6765\u7ef4\u62a4\u7684\u3002\n\n\u5bf9\u4e8e\u672c\u9898\uff0c\u6cbf\u7528\u8fd9\u4e00\u601d\u8def\u3002  \n\u6211\u4eec\u5c06 $\\displaystyle{a_i\\brack b_i}$ \u6309\u7167 $a_i$ \u7684\u5927\u5c0f\u5212\u5206 \u3002\u5177\u4f53\u5730\uff0c\u6bcf\u4e2a\u8282\u70b9\u7ef4\u62a4\u5982\u4e0b\u4fe1\u606f\uff1a\n\n- $\\overrightarrow{mx}$\uff1a$a_i$ \u6700\u5927\u7684 $\\displaystyle{a_i\\brack b_i}_{}$ \u4e4b\u548c\u3002\n- $\\overrightarrow{se}$\uff1a$a_i$ \u975e\u6700\u5927\u7684 $\\displaystyle{a_i\\brack b_i}$ \u4e4b\u548c\u3002\n- \u77e9\u9635 $M$\uff1a\u5bf9 $\\overrightarrow{mx}$ \u7684\u77e9\u9635\u4e58\u6cd5\u6807\u8bb0\u3002\n- \u77e9\u9635 $E$\uff1a\u5bf9 $\\overrightarrow{se}$ \u7684\u77e9\u9635\u4e58\u6cd5\u6807\u8bb0\u3002\n\n\u7ebf\u6bb5\u6811\u7ef4\u62a4\u5373\u53ef\u3002\n\n\u7279\u522b\u5730\uff0c\u5c3d\u7ba1\u533a\u95f4\u6c42\u548c\u4e0d\u80fd\u7528\u77e9\u9635\u6765\u8868\u793a\uff0c  \n\u4f46\u4e5f\u662f\u53ef\u4ee5\u96c6\u6210\u5230\u8fd9\u68f5\u7ebf\u6bb5\u6811\u4e0a\u7684\uff0c\u8fd9\u91cc\u7559\u7ed9\u8bfb\u8005\u4f5c\u4e3a\u601d\u8003\u9898\u3002\n\n---------------------------\n\u4ee4\u6211\u5403\u60ca\u7684\u662f\uff0c\u5728\u6b64\u4e4b\u524d\u5e76\u6ca1\u6709\u4e00\u7bc7\u9898\u89e3\u662f\u57fa\u4e8e\u77e9\u9635\u6765\u7406\u89e3\u5409\u8001\u5e08\u7ebf\u6bb5\u6811\u7684\uff0c  \n\u663e\u7136\u77e9\u9635\u8ba9\u5404\u4e2a\u64cd\u4f5c\u7684\u7ec4\u7ec7\u53d8\u5f97\u5bb9\u6613\u4e86\u8bb8\u591a\u3002\n\n\u5e0c\u671b\u8fd9\u7bc7\u9898\u89e3\u80fd\u8ba9\u521d\u5b66\u8005\u4e0d\u88ab\u7e41\u6742\u7684\u6807\u8bb0\u529d\u9000\uff0c\u5c11\u8d70\u5f2f\u8def\uff0c\u66f4\u6df1\u5165\u5730\u7406\u89e3\u8fd9\u4e2a\u6570\u636e\u7ed3\u6784\u3002\n\n```cpp\n/*\nthis code is made by wangrx\n2022.2.14 21:25\n*/\n#include<stdio.h>\n#include<string.h>\ntypedef long long ll;\ntypedef unsigned int word;\nstruct READ{//\u5feb\u8bfb\n\tchar pool[5<<22],*top,w;\n\tinline READ(){fread(top=pool,5<<22,1,stdin);}\n\ttemplate<typename type>\n\tinline READ& operator >>(type& num){\n\t\tfor(w=1;'0'>*top||*top>'9';)\n\t\t\tw=*(top++)=='-'? -1:1;\n\t\tfor(num=0;'0'<=*top&&*top<='9';)\n\t\t\tnum=num*10+(*(top++)-'0');\n\t\treturn num*=w,*this;\n\t}\n}cin;\nconst int inf=0x80000000;//\u2212\u221e\ninline int max(const int a,const int b){\n\treturn a>b? a:b;}\n/* \u5411\u91cf/\u77e9\u9635\n\u23a1a\u23a4   \u23a1a \u2212\u221e\u23a4\n\u23a3b\u23a6   \u23a3b  0\u23a6\n*/\nstruct matrix{\n\tint a,b;\n\tinline matrix(){}\n\tinline matrix(const matrix &p)=default;\n\tinline matrix(int A,int B):a(A),b(B){}\n\tinline matrix operator+(const matrix &p)const{//\u77e9\u9635/\u5411\u91cf \u52a0\u6cd5\n\t\treturn matrix(max(a,p.a),max(b,p.b));}\n\tinline matrix operator()(const matrix &p)const{//\u77e9\u9635\u4e58\u6cd5\n\t\treturn matrix(a==inf||p.a==inf? inf:a+p.a,\n\t\t\tb==inf||p.a==inf? p.b:max(b+p.a,p.b));}\n\tinline bool operator!=(const matrix &p)const{\n\t\treturn a!=p.a||b!=p.b;}\n}const I(0,inf),vec0(inf,inf);\nword n,m;\nstruct segment_tree{//\u7ebf\u6bb5\u6811\uff08zkw\uff09\n\tll sum[1u<<20];\n\tint cnt[1u<<20];\n\tmatrix mx[1u<<20],M[1u<<20];\n\tmatrix se[1u<<20],E[1u<<20];\n\tinline segment_tree(){\n\t\tfor(word i=0;i<(1u<<20);++i) M[i]=E[i]=I;\n\t\tse[1u<<19]=vec0,cnt[1u<<19]=1,cin>>n>>m;\n\t\tfor(int i=(1u<<19)+1,num;i<=(1u<<19|n);++i){\n\t\t\tse[i]=vec0,cnt[i]=1,cin>>num;\n\t\t\tsum[i]=mx[i].a=mx[i].b=num;\n\t\t}\n\t\tfor(word i=(1u<<19|n)+1;i<(1u<<20);++i)\n\t\t\tse[i]=vec0,cnt[i]=1;\n\t\tfor(word i=(1u<<19)-1;i;--i) pushup(i);\n\t}\n\t#define l (rt<<1)\n\t#define r (rt<<1|1)\n\tinline void pushup(const word rt){//\u4e0a\u4f20\u4fe1\u606f\n\t\tsum[rt]=sum[l]+sum[r];\n\t\tif(mx[l].a>mx[r].a){\n\t\t\tmx[rt]=mx[l],cnt[rt]=cnt[l];\n\t\t\tse[rt]=se[l]+se[r]+mx[r];\n\t\t}else if(mx[l].a<mx[r].a){\n\t\t\tmx[rt]=mx[r],cnt[rt]=cnt[r];\n\t\t\tse[rt]=se[l]+se[r]+mx[l];\n\t\t}else{\n\t\t\tmx[rt]=mx[l]+mx[r];\n\t\t\tcnt[rt]=cnt[l]+cnt[r];\n\t\t\tse[rt]=se[l]+se[r];\n\t\t}\n\t}\n\tinline void Mmul(const matrix &p,const word id){//\u4fee\u6539 mx\n\t\tmx[id]=p(mx[id]),M[id]=p(M[id]),sum[id]+=1ll*cnt[id]*p.a;}\n\tinline void Emul(const matrix &p,const word id,const word size){//\u4fee\u6539 se\n\t\tse[id]=p(se[id]),E[id]=p(E[id]);\n\t\tsum[id]+=1ll*(size-cnt[id])*p.a;\n\t}\n\tinline void pushdown(const word rt,const word size){//\u4e0b\u4f20\u6807\u8bb0\n\t\tMmul(mx[l].a==mx[rt].a-M[rt].a? M[rt]:E[rt],l);\n\t\tMmul(mx[r].a==mx[rt].a-M[rt].a? M[rt]:E[rt],r);\n\t\t//\u6ce8\u610f\u6b64\u5904\u4e0d\u80fd\u7528 mx[l].a \u548c mx[r].a \u7684\u5927\u5c0f\u5173\u7cfb\u6765\u5224\u65ad\u5212\u5206\uff0c\u56e0\u4e3a\u6807\u8bb0\u4e0b\u4f20\u540e mx \u4f1a\u88ab\u4fee\u6539\n\t\tif(size!=1) Emul(E[rt],l,size),Emul(E[rt],r,size);\n\t\tM[rt]=E[rt]=I;\n\t}\n\tinline void plus(const word f,const word t,const int k,\n\t\tconst word rt=1,const word size=1u<<18){//\u533a\u95f4\u52a0\n\t\tif(size==0||(f==0&&t==(size<<1)-1))\n\t\t\treturn Mmul(matrix(k,k),rt),Emul(matrix(k,k),rt,size? size<<1:1);\n\t\tauto lf=[&](word f,word t){plus(f,t,k,l,size>>1);};\n\t\tauto rf=[&](word f,word t){plus(f,t,k,r,size>>1);};\n\t\tpushdown(rt,size);\n\t\tif(f&size) rf(f&~size,t&~size);\n\t\telse if((t&size)^size) lf(f,t);\n\t\telse lf(f,size-1),rf(0,t&~size);\n\t\tpushup(rt);\n\t}\n\tinline void min(const word f,const word t,const int k,\n\t\tconst word rt=1,const word size=1u<<18){//\u533a\u95f4\u53d6 min\n\t\tif(k>=mx[rt].a) return;\n\t\tconst auto lf=[&](word f,word t){min(f,t,k,l,size>>1);};\n\t\tconst auto rf=[&](word f,word t){min(f,t,k,r,size>>1);};\n\t\tif(size==0||(f==0&&t==(size<<1)-1)){\n\t\t\tif(k>se[rt].a) return Mmul(matrix(k-mx[rt].a,k-mx[rt].a),rt);\n\t\t\treturn pushdown(rt,size),lf(0,size-1),rf(0,size-1),pushup(rt);\n\t\t}\n\t\tpushdown(rt,size);\n\t\tif(f&size) rf(f&~size,t&~size);\n\t\telse if((t&size)^size) lf(f,t);\n\t\telse lf(f,size-1),rf(0,t&~size);\n\t\tpushup(rt);\n\t}\n\tinline ll getsum(const word f,const word t,\n\t\tconst word rt=1,const word size=1u<<18){//\u533a\u95f4\u6c42\u548c\n\t\tif(size==0||(f==0&&t==(size<<1)-1)) return sum[rt];\n\t\tconst auto lf=[&](word f,word t)->ll{return getsum(f,t,l,size>>1);};\n\t\tconst auto rf=[&](word f,word t)->ll{return getsum(f,t,r,size>>1);};\n\t\tpushdown(rt,size);\n\t\tif(f&size) return rf(f&~size,t&~size);\n\t\telse if((t&size)^size) return lf(f,t);\n\t\treturn lf(f,size-1)+rf(0,t&~size);\n\t}\n\tinline int geta(const word f,const word t,\n\t\tconst word rt=1,const word size=1u<<18){//\u533a\u95f4\u6700\u503c\n\t\tif(size==0||(f==0&&t==(size<<1)-1)) return mx[rt].a;\n\t\tconst auto lf=[&](word f,word t)->ll{return geta(f,t,l,size>>1);};\n\t\tconst auto rf=[&](word f,word t)->ll{return geta(f,t,r,size>>1);};\n\t\tpushdown(rt,size);\n\t\tif(f&size) return rf(f&~size,t&~size);\n\t\telse if((t&size)^size) return lf(f,t);\n\t\treturn max(lf(f,size-1),rf(0,t&~size));\n\t}\n\tinline int getb(const word f,const word t,\n\t\tconst word rt=1,const word size=1u<<18){//\u533a\u95f4\u5386\u53f2\u6700\u503c\n\t\tif(size==0||(f==0&&t==(size<<1)-1)) return max(mx[rt].b,se[rt].b);\n\t\tconst auto lf=[&](word f,word t)->ll{return getb(f,t,l,size>>1);};\n\t\tconst auto rf=[&](word f,word t)->ll{return getb(f,t,r,size>>1);};\n\t\tpushdown(rt,size);\n\t\tif(f&size) return rf(f&~size,t&~size);\n\t\telse if((t&size)^size) return lf(f,t);\n\t\treturn max(lf(f,size-1),rf(0,t&~size));\n\t}\n\t#undef l\n\t#undef r\n}tree;\nint main(){\n\tfor(int opt,l,r;m;--m)\n\t\tif(cin>>opt>>l>>r,opt==1)\n\t\t\tcin>>opt,tree.plus(l,r,opt);\n\t\telse if(opt==2) cin>>opt,tree.min(l,r,opt);\n\t\telse if(opt==4) printf(\"%d\\n\",tree.geta(l,r));\n\t\telse if(opt==5) printf(\"%d\\n\",tree.getb(l,r));\n\t\telse printf(\"%lld\\n\",tree.getsum(l,r));\n    return 0;\n}\n```",
        "postTime": 1644758189,
        "uid": 104726,
        "name": "wangrx",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P6242 \u3010\u6a21\u677f\u3011\u7ebf\u6bb5\u6811 3"
    },
    {
        "content": "\u5409\u8001\u5e08\u7ebf\u6bb5\u6811\u6a21\u677f\u9898,\u5982\u679c\u60f3\u8981\u77e5\u9053\u66f4\u591a\u53ef\u4ee5\u53bb\u770b\u770b2016\u5e74\u7684\u56fd\u96c6\u8bba\u6587.\n\n# \u5206\u6790\n\n\u5148\u6765\u770b5\u4e2a\u64cd\u4f5c(\u7b2c\u4e00\u611f\u89c9):\n\n1.  \u533a\u95f4\u52a0,\u53ea\u8981\u7528\u61d2\u6807\u8bb0\u641e\u4e00\u4e0b\u5c31\u597d\u4e86.\n2.  \u533a\u95f4\u53d6min,\u5409\u8001\u5e08\u7ebf\u6bb5\u6811\u57fa\u672c\u64cd\u4f5c,\u8bb0\u5f55\u4e00\u4e0b\u6700\u5927\u503c,\u6700\u5927\u503c\u51fa\u73b0\u6b21\u6570,\u4e25\u683c\u6b21\u5927\u503c\u5c31\u597d\u4e86.\n3.  \u533a\u95f4\u548c,\u76f4\u63a5\u7ef4\u62a4\u5c31\u597d\u4e86.\n4.  \u533a\u95f4max,\u5df2\u7ecf\u7ef4\u62a4\u4e86.\n5.  \u533a\u95f4\u5386\u53f2max,\u7ef4\u62a4\u4e00\u4e0b\u6700\u5927\u52a0\u6807\u8bb0\u5c31\u597d\u4e86.\n\n\u7136\u540e\u60a8\u5c31\u53ef\u4ee5\u5f97\u523030\u5206\u7684\u597d\u6210\u7ee9.\n\n\u8003\u8651\u4e00\u4e0b\u8fd9\u4e2a\u505a\u6cd5\u6709\u4ec0\u4e48\u95ee\u9898.\n\n\u53ef\u4ee5\u53d1\u73b0\u95ee\u9898\u662f\u51fa\u5728\u6807\u8bb0\u5408\u5e76\u4e0a.\n\n\u53ef\u4ee5\u53d1\u73b0\u5728\u53d6min\u65f6\u6700\u5927\u7684\u6570\u7684\u52a0\u6807\u8bb0\u4f1a\u53d1\u751f\u6539\u53d8,\u90a3\u4e48\u9700\u8981\u989d\u5916\u7ef4\u62a4\u51fa\u6700\u5927\u7684\u6570\u7684\u52a0\u6807\u8bb0\u548c\u5176\u4ed6\u7684\u6570\u7684\u52a0\u6807\u8bb0(\u6700\u5927\u52a0\u6807\u8bb0).\n\n\u5728\u6807\u8bb0\u4e0b\u4f20\u65f6,\u5982\u679c\u4fee\u6539\u7684\u5b50\u6811\u7684\u6700\u5927\u503c\u662f\u4e24\u5b50\u6811\u6700\u5927\u503c\u7684\u6700\u5927\u503c\u90a3\u4e48\u5b83\u7684\u6700\u5927\u503c\u7684\u4fee\u6539\u548c\u5176\u4ed6\u503c\u7684\u4fee\u6539\u53ef\u80fd\u4e0d\u540c,\u5426\u5219\u662f\u76f8\u540c\u7684.\n\n\u5173\u4e8e\u5409\u8001\u5e08\u7ebf\u6bb5\u6811\u7684\u590d\u6742\u5ea6\u8bc1\u660e\u5efa\u8bae\u53bb\u770b\u770b\u8bba\u6587\u6216\u8005\u5176\u4ed6\u7684\u535a\u5ba2(\u6211\u592a\u83dc\u4e86).\n\n\u5177\u4f53\u8fd8\u662f\u770b\u4ee3\u7801\u5427.\n\n# \u4ee3\u7801\n\n```cpp\n#include<bits/stdc++.h>\n#define REP(i,first,last) for(int i=first;i<=last;++i)\n#define DOW(i,first,last) for(int i=first;i>=last;--i)\nusing namespace std;\nconst int MAXN=5e5+5;\nconst int MAX_NUM=5e5;\nconst long long INF=1e18;\nlong long maxll(long long a,long long b)\n{\n\tif(a>b)\n\t{\n\t\treturn a;\n\t}\n\treturn b;\n}\nint n,m;\nint arr[MAXN];\nstruct LazyTag\n{\n\tlong long max_add,add;//\u5bf9\u4e8e\u975e\u6700\u5927\u6570\u7684\u6700\u5927\u52a0\u6807\u8bb0\u548c\u5f53\u524d\u52a0\u6807\u8bb0\n\tlong long add_max_for_max,add_for_max;//\u5bf9\u4e8e\u6700\u5927\u6570\u7684\u6700\u5927\u52a0\u6807\u8bb0\u548c\u5f53\u524d\u52a0\u6807\u8bb0\n\tvoid Clean()//\u6e05\u7a7a\u6807\u8bb0\n\t{\n\t\tadd=0;\n\t\tadd_for_max=0;\n\t\tmax_add=0;\n\t\tadd_max_for_max=0;\n\t}\n}for_make;\nLazyTag MakeTagAdd(int add)//\u5bf9\u4e8e\u52a0\u64cd\u4f5c\u7684\u4fee\u6539\u4e2d\u6240\u6709\u6807\u8bb0\u90fd\u662f\u76f8\u540c\u7684\n{\n\tfor_make.Clean();\n\tfor_make.add=add;\n\tfor_make.max_add=add;\n\tfor_make.add_for_max=add;\n\tfor_make.add_max_for_max=add;\n\treturn for_make;\n}\nLazyTag MakeTagMin(int min,int now_max)//\u5bf9\u4e8e\u53d6min\u64cd\u4f5c,\u53ea\u6709\u5bf9\u6700\u5927\u503c\u6709\u4fee\u6539\n{\n\tfor_make.Clean();\n\tfor_make.add_for_max=min-now_max;\n\tfor_make.add_max_for_max=min-now_max;\n\treturn for_make;\n}\nstruct SegmentTree\n{\n\tlong long first_max,second_max;\n\tlong long max_num;\n\tlong long history_max;\n\tlong long sum;\n\tLazyTag tag;\n}sgt[MAXN*4];\n#define LSON (now<<1)\n#define RSON (now<<1|1)\n#define MIDDLE ((left+right)>>1)\n#define LEFT LSON,left,MIDDLE\n#define RIGHT RSON,MIDDLE+1,right\n#define NOW now_left,now_right\nvoid PushUp(int now)//\u5408\u5e76\u5b50\u6811\n{\n\tsgt[now].history_max=maxll(sgt[LSON].history_max,sgt[RSON].history_max);//\u5386\u53f2\u6700\u5927\u503c\u76f4\u63a5\u53d6max\n\tsgt[now].sum=sgt[LSON].sum+sgt[RSON].sum;//\u533a\u95f4\u548c\u76f4\u63a5\u76f8\u52a0\n\tif(sgt[LSON].first_max==sgt[RSON].first_max)//\u5bf9\u4e8e\u6700\u5927\u503c\u548c\u4e25\u683c\u6b21\u5927\u503c\u9700\u8981\u5206\u7c7b\u8ba8\u8bba\n\t{\n        //\u5982\u679c\u4e24\u5b50\u6811\u6700\u5927\u503c\u76f8\u540c\n\t\tsgt[now].first_max=sgt[LSON].first_max;//\u5f53\u524d\u6700\u5927\u503c\u5c31\u662f\u5b50\u6811\u6700\u5927\u503c\n\t\tsgt[now].max_num=sgt[LSON].max_num+sgt[RSON].max_num;//\u6700\u5927\u503c\u51fa\u73b0\u6b21\u6570\u662f\u5b50\u6811\u51fa\u73b0\u6b21\u6570\u4e4b\u548c\n\t\tsgt[now].second_max=maxll(sgt[LSON].second_max,sgt[RSON].second_max);//\u4e25\u683c\u6b21\u5927\u662f\u4e24\u5b50\u6811\u7684\u4e25\u683c\u6b21\u5927\u4e2d\u7684\u5927\u503c\n\t}\n\telse\n\t{\n\t\tif(sgt[LSON].first_max>sgt[RSON].first_max)//\u5982\u679c\u6700\u5927\u503c\u4e0d\u540c,\u90a3\u4e48\u5c31\u6bd4\u8f83\u6700\u5927\u503c\n\t\t{\n\t\t\tsgt[now].first_max=sgt[LSON].first_max;//\u6700\u5927\u503c\u5c31\u662f\u4e24\u5b50\u6811\u7684\u6700\u5927\u503c\n\t\t\tsgt[now].max_num=sgt[LSON].max_num;//\u51fa\u73b0\u6b21\u6570\u5c31\u662f\u5927\u7684\u6570\u7684\u51fa\u73b0\u6b21\u6570\n\t\t\tsgt[now].second_max=maxll(sgt[RSON].first_max,sgt[LSON].second_max);//\u4e25\u683c\u6b21\u5927\u503c\n\t\t}\n\t\telse\n\t\t{\n\t\t\tsgt[now].first_max=sgt[RSON].first_max;\n\t\t\tsgt[now].max_num=sgt[RSON].max_num;\n\t\t\tsgt[now].second_max=maxll(sgt[LSON].first_max,sgt[RSON].second_max);\n\t\t}\n\t}\n}\nvoid Build(int now=1,int left=1,int right=n)//\u5efa\u6811\n{\n\tsgt[now].tag.Clean();\n\tif(left==right)\n\t{\n\t\tsgt[now].first_max=\n\t\tsgt[now].history_max=\n\t\tsgt[now].sum=\n\t\tarr[left];//\u76f4\u63a5\u7b49\u4e8e\u521d\u503c\n\t\tsgt[now].second_max=-INF;//\u65e0\u4e25\u683c\u6b21\u5927\n\t\tsgt[now].max_num=1;//\u51fa\u73b0\u6b21\u6570\u4e3a1\n\t\treturn;\n\t}\n\tBuild(LEFT);\n\tBuild(RIGHT);\n\tPushUp(now);\n}\nvoid DownMax(LazyTag tag,int now,int left,int right)//\u5bf9\u4e8e\u6709\u6700\u5927\u503c\u7684\u4e0b\u4f20\u6807\u8bb0\n{\n\tsgt[now].sum+=\n\t1ll*tag.add_for_max*sgt[now].max_num\n\t+1ll*tag.add*(right-left+1-sgt[now].max_num);//\u8ba1\u7b97\u8d21\u732e\u65f6\u9700\u8981\u5206\u5f00\u8ba1\u7b97\n\tsgt[now].tag.max_add=//\u5bf9\u4e8e\u975e\u6700\u5927\u503c\u7684\u6700\u5927\u52a0\u6807\u8bb0\u7684\u4fee\u6539\n\tmaxll(\n\t\tsgt[now].tag.max_add,\n\t\tsgt[now].tag.add+tag.max_add//\u548c\u539f\u6765\u7684\u52a0\u6807\u8bb0+\u4e0b\u4f20\u7684\u6807\u8bb0\u4e2d\u7684\u6700\u5927\u52a0\u6807\u8bb0\u7684\u548c\u53d6\u5927\u503c\n\t);\n\tsgt[now].tag.add_max_for_max=//\u5bf9\u4e8e\u6700\u5927\u503c\u540c\u7406\n\tmaxll(\n\t\tsgt[now].tag.add_max_for_max,\n\t\tsgt[now].tag.add_for_max+tag.add_max_for_max\n\t);\n\tsgt[now].history_max=//\u5386\u53f2\u6700\u5927\u503c\u4e5f\u540c\u7406\n\tmaxll(\n\t\tsgt[now].history_max,\n\t\tsgt[now].first_max+tag.add_max_for_max//\u6ce8\u610f\u662f\u5bf9\u4e8e\u6700\u5927\u503c\u7684\u6700\u5927\u52a0\u6807\u8bb0\n\t);\n\tsgt[now].first_max+=tag.add_for_max;//\u52a0\u4e0a\u7684\u662f\u5bf9\u4e8e\u6700\u5927\u503c\u7684\u52a0\u6807\u8bb0\n\tif(sgt[now].second_max!=INF)//\u5982\u679c\u5b58\u5728\u4e25\u683c\u6b21\u5927\u503c\n\t{\n\t\tsgt[now].second_max+=tag.add;//\u52a0\u4e0a\u7684\u662f\u975e\u6700\u5927\u503c\u7684\u52a0\u6807\u8bb0\n\t}\n\tsgt[now].tag.add+=tag.add;//\u5bf9\u4e8e\u52a0\u6807\u8bb0\u76f4\u63a5\u4fee\u6539\u5c31\u53ef\u4ee5\n\tsgt[now].tag.add_for_max+=tag.add_for_max;\n\n}\nvoid Down(LazyTag tag,int now,int left,int right)//\u6ca1\u6709\u6700\u5927\u503c\u7684\u6807\u8bb0\u4e0b\u4f20\n{\n\ttag.add_for_max=tag.add;//\u548c\u4e0a\u9762\u7684\u533a\u522b\u53ea\u6709\u5c06\u6700\u5927\u503c\u7684\u4fee\u6539\u53d8\u4e3a\u975e\u6700\u5927\u503c\u7684\u4fee\u6539\n\ttag.add_max_for_max=tag.max_add;\n    \n\tsgt[now].sum+=\n\t1ll*tag.add_for_max*sgt[now].max_num\n\t+1ll*tag.add*(right-left+1-sgt[now].max_num);\n\tsgt[now].tag.max_add=\n\tmaxll(\n\t\tsgt[now].tag.max_add,\n\t\tsgt[now].tag.add+tag.max_add\n\t);\n\tsgt[now].tag.add_max_for_max=\n\tmaxll(\n\t\tsgt[now].tag.add_max_for_max,\n\t\tsgt[now].tag.add_for_max+tag.add_max_for_max\n\t);\n\tsgt[now].history_max=\n\tmaxll(\n\t\tsgt[now].history_max,\n\t\tsgt[now].first_max+tag.add_max_for_max\n\t);\n\tsgt[now].first_max+=tag.add_for_max;\n\tif(sgt[now].second_max!=INF)\n\t{\n\t\tsgt[now].second_max+=tag.add;\n\t}\n\tsgt[now].tag.add+=tag.add;\n\tsgt[now].tag.add_for_max+=tag.add_for_max;\n}\nvoid PushDown(int now,int left,int right)\n{\n\tint max=maxll(sgt[LSON].first_max,sgt[RSON].first_max);//\u53d6\u51famax\n\tif(max==sgt[LSON].first_max)//\u5982\u679c\u7b49\u4e8emax,\u90a3\u4e48\u5c31\u662f\u6709\u6700\u5927\u503c\u7684\u6807\u8bb0\u4e0b\u4f20,\u5426\u5219\u662f\u6ca1\u6709\u6700\u5927\u503c\u7684\u4e0b\u4f20\n\t{\n\t\tDownMax(sgt[now].tag,LEFT);\n\t}\n\telse\n\t{\n\t\tDown(sgt[now].tag,LEFT);\n\t}\n\tif(max==sgt[RSON].first_max)\n\t{\n\t\tDownMax(sgt[now].tag,RIGHT);\n\t}\n\telse\n\t{\n\t\tDown(sgt[now].tag,RIGHT);\n\t}\n\tsgt[now].tag.Clean();//\u6e05\u7a7a\u6807\u8bb0\n}\nvoid UpdataAdd(int now_left,int now_right,int add,int now=1,int left=1,int right=n)//\u533a\u95f4\u52a0\u7684\u64cd\u4f5c\n{\n\tif(now_right<left||right<now_left)\n\t{\n\t\treturn;\n\t}\n\tif(now_left<=left&&right<=now_right)//\u76f4\u63a5\u4fee\u6539\u5c31\u53ef\u4ee5\n\t{\n\t\tDown(MakeTagAdd(add),now,left,right);\n\t\treturn;\n\t}\n\tPushDown(now,left,right);\n\tUpdataAdd(NOW,add,LEFT);\n\tUpdataAdd(NOW,add,RIGHT);\n\tPushUp(now);\n}\nvoid UpdataMin(int now_left,int now_right,int min,int now=1,int left=1,int right=n)//\u533a\u95f4\u53d6min\u7684\u64cd\u4f5c\n{\n\tif(now_right<left||right<now_left||sgt[now].first_max<=min/*\u9002\u5f53\u526a\u679d*/)\n\t{\n\t\treturn;\n\t}\n\tif(now_left<=left&&right<=now_right)\n\t{\n\t\tif(sgt[now].first_max>min&&min>sgt[now].second_max)//\u5982\u679c\u5f53\u524d\u6570\u662f\u5728\u6700\u5927\u503c\u548c\u4e25\u683c\u6b21\u5927\u503c\u4e4b\u95f4\u90a3\u4e48\u5c31\u6253\u4e0a\u6807\u8bb0\u4fee\u6539\n\t\t{\n\t\t\tDownMax(MakeTagMin(min,sgt[now].first_max),now,left,right);\n\t\t\treturn;\n\t\t}//\u5426\u5219\u7ee7\u7eed\u9012\u5f52,\u5230\u53f6\u8282\u70b9\u4e00\u5b9a\u662f\u7b26\u5408\u7684\n\t}\n\tPushDown(now,left,right);\n\tUpdataMin(NOW,min,LEFT);\n\tUpdataMin(NOW,min,RIGHT);\n\tPushUp(now);\n}\nlong long QuerySum(int now_left,int now_right,int now=1,int left=1,int right=n)//\u533a\u95f4\u548c,\u548c\u666e\u901a\u7ebf\u6bb5\u6811\u76f8\u540c\n{\n\tif(now_right<left||right<now_left)\n\t{\n\t\treturn 0;\n\t}\n\tif(now_left<=left&&right<=now_right)\n\t{\n\t\treturn sgt[now].sum;\n\t}\n\tPushDown(now,left,right);\n\treturn QuerySum(NOW,LEFT)+QuerySum(NOW,RIGHT);\n}\nlong long QueryMax(int now_left,int now_right,int now=1,int left=1,int right=n)//\u533a\u95f4max\n{\n\tif(now_right<left||right<now_left)\n\t{\n\t\treturn -INF;\n\t}\n\tif(now_left<=left&&right<=now_right)\n\t{\n\t\treturn sgt[now].first_max;\n\t}\n\tPushDown(now,left,right);\n\treturn maxll(QueryMax(NOW,LEFT),QueryMax(NOW,RIGHT));\n}\nlong long QueryHistoryMax(int now_left,int now_right,int now=1,int left=1,int right=n)//\u533a\u95f4\u5386\u53f2max\n{\n\tif(now_right<left||right<now_left)\n\t{\n\t\treturn -INF;\n\t}\n\tif(now_left<=left&&right<=now_right)\n\t{\n\t\treturn sgt[now].history_max;\n\t}\n\tPushDown(now,left,right);\n\treturn maxll(QueryHistoryMax(NOW,LEFT),QueryHistoryMax(NOW,RIGHT));\n}\n#undef LSON\n#undef RSON\n#undef MIDDLE\n#undef LEFT\n#undef RIGHT\n#undef NOW\nint main()\n{\n\tscanf(\"%d%d\",&n,&m);\n\tREP(i,1,n)\n\t{\n\t\tscanf(\"%d\",&arr[i]);\n\t}\n\tBuild();//\u5efa\u6811\n\tint opt,l,r,k,v;\n\tREP(i,1,m)\n\t{\n\t\tscanf(\"%d\",&opt);\n\t\tif(opt==1)\n\t\t{\n\t\t\tscanf(\"%d%d%d\",&l,&r,&k);\n\t\t\tUpdataAdd(l,r,k);\n\t\t}\n\t\tif(opt==2)\n\t\t{\n\t\t\tscanf(\"%d%d%d\",&l,&r,&v);\n\t\t\tUpdataMin(l,r,v);\n\t\t}\n\t\tif(opt==3)\n\t\t{\n\t\t\tscanf(\"%d%d\",&l,&r);\n\t\t\tprintf(\"%lld\\n\",QuerySum(l,r));\n\t\t}\n\t\tif(opt==4)\n\t\t{\n\t\t\tscanf(\"%d%d\",&l,&r);\n\t\t\tprintf(\"%lld\\n\",QueryMax(l,r));\n\t\t}\n\t\tif(opt==5)\n\t\t{\n\t\t\tscanf(\"%d%d\",&l,&r);\n\t\t\tprintf(\"%lld\\n\",QueryHistoryMax(l,r));\n\t\t}\n\t}\n\treturn 0;\n}\n```\n\n",
        "postTime": 1586223307,
        "uid": 86625,
        "name": "Limit",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P6242 \u3010\u3010\u6a21\u677f\u3011\u7ebf\u6bb5\u6811 3\u3011"
    },
    {
        "content": "\u672c\u6587\u540c\u6b65\u53d1\u8868\u4e8e\u4e2a\u4eba\u535a\u5ba2\uff1a[link](https://www.watertomato.com/%e6%9c%89%e8%b6%a3%e7%9a%84%e7%ba%bf%e6%ae%b5%e6%a0%91%e7%bb%b4%e6%8a%a4-%e5%90%89%e8%80%81%e5%b8%88%e7%ba%bf%e6%ae%b5%e6%a0%91%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0/)\n\n\u672c\u6765\u6ca1\u6253\u7b97\u5199\u8fd9\u73a9\u610f\u513f\uff0c\u7ed3\u679c\u5b66\u4e60\u4e86\u4e4b\u540e\u89c9\u5f97\u5409\u8001\u5e08\u7ebf\u6bb5\u6811\u771f\u7684\u5f88\u6709\u610f\u601d\uff0c\u6240\u4ee5\u5c31\u51b3\u5b9a\u7b80\u5355\u5199\u4e00\u4e0b\u5b66\u4e60\u7b14\u8bb0\u3002\n\n> \u672c\u535a\u5ba2\u53c2\u8003\uff1aecho \u7684 [\u535a\u5ba2](https://www.luogu.com.cn/blog/2806wsltz/solution-p6242) \u4e0e \u4ee3\u7801\u542f\u793a\uff0cjiry_2 \u7684 [\u8bfe\u4ef6](https://pan.baidu.com/s/1o7xSSQ2)\u3002\n\n\u4f46\u662f\u4e2a\u4eba\u611f\u89c9\u8be5\u535a\u5ba2\u5bf9\u4e8e pushdown \u90e8\u5206\u8fd8\u662f\u6709\u70b9\u96be\u4ee5\u7406\u89e3\uff0c\u6240\u4ee5\u51b3\u5b9a\u7528\u81ea\u5df1\u7684\u8bed\u8a00\u5199\u4e00\u7bc7\u535a\u5ba2\u9610\u8ff0\u4e00\u4e0b\u3002\n\n## \u5409\u8001\u5e08\u7ebf\u6bb5\u6811\n\n> \u5409\u5982\u4e00(jiry_2)\u7684 PDF \u89c1\u535a\u5ba2\u4e0a\u65b9\u535a\u5ba2\u53c2\u8003\u90e8\u5206\u3002\n\n\u6a21\u677f\u9898\uff1a[Luogu6242](https://www.luogu.com.cn/problem/P6242)\u3002\n\n**\u9898\u610f**\uff1a\u5199\u4e00\u68f5\u7ebf\u6bb5\u6811\uff0c\u7ef4\u62a4\u533a\u95f4\u52a0\u3001**\u533a\u95f4\u53d6\u6700\u503c**\u3001\u533a\u95f4\u6c42\u548c\u3001\u533a\u95f4\u6700\u503c\u4e0e**\u533a\u95f4\u5386\u53f2\u6700\u503c**\u64cd\u4f5c\u3002\n\n\u5148\u4e0d\u8003\u8651\u5386\u53f2\u6700\u503c\u95ee\u9898\uff0c\u6211\u4eec\u5bb9\u6613\u53d1\u73b0\u66b4\u529b\u7ef4\u62a4\u533a\u95f4\u53d6\u6700\u503c\u64cd\u4f5c\uff08\u672c\u9898\u4e2d\u4e3a\u5c06 $A_i$ \u53d8\u6210 $\\min(A_i,v)$ \u66b4\u529b\u65b9\u6cd5\u5373\uff1a\u4e00\u76f4\u5f80\u4e0b\u641c\u76f4\u81f3\u641c\u5230 $l=r$ \u6216 $v>max$ \u4e3a\u6b62\uff0c$max$ \u4e3a\u533a\u95f4\u6700\u5927\u503c\uff09\u7684\u590d\u6742\u5ea6\u662f $O(n^2)$ \uff0c\u4e0d\u53ef\u63a5\u53d7\u3002\u6211\u4eec\u8003\u8651\u5982\u4f55\u7ef4\u62a4\u8fd9\u4e2a\u4e1c\u897f\u3002\n\n\u5409\u8001\u5e08\u63d0\u51fa\u4e86\u4e00\u4e2a\u5f88\u597d\u7684\u89e3\u51b3\u65b9\u6848\uff1a\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u7ed3\u70b9\uff0c\u6211\u4eec\u7ef4\u62a4\u533a\u95f4\u6700\u5927\u503c\uff0c\u6700\u5927\u503c\u51fa\u73b0\u6b21\u6570\uff0c\u533a\u95f4\u4e25\u683c\u6b21\u5927\u503c\uff08\u7528 $sec$ \u8868\u793a\uff09\u3002\u6211\u4eec\u7ef4\u62a4\u597d\u4e86\u8fd9\u4e9b\u4fe1\u606f\u4e4b\u540e\uff0c\u6211\u4eec\u53d1\u73b0\u6211\u4eec\u53ef\u4ee5\u5728\u533a\u95f4\u53d6 $\\min$ \u64cd\u4f5c\u65f6\u4e0d\u65ad\u904d\u5386\u7ebf\u6bb5\u6811\uff0c\u76f4\u5230 $sec<v$\uff0c\u7531\u4e8e\u6211\u4eec\u7ef4\u62a4\u597d\u4e86\u533a\u95f4\u6700\u5927\u503c\u548c\u6700\u5927\u503c\u51fa\u73b0\u6b21\u6570\uff0c\u6211\u4eec\u53ef\u4ee5\u5f88\u5bb9\u6613\u5730\u7ef4\u62a4\u5176\u4ed6\u9700\u8981\u7ef4\u62a4\u7684\u4fe1\u606f\u3002\u5409\u8001\u5e08\u4e5f\u627f\u8ba4\u4e86\u81ea\u5df1\u5728\u8bfe\u4ef6\u4e0a\u7684 $O(n\\log n)$ \u8bc1\u660e\u662f\u4f2a\u8bc1\uff0c\u4f46\u662f\u53ef\u4ee5\u786e\u5b9a\u7684\u662f\uff0c\u8be5\u7b97\u6cd5\u7684\u590d\u6742\u5ea6\u4e0d\u591a\u4e8e $O(n\\log^2n)$\u3002\n\n> \u5982\u679c\u5bf9\u8bc1\u660e\u6709\u5174\u8da3\uff0c\u53ef\u4ee5\u53c2\u8003][\u5409\u5982\u4e00\u7684\u8ba8\u8bba](https://jiry-2.blog.uoj.ac/blog/1404)\uff0c\u7075\u68a6\u7684[\u6d1b\u8c37\u65e5\u62a5\u6587\u7ae0](https://www.luogu.com.cn/blog/Hakurei-Reimu/seg-beats)\uff0c \u4ee5\u53ca\u5409\u5982\u4e00\u7684\u96c6\u8bad\u961f\u8bba\u6587\u3002\n\n\u90a3\u4e48\uff0c\u52a0\u5165\u4e86\u5386\u53f2\u6700\u503c\u64cd\u4f5c\u4e4b\u540e\u8981\u600e\u4e48\u7ef4\u62a4\u5462\uff1f\u6211\u5c06\u4f1a\u4e0b\u6587\u7684\u6807\u8bb0\u4e0b\u4f20(pushdown)\u90e8\u5206\u8be6\u7ec6\u9610\u8ff0\u3002\n\n\u63a5\u7740\u5c06\u4f1a\u7740\u91cd\u5199\u4e09\u4e2a\u677f\u5757\u7684\u5185\u5bb9\uff1a\u6570\u503c\u4e0a\u4f20(pushup),\u6807\u8bb0\u4e0b\u4f20(pushdown), \u533a\u95f4\u53d6\u6700\u503c(update_min)\u3002\n\n### \u6570\u503c\u4e0a\u4f20(pushup)\n\n\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u4e0a\u4f20\u533a\u95f4\u6700\u5927\u503c\u3001\u5386\u53f2\u6700\u5927\u503c\u548c\u533a\u95f4\u548c\u3002\u4f46\u662f\u600e\u4e48\u7ef4\u62a4\u533a\u95f4\u4e25\u683c\u6b21\u5927\u503c\u548c\u6700\u5927\u503c\u51fa\u73b0\u6b21\u6570\u5462\uff1f\u6211\u4eec\u5148\u5224\u65ad\u5de6\u53f3\u533a\u95f4\u7684\u533a\u95f4\u6700\u5927\u503c\u662f\u5426\u76f8\u540c\uff1a\u82e5\u76f8\u540c\uff0c\u5c06\u5de6\u53f3\u533a\u95f4\u6700\u5927\u503c\u51fa\u73b0\u6b21\u6570\u76f8\u52a0\uff0c\u5e76\u53d6\u5de6\u53f3\u533a\u95f4\u7684\u4e25\u683c\u6b21\u5927\u503c\u4e2d\u8f83\u5927\u7684\u90a3\u4e2a\u4f5c\u4e3a\u533a\u95f4\u6b21\u5927\u503c\uff1b\u82e5\u4e0d\u540c\uff0c\u53d6\u6700\u5927\u503c\u8f83\u5927\u7684\u90a3\u4e2a\u533a\u95f4\u7684\u6700\u5927\u503c\u533a\u95f4\u6b21\u6570\uff0c\u5e76\u5c06\u8be5\u533a\u95f4\u7684\u6b21\u5927\u503c\u4e0e\u53e6\u4e00\u4e2a\u533a\u95f4\u7684\u4e25\u683c\u6b21\u5927\u503c\u6bd4\u8f83\u4ee5\u66f4\u65b0\u533a\u95f4\u6b21\u5927\u503c\u3002\n\n\u8be5\u90e8\u5206\u5e94\u8be5\u6bd4\u8f83\u5bb9\u6613\u7406\u89e3\u3002\n\n```cpp\ninline void pushup(int u){\n\ttree[u].maxa=max(tree[ls].maxa,tree[rs].maxa);\n\ttree[u].maxb=max(tree[ls].maxb,tree[rs].maxb);\n\ttree[u].sum=tree[ls].sum+tree[rs].sum;//\u76f4\u63a5\u4e0a\u4f20\n\tif(tree[ls].maxa==tree[rs].maxa){//\u4e09\u79cd\u60c5\u51b5\uff0c\u4e0d\u540c\u53d6\u6cd5\n\t\ttree[u].sec=max(tree[ls].sec,tree[rs].sec);\n\t\ttree[u].cnt=tree[ls].cnt+tree[rs].cnt;\n\t}\n\telse if(tree[ls].maxa>tree[rs].maxa){\n\t\ttree[u].sec=max(tree[ls].sec,tree[rs].maxa);\n\t\ttree[u].cnt=tree[ls].cnt;\n\t}\n\telse{\n\t\ttree[u].sec=max(tree[ls].maxa,tree[rs].sec);\n\t\ttree[u].cnt=tree[rs].cnt;\n\t}\n}\n```\n\n### \u6807\u8bb0\u4e0b\u4f20(pushdown)\n\n\u5728\u8fd9\u91cc\u7740\u91cd\u8bb2\u4e00\u4e0b\u52a0\u5165\u4e86\u5386\u53f2\u6700\u5927\u503c\u64cd\u4f5c\u8981\u600e\u4e48\u7ef4\u62a4\u3002\n\n\u9996\u5148\u6211\u4eec\u8981\u7ef4\u62a4\u56db\u4e2a tag\uff0c\u5373 $add\\_a,add\\_a1,add\\_b,add\\_b1$\u3002\n\n```cpp\nstruct Segment_Tree{\n\tint add_a,add_a1,add_b,add_b1;\n\tint maxa,sec,maxb,sum,cnt,len;\n}tree[N<<3];\n```\n\n\u8fd9\u56db\u4e2a tag \u5206\u522b\u662f\u5e72\u4ec0\u4e48\u7684\u5462\uff1f\u7531\u4e8e\u5728\u5409\u8001\u5e08\u7ebf\u6bb5\u6811\u4e2d\uff0c\u6211\u4eec\u533a\u95f4\u53d6 $\\min$ \u65f6\u53ea\u4f1a\u66f4\u65b0\u533a\u95f4\u6700\u5927\u503c\u7684\u503c\uff0c\u56e0\u6b64\u6211\u4eec\u8003\u8651\u5c06\u6bcf\u4e2a\u533a\u95f4\u7684\u6570\u5206\u4e3a\u4e24\u7c7b\uff1a\u6700\u5927\u6570\u548c\u975e\u6700\u5927\u6570\uff0c\u7136\u540e\u8fdb\u884c\u7ef4\u62a4\u3002\u8fd9\u6837\u6211\u4eec\u5728\u533a\u95f4\u53d6 $\\min$ \u65f6\u5c31\u53ef\u4ee5\u5f88\u597d\u7684\u53ea\u5bf9\u6700\u5927\u503c\u8fdb\u884c\u64cd\u4f5c\u4e86\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u7528 $add\\_a,add\\_a1$ \u5206\u522b\u8868\u793a\u5f53\u524d\u533a\u95f4\u6700\u5927\u503c\u7684\u52a0\u6807\u8bb0\u548c\u5f53\u524d\u533a\u95f4\u975e\u6700\u5927\u503c\u7684\u52a0\u6807\u8bb0\uff08\u52a0\u6807\u8bb0\u662f\u4ec0\u4e48\uff1f\u53c2\u8003 [\u3010\u6a21\u677f\u3011\u7ebf\u6bb5\u6811 1](https://www.luogu.com.cn/problem/P3372)\uff09\uff0c\u7528 $add\\_b,add\\_b1$ \u5206\u522b\u8868\u793a\u5f53\u524d\u533a\u95f4\u6700\u5927\u503c**\u5386\u53f2\u4e0a\u52a0\u7684\u6700\u591a\u7684\u90a3\u6b21\u7684\u52a0\u6807\u8bb0**\u4ee5\u53ca\u5bf9\u5e94\u7684\u975e\u6700\u5927\u503c\u7684\u5386\u53f2\u4e0a\u52a0\u7684\u6700\u591a\u7684\u90a3\u6b21\u7684\u52a0\u6807\u8bb0\u3002\n\n\u4ec0\u4e48\u662f**\u5386\u53f2\u4e0a\u52a0\u7684\u6700\u591a\u7684\u90a3\u6b21\u7684\u52a0\u6807\u8bb0**\uff1f\u6211\u4eec\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u6211\u4eec\u66fe\u7ecf\u7ed9\u4e00\u4e2a\u533a\u95f4\u7684\u6700\u5927\u503c\u6253\u4e0a\u4e86 $+5$ \u7684\u52a0\u6807\u8bb0\uff0c\u7136\u540e\u4e0b\u4e00\u4e2a\u64cd\u4f5c\uff0c\u8fd9\u4e2a\u533a\u95f4\u7684\u6700\u5927\u503c\u8981 $-2$\uff0c\u6211\u4eec\u6253\u8fd9\u4e2a\u6807\u8bb0\u540e\uff0c$add\\_a$ \u5c31\u53d8\u6210\u4e86 $+3$\uff0c\u800c $add\\_b$ \u4ecd\u4e3a $+5$\u3002**\u56e0\u4e3a\u4ed6\u66fe\u7ecf\u52a0\u7684\u6700\u591a\u7684\u662f $5$\uff0c\u6240\u4ee5\u4ed6\u7684\u5b50\u533a\u95f4\u90fd\u5728\u67d0\u4e00\u4e2a\u65f6\u523b\u662f $+5$ \u7684**\uff0c\u8fd9\u4e2a\u65f6\u523b\u624d\u53ef\u80fd\u662f\u5386\u53f2\u6700\u5927\u7684\u4f4d\u7f6e\u3002\n\n\u8fd9\u56db\u4e2a\u6807\u8bb0\u7406\u89e3\u4e86\u4e4b\u540e\uff0c\u540e\u9762\u5c31\u6bd4\u8f83\u5bb9\u6613\u7406\u89e3\u4e86\u3002\u7531\u4e8e\u6807\u8bb0\u4e0b\u4f20\u6bd4\u8f83\u590d\u6742\uff0c\u6211\u4eec\u901a\u5e38\u7528 pushdown \u548c update \u4e24\u4e2a\u51fd\u6570\u6765\u7ef4\u62a4\u3002\u5bf9\u4e8e pushdown\uff0c\u6211\u4eec\u5148\u5224\u65ad\u6700\u5927\u503c\u5728\u54ea\u8fb9\uff0c\u5982\u679c\u5728\u5de6\u8fb9\uff0c\u90a3\u4e48\u5de6\u8fb9\u7684\u6700\u5927\u503c\u53d7\u5230\u7684\u5f71\u54cd\u662f\u5f53\u524d\u533a\u95f4\u5bf9\u6700\u5927\u503c\u7684\u5f71\u54cd\uff0c\u800c\u53f3\u8fb9\u7684\u6700\u5927\u503c\u53d7\u5230\u7684\u5f71\u54cd\u4ec5\u662f\u5f53\u524d\u533a\u95f4\u5bf9\u6b21\u5927\u503c\u7684\u5f71\u54cd\uff08\u5f53\u7136\u53ef\u80fd\u5de6\u53f3\u4e24\u8fb9\u90fd\u6709\u6700\u5927\u503c\uff0c\u90a3\u4e48\u4e24\u8fb9\u7684\u6700\u5927\u503c\u53d7\u5230\u7684\u5f71\u54cd\u5747\u662f\u5f53\u524d\u533a\u95f4\u5bf9\u6700\u5927\u503c\u7684\u5f71\u54cd\uff09\u3002\u5982\u679c\u6700\u5927\u503c\u5728\u53f3\u8fb9\uff0c\u53cd\u8fc7\u6765\u5c31\u53ef\u4ee5\u4e86\u3002\n\n```cpp\ninline void pushdown(int u){\n\tint maxx=max(tree[ls].maxa,tree[rs].maxa);\n\tif(tree[ls].maxa==maxx)//\u6700\u5927\u503c\u5728\u5de6\u8fb9?\n\t\tupdate(ls,tree[u].add_a,tree[u].add_b,tree[u].add_a1,tree[u].add_b1);//\u662f\uff0c\u7ed9\u6700\u5927\u503c\u7684\u6807\u8bb0\u7ed9\u5de6\u8fb9\u3002\n\telse update(ls,tree[u].add_a1,tree[u].add_b1,tree[u].add_a1,tree[u].add_b1);//\u4e0d\u662f\uff0c\u5de6\u8fb9\u7684\u6700\u5927\u503c\u83b7\u5f97\u7684\u6807\u8bb0\u4e5f\u5e94\u8be5\u662f\u8be5\u533a\u95f4\u7684\u975e\u6700\u5927\u503c\u83b7\u5f97\u7684\u6807\u8bb0\u3002\n\tif(tree[rs].maxa==maxx)//\u6700\u5927\u503c\u5728\u53f3\u8fb9?\n\t\tupdate(rs,tree[u].add_a,tree[u].add_b,tree[u].add_a1,tree[u].add_b1);//\u7c7b\u4f3c\u4e0a\u8fb9\n\telse update(rs,tree[u].add_a1,tree[u].add_b1,tree[u].add_a1,tree[u].add_b1);\n\ttree[u].add_a=tree[u].add_b=tree[u].add_a1=tree[u].add_b1=0;\n}\n```\n\n\u8fd9\u65f6\u5019\u53ef\u80fd\u6709\u7591\u95ee\uff0c\u6211\u4eec\u4ec5\u4ec5\u5224\u65ad\u4e86\u5f53\u524d\u7684\u6700\u5927\u503c\u5728\u54ea\u91cc\uff0c\u600e\u4e48 $add\\_b$ \u4e5f\u8ddf\u7740\u8d70\u4e86\uff0c\u8fd9\u4e2a\u4e1c\u897f\u4e0d\u662f\u7ef4\u62a4\u5386\u53f2\u7684\u5417\uff1f\u5982\u679c\u4f60\u7406\u89e3\u4e86\u4e0a\u9762\u7684\uff0c\u90a3\u4e48\u8be5\u6807\u8bb0\u8868\u793a\u7684\u662f**\u5f53\u524d**\u6700\u5927\u503c**\u5386\u53f2\u4e0a**\u52a0\u7684\u6700\u591a\u7684\u90a3\u6b21\uff0c\u6240\u4ee5\u8fd9\u4e2a\u6807\u8bb0\u5b9e\u8d28\u4e0a\u8fd8\u662f\u6253\u7ed9\u5f53\u524d\u6700\u5927\u503c\u7684\uff0c\u5f53\u7136\u662f\u4e0e $add\\_a$ \u662f\u4e00\u8d77\u7684\u3002\n\n\u90a3\u4e48 update \u5462\uff1f\u6211\u4eec\u5148\u770b\u4ee3\u7801\u3002\n\n```cpp\ninline void update(int u,int k1,int k2,int k3,int k4){\n\ttree[u].sum+=k1*tree[u].cnt+k3*(tree[u].len-tree[u].cnt);//\u66f4\u65b0\u533a\u95f4\u548c\n\ttree[u].maxb=max(tree[u].maxb,tree[u].maxa+k2);//\u66f4\u65b0\u5386\u53f2\u6700\u5927\u503c\n\ttree[u].add_b=max(tree[u].add_b,tree[u].add_a+k2);\n\ttree[u].add_b1=max(tree[u].add_b1,tree[u].add_a1+k4);\n\ttree[u].maxa+=k1;//\u66f4\u65b0\u5f53\u524d\u6700\u5927\u503c\n\ttree[u].add_a+=k1;\n\ttree[u].add_a1+=k3;\n\tif(tree[u].sec!=-1e18) tree[u].sec+=k3;//\u66f4\u65b0\u6b21\u5927\u503c\n}\n```\n\n$k1,k2$ \u5206\u522b\u8868\u793a\uff1a\u5f53\u524d/\u5386\u53f2\u6700\u5927\u503c\u8981\u52a0\u7684\u6570\u3002\n\n$k3,k4$ \u5206\u522b\u8868\u793a\uff1a\u5f53\u524d/\u5386\u53f2\u975e\u6700\u5927\u503c\u8981\u52a0\u7684\u6570\u3002\n\n\u7136\u540e\u6211\u4eec\u8003\u8651\u5982\u679c\u66f4\u65b0\u5404\u4e2a\u6807\u8bb0\u3002\u533a\u95f4\u548c\u5f88\u597d\u7406\u89e3\uff0c\u5c31\u662f\u6700\u5927\u503c\u52a0\u7684\u91cf\u52a0\u4e0a\u975e\u6700\u5927\u503c\u52a0\u7684\u91cf\u3002\u5bf9\u4e8e $add\\_b$\uff0c\u5b83\u662f\u5386\u53f2\u4e0a\u52a0\u7684\u6700\u591a\u7684\u90a3\u6b21\uff0c\u6240\u4ee5\u6211\u4eec\u5224\u65ad\u4e00\u4e0b\u5f53\u524d\u7684 $add\\_a$ \u52a0\u4e0a $k1$ \u662f\u5426\u8d85\u8fc7\u4e86\u5386\u53f2\uff0c\u82e5\u662f\uff0c\u66f4\u65b0\u5386\u53f2\uff08\u5982\u679c\u4e0d\u7406\u89e3\uff0c\u8bf7\u5148\u7406\u89e3\u597d $add\\_b$ \u7684\u542b\u4e49\uff09\u3002$add\\_b1$ \u7c7b\u4f3c\u3002\u5bf9\u4e8e\u5386\u53f2\u6700\u5927\u503c\uff0c\u6211\u4eec\u770b\u770b\u5f53\u524d\u6700\u5927\u503c\u52a0\u4e0a\u5386\u53f2\u4e0a\u52a0\u7684\u6700\u591a\u7684\u65f6\u5019\u7684\u52a0\u6807\u8bb0\u7684\u503c\uff08\u5373 $k2$\uff09\u662f\u5426\u8d85\u8fc7\u4e86\u5386\u53f2\u6700\u5927\u503c\uff0c\u82e5\u8d85\u8fc7\u4e86\uff0c\u66f4\u65b0\u5386\u53f2\u6700\u5927\u503c\u3002\u5176\u4ed6\u4fe1\u606f\u7684\u7ef4\u62a4\u5c31\u5f88\u5bb9\u6613\u4e86\uff0c\u81ea\u884c\u770b\u4e0a\u65b9\u4ee3\u7801\u5373\u53ef\u3002      \n\n### \u533a\u95f4\u53d6\u6700\u503c(update_min)\n\n\u9996\u5148\uff0c\u5982\u679c\u8be5\u533a\u95f4\u7684\u6700\u5927\u503c\u6bd4\u8981\u53d6\u7684 $v$\uff08\u4e0b\u9762\u4ee3\u7801\u4e2d\u4e3a $k$\uff09\u5c0f\uff0c\u663e\u7136\u76f4\u63a5\u8fd4\u56de\u5373\u53ef\u3002\u82e5 $sec \\le v \\le maxa$\uff0c\u90a3\u4e48\u5c31\u66f4\u65b0\u6700\u5927\u503c\u3002\u600e\u4e48\u66f4\u65b0\u5462\uff1f\u6211\u4eec\u5c06 $maxa$ \u53d8\u6210\u4e86 $k$\uff0c\u4e5f\u5c31\u662f\u5bf9\u4e8e\u6700\u5927\u503c\uff0c\u51cf\u53bb\u4e86 $maxa-k$\uff0c\u6362\u8a00\u4e4b\uff0c\u52a0\u4e86 $k-maxa$\uff0c\u7528 update \u51fd\u6570\u64cd\u4f5c\u5373\u53ef\u3002\u82e5\u4e0d\u5c5e\u4e8e\u8fd9\u4e24\u79cd\u60c5\u51b5\u4e2d\u7684\u4efb\u610f\u4e00\u79cd\uff0c\u90a3\u5c31\u9700\u8981\u7ee7\u7eed\u904d\u5386\u5230\u5b50\u533a\u95f4\u3002\n\n```cpp\ninline void update_min(int u,int l,int r,int L,int R,int k){\n\tif(l>R||r<L||k>=tree[u].maxa) return;//\u76f4\u63a5\u8fd4\u56de\n\tif(l>=L&&r<=R&&k>=tree[u].sec){//\u66f4\u65b0\u518d\u8fd4\u56de\n\t\tupdate(u,k-tree[u].maxa,k-tree[u].maxa,0,0);\n\t\treturn;\n\t}\n\tpushdown(u);//\u7ee7\u7eed\u904d\u5386\n\tint mid=(l+r)>>1;\n\tupdate_min(ls,l,mid,L,R,k);update_min(rs,mid+1,r,L,R,k);\n\tpushup(u);\n}\n```\n\n\u8fd9\u4e2a\u51fd\u6570\u4e0d\u96be\u7406\u89e3\uff0c\u4e0d\u591a\u505a\u8d58\u8ff0\u3002\u5176\u4ed6\u51fd\u6570\u5747\u4e0e\u666e\u901a\u7684\u7ebf\u6bb5\u6811\u7c7b\u4f3c\uff0c\u8fd9\u91cc\u4e5f\u4e0d\u8c08\u4e86\u3002\n\n## \u5b8c\u6574\u4ee3\u7801\n\n```cpp\n#include<bits/stdc++.h>\n#define int long long\n#define ls u<<1\n#define rs u<<1|1\n#define getchar()(p1==p2&&(p2=(p1=buf)+fread(buf,1,1<<21,stdin),p1==p2)?EOF:*p1++)\nusing namespace std;\nchar buf[1<<21],*p1=buf,*p2=buf;\ntemplate <typename T>\ninline void read(T& r) {\n    r=0;bool w=0; char ch=getchar();\n    while(ch<'0'||ch>'9') w=ch=='-'?1:0,ch=getchar();\n    while(ch>='0'&&ch<='9') r=r*10+(ch^48), ch=getchar();\n    r=w?-r:r;\n}\nconst int N=5e5+5;\nstruct Segment_Tree{\n\tint add_a,add_a1,add_b,add_b1;\n\tint maxa,sec,maxb,sum,cnt,len;\n}tree[N<<3];\nint n,m,a[N];\ninline void pushup(int u){\n\ttree[u].maxa=max(tree[ls].maxa,tree[rs].maxa);\n\ttree[u].maxb=max(tree[ls].maxb,tree[rs].maxb);\n\ttree[u].sum=tree[ls].sum+tree[rs].sum;\n\tif(tree[ls].maxa==tree[rs].maxa){\n\t\ttree[u].sec=max(tree[ls].sec,tree[rs].sec);\n\t\ttree[u].cnt=tree[ls].cnt+tree[rs].cnt;\n\t}\n\telse if(tree[ls].maxa>tree[rs].maxa){\n\t\ttree[u].sec=max(tree[ls].sec,tree[rs].maxa);\n\t\ttree[u].cnt=tree[ls].cnt;\n\t}\n\telse{\n\t\ttree[u].sec=max(tree[ls].maxa,tree[rs].sec);\n\t\ttree[u].cnt=tree[rs].cnt;\n\t}\n}\ninline void update(int u,int k1,int k2,int k3,int k4){\n\ttree[u].sum+=k1*tree[u].cnt+k3*(tree[u].len-tree[u].cnt);\n\ttree[u].maxb=max(tree[u].maxb,tree[u].maxa+k2);\n\ttree[u].add_b=max(tree[u].add_b,tree[u].add_a+k2);\n\ttree[u].add_b1=max(tree[u].add_b1,tree[u].add_a1+k4);\n\ttree[u].maxa+=k1;\n\ttree[u].add_a+=k1;\n\ttree[u].add_a1+=k3;\n\tif(tree[u].sec!=-1e18) tree[u].sec+=k3;\n}\ninline void pushdown(int u){\n\tint maxx=max(tree[ls].maxa,tree[rs].maxa);\n\tif(tree[ls].maxa==maxx)\n\t\tupdate(ls,tree[u].add_a,tree[u].add_b,tree[u].add_a1,tree[u].add_b1);\n\telse update(ls,tree[u].add_a1,tree[u].add_b1,tree[u].add_a1,tree[u].add_b1);\n\tif(tree[rs].maxa==maxx)\n\t\tupdate(rs,tree[u].add_a,tree[u].add_b,tree[u].add_a1,tree[u].add_b1);\n\telse update(rs,tree[u].add_a1,tree[u].add_b1,tree[u].add_a1,tree[u].add_b1);\n\ttree[u].add_a=tree[u].add_b=tree[u].add_a1=tree[u].add_b1=0;\n}\ninline void build(int u,int l,int r){\n\ttree[u].len=r-l+1;\n\tif(l==r){\n\t\ttree[u].maxa=tree[u].maxb=tree[u].sum=a[l];\n\t\ttree[u].sec=-1e18;tree[u].cnt=1;\n\t\treturn;\n\t}\n\tint mid=(l+r)>>1;\n\tbuild(ls,l,mid);build(rs,mid+1,r);\n\tpushup(u);\n}\ninline void update_add(int u,int l,int r,int L,int R,int k){\n\tif(l>R||r<L) return;\n\tif(l>=L&&r<=R){\n\t\tupdate(u,k,k,k,k);\n\t\treturn;\n\t}\n\tpushdown(u);\n\tint mid=(l+r)>>1;\n\tupdate_add(ls,l,mid,L,R,k);update_add(rs,mid+1,r,L,R,k);\n\tpushup(u);\n}\ninline void update_min(int u,int l,int r,int L,int R,int k){\n\tif(l>R||r<L||k>=tree[u].maxa) return;\n\tif(l>=L&&r<=R&&k>=tree[u].sec){\n\t\tupdate(u,k-tree[u].maxa,k-tree[u].maxa,0,0);\n\t\treturn;\n\t}\n\tpushdown(u);\n\tint mid=(l+r)>>1;\n\tupdate_min(ls,l,mid,L,R,k);update_min(rs,mid+1,r,L,R,k);\n\tpushup(u);\n}\ninline int query_sum(int u,int l,int r,int L,int R){\n\tif(l>R||r<L) return 0;\n\tif(l>=L&&r<=R) return tree[u].sum;\n\tint mid=(l+r)>>1;\n\tpushdown(u);\n\treturn query_sum(ls,l,mid,L,R)+query_sum(rs,mid+1,r,L,R);\n}\ninline int query_maxa(int u,int l,int r,int L,int R){\n\tif(l>R||r<L) return -1e18;\n\tif(l>=L&&r<=R) return tree[u].maxa;\n\tint mid=(l+r)>>1;\n\tpushdown(u);\n\treturn max(query_maxa(ls,l,mid,L,R),query_maxa(rs,mid+1,r,L,R));\n}\ninline int query_maxb(int u,int l,int r,int L,int R){\n\tif(l>R||r<L) return -1e18;\n\tif(l>=L&&r<=R) return tree[u].maxb;\n\tint mid=(l+r)>>1;\n\tpushdown(u);\n\treturn max(query_maxb(ls,l,mid,L,R),query_maxb(rs,mid+1,r,L,R));\n}\nsigned main(){\n\tread(n);read(m);\n\tfor(int i=1;i<=n;i++) read(a[i]);\n\tbuild(1,1,n);\n\tfor(int i=1,opt,l,r,k;i<=m;i++){\n\t\tread(opt);read(l);read(r);\n\t\tif(opt==1){\n\t\t\tread(k);\n\t\t\tupdate_add(1,1,n,l,r,k);\n\t\t}\n\t\telse if(opt==2){\n\t\t\tread(k);\n\t\t\tupdate_min(1,1,n,l,r,k);\n\t\t}\n\t\telse if(opt==3){\n\t\t\tprintf(\"%lld\\n\",query_sum(1,1,n,l,r));\n\t\t}\n\t\telse if(opt==4){\n\t\t\tprintf(\"%lld\\n\",query_maxa(1,1,n,l,r));\n\t\t}\n\t\telse{\n\t\t\tprintf(\"%lld\\n\",query_maxb(1,1,n,l,r));\n\t\t}\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1615987084,
        "uid": 195229,
        "name": "water_tomato",
        "ccfLevel": 7,
        "title": "\u6709\u8da3\u7684\u7ebf\u6bb5\u6811\u7ef4\u62a4\u2014\u2014\u5409\u8001\u5e08\u7ebf\u6bb5\u6811\u5b66\u4e60\u7b14\u8bb0"
    },
    {
        "content": "\u5176\u4ed6\u9898\u89e3\u5df2\u7ecf\u628a\u672c\u9898\u7684\u8fc7\u7a0b\u8bb2\u8ff0\u5f97\u5f88\u8be6\u5c3d\u4e86\uff0c\u8fd9\u91cc\u4ec5\u8bf4\u4e00\u70b9\u5bf9\u61d2\u6807\u8bb0\u7684\u7406\u89e3\u3002\n\n\u6240\u8c13\u61d2\u6807\u8bb0\uff0c\u672c\u8d28\u662f\u8bb0\u5f55\u4e86\u4e00\u6bb5\u64cd\u4f5c\u5e8f\u5217\uff0c\u7528\u4e00\u4e2a\u503c\u6216\u4e00\u4e9b\u503c\u63cf\u8ff0\u51fa\u6765\u3002\u800c\u61d2\u6807\u8bb0\u7684\u4e0b\u4f20\uff0c\u5c31\u662f\u5c06\u8fd9\u6bb5\u64cd\u4f5c\u5e8f\u5217\u7684\u5f71\u54cd\u66f4\u65b0\u5230\u5b50\u7ed3\u70b9\u5904\uff0c\u5e76\u4e14\u5c06\u8fd9\u6bb5\u64cd\u4f5c\u5e8f\u5217\u6dfb\u52a0\u5230\u5b50\u7ed3\u70b9\u64cd\u4f5c\u5e8f\u5217\u7684\u540e\u9762\uff0c\u7136\u540e\u6e05\u7a7a\u539f\u7ed3\u70b9\u64cd\u4f5c\u5e8f\u5217\u7684\u8fc7\u7a0b\u3002\u6bcf\u8bbf\u95ee\u5230\u4e00\u4e2a\u7ed3\u70b9\u5c31\u4e0b\u4f20\u8be5\u70b9\u7684\u61d2\u6807\u8bb0\uff0c\u610f\u4e49\u5c31\u5728\u4e8e\u7ef4\u62a4\u6240\u6709\u64cd\u4f5c\u5e8f\u5217\u7684\u6709\u5e8f\u6027\u3002\u6709\u4e9b\u64cd\u4f5c\u7684\u64cd\u4f5c\u987a\u5e8f\u4e0d\u4f1a\u5f71\u54cd\u5230\u8be2\u95ee\u7684\u7ed3\u679c\uff0c\u5982\u533a\u95f4\u52a0\u533a\u95f4\u6c42\u548c\uff0c\u6b64\u65f6\u624d\u53ef\u4ee5\u6807\u8bb0\u6c38\u4e45\u5316\uff0c\u4e0d\u4e0b\u4f20\u6807\u8bb0\u3002\n\n\u56de\u5230\u672c\u9898\u7684\u201c\u5386\u53f2\u7248\u672c\u6700\u5927\u503c\u201d\uff0c\u6240\u6c42\u5373\u4e3a **\u64cd\u4f5c\u5e8f\u5217\u7684\u524d\u7f00\u548c\u7684\u6700\u5927\u503c** \u3002\u4ee4 $add_x$ \u8868\u793a\u7ebf\u6bb5\u6811\u4e0a\u7ed3\u70b9 $x$ \u7684\u533a\u95f4\u52a0\u6807\u8bb0\uff0c $add'_x$ \u8868\u793a\u7ed3\u70b9 $x$ \u7684\u5386\u53f2\u6700\u5927\u52a0\u6807\u8bb0\uff0c\u8bbe $x$ \u7684\u513f\u5b50\u7ed3\u70b9\u4e3a $y$ \uff0c\u5c06 $x$ \u7684\u6807\u8bb0\u4e0b\u4f20\u81f3 $y$ \u65f6\uff0c\u6709 $add'_y=\\max\\{add'_y,add_y+add'_x\\}$ \uff0c\u5373\u5c06 $x$ \u7684\u64cd\u4f5c\u5e8f\u5217\u63a5\u5728 $y$ \u7684\u64cd\u4f5c\u5e8f\u5217\u4e4b\u540e\uff0c\u524d\u7f00\u548c\u7684\u6700\u5927\u503c\u3002\n\n\u6700\u540e\u518d\u8bf4\u4e00\u4e0b\u5728\u6807\u8bb0\u4e0b\u4f20\u65f6\u9700\u8981\u6ce8\u610f\u7684\u4e24\u4e2a\u95ee\u9898\uff1a\n\n1. \u5728\u4e0b\u4f20\u524d\uff0c\u8981\u5148\u5224\u65ad\u513f\u5b50\u7ed3\u70b9\u7684\u533a\u95f4\u91cc\u6709\u6ca1\u6709\u5f53\u524d\u7ed3\u70b9\u7684\u533a\u95f4\u91cc\u7684\u6700\u5927\u503c\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u5219\u533a\u95f4\u975e\u6700\u5927\u503c\u52a0\u6cd5\u6807\u8bb0\u4f1a\u5f71\u54cd\u5230\u513f\u5b50\u7ed3\u70b9\u533a\u95f4\u7684\u6700\u5927\u503c\uff0c\u533a\u95f4\u6700\u5927\u503c\u52a0\u6cd5\u6807\u8bb0\u4e0d\u4f1a\u5f71\u54cd\u513f\u5b50\u7ed3\u70b9\u533a\u95f4\u3002\n\n2. \u4e0d\u80fd\u56e0\u4e3a\u533a\u95f4\u52a0\u6807\u8bb0\u7b49\u4e8e $0$ \u5c31\u4e0d\u4e0b\u4f20\u6807\u8bb0\uff0c\u53ef\u80fd\u7ecf\u8fc7\u4e00\u7cfb\u5217\u64cd\u4f5c\u540e\u533a\u95f4\u52a0\u6807\u8bb0\u53d8\u6210\u4e86 $0$ \uff0c\u4f46\u662f\u5386\u53f2\u6700\u5927\u52a0\u6807\u8bb0\u4e0d\u4e3a $0$ \u3002\n\n\u4ee3\u7801\u592a\u4e11\uff0c\u5c31\u4e0d\u653e\u51fa\u6765\u5566\uff0c\u5728\u7406\u89e3\u672c\u9898\u5e94\u8be5\u7ef4\u62a4\u54ea\u4e9b\u503c\u54ea\u4e9b\u6807\u8bb0\u4ee5\u53ca\u5982\u4f55\u4e0b\u4f20\u6807\u8bb0\u540e\uff0c\u4ee3\u7801\u5b9e\u73b0\u4e0d\u4f1a\u5f88\u96be\u3002",
        "postTime": 1586067749,
        "uid": 43486,
        "name": "hsfzLZH1",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P6242 \u3010\u3010\u6a21\u677f\u3011\u7ebf\u6bb5\u6811 3\u3011"
    },
    {
        "content": "\u4e00\u9053\u975e\u5e38\u6076\u5fc3\u7684\u7ebf\u6bb5\u6811\u6a21\u677f\u9898\uff08~~\u6a21\u677f\u9898\u90fd\u8fd9\u4e48\u6076\u5fc3~~\uff09\uff0c\u5361\u4e86\u6211 $3$ \u4e2a\u5c0f\u65f6\u3002\n\n# \u9996\u5148\u8bb2\u601d\u8def\uff1a\n\u5176\u5b9e\u53ea\u8981 $AC$ \u4e86 [\u8fd9\u4e00\u9053\u9898](https://www.luogu.com.cn/problem/P3372) \u548c [\u8fd9\u4e00\u9053\u9898](https://www.luogu.com.cn/problem/P3373) \u5c31\u53ef\u4ee5\u5f88~~\u8f7b\u677e\u52a0\u6109\u5feb~~\u5730\u5207\u6389\u8fd9\u4e00\u9898\u3002\n\n# \u4ee3\u7801\u5b9e\u73b0\n## 1.\u5b9a\u4e49\u7ed3\u6784\u4f53\u4e0e\u4f18\u5316\uff1a\n\u76f4\u63a5\u7167\u7740\u642c\u677f\u5b50\u5c31\u53ef\u4ee5\u4e86\u3002\n\n### code\uff1a\n```cpp\n#include<bits/stdc++.h>\n#define int long long\n#define lc p*2\n#define rc p*2+1\nusing namespace std;\nint n,m,k,o,l,r;\nint a[10000005];\nstruct node{\n\tint l;//\u5de6\u7aef\u70b9 \n\tint r;//\u53f3\u7aef\u70b9 \n\tint data;//\u533a\u95f4\u548c \n\tint tag_max_1;//\u533a\u95f4\u6700\u5927\u503c \n\tint tag_max_add_1;//\u533a\u95f4\u6700\u5927\u503clazy_tag \n\tint tag_max_2;//\u533a\u95f4\u6b21\u5927\u503c \n\tint tag_max_add_2;//\u533a\u95f4\u975e\u6700\u5927\u503clazy_tag \n\tint tag_max_1_old;//\u533a\u95f4\u5386\u53f2\u6700\u5927\u503c \n\tint tag_max_add_1_old;//\u533a\u95f4\u5386\u53f2\u6700\u5927\u503clazy_tag \n\tint tag_max_2_old;//\u533a\u95f4\u5386\u53f2\u6b21\u5927\u503c \n\tint tag_max_add_2_old;//\u533a\u95f4\u5386\u53f2\u975e\u6700\u5927\u503clazy_tag \n\tint tag_max_cnt;//\u6700\u5927\u503c\u7684\u4e2a\u6570 \n}tree[1000005*4];\nint read(){\n    char c=getchar();int s=0,f=1;\n    for(;!isdigit(c);c=getchar())if(c=='-')f=-1;\n    for(;isdigit(c);c=getchar())s=s*10+c-48;\n    return s*f;\n}//\u8bfb\u5165\u4f18\u5316 \n```\n\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u7ed3\u6784\u4f53\u91cc\u8fd9\u4e9b\u4e71\u4e03\u516b\u7cdf\u7684\u4e1c\u897f\u6700\u597d\u662f\u82f1\u6587\u7ffb\u8bd1\u6216\u8005\u662f\u7f29\u5199\uff08~~\u4e0d\u7136\u7684\u8bdd\u5c31\u4f1a\u50cf\u6211\u4e00\u6837\u770b\u5176\u4ed6\u51e0\u7bc7\u9898\u89e3\u770b\u5f97\u5934\u6655~~\uff09\u3002\n## 2.\u4e3b\u51fd\u6570\u5b9e\u73b0\uff1a\n\u4e5f\u6ca1\u6709\u4efb\u4f55\u96be\u5ea6\uff0c\u76f4\u63a5\u4e0a\u4ee3\u7801\u3002\n### code\uff1a\n```cpp\nsigned main(){\n\tcin>>n>>m;\n\tfor(int i=1;i<=n;i++){\n\t\ta[i]=read();\n\t}\n\t//\u8f93\u5165 \n\tbuild(1,1,n);//\u8c03\u7528\u5efa\u6811\u51fd\u6570 \n\tfor(int i=1;i<=m;i++){\n\t\to=read(),l=read(),r=read();\n\t\tif(o==1)k=read(),change_1(1);\n\t\tif(o==2)k=read(),change_2(1);\n\t\tif(o==3)printf(\"%lld\\n\",ask_1(1));\n\t\tif(o==4)printf(\"%lld\\n\",ask_2(1));\n\t\tif(o==5)printf(\"%lld\\n\",ask_3(1));\n\t}\n\treturn 0;\n} \n```\n## 3.\u5efa\u6811\uff1a\n\u53ea\u6bd4\u524d\u9762\u4e24\u9053\u6a21\u677f\u9898\u7684 $build$ \u51fd\u6570\u591a\u4ebf\u70b9\u4e1c\u897f\uff0c\u4f9d\u7136\u5f88\u5bb9\u6613\u3002\n### code\uff1a\n```cpp\nvoid build(int p,int l,int r){//\u5efa\u6811 \n\ttree[p].l=l;//\u5b58\u50a8\u5de6\u7aef\u70b9 \n\ttree[p].r=r;//\u5b58\u50a8\u53f3\u7aef\u70b9 \n\tif(l==r){//\u5982\u679c\u8bbf\u95ee\u5230\u53f6\u5b50\u8282\u70b9 \n\t\ttree[p].data=a[l];//\u56e0\u4e3a\u5f53\u524d\u8282\u70b9\u53ea\u6709\u4e00\u4e2a\u5143\u7d20\uff0c\u6240\u4ee5\u533a\u95f4\u548c\u4e3a\u5b83\u672c\u8eab \n\t\ttree[p].tag_max_1=a[l];//\u56e0\u4e3a\u5f53\u524d\u533a\u95f4\u53ea\u6709\u4e00\u4e2a\u5143\u7d20\uff0c\u6240\u4ee5\u6700\u5927\u503c\u5c31\u662f\u5b83\u672c\u8eab \n\t\ttree[p].tag_max_1_old=a[l];//\u5386\u53f2\u6700\u5927\u503c\u8d4b\u503c\u4e3a\u5f53\u524d\u5143\u7d20 \n\t\ttree[p].tag_max_2=-1e18;//\u56e0\u4e3a\u5f53\u524d\u533a\u95f4\u53ea\u6709\u4e00\u4e2a\u5143\u7d20\uff0c\u6240\u4ee5\u4e0d\u5b58\u5728\u6b21\u5927\u503c\uff0c\u8d4b\u503c\u4e3a\u65e0\u7a77\u5c0f \n\t\ttree[p].tag_max_cnt=1;//\u6700\u5927\u503c\u53ea\u6709\u4e00\u4e2a\u4e5f\u5c31\u662f\u5b83\u672c\u8eab\n\t\treturn;//\u8fd4\u56de \n\t}\n\tint mid=(l+r)/2;\n\tbuild(lc,l,mid);//\u9012\u5f52\u5efa\u9020\u5de6\u533a\u95f4 \n\tbuild(rc,mid+1,r);//\u9012\u5f52\u5efa\u9020\u53f3\u533a\u95f4 \n\tpush_up(p);//\u5408\u5e76\u533a\u95f4 \n}\n```\n\u5408\u5e76\u533a\u95f4\u7684\u4ee3\u7801\u5728\u8fd9\u91cc~\u3002\n### code\uff1a\n```cpp\nvoid push_up(int p){//\u5408\u5e76\u533a\u95f4 \n\ttree[p].tag_max_1=max(tree[lc].tag_max_1,tree[rc].tag_max_1);//\u66f4\u65b0\u533a\u95f4\u6700\u5927\u503c \n\ttree[p].tag_max_1_old=max(tree[lc].tag_max_1_old,tree[rc].tag_max_1_old);//\u66f4\u65b0\u5386\u53f2\u533a\u95f4\u6700\u5927\u503c \n\ttree[p].data=tree[lc].data+tree[rc].data;//\u66f4\u65b0\u533a\u95f4\u548c \n\tif(tree[lc].tag_max_1==tree[rc].tag_max_1){//\u5982\u679c\u6574\u4e2a\u533a\u95f4\u6700\u5927\u503c\u4e24\u8fb9\u90fd\u6709 \n\t\ttree[p].tag_max_2=max(tree[lc].tag_max_2,tree[rc].tag_max_2);//\u66f4\u65b0\u533a\u95f4\u6b21\u5927\u503c\u4e3a\u4e24\u8fb9\u6b21\u5927\u503c\u4e2d\u7684\u6700\u5927\u503c \n\t\ttree[p].tag_max_cnt=tree[lc].tag_max_cnt+tree[rc].tag_max_cnt;//\u66f4\u65b0\u533a\u95f4\u6700\u5927\u503c\u4e2a\u6570\u4e3a\u4e24\u8fb9\u6700\u5927\u503c\u4e2a\u6570\u4e4b\u548c \n\t}\n\tif(tree[lc].tag_max_1>tree[rc].tag_max_1){//\u5982\u679c\u533a\u95f4\u6700\u5927\u503c\u4f4d\u4e8e\u5de6\u8fb9 \n\t\ttree[p].tag_max_2=max(tree[lc].tag_max_2,tree[rc].tag_max_1);//\u66f4\u65b0\u533a\u95f4\u6b21\u5927\u503c\u4e3a\u5de6\u8fb9\u6b21\u5927\u503c\u4e0e\u53f3\u8fb9\u6700\u5927\u503c\u4e2d\u7684\u6700\u5927\u503c \n\t\ttree[p].tag_max_cnt=tree[lc].tag_max_cnt;//\u6700\u5927\u503c\u4e2a\u6570\u4e3a\u5de6\u8fb9\u6700\u5927\u503c\u7684\u4e2a\u6570 \n\t}\n\tif(tree[lc].tag_max_1<tree[rc].tag_max_1){//\u5982\u679c\u533a\u95f4\u6700\u5927\u503c\u4f4d\u4e8e\u53f3\u8fb9 \n\t\ttree[p].tag_max_2=max(tree[lc].tag_max_1,tree[rc].tag_max_2);//\u533a\u95f4\u6700\u5927\u503c\u4e3a\u5de6\u8fb9\u6700\u5927\u503c\u4e0e\u53f3\u8fb9\u6b21\u5927\u503c\u4e2d\u7684\u6700\u5927\u503c \n\t\ttree[p].tag_max_cnt=tree[rc].tag_max_cnt;//\u533a\u95f4\u6700\u5927\u503c\u4e2a\u6570\u4e3a\u53f3\u8fb9\u6700\u5927\u503c\u7684\u4e2a\u6570 \n\t}\n}\n```\n## 4. $lazy\\_tag$ \u5904\u7406\u65b9\u6cd5\uff1a\n\u8bb2\u51fa\u6765\u6709\u4e9b\u590d\u6742\uff0c\u76f4\u63a5\u770b\u4ee3\u7801\u3002\n### code\uff1a\n```cpp\nvoid update(int k1,int k2,int k3,int k4,int p){\n\t//k1\u8868\u793a\u533a\u95f4\u6700\u5927\u503c\u8981\u52a0\u7684\u6570\uff0ck2\u8868\u793a\u5386\u53f2\u6700\u5927\u503c\u8981\u52a0\u7684\u6570\uff0ck3\u8868\u793a\u975e\u6700\u5927\u503c\u8981\u52a0\u7684\u6570\uff0ck4\u8868\u793a\u975e\u5386\u53f2\u6700\u5927\u503c\u6700\u5927\u503c\u8981\u52a0\u7684\u6570 \n\ttree[p].data+=k1*tree[p].tag_max_cnt+k3*(tree[p].r-tree[p].l+1-tree[p].tag_max_cnt);//\u66f4\u65b0\u533a\u95f4\u548c \n\ttree[p].tag_max_1_old=max(tree[p].tag_max_1_old,tree[p].tag_max_1+k2);\n\ttree[p].tag_max_add_1_old=max(tree[p].tag_max_add_1_old,tree[p].tag_max_add_1+k2);\n\ttree[p].tag_max_add_2_old=max(tree[p].tag_max_add_2_old,tree[p].tag_max_add_2+k4);\n\t//\u5982\u679c\u5f53\u524d\u533a\u95f4\u7684\u6700\u5927\u503c\u52a0\u4e0a\u6700\u5927\u7684\u5386\u53f2\u6700\u5927\u503c\u8981\u52a0\u7684\u6570\u5927\u4e8e\u539f\u6765\u7684\u6700\u5927\u7684\u5386\u53f2\u6700\u5927\u503c\uff0c\u5c31\u5c06\u503c\u66f4\u65b0\u3002\u5982\u679c\u503c\u66f4\u65b0\u4e86\uff0c\u8bf4\u660e\u6700\u5927\u7684\u5386\u53f2\u6700\u5927\u503c\u53d8\u4e86\uff0c\u90a3\u4e48\u61d2\u6807\u8bb0\u80af\u5b9a\u4e5f\u8981\u53d8\u3002\u6700\u540e\u8fd8\u8981\u66f4\u65b0\u666e\u901a\u7684\u5386\u53f2\u6700\u5927\u503c\u7684\u61d2\u6807\u8bb0\n\ttree[p].tag_max_add_1+=k1;//\u66f4\u65b0\u533a\u95f4\u6700\u5927\u503clazy_tag \n\ttree[p].tag_max_1+=k1;//\u66f4\u65b0\u533a\u95f4\u6700\u5927\u503c \n\ttree[p].tag_max_2+=k3;//\u66f4\u65b0\u975e\u533a\u95f4\u6700\u5927\u503c \n\ttree[p].tag_max_add_2+=k3;//\u66f4\u65b0\u975e\u533a\u95f4\u6700\u5927\u503clazy_tag \n\tif(tree[p].tag_max_2!=-1e18)tree[p].tag_max_2_old+=k3;//\u5982\u679c\u5f53\u524d\u533a\u95f4\u6709\u6b21\u5927\u503c\uff0c\u90a3\u4e48\u6b21\u5927\u503c\u52a0\u4e0a\u666e\u901alazy_tag \n}\nvoid push_down(int p){//\u4e0b\u4f20\u61d2\u6807\u8bb0 \n\tint maxn=max(tree[lc].tag_max_1,tree[rc].tag_max_1);//\u53d6\u51fa\u533a\u95f4\u6700\u5927\u503c \n\tif(tree[lc].tag_max_1==maxn){//\u5982\u679c\u533a\u95f4\u6700\u5927\u503c\u4f4d\u4e8e\u5de6\u533a\u95f4 \n\t\tupdate(tree[p].tag_max_add_1,tree[p].tag_max_add_1_old,tree[p].tag_max_add_2,tree[p].tag_max_add_2_old,lc);\n\t\t//\u5411\u53f3\u513f\u5b50\u4f20\u9012\u6700\u5927\u503clazy_tag \n\t}else{\n\t\tupdate(tree[p].tag_max_add_2,tree[p].tag_max_add_2_old,tree[p].tag_max_add_2,tree[p].tag_max_add_2_old,lc);\n\t\t//\u5426\u5219\u5411\u53f3\u513f\u5b50\u4f20\u9012\u975e\u6700\u5927\u503clazy_tag \n\t} \n\tif(tree[rc].tag_max_1==maxn){//\u5982\u679c\u533a\u95f4\u6700\u5927\u503c\u4f4d\u4e8e\u53f3\u533a\u95f4 \n\t\tupdate(tree[p].tag_max_add_1,tree[p].tag_max_add_1_old,tree[p].tag_max_add_2,tree[p].tag_max_add_2_old,rc);\n\t\t//\u5411\u5de6\u513f\u5b50\u4f20\u9012\u533a\u95f4\u6700\u5927\u503clazy_tag \n\t}else{\n\t\tupdate(tree[p].tag_max_add_2,tree[p].tag_max_add_2_old,tree[p].tag_max_add_2,tree[p].tag_max_add_2_old,rc);\n\t\t//\u5426\u5219\u5411\u53f3\u513f\u5b50\u4f20\u9012\u975e\u6700\u5927\u503clazy_tag\n\t}\n\ttree[p].tag_max_add_1=tree[p].tag_max_add_1_old=tree[p].tag_max_add_2=tree[p].tag_max_add_2_old=0;\n\t//\u6e05\u9664lazy_tag \n}\n```\n## 5.\u533a\u95f4\u52a0:\n\u4e0e\u6a21\u677f\u4e00\u7684\u5b9e\u73b0\u6709\u4e00\u4e9b\u7ec6\u5fae\u7684\u5dee\u522b\uff0c\u4e0d\u8fc7\u8fd8\u662f\u5f88\u5bb9\u6613\u89e3\u51b3\u3002\n### code\uff1a\n```cpp\nvoid change_1(int p){//\u533a\u95f4\u52a0 \n\tif(tree[p].l>r||tree[p].r<l) return;//\u5982\u679c\u5f53\u524d\u533a\u95f4\u4e0d\u5728\u76ee\u6807\u8303\u56f4\u5185\uff0c\u76f4\u63a5\u8fd4\u56de \n\tif(l<=tree[p].l&&tree[p].r<=r){//\u5982\u679c\u5f53\u524d\u533a\u95f4\u5728\u5b8c\u5168\u5728\u76ee\u6807\u8303\u56f4\u5185 \n\t\tupdate(k,k,k,k,p);//\u66f4\u65b0\u503c\u548clazy_tag \n\t\treturn; //\u8fd4\u56de \n\t}\n\tpush_down(p);//\u4e0b\u4f20lazy_tag \n\tchange_1(lc),change_1(rc);//\u5206\u5de6\u53f3\u9012\u5f52 \n\tpush_up(p);//\u5408\u5e76\u533a\u95f4 \n}\n```\n## 6.\u533a\u95f4 $min$ \u8fd0\u7b97\uff1a\n\u5c31\u662f\u8fd9\u4e2a\u5730\u65b9\u5361\u4e86\u6211\u597d\u4e45\uff0c\u7136\u9e45\u6700\u540e\u53d1\u73b0\u6253\u9519\u4e86\u4e00\u4e2a\u4e0b\u6807\u3002\u3002\u3002\n### code\uff1a\n```cpp\nvoid change_2(int p){//\u533a\u95f4min\u4fee\u6539 \n\tif(tree[p].l>r||tree[p].r<l||k>=tree[p].tag_max_1)return;//\u5982\u679c\u5f53\u524d\u8282\u70b9\u4e0d\u5728\u76ee\u6807\u8303\u56f4\u5185\uff0c\u6216\u8005\u662f\u533a\u95f4\u6700\u5927\u503c\u90fd\u6bd4min\u6570\u5c0f\uff0c\u5c31\u6ca1\u6709\u7ee7\u7eed\u9012\u5f52\u4e0b\u53bb\u7684\u5fc5\u8981\u4e86 \n\tif(l<=tree[p].l&&tree[p].r<=r&&k>tree[p].tag_max_2){//\u5982\u679c\u5f53\u524d\u533a\u95f4\u5728\u8303\u56f4\u5185\uff0c\u4e14min\u6570\u6bd4\u6b21\u5927\u503c\u5927 \n\t    update(k-tree[p].tag_max_1,k-tree[p].tag_max_1,0,0,p);//\u5219\u4e0b\u4f20lazy_tag \n\t\treturn;\n\t}\n\tpush_down(p);//\u4e0b\u4f20lazy_tag \n\tchange_2(lc),change_2(rc);//\u9012\u5f52\u5de6\u53f3\u533a\u95f4 \n\tpush_up(p);//\u66f4\u65b0\u533a\u95f4 \n}\n```\n## 7.\u533a\u95f4\u6c42\u548c\uff1a\n\u4e0e\u524d\u9762\u7684\u4e00\u6a21\u4e00\u6837\u5566\u5566\u5566~\u3002\n### code\uff1a\n```cpp\nint ask_1(int p){//\u533a\u95f4\u6c42\u548c \n\tif(tree[p].l>r||tree[p].r<l)return 0;//\u5982\u679c\u5f53\u524d\u8282\u70b9\u5728\u76ee\u6807\u8303\u56f4\u4e4b\u5916\uff0c\u76f4\u63a5\u8fd4\u56de0\uff0c\u4e0d\u5f71\u54cd\u533a\u95f4\u6c42\u548c \n\tif(l<=tree[p].l&&tree[p].r<=r)return tree[p].data;//\u5982\u679c\u5f53\u524d\u533a\u95f4\u5b8c\u5168\u5728\u8303\u56f4\u4e4b\u5185\uff0c\u76f4\u63a5\u8fd4\u56de\u5f53\u524d\u533a\u95f4\u548c \n\tpush_down(p);//\u5982\u679c\u6709\u79ef\u538b\u7684\u5de5\u4f5c\uff0c\u76f4\u63a5\u901a\u8fc7\u4e0b\u4f20lazy_tag\u7684\u65b9\u5f0f\u505a\u5b8c \n\treturn ask_1(lc)+ask_1(rc);//\u8fd4\u56de\u5de6\u533a\u95f4\u4e0e\u53f3\u533a\u95f4\u7684\u548c \n}\n```\n## 8.\u533a\u95f4\u6c42\u6700\u5927\u503c\uff1a\n\u628a $ask\\_1$ \u91cc\u7684\u8fd4\u56de\u533a\u95f4\u548c\u53d8\u4e3a\u8fd4\u56de\u5de6\u53f3\u533a\u95f4\u6700\u5927\u503c\u7684\u6700\u5927\u503c\u5c31\u53ef\u4ee5\u4e86\u3002\u5982\u679c\u8d8a\u754c\u7684\u8bdd\u5fc5\u987b\u8fd4\u56de\u8d1f\u65e0\u7a77\uff0c\u5426\u5219\u6709\u53ef\u80fd\u4f1a\u9519\u3002\n### code\uff1a\n```cpp\nint ask_2(int p){//\u6c42\u533a\u95f4\u6700\u5927\u503c \n\tif(tree[p].l>r||tree[p].r<l)return -1e18;//\u5982\u679c\u5f53\u524d\u8282\u70b9\u5728\u76ee\u6807\u8303\u56f4\u4e4b\u5916\uff0c\u76f4\u63a5\u8fd4\u56de\u65e0\u7a77\u5c0f\uff0c\u4e0d\u5f71\u54cd\u6c42\u533a\u95f4\u6700\u5927\u503c \n\tif(l<=tree[p].l&&tree[p].r<=r)return tree[p].tag_max_1;//\u5982\u679c\u5f53\u524d\u533a\u95f4\u5b8c\u5168\u5728\u8303\u56f4\u4e4b\u5185\uff0c\u76f4\u63a5\u8fd4\u56de\u5f53\u524d\u533a\u95f4\u6700\u5927\u503c \n\tpush_down(p);//\u5982\u679c\u6709\u79ef\u538b\u7684\u5de5\u4f5c\uff0c\u76f4\u63a5\u901a\u8fc7\u4e0b\u4f20lazy_tag\u7684\u65b9\u5f0f\u505a\u5b8c  \n\treturn max(ask_2(lc),ask_2(rc));//\u8fd4\u56de\u5de6\u533a\u95f4\u4e0e\u53f3\u533a\u95f4\u7684\u533a\u95f4\u6700\u5927\u503c\u7684\u6700\u5927\u503c \n}\n```\n## 9.\u533a\u95f4\u6c42\u5386\u53f2\u6700\u5927\u503c\uff1a\n\u628a $ask\\_2$ \u91cc\u7684 $return\\ tree[p].tag\\_max\\_1;$ \u6539\u6210 $return\\ tree[p].tag\\_max\\_1\\_old;$ \u5c31\u53ef\u4ee5\u4e86\u3002\n### code\uff1a\n```cpp\nint ask_3(int p){//\u6c42\u533a\u95f4\u5386\u53f2\u6700\u5927\u503c \n\tif(tree[p].l>r||tree[p].r<l)return -1e18;//\u5982\u679c\u5f53\u524d\u8282\u70b9\u5728\u76ee\u6807\u8303\u56f4\u4e4b\u5916\uff0c\u76f4\u63a5\u8fd4\u56de\u65e0\u7a77\u5c0f\uff0c\u4e0d\u5f71\u54cd\u6c42\u533a\u95f4\u5386\u53f2\u6700\u5927\u503c\n\tif(l<=tree[p].l&&tree[p].r<=r)return tree[p].tag_max_1_old;//\u5982\u679c\u5f53\u524d\u533a\u95f4\u5b8c\u5168\u5728\u8303\u56f4\u4e4b\u5185\uff0c\u76f4\u63a5\u8fd4\u56de\u5f53\u524d\u533a\u95f4\u5386\u53f2\u6700\u5927\u503c \n\tpush_down(p);//\u5982\u679c\u6709\u79ef\u538b\u7684\u5de5\u4f5c\uff0c\u76f4\u63a5\u901a\u8fc7\u4e0b\u4f20lazy_tag\u7684\u65b9\u5f0f\u505a\u5b8c\n\treturn max(ask_3(lc),ask_3(rc));//\u8fd4\u56de\u5de6\u533a\u95f4\u4e0e\u53f3\u533a\u95f4\u7684\u533a\u95f4\u5386\u53f2\u6700\u5927\u503c\u7684\u6700\u5927\u503c \n}\n```\n# \u6700\u540e\u9001\u4e0a $AC$ \u4ee3\u7801\u795d\u5927\u5bb6 $CSP\\ rp++$!\n```cpp\n#include<bits/stdc++.h>\n#define int long long\n#define lc p*2\n#define rc p*2+1\nusing namespace std;\nint n,m,k,o,l,r;\nint a[10000005];\nstruct node{\n\tint l;//\u5de6\u7aef\u70b9 \n\tint r;//\u53f3\u7aef\u70b9 \n\tint data;//\u533a\u95f4\u548c \n\tint tag_max_1;//\u533a\u95f4\u6700\u5927\u503c \n\tint tag_max_add_1;//\u533a\u95f4\u6700\u5927\u503clazy_tag \n\tint tag_max_2;//\u533a\u95f4\u6b21\u5927\u503c \n\tint tag_max_add_2;//\u533a\u95f4\u975e\u6700\u5927\u503clazy_tag \n\tint tag_max_1_old;//\u533a\u95f4\u5386\u53f2\u6700\u5927\u503c \n\tint tag_max_add_1_old;//\u533a\u95f4\u5386\u53f2\u6700\u5927\u503clazy_tag \n\tint tag_max_2_old;//\u533a\u95f4\u5386\u53f2\u6b21\u5927\u503c \n\tint tag_max_add_2_old;//\u533a\u95f4\u5386\u53f2\u975e\u6700\u5927\u503clazy_tag \n\tint tag_max_cnt;//\u6700\u5927\u503c\u7684\u4e2a\u6570 \n}tree[1000005*4];\nint read(){\n    char c=getchar();int s=0,f=1;\n    for(;!isdigit(c);c=getchar())if(c=='-')f=-1;\n    for(;isdigit(c);c=getchar())s=s*10+c-48;\n    return s*f;\n}//\u8bfb\u5165\u4f18\u5316 \nvoid push_up(int p){//\u5408\u5e76\u533a\u95f4 \n\ttree[p].tag_max_1=max(tree[lc].tag_max_1,tree[rc].tag_max_1);//\u66f4\u65b0\u533a\u95f4\u6700\u5927\u503c \n\ttree[p].tag_max_1_old=max(tree[lc].tag_max_1_old,tree[rc].tag_max_1_old);//\u66f4\u65b0\u5386\u53f2\u533a\u95f4\u6700\u5927\u503c \n\ttree[p].data=tree[lc].data+tree[rc].data;//\u66f4\u65b0\u533a\u95f4\u548c \n\tif(tree[lc].tag_max_1==tree[rc].tag_max_1){//\u5982\u679c\u6574\u4e2a\u533a\u95f4\u6700\u5927\u503c\u4e24\u8fb9\u90fd\u6709 \n\t\ttree[p].tag_max_2=max(tree[lc].tag_max_2,tree[rc].tag_max_2);//\u66f4\u65b0\u533a\u95f4\u6b21\u5927\u503c\u4e3a\u4e24\u8fb9\u6b21\u5927\u503c\u4e2d\u7684\u6700\u5927\u503c \n\t\ttree[p].tag_max_cnt=tree[lc].tag_max_cnt+tree[rc].tag_max_cnt;//\u66f4\u65b0\u533a\u95f4\u6700\u5927\u503c\u4e2a\u6570\u4e3a\u4e24\u8fb9\u6700\u5927\u503c\u4e2a\u6570\u4e4b\u548c \n\t}\n\tif(tree[lc].tag_max_1>tree[rc].tag_max_1){//\u5982\u679c\u533a\u95f4\u6700\u5927\u503c\u4f4d\u4e8e\u5de6\u8fb9 \n\t\ttree[p].tag_max_2=max(tree[lc].tag_max_2,tree[rc].tag_max_1);//\u66f4\u65b0\u533a\u95f4\u6b21\u5927\u503c\u4e3a\u5de6\u8fb9\u6b21\u5927\u503c\u4e0e\u53f3\u8fb9\u6700\u5927\u503c\u4e2d\u7684\u6700\u5927\u503c \n\t\ttree[p].tag_max_cnt=tree[lc].tag_max_cnt;//\u6700\u5927\u503c\u4e2a\u6570\u4e3a\u5de6\u8fb9\u6700\u5927\u503c\u7684\u4e2a\u6570 \n\t}\n\tif(tree[lc].tag_max_1<tree[rc].tag_max_1){//\u5982\u679c\u533a\u95f4\u6700\u5927\u503c\u4f4d\u4e8e\u53f3\u8fb9 \n\t\ttree[p].tag_max_2=max(tree[lc].tag_max_1,tree[rc].tag_max_2);//\u533a\u95f4\u6700\u5927\u503c\u4e3a\u5de6\u8fb9\u6700\u5927\u503c\u4e0e\u53f3\u8fb9\u6b21\u5927\u503c\u4e2d\u7684\u6700\u5927\u503c \n\t\ttree[p].tag_max_cnt=tree[rc].tag_max_cnt;//\u533a\u95f4\u6700\u5927\u503c\u4e2a\u6570\u4e3a\u53f3\u8fb9\u6700\u5927\u503c\u7684\u4e2a\u6570 \n\t}\n}\nvoid update(int k1,int k2,int k3,int k4,int p){\n\t//k1\u8868\u793a\u533a\u95f4\u6700\u5927\u503c\u8981\u52a0\u7684\u6570\uff0ck2\u8868\u793a\u5386\u53f2\u6700\u5927\u503c\u8981\u52a0\u7684\u6570\uff0ck3\u8868\u793a\u975e\u6700\u5927\u503c\u8981\u52a0\u7684\u6570\uff0ck4\u8868\u793a\u975e\u5386\u53f2\u6700\u5927\u503c\u6700\u5927\u503c\u8981\u52a0\u7684\u6570 \n\ttree[p].data+=k1*tree[p].tag_max_cnt+k3*(tree[p].r-tree[p].l+1-tree[p].tag_max_cnt);//\u66f4\u65b0\u533a\u95f4\u548c \n\ttree[p].tag_max_1_old=max(tree[p].tag_max_1_old,tree[p].tag_max_1+k2);\n\ttree[p].tag_max_add_1_old=max(tree[p].tag_max_add_1_old,tree[p].tag_max_add_1+k2);\n\ttree[p].tag_max_add_2_old=max(tree[p].tag_max_add_2_old,tree[p].tag_max_add_2+k4);\n\t//\u5982\u679c\u5f53\u524d\u533a\u95f4\u7684\u6700\u5927\u503c\u52a0\u4e0a\u6700\u5927\u7684\u5386\u53f2\u6700\u5927\u503c\u8981\u52a0\u7684\u6570\u5927\u4e8e\u539f\u6765\u7684\u6700\u5927\u7684\u5386\u53f2\u6700\u5927\u503c\uff0c\u5c31\u5c06\u503c\u66f4\u65b0\u3002\u5982\u679c\u503c\u66f4\u65b0\u4e86\uff0c\u8bf4\u660e\u6700\u5927\u7684\u5386\u53f2\u6700\u5927\u503c\u53d8\u4e86\uff0c\u90a3\u4e48\u61d2\u6807\u8bb0\u80af\u5b9a\u4e5f\u8981\u53d8\u3002\u6700\u540e\u8fd8\u8981\u66f4\u65b0\u666e\u901a\u7684\u5386\u53f2\u6700\u5927\u503c\u7684\u61d2\u6807\u8bb0\n\ttree[p].tag_max_add_1+=k1;//\u66f4\u65b0\u533a\u95f4\u6700\u5927\u503clazy_tag \n\ttree[p].tag_max_1+=k1;//\u66f4\u65b0\u533a\u95f4\u6700\u5927\u503c \n\ttree[p].tag_max_2+=k3;//\u66f4\u65b0\u975e\u533a\u95f4\u6700\u5927\u503c \n\ttree[p].tag_max_add_2+=k3;//\u66f4\u65b0\u975e\u533a\u95f4\u6700\u5927\u503clazy_tag \n\tif(tree[p].tag_max_2!=-1e18)tree[p].tag_max_2_old+=k3;//\u5982\u679c\u5f53\u524d\u533a\u95f4\u6709\u6b21\u5927\u503c\uff0c\u90a3\u4e48\u6b21\u5927\u503c\u52a0\u4e0a\u666e\u901alazy_tag \n}\nvoid push_down(int p){//\u4e0b\u4f20\u61d2\u6807\u8bb0 \n\tint maxn=max(tree[lc].tag_max_1,tree[rc].tag_max_1);//\u53d6\u51fa\u533a\u95f4\u6700\u5927\u503c \n\tif(tree[lc].tag_max_1==maxn){//\u5982\u679c\u533a\u95f4\u6700\u5927\u503c\u4f4d\u4e8e\u5de6\u533a\u95f4 \n\t\tupdate(tree[p].tag_max_add_1,tree[p].tag_max_add_1_old,tree[p].tag_max_add_2,tree[p].tag_max_add_2_old,lc);\n\t\t//\u5411\u53f3\u513f\u5b50\u4f20\u9012\u6700\u5927\u503clazy_tag \n\t}else{\n\t\tupdate(tree[p].tag_max_add_2,tree[p].tag_max_add_2_old,tree[p].tag_max_add_2,tree[p].tag_max_add_2_old,lc);\n\t\t//\u5426\u5219\u5411\u53f3\u513f\u5b50\u4f20\u9012\u975e\u6700\u5927\u503clazy_tag \n\t} \n\tif(tree[rc].tag_max_1==maxn){//\u5982\u679c\u533a\u95f4\u6700\u5927\u503c\u4f4d\u4e8e\u53f3\u533a\u95f4 \n\t\tupdate(tree[p].tag_max_add_1,tree[p].tag_max_add_1_old,tree[p].tag_max_add_2,tree[p].tag_max_add_2_old,rc);\n\t\t//\u5411\u5de6\u513f\u5b50\u4f20\u9012\u533a\u95f4\u6700\u5927\u503clazy_tag \n\t}else{\n\t\tupdate(tree[p].tag_max_add_2,tree[p].tag_max_add_2_old,tree[p].tag_max_add_2,tree[p].tag_max_add_2_old,rc);\n\t\t//\u5426\u5219\u5411\u53f3\u513f\u5b50\u4f20\u9012\u975e\u6700\u5927\u503clazy_tag\n\t}\n\ttree[p].tag_max_add_1=tree[p].tag_max_add_1_old=tree[p].tag_max_add_2=tree[p].tag_max_add_2_old=0;\n\t//\u6e05\u9664lazy_tag \n}\nvoid build(int p,int l,int r){//\u5efa\u6811 \n\ttree[p].l=l;//\u5b58\u50a8\u5de6\u7aef\u70b9 \n\ttree[p].r=r;//\u5b58\u50a8\u53f3\u7aef\u70b9 \n\tif(l==r){//\u82e5\u679c\u8bbf\u95ee\u5230\u53f6\u5b50\u8282\u70b9 \n\t\ttree[p].data=a[l];//\u56e0\u4e3a\u5f53\u524d\u8282\u70b9\u53ea\u6709\u4e00\u4e2a\u5143\u7d20\uff0c\u6240\u4ee5\u533a\u95f4\u548c\u4e3a\u5b83\u672c\u8eab \n\t\ttree[p].tag_max_1=a[l];//\u56e0\u4e3a\u5f53\u524d\u533a\u95f4\u53ea\u6709\u4e00\u4e2a\u5143\u7d20\uff0c\u6240\u4ee5\u6700\u5927\u503c\u5c31\u662f\u5b83\u672c\u8eab \n\t\ttree[p].tag_max_1_old=a[l];//\u5386\u53f2\u6700\u5927\u503c\u8d4b\u503c\u4e3a\u5f53\u524d\u5143\u7d20 \n\t\ttree[p].tag_max_2=-1e18;//\u56e0\u4e3a\u5f53\u524d\u533a\u95f4\u53ea\u6709\u4e00\u4e2a\u5143\u7d20\uff0c\u6240\u4ee5\u4e0d\u5b58\u5728\u6b21\u5927\u503c\uff0c\u8d4b\u503c\u4e3a\u65e0\u7a77\u5c0f \n\t\ttree[p].tag_max_cnt=1;//\u6700\u5927\u503c\u53ea\u6709\u4e00\u4e2a\u4e5f\u5c31\u662f\u5b83\u672c\u8eab\n\t\treturn;//\u8fd4\u56de \n\t}\n\tint mid=(l+r)/2;\n\tbuild(lc,l,mid);//\u9012\u5f52\u5efa\u9020\u5de6\u533a\u95f4 \n\tbuild(rc,mid+1,r);//\u9012\u5f52\u5efa\u9020\u53f3\u533a\u95f4 \n\tpush_up(p);//\u5408\u5e76\u533a\u95f4 \n}\nvoid change_1(int p){//\u533a\u95f4\u52a0 \n\tif(tree[p].l>r||tree[p].r<l) return;//\u5982\u679c\u5f53\u524d\u533a\u95f4\u4e0d\u5728\u76ee\u6807\u8303\u56f4\u5185\uff0c\u76f4\u63a5\u8fd4\u56de \n\tif(l<=tree[p].l&&tree[p].r<=r){//\u5982\u679c\u5f53\u524d\u533a\u95f4\u5728\u5b8c\u5168\u5728\u76ee\u6807\u8303\u56f4\u5185 \n\t\tupdate(k,k,k,k,p);//\u66f4\u65b0\u503c\u548clazy_tag \n\t\treturn; //\u8fd4\u56de \n\t}\n\tpush_down(p);//\u4e0b\u4f20lazy_tag \n\tchange_1(lc),change_1(rc);//\u5206\u5de6\u53f3\u9012\u5f52 \n\tpush_up(p);//\u5408\u5e76\u533a\u95f4 \n}\nvoid change_2(int p){//\u533a\u95f4min\u4fee\u6539 \n\tif(tree[p].l>r||tree[p].r<l||k>=tree[p].tag_max_1)return;//\u5982\u679c\u5f53\u524d\u8282\u70b9\u4e0d\u5728\u76ee\u6807\u8303\u56f4\u5185\uff0c\u6216\u8005\u662f\u533a\u95f4\u6700\u5927\u503c\u90fd\u6bd4min\u6570\u5c0f\uff0c\u5c31\u6ca1\u6709\u7ee7\u7eed\u9012\u5f52\u4e0b\u53bb\u7684\u5fc5\u8981\u4e86 \n\tif(l<=tree[p].l&&tree[p].r<=r&&k>tree[p].tag_max_2){//\u5982\u679c\u5f53\u524d\u533a\u95f4\u5728\u8303\u56f4\u5185\uff0c\u4e14min\u6570\u6bd4\u6b21\u5927\u503c\u5927 \n\t    update(k-tree[p].tag_max_1,k-tree[p].tag_max_1,0,0,p);//\u5219\u4e0b\u4f20lazy_tag \n\t\treturn;\n\t}\n\tpush_down(p);//\u4e0b\u4f20lazy_tag \n\tchange_2(lc),change_2(rc);//\u9012\u5f52\u5de6\u53f3\u533a\u95f4 \n\tpush_up(p);//\u66f4\u65b0\u533a\u95f4 \n}\nint ask_1(int p){//\u533a\u95f4\u6c42\u548c \n\tif(tree[p].l>r||tree[p].r<l)return 0;//\u5982\u679c\u5f53\u524d\u8282\u70b9\u5728\u76ee\u6807\u8303\u56f4\u4e4b\u5916\uff0c\u76f4\u63a5\u8fd4\u56de0\uff0c\u4e0d\u5f71\u54cd\u533a\u95f4\u6c42\u548c \n\tif(l<=tree[p].l&&tree[p].r<=r)return tree[p].data;//\u5982\u679c\u5f53\u524d\u533a\u95f4\u5b8c\u5168\u5728\u8303\u56f4\u4e4b\u5185\uff0c\u76f4\u63a5\u8fd4\u56de\u5f53\u524d\u533a\u95f4\u548c \n\tpush_down(p);//\u5982\u679c\u6709\u79ef\u538b\u7684\u5de5\u4f5c\uff0c\u76f4\u63a5\u901a\u8fc7\u4e0b\u4f20lazy_tag\u7684\u65b9\u5f0f\u505a\u5b8c \n\treturn ask_1(lc)+ask_1(rc);//\u8fd4\u56de\u5de6\u533a\u95f4\u4e0e\u53f3\u533a\u95f4\u7684\u548c \n}\nint ask_2(int p){//\u6c42\u533a\u95f4\u6700\u5927\u503c \n\tif(tree[p].l>r||tree[p].r<l)return -1e18;//\u5982\u679c\u5f53\u524d\u8282\u70b9\u5728\u76ee\u6807\u8303\u56f4\u4e4b\u5916\uff0c\u76f4\u63a5\u8fd4\u56de\u65e0\u7a77\u5c0f\uff0c\u4e0d\u5f71\u54cd\u6c42\u533a\u95f4\u6700\u5927\u503c \n\tif(l<=tree[p].l&&tree[p].r<=r)return tree[p].tag_max_1;//\u5982\u679c\u5f53\u524d\u533a\u95f4\u5b8c\u5168\u5728\u8303\u56f4\u4e4b\u5185\uff0c\u76f4\u63a5\u8fd4\u56de\u5f53\u524d\u533a\u95f4\u6700\u5927\u503c \n\tpush_down(p);//\u5982\u679c\u6709\u79ef\u538b\u7684\u5de5\u4f5c\uff0c\u76f4\u63a5\u901a\u8fc7\u4e0b\u4f20lazy_tag\u7684\u65b9\u5f0f\u505a\u5b8c  \n\treturn max(ask_2(lc),ask_2(rc));//\u8fd4\u56de\u5de6\u533a\u95f4\u4e0e\u53f3\u533a\u95f4\u7684\u533a\u95f4\u6700\u5927\u503c\u7684\u6700\u5927\u503c \n}\nint ask_3(int p){//\u6c42\u533a\u95f4\u5386\u53f2\u6700\u5927\u503c \n\tif(tree[p].l>r||tree[p].r<l)return -1e18;//\u5982\u679c\u5f53\u524d\u8282\u70b9\u5728\u76ee\u6807\u8303\u56f4\u4e4b\u5916\uff0c\u76f4\u63a5\u8fd4\u56de\u65e0\u7a77\u5c0f\uff0c\u4e0d\u5f71\u54cd\u6c42\u533a\u95f4\u5386\u53f2\u6700\u5927\u503c\n\tif(l<=tree[p].l&&tree[p].r<=r)return tree[p].tag_max_1_old;//\u5982\u679c\u5f53\u524d\u533a\u95f4\u5b8c\u5168\u5728\u8303\u56f4\u4e4b\u5185\uff0c\u76f4\u63a5\u8fd4\u56de\u5f53\u524d\u533a\u95f4\u5386\u53f2\u6700\u5927\u503c \n\tpush_down(p);//\u5982\u679c\u6709\u79ef\u538b\u7684\u5de5\u4f5c\uff0c\u76f4\u63a5\u901a\u8fc7\u4e0b\u4f20lazy_tag\u7684\u65b9\u5f0f\u505a\u5b8c\n\treturn max(ask_3(lc),ask_3(rc));//\u8fd4\u56de\u5de6\u533a\u95f4\u4e0e\u53f3\u533a\u95f4\u7684\u533a\u95f4\u5386\u53f2\u6700\u5927\u503c\u7684\u6700\u5927\u503c \n}\nsigned main(){\n\tcin>>n>>m;\n\tfor(int i=1;i<=n;i++){\n\t\ta[i]=read();\n\t}\n\t//\u8f93\u5165 \n\tbuild(1,1,n);//\u8c03\u7528\u5efa\u6811\u51fd\u6570 \n\tfor(int i=1;i<=m;i++){\n\t\to=read(),l=read(),r=read();\n\t\tif(o==1)k=read(),change_1(1);\n\t\tif(o==2)k=read(),change_2(1);\n\t\tif(o==3)printf(\"%lld\\n\",ask_1(1));\n\t\tif(o==4)printf(\"%lld\\n\",ask_2(1));\n\t\tif(o==5)printf(\"%lld\\n\",ask_3(1));\n\t}\n\treturn 0;\n} \n```\n\u5b9e\u6d4b\u53ef\u8fdb\u6700\u4f18\u89e3\u7b2c\u4e00\u9875\u3002",
        "postTime": 1602961169,
        "uid": 244165,
        "name": "_121017_",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P6242 \u3010\u3010\u6a21\u677f\u3011\u7ebf\u6bb5\u6811 3\u3011"
    },
    {
        "content": "- \u6709\u4e00\u4e2a\u8457\u540d\u7684 $\\operatorname{checkmin}(l,r,x)$ \u64cd\u4f5c\uff0c\u8868\u793a\u5bf9\u4e8e $l\\le i\\le r$\uff0c\u4f7f\u5f97 $a_i=\\min(a_i,x)$\u3002\n- \u4eca\u5929\u6211\u4eec\u5c31\u8981\u8fd9\u4e2a\u7279\u522b\u7684\u64cd\u4f5c\uff0c\u79f0\u4f5c\u533a\u95f4 $\\text{checkmin}$\u3002\n\n**Task A**\n- \u4fee\u6539\uff1a\u533a\u95f4 $\\operatorname{checkmin}$\u3002\n- \u67e5\u8be2\uff1a\u533a\u95f4\u548c\u3002\n- \u8003\u8651\u5747\u644a\u80fd\u591f\u8fc7\u7684\u505a\u6cd5\u3002\n- \u6bcf\u4e2a\u8282\u70b9\u7ef4\u62a4\u533a\u95f4\u548c $S$\uff0c\u6700\u5927\u503c $Mx$\uff0c\u6b21\u5927\u503c $Se$\uff0c\u6700\u5927\u503c\u51fa\u73b0\u6b21\u6570 $Num$\u3002\n- \u90a3\u4e48\u9012\u5f52\u65f6\u6ee1\u8db3\u4ee5\u4e0b\u4e09\u4e2a\u6761\u4ef6\u4e4b\u4e00\u65f6\u53ef\u4ee5\u505c\u6b62\u9012\u5f52\uff1a\n$$l=r$$\n$$Mx\\le x$$\n$$Se<x<Mx$$\n- \u770b\u8d77\u6765\u5f88\u50cf\u4e71\u641e\u5bf9\u5427\uff0c\u4f46\u5b83\u7684\u805a\u5408\u590d\u6742\u5ea6\u662f $O((n+q)\\log n)$ \u7684\uff0c\u7406\u7531\uff1a\n- \u9996\u5148\u9700\u8981\u9700\u8981\u8003\u8651\u7ebf\u6bb5\u6811\u5b9a\u4f4d\u533a\u95f4\u6240\u5fc5\u987b\u7684 $O(q\\log n)$ \u590d\u6742\u5ea6\uff0c\u8fd9\u91cc\u611f\u8c22 [hgzxgzx](https://www.luogu.com.cn/user/545918) \u548c [bai_tang](https://www.luogu.com.cn/user/817142) \u5728 [\u8fd9\u91cc](https://www.luogu.com.cn/discuss/506677?page=2) \u7684\u6307\u51fa\u9519\u8bef\uff0c\u795d\u613f\u5176\u4fe1\u606f\u5b66\u4e4b\u8def\u5149\u8292\u7480\u74a8\u3002\n- \u4e3a\u5565\uff0c\u54c8\u54c8\uff0c\u6211\u4eec\u5b9a\u4e49 $\\varphi(u)$ \u4e3a\uff1a$u$ \u7684\u5b50\u6811\u4e2d\u6ee1\u8db3\u81ea\u5df1\u7684\u6700\u5927\u503c\u4e0e\u5b83\u7236\u8282\u70b9\u6700\u5927\u503c\u4e0d\u76f8\u7b49\u7684\u8282\u70b9\u4e2a\u6570\u3002\n- \u603b\u52bf\u80fd\uff08\u6240\u6709 $\\varphi(u)$ \u7684\u548c\uff09\u7684\u4e0a\u754c\u663e\u7136\u662f $O(n\\log n)$\u3002\n- $\\text{checkmin}$ \u64cd\u4f5c\u5bf9\u603b\u52bf\u80fd\u7684\u5f71\u54cd\u662f\u663e\u7136\u7684\uff1a\u6bcf\u4e2a\u4e0d\u7ec8\u6b62\u7684\u60c5\u51b5\u90fd\u5e26\u6765\u52bf\u80fd\u7684\u51cf\u5c0f\uff0c\u56e0\u4e3a $x\\le Se<Mx$\u3002\n- \u800c\u6240\u6709 $\\varphi(u)$ \u4e4b\u548c\u662f $O(n\\log n)$ \u7684\uff0c\u800c\u8fd9\u4e5f\u662f\u9012\u5f52\u64cd\u4f5c\u7684\u4e0a\u754c\uff08\u603b\u4e0d\u80fd\u51cf\u5230\u8d1f\u5427\uff09\u3002\n- \u5bf9\u4e86\u6709\u4e2a\u5177\u4f53\u7684\u5b9e\u73b0\u7ec6\u8282\uff1a$Se<x<Mx$ \u7684\u65f6\u5019\u8981\u8bbe\u4e00\u4e2a\u61d2\u6807\u8bb0\u3002\n- \u611f\u8c22[\u5946\u4f6c](https://www.luogu.com.cn/user/371852)\u7684\u63d0\u9192\uff0c\u8877\u5fc3\u795d\u613f\u5176\u4fe1\u606f\u5b66\u4e4b\u8def\u5149\u8292\u7480\u74a8\u3002\n- \u8fd9\u91cc\u7279\u522b\u52a0\u4e00\u4e2a\u63d0\u793a\uff1a$\\varphi(u)$ \u8868\u793a\u7684\u662f\u6574\u4e2a\u5b50\u6811\u7684\u60c5\u51b5\uff0c\u6211\u8bf4\u6bcf\u4e00\u6b21\u64cd\u4f5c\u90fd\u4f1a\u4f7f\u5f97\u52bf\u80fd\u51cf\u5c0f\u7684\u5b9e\u9645\u6307\uff1a\u8fd9\u6574\u4e2a\u5b50\u6811\u5185\u81f3\u5c11\u4f1a\u6709\u4e00\u4e2a\u8282\u70b9\u7531\u4e0d\u7b49\u53d8\u5f97\u7b49\u4e8e\u3002\n- \u4e5f\u53ef\u4ee5\u7406\u89e3\u4e3a\u521d\u59cb\u52bf\u80fd\u4e3a $O(n)$\uff0c\u6bcf\u51cf\u5c11\u4e00\u4e2a\u5355\u4f4d\u7684\u52bf\u80fd\u9700\u8981 $O(\\log n)$ \u7684\u65f6\u95f4\u3002\n\n**Task B**\n- \u4fee\u6539\uff1a\u533a\u95f4 $\\operatorname{checkmin}$\uff0c\u533a\u95f4\u52a0\u3002\n- \u67e5\u8be2\uff1a\u533a\u95f4\u6c42\u548c\u3002\n- \u5982\u679c\u6211\u4eec\u7ef4\u6301\u5148\u524d\u7684\u90a3\u79cd\u7b56\u7565\uff0c\u590d\u6742\u5ea6\u53c8\u662f\u591a\u5c11\u5462\uff1f\u4e0a\u754c\u662f $O(n\\log n+q\\log^2n)$\u3002\n- \u8003\u8651\u533a\u95f4\u52a0\u64cd\u4f5c\u5bf9\u603b\u52bf\u80fd\u7684\u5f71\u54cd\uff1a\u5b83\u53ea\u4f1a\u8ba9 $O(\\log n)$ \u4e2a\u8282\u70b9\u53d7\u5230\u5f71\u54cd\uff0c\u4f46\u5c31\u7b97\u5b83\u4eec\u5168\u90fd\u7531\u4e4b\u524d\u4e0e\u7236\u4eb2\u7684\u6700\u5927\u503c\u4e0d\u4e00\u6837\u53d8\u5f97\u4e00\u6837\uff0c\u90a3\u4e48\u603b\u52bf\u80fd\u6700\u591a\u52a0\u4e0a $O(\\log^2 n)$\uff0c\u540c\u6837\u7684\u539f\u56e0\uff0c\u8fd9\u4e2a\u4e0a\u754c\u8f83\u677e\u3002\n- \u52bf\u80fd\u7684\u603b\u548c\u4e5f\u5c31\u662f\u5b83\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u4e0a\u9650 $O(n\\log n+q\\log^2 n)$\u3002\n- \u5177\u4f53\u5b9e\u73b0\u8fd8\u6709\u4e00\u4e9b\u7ec6\u8282\u5c1a\u5f85\u8ba8\u8bba\uff1a\u56e0\u4e3a\u6211\u4eec\u5e0c\u671b\u5728\u61d2\u6807\u8bb0\u4e92\u76f8\u91cd\u53e0\u7684\u65f6\u5019\u4ecd\u7136\u82df\u4f4f\u4e0d\u4e0b\u4f20\uff08\u5426\u5219\u5927\u6982\u7387\u88ab\u5361\u6210\u66b4\u529b\uff09\uff0c\u90a3\u4e48\u5177\u4f53\u6211\u4eec\u600e\u4e48\u505a\u5462\uff1f\n- \u5bb9\u6613\u53d1\u73b0 $\\text{add}(l,r,a)+\\text{checkmin}(l,r,b)+\\text{add}(l,r,c)$ \u4e0e $\\text{add}(l,r,a+c)+\\text{checkmin}(l,r,b+c)$ \u7b49\u4ef7\u3002\n\n**Task C**\n- \u4fee\u6539\uff1a\u533a\u95f4\u52a0\uff0c\u533a\u95f4\u8986\u76d6\u3002\n- \u67e5\u8be2\uff1a\u533a\u95f4\u6700\u5927\u503c\uff0c\u533a\u95f4\u5386\u53f2\u6700\u5927\u503c\u3002\n- \u589e\u52a0\u4e86\u5947\u602a\u7684\u4e1c\u897f\u5462\u3002\n- [\u8fd8\u597d\u4f5c\u8005\u4e13\u95e8\u5199\u4e86\u535a\u5ba2](https://www.luogu.com.cn/blog/luo1gu1zui1bang1/solution-p4314)\u3002\n- \u4e3b\u8981\u601d\u60f3\u5c31\u662f\u5bf9\u201c\u5386\u53f2\u201d\u4e13\u95e8\u5f00\u61d2\u6807\u8bb0\u3002\n- \u5176\u5b9e\u662f\u5728\u6253\u8fd9\u4e2a\u4e4b\u540e\u5199\u7684\uff08\u5c34\u5c2c\uff09\u3002\n\n**Task D**\n- \u4fee\u6539\uff1a\u533a\u95f4\u52a0\uff0c\u533a\u95f4 $\\text{checkmin}$\u3002\n- \u67e5\u8be2\uff1a\u533a\u95f4\u6c42\u548c\uff0c\u533a\u95f4\u6700\u5927\u503c\uff0c\u533a\u95f4\u5386\u53f2\u6700\u5927\u503c\u3002\n- [\u5c31\u662f\u8fd9\u4e2a\u9898\u76ee](https://www.luogu.com.cn/problem/P6242)\u3002\n- \u4e2a\u4eba\u8ba4\u4e3a\u96be\u5ea6\u6ca1\u6709\u68af\u5ea6\u662f\u8fd9\u9053\u9898\u51e0\u4e4e\u6240\u6709\u5e16\u5b50\u90fd\u662f\u6c42\u52a9\u5e16\u7684\u4e3b\u8981\u539f\u56e0~~\u800c\u4e14\u8fd8\u6ca1\u4eba\u6562\u5e2e\u4f60\u8c03~~\u3002\n- ~~\u8bdd\u8bf4\u539f\u8bba\u6587\u597d\u50cf\u66f4\u52a0\u7325\u7410\u3002~~\n- \u4e0d\u5c31\u662f\u591a\u5408\u4e00\u5957\u5728\u4e00\u8d77\u5417\uff0c\u6211 $\\text{W}$ \u67d0\u4eba\u4f55\u60e7\uff1f\n- \u6027\u8d28\u662f\u7c7b\u4f3c\u7684\uff0c\u800c\u4e14\u533a\u95f4 $\\text{checkmin}$ \u4e4b\u540e\u5386\u53f2\u6700\u5927\u503c\u4e00\u5b9a\u4e0d\u4f1a\u66f4\u65b0\uff0c\u6240\u4ee5\u5b8c\u5168\u4e0d\u9700\u8981\u8bb0\u5f55\u5386\u53f2\u6700\u5927 $\\text{checkmin}$ \u5462\u3002\n- \u4f46\u5386\u53f2\u6700\u5927\u503c\u600e\u4e48\u529e\uff1f\u5982\u679c\u4ecd\u7136\u91c7\u7528\u4e4b\u524d\u7684\u505a\u6cd5\u7684\u8bdd\u6807\u8bb0\u7684\u4e0b\u4f20\u5c31\u4f1a\u51fa\u95ee\u9898\u3002\n- \u53d1\u73b0\u4f5c\u7528\u5728\u8fd9\u4e2a\u7ebf\u6bb5\u4e0a\u7684\u4e00\u5207 $\\text{checkmin}$ \u64cd\u4f5c\u53ea\u4f1a\u5bf9\u8fd9\u4e2a\u70b9\u4e0a\u7684\u6700\u5927\u503c\u6709\u5f71\u54cd\uff0c\u6240\u4ee5\u76f4\u63a5\u628a $\\text{checkmin}$ \u64cd\u4f5c\u6539\u4e3a $\\text{addmax}$ \u6807\u8bb0\uff0c\u610f\u601d\u5c31\u662f\u5bf9\u533a\u95f4\u6700\u5927\u503c\u8fdb\u884c\u7684\u52a0\u51cf\u3002\n- \u90a3\u8fd9\u4e0d\u5c31\u597d\u7ef4\u62a4\u591a\u4e86\u5417\uff1f\n- \u6211\u4eec\u7ef4\u62a4\u56db\u4e2a\u6807\u8bb0\uff1a\u5bf9\u6b21\u5927\u503c\u7684\u52a0\u51cf\uff0c\u5bf9\u6700\u5927\u503c\u7684\u52a0\u51cf\uff0c\u5bf9\u6b21\u5927\u503c\u7684\u52a0\u51cf\u7684\u5386\u53f2\u6700\u5927\u503c\uff0c\u5bf9\u6700\u5927\u503c\u7684\u52a0\u51cf\u7684\u5386\u53f2\u6700\u5927\u503c\u3002\n- \u7136\u540e\u5408\u5e76\u5c31\u5f88\u65e0\u8111\u5f88\u597d\u6253\u4e86\u3002\n\n**\u540e\u8bb0**\n- \u5728\u4f5c\u8005\u771f\u6b63\u6253\u51fa\u6765\u8fd9\u9053\u9898\u76ee\u7684\u65f6\u5019\uff0c\u9898\u89e3\u5df2\u7ecf\u8fc7\u5ba1\u4e00\u6bb5\u65f6\u95f4\u4e86\uff0c\u4f46\u6211\u9700\u8981\u91cd\u65b0\u4f5c\u4e00\u4e9b\u5b9e\u73b0\u7ec6\u8282\u65b9\u9762\u7684\u63d0\u793a\uff1a\n- \u867d\u7136\u590d\u6742\u5ea6\u662f $O(n\\log n+q\\log^2 n)$ \u800c\u4e14\u8dd1\u4e0d\u6ee1\uff0c\u4f46\u7531\u4e8e\u5e38\u89c4\u89e3\u6cd5\u4e00\u5171\u4f7f\u7528 $9$ \u4e2a\u7ebf\u6bb5\u6811\u53d8\u91cf\uff0c\u6240\u4ee5\u5b9e\u9645\u4e0a\u4f1a\u7565\u6709\u5361\u5e38\uff0c\u8bf7\u81ea\u884c\u641c\u7d22\u5361\u5e38\u7684\u76f8\u5173\u77e5\u8bc6\u6216\u8005\u53c2\u7167\u672c\u4ee3\u7801\u7684\u5b9e\u73b0\u3002\n- \u4f5c\u8005\u7531\u4e8e\u5361\u5e38\uff0c\u5c06\u9664\u4e86\u533a\u95f4\u548c\u5916\u7684\u6807\u8bb0\u5168\u90fd\u8bbe\u7f6e\u4e3a $32$ \u4f4d\u6709\u7b26\u53f7\u6574\u6570\uff0c\u53f6\u8282\u70b9\u7684\u6b21\u5c0f\u503c\u53d6 $-2^{31}$\uff0c\u6240\u4ee5\u5982\u679c\u6267\u884c\u5bf9\u6b21\u5c0f\u503c\u7684\u52a0\u6cd5\u5c31\u9700\u8981\u7279\u5224\u3002\n- \u4f5c\u8005\u7531\u4e8e\u5361\u5e38\uff0c\u4e0b\u4f20\u61d2\u60f0\u6807\u8bb0\u7684\u65f6\u5019\u91c7\u53d6\u6bd4\u8f83\u4e24\u5b50\u8282\u70b9\u6bd4\u8f83\u5927\u5c0f\u7684\u65b9\u5f0f\u4e0b\u4f20\uff0c\u8fd9\u662f\u7edd\u5bf9\u4e0d\u53ef\u53d6\u7684\uff01\u56e0\u4e3a\u5df2\u7ecf\u6539\u53d8\u4e86\u8282\u70b9\u7684\u503c\u4e86\uff08\u4e0d\u8fc7\u91c7\u7528\u4e09\u76ee\u6bd4\u8f83\u5c31\u6ca1\u6709\u95ee\u9898\uff09\uff01\n- ~~\u867d\u7136\u4f46\u662f\u627e\u5230\u539f\u8bba\u6587\u4ee3\u7801\u5b9e\u73b0\u4e5f\u770b\u5f97\u5230\u7c7b\u4f3c\u7684\u7ec6\u8282\u5904\u7406\u3002~~\n- [\u4ee3\u7801\u5b9e\u73b0](https://www.luogu.com.cn/paste/0c6kuzw7)\u3002\n- \u5bf9\u4e8e\u6570\u636e\u7ed3\u6784\u6a21\u677f\u6765\u8bf4\uff0c\u7b97\u4e00\u9053\u597d\u9898\u3002\n- \u6700\u540e\uff0c\u7531\u8877\u611f\u8c22 [@Mysterious_Mini](https://www.luogu.com.cn/user/476150) \u7684\u5e2e\u52a9\uff0c\u5e0c\u671b\u5176\u4fe1\u606f\u5b66\u4e4b\u8def\u5149\u8292\u7480\u74a8\u3002",
        "postTime": 1639110436,
        "uid": 260884,
        "name": "WeLikeStudying",
        "ccfLevel": 0,
        "title": "\u3010\u6570\u636e\u7ed3\u6784\u3011segment tree beats"
    },
    {
        "content": "\u4ee5\u524d\u60f3\u505a\u4f46\u662f\u4e0d\u4f1a\u7684\u9898&&\u4e00\u4e2a\u8111\u762b\u624d\u4f1a\u72af\u7684\u9519\u8bef\u6211\u8c03\u4e86\u534a\u5929\\kel\n\n**\u9898\u610f\uff1a**\n\n\u533a\u95f4\u52a0\uff0c\u533a\u95f4\u53d6\u6700\u5c0f\u503c\uff0c\u6c42\u533a\u95f4\u548c\uff0c\u6c42\u533a\u95f4\u6700\u5927\u503c\uff0c\u6c42\u533a\u95f4\u5386\u53f2\u6700\u5927\u503c\u3002\n\n**Soluion\uff1a**\n\n\u8fd9\u663e\u7136\u662f\u628a\u533a\u95f4\u6700\u503c\u64cd\u4f5c\u548c\u533a\u95f4\u5386\u53f2\u6700\u5927\u503c\u63c9\u5728\u4e86\u4e00\u8d77\u3002\n\n**Case 1\uff1a\u533a\u95f4\u6700\u503c\u64cd\u4f5c**\n\n~~\u5409\u53f8\u673a\u7ebf\u6bb5\u6811\uff0c~~ \u7ef4\u62a4\u4e00\u4e2a\u6700\u5927\u503c $Max$ \u548c\u6b21\u5927\u503c $seMax(Second\\ Max)$ \u548c\u6700\u5927\u503c\u7684\u4e2a\u6570 $Maxcnt$\uff0c\u5047\u8bbe\u5bf9\u6bcf\u4e2a\u6570\u53d6 $min(a_i,x)$\uff0c\u90a3\u6211\u4eec\u5728\u4fee\u6539\u65f6\u5224\u65ad\u662f\u5426\u6709 $x\\in[seMax+1,Max-1]$ \u5982\u679c\u662f\u5c31\u6253\u61d2\u60f0\u6807\u8bb0\u3002\u8fd9\u91cc\u6709\u4e2a\u6280\u5de7\u5c31\u662f\u7ef4\u62a4\u4e24\u4e2a\u61d2\u6807\u8bb0 $Addtag$ \u548c $MaxAddtag$\uff0c\u7b2c\u4e8c\u4e2a\u8868\u793a\u7684\u662f\u533a\u95f4\u91cc\u7684\u6700\u5927\u503c\u7684\u52a0\u6cd5\u61d2\u60f0\u6807\u8bb0\uff08\u56e0\u4e3a\u533a\u95f4\u6700\u503c\u64cd\u4f5c\u53ea\u4fee\u6539\u6700\u5927\u503c\uff09\u3002~~\u56de\u5230\u4e0a\u9762~~\uff0c\u5982\u679c $x\\in[seMax+1,Max-1]$ \u662f\u5426\uff0c\u90a3\u5c31\u7ee7\u7eed\u9012\u5f52\uff0c\u8fd9\u4e1c\u897f\u590d\u6742\u5ea6\u662f $O(n\\log^2n)$\uff0c\u7528\u52bf\u80fd\u6cd5\u8bc1\uff08\u6211\u4e0d\u4f1a\uff09\u3002\n\n**Case 2\uff1a\u5386\u53f2\u6700\u5927\u503c**\n\n\u5148\u662f\u5206\u6790\u6027\u8d28\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u7ed3\u70b9\u7684\u72b6\u6001\u5206\u6bb5\uff0c\u53ef\u4ee5\u5c06\u4e00\u6b21\u6807\u8bb0\u4e0b\u4f20\u540e\u5230\u4e0b\u4e00\u6b21\u6807\u8bb0\u4e0b\u4f20\u524d\u4f5c\u4e3a\u4e00\u4e2a\u9636\u6bb5\u3002\n\n\u90a3\u6211\u4eec\u7ef4\u62a4\u4e00\u4e2a $HisAddtag$ \u8868\u793a\u8fd9\u4e00\u9636\u6bb5 $Addtag$ \u7684\u6700\u5927\u503c\uff0c\u4e0b\u4f20\u65f6\u5047\u8bbe\u5b50\u8282\u70b9 $x$\uff0c\u7236\u8282\u70b9 $y,HisAddtag_x=\\max\\{HisAddtag_x,Addtag_x+HisAddtag_y\\},Addtag_x+=Addtag_y$\uff0c\u6700\u5927\u503c\u76f8\u5e94\u66f4\u65b0\u5c31\u884c\u4e86\u3002\n\n**Case 3\uff1a\u5947\u6280\u6deb\u5de7**\n\n$Case\\ 1$ \u91cc\u7684 $Addtag,MaxAddtag,Max,seMax$ \u80af\u5b9a\u8981\u7ef4\u62a4\uff0c $Case\\ 2$ \u91cc\u7684 $Addtag,HisAddtag$ \u548c\u524d\u9762\u7684\u4e24\u4e2a\u61d2\u6807\u8bb0\u878d\u5408\u4e00\u4e0b\uff1a$Addtag,MaxAddtag,HisAddtag,HisMaxAddtag$\uff0c\u8fd9\u56db\u4e2a\u61d2\u6807\u8bb0\u548c\u4e0a\u9762\u5b9a\u4e49\u7684\u540c\u7406\uff0c~~\u62c6\u5206\u5355\u8bcd\u5c31\u884c\u4e86~~\uff0c \u7136\u540e\u4e00\u4e00\u5c06\u4e0a\u9762\u7684\u5904\u7406\u5e26\u8fdb\u53bb\uff0c\u878d\u5408\u7684\u5730\u65b9\u591a\u51e0\u4e2a\u5224\u65ad\u5c31\u884c\u4e86\u3002\n\n\u7ed9\u4e00\u4e2a\u53c8\u957f\u53c8\u81ed\u7684\u4ee3\u7801\uff1a\n\n```cpp\n#include <bits/stdc++.h>\n#define ll long long\nusing namespace std;\nll qr() {\n\tbool f=0;\n\tll x=0;\n\tchar c=getchar();\n\twhile(!isdigit(c)) f|=c=='-',c=getchar();\n\twhile(isdigit(c)) x=(x<<3)+(x<<1)+(c^48),c=getchar();\n\treturn f?~(x-1):x;\n}\nconst ll N=500005;\nstruct node{ll l,r,sum,Max,Maxcnt,seMax,HisMax,Addtag,MaxAddtag,HisAddtag,HisMaxAddtag,lstMax;}tr[N<<2];\nvoid pushup(ll p) {\n\ttr[p].sum=tr[p<<1].sum+tr[p<<1|1].sum;\n\ttr[p].HisMax=max(tr[p<<1].HisMax,tr[p<<1|1].HisMax);\n\tif(tr[p<<1].Max>tr[p<<1|1].Max) tr[p].Max=tr[p<<1].Max,tr[p].seMax=max(tr[p<<1].seMax,tr[p<<1|1].Max),tr[p].Maxcnt=tr[p<<1].Maxcnt;\n\telse if(tr[p<<1].Max<tr[p<<1|1].Max) tr[p].Max=tr[p<<1|1].Max,tr[p].seMax=max(tr[p<<1].Max,tr[p<<1|1].seMax),tr[p].Maxcnt=tr[p<<1|1].Maxcnt;\n\telse tr[p].Max=tr[p<<1].Max,tr[p].seMax=max(tr[p<<1].seMax,tr[p<<1|1].seMax),tr[p].Maxcnt=tr[p<<1].Maxcnt+tr[p<<1|1].Maxcnt;\n}\nvoid pushdown(ll p) {\n\tll Max1=tr[p<<1].Max,Max2=tr[p<<1|1].Max; \n\ttr[p<<1].HisAddtag=max(tr[p<<1].HisAddtag,tr[p<<1].Addtag+tr[p].HisAddtag);\n\ttr[p<<1].Addtag+=tr[p].Addtag;\n\tif(Max1>=Max2) {\n\t\ttr[p<<1].sum+=(tr[p<<1].r-tr[p<<1].l+1-tr[p<<1].Maxcnt)*tr[p].Addtag+tr[p<<1].Maxcnt*tr[p].MaxAddtag;\n\t\ttr[p<<1].HisMaxAddtag=max(tr[p<<1].HisMaxAddtag,tr[p<<1].MaxAddtag+tr[p].HisMaxAddtag);\n\t\ttr[p<<1].MaxAddtag+=tr[p].MaxAddtag;\n\t\ttr[p<<1].HisMax=max(tr[p<<1].HisMax,tr[p<<1].Max+tr[p].HisMaxAddtag);\n\t\ttr[p<<1].Max+=tr[p].MaxAddtag;\n\t\ttr[p<<1].seMax+=tr[p].Addtag;\n\t}else {\n\t\ttr[p<<1].sum+=(tr[p<<1].r-tr[p<<1].l+1)*tr[p].Addtag;\n\t\ttr[p<<1].HisMaxAddtag=max(tr[p<<1].HisMaxAddtag,tr[p<<1].MaxAddtag+tr[p].HisAddtag);\n\t\ttr[p<<1].MaxAddtag+=tr[p].Addtag;\n\t\ttr[p<<1].HisMax=max(tr[p<<1].HisMax,tr[p<<1].Max+tr[p].HisAddtag);\n\t\ttr[p<<1].Max+=tr[p].Addtag;\n\t\ttr[p<<1].seMax+=tr[p].Addtag;\n\t}\n\ttr[p<<1|1].HisAddtag=max(tr[p<<1|1].HisAddtag,tr[p<<1|1].Addtag+tr[p].HisAddtag);\n\ttr[p<<1|1].Addtag+=tr[p].Addtag;\n\tif(Max2>=Max1) {\n\t\ttr[p<<1|1].sum+=(tr[p<<1|1].r-tr[p<<1|1].l+1-tr[p<<1|1].Maxcnt)*tr[p].Addtag+tr[p<<1|1].Maxcnt*tr[p].MaxAddtag;\n\t\ttr[p<<1|1].HisMaxAddtag=max(tr[p<<1|1].HisMaxAddtag,tr[p<<1|1].MaxAddtag+tr[p].HisMaxAddtag);\n\t\ttr[p<<1|1].MaxAddtag+=tr[p].MaxAddtag;\n\t\ttr[p<<1|1].HisMax=max(tr[p<<1|1].HisMax,tr[p<<1|1].Max+tr[p].HisMaxAddtag);\n\t\ttr[p<<1|1].Max+=tr[p].MaxAddtag;\n\t\ttr[p<<1|1].seMax+=tr[p].Addtag;\n\t}else {\n\t\ttr[p<<1|1].sum+=(tr[p<<1|1].r-tr[p<<1|1].l+1)*tr[p].Addtag;\n\t\ttr[p<<1|1].HisMaxAddtag=max(tr[p<<1|1].HisMaxAddtag,tr[p<<1|1].MaxAddtag+tr[p].HisAddtag);\n\t\ttr[p<<1|1].MaxAddtag+=tr[p].Addtag;\n\t\ttr[p<<1|1].HisMax=max(tr[p<<1|1].HisMax,tr[p<<1|1].Max+tr[p].HisAddtag);\n\t\ttr[p<<1|1].Max+=tr[p].Addtag;\n\t\ttr[p<<1|1].seMax+=tr[p].Addtag;\n\t}\n\ttr[p].Addtag=tr[p].MaxAddtag=0;tr[p].HisAddtag=tr[p].HisMaxAddtag=-1145141919810;\n}\nll l,r,x,n,m;\nvoid build(ll l,ll r,ll p) {\n\ttr[p].l=l,tr[p].r=r,tr[p].Addtag=tr[p].HisAddtag=tr[p].HisMaxAddtag=tr[p].MaxAddtag=0;\n\tif(l==r) {tr[p].HisMax=tr[p].Max=tr[p].sum=qr(),tr[p].seMax=-1145141919810,tr[p].Maxcnt=1;return ;}\n\tll mid=l+r>>1;build(l,mid,p<<1),build(mid+1,r,p<<1|1),pushup(p);\n}\nvoid update1(ll p) {\n\tif(l<=tr[p].l&&tr[p].r<=r) {\n\t\ttr[p].sum+=(tr[p].r-tr[p].l+1)*x,tr[p].Addtag+=x;\n\t\ttr[p].HisAddtag=max(tr[p].HisAddtag,tr[p].Addtag);\n\t\ttr[p].Max+=x,tr[p].seMax+=x,tr[p].MaxAddtag+=x;\n\t\ttr[p].HisMax=max(tr[p].HisMax,tr[p].Max);\n\t\ttr[p].HisMaxAddtag=max(tr[p].HisMaxAddtag,tr[p].MaxAddtag);\n\t\treturn ;\n\t}\n\tpushdown(p);\n\tll mid=tr[p].l+tr[p].r>>1;\n\tif(l<=mid) update1(p<<1);\n\tif(r>mid) update1(p<<1|1);\n\tpushup(p);\n}\nvoid update2(ll p) {\n\tif(tr[p].Max<=x) return ;\n\tif(l<=tr[p].l&&tr[p].r<=r&&tr[p].seMax<x) {\n\t\ttr[p].sum-=tr[p].Maxcnt*(tr[p].Max-x);\n\t\ttr[p].MaxAddtag+=x-tr[p].Max,tr[p].Max=x;\n\t\treturn ;\n\t}\n\tpushdown(p);\n\tll mid=tr[p].l+tr[p].r>>1;\n\tif(l<=mid) update2(p<<1);\n\tif(r>mid) update2(p<<1|1);\n\tpushup(p);\n}\nll getsum(ll p) {\n\tif(l>tr[p].r||r<tr[p].l) return 0;\n\tif(l<=tr[p].l&&tr[p].r<=r) return tr[p].sum;\n\tpushdown(p);\n\treturn getsum(p<<1)+getsum(p<<1|1);\n}\nll getnowmax(ll p) {\n\tif(l>tr[p].r||r<tr[p].l) return -1145141919810;\n\tif(l<=tr[p].l&&tr[p].r<=r) return tr[p].Max;\n\tpushdown(p);\n\treturn max(getnowmax(p<<1),getnowmax(p<<1|1));\n}\nll getpremax(ll p) {\n\tif(l>tr[p].r||r<tr[p].l) return -1145141919810;\n\tif(l<=tr[p].l&&tr[p].r<=r) return tr[p].HisMax;\n\tpushdown(p);\n\treturn max(getpremax(p<<1),getpremax(p<<1|1));\n}\nint main() {\n\tn=qr(),m=qr();\n\tbuild(1,n,1);\n\tfor(ll i=1,op;i<=m;i++) {\n\t\top=qr();\n\t\tif(op==1) {\n\t\t\tl=qr(),r=qr(),x=qr();\n\t\t\tupdate1(1);\n\t\t}else if(op==2) {\n\t\t\tl=qr(),r=qr(),x=qr();\n\t\t\tupdate2(1);\n\t\t}else if(op==3) {\n\t\t\tl=qr(),r=qr();\n\t\t\tprintf(\"%lld\\n\",getsum(1));\n\t\t}else if(op==4) {\n\t\t\tl=qr(),r=qr();\n\t\t\tprintf(\"%lld\\n\",getnowmax(1));\n\t\t}else {\n\t\t\tl=qr(),r=qr();\n\t\t\tprintf(\"%lld\\n\",getpremax(1));\n\t\t}\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1646490681,
        "uid": 383791,
        "name": "Others",
        "ccfLevel": 7,
        "title": "P6242 \u9898\u89e3"
    }
]