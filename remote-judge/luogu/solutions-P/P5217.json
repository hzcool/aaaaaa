[
    {
        "content": "[$\\Huge \\texttt{My Cnblogs}$](https://www.cnblogs.com/Wendigo/p/12899654.html)\n\n---\n\n> [\u6d1b\u8c37P5217 \u8d2b\u7a77](https://www.luogu.com.cn/problem/P5217)\n\n> \u7ed9\u5b9a\u957f\u5ea6\u4e3a $n$ \u7684\u521d\u59cb\u6587\u672c $s$\uff0c\u6709 $m$ \u4e2a\u5982\u4e0b\u64cd\u4f5c\uff1a\n> 1. $\\texttt{I x c}$\uff0c\u5728\u7b2c $x$ \u4e2a\u5b57\u6bcd\u540e\u9762\u63d2\u5165\u4e00\u4e2a $c$\u3002\n> 2. $\\texttt{D x}$\uff0c\u5220\u9664\u7b2c $x$ \u4e2a\u5b57\u6bcd\u3002\n> 3. $\\texttt{R x y}$\uff0c\u53cd\u8f6c\u5f53\u524d\u6587\u672c\u4e2d\u7684\u533a\u95f4 $[x,y]$\u3002\n> 4. $\\texttt{P x}$\uff0c\u8f93\u51fa\u521d\u59cb\u6587\u672c\u4e2d\u7b2c $x$ \u4e2a\u5b57\u6bcd\u5728\u5f53\u524d\u6587\u672c\u4e2d\u7684\u4f4d\u7f6e\u3002\u7279\u522b\u5730\uff0c\u82e5\u4e0d\u5b58\u5728\uff0c\u8f93\u51fa $0$\u3002\n> 5. $\\texttt{T x}$\uff0c\u8f93\u51fa\u5f53\u524d\u6587\u672c\u4e2d\u7b2c $x$ \u4e2a\u5b57\u6bcd\u3002\n> 6. $\\texttt{Q x y}$\uff0c\u8f93\u51fa\u5f53\u524d\u6587\u672c\u4e2d\u533a\u95f4 $[x,y]$ \u5185\u51fa\u73b0\u8fc7\u7684\u5b57\u6bcd\u7684\u79cd\u7c7b\u6570\u3002\n\n> \u6570\u636e\u8303\u56f4\uff1a$1\\le n,m\\le 10^5$\u3002\n\n---\n\u521d\u5b66\u5e73\u8861\u6811\u7684\u849f\u84bb\u592a\u849f\u84bb\u4e86\uff0c\u8fd9\u9898\u505a\u4e86 $5$ \u4e2a\u5c0f\u65f6\u3002\n\n\u849f\u84bb\u662f\u7528 $\\tt fhqTreap$ \u505a\u7684\uff0c\u867d\u7136\u5bf9\u4ed8\u8fd9\u9898 $\\tt Splay$ \u66f4\u81ea\u7136\uff0c\u4f46\u662f $\\tt fhqTreap$ \u4ee3\u7801\u77ed\u3002\n\n---\n- **\u7ef4\u62a4\u8282\u70b9\u4fe1\u606f\uff1a**\n\n```cpp\nconst int N=1e5,T=2e5;\n// N\u4e3a\u521d\u59cb\u6587\u672c\u957f\u5ea6\uff0cT\u4e3a\u5e73\u8861\u6811\u8282\u70b9\u6700\u5927\u4e2a\u6570\nint o[N+7];\n// \u8bb0\u5f55\u6bcf\u4e2a\u521d\u59cb\u6587\u672c\u5b57\u6bcd\u5bf9\u5e94\u7684\u5e73\u8861\u6811\u8282\u70b9\nint sz[T+7],fa[T+7],ls[T+7],rs[T+7],v[T+7],sm[T+7],p[T+7],mk[T+7];\n// sz\uff1a\u8282\u70b9\u7684\u5b50\u6811\u5927\u5c0f\n// fa\uff1a\u8282\u70b9\u7684\u7236\u4eb2\u8282\u70b9\uff0c\u7528\u4e8e4\u64cd\u4f5c\u4e2d\u6c42rank\n// ls/rs\uff1a\u5de6\u53f3\u513f\u5b50\u8282\u70b9\n// v\uff1a\u8be5\u8282\u70b9\u5bf9\u5e94\u7684\u5b57\u6bcd\uff08-'a'\uff09\n// sm\uff1a\u5b50\u6811\u7684\u5b57\u6bcd\u603b\u96c6\u72b6\u538b\uff080<=sm[x]<(1<<26)\uff09\n// p\uff1afhqTreap\u7cbe\u534e\u968f\u673a\u6570\u6743\u503c\uff08\u7528\u4e8e\u7ef4\u62a4\u5806\uff09\n// mk\uff1a\u7ffb\u8f6c\u6807\u8bb0\uff0c\u7528\u4e8e\u89e3\u51b33\u64cd\u4f5c\n```\n---\n- **$\\tt fhqTreap$ \u57fa\u672c\u64cd\u4f5c\uff1a**\n\n```cpp\nvoid up(int x){\n\tif(ls[x]) fa[ls[x]]=x;\n\tif(rs[x]) fa[rs[x]]=x;\n\tsz[x]=sz[ls[x]]+sz[rs[x]]+1;\n\tsm[x]=sm[ls[x]]|sm[rs[x]]|1<<v[x];\n}\nvoid down(int x){if(mk[x]) swap(ls[x],rs[x]),mk[ls[x]]^=1,mk[rs[x]]^=1,mk[x]=0;} \nint wen(int x,int y=rand()){return v[++cnt]=x,p[cnt]=y,up(cnt),cnt;}\nint merge(int x,int y){\n\tif(!x||!y) return x^y;\n\tif(p[x]<p[y]) return down(x),rs[x]=merge(rs[x],y),up(x),x;\n\treturn down(y),ls[y]=merge(x,ls[y]),up(y),y;\n}\nvoid split(int u,int k,int&x,int&y){\n\tif(!u) return void(x=y=0);\n\tdown(u); //\u8fd9\u4e1c\u897f\u4e00\u5b9a\u8981\u5199\u5728\u8fd9\u91cc\uff0c\u8981\u4e0d\u7136\u4e0d\u77e5\u9053ls[u]\u662f\u4e0d\u662f\u771f\u7684ls[u]\n\tif(k<=sz[ls[u]]) y=u,split(ls[y],k,x,ls[y]),fa[x]=0;\n\telse x=u,split(rs[x],k-sz[ls[u]]-1,rs[x],y),fa[y]=0;\n\tup(u);\n}\n```\n\n---\n\n- **\u9898\u76ee\u4e2d\u7684\u64cd\u4f5c\uff1a**\n\n**$\\color{#44a897}{\\texttt{[0]}}$ \u63d2\u5165\u6587\u672c\uff1a** \u91ce\u86ee $\\tt merge$\u3002\n\n```cpp\nfor(int i=1;i<=n;i++) rt=merge(rt,o[i]=wen(s[i]-'a'));\n```\n\n**$\\color{#44a897}{\\texttt{[1]}}$ \u63d2\u5165\u5b57\u7b26\uff1a** \u5957\u8def $\\tt split$\uff0c\u5957\u8def $\\tt merge$\u3002\n\n```cpp\nscanf(\"%d %s\",&a,&c[1]);\nsplit(rt,a,L,R);\nrt=merge(merge(L,wen(c[1]-'a')),R);\n```\n\n**$\\color{#44a897}{\\texttt{[2]}}$ \u5220\u9664\u5b57\u7b26\uff1a** \u5148\u628a\u8282\u70b9\u5206\u88c2\u51fa\u6765\uff0c\u7136\u540e\u628a\u4e24\u8fb9\u5408\u5e76\u3002\u4e3a\u4e86\u64cd\u4f5c $4$ \u53ef\u4ee5\u770b\u51fa\u4e00\u4e2a\u70b9\u662f\u5426\u88ab\u5220\uff0c\u5728\u88ab\u5220\u8282\u70b9\u6743\u503c\u4e0a\u505a\u6807\u8bb0\u3002\n\n```cpp\nscanf(\"%d\",&a);\nsplit(rt,a,L,R),split(L,a-1,L,M);\nv[M]=-1,rt=merge(L,R);\n```\n\n**$\\color{#44a897}{\\texttt{[3]}}$ \u7ffb\u8f6c\u533a\u95f4\uff1a** \u5148\u628a\u533a\u95f4\u5206\u88c2\u51fa\u6765\uff0c\u7136\u540e\u6253\u7ffb\u8f6c\u6807\u8bb0\uff0c\u6700\u540e\u4e0d\u5fd8\u628a\u6811\u5408\u56de\u53bb\u3002\n\n```cpp\nscanf(\"%d%d\",&a,&b);\nsplit(rt,b,L,R),split(L,a-1,L,M);\nmk[M]^=1,rt=merge(merge(L,M),R);\n```\n\n**$\\color{#44a897}{\\texttt{[4]}}$ \u67e5\u8be2\u6392\u540d\uff1a** \u5982\u679c\u8282\u70b9\u6743\u503c\u6709\u5220\u9664\u6807\u8bb0\u8f93\u51fa $0$\u3002\u5426\u5219\u5148\u628a\u8282\u70b9\u5230\u6839\u7684\u8def\u5f84**\u4ece\u4e0a\u5230\u4e0b**\u4e0b\u653e\u6807\u8bb0\uff0c\u7136\u540e**\u4ece\u4e0b\u5411\u4e0a**\u6c42\u8be5\u8282\u70b9\u524d\u9762\u7684\u8282\u70b9\u6570\u3002\n\n```cpp\nvoid updown(int x){if(fa[x]) updown(fa[x]);down(x);}\nint frank(int x){\n\tupdown(x);\n\tint res=sz[ls[x]]+1;\n\tfor(int i=x;fa[i];i=fa[i])if(rs[fa[i]]==i) res+=sz[ls[fa[i]]]+1;\n\treturn res;\n}\n\nscanf(\"%d\",&a);\nif(v[o[a]]==-1) puts(\"0\");\nelse printf(\"%d\\n\",frank(o[a]));\n```\n\n**$\\color{#44a897}{\\texttt{[5]}}$ \u8f93\u51fa\u4f4d\u7f6e\u5b57\u6bcd\uff1a** \u76f8\u5f53\u4e8e\u6c42\u4e2a $\\tt kth$\uff0c\u53ef\u4ee5\u5957\u8def $\\tt split$ \u6c42\u3002\n\n```cpp\nscanf(\"%d\",&a);\nsplit(rt,a,L,R),split(L,a-1,L,M);\nprintf(\"%c\\n\",'a'+v[M]);\nrt=merge(merge(L,M),R);\n```\n\n**$\\color{#44a897}{\\texttt{[6]}}$ \u533a\u95f4\u5b57\u6bcd\u79cd\u7c7b\uff1a** \u5148\u628a\u533a\u95f4\u5206\u88c2\u51fa\u6765\uff0c\u7b54\u6848\u5373\u5206\u88c2\u51fa\u7684\u6839\u8282\u70b9\u7684\u5b50\u6811\u5b57\u6bcd\u96c6\u72b6\u538b\u4e2d\u7684 $1$ \u7684\u4e2a\u6570\u3002\n\n```cpp\nscanf(\"%d%d\",&a,&b);\nsplit(rt,b,L,R),split(L,a-1,L,M);\nprintf(\"%d\\n\",bit(sm[M])),rt=merge(merge(L,M),R);\n```\n---\n- **\u8c03\u8bd5\u4e0e\u89e3\u91ca**\n\n**$\\color{#efca55}{\\texttt{[1]}}$ \u8f93\u51fa\u5f53\u524d\u5b57\u7b26\u4e32\uff1a** \u6c42\u5e73\u8861\u6811\u7684\u4e2d\u5e8f\u904d\u5386\uff0c\u5199\u4e2a $\\tt Dfs$\u3002\n\n```cpp\nvoid Print(int x){\n\tdown(x);\n\tif(ls[x]) Print(ls[x]);\n//\tprintf(\"[%d<-%d->%d] (sz%d,v[%c],p%d,fa%d)\\n\",ls[x],x,rs[x],sz[x],v[x]+'a',p[x],fa[x]);\n\tprintf(\"%c\",v[x]+'a');\n\tif(rs[x]) Print(rs[x]);\n}\n```\n\n**$\\color{#efca55}{\\texttt{[2]}}$ \u4e3a\u4ec0\u4e48\u6709\u4e9b\u65f6\u5019\u5199\u4e86 $\\tt Print$ \u5c31\u5bf9\u4e86\uff0c\u6ce8\u91ca\u6389\u5c31\u6302\u4e86\uff1a** $\\tt Print$ \u51fd\u6570\u5e2e\u4f60\u628a\u6574\u68f5\u6811\u7684\u7ffb\u8f6c\u6807\u8bb0\u4e0b\u653e\u4e86\uff0c\u5982\u679c\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\u8bf4\u660e\u4f60\u7684\u64cd\u4f5c\u8fc7\u7a0b\u4e2d\u6807\u8bb0\u4e0b\u653e\u4e0d\u5b8c\u5168\u3002\u5982\u679c\u8981\u9a8c\u8bc1\u4f60\u7684\u4ee3\u7801\u9664\u4e86\u6807\u8bb0\u4e0b\u653e\u90fd\u662f\u6b63\u786e\u7684\uff0c\u53ef\u4ee5\u628a $\\tt Print$ \u4e2d\u7684\u8f93\u51fa\u53bb\u6389\uff0c\u6bcf\u6b21\u64cd\u4f5c\u5b8c\u90fd $\\tt Print$\uff0c\u7136\u540e\u4ea4\u4e00\u53d1\uff0c\u5982\u679c $\\tt ac$ \u4e24\u4e2a\u70b9\uff0c$\\tt tle$ \u516b\u4e2a\u70b9\uff0c\u8bf4\u660e\u4f60\u7684\u4ee3\u7801\u9664\u4e86\u6807\u8bb0\u4e0b\u653e\u90fd\u662f\u6b63\u786e\u7684\u3002\n\n---\n\u597d\u4e86\u7ed3\u675f\u4e86\uff0c\u849f\u84bb\u53c8\u5199\u4e86\u4e00\u7bc7\u65e0\u610f\u4e49\u9898\u89e3\uff0c\u653e\u4ee3\u7801\u5427\uff1a\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n\n//Start\ntypedef long long ll;\ntypedef double db;\n#define mp(a,b) make_pair(a,b)\n#define x(a) a.first\n#define y(a) a.second\n#define b(a) a.begin()\n#define e(a) a.end()\n#define sz(a) int((a).size())\n#define pb(a) push_back(a)\nconst int inf=0x3f3f3f3f;\nconst ll INF=0x3f3f3f3f3f3f3f3f;\n\n//Data\nconst int N=1e5,T=2e5;\nint n,m,o[N+7];\nchar s[N+7],c[3];\nint bit(int x){return x?bit(x-(x&-x))+1:0;}\n\n//Fhqtreap\nint rt,cnt,sz[T+7],fa[T+7],ls[T+7],rs[T+7],v[T+7],sm[T+7],p[T+7],mk[T+7];\nvoid up(int x){\n\tif(ls[x]) fa[ls[x]]=x;\n\tif(rs[x]) fa[rs[x]]=x;\n\tsz[x]=sz[ls[x]]+sz[rs[x]]+1;\n\tsm[x]=sm[ls[x]]|sm[rs[x]]|1<<v[x];\n}\nvoid down(int x){if(mk[x]) swap(ls[x],rs[x]),mk[ls[x]]^=1,mk[rs[x]]^=1,mk[x]=0;}\nint wen(int x,int y=rand()){return v[++cnt]=x,p[cnt]=y,up(cnt),cnt;}\nint merge(int x,int y){\n\tif(!x||!y) return x^y;\n\tif(p[x]<p[y]) return down(x),rs[x]=merge(rs[x],y),up(x),x;\n\treturn down(y),ls[y]=merge(x,ls[y]),up(y),y;\n}\nvoid split(int u,int k,int&x,int&y){\n\tif(!u) return void(x=y=0);\n\tdown(u);\n\tif(k<=sz[ls[u]]) y=u,split(ls[y],k,x,ls[y]),fa[x]=0;\n\telse x=u,split(rs[x],k-sz[ls[u]]-1,rs[x],y),fa[y]=0;\n\tup(u);\n}\nvoid updown(int x){if(fa[x]) updown(fa[x]);down(x);}\nint frank(int x){\n\tupdown(x);\n\tint res=sz[ls[x]]+1;\n\tfor(int i=x;fa[i];i=fa[i])if(rs[fa[i]]==i) res+=sz[ls[fa[i]]]+1;\n\treturn res;\n}\nvoid Print(int x){\n\tdown(x);\n\tif(ls[x]) Print(ls[x]);\n//\tprintf(\"[%d<-%d->%d] (sz%d,v[%c],p%d,fa%d)\\n\",ls[x],x,rs[x],sz[x],v[x]+'a',p[x],fa[x]);\n\tprintf(\"%c\",v[x]+'a');\n\tif(rs[x]) Print(rs[x]);\n}\n\n//Main\nint main(){\n\tscanf(\"%d%d\\n%s\",&n,&m,&s[1]);\n\tfor(int i=1;i<=n;i++) rt=merge(rt,o[i]=wen(s[i]-'a'));\n//\tputs(\"now---\");\n//\tPrint(rt); puts(\"\");\n//\tputs(\"++++++\");\n\tfor(int i=1,a,b,L,M,R;i<=m;i++){\n\t\tscanf(\"\\n%s \",&c[1]);\n\t\tif(c[1]=='I'){\n\t\t\tscanf(\"%d %s\",&a,&c[1]);\n\t\t\tsplit(rt,a,L,R);\n\t\t\trt=merge(merge(L,wen(c[1]-'a')),R);\n\t\t} else if(c[1]=='D'){\n\t\t\tscanf(\"%d\",&a);\n\t\t\tsplit(rt,a,L,R),split(L,a-1,L,M);\n\t\t\tv[M]=-1,rt=merge(L,R);\n\t\t} else if(c[1]=='R'){\n\t\t\tscanf(\"%d%d\",&a,&b);\n\t\t\tsplit(rt,b,L,R),split(L,a-1,L,M);\n\t\t\tmk[M]^=1,rt=merge(merge(L,M),R);\n\t\t} else if(c[1]=='P'){\n\t\t\tscanf(\"%d\",&a);\n\t\t\tif(v[o[a]]==-1) puts(\"0\");\n\t\t\telse printf(\"%d\\n\",frank(o[a]));\n\t\t} else if(c[1]=='T'){\n\t\t\tscanf(\"%d\",&a);\n\t\t\tsplit(rt,a,L,R),split(L,a-1,L,M);\n\t\t\tprintf(\"%c\\n\",'a'+v[M]);\n\t\t\trt=merge(merge(L,M),R);\n\t\t} else if(c[1]=='Q'){\n\t\t\tscanf(\"%d%d\",&a,&b);\n\t\t\tsplit(rt,b,L,R),split(L,a-1,L,M);\n\t\t\tprintf(\"%d\\n\",bit(sm[M])),rt=merge(merge(L,M),R);\n\t\t}\n//\t\tputs(\"now---\");\n//\t\tPrint(rt); \n//\t\tputs(\"\");\n//\t\tputs(\"++++++\");\n\t}\n\treturn 0;\n}\n```\n---\n\n**\u795d\u5927\u5bb6\u5b66\u4e60\u6109\u5feb\uff01**\n",
        "postTime": 1589600315,
        "uid": 118365,
        "name": "George1123",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P5217 \u3010\u8d2b\u7a77\u3011"
    },
    {
        "content": "\u672c\u9898\u89e3\u4f7f\u7528 fhq_treap\u3002\n\n\u5e73\u8861\u6811\u5e8f\u5217\u64cd\u4f5c\u677f\u5b50\u9898\uff0c\u52a0\u4e0a\u4e00\u70b9\u72b6\u538b\u6280\u5de7\u3002\n\n[\u4f20\u9001\u95e8qwq](https://www.luogu.com.cn/problem/P5217)\n\n\u9996\u5148\u5e94\u8be5\u4e86\u89e3\u5e73\u8861\u6811\u5e8f\u5217\u64cd\u4f5c\u7684\u57fa\u672c\u5206\u88c2\u65b9\u6cd5\uff0c\u677f\u5b50\u9898\u5e94\u8be5\u662f\u6587\u827a\u5e73\u8861\u6811\u3002\u8fd9\u91cc\u7684\u5206\u88c2\u65b9\u6cd5\u53ef\u4ee5\u7406\u89e3\u4e3a\u201c\u6309\u5927\u5c0f\u5206\u88c2\u201d\u3002\u8fd8\u6709\u5f88\u597d\u7684\u4e00\u70b9\u5c31\u662f\u5982\u679c\u6309\u7167 $k$ \u5206\u88c2\uff0c\u5176\u5b9e\u5206\u88c2\u4e0b\u6765\u7684\u662f\u5e8f\u5217\u4e2d\u5e8f\u7684\u524d $k$ \u4e2a\u5143\u7d20\u3002\n\n\u6ce8\u610f\u5230\u5b57\u6bcd\u6700\u591a\u53ea\u6709 $26$ \u79cd\uff0c\u8003\u8651\u8f6c\u6210\u6570\u5b57\u540e\u72b6\u538b\u3002\u6ce8\u610f\u5408\u5e76\u5b50\u6811\u4fe1\u606f\u7684\u65f6\u5019\u662f\u201c\u6216\u201d\u7684\u5173\u7cfb\u3002\u5982\u679c\u4e00\u4e2a\u8282\u70b9\u4e3a\u6839\u7684\u5b50\u6811\u5185\u6709\u5143\u7d20 $i$\uff0c\u90a3\u4e48\u8fd9\u4e2a\u8282\u70b9\u7684\u72b6\u538b\u4fe1\u606f\u7684\u4e8c\u8fdb\u5236\u4e0b\u7684\u7b2c $i$ \u4f4d\u5c31\u662f $1$\u3002\n\n\u5e9f\u8bdd\u4e0d\u591a\u8bf4\uff0c\u76f4\u63a5\u770b\u64cd\u4f5c\u3002\n\n\uff08\u4ee5\u4e0b\u5185\u5bb9\u6211\u662f\u628a\u5b57\u6bcd\u8f6c\u6210\u6570\u5b57\u4e86\u7684\uff01\u8bf7\u6ce8\u610f\u3002\uff09\n\n\u5148\u628a\u57fa\u672c\u7684\u51fd\u6570\u62ff\u51fa\u6765\u5427\uff0c\u65b9\u4fbf\u7406\u89e3\u3002\n\n### \u5e73\u8861\u6811\u91cc\u7ef4\u62a4\u7684\u4fe1\u606f\uff1a\n\n```\nint v[N];//\u6743\u503c\nint c[N];//\u4fee\u6b63\u503c\nint ls[N];//\u5de6\u513f\u5b50\nint rs[N];//\u53f3\u513f\u5b50\nint fa[N];//\u7236\u4eb2\nint sz[N];//\u5b50\u6811\u5927\u5c0f\nint tag[N];//\u7ffb\u8f6c\u6807\u8bb0\nlong long ans[N];//\u8fd9\u4e2a\u8282\u70b9\u4e3a\u6839\u7684\u5b50\u6811\u5185\u72b6\u538b\u7684\u7ed3\u679c\n```\n\n### split\uff1a\n\n\u53c2\u6570\u8bf4\u660e\uff1a$r$ \u662f\u5f53\u524d\u5904\u7406\u5230\u7684\u6839\uff0c$k$ \u662f\u8981\u5206\u88c2\u8fd9\u68f5\u6811\u7684\u4e2d\u5e8f\u7684\u524d\u591a\u5c11\u4e2a\u6570\u3002$x$ \u662f\u5206\u88c2\u5b8c\u5de6\u6bb5\u7684\u6839\u8282\u70b9\uff0c$y$ \u662f\u5206\u88c2\u5b8c\u53f3\u6bb5\u7684\u6839\u8282\u70b9\u3002$fx$ \u662f\u5206\u88c2\u540e $x$ \u7684\u7236\u4eb2\uff0c$fy$ \u662f\u5206\u88c2\u5b8c $y$ \u7684\u7236\u4eb2\u3002\n\n```\nvoid split(int r,int k,int &x,int &y,int fx,int fy){\n\tif(!r){\n\t\tx=0;\n\t\ty=0;\n\t\treturn;\n\t}\n\tif(tag[r])\n\t\tpush_down(r);\n\tif(sz[ls[r]]>=k){\n\t\ty=r;\n\t\tsplit(ls[r],k,x,ls[r],fx,r);\n\t}\n\telse{\n\t\tx=r;\n\t\tsplit(rs[r],k-sz[ls[r]]-1,rs[r],y,r,fy);\n\t}\n\tupd(r);\n\tif(x)\n\t\tfa[x]=fx;\n\tif(y)\n\t\tfa[y]=fy;\n}\n```\n\n### merge\uff1a\n\n```\nint merge(int r1,int r2){\n\tif(!r1||!r2)\n\t\treturn r1+r2;\n\tif(c[r1]<=c[r2]){\n\t\tif(tag[r1])\n\t\t\tpush_down(r1);\n\t\trs[r1]=merge(rs[r1],r2);\n\t\tfa[rs[r1]]=r1;\n\t\tupd(r1);\n\t\treturn r1;\n\t}\n\telse{\n\t\tif(tag[r2])\n\t\t\tpush_down(r2);\n\t\tls[r2]=merge(r1,ls[r2]);\n\t\tfa[ls[r2]]=r2;\n\t\tupd(r2);\n\t\treturn r2;\n\t}\n}\n```\n\n### \u5efa\u7acb\u65b0\u70b9\uff1a\n\n```\nint newnode(int a){\n\tcnt++;\n\tv[cnt]=a;\n\tc[cnt]=rand();\n\tsz[cnt]=1;\n\tans[cnt]=(1<<a);\n\treturn cnt;\n}\n```\n\n## 1.\u63d2\u5165\u64cd\u4f5c\n\n\u5728 $p$ \u4f4d\u7f6e\u540e\u9762\u63d2\u5165\u6570\u5b57 $a$\u3002\n\n```\nroot=merge(root,newnode(a));\n```\n\n## 2.\u5220\u9664\u64cd\u4f5c\n\n\u5220\u9664\u5e8f\u5217\u4e2d\u7684\u7b2c $p$ \u4e2a\u6570\u5b57\u3002\n\n\u5176\u5b9e\u5c31\u662f\u628a\u901a\u8fc7\u5206\u88c2\u628a $p$ \u4f4d\u7f6e\u7684\u5143\u7d20\u5355\u72ec\u653e\u5230\u4e00\u68f5\u6811\u4e0a\uff0c\u5408\u5e76\u7684\u65f6\u5019\u5ffd\u7565\u8fd9\u68f5\u6811\u5373\u53ef\u3002\u7136\u540e\u628a\u6254\u6389\u7684\u5143\u7d20\u6743\u503c\u6539\u4e3a $-1$\uff0c\u8fd9\u4e48\u505a\u4ee5\u540e\u4f1a\u7528\u3002\n\n```\nsplit(root,p-1,x,z,0,0);\nsplit(z,1,y,z,0,0);\nv[y]=-1;\nroot=merge(x,z);\n```\n\n## 3.\u53cd\u8f6c\u64cd\u4f5c\n\n\u6587\u827a\u5e73\u8861\u6811\u7684\u57fa\u672c\u64cd\u4f5c\u3002\n\n```\nsplit(root,l-1,x,z,0,0);\nsplit(z,r-l+1,y,z,0,0);\ntag[y]^=1;\nswap(ls[y],rs[y]);\nroot=merge(x,merge(y,z));\n```\n\n## 4.\u67e5\u8be2\u4f4d\u7f6e\n\n\u67e5\u8be2\u539f\u5e8f\u5217\u7b2c $p$ \u5404\u5143\u7d20\u73b0\u5728\u5728\u5e8f\u5217\u91cc\u7684\u4f4d\u7f6e\u3002\n\n\u5176\u5b9e\u5c31\u662f\u67e5\u8be2 $p$ \u53f7\u70b9\u7684\u4e2d\u5e8f\u3002\n\n\u5bf9\u4e8e\u65e0\u89e3\uff0c\u5373 $p$ \u53f7\u70b9\u7684\u6743\u503c\u5df2\u7ecf\u88ab\u6539\u4e3a $-1$ \u4e86\uff0c\u76f4\u63a5\u5224\u6389\u3002\uff08\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48\u64cd\u4f5c\u4e8c\u8981\u8fd9\u4e48\u64cd\u4f5c\uff09\n\n\u5bf9\u4e8e\u6709\u89e3\uff0c\u5199\u4e00\u4e2a\u67e5\u8be2\u4e2d\u5e8f\u7684\u51fd\u6570\uff0c\u6ce8\u610f\u67e5\u4e4b\u524d\u8981\u628a\u6839\u8282\u70b9\u5230\u4f60\u67e5\u7684\u4f4d\u7f6e\u8fd9\u6761\u94fe\u4e0a\u7684\u61d2\u6807\u8bb0\u5168\u90fd\u4e0b\u4f20\uff0c\u800c\u4e14\u662f\u81ea\u4e0a\u800c\u4e0b\u7684\u3002\n\n```\nvoid work(int r){//\u4e0b\u4f20\u6807\u8bb0\n\tif(fa[r])\n\t\twork(fa[r]);\n\tif(tag[r])\n\t\tpush_down(r);\n}\nint find(int r){//\u67e5\u8be2\u4e2d\u5e8f\n\twork(r);\n\tint res=sz[ls[r]]+1;\n\twhile(fa[r]){\n\t\tif(rs[fa[r]]==r)\n\t\t\tres+=sz[ls[fa[r]]]+1;\n\t\tr=fa[r];\n\t}\n\treturn res;\n}\n```\n\n## 5.\u67e5\u8be2\u6743\u503c\n\n\u67e5\u8be2 $p$ \u4f4d\u7f6e\u7684\u6743\u503c\u3002\n\n\u901a\u8fc7\u5206\u88c2\u4f7f\u5f97 $p$ \u4f4d\u7f6e\u7684\u5143\u7d20\u5355\u72ec\u4f4d\u4e8e\u4e00\u68f5\u6811\u4e0a\uff0c\u8fd9\u6837\u6211\u4eec\u5c31\u5f97\u5230\u4e86\u5b83\u7684\u7f16\u53f7\uff0c\u8f93\u51fa\u6743\u503c\u5373\u53ef\u3002\n\n```\nsplit(root,p-1,x,z,0,0);\nsplit(z,1,y,z,0,0);\ncout<<char(v[y]+96);\nprintf(\"\\n\");\nroot=merge(x,merge(y,z));\n```\n\n\n## 6.\u67e5\u8be2\u5143\u7d20\u79cd\u7c7b\n\n\u67e5\u8be2\u533a\u95f4 $[x,y]$ \u5185\u7684\u5143\u7d20\u4e2a\u6570\u3002\n\n\u628a\u8fd9\u6bb5\u533a\u95f4\u5206\u88c2\u4e0b\u6765\uff0c\u67e5\u8be2\u8fd9\u68f5\u6811\u7684\u72b6\u538b\u4fe1\u606f\u5373\u53ef\u3002\n\n\u7136\u540e\u7b97\u4e00\u4e0b\u8fd9\u4e2a\u6570\u5b57\u7684\u4e8c\u8fdb\u5236\u91cc\u6709\u591a\u5c11\u4e2a $1$\uff0c\u57fa\u672c\u5e38\u8bc6\u4e86\u3002\n\n```\nsplit(root,r,x,z,0,0);\nsplit(x,l-1,x,y,0,0);\nprintf(\"%d\\n\",calc(ans[y]));\nroot=merge(x,merge(y,z));\n```\n### calc \u4ee5\u53ca lowbit \u51fd\u6570\uff1a\n\n```\nlong long lowbit(long long k){\n\treturn k&(-k);\n}\nint calc(long long k){\n\tint res=0;\n\twhile(k){\n\t\tres++;\n\t\tk-=lowbit(k);\n\t}\n\treturn res;\n}\n```\n\u601d\u8def\u5f88\u6e05\u6670\u4e86\u5427\uff0c\u7ed9\u4e2a\u4ee3\u7801\uff1a\n\n```\n#include<bits/stdc++.h>\nusing namespace std;\nint read(){\n\tint ss=0,ww=1;\n\tchar ch=getchar();\n\twhile(ch<'0'||ch>'9'){\n\t\tif(ch=='-')\n\t\t\tww=-1;\n\t\tch=getchar();\n\t}\n\twhile(ch>='0'&&ch<='9'){\n\t\tss=ss*10+ch-'0';\n\t\tch=getchar();\n\t}\n\treturn ss*ww;\n}\nint n,m;\nconst int N=200010;\nint root,x,y,z;\nint v[N];\nint c[N];\nint ls[N];\nint rs[N];\nint fa[N];\nint sz[N];\nint tag[N];\nint cnt;\nll ans[N];\ntypedef long long ll;\nint newnode(int a){\n\tcnt++;\n\tv[cnt]=a;\n\tc[cnt]=rand();\n\tsz[cnt]=1;\n\tans[cnt]=(1<<a);\n\treturn cnt;\n}\nvoid upd(int r){\n\tsz[r]=sz[ls[r]]+sz[rs[r]]+1;\n\tans[r]=(ans[ls[r]]|ans[rs[r]]|(1<<v[r]));\n}\nvoid push_down(int r){\n\ttag[r]=0;\n\tif(ls[r]){\n\t\ttag[ls[r]]^=1;\n\t\tswap(ls[ls[r]],rs[ls[r]]);\n\t}\n\tif(rs[r]){\n\t\ttag[rs[r]]^=1;\n\t\tswap(ls[rs[r]],rs[rs[r]]);\n\t}\n}\nint merge(int r1,int r2){\n\tif(!r1||!r2)\n\t\treturn r1+r2;\n\tif(c[r1]<=c[r2]){\n\t\tif(tag[r1])\n\t\t\tpush_down(r1);\n\t\trs[r1]=merge(rs[r1],r2);\n\t\tfa[rs[r1]]=r1;\n\t\tupd(r1);\n\t\treturn r1;\n\t}\n\telse{\n\t\tif(tag[r2])\n\t\t\tpush_down(r2);\n\t\tls[r2]=merge(r1,ls[r2]);\n\t\tfa[ls[r2]]=r2;\n\t\tupd(r2);\n\t\treturn r2;\n\t}\n}\nvoid split(int r,int k,int &x,int &y,int fx,int fy){\n\tif(!r){\n\t\tx=0;\n\t\ty=0;\n\t\treturn;\n\t}\n\tif(tag[r])\n\t\tpush_down(r);\n\tif(sz[ls[r]]>=k){\n\t\ty=r;\n\t\tsplit(ls[r],k,x,ls[r],fx,r);\n\t}\n\telse{\n\t\tx=r;\n\t\tsplit(rs[r],k-sz[ls[r]]-1,rs[r],y,r,fy);\n\t}\n\tupd(r);\n\tif(x)\n\t\tfa[x]=fx;\n\tif(y)\n\t\tfa[y]=fy;\n}\nvoid rev(int l,int r){\n\tsplit(root,l-1,x,z,0,0);\n\tsplit(z,r-l+1,y,z,0,0);\n\ttag[y]^=1;\n\tswap(ls[y],rs[y]);\n\troot=merge(x,merge(y,z));\n}\nvoid work(int r){\n\tif(fa[r])\n\t\twork(fa[r]);\n\tif(tag[r])\n\t\tpush_down(r);\n}\nint find(int r){\n\twork(r);\n\tint res=sz[ls[r]]+1;\n\twhile(fa[r]){\n\t\tif(rs[fa[r]]==r)\n\t\t\tres+=sz[ls[fa[r]]]+1;\n\t\tr=fa[r];\n\t}\n\treturn res;\n}\nll lowbit(ll k){\n\treturn k&(-k);\n}\nint calc(ll k){\n\tint res=0;\n\twhile(k){\n\t\tres++;\n\t\tk-=lowbit(k);\n\t}\n\treturn res;\n}\nint main(){\n\tn=read();\n\tm=read();\n\tfor(int i=1;i<=n;i++){\n\t\tchar c;\n\t\tcin>>c;\n\t\tint a=c-96;\n\t\troot=merge(root,newnode(a));\n\t}\n\tfor(int i=1;i<=m;i++){\n\t\tchar opt;\n\t\tcin>>opt;\n\t\tif(opt=='I'){\n\t\t\tint p,a;\n\t\t\tchar c;\n\t\t\tp=read();\n\t\t\tcin>>c;\n\t\t\ta=c-96;\n\t\t\tsplit(root,p,x,y,0,0);\n\t\t\troot=merge(merge(x,newnode(a)),y);\n\t\t}\n\t\tif(opt=='D'){\n\t\t\tint p;\n\t\t\tp=read();\n\t\t\tsplit(root,p-1,x,z,0,0);\n\t\t\tsplit(z,1,y,z,0,0);\n\t\t\tv[y]=-1;\n\t\t\troot=merge(x,z);\n\t\t}\n\t\tif(opt=='R'){\n\t\t\tint l,r;\n\t\t\tl=read();\n\t\t\tr=read();\n\t\t\trev(l,r);\n\t\t//\tprint(root);\n\t\t}\n\t\tif(opt=='P'){\n\t\t\tint p;\n\t\t\tp=read();\n\t\t\tif(v[p]==-1)\n\t\t\t\tprintf(\"0\\n\");\n\t\t\telse\n\t\t\t\tprintf(\"%d\\n\",find(p));\n\t\t}\n\t\tif(opt=='T'){\n\t\t\tint p;\n\t\t\tp=read();\n\t\t\tsplit(root,p-1,x,z,0,0);\n\t\t\tsplit(z,1,y,z,0,0);\n\t\t\tcout<<char(v[y]+96);\n\t\t\tprintf(\"\\n\");\n\t\t\troot=merge(x,merge(y,z));\n\t\t}\n\t\tif(opt=='Q'){\n\t\t\tint l,r;\n\t\t\tl=read();\n\t\t\tr=read();\n\t\t\tsplit(root,r,x,z,0,0);\n\t\t\tsplit(x,l-1,x,y,0,0);\n\t\t\tprintf(\"%d\\n\",calc(ans[y]));\n\t\t\troot=merge(x,merge(y,z));\n\t\t}\n\t}\n\treturn 0;\n}\n\n```\n",
        "postTime": 1645947158,
        "uid": 140360,
        "name": "LKawaii",
        "ccfLevel": 0,
        "title": "P5217\u9898\u89e3"
    },
    {
        "content": "\u6765\u4e00\u53d1$Splay$~~~\n\n\u9996\u5148\u4e00\u4e2a\u4e2a\u64cd\u4f5c\u5206\u6790\uff1a\n\n1. I\u64cd\u4f5c\uff0c$Splay$\u63d2\u5165\u3002\n2. D\u64cd\u4f5c\uff0c$Splay$\u5220\u9664\u3002\n3. R\u64cd\u4f5c\uff0c\u53ef\u4ee5\u53c2\u8003[P3391](https://www.luogu.org/problemnew/show/P3391)\uff0c\u628a$[x,y]$\u4ece\u6811\u4e2d\u5206\u88c2\u51fa\u6765\uff0c\u6253\u6807\u8bb0\n4. P\u64cd\u4f5c\uff0c\u5728\u5efa\u6811\u65f6\u628a$1-n$\u53f7\u5b57\u7b26\u6240\u5728\u7684\u7ed3\u70b9\u7f16\u53f7\u8bb0\u4e0b\u6765\uff0c\u5224\u65ad\u8be5\u70b9\u662f\u5426\u88ab\u5220\u9664\uff08\u5728\u5220\u9664\u65f6\u52a0\u4e2a\u8bb0\u53f7\uff09\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u5148\u628a\u7ed3\u70b9\u4e0a\u65b9\u7684\u6807\u8bb0\u5168\u90e8\u4e0b\u63a8\uff0c\u7136\u540e\u5c06\u7ed3\u70b9\u65cb\u5230\u6839\uff0c\u8f93\u51fa\u6392\u540d\n5. T\u64cd\u4f5c\uff0c\u5c06\u6392\u540d\u7b2c$x$\u7684\u7ed3\u70b9\u65cb\u5230\u6839\n6. Q\u64cd\u4f5c\uff0c\u8003\u8651\u5b57\u6bcd\u53ea\u670926\u4e2a\uff0c\u7528$1,2,...2^{25}$\u72b6\u538b\u7ef4\u62a4\u4e00\u4e0b\uff0c\u8be2\u95ee\u65f6\u540c\u6837\u628a$[x,y]$\u4ece\u6811\u4e2d\u5206\u88c2\u51fa\u6765\uff0c\u8f93\u51fa\n\n\u4e8e\u662f\u63a5\u4e0b\u6765\u5c31\u662f\u4e0a\u6a21\u677f\u4e86~~\uff08\u4f3c\u4e4e\u6211\u5199\u7684\u6700\u957f\uff09~~\n```cpp\n#include<cstdio>\n#include<cctype>\n#define il inline\nconst int N=200050;\nchar rB[1<<21],*S,*T,wB[1<<21];\nint wp=-1;\nil char gc(){return S==T&&(T=(S=rB)+fread(rB,1,1<<21,stdin),S==T)?EOF:*S++;}\nil void flush(){fwrite(wB,1,wp+1,stdout);wp=-1;}\nil void pc(char c){if(wp==(1<<21))flush();wB[++wp]=c;}\nil char rdu(){\n    char c=gc();\n    while(!isupper(c))c=gc();\n    return c;\n}\nil char rdc(){\n    char c=gc();\n    while(!islower(c))c=gc();\n    return c;\n}\nil int rdi(){\n    char c=gc();\n    while(!isdigit(c))c=gc();\n    int x=c&15;\n    for(c=gc();isdigit(c);c=gc())x=(x<<3)+(x<<1)+(c&15);\n    return x;\n}\n//\u5feb\u8bfb\nshort buf[15];\nil void wt(int x){\n    short l=-1;\n    while(x>9){\n        buf[++l]=x%10;\n        x/=10;\n    }\n    pc(x|48);\n    while(l>=0)pc(buf[l--]|48);\n    pc('\\n');\n}\n//\u5feb\u5199\nchar v[N],st[N>>1];\nint pos[N>>1],s[N],fa[N],ch[N][2],f[N],sz=0;\nbool lazy[N];\nil void rds(){  //\u8fd9\u4e2a\u4e5f\u662f\u5feb\u8bfb\n    char c=gc();\n    while(!islower(c))c=gc();\n    st[1]=c;\n    for(int i=2,c=gc();islower(c);i++,c=gc())st[i]=c;\n}\nil void Swap(int &a,int &b){int t=a;a=b;b=t;}\nil short count(int x){  //\u6570x\u4e8c\u8fdb\u5236\u4f4d\u4e2d1\u7684\u4e2a\u6570\uff0c\u5373\u5b57\u7b26\u79cd\u7c7b\u6570\n    short s=0;\n    for(;x;x^=x&-x)s++;\n    return s;\n}\n//\u6a21\u677f\u6765\u4e86\nstruct Splay{\n    int rt;\n    il int newnode(char c){\n        v[++sz]=c;s[sz]=1;fa[sz]=ch[sz][0]=ch[sz][1]=0;f[sz]=1<<c-'a';lazy[sz]=0;\n        return sz;\n    }\n    il void maintain(int o){  //\u7ef4\u62a4\u7ed3\u70b9\u4fe1\u606f\n        s[o]=1+s[ch[o][0]]+s[ch[o][1]];  //\u8be5\u7ed3\u70b9\u5b50\u6811\u5927\u5c0f\n        f[o]=(1<<v[o]-'a')|f[ch[o][0]]|f[ch[o][1]];  //\u8be5\u7ed3\u70b9\u5b50\u6811\u6240\u542b\u5b57\u7b26\u79cd\u7c7b\n    }\n    il void pushdown(int o){  //\u4e0b\u63a8\u61d2\u6807\u8bb0\n        if(lazy[o]){\n            Swap(ch[o][0],ch[o][1]);\n            lazy[ch[o][0]]^=1;lazy[ch[o][1]]^=1;\n            lazy[o]=0;\n        }\n    }\n    il short cmp(int o,char c){  //\u6bd4\u8f83\n        if(v[o]==c)return -1;\n        else return c>v[o];\n    }\n    il bool dir(int o){return ch[fa[o]][1]==o;}  //o\u662f\u5b83\u7236\u4eb2\u7684\u5de6/\u53f3\u513f\u5b50\uff080\u8868\u793a\u5de6\uff0c1\u8868\u793a\u53f3\uff0c\u4ee5\u4e0b\u5747\u540c\uff09\n    il void rotate(int o){  //\u65cb\u8f6c\uff0c\u5c06o\u65cb\u5230\u5b83\u7236\u4eb2\u7684\u4f4d\u7f6e\n        int f=fa[o];\n        short d=dir(o);\n        fa[o]=fa[f];\n        if(f==rt)rt=o;\n        else ch[fa[f]][dir(f)]=o;\n        if(ch[f][d]=ch[o][d^1])fa[ch[f][d]]=f;\n        fa[ch[o][d^1]=f]=o;\n        maintain(f);maintain(o);\n    }\n    il void splay(int o){  //Splay\u6700\u6838\u5fc3\u7684\u5185\u5bb9\uff0c\u5c06o\u65cb\u8f6c\u5230\u6839\n        for(;fa[o];rotate(o))if(fa[fa[o]])rotate(dir(fa[o])==dir(o)?fa[o]:o);\n    }\n    void build(int &o,int L,int R){  //\u5f00\u59cb\u5efa\u4e00\u68f5\u5b8c\u7f8eSplay\n    \tint M=L+R>>1;\n    \to=newnode(st[M]);pos[M]=o;  //P\u64cd\u4f5c\u7528\u7684\u7f16\u53f7\n    \tif(L<M){\n    \t\tbuild(ch[o][0],L,M-1);\n    \t\tfa[ch[o][0]]=o;\n        }\n        if(M<R){\n            build(ch[o][1],M+1,R);\n            fa[ch[o][1]]=o;\n        }\n        maintain(o);\n    }\n    il void find(int k){  //\u627e\u5230\u6392\u540d\u4e3ak\u7684\u7ed3\u70b9\u5e76\u5c06\u5176\u65cb\u5230\u6839\n        int o=rt,t;\n        for(;;){\n            pushdown(o);  //\u6bcf\u8bbf\u95ee\u4e00\u4e2a\u7ed3\u70b9\u90fd\u8981\u8bb0\u5f97\u4e0b\u63a8\u6807\u8bb0\n            t=s[ch[o][0]];\n            if(t+1==k)break;\n            else if(k<=t)o=ch[o][0];\n            else{\n                k-=t+1;\n                o=ch[o][1];\n            }\n        }\n        splay(o);\n    }\n    il int split(bool d){  //\u5c06\u6811\u6839\u7684\u5de6/\u53f3\u513f\u5b50\u5206\u88c2\u51fa\u6765\n        pushdown(rt);\n        int t=ch[rt][d];\n        ch[rt][d]=0;fa[t]=0;\n        maintain(rt);\n        return t;\n    }\n    il void merge(int t,bool d){  //\u5408\u5e76\u5230\u6811\u7684\u6700\u5de6/\u53f3\u4fa7\n        if(!rt)rt=t;\n        else{\n            find(d?s[rt]:1);\n            fa[ch[rt][d]=t]=rt;\n            maintain(rt);\n        }\n    }\n    il void ins(int k,char c){  //I\u64cd\u4f5c\uff0c\u672c\u6765\u53ef\u4ee5\u76f4\u63a5\u7528find\uff0c\u56e0\u4e3a\u5199\u5f97\u65e9\u5fd8\u8bb0\u4e86\n    \tif(!rt)rt=newnode(c);\n    \telse{\n    \t\tint o=rt,t;\n    \t\tfor(;;){\n    \t\t\tpushdown(o);\n    \t\t\tt=s[ch[o][0]];\n    \t\t\tif(t+1==k)break;\n    \t\t\telse if(k<=t)if(ch[o][0])o=ch[o][0];\n    \t\t\telse{  //\u8fd9\u91cc\u6ce8\u610f\u5f53k=0\uff0c\u5373\u63d2\u5728\u6700\u524d\u9762\u65f6\uff0c\u662f\u627e\u4e0d\u5230\u7b2c0\u7ed3\u70b9\u7684\uff0c\u7279\u5224\u4e00\u4e0b\n    \t\t\t\tfa[ch[o][0]=newnode(c)]=o;\n    \t\t\t\tmaintain(o);\n    \t\t\t\tsplay(o);  //\u505a\u5b8c\u64cd\u4f5c\u90fdsplay\u4e00\u4e0b\u53ef\u4ee5\u4fdd\u8bc1\u6811\u7684\u968f\u673a\u6027\n    \t\t\t\treturn;\n                }else{\n                    k-=t+1;\n                    o=ch[o][1];\n                }\n            }\n            splay(o);\n            t=split(1);\n            fa[ch[o][1]=newnode(c)]=o;\n            fa[ch[ch[o][1]][1]=t]=ch[o][1];\n            maintain(ch[o][1]);\n            maintain(o);\n//\u5148\u5c06o\u65cb\u5230\u6839\uff0c\u518d\u5206\u88c2\u53f3\u5b50\u6811\uff0c\u5c06\u65b0\u7ed3\u70b9\u53d8\u6210o\u7684\u53f3\u513f\u5b50\uff0c\u539f\u6765\u7684\u53f3\u5b50\u6811\u53d8\u6210\u65b0\u7ed3\u70b9\u7684\u53f3\u513f\u5b50\uff0c\u5c31\u6210\u529f\u5c06\u65b0\u7ed3\u70b9\u63d2\u5165\u5230o\u7684\u53f3\u4fa7\n        }\n    }\n    il void del(int k){  //D\u64cd\u4f5c\uff0c\u540c\u6837\u53ef\u4ee5\u7528find\u7b80\u5316\n        int o=rt,t;\n        for(;;){\n            pushdown(o);\n            t=s[ch[o][0]];\n            if(t+1==k)break;\n            else if(k<=t)o=ch[o][0];\n            else{\n                k-=t+1;\n                o=ch[o][1];\n            }\n        }\n        splay(o);\n        t=split(1);\n        v[o]='#';  //\u4ee5'#'\u4f5c\u4e3a\u5220\u9664\u6807\u8bb0\n        fa[rt=ch[o][0]]=0;\n        merge(t,1);\n//\u5148\u5c06o\u65cb\u8f6c\u5230\u6839\uff0c\u518d\u5408\u5e76\u5b83\u7684\u5de6\u53f3\u5b50\u6811\n    }\n    void allpush(int o){  //\u5bf9o\u7684\u6240\u6709\u7956\u5148\u505a\u4e0b\u63a8\n        if(o!=rt)allpush(fa[o]);\n        pushdown(o);\n    }\n}tree;\nint main(){\n    int n=rdi(),m=rdi(),x,y,t1,t2;\n    char opt,c;\n    rds();\n    tree.build(tree.rt,1,n);\n    while(m--){\n        opt=rdu();x=rdi();\n        if(opt=='I'){\n            c=rdc();\n            tree.ins(x,c);\n        }else if(opt=='D')tree.del(x);\n        else if(opt=='R'){\n            if((y=rdi())<x)Swap(x,y);\n            tree.find(y);t2=tree.split(1);\n            tree.find(x);t1=tree.split(0);\n//\u5c06\u533a\u95f4[x,y]\u5206\u88c2\u51fa\u6765\uff0c\u5148\u627ex\u7684\u8bddy\u7684\u6392\u540d\u4f1a\u6539\u53d8\uff0c\u4e0d\u5982\u5148\u627ey\u65b9\u4fbf\n            lazy[tree.rt]^=1;\n            tree.merge(t1,0);\n            tree.merge(t2,1);\n        }else if(opt=='P')if(v[pos[x]]=='#'){pc('0');pc('\\n');}\n        else{\n            tree.allpush(pos[x]);\n            tree.splay(pos[x]);\n            wt(s[ch[tree.rt][0]]+1);\n        }else if(opt=='T'){\n            tree.find(x);\n            pc(v[tree.rt]);pc('\\n');\n        }else if(opt=='Q'){\n            if((y=rdi())<x)Swap(x,y);\n            tree.find(y);t2=tree.split(1);\n            tree.find(x);t1=tree.split(0);\n            wt(count(f[tree.rt]));\n            tree.merge(t1,0);\n            tree.merge(t2,1);\n        }\n    }\n    flush();\n    return 0;\n}\n```",
        "postTime": 1549697203,
        "uid": 57926,
        "name": "Thinking",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P5217 \u3010\u8d2b\u7a77\u3011"
    },
    {
        "content": "\u53d1\u73b0\u8fd9\u4e9b\u64cd\u4f5c\u90fd\u53ef\u4ee5\u7528\u5e73\u8861\u6811\u7ef4\u62a4\uff0c\u6211\u7528\u7684\u662f fhq treap\n\n\u5bf9\u4e8e\u79cd\u7c7b\u6570\u53ef\u4ee5\u72b6\u538b\n\n\u5bf9\u4e8e\u6c42\u6392\u540d\uff0cfhq treap \u9700\u8981\u8bb0\u5f55\u6bcf\u4e2a\u8282\u70b9\u7684\u7236\u4eb2\uff0c\u81ea\u4e0b\u5f80\u4e0a\u6c42\u6392\u540d\uff0c\u800c splay \u5c31\u6bd4\u8f83\u65b9\u4fbf\u4e86\n\n\u7ffb\u8f6c\u5c31\u662f\u57fa\u7840\u64cd\u4f5c\u4e86\n\n```cpp\n#include <iostream>\n#include <cstdlib>\n\nconst int N = 200005;\nint n, m, idx, root;\nstd::string str;\nint lc[N], rc[N], size[N], f[N], pri[N], sum[N], val[N];\nbool rev[N], removed[N];\nint newnode(char ch) {\n\tint now = ++idx;\n\tlc[now] = rc[now] = 0, size[now] = 1, pri[now] = std::rand(), f[now] = 0;\n\tval[now] = ch - 'a', sum[now] = 1 << val[now];\n\treturn now;\n}\nvoid pushup(int x) {\n\tif (lc[x]) f[lc[x]] = x;\n\tif (rc[x]) f[rc[x]] = x;\n\tsize[x] = 1 + size[lc[x]] + size[rc[x]];\n\tsum[x] = 1 << val[x] | sum[lc[x]] | sum[rc[x]];\n}\nvoid setrev(int x) {\n\trev[x] ^= 1, std::swap(lc[x], rc[x]);\n}\nvoid pushdown(int x) {\n\tif (rev[x]) {\n\t\tif (lc[x]) setrev(lc[x]);\n\t\tif (rc[x]) setrev(rc[x]);\n\t\trev[x] = 0;\n\t}\n}\nvoid split(int now, int k, int &x, int &y) {\n\tif (!now) x = y = 0;\n\telse {\n\t\tpushdown(now);\n\t\tif (size[lc[now]] >= k) y = now, split(lc[y], k, x, lc[y]), f[x] = 0;\n\t\telse x = now, split(rc[x], k - size[lc[now]] - 1, rc[x], y), f[y] = 0;\n\t\tpushup(now);\n\t}\n}\nint merge(int x, int y) {\n\tif (!x || !y) return x | y;\n\tif (pri[x] < pri[y]) {\n\t\tpushdown(x), rc[x] = merge(rc[x], y), pushup(x);\n\t\treturn x;\n\t} else {\n\t\tpushdown(y); lc[y] = merge(x, lc[y]), pushup(y);\n\t\treturn y;\n\t}\n}\nvoid clear(int x) {\n\tif (f[x]) clear(f[x]);\n\tpushdown(x);\n}\nint getrank(int x) {\n\tclear(x);\n\tint ans = size[lc[x]] + 1;\n\twhile (f[x]) {\n\t\tif (rc[f[x]] == x)\n\t\t\tans += size[lc[f[x]]] + 1;\n\t\tx = f[x];\n\t}\n\treturn ans;\n}\nchar kth(int k) {\n\tint a, b;\n\tsplit(root, k, root, b);\n\tsplit(root, k - 1, a, root);\n\tchar ans = val[root] + 'a';\n\troot = merge(a, merge(root, b));\n\treturn ans;\n}\nint query(int l, int r) {\n\tint a, b;\n\tsplit(root, r, root, b);\n\tsplit(root, l - 1, a, root);\n\tint ans = __builtin_popcount(sum[root]);\n\troot = merge(a, merge(root, b));\n\treturn ans;\n}\nvoid reverse(int l, int r) {\n\tint a, b;\n\tsplit(root, r, root, b);\n\tsplit(root, l - 1, a, root);\n\tsetrev(root);\n\troot = merge(a, merge(root, b));\n}\nvoid insert(int pos, char ch) {\n\tint a, b;\n\tsplit(root, pos, a, b);\n\troot = merge(a, merge(newnode(ch), b));\n}\nvoid remove(int pos) {\n\tint a, b;\n\tsplit(root, pos, root, b);\n\tsplit(root, pos - 1, a, root);\n\tremoved[root] = 1;\n\troot = merge(a, b);\n}\nint main() {\n\tstd::ios::sync_with_stdio(0), std::cin.tie(0);\n\tstd::cin >> n >> m >> str;\n\tfor (int i = 0; i < n; ++i)\n\t\troot = merge(root, newnode(str[i]));\n\tfor (int i = 0; i < m; ++i) {\n\t\tint x, y; char ch, opt;\n\t\tstd::cin >> opt;\n\t\tif (opt == 'I') std::cin >> x >> ch, insert(x, ch);\n\t\telse if (opt == 'D') std::cin >> x, remove(x);\n\t\telse if (opt == 'R') std::cin >> x >> y, reverse(x, y);\n\t\telse if (opt == 'P') {\n\t\t\tstd::cin >> x;\n\t\t\tif (removed[x]) std::cout << 0 << '\\n';\n\t\t\telse std::cout << getrank(x) << '\\n';\n\t\t}\n\t\telse if (opt == 'T') std::cin >> x, std::cout << kth(x) << '\\n';\n\t\telse if (opt == 'Q') std::cin >> x >> y, std::cout << query(x, y) << '\\n';\n\t}\n\treturn 0;\n}\n\n```",
        "postTime": 1549522981,
        "uid": 26127,
        "name": "Weng_Weijie",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P5217 \u3010\u8d2b\u7a77\u3011"
    },
    {
        "content": "\u975e\u5e38\u88f8\u3001\u800c\u4e14\u975e\u5e38\u7b80\u5355\u7684\u4e00\u9053\u5e73\u8861\u6811\u3002\n\n\u524d5\u4e2a\u64cd\u4f5c\u90fd\u662f\u5e73\u8861\u6811\u7684\u57fa\u672c\u64cd\u4f5c\uff0c\u7b2c6\u4e2a\u64cd\u4f5c\u53ef\u4ee5\u8003\u8651\u72b6\u538b\uff0c2^26\u7528\u4e00\u4e2aint\u5c31\u80fd\u5b58\u4e0b\u6765\uff0c\u5219\u533a\u95f4\u5408\u5e76\u76f4\u63a5\u53d6\u6216\u5373\u53ef\u3002\u5982\u679c\u6b64\u9898\u5b57\u7b26\u96c6\u518d\u5927\u4e00\u4e9b\u53ef\u4ee5\u8003\u8651bitset\n\n```cpp\n#include <stdio.h>\n#include <string.h>\n#include <algorithm>\nusing namespace std;\nconst int N=2e5+2;\nint s[N],siz[N],c[N][2],f[N],zf[N],lz[N],st[N],ys[N];\nint n,m,i,j,x,y,z,cc,ds,tp,rt;\ninline void read(int &x)\n{\n    cc=getchar();\n    while ((cc<48)||(cc>57)) cc=getchar();\n    x=cc^48;cc=getchar();\n    while ((cc>=48)&&(cc<=57))\n    {\n        x=x*10+(cc^48);\n        cc=getchar();\n    }\n}\ninline void pushup(int x)\n{\n    s[x]=s[c[x][0]]|s[c[x][1]]|1<<zf[x];\n    siz[x]=siz[c[x][0]]+siz[c[x][1]]+1;\n}\ninline void pushdown(int x)\n{\n    if (lz[x])\n    {\n        swap(c[c[x][0]][0],c[c[x][0]][1]);\n        swap(c[c[x][1]][0],c[c[x][1]][1]);\n        lz[c[x][0]]^=1;lz[c[x][1]]^=1;\n        lz[x]=0;\n    }\n}\ninline void zigzag(int x)\n{\n    int y=f[x],typ=(c[y][1]==x);\n    if (f[x]=f[y]) c[f[y]][c[f[y]][1]==y]=x;\n    if (c[x][typ^1]) f[c[x][typ^1]]=y;\n    c[y][typ]=c[f[y]=x][typ^1];\n    c[x][typ^1]=y;\n    pushup(y);\n}\ninline void splay(int x,int tar)\n{\n    int y=st[tp=1]=x;\n    while (f[y]) st[++tp]=y=f[y];\n    while (tp) pushdown(st[tp--]);\n    while ((y=f[x])!=tar)\n    {\n        if (f[y]!=tar)\n        {\n            if (c[f[y]][0]==y^c[y][0]==x) zigzag(x); else zigzag(y);\n        }\n        zigzag(x);\n    }\n    pushup(x);\n    if (!tar) rt=x;\n}\ninline void find(int kth,int tar)\n{\n    int x=rt;\n    pushdown(x);\n    while (siz[c[x][0]]+1!=kth)\n    {\n        if (siz[c[x][0]]>=kth) pushdown(x=c[x][0]); else\n        {\n            kth-=siz[c[x][0]]+1;\n            pushdown(x=c[x][1]);\n        }\n    }\n    splay(x,tar);\n}\nint main()\n{\n    read(n);read(m);\n    while ((cc<'a')||(cc>'z')) cc=getchar();\n    siz[1]=ds=n+2;siz[n+2]=1;\n    c[1][1]=2;f[n+2]=n+1;\n    c[2][1]=3;f[2]=1;siz[2]=n+1;\n    ys[1]=2;\n    zf[2]=cc^96;\n    for (i=2;i<=n;i++)\n    {\n        siz[i+1]=n+2-i;\n        c[i+1][1]=i+2;\n        f[i+1]=i;\n        zf[i+1]=getchar()^96;\n        ys[i]=i+1;\n    }\n    for (i=n+1;i;i--) pushup(i);\n    s[n+2]=1;\n    rt=1;\n    while (m--)\n    {\n        cc=getchar();\n        while ((cc<'A')||(cc>'Z')) cc=getchar();\n        if (cc=='I')\n        {\n            read(x);\n            find(x+1,0);find(x+2,rt);\n            x=c[rt][1];\n            f[c[x][0]=++ds]=x;\n            while ((cc<'a')||(cc>'z')) cc=getchar();\n            zf[ds]=cc^96;\n            siz[ds]=1;\n            s[ds]=1<<zf[ds];\n            pushup(x);pushup(rt);\n            continue;\n        }\n        if (cc=='D')\n        {\n            read(x);\n            find(x,0);find(x+2,rt);\n            x=c[rt][1];\n            zf[c[x][0]]=0;\n            c[x][0]=0;\n            pushup(x);pushup(rt);\n            continue;\n        }\n        if (cc=='R')\n        {\n            read(x);read(y);\n            find(x,0);find(y+2,rt);\n            x=c[c[rt][1]][0];\n            lz[x]^=1;swap(c[x][0],c[x][1]);\n            continue;\n        }\n        if (cc=='P')\n        {\n            read(x);\n            x=ys[x];\n            if (!zf[x])\n            {\n                puts(\"0\");\n                continue;\n            }\n            splay(x,0);\n            printf(\"%d\\n\",siz[c[x][0]]);\n            continue;\n        }\n        if (cc=='T')\n        {\n            read(x);\n            find(x+1,0);\n            printf(\"%c\\n\",zf[rt]|96);\n        }\n        else\n        {\n            read(x);read(y);\n            find(x,0);find(y+2,rt);\n            x=c[c[rt][1]][y=0];\n            for (i=1;i<=26;i++) if (1<<i&s[x]) ++y;\n            printf(\"%d\\n\",y); \n        }\n    }\n}\n```",
        "postTime": 1549710504,
        "uid": 29826,
        "name": "SSerxhs",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P5217 \u3010\u8d2b\u7a77\u3011"
    },
    {
        "content": "\u9898\u76ee\u5728\u8fd9\uff1a[\u4f20\u9001\u95e8](https://www.luogu.com.cn/problem/P5217)\u3002\n\n\u5f88\u597d\u7684\u4e00\u9053\u6587\u827a\u5e73\u8861\u6811\u7684\u7ec3\u624b\u9898\u76ee\u3002\n\n### \u505a\u6cd5\uff1afhq treap\u3002\n\n\u4e3b\u8981\u7684\u96be\u70b9\u5728\u4e8e\u64cd\u4f5c P\u3001T\u3001Q\u3002\n\n\u64cd\u4f5c T \u5b9e\u9645\u5c31\u662f\u628a\u64cd\u4f5c\u7684\u4f4d\u7f6e\u5206\u79bb\u51fa\u6765\uff0c\u76f4\u63a5\u8f93\u51fa\u5373\u53ef\u3002\n\n\u64cd\u4f5c Q \u5219\u53ef\u4ee5\u7528\u538b\u4f4d\u8fdb\u884c\u5904\u7406\u3002\n\n\u4f55\u4e3a\u538b\u4f4d\uff1f\n\n\u6211\u4eec\u53ef\u4ee5\u628a26\u4e2a\u5b57\u6bcd\u6362\u6210\u4e00\u517126\u4f4d\u7684\u6570\u5b57\u3002a \u5728\u4e2a\u4f4d\u6807\u4e3a1\uff0cb \u5728\u5341\u4f4d\u6807\u4e3a1\u2026\n\n\u4f46\u662f26\u4f4d\u7684\u6570\u5b57\u597d\u5927\u554a\uff0c\u600e\u4e48\u529e\u5462\uff1f\n\n\u6211\u4eec\u53ef\u4ee5\u628a\u5b83**\u8f6c\u6362\u4e3a\u4e8c\u8fdb\u5236**\u3002\n\n\u90a3\u4e48\u4fbf\u6210\u4e86\uff1aa \u5728\u7b2c1\u4f4d\u6807\u4e3a1\uff0cb \u5728\u7b2c2\u4f4d\u6807\u4e3a1\u2026\n\n\u627e\u5230\u5728\u54ea\u4e2a\u4f4d\u7f6e\u68071\u53ef\u4ee5\u7528**\u4f4d\u79fb**\u6765\u5b9e\u73b0\u3002\n\n\u90a3\u4e48\u5408\u5e76\u533a\u95f4\u7684\u7b54\u6848\u5462\uff1f\n\n\u6211\u4eec\u53ef\u4ee5\u7528**\u6216**\u6765\u5b9e\u73b0\u3002\n\n\u5982\u4f55\u627e\u5230\u6709\u591a\u5c11\u79cd\u5b57\u6bcd\u5462\uff1f\n\n\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u7c7b\u4f3c\u4e8e**\u8fdb\u5236\u8f6c\u6362**\u7684\u65b9\u6cd5\u53bb\u5bfb\u627e\u5230\u3002\n\n### \u91cd\u70b9\u4e0e\u96be\u70b9\uff1a\u64cd\u4f5c P\u3002\n\n~~\u8fd9\u4e2a\u64cd\u4f5c\u4e0d\u662f\u4e00\u822c\u7684\u53d8\u6001\u3002~~\n\n\u6253\u8fc7 Splay \u7684\u4f1a\u77e5\u9053\uff0c\u5728\u6587\u827a\u5e73\u8861\u6811\u65f6\uff0c\u901a\u5e38\u4f1a\u9700\u8981\u4e00\u4e2a pushall \u51fd\u6570\u6765\u5b9e\u73b0\u628a\u8282\u70b9\u5230\u6839\u7684\u6807\u8bb0\u5168\u90e8\u4e0b\u4f20\u3002\n\n\u5f88\u660e\u663e\uff0c\u8fd9\u4e00\u9898\u4e5f\u662f\u9700\u8981\u8fd9\u4e2a\u51fd\u6570\u7684\u3002\n\n\u4f46\u662f\u6211\u4e0d\u60f3\u4e5f\u4e0d\u4f1a\u6253 Splay \u554a\uff01\n\n\u90a3\u6015\u751a\uff1ffhq \u540c\u6837\u53ef\u4ee5\uff01\n\n~~\u53ea\u4e0d\u8fc7\u6709\u70b9\u9ebb\u70e6\u800c\u5df2\u3002~~\n\n\u6211\u4eec\u9700\u8981\u8fdb\u884c\u9b54\u6539 fhq\uff0c\u4f7f\u5b83\u80fd\u591f\u6709\u8fde\u5411 $fa$ \u7684\u8fb9\u3002\n\n\u6211\u4eec\u600e\u4e48\u53bb\u8fdb\u884c\u7ef4\u62a4\u5462\uff1f\n\n\u5f53\u7136\u662f\u4ece pushup \u5f00\u5200\u5566\u3002\n\n```cpp\ninline void pushup(int pos){\n\tint lson=fhq[pos].lson,rson=fhq[pos].rson;\n\tif(lson)\n\t\tfhq[lson].fa=pos;//\u5982\u679c\u6709\u5de6\u513f\u5b50\uff0c\u90a3\u5c31\u8981\u628a\u5de6\u513f\u5b50\u7684\u7236\u4eb2\u66f4\u65b0\n\tif(rson)\n\t\tfhq[rson].fa=pos;//\u53f3\u513f\u5b50\u540c\u7406\n\tfhq[pos].size=fhq[lson].size+fhq[rson].size+1;\n\tfhq[pos].tot=fhq[lson].tot|fhq[rson].tot|1<<fhq[pos].val;//\u66f4\u65b0\u538b\u4f4d\n}\n```\n\n\u5f53\u7136\uff0c\u5728\u6bcf\u6b21 merge \u540e\uff0c$root$ \u7684 $fa$ \u90fd\u8981\u66f4\u65b0\u4e3a0\u3002\n\n\u5982\u4f55 pushall \u5462\uff1f\n\n\u6211\u4eec\u53ef\u4ee5\u7528\u4e00\u4e2a**\u5934\u9012\u5f52**\uff0c\u4e00\u76f4\u987a\u7740 $fa$ \u627e\u5230\u6839\uff0c\u5728 pushdown \u56de\u53bb\u3002\n\n```cpp\nvoid pushall(int pos){\n\tif(fhq[pos].fa)//\u8fd8\u6709\u7236\u4eb2\uff0c\u5c31\u662f\u8fd8\u4e0d\u662f\u6839\n\t\tpushall(fhq[pos].fa);\n\tpushdown(pos);//\u8bb0\u5f97\u4e0b\u4f20\u6807\u8bb0\n}\n```\n\n\u56e0\u4e3a\u8fd8\u6709\u53ef\u80fd\u8282\u70b9\u88ab\u5220\u9664\uff0c\u6240\u4ee5\u88ab\u5220\u9664\u7684\u8282\u70b9\u7684 $fa$ \u53ef\u4ee5\u6807\u4e3a-1\u6807\u8bb0\u6210\u88ab\u5220\u9664\u3002\n\n\u90a3\u4e48 P \u64cd\u4f5c\u7684\u4ee3\u7801\u5982\u4e0b\uff1a\n\n```cpp\nint rnk(int pos){\n\tif(fhq[pos].fa==-1)//\u88ab\u5220\u9664\n\t\treturn 0;\n\tpushall(pos);//\u628a\u8282\u70b9\u4e0a\u9762\u7684\u5f71\u54cd\u6e05\u7a7a\n\tint ans=fhq[fhq[pos].lson].size+1;//\u5de6\u513f\u5b50\u6709\u8d21\u732e\n\tfor(int i=pos;fhq[i].fa;i=fhq[i].fa)//\u8df3fa\u6765\u7b97\u51fa\u6240\u4ee5\u7684\u8d21\u732e\n\t\tif(fhq[fhq[i].fa].rson==i)//\u6ce8\u610f\uff1a\u53ea\u6709\u5f53pos\u662ffa\u7684\u53f3\u513f\u5b50\u65f6\u624d\u6709\u5de6\u513f\u5b50\u7684\u8d21\u732e\n\t\t\tans+=fhq[fhq[fhq[i].fa].lson].size+1;//\u52a0\u4e0a\u8d21\u732e\n\treturn ans;\n}\n```\n\n\u80af\u5b9a\u4f1a\u6709\u4eba\u95ee\uff1a\u4e3a\u4ec0\u4e48\u76f4\u63a5\u5c31\u7528 $pos$ \u5c31\u53ef\u4ee5\u4e86\u5462\uff1f\n\n\u90a3\u662f\u56e0\u4e3a\u6700\u5f00\u59cb\u6211\u4eec\u90fd\u662f\u6309\u987a\u5e8f\u4e00\u4e2a\u4e00\u4e2a\u63d2\u5165\u7684\uff0c\u7b2c $i$ \u4e2a\u5b57\u6bcd\u7684\u7f16\u53f7\u5373\u4e3a $i$\u3002\n\n\u90a3\u4e48\u5c31\u53ef\u4ee5\u5feb\u843d\u5730 A \u8fd9\u4e00\u9898\u4e86~\n\n```cpp\n#include<iostream>\n#include<cstdlib>\n#include<cstring>\nusing namespace std;\nconst int N=1e6+10;\nstruct fhq_treap{\n\tint fa,lson,rson;\n\tint val,key;\n\tint size;\n\tint tot;\n\tint tag;\n};\nfhq_treap fhq[N];\nstring s;\nint a[N];\nint tot,root;\ninline int newnode(int val){\n\ttot++;\n\tfhq[tot].key=rand();\n\tfhq[tot].tot=1<<val;//\u6ce8\u610f\u8981\u4f4d\u79fb\n\tfhq[tot].val=val;\n\tfhq[tot].size=1;\n\tfhq[tot].fa=0;\n\treturn tot;\n}\ninline void pushup(int pos){\n\tint lson=fhq[pos].lson,rson=fhq[pos].rson;\n\tif(lson)\n\t\tfhq[lson].fa=pos;\n\tif(rson)\n\t\tfhq[rson].fa=pos;\n\tfhq[pos].size=fhq[lson].size+fhq[rson].size+1;\n\tfhq[pos].tot=fhq[lson].tot|fhq[rson].tot|1<<fhq[pos].val;\n}\ninline void pushdown(int pos){\n\tif(!fhq[pos].tag)\n\t\treturn ;\n\tswap(fhq[pos].lson,fhq[pos].rson);\n\tfhq[fhq[pos].lson].tag^=1;\n\tfhq[fhq[pos].rson].tag^=1;\n\tfhq[pos].tag=0;\n}\nvoid split(int pos,int size,int &x,int &y){\n\tif(!pos){\n\t\tx=y=0;\n\t\treturn ;\n\t}\n\tpushdown(pos);\n\tif(fhq[fhq[pos].lson].size+1<=size){\n\t\tx=pos;\n\t\tsplit(fhq[x].rson,size-fhq[fhq[pos].lson].size-1,fhq[x].rson,y);//\u6ce8\u610fsize\u8981\u51cf\u5de6\u513f\u5b50\u7684size\u548c\u81ea\u5df1\n\t}\n\telse{\n\t\ty=pos;\n\t\tsplit(fhq[y].lson,size,x,fhq[y].lson);\n\t}\n\tpushup(pos);\n}\nint merge(int x,int y){\n\tif(!x||!y)\n\t\treturn x+y;\n\tif(fhq[x].key<fhq[y].key){\n\t\tpushdown(x);\n\t\tfhq[x].rson=merge(fhq[x].rson,y);\n\t\tpushup(x);\n\t\treturn x;\n\t}\n\telse{\n\t\tpushdown(y);\n\t\tfhq[y].lson=merge(x,fhq[y].lson);\n\t\tpushup(y);\n\t\treturn y;\n\t}\n}\nvoid pushall(int pos){\n\tif(fhq[pos].fa)\n\t\tpushall(fhq[pos].fa);\n\tpushdown(pos);\n}\nvoid ins(int pos,int val){\n\tint x,y;\n\tsplit(root,pos,x,y);\n\troot=merge(merge(x,newnode(val)),y);\n\tfhq[root].fa=0;//\u4e0d\u5fd8\u6807\u8bb0\n}\nvoid del(int pos){\n\tint x,y,z;\n\tsplit(root,pos-1,x,y);\n\tsplit(y,1,y,z);\n\tfhq[y].fa=-1;//\u4e0d\u5fd8\u6807\u8bb0\n\troot=merge(x,z);\n\tfhq[root].fa=0;//\u4e0d\u5fd8\u6807\u8bb0\n}\nvoid rev(int l,int r){\n\tint x,y,z;\n\tsplit(root,l-1,x,y);\n\tsplit(y,r-l+1,y,z);//\u662fr-l+1\n\tfhq[y].tag^=1;\n\troot=merge(merge(x,y),z);\n\tfhq[root].fa=0;//\u4e0d\u5fd8\u6807\u8bb0\n}\nint rnk(int pos){\n\tif(fhq[pos].fa==-1)\n\t\treturn 0;\n\tpushall(pos);\n\tint ans=fhq[fhq[pos].lson].size+1;\n\tfor(int i=pos;fhq[i].fa;i=fhq[i].fa)\n\t\tif(fhq[fhq[i].fa].rson==i)\n\t\t\tans+=fhq[fhq[fhq[i].fa].lson].size+1;\n\treturn ans;\n}\nchar num(int pos){\n\tint x,y,z;\n\tsplit(root,pos-1,x,y);\n\tsplit(y,1,y,z);\n\tchar ch=fhq[y].val+'a';\n\troot=merge(merge(x,y),z);\n\tfhq[root].fa=0;//\u4e0d\u5fd8\u6807\u8bb0\n\treturn ch;\n}\nint cnt(int l,int r){\n\tint x,y,z;\n\tsplit(root,l-1,x,y);\n\tsplit(y,r-l+1,y,z);\n\tint tmp=fhq[y].tot;\n\troot=merge(merge(x,y),z);\n\tfhq[root].fa=0;//\u4e0d\u5fd8\u6807\u8bb0\n\tint ans=0;\n\twhile(tmp){\n\t\tans+=tmp%2;\n\t\ttmp/=2;\n\t}//\u7c7b\u4f3c\u8fdb\u5236\u8f6c\u6362\u6765\u6c42\n\treturn ans;\n}\nint main(){\n\tint n,m;\n\tcin>>n>>m;\n\tcin>>s;\n\tfor(int i=0;i<n;i++)\n\t\ta[i+1]=s[i]-'a';\n\tfor(int i=1;i<=n;i++)\n\t\troot=merge(root,newnode(a[i]));\n\tchar opt,ch;\n\tint x,y;\n\tfor(int i=1;i<=m;i++){\n\t\tcin>>opt;\n\t\tswitch(opt){\n\t\t\tcase 'I':\n\t\t\t\tcin>>x>>ch;\n\t\t\t\tins(x,ch-'a');\n\t\t\t\tbreak;\n\t\t\tcase 'D':\n\t\t\t\tcin>>x;\n\t\t\t\tdel(x);\n\t\t\t\tbreak;\n\t\t\tcase 'R':\n\t\t\t\tcin>>x>>y;\n\t\t\t\trev(x,y);\n\t\t\t\tbreak;\n\t\t\tcase 'P':\n\t\t\t\tcin>>x;\n\t\t\t\tcout<<rnk(x)<<'\\n';\n\t\t\t\tbreak;\n\t\t\tcase 'T':\n\t\t\t\tcin>>x;\n\t\t\t\tcout<<num(x)<<'\\n';\n\t\t\t\tbreak;\n\t\t\tcase 'Q':\n\t\t\t\tcin>>x>>y;\n\t\t\t\tcout<<cnt(x,y)<<'\\n';\n\t\t\t\tbreak;\n\t\t}\n\t}\n}\n```",
        "postTime": 1609597538,
        "uid": 204705,
        "name": "KiDDOwithTopTree",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P5217 \u3010\u8d2b\u7a77\u3011"
    },
    {
        "content": "\u63d0\u4f9b\u4e00\u4e2a\u4ee3\u7801\u77ed\uff0c\u8dd1\u5f97\u5feb\u7684\u6307\u9488 FHQ \u5199\u6cd5\u3002\n\n\u524d\u7f6e\u77e5\u8bc6\uff1aFHQ Treap\uff0c[\u6587\u827a\u5e73\u8861\u6811](https://www.luogu.com.cn/problem/P3391)\uff0c[\u7b1b\u5361\u5c14\u6811](https://www.luogu.com.cn/problem/P5854)\uff08\u7528\u6765\u4f18\u5316\u5e38\u6570\uff09\u3002\n# \u601d\u8def\n\u7528\u5e73\u8861\u6811\u7ef4\u62a4\u4e4b\uff0c\u8003\u8651\u7ecf\u5178\u5e73\u8861\u6811\u4e94\u95ee\uff1a\n### \u8282\u70b9\u4fe1\u606f\n\u56e0\u4e3a\u6211\u4eec\u5199\u7684\u662f FHQ\uff0c\u6240\u4ee5\u8981\u8bb0\u5f55\u5de6\u53f3\u5b69\u5b50\u3001\u4e24\u4e2a\u6743\u503c\u3001\u5b50\u6811\u5927\u5c0f\u3002\n\n\u8003\u8651\u600e\u4e48\u5904\u7406 P \u64cd\u4f5c\u3002\u6211\u4eec\u8bb0\u5f55\u521d\u59cb\u6587\u672c\u4e2d\u6bcf\u4e2a\u5b57\u7b26\u5bf9\u5e94\u7684\u8282\u70b9\uff0c\n\n\u8be2\u95ee\u8282\u70b9 $x$ \u7684\u6392\u540d\u65f6\uff0c\u4ece\u6839\u5230 $x$ \u4f9d\u6b21 push down\uff0c\u518d\u4ece $x$ \u5230\u6839\u7edf\u8ba1 $x$ \u524d\u9762\u7684\u8282\u70b9\u6570\u3002\n\n\u56e0\u4e3a\u8981\u5904\u7406 $x$ \u5230\u6839\u7684\u8def\u5f84\uff0c\u6240\u4ee5\u8981\u8bb0\u5f55\u7236\u8282\u70b9\u3002\n\n\u56e0\u4e3a\u8981\u7279\u5224 $x$ \u4e0d\u5b58\u5728\u7684\u60c5\u51b5\uff0c\u6240\u4ee5\u8981\u8bb0\u5f55\u8be5\u8282\u70b9\u662f\u5426\u88ab\u5220\u9664\u3002\n\n\u8003\u8651\u600e\u4e48\u5904\u7406 Q \u64cd\u4f5c\u3002\u6ce8\u610f\u5230\u5b57\u7b26\u96c6\u5f88\u5c0f\uff0c\u6211\u4eec\u8bb0\u5f55\u4e00\u4e2a\u72b6\u538b\u503c $q$\uff0c$q$ \u7684\u7b2c $i$ \u4f4d\u4e3a $1$ \u8868\u793a\u8be5\u5b50\u6811\u5185\u5305\u542b\u5b57\u7b26 `'a'+i`\u3002\n### \u8282\u70b9\u6807\u8bb0\n\u56e0\u4e3a\u8981\u7ef4\u62a4\u533a\u95f4\u53cd\u8f6c\uff0c\u6240\u4ee5\u8981\u8bb0\u5f55\u533a\u95f4\u53cd\u8f6c\u6807\u8bb0\u3002\n### \u4e0b\u4f20\u6807\u8bb0\n\u548c[\u6587\u827a\u5e73\u8861\u6811](https://www.luogu.com.cn/problem/P3391)\u4e00\u6837\uff0c\u4e0d\u89e3\u91ca\u3002\n### \u533a\u95f4\u4fee\u6539\n\u548c[\u6587\u827a\u5e73\u8861\u6811](https://www.luogu.com.cn/problem/P3391)\u4e00\u6837\uff0c\u76f4\u63a5\u6253\u6807\u8bb0\u5373\u53ef\uff0c\u4e0d\u89e3\u91ca\u3002\n### \u4e0a\u4f20\u4fe1\u606f\n\u6b63\u5e38\u66f4\u65b0\u5b50\u6811\u5927\u5c0f\uff0c\u6ce8\u610f\u66f4\u65b0\u7236\u8282\u70b9\u3002\n\n\u8003\u8651\u5982\u4f55\u5408\u5e76\u72b6\u538b\u503c $q$\uff0c\u663e\u7136\u53ef\u4ee5\u6309\u4f4d\u6216\u89e3\u51b3\u3002\n\n\u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u5199\u51fa\uff1a\n```cpp\nstruct T\n{\n    T *l, *r, *f;int v, k, s, q;bool b, g;int z() {return l ? l->s : 0;}\n    T(int _) : l(0), r(0), f(0), v(_), k(rand()), s(1), q(1 << v), b(0), g(0) {}void u() {\n    s = 1;q = 1 << v;if(l) l->f = this, s += l->s, q |= l->q;if(r) r->f = this, s += r->s, q |= r->q;}\n    void d() {if(b) {T *t = l;l = r;r = t;if(l) l->b ^= 1;if(r) r->b ^= 1;b = 0;}}\n}*r, *a, *b, *c, *s[30], *d[100050];void D(T *x) {if(x) D(x->f), x->d();}\nvoid S(T *x, int k, T *&a, T *&b)\n{\n    if(!x) {a = b = 0;return;}if(!k) {a = 0;b = x;return;}\n    if(k >= x->s) {a = x;b = 0;return;}x->d();int z = x->z();\n    if(z >= k) b = x, S(x->l, k, a, b->l), b->u();\n    else a = x, S(x->r, k - z - 1, a->r, b), a->u();\n}\nT *M(T *a, T *b)\n{\n    if(!a) return b;if(!b) return a;\n    if(a->k < b->k) {a->d();a->r = M(a->r, b);a->u();return a;}\n    else {b->d();b->l = M(a, b->l);b->u();return b;}\n}\n```\n\u8003\u8651\u600e\u4e48\u628a\u521d\u59cb\u6587\u672c\u5efa\u51fa\u6765\u3002\u6211\u4eec\u53ef\u4ee5\u7528\u7b1b\u5361\u5c14\u6811\u4f18\u5316\u5efa\u6811\u8fc7\u7a0b\uff1a\n```cpp\nfor(int i = 1;i <= n;++i)\n{\n    do v = getchar();while(!islower(v));a = new T(v - 'a');\n    k = a->k;p = l;while(l && k < s[l - 1]->k) s[--l]->u();\n    if(l < p) a->l = s[l];if(l) s[l - 1]->r = a;s[l++] = d[i] = a;\n}\nwhile(l) s[--l]->u();r = s[0];\n```\n\u63a5\u4e0b\u6765\u5206\u522b\u8003\u8651\u6bcf\u79cd\u64cd\u4f5c\u3002\n### I \u64cd\u4f5c/D \u64cd\u4f5c\n\u5957\u8def\u5206\u88c2\u5408\u5e76\uff0c\u4e0d\u89e3\u91ca\u3002\n```cpp\nscanf(\" %c%d\", &o, &x);switch(o) {\ncase 'I': scanf(\" %c\", &v);S(r, x, a, b);r = M(a, M(new T(v - 'a'), b));break;\ncase 'D': S(r, x - 1, a, b);S(b, 1, b, c);b->g = 1;r = M(a, c);break;\n```\n### R \u64cd\u4f5c\n\u548c[\u6587\u827a\u5e73\u8861\u6811](https://www.luogu.com.cn/problem/P3391)\u4e00\u6837\uff0c\u628a\u64cd\u4f5c\u533a\u95f4\u5206\u88c2\u51fa\u6765\uff0c\u6253\u6807\u8bb0\uff0c\u5408\u5e76\u56de\u53bb\u3002\n```cpp\ncase 'R': scanf(\"%d\", &y);S(r, y, a, c);S(a, x - 1, a, b);b->b ^= 1;r = M(a, M(b, c));break;\n```\n### P \u64cd\u4f5c\n\u89c1\u4e0a\u6587\u3002\n\n>\u8be2\u95ee\u8282\u70b9 $x$ \u7684\u6392\u540d\u65f6\uff0c\u4ece\u6839\u5230 $x$ \u4f9d\u6b21 push down\uff0c\u518d\u4ece $x$ \u5230\u6839\u7edf\u8ba1 $x$ \u524d\u9762\u7684\u8282\u70b9\u6570\u3002\n\n```cpp\ncase 'P': q = 0;if(!d[x]->g) {D(a = d[x]);q = a->z() + 1;\nfor(;a->f;a = a->f) if(a == a->f->r) q += a->f->z() + 1;}printf(\"%d\\n\", q);break;\n```\n### T \u64cd\u4f5c\n\u5957\u8def\u5206\u88c2\u5408\u5e76\uff0c\u4e0d\u89e3\u91ca\u3002\n```cpp\ncase 'T': S(r, x - 1, a, b);S(b, 1, b, c);printf(\"%c\\n\", b->v + 'a');r = M(a, M(b, c));break;\n```\n### Q \u64cd\u4f5c\n\u628a\u64cd\u4f5c\u533a\u95f4\u5206\u88c2\u51fa\u6765\uff0c\u8f93\u51fa $q$ \u7684\u4e8c\u8fdb\u5236\u4e2d $1$ \u7684\u4e2a\u6570\uff08\u53ef\u4ee5\u7528 `__builtin_popcount` \u8ba1\u7b97\uff09\uff0c\u5408\u5e76\u56de\u53bb\u3002\n```cpp\ncase 'Q':scanf(\"%d\", &y);S(r, y, a, c);S(a, x - 1, a, b);\nprintf(\"%d\\n\", __builtin_popcount(b->q));r = M(a, M(b, c));break;\n```\n# Code\n~~\u6765\u70b9\u6781\u7b80\u98ce\u4ee3\u7801~~\n```cpp\n#include <cstdio>\n#include <cctype>\n#include <cstdlib>\n#define A r = M(a, M(b, c))\n#define B S(r, x - 1, a, b);S(b, 1, b, c)\n#define C S(r, R(), a, c);S(a, x - 1, a, b)\ninline int R()\n{\n    int r = 0;char c = getchar();while(!isdigit(c)) c = getchar();\n    while(isdigit(c)) r = r * 10 + c - '0', c = getchar();return r;\n}\nint n, m, l, k, p, o, x, y, q;char v;struct T\n{\n    T *l, *r, *f;int v, k, s, q;bool b, g;int z() {return l ? l->s : 0;}\n    T(int _) : l(0), r(0), f(0), v(_), k(rand()), s(1), q(1 << v), b(0), g(0) {}void u() {\n    s = 1;q = 1 << v;if(l) l->f = this, s += l->s, q |= l->q;if(r) r->f = this, s += r->s, q |= r->q;}\n    void d() {if(b) {T *t = l;l = r;r = t;if(l) l->b ^= 1;if(r) r->b ^= 1;b = 0;}}\n}*r, *a, *b, *c, *s[30], *d[100050];void D(T *x) {if(x) D(x->f), x->d();}\nvoid S(T *x, int k, T *&a, T *&b)\n{\n    if(!x) {a = b = 0;return;}if(!k) {a = 0;b = x;return;}\n    if(k >= x->s) {a = x;b = 0;return;}x->d();int z = x->z();\n    if(z >= k) b = x, S(x->l, k, a, b->l), b->u();\n    else a = x, S(x->r, k - z - 1, a->r, b), a->u();\n}\nT *M(T *a, T *b)\n{\n    if(!a) return b;if(!b) return a;\n    if(a->k < b->k) {a->d();a->r = M(a->r, b);a->u();return a;}\n    else {b->d();b->l = M(a, b->l);b->u();return b;}\n}\nint main()\n{\n    srand(388651);n = R();m = R();for(int i = 1;i <= n;++i)\n    {\n        do v = getchar();while(!islower(v));a = new T(v - 'a');\n        k = a->k;p = l;while(l && k < s[l - 1]->k) s[--l]->u();\n        if(l < p) a->l = s[l];if(l) s[l - 1]->r = a;s[l++] = d[i] = a;\n    }\n    while(l) s[--l]->u();r = s[0];while(m--)\n    {\n        scanf(\" %c\", &o);x = R();switch(o)\n        {\n            case 'I': scanf(\" %c\", &v);S(r, x, a, b);r = M(a, M(new T(v - 'a'), b));break;\n            case 'D': B;b->g = 1;r = M(a, c);break;case 'R': C;b->b ^= 1;A;break;\n            case 'P': q = 0;if(!d[x]->g) {D(a = d[x]);q = a->z() + 1;for(;a->f;a = a->f)\n            if(a == a->f->r) q += a->f->z() + 1;}printf(\"%d\\n\", q);break;\n            case 'T': B;printf(\"%c\\n\", b->v + 'a');A;break;\n            case 'Q': C;printf(\"%d\\n\", __builtin_popcount(b->q));A;break;\n        }\n    }\n    return 0;\n}\n```\n",
        "postTime": 1660564357,
        "uid": 388651,
        "name": "5k_sync_closer",
        "ccfLevel": 7,
        "title": "P5217 \u8d2b\u7a77 \u9898\u89e3"
    },
    {
        "content": "\u88ab\u964d\u667a\u4e86\u3002               \n\n\u8003\u8651\u7528 fhq-treap \u7ef4\u62a4\u3002              \n\n\u5bf9\u4e8e\u4e00\u64cd\u4f5c\u6211\u4eec\u76f4\u63a5\u6309\u5b50\u6811\u5927\u5c0f\u5206\u88c2\u63d2\u5165\u5373\u53ef\u3002            \n\n\u5bf9\u4e8e\u4e8c\u64cd\u4f5c\u6211\u4eec\u76f4\u63a5\u6309\u5b50\u6811\u5927\u5c0f\u5206\u88c2\u5220\u9664\u5373\u53ef\u3002             \n\n\u5bf9\u4e8e\u4e09\u64cd\u4f5c\uff0c\u4e5f\u5c31\u662f\u6587\u827a\u5e73\u8861\u6811\uff0c\u6211\u4eec\u76f4\u63a5\u5206\u88c2\u51fa\u9700\u8981\u53cd\u8f6c\u7684\u56ca\u62ec\u4e86\u533a\u95f4\u7684\u6811\uff0c\u6253\u4e0a\u53cd\u8f6c\u6807\u8bb0\u540e\u4e00\u76f4 push_down \u5c31\u597d\u4e86\u3002           \n\n\u5bf9\u4e8e\u56db\u64cd\u4f5c\uff0c\u6211\u4eec\u8003\u8651\u521d\u59cb\u63d2\u5165\u7684\u5e73\u8861\u6811\u8282\u70b9 $x$\uff0c\u5176\u5728\u5e73\u8861\u6811\u8282\u70b9\u4e2d\u7684\u6807\u53f7\u4e5f\u662f $x$\uff0c\u7528\u8fd9\u4e2a\u8282\u70b9\u5411\u4e0a\u8df3\u5230\u6839\u7136\u540e\u4ece\u6839\u5230\u5e95\u4e0b push_down \u4e00\u904d\u540e\u7ef4\u62a4\u5b83\u5728\u8fd9\u68f5\u5e73\u8861\u6811\u91cc\u4e2d\u5e8f\u904d\u5386\u7684\u4f4d\u7f6e\u5373\u53ef\u3002            \n\n\u5bf9\u4e8e\u4e94\u64cd\u4f5c\uff0c\u76f4\u63a5\u6309\u5b50\u6811\u5927\u5c0f\u5206\u88c2\u8f93\u51fa\u5373\u53ef\u3002            \n\n\u5bf9\u4e8e\u516d\u64cd\u4f5c\uff0c\u8003\u8651\u5728\u5e73\u8861\u6811\u4e0a\u5f00\u4e00\u4e2a\u5927\u5c0f\u4e3a $26$ \u7684 bool \u6570\u7ec4\u7136\u540e\u6bcf\u6b21 update \u4ece\u5b50\u6811\u8f6c\u79fb\u5373\u53ef\uff0c\u4e3a\u4e86\u7701\u7a7a\u95f4\u53ef\u4ee5\u538b\u6210\u4e00\u4e2a int \u6574\u578b\u3002           \n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(n \\log n)$\uff0c\u7a7a\u95f4\u590d\u6742\u5ea6 $O(n)$\u3002\n\n```cpp\n#include \"bits/stdc++.h\"\nusing namespace std;\nconst int Len = 2e5 + 5;\nint n,m,root,x,y,z,tot;\nbool vis[Len];\nstruct node\n{\n\tint l,r,siz,key,val,tag,f;\n\tint sum;\n\tnode(){l = r = siz = key = val = tag = f = sum = 0;}\n\tnode(int L,int R,int SIZ,int KEY,int VAL,int TAG,int F,long long SUM){l = L , r = R , siz = SIZ , key = KEY , val = VAL , tag = TAG , f = F , sum = SUM;}\n}fhq[Len];\nint newnode(int val)\n{\n\t++ tot;\n\tfhq[tot] = node(0 , 0 , 1 , rand() , val , 0 , 0 , (1 << val));\n\treturn tot;\n}\n#define ls fhq[p].l\n#define rs fhq[p].r\nvoid update(int p)\n{\n\tfhq[p].siz = fhq[ls].siz + fhq[rs].siz + 1;\n\tfhq[p].sum = fhq[ls].sum | fhq[rs].sum | (1 << fhq[p].val);\n\t//fhq[ls].f = p , fhq[rs].f = p;\n}\nvoid push_down(int p)\n{\n\tif(fhq[p].tag)\n\t{\n\t\tswap(fhq[p].l , fhq[p].r);\n\t\tfhq[ls].tag ^= 1 , fhq[rs].tag ^= 1;\n\t\tfhq[p].tag = 0;\n\t}\n}\nvoid split(int now,int k,int &x,int &y,int lstx,int lsty)\n{\n\tif(!now){x = y = 0;return;}\n\tpush_down(now);\n\tif(k <= fhq[fhq[now].l].siz)\n\t{\n\t\ty = now;\n\t\tfhq[now].f = lsty;\n\t\tsplit(fhq[now].l , k , x , fhq[now].l , lstx , y);\n\t}\n\telse\n\t{\n\t\tx = now;\n\t\tfhq[now].f = lstx;\n\t\tsplit(fhq[now].r , k - fhq[fhq[now].l].siz - 1 , fhq[now].r , y , x , lsty);\n\t}\n\tupdate(now);\n}\nint merge(int x,int y)\n{\n\tif(!x || !y) return x + y;\n\tif(fhq[x].key < fhq[y].key) \n\t{\n\t\tpush_down(x);\n\t\tfhq[x].r = merge(fhq[x].r , y);\n\t\tfhq[fhq[x].r].f = x;\n\t\tupdate(x);\n\t\treturn x;\n\t}\n\telse\n\t{\n\t\tpush_down(y);\n\t\tfhq[y].l = merge(x , fhq[y].l);\n\t\tfhq[fhq[y].l].f = y;\n\t\tupdate(y);\n\t\treturn y;\n\t}\n}\nvoid Ins(int siz,int val)\n{\n\tx = y = 0;\n\tsplit(root , siz , x , y , 0 , 0);\n\troot = merge(merge(x , newnode(val)) , y);\n}\nvoid del(int siz)\n{\n\tx = y = z = 0;\n\tsplit(root , siz - 1 , x , z , 0 , 0);\n\tsplit(z , 1 , y , z , 0 , 0);\n\tvis[y] = 1;\n\troot = merge(x , z);\n}\nvoid Rev(int l,int r)\n{\n\tint Siz = r - l + 1;\n\tsplit(root , l - 1 , x , z , 0 , 0);\n\tsplit(z , Siz , y , z , 0 , 0);\n\tfhq[y].tag ^= 1;\n\troot = merge(x , merge(y , z));\n}\nvector<int> calc;\nvoid Pa(int x)\n{\n\tcalc.push_back(x);\n\tif(x == root) return;\n\tPa(fhq[x].f);\n}\nvoid Print(int x)\n{\n\tpush_down(x);\n\tif(fhq[x].l) Print(fhq[x].l);\n\tprintf(\"%d\\n\",x);\n\tif(fhq[x].r) Print(fhq[x].r);\n}\nint Pos(int x)\n{\n\tif(vis[x]) return 0;\n\tcalc.clear();\n\tPa(x);\n\t//for(int j = 0 ; j < calc.size() ; j ++) printf(\"calc:%d \",calc[j]);\n\tint u = root , nums = calc.size() - 1 , rank = 0;\n\twhile(u != x && nums - 1 >= 0)\n\t{\n\t\tpush_down(u);\n\t\tif(fhq[u].l == calc[nums - 1]) u = fhq[u].l;\n\t\telse rank += fhq[fhq[u].l].siz + 1 , u = fhq[u].r;\n\t\t-- nums;\n\t}\n\tpush_down(u);\n\t//Print(root);\n\treturn rank + fhq[fhq[u].l].siz + 1;\n}\nvoid FirX(int siz)\n{\n\tx = y = z = 0;\n\tsplit(root , siz , x , z , 0 , 0);\n\tsplit(x , siz - 1 , x , y , 0 , 0);\n\tputchar(fhq[y].val + 'a') , puts(\"\");\n\troot = merge(merge(x , y) , z);\n}\nvoid Count(int l,int r)\n{\n\tint Siz = r - l + 1;\n\tsplit(root , l - 1 , x , z , 0 , 0);\n\tsplit(z , Siz , y , z , 0 , 0);int sim = 0;\n\tfor(int i = 0 ; i < 26 ; i ++) sim += ((fhq[y].sum >> i) & 1); \n\tprintf(\"%d\\n\",sim);\n\troot = merge(x , merge(y , z));\n}\nchar s[Len],ss[5],sss[5];\nint main()\n{\n\tsrand(time(0));\n\tscanf(\"%d %d\",&n,&m);\n\tscanf(\"%s\",s + 1);\n\tfor(int i = 1 ; i <= n ; i ++) Ins(i - 1 , s[i] - 'a');\n\tint X,Y;\n\tfor(int i = 1 ; i <= m ; i ++)\n\t{\n\t\tscanf(\"%s\",ss + 1);\n\t\tif(ss[1] == 'I') \n\t\t{\n\t\t\tscanf(\"%d\",&X);\n\t\t\tscanf(\"%s\",sss + 1);\n\t\t\tIns(X , sss[1] - 'a');\n\t\t}\t\n\t\telse if(ss[1] == 'D') \n\t\t{\n\t\t\tscanf(\"%d\",&X);\n\t\t\tdel(X);\n\t\t}\n\t\telse if(ss[1] == 'R')\n\t\t{\n\t\t\tscanf(\"%d %d\",&X,&Y);\n\t\t\tRev(X , Y);\n\t\t}\n\t\telse if(ss[1] == 'P') \n\t\t{\n\t\t\tscanf(\"%d\",&X);\n\t\t\tprintf(\"%d\\n\",Pos(X));\n\t\t}\n\t\telse if(ss[1] == 'T') \n\t\t{\n\t\t\tscanf(\"%d\",&X);\n\t\t\tFirX(X);\n\t\t}\n\t\telse if(ss[1] == 'Q') \n\t\t{\n\t\t\tscanf(\"%d %d\",&X,&Y);\n\t\t\tCount(X , Y);\n\t\t}\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1634815843,
        "uid": 132533,
        "name": "Hakuoro",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P5217 \u8d2b\u7a77"
    },
    {
        "content": "\u200b\t\t\u770b\u5b8c\u9898\u76ee\u6211\u4eec\u90fd\u77e5\u9053\u662f\u5e73\u8861\u6811\uff0c\u800c\u4e14\u662f\u8981\u8d44\u74f7\u533a\u95f4\u64cd\u4f5c\u7684\u5e73\u8861\u6811\uff0c\u5e76\u4e14\u8981\u80fd\u533a\u95f4\u7ffb\u8f6c\uff0c\u6240\u4ee5\u6211\u4eec~~\u88ab\u8feb~~\u9009\u62e9~~\u81ea\u5e26\u4e09\u500d\u5927\u5e38\u6570~~\u7684$Splay$\uff0c\u5269\u4e0b\u7684\u90fd\u662f\u4e00\u4e9b\u5e73\u8861\u6811\u7684\u57fa\u64cd\u4e86\u3002\n\n\u64cd\u4f5c$1$ \uff1a\u63d2\u5165\uff0c\u5f88\u7b80\u5355\u3002~~\u8be5\u600e\u4e48\u63d2\u5c31\u600e\u4e48\u63d2~~\n\n\u64cd\u4f5c$2$ \uff1a\u5220\u9664\uff0c\u76f4\u63a5\u5220\u9664\u3002\n\n\u64cd\u4f5c$3$ \uff1a\u7ffb\u8f6c\uff0c\u5c06\u8981\u64cd\u4f5c\u7684\u5b50\u6811\u65cb\u8f6c\u51fa\u6765\uff0c\u7136\u540e\u76f4\u63a5\u6253\u6807\u8bb0\u7ffb\u8f6c\u3002\n\n\u64cd\u4f5c$4$ \uff1a\u5f00\u59cb\u65f6\u5c06\u6574\u4e2a\u5e8f\u5217$build$\u51fa\u6765\uff0c\u7136\u540e\u7528\u6570\u7ec4\u5c06\u539f\u5e8f\u5217\u5728\u5e73\u8861\u6811\u4e2d\u7684\u4f4d\u7f6e\u8bb0\u5f55\u4e0b\u6765\u3002\u5e73\u8861\u6811\u4e2d\u7684\u4e00\u4e2a\u70b9\u88ab\u5220\u9664\u540e\u5c31\u7ed9\u90a3\u4e2a\u70b9\u6253\u4e0a\u6807\u8bb0\uff0c\u67e5\u8be2\u65f6\u76f4\u63a5\u67e5\u5bf9\u5e94\u7684\u4f4d\u7f6e\uff0c\u5982\u679c\u88ab\u5220\u9664\u540e\u5c31\u8f93\u51fa$0$\uff0c\u5426\u5219\u5148$dfs$\u5c06\u8def\u4e0a\u7684\u6807\u8bb0$pushdown$\u4e0b\u6765\uff0c\u7136\u540e\u518d\u65cb\u8f6c\u5230\u6839\u8f93\u51fa\u6392\u540d\u5373\u53ef\u3002\n\n\u64cd\u4f5c$5$ \uff1a\u7b2c$k$\u5c0f\uff0c\u76f4\u63a5\u8f93\u51fa\u5373\u53ef\u3002\n\n\u64cd\u4f5c$6$ \uff1a\u72b6\u538b\u538b\u5b57\u6bcd\uff0c\u5c06\u8981\u64cd\u4f5c\u7684\u5b50\u6811\u65cb\u8f6c\u51fa\u6765\uff0c\u7136\u540e\u76f4\u63a5\u8f93\u51fa\u3002\n\n### \u7ec6\u8282\n\n$1.$\n\n\u63a8\u8350\u4f7f\u7528\u4e00\u4e2a\u8fd9\u6837\u7684\u51fd\u6570\uff1a\n\n```cpp\ninline int split(int l,int r)\n{\n    int x=rnk(l-1),y=rnk(r+1);\n    splay(x,0);splay(y,x);\n    return lc(y);\n}\n```\n\n$rnk$\u5c31\u662f\u627e\u7b2c$k$\u4e2a\u4f4d\u7f6e\u3002\n\n\u7136\u540e\u4f60\u8981\u63d2\u5165\u5c31\n\n```cpp\nint u=split(pos,pos-1);\n```\n\n\u5220\u9664\u5c31\n\n```cpp\nint u=split(pos,pos);\n```\n\n\u627e\u533a\u95f4\u5c31\n\n```cpp\nint u=split(l,r);\n```\n\n$2.$\n\n\u4e3a\u4e86\u4e0d\u4f7f\u6211\u4eec$split$\u65f6\u8d8a\u754c\uff0c\u6211\u4eec\u5c31\u5728\u9996\u5c3e\u641e\u4e24\u4e2a\u5b57\u6bcd\uff0c\u7136\u540e\u8981\u628a\u8bfb\u5165\u540e\u7684\u4f4d\u7f6e$++$\u3002\n\n\u7136\u540e\u5462\uff1f\u7136\u540e\u5c31\u5b8c\u4e86\u3002\n\n\u4e0a\u4ee3\u7801\uff1a\n\n```cpp\ninline int ids(int u) {return u==rc(fc(u));}\ninline void connect(int u,int f,int s) {fc(u)=f;tr[f].ch[s]=u;}\ninline void pushup(int u)\n{\n    if(!u) return;\n    tr[u].siz=tr[lc(u)].siz+tr[rc(u)].siz+1;\n    tr[u].valt=tr[lc(u)].valt|tr[rc(u)].valt|(1<<tr[u].val);\n}\ninline void update(int u)\n{\n    tr[u].rev^=1;\n    swap(lc(u),rc(u));\n}\n\ninline void pushdown(int u)\n{\n    if(!tr[u].rev) return;\n    if(lc(u)) update(lc(u));\n    if(rc(u)) update(rc(u));\n    tr[u].rev=0;\n}\n\ninline void rotate(int u)\n{\n    int f=fc(u),ff=fc(f),s1=ids(u),s2=ids(f);\n    connect(tr[u].ch[s1^1],f,s1);connect(f,u,s1^1);connect(u,ff,s2);\n    pushup(f);pushup(u);\n}\n\ninline void splay(int u,int to)\n{\n    while(fc(u)!=to)\n    {\n        if(fc(fc(u))==to) rotate(u);\n        else if(ids(u)==ids(fc(u))) rotate(fc(u)),rotate(u);\n        else rotate(u),rotate(u);\n    }\n}\n\ninline int rnk(int k)\n{\n    int u=root;\n    while(u)\n    {\n        pushdown(u);\n        if(tr[lc(u)].siz+1==k) return u;\n        else if(tr[lc(u)].siz>=k) u=lc(u);\n        else k=k-tr[lc(u)].siz-1,u=rc(u);\n    }\n}\n\ninline int split(int l,int r)\n{\n    int x=rnk(l-1),y=rnk(r+1);\n    splay(x,0);splay(y,x);\n    return lc(y);\n}\n\ninline void insert(int pos,int val)\n{\n    split(pos,pos-1);\n    int u=rc(root),v=++utot;lc(u)=v;\n    tr[v].siz=1;tr[v].fa=u;tr[v].val=val;tr[v].valt=(1<<val);\n    pushup(u);pushup(fc(u));pushup(fc(fc(u)));\n}\n\ninline void erase(int pos)\n{\n    int u=split(pos,pos);delt[u]=1;\n    lc(fc(u))=0;fc(u)=0;\n}\n\ninline void reverse(int l,int r)\n{\n    int u=split(l,r);\n    update(u);\n}\n\nvoid prepush(int u)\n{\n    if(!u) return;\n    prepush(fc(u));pushdown(u);\n}\n\ninline int getpos(int pos)\n{\n    if(delt[used[pos]]) return 1;\n    const int &u=used[pos];\n    prepush(u);splay(u,0);\n    return tr[lc(u)].siz+1;\n}\n\ninline int getcol(int l,int r)\n{\n    int u=split(l,r),res=0;u=tr[u].valt;\n    while(u) res++,u=u-(u&(-u));\n    return res;\n}\n\nint build(int l,int r,int f)\n{\n    if(l>r) return 0;\n    int mid=(l+r)>>1,u=++utot;\n    fc(u)=f;used[mid]=u;tr[u].siz=1;\n    if(mid!=1&&mid!=n+2) tr[u].val=pre[mid]-'a',tr[u].valt=1<<tr[u].val;\n    lc(u)=build(l,mid-1,u);\n    rc(u)=build(mid+1,r,u);\n    pushup(u);\n    return u;\n}\n\ntemplate<typename T>\ninline void read(T &x)\n{\n    char c;int f=1;\n    while(!isdigit(c=getchar())) (c=='-')&&(f=-1);\n    x=c^48;\n    while(isdigit(c=getchar())) x=x*10+(c^48);\n    x*=f;\n}\n\nint main()\n{\n    int x,y,t;\n    char in[10],opt[10];\n    read(n);read(t);\n    scanf(\"%s\",pre+2);\n    root=build(1,n+2,root);\n    while(t--)\n    {\n        scanf(\"%s\",opt);read(x);x++;\n        if(opt[0]=='I') scanf(\"%s\",in),insert(x+1,in[0]-'a');\n        else if(opt[0]=='D') erase(x);\n        else if(opt[0]=='R') read(y),y++,reverse(x,y);\n        else if(opt[0]=='P') printf(\"%d\\n\",getpos(x)-1);\n        else if(opt[0]=='T') printf(\"%c\\n\",(char)tr[rnk(x)].val+'a');\n        else read(y),y++,printf(\"%d\\n\",getcol(x,y));\n    }\n    return 0;\n}\n```\n\n",
        "postTime": 1597735249,
        "uid": 199750,
        "name": "\u8bd5\u8bd5\u4e8b\u5b9e\u4e0a\u5417",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P5217 \u3010\u8d2b\u7a77\u3011"
    }
]