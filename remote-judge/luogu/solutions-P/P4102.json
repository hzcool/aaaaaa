[
    {
        "content": "\u5495\u4e86\u51e0\u5929\u7ec8\u4e8e\u6765\u4e86~\n\n\u8fd9\u4e2a\u9898\u9996\u5148\u770b\u6570\u636e\u8303\u56f4\u53d1\u73b0\u662f $n \\le 100$ \u7684\u70b9\u5bf9\u4e4b\u95f4\u8def\u5f84\u8ba1\u6570\uff0c\u5176\u4e2d\u5e26\u6709\u8def\u5f84\u957f\u5ea6\u7684\u9650\u5236\uff0c\u90a3\u5f88\u660e\u663e\u5c31\u8ddf\u90bb\u63a5\u77e9\u9635\u7684\u5e42\u8131\u4e0d\u4e86\u5173\u7cfb\uff0c\u90a3\u4e48\u4e3b\u8981\u7684\u96be\u70b9\u5c31\u5728\u4e8e\u5982\u4f55\u5904\u7406\u8def\u5f84\u957f\u5ea6\u7684\u5e73\u65b9\u8fd9\u4ef6\u4e8b\u3002\n\n\u5927\u4f53\u7684\u601d\u8def\u662f\u9012\u5f52\uff0c\u5148\u6c42\u51fa $m = \\lfloor \\frac{k}{2} \\rfloor$ \u65f6\u7684\u7b54\u6848\uff0c\u518d\u5229\u7528 $m$ \u65f6\u7684\u7b54\u6848\u63a8\u51fa $k$ \u7684\u7b54\u6848\u3002\u8003\u8651\u7ef4\u62a4\u4e09\u4e2a\u77e9\u9635 $A,B,C$ \u5206\u522b\u4ee3\u8868\u5f53\u524d **\u6240\u6709\u8def\u5f84\u957f\u5ea6\u7684 $0,1,2$ \u6b21\u65b9\u4e4b\u548c**\u3002\n\n\u7b80\u5355\u8d77\u89c1\uff0c\u8fd9\u91cc\u53ea\u8ba8\u8bba $k$ \u4e3a\u5076\u6570\uff0c\u5373 $k=2m$ \u65f6\u7684\u60c5\u51b5\uff0c\u5947\u6570\u60c5\u51b5\u662f\u57fa\u672c\u540c\u7406\u7684\u3002\u8003\u8651\u5bf9\u4e8e\u67d0\u4e00\u4e2a\u6709\u5e8f\u70b9\u5bf9 $(u,v)$\uff0c\u4ee4 $a_i$ \u4e3a\u4ece $u$ \u5230 $v$ \u957f\u5ea6\u6070\u4e3a $i$ \u7684\u8def\u5f84\u6570\u91cf\uff0c\u5219\u6709\uff1a\n\n$$A_{u,v} = \\sum_{i=1}^m a_i,\\ B_{u,v} = \\sum_{i=1}^m ia_i,\\ C_{u,v} = \\sum_{i=1}^m i^2a_i$$\n\n\u800c\u5bf9\u4e8e\u6700\u957f\u8def\u5f84\u9650\u5236\u4e3a $k=2m$ \u65f6\u7684 $A,B,C$\uff08\u4e0d\u59a8\u8bb0\u4e3a $A',B',C'$\uff09\u6709\uff1a\n\n$$A'_{u,v} = \\sum_{i=1}^{2m} a_i = A_{u,v}+\\sum_{i=1}^m a_{i+m}$$\n\n$$B'_{u,v} = \\sum_{i=1}^{2m} ia_i = B_{u,v}+\\sum_{i=1}^m ia_{i+m}+m\\sum_{i=1}^m a_{i+m}$$\n\n$$C'_{u,v} = \\sum_{i=1}^{2m} i^2a_i = C_{u,v}+\\sum_{i=1}^m i^2a_{i+m}+2m\\sum_{i=1}^m ia_{i+m}+m^2\\sum_{i=1}^m a_{i+m} $$\n\n\u4e0d\u59a8\u4ee4\u539f\u56fe\u7684\u90bb\u63a5\u77e9\u9635\u4e3a $G$\u3002\u6211\u4eec\u6240\u719f\u77e5\u7684\u662f\uff0c\u5bf9\u4e8e\u4efb\u610f\u7684 $i$\uff0c\u5168\u4f53 $a_i$ \u5230\u5168\u4f53 $a_{i+m}$ \u7684\u53d8\u5316\u662f\u53ef\u4ee5\u7528\u5168\u4f53 $a_i$ \u5bf9\u5e94\u7684\u77e9\u9635\u4e58\u4e0a $G^m$ \u6765\u523b\u753b\u7684\uff0c\u90a3\u4e48\u5bf9\u4e8e $a_i$ \u7684\u524d\u7f00\u548c\uff08\u5373 $A$ \u5230 $A'$ \u7684\u53d8\u5316\uff09\u5176\u5b9e\u4e5f\u662f\u5b8c\u5168\u76f8\u540c\u7684\u3002\u4e8e\u662f\u5bf9\u7167\u4e0a\u5f0f\u5373\u5f97\uff1a\n\n$$A' = A+A \\cdot G^m$$\n\n\u540c\u7406\u66f4\u6709\n\n$$B' = B+B \\cdot G^m+m \\cdot A \\cdot G^m$$\n\n$$C' = C+C \\cdot G^m+2m \\cdot B \\cdot G^m+m^2 \\cdot A \\cdot G^m$$\n\n\u90a3\u4e48\u53ea\u8981\u5728\u9012\u5f52\u8fc7\u7a0b\u4e2d\u8bb0\u5f55 $G^m$ \u5373\u53ef\u3002$k$ \u4e3a\u5947\u6570\u7684\u60c5\u51b5\uff0c\u53ea\u8981\u518d\u52a0\u4e0a\u4e00\u6b21 $m=1$ \u5373\u53ef\uff0c\u662f\u5b8c\u5168\u7c7b\u4f3c\u7684\u3002\u590d\u6742\u5ea6 $O(n^3 \\log k + q)$\u3002\u53ef\u80fd\u7565\u5361\u5e38\u3002\n\n\u4ee3\u7801\uff1a\n\n```cpp\n#include <iostream>\n#include <cstdio>\n#include <cstring>\n#include <cstdlib>\n#include <algorithm>\n#define mod 1000000007\n\nusing namespace std;\ntypedef long long ll;\nconst int MAXN = 105; \ninline int readint()\n{\n\tint res = 0, f = 1;\n\tchar c = 0;\n\twhile(!isdigit(c))\n\t{\n\t\tc = getchar();\n\t\tif(c=='-')\n\t\t\tf = -1;\n\t}\n\twhile(isdigit(c))\n\t\tres = res*10+c-'0', c = getchar();\n\treturn res*f;\n}\nint n,m,k,q;\ninline int modd(int x)\n\t{ return x>=mod?x-mod:x; } \nstruct Mat\n{\n\tint a[MAXN][MAXN];\n\tMat()\n\t\t{ memset(a,0,sizeof(a)); } \n\tMat operator+(const Mat t) const\n\t{\n\t\tMat res;\n\t\tfor(int i = 1; i<=n; i++)\n\t\t\tfor(int j = 1; j<=n; j++)\n\t\t\t\tres.a[i][j] = modd(a[i][j]+t.a[i][j]);\n\t\treturn res;\n\t}\n\tMat operator*(const Mat t) const\n\t{\n\t\tMat res;\n\t\tfor(int i = 1; i<=n; i++)\n\t\t\tfor(int j = 1; j<=n; j++)\n\t\t\t\tif(t.a[i][j])\n\t\t\t\t\tfor(int k = 1; k<=n; k++)\n\t\t\t\t\t\tres.a[i][k] = (1ll*res.a[i][k]+1ll*a[j][k]*t.a[i][j])%mod;\n\t\treturn res; \n\t}\n\tMat operator*(const int t) const\n\t{\n\t\tMat res;\n\t\tfor(int i = 1; i<=n; i++)\n\t\t\tfor(int j = 1; j<=n; j++)\n\t\t\t\tres.a[i][j] = 1ll*a[i][j]*t%mod;\n\t\treturn res; \n\t}\n}G,c,ans0,ans1,ans2;\ninline Mat unit()\n{\n\tMat res;\n\tfor(int i = 1; i<=n; i++)\n\t\tres.a[i][i] = 1;\n\treturn res;\n} \ninline void solve(int t)\n{\n\tif(t==1)\n\t{\n\t\tc = G, ans0 = unit();\n\t\treturn;\n\t}\n\tsolve(t/2);\n\tint x = t/2;\n\tans2 = ans2+ans2*c+ans1*c*(2*x)+ans0*c*(1ll*x*x%mod);\n\tans1 = ans1+ans1*c+ans0*c*x;\n\tans0 = ans0+ans0*c;\n\tc = c*c;\n\tif(t&1)\n\t{\n\t\tans0 = ans0+c;\n\t\tans1 = ans1+c*(t-1);\n\t\tans2 = ans2+c*(1ll*(t-1)*(t-1)%mod);\n\t\tc = c*G;\n\t}\n}\n\nint main()\n{\n\tn = readint(), m = readint(), k = readint(), q = readint();\n\tfor(int i = 1; i<=m; i++)\n\t{\n\t\tint u = readint(), v = readint();\n\t\tG.a[u][v]++;\n\t}\n\tsolve(k+1);\n\twhile(q--)\n\t{\n\t\tint x = readint(), y = readint();\n\t\tprintf(\"%d\\n\",ans2.a[x][y]); \n\t}\n\treturn 0;\n}\n\n```\n",
        "postTime": 1593843893,
        "uid": 31098,
        "name": "Caro23333",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P4102 \u3010[HEOI2014]\u6797\u4e2d\u8def\u5f84 \u3011"
    },
    {
        "content": "[\u535a\u5ba2](https://gzy-blog.pages.dev/posts/p4102-heoi2014-%E6%9E%97%E4%B8%AD%E8%B7%AF%E5%BE%84-%E9%A2%98%E8%A7%A3/)\n\n\u8bbe $A[i][j]$ \u4e3a\u4ece $i$ \u70b9\u5230 $j$ \u70b9\u7684\u8fb9\u7684\u6570\u91cf\u3002\n\n\u8bbe\uff1a\n$$\n\\begin{aligned}\n\nE_0[L] & = \\sum_{i = 1}^LA^i\\\\\nE_1[L] & = \\sum_{i = 1}^Li\\times A^i\\\\\nE_2[L] & = \\sum_{i = 1}^Li^2\\times A^i\\\\\n\n\\end{aligned}\n$$\n\u7b54\u6848\u5c31\u662f $E_2[k]$\u3002\n\n\u8003\u8651\u7528\u5206\u6cbb\u6c42\u89e3\u8fd9\u4e09\u4e2a\u77e9\u9635\u3002\n\n\u5f53 $L$ \u662f\u5076\u6570\u65f6\uff1a\n$$\n\\begin{aligned}\n\nE_0[L] & = \\sum_{i = 1}^LA^i\\\\& = \\sum_{i = 1}^{L/2}A^i  +A^{L/2}\\times \\sum_{i = 1}^{L/2}A^i\\\\&=E_0[L/2]+A^{L/2}\\times E_0[L/2]\\\\\n\nE_1[L]& = \\sum_{i = 1}^Li\\times A^i\\\\ \n& = \\sum_{i = 1}^{L/2}i\\times A^i+A^{L/2}\\times \\sum_{i=1}^{L/2}[(i+L/2)\\times A^i]\\\\ &=E_1[L/2]+A^{L/2}\\times(\\sum_{i=1}^{L/2}i\\times A^i+L/2\\times\\sum_{i=1}^{L/2}A^i)\\\\\n&=E_1[L/2]+A^{L/2}\\times(E_1[L/2]+L/2\\times E_0[L/2])\\\\\n\nE_2[L]& = \\sum_{i = 1}^Li^2\\times A^i\\\\ \n& = \\sum_{i = 1}^{L/2}i^2\\times A^i+A^{L/2}\\times \\sum_{i=1}^{L/2}[(i+L/2)^2\\times A^i]\\\\\n& = \\sum_{i = 1}^{L/2}i^2\\times A^i+A^{L/2}\\times \\sum_{i=1}^{L/2}[(i^2+2i(L/2)+(L/2)^2\\times A^i]\\\\\n&=E_2[L/2]+A^{L/2}\\times(\\sum_{i=1}^{L/2}i^2\\times A^i+L\\times\\sum_{i=1}^{L/2}i\\times A^i+L^2/4\\times\\sum_{i=1}^{L/2}A^i)\\\\\n&=E_2[L/2]+A^{L/2}\\times(E_2[L/2]+L\\times E_1[L/2]+L^2/4\\times E_0[L/2])\\\\\n\n\\end{aligned}\n$$\n\u5f53 $L$ \u662f\u5947\u6570\u65f6\uff1a\n$$\n\\begin{aligned}\n\nE_0[L] & = \\sum_{i = 1}^LA^i\\\\\n&=A+A\\times\\sum_{i = 1}^{L-1}A^i\\\\&=A+A\\times E_0[L-1]\\\\\nE_1[L] & = \\sum_{i = 1}^Li\\times A^i\\\\&\n=A+A\\times\\sum_{i = 1}^{L-1}((i+1)\\times A^i)\\\\\n&=A+A\\times(\\sum_{i = 1}^{L-1}i\\times A^i+\\sum_{i = 1}^{L-1} A^i)\\\\\n&=A+A\\times (E_1[L-1]+E_0[L-1])\\\\\nE_2[L] & = \\sum_{i = 1}^Li^2\\times A^i\\\\\n&=A+A\\times\\sum_{i = 1}^{L-1}((i+1)^2\\times A^i)\\\\\n&=A+A\\times\\sum_{i = 1}^{L-1}((i^2+2i+1)\\times A^i)\\\\\n&=A+A\\times(\\sum_{i = 1}^{L-1}i^2\\times A^i+2\\sum_{i = 1}^{L-1} i\\times A^i+\\sum_{i = 1}^{L-1} A^i)\\\\\n&=A+A\\times (E_2[L-1]+2E_1[L-1]+E_0[L-1])\\\\\n\n\\end{aligned}\n$$\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(n^3\\log{k})$\u3002\n\n\u4ee3\u7801\uff1a\n\n```cpp\n#include<bits/stdc++.h>\n#define per(x,y,z) for(int x=(y);(x)<=(z);++(x))\n#define ll long long\nusing namespace std;\nconst int N=110,p=1e9+7;\nint n,m,k,q;\nstruct mx{ll s[N][N];mx(){memset(s,0,sizeof(s));}}A,E0,E1,E2,s;\nmx operator*(mx a,mx b){\n    mx c;per(k,1,n)per(i,1,n)per(j,1,n) \n        c.s[i][j]=(c.s[i][j]+(a.s[i][k]*b.s[k][j])%p)%p;\n    return c;\n}\nmx operator+(mx a,mx b){\n    per(i,1,n) per(j,1,n) \n        a.s[i][j]=(a.s[i][j]+b.s[i][j])%p;\n    return a;\n}\nmx operator*(mx a,ll b){\n    per(i,1,n) per(j,1,n) \n        a.s[i][j]=(a.s[i][j]*b)%p;\n    return a;\n}\nvoid solve(int L){\n    if(L==1){s=E0=E1=E2=A;return;}\n    if(L&1){\n        solve(L-1);\n        E2=A+(A*(E2+E1*2+E0));\n        E1=A+(A*(E1+E0));\n        E0=A+(A*E0);\n        s=s*A;\n    }else{\n        solve(L/2);\n        ll L2=L/2;\n        E2=E2+s*(E2+E1*L+E0*(L2*L2%p));\n        E1=E1+s*(E1+E0*(L2%p));\n        E0=E0+(s*E0);\n        s=s*s;\n    }\n}\nsigned main(){\n    ios::sync_with_stdio(false);\n    cin>>n>>m>>k>>q;\n    per(i,1,m){\n        int x,y;cin>>x>>y;\n        A.s[x][y]++;\n    }\n    solve(k);\n    while(q--){\n        int s,t;cin>>s>>t;\n        cout<<E2.s[s][t]<<'\\n';\n    }\n}\n```\n\n\n\n",
        "postTime": 1666431489,
        "uid": 238310,
        "name": "2019gzy",
        "ccfLevel": 3,
        "title": "P4102 \u9898\u89e3"
    }
]