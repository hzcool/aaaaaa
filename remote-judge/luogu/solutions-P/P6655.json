[
    {
        "content": "\u603b\u7684\u65b9\u6848\u6570\u4e00\u5171\u6709 $S=\\prod\\limits_{i=2}^n r_i-l_i+1$\uff0c\u7136\u540e\u6211\u4eec\u72ec\u7acb\u7b97\u6bcf\u4e2a\u7ed3\u70b9\u7684\u8d21\u732e\u3002\n\n\u6839\u8282\u70b9\u7684\u8d21\u732e\u5c31\u662f $S$\uff0c\u800c\u5176\u4ed6\u7ed3\u70b9\u7684\u8d21\u732e\u4f9d\u8d56\u4e8e\u5176\u7236\u8282\u70b9\u662f\u5426\u4e3a\u5236\u9ad8\u70b9\u3002\n\n\u4ece\u6bcf\u4e2a\u70b9\u7684\u671f\u671b\u8003\u8651\u4f1a\u6bd4\u8f83\u7b80\u5355\uff0c\u8bbe $f_i$ \u4e3a\u968f\u673a\u4e00\u79cd\u65b9\u6848\u4e0b $i$ \u662f\u5236\u9ad8\u70b9\u7684\u671f\u671b\uff0c\u90a3\u4e48\u6700\u7ec8\u7b54\u6848\u5c31\u662f $\\sum\\limits_{i=1}^n f_i S$\u3002\n\n\u56e0\u4e3a $r_i<i$\uff0c\u663e\u7136\u53ef\u4ee5 DP \u8ba1\u7b97\u671f\u671b\uff1a\u521d\u59cb $f_1=1$\uff0c\u8f6c\u79fb\u65b9\u7a0b\u4e3a $f_i=\\sum\\limits_{j=l_i}^{r_i} f_j[h_j\\le h_i]\\times \\frac{1}{r_i-l_i+1}$\u3002\n\n\u73b0\u5728\u95ee\u9898\u53d8\u6210\u4e86\u6c42 $[l,r]$ \u533a\u95f4\u5185\u9ad8\u5ea6\u503c\u5c0f\u4e8e\u7b49\u4e8e $h_i$ \u7684 $f_j$ \u603b\u548c\uff0c$h_i$ \u6bd4\u8f83\u5927\u5148\u79bb\u6563\u5316\u3002\n\n\u53ef\u4ee5\u79bb\u7ebf\u89e3\u51b3\uff0c\u628a\u6240\u6709\u8be2\u95ee\u6309\u9ad8\u5ea6\u6392\u5e8f\uff0c\u7136\u540e\u4e00\u4e2a\u4e2a\u628a $f_i$ \u503c\u63d2\u5165\u5230\u6811\u72b6\u6570\u7ec4\u91cc\uff0c\u6c42\u4e2a\u533a\u95f4\u548c\u5c31\u662f\u7b54\u6848\u3002\n\n\u4e5f\u53ef\u4ee5\u5229\u7528\u4e3b\u5e2d\u6811\u5728\u7ebf\u89e3\u51b3\uff0c\u76f4\u63a5\u6c42\u7b2c $r$ \u4e2a\u7248\u672c\u548c\u7b2c $l-1$ \u4e2a\u7248\u672c\u7684 $[1,h_i]$ \u7684\u533a\u95f4\u548c\u7684\u5dee\uff0c\u5728\u6c42\u51fa $f_i$ \u540e\u63d2\u5165\u5230\u5f53\u524d\u7248\u672c $h_i$ \u7684\u4f4d\u7f6e\u3002\n\n\u4ee3\u7801\u5982\u4e0b\uff1a\n\n```c++\n#include <bits/stdc++.h>\nusing namespace std;\ntypedef long long LL;\nconst int INF = 0x3f3f3f3f;\nconst LL mod = 998244353;\nconst int N = 100005;\n\nLL pow_mod(LL x, LL n) {\n    LL res = 1;\n    while (n) {\n        if (n & 1) res = res * x % mod;\n        x = x * x % mod;\n        n >>= 1;\n    }\n    return res;\n}\nstruct Node {\n    int ls, rs, val;\n} tr[N * 20];\nint root[N], ck;\nvoid update(int &u, int o, int l, int r, int x, int v) {\n    u = ++ck;\n    tr[u] = tr[o];\n    tr[u].val = (tr[u].val + v) % mod;\n    if (l == r) return;\n    int mid = l + r >> 1;\n    if (x <= mid)\n        update(tr[u].ls, tr[o].ls, l, mid, x, v);\n    else\n        update(tr[u].rs, tr[o].rs, mid + 1, r, x, v);\n}\nLL query(int u, int o, int l, int r, int x, int y) {\n    if (x <= l && r <= y) {\n        return tr[u].val - tr[o].val;\n    }\n    int mid = l + r >> 1;\n    LL res = 0;\n    if (x <= mid) res += query(tr[u].ls, tr[o].ls, l, mid, x, y);\n    if (y > mid) res += query(tr[u].rs, tr[o].rs, mid + 1, r, x, y);\n    return res;\n}\nint a[N], b[N], l[N], r[N];\n\nint main() {\n    int n;\n    scanf(\"%d\", &n);\n    for (int i = 1; i <= n; i++) scanf(\"%d\", &a[i]), b[i] = a[i];\n    sort(b + 1, b + n + 1);\n    LL sb = 1;\n    for (int i = 2; i <= n; i++) {\n        scanf(\"%d%d\", &l[i], &r[i]);\n        sb = sb * (r[i] - l[i] + 1) % mod;\n    }\n    LL ans = 0;\n    for (int i = 1; i <= n; i++) {\n        a[i] = lower_bound(b + 1, b + n + 1, a[i]) - b;\n        LL now = i == 1 ? 1 : (query(root[r[i]], root[l[i] - 1], 1, n, 1, a[i]) % mod + mod) % mod * pow_mod(r[i] - l[i] + 1, mod - 2) % mod;\n        update(root[i], root[i - 1], 1, n, a[i], now);\n        ans += now * sb % mod;\n    }\n    ans %= mod;\n    printf(\"%lld\\n\", ans);\n    return 0;\n}\n```\n\n",
        "postTime": 1605257187,
        "uid": 54357,
        "name": "OMG_wc",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P6655 \u3010[YsOI2020]\u5236\u9ad8\u3011"
    },
    {
        "content": "\u5927\u6982\u548c\u524d\u51e0\u5929\u6708\u8d5b T3 \u633a\u50cf\u7684...\n\n\u5728\u8fd9\u91cc\u63a8\u8350\u4e00\u4e0b\u6708\u8d5b T3 \u7684[\u9898\u89e3](https://www.luogu.com.cn/blog/Fairicle/ti-xie-p6834-cnoi2020-meng-yuan-post)\n\n\u5bf9\u4e8e\u8fd9\u9898\u4ecd\u7136\u8003\u8651\u52a0\u5165\u4e00\u4e2a\u70b9\u4f1a\u5bf9\u7ed3\u679c\u6709\u4ec0\u4e48\u5f71\u54cd\uff08\u4ec5\u5bf9\u67d0\u4e00\u9897\u6811\u800c\u8a00\uff0c\u76f8\u5f53\u4e8e\u6c42\u671f\u671b\uff09\n\n\u8bb0\u5b83\u4e3a $i$\uff0c\u7236\u4eb2\u662f $fa$ \u5219\u82e5 $h_{fa}>h_i$ \u65e0\u8d21\u732e\uff0c\u82e5 $h_{fa}\\le h_i$ \u624d\u4f1a\u6709\u8d21\u732e\u3002\n\n\u4e0d\u59a8\u4ee4 $f_i$ \u4ee3\u8868 $i$ \u6210\u4e3a\u5236\u9ad8\u70b9\u7684\u671f\u671b\u4e2a\u6570\uff0c\u5219\u6709 $f_i=\\sum_{i=l_i}^{r_i}f_{fa}\\times \\frac{1}{r_i-l_i+1}$ \u4e58\u4e0a $\\frac{1}{r_i-l_i+1}$ \u81ea\u7136\u662f\u56e0\u4e3a\u6c42\u671f\u671b\u3002\n\n\u7531\u4e8e\u9898\u76ee\u6c42\u7684\u662f\u603b\u65b9\u6848\u6570\uff0c\u6240\u4ee5\u6700\u540e\u7684\u7b54\u6848\u4e3a $\\sum_{i=1}^n f_i \\times \\prod_{i=2}^n(r_i-l_i+1)$\n\n\u7ef4\u62a4\u7684\u8bdd\u8fd8\u662f\u79bb\u7ebf\u505a\uff0c\u5f00\u6876\uff0c\u7136\u540e\u4ece\u5c0f\u5230\u5927\u679a\u4e3e $h$ \u6254\u5230 BIT \u4e2d\u7edf\u8ba1\u5373\u53ef\u3002\n\ncode\uff1a\n```cpp\n#include\"bits/stdc++.h\"\nusing namespace std;\n#define ll long long\n#define ul unsigned long long\n#define ui unsigned int\n#define ri register int\n#define pb push_back\n#define mp make_pair\n#define mod 998244353\nchar p[30]={'0','a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z'};\ninline ll rd(){\n\tll x=0,flag=1;\n\tchar ch=getchar();\n\twhile(ch<'0'||ch>'9'){if(ch=='-') flag=-1;ch=getchar();}\n\twhile(ch>='0'&&ch<='9'){x=x*10+(ch^48);ch=getchar();}\n\treturn x*flag;\n}\n#define N 100010\nll n,h[N],l[N],r[N],c[N],b[N],pre[N],f[N];\nll inv[N];\nll ans;\nvector<int>buc[N];\ninline int lowbit(int x){return x & ( - x ) ;}\ninline void init(){\n\tinv[0]=1,inv[1]=1;\n\tfor(ri i=2;i<=n;++i) inv[i]=(mod-(mod/i))*inv[mod%i]%mod;\n}\ninline void add(int x,ll v){\n\tif(x<=0) return;\n\tfor(ri i=x;i<=n;i+=lowbit(i)) c[i]+=v,c[i]%=mod; \n}\ninline ll sum(int x){\n\tif(x<=0) return 0;\n\tll ans=0;for(ri i=x;i>0;i-=lowbit(i)) ans+=c[i];\n\treturn ans;\n}\nint main()\n{\n\tstd::ios::sync_with_stdio(false);\n    cin>>n;init();\n    for(ri i=1;i<=n;++i) cin>>h[i],b[i]=h[i];for(ri i=2;i<=n;++i) cin>>l[i]>>r[i];sort(b+1,b+1+n);\n    int m=unique(b+1,b+1+n)-b-1;\n    for(ri i=1;i<=n;++i){\n    \tint val=h[i];\n    \th[i]=lower_bound(b+1,b+1+m,h[i])-b;\n    \tpre[i]=val;buc[h[i]].push_back(i);\n\t}\n\t//cout<<inv[2]<<endl;\n\tfor(ri i=1;i<=m;++i){\n\t\tint siz=buc[i].size();\n\t\tfor(ri j=0;j<siz;++j){\n\t\t\tif(buc[i][j]==1) {f[buc[i][j]]=1;add(buc[i][j],1);continue;}\n\t\t\tf[buc[i][j]]=(sum(r[buc[i][j]])-sum(l[buc[i][j]]-1)+mod)%mod;f[buc[i][j]]=f[buc[i][j]]*inv[r[buc[i][j]]-l[buc[i][j]]+1]%mod;\n\t\t\tadd(buc[i][j],f[buc[i][j]]);\n\t\t\t//cout<<buc[i][j]<<\" \"<<f[buc[i][j]]<<endl;\n\t\t}\n\t}\n\tfor(ri i=1;i<=n;++i) ans=ans+f[i],ans%=mod;\n\tfor(ri i=2;i<=n;++i) ans=ans*(r[i]-l[i]+1)%mod;\n\tcout<<ans;\n\treturn 0;\n}\n\n```\n",
        "postTime": 1600841632,
        "uid": 135839,
        "name": "Fairicle",
        "ccfLevel": 6,
        "title": "\u9898\u89e3 P6655 \u3010[YsOI2020]\u5236\u9ad8\u3011"
    },
    {
        "content": "## \u9898\u76ee\u7b80\u8ff0\n\n> - \u5b9a\u4e49\u4e00\u9897\u4ee5 $1$ \u4e3a\u6839\u7684\u6570\u5f53\u4e2d\u7684\u70b9 $u$ \u662f\u201c\u597d\u70b9\u201d\u5f53\u4e14\u4ec5\u5f53\u4ee5\u4e0b\u4e24\u4e2a\u6761\u4ef6\u4efb\u610f\u6ee1\u8db3\u5176\u4e00\n>   - $u=1$\n>   - $v$ \u4e3a $u$ \u7684\u7236\u4eb2\uff0c$h_u\\leq h_v$ \u4e14 $v$ \u4e3a\u597d\u70b9\u3002\n> - \u6bcf\u4e2a\u8282\u70b9 $i(2\\leq i\\leq n)$ \u7684\u7236\u4eb2\u5728 $[L_i,R_i]$ \u95f4\u968f\u673a\u6311\u9009\uff0c\u6c42\u6240\u6709\u60c5\u51b5\u597d\u70b9\u6570\u7684\u548c\u3002\n> - $n\\leq 10^5$\uff0c$L_i\\leq R_i\\leq i$\u3002\n\n## \u89e3\u9898\u601d\u8def\n\n\u5047\u8bbe $f_i$ \u4e3a $i$ \u8282\u70b9\u4e3a\u201c\u597d\u70b9\u201d\u7684\u671f\u671b\uff0c\u90a3\u4e48\u4e0d\u96be\u53d1\u73b0\n$$\nf_i=\\sum_{j=L_i}^{R_i}[h_j\\geq h_i]\\times f_j\n$$\n\u81f3\u6b64\u6709\u4e86\u4e00\u4e2a $n^2$ \u505a\u6cd5\uff0c\u4f46\u662f\u8fd8\u4e0d\u591f\u3002\u4e0d\u96be\u628a $f_i$ \u53d8\u6210\u5982\u4e0b\uff1a\n$$\nf_i=\\sum_{j=1}^{R_i}[h_j\\geq h_i]\\times f_j-\\sum_{j=1}^{L_i-1}[h_j\\geq h_i]\\times f_j\n\n\n$$\n\u4e8e\u662f\u5c31\u53d8\u6210\u4e86\u4e00\u4e2a\u7c7b\u4f3c\u4e8e\u524d\u7f00\u548c\u7684\u95ee\u9898\uff0c\u4f46\u662f\u6709\u4e00\u4e2a\u5386\u53f2\u72b6\u6001\u9700\u8981\u7ef4\u62a4\u3002\u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u5148\u79bb\u6563\u5316 $h$ \u518d\u5f00\u4e00\u4e2a\u7ebf\u6bb5\u6811\u6765\u7ef4\u62a4\u6bcf\u4e2a $h$ \u6570\u503c\u51fa\u73b0\u5bf9\u5e94 $p$ \u7684\u548c\u3002\u5bf9\u4e8e\u4e00\u4e2a\u65b0\u6c42\u51fa\u6765\u7684 $f_i$ \u6211\u4eec\u8981\u4fee\u6539\u4e00\u4e2a\u70b9\u503c\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u53ef\u6301\u4e45\u5316\u7ebf\u6bb5\u6811\u6765\u7ef4\u62a4\uff0c\u5b8c\u7ed3\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log n)$\n\n## \u53c2\u8003\u4ee3\u7801\n\n```cpp\n#include<iostream>\n#include<map>\n#include<algorithm>\nusing namespace std;\n#define ll long long\nconst int MOD=998244353;\nconst int MAXN=1e5+5;\nstruct node{\n\tint ls,rs,sum;\n}a[MAXN<<5];\nint rt[MAXN];\nint cnt=0;\nint n;int h[MAXN],g[MAXN];\nint L[MAXN],R[MAXN];\nint p[MAXN];\nmap<int,int> M;int tot=0;\nll ksm(ll a,int b){\n\tll res=1;\n\twhile(b){\n\t\tif(b&1) res=res*a%MOD;\n\t\ta=a*a%MOD;\n\t\tb=b>>1;\n\t}\n\treturn res;\n}\nll inv(int x){\n\treturn ksm(x,MOD-2);\n}\nvoid build(int &id,int l,int r){\n\tid=++cnt;\n\tif(l==r) return;\n\tint mid=l+r>>1;\n\tbuild(a[id].ls,l,mid);\n\tbuild(a[id].rs,mid+1,r);\n\treturn;\n}\nvoid ins(int &id,int copy,int l,int r,int x,int v){\n\tid=++cnt;\n\ta[id]=a[copy];\n\tif(l==r){a[id].sum=(a[id].sum+v)%MOD;return;}\n\tint mid=l+r>>1;\n\tif(mid>=x) ins(a[id].ls,a[id].ls,l,mid,x,v);\n\telse ins(a[id].rs,a[id].rs,mid+1,r,x,v);\n\ta[id].sum=(a[a[id].ls].sum+a[a[id].rs].sum)%MOD;\n\treturn;\n}\nint query(int id,int l,int r,int L,int R){\n\t//cout<<l<<\" \"<<r<<endl;\n\tif(L<=l&&r<=R) return a[id].sum;\n\tint mid=l+r>>1;\n\tint ans=0;\n\tif(L<=mid) ans=(ans+query(a[id].ls,l,mid,L,R))%MOD;\n\tif(mid<R) ans=(ans+query(a[id].rs,mid+1,r,L,R))%MOD;\n\treturn ans;\n}\nint main(){\n\tcin>>n;\n\tfor(int i=1;i<=n;i++){\n\t\tcin>>h[i];\n\t\tg[i]=h[i];\n\t}\n\tfor(int i=2;i<=n;i++)\n\t\tcin>>L[i]>>R[i];\n\tsort(g+1,g+n+1);\n\tfor(int i=1;i<=n;i++)\n\t\tif(!M[g[i]])\n\t\t\tM[g[i]]=++tot;\n\tfor(int i=1;i<=n;i++)\n\t\th[i]=M[h[i]];\n\tbuild(rt[0],1,tot);\n\tp[1]=1;\n\tfor(int i=1;i<=n;i++){\n\t\tif(i!=1) p[i]=(query(rt[R[i]],1,tot,1,h[i])-query(rt[L[i]-1],1,tot,1,h[i])+MOD)*inv(R[i]-L[i]+1)%MOD;\n\t\tins(rt[i],rt[i-1],1,tot,h[i],p[i]);\n\t\t//cout<<h[i]<<\" \"<<p[i]<<endl;\n\t}\n\tll ans=0;\n\tfor(int i=1;i<=n;i++)\n\t\tans=(ans+p[i])%MOD;\n\tfor(int i=1;i<=n;i++)\n\t\tans=ans*(R[i]-L[i]+1)%MOD;\n\tcout<<ans;\n\treturn 0;\n} \n```",
        "postTime": 1672843837,
        "uid": 248400,
        "name": "Inaba_Meguru",
        "ccfLevel": 7,
        "title": "P6655 [YsOI2020]\u5236\u9ad8 \u9898\u89e3"
    }
]