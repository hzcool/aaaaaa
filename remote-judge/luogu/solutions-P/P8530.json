[
    {
        "content": "&#35;Ynoi\u5f00\u59cb\u666e\u53ca\u4e8c\u7ef4\u5206\u5757#\n\n\u6211\u4eec\u8003\u8651\u4e00\u4e2a\u5e7f\u4e3a\u4eba\u77e5\u7684\u4e00\u7ef4\u533a\u95f4\u6570\u989c\u8272 trick\uff1a\u8bb0\u5f55\u6bcf\u4e2a\u4f4d\u7f6e\u4e4b\u524d\u548c\u5b83\u989c\u8272\u76f8\u540c\u7684\u6700\u540e\u4e00\u4e2a\u4f4d\u7f6e\uff0c\u67e5\u8be2 $[l,r]$ \u5c31\u76f8\u5f53\u4e8e\u662f\u67e5\u8be2 $[l,r]$ \u4e2d\u524d\u9a71\u5728 $[0,l-1]$ \u7684\u4f4d\u7f6e\u4e2a\u6570\uff0c\u8fd9\u662f\u4e00\u4e2a\u4e8c\u7ef4\u6570\u70b9\u95ee\u9898\uff0c\u5bb9\u6613\u89e3\u51b3\u3002\n\n\u7136\u800c\u8fd9\u4e2a\u505a\u6cd5\u96be\u4ee5\u76f4\u63a5\u63a8\u5e7f\u5230\u4e8c\u7ef4\uff0c\u56e0\u4e3a\u4f60\u627e\u4e0d\u5230\u5230\u4e00\u4e2a\u5408\u9002\u7684\u5e8f\u3002\u3002\u3002\u56e0\u6b64\u8003\u8651\u964d\u7ef4\uff0c\u5728\u6a2a\u5750\u6807\u4e0a\u83ab\u961f\uff0c\u540c\u65f6\u7ef4\u62a4\u7eb5\u5750\u6807\u4e0a\u7684\u524d\u9a71\u3002\u5148\u5047\u88c5\u6211\u4eec\u5df2\u7ecf\u6709\u4e86\u5feb\u901f\u627e\u5230\u524d\u9a71\u540e\u7ee7\u7684\u65b9\u6cd5\uff0c\u90a3\u4e48\u6211\u4eec\u52a0\u5165/\u5220\u9664\u4e00\u4e2a\u70b9\u65f6\u53ea\u4f1a\u5f71\u54cd\u5230 $O(1)$ \u4e2a\u4f4d\u7f6e\u7684\u524d\u9a71\u503c\uff0c\u4e8e\u662f\u8fd9\u5c31\u662f\u4e00\u4e2a $O(n\\sqrt m)$ \u6b21\u5355\u70b9\u4fee\u6539\uff0c$O(m)$ \u6b21\u4e8c\u7ef4\u6570\u70b9\u7684\u95ee\u9898\u3002\u4f17\u6240\u5468\u77e5\u8fd9\u662f\u4e00\u4e2a\u4e8c\u7ef4\u5206\u5757\uff0c\u5177\u4f53\u53ef\u4ee5\u770b P7448\u3002\n\n\u5173\u4e8e\u5feb\u901f\u627e\u524d\u9a71\u540e\u7ee7\uff0c\u5b9e\u9645\u4e0a\u53ea\u9700\u8981\u7528\u65e0\u589e\u56de\u6eda\u5c31\u53ef\u4ee5\u4e86\u3002~~\u4e0a\u4e00\u6b21\u88ab\u65e0\u589e\u56de\u6eda\u6740\u8fd8\u662f\u5728\u4e0a\u4e00\u6b21~~\u3002\n\n\u4e8e\u662f\u590d\u6742\u5ea6\u5c31\u662f $O(n\\sqrt m+m\\sqrt n)$ \u7684\u4e86\u3002\n\n\u5934\u6587\u4ef6\u5df2\u5220\u3002\n\n```cpp\nint n,m,B,b[N],rb[N],pos[N],p[N],a[N],L1,L2,C,D,bv2[N],bv[L],rbv2[L],rbv[25],pre[N],nxt[N],lst[N];\nui val[N],s1[25][25],s2[25][L],s3[L][25],s4[L][L],sb[L],sv[N],ans[N*10];bool vst[N],del[N];\nstruct qry{int l,r,d,u,id;};vector<qry> vq[N];\nbool cmp(qry u,qry v){return u.r>v.r;}\nvoid init(){\n\tfor(int i=1;i<=D;i++)fill(s1[i],s1[i]+D+1,0),fill(s2[i],s2[i]+C+1,0);\n\tfor(int i=1;i<=C;i++)fill(s3[i],s3[i]+D+1,0),fill(s4[i],s4[i]+C+1,0);\n\tfill(sb,sb+C+1,0),fill(sv,sv+n+1,0);\n}\nvoid update(int x,int y,ui v){\n\tif(y==0){sb[bv2[x]]+=v,sv[x]+=v;return;}\n\tint bx=bv[x=bv2[x]],by=bv[y=bv2[y]];\n\ts1[bx][by]+=v,s2[bx][y]+=v,s3[x][by]+=v,s4[x][y]+=v;\n}\nui query(int x,int y){\n\tui res=0;\n\tfor(int i=1;i<bv2[x];i++)res+=sb[i];\n\tfor(int i=rbv2[bv2[x]-1]+1;i<=x;i++)res+=sv[i];\n\tif(!y)return res;\n\tfor(int i=rbv2[bv2[x]-1]+1;i<=x;i++)if(!del[i]&&pre[i]&&bv2[pre[i]]<bv2[y])res+=val[a[pos[i]]];\n\tfor(int i=rbv2[bv2[y]-1]+1;i<=y;i++)if(!del[i]&&nxt[i]<=x)res+=val[a[pos[i]]];\n\tint bx=bv[x=bv2[x]],by=bv[y=bv2[y]];\n\tfor(int i=1;i<bx;i++)for(int j=1;j<by;j++)res+=s1[i][j];\n\tfor(int i=1;i<bx;i++)for(int j=rbv[by-1]+1;j<y;j++)res+=s2[i][j];\n\tfor(int i=rbv[bx-1]+1;i<x;i++)for(int j=1;j<by;j++)res+=s3[i][j];\n\tfor(int i=rbv[bx-1]+1;i<x;i++)for(int j=rbv[by-1]+1;j<y;j++)res+=s4[i][j];\n\treturn res;\n}\nint main(){\n\tn=read();\n\tfor(int i=1;i<=n;i++)p[i]=read(),pos[p[i]]=i;\n\tfor(int i=1;i<=n;i++)a[i]=read();\n\tfor(int i=1;i<=n;i++)val[i]=read();\n\tm=read(),B=n/sqrt(m);if(!B)B=1;\n\tfor(int i=1;i<=n;i++)b[i]=(i-1)/B+1;\n\tfor(int i=1;i<b[n];i++)rb[i]=i*B;rb[b[n]]=n;\n\tL2=sqrt(n);\n\tfor(int i=1;i<=n;i++)bv2[i]=(i-1)/L2+1;\n\tfor(int i=1;i<bv2[n];i++)rbv2[i]=i*L2;rbv2[C=bv2[n]]=n;\n\tL1=sqrt(C);\n\tfor(int i=1;i<=C;i++)bv[i]=(i-1)/L1+1;\n\tfor(int i=1;i<bv[C];i++)rbv[i]=i*L1;rbv[D=bv[C]]=C;\n\tfor(int i=1,l,r,d,u;i<=m;i++){\n\t\tl=read(),r=read(),d=read(),u=read();\n\t\tif(b[l]==b[r]){\n\t\t\tfor(int j=l;j<=r;j++)vst[a[j]]=0;\n\t\t\tfor(int j=l;j<=r;j++)if(p[j]>=d&&p[j]<=u)vst[a[j]]=1;\n\t\t\tfor(int j=l;j<=r;j++)if(vst[a[j]])ans[i]+=val[a[j]],vst[a[j]]=0;\n\t\t}\n\t\telse vq[b[l]].push_back((qry){l,r,d,u,i});\n\t}\n\tfor(int k=1;k<=b[n];k++)if(vq[k].size()){\n\t\tsort(vq[k].begin(),vq[k].end(),cmp);\n\t\tfill(lst,lst+n+1,0),fill(nxt,nxt+n+1,n+1),fill(del,del+n+1,1);\n\t\tfor(int i=1;i<=n;i++)if(pos[i]>rb[k-1])pre[i]=lst[a[pos[i]]],lst[a[pos[i]]]=i,del[i]=0;\n\t\tfor(int i=1;i<=n;i++)if(pos[i]>rb[k-1]&&pre[i])nxt[pre[i]]=i;\n\t\tinit();\n\t\tfor(int i=1;i<=n;i++)if(pos[i]>rb[k-1])update(i,pre[i],val[a[pos[i]]]);\n\t\tint r=n;\n\t\tfor(auto q:vq[k]){\n\t\t\twhile(r>q.r){\n\t\t\t\tupdate(p[r],pre[p[r]],-val[a[r]]);\n\t\t\t\tif(nxt[p[r]]!=n+1)update(nxt[p[r]],p[r],-val[a[r]]),update(nxt[p[r]],pre[p[r]],val[a[r]]),pre[nxt[p[r]]]=pre[p[r]];\n\t\t\t\tif(pre[p[r]])nxt[pre[p[r]]]=nxt[p[r]];\n\t\t\t\tdel[p[r]]=1,r--;\n\t\t\t}\n\t\t\tfor(int l=rb[k-1]+1;l<q.l;l++){\n\t\t\t\tupdate(p[l],pre[p[l]],-val[a[l]]);\n\t\t\t\tif(nxt[p[l]]!=n+1)update(nxt[p[l]],p[l],-val[a[l]]),update(nxt[p[l]],pre[p[l]],val[a[l]]),pre[nxt[p[l]]]=pre[p[l]];\n\t\t\t\tif(pre[p[l]])nxt[pre[p[l]]]=nxt[p[l]];\n\t\t\t\tdel[p[l]]=1;\n\t\t\t}\n\t\t\tans[q.id]=query(q.u,q.d-1)-query(q.d-1,q.d-1);\n\t\t\tfor(int l=q.l-1;l>rb[k-1];l--){\n\t\t\t\tupdate(p[l],pre[p[l]],val[a[l]]);\n\t\t\t\tif(nxt[p[l]]!=n+1)update(nxt[p[l]],pre[p[l]],-val[a[l]]),update(nxt[p[l]],p[l],val[a[l]]),pre[nxt[p[l]]]=p[l];\n\t\t\t\tif(pre[p[l]])nxt[pre[p[l]]]=p[l];\n\t\t\t\tdel[p[l]]=0;\n\t\t\t}\n\t\t}\n\t}\n\tfor(int i=1;i<=m;i++)printf(\"%u\\n\",ans[i]);\n\treturn 0;\n}\n```",
        "postTime": 1647391734,
        "uid": 77174,
        "name": "FunnyCreatress",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P7721\u3010[Ynoi2007] rcn\u3011"
    },
    {
        "content": "[$\\tt Link$](/problem/P7721)\n\n\u9898\u610f\uff1a\u4e8c\u7ef4\u5e26\u6743\u6570\u989c\u8272\u3002\n\n## \u4e00\u7ef4\u95ee\u9898\n\n\u4e00\u7ef4\u6570\u989c\u8272\u7684\u5e38\u89c1\u505a\u6cd5\u662f\uff1a\u7ef4\u62a4\u6bcf\u4e2a\u989c\u8272\u7684\u4e0a\u4e00\u4e2a\u4e0e\u5176\u989c\u8272\u76f8\u540c\u7684\u4f4d\u7f6e $pre$\uff0c\u7136\u540e\u95ee\u9898\u8f6c\u5316\u4e3a\u533a\u95f4 $[l,r]$ \u4e2d $pre$ \u503c\u5c0f\u4e8e $l$ \u7684\u6570\u7684\u4e2a\u6570\u3002\n\n\u56e0\u4e3a\u5e26\u6743\uff0c\u6240\u4ee5\u4f60\u4e0d\u5f97\u4e0d\u628a\u8fd9\u4e2a\u95ee\u9898\u5199\u6210\u4e8c\u7ef4\u6570\u70b9\u7684\u5f62\u5f0f\uff1a\u6709 $n$ \u4e2a\u70b9 $(i,pre_i)$\uff0c\u70b9\u6709\u70b9\u6743\u3002\u73b0\u5728\u4f60\u8981\u6c42 $[l,r][0,l)$ \u8fd9\u4e2a\u77e9\u9635\u7684\u6743\u503c\u548c\u3002\n\n\u4e8c\u7ef4\u6570\u70b9\u7528\u4e8c\u7ef4\u5206\u5757\uff0c\u6ca1\u505a\u8fc7\u53ef\u4ee5\u53bb\u5199 [$\\tt rdiq$](/problem/P7448)\u3002\u8fd9\u91cc\u7684 $pre$ \u6709\u7740\u8fd9\u6837\u7684\u6027\u8d28\uff1a\u9664\u4e86\u6709\u591a\u4e2a\u4f4d\u7f6e $pre_i=0$ \u4e4b\u5916\u5176\u4f59 $pre$ \u4e92\u4e0d\u76f8\u7b49\u3002\u4e8e\u662f\u5bf9\u4e8e $pre_i=0$ \u7684\u60c5\u51b5\uff0c\u5199\u4e00\u4e2a\u4e00\u7ef4\u5206\u5757\u7ef4\u62a4\u3002\n\n## \u4e8c\u7ef4\u95ee\u9898\n\n\u4e8c\u7ef4\u4e0d\u597d\u76f4\u63a5\u505a\uff0c\u56e0\u4e3a\u4f60\u6ca1\u6709\u4e00\u79cd\u5408\u9002\u7684\u987a\u5e8f\u7ef4\u62a4 $pre$\uff0c\u8003\u8651\u8f6c\u5316\u4e3a\u52a8\u6001\u7684\u4e00\u7ef4\u95ee\u9898\u3002\n\n\u4f46\u662f\u7ed3\u5408 *\u7279\u6b8a\u6027\u8d28 A* \u6765\u60f3\uff1a\u5982\u679c\u4f60\u8be2\u95ee\u7684 $l_1=1,r_1=n$ \u4f1a\u600e\u6837\u5462\uff1f\u8fd9\u65f6\u6211\u4eec\u53ef\u4ee5\u76f4\u63a5\u628a\u6bcf\u4e2a\u70b9\u7684 $y$ \u5750\u6807\u5347\u5e8f\u6392\u5217\uff0c\u53d8\u6210\u4e00\u4e2a\u5e8f\u5217\uff0c\u7136\u540e\u6784\u5efa $pre$\u3002\n\n\u8003\u8651\u501f\u52a9\u83ab\u961f\u8fd9\u79cd\u7c7b\u4f3c\u626b\u63cf\u7ebf\u7684\u4e1c\u897f\uff0c\u628a\u539f\u95ee\u9898\u4ece\u9759\u6001\u53d8\u6210\u52a8\u6001\uff1a\u6211\u4eec\u5728 $x$ \u8f74\u4e0a\u83ab\u961f\uff0c\u7136\u540e\u5bf9\u6240\u6709\u5728\u83ab\u961f\u91cc\u7684\u70b9\uff0c\u6309 $y$ \u5750\u6807\u4ece\u5c0f\u5230\u5927\u6784\u5efa $pre$\uff0c\u8f6c\u6210\u4e00\u7ef4\u95ee\u9898\u3002\u8003\u8651\u83ab\u961f\u7684\u8f6c\u79fb\uff1a\n\n+ \u63d2\u5165\uff1a\u56e0\u4e3a\u8981\u4fdd\u8bc1 $y$ \u5750\u6807\u5347\u5e8f\uff0c\u6240\u4ee5\u5f88\u96be\u505a\u5230\u597d\u7684\u590d\u6742\u5ea6\u3002\n+ \u5220\u9664\uff1a\u7ef4\u62a4 $pre$ \u7684\u9006\u6570\u7ec4 $nxt$\uff0c\u7136\u540e\u7528\u7c7b\u4f3c\u94fe\u8868\u7684\u5199\u6cd5\u4e00\u901a\u4e71\u641e\u5373\u53ef\u3002\n\n\u5220\u9664\u5bb9\u6613\u63d2\u5165\u96be\uff1f\u8003\u8651\u628a\u83ab\u961f\u56de\u6eda\uff0c\u53d8\u6210\u4e0d\u63d2\u5165\u83ab\u961f\u3002\u5e38\u89c1\u7684\u56de\u6eda\u662f\u901a\u8fc7\u6539\u53d8\u6307\u9488\u8f68\u8ff9\u505a\u5230\u4e0d\u5220\u9664\uff0c\u8fd9\u91cc\u8981\u6c42\u5c11\u63d2\u5165\uff0c\u4e8e\u662f\u4f60\u628a\u4e0d\u5220\u9664\u83ab\u961f\u7684\u8f68\u8ff9\u5012\u8fc7\u6765\u5373\u53ef\u3002\n\n## \u4ee3\u7801\n\n[$\\tt Code$](https://www.luogu.com.cn/paste/unvfvncb)",
        "postTime": 1651817714,
        "uid": 368107,
        "name": "xfrvq",
        "ccfLevel": 7,
        "title": "P7721 [Ynoi2007] rcn"
    },
    {
        "content": "[$\\text{Link}$](https://www.luogu.com.cn/problem/P7721)\n## \u9898\u610f\n\u7ed9\u4f60 $n$ \u4e2a\u70b9 $(i,p_i)$\uff0c\u5176\u4e2d $p$ \u662f\u4e00\u4e2a $n$ \u9636**\u6392\u5217**\u3002\u7b2c $i$ \u4e2a\u70b9\u6709\u989c\u8272 $a_i$\uff0c\u6bcf\u79cd\u989c\u8272\u6709\u4e00\u4e2a\u6743\u503c $b_i$\u3002\u6709 $m$ \u6b21\u8be2\u95ee\uff0c\u6bcf\u6b21\u8be2\u95ee\u7ed9\u51fa $l_1,r_1,l_2,r_2$\uff0c\u6c42\u51fa $\\displaystyle\\sum_{k=1}^nb_k\\left[\\sum_{i=l_1}^{r_1}[l_2\\le p_i\\le r_2][a_i=k]\\right]$\uff0c\u5373\u6c42\u77e9\u9635\u989c\u8272\u6743\u503c\u548c\u3002\n\n\u65f6\u95f4 7.5s\uff0c$1\\le p_i,a_i\\le n\\le 10^5,1\\le m\\le 10^6$.\n## \u601d\u8def\n\u524d\u7f6e\u77e5\u8bc6\uff1a[P7448 [Ynoi2007] rdiq](https://www.luogu.com.cn/problem/P7448)\uff08\u6700\u597d\u4f1a\u4f46\u4e0d\u4e00\u5b9a\u9700\u8981\uff09\n\n~~\u867d\u7136\u4e0d\u5361\u5e38\uff0c\u4f46\u662f $10^6$ \u7684\u6570\u636e\u8303\u56f4\u7528\u610f\u4f55\u5728\uff1f~~ update\uff1alxl\uff1a1e6\u5361\u56db\u7ef4\u83ab\u961f\u5457\u3002\n\n\u6211\u7801\u529b\u597d\u5dee\uff0c\u5199\u4e86\u4e09\u5929/kel\n****\n\u9996\u5148\u53ef\u4ee5\u60f3\u5230\u5bf9 $x$ \u8f74\u505a\u83ab\u961f\uff0c\u7136\u540e\u662f\u8981\u505a\u5728 $y$ \u8f74\u4e0a\u5355\u70b9\u4fee\u6539\u533a\u95f4\u6570\u989c\u8272\uff08\u8fd9\u662f\u56e0\u4e3a $y$ \u8f74\u4e0d\u91cd\u590d\uff09\u3002\n\n\u8bb0 $rp_{p_i}=i,c_i=a_{p_i}$\uff0c\u4ee5\u4e0b\u8ba8\u8bba\u90fd\u662f\u5728 $y$ \u5750\u6807\u4e0a\u7684\u3002\n\n\u8fd9\u4e2a\u4fee\u6539\u5176\u5b9e\u662f\u5728\u5e8f\u5217\u4e0a\u63d2\u5165/\u5220\u9664\uff0c\u6c42\u533a\u95f4\u989c\u8272\u6570\uff0c\u90a3\u4e48\u7528\u94fe\u8868\uff08\u6216\u8005\u5176\u5b83\u7684\u6570\u636e\u7ed3\u6784\uff09\u7ef4\u62a4\u6bcf\u4e2a\u989c\u8272\uff0c\u8bb0\u4e0a\u4e00\u4e2a\u989c\u8272\u4e3a $c_i$ \u7684\u70b9\uff08\u6309 $y$ \u5750\u6807\u6392\u5e8f\uff09\u7684 $y$ \u5750\u6807\u4e3a $pre_i$\uff0c\u5219\u63d2\u5165\u5220\u9664\u662f\u5355\u70b9\u4fee\u6539\uff08\u52a0\uff09\uff0c\u67e5\u8be2\u662f\u4e8c\u7ef4\u6570\u70b9\u3002\u53ef\u60dc\u6211\u4eec\u63d2\u5165\u65f6\u8981\u5728\u7ebf\u67e5\u8be2\u524d\u9a71\uff0c\u8fd9\u91cc\u4f1a\u5e26\u4e0a $\\log$\u3002\n\n\u628a\u83ab\u961f\u56de\u6eda\uff0c\u53d8\u6210\u4e0d\u63d2\u5165\u83ab\u961f\uff0c\u6211\u4eec\u4fbf\u53ea\u9700\u8981\u5220\u9664\uff0c\u7528\u94fe\u8868\u53ef\u4ee5\u505a\u5230\u3002\n\n\u73b0\u5728\u9700\u8981\u652f\u6301\u7684\u662f $O(1)-O(\\sqrt n)$ \u7684\u5355\u70b9\u52a0\u77e9\u5f62\u6c42\u548c\u7684\u6570\u636e\u7ed3\u6784\u3002[\u770b\u7740\u773c\u719f](https://www.luogu.com.cn/problem/P7448)\u3002\u4e8b\u5b9e\u4e0a\uff0c\u8fd9\u91cc\u5355\u70b9\u52a0\u7684\u70b9\u53ea\u6709 $(i,pre_i)$\uff0c$y$ \u5750\u6807**\u51e0\u4e4e**\u662f\u65f6\u523b\u4e0d\u91cd\u590d\u7684\u3002\u4e3a\u4ec0\u4e48\u662f\u51e0\u4e4e\uff1f\u56e0\u4e3a $pre_i=0$ \u7684\u70b9\u4f1a\u6709\u5f88\u591a\u3002\u90a3\u4e48\u6211\u4eec\u5c06\u8fd9\u4e9b\u70b9\u53d6\u51fa\u6765\uff0c\u5bf9\u4e8e\u70b9 $(i,j)(j\\ne 0)$\uff0c$j$ \u662f\u4e0d\u91cd\u590d\u7684\uff0c\u91c7\u7528 $\\text{rdiq}$ \u4e2d\u7684\u4e8c\u7ef4\u5206\u5757\u7ed3\u6784\uff0c\u5b9e\u65f6\u66f4\u65b0\u6bcf\u4e2a $x$ \u5bf9\u5e94\u7684 $y$\uff08\u548c $y$ \u5bf9\u5e94\u7684 $x$\uff09\uff0c\u5bf9\u4e8e\u70b9 $(i,j)(j=0)$\uff0c\u6211\u4eec\u5199\u4e00\u4e2a\u4e00\u7ef4\u5206\u5757\u7ef4\u62a4\u5373\u53ef\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\u662f $O(n\\sqrt m+m\\sqrt n)$\uff0c\u7a7a\u95f4\u590d\u6742\u5ea6\u662f $O(n+m)$\u3002\u6ce8\u610f\u83ab\u961f\u5757\u957f\u662f $\\dfrac{n}{\\sqrt m}$\uff0c\u4e0d\u8981\u8ba9\u65f6\u95f4\u590d\u6742\u5ea6\u5e26\u4e0a $O(m\\sqrt m)$\u3002\n\n> \u8fd9\u9053\u9898\u8fd8\u662f\u6709\u4e00\u5b9a\u542f\u53d1\u6027\u7684\uff0c\u5bf9\u4e8e\u9ad8\u7ef4\u7684\u8303\u56f4\u67e5\u8be2\u95ee\u9898\uff0c\u53ef\u4ee5\u4f7f\u7528\u83ab\u961f\u89e3\u51b3\u5176\u4e2d\u4e00\u4e9b\u7ef4\u5ea6\uff0c\u6570\u636e\u7ed3\u6784\u7ef4\u62a4\u5176\u4f59\u7ef4\u5ea6\u6765\u505a\u5230\u66f4\u4f18\u79c0\u7684\u590d\u6742\u5ea6\u3002\u5f53\u8fd9\u91cc\u4f7f\u7528\u83ab\u961f\u7ef4\u62a4\u4e00\u7ef4\uff0c\u6570\u636e\u7ed3\u6784\u7ef4\u62a4\u4e09\u7ef4\u65f6\uff0c\u5b9e\u9645\u4e0a\u7b49\u4ef7\u4e8e\u4e00\u4e2a\u5e26\u4fee\u6539\u7684\u4e09\u7ef4\u95ee\u9898\uff0c\u56e0\u4e3a\u4e00\u7ef4\u7684\u83ab\u961f\u5c31\u662f\u4e00\u4e2a\u626b\u63cf\u7ebf\uff0c\u4e5f\u53ef\u4ee5\u770b\u51fa\u83ab\u961f\u5b9e\u9645\u4e0a\u662f\u4e00\u4e2a\u4e8c\u7ef4\u7684\u626b\u63cf\u7ebf\u3002\u2014\u2014lxl\n\n****\n\u8fd9\u9898\u4e0d\u600e\u4e48\u5361\u5e38\uff0c\u53ea\u8981\u4f60\u590d\u6742\u5ea6\u6b63\u786e\uff0c\u5e38\u6570\u4e0d\u79bb\u8c31\u57fa\u672c\u4e0a\u4e0d\u4f1a\u88ab\u5361\u3002\n\n\u4ee5\u4e0b\u4ee3\u7801\u4ec5\u4f9b\u53c2\u8003\uff0c\u8bf7\u52ff\u6284\u88ad\u3002\n\n\u7ec6\u8282\u5de8\u591a\u7684\u4ee3\u7801\uff1a\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define ll long long\n#define ui unsigned\nnamespace IO{//by cyffff\n\t\n}\nconst int N=1e5+10,M=1e6+10,sq1=317,sq2=5706,nq1=N/sq2+10,nq2=N/sq1+10;\nint p[N],a[N],b[N],c[N],rp[N],curL,curR;\nint blo,bel[N];\nint n,m,k;\nui ans[M];\nstruct query{\n\tint l,r,id;\n\tinline friend bool operator<(const query &a,const query &b){\n\t\treturn bel[a.l]==bel[b.l]?a.r>b.r:bel[a.l]<bel[b.l];\n\t}\n}q[M];\nstruct Matrix{\n\tint l1,r1,l2,r2;\n}sav[M];\nstruct Delete{\n\tint pre,suf,ind;\n}tem[N];\nint pre[N],suf[N],las[N],fir[N];\nstruct Two_D_Blocker{\n\tint bel1[N],bel2[N],bl1[N],bl2[N],sz1,sz2;\n\tint P[N],rP[N];\n\tui s1[nq1][nq1],s2[nq2][nq1],s3[nq1][nq2],s4[nq2][nq2],s5[N],s6[N];\n\tui a[N],sum[nq2];\n\tinline void init(){\n\t\tfor(int i=1;i<=n;i++)\n\t\t\trp[p[i]]=i;\n\t\tfor(int i=1;i<=n;i++)\n\t\t\tbel1[i]=(i-1)/sq1+1,\n\t\t\tbel2[i]=(i-1)/sq2+1;\n\t\tfor(int i=n;i>=1;i--)\n\t\t\tbl1[bel1[i]]=i,\n\t\t\tbl2[bel2[i]]=bel1[i];\n\t}\n\tinline void modify(int x,int y,ui v){\n\t\tif(y==0){\n\t\t\tsum[bel1[x]]+=v,a[x]+=v;\n\t\t\treturn ;\n\t\t}\n\t\tint x1=bel1[x],x2=bel2[x],y1=bel1[y],y2=bel2[y];\n\t\ts1[x2][y2]+=v;\n\t\ts2[x1][y2]+=v;\n\t\ts3[x2][y1]+=v;\n\t\ts4[x1][y1]+=v;\n\t\ts5[x]+=v,s6[y]+=v;\n\t\tP[x]=y,rP[y]=x;\n\t}\n\tinline ui query(int x,int y){\n\t\tif(!x) return 0;\n\t\tui ans=0;\n\t\tint x1=bel1[x],x2=bel2[x],y1=bel1[y],y2=bel2[y];\n\t\tint qx=bl1[x1],px=bl2[x2],qy=bl1[y1],py=bl2[y2];\n\t\tfor(int i=1;i<x2;i++)\n\t\t\tfor(int j=1;j<y2;j++)\n\t\t\t\tans+=s1[i][j];\n\t\tfor(int i=px;i<x1;i++)\n\t\t\tfor(int j=1;j<y2;j++)\n\t\t\t\tans+=s2[i][j];\n\t\tfor(int i=1;i<x2;i++)\n\t\t\tfor(int j=py;j<y1;j++)\n\t\t\t\tans+=s3[i][j];\n\t\tfor(int i=px;i<x1;i++)\n\t\t\tfor(int j=py;j<y1;j++)\n\t\t\t\tans+=s4[i][j];\n\t\tfor(int i=qx;i<=x;i++)\n\t\t\tif(P[i]<=y)\n\t\t\t\tans+=s5[i];\n\t\tfor(int i=qy;i<=y;i++)\n\t\t\tif(rP[i]<qx)\n\t\t\t\tans+=s6[i];\n\t\tfor(int i=1;i<x1;i++)\n\t\t\tans+=sum[i];\n\t\tfor(int i=qx;i<=x;i++)\n\t\t\tans+=a[i];\n\t\treturn ans;\n\t}\n\tinline void clear(){\n\t\tmemset(s1,0,sizeof(s1));\n\t\tmemset(s2,0,sizeof(s2));\n\t\tmemset(s3,0,sizeof(s3));\n\t\tmemset(s4,0,sizeof(s4));\n\t\tmemset(s5,0,sizeof(s5));\n\t\tmemset(s6,0,sizeof(s6));\n\t\tmemset(a,0,sizeof(a));\n\t\tmemset(sum,0,sizeof(sum));\n\t}\n}ds;\ninline ui query(int id){\n\tint l1=sav[id].l2,r1=sav[id].r2,r2=sav[id].l2-1;\n\treturn ds.query(r1,r2)-ds.query(l1-1,r2);\n}\nbool vis[N];\ninline ui calc(int id){\n\tint l1=sav[id].l1,r1=sav[id].r1,l2=sav[id].l2,r2=sav[id].r2;\n\tui ans=0;\n\tfor(int i=l1;i<=r1;i++)\n\t\tif(l2<=p[i]&&p[i]<=r2&&!vis[a[i]])\n\t\t\tvis[a[i]]=1,ans+=b[a[i]];\n\tfor(int i=l1;i<=r1;i++)\n\t\tvis[a[i]]=0;\n\treturn ans;\n}\ninline void init2(int bL){\n\tmemset(las,0,sizeof(las));\n\tmemset(pre,0,sizeof(pre));\n\tmemset(suf,0,sizeof(suf));\n\tfor(int i=1;i<=n;i++)\n\t\tif(rp[i]>=bL) pre[i]=las[c[i]],las[c[i]]=i;\n\tmemset(las,0,sizeof(las));\n\tfor(int i=n;i>=1;i--)\n\t\tif(rp[i]>=bL) suf[i]=las[c[i]],las[c[i]]=i;\n}\nint main(){\n//\tfreopen(\"make_data.in\",\"r\",stdin);\n\tn=read();\n\tfor(int i=1;i<=n;i++)\n\t\tp[i]=read();\n\tfor(int i=1;i<=n;i++)\n\t\ta[i]=read(),c[p[i]]=a[i];\n\tfor(int i=1;i<=n;i++)\n\t\tb[i]=read();\n\tm=read();\n\tfor(int i=1;i<=m;i++){\n\t\tint l1=read(),r1=read(),l2=read(),r2=read();\n\t\tsav[i]={l1,r1,l2,r2};\n\t\tq[i]={l1,r1,i}; \n\t}\n\tds.init();\n\tblo=n/sqrt(m);\n\tfor(int i=1;i<=n;i++)\n\t\tbel[i]=(i-1)/blo+1;\n\tsort(q+1,q+m+1);\n\tfor(int i=1,j=1,bL=1;i<=bel[n];i++,bL+=blo){\n\t\tint bR=min(n,bL+blo-1);\n\t\tif(bel[q[j].l]!=i) continue;\n\t\tcurL=bL-1,curR=n;\n\t\tinit2(bL);\n\t\tfor(int i=bL;i<=n;i++)\n\t\t\tds.modify(p[i],pre[p[i]],b[a[i]]);\n\t\tfor(;bel[q[j].l]==i;j++){\n\t\t\tint L=q[j].l,R=q[j].r,top=0;\n\t\t\tif(bel[R]==i){\n\t\t\t\tans[q[j].id]=calc(q[j].id);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tcurL=bL;\n\t\t\twhile(curR>R){\n\t\t\t\tint t=p[curR];\n\t\t\t\tif(suf[t])\n\t\t\t\t\tds.modify(suf[t],t,-b[c[suf[t]]]),pre[suf[t]]=pre[t];\n\t\t\t\tds.modify(t,pre[t],-b[c[t]]);\n\t\t\t\tif(pre[t])\n\t\t\t\t\tsuf[pre[t]]=suf[t];\n\t\t\t\tif(suf[t])\n\t\t\t\t\tds.modify(suf[t],pre[t],b[c[suf[t]]]);\n\t\t\t\tcurR--;\n\t\t\t}\n\t\t\twhile(curL<L){\n\t\t\t\tint t=p[curL];\n\t\t\t\ttem[++top]={pre[t],suf[t],t};\n\t\t\t\tif(suf[t])\n\t\t\t\t\tds.modify(suf[t],t,-b[c[suf[t]]]),pre[suf[t]]=pre[t];\n\t\t\t\tds.modify(t,pre[t],-b[c[t]]);\n\t\t\t\tif(pre[t])\n\t\t\t\t\tsuf[pre[t]]=suf[t];\n\t\t\t\tif(suf[t])\n\t\t\t\t\tds.modify(suf[t],pre[t],b[c[suf[t]]]);\n\t\t\t\tcurL++;\n\t\t\t}\n\t\t\tans[q[j].id]=query(q[j].id);\n\t\t\twhile(top){\n\t\t\t\tDelete tmp=tem[top--];\n\t\t\t\tif(tmp.suf) \n\t\t\t\t\tds.modify(tmp.suf,pre[tmp.suf],-b[c[tmp.suf]]),pre[tmp.suf]=tmp.ind;\n\t\t\t\tds.modify(tmp.ind,tmp.pre,b[c[tmp.ind]]);\n\t\t\t\tpre[tmp.ind]=tmp.pre,suf[tmp.ind]=tmp.suf;\n\t\t\t\tif(tmp.pre)\n\t\t\t\t\tsuf[tmp.pre]=tmp.ind;\n\t\t\t\tif(tmp.suf)\n\t\t\t\t\tds.modify(tmp.suf,pre[tmp.suf],b[c[tmp.suf]]);\n\t\t\t}\n\t\t}\n\t\tds.clear();\n\t}\n\tfor(int i=1;i<=m;i++)\n\t\twrite(ans[i]),putc('\\n');\n\tflush();\n}\n```\n\n\u518d\u89c1 qwq~",
        "postTime": 1647495503,
        "uid": 365127,
        "name": "cyffff",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P7721\u3010[Ynoi2007] rcn\u3011"
    },
    {
        "content": "**P8530 sol**\n\n\u539f\u95ee\u9898\u770b\u8d77\u6765\u5f88\u4e0d\u5f31\u4e8e\u4e09\u7ef4\u6570\u70b9\uff0c\u6240\u4ee5\u91c7\u7528\u4e8c\u7ef4\u626b\u63cf\u7ebf\u770b\u770b\u9000\u5316\u4e00\u7ef4\u7684\u95ee\u9898\u3002\n\n\u5373\u6211\u4eec\u5c06\u5728 $[l_1,r_1]$ \u7684\u70b9\u62ff\u51fa\u6765\uff0c\u6309\u7167 $p_i$ \u5927\u5c0f\u4ece\u5c0f\u5230\u5927\u6392\u5e8f\uff0c\u770b\u8d77\u6765\u5c31\u662f\u4e2a\u4e8c\u7ef4\u5355\u6743\u989c\u8272\u6570\uff0c\u8bbe $lst_i$ \u8868\u793a\u4f4d\u7f6e\u4e3a $p_i$ \u7684\u6570\u524d\u4e00\u4e2a\uff08$p_i$ \u5e8f\u6392\u5e8f\uff09\u989c\u8272\u76f8\u540c\u7684\u6570\u662f\u8c01\uff08\u4e5f\u7528 $p_i$ \u4f5c\u4e3a\u952e\u503c\uff09\uff0c\u90a3\u4e48\u7b49\u4ef7\u4e8e $l_2 \\leq p_i \\leq r_2,lst_{p_i} < l_2$ \u7684\u4e8c\u7ef4\u6570\u70b9\u3002\n\n\u95ee\u9898\u53d8\u5f97\u660e\u786e\uff1a\u4f7f\u7528\u4e0d\u6dfb\u52a0\u83ab\u961f\u4ee3\u66ff\u4e8c\u7ef4\u626b\u63cf\u7ebf\uff0c\u53ef\u4ee5\u7ebf\u6027\u7ef4\u62a4\u6240\u6709\u7684 $(p_i,lst_{p_i})$\uff0c\u5728\u56de\u6eda\u65f6\u6211\u4eec\u5220\u9664\u4e00\u4e2a\u70b9\uff0c\u5c31\u76f4\u63a5\u4ece\u94fe\u8868\u91cc\u62ff\u51fa\u6765\u66f4\u6539\u524d\u540e\u76f8\u90bb\u4fe1\u606f\u5373\u53ef\u3002\n\n\u95ee\u9898\u53d8\u6210\u4e86 $O(n \\sqrt m)$ \u5355\u70b9\u52a0 $O(q)$ \u77e9\u5f62\u67e5\u8be2\uff0c\u5bb9\u6613\u53d1\u73b0\u6240\u6709\u52a0\u5165\u7684\u5355\u70b9\u4e2d\u9664\u4e86 $lst_{p_i} = 0$ \u7684\u6240\u6709\u70b9\u5750\u6807\u90fd\u662f\u5728\u4e24\u4e2a\u7ef4\u4e0a\u4e92\u76f8\u4e0d\u91cd\u590d\u7684\uff0c\u5bf9\u4e8e $lst_{p_i} = 0$ \u7684\u5355\u72ec\u7ef4\u62a4\u4e00\u4e2a\u4e00\u7ef4\u5206\u5757\uff0c\u5bf9\u4e8e\u5176\u5b83\u70b9\u7528\u4e8c\u7ef4\u5206\u5757\uff0c\u65f6\u95f4\u590d\u6742\u5ea6\u5373\u53ef\u5e73\u8861\u5230 $O(n \\sqrt m)$\u3002\n\n\u6ce8\u610f\u65f6\u9650\uff0c\u5361\u5e38\u3002\u81ea\u5df1~~\u8d3a~~\u7684\u65f6\u5019\u56e0\u4e3a\u4e71\u5f00\u6570\u7ec4\u7a7a\u95f4\u6bcf\u6b21\u83ab\u961f\u6e05\u7a7a\u4e86\u4e00\u4e2a $10 ^ 6$ \u7684\u6570\u7ec4\uff0c\u868c\u3002\n\n",
        "postTime": 1674958762,
        "uid": 132533,
        "name": "Hakuoro",
        "ccfLevel": 0,
        "title": "\u6ce2\u7279\u5bf9\u7ade\u8d5b\u60c5\u6709\u72ec\u949f\uff0c\u4ed6\u7684\u7b2c\u4e00\u90e8\u5e7f\u4e3a\u6d41\u4f20\u7684\u8457\u4f5c\u662f 2077 \u5e74\u51fa\u7248\u7684\u300a\u8c03\u6559\u8d85\u840c AI \u4f7f\u5176\u79d2\u5207 Ynoi\u300b\u3002"
    },
    {
        "content": "\u4f60\u5c31\u5bf9\u4e00\u4e2a\u7ef4\u5ea6\u505a\u83ab\u961f\u3002\n\n\u7136\u540e\u76f8\u5f53\u4e8e\u5e26\u4fee\u533a\u95f4\u6570\u989c\u8272\u3002\n\n\u8fd9\u4e2a\u662f well-known \u7684\uff0c\u7ef4\u62a4 $pre_i$ \u8868\u793a\u524d\u9762\u7b2c\u4e00\u4e2a\u4e0e\u5176\u76f8\u7b49\u7684\u6570\u7684\u4e0b\u6807\u3002\n\n\u7136\u540e\u5c31\u662f\u6c42\u533a\u95f4\u4e2d $pre<l$ \u7684\u6570\u91cf\u3002\n\n\u4f60\u8003\u8651\u600e\u4e48\u7ef4\u62a4 $pre$ \u7684\u53d8\u5316\u3002\n\n\u8fd9\u4e2a\u662f\u5957\u8def\uff0c\u7528\u53ea\u5220\u9664\u7684\u83ab\u961f\u7ef4\u62a4 $pre$ \u548c $nxt$ \u5373\u53ef\u3002\n\n\u5220\u9664\u7684\u65f6\u5019\u5c31\u64a4\u9500\u81ea\u8eab\u8d21\u732e\uff0c\u7136\u540e\u628a $nxt_i$ \u7684 $pre$ \u6539\u6210 $pre_i$\u3002\u8fd9\u4e2a\u5c31\u662f\u66f4\u6539 $O(1)$ \u4e2a $pre$\u3002\n\n\u7136\u540e\u6c42\u533a\u95f4\u4e2d $pre<l$ \u7684\u6570\u91cf\u663e\u7136\u5c31\u662f\u52a8\u6001\u4e8c\u7ef4\u6570\u70b9\u3002\n\n\u4e8c\u7ef4\u5206\u5757\u5373\u53ef\u3002\u53ef\u4ee5\u770b rdiq \u90a3\u4e2a\u9898\u3002\n\nP.S. \u8fd9\u4e2a $pre$ \u7684\u6027\u8d28\u5f88\u597d\uff0c\u51e0\u4e4e\u4e0d\u91cd\uff08\u5bf9\u4e8e\u4e8c\u7ef4\u5206\u5757\u6765\u8bb2\uff09\uff0c\u4f46\u53ef\u80fd\u51fa\u73b0 $0$ \u7684\u60c5\u51b5\uff0c\u8fd9\u4e2a\u53ef\u4ee5\u53e6\u5916\u5199\u4e2a\u5206\u5757\u7ef4\u62a4\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\sqrt m+m\\sqrt n)$\n\n\u65b0\u7684 Ynoi \u60ef\u4f8b\u597d\u50cf\u662f\u4e0d\u653e\u4ee3\u7801\u3002",
        "postTime": 1647426205,
        "uid": 203623,
        "name": "Ntokisq",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P7721 [Ynoi2007] rcn"
    },
    {
        "content": "\u963b\u6321\u6211\u4e00\u904d\u8fc7\u7684\u7adf\u7136\u662f\u540c\u5757\u7684\u66b4\u529b......\n\n6.5 update\uff1a\u7ecf@[FutaRimeWoawaSete](https://www.luogu.com.cn/user/132533)\u7684\u63d0\u9192\u4fee\u6539\u4e86\u201c\u666e\u53ca\u201d\u7684\u90e8\u5206\u3002\n\n2023.1.28 update:\u4fee\u6539\u4e86\u4ee3\u7801\u91cc\u7684\u4e00\u4e9b\u7455\u75b5\u3002\n\n**\u524d\u7f6e\u77e5\u8bc6**\n\n\u5206\u5757\uff0c\u533a\u95f4\u6570\u989c\u8272\u7684 `trick`\uff0c\u56de\u6eda\u83ab\u961f\uff0c\u5982\u679c\u505a\u8fc7[rdiq](https://www.luogu.com.cn/problem/P7448)\u90a3\u4f60\u5c31\u7545\u901a\u65e0\u963b\u4e86\u3002\n\n**\u5148\u666e\u53ca\u4e8c\u7ef4\u5206\u5757\uff08\u4f1a\u7684\u8df3\u8fc7\uff09**\n\n\u6211\u4eec\u7406\u89e3\u4e00\u4e0b\u4e00\u7ef4\u5206\u5757\uff0c\u5b83\u76f8\u5f53\u4e8e\u4e00\u4e2a $n^{0.5}$ \u53c9\u6811\uff0c\u4f46\u662f\u7167\u642c\u4e0b\u6765\u5728\u4e8c\u7ef4\u7684\u80cc\u666f\u4e0b\u4f1a\u5e73\u65b9\uff0c\u6240\u4ee5\u6211\u4eec\u727a\u7272\u6811\u7684\u9ad8\u5ea6\uff08\u5e38\u6570\uff09\u6765\u4f18\u5316\uff0c\u5373 $n^{0.25}$ \u53c9\u6811\uff0c\u7b2c\u4e00\u5c42\u662f $n^{0.75}\\times n^{0.75}$\uff08\u7701\u53bb\u4e86\u7b2c $-1$ \u5c42\u7684 $n\\times n$ \u548c\u7b2c $0$ \u5c42\u7684 $n\\times n^{0.75}$ \u548c $n^{0.75}\\times n$\uff09\uff0c\u7b2c\u4e8c\u5c42\u662f $n^{0.75}\\times n^{0.5}$ \u548c $n^{0.5}\\times n^{0.75}$\uff0c\u7136\u540e\u5c31\u662f $n^{0.5}\\times n^{0.5}$ \u7684\u5757\uff0c\u56e0\u4e3a\u8fd9\u9898\u6709\u4e2a\u6027\u8d28\uff1a$x,y$ \u5750\u6807\u4e0d\u91cd\u590d\uff0c\u6240\u4ee5\u6563\u5757\u76f4\u63a5\u679a\u4e3e\u6a2a\u7eb5\u5750\u6807\u5c31\u884c\u4e86\u3002\n\n\u8003\u8651\u6ca1\u6709\u6027\u8d28\u7684\u60c5\u51b5\uff1a\u6211\u4eec\u5728\u5206\u4e00\u4e2a $n^{0.25}\\times n^{1/0.75/0.5/0.25}$ \u7684\u5757\u548c $1\\times n^{1/0.75/0.5/0.25}$ \u7684\u5757\uff0c\u5269\u7684\u66b4\u529b\u5373\u53ef\uff0c\u53ea\u662f\u8fd9\u6837\u7684\u7a7a\u95f4\u5f88\u75af\u72c2......\n\n**\u672c\u9898\u5b9e\u73b0\u601d\u8def**\n\n\u8fd9\u662f\u4e00\u4e2a\u9759\u6001\u533a\u95f4\u6570\u989c\u8272\u7684\u9898\u76ee\uff08`Range Count Numbers`\uff09\uff0c\u4e8c\u7ef4\u7248\u672c\u3002\n\n\u9996\u5148\u8fd9\u79cd\u5927\u89c4\u6a21\u6570\u989c\u8272\u80af\u5b9a\u8981\u7528\u94fe\u8868\u7684 `trick`\uff0c\u6700\u540e\u67e5\u8be2 $lst<l_2$ \u7684\u548c\u5373\u53ef\uff0c\u4f46\u662f\u7528\u56de\u6eda\u83ab\u961f\u6eda\u6eda\u6389\u4e00\u7ef4\u540e\u8fd8\u6709\u4e00\u4e2a $p_i$ \u548c $lst_i$ \u4e24\u7ef4\uff0c\u6240\u4ee5\u8003\u8651\u4e8c\u7ef4\u5206\u5757\uff0c\u56e0\u4e3a $p_i$ \u4e0d\u91cd\u590d\uff0c$lst_i$ \u9664\u4e86 $0$ \u7684\u60c5\u51b5\u80af\u5b9a\u90fd\u4e0d\u91cd\u590d\uff0c\u800c $0$ \u7684\u60c5\u51b5\u90fd\u4f1a\u8ba1\u5165\u7b54\u6848\uff0c\u6240\u4ee5\u4e8c\u7ef4\u5206\u5757\u8bb0\u5f55\u4e0d\u4e3a $0$ \u7684\u90e8\u5206\uff0c\u518d\u6253\u4e00\u4e2a\u4e00\u7ef4\u5206\u5757\u8bb0\u5f55 $0$ \u7684\u90e8\u5206\uff0c\u90fd\u662f $O(1)-O(\\sqrt n)$ \u7684\u5206\u5757\u3002\n\n\u8fd8\u6709\u51e0\u70b9\u503c\u5f97\u6ce8\u610f\uff1a\n\n1. $lst_i$ \u548c $nxt_i$ \u90fd\u8981\u8bb0\u5f55\u3002\n2. \u539f\u5e8f\u5217\u7684\u90a3\u4e00\u7ef4\u5df2\u7ecf\u88ab\u6eda\u6389\u4e86\uff0c\u6240\u4ee5\u94fe\u8868\u662f\u5728 $p_i$ \u90a3\u4e00\u7ef4\u64cd\u4f5c\u7684\u3002\n\n**Code:**\n\n```cpp\n#include <bits/stdc++.h>\n#define ll unsigned int\n#define wr(x,ch) write(x),putchar(ch)\nusing namespace std;\nnamespace IO{\n}\nusing IO::read;\nusing IO::write;\nconst ll N=100005,M=1000005,s=107,s1=6405,s2=305;\nll sum1[N/s1+5][N/s1+5],sum2[N/s1+5][N/s2+5],sum3[N/s2+5][N/s1+5],sum4[N/s2+5][N/s2+5],sum5[N],sum6[N],pos[N],a[N],b[N],\nP[N],idx[N],L[N],n,m,bls,R[N],vis[N],ans[M],lst[N],nxt[N],Q[N],aa[N],del[N];\nll L1[N],L2[N],R1[N],R2[N],idx1[N],idx2[N],bls1,bls2;\nstruct node {\n\tll l,r,id,s,t;\n\tbool operator<(const node &p) const {\n\t\treturn idx[l]==idx[p.l]?r>p.r:l<p.l;\n\t}\n}p[M];\ninline void add(ll x,ll y,const ll delta) {\n\tif(!y) {\n\t\tsum5[x]+=delta,sum6[idx[x]]+=delta;\n\t\treturn ;\n\t}\n\tsum1[idx1[x]][idx1[y]]+=delta;\n\tsum2[idx1[x]][idx2[y]]+=delta;\n\tsum3[idx2[x]][idx1[y]]+=delta;\n\tsum4[idx2[x]][idx2[y]]+=delta;\n}\nll ask(ll x,ll y) {\n\tll tot=0;\n\tfor(ll i=1;i<idx[x];i++) tot+=sum6[i];\n\tfor(ll i=L[idx[x]];i<=x;i++) tot+=sum5[i];\n\tfor(ll i=1;i<idx1[x];i++) \n\t\tfor(ll j=1;j<idx1[y];j++) \n\t\t\ttot+=sum1[i][j];\n\tfor(ll i=1;i<idx1[x];i++) \n\t\tfor(ll j=idx2[L1[idx1[y]]],k=idx2[y];j<k;j++) \n\t\t\ttot+=sum2[i][j];\n\tfor(ll i=idx2[L1[idx1[x]]],j=idx2[x];i<j;i++) \n\t\tfor(ll k=1;k<idx1[y];k++) \n\t\t\ttot+=sum3[i][k];\n\tfor(ll i=idx2[L1[idx1[x]]],j=idx2[x];i<j;i++) \n\t\tfor(ll k=idx2[L1[idx1[y]]],l=idx2[y];k<l;k++) \n\t\t\ttot+=sum4[i][k];\n\tfor(ll i=L2[idx2[x]];i<=x;i++) (!del[i]&&lst[i]&&lst[i]<=y)&&(tot+=b[aa[i]]);\n\tfor(ll i=L2[idx2[y]],cyy=L2[idx2[x]];i<=y;i++) (!del[i]&&nxt[i]&&nxt[i]<cyy)&&(tot+=b[aa[i]]);\n\treturn tot;\n}\nvoid init() {\n\tbls=(n+s-1)/s;\n\tfor(int i=1;i<=bls;i++) {\n\t\tL[i]=R[i-1]+1,R[i]=min(n,s*i);\n\t\tfor(int j=L[i];j<=R[i];j++) idx[j]=i;\n\t}\n\tbls1=(n+s1-1)/s1;\n\tfor(int i=1;i<=bls1;i++) {\n\t\tL1[i]=R1[i-1]+1,R1[i]=min(n,s1*i);\n\t\tfor(int j=L1[i];j<=R1[i];j++) idx1[j]=i;\n\t}\n\tbls2=(n+s2-1)/s2;\n\tfor(int i=1;i<=bls2;i++) {\n\t\tL2[i]=R2[i-1]+1,R2[i]=min(n,s2*i);\n\t\tfor(int j=L2[i];j<=R2[i];j++) idx2[j]=i;\n\t}\n}\nint main() {\n\tn=read();\n\tfor(ll i=1;i<=n;i++) P[i]=read(),Q[P[i]]=i;\n\tfor(ll i=1;i<=n;i++) a[i]=read(),aa[P[i]]=a[i];\n\tfor(ll i=1;i<=n;i++) b[i]=read();\n\tm=read();\n\tinit();\n\tfor(ll i=1;i<=m;i++) p[i].l=read(),p[i].r=read(),p[i].s=read(),p[i].t=read(),p[i].id=i;\n\tsort(p+1,p+m+1);\n\tfor(ll i=1,now=0,tot=0,l,r;i<=m;i++) {\n\t\tif(idx[p[i].l]!=now) {\n\t\t\tnow=idx[p[i].l],l=L[now],r=n;\n\t\t\tmemset(pos,0,sizeof(pos));\n\t\t\tmemset(sum1,0,sizeof(sum1));\n\t\t\tmemset(sum2,0,sizeof(sum2));\n\t\t\tmemset(sum3,0,sizeof(sum3));\n\t\t\tmemset(sum4,0,sizeof(sum4));\n\t\t\tmemset(sum5,0,sizeof(sum5));\n\t\t\tmemset(sum6,0,sizeof(sum6));\n\t\t\tmemset(lst,0,sizeof(lst));\n\t\t\tmemset(nxt,0,sizeof(nxt));\n\t\t\tmemset(del,0,sizeof(del));\n\t\t\tfor(ll j=1;j<=n;j++) if(Q[j]>=l) lst[j]=pos[aa[j]],pos[aa[j]]=j,add(j,lst[j],b[aa[j]]);\n\t\t\tmemset(pos,0,sizeof(pos));\n\t\t\tfor(ll j=n;j>=1;j--) if(Q[j]>=l) nxt[j]=pos[aa[j]],pos[aa[j]]=j;\n\t\t}\n\t\twhile(r>p[i].r) {\n\t\t\tadd(P[r],lst[P[r]],-b[a[r]]),del[P[r]]=1;\n\t\t\tif(nxt[P[r]]) add(nxt[P[r]],P[r],-b[a[r]]),lst[nxt[P[r]]]=lst[P[r]],add(nxt[P[r]],lst[nxt[P[r]]],b[a[r]]);\n\t\t\tif(lst[P[r]]) nxt[lst[P[r]]]=nxt[P[r]];\n\t\t\tr--;\n\t\t}\n\t\twhile(l<p[i].l) {\n\t\t\tadd(P[l],lst[P[l]],-b[a[l]]),del[P[l]]=1;\n\t\t\tif(nxt[P[l]]) add(nxt[P[l]],P[l],-b[a[l]]),lst[nxt[P[l]]]=lst[P[l]],add(nxt[P[l]],lst[nxt[P[l]]],b[a[l]]);\n\t\t\tif(lst[P[l]]) nxt[lst[P[l]]]=nxt[P[l]];\n\t\t\tl++;\n\t\t}\n\t\tans[p[i].id]=ask(p[i].t,p[i].s-1)-ask(p[i].s-1,p[i].s-1);\n\t\twhile(l>L[now]) {\n\t\t\tl--,del[P[l]]=0;\n\t\t\tif(nxt[P[l]]) add(nxt[P[l]],lst[nxt[P[l]]],-b[a[l]]),lst[nxt[P[l]]]=P[l],add(nxt[P[l]],P[l],b[a[l]]);\n\t\t\tif(lst[P[l]]) nxt[lst[P[l]]]=P[l];add(P[l],lst[P[l]],b[a[l]]);\n\t\t}\n\t}\n\tfor(ll i=1;i<=m;i++) wr(ans[i],'\\n');\n\treturn 0;\n}\n```",
        "postTime": 1654003575,
        "uid": 383791,
        "name": "Others",
        "ccfLevel": 7,
        "title": "P8530 \u9898\u89e3"
    },
    {
        "content": "\u4e8c\u7ef4\u5e26\u6743\u6570\u989c\u8272\u3002\n\n\u6839\u636e\u5957\u8def\uff0c\u91c7\u7528\u83ab\u961f\u5957\u4e8c\u7ef4\u5206\u5757\uff0c\u6ca1\u5199\u8fc7\u53bb\u770b `P7448`\u3002\n\n\u4e00\u7ef4\u5e26\u6743\u6570\u989c\u8272\u8c01\u90fd\u4f1a\uff0c\u8bb0\u6bcf\u4e2a\u989c\u8272\u7684\u4e0a\u4e00\u4e2a\u4e0e\u5176\u989c\u8272\u76f8\u540c\u7684\u4f4d\u7f6e $pre$\uff0c\u95ee\u9898\u8f6c\u5316\u4e3a\u67e5\u8be2\u533a\u95f4 $[l,r]$ \u4e2d $pre<l$ \u7684\u6570\u7684\u4e2a\u6570\u3002\n\n\u7136\u540e\u8f6c\u6210\u4e8c\u7ef4\u6570\u70b9\u7684\u5f62\u5f0f\uff0c\u6709 $n$ \u4e2a\u70b9 $(i,pre_i)$\uff0c\u67e5\u8be2 $[l,r][0,l)$ \u8fd9\u4e2a\u77e9\u9635\u7684\u548c\uff0c\u5e26\u4fee\u3002\n\n\u518d\u8003\u8651\u4e8c\u7ef4\uff0c\u9009\u4e00\u7ef4\u5ea6\u8dd1\u83ab\u961f\u3002\n\n\u5269\u4e0b\u7684\u5c31\u662f\u7ef4\u62a4 $pre$\uff0c\u7136\u540e\u52a8\u6001\u4e8c\u7ef4\u6570\u70b9\uff0c\u8dd1 $\\mathcal O(1)-\\mathcal O(\\sqrt n)$ \u4e8c\u7ef4\u5206\u5757\u5373\u53ef\u3002\n\n\u5bf9\u4e8e\u6563\u5757\uff0c\u8003\u8651\u5230 $pre$ \u72ec\u7279\u7684\u6027\u8d28\uff1a\u9664\u4e86\u6709\u591a\u4e2a\u4f4d\u7f6e $pre_i=0$ \u4e4b\u5916\u5176\u4f59 $pre$ \u4e92\u4e0d\u76f8\u7b49\u3002\u4e8e\u662f\u5bf9\u4e8e $pre_i=0$ \u7684\u60c5\u51b5\uff0c\u5199\u4e2a\u4e00\u7ef4\u5206\u5757\u7ef4\u62a4\uff0c\u5176\u4ed6\u5747\u644a\u590d\u6742\u5ea6\u6b63\u786e\u3002\n\n\u8003\u8651\u5230\u8fd9\u4e2a\u83ab\u961f\u5220\u9664\u5bb9\u6613\uff0c\u589e\u52a0\u7206\u70b8\uff0c\u6545\u4f7f\u7528\u56de\u6eda\u83ab\u961f\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal O(n\\sqrt n)$\uff0c\u7a7a\u95f4\u590d\u6742\u5ea6 $\\mathcal O(n)$\u3002\n\n[CODE](https://www.luogu.com.cn/paste/p1xh0fzc)",
        "postTime": 1655162944,
        "uid": 257146,
        "name": "orz_z",
        "ccfLevel": 0,
        "title": "P7721 [Ynoi2007] rcn"
    }
]