[
    {
        "content": "2021/6/19 UPD: \u4fee\u6b63\u4e86\u4e00\u4e9btypo\n\n\u8003\u8651\u5206\u6cbb\uff0c\u5bf9\u4e8e\u4e00\u6bb5\u533a\u95f4 $[L,R]$\uff0c\u4ee4 $mid=\\lfloor\\frac{L+R}{2}\\rfloor$\uff0c\u6211\u4eec\u53ef\u4ee5\u5c06\u5176\u5b50\u533a\u95f4\u5206\u4e3a\u4e09\u7c7b\uff1a\n\n- \u5de6\u7aef\u70b9\u548c\u53f3\u7aef\u70b9\u90fd\u5728 $[L,mid]$ \u4e0a\u3002\n\n- \u5de6\u7aef\u70b9\u548c\u53f3\u7aef\u70b9\u90fd\u5728 $[mid+1,R]$ \u4e0a\u3002\n\n- \u5de6\u7aef\u70b9\u5728 $[L,mid]$ \u4e0a\uff0c\u53f3\u7aef\u70b9\u5728 $[mid+1,R]$ \u4e0a\u3002\n\n\u5bf9\u4e8e\u7b2c\u4e00\u3001\u4e8c\u79cd\u60c5\u51b5\uff0c\u6211\u4eec\u76f4\u63a5\u9012\u5f52\u5230\u8be5\u5b50\u533a\u95f4\u4ee5\u540c\u6837\u7684\u65b9\u6cd5\u6c42\u89e3\uff0c\u4e8e\u662f\u53ea\u9700\u8981\u8003\u8651\u7b2c\u4e09\u79cd\u60c5\u51b5\u7684\u8d21\u732e\u3002\n\n\u4ee4 $fl_i$ \u4e3a\u9009\u53d6 $a_{mid}$ \u7684 $[i,mid]$ \u6bb5\u6700\u5927\u503c\uff0c$gl_i$ \u4e3a\u4e0d\u9009\u53d6 $a_{mid}$ \u7684 $[i,mid]$ \u6bb5\u6700\u5927\u503c\uff0c\n$fr_i$ \u4e3a\u9009\u53d6 $a_{mid+1}$ \u7684 $[mid+1,i]$ \u6bb5\u6700\u5927\u503c\uff0c\n$gr_i$ \u4e3a\u4e0d\u9009\u53d6 $a_{mid+1}$ \u7684 $[mid+1,i]$ \u6bb5\u6700\u5927\u503c\uff0c\u90a3\u4e48\u9898\u76ee\u4e2d\u7684 $f(l,r)=\\max(fl_l+gr_r,gl_l+fr_r,gl_l+gr_r)=\\max(\\max(fl_l,gl_l)+gr_r,gl_l+fr_r)$\u3002\n\n\u8003\u8651\u9009\u53d6 $gl_l+fr_r$ \u7684\u60c5\u51b5\uff0c\u663e\u7136 $\\max(fl_l,gl_l)+gr_r<gl_l+fr_r$\uff0c\u79fb\u9879\uff0c\u5c06\u76f8\u540c\u4e0b\u6807\u7684\u6570\u79fb\u5230\u540c\u4fa7\uff0c\u53ef\u4ee5\u5f97\u5230 $\\max(fl_l-gl_l,0)<fr_r-gr_r$\u3002\n\n\u4e8e\u662f\u6211\u4eec\u5bf9\u4e8e\u6bcf\u4e2a\u5de6\u7aef\u70b9\uff0c\u5373 $[L,mid]$ \u4e2d\u7684\u6240\u6709\u70b9\uff0c\u5c06\u5176 $\\max(fl_l-gl_l,0)$ \u8bb0\u5f55\u5728\u6570\u7ec4 $tl$ \u4e2d\uff0c\u5e76\u5c06 $tl$ \u6392\u5e8f\u3002\u5bf9\u6392\u5e8f\u540e\u7684 $tl$ \u6570\u7ec4\uff0c\u5f00\u4e24\u4e2a\u524d\u7f00\u548c\u6570\u7ec4 $sgl$ \u548c $sml$\uff0c$sgl$ \u4e3a $gl$ \u7684\u524d\u7f00\u548c\uff0c $sml$ \u4e3a $\\max(fl-gl,0)$ \u7684\u524d\u7f00\u548c\u3002\u7136\u540e\u6211\u4eec\u5728 $[mid+1,R]$ \u4e0a\u679a\u4e3e\u53f3\u7aef\u70b9 $i$\uff0c\u4e8c\u5206 $tl$ \u4e2d\u6bd4 $fr_i-gr_i$ \u5c0f\u7684\u5143\u7d20\u4e2a\u6570\uff0c\u82e5\u6709 $k$ \u4e2a\uff0c\u90a3\u4e48\u4ee5 $i$ \u4e3a\u53f3\u7aef\u70b9\uff0c\u5de6\u7aef\u70b9\u5728 $[L,mid]$ \u4e2d\u7684\u6240\u6709\u533a\u95f4\u5bf9\u7b54\u6848\u7684\u8d21\u732e\u4e3a $sgl_{k-1}+(k-l)\\times fr_i+sml_{mid}-sml_{k-1}+(mid-k+1)\\times gr_i$\u3002\n\n\u6700\u540e\u63d0\u9192\u4e00\u4e0b\uff0c\u4e0a\u8ff0\u8fc7\u7a0b\u4e2d\uff0c\u4e0d\u5e94\u5c06 $fl$ \u548c $gl$ \u6570\u7ec4\u53d6\u6a21\uff0c\u56e0\u4e3a\u6211\u4eec\u9700\u8981\u5bf9 $tl$ \u6392\u5e8f\uff0c\u82e5\u53d6\u6a21\u5219\u53ef\u80fd\u4f1a\u5f71\u54cd $tl$ \u4e2d\u5404\u5143\u7d20\u7684\u987a\u5e8f\u3002\n\n\u65f6\u95f4\u590d\u6742\u5ea6\uff1a $O(n\\log^2n)$\u3002\n\n\u4ee3\u7801\uff1a\n\n```cpp\n#include<bits/stdc++.h>\nusing namespace std;\n#define ri register int\ntypedef long long ll;\nconst int maxn=1e5+10,mod=1e9+7;\nstruct node{\n\tll val;\n\tint id;\n\tinline bool operator<(const node &k)const{\n\t\treturn val<k.val;\n\t}\n}tl[maxn];\nint a[maxn],n;\nll ans,fl[maxn],fr[maxn],gl[maxn],gr[maxn],sml[maxn],sgl[maxn];\nvoid solve(int l,int r){\n\tif(l==r){\n\t\tans=(ans+a[l])%mod;\n\t\treturn;\n\t}\n\tint mid=l+r>>1;\n\tsolve(l,mid);\n\tsolve(mid+1,r);\n\tfor(ri i=mid;i>=l;--i){\n\t\tif(i==mid)fl[i]=a[i],fl[i+1]=gl[i]=0;\n\t\telse fl[i]=max(fl[i+1],fl[i+2]+a[i]);\n\t\tif(i==mid-1)gl[i]=a[i],gl[i+1]=0;\n\t\telse if(i!=mid)gl[i]=max(gl[i+1],gl[i+2]+a[i]);\n\t\ttl[i]={max(fl[i]-gl[i],0ll),i};\n\t}\n\tsort(tl+l,tl+mid+1);\n\tsml[l-1]=sgl[l-1]=0;\n\tfor(ri i=l;i<=mid;++i){\n\t\tsml[i]=sml[i-1]+max(fl[tl[i].id],gl[tl[i].id]);\n\t\tsgl[i]=sgl[i-1]+gl[tl[i].id];\n\t}\n\tfor(ri i=mid+1;i<=r;++i){\n\t\tif(i==mid+1)fr[i]=a[i],fr[i-1]=gr[i]=0;\n\t\telse fr[i]=max(fr[i-1],fr[i-2]+a[i]);\n\t\tif(i==mid+2)gr[i]=a[i];\n\t\telse if(i!=mid+1)gr[i]=max(gr[i-1],gr[i-2]+a[i]);\n\t\tri k=lower_bound(tl+l,tl+mid+1,node{fr[i]-gr[i],0})-tl;\n\t\tans=(ans+(sml[mid]-sml[k-1])%mod+(mid-k+1)*(gr[i]%mod)%mod)%mod;\n\t\tans=(ans+(sgl[k-1]%mod)+(k-l)*(fr[i]%mod)%mod)%mod;\n\t}\n}\nint main(){\n\tscanf(\"%d\",&n);\n\tfor(ri i=1;i<=n;++i)scanf(\"%d\",a+i);\n\tsolve(1,n);\n\tprintf(\"%lld\",ans);\n\treturn 0;\n}\n```",
        "postTime": 1619145187,
        "uid": 67942,
        "name": "meyi",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P7482 \u3010\u4e0d\u6761\u7406\u72c2\u8bd7\u66f2\u3011"
    },
    {
        "content": "### Link.\n[Luogu](https://www.luogu.com.cn/problem/P7482)  \n[\u66f4\u7d2c\u7684\u9605\u8bfb\u4f53\u9a8c](https://www.cnblogs.com/pealfrog/p/15171835.html)  \n\n### Description.\n\u7ed9\u5b9a\u4e00\u4e2a\u5e8f\u5217 $\\{a_i\\}$\uff0c\u5b9a\u4e49 $f(l,r)$ \u8868\u793a $[l,r]$ \u4e2d\u53d6\u51fa\u4e00\u4e9b\u4e0d\u76f8\u90bb\u6570\u7684\u6700\u5927\u548c\u3002  \n\u6c42 $\\sum_{l=1}^n\\sum_{r=l}^nf(l,r)$\u3002  \n\n### Solution.\n\u697c\u4e0a\u6709\u4e00\u4e2a\u6b65\u9aa4\u6bd4\u8f83\u590d\u6742\u5176\u5b9e\u7684\u8bf4\u3002  \n\n\u5206\u6cbb\uff0c\u62c6\u8d21\u732e\uff0c\u7136\u540e\u63a5\u4e0b\u6765\u9700\u8981\u8003\u8651\u8de8\u8fc7 $l\\le md,r>md$ \u7684 $f(l,r)$ \u8d21\u732e\u3002  \n\u5de6\u53f3\u4e24\u8fb9\u9664\u4e86\u9009\u4e2d\u70b9\u4e4b\u5916\u4e92\u4e0d\u5e72\u6270\uff0c\u6211\u4eec\u8003\u8651\u76f4\u63a5 `dp` \u7684\u5408\u5e76\u3002  \n\u5148\u5de6\u8fb9\u505a\u4e00\u904d `dp`\uff0c\u53f3\u8fb9\u505a\u4e00\u904d `dp`\uff0c\u8bbe $f_l(i),g_l(i),f_r(i),g_r(i)$ \u8868\u793a\u4ece $md/md+1$ `dp` \u5230 $i$\uff0c$md/md+1$ \u9009\u6216\u4e0d\u9009\u7684\u6700\u5927\u548c\u3002  \n\u7b54\u6848 $f(a,b)$ \u5c31\u662f $\\max(f_l(a)+g_r(b),g_l(a)+f_r(b))$\u3002  \n\u8003\u8651\u51b3\u7b56\uff0c\u82e5 $f_l(a)+g_r(b)<g_l(a)+f_r(b)$\uff0c\u5219\u6709 $f_r(b)-g_r(b)>f_l(a)-g_l(a)$  \n\u7136\u540e\u76f4\u63a5\u5de6\u8fb9\u6309\u7167 $f_l(a)-g_l(b)$ \u6392\u5e8f\uff0c\u5c31\u80fd\u627e\u5230\u51b3\u7b56\u70b9\u3002  \n\u7136\u540e\u7ef4\u62a4\u4e00\u4e0b $f_l(x)$ \u7684\u524d\u7f00\u548c\u548c $g_l(x)$ \u7684\u540e\u7f00\u548c\u5373\u53ef\u3002  \n\n### Coding.\n```cpp\n//\u662f\u554a\uff0c\u4f60\u5c31\u662f\u90a3\u53ea\u9b3c\u4e86\uff0c\u6240\u4ee5\u88ab\u4f60\u78b0\u5230\u4ee5\u540e\uff0c\u5c31\u8f6e\u5230\u6211\u53d8\u6210\u9b3c\u4e86{{{\n#include<bits/stdc++.h>\nusing namespace std;typedef long long ll;\ntemplate<typename T>inline void read(T &x)\n{\n\tx=0;char c=getchar(),f=0;\n\tfor(;c<48||c>57;c=getchar()) if(!(c^45)) f=1;\n\tfor(;c>=48&&c<=57;c=getchar()) x=(x<<1)+(x<<3)+(c^48);\n\tf?x=-x:x;\n}\ntemplate<typename T,typename...L>inline void read(T &x,L&...l) {read(x),read(l...);}/*}}}*/\nconst int N=100005,P=1e9+7;int n,a[N],id[N],rs;\nll fl[N],gl[N],fr[N],gr[N],sf[N],sg[N];\nstruct ${ll f,g;char operator<($ b) const {return f-g<b.f-b.g;}}F[N];\ninline void solve(int l,int r)\n{\n\tint md=(l+r)>>1;if(l==r) return (rs+=a[l])%=P,void();else solve(l,md),solve(md+1,r);\n\tfl[md+1]=0,fl[md]=a[md];for(int i=md-1;i>=l;i--) fl[i]=max(fl[i+1],fl[i+2]+a[i]);\n\tgl[md]=0,gl[md-1]=a[md-1];for(int i=md-2;i>=l;i--) gl[i]=max(gl[i+1],gl[i+2]+a[i]);\n\tfr[md]=0,fr[md+1]=a[md+1];for(int i=md+2;i<=r;i++) fr[i]=max(fr[i-1],fr[i-2]+a[i]);\n\tgr[md+1]=0,gr[md+2]=a[md+2];for(int i=md+3;i<=r;i++) gr[i]=max(gr[i-1],gr[i-2]+a[i]);\n\tint tt=0;for(int i=l;i<=md;i++) F[++tt]=($){fl[i],gl[i]};\n\tsort(F+1,F+tt+1);for(int i=1;i<=tt;i++) sf[i]=sf[i-1]+F[i].f,sg[i]=sg[i-1]+F[i].g;\n\t//printf(\"%d %d %d : %d\\n\",l,md,r,rs);\n\t//if(l==1&&md==2&&r==3) for(int i=1;i<=tt;i++) printf(\"ll %lld %lld\\n\",F[i].f,F[i].g);\n\tfor(int i=md+1;i<=r;i++)\n\t{\n\t\tint wh=lower_bound(F+1,F+tt+1,($){fr[i],gr[i]})-F-1;\n\t\t//if(l==1&&md==2&&r==3) printf(\"rr %lld %lld\\n\",fr[i],gr[i]);\n\t\trs=(rs+(sf[tt]-sf[wh])+gr[i]%P*(tt-wh))%P;\n\t\trs=(rs+sg[wh]+fr[i]%P*wh)%P;\n\t}\n\t//printf(\"%d %d %d : %d\\n\",l,md,r,rs);\n}\nint main()\n{\n\tread(n);for(int i=1;i<=n;i++) read(a[i]);\n\treturn solve(1,n),printf(\"%d\\n\",rs),0;\n}\n```",
        "postTime": 1629604420,
        "uid": 44805,
        "name": "Leap_Frog",
        "ccfLevel": 7,
        "title": "P7482 \u4e0d\u6761\u7406\u72c2\u8bd7\u66f2\uff08\u9898\u89e3\uff09"
    }
]