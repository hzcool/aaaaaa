[
    {
        "content": "> \u4e00\u9053\u5957\u8def\u9898\u2014\u2014\u795ecy\n\n~~\u597d\u50cf\u786e\u5b9e\u633a\u5957\u8def\u7684~~\n\n\u8003\u8651\u6211\u4eec\u8ba9\u6240\u6709$k>\\sqrt n$\u7684\u66b4\u529b\u8df3\uff0c\u9884\u5904\u7406\u6240\u6709$k\\leq\\sqrt n$\u7684\u60c5\u51b5\u5373$sum[i][j]$\u8868\u793a$i$\u5f80\u4e0a\u6bcf$j$\u7ea7\u7956\u5148\u9009\u4e00\u4e2a\u70b9\uff0c\u4e00\u76f4\u5230\u6839\u8282\u70b9\u9009\u7684\u70b9\u7684\u60c5\u51b5\u548c\uff0c\u67e5\u8be2\u5c31\u7c7b\u4f3c\u6811\u4e0a\u5dee\u5206\u5c31\u597d\u4e86\n\n\u90a3\u4e48\u8fd9\u6837\u66b4\u529b\u8df3\u7684\u590d\u6742\u5ea6\u662f$O(n\\sqrt n \\log n)$\uff0c\u9884\u5904\u7406\u662f$O(n\\sqrt n)$\n\n\u5bf9\u65f6\u95f4\u8fdb\u884c\u4f18\u5316\uff0c\u53ef\u4ee5\u4f7f\u7528\u957f\u94fe\u5256\u5206\uff0c\u6bcf\u6b21$O(1)$\u67e5\u8be2k\u7ea7\u7956\u5148\uff0c\u8fd9\u6837\u6211\u4eec\u7684\u603b\u590d\u6742\u5ea6\u5c31\u53ef\u4ee5\u505a\u5230$O(n\\log n+n\\sqrt n)$\u4e86\n\n[\u957f\u94fe\u5256\u5206\u6a21\u677f\u9898](https://www.luogu.com.cn/problem/P5903)\n\n\u7136\u540e\u8fd9\u9053\u9898\u5c31\u6109\u5feb\u7684\u505a\u5b8c\u4e86\n\n\u6ca1\u9519\uff0c\u601d\u60f3\u5c31\u8fd9\u4e48\u7b80\u5355\uff0c~~\u4f46\u662f\u4ee3\u7801\u554a~~\n\n\u7ec6\u8282\u4e0d\u5c11\uff0c\u4e00\u5b9a\u8981\u60f3\u6e05\u695a\u4e86\u518d\u5199\uff0c\u4e0d\u7136\u5199\u9898\u534a\u5c0f\u65f6\uff0cdebug\u4e94\u5c0f\u65f6\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n#define QAQ puts(\"QAQ\")\n# define Rep(i,a,b) for(int i=a;i<=b;i++)\n# define _Rep(i,a,b) for(int i=a;i>=b;i--)\n# define RepG(i,u) for(int i=head[u];~i;i=e[i].next)\n\ntypedef long long ll;\n\nconst int N=5e4+5;\nconst int W=250;\nconst int w=225;\n\ntemplate<typename T> void read(T &x){\n   x=0;int f=1;\n   char c=getchar();\n   for(;!isdigit(c);c=getchar())if(c=='-')f=-1;\n   for(;isdigit(c);c=getchar())x=(x<<1)+(x<<3)+c-'0';\n    x*=f;\n}\n\nint n;\nint a[N];\nint head[N],cnt;\nint b[N],c[N];\nint dep[N],mdep[N],son[N],top[N];\nint highbit[N],f[N][25];\nint sum[N][W];\n\nvector<int> up[N],down[N];\n\nstruct Edge{\n\tint to,next;\t\n}e[N<<1];\n\nvoid add(int x,int y){\n\te[++cnt]=(Edge){y,head[x]},head[x]=cnt;\t\n}\n\nvoid dfs1(int u,int fa){\n\tmdep[u]=dep[u]=dep[fa]+1;\n//\tprintf(\"%d %d\\n\",u,dep[u]);\n\tf[u][0]=fa;\n\tRep(i,1,18)f[u][i]=f[f[u][i-1]][i-1];\n\tRepG(i,u){\n\t\tint v=e[i].to;\n\t\tif(v==fa)continue;\n\t\tdfs1(v,u);\n\t\tif(mdep[v]>mdep[u])mdep[u]=mdep[v],son[u]=v;\n\t}\n}\n\nvoid dfs2(int u,int fa,int _top){\n\ttop[u]=_top;\n\tfor(int i=1,p=f[u][0];i<=w;i++,p=f[p][0])sum[u][i]=sum[p][i]+a[u];\n\tif(top[u]==u){\n\t\tfor(int i=0,ff=u;i<=mdep[u]-dep[u];i++,ff=f[ff][0])\n\t\t\tup[u].push_back(ff);\n\t\tfor(int i=0,ss=u;i<=mdep[u]-dep[u];i++,ss=son[ss])\n\t\t\tdown[u].push_back(ss);\n\t}\n\tif(son[u])dfs2(son[u],u,_top);\n\tRepG(i,u){\n\t\tint v=e[i].to;\n\t\tif(v==son[u]||v==fa)continue;\n\t\tdfs2(v,u,v);\t\n\t}\n}\n\nint kthan(int x,int k){\n\tif(dep[x]<=k)return 0;\n\tif(!k)return x;\n\tx=f[x][highbit[k]],k-=(1<<highbit[k]);\n\tk-=dep[x]-dep[top[x]],x=top[x];\n\treturn k>=0?up[x][k]:down[x][-k];\t\n}\n\nint lca(int x,int y){\n\tif(dep[x]<=dep[y])swap(x,y);\n\t_Rep(i,18,0)if(dep[f[x][i]]>=dep[y])x=f[x][i];\n\tif(x==y)return x;\n\t_Rep(i,18,0)if(f[x][i]!=f[y][i])x=f[x][i],y=f[y][i];\n\treturn f[x][0];\t\n}\n\nsigned main()\n{\n//\tfreopen(\"3591.in\",\"r\",stdin);\n//\tfreopen(\"3591.out\",\"w\",stdout);\n\tmemset(head,-1,sizeof(head));\n\tread(n);\n\tRep(i,1,n)read(a[i]);\n\tRep(i,1,n-1){\n\t\tint x,y;\n\t\tread(x),read(y);\n\t\tadd(x,y),add(y,x);\t\n\t}\n\tRep(i,1,n)read(b[i]);\n\tRep(i,1,n-1)read(c[i]);\n\tdfs1(1,0);\n\tdfs2(1,0,1);\n\thighbit[1]=0;\n\tRep(i,2,n)highbit[i]=highbit[i>>1]+1;\n\tRep(i,2,n){\n\t\tint x=b[i-1],y=b[i],k=c[i-1];\n\t\tint l=lca(x,y);\n\t\tint res=0;\n\t\tif(k<=w){\n\t\t\tres+=sum[x][k]-sum[kthan(x,k*((dep[x]-dep[l])/k+1))][k];\n\t\t\ty=kthan(y,(dep[x]+dep[y]-2*dep[l])%k);\n\t\t\tres+=sum[y][k]-sum[kthan(y,k*((dep[y]-dep[l])/k+1))][k];\n\t\t\tif((dep[x]-dep[l])%k==0&&(dep[y]-dep[l])%k==0)res-=a[l];\n\t\t\tprintf(\"%d\\n\",res);\n\t\t}\n\t\telse{\n\t\t\tfor(int i=x;dep[i]>=dep[l];i=kthan(i,k))res+=a[i];\n\t\t\ty=kthan(y,(dep[x]+dep[y]-2*dep[l])%k);\n\t\t\tfor(int i=y;dep[i]>=dep[l];i=kthan(i,k))res+=a[i];\n\t\t\tif((dep[x]-dep[l])%k==0&&(dep[y]-dep[l])%k==0)res-=a[l];\n\t\t\tprintf(\"%d\\n\",res);\t\n\t\t}\n\t}\n\treturn 0;\n}\n```\n",
        "postTime": 1595835128,
        "uid": 97344,
        "name": "devout",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3591 \u3010[POI2015]ODW\u3011"
    },
    {
        "content": "[\u9898\u76ee\u4f20\u9001\u95e8](https://www.luogu.com.cn/problem/P3591)\n\n\u8fd9\u662f\u4e00\u4e2a\u6811\u5256+\u5e8f\u5217\u5206\u5757\u3002\u611f\u89c9\u56e0\u4e3a\u5355\u7eaf\u6811\u5256\u8dd1\u4e0d\u6ee1 log\uff0c\u6bd4\u6811\u4e0ak\u7ea7\u7956\u5148+\u6839\u53f7\u5206\u6cbb\u7684\u505a\u6cd5\u8981\u5feb\u4e00\u4e9b\u3002\n\n\u5bf9\u4e8e\u67e5\u8be2\u7684\u4e24\u4e2a\u7aef\u70b9\uff0c\u8bb0\u4f59\u6570 $m_u,m_v$ \u4e3a $1$\u3002\n\n\u6bcf\u6b21\u6811\u5256\u8df3 $u$ \u7684\u65f6\u5019\uff0c\u5728\u5e8f\u5217\u4e0a\u67e5\u8be2\u8fd9\u4e00\u6bb5\u6a21\u6570\u4e3a $k$\uff0c\u4e14\u4e0b\u6807\uff08\u4ece1\u5f00\u59cb\uff09\u4f59\u6570\u4e3a $m_u$ \u7684\u548c\uff0c\u518d\u4ee4 $m_u=(m_u-l)\\mod k$\uff08$l$ \u662f\u67e5\u8be2\u533a\u95f4\u7684\u957f\u5ea6\uff09\u3002\u8df3 $v$ \u540c\u7406\u3002\n\n\u5bf9 dfs \u5e8f\u8fdb\u884c\u5206\u5757\uff0c\u5757\u5927\u5c0f\u4e3a $S$\u3002\u6bcf\u5757\u5bf9\u4e8e $1\\leq k\\leq S$ \u7684\u6a21\u6570\u9884\u5904\u7406\u51fa\u4e0b\u6807\uff08\u4ece1\u5f00\u59cb\uff09\u4f59\u6570\u4e3a $0\\leq m<k$ \u7684\u548c\u3002\n\n\u6563\u5757\u66b4\u529b\u8df3\uff0c\u8dd1\u5b8c\u6bcf\u4e2a\u5757\uff0c\u4f59\u6570\u7c7b\u4f3c\u6811\u5256\u90a3\u6bb5\u8fdb\u884c\u53d8\u5316\u3002\n\n\u5982\u679c\u67e5\u8be2\u7684 $k\\geq S$\uff0c\u5c31\u76f4\u63a5\u66b4\u529b\u8df3\u6574\u4e2a\u533a\u95f4\u3002\n\n\u4e00\u4e2a\u5c0f\u95ee\u9898\u662f\u6811\u5256\u662f\u5012\u7740\u8df3\u7684\uff0c\u5728\u6b63\u7684 dfs \u5e8f\u4e0a\u67e5\u8be2\u4f59\u6570\u6709\u70b9\u9ebb\u70e6\u3002\n\n\u6240\u4ee5\u6211\u4eec\u628a\u6bcf\u4e2a\u70b9\u5728 dfs \u5e8f\u4e0a\u7684\u4f4d\u7f6e\u53d8\u4e3a `n-dfn[x]+1`\uff0c\u76f8\u5f53\u4e8e\u5206\u5757\u7ef4\u62a4\u53cd dfs \u5e8f\u3002\n\n\u672c\u8d28\u7c7b\u4f3c\u6839\u53f7\u5206\u6cbb\u505a\u6cd5\uff0c\u4f46\u5145\u5206\u5229\u7528\u4e86\u6811\u5256\u7684\u7279\u6027\u800c\u4e0d\u662f\u6bcf\u6b21\u5c31\u53ea\u8df3 $S$\u3002\n\n\u53d6 $S=\\sqrt{n}$\uff0c\u65f6\u95f4 $O(n\\lg n\\sqrt{n})$\uff0c\u7a7a\u95f4 $\\Theta(n\\sqrt{n})$\u3002\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\ninline int read(){\n    char c;int x,f{0};\n    do x=(c=getchar())^48;\n    while (!isdigit(c)&&c!='-');\n    if (x==29) f=-1,x=0;\n    while (isdigit(c=getchar()))\n        x=(x<<3)+(x<<1)+(c^48);\n    return (x^f)-f;\n}\nconst int N(5e4),B{223*20},K{N/B+1};\n// val\u662fdfs\u5e8f\u4e0a\u7684\u70b9\u6743\nint sum[B+5][K][K],val[N+5],a[N+5],n;\ninline int R(int b){return b*K;}\ninline int L(int b){return R(b-1)+1;}\ninline int bl(int x){return (x-1)/K+1;};\nint ppip(int l,int r,int k,int m)\n{\n    if (!m) m=k;\n    int ans{0};\n    for (int i{l+m-1};i<=r;i+=k)\n        ans+=val[i];\n    return ans;\n}\n// \u5e8f\u5217\u5206\u5757\nint query(int l,int r,int k,int m){\n    if (bl(l)==bl(r)) return ppip(l,r,k,m);\n    int ans{ppip(l,R(bl(l)),k,m)};\n    m=(m+k-(R(bl(l))-l+1)%k)%k;\n    assert(R(bl(r)-1)<=n);\n    for (int i{bl(l)+1};i<bl(r);++i) {\n        if (k>=K) {\n            if (k==K&&m==0) ans+=val[R(i)];\n            else if (m<=K&&m) ans+=val[L(i)+m-1];\n        } else ans+=sum[i][k][m];\n        m=(m+k-K%k)%k;\n    }\n    ans+=ppip(L(bl(r)),r,k,m);\n    return ans;\n}\nint fa[N+5],dep[N+5],sz[N+5],son[N+5],tp[N+5];\nint dfn[N+5];\nvector<int> e[N+5];\n// \u6811\u5256\nvoid fz_init(int u,int f){\n    fa[u]=f;dep[u]=dep[f]+1;sz[u]=1;\n    for (auto v:e[u])\n        if (v!=f) {\n            fz_init(v,u);\n            sz[u]+=sz[v];\n            if (sz[v]>sz[son[u]])\n                son[u]=v;\n        }\n}\nvoid fz_cut(int u,int top){\n    static int cxx{1};\n    tp[u]=top;dfn[u]=cxx++;\n    if (son[u]) fz_cut(son[u],top);\n    for (auto v:e[u])\n        if (v!=fa[u]&&v!=son[u])\n            fz_cut(v,v);\n}\nint query(int u,int v,int k){\n    int wu{1%k},wv{1%k},ans{0};\n    while (tp[u]!=tp[v]){\n        if (dep[tp[u]]<dep[tp[v]])\n            swap(u,v),swap(wu,wv);\n        // \u6ce8\u610f\u53cddfs\u5e8f\u53cd\u7740\u8be2\u95ee\n        ans+=query(dfn[u],dfn[tp[u]],k,wu);\n        wu=(wu+k-(dfn[tp[u]]-dfn[u]+1)%k)%k;\n        u=fa[tp[u]];\n    }\n    if (dep[u]<dep[v]) swap(u,v),swap(wu,wv);\n    ans+=query(dfn[u],dfn[v],k,wu);\n    return ans;\n}\nint main(){\n    n=read();\n    for (int i{1};i<=n;++i)\n        scanf(\"%d\",a+i);\n    for (int i{1};i<n;++i) {\n        int a{read()},b{read()};\n        e[a].push_back(b);\n        e[b].push_back(a);\n    }\n    fz_init(1,0);fz_cut(1,1);\n    for (int i{1};i<=n;++i)\n        dfn[i]=n-dfn[i]+1;\n    for (int i{1};i<=n;++i)\n        val[dfn[i]]=a[i];\n    for (int k{1};k<K;++k)\n        for (int i{2};i<bl(n);++i)\n            for (int j{L(i)};j<=R(i);++j)\n                sum[i][k][(j-L(i)+1)%k]+=val[j];\n    for (int i{1};i<=n;++i)\n        a[i]=read();\n    for (int i{1};i<n;++i) {\n        int w{read()};\n        printf(\"%d\\n\",query(a[i],a[i+1],w));\n    }\n    return 0;\n}\n```\n\n\u968f\u4fbf\u8dd1\u8dd1\u5c31\u6700\u4f18\u89e3\u7b2c\u4e00\u9875\u4e86\u3002",
        "postTime": 1658108732,
        "uid": 374433,
        "name": "ppip",
        "ccfLevel": 7,
        "title": "P3591 [POI2015] ODW \u9898\u89e3"
    },
    {
        "content": "\u6309\u7167$c$\u5206\u7c7b\u8ba8\u8bba\u3002\n\n\u8bbe\u4e00\u4e2a\u9608\u503c$S$\u3002\n\n\u5f53$c>S$\u7684\u65f6\u5019\uff0c\u6211\u4eec\u5c31\u76f4\u63a5\u66b4\u529b\u8df3\uff0c\u7528\u500d\u589e\u6c42\u51fa\u6bcf\u6b21\u8df3\u7684\u70b9\u7684$c$\u7ea7\u7956\u5148\uff0c\u7136\u540e\u7d2f\u52a0\u3002\u65f6\u95f4\u590d\u6742\u5ea6$O(\\dfrac{n^2\\log n}S)$\u3002\n\n\u5f53$c\\leqslant S$\u7684\u65f6\u5019\uff0c\u8bb0$s[i]$\u8868\u793a\u6839\u8282\u70b9\u5230$i$\u7684\u8def\u5f84\u4e0a\uff0c\u6bcf$c$\u4e2a\u70b9\u53d6\u4e00\u4e2a\uff0c\u4e14$i$\u6070\u597d\u88ab\u53d6\u5230\uff08\u6839\u4e0d\u4e00\u5b9a\u88ab\u53d6\u5230\uff09\u7684\u65f6\u5019\uff0c\u53d6\u7684\u6240\u6709\u70b9\u7684\u548c\u3002\n\n\u7136\u540e\u8fd0\u7528\u524d\u7f00\u548c\u601d\u60f3\uff0c\u5c31\u53ef\u4ee5\u5feb\u901f\u6c42\u51fa\u8df3\u4e00\u6bb5\u7684\u8d21\u732e\u548c\u3002\u5219\u53ef\u4ee5\u505a\u5230\u5355\u6b21\u67e5\u8be2\u590d\u6742\u5ea6$O(\\log n)$\uff0c\u9884\u5904\u7406\u6bcf\u4e2a$c$\u5bf9\u5e94\u7684$s[i]$\u590d\u6742\u5ea6$O(nS)$\u3002\n\n\u8fd9\u6837\u7684\u8bdd\uff0c\u7406\u8bba\u4e0a\u6700\u4f18\u7684$S$\u7684\u53d6\u503c\u4e3a$\\sqrt{n\\log n}$\uff0c\u8fd9\u6837\u603b\u590d\u6742\u5ea6\u4e3a$O(n\\sqrt{n\\log n})$\u3002\n\n\u800c\u5b9e\u9645\u4e0a\u8fd9\u6837\u8dd1\u5f97\u5f88\u6162\uff0c\u4f1aTLE\uff0c\u800c$S=\\sqrt n$\u7684\u65f6\u5019\u5f88\u5feb\uff08\u548c\u6570\u636e\u6709\u5173\u7cfb\uff09\uff0c\u4f46\u7406\u8bba\u65f6\u95f4\u590d\u6742\u5ea6\u4e0a\u754c\u4e3a$O(n\\sqrt n\\log n)$\u3002\n\n## Code\uff1a\n```cpp\n#include<cstdio>\n#include<cctype>\n#define N 50005\n#define siz 225\nint n,head[N],cnt=0,to[N<<1],nxt[N<<1],b[N],c[N],dep[N],fa[17][N],a[N],sum[N];\nint s[226][N];\nstruct istream{\n\tchar buf[23333333],*s;\n\tinline istream(){\n\t\tbuf[fread(s=buf,1,23333330,stdin)]='\\n';\n\t\tfclose(stdin);\n\t}\n\tinline istream&operator>>(int&d){\n\t\td=0;\n\t\tfor(;!isdigit(*s);++s);\n\t\twhile(isdigit(*s))\n\t\td=(d<<3)+(d<<1)+(*s++^'0');\n\t\treturn*this;\n\t}\n}cin;\nvoid dfs(int now){\n\tsum[now]+=a[now];\n\tfor(int i=1;i<17;++i)\n\tfa[i][now]=fa[i-1][fa[i-1][now]];\n\tfor(int i=head[now];i;i=nxt[i])\n\tif(!dep[to[i]]){\n\t\tdep[to[i]]=dep[now]+1;\n\t\tsum[to[i]]=sum[now];\n\t\tfa[0][to[i]]=now;\n\t\tdfs(to[i]);\n\t}\n}\ninline int LCA(int x,int y){\n\tif(dep[x]<dep[y])x^=y^=x^=y;\n\tfor(int i=16;~i;--i)if(dep[fa[i][x]]>=dep[y])x=fa[i][x];\n\tif(x==y)return x;\n\tfor(int i=16;~i;--i)if(fa[i][x]!=fa[i][y])x=fa[i][x],y=fa[i][y];\n\treturn fa[0][x];\n}\ninline int getfa(int u,int x){\n\tfor(int i=16;~i;--i)\n\tif(x>>i&1)u=fa[i][u];\n\treturn u;\n}\nvoid dfs2(int now){\n\tint u=fa[0][now];\n\tfor(int i=2;i<=siz;++i){\n\t\tu=fa[0][u];\n\t\ts[i][now]=s[i][u]+a[now];\n\t}\n\tfor(int i=head[now];i;i=nxt[i])\n\tif(dep[now]<dep[to[i]])dfs2(to[i]);\n}\nint main(){\n\tcin>>n;\n\tfor(int i=1;i<=n;++i)cin>>a[i];\n\tfor(int i=1;i<n;++i){\n\t\tint u,v;\n\t\tcin>>u>>v;\n\t\tto[++cnt]=v;nxt[cnt]=head[u];head[u]=cnt;\n\t\tto[++cnt]=u;nxt[cnt]=head[v];head[v]=cnt;\n\t}\n\tfor(int i=1;i<=n;++i)cin>>b[i];\n\tfor(int i=1;i<n;++i)cin>>c[i];\n\tdfs(dep[1]=1);\n\tdfs2(1);\n\tfor(int i=1;i<n;++i){\n\t\tint u=b[i],v=b[i+1],c=::c[i];\n\t\tint lca=LCA(u,v);\n\t\tif(c==1)\n\t\tprintf(\"%d\\n\",sum[u]+sum[v]-sum[lca]-sum[fa[0][lca]]);else\n\t\tif(c<=siz){\n\t\t\tint ans=s[c][u],di=(dep[u]-dep[lca])%c;\n\t\t\tif(di==0)di=c;\n\t\t\tfor(int i=16;~i;--i)\n\t\t\tif(dep[fa[i][u]]-dep[lca]>=di)u=fa[i][u];\n\t\t\tans+=a[u]-s[c][u];\n\t\t\tif(dep[u]+dep[v]-(dep[lca]<<1)>=c){\n\t\t\t\tdi=c-dep[u]+dep[lca];\n\t\t\t\tu=v;\n\t\t\t\tfor(int i=16;~i;--i)\n\t\t\t\tif(dep[fa[i][u]]-dep[lca]>=di)u=fa[i][u];\n\t\t\t\tdi=(dep[v]-dep[u])%c;\n\t\t\t\tif(di!=0)ans+=a[v];\n\t\t\t\tv=getfa(v,di);\n\t\t\t\tans+=s[c][v]-s[c][u]+a[u];\n\t\t\t}else ans+=a[v];\n\t\t\tprintf(\"%d\\n\",ans);\n\t\t}else{\n\t\t\tint ans=0;\n\t\t\twhile(dep[u]-dep[lca]>c){\n\t\t\t\tans+=a[u];\n\t\t\t\tu=getfa(u,c);\n\t\t\t}\n\t\t\tans+=a[u];\n\t\t\tif(dep[u]+dep[v]-(dep[lca]<<1)>=c){\n\t\t\t\tint di=c-dep[u]+dep[lca];\n\t\t\t\tu=v;\n\t\t\t\tfor(int i=16;~i;--i)\n\t\t\t\tif(dep[fa[i][u]]-dep[lca]>=di)u=fa[i][u];\n\t\t\t\tdi=(dep[v]-dep[u])%c;\n\t\t\t\tif(di!=0)ans+=a[v];\n\t\t\t\tv=getfa(v,di);\n\t\t\t\twhile(dep[v]-dep[u]>=c){\n\t\t\t\t\tans+=a[v];\n\t\t\t\t\tv=getfa(v,c);\n\t\t\t\t}\n\t\t\t\tans+=a[v];\n\t\t\t}else ans+=a[v];\n\t\t\tprintf(\"%d\\n\",ans);\n\t\t}\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1543825934,
        "uid": 6813,
        "name": "mrsrz",
        "ccfLevel": 10,
        "title": "\u9898\u89e3 P3591 \u3010[POI2015]ODW\u3011"
    },
    {
        "content": "[\u9898\u76ee\u4f20\u9001\u95e8](https://www.luogu.com.cn/problem/P3591)\n\n\u8fd9\u662f\u4e00\u9053\u5e94\u7528\u4e86\u5206\u5757\u601d\u60f3\u957f\u94fe\u5256\u5206\u9898\u3002\n\n\u8bfb\u5b8c\u9898\u540e\u6211\u4eec\u53ef\u4ee5\u60f3\u5230\u5229\u7528\u957f\u94fe\u5256\u5206\u6765 $\\operatorname{O}(1)$ \u6c42 $k$ \u7ea7\u7956\u5148\u3002\n\n\u6211\u4eec\u53d1\u73b0\u5f53\u6b65\u4f10 $k$ \u5f88\u5927\u7684\u65f6\u5019\uff0c\u590d\u6742\u5ea6\u662f\u8f83\u5c0f\u7684\uff0c\u800c\u5f53 $k$ \u8f83\u5c0f\u65f6\u590d\u6742\u5ea6\u4f1a\u8fbe\u5230 $\\operatorname{O}(n)$\u3002\n\n\u6240\u4ee5\u5bf9\u4e8e $k$ \u8f83\u5c0f\u65f6\u6211\u4eec\u53ef\u4ee5\u8003\u8651\u7528\u7c7b\u4f3c\u6811\u4e0a\u5dee\u5206\u7684\u65b9\u6cd5\u9884\u5904\u7406\u51fa\u6bcf\u4e2a\u70b9\u5230\u6839\u7684\u548c\u3002\n\n\u4e3a\u4e86\u6743\u8861\u8fd9\u4e24\u79cd\u65b9\u6cd5\u6211\u4eec\u53ef\u4ee5\u7528\u5206\u5757\u7684\u601d\u60f3\u3002\u5f53 $k>\\sqrt{n}$ \u65f6\u6211\u4eec\u4f7f\u7528\u524d\u8005\uff0c\u53cd\u4e4b\u4f7f\u7528\u540e\u8005\u3002\n\n\u8fd9\u6837\u7684\u8bdd\u524d\u8005\u5355\u6b21\u67e5\u8be2\u662f $\\operatorname{O}(\\sqrt{n})$\uff0c\u800c\u540e\u8005\u9884\u5904\u7406\u662f $\\operatorname{O}(n\\,\\sqrt{n})$\uff0c\u53ef\u4ee5\u4fdd\u8bc1\u603b\u590d\u6742\u5ea6\u4e3a$\\operatorname{O}(n\\,\\sqrt{n})$\u3002\n\n\u8be6\u7ec6\u5b9e\u73b0\u8bf7\u770b\u4ee3\u7801\u548c\u6ce8\u91ca\u3002\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n\nint n, sq, cnt, a[50005], b[50005];     //sq\u8868\u793a\u5206\u754c\nint fi[50005], ne[100005], to[100005];  //\u90bb\u63a5\u8868\u5b58\u8fb9\nint d[50005], dep[50005], son[50005];   //d\u8868\u793a\u6df1\u5ea6 dep\u8868\u793a\u5230\u53f6\u7684\u957f\u5ea6\nint g[50005], f[50005][20], top[50005]; //g[n]\u8868\u793alog2(n) f[x][k]\u8868\u793ax\u76842^k\u7ea7\u7956\u5148\nint s[50005][250];                      //\u5dee\u5206\u6570\u7ec4(\u5bf9\u4e8e\u4e0d\u540c\u7684k\u5206\u522b\u5904\u7406)\nvector<int> up[50005], down[50005];     //\u8bb0\u5f55\u94fe\u9876\u7684\u4e0a\u4e0b\u8282\u70b9\n\nvoid add(int u, int v)\n{\n    to[++cnt] = v;\n    ne[cnt] = fi[u];\n    fi[u] = cnt;\n}\n\nvoid dfs(int x) //\u7b2c\u4e00\u6b21\u904d\u5386\n{\n    dep[x] = d[x] = d[f[x][0]] + 1; //\u5904\u7406\u6df1\u5ea6\n    for (int i = fi[x]; i; i = ne[i])\n    {\n        int y = to[i];\n        if (y == f[x][0])\n            continue;\n        f[y][0] = x;\n        for (int j = 1; f[f[y][j - 1]][j - 1]; j++)\n            f[y][j] = f[f[y][j - 1]][j - 1]; //\u9884\u5904\u7406\u500d\u589e\u6570\u7ec4\n        dfs(y);\n        if (dep[y] > dep[x]) //\u5904\u7406\u957f\u513f\u5b50\n            dep[x] = dep[y], son[x] = y;\n    }\n}\n\nvoid dfs(int x, int p) //\u7b2c\u4e8c\u6b21\u904d\u5386\n{\n    top[x] = p; //\u8bb0\u5f55\u94fe\u9876\n    for (int i = 1, o = f[x][0]; i <= sq; i++, o = f[o][0])\n        s[x][i] = s[o][i] + a[x]; //\u9884\u5904\u7406\u5dee\u5206\u6570\u7ec4\n    if (x == p)                   //\u5982\u679c\u662f\u94fe\u9876\u7684\u8bdd\u8bb0\u5f55\u4ed6\u4e0a\u4e0b\u7684\u8282\u70b9\n    {\n        for (int i = 0, o = x; i <= dep[x] - d[x]; ++i)\n            up[x].push_back(o), o = f[o][0];\n        for (int i = 0, o = x; i <= dep[x] - d[x]; ++i)\n            down[x].push_back(o), o = son[o];\n    }\n    if (son[x])\n        dfs(son[x], p); //\u5148\u5904\u7406\u957f\u513f\u5b50\n    for (int i = fi[x]; i; i = ne[i])\n    {\n        int y = to[i];\n        if (y != f[x][0] && y != son[x])\n            dfs(y, y);\n    }\n}\n\nint ask(int x, int k) //O(1)\u6c42k\u7ea7\u7956\u5148\n{\n    if (d[x] - k <= 0)\n        return 0;\n    if (!k)\n        return x;\n    x = f[x][g[k]]; //\u5148\u8df3\u52302^g[k]\u7ea7\u7956\u5148\n    k -= 1 << g[k];\n    k -= d[x] - d[top[x]]; //\u7136\u540e\u8df3\u5230\u94fe\u9876\n    x = top[x];\n    if (k >= 0)\n        return up[x][k]; //\u8df3\u5230k\u7ea7\u7956\u5148\n    else\n        return down[x][-k];\n}\n\nint lca(int x, int y) //LCA\n{\n    if (d[x] < d[y])\n        swap(x, y);\n    for (int i = g[d[x]]; i >= 0; --i) //\u5148\u8df3\u5230\u540c\u4e00\u5c42\n        if (d[f[x][i]] >= d[y])\n            x = f[x][i];\n    if (x == y)\n        return x;\n    for (int i = g[d[x]]; i >= 0; --i) //\u4e00\u8d77\u5f80\u4e0a\u8df3\n        if (f[x][i] != f[y][i])\n            x = f[x][i], y = f[y][i];\n    return f[x][0];\n}\n\nint main()\n{\n    clock_t c1 = clock();\n#ifdef LOCAL\n    freopen(\"in.in\", \"r\", stdin);\n    freopen(\"out.out\", \"w\", stdout);\n#endif\n    scanf(\"%d\", &n);\n    sq = sqrt(n);\n    g[0] = -1;                   //\u9012\u63a8\u6c42log2(n)\n    for (int i = 1; i <= n; ++i) //\u6ce8\u610f\u8fb9\u754c\n        g[i] = g[i >> 1] + 1;\n    for (int i = 1; i <= n; ++i)\n        scanf(\"%d\", &a[i]);\n    for (int i = 1; i < n; ++i)\n    {\n        int u, v;\n        scanf(\"%d%d\", &u, &v);\n        add(u, v);\n        add(v, u);\n    }\n    for (int i = 1; i <= n; ++i)\n        scanf(\"%d\", &b[i]);\n    dfs(1); //\u4e24\u6b21\u904d\u5386\n    dfs(1, 1);\n    for (int i = 1; i < n; ++i)\n    {\n        int x = b[i], y = b[i + 1], c;\n        scanf(\"%d\", &c);\n        int l = lca(x, y);\n        int r = (d[x] - d[l]) % c; //\u5bf9\u6709\u4f59\u6570\u7684\u60c5\u51b5\u5904\u7406\n        int R = (d[y] + d[x] - 2 * d[l]) % c;\n        int ans = 0;\n        if (c <= sq) //\u5982\u679c\u6b65\u4f10\u8f83\u5c0f\n        {            //\u5229\u7528\u6811\u4e0a\u5dee\u5206\n            ans += s[x][c];\n            ans -= s[ask(l, c - r)][c]; //x\u5230l\n            ans += s[ask(y, R)][c];\n            ans -= s[ask(l, r)][c]; //y\u5230l\n        }\n        else //\u5982\u679c\u6b65\u4f10\u8f83\u5927\n        {    //\u66b4\u529b\u8df3\n            for (int t = x; d[t] >= d[l]; t = ask(t, c))\n                ans += a[t];                                    //\u9632\u6b62\u628al\u7b97\u4e24\u904d\n            for (int t = ask(y, R); d[t] > d[l]; t = ask(t, c)) //\u7b2c\u4e00\u6b21\u5305\u62ecl\n                ans += a[t];                                    //\u7b2c\u4e8c\u6b21\u4e0d\u5305\u62ecl\n        }\n        printf(\"%d\\n\", ans);\n    }\n    return 0;\n}\n```\n",
        "postTime": 1632498217,
        "uid": 184443,
        "name": "Cui_Wenjia",
        "ccfLevel": 6,
        "title": "P3591 [POI2015]ODW \u9898\u89e3"
    },
    {
        "content": "\u53d1\u4e00\u4e2a\u4e0d\u5e26log\u7684\u505a\u6cd5\uff0c\u5c31\u662f\u663e\u7136\u662f\u5bf9c\u5206\u5757\u5bf9\u5427\uff0c\u7136\u540e\u66b4\u529b\u5f80\u4e0a\u9762\u8df3\u7684\u65f6\u5019\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528\u957f\u94fe\u5256\u5206\u76f4\u63a5$O(1)$\u627ek\u7ea7\u7956\u5148\uff0c\u5c31\u662f\u5728\u6bcf\u4e2a\u94fe\u9876\u5f00\u4e24\u4e2avector\uff0c\u4e00\u4e2a\u6309\u6df1\u5ea6\u9012\u589e\u5b58\u8fd9\u6761\u94fe\u7684\u70b9\uff0c\u4e00\u4e2a\u6309\u6df1\u5ea6\u9012\u51cf\u5b58\u4ed6\u7684\u6240\u6709\u5230\u8fd9\u4e2a\u70b9\u8ddd\u79bb\u4e0d\u8d85\u8fc7\u94fe\u957f\u7684\u7956\u5148\uff08\u76f8\u5f53\u4e8e\u662f\u7b49\u4e8e\u94fe\u957f\u7684\u4e00\u6761\u5230\u7956\u5148\u7684\u94fe\uff09\uff0c\u6211\u4eec\u5148\u7528\u500d\u589e\u6570\u7ec4\u5411\u4e0a\u8df3$2^{\\log k}$\u6b65\uff0c\u627e\u5230\u8fd9\u4e2a\u70b9\u7684\u94fe\u9876\uff0c\u663e\u7136\u8fd9\u4e2ak\u7ea7\u7956\u5148\u8981\u4e48\u5728\u8fd9\u4e2a\u94fe\u9876\u7684\u7956\u5148vector\u4e0a\uff0c\u8981\u4e48\u5728\u8fd9\u4e2a\u94fe\u7684vector\u4e0a\uff08\u56e0\u4e3a\u5df2\u7ecf\u8df3\u4e86\u81f3\u5c11\u4e00\u534a\u7684\u8ddd\u79bb\u4e86\uff0c\u522b\u5fd8\u4e86\u8fd9\u4e2a\u662f\u957f\u94fe\u5256\u5206\uff09\uff0c\u4e8e\u662f\u5c31\u53ef\u4ee5\u505a\u5230$O(n\\sqrt n)$\u3002\n\n~~\u5176\u5b9e\u6211\u4e4b\u6240\u4ee5\u4e0d\u5199\u500d\u589e\u662f\u56e0\u4e3a\u5f00\u59cb\u7684\u65f6\u5019\u628a\u5206\u5757\u7684\u7b56\u7565\u5199\u53cd\u4e86T\u98de\u4e86\u4ee5\u4e3a\u5361log\u2026\u2026\u7136\u540e\u5c31\u4e0a\u4e86\u4e2a\u8fd9\u73a9\u610f\u2026\u2026~~\n\n\u4e0a\u4ee3\u7801~\n\n```cpp\n#include<iostream>\n#include<cstdio>\n#include<cstring>\n#include<vector>\n#define blo 223\nusing namespace std;\nnamespace ywy{\n\tinline int get(){\n\t\tint n=0;char c;while((c=getchar())||23333){\n\t\t\tif(c>='0'&&c<='9')break;if(c=='-')goto s;\n\t\t}n=c-'0';while((c=getchar())||23333){\n\t\t\tif(c>='0'&&c<='9')n=n*10+c-'0';else return(n);\n\t\t}s:while((c=getchar())||23333){\n\t\t\tif(c>='0'&&c<='9')n=n*10-c+'0';else return(n);\n\t\t}\n\t}\n\tvoid print(int num){\n\t\tif(num>=10)print(num/10);\n\t\tputchar(num%10+'0');\n\t}\n\tint b[50001],c[50001],ints[50001],f[50001][230],deep[50001],ance[50001][16];\n\ttypedef struct _b{\n\t\tint dest;int nxt;\n\t}bian;\n\tbian memchi[100001];\n\tint gn=1,heads[50001],stk[50001],sp=0;\n\tinline void add(int s,int t){\n\t\tmemchi[gn].dest=t;\n\t\tmemchi[gn].nxt=heads[s];\n\t\theads[s]=gn;gn++;\n\t}\n\tinline int lca(int a,int b){\n\t\tif(deep[a]>deep[b])swap(a,b);\n\t\tfor(register int i=15;i>=0;i--){\n\t\t\tif(deep[ance[b][i]]>=deep[a])b=ance[b][i];\n\t\t}\n\t\tif(a==b)return(a);\n\t\tfor(register int i=15;i>=0;i--){\n\t\t\tif(ance[a][i]!=ance[b][i])a=ance[a][i],b=ance[b][i];\n\t\t}\n\t\treturn(ance[a][0]);\n\t}\n\tint mxdeep[50001],top[50001],zhongson[50001];//mxdeep\u662f\u70b9\u7684 \n\tvoid dfs(int pt,int baba){\n\t\tstk[sp]=pt;sp++;\n\t\tfor(register int i=0;i<=blo;i++){\n\t\t\tif(deep[pt]<i)f[pt][i]=ints[pt];\n\t\t\telse f[pt][i]=ints[pt]+f[stk[deep[pt]-i]][i];\n\t\t}\n\t\tint mx=0,best=0;top[pt]=pt;\n\t\tfor(register int i=heads[pt];i;i=memchi[i].nxt){\n\t\t\tif(memchi[i].dest==baba)continue;\n\t\t\tdeep[memchi[i].dest]=deep[pt]+1;\n\t\t\tance[memchi[i].dest][0]=pt;\n\t\t\tdfs(memchi[i].dest,pt);\n\t\t\tif(mxdeep[memchi[i].dest]>mx)mx=mxdeep[memchi[i].dest],best=memchi[i].dest;\n\t\t}\n\t\tsp--;zhongson[pt]=best;mxdeep[pt]=mx+1;\n\t}\n\tint lg[50001];\n\tvector<int> lian[50001],ba[50001];\n\tvoid efs(int pt,int baba){\n\t\tstk[sp]=pt;sp++;\n\t\tif(pt==top[pt]){\n\t\t\tfor(register int i=sp-1;i>=0&&i>=sp-mxdeep[pt];i--)ba[pt].push_back(stk[i]);\n\t\t}\n\t\tlian[top[pt]].push_back(pt);\n\t\tif(zhongson[pt])top[zhongson[pt]]=top[pt],efs(zhongson[pt],pt);\n\t\tfor(register int i=heads[pt];i;i=memchi[i].nxt){\n\t\t\tif(memchi[i].dest==baba||memchi[i].dest==zhongson[pt])continue;\n\t\t\tefs(memchi[i].dest,pt);\n\t\t}\n\t\tsp--;\n\t}\n\tinline int ga(int pt,int dai){\n\t\tif(deep[pt]<dai)return(0);\n\t\tif(!dai)return(pt);\n\t\tint ac=ance[pt][lg[dai]];dai-=(1<<lg[dai]);\n\t\tif(deep[ac]-deep[top[ac]]>=dai)return(lian[top[ac]][deep[ac]-deep[top[ac]]-dai]);\n\t\treturn(ba[top[ac]][dai-(deep[ac]-deep[top[ac]])]);\n\t}\n\tvoid ywymain(){\n\t\tdeep[0]=-1;int n=get();\n\t\tfor(register int i=1;i<=n;i++)ints[i]=get();lg[0]=-1;\n\t\tfor(register int i=1;i<n;i++){\n\t\t\tint s=get(),t=get();\n\t\t\tadd(s,t);add(t,s);\n\t\t\tlg[i]=(lg[i-1]+(i==(i&-i)));\n\t\t}\n\t\tdfs(1,0);efs(1,0);\n\t\tfor(register int i=1;i<=15;i++){\n\t\t\tfor(register int j=1;j<=n;j++)ance[j][i]=ance[ance[j][i-1]][i-1];\n\t\t}\n\t\tfor(register int i=1;i<=n;i++)b[i]=get();\n\t\tfor(register int i=1;i<n;i++)c[i]=get();\n\t\tfor(register int i=1;i<n;i++){\n\t\t\tint s=b[i],t=b[i+1],l=c[i],lc=lca(s,t);\n\t\t\tif(t==lc)swap(s,t);\n\t\t\tint len=deep[s]+deep[t]-2*deep[lc];\n\t\t\tif(l>=blo){\n\t\t\t\tint cur=s;\n\t\t\t\tint ans=0;\n\t\t\t\twhile(deep[cur]>=deep[lc])ans+=ints[cur],cur=ga(cur,l);\n\t\t\t\tcur=t;\n\t\t\t\tint r=(deep[s]-deep[lc])%l;\n\t\t\t\tr=(deep[t]-deep[lc]+r)%l;if(r)ans+=ints[t];\n\t\t\t\tcur=ga(cur\uff0cr);\n\t\t\t\twhile(deep[cur]>deep[lc])ans+=ints[cur],cur=ga(cur,l);\n\t\t\t\tprint(ans);putchar('\\n');\n\t\t\t}else{\n\t\t\t\tint ans=f[s][l]-f[ga(s,l*((deep[s]-deep[lc])/l+1))][l];\n\t\t\t\tint r=(deep[s]-deep[lc])%l;r=(deep[t]-deep[lc]+r)%l;\n\t\t\t\tif(r)ans+=ints[t]\uff1b\n\t\t\t\tint cur=ga(t,r);\n\t\t\t\tif(deep[cur]>deep[lc])ans+=(f[cur][l]-f[ga(cur,l*((deep[cur]-deep[lc])/l+1))][l]);\n\t\t\t\tif((deep[s]-deep[lc])%l==0&&(deep[t]-deep[lc])%l==0)ans-=ints[lc];\n\t\t\t\tprint(ans);putchar('\\n');\n\t\t\t}\n\t\t}\n\t}\n}\nint main(){\n\tywy::ywymain();return(0);\\\\\u518d\u89c1\u7a0b\u5e8f\n}\n```",
        "postTime": 1547554378,
        "uid": 125124,
        "name": "ywy_c_asm",
        "ccfLevel": 9,
        "title": "\u9898\u89e3 P3591 \u3010[POI2015]ODW\u3011"
    },
    {
        "content": "\u65f6\u95f4\u590d\u6742\u5ea6 $O(n\\log n+n\\sqrt n)$\uff0c\u4ee3\u7801\u53ea\u6709 1.7K\uff0c\u4f3c\u4e4e\u6bd4\u73b0\u6709\u9898\u89e3\u90fd\u77ed\u3002\n\n\u8003\u8651\uff0c\u56e0\u4e3a\u4fdd\u8bc1\u8def\u5f84\u957f\u5ea6\u88ab $c$ \u6574\u9664\uff0c\u5c31\u662f\u8bf4\u8d77\u70b9\u7ec8\u70b9\u4e00\u5b9a\u4f1a\u88ab\u53d6\u5230\uff0c\u8fd9\u5c31\u65b9\u4fbf\u4e86\u6211\u4eec\u5b9e\u73b0\uff0c\u663e\u7136\u662f\u5bf9\u4e8e\u8d77\u70b9\u7ec8\u70b9\u5230 LCA \u7684\u8def\u5f84\u5206\u522b\u6c42\u51fa\u7b54\u6848\u52a0\u8d77\u6765\u5c31\u53ef\u4ee5\u4e86\u3002\n\n\u95ee\u9898\u8f6c\u5316\u6210\u4e86\uff0c\u6bcf\u6b21\u8be2\u95ee\u6811\u4e0a\u4e00\u6bb5\u8def\u5f84\u7684\u7b54\u6848\uff0c\u4fdd\u8bc1\u8def\u5f84\u8d77\u6b62\u70b9\u662f\u7956\u5148\u540e\u4ee3\u5173\u7cfb\u3002\n\n\u6700\u57fa\u7840\u7684\u601d\u8def\u662f\u6839\u53f7\u5206\u6cbb\uff0c\u5373\u6211\u4eec\u8003\u8651\u5bf9\u4e8e\u6b65\u957f\u8f83\u5927\u7684\u8be2\u95ee\u4e00\u6b65\u4e00\u6b65\u5411\u4e0a\u8df3\u7edf\u8ba1\u7b54\u6848\uff0c\u5bf9\u4e8e\u6b65\u957f\u8f83\u5c0f\u7684\u7528\u6570\u636e\u7ed3\u6784\u6216\u8005\u522b\u7684\u65b9\u5f0f\u9884\u5904\u7406\u51fa\u6765\u7136\u540e\u76f4\u63a5\u67e5\u7b54\u6848\u3002\n\n\u4e3a\u4e86\u7b80\u5316\u95ee\u9898\uff0c\u6211\u4eec\u518d\u6b21\u628a\u95ee\u9898\u6539\u6210\u6bcf\u6b21\u8be2\u95ee\u4e00\u4e2a\u70b9\u5230\u6839\u7684\u8def\u5f84\u4e0a\uff0c\u5bf9\u5e94\u6b65\u957f\u7684\u6743\u503c\u548c\uff08\u5f53\u7136\u4fdd\u8bc1\u4ece\u8be5\u70b9\u5f00\u59cb\u8d70\uff09\uff0c\u663e\u7136\u8fd9\u4e2a\u95ee\u9898\u5dee\u5206\u4e00\u4e0b\u5c31\u80fd\u5f97\u5230\u539f\u95ee\u9898\u7b54\u6848\u3002\n\n\u6211\u4eec\u628a\u8be2\u95ee\u79bb\u7ebf\u7136\u540e\u653e\u5230\u6811\u4e0a\u7edf\u4e00\u5904\u7406\uff0c\u9996\u5148\u8003\u8651\u6b65\u957f\u8f83\u5927\u7684\uff0c\u6211\u4eec\u6ca1\u5fc5\u8981\u53bb\u505a\u957f\u94fe\u5256\u5206\u6c42 K \u7ea7\u7956\u5148\uff0c\u53ea\u8981\u5728 DFS \u7684\u65f6\u5019\u7ef4\u62a4\u4e00\u4e2a\u6570\u7ec4\u8bb0\u5f55\u5f53\u524d\u70b9\u5230\u6839\u5bf9\u5e94\u6df1\u5ea6\u7684\u70b9\u662f\u54ea\u4e2a\u5c31\u53ef\u4ee5\u4e86\uff0c\u4e8e\u662f\u8fd9\u90e8\u5206\u95ee\u9898\u5c31\u89e3\u51b3\u4e86\u3002\n\n\u7136\u540e\u6211\u4eec\u8003\u8651\u6b65\u957f\u8f83\u5c0f\u7684\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u6b65\u957f\uff0c\u6211\u4eec\u8003\u8651\u5b58\u4e00\u4e2a\u6570\u7ec4 $f_{i,j}$ \u8868\u793a\u6b65\u957f\u4e3a $i$\uff0c\u8d77\u70b9\u6df1\u5ea6 $\\bmod i=j$ \u7684\u7b54\u6848\u3002\u5047\u8bbe\u8be2\u95ee\u6b65\u957f\u662f $c$ \u5f53\u524d\u70b9\u6df1\u5ea6\u662f $d$ \u90a3\u4e48\u8981\u6c42\u7b54\u6848\u76f4\u63a5\u67e5 $f_{c,d\\bmod c}$ \u5c31\u53ef\u4ee5\u4e86\uff0c\u800c\u4e14\u8fd9\u4e2a\u4e1c\u897f\u663e\u7136\u662f\u5f88\u597d\u7ef4\u62a4\u7684\u3002\n\n\u4e8e\u662f\u95ee\u9898\u89e3\u51b3\u3002\u53e6\u5916\u8fd9\u91cc\u6839\u53f7\u5206\u6cbb\u53d6\u5757\u957f\u56e0\u4e3a\u6570\u636e\u7684\u95ee\u9898\uff0c\u53d6 $25$ \u5de6\u53f3\u53ef\u4ee5\u8dd1\u5f97\u98de\u5feb\u3002\n\n### \u4ee3\u7801\n\n```cpp\n#include <bits/stdc++.h>\n#define pii pair<int,int>\n#define fi first\n#define se second\nusing namespace std;\ninline int read(){\n\tchar c;int f=1,res=0;\n\twhile(c=getchar(),!isdigit(c))if(c=='-')f*=-1;\n\twhile(isdigit(c))res=res*10+c-'0',c=getchar();\n\treturn res*f;\n}\nconst int N=5e5+5,L=20,B=25;\nint n,a[N],b[N],c[N];\nint d[N],an[N][L],ans[N];\nvector<int> ver[N],q[N];\nvoid DFS0(int u,int pr){\n\td[u]=d[pr]+1;an[u][0]=pr;\n\tfor(int i=1;i<L;++i)\n\t\tan[u][i]=an[an[u][i-1]][i-1];\n\tfor(int v:ver[u])\n\t\tif(v!=pr)DFS0(v,u);\n}\ninline int find(int u,int di){\n\tfor(int i=0;i<L;++i,di>>=1)\n\t\tif(di&1)u=an[u][i];\n\treturn u;\n}\ninline int LCA(int u,int v){\n\tif(d[u]<d[v])swap(u,v);\n\tif((u=find(u,d[u]-d[v]))==v)\n\t\treturn u;\n\tfor(int i=L-1;i>=0;--i)\n\t\tif(an[u][i]!=an[v][i])\n\t\t\tu=an[u][i],v=an[v][i];\n\treturn an[u][0];\n}\nint s[B+5][B+5],st[N];\nvoid DFS(int u){\n\tst[d[u]]=u;\n\tfor(int i=1;i<=B;++i)\n\t\ts[i][d[u]%i]+=a[u];\n\tfor(int _x:q[u]){\n\t\tint x=abs(_x),upd=0;\n\t\tif(c[x]<=B)\n\t\t\tupd=s[c[x]][d[u]%c[x]];\n\t\telse{\n\t\t\tfor(int i=d[u];i>=0;i-=c[x])\n\t\t\t\tupd+=a[st[i]];\n\t\t}ans[x]+=(_x>0?1:-1)*upd;\n\t}for(int v:ver[u])\n\t\tif(v!=an[u][0])DFS(v);\n\tfor(int i=1;i<=B;++i)\n\t\ts[i][d[u]%i]-=a[u];\n}\nint main(){\n\tn=read();\n\tfor(int i=1;i<=n;++i)\n\t\ta[i]=read();\n\tfor(int i=1;i<n;++i){\n\t\tint u=read(),v=read();\n\t\tver[u].push_back(v);\n\t\tver[v].push_back(u);\n\t}for(int i=1;i<=n;++i)b[i]=read();\n\tfor(int i=1;i<n;++i)c[i]=read();\n\td[0]=-1;DFS0(1,0);\n\tfor(int i=1;i<n;++i){\n\t\tint u=b[i],v=b[i+1],w=LCA(u,v),di;\n\t\tdi=(d[u]-d[w]+c[i]-1)/c[i]*c[i];\n\t\tq[u].push_back(i);q[find(u,di)].push_back(-i);\n\t\tdi=(d[v]-d[w]+c[i])/c[i]*c[i];\n\t\tq[v].push_back(i);q[find(v,di)].push_back(-i);\n\t}DFS(1);\n\tfor(int i=1;i<n;++i)\n\t\tprintf(\"%d\\n\",ans[i]);\n\treturn 0;\n}\n\n```\n\n",
        "postTime": 1649928609,
        "uid": 206258,
        "name": "SDNetFriend",
        "ccfLevel": 7,
        "title": "P3591 [POI2015] ODW \u9898\u89e3"
    },
    {
        "content": "\u524d\u7f6e\u829d\u58eb\uff1a[LCA\uff08\u6700\u8fd1\u516c\u5171\u7956\u5148\uff09](https://oi-wiki.org/graph/lca/)\u3001\u6839\u53f7\u5206\u6cbb\uff08\u601d\u60f3\uff09\n\n\u770b\u5230\u8fd9\u79cd\u8981\u4e00\u6b21\u8d70 / \u8df3 $k$ \u6b65\u7684\u9898\u5c31\u5e94\u8be5\u60f3\u5230\u6839\u53f7\u5206\u6cbb / \u5206\u5757\u3002\n\n\u8bbe\u5b9a\u9608\u503c $B$\uff0c\u5219\u5f53 $c_i \\leq B$\uff0c\u9884\u5904\u7406\u4ece\u6bcf\u4e2a\u70b9\u6bcf\u6b21\u5411\u4e0a\u8df3 $c_i$ \u683c\u4e00\u76f4\u8df3\u5230\u6839\u8282\u70b9\u6240\u7ecf\u8fc7\u6743\u503c\u4e4b\u548c\uff0c\u67e5\u8be2\u65f6\u5dee\u5206\u5373\u53ef\uff08\u6ce8\u610f\u8981\u7279\u5224 LCA\uff09\uff1b\u5426\u5219\uff0c\u76f4\u63a5\u7528\u6811\u4e0a $k$ \u7ea7\u7956\u5148\u66b4\u529b\u8df3\u3002\n\n\u4ee4 $B = \\sqrt{n}$\uff0c\u5219\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $O(n \\sqrt{n} \\log n)$\u3002\n\n\u5982\u679c\u50cf\u6211\u4e00\u6837\u7528\u500d\u589e\u6c42\u6811\u4e0a $k$ \u7ea7\u7956\u5148\uff0c\u901a\u8fc7\u672c\u9898\u9700\u8981\u8f7b\u5fae\u5361\u5e38\u3002\u503c\u5f97\u4e00\u63d0\u7684\u662f\uff0c\u672c\u9898\u8bc4\u6d4b\u65f6\u6ce2\u52a8\u8f83\u5927\uff08\u6307\u540c\u4e00\u4efd\u4ee3\u7801 $90 \\operatorname{pts} \\to 60 \\operatorname{pts}$\uff09\u3002\u53e6\u5916\uff0c\u6ce8\u610f\u7b54\u6848\u4e0d\u9700\u8981\u5f00 long long\u3002\n\n\u4ee3\u7801\uff1a\n```cpp\n#include <iostream>\n#include <vector>\n#include <cmath>\n\nusing namespace std;\n\ntypedef struct {\n\tint nxt;\n\tint end;\n} Edge;\n\nint cnt = 0;\nint _log2[100007], a[50007], head[50007], depth[50007], fa[50007][17], sum[227][50007], b[50007];\nEdge edge[100007];\nvector<int> v[50007];\n\ninline void init(int n){\n\tfor (register int i = 2; i <= n; i++){\n\t\t_log2[i] = _log2[i >> 1] + 1;\n\t}\n}\n\ninline void add_edge(int start, int end){\n\tcnt++;\n\tedge[cnt].nxt = head[start];\n\thead[start] = cnt;\n\tedge[cnt].end = end;\n}\n\nvoid dfs(int u, int father){\n\tdepth[u] = depth[father] + 1;\n\tv[depth[u]].push_back(u);\n\tfa[u][0] = father;\n\tfor (register int i = 1; i <= _log2[depth[u]]; i++){\n\t\tfa[u][i] = fa[fa[u][i - 1]][i - 1];\n\t}\n\tfor (register int i = head[u]; i != 0; i = edge[i].nxt){\n\t\tint x = edge[i].end;\n\t\tif (x != father) dfs(x, u);\n\t}\n}\n\ninline int walk_up(int u, int step){\n\tfor (register int i = 0; i <= _log2[step]; i++){\n\t\tif (step >> i & 1) u = fa[u][i];\n\t}\n\treturn u;\n}\n\ninline int lca(int u, int v){\n\tif (depth[u] < depth[v]) swap(u, v);\n\tu = walk_up(u, depth[u] - depth[v]);\n\tif (u == v) return u;\n\tfor (register int i = _log2[depth[u]]; i >= 0; i--){\n\t\tif (fa[u][i] != fa[v][i]){\n\t\t\tu = fa[u][i];\n\t\t\tv = fa[v][i];\n\t\t}\n\t}\n\treturn fa[u][0];\n}\n\nint main(){\n\tint n, m;\n\tcin >> n;\n\tm = ceil(sqrt(n));\n\tinit(n * 2);\n\tfor (register int i = 1; i <= n; i++){\n\t\tcin >> a[i];\n\t}\n\tfor (register int i = 1; i < n; i++){\n\t\tint u, v;\n\t\tcin >> u >> v;\n\t\tadd_edge(u, v);\n\t\tadd_edge(v, u);\n\t}\n\tdfs(1, 0);\n\tfor (register int i = 1; i <= m; i++){\n\t\tfor (register int j = 1; j <= n; j++){\n\t\t\tint size = v[j].size();\n\t\t\tfor (register int k = 0; k < size; k++){\n\t\t\t\tsum[i][v[j][k]] = sum[i][walk_up(v[j][k], i)] + a[v[j][k]];\n\t\t\t}\n\t\t}\n\t}\n\tfor (register int i = 1; i <= n; i++){\n\t\tcin >> b[i];\n\t}\n\tfor (register int i = 2, j = b[1]; i <= n; j = b[i++]){\n\t\tint c, cur_lca = lca(j, b[i]), t, ans;\n\t\tcin >> c;\n\t\tt = walk_up(b[i], (depth[j] + depth[b[i]] - depth[cur_lca] * 2) % c);\n\t\tif (c <= m){\n\t\t\tans = (sum[c][j] - sum[c][walk_up(j, c * ((depth[j] - depth[cur_lca]) / c + 1))]) + (sum[c][t] - sum[c][walk_up(t, c * ((depth[t] - depth[cur_lca]) / c + 1))]);\n\t\t\tif ((depth[j] - depth[cur_lca]) % c == 0 && (depth[t] - depth[cur_lca]) % c == 0) ans -= a[cur_lca];\n\t\t} else {\n\t\t\tans = 0;\n\t\t\tif ((depth[j] - depth[cur_lca]) % c == 0 && (depth[b[i]] - depth[cur_lca]) % c == 0) ans -= a[cur_lca];\n\t\t\tfor (register int k = j; depth[k] >= depth[cur_lca]; k = walk_up(k, c)) ans += a[k];\n\t\t\tfor (register int k = t; depth[k] >= depth[cur_lca]; k = walk_up(k, c)) ans += a[k];\n\t\t}\n\t\tcout << ans << endl;\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1626531078,
        "uid": 201007,
        "name": "Leasier",
        "ccfLevel": 8,
        "title": "\u9898\u89e3 P3591 \u3010[POI2015] ODW\u3011"
    },
    {
        "content": "SOL\uff1a\n\n\u6211\u4eec\u89c2\u5bdf\u4e86\u4e00\u6ce2\u5c40\u52bf\uff0c\u53d1\u73b0\u8fd9\u9053\u9898\u6709\u4e9b\u773c\u719f\u3002\u76f8\u6bd4\u5927\u5bb6\u5e94\u8be5\u90fd\u505a\u8fc7\u8fd9\u6837\u4e00\u9053\u9898\uff1a\u7ed9\u4f60\u4e00\u4e2a\u9759\u6001\u7684\u5e8f\u5217\uff08\u6240\u8c13\u9759\u6001\u662f\u6307\u8fd9\u4e2a\u533a\u95f4\u4e0d\u4f1a\u505a\u4efb\u4f55\u7684\u4fee\u6539\uff09\uff0cM\u6b21\u7ed9\u51faX,L,K\uff0c\u8ba9\u4f60\u6c42\u4eceX\u8d77\u7684L\u4e2a\u6570\u7684\u548c\uff0c\u8fd9L\u4e2a\u6570\u4e2d\u95f4\u4e24\u4e24\u4e0b\u8868\u76f8\u95f4K\uff08\u4e3e\u4e2a\u6817\u5b50\uff1aX=5\uff0cL=4\uff0cK=3\uff0c\u90a3\u4e48sum=a5+a8+a11+a14\uff09\u3002\uff08N<=10W\uff0cM<=10W\uff09\n\n\n\u8fd9\u9053\u9898\u6211\u4eec\u7684\u601d\u60f3\u5c31\u662f\u5206\u5757\uff0c\u6211\u4eec\u53d1\u73b0\u5f53K\u5f88\u5927\u65f6\uff0c\u6211\u4eec\u66b4\u529b\u6c42\u548c\u7684\u901f\u5ea6\u662f\u76f8\u5f53\u5feb\u7684\u3002\u56e0\u4e3a\u6211\u4eec\u53d1\u73b0 L<=N/K\uff0c\u6211\u4eec\u7684\u66b4\u529b\u590d\u6742\u5ea6\u662fO(L)\u7684\u3002\u800cK\u5f88\u5c0f\u65f6\uff0c\u66b4\u529b\u5c31\u5f88\u6162\u4e86\uff0c\u63a5\u8fd1\u4e8eO(N)\u3002\u6211\u4eec\u53c8\u6ce8\u610f\u5230K=1\u65f6\u4fbf\u662f\u524d\u7f00\u548c\uff0c\u53ef\u4ee5\u505a\u5230O\uff081\uff09\u67e5\u8be2\u3002\u90a3\u4e48\u6211\u4eec\u4e0d\u7981\u60f3\u5f53K\u5f88\u5c0f\u65f6\u6211\u4eec\u7528\u524d\u7f00\u548c\u4f18\u5316\uff08K>1\u6709\u95f4\u8ddd\u7684\u524d\u7f00\u548c\u76f8\u6bd4\u5927\u5bb6\u90fd\u4f1a\uff09\u3002\n\n\n\u6211\u4eec\u5047\u8bbe\u6211\u4eec\u91c7\u53d6\u8fd9\u6837\u7684\u7b56\u7565\uff0c\u5f53K<S\u65f6\u6211\u4eec\u7528\u524d\u7f00\u548c\uff0cK>S\u65f6\u6211\u4eec\u91c7\u53d6\u66b4\u529b\uff0c\u90a3\u4e48\u6211\u4eec\u5c31\u53ef\u4ee5\u5728\u6700\u574f\u60c5\u51b5\u4e0bO\uff08n\\*s+m\\*n/s\uff09\u4e0b\u89e3\u51b3\u95ee\u9898,\u90a3\u4e48\u6211\u4eec\u89e3\u5f97S=sqrt N\u65f6\u6700\u4f18\u3002\uff08\u5b9e\u9645\u4e0aS\u53d6\u7684\u7a0d\u5fae\u5c0f\u4e00\u4e9b\u4f1a\u66f4\u5feb\uff0c\u56e0\u4e3a\u6211\u4eec\u521a\u521a\u8ba1\u7b97\u7684\u662f\u6700\u574f\u60c5\u51b5\uff09\n\n\n\u90a3\u4e48\u6211\u4eec\u5c31\u53ef\u4ee5\u505a\u8fd9\u4e00\u9053\u9898\u4e86\uff0c\u540c\u6837\u7684\u601d\u60f3\uff0c\u5f53K<sqrt N \u65f6\u6211\u4eec\u9884\u5904\u7406\uff0cK > sqrt N \u65f6\u6211\u4eec\u4fbf\u66b4\u529b\u5411\u4e0a\u8df3\u3002\n\n\ncase 1: K<sqrt N \u6211\u4eec\u9884\u5904\u7406\u6bcf\u4e2a\u70b9 \u4ee5K\u4e3a\u95f4\u8ddd\u5411\u4e0a\u8df3\u7684 \u7b54\u6848\uff0cx\u7684\u7b54\u6848\u52a0\u4e0ay\u7684\u7b54\u6848\u51cf\u53bblca\u7684\u7b54\u6848\u5c31\u662f\u4e86\u3002\n\n\ncase 1: K>sqrt N \u6211\u4eec\u66b4\u529b\u505a\uff0c\u6211\u4eec\u6bcf\u6b21\u7528\u6811\u4e0a\u500d\u589e\u7684\u65b9\u6cd5 log N \u7684\u65b9\u6cd5\u5411\u4e0a\u8df3\uff0c\u66b4\u529b\u7edf\u8ba1\u7b54\u6848\uff0c\u8df3\u8df3\u5c31\u597d\u4e86\u3002\n\n\u4ee3\u7801\u89c1\u8fd9\u91cc\uff1ahttp://www.cnblogs.com/rrsb/p/8127786.html\n",
        "postTime": 1514381582,
        "uid": 53193,
        "name": "\u6b87\u96ea",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3591 \u3010[POI2015]ODW\u3011"
    },
    {
        "content": "\u4e00\u9053\u5f88\u597d\u60f3\u4f46\u7ec6\u8282\u4e0d\u5c11\u7684\u5206\u5757\u9898\uff0c\u8fd9\u91cc\u7ed9\u51fa\u4e00\u79cd\u4e0d\u9700\u8981\u957f\u94fe\u5256\u5206\u7684 $O(n\\sqrt n)$ \u505a\u6cd5\u3002\n\n\u505a\u6cd5\u5f88\u663e\u7136\uff0c\u9884\u5904\u7406\u51fa\u6b65\u957f\u4e3a $[1,\\sqrt n]$ \u65f6\u6bcf\u4e2a\u70b9\u5411\u4e0a\u8df3\u5230\u6839\u7ecf\u8fc7\u7684\u70b9\u6743\u548c\uff08\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u81ea\u7136\u4e5f\u4f1a\u5904\u7406\u51fa\u6bcf\u4e2a\u70b9\u7684 $1\\sim\\sqrt n$ \u7ea7\u7956\u5148\uff09\u3002\u5bf9\u4e8e\u4e00\u6b21\u6b65\u957f\u4e3a $k$ \u7684\u8be2\u95ee\uff0c\u5f53 $1\\le k \\le\\sqrt n$ \u65f6\u76f4\u63a5\u6811\u4e0a\u5dee\u5206\u5373\u53ef\uff0c\u800c\u5f53 $k>\\sqrt n$ \u65f6\u5219\u66b4\u529b\u8df3\uff0c\u56e0\u4e3a\u8df3\u7684\u6b21\u6570\u4e00\u5b9a\u4e0d\u4f1a\u8d85\u8fc7 $\\sqrt n$\u3002\n\n\u4f46\u662f\u7b2c\u4e8c\u79cd\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u5e76\u65e0\u6cd5\u9ad8\u6548\u5730\u67e5\u8be2\u4e00\u4e2a\u70b9\u7684 $k $ \u7ea7\u7956\u5148\uff0c\u5426\u5219\u65f6\u95f4\u590d\u6742\u5ea6\u5c31\u4f1a\u591a\u4e2a $\\log$\u3002\u4e8e\u662f\u6211\u4eec\u53ef\u4ee5\u6bcf\u6b21\u53ea\u8df3 $\\sqrt n$ \u6b65\uff0c\u7528\u82e5\u5e72\u4e2a $\\sqrt n$ \u518d\u52a0\u4e00\u4e2a\u4e0d\u5927\u4e8e $\\sqrt n$ \u7684\u5e38\u6570\u62fc\u6210 $k$\uff0c\u663e\u7136\u8fd9\u79cd\u60c5\u51b5\u4e0b\u65f6\u95f4\u590d\u6742\u5ea6\u4ecd\u7136\u662f $O(n\\sqrt n)$ \u7684\u3002\n\n\u4ee3\u7801\uff08\u7528\u4e86\u6211\u81ea\u5df1\u7684\u5feb\u8bfb\u5feb\u5199\u5e93\uff0c\u4e0d\u8fc7\u5e76\u4e0d\u59a8\u788d\u9605\u8bfb\uff09\uff1a\n```cpp\n#include <fastio.hpp>\n#include <vector>\n#include <cmath>\n\nconst int maxn = 50009, maxs = 250;\nusing namespace std;\n\n//sum[i][j]\u4ee3\u8868\u6b65\u957f\u4e3aj\u65f6\u4ecei\u8df3\u5230\u6839\u7684\u70b9\u6743\u548c\uff0cup[i][j]\u4ee3\u8868i\u7684\u7b2cj\u7ea7\u7956\u5148\uff0cfa[i][j]\u4ee3\u8868i\u7684\u7b2c2^j\u7ea7\u7956\u5148\nint sum[maxn][maxs],up[maxn][maxs],fa[maxn][16],path[maxn],step[maxn],dep[maxn],n,lim;\nvector<int> edges[maxn];\n\nvoid Read(){\n    read(n); lim = round(sqrt(n));\n    for(int i=1; i<=n; i++) read(sum[i][0]);\n    for(int i=1,u,v; i<n; i++){\n        read(u,v);\n        edges[u].push_back(v);\n        edges[v].push_back(u);\n    }\n    readarr(path+1,n);\n    readarr(step+1,n-1);\n}\nvoid Dfs(int now){\n    dep[now] = dep[fa[now][0]]+1;\n    for(int i=1; i<16; i++){\n        fa[now][i] = fa[fa[now][i-1]][i-1];\n    }\n    up[now][0] = now;\n    up[now][1] = fa[now][0];\n    sum[now][1] = sum[now][0] + sum[fa[now][0]][1];\n    for(int i=2; i<=lim; i++){\n        up[now][i] = up[fa[now][0]][i-1];\n        sum[now][i] = sum[now][0] + sum[up[now][i]][i];\n    }\n    for(int to : edges[now]){\n        if(to == fa[now][0]) continue;\n        fa[to][0] = now;\n        Dfs(to);\n    }\n}\n\ninline int LCA(int u, int v){\n    if(dep[u] < dep[v]) swap(u,v);\n    for(int i=15; ~i; i--){\n        if(dep[fa[u][i]] >= dep[v]) u=fa[u][i];\n    }\n    if(u == v) return u;\n    for(int i=15; ~i; i--){\n        if(fa[u][i] != fa[v][i]){\n            u=fa[u][i];\n            v=fa[v][i];\n        }\n    }\n    return fa[u][0];\n}\n\nint Walk(int u, int v, int dist) {\n    int lca = LCA(u,v), res = 0;\n    if(dist <= lim){ //\u6811\u4e0a\u5dee\u5206\n        if(lca == u) return sum[v][dist]-sum[up[u][dist]][dist];\n        if(lca == v) return sum[u][dist]-sum[up[v][dist]][dist];\n        res = sum[u][dist]+sum[v][dist];\n        int tmp = fa[lca][0];\n        while(tmp && dep[tmp]%dist != dep[u]%dist) tmp = fa[tmp][0];\n        res -= sum[tmp][dist];\n        tmp = lca;\n        while(tmp && dep[tmp]%dist != dep[v]%dist) tmp = fa[tmp][0];\n        res -= sum[tmp][dist];\n        return res;\n    }\n    //\u66b4\u529b\u8df3\n    res = sum[u][0];\n    while(dep[u] > dep[lca]){\n        int walk = dist;\n        while(walk > lim){\n            u = up[u][lim];\n            walk -= lim;\n        }\n        u = up[u][walk];\n        if(dep[u] >= dep[lca]) res += sum[u][0];\n    }\n    if(u == v) return res;\n    res += sum[v][0];\n    while(dep[v] > dep[lca]){\n        int walk = dist;\n        while(walk > lim){\n            v = up[v][lim];\n            walk -= lim;\n        }\n        v = up[v][walk];\n        if(dep[v] > dep[lca]) res += sum[v][0];\n    }\n    return res;\n}\n\nint main(){\n    Read();\n    Dfs(1);\n    for(int i=1; i<n; i++){\n        writeln(Walk(path[i],path[i+1],step[i]));\n    }\n    fastio_flush();\n    return 0;\n}\n```\n",
        "postTime": 1643779473,
        "uid": 130256,
        "name": "jia_shengyuan",
        "ccfLevel": 9,
        "title": "P3691 ODW \u9898\u89e3"
    },
    {
        "content": "> [P3591 [POI2015]ODW](https://www.luogu.com.cn/problem/P3591)\n>\n> [POI \u5408\u96c6](https://www.cnblogs.com/alex-wei/p/POI.html)\u3002\n\n\u6bd4\u8f83\u5957\u8def\u7684\u6839\u53f7\u5206\u6cbb\u9898\u76ee\u3002\u7531\u4e8e\u5f53\u6b65\u957f $>B$ \u65f6\u6700\u591a\u8d70 $\\dfrac n B$ \u6b65\uff0c\u6240\u4ee5\u6211\u4eec\u8bbe\u7f6e\u4e00\u4e2a\u9608\u503c $B$\uff0c\u8868\u793a\u82e5\u6b65\u957f $\\leq B$ \u5219\u4f7f\u7528\u9884\u5904\u7406\u7684\u4fe1\u606f\uff0c\u82e5\u6b65\u957f $>B$ \u5219\u66b4\u529b\u6811\u4e0a\u500d\u589e\u8ba1\u7b97\u3002\n\n\u9884\u5904\u7406\u7684\u4fe1\u606f\u53ea\u9700\u8981 $v_{k,u}$ \u8868\u793a $u$ \u6bcf\u6b21\u5411\u4e0a\u8df3 $k$ \u6b65\u80fd\u5230\u8fbe\u7684\u6240\u6709\u8282\u70b9\u6743\u503c\u4e4b\u548c\uff0c\u5373 $\\sum_{v\\in \\mathrm{ancestor}(u)}a_v[k\\mid dep_u-dep_v]$\u3002\u53ef\u4ee5\u5728 $\\mathcal{O}(nB)$ \u7684\u590d\u6742\u5ea6\u5185\u6c42\u5f97\u3002\n\n\u7efc\u4e0a\uff0c\u65f6\u95f4\u590d\u6742\u5ea6 $\\mathcal{O}\\left(nB+\\dfrac{n^2}{B}\\log n\\right)$\uff0c\u5f53 $B$ \u53d6 $\\sqrt{n\\log n}$ \u65f6\u6709\u7406\u8bba\u6700\u4f18\u590d\u6742\u5ea6 $n\\sqrt{n\\log n}$\u3002\u5982\u679c\u7528\u957f\u94fe\u5256\u5206\u6c42\u6811\u4e0a $k$ \u7ea7\u7956\u5148\u5219\u53ef\u505a\u5230\u4e25\u683c $n\\sqrt n$\u3002\n\n\u7531\u4e8e\u6570\u636e\u539f\u56e0\uff0c\u5b9e\u9645\u8868\u73b0\u4e2d\u53d6 $B=20$ \u4f1a\u5f88\u5feb\u3002\n\n```cpp\nint n, a[N], b[N], lg[N];\nint fa[16][N], dep[N], val[B][N];\nvint e[N];\nint kthanc(int u, int k) {\n\tfor(int i = lg[k]; ~i; i--) if(k >> i & 1) u = fa[i][u];\n\treturn u;\n}\nint LCA(int u, int v) {\n\tif(dep[u] < dep[v]) swap(u, v);\n\tfor(int i = lg[dep[u]]; ~i; i--)\n\t\tif(dep[u] - dep[v] >> i & 1) u = fa[i][u];\n\tif(u == v) return u;\n\tfor(int i = lg[dep[u]]; ~i; i--)\n\t\tif(fa[i][u] != fa[i][v]) u = fa[i][u], v = fa[i][v];\n\treturn fa[0][u];\n}\nvoid dfs(int id, int f) {\n\tfa[0][id] = f, dep[id] = dep[f] + 1;\n\tfor(int i = 1; i <= lg[dep[id]]; i++) fa[i][id] = fa[i - 1][fa[i - 1][id]];\n\tfor(int i = 1, v = f; i < B; i++, v = fa[0][v])\n\t\tval[i][id] = a[id] + val[i][v];\n\tfor(int it : e[id]) if(it != f) dfs(it, id);\n}\n\nint main() {\n\tcin >> n;\n\tfor(int i = 2; i <= n; i++) lg[i] = lg[i >> 1] + 1;\n\tfor(int i = 1; i <= n; i++) a[i] = read();\n\tfor(int i = 1, u, v; i < n; i++) e[u = read()].pb(v = read()), e[v].pb(u);\n\tdfs(1, 0);\n\tfor(int i = 1; i <= n; i++) b[i] = read();\n\tfor(int i = 1, u, v, c; i < n; i++) {\n\t\tc = read(), u = b[i], v = b[i + 1];\n\t\tint d = LCA(u, v), ans = 0;\n\t\tif(c >= B) {\n\t\t\tans = a[u] + a[v];\n\t\t\twhile(1) {\n\t\t\t\tint anc = kthanc(u, c);\n\t\t\t\tif(dep[anc] < dep[d]) break;\n\t\t\t\tif(v == d && anc == d) break;\n\t\t\t\tans += a[anc], u = anc;\n\t\t\t}\n\t\t\tint gap = dep[u] + dep[v] - (dep[d] << 1);\n\t\t\tif(gap % c) {\n\t\t\t\tint anc = kthanc(v, gap % c);\n\t\t\t\tif(dep[anc] > dep[d]) ans += a[anc], v = anc;\n\t\t\t}\n\t\t\twhile(1) {\n\t\t\t\tint anc = kthanc(v, c);\n\t\t\t\tif(dep[anc] <= dep[d]) break;\n\t\t\t\tans += a[anc], v = anc;\n\t\t\t}\n\t\t} else if(d == v)\n\t\t\tans = a[v] + val[c][u] -\n\t\t\t\tval[c][kthanc(u, (dep[u] - dep[v] - 1) / c * c + c)];\n\t\telse {\n\t\t\tint gap = dep[u] - dep[d];\n\t\t\tint anc = kthanc(u, gap / c * c + c);\n\t\t\tans += val[c][u] - val[c][anc];\n\t\t\tgap = dep[u] + dep[v] - (dep[d] << 1);\n\t\t\tif(gap % c) {\n\t\t\t\tint anc = kthanc(v, gap % c);\n\t\t\t\tif(dep[anc] > dep[d]) ans += a[v], v = anc;\n\t\t\t}\n\t\t\tif(v != d) {\n\t\t\t\tanc = kthanc(v, (dep[v] - dep[d] - 1) / c * c + c);\n\t\t\t\tans += val[c][v] - val[c][anc];\n\t\t\t}\n\t\t} print(ans), pc('\\n');\n\t}\n\treturn flush(), 0;\n}\n```",
        "postTime": 1639123892,
        "uid": 123294,
        "name": "Alex_Wei",
        "ccfLevel": 10,
        "title": "P3591 [POI2015]ODW"
    },
    {
        "content": "$O(n\\sqrt{n}\\log n)$ \u5feb\u5230\u8d77\u98de\uff1f\uff1f \u6700\u4f18\u89e3 rk2\n\n## \u6839\u53f7\u5206\u6cbb + \u91cd\u94fe\u5256\u5206\n\n\u6839\u53f7\u5206\u6cbb\u90e8\u5206\u4f3c\u4e4e\u697c\u4e0a\u90fd\u8bf4\u4e86 \u6211\u4e5f\u5728\u63d0\u4e00\u5634\n\n\u6b65\u5e45\u8fd9\u79cd\u4e1c\u897f\u662f\u5929\u7136\u4e0e\u9664\u6cd5\u6709\u5173 \u8003\u8651\u6839\u53f7\u5206\u6cbb\n\n\u4e00\u6761\u8def\u5f84\u6700\u574f\u957f $O(n)$ \u9608\u503c $s$\n\n\u5982\u679c\u6b65\u5e45\u957f\u4e8e $s$ \u76f4\u63a5\u66b4\u529b\u770b\u8d77\u6765\u5c31\u5f88\u53ef\u505a $O(\\dfrac{n}{s})$ \u540e\u9762\u4e58\u4e2a\u627e\u5230 $k$ \u7ea7\u7956\u5148\u7684\u590d\u6742\u5ea6 \u6709 $k$ \u5927\u4e8e $s$\n\n\u5982\u679c\u5c0f\u4e8e\u6839\u53f7\u6211\u4eec\u7ef4\u62a4\u4e00\u4e2a\u7c7b\u4f3c\u6811\u4e0a\u8def\u5f84\u5dee\u5206\u7684\u4e1c\u897f \u7a7a\u95f4 $O(sn)$ \u65f6\u95f4 $O(sn)$ \u4e58\u4e2a\u627e\u5230 $k$ \u7ea7\u7956\u5148\u7684\u590d\u6742\u5ea6 \u6709 $k$ \u5c0f\u4e8e\u7b49\u4e8e $s$\n\n\u6211\u4eec\u8003\u8651\u600e\u4e48\u641e $k$ \u7ea7\u7956\u5148 \u6211\u592a\u84bb\u4e86 \u4e0d\u4f1a\u957f\u5256 \u6211\u592a\u61d2\u4e86 \u4e0d\u60f3\u5199\u500d\u589e\n\n\u6240\u4ee5\u778e\u641e\u4e2a\u91cd\u5256 \u91cd\u5256 $\\log n $ \u627e $k$ \u7ea7\u7956\u5148 \u633a\u597d\u641e\u7684 \u5c31\u5728\u5230\u6839\u7684\u8def\u5f84\u4e0a\u8df3\u94fe \u627e\u5c31\u5b8c\u4e86 \u7136\u540e\u5c31\u505a\u5b8c\u4e86 \u8ba8\u8bba\u4e00\u4e0b\u9608\u503c\u7684\u53d6\u503c\n\n\u5c0f\u4e8e\u9608\u503c\u7684\u90e8\u5206\u53c8\u8017\u7a7a\u95f4 \u9884\u5904\u7406\u67e5\u7684\u6b21\u6570\u8fd8\u5f88\u591a \u6240\u4ee5\u9608\u503c\u5411\u5c0f\u8c03\n\n$s=\\sqrt{n}$ \u53ef\u8fc7\u6d1b\u8c37\u6570\u636e bzoj \u6570\u636e\u4f1a T \n\n$s=\\dfrac{\\sqrt{n}}{20}$ \u5c31\u66f4\u5feb\u4e86 \u6bd4\u6839\u53f7\u5feb10\u500d\uff08\n\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\nconst int N=5e4+3;\ninline int read()\n{\n\tint x=0;\n\tchar c=getchar();\n\twhile(c<'0'||c>'9')c=getchar();\n\twhile(c<='9'&&c>='0')\n\t{\n\t\tx=(x<<1)+(x<<3)+(c^48);\n\t\tc=getchar();\n\t}\n\treturn x;\n}\nint n,a[N],q[N],c[N];\nstruct edge\n{\n\tint to,nxt;\n}e[N<<1];\nint h[N],etot;\ninline void eadd(int x,int y)\n{\n\te[++etot].to=y;\n\te[etot].nxt=h[x];\n\th[x]=etot;\n}\nint dep[N],top[N],fa[N],exdfn[N],dfn[N],cnt,siz[N],son[N];\nint w[120][N];\nvoid dfs1(int x)\n{\n\tint maxson=-1;\n\tw[1][x]+=a[x];\n\tsiz[x]=1;\n\tfor(int i=h[x];i;i=e[i].nxt)\n\t{\n\t\tif(e[i].to!=fa[x])\n\t\t{\n\t\t\tfa[e[i].to]=x;\n\t\t\tdep[e[i].to]=dep[x]+1;\n\t\t\tw[1][e[i].to]=w[1][x];\n\t\t\tdfs1(e[i].to);\n\t\t\tsiz[x]+=siz[e[i].to];\n\t\t\tif(siz[e[i].to]>maxson)\n\t\t\t{\n\t\t\t\tmaxson=siz[e[i].to];\n\t\t\t\tson[x]=e[i].to;\n\t\t\t}\n\t\t}\n\t}\n}\nvoid dfs2(int x,int topn)\n{\n\ttop[x]=topn;\n\texdfn[++cnt]=x;\n\tdfn[x]=cnt;\n\tif(!son[x])return;\n\tdfs2(son[x],topn);\n\tfor(int i=h[x];i;i=e[i].nxt)\n\t{\n\t\tif(e[i].to!=fa[x]&&e[i].to!=son[x])\n\t\tdfs2(e[i].to,e[i].to);\n\t}\n}\ninline int get_fa(int x,int k)\n{\n\twhile(k>dep[x]-dep[top[x]]&&x)\n\t{\n\t\tk-=(dep[x]-dep[top[x]]+1);\n\t\tx=fa[top[x]];\n\t}\n\tif(dfn[x]-k&&x)\n\treturn exdfn[dfn[x]-k];\n\telse\n\treturn 0;\n}\ninline int get_lca(int x,int y)\n{\n\twhile(top[x]!=top[y])\n\t{\n\t\tif(dep[top[x]]<dep[top[y]])swap(x,y);\n\t\tx=fa[top[x]];\n\t}\n\tif(dep[x]>dep[y])swap(x,y);\n\treturn x;\n}\nvoid build(int x,int k)\n{\n\tw[k][x]=w[k][get_fa(x,k)]+a[x];\n\tfor(int i=h[x];i;i=e[i].nxt)\n\t{\n\t\tif(e[i].to!=fa[x])\n\t\tbuild(e[i].to,k);\n\t}\n}\nint s;\ninline int qes(int x,int y,int k)\n{\n\tint lca=get_lca(x,y);\n\tif(k<=s)\n\t{\n\t\tint yy=(dep[x]-dep[lca])%k;\n\t\tif(yy)\n\t\t{\n\t\t\tyy=get_fa(lca,k-yy);\n\t\t\tint xx=(dep[y]-dep[lca])%k;\n\t\t\txx=get_fa(lca,k-xx);\n\t\t\treturn w[k][x]+w[k][y]-w[k][yy]-w[k][xx];\n\t\t}\n\t\treturn w[k][y]+w[k][x]-w[k][lca]-w[k][get_fa(lca,k)];\n\t}\n\telse\n\t{\n\t\tint res=0;\n\t\tbool reo=0;\n\t\twhile(dep[x]>=dep[lca])\n\t\t{\n\t\t\tres+=a[x];\n\t\t\tif(x==lca)reo=1;\n\t\t\tx=get_fa(x,k);\n\t\t}\n\t\twhile(dep[y]>=dep[lca])\n\t\t{\n\t\t\tres+=a[y];\n\t\t\ty=get_fa(y,k);\n\t\t}\n\t\tif(reo)res-=a[lca];\n\t\treturn res;\n\t}\n}\nint main()\n{\n\t//freopen(\"in.txt\",\"r\",stdin);\n\t//freopen(\"out.txt\",\"w\",stdout);\n\tn=read();\n\tfor(int i=1;i<=n;i++)a[i]=read();\n\tfor(int i=1;i<n;i++)\n\t{\n\t\tint x=read(),y=read();\n\t\teadd(x,y);\n\t\teadd(y,x);\n\t}\n\tfor(int i=1;i<=n;i++)q[i]=read();\n\tfor(int i=1;i<n;i++)c[i]=read();\n\ts=ceil(sqrt(n)/20);\n\tdep[1]=1;\n\tdfs1(1);\n\tdfs2(1,1);\n\tfor(int i=2;i<=s;i++)build(1,i);\n\tfor(int i=1;i<n;i++)\n\t{\n\t\tprintf(\"%d\\n\",qes(q[i],q[i+1],c[i]));\n\t}\n\treturn 0;\n}\n```\n",
        "postTime": 1647704373,
        "uid": 223560,
        "name": "_HL_",
        "ccfLevel": 0,
        "title": "P3591 [POI2015] ODW \u9898\u89e3"
    },
    {
        "content": "\u4ee4 $f_{i,j}$ \u4e3a $i$ \u5f80\u4e0a\u8df3 $j$ \u6b65\uff0c\u76f4\u5230\u4e0d\u80fd\u8df3\u4e3a\u6b62\u7684\u7b54\u6848\u3002\n\n$j \\leq \\sqrt n$\u3002\n\n$f_{i,j} = f_{K(i,j),j} + val_i$\u3002\n\n\u8fd9\u6837\u9884\u5904\u7406\u7684\u590d\u6742\u5ea6\u662f $n \\sqrt n$\u3002\n\n\u67e5\u8be2\u7684\u65f6\u5019\u505a\u4e00\u4e2a\u524d\u7f00\u548c\u5c31\u597d\u4e86\u3002\n\n\u7136\u540e\u5982\u679c\u8df3 $j$\uff0c$j \\geq \\sqrt n$\uff0c\u90a3\u4e48\u76f4\u63a5\u8df3\u3002\n\n\n\u4ee3\u7801\u9e3d\u4e86",
        "postTime": 1606441358,
        "uid": 96580,
        "name": "SXNhdW5veWE",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P3591 \u3010[POI2015]ODW\u3011"
    },
    {
        "content": "\u8fd9\u9898\u5b9e\u9645\u4e0a\u6bd4\u8f83\u5957\u8def......\n\n\u6ce8\u610f\u5230 $n\\le 50000$\uff0c\u5927\u6982\u7387\u662f\u60f3\u8ba9\u6211\u4eec\u7528\u4e2a $\\mathcal{O}(n\\sqrt{n})$ \u7684\u590d\u6742\u5ea6\u3002\u60f3\u5230\u6839\u53f7\u590d\u6742\u5ea6\u7684\u8bdd\u5c31\u5f88\u6709\u53ef\u80fd\u662f\u4e2a\u6839\u53f7\u5206\u6cbb\u3002\u8fd9\u9898\u4e5f\u4e0d\u4f8b\u5916\u3002\n\n\u6211\u4eec\u6309\u7167 $k$ \u7684\u5927\u5c0f\u5206\u6210\u4e24\u7c7b\uff1a\u5047\u8bbe\u4e00\u4e2a\u754c\u4e3a $B=200$\uff0c\u5f53 $k\\ge B$ \u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u76f4\u63a5\u66b4\u529b\u6a21\u62df\u8fd9\u4e2a\u8df3\u7684\u8fc7\u7a0b\uff0c\u5f53 $k<B$ \u7684\u65f6\u5019\u5c31\u53ef\u4ee5\u8003\u8651\u7528\u4ec0\u4e48\u4e1c\u897f\u6765\u7ef4\u62a4\u3002\n\n\u5148\u8bf4\u7b80\u5355\u7684\u90e8\u5206\uff1a\u66b4\u529b\u5411\u4e0a\u8df3\u3002\u6211\u4eec\u53ef\u4ee5\u5c06\u8def\u5f84 $x\\to y$ \u62c6\u6210 $x\\to lca,lca \\to y$\u3002\u8fd9\u6837\u7684\u8bdd\uff0c\u6211\u4eec\u9700\u8981\u8ddd\u79bb $x$ \u4e3a $k$ \u7684\u7956\u5148\u662f\u54ea\u4e00\u4e2a\uff08\u4e5f\u5c31\u662f $x$ \u7684 $k$ \u7ea7\u7956\u5148\uff09\u3002\u8fd9\u4e00\u90e8\u5206\u6211\u4eec\u53ef\u4ee5\u7528\u957f\u94fe\u5256\u5206\u6765\u641e\uff0c\u867d\u7136\u6162\u4e86\u70b9\u4f46\u8fd8\u662f\u80fd\u8fc7\u3002\u8fd9\u6837\u7684\u8bdd\uff0c\u5c31\u53ef\u4ee5\u5c06\u8def\u5f84\u770b\u6210 $x$ \u5230 $lca$\uff0c$y$ \u5230 $lca$\u3002\n\n\u6ce8\u610f\u4e00\u4e2a\u7ec6\u8282\uff1a$y$ \u9700\u8981\u5148\u5f80\u4e0a\u8df3\u4e00\u5c0f\u6bb5\u518d\u66b4\u529b\u8df3\u5230 $lca$\uff0c\u56e0\u4e3a\u9898\u76ee\u4e2d\u6709\u8bf4 \u201c\u8ddd\u79bb\u5c0f\u4e8e $k$ \u7684\u8bdd\u5c31\u76f4\u63a5\u4e00\u6b65\u8df3\u5230 $y$\u201d\u3002\u8fd9\u6837\u7684\u8bdd\uff0c\u56e0\u4e3a $y$ \u5f80\u4e0a\u8df3\u4e0e\u5b9e\u9645\u8def\u5f84\u65b9\u5411\u76f8\u53cd\uff0c\u6240\u4ee5\u9700\u8981\u5148\u5904\u7406\u8fd9\u4e00\u5c0f\u6bb5\u3002\n\n\u4e4b\u540e\u518d\u8bf4 $k<B$ \u7684\u90e8\u5206\u3002\u8bbe $s(i,j)$ \u8868\u793a\u4ece $i$ \u5f00\u59cb\u6bcf\u6b21\u8df3 $j$ \u6b65\u4e00\u76f4\u8df3\u5230\u6839\u8282\u70b9\u4e3a\u6b62\u7684\u8def\u5f84\u4e0a\u7684\u70b9\u6743\u548c\uff08\u5f53\u7136\u4e5f\u6709\u53ef\u80fd\u8df3\u4e0d\u5230\u6839\u8282\u70b9\uff0c\u4f46\u8fd9\u4e2a\u5176\u5b9e\u65e0\u6240\u8c13\uff0c\u56e0\u4e3a\u8fd9\u4e2a\u65f6\u5019\u518d\u8df3 $j$ \u6b65\u7684\u8bdd\u5df2\u7ecf\u8df3\u51fa\u53bb\u4e86\uff09\u3002\u8fd9\u4e00\u6b65\u6709\u4e00\u4e2a\u9012\u63a8\u5f0f\u5b50\uff1a\u8bbe $f(i,j)$ \u8868\u793a $i$ \u7684 $j$ \u7ea7\u7956\u5148\u662f\u54ea\u4e2a\u70b9\uff0c\u90a3\u4e48\u663e\u7136\u6211\u4eec\u5c31\u6709 $s(i,j)=s(f(i,j),j)+a_i$\uff08$a_i$ \u4e3a\u70b9\u6743\uff09\uff0c\u6ce8\u610f $f(i,j)$ \u53ef\u80fd\u4e0d\u5b58\u5728\uff0c\u8fd9\u4e2a\u65f6\u5019\u5c31\u662f $s(i,j)=a_i$\u3002\n\n\u4e4b\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u7b97\u51fa $s(x,k)$ \u5e76\u51cf\u53bb\u5728 $lca(x,y)$ \u4e0a\u65b9\u7684\u90e8\u5206\u8d21\u732e\uff0c\u540c\u7406\u4e5f\u53ef\u4ee5\u7b97\u51fa $s(y,k)$ \u5e76\u51cf\u53bb\u5728 $lca(x,y)$ \u4e0a\u65b9\u7684\u90e8\u5206\u8d21\u732e\u3002\u540c\u65f6\u6ce8\u610f\u4e00\u4e0b\u4e0a\u9762\u63d0\u5230\u7684\u7ec6\u8282\u5373\u53ef\u3002\n\n\u7efc\u4e0a\uff0c\u8fd9\u4e2a\u9898\u5c31\u505a\u5b8c\u4e86\u3002\u65f6\u95f4\u590d\u6742\u5ea6\u4e3a $\\mathcal{O}(nB\\log n)$\n\n\u4f46\u662f\u8fd9\u9898\u7ec6\u8282\u662f\u771f\u7684\u8d85\u591a......\n\n```cpp\n#include <bits/stdc++.h>\n#define ll long long\n#define ls id << 1\n#define rs id << 1 | 1\n#define mem(array, value, size, type) memset(array, value, ((size) + 5) * sizeof(type))\n#define memarray(array, value) memset(array, value, sizeof(array))\n#define pb(x) push_back(x)\n#define st(x) (1LL << (x))\n#define pii pair<int, int>\n#define mp(a, b) make_pair((a), (b))\n#define Flush fflush(stdout)\n#define vecfirst (*vec.begin())\n#define veclast (*vec.rbegin())\n#define vecall(v) (v).begin(), (v).end()\n#define vecupsort(v) (sort((v).begin(), (v).end()))\n#define vecdownsort(v, type) (sort(vecall(v), greater<type>()))\n#define veccmpsort(v, cmp) (sort(vecall(v), cmp))\nusing namespace std;\nconst int N = 50050;\nconst int inf = 0x3f3f3f3f;\nconst ll llinf = 0x3f3f3f3f3f3f3f3f;\nconst int mod = 998244353;\nconst int MOD = 1e9 + 7;\nconst double PI = acos(-1.0);\nclock_t TIME__START, TIME__END;\nvoid program_end()\n{\n#ifdef ONLINE\n    printf(\"\\nTime used: %.6lf(s)\\n\", ((double)TIME__END - TIME__START) / 1000);\n    system(\"pause\");\n#endif\n}\nconst int M = 201;\nint s[N][M], a[N];\nint n;\nint b[N], d[N], f[N][16], son[N], dep[N], top[N], g[N];\nvector<int> e[N], u[N], v[N];\nvoid dfs(int x, int fa)\n{\n    dep[x] = d[x] = d[fa] + 1;\n    f[x][0] = fa;\n    for (int i = 1; (1 << i) <= d[x]; i++)\n        f[x][i] = f[f[x][i - 1]][i - 1];\n    for (auto y : e[x])\n    {\n        if (y == fa)\n            continue;\n        dfs(y, x);\n        if (dep[y] > dep[x])\n            dep[x] = dep[y], son[x] = y;\n    }\n}\ninline int getlca(int a, int b)\n{\n    if (d[a] > d[b])\n        swap(a, b);\n    for (int i = 15; i >= 0; i--)\n        if (d[a] <= d[b] - (1 << i))\n            b = f[b][i];\n    if (a == b)\n        return a;\n    for (int i = 15; i >= 0; i--)\n    {\n        if (f[a][i] == f[b][i])\n            continue;\n        else\n            a = f[a][i], b = f[b][i];\n    }\n    return f[a][0];\n}\ninline int getdis(int x, int y) { return d[x] + d[y] - 2 * d[getlca(x, y)]; }\nvoid dfs(int x, int p, int fa)\n{\n    top[x] = p;\n    if (x == p)\n    {\n        for (int i = 0, o = x; i <= dep[x] - d[x]; ++i)\n            u[x].pb(o), o = f[o][0];\n        for (int i = 0, o = x; i <= dep[x] - d[x]; ++i)\n            v[x].pb(o), o = son[o];\n    }\n    if (son[x])\n        dfs(son[x], p, f[son[x]][0]);\n    for (auto y : e[x])\n        if (y != son[x] && y != fa)\n            dfs(y, y, x);\n}\ninline int ask(int x, int k)\n{\n    if (!k)\n        return x;\n    x = f[x][g[k]], k -= 1 << g[k], k -= d[x] - d[top[x]], x = top[x];\n    return k >= 0 ? (k < (int)u[x].size() ? u[x][k] : -1) : (k < (int)v[x].size() ? v[x][-k] : -1);\n}\nvoid dfs2(int x, int fa)\n{\n    for (int j = 1; j < M; ++j)\n    {\n        if (ask(x, j) == -1)\n            s[x][j] = a[x];\n        else\n            s[x][j] = s[ask(x, j)][j] + a[x];\n    }\n    for (auto vv : e[x])\n    {\n        if (vv == fa)\n            continue;\n        dfs2(vv, x);\n    }\n}\n\ninline int queryBig(int x, int y, int k)\n{\n    int resx = 0, resy = 0;\n    int lca = getlca(x, y), D = getdis(x, y);\n    int dx = getdis(x, lca), dy = getdis(y, lca);\n    if (lca == x)\n    {\n        int ry = D % k;\n        if (ry)\n            resy += a[y];\n        y = ask(y, ry);\n        while (~y && d[y] >= d[lca])\n            resy += a[y], y = ask(y, k);\n        return resy;\n    }\n    while (~x && d[x] > d[lca])\n        resx += a[x], x = ask(x, k);\n    if (lca == y)\n        return resx + a[y];\n    int ry = D % k;\n    if (ry)\n        resy += a[y];\n    y = ask(y, ry);\n    while (~y && d[y] > d[lca])\n        resy += a[y], y = ask(y, k);\n    if (dx % k == 0 || dy % k == 0)\n        resx += a[lca];\n    return resx + resy;\n}\ninline int querySmall(int x, int y, int k)\n{\n    int resx = 0, resy = 0;\n    int lca = getlca(x, y), D = getdis(x, y);\n    int ry = D % k;\n    if (ry)\n        resy += a[y];\n    if (lca == x)\n    {\n        y = ask(y, ry);\n        int lcay = ask(lca, k);\n        resy += (y == -1 ? 0 : s[y][k]) - (lcay == -1 ? 0 : s[lcay][k]);\n        return resy;\n    }\n    if (lca == y)\n    {\n        int lcax = ask(lca, k - D % k);\n        resx += s[x][k] - (lcax == -1 ? 0 : s[lcax][k]);\n        return resx;\n    }\n    int dx = getdis(x, lca);\n    int lcax = ask(lca, k - dx % k);\n    resx += s[x][k] - (lcax == -1 ? 0 : s[lcax][k]);\n    y = ask(y, ry);\n    int lcay = ask(lca, dx % k);\n    resy += (y == -1 ? 0 : s[y][k]) - (lcay == -1 ? 0 : s[lcay][k]);\n    return resx + resy;\n}\n\ninline void solve()\n{\n    scanf(\"%d\", &n);\n    g[0] = -1;\n    for (int i = 1; i <= n; ++i)\n        g[i] = g[i >> 1] + 1, scanf(\"%d\", &a[i]);\n    for (int i = 1; i < n; ++i)\n    {\n        int x, y;\n        scanf(\"%d%d\", &x, &y);\n        e[x].push_back(y), e[y].push_back(x);\n    }\n    dfs(1, 0);\n    dfs(1, 1, 0);\n    dfs2(1, 0);\n    for (int i = 1; i <= n; ++i)\n        scanf(\"%d\", &b[i]);\n    int uu, vv, k;\n    for (int i = 2; i <= n; ++i)\n    {\n        scanf(\"%d\", &k);\n        int ans = 0;\n        if (k >= M)\n            ans = queryBig(b[i - 1], b[i], k);\n        else\n            ans = querySmall(b[i - 1], b[i], k);\n        printf(\"%d\\n\", ans);\n    }\n}\n\nint main()\n{\n    TIME__START = clock();\n    int Test = 1;\n    // scanf(\"%d\", &Test);\n    while (Test--)\n        solve();\n    TIME__END = clock();\n    program_end();\n    return 0;\n}\n```\n",
        "postTime": 1596727098,
        "uid": 219480,
        "name": "krazy",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P3591 \u3010[POI2015]ODW\u3011"
    },
    {
        "content": "\u53d1\u73b0\u5f88\u5927\u7684\u6b65\u957f\u53ef\u4ee5\u76f4\u63a5\u6a21\u62df\uff0c\u5f88\u5c0f\u7684\u6b65\u957f\u53ef\u4ee5\u7528\u524d\u7f00\u548c\u7684\u65b9\u5f0f\u9884\u5904\u7406\uff0c\u7528sum[i][k]\u8868\u793a\u4ecei\u5f80root\u8df3\uff0c\u6b65\u957f\u4e3ak\u7684\u60c5\u51b5\u4e0b\u7684\u6743\u503c\u548c\uff0c\u5f53\u8be2\u95eex\u8df3y\u65f6\u6c42\u51falca\u3002\u663e\u7136\u8fb9\u754c\u662fn^0.5\u3002\n\n\u6ce8\u610f\u5404\u79cd\u8fb9\u754c\u60c5\u51b5\u3002\n\n```cpp\n#include <cstdio>\n#include <cmath>\n#include <algorithm>\nusing std::swap;\nconst int N = 5e4 + 10, R = sqrt(5e4) + 10, E = 1e5 + 10;\nint n, siz, val[N], b[N];\nint sum[N][R];\nint first[N], to[E], nxt[E], cnt = 0;\ninline void adde(int u, int v) {\n  to[++cnt] = v, nxt[cnt] = first[u];\n  first[u] = cnt;\n}\nint dep[N], fa[N][16], s[N], top = 0;\nvoid dfs(int u, int f) {\n  fa[u][0] = f;\n  dep[u] = dep[f] + 1;\n  s[++top] = u;\n  for (int i = 1; i <= siz; ++i) {\n    int f = dep[u] - i; if (f < 0) f = 0;\n    sum[u][i] = sum[s[f]][i] + val[u];\n  }\n  for (int p = first[u]; p; p = nxt[p]) {\n    int v = to[p]; if (v == f) continue;\n    dfs(v, u);\n  } --top;\n}\ninline int getlca(int x, int y) {\n  if (dep[x] < dep[y]) swap(x, y);\n  for (int t = 15; t >= 0; --t) if (dep[fa[x][t]] >= dep[y]) x = fa[x][t];\n  if (x == y) return x;\n  for (int t = 15; t >= 0; --t) if (fa[x][t] != fa[y][t]) x = fa[x][t], y = fa[y][t];\n  return fa[x][0];\n}\ninline int getf(int x, int len) {\n  for (int t = 15; t >= 0; --t)\n    if (len >= (1 << t))\n      x = fa[x][t], len -= (1 << t);\n  return x;\n}\nsigned main() {\n  scanf(\"%d\", &n); siz = sqrt(n);\n  for (int i = 1; i <= n; ++i) scanf(\"%d\", &val[i]);\n  for (int i = 1; i <= n - 1; ++i) {\n    int u, v; scanf(\"%d %d\", &u, &v);\n    adde(u, v), adde(v, u);\n  }\n  dfs(1, 0);\n  for (int t = 1; t <= 15; ++t)\n    for (int i = 1; i <= n; ++i)\n      fa[i][t] = fa[fa[i][t - 1]][t - 1];\n  for (int i = 1; i <= n; ++i) scanf(\"%d\", &b[i]);\n  for (int i = 1; i <= n - 1; ++i) {\n    int k, x = b[i], y = b[i + 1]; scanf(\"%d\", &k); // b[i], b[i + 1]\n    int lca = getlca(x, y); int ans = 0;\n    if (k > siz) {\n      while (dep[x] > dep[lca]) {\n        ans += val[x];\n        int f = getf(x, k);\n        if (dep[f] > dep[lca]) x = f;\n        else break;\n      }\n      ans += val[y]; y = fa[y][0];\n      if (dep[y] >= dep[lca]) {\n        int d = (dep[y] - dep[lca] + dep[x] - dep[lca]) / k;\n        for (int t = 15; t >= 0; --t)\n          if (dep[fa[y][t]] >= dep[lca] and (dep[fa[y][t]] - dep[lca] + dep[x] - dep[lca]) / k == d)\n            y = fa[y][t];\n      }\n      if ((dep[y] - dep[lca] + dep[x] - dep[lca]) % k == 0) while (dep[y] >= dep[lca]) {\n        ans += val[y];\n        y = getf(y, k);\n      }\n    }\n    else {\n      if (x != lca) {\n        int d = (dep[x] - (dep[lca] + 1)) / k;\n        int f = getf(x, d * k);\n        ans = ans + sum[x][k] - sum[f][k] + val[f];\n        x = f;\n      }\n      ans += val[y]; y = fa[y][0];\n      while (dep[y] >= dep[lca] and (dep[y] - dep[lca] + dep[x] - dep[lca]) % k != 0)\n        y = fa[y][0];\n      if (dep[y] >= dep[lca]) {\n        int d = (dep[y] - dep[lca]) / k;\n        int f = getf(y, d * k);\n        ans = ans + sum[y][k] - sum[f][k] + val[f];\n      }\n    }\n    printf(\"%d\\n\", ans);\n  }\n  return 0;\n}\n```",
        "postTime": 1571231831,
        "uid": 49474,
        "name": "\u5b66\u59d4",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P3591 \u3010[POI2015]ODW\u3011"
    }
]