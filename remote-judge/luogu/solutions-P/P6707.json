[
    {
        "content": "\u5bf9\u697c\u4e0a\u5206\u5757\u7b97\u6cd5\u7684\u4ee3\u7801\u8865\u5145\n\n\u53e6\u63d0\u4e00\u4e0b\uff0c\u4e4b\u6240\u4ee5\u4e0d\u4f1aT,\u662f\u56e0\u4e3a\u6211\u4eec\u5f53\u5757\u5927\u5c0f>2S\u65f6\u624d\u4f1a\u91cd\u6784\uff0c\u90a3\u4e48\u6700\u591a\u91cd\u6784$\\sqrt(n)$\u6b21,\u590d\u6742\u5ea6\u662f$\\sqrt(n)n$\n```cpp\n#include <bits/stdc++.h>\nusing namespace std;\n#define LL long long\n#define ls p<<1\n#define rs p<<1|1\nconst int M=2e5+5;\nint n,tot,Q,S,sz[450];//sz\uff1a\u5757\u7684\u5927\u5c0f \nLL lazy[3][450],sum[450],num[450][900],tmp[M];//lazy:\u5ef6\u8fdf\u66f4\u65b0\u6807\u8bb0 \nvoid Down(int p){ \n    if(lazy[0][p]){\n        for(int i=1;i<=sz[p];++i)num[p][i]=lazy[0][p];\n        lazy[0][p]=0;\n    }\n    if(lazy[1][p]){\n        LL &x=lazy[1][p],&y=lazy[2][p];\n        for(int i=1;i<=sz[p];++i)\n            num[p][i]+=x,x+=y;\n        x=y=0;\n    }\n}\nLL Query(int l,int r){\n    LL res=0;\n    int k=1,id=0,t=1;\n    while(k+sz[id]<=l)k+=sz[id++];\n    Down(id);\n    while(k<l)++k,++t;\n    while(t<=sz[id]&&k<=r)res+=num[id][t++],++k;\n    ++id;\n    while(k+sz[id]<=r)k+=sz[id],res+=sum[id++];\n    t=1;Down(id);\n    while(k<=r)res+=num[id][t++],++k;\n    return res;\n}\nvoid Change(int l,int r,int x){\n    int k=1,id=0,t=1;\n    while(k+sz[id]<=l)k+=sz[id++];\n    Down(id);\n    while(k<l)++k,++t;\n    while(t<=sz[id]&&k<=r)\n        sum[id]+=x-num[id][t],num[id][t++]=x,++k;\n    ++id;\n    while(k+sz[id]<=r){\n        k+=sz[id];\n        sum[id]=1ll*sz[id]*x;\n        lazy[0][id]=x;lazy[1][id]=lazy[2][id]=0;\n        id++;\n    }\n    t=1;Down(id);\n    while(k<=r){\n        sum[id]+=x-num[id][t],num[id][t++]=x,++k;\n    }\n    return ;\n}\nvoid Update(int l,int r,int x){\n    int k=1,id=0,t=1;\n    LL v=x;\n    while(k+sz[id]<=l)k+=sz[id++];\n    Down(id);\n    while(k<l)++k,++t;\n    while(t<=sz[id]&&k<=r)\n        sum[id]+=v,num[id][t++]+=v,++k,v+=x;\n    ++id;\n    while(k+sz[id]<=r){\n        k+=sz[id];\n        sum[id]+=(v+v+(1ll*sz[id]-1)*x)*sz[id]/2;\n        lazy[1][id]+=v;lazy[2][id]+=x;\n        v+=1ll*sz[id]*x;id++;\n    }\n    t=1;Down(id);\n    while(k<=r){\n        sum[id]+=v,num[id][t++]+=v,++k,v+=x;\n    }\n    return ;\n}\nvoid Rebuild(){//\u5757\u91cd\u6784 \n    tot=0;\n    for(int i=0;sz[i];++i){\n        Down(i);\n        for(int j=1;j<=sz[i];++j)\n        tmp[++tot]=num[i][j];\n        sz[i]=sum[i]=0;\n    }\n    S=max(2,(int)sqrt(tot));\n    for(int i=1;i<=tot;++i){\n        int id=i/S;\n        sum[id]+=tmp[i];\n        num[id][++sz[id]]=tmp[i];\n    }\n}\nvoid Insert(int x,int y){\n    int k=1,id=0,t=1;\n    while(sz[id]&&k+sz[id]<=x)k+=sz[id++];\n    Down(id);\n    while(k<x)++k,++t;\n    for(int i=sz[id];i>=t;--i)num[id][i+1]=num[id][i];\n    num[id][t]=y,sum[id]+=y,++sz[id];\n    if(sz[id]>2*S)Rebuild(); //\u5f53\u5757\u7684\u5927\u5c0f\u8d85\u51fa2S\u7684\u65f6\u5019\u5c06\u6240\u6709\u5757\u91cd\u6784 \n}\nint main(){\n    int x,y,z,kind;\n    scanf(\"%d%d\",&n,&Q);\n    int S=max(2,(int)sqrt(n));\n    for(int i=1;i<=n;++i){\n        scanf(\"%d\",&x);\n        int id=i/S;\n        num[id][++sz[id]]=x;\n        sum[id]+=x;\n    }\n    while(Q--){\n        scanf(\"%d%d%d\",&kind,&x,&y);\n        if(kind==1){\n            scanf(\"%d\",&z);\n            Change(x,y,z);\n        }\n        else if(kind==2){\n            scanf(\"%d\",&z);\n            Update(x,y,z);\n        }   \n        else if(kind==3)\n            Insert(x,y);\n         \n        else\n            printf(\"%lld\\n\",Query(x,y));    \n    }\n    return 0;\n}\n```\n",
        "postTime": 1601302960,
        "uid": 89551,
        "name": "\u72c2\u62fd\u9177\u70ab\u540a",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P6707 \u3010[COCI2010-2011#7] UPIT\u3011\u7ec8\u6781\u6570\u636e\u7ed3\u6784"
    },
    {
        "content": "\u4e00\u8840\u3002\n\n------------\n\n### \u63d0\u4f9b\u4e24\u79cd\u505a\u6cd5\uff1a\n\n#### \u5206\u5757\uff1a\n\n\u533a\u95f4\u52a0\u6cd5\u540c[P1438](https://www.luogu.com.cn/problem/P1438)\uff0c\u7ef4\u62a4\u4e00\u4e2a\u9996\u9879\u548c\u4e00\u4e2a\u516c\u5dee tag\uff0c\u4e0d\u96be\u53d1\u73b0\u9996\u9879\u548c\u516c\u5dee\u662f\u80fd\u76f8\u52a0\u7684\u3002\n\n\u533a\u95f4\u8d4b\u503c\u5c31\u5bf9\u6bcf\u4e2a\u5757\u7ef4\u62a4\u4e24\u4e2a tag\uff0c\u5206\u522b\u8868\u793a\u8fd9\u4e2a\u533a\u95f4\u6709\u6ca1\u6709\u88ab\u8d4b\u503c\uff0c\u8d4b\u503c\u7684\u6570\u662f\u591a\u5c11\uff0c\u6ce8\u610f\u8d4b\u503c\u4f18\u5148\u7ea7\u6bd4\u52a0\u6cd5\u7684\u9ad8\u3002\n\n\u63d2\u5165\u53ef\u4ee5\u76f4\u63a5\u66b4\u529b\u63d2\u5165\uff0c\u7136\u540e\u5982\u679c\u8fd9\u4e2a\u5757\u5927\u5c0f\u592a\u5927\uff0c\u5c31\u628a\u5b83\u62c6\u6210\u4e24\u4e2a\uff0c\u5177\u4f53\u5b9e\u73b0\u53ef\u4ee5\u7528 vector\u3002~~\u4ee3\u7801\u5495\u5495\u4e86\u3002~~\n\n#### \u5e73\u8861\u6811\uff1a\n\n\u52a0\u6cd5\u3001\u8d4b\u503c\u540c\u5206\u5757\u505a\u6cd5\uff0c\u63d2\u5165\u7684\u65f6\u5019\u6ce8\u610f\u7ef4\u62a4\u5e73\u8861\u5373\u53ef\u3002\n\n\u6ce8\u610f\uff1a\u5e73\u8861\u6811\u505a\u6cd5\u8981\u6ce8\u610f\u8d8a\u754c\u7684\u60c5\u51b5\uff0c\u6240\u4ee5\u521d\u59cb\u7684\u5efa\u6811\u8303\u56f4\u662f $1$ \u5230 $n+2$\uff0c\u8bfb\u5165\u65f6\u662f $2$ \u5230 $n+1$\uff1b\u6570\u7ec4\u4e00\u5b9a\u8981\u5f00\u5927\uff0c\u6240\u6709\u5173\u4e8e\u6570\u503c\u7684\u4e00\u5b9a\u8981\u5f00`long long`\u3002\n\n\u5e73\u8861\u6811\u4ee3\u7801\uff1a\n\n```cpp\n#include<bits/stdc++.h>\n#define ll long long\n#define N 500005\nusing namespace std;\nint n,q,cnt,tg1,tg2;//cnt\u662f\u8282\u70b9\u4e2a\u6570\uff0ctg1\u662f\u8be2\u95ee\u4e2dl\u5728\u6811\u4e0a\u7684\u4f4d\u7f6e\uff0ctg2\u662f\u8be2\u95ee\u4e2dr\u5728\u6811\u4e0a\u7684\u4f4d\u7f6e \nint rt,son[N][2],fa[N];\n/*\ntag0:\u662f\u5426\u8d4b\u503c\ntag1:\u8d4b\u503c\u4e86\u591a\u5c11\ntag2:\u9996\u9879\ntag3:\u516c\u5dee \n*/\nll a[N],sum[N],tag[N][5],si[N];\ninline void pushup(int o){\n\tint l = son[o][0],r = son[o][1];\n\tsi[o] = si[l]+si[r]+1;\n\tsum[o] = sum[l]+sum[r]+a[o];\n}\n\ninline void rotate(int o,int &k){\n\tint f1 = fa[o],f2 = fa[f1],l = (son[f1][1]==o),r = l^1;\n\tif(f1 != k) son[f2][son[f2][1] == f1] = o;\n\telse k = o;\n\tfa[o] = f2,fa[f1] = o,fa[son[o][r]] = f1;\n\tson[f1][l] = son[o][r],son[o][r] = f1;\n    pushup(f1),pushup(o);\n}\n\ninline void splay(int o,int &k){\n\twhile(o != k){\n        int f1 = fa[o],f2 = fa[f1];\n        if(f1 != k){\n            if((son[f2][0]==f1) != (son[f1][0]==o)) rotate(o,k);\n\t\t\telse rotate(f1,k);\n        }\n        rotate(o,k);\n    }\n}\n\ninline void cover(int o,ll k){\n\tsum[o] = si[o]*k;\n\ta[o] = k;\n\ttag[o][0] = 1,tag[o][1] = k,tag[o][2] = tag[o][3] = 0;\n}\n\ninline void add(int o,ll k1,ll k2){\n\tint l = son[o][0],r = son[o][1];\n\ta[o] += k1+si[l]*k2;\n\tsum[o] += si[o]*k1+(si[o]-1)*si[o]/(1ll*2)*k2;//\u5957\u7528\u516c\u5f0fsum = n*(n+1)/2\uff0c\u8fd9\u91cc\u5355\u72ec\u63d0\u51fa\u9996\u9879 \n\ttag[o][2] += k1,tag[o][3] += k2;\n}\n\ninline void push_down(int o){\n\tint l = son[o][0],r = son[o][1];\n\tif(tag[o][0]){//\u5148\u8fdb\u884c\u8d4b\u503c\uff0c\u518d\u8fdb\u884c\u52a0\u51cf \n\t\tcover(l,tag[o][1]),cover(r,tag[o][1]);\n\t\ttag[o][0] = 0;\n\t}\n\tif(tag[o][2] || tag[o][3]){\n\t\tadd(l,tag[o][2],tag[o][3]),add(r,tag[o][2]+(si[l]+1)*tag[o][3],tag[o][3]);\n\t\ttag[o][2] = tag[o][3] = 0;\n\t}\n}\n\ninline int gettp(int o,int k){//\u627e\u5230o\u7684\u4f4d\u7f6e \n\tpush_down(o);\n\tint l = son[o][0],r = son[o][1];\n\tif(si[l]+1 == k) return o;\n\telse if(si[l] >= k) return gettp(l,k);\n\treturn gettp(r,k-si[l]-1);\n}\n\ninline void split(int l,int r){\n\ttg1 = gettp(rt,l),tg2 = gettp(rt,r);\n\tsplay(tg1,rt),splay(tg2,son[tg1][1]);\n}\n\ninline void build(int l,int r,int f){\n\tif(l>r) return ;\n\tint mid = l+r>>1;\n\tfa[mid] = f,son[f][mid>f] = mid;\n\tif(l == r){\n\t\tsi[mid] = 1,sum[mid] = a[mid];\n\t\treturn ;\n\t}\n\tbuild(l,mid-1,mid),build(mid+1,r,mid);\n\tpushup(mid);\n}\nint main(){\n\tscanf(\"%d%d\",&n,&q);\n\tfor(int i = 2;i<=n+1;++i) scanf(\"%lld\",a+i);\n\tcnt = n+2,rt = (n+3)>>1;\n\tbuild(1,n+2,0);\n\tint opt,l,r,tp;\n\tll k;\n\twhile(q--){\n\t\tscanf(\"%d\",&opt);\n\t\tif(opt == 3){\n\t\t\tscanf(\"%d%lld\",&tp,&k);\n\t\t\tsplit(tp,tp+1);\n\t\t\tfa[son[tg2][0] = ++cnt] = tg2;\n\t\t\tsum[cnt] = a[cnt] = k,si[cnt] = 1;\n\t\t}else{\n\t\t\tscanf(\"%d%d\",&l,&r);\n\t\t\tsplit(l,r+2);\n\t\t\tif(opt == 1) scanf(\"%lld\",&k),cover(son[tg2][0],k);\n\t\t\telse if(opt == 2) scanf(\"%lld\",&k),add(son[tg2][0],k,k);\n\t\t\telse printf(\"%lld\\n\",sum[son[tg2][0]]);\n\t\t}\n\t\tpushup(tg2),pushup(tg1);\n\t}\n\treturn 0;\n}\n```\n",
        "postTime": 1597709596,
        "uid": 114173,
        "name": "Computer1828",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P6707 \u3010[COCI2010-2011#7] UPIT\u3011"
    },
    {
        "content": "\u9898\u89e3\u505a\u6cd5\uff1a\u5757\u72b6\u94fe\u8868\u3002\n\n\u82e5\u53ea\u6709 1\u30012\u30014 \u64cd\u4f5c\uff0c\u5373\u9898\u76ee [P1438 \u65e0\u804a\u7684\u6570\u5217](https://www.luogu.com.cn/problem/P1438)\uff0c\u53ef\u4ee5\u7528\u7ebf\u6bb5\u6811 + \u5dee\u5206\u8f7b\u677e\u7ef4\u62a4\uff0c\u4e5f\u53ef\u4ee5\u7528\u5206\u5757\u5b9e\u73b0\uff0c\u8fd9\u4e24\u79cd\u505a\u6cd5\u90fd\u662f\u5728\u7ebf\u7684\u3002\n\n\u65b0\u589e\u4e00\u4e2a 3 \u64cd\u4f5c\uff0c\u7528\u7ebf\u6bb5\u6811\u96be\u4ee5\u5728\u7ebf\u5b9e\u73b0\u63d2\u5165\u64cd\u4f5c\uff0c\u53ea\u80fd\u79bb\u7ebf\u5b9e\u73b0\u3002\u5982\u679c\u5f3a\u5236\u5728\u7ebf\u5462\uff1f\u6211\u4eec\u8003\u8651\u7528\u5206\u5757\u6765\u5b9e\u73b0\u3002\n\n\u64cd\u4f5c 1\uff1a\u533a\u95f4\u8d4b\u503c\u3002\n\n\u6563\u5757\u66b4\u529b\u4fee\u6539\uff0c\u6574\u5757\u7528\u4e00\u4e2a\u6570\u7ec4 `change` \u8bb0\u6539\u6210\u4e86\u5565\u3002\u7531\u4e8e\u662f\u8d4b\u503c\uff0c\u6211\u4eec\u5c06\u5176\u4ed6\u6574\u5757\u4e0a\u7684\u76f8\u5173\u4fe1\u606f\u6e05\u7a7a\uff0c\u5982\u533a\u95f4\u52a0\u7684\u6807\u8bb0\u7b49\uff0c\u5e76\u4e14\u66f4\u65b0\u533a\u95f4\u548c `sum[i]=siz[i]*c`\u3002\u6ce8\u610f\u5728\u6bcf\u6b21\u6563\u5757\u8d4b\u503c\u524d\uff0c\u8981\u7c7b\u4f3c\u7ebf\u6bb5\u6811\u7684 `pushdown`\uff0c\u5c06\u6807\u8bb0\u4e0b\u653e\uff0c\u5373\u628a\u6563\u5757\u6240\u6709\u5143\u7d20\u7684\u503c\u901a\u8fc7\u6807\u8bb0\u66f4\u65b0\u3002\n\n\u64cd\u4f5c 2\uff1a\u533a\u95f4\u52a0\u7b49\u5dee\u6570\u5217\u3002\n\n\u8fd9\u4e2a\u7b49\u5dee\u6570\u5217\u6bd4\u8f83\u7279\u522b\uff0c\u5b83\u7684\u9996\u9879\u7b49\u4e8e\u516c\u5dee\u3002\u5982\u679c\u6709\u4e2a\u6574\u5757\u4e00\u76f4\u662f\u8fdb\u884c\u64cd\u4f5c 1 \u548c 2 \u7684\uff0c\u90a3\u4e48\u6574\u5757\u4e2d\u7684\u76f8\u90bb\u4e24\u4e2a\u5143\u7d20\u5dee\u662f\u56fa\u5b9a\u7684\uff0c\u5373\u6700\u540e\u4e00\u6b21\u64cd\u4f5c 1 \u540e\u7684\u6240\u6709\u64cd\u4f5c 2 \u5bf9\u5e94\u7684\u516c\u5dee\u4e4b\u548c\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u8bb0\u4e0b\u516c\u5dee\u4e4b\u548c\uff0c\u4ee5\u53ca\u6574\u5757\u4e2d\u7b2c\u4e00\u4e2a\u5143\u7d20\u503c\u7684\u589e\u91cf\u3002\n\n\u64cd\u4f5c 3\uff1a\u5355\u70b9\u63d2\u5165\u3002\n\n\u627e\u5230\u63d2\u5165\u70b9\u5bf9\u5e94\u7684\u5757\uff0c\u5982\u679c\u63d2\u5165\u70b9\u7b49\u4e8e\u5f53\u524d\u5e8f\u5217\u957f\u5ea6 +1\uff0c\u5219\u5f52\u4e3a\u6700\u540e\u4e00\u5757\u3002\u7c7b\u4f3c\u66b4\u529b\uff0c\u5c06\u63d2\u5165\u70b9\u540e\u6240\u6709\u5143\u7d20\u5168\u90e8\u540e\u79fb\uff0c\u7136\u540e\u586b\u4e0a\u63d2\u5165\u7684\u5143\u7d20\u3002\u7528 vector \u53ef\u4ee5\u5b9e\u73b0\uff0c\u4f46\u5e38\u6570\u8f83\u5927\u3002\u6b63\u56e0\u8fd9\u4e00\u90e8\u5206\uff0c\u6211\u4f7f\u7528\u4e86\u5757\u72b6\u94fe\u8868\u3002\n\n\u6ce8\u610f\u63d2\u5165\u70b9\u540e\u6240\u6709\u5143\u7d20\u5168\u90e8\u540e\u79fb\u53ea\u80fd\u5728\u8be5\u5757\u5185\u5b9e\u73b0\uff0c\u82e5\u5168\u90e8\u66f4\u65b0\u590d\u6742\u5ea6\u65e0\u6cd5\u63a5\u53d7\u3002\u56e0\u6b64\u6211\u4eec\u5bf9\u94fe\u8868\u4e0a\u6bcf\u4e2a\u5143\u7d20\u8bb0\u5f55\u5b83\u7684\u539f\u7f16\u53f7\uff08\u5373\u6309\u8f93\u5165\u4ee5\u53ca\u63d2\u5165\u987a\u5e8f\uff09\uff0c\u5e76\u8bb0\u5f55\u5b83\u5728\u5f53\u524d\u5757\u4e2d\u7684\u6392\u540d\uff08\u4ece\u524d\u5f80\u540e\u6570\u7b2c\u51e0\u4e2a\uff09\uff0c\u5728\u8fdb\u884c\u64cd\u4f5c\u65f6\u76f4\u63a5\u904d\u5386\u5f53\u524d\u5757\u5bf9\u5e94\u94fe\u8868\uff0c\u5c06\u7b26\u5408\u4fee\u6539\u76ee\u7684\u7684\u5143\u7d20\u8fdb\u884c\u4fee\u6539\u5373\u53ef\u3002\n\n\u8003\u8651\u6781\u7aef\u60c5\u51b5\uff1a\u51e0\u4e4e\u6240\u6709\u63d2\u5165\u5168\u90e8\u63d2\u5165\u5728\u540c\u4e00\u70b9\uff0c\u90a3\u4e48\u5355\u5757\u6700\u957f\u53ef\u8fbe $\\text{block}+m$\u3002\u82e5\u6240\u6709\u67e5\u8be2\u90fd\u662f\u6c42\u5e8f\u5217\u5143\u7d20\u603b\u548c\uff0c\u5219\u7edf\u8ba1\u4e0a\u8ff0\u60c5\u51b5\u5757\u65f6\u7684\u590d\u6742\u5ea6\u4e0d\u518d\u4e3a $O(\\text{block})$\uff0c\u800c\u662f\u8fbe\u5230\u4e86 $O(\\text{block}+m)$\u3002\u4e0a\u8ff0\u4e24\u79cd\u6781\u7aef\u64cd\u4f5c\u5747\u5300\u51fa\u73b0\uff0c\u5ffd\u7565\u5e38\u6570\uff0c\u5219\u603b\u590d\u6742\u5ea6\u6700\u9ad8\u53ef\u8fbe $O\\big((\\text{block}+m)^2\\big)$\uff0c\u65e0\u6cd5\u627f\u53d7\u3002\u56e0\u6b64\u5f53\u5b58\u5728\u4e00\u4e2a\u6574\u5757\u5927\u5c0f\u8d85\u8fc7 $2\\times \\text{block}$ \u65f6\uff0c\u6211\u4eec\u9700\u8981\u91cd\u6784\uff0c\u90a3\u4e48\u6700\u591a\u91cd\u6784 $m/\\text{block}$ \u6b21\u3002\n\n\u6ce8\u610f\uff1a\u63d2\u5165\u524d\u9700\u8981\u4e0b\u4f20\u6807\u8bb0\uff0c\u63d2\u5165\u540e\u82e5\u91cd\u6784\uff0c\u9700\u8981\u91cd\u65b0\u7edf\u8ba1\u6bcf\u5757\u5927\u5c0f\u3002\n\n\u64cd\u4f5c 4\uff1a\u533a\u95f4\u6c42\u548c\u3002\n\n\u8fd9\u4e2a\u64cd\u4f5c\u5c31\u975e\u5e38 naive \u4e86\uff0c\u4ecd\u9700\u6ce8\u610f\u7684\u662f\u7edf\u8ba1\u524d\u4e0b\u4f20\u6807\u8bb0\u3002\n\n\u8ba4\u4e3a $n$ \u548c $m$ \u540c\u9636\uff0c\u53d6 $\\text{block}=\\sqrt{n+m}$ \u5de6\u53f3\u65f6\uff0c\u603b\u65f6\u95f4\u590d\u6742\u5ea6\u7ea6\u4e3a $O(n\\sqrt{n})$\u3002\n\n\u5982\u679c\u60a8\u901a\u8fc7\u4e0a\u8ff0\u6587\u5b57\u5c1a\u65e0\u6cd5\u7406\u89e3\u6216\u4e0d\u6e05\u695a\u5982\u4f55\u5b9e\u73b0\uff0c\u53ef\u4ee5\u70b9\u51fb\u4e0b\u9762\u94fe\u63a5\u5177\u4f53\u4e86\u89e3\u3002\n\n[\u5177\u4f53\u4ee3\u7801\u5b9e\u73b0\u53ca\u5168\u89e3\u91ca](https://www.luogu.com.cn/paste/tpvdesxj)\n\n\u5176\u4e2d\u5c55\u793a\u7684\u4ee3\u7801\u4f7f\u7528\u8bed\u8a00 C++14 \u63d0\u4ea4\uff0c\u53ef\u4ee5\u5728\u4e0d\u5f00\u542f O2 \u4f18\u5316\u7684\u60c5\u51b5\u4e0b\u901a\u8fc7\u3002",
        "postTime": 1630071107,
        "uid": 338630,
        "name": "Silence_water",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P6707"
    },
    {
        "content": "### **\u9898\u5916\u8bdd\uff1a\u6b64\u9898\u5efa\u8bae\u8bc4\u7d2b\uff01\uff01\uff01**  \n\n------------\n\n\u7ed9\u4e00\u4e2a\u5206\u5757\u505a\u6cd5\u5427\uff0c\u867d\u7136\u662f\u4e00\u9053\u5f88\u597d\u7684 Splay \u7684\u7ec3\u4e60\u9898\uff0c\u4f46\u662f\u6211\u8fd8\u662f\u8981\u7528\u5206\u5757\u6765\u505a  \n\u4e00\u4e2a\u64cd\u4f5c\u4e00\u4e2a\u64cd\u4f5c\u7684\u8003\u8651\u5427\uff0c\u8fd9\u79cd\u591a\u64cd\u4f5c\u7684\u9898\uff0c\u4e00\u5b9a\u8981\u628a\u6bcf\u4e00\u4e2a\u64cd\u4f5c\u5206\u6790\u6e05\u695a\uff0c\u60f3\u597d\u600e\u4e48\u5904\u7406\u518d\u6765\u7801  \n### \u7b2c\u4e00\u4e2a\u64cd\u4f5c  \n\u533a\u95f4\u8d4b\u503c\u561b\uff0c\u5206\u5757\u7684\u57fa\u672c\u64cd\u4f5c\u4e86\uff0c\u867d\u7136\u53ef\u4ee5\u7528 ODT \u8fd9\u4e2a\u67ef\u7231\u7684\u6570\u636e\u7ed3\u6784\uff0c\u4f46\u8fd8\u662f\u7528\u5206\u5757\u7684\u5e38\u89c4\u64cd\u4f5c\u5427\uff0c\u4f7f\u7528\u4e00\u4e2a Lazy1 \u6807\u8bb0\u6765\u8bb0\u5f55\u6574\u4e2a\u5757\u7684\u4e00\u64cd\u4f5c\u8d4b\u503c\uff0c\u5982\u679c\u662f\u6563\u5757\u7684\u5c31\u76f4\u63a5\u66b4\u529b\u8d4b\u503c\u5566\uff0c\u65f6\u95f4 $O(\\log n)$   \n### \u7b2c\u4e8c\u4e2a\u64cd\u4f5c  \n\u4e5f\u662f\u6700\u96be\u7684\u4e00\u4e2a\u64cd\u4f5c\uff0c\u5982\u679c\u60f3\u5355\u72ec\u7ec3\u4e60\u8fd9\u4e2a\u64cd\u4f5c\u7684\u53ef\u4ee5\u53bb\u505a [P1438 \u65e0\u804a\u7684\u6570\u5217](https://www.luogu.com.cn/problem/P1438)  \u662f\u4e00\u4e2a\u4e0d\u9519\u7684\u9898\u76ee  \n\u7136\u540e\u56de\u5230\u672c\u9898\uff0c\u6211\u662f\u7528\u4e86\u4e24\u4e2a Lazy \u6570\u7ec4 Lazy2 \u548c Lazy3 \u4e00\u4e2a\u7528\u6765\u8bb0\u5f55\u533a\u95f4\u8981\u52a0\u7684\u6570\uff0c\u7136\u540e\u4e00\u4e2a\u7528\u6765\u7ef4\u62a4\u7b49\u5dee\u6570\u5217\u7684\u516c\u5dee\uff0c\u4e3a\u4ec0\u4e48\u8981\u8fd9\u4e48\u5e72\u5462\uff0c\u5982\u679c\u53ea\u7528\u4e00\u4e2a\u6807\u8bb0\uff0c\u65e0\u6cd5\u8bb0\u5f55\u6bcf\u4e2a\u5757\u8981\u5177\u4f53\u589e\u52a0\u7684\u503c\uff0c\u6240\u4ee5\u7528\u4e24\u4e2a\u6807\u8bb0\u6765\u5904\u7406\u7b49\u5dee  \n\u5bf9\u4e8e\u6bcf\u4e00\u6b21 pushdown \u64cd\u4f5c\uff0c\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u5757\uff0c\u4ece\u7b2c\u4e00\u4e2a\u5f00\u59cb\uff0c\u6bcf\u4e00\u6b21\u8fd9\u4e2a\u6570\u52a0\u4e00\u4e2a Lazy2 \u7136\u540e\u4e0b\u4e00\u4e2a\u6570\u5c31\u8981\u518d\u52a0\u4e0a\u4e00\u4e2a\u516c\u5dee  \n\u5bf9\u4e8e\u6bcf\u4e00\u4e2a\u6563\u5757\u5c31\u76f4\u63a5\u66b4\u529b\u52a0\uff0c\u7136\u540e\u6539\u53d8 Lazy2 \u548c Lazy3 \uff0c\u7b49\u5dee\u6570\u5217\u5e94\u8be5\u90fd\u4f1a\u5427....\u5c31\u4e0d\u7ec6\u8bb2\u4e86\uff0c\u5177\u4f53\u7684\u53ef\u4ee5\u518d\u4ee3\u7801\u91cc\u770b  \n### \u7b2c\u4e09\u4e2a\u64cd\u4f5c   \n\u4e00\u4e2a\u5f71\u54cd\u8fd9\u4e2a\u9898\u6027\u8d28\u7684\u64cd\u4f5c\uff0c\u5982\u679c\u6ca1\u6709\u63d2\u5165\u8fd9\u4e2a\u6570\uff0c\u90a3\u4e48\u8fd9\u4e2a\u9898 80 \u6765\u884c\u5c31\u53ef\u4ee5\u5199\u5b8c\u4e86\uff0c\u4f46\u662f\u6709\u4e86\u8fd9\u4e2a\u64cd\u4f5c\uff0c\u6211\u4eec\u5c31\u8981\u7528 vector \u554a\u5176\u5b9e\u4e5f\u6ca1\u6709\u5565\u5f71\u54cd\uff0c\u8fd9\u4e2a\u64cd\u4f5c\u4e5f\u7b97\u57fa\u7840\u9898\u4e86\uff0c\u6240\u4ee5\u4e5f\u4e0d\u7ec6\u8bb2  \n### \u7b2c\u56db\u4e2a\u64cd\u4f5c   \n\u6700\u7b80\u5355\u7684\u64cd\u4f5c\uff0c\u5e94\u8be5\u5b66\u4e86\u98de\u5feb\u7684\u4eba\u90fd\u4f1a\uff0c\u6ca1\u5565\u597d\u8bf4\u7684  \n\u6700\u540e\u6b64\u9898\u6bd4\u8f83\u6ce8\u91cd\u7ec6\u8282\uff0c\u6240\u4ee5\u5927\u5bb6\u614e\u91cd\u4e00\u70b9\u5199\u5427\uff0c\u7136\u540e\u9644\u4e0a\u4ee3\u7801qwq  \n```\n#include<iostream>\n#include<cstdio>\n#include<algorithm>\n#include<vector>\n#include<cmath>\n#define ll long long\nusing namespace std;\nconst int N=300010,K=600;\nint n,m,g;\nstruct MS{int st,en;}q[K];\nbool V[K];\nll a[N],sum[K];\nvector<ll>v[K];\nll tmp[N];\nll lazy1[K],lazy2[K],lazy3[K];\n\nvoid pushdown(int p)\n{\n\tif(lazy1[p])\n\t{\n\t\tfor(int i=0;i<v[p].size();i++)\n\t\t\tv[p][i]=lazy1[p];\n\t\tlazy1[p]=0;\n\t}\n\tif(lazy2[p])\n\t{\n\t\tfor(int i=0;i<v[p].size();i++)\n\t\t{\n\t\t\tv[p][i]+=lazy2[p];\n\t\t\tlazy2[p]+=lazy3[p];\n\t\t}\n\t\tlazy2[p]=lazy3[p]=0;\n\t}\n}\n\nvoid duliu1(int l,int r,ll d)\n{\n\tint now=1,id=0,t=0;\n\twhile(now+v[id].size()<=l)now+=v[id++].size();\n\tpushdown(id);\n\t\n\twhile(now<l)now++,t++;\n\t//int t=l-now;\n\t//now=l;\n\t//cout<<t<<endl;\n\t//cout<<id<<endl;\n\tfor(;t<v[id].size()&&now<=r;now++,t++)\n\t{\n\t\tsum[id]-=v[id][t]-d;\n\t\tv[id][t]=d;\n\t}\n\tid++;\n\twhile(now+v[id].size()<=r)\n\t{\n\t\tnow+=v[id].size();\n\t\tsum[id]=d*v[id].size();\n\t\tlazy1[id]=d;\n\t\tlazy2[id]=lazy3[id]=0;\n\t\tid++;\n\t}\n\t//cout<<id<<endl;\n\tt=0;\n\tpushdown(id);\n\tfor(;now<=r;now++,t++)\n\t{\n\t\tsum[id]+=d-v[id][t];\n\t\tv[id][t]=d;\t\n\t\t//cout<<id<<\" \"<<t<<endl;\t\n\t}\n}\n\nvoid duliu2(int l,int r,ll x)\n{\n\tint now=1,id=0,t=0;\n\tll d=x;\n\twhile(now+v[id].size()<=l)now+=v[id++].size();\n\tpushdown(id);\n\t\n\twhile(now<l)now++,t++;\n\t\n\tfor(;t<v[id].size()&&now<=r;now++,t++,d+=x)\n\t{\n\t\tsum[id]+=d;\n\t\tv[id][t]+=d;\n\t}\n\tid++;\n\twhile(now+v[id].size()<=r)\n\t{\n\t\tnow+=v[id].size();\n\t\tsum[id]+=(d+(d+(1ll*v[id].size()-1)*x))*v[id].size()/2;\n\t\tlazy2[id]+=d;\n\t\tlazy3[id]+=x;\n\t\td+=1ll*v[id].size()*x;\n\t\tid++;\n\t}\n\tt=0;\n\tpushdown(id);\n\tfor(;now<=r;now++,d+=x,t++)\n\t{\n\t\tsum[id]+=d;\n\t\tv[id][t]+=d;\t\t\n\t}\n}\n\nvoid build()\n{\n\tint tot=0;\n\tfor(int i=0;v[i].size();i++)\n\t{\n\t\tpushdown(i);\n\t\tfor(int j=0;j<v[i].size();j++)\n\t\t\ttmp[++tot]=v[i][j];\n\t\tv[i].clear();\n\t\tsum[i]=0;\n\t}\n\tg=sqrt(tot);\n\tfor(int i=1;i<=tot;i++)\n\t{\n\t\tint id=i/g;\n\t\tsum[id]+=tmp[i];\n\t\tv[id].push_back(tmp[i]);\n\t}\n}\n\nvoid duliu3(int x,ll y)\n{\n\tint now=1,id=0,t=0;\n\twhile(v[id].size()&&now+v[id].size()<=x)now+=v[id++].size();\n\tpushdown(id);\n\t\n\twhile(now<x)now++,t++;\n\tv[id].push_back(y);\n\tsum[id]+=y;\n\tfor(int i=v[id].size()-2;i>=t;i--)swap(v[id][i+1],v[id][i]);\n\tif(v[id].size()>2*g)build();\n}\n\nll duliu4(int l,int r)\n{\n\tll ans=0;\n\tint now=1,id=0,t=0;\n\twhile(now+v[id].size()<=l)now+=v[id++].size();\n\tpushdown(id);\n\twhile(now<l)now++,t++;\n\tfor(;t<v[id].size()&&now<=r;t++,now++)\n\t\tans+=v[id][t];\n\t//cout<<ans<<endl;\n\tid++;\n\twhile(now+v[id].size()<=r)now+=v[id].size(),ans+=sum[id++];\n\tt=0;\n\tpushdown(id);\n\tfor(;now<=r;t++,now++)ans+=v[id][t];\n\treturn ans;\n}\n\nint main()\n{\n\tscanf(\"%d%d\",&n,&m);g=sqrt(n);\n\tif(g<2)g=2;\n\tfor(int i=1;i<=n;i++)scanf(\"%lld\",&a[i]);\n\tfor(int i=1;i<=n;i++)\n\t{\n\t\tint id=i/g;\n\t\t//cout<<id<<\" \";\n\t\tv[id].push_back(a[i]);\n\t\tsum[id]+=a[i];\n\t}\n\tfor(int i=1;i<=m;i++)\n\t{\n\t\tint op,l;\n\t\tll r,d;\n\t\tscanf(\"%d%d%lld\",&op,&l,&r);\n\t//\tcout<<v[1][1]<<\" \"<<v[2][0]<<endl;\n\t\tif(op==1)\n\t\t{\n\t\t\tscanf(\"%lld\",&d);\n\t\t\tduliu1(l,r,d);\n\t\t}\n\t\t//cout<<v[1][1]<<\" \"<<v[2][0]<<endl;\n\t\tif(op==2)\n\t\t{\n\t\t\tscanf(\"%lld\",&d);\n\t\t\tduliu2(l,r,d);\n\t\t}\n\t\tif(op==3)duliu3(l,r);\n\t\tif(op==4)printf(\"%lld\\n\",duliu4(l,r));\n\t}\n    return 0;\n}\n/*\n5 2\n1 2 3 4 5\n1 1 5 0\n4 1 5\n\n*/\n```\n",
        "postTime": 1626773126,
        "uid": 247269,
        "name": "MSqwq",
        "ccfLevel": 0,
        "title": "P6707 [COCI2010-2011#7] UPIT"
    },
    {
        "content": "## [COCI2010-2011#7] UPIT \u5206\u5757\n\n\u9898\u76ee\u94fe\u63a5\uff1a[COCI2010-2011#7](https://www.luogu.com.cn/problem/P6707)\n\n---\n\n\u200b\t\u6bd4\u8f83\u5e38\u89c4\u7684\u5206\u5757\u7ef4\u62a4\u4fe1\u606f\u7684\u9898\u76ee\u3002\n\n\u200b\t\u5bf9\u4e8e\u64cd\u4f5c\u4e00\uff0c\u7b80\u5355\u7684\u533a\u95f4\u8986\u76d6\u3002\n\n\u200b\t\u5bf9\u4e8e\u64cd\u4f5c\u4e8c\u3002\u6563\u5757\u7684\u8bdd\u66b4\u529b\u4fee\u6539\u3002\u6574\u5757\u4e2d\u589e\u52a0\u7684\u503c\u6784\u6210\u4e00\u4e2a\u7b49\u5dee\u6570\u5217\uff0c\u6240\u4ee5\u6574\u5757\u533a\u95f4\u548c\u53ef\u4ee5\u901a\u8fc7\u7b49\u5dee\u6570\u5217\u516c\u5f0f\u8fdb\u884c\u7ef4\u62a4\u3002\u7136\u540e\u518d\u5f00\u4e24\u4e2a\u6570\u7ec4\u8bb0\u5f55\u8fd9\u5757\u5de6\u7aef\u70b9\u589e\u52a0\u7684\u503c\u548c\u7b49\u5dee\u6570\u5217\u7684\u5dee\u503c\uff0c\u8fd9\u6837\u6211\u4eec\u5982\u679c\u67e5\u8be2\u6563\u5757\u65f6\u4e0b\u4f20\u6807\u8bb0\u53ef\u4ee5\u7528\u8fd9\u4e24\u4e2a\u6570\u7ec4\u66f4\u65b0\u3002\n\n\u200b\t\u5bf9\u4e8e\u64cd\u4f5c\u4e8c\u7684\u6574\u5757\u4fee\u6539\u53ca\u4e0b\u4f20\u6807\u8bb0\u7684\u5c40\u90e8\u4ee3\u7801\u5982\u4e0b\uff1a\n\n```cpp\nvoid remake(int k)\n{\n\tll d=num[k];\n\tfor(Re int i=0;i<vec[k].size();++i)\n\t{\n\t\tif(tag[k]) vec[k][i]=tag[k];//\u4eba\u4e3a\u89c4\u5b9a\u8986\u76d6\u7684\u6807\u8bb0\u4f18\u5148\u7ea7\u8f83\u5927\uff0c\u7c7b\u4f3c\u4e8e\u4e58\u6cd5\u6807\u8bb0\u548c\u52a0\u6cd5\u6807\u8bb0\u7684\u5173\u7cfb\u3002\n\t\tvec[k][i]+=d;\n\t\td+=add[k];\n\t}\n\tadd[k]=num[k]=tag[k]=0;\n}\n//---\u5206\u5272\u7ebf---\n//\u4e0b\u9762\u662f\u4e00\u4e2a\u4e0d\u5b8c\u6574\u7684\u51fd\u6570\uff0c\u7528\u6765\u66f4\u65b0\u6574\u5757\nfor(Re int i=le+1;i<ri;++i)\n\t{\n\t\tadd[i]+=x;num[i]+=x*(tot+1);//\uff08tot+1\uff09*x\u4e3a\u8fd9\u4e2a\u5757\u5de6\u7aef\u589e\u52a0\u7684\u503c\uff0c\u6c42\u6cd5\u53ef\u89c1\u5b8c\u6574\u4ee3\u7801\n\t\tsum[i]+=x*(tot*2ll+1+vec[i].size())*vec[i].size()/2;\n\t\ttot+=vec[i].size();\n\t}\n```\n\n\u200b\t\u5bf9\u4e8e\u64cd\u4f5c\u4e09\uff0c\u53ef\u80fd\u662f\u4e00\u4e2a\u91cd\u5934\u620f\uff0c\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u6211\u4eec\u9009\u62e9\u5206\u5757\u7684\u539f\u56e0\u3002\u6211\u4eec\u53ef\u4ee5\u6bcf\u5757\u7ef4\u62a4\u4e00\u4e2a $\\text{vector}$\uff0c\u63d2\u5165\u76f4\u63a5\u5728\u4f4d\u7f6e\u6240\u5728\u5757\u7684 $\\text{vector}$ \u4e2d\u63d2\u5165\uff0c\u7531\u4e8e\u4e00\u4e2a\u5757\u957f\u4e3a $O(\\sqrt{n})$\uff0c\u6240\u4ee5\u63d2\u5165\u64cd\u4f5c\u4e5f\u662f $O(\\sqrt{n})$ \u7684\u3002\u4f46\u662f\u6211\u4eec\u77e5\u9053\uff0c\u5982\u679c\u6570\u636e\u91cd\u590d\u63d2\u5165\u4e00\u4e2a\u5757\uff0c\u6211\u4eec\u8fd9\u79cd\u505a\u6cd5\u4f1a\u5bfc\u81f4\u67d0\u4e00\u4e2a\u5757\u957f\u957f\u5ea6\u8fc7\u5927\u4ece\u800c\u4f7f\u5f97\u6211\u4eec\u5206\u5757\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u9000\u5316\u3002\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u5728\u67d0\u4e00\u5757\u7684\u957f\u5ea6\u5927\u4e8e $2\\times\\sqrt{n}$ \u7684\u65f6\u5019\u91cd\u6784\u6574\u4e2a\u6570\u7ec4\u3002\u91cd\u6784\u4e00\u6b21\u590d\u6742\u5ea6\u662f $O(n)$ \u3002\u4f46\u662f\u7531\u4e8e\u8d77\u7801\u63d2\u5165 $\\sqrt{n}$ \u4e2a\u6570\u4e4b\u540e\u624d\u4f1a\u91cd\u6784\u4e00\u6b21\u6574\u4e2a\u6570\u7ec4\uff0c\u6240\u4ee5\u6211\u4eec\u7684\u65f6\u95f4\u590d\u6742\u5ea6\u4ecd\u65e7\u662f $O(n\\times\\sqrt{n})$\u3002\n\n\u200b\t\u91cd\u6784\u6574\u4e2a\u6570\u7ec4\u7684\u5c40\u90e8\u4ee3\u7801\u5982\u4e0b\uff1a\n\n```cpp\nvoid rebuild()\n{\n\tint tot=0,len=sqrt(n);\n\tfor(Re int i=1;tot<n;++i)\n\t{\n\t\tremake(i);\n\t\tfor(Re int j=0;j<vec[i].size();++j)\n\t\t\ta[++tot]=vec[i][j];\n\t\tvec[i].clear();\n\t\ttag[i]=add[i]=sum[i]=num[i]=0;\n\t}\n\tfor(Re int i=1;i<=tot;++i)\n\t{\n\t\tvec[(i-1)/len+1].push_back(a[i]);\n\t\tsum[(i-1)/len+1]+=a[i];\n\t}\n}\n```\n\n\u200b\t\u64cd\u4f5c\u56db\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u533a\u95f4\u548c\u67e5\u8be2\uff0c\u7b97\u662f\u5206\u5757\u7684\u57fa\u672c\u64cd\u4f5c\u3002\u5982\u4e0a\u6587\u6240\u8bf4\uff0c\u6563\u5757\u66b4\u529b\uff0c\u987a\u4fbf\u7ef4\u62a4\u6574\u5757\u7684\u548c\u5c31\u53ef\u4ee5\u5728 $O(\\sqrt{n})$ \u7684\u65f6\u95f4\u5185\u67e5\u8be2\u51fa\u7b54\u6848\u3002\n\n\u200b\t\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u8fd9\u9898\u7531\u4e8e\u6211\u4eec\u4f7f\u7528 $\\text{vector}$ \u5c01\u88c5\u4e00\u4e2a\u6574\u5757\uff0c\u800c\u4e14\u9898\u76ee\u4e2d\u4e5f\u6709\u63d2\u5165\u64cd\u4f5c\u3002\u6240\u4ee5\u5728\u83b7\u53d6\u5de6\u53f3\u7aef\u70b9 $l,r$ \u6240\u5728\u5757\u7684\u7f16\u53f7\u4e2d\u4e0d\u80fd\u901a\u8fc7\u9884\u5904\u7406\u7136\u540e $O(1)$ \u83b7\u53d6\u3002\u6240\u4ee5\u6211\u4eec\u904d\u5386\u6bcf\u4e00\u4e2a\u5757\u8fdb\u884c\u83b7\u53d6\uff0c\u8fd9\u4e2a\u64cd\u4f5c\u4e5f\u662f $O(\\sqrt{n})$ \u7684\u590d\u6742\u5ea6\uff0c\u5e76\u4e0d\u4f1a\u8d85\u65f6\u3002\n\n\u200b\t\u90a3\u4e48\u7efc\u4e0a\u6240\u8ff0\uff0c\u65f6\u95f4\u590d\u6742\u5ea6\u5c31\u4e3a $O(n\\times \\sqrt{n})$\u3002\n\n\u200b\t\u5168\u90e8\u4ee3\u7801\u5982\u4e0b\uff1a\n\n```cpp\n#pragma GCC optimize(2) \n#pragma GCC optimize(3)\n#pragma GCC optimize(\"Ofast\")\n#pragma GCC optimize(\"inline\")\n#pragma GCC target(\"avx\",\"sse2\")\n#pragma GCC optimize(\"unroll-loops\")\n#pragma GCC optimize(\"inline-small-functions\")\n//\u89c2\u5bdf\u53ef\u77e5\u8fd9\u9898\u662f\u8981\u6211\u4eec\u5199\u4e00\u4e2a\u6570\u636e\u7ed3\u6784\n//\u89c2\u5bdf\u53ef\u77e5\uff0c\u64cd\u4f5c\u4e00\u662f\u533a\u95f4\u4fee\u6539\uff0c\u64cd\u4f5c\u4e8c\u662f\u533a\u95f4\u4fee\u6539\uff0c\u64cd\u4f5c\u4e09\u662f\u63d2\u5165\uff0c\u64cd\u4f5c\u56db\u662f\u533a\u95f4\u67e5\u8be2 \n//\u6240\u4ee5\u6709\u4e00\u4e2a\u7ed3\u8bba\u3002\u5982\u679c a+b==a+b\u90a3\u4e48a+b==a+b\u3002\n//\u6211\u4eec\u53ef\u4ee5\u7528\u8fd9\u4e2a\u7ed3\u8bba\u7ef4\u62a4\u5206\u5757\u3002 \n//\u7136\u540e\u518d\u7528\u5206\u5757\u7ef4\u62a4\u7b54\u6848\u3002 \n//O(FAST)\u7684\u5206\u5757/se \n#include<bits/stdc++.h>\n#define ll long long\n#define Re register\nusing namespace std;\nconst int MAXN = 1e5+5;\nint n,q;\nll a[MAXN<<1],tag[MAXN],add[MAXN],num[MAXN],sum[MAXN];\nvector <ll> vec[MAXN];\nvoid Make_Group()\n{\n\tint len=sqrt(n);\n\tfor(Re int i=1;i<=n;++i)\n\t{\n\t\tvec[(i-1)/len+1].push_back(a[i]);\n\t\tsum[(i-1)/len+1]+=a[i];\n\t}\n}\nvoid remake(int k)\n{\n\tll d=num[k];\n\tfor(Re int i=0;i<vec[k].size();++i)\n\t{\n\t\tif(tag[k]) vec[k][i]=tag[k];\n\t\tvec[k][i]+=d;\n\t\td+=add[k];\n\t}\n\tadd[k]=num[k]=tag[k]=0;\n}\nvoid rebuild()\n{\n\tint tot=0,len=sqrt(n);\n\tfor(Re int i=1;tot<n;++i)\n\t{\n\t\tremake(i);\n\t\tfor(Re int j=0;j<vec[i].size();++j)\n\t\t\ta[++tot]=vec[i][j];\n\t\tvec[i].clear();\n\t\ttag[i]=add[i]=sum[i]=num[i]=0;\n\t}\n\tfor(Re int i=1;i<=tot;++i)\n\t{\n\t\tvec[(i-1)/len+1].push_back(a[i]);\n\t\tsum[(i-1)/len+1]+=a[i];\n\t}\n}\nvoid modify(int l,int r,ll x)\n{\n\tint tot=0,le,ri,L,R;\n\tfor(Re int i=1;tot<n;++i)\n\t{\n\t\tif(tot+vec[i].size()>=l&&tot<l) le=i,L=l-tot-1;\n\t\tif(tot+vec[i].size()>=r&&tot<r) ri=i,R=r-tot-1;\n\t\ttot+=vec[i].size();\n\t}\n\tif(le==ri)\n\t{\n\t\tremake(le);\n\t\tfor(Re int i=L;i<=R;++i)\n\t\t{\n\t\t\tsum[le]+=x-vec[le][i];\n\t\t\tvec[le][i]=x;\n\t\t}\n\t}\n\telse\n\t{\n\t\tfor(Re int i=le+1;i<ri;++i)\n\t\t{\n\t\t\tadd[i]=0;num[i]=0;\n\t\t\tsum[i]=1ll*vec[i].size()*x;\n\t\t\ttag[i]=x;\n\t\t}\n\t\tremake(le);remake(ri);\n\t\tfor(Re int i=L;i<vec[le].size();++i)\n\t\t\tsum[le]+=x-vec[le][i],vec[le][i]=x;\n\t\tfor(Re int i=0;i<=R;++i)\n\t\t\tsum[ri]+=x-vec[ri][i],vec[ri][i]=x;\n\t}\n}\nvoid upd(int l,int r,ll x)\n{\n\tint tot=0,le,ri,L,R,tmp=0;\n\tfor(Re int i=1;tot<n;++i)\n\t{\n\t\tif(tot+vec[i].size()>=l&&tot<l) le=i,L=l-tot-1;\n\t\tif(tot+vec[i].size()>=r&&tot<r) ri=i,R=r-tot-1;\n\t\ttot+=vec[i].size();\n\t}\n\ttot=vec[le].size()-L;\n\tif(le==ri)\n\t{\n\t\tremake(le);\n\t\tfor(Re int i=L;i<=R;++i)\n\t\t\tvec[le][i]+=x*(i-L+1),sum[le]+=x*(i-L+1);\n\t}\n\telse\n\t{\n\t\tfor(Re int i=le+1;i<ri;++i)\n\t\t{\n\t\t\tadd[i]+=x;num[i]+=x*(tot+1);\n\t\t\tsum[i]+=x*(tot*2ll+1+vec[i].size())*vec[i].size()/2;\n\t\t\ttot+=vec[i].size();\n\t\t}\n\t\tremake(le);remake(ri);\n\t\tfor(Re int i=L;i<vec[le].size();++i)\n\t\t\tvec[le][i]+=x*(i-L+1),sum[le]+=x*(i-L+1);\n\t\tfor(Re int i=0;i<=R;++i)\n\t\t\tvec[ri][i]+=x*(tot+i+1),sum[ri]+=x*(tot+i+1);\n\t}\n}\nvoid insert(int pos,ll x)\n{\n\tfor(Re int i=1;pos;++i)\n\t{\n\t\tif(!vec[i].size())\n\t\t{\n\t\t\tvec[i].push_back(x);\n\t\t\tsum[i]+=x;\n\t\t\tbreak;\n\t\t}\n\t\tif(pos<=vec[i].size())\n\t\t{\n\t\t\tremake(i);\n\t\t\tvector<ll>::iterator it=vec[i].begin()+pos-1;\n\t\t\tvec[i].insert(it,x);\n\t\t\tsum[i]+=x;\n\t\t\tif(vec[i].size()>2*sqrt(n)) rebuild();\n\t\t\tbreak; \n\t\t}\n\t\tpos-=vec[i].size();\n\t}\n}\nll query(int l,int r)\n{\n\tint tot=0,le,ri,L,R;\n\tfor(Re int i=1;tot<n;++i)\n\t{\n\t\tif(tot+vec[i].size()>=l&&tot<l) le=i,L=l-tot-1;\n\t\tif(tot+vec[i].size()>=r&&tot<r) ri=i,R=r-tot-1;\n\t\ttot+=vec[i].size();\n\t}\n\tll ans=0;\n\tif(le==ri)\n\t{\n\t\tremake(le);\n\t\tfor(Re int i=L;i<=R;++i)\n\t\t\tans+=vec[le][i];\n\t}\n\telse\n\t{\n\t\tfor(Re int i=le+1;i<ri;++i)\n\t\t\tans+=sum[i];\n\t\tremake(le);remake(ri);\n\t\tfor(Re int i=L;i<vec[le].size();++i)\n\t\t\tans+=vec[le][i];\n\t\tfor(Re int i=0;i<=R;++i)\n\t\t\tans+=vec[ri][i];\n\t}\n\treturn ans;\n}\nint main()\n{\n\tscanf(\"%d %d\",&n,&q);\n\tfor(Re int i=1;i<=n;++i)\n\t\tscanf(\"%d\",&a[i]);\n\tMake_Group();\n\twhile(q--)\n\t{\n\t\tint opt,a,b,c;ll x;\n\t\tscanf(\"%d\",&opt);\n\t\tif(opt==1)\n\t\t{\n\t\t\tscanf(\"%d %d %lld\",&a,&b,&x);\n\t\t\tmodify(a,b,x);\n\t\t}\n\t\telse if(opt==2)\n\t\t{\n\t\t\tscanf(\"%d %d %lld\",&a,&b,&x);\n\t\t\tupd(a,b,x);\n\t\t}\n\t\telse if(opt==3)\n\t\t{\n\t\t\tscanf(\"%d %lld\",&c,&x);\n\t\t\tinsert(c,x);\n\t\t\t++n;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tscanf(\"%d %d\",&a,&b);\n\t\t\tprintf(\"%lld\\n\",query(a,b));\n\t\t}\n\t}\n\treturn 0;\n}\n```\n\n\n\n",
        "postTime": 1630074232,
        "uid": 141485,
        "name": "A_Sunny_Day",
        "ccfLevel": 0,
        "title": "[COCI2010-2011#7] UPIT \u5206\u5757"
    },
    {
        "content": "\u672c\u9898\u89e3\u63d0\u4f9b\u4ee5\u5e73\u8861\u6811Splay\u4e3a\u57fa\u7840\u7684\u89e3\u51b3\u65b9\u6cd5\u3002\u5982\u679c\u672a\u5b66\u4e60Splay\u5e73\u8861\u6811\uff0c\u8bf7\u52a1\u5fc5\u4f18\u5148\u5b66\u4e60\u3002\u53c2\u8003\u94fe\u63a5\uff1a[\u5e73\u8861\u6811\u4e13\u9898](https://www.luogu.com.cn/blog/BingBang/ping-heng-shu-zhuan-ti)\u4e2d\u7684Splay\u8bb2\u89e3\u90e8\u5206\u3002  \n\u4e0b\u9762\u5206\u64cd\u4f5c\u7c7b\u578b\u89e3\u6790\uff1a  \n\n- \u64cd\u4f5c1\uff1a\u7ed9\u5b9a\u533a\u95f4$[l,r]$\u5185\u6240\u6709\u5143\u7d20\u503c\u4fee\u6539\u4e3a$x$\u3002  \n\u8be5\u64cd\u4f5c\u53ef\u4ee5\u901a\u8fc7\u7c7b\u4f3c\u4e8e\u7ebf\u6bb5\u6811\u61d2\u6807\u8bb0\u7684\u65b9\u6cd5\u89e3\u51b3\u3002\u8fd9\u662f\u4f18\u5148\u7ea7\u6700\u9ad8\u7684\u64cd\u4f5c\uff0c\u6bcf\u6b21\u64cd\u4f5c\u65f6\u5728Splay\u6811\u4e0a\u5c06\u533a\u95f4$[l,r]$\u5bf9\u5e94\u8282\u70b9\u96c6\u5408\u201c\u538b\u7f29\u201d\u5230\u4e00\u9897\u5b50\u6811\u5185\uff0c\u5e76\u5728\u5b50\u6811\u6811\u6839\u5904\u8bbe\u7f6e\u61d2\u6807\u8bb0\u3002\u6bcf\u6b21\u4e0b\u653e\u61d2\u6807\u8bb0\u65f6\uff0c\u76f4\u63a5\u5c06\u61d2\u6807\u8bb0\u4f20\u9012\u7ed9\u5b50\u8282\u70b9\uff0c\u5e76\u66f4\u65b0\u5b50\u8282\u70b9\u7684\u503c\u3002\u8be6\u89c1\u4ee3\u7801\u3002\n\n- \u64cd\u4f5c2\uff1a\u7ed9\u5b9a\u533a\u95f4$[l,r]$\u5185\u7b2c$i$\u4e2a\u5143\u7d20\u589e\u52a0$x$\u4e58$i$\u3002  \n\u8be5\u64cd\u4f5c\u4e5f\u53ef\u4ee5\u901a\u8fc7\u61d2\u6807\u8bb0\u7684\u65b9\u6cd5\u89e3\u51b3\u3002\u5148\u5c06Splay\u6811\u4e0a\u5bf9\u5e94\u8282\u70b9\u96c6\u5408\u201c\u538b\u7f29\u201d\u5230\u4e00\u9897\u5b50\u6811\u5185\uff0c\u968f\u540e\u5728\u5b50\u6811\u6811\u6839\u5904\u8bbe\u7f6e\u61d2\u6807\u8bb0\u3002\u6b64\u5904\u61d2\u6807\u8bb0\u9700\u8981\u8bb0\u5f55\u4e24\u4e2a\u503c\uff1a$add_1,add_2$\uff0c\u5206\u522b\u4ee3\u8868\u57fa\u7840\u589e\u91cf\u53ca\u6392\u540d\u4e58\u6570\u3002\u5904\u7406\u61d2\u6807\u8bb0\u7684\u65b9\u6cd5\u7a0d\u6709\u4e0d\u540c\uff1a\u5bf9\u4e8e\u5f53\u524d\u8282\u70b9\uff0c\u8bbe\u5176\u5de6\u5b50\u6811\u5927\u5c0f\u4e3a$siz_l$\uff0c\u53f3\u5b50\u6811\u5927\u5c0f\u4e3a$siz_r$\uff0c\u5219\u5f53\u524d\u8282\u70b9\u8282\u70b9\u503c\u589e\u91cf\u4e3a$add_1+add_2 \\times (siz_l+1)$\u3002\u4f20\u9012\u61d2\u6807\u8bb0\u65f6\uff0c\u5bf9\u5de6\u5b50\u8282\u70b9\u7684$add_1,add_2$\u503c\u5206\u522b\u589e\u52a0\u5f53\u524d\u8282\u70b9\u7684$add_1,add_2$\u503c(\u539f\u56e0\u662f\u4e24\u4e2a\u7b49\u5dee\u6570\u5217\u5bf9\u5e94\u9879\u7684\u548c\u5f62\u6210\u7684\u7b49\u5dee\u6570\u5217\u662f\u4e00\u4e2a\u4ee5\u4e24\u4e2a\u539f\u7b49\u5dee\u6570\u5217\u9996\u9879\u4e4b\u548c\u4e3a\u9996\u9879\uff0c\u4ee5\u4e24\u4e2a\u539f\u7b49\u5dee\u6570\u5217\u516c\u5dee\u4e4b\u548c\u4e3a\u516c\u5dee\u7684\u7b49\u5dee\u6570\u5217)\uff0c\u5bf9\u5e94\u53f3\u5b50\u8282\u70b9\u7684$add_1$\u589e\u52a0$add_1+add_2 \\times (siz_l+1)$\uff0c$add_2$\u589e\u52a0\u5f53\u524d\u8282\u70b9\u7684$add_2$(\u7406\u7531\u76f8\u540c)\u3002\u8be6\u89c1\u4ee3\u7801\u3002\n\n- \u64cd\u4f5c3\uff1a\u5728\u67d0\u4e00\u4f4d\u7f6e\u63d2\u5165\u7ed9\u5b9a\u503c\u3002  \nSplay\u6811\u57fa\u7840\u64cd\u4f5c\uff0c\u76f4\u63a5\u5c06\u8be5\u4f4d\u7f6e\u65cb\u8f6c\u81f3\u6839\u8282\u70b9\uff0c\u5728\u6839\u8282\u70b9\u5de6\u5b50\u8282\u70b9\u5904\u5f3a\u884c\u63d2\u5165\u4e00\u4e2a\u65b0\u7684\u8282\u70b9\u5373\u53ef\u3002\u8be6\u89c1\u4ee3\u7801\u3002\n\n- \u64cd\u4f5c4\uff1a\u7ed9\u5b9a\u533a\u95f4$[l,r]$\uff0c\u6c42\u533a\u95f4\u5185\u5143\u7d20\u4e4b\u548c\u3002  \n\u76f4\u63a5\u5c06\u533a\u95f4$[l,r]$\u5bf9\u5e94\u8282\u70b9\u96c6\u201c\u538b\u7f29\u201d\u81f3\u4e00\u9897\u5b50\u6811\uff0c\u53d6\u5b50\u6811\u6811\u6839\u7684$sum$\u503c\u5373\u53ef\u3002\u8be6\u89c1\u4ee3\u7801\n\n\u603b\u7ed3\u4e00\u4e0b\u5bf9\u4e8e\u6bcf\u4e2a\u8282\u70b9$x$\u9700\u8981\u7ef4\u62a4\u7684\u4fe1\u606f\uff1a  \n\u8282\u70b9\u503c$val[x]$  \n\u4ee5$x$\u4e3a\u6839\u8282\u70b9\u7684\u5b50\u6811\u5143\u7d20\u503c\u4e4b\u548c$sum[x]$  \n\u4fee\u6539\u61d2\u6807\u8bb0$tag[x]$  \n\u589e\u91cf\u61d2\u6807\u8bb0$add1[x],add2[x]$  \n\u4ee5$x$\u4e3a\u6839\u8282\u70b9\u7684\u5b50\u6811\u5927\u5c0f$siz[x]$  \nSplay\u5e73\u8861\u6811\u6240\u9700\u7ef4\u62a4\u7684\u5176\u5b83\u57fa\u672c\u4fe1\u606f\u3002\n\n\u6ce8\u610f\uff1a\u5728\u61d2\u6807\u8bb0\u7ef4\u62a4\u65f6\uff0c\u4f18\u5148\u4f20\u9012$tag$\u4fee\u6539\u61d2\u6807\u8bb0\u7684\u503c\u3002\u6bcf\u6b21\u8d4b\u503c$tag$\u61d2\u6807\u8bb0\u65f6\uff0c\u76f4\u63a5\u6e05\u7a7a$add1,add2$\u3002\u5177\u4f53\u53ef\u4ee5\u601d\u8003\u8fd9\u4e9b\u8fd0\u7b97\u7684\u4f18\u5148\u7ea7\u3002\n\n\u7ef4\u62a4\u7ec6\u8282\uff1a\u7531\u4e8e\u9700\u8981\u8fdb\u884c\u201c\u538b\u7f29\u201d\u64cd\u4f5c\uff0c\u6545\u53ef\u4ee5\u5728\u4e24\u7aef\u5404\u63d2\u5165\u4e00\u4e2a\u503c$0$(\u4efb\u610f\u503c\u5747\u53ef)\uff0c\u4ee5\u4fbf\u201c\u538b\u7f29\u201d\u7aef\u70b9\u5728\u8fb9\u7f18\u4f4d\u7f6e\u7684\u533a\u95f4\u3002\u6ce8\u610f\u4f7f\u7528\u8be5\u65b9\u6cd5\u65f6\u6bcf\u6b21\u5bf9\u8f93\u5165\u7684\u64cd\u4f5c\u533a\u95f4\u4e24\u7aef\u70b9\u5404$+1$\u3002\n\n\u5b9e\u73b0\u4ee3\u7801\uff1a\n```\n#include<bits/stdc++.h>\nusing namespace std;\n#define re register\ninline int read(){//\u5feb\u901f\u8bfb\u5165int\u578b \n\tregister int x=0,f=1;register char ch=getchar();\n\twhile(!(ch>='0'&&ch<='9')&&ch!='-')ch=getchar();\n\tif(ch=='-')f=-1,ch=getchar();\n\twhile(ch>='0'&&ch<='9'){\n\t\tx=(x<<3)+(x<<1)+(ch^'0');ch=getchar();\n\t}\n\treturn x*f;\n}\ninline void fput(long long x){//\u5feb\u901f\u8f93\u51falong long\u578b(\u65e0\u6362\u884c\u7b26)  \n\tif(x<0)putchar('-'),x=-x;\n\tif(x>=10)fput(x/10);\n\tputchar(x%10+'0');\n}\n#define M 200005\nint n,q,tree[M][2],fa[M],siz[M],root,cnt;\nlong long val[M],sum[M],tag[M],add1[M],add2[M];\n//\u6811\u4e2d\u7b2ck\u5927\u7684\u8282\u70b9\u589e\u91cf\u4e3aadd1+add2*k \ninline void pushup(int x){\n\tsiz[x]=siz[tree[x][0]]+siz[tree[x][1]]+1;\n\tsum[x]=sum[tree[x][0]]+sum[tree[x][1]]+val[x];\n\treturn ;\n}\ninline void turn(int x){\n\tre int y=fa[x],z=fa[y];\n\tre bool c=(tree[y][1]==x);\n\tif(z)tree[z][tree[z][1]==y]=x;\n\tfa[x]=z;\n\ttree[y][c]=tree[x][!c];\n\tfa[tree[x][!c]]=y;\n\ttree[x][!c]=y;\n\tfa[y]=x;\n\tpushup(y);pushup(x);\n\treturn ;\n}\ninline void pushtag(int x,long long y){//\u7ef4\u62a4tag\u6807\u8bb0\n\tval[x]=y;sum[x]=y*siz[x];\n\tadd1[x]=add2[x]=0;//\u6ce8\u610f\u6e05\u7a7aadd1,add2\u6807\u8bb0\n\ttag[x]=y;\n\treturn ;\n}\ninline long long cal(long long f1,long long d,int num){//\u8ba1\u7b97\u4ee5f1\u4e3a\u9996\u9879,d\u4e3a\u516c\u5dee\u7684\u7b49\u5dee\u6570\u5217\u76841~num\u9879\u4e4b\u548c\n\treturn f1*num+d*(1+num)*num/2;\n}\ninline void pushadd(int x,long long k1,long long k2){//\u7ef4\u62a4add1,add2\u6807\u8bb0\n\tval[x]+=k1+k2*(siz[tree[x][0]]+1);\n\tsum[x]+=cal(k1,k2,siz[x]);\n\tadd1[x]+=k1;add2[x]+=k2;\n\treturn ;\n}\ninline void pushd(int x){//\u4f20\u9012\u6807\u8bb0\n\tif(tag[x]){//tag\u6807\u8bb0\u4f18\u5148\u7ea7\u8f83\u9ad8\n\t\tif(tree[x][0])pushtag(tree[x][0],tag[x]);\n\t\tif(tree[x][1])pushtag(tree[x][1],tag[x]);\n\t\ttag[x]=0;\n\t}\n\tif(add1[x]||add2[x]){//\u4f20\u9012add1,add2\u6807\u8bb0\n\t\tif(tree[x][0])pushadd(tree[x][0],add1[x],add2[x]);\n\t\tif(tree[x][1])pushadd(tree[x][1],add1[x]+add2[x]*(siz[tree[x][0]]+1),add2[x]);\n\t\tadd1[x]=add2[x]=0;\n\t}\n\treturn ;\n}\nvoid pushdown(int x){\n\tif(fa[x])pushdown(fa[x]);\n\tpushd(x);\n\treturn ;\n}\ninline void splay(int x,int goal){\n\tpushdown(x);\n\twhile(fa[x]!=goal){\n\t\tre int y=fa[x],z=fa[y];\n\t\tif(z!=goal){\n\t\t\t((tree[z][0]==y)^(tree[y][0]==x))?turn(x):turn(y);\n\t\t}\n\t\tturn(x);\n\t}\n\tif(!goal)root=x;\n\treturn ;\n}\ninline void insert(int x){\n\tif(!root){\n\t\troot=cnt=1;\n\t\tsiz[root]=1;\n\t\tval[root]=sum[root]=x;\n\t\treturn ;\n\t}\n\tre int p=root;\n\twhile(pushd(p),tree[p][1])p=tree[p][1];\n\ttree[p][1]=++cnt;\n\tfa[cnt]=p;\n\tsiz[cnt]=1;val[cnt]=sum[cnt]=x;\n\tsplay(cnt,0);\n\treturn ;\n}\ninline int ranks(int x){//\u67e5\u627e\u7b2cx\u9879\n\tre int p=root;\n\twhile(1){\n\t\tpushd(p);\n\t\tif(siz[tree[p][0]]>=x){\n\t\t\tp=tree[p][0];\n\t\t}else if(siz[tree[p][0]]+1>=x){\n\t\t\tsplay(p,0);\n\t\t\treturn p;\n\t\t}else{\n\t\t\tx-=(siz[tree[p][0]]+1);\n\t\t\tp=tree[p][1];\n\t\t}\n\t}\n}\ninline int split(int l,int r){//\u5c06\u533a\u95f4[l,r]\u538b\u7f29\u5e76\u8fd4\u56de\u538b\u7f29\u540e\u7684\u6839\u8282\u70b9\n\tre int x=ranks(l-1),y=ranks(r+1);\n\tsplay(x,0);splay(y,x);\n\treturn tree[y][0];\n}\ninline void insert2(int c,int x){//\u5728\u4f4d\u7f6ec\u5904\u63d2\u5165x\n\tranks(c);\n\tpushd(root);\n\tfa[tree[root][0]]=++cnt;\n\ttree[cnt][0]=tree[root][0];\n\ttree[root][0]=cnt;\n\tfa[cnt]=root;\n\tsiz[cnt]=1;\n\tval[cnt]=sum[cnt]=x;\n\tpushup(cnt);pushup(root);\n\treturn ;\n}\nint main(){\n\tn=read();q=read();\n\tinsert(0);\n\tfor(re int i=1;i<=n;i++){\n\t\tinsert(read());\n\t}\n\tinsert(0);\n//\tputs(\"insert done!\\n\");\n\twhile(q--){\n\t\tre int opt=read();\n\t\tif(opt==1){\n\t\t\tre int l=read()+1,r=read()+1,x=read();\n\t\t\tre int p=split(l,r);\n\t\t\tpushtag(p,x);\n\t\t}else if(opt==2){\n\t\t\tre int l=read()+1,r=read()+1,x=read();\n\t\t\tre int p=split(l,r);\n\t\t\tpushadd(p,0,x);\n\t\t}else if(opt==3){\n\t\t\tre int c=read()+1,x=read();\n\t\t\tinsert2(c,x);\n\t\t}else{\n\t\t\tre int l=read()+1,r=read()+1;\n\t\t\tre int p=split(l,r);\n\t\t\tfput(sum[p]);putchar('\\n');\n\t\t}\n\t}\n\treturn 0;\n}\n```",
        "postTime": 1605789983,
        "uid": 245770,
        "name": "BingBang",
        "ccfLevel": 0,
        "title": "\u9898\u89e3 P6707 \u3010[COCI2010-2011#7] UPIT\u3011"
    }
]