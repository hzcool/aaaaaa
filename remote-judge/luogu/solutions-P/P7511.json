[
    {
        "content": "$\\text{Problem}:$[\u4e09\u5230\u516d](https://www.luogu.com.cn/problem/P7511)\n\n$\\text{Solution}:$\n\n\u89c2\u5bdf\u4e0d\u7b49\u5f0f $\u03c0_{i}<\u03c0_{\u03c0_{i}'}<\u03c0_{\u03c0_{\u03c0_{i}'}'}<...$\uff0c\u7531\u4e8e $\u03c0'$ \u662f\u4e00\u4e2a\u6392\u5217\uff0c\u6240\u4ee5\u6700\u540e\u4e0d\u7b49\u5173\u7cfb\u4e00\u5b9a\u6784\u6210\u4e86\u82e5\u5e72\u4e2a\u6709\u5411\u73af\u3002\u53ef\u4ee5\u53d1\u73b0\uff0c\u94a6\u5b9a\u73af\u4e0a\u4e00\u6761\u8fb9\u4e0d\u6ee1\u8db3\u6761\u4ef6\uff0c\u5e76\u65ad\u6389\u8fd9\u6761\u8fb9\u4f7f\u7834\u73af\u6210\u94fe\uff0c\u5c31\u6784\u6210\u4e86\u4e00\u4e2a\u957f\u5ea6\u4e3a $m$ \u7684\u5e8f\u5217\u3002\u95ee\u9898\u8f6c\u5316\u4e3a\uff1a\u6709\u82e5\u5e72\u4e2a\u73af\uff0c\u6bcf\u4e2a\u73af\u5bf9\u5e94\u4e00\u4e2a\u5e8f\u5217\uff0c\u5728\u8fd9\u4e2a\u5e8f\u5217\u4e2d\u6709 $b_{i}$ \u4e2a\u4f4d\u7f6e\u6ee1\u8db3 $\u03c0_{i}<\u03c0_{i+1}$\uff0c\u4e14 $\\sum b_{i}=k$\u3002\u6c42\u6ee1\u8db3\u6761\u4ef6\u7684\u603b\u6392\u5217\u4e2a\u6570\u3002\n\n\u5148\u8003\u8651\u5355\u4e2a\u957f\u5ea6\u4e3a $m$ \u7684\u73af\u5bf9\u7b54\u6848\u8d21\u732e\u4e86 $j$ \u4e2a $\u03c0_{i}<\u03c0_{\u03c0_{i}'}$ \u7684\u65b9\u6848\u6570\uff1a\u94a6\u5b9a\u4e00\u4e2a\u4f4d\u7f6e $i$\uff0c\u6ee1\u8db3 $\u03c0_{i}=1$\uff0c\u4ee4 $i$ \u8fd9\u4e2a\u4f4d\u7f6e\u4e3a\u65ad\u70b9\uff0c\u5c31\u662f\u5728\u957f\u5ea6\u4e3a $m-1$ \u7684\u5e8f\u5217\u4e2d\u6709 $j-1$ \u4e2a\u4f4d\u7f6e\u6ee1\u8db3 $\u03c0_{i}<\u03c0_{i+1}$\u3002\u800c $\u03c0_{i}=1$ \u7684\u4f4d\u7f6e\u6709 $m$ \u79cd\u4e0d\u540c\u7684\u9009\u62e9\u3002\u628a\u6240\u6709\u73af\u7684\u8d21\u732e\u76f8\u4e58\u5c31\u662f\u7b54\u6848\uff0c\u5f97\u5230\uff1a\n$$\n\\binom{n}{a_{1},a_{2}...a_{m}}\\sum\\limits_{\\sum b_{i}=k}\\prod\\limits_{i} a_{i}\\left<a_{i}-1\\atop b_{i}-1\\right>,\\sum\\limits_{i=1}^{m}a_{i}=n\n$$\n\u53d1\u73b0 $\\sum\\limits_{b_{i}=k}$ \u662f\u4e00\u4e2a\u80cc\u5305\u5f62\u5f0f\uff0c$dp$ \u6c42\u6b27\u62c9\u6570\u7136\u540e\u66b4\u529b\u80cc\u5305\u5c31\u53ef\u4ee5\u505a\u5230 $O(n^2)$\u3002\u6ce8\u610f\u6211\u4eec\u7ed9\u51fa\u7684\u5b9a\u4e49\uff0c\u9700\u8981\u5bf9 $a_{i}=1$ \u7684\u60c5\u51b5\u7279\u5224\u3002\u4e0b\u9762\u7ed9\u51fa\u4e00\u4e2a $O(n^2)$ \u7684\u4ee3\u7801\uff0c\u53ef\u4ee5\u5f97\u5230 $60$ \u5206\uff1a\n\n```cpp\n#include <bits/stdc++.h>\n#pragma GCC optimize(3)\n//#define int long long\n#define ri register\n#define mk make_pair\n#define fi first\n#define se second\n#define pb push_back\n#define eb emplace_back\n#define is insert\n#define es erase\n#define vi vector<int>\n#define vpi vector<pair<int,int>>\nusing namespace std; const int N=2010, Mod=998244353;\ninline int read()\n{\n\tint s=0, w=1; ri char ch=getchar();\n\twhile(ch<'0'||ch>'9') { if(ch=='-') w=-1; ch=getchar(); }\n\twhile(ch>='0'&&ch<='9') s=(s<<3)+(s<<1)+(ch^48), ch=getchar();\n\treturn s*w;\n}\nint n,K,p[N],book[N],T[N][N],fac[N+5],inv[N+5],ans,a[N],m,F[N][N];\ninline int ksc(int x,int p) { int res=1; for(;p;p>>=1, x=1ll*x*x%Mod) if(p&1) res=1ll*res*x%Mod; return res; }\nsigned main()\n{\n\tfac[0]=1;\n\tfor(ri int i=1;i<=N;i++) fac[i]=1ll*fac[i-1]*i%Mod;\n\tinv[N]=ksc(fac[N],Mod-2);\n\tfor(ri int i=N;i;i--) inv[i-1]=1ll*inv[i]*i%Mod;\n\tn=read(), K=read();\n\tfor(ri int i=1;i<=n;i++) p[i]=read();\n\tT[0][0]=1;\n\tfor(ri int i=1;i<=n;i++)\n\t{\n\t\tT[i][0]=1;\n\t\tfor(ri int j=1;j<i;j++)\n\t\t\tT[i][j]=(1ll*(j+1)*T[i-1][j]%Mod+1ll*(i-j)*T[i-1][j-1]%Mod)%Mod;\n\t}\n\tans=fac[n];\n\tfor(ri int i=1;i<=n;i++)\n\t{\n\t\tif(book[i]) continue;\n\t\tint x=i,len=0;\n\t\twhile(!book[x])\n\t\t{\n\t\t\tbook[x]=1;\n\t\t\tlen++;\n\t\t\tx=p[x];\n\t\t}\n\t\tans=1ll*ans*inv[len]%Mod;\n\t\ta[++m]=len;\n\t}\n\tF[0][0]=1;\n\tfor(ri int i=1;i<=m;i++)\n\t{\n\t\tif(a[i]==1)\n\t\t{\n\t\t\tfor(ri int j=0;j<=K;j++) F[i][j]=F[i-1][j];\n\t\t\tcontinue;\n\t\t}\n\t\tfor(ri int j=1;j<a[i];j++)\n\t\t{\n\t\t\tfor(ri int k=0;k+j<=K;k++)\n\t\t\t{\n\t\t\t\tF[i][j+k]=(F[i][j+k]+1ll*F[i-1][k]*a[i]%Mod*T[a[i]-1][j-1]%Mod)%Mod;\n\t\t\t}\n\t\t}\n\t}\n\tprintf(\"%d\\n\",1ll*F[m][K]*ans%Mod);\n\treturn 0;\n}\n```\n\n\u53c2\u8003 [Karry5307 \u7684\u65e5\u62a5](https://www.luogu.com.cn/blog/Karry5307/eulerian-numbers)\uff0c\u6709\uff1a\n$$\n\\left<n\\atop m\\right>=\\sum\\limits_{k=0}^{m}\\binom{n+1}{k}(m+1-k)^{n}(-1)^{k}\n$$\n\u8bbe $g_{i}=\\binom{n+1}{i}(-1)^{i}$\uff0c$h_{i}=(i+1)^{n}$\uff0c\u6709\uff1a\n$$\n\\left<n\\atop i\\right>=f_{i}=\\sum\\limits_{j=0}^{i}g_{j}h_{i-j}\n$$\n\u53ef\u4ee5\u5229\u7528\u5377\u79ef\u505a\u5230\u5728 $O(n\\log n)$ \u7684\u65f6\u95f4\u5185\u6c42\u51fa\u4e00\u884c\u7684\u6b27\u62c9\u6570\u3002\n\n\u73b0\u5728\u8bb0 $F_{i}$ \u8868\u793a\u5df2\u7ecf\u9009\u4e86 $i$ \u4e2a\u5c0f\u4e8e\u53f7\u7684\u65b9\u6848\u6570\uff0c\u679a\u4e3e\u5230\u7b2c $i$ \u4e2a\u73af\u65f6 $G_{j}=a_{i}\\times \\left<a_{i}-1\\atop j-1\\right>$\uff0c\u90a3\u4e48\u6709\uff1a\n$$\nF_{i}=\\sum\\limits_{j=0}^{i}F_{j}\\times G_{i-j}\n$$\n\u5229\u7528\u5206\u6cbb $\\text{NTT}$ \u5373\u53ef\u89e3\u51b3\u3002\n\n$\\text{Code}:$\n\n```cpp\n#include <bits/stdc++.h>\n#pragma GCC optimize(3)\n//#define int long long\n#define ri register\n#define mk make_pair\n#define fi first\n#define se second\n#define pb push_back\n#define eb emplace_back\n#define is insert\n#define es erase\n#define vi vector<int>\n#define vpi vector<pair<int,int>>\nusing namespace std; const int N=550000, Mod=998244353;\ninline int read()\n{\n\tint s=0, w=1; ri char ch=getchar();\n\twhile(ch<'0'||ch>'9') { if(ch=='-') w=-1; ch=getchar(); }\n\twhile(ch>='0'&&ch<='9') s=(s<<3)+(s<<1)+(ch^48), ch=getchar();\n\treturn s*w;\n}\nint n,K,p[N],a[N],book[N],m,ans;\nint fac[N+5],inv[N+5];\ninline int ksc(int x,int p) { int res=1; for(;p;p>>=1, x=1ll*x*x%Mod) if(p&1) res=1ll*res*x%Mod; return res; }\ninline int C(int x,int y) { if(x<y||x<0||y<0) return 0; return 1ll*fac[x]*inv[x-y]%Mod*inv[y]%Mod; }\nvector<int> F;\nvector<int> A,B;\nint rev[N],r[24][2];\ninline void Init()\n{\n\tfac[0]=1;\n\tfor(ri int i=1;i<=N;i++) fac[i]=1ll*fac[i-1]*i%Mod;\n\tinv[N]=ksc(fac[N],Mod-2);\n\tfor(ri int i=N;i;i--) inv[i-1]=1ll*inv[i]*i%Mod;\n\tr[23][1]=ksc(3,119), r[23][0]=ksc(332748118,119);\n\tfor(ri int i=22;~i;i--) r[i][0]=1ll*r[i+1][0]*r[i+1][0]%Mod, r[i][1]=1ll*r[i+1][1]*r[i+1][1]%Mod;\n}\ninline void Get_Rev(int T) { for(ri int i=0;i<T;i++) rev[i]=(rev[i>>1]>>1)|((i&1)?(T>>1):0); }\ninline void DFT(vector<int> &s,int T,int type)\n{\n\tfor(ri int i=0;i<T;i++) if(i<rev[i]) swap(s[i],s[rev[i]]);\n\tfor(ri int i=2,cnt=1;i<=T;i<<=1,cnt++)\n\t{\n\t\tint wn=r[cnt][type];\n\t\tfor(ri int j=0,mid=(i>>1);j<T;j+=i)\n\t\t{\n\t\t\tfor(ri int k=0,w=1;k<mid;k++,w=1ll*w*wn%Mod)\n\t\t\t{\n\t\t\t\tint x=s[j+k], y=1ll*w*s[j+mid+k]%Mod;\n\t\t\t\ts[j+k]=(x+y)%Mod;\n\t\t\t\ts[j+mid+k]=x-y;\n\t\t\t\tif(s[j+mid+k]<0) s[j+mid+k]+=Mod;\n\t\t\t}\n\t\t}\n\t}\n\tif(!type) for(ri int i=0,inv=ksc(T,Mod-2);i<T;i++) s[i]=1ll*s[i]*inv%Mod;\n}\ninline void NTT(int n,int m,vector<int> &A,vector<int> &B)\n{\n\tint len=n+m;\n\tint T=1;\n\twhile(T<=len) T<<=1;\n\tGet_Rev(T);\n\tA.resize(T), B.resize(T);\n\tfor(ri int i=n+1;i<T;i++) A[i]=0;\n\tfor(ri int i=m+1;i<T;i++) B[i]=0;\n\tDFT(A,T,1), DFT(B,T,1);\n\tfor(ri int i=0;i<T;i++) A[i]=1ll*A[i]*B[i]%Mod;\n\tDFT(A,T,0);\n\tfor(ri int i=n+m+1;i<T;i++) A[i]=0;\n\tA.erase(A.begin()+n+m+1,A.end());\n\tB.erase(B.begin()+m+1,B.end());\n}\nvoid Merge(int l,int r,vector<int> &F)\n{\n\tif(l==r)\n\t{\n\t\tF.resize(a[l]+1), B.resize(a[l]+1);\n\t\tfor(ri int i=0;i<=a[l];i++)\n\t\t{\n\t\t\tint tp=(i&1)?(-1):(1);\n\t\t\tint w1=(C(a[l],i)*tp+Mod)%Mod, w2=ksc(i,a[l]-1);\n\t\t\tF[i]=w1, B[i]=w2;\n\t\t}\n\t\tNTT(F.size()-1,B.size()-1,F,B);\n\t\tfor(ri int i=0;i<=a[l];i++) F[i]=1ll*F[i]*a[l]%Mod;\n\t\tF.erase(F.begin()+a[l]+1,F.end());\n\t\tB.erase(B.begin(),B.end());\n\t\treturn;\n\t}\n\tint mid=(l+r)/2;\n\tMerge(l,mid,F);\n\tvector<int> G;\n\tMerge(mid+1,r,G);\n\tNTT(F.size()-1,G.size()-1,F,G);\n}\nsigned main()\n{\n\tInit();\n\tn=read(), K=read();\n\tfor(ri int i=1;i<=n;i++) p[i]=read();\n\tans=fac[n];\n\tfor(ri int i=1;i<=n;i++)\n\t{\n\t\tif(book[i]) continue;\n\t\tint x=i,len=0;\n\t\twhile(!book[x])\n\t\t{\n\t\t\tbook[x]=1;\n\t\t\tx=p[x], len++;\n\t\t}\n\t\tans=1ll*ans*inv[len]%Mod;\n\t\ta[++m]=len;\n\t}\n\tMerge(1,m,F);\n\tprintf(\"%d\\n\",1ll*F[K]*ans%Mod);\n\treturn 0;\n}\n```\n\n",
        "postTime": 1617971631,
        "uid": 98618,
        "name": "Provicy",
        "ccfLevel": 7,
        "title": "\u9898\u89e3 P7511"
    }
]